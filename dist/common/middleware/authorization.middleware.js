'use strict';const _0x13b635=_0x364d;(function(_0x59ac4c,_0x1779e7){const _0x2a2546=_0x364d,_0x9157a=_0x59ac4c();while(!![]){try{const _0x2ab58c=parseInt(_0x2a2546(0x13d))/0x1*(-parseInt(_0x2a2546(0x147))/0x2)+parseInt(_0x2a2546(0x179))/0x3*(parseInt(_0x2a2546(0x14f))/0x4)+parseInt(_0x2a2546(0x154))/0x5+parseInt(_0x2a2546(0x174))/0x6*(parseInt(_0x2a2546(0x168))/0x7)+parseInt(_0x2a2546(0x141))/0x8+-parseInt(_0x2a2546(0x14c))/0x9+parseInt(_0x2a2546(0x13e))/0xa;if(_0x2ab58c===_0x1779e7)break;else _0x9157a['push'](_0x9157a['shift']());}catch(_0x13fd11){_0x9157a['push'](_0x9157a['shift']());}}}(_0x2e2e,0x39824));function _0x2e2e(){const _0x457959=['未命中','136273JUwIOz','1559990JqGHkO','rocketAiKey','__metadata','1770696jdsIwg','域名验证\x20-\x20处理后的域名:\x20','__esModule','授权验证失败:\x20url=','query','design:paramtypes','6eqfRXZ','object','wishSet','protocol','Connection','2862450VYYmzv','code','toISOString','4obklhE','Redis缓存状态:\x20','域名验证\x20-\x20原始域名:\x20','x-forwarded-host','headers','516230THvAPL','站点尚未授权:\x20未找到授权码','stringify','wishGet','从数据库获取授权码:\x20','开始远程授权验证','HttpException','getOwnPropertyDescriptor','@nestjs/common','stack','设置授权码接口，跳过验证','decorate','true','getTime','length','connection','configVal','未找到','\x20code=','redisCacheService','5677oaejHc','ISDEV','域名验证\x20-\x20请求头信息：','Redis缓存解密失败:\x20url=','http://authorization.nodeai.cn/api/domainAuth/checkDomain/mechat','FORBIDDEN','站点未授权','post','Redis缓存验证:\x20当前时间=','originalUrl','json','defineProperty','786oCwlCE','function','logger','HttpStatus','../utils/baseRequest','1126806lOWfWS','log','RedisCacheService','error','Injectable','default','metadata','host','use','Logger','env','SELECT\x20configVal\x20FROM\x20config\x20WHERE\x20configKey=?','../utils/wishCrypto',',\x20过期时间=','AuthorizationMiddleware','\x20redisVal=','x-real-ip','/api/config/setKey','使用缓存验证通过','baseRequest','授权验证发生错误','decrypt','站点尚未授权','x-forwarded-proto'];_0x2e2e=function(){return _0x457959;};return _0x2e2e();}var __decorate=this&&this['__decorate']||function(_0x3ad485,_0x26b4bf,_0x3022a9,_0x568ee6){const _0x1c43c8=_0x364d;var _0x51012e=arguments[_0x1c43c8(0x162)],_0x31de87=_0x51012e<0x3?_0x26b4bf:_0x568ee6===null?_0x568ee6=Object[_0x1c43c8(0x15b)](_0x26b4bf,_0x3022a9):_0x568ee6,_0x1f79e3;if(typeof Reflect===_0x1c43c8(0x148)&&typeof Reflect['decorate']==='function')_0x31de87=Reflect[_0x1c43c8(0x15f)](_0x3ad485,_0x26b4bf,_0x3022a9,_0x568ee6);else{for(var _0xb57644=_0x3ad485[_0x1c43c8(0x162)]-0x1;_0xb57644>=0x0;_0xb57644--)if(_0x1f79e3=_0x3ad485[_0xb57644])_0x31de87=(_0x51012e<0x3?_0x1f79e3(_0x31de87):_0x51012e>0x3?_0x1f79e3(_0x26b4bf,_0x3022a9,_0x31de87):_0x1f79e3(_0x26b4bf,_0x3022a9))||_0x31de87;}return _0x51012e>0x3&&_0x31de87&&Object[_0x1c43c8(0x173)](_0x26b4bf,_0x3022a9,_0x31de87),_0x31de87;},__metadata=this&&this[_0x13b635(0x140)]||function(_0x3471fd,_0x4d93f4){const _0x2bb105=_0x13b635;if(typeof Reflect===_0x2bb105(0x148)&&typeof Reflect[_0x2bb105(0x12a)]===_0x2bb105(0x175))return Reflect[_0x2bb105(0x12a)](_0x3471fd,_0x4d93f4);};Object[_0x13b635(0x173)](exports,_0x13b635(0x143),{'value':!![]}),exports[_0x13b635(0x132)]=void 0x0;const common_1=require(_0x13b635(0x15c)),typeorm_1=require('typeorm'),redisCache_service_1=require('../../modules/redisCache/redisCache.service'),baseRequest_1=require(_0x13b635(0x178)),wishCrypto_1=require(_0x13b635(0x130)),hourTimer=0x3c*0x3c*0x3e8;let AuthorizationMiddleware=class AuthorizationMiddleware{constructor(_0x153e15,_0x52fcb1){const _0x59368c=_0x13b635;this[_0x59368c(0x163)]=_0x153e15,this[_0x59368c(0x167)]=_0x52fcb1,this[_0x59368c(0x176)]=new common_1[(_0x59368c(0x12d))](_0x59368c(0x132));}async[_0x13b635(0x12c)](_0x3d323b,_0x21b4fb,_0x5e4841){const _0x573477=_0x13b635;var _0x84c946,_0x1ec7cc;const _0x236004={'host':_0x3d323b[_0x573477(0x153)][_0x573477(0x12b)],'x-forwarded-host':_0x3d323b[_0x573477(0x153)][_0x573477(0x152)],'x-forwarded-proto':_0x3d323b[_0x573477(0x153)]['x-forwarded-proto'],'x-real-ip':_0x3d323b[_0x573477(0x153)][_0x573477(0x134)],'x-forwarded-for':_0x3d323b[_0x573477(0x153)]['x-forwarded-for']},_0x46a8e8=_0x3d323b[_0x573477(0x153)][_0x573477(0x152)]||_0x3d323b[_0x573477(0x153)][_0x573477(0x12b)],_0x3d1aa0=_0x3d323b[_0x573477(0x153)][_0x573477(0x13b)]||_0x3d323b[_0x573477(0x14a)],_0x4f85e2=((_0x84c946=_0x46a8e8===null||_0x46a8e8===void 0x0?void 0x0:_0x46a8e8['split'](':'))===null||_0x84c946===void 0x0?void 0x0:_0x84c946[0x0])||'';this['logger'][_0x573477(0x17a)](_0x573477(0x16a)),this['logger'][_0x573477(0x17a)](JSON[_0x573477(0x156)](_0x236004,null,0x2)),this['logger'][_0x573477(0x17a)](_0x573477(0x151)+_0x46a8e8),this['logger'][_0x573477(0x17a)](_0x573477(0x142)+_0x4f85e2);if(_0x3d323b[_0x573477(0x171)]==_0x573477(0x135))return this['logger'][_0x573477(0x17a)](_0x573477(0x15e)),_0x5e4841();if(process[_0x573477(0x12e)][_0x573477(0x169)]===_0x573477(0x160))return _0x5e4841();try{const _0x2a1273=_0x573477(0x13f);let _0x13dae6=await this['connection'][_0x573477(0x145)](_0x573477(0x12f),[_0x2a1273]);_0x13dae6=(_0x1ec7cc=_0x13dae6[0x0])===null||_0x1ec7cc===void 0x0?void 0x0:_0x1ec7cc[_0x573477(0x164)],this['logger'][_0x573477(0x17a)](_0x573477(0x158)+(_0x13dae6?'成功':_0x573477(0x165)));if(!_0x13dae6)return this[_0x573477(0x176)][_0x573477(0x17c)](_0x573477(0x155)),_0x21b4fb['status'](0x193)[_0x573477(0x172)]({'message':_0x573477(0x13a)});const _0x188ffb=await this[_0x573477(0x167)][_0x573477(0x157)](_0x13dae6);this[_0x573477(0x176)]['log'](_0x573477(0x150)+(_0x188ffb?'命中':_0x573477(0x13c)));if(_0x188ffb)try{const _0x50dc4f=new Date()[_0x573477(0x161)](),_0x4c7a51=wishCrypto_1[_0x573477(0x129)][_0x573477(0x139)](_0x188ffb);this['logger'][_0x573477(0x17a)](_0x573477(0x170)+_0x50dc4f+_0x573477(0x131)+_0x4c7a51);if(_0x50dc4f<Number(_0x4c7a51))return this['logger']['log'](_0x573477(0x136)),_0x5e4841();}catch(_0x26d22a){this[_0x573477(0x176)]['error'](_0x573477(0x16b)+_0x4f85e2+_0x573477(0x166)+_0x13dae6+_0x573477(0x133)+_0x188ffb,_0x26d22a[_0x573477(0x15d)]);}this[_0x573477(0x176)][_0x573477(0x17a)](_0x573477(0x159));const _0x3cbdd9={'domain':_0x4f85e2,'authCode':_0x13dae6};this[_0x573477(0x176)][_0x573477(0x17a)]('发送验证请求数据:\x20'+JSON[_0x573477(0x156)](_0x3cbdd9,null,0x2));const _0xd2517f=await(0x0,baseRequest_1[_0x573477(0x137)])({'method':_0x573477(0x16f),'url':_0x573477(0x16c),'data':_0x3cbdd9});this[_0x573477(0x176)][_0x573477(0x17a)]('远程授权验证响应:\x20'+JSON[_0x573477(0x156)](_0xd2517f,null,0x2));if(_0xd2517f[_0x573477(0x14d)]==0x7){this[_0x573477(0x176)][_0x573477(0x17c)](_0x573477(0x144)+_0x4f85e2+_0x573477(0x166)+_0x13dae6);throw new common_1[(_0x573477(0x15a))](_0x573477(0x16e),common_1[_0x573477(0x177)]['FORBIDDEN']);}else{const _0x5882ce=new Date()[_0x573477(0x161)](),_0x5d73ae=_0x5882ce+hourTimer,_0x4f1042=wishCrypto_1[_0x573477(0x129)]['encrypt'](''+_0x5d73ae);this[_0x573477(0x176)][_0x573477(0x17a)]('授权验证通过，设置Redis缓存，过期时间:\x20'+new Date(_0x5d73ae)[_0x573477(0x14e)]()),await this['redisCacheService'][_0x573477(0x149)](_0x13dae6,_0x4f1042,0x3c*0x3c*0x1),_0x5e4841();}}catch(_0x29d076){this[_0x573477(0x176)]['error'](_0x573477(0x138),_0x29d076['stack']);throw new common_1[(_0x573477(0x15a))](_0x573477(0x16e),common_1[_0x573477(0x177)][_0x573477(0x16d)]);}}};function _0x364d(_0x22160a,_0x26f3a3){const _0x2e2eda=_0x2e2e();return _0x364d=function(_0x364daf,_0x28fb86){_0x364daf=_0x364daf-0x128;let _0x54bbbf=_0x2e2eda[_0x364daf];return _0x54bbbf;},_0x364d(_0x22160a,_0x26f3a3);}AuthorizationMiddleware=__decorate([(0x0,common_1[_0x13b635(0x128)])(),__metadata(_0x13b635(0x146),[typeorm_1[_0x13b635(0x14b)],redisCache_service_1[_0x13b635(0x17b)]])],AuthorizationMiddleware),exports['AuthorizationMiddleware']=AuthorizationMiddleware;