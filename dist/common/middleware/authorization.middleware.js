'use strict';const _0x18e29e=_0x2ff9;(function(_0x4dc015,_0x9073e9){const _0x24010d=_0x2ff9,_0x2e3df6=_0x4dc015();while(!![]){try{const _0x147e7c=parseInt(_0x24010d(0x101))/0x1+parseInt(_0x24010d(0x107))/0x2*(-parseInt(_0x24010d(0xc6))/0x3)+parseInt(_0x24010d(0xdf))/0x4*(-parseInt(_0x24010d(0xfb))/0x5)+-parseInt(_0x24010d(0x102))/0x6+parseInt(_0x24010d(0xf8))/0x7*(parseInt(_0x24010d(0xc5))/0x8)+-parseInt(_0x24010d(0xfc))/0x9+parseInt(_0x24010d(0xf7))/0xa*(parseInt(_0x24010d(0x103))/0xb);if(_0x147e7c===_0x9073e9)break;else _0x2e3df6['push'](_0x2e3df6['shift']());}catch(_0x46a0dc){_0x2e3df6['push'](_0x2e3df6['shift']());}}}(_0x3f32,0x20c41));var __decorate=this&&this[_0x18e29e(0xc1)]||function(_0x4d4a47,_0x5d39c1,_0x5ee63a,_0x3728e6){const _0x5accbe=_0x18e29e;var _0xdfcb83=arguments['length'],_0x1fe755=_0xdfcb83<0x3?_0x5d39c1:_0x3728e6===null?_0x3728e6=Object[_0x5accbe(0xfe)](_0x5d39c1,_0x5ee63a):_0x3728e6,_0x3753b7;if(typeof Reflect==='object'&&typeof Reflect['decorate']===_0x5accbe(0xef))_0x1fe755=Reflect[_0x5accbe(0xc8)](_0x4d4a47,_0x5d39c1,_0x5ee63a,_0x3728e6);else{for(var _0x338778=_0x4d4a47[_0x5accbe(0xcd)]-0x1;_0x338778>=0x0;_0x338778--)if(_0x3753b7=_0x4d4a47[_0x338778])_0x1fe755=(_0xdfcb83<0x3?_0x3753b7(_0x1fe755):_0xdfcb83>0x3?_0x3753b7(_0x5d39c1,_0x5ee63a,_0x1fe755):_0x3753b7(_0x5d39c1,_0x5ee63a))||_0x1fe755;}return _0xdfcb83>0x3&&_0x1fe755&&Object[_0x5accbe(0x104)](_0x5d39c1,_0x5ee63a,_0x1fe755),_0x1fe755;},__metadata=this&&this[_0x18e29e(0xde)]||function(_0x38416,_0x3a81d8){const _0x43472c=_0x18e29e;if(typeof Reflect===_0x43472c(0xf9)&&typeof Reflect[_0x43472c(0xd8)]===_0x43472c(0xef))return Reflect['metadata'](_0x38416,_0x3a81d8);};Object['defineProperty'](exports,_0x18e29e(0xbf),{'value':!![]}),exports['AuthorizationMiddleware']=void 0x0;function _0x3f32(){const _0x491ff8=['AuthorizationMiddleware','default','../utils/wishCrypto','length','connection','baseRequest','Actual\x20host:\x20','x-forwarded-proto','stack','query','授权验证发生错误','wishGet','授权验证失败:\x20url=','站点尚未授权:\x20未找到授权码','metadata','HttpStatus','error','code','/api/config/setKey','typeorm','__metadata','220blVHls','FORBIDDEN','headers','Connection','ISDEV','Injectable','getTime','use','设置授权码接口，跳过验证','design:paramtypes','Redis缓存验证:\x20当前时间=','encrypt','decrypt','开始远程授权验证','SELECT\x20configVal\x20FROM\x20config\x20WHERE\x20configKey=?','../utils/baseRequest','function','使用缓存验证通过','http://authorization.nodeai.cn/api/domainAuth/checkDomain/mechat','未命中','host','授权验证通过，设置Redis缓存，过期时间:\x20','远程授权验证响应:\x20code=','logger','1270gwxBNg','152684VFxjgq','object','wishSet','2395ReNJPN','717498cjRxFN','data','getOwnPropertyDescriptor','从数据库获取授权码:\x20','x-forwarded-host','110544BgZBWA','35490UofQng','19217AAUOJX','defineProperty','站点未授权','log','76mebDwL','env','__esModule','true','__decorate','toISOString',',\x20protocol:\x20','redisCacheService','56DBclQq','18861aOzDEe','\x20code=','decorate','HttpException'];_0x3f32=function(){return _0x491ff8;};return _0x3f32();}const common_1=require('@nestjs/common'),typeorm_1=require(_0x18e29e(0xdd)),redisCache_service_1=require('../../modules/redisCache/redisCache.service'),baseRequest_1=require(_0x18e29e(0xee)),wishCrypto_1=require(_0x18e29e(0xcc)),hourTimer=0x3c*0x3c*0x3e8;let AuthorizationMiddleware=class AuthorizationMiddleware{constructor(_0x4de480,_0x32e2e3){const _0x3ecc82=_0x18e29e;this[_0x3ecc82(0xce)]=_0x4de480,this[_0x3ecc82(0xc4)]=_0x32e2e3,this['logger']=new common_1['Logger'](_0x3ecc82(0xca));}async[_0x18e29e(0xe6)](_0x4161c0,_0x2cfeba,_0x2d3eda){const _0x120dad=_0x18e29e;var _0x21a2ee;const _0x39c361=_0x4161c0[_0x120dad(0xe1)][_0x120dad(0x100)]||_0x4161c0[_0x120dad(0xe1)][_0x120dad(0xf3)],_0x5ed493=_0x4161c0[_0x120dad(0xe1)][_0x120dad(0xd1)]||_0x4161c0['protocol'],_0x3b8b44=''+_0x39c361;this[_0x120dad(0xf6)][_0x120dad(0x106)](_0x120dad(0xd0)+_0x39c361+_0x120dad(0xc3)+_0x5ed493);if(_0x4161c0['originalUrl']==_0x120dad(0xdc))return this[_0x120dad(0xf6)][_0x120dad(0x106)](_0x120dad(0xe7)),_0x2d3eda();if(process[_0x120dad(0x108)][_0x120dad(0xe3)]===_0x120dad(0xc0))return _0x2d3eda();try{const _0x5ae274='rocketAiKey';let _0x134c87=await this[_0x120dad(0xce)][_0x120dad(0xd3)](_0x120dad(0xed),[_0x5ae274]);_0x134c87=(_0x21a2ee=_0x134c87[0x0])===null||_0x21a2ee===void 0x0?void 0x0:_0x21a2ee['configVal'],this[_0x120dad(0xf6)][_0x120dad(0x106)](_0x120dad(0xff)+(_0x134c87?'成功':'未找到'));if(!_0x134c87)return this['logger'][_0x120dad(0xda)](_0x120dad(0xd7)),_0x2cfeba['status'](0x193)['json']({'message':'站点尚未授权'});const _0x3f682b=await this[_0x120dad(0xc4)][_0x120dad(0xd5)](_0x134c87);this[_0x120dad(0xf6)][_0x120dad(0x106)]('Redis缓存状态:\x20'+(_0x3f682b?'命中':_0x120dad(0xf2)));if(_0x3f682b)try{const _0x1825d1=new Date()[_0x120dad(0xe5)](),_0x56c982=wishCrypto_1[_0x120dad(0xcb)][_0x120dad(0xeb)](_0x3f682b);this[_0x120dad(0xf6)][_0x120dad(0x106)](_0x120dad(0xe9)+_0x1825d1+',\x20过期时间='+_0x56c982);if(_0x1825d1<Number(_0x56c982))return this[_0x120dad(0xf6)][_0x120dad(0x106)](_0x120dad(0xf0)),_0x2d3eda();}catch(_0x1a53fe){this[_0x120dad(0xf6)]['error']('Redis缓存解密失败:\x20url='+_0x3b8b44+_0x120dad(0xc7)+_0x134c87+'\x20redisVal='+_0x3f682b,_0x1a53fe['stack']);}this[_0x120dad(0xf6)]['log'](_0x120dad(0xec));const _0x4b32ec=await(0x0,baseRequest_1[_0x120dad(0xcf)])({'method':'post','url':_0x120dad(0xf1),'data':{'domain':_0x3b8b44,'authCode':_0x134c87}});this['logger'][_0x120dad(0x106)](_0x120dad(0xf5)+_0x4b32ec[_0x120dad(0xdb)]+',\x20data='+_0x4b32ec[_0x120dad(0xfd)]);if(_0x4b32ec['code']==0x7){this['logger'][_0x120dad(0xda)](_0x120dad(0xd6)+_0x3b8b44+'\x20code='+_0x134c87);throw new common_1['HttpException'](_0x120dad(0x105),common_1[_0x120dad(0xd9)][_0x120dad(0xe0)]);}else{const _0x4f8f6f=new Date()[_0x120dad(0xe5)](),_0x94df2=_0x4f8f6f+hourTimer,_0x36957a=wishCrypto_1[_0x120dad(0xcb)][_0x120dad(0xea)](''+_0x94df2);this[_0x120dad(0xf6)][_0x120dad(0x106)](_0x120dad(0xf4)+new Date(_0x94df2)[_0x120dad(0xc2)]()),await this[_0x120dad(0xc4)][_0x120dad(0xfa)](_0x134c87,_0x36957a,0x3c*0x3c*0x1),_0x2d3eda();}}catch(_0x2ae5ce){this[_0x120dad(0xf6)][_0x120dad(0xda)](_0x120dad(0xd4),_0x2ae5ce[_0x120dad(0xd2)]);throw new common_1[(_0x120dad(0xc9))](_0x120dad(0x105),common_1['HttpStatus'][_0x120dad(0xe0)]);}}};function _0x2ff9(_0x10be1f,_0x1f6f41){const _0x3f32a6=_0x3f32();return _0x2ff9=function(_0x2ff94b,_0x57b4c3){_0x2ff94b=_0x2ff94b-0xbf;let _0x5a6d09=_0x3f32a6[_0x2ff94b];return _0x5a6d09;},_0x2ff9(_0x10be1f,_0x1f6f41);}AuthorizationMiddleware=__decorate([(0x0,common_1[_0x18e29e(0xe4)])(),__metadata(_0x18e29e(0xe8),[typeorm_1[_0x18e29e(0xe2)],redisCache_service_1['RedisCacheService']])],AuthorizationMiddleware),exports[_0x18e29e(0xca)]=AuthorizationMiddleware;