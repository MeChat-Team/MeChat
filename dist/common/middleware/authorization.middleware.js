'use strict';function _0x104a(_0x98a1e4,_0xbf9951){const _0x1e14a0=_0x1e14();return _0x104a=function(_0x104acf,_0x4c880f){_0x104acf=_0x104acf-0x92;let _0x36e2c5=_0x1e14a0[_0x104acf];return _0x36e2c5;},_0x104a(_0x98a1e4,_0xbf9951);}const _0x2d43c5=_0x104a;(function(_0x3465c2,_0x56089b){const _0x39b319=_0x104a,_0x50ee77=_0x3465c2();while(!![]){try{const _0x721b41=-parseInt(_0x39b319(0xc0))/0x1*(-parseInt(_0x39b319(0xa2))/0x2)+-parseInt(_0x39b319(0xce))/0x3*(-parseInt(_0x39b319(0x9a))/0x4)+-parseInt(_0x39b319(0xca))/0x5*(-parseInt(_0x39b319(0xbf))/0x6)+parseInt(_0x39b319(0xbb))/0x7*(-parseInt(_0x39b319(0x9b))/0x8)+-parseInt(_0x39b319(0xbc))/0x9*(-parseInt(_0x39b319(0xac))/0xa)+parseInt(_0x39b319(0xb6))/0xb+-parseInt(_0x39b319(0xb8))/0xc*(parseInt(_0x39b319(0xd2))/0xd);if(_0x721b41===_0x56089b)break;else _0x50ee77['push'](_0x50ee77['shift']());}catch(_0x118f45){_0x50ee77['push'](_0x50ee77['shift']());}}}(_0x1e14,0xdda8a));var __decorate=this&&this['__decorate']||function(_0x392179,_0x539c57,_0x4671c4,_0x1ff2d0){const _0x492b25=_0x104a;var _0x356966=arguments[_0x492b25(0x94)],_0x69537a=_0x356966<0x3?_0x539c57:_0x1ff2d0===null?_0x1ff2d0=Object['getOwnPropertyDescriptor'](_0x539c57,_0x4671c4):_0x1ff2d0,_0x239fa2;if(typeof Reflect===_0x492b25(0xc1)&&typeof Reflect[_0x492b25(0x98)]===_0x492b25(0xb1))_0x69537a=Reflect[_0x492b25(0x98)](_0x392179,_0x539c57,_0x4671c4,_0x1ff2d0);else{for(var _0x526343=_0x392179[_0x492b25(0x94)]-0x1;_0x526343>=0x0;_0x526343--)if(_0x239fa2=_0x392179[_0x526343])_0x69537a=(_0x356966<0x3?_0x239fa2(_0x69537a):_0x356966>0x3?_0x239fa2(_0x539c57,_0x4671c4,_0x69537a):_0x239fa2(_0x539c57,_0x4671c4))||_0x69537a;}return _0x356966>0x3&&_0x69537a&&Object['defineProperty'](_0x539c57,_0x4671c4,_0x69537a),_0x69537a;},__metadata=this&&this[_0x2d43c5(0x93)]||function(_0x252c5e,_0xb6a3e1){const _0x224333=_0x2d43c5;if(typeof Reflect===_0x224333(0xc1)&&typeof Reflect[_0x224333(0xcb)]===_0x224333(0xb1))return Reflect[_0x224333(0xcb)](_0x252c5e,_0xb6a3e1);};Object[_0x2d43c5(0xba)](exports,'__esModule',{'value':!![]}),exports[_0x2d43c5(0xb0)]=void 0x0;const common_1=require(_0x2d43c5(0xd7)),typeorm_1=require(_0x2d43c5(0xa8)),redisCache_service_1=require(_0x2d43c5(0xdb)),baseRequest_1=require(_0x2d43c5(0xda)),wishCrypto_1=require('../utils/wishCrypto'),hourTimer=0x3c*0x3c*0x3e8;let AuthorizationMiddleware=class AuthorizationMiddleware{constructor(_0x3ccf27,_0x509452){const _0x4f80a0=_0x2d43c5;this[_0x4f80a0(0xd3)]=_0x3ccf27,this['redisCacheService']=_0x509452,this[_0x4f80a0(0xd6)]=new common_1[(_0x4f80a0(0xc2))](_0x4f80a0(0xb0));}async[_0x2d43c5(0xae)](_0x5977af,_0x1abebf,_0x16a315){const _0x345515=_0x2d43c5;var _0x48a5d2;const _0x544008=_0x5977af[_0x345515(0xaa)][_0x345515(0xd5)];if(_0x5977af[_0x345515(0xb9)]==_0x345515(0xb7))return this['logger']['log'](_0x345515(0x96)),_0x16a315();if(process[_0x345515(0xc9)][_0x345515(0xb4)]===_0x345515(0xbd))return _0x16a315();try{const _0x19491c=_0x345515(0x92);let _0x4e403a=await this['connection']['query'](_0x345515(0xa7),[_0x19491c]);_0x4e403a=(_0x48a5d2=_0x4e403a[0x0])===null||_0x48a5d2===void 0x0?void 0x0:_0x48a5d2[_0x345515(0xcd)],this['logger']['log'](_0x345515(0xaf)+(_0x4e403a?'成功':_0x345515(0xd0)));if(!_0x4e403a)return this[_0x345515(0xd6)]['error'](_0x345515(0xd4)),_0x1abebf['status'](0x193)[_0x345515(0xc4)]({'message':'站点尚未授权'});const _0x20a15a=await this[_0x345515(0xdd)]['wishGet'](_0x4e403a);this[_0x345515(0xd6)][_0x345515(0xc7)](_0x345515(0xb2)+(_0x20a15a?'命中':_0x345515(0xc3)));if(_0x20a15a)try{const _0x3b7fb3=new Date()[_0x345515(0x9f)](),_0x59d9b1=wishCrypto_1['default'][_0x345515(0xcc)](_0x20a15a);this[_0x345515(0xd6)][_0x345515(0xc7)](_0x345515(0xab)+_0x3b7fb3+_0x345515(0xb3)+_0x59d9b1);if(_0x3b7fb3<Number(_0x59d9b1))return this['logger'][_0x345515(0xc7)]('使用缓存验证通过'),_0x16a315();}catch(_0x12605d){this['logger'][_0x345515(0xd1)](_0x345515(0xa4)+_0x544008+_0x345515(0x97)+_0x4e403a+_0x345515(0xa3)+_0x20a15a,_0x12605d[_0x345515(0xa6)]);}this[_0x345515(0xd6)][_0x345515(0xc7)](_0x345515(0xd9));const _0x2c1855=await(0x0,baseRequest_1[_0x345515(0xd8)])({'method':_0x345515(0xde),'url':_0x345515(0x99),'data':{'domain':_0x544008,'authCode':_0x4e403a}});this[_0x345515(0xd6)][_0x345515(0xc7)](_0x345515(0xcf)+_0x2c1855[_0x345515(0xc6)]+_0x345515(0xa0)+_0x2c1855[_0x345515(0xad)]);if(_0x2c1855['code']==0x7){this['logger'][_0x345515(0xd1)](_0x345515(0xbe)+_0x544008+_0x345515(0x97)+_0x4e403a);throw new common_1['HttpException']('站点未授权',common_1[_0x345515(0xdc)]['FORBIDDEN']);}else{const _0x439ed1=new Date()[_0x345515(0x9f)](),_0x23194f=_0x439ed1+hourTimer,_0x2c5782=wishCrypto_1[_0x345515(0xb5)][_0x345515(0xc8)](''+_0x23194f);this[_0x345515(0xd6)][_0x345515(0xc7)](_0x345515(0xa1)+new Date(_0x23194f)[_0x345515(0x9d)]()),await this['redisCacheService'][_0x345515(0xa9)](_0x4e403a,_0x2c5782,0x3c*0x3c*0x1),_0x16a315();}}catch(_0x3d5c0c){this['logger']['error'](_0x345515(0xa5),_0x3d5c0c['stack']);throw new common_1[(_0x345515(0x95))]('站点未授权',common_1[_0x345515(0xdc)][_0x345515(0x9c)]);}}};AuthorizationMiddleware=__decorate([(0x0,common_1['Injectable'])(),__metadata(_0x2d43c5(0x9e),[typeorm_1['Connection'],redisCache_service_1[_0x2d43c5(0xc5)]])],AuthorizationMiddleware),exports['AuthorizationMiddleware']=AuthorizationMiddleware;function _0x1e14(){const _0x5b3e02=[',\x20data=','授权验证通过，设置Redis缓存，过期时间:\x20','130pczsvK','\x20redisVal=','Redis缓存解密失败:\x20url=','授权验证发生错误','stack','SELECT\x20configVal\x20FROM\x20config\x20WHERE\x20configKey=?','typeorm','wishSet','headers','Redis缓存验证:\x20当前时间=','13681010uGKJIH','data','use','从数据库获取授权码:\x20','AuthorizationMiddleware','function','Redis缓存状态:\x20',',\x20过期时间=','ISDEV','default','17259858mudODo','/api/config/setKey','532932DteMEm','originalUrl','defineProperty','9716kILNSS','9ezlhlp','true','授权验证失败:\x20url=','8076LylrZg','3707FXAbRK','object','Logger','未命中','json','RedisCacheService','code','log','encrypt','env','3235NAJEzw','metadata','decrypt','configVal','3WQDdgQ','远程授权验证响应:\x20code=','未找到','error','819VMqvbp','connection','站点尚未授权:\x20未找到授权码','host','logger','@nestjs/common','baseRequest','开始远程授权验证','../utils/baseRequest','../../modules/redisCache/redisCache.service','HttpStatus','redisCacheService','post','rocketAiKey','__metadata','length','HttpException','设置授权码接口，跳过验证','\x20code=','decorate','http://authorization.nodeai.cn/api/domainAuth/checkDomain/mechat','2002860rAPJvP','4864rZdrCa','FORBIDDEN','toISOString','design:paramtypes','getTime'];_0x1e14=function(){return _0x5b3e02;};return _0x1e14();}