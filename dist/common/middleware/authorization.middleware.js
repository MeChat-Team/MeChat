'use strict';const _0x7d9426=_0x15f1;(function(_0x27a708,_0xc38f8){const _0xdec4a9=_0x15f1,_0x15177e=_0x27a708();while(!![]){try{const _0xb9ad6d=-parseInt(_0xdec4a9(0x138))/0x1+parseInt(_0xdec4a9(0x152))/0x2*(parseInt(_0xdec4a9(0x153))/0x3)+-parseInt(_0xdec4a9(0x14a))/0x4+-parseInt(_0xdec4a9(0x12a))/0x5*(parseInt(_0xdec4a9(0x158))/0x6)+-parseInt(_0xdec4a9(0x145))/0x7+-parseInt(_0xdec4a9(0x126))/0x8*(-parseInt(_0xdec4a9(0x128))/0x9)+parseInt(_0xdec4a9(0x11e))/0xa*(parseInt(_0xdec4a9(0x155))/0xb);if(_0xb9ad6d===_0xc38f8)break;else _0x15177e['push'](_0x15177e['shift']());}catch(_0x5b179c){_0x15177e['push'](_0x15177e['shift']());}}}(_0x266e,0x46cca));var __decorate=this&&this[_0x7d9426(0x156)]||function(_0x48f48a,_0x51cf50,_0x5aea8c,_0x2c6a4c){const _0x59765e=_0x7d9426;var _0x4657bc=arguments[_0x59765e(0x127)],_0x1f1ad3=_0x4657bc<0x3?_0x51cf50:_0x2c6a4c===null?_0x2c6a4c=Object[_0x59765e(0x122)](_0x51cf50,_0x5aea8c):_0x2c6a4c,_0x9ca55b;if(typeof Reflect===_0x59765e(0x12d)&&typeof Reflect[_0x59765e(0x120)]==='function')_0x1f1ad3=Reflect[_0x59765e(0x120)](_0x48f48a,_0x51cf50,_0x5aea8c,_0x2c6a4c);else{for(var _0x18bc03=_0x48f48a[_0x59765e(0x127)]-0x1;_0x18bc03>=0x0;_0x18bc03--)if(_0x9ca55b=_0x48f48a[_0x18bc03])_0x1f1ad3=(_0x4657bc<0x3?_0x9ca55b(_0x1f1ad3):_0x4657bc>0x3?_0x9ca55b(_0x51cf50,_0x5aea8c,_0x1f1ad3):_0x9ca55b(_0x51cf50,_0x5aea8c))||_0x1f1ad3;}return _0x4657bc>0x3&&_0x1f1ad3&&Object[_0x59765e(0x130)](_0x51cf50,_0x5aea8c,_0x1f1ad3),_0x1f1ad3;},__metadata=this&&this[_0x7d9426(0x150)]||function(_0x32d624,_0x468cee){const _0x7cc96e=_0x7d9426;if(typeof Reflect===_0x7cc96e(0x12d)&&typeof Reflect['metadata']==='function')return Reflect[_0x7cc96e(0x121)](_0x32d624,_0x468cee);},AuthorizationMiddleware_1;Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports['AuthorizationMiddleware']=void 0x0;const common_1=require('@nestjs/common'),typeorm_1=require(_0x7d9426(0x143)),redisCache_service_1=require(_0x7d9426(0x142)),baseRequest_1=require(_0x7d9426(0x12e)),wishCrypto_1=require('../utils/wishCrypto'),hourTimer=0x3c*0x3c*0x3e8;function _0x15f1(_0x4b47bd,_0xf814c0){const _0x266ebe=_0x266e();return _0x15f1=function(_0x15f183,_0x26692e){_0x15f183=_0x15f183-0x11d;let _0x30a86e=_0x266ebe[_0x15f183];return _0x30a86e;},_0x15f1(_0x4b47bd,_0xf814c0);}let AuthorizationMiddleware=AuthorizationMiddleware_1=class AuthorizationMiddleware{constructor(_0x4dc582,_0x4fa6c5){const _0x570446=_0x7d9426;this[_0x570446(0x12f)]=_0x4dc582,this[_0x570446(0x12b)]=_0x4fa6c5,this[_0x570446(0x15a)]=new common_1['Logger'](AuthorizationMiddleware_1['name']);}async[_0x7d9426(0x144)](_0x14f3fc,_0x483e18,_0x33366e){const _0x47441b=_0x7d9426;var _0x4d9b0c,_0x43e974;const _0x117c93=_0x14f3fc['headers']['x-forwarded-host']||_0x14f3fc[_0x47441b(0x151)][_0x47441b(0x132)],_0x36cfab=((_0x4d9b0c=_0x117c93===null||_0x117c93===void 0x0?void 0x0:_0x117c93['split'](':'))===null||_0x4d9b0c===void 0x0?void 0x0:_0x4d9b0c[0x0])||'';if(_0x14f3fc['originalUrl']==_0x47441b(0x13c))return this[_0x47441b(0x15a)][_0x47441b(0x13e)]('Received\x20a\x20request\x20to\x20/api/config/setKey'),_0x33366e();if(process['env'][_0x47441b(0x14f)]===_0x47441b(0x141))return _0x33366e();try{const _0x573aeb=_0x47441b(0x135);let _0x34f91d=await this[_0x47441b(0x12f)]['query'](_0x47441b(0x125),[_0x573aeb]);_0x34f91d=(_0x43e974=_0x34f91d[0x0])===null||_0x43e974===void 0x0?void 0x0:_0x43e974[_0x47441b(0x129)];if(!_0x34f91d)return this[_0x47441b(0x15a)]['error'](_0x47441b(0x124)),_0x483e18[_0x47441b(0x136)](0x193)[_0x47441b(0x14d)]({'message':_0x47441b(0x11f)});const _0x31796a=await this['redisCacheService'][_0x47441b(0x154)](_0x34f91d);if(_0x31796a)try{const _0xc4ae06=new Date()[_0x47441b(0x157)](),_0x185dd9=wishCrypto_1[_0x47441b(0x133)][_0x47441b(0x12c)](_0x31796a);if(_0xc4ae06<Number(_0x185dd9))return _0x33366e();}catch(_0x568fb2){this[_0x47441b(0x15a)][_0x47441b(0x14e)](_0x47441b(0x131)+_0x36cfab+'\x20code:'+_0x34f91d+_0x47441b(0x139)+_0x31796a);}const _0xc7207={'domain':_0x36cfab,'authCode':_0x34f91d};this['logger'][_0x47441b(0x14e)]('授权验证请求：url:'+_0x36cfab+_0x47441b(0x11d)+_0x34f91d);const _0x4e5677=await(0x0,baseRequest_1[_0x47441b(0x159)])({'method':'post','url':_0x47441b(0x147),'data':_0xc7207});if(_0x4e5677[_0x47441b(0x14b)]==0x7)throw new common_1['HttpException'](_0x47441b(0x149),common_1['HttpStatus'][_0x47441b(0x140)]);else{const _0x1d42dc=new Date()[_0x47441b(0x157)](),_0x3d57aa=_0x1d42dc+hourTimer,_0x41b99c=wishCrypto_1[_0x47441b(0x133)][_0x47441b(0x137)](''+_0x3d57aa);await this[_0x47441b(0x12b)][_0x47441b(0x148)](_0x34f91d,_0x41b99c,0x3c*0x3c*0x1),_0x33366e();}}catch(_0x48148f){this['logger'][_0x47441b(0x13d)](_0x47441b(0x13a)+(_0x48148f[_0x47441b(0x13f)]||_0x48148f)),_0x483e18[_0x47441b(0x136)](0x1f4)['json']({'message':_0x47441b(0x13b)});}}};AuthorizationMiddleware=AuthorizationMiddleware_1=__decorate([(0x0,common_1['Injectable'])(),__metadata(_0x7d9426(0x123),[typeorm_1[_0x7d9426(0x134)],redisCache_service_1[_0x7d9426(0x14c)]])],AuthorizationMiddleware),exports[_0x7d9426(0x146)]=AuthorizationMiddleware;function _0x266e(){const _0x107483=['站点未授权','1623444XrkibC','code','RedisCacheService','json','debug','ISDEV','__metadata','headers','2qtIlCn','1532553uVSMux','wishGet','761156hcPXGi','__decorate','getTime','1466274ZYWtVQ','baseRequest','logger','\x20code:','190xrFYjP','站点尚未授权','decorate','metadata','getOwnPropertyDescriptor','design:paramtypes','站点尚未授权:\x20未找到授权码','SELECT\x20configVal\x20FROM\x20config\x20WHERE\x20configKey=?','14360pnvnBW','length','477IkBDqi','configVal','5OEgDof','redisCacheService','decrypt','object','../utils/baseRequest','connection','defineProperty','授权验证失败：解密缓存失败\x20url:','host','default','Connection','rocketAiKey','status','encrypt','429019ZEuSCb','\x20redisVal:','授权失败:\x20','授权未通过','/api/config/setKey','error','log','message','FORBIDDEN','true','../../modules/redisCache/redisCache.service','typeorm','use','3860199Rlyzpx','AuthorizationMiddleware','http://authorization.nodeai.cn/api/domainAuth/checkDomain/mechat','wishSet'];_0x266e=function(){return _0x107483;};return _0x266e();}