'use strict';const _0x399b4e=_0x5a2f;(function(_0xaad5c2,_0x37022e){const _0x896ad9=_0x5a2f,_0x145844=_0xaad5c2();while(!![]){try{const _0x3676d9=-parseInt(_0x896ad9(0x84))/0x1+parseInt(_0x896ad9(0x87))/0x2*(parseInt(_0x896ad9(0x82))/0x3)+parseInt(_0x896ad9(0xa5))/0x4*(-parseInt(_0x896ad9(0x68))/0x5)+parseInt(_0x896ad9(0x9c))/0x6*(parseInt(_0x896ad9(0x93))/0x7)+parseInt(_0x896ad9(0x6a))/0x8+parseInt(_0x896ad9(0x9d))/0x9+parseInt(_0x896ad9(0x8a))/0xa;if(_0x3676d9===_0x37022e)break;else _0x145844['push'](_0x145844['shift']());}catch(_0x54a395){_0x145844['push'](_0x145844['shift']());}}}(_0x3a36,0x2a378));var __decorate=this&&this['__decorate']||function(_0x3704fe,_0x20f971,_0x287fd7,_0x4e39c6){const _0x1cc4a4=_0x5a2f;var _0x5480e4=arguments['length'],_0x28b065=_0x5480e4<0x3?_0x20f971:_0x4e39c6===null?_0x4e39c6=Object[_0x1cc4a4(0x85)](_0x20f971,_0x287fd7):_0x4e39c6,_0x320a25;if(typeof Reflect===_0x1cc4a4(0xa0)&&typeof Reflect[_0x1cc4a4(0x94)]===_0x1cc4a4(0x71))_0x28b065=Reflect[_0x1cc4a4(0x94)](_0x3704fe,_0x20f971,_0x287fd7,_0x4e39c6);else{for(var _0x1fb1ce=_0x3704fe[_0x1cc4a4(0x6f)]-0x1;_0x1fb1ce>=0x0;_0x1fb1ce--)if(_0x320a25=_0x3704fe[_0x1fb1ce])_0x28b065=(_0x5480e4<0x3?_0x320a25(_0x28b065):_0x5480e4>0x3?_0x320a25(_0x20f971,_0x287fd7,_0x28b065):_0x320a25(_0x20f971,_0x287fd7))||_0x28b065;}return _0x5480e4>0x3&&_0x28b065&&Object[_0x1cc4a4(0x89)](_0x20f971,_0x287fd7,_0x28b065),_0x28b065;},__metadata=this&&this[_0x399b4e(0x99)]||function(_0x40f461,_0x2d68cd){const _0x2bbb7c=_0x399b4e;if(typeof Reflect===_0x2bbb7c(0xa0)&&typeof Reflect[_0x2bbb7c(0x78)]===_0x2bbb7c(0x71))return Reflect[_0x2bbb7c(0x78)](_0x40f461,_0x2d68cd);},AuthorizationMiddleware_1;Object[_0x399b4e(0x89)](exports,_0x399b4e(0x90),{'value':!![]}),exports[_0x399b4e(0x7d)]=void 0x0;const common_1=require(_0x399b4e(0x88)),typeorm_1=require(_0x399b4e(0x98)),redisCache_service_1=require(_0x399b4e(0x81)),baseRequest_1=require(_0x399b4e(0x73)),wishCrypto_1=require(_0x399b4e(0xa4)),hourTimer=0x3c*0x3c*0x3e8;function _0x3a36(){const _0x50ea98=['status','Connection','../utils/wishCrypto','234676ugsJmz','\x20redisVal:','5erNqoP','logger','187136bmZory','http://authorization.nodeai.cn/api/domainAuth/checkDomain/rocket','headers','redisCacheService','\x20code:','length','encrypt','function','站点未授权','../utils/baseRequest','授权未通过','default','x-forwarded-host','授权失败:\x20','metadata','baseRequest','query','decrypt','/api/config/setKey','AuthorizationMiddleware','design:paramtypes','log','wishSet','../../modules/redisCache/redisCache.service','98148bCXtWr','Logger','61606ADELcZ','getOwnPropertyDescriptor','connection','2pnnGmr','@nestjs/common','defineProperty','291020EOQUzE','error','json','授权验证请求：url:','debug','env','__esModule','wishGet','getTime','66507exAWHb','decorate','message','post','originalUrl','typeorm','__metadata','SELECT\x20configVal\x20FROM\x20config\x20WHERE\x20configKey=?','WISH_ISDEV','114bziUZs','247194iAKlTp','站点尚未授权:\x20未找到授权码','HttpException','object','Received\x20a\x20request\x20to\x20/api/config/setKey'];_0x3a36=function(){return _0x50ea98;};return _0x3a36();}let AuthorizationMiddleware=AuthorizationMiddleware_1=class AuthorizationMiddleware{constructor(_0x177fba,_0x2d14c3){const _0x1ed8f8=_0x399b4e;this[_0x1ed8f8(0x86)]=_0x177fba,this[_0x1ed8f8(0x6d)]=_0x2d14c3,this[_0x1ed8f8(0x69)]=new common_1[(_0x1ed8f8(0x83))](AuthorizationMiddleware_1['name']);}async['use'](_0x1b0a16,_0x388d7d,_0x446ae9){const _0x592057=_0x399b4e;var _0x274ec4,_0x343a73;const _0x5c123b=_0x1b0a16[_0x592057(0x6c)][_0x592057(0x76)]||_0x1b0a16[_0x592057(0x6c)]['host'],_0x293c1d=((_0x274ec4=_0x5c123b===null||_0x5c123b===void 0x0?void 0x0:_0x5c123b['split'](':'))===null||_0x274ec4===void 0x0?void 0x0:_0x274ec4[0x0])||'';if(_0x1b0a16[_0x592057(0x97)]==_0x592057(0x7c))return this[_0x592057(0x69)][_0x592057(0x7f)](_0x592057(0xa1)),_0x446ae9();if(process[_0x592057(0x8f)][_0x592057(0x9b)]==='true')return _0x446ae9();try{const _0xd276c3='rocketAiKey';let _0x581c13=await this[_0x592057(0x86)][_0x592057(0x7a)](_0x592057(0x9a),[_0xd276c3]);_0x581c13=(_0x343a73=_0x581c13[0x0])===null||_0x343a73===void 0x0?void 0x0:_0x343a73['configVal'];if(!_0x581c13)return this[_0x592057(0x69)][_0x592057(0x8b)](_0x592057(0x9e)),_0x388d7d[_0x592057(0xa2)](0x193)[_0x592057(0x8c)]({'message':'站点尚未授权'});const _0x21062b=await this[_0x592057(0x6d)][_0x592057(0x91)](_0x581c13);if(_0x21062b)try{const _0x4b41e5=new Date()[_0x592057(0x92)](),_0x48781b=wishCrypto_1[_0x592057(0x75)][_0x592057(0x7b)](_0x21062b);if(_0x4b41e5<Number(_0x48781b))return _0x446ae9();}catch(_0x1827f0){this[_0x592057(0x69)][_0x592057(0x8e)]('授权验证失败：解密缓存失败\x20url:'+_0x293c1d+_0x592057(0x6e)+_0x581c13+_0x592057(0xa6)+_0x21062b);}const _0x75b512={'domain':_0x293c1d,'authCode':_0x581c13};this[_0x592057(0x69)][_0x592057(0x8e)](_0x592057(0x8d)+_0x293c1d+_0x592057(0x6e)+_0x581c13);const _0x4c359e=await(0x0,baseRequest_1[_0x592057(0x79)])({'method':_0x592057(0x96),'url':_0x592057(0x6b),'data':_0x75b512});if(_0x4c359e['code']==0x7)throw new common_1[(_0x592057(0x9f))](_0x592057(0x72),common_1['HttpStatus']['FORBIDDEN']);else{const _0x4fa319=new Date()[_0x592057(0x92)](),_0xea575b=_0x4fa319+hourTimer,_0x2f080f=wishCrypto_1[_0x592057(0x75)][_0x592057(0x70)](''+_0xea575b);await this[_0x592057(0x6d)][_0x592057(0x80)](_0x581c13,_0x2f080f,0x3c*0x3c*0x1),_0x446ae9();}}catch(_0x3ac441){this[_0x592057(0x69)][_0x592057(0x8b)](_0x592057(0x77)+(_0x3ac441[_0x592057(0x95)]||_0x3ac441)),_0x388d7d['status'](0x1f4)[_0x592057(0x8c)]({'message':_0x592057(0x74)});}}};function _0x5a2f(_0x395072,_0x49e155){const _0x3a36aa=_0x3a36();return _0x5a2f=function(_0x5a2f9f,_0x364d34){_0x5a2f9f=_0x5a2f9f-0x68;let _0x5ecdcd=_0x3a36aa[_0x5a2f9f];return _0x5ecdcd;},_0x5a2f(_0x395072,_0x49e155);}AuthorizationMiddleware=AuthorizationMiddleware_1=__decorate([(0x0,common_1['Injectable'])(),__metadata(_0x399b4e(0x7e),[typeorm_1[_0x399b4e(0xa3)],redisCache_service_1['RedisCacheService']])],AuthorizationMiddleware),exports[_0x399b4e(0x7d)]=AuthorizationMiddleware;