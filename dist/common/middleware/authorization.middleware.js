'use strict';const _0x19844d=_0x5559;(function(_0x2d2b05,_0x584531){const _0x31e81d=_0x5559,_0x5a7b45=_0x2d2b05();while(!![]){try{const _0x794e63=parseInt(_0x31e81d(0x125))/0x1+-parseInt(_0x31e81d(0x12a))/0x2*(-parseInt(_0x31e81d(0x137))/0x3)+-parseInt(_0x31e81d(0x139))/0x4+-parseInt(_0x31e81d(0x135))/0x5*(parseInt(_0x31e81d(0x12d))/0x6)+parseInt(_0x31e81d(0x130))/0x7*(-parseInt(_0x31e81d(0x115))/0x8)+-parseInt(_0x31e81d(0x145))/0x9+parseInt(_0x31e81d(0x12f))/0xa;if(_0x794e63===_0x584531)break;else _0x5a7b45['push'](_0x5a7b45['shift']());}catch(_0xb21512){_0x5a7b45['push'](_0x5a7b45['shift']());}}}(_0x2cdc,0xc20d5));var __decorate=this&&this[_0x19844d(0x118)]||function(_0x1d856c,_0x133520,_0x2d3150,_0x3f1e52){const _0x1c3975=_0x19844d;var _0x5e8746=arguments['length'],_0x31ddb0=_0x5e8746<0x3?_0x133520:_0x3f1e52===null?_0x3f1e52=Object[_0x1c3975(0x124)](_0x133520,_0x2d3150):_0x3f1e52,_0xa87701;if(typeof Reflect==='object'&&typeof Reflect[_0x1c3975(0x131)]===_0x1c3975(0x13e))_0x31ddb0=Reflect['decorate'](_0x1d856c,_0x133520,_0x2d3150,_0x3f1e52);else{for(var _0x1b4d2b=_0x1d856c['length']-0x1;_0x1b4d2b>=0x0;_0x1b4d2b--)if(_0xa87701=_0x1d856c[_0x1b4d2b])_0x31ddb0=(_0x5e8746<0x3?_0xa87701(_0x31ddb0):_0x5e8746>0x3?_0xa87701(_0x133520,_0x2d3150,_0x31ddb0):_0xa87701(_0x133520,_0x2d3150))||_0x31ddb0;}return _0x5e8746>0x3&&_0x31ddb0&&Object[_0x1c3975(0x11f)](_0x133520,_0x2d3150,_0x31ddb0),_0x31ddb0;},__metadata=this&&this[_0x19844d(0x128)]||function(_0x313b61,_0x1c90e5){const _0x19ea6c=_0x19844d;if(typeof Reflect===_0x19ea6c(0x11c)&&typeof Reflect[_0x19ea6c(0x134)]===_0x19ea6c(0x13e))return Reflect[_0x19ea6c(0x134)](_0x313b61,_0x1c90e5);},AuthorizationMiddleware_1;function _0x2cdc(){const _0x56004d=['569196cJvriy','encrypt','use','__metadata','code','18HnJJrO','\x20code:','logger','30fKrxhu','SELECT\x20configVal\x20FROM\x20config\x20WHERE\x20configKey=?','22360630wRSrhi','1438311bdYrPk','decorate','originalUrl','http://authorization.nodeai.cn/api/domainAuth/checkDomain/mechat','metadata','435695QPNmYL','/api/config/setKey','386079JBqUyx','RedisCacheService','650484NjRSvS','站点尚未授权:\x20未找到授权码','redisCacheService','getTime','design:paramtypes','function','status','Injectable','授权未通过','json','Logger','wishGet','12037545XajOtM','Connection','x-forwarded-host','default','name','../utils/baseRequest','AuthorizationMiddleware','typeorm','授权失败:\x20','debug','connection','48PYtdbi','message','decrypt','__decorate','headers','log','../utils/wishCrypto','object','../../modules/redisCache/redisCache.service','post','defineProperty','WISH_ISDEV','@nestjs/common','env','configVal','getOwnPropertyDescriptor'];_0x2cdc=function(){return _0x56004d;};return _0x2cdc();}Object[_0x19844d(0x11f)](exports,'__esModule',{'value':!![]}),exports[_0x19844d(0x14b)]=void 0x0;const common_1=require(_0x19844d(0x121)),typeorm_1=require(_0x19844d(0x14c)),redisCache_service_1=require(_0x19844d(0x11d)),baseRequest_1=require(_0x19844d(0x14a)),wishCrypto_1=require(_0x19844d(0x11b)),hourTimer=0x3c*0x3c*0x3e8;let AuthorizationMiddleware=AuthorizationMiddleware_1=class AuthorizationMiddleware{constructor(_0x4d4b82,_0x177ab8){const _0x12a9c3=_0x19844d;this[_0x12a9c3(0x114)]=_0x4d4b82,this[_0x12a9c3(0x13b)]=_0x177ab8,this[_0x12a9c3(0x12c)]=new common_1[(_0x12a9c3(0x143))](AuthorizationMiddleware_1[_0x12a9c3(0x149)]);}async[_0x19844d(0x127)](_0x218f7d,_0x3458d6,_0x1235ba){const _0x17007d=_0x19844d;var _0x4cc572,_0x346f73;const _0x31bb36=_0x218f7d[_0x17007d(0x119)][_0x17007d(0x147)]||_0x218f7d[_0x17007d(0x119)]['host'],_0x163fbc=((_0x4cc572=_0x31bb36===null||_0x31bb36===void 0x0?void 0x0:_0x31bb36['split'](':'))===null||_0x4cc572===void 0x0?void 0x0:_0x4cc572[0x0])||'';if(_0x218f7d[_0x17007d(0x132)]==_0x17007d(0x136))return this[_0x17007d(0x12c)][_0x17007d(0x11a)]('Received\x20a\x20request\x20to\x20/api/config/setKey'),_0x1235ba();if(process[_0x17007d(0x122)][_0x17007d(0x120)]==='true')return _0x1235ba();try{const _0x38eebc='rocketAiKey';let _0x598de3=await this[_0x17007d(0x114)]['query'](_0x17007d(0x12e),[_0x38eebc]);_0x598de3=(_0x346f73=_0x598de3[0x0])===null||_0x346f73===void 0x0?void 0x0:_0x346f73[_0x17007d(0x123)];if(!_0x598de3)return this[_0x17007d(0x12c)]['error'](_0x17007d(0x13a)),_0x3458d6['status'](0x193)['json']({'message':'站点尚未授权'});const _0xaf47d8=await this[_0x17007d(0x13b)][_0x17007d(0x144)](_0x598de3);if(_0xaf47d8)try{const _0x4b0be6=new Date()[_0x17007d(0x13c)](),_0x3e9f37=wishCrypto_1[_0x17007d(0x148)][_0x17007d(0x117)](_0xaf47d8);if(_0x4b0be6<Number(_0x3e9f37))return _0x1235ba();}catch(_0x12c420){this[_0x17007d(0x12c)][_0x17007d(0x113)]('授权验证失败：解密缓存失败\x20url:'+_0x163fbc+_0x17007d(0x12b)+_0x598de3+'\x20redisVal:'+_0xaf47d8);}const _0x35340c={'domain':_0x163fbc,'authCode':_0x598de3};this['logger'][_0x17007d(0x113)]('授权验证请求：url:'+_0x163fbc+'\x20code:'+_0x598de3);const _0x5d5eda=await(0x0,baseRequest_1['baseRequest'])({'method':_0x17007d(0x11e),'url':_0x17007d(0x133),'data':_0x35340c});if(_0x5d5eda[_0x17007d(0x129)]==0x7)throw new common_1['HttpException']('站点未授权',common_1['HttpStatus']['FORBIDDEN']);else{const _0x3b6537=new Date()[_0x17007d(0x13c)](),_0x171a3c=_0x3b6537+hourTimer,_0x4efeed=wishCrypto_1[_0x17007d(0x148)][_0x17007d(0x126)](''+_0x171a3c);await this[_0x17007d(0x13b)]['wishSet'](_0x598de3,_0x4efeed,0x3c*0x3c*0x1),_0x1235ba();}}catch(_0x5533c2){this[_0x17007d(0x12c)]['error'](_0x17007d(0x14d)+(_0x5533c2[_0x17007d(0x116)]||_0x5533c2)),_0x3458d6[_0x17007d(0x13f)](0x1f4)[_0x17007d(0x142)]({'message':_0x17007d(0x141)});}}};function _0x5559(_0x56f814,_0x7bb83){const _0x2cdc70=_0x2cdc();return _0x5559=function(_0x555922,_0x2274bd){_0x555922=_0x555922-0x113;let _0x2f2afa=_0x2cdc70[_0x555922];return _0x2f2afa;},_0x5559(_0x56f814,_0x7bb83);}AuthorizationMiddleware=AuthorizationMiddleware_1=__decorate([(0x0,common_1[_0x19844d(0x140)])(),__metadata(_0x19844d(0x13d),[typeorm_1[_0x19844d(0x146)],redisCache_service_1[_0x19844d(0x138)]])],AuthorizationMiddleware),exports[_0x19844d(0x14b)]=AuthorizationMiddleware;