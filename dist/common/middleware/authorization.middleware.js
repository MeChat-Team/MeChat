'use strict';const _0x59e0d3=_0x1809;(function(_0x4c8cc3,_0x2ae7e0){const _0x60c681=_0x1809,_0x433bde=_0x4c8cc3();while(!![]){try{const _0x4824ed=-parseInt(_0x60c681(0x18d))/0x1*(-parseInt(_0x60c681(0x1b1))/0x2)+parseInt(_0x60c681(0x192))/0x3*(-parseInt(_0x60c681(0x1a0))/0x4)+parseInt(_0x60c681(0x1ac))/0x5*(-parseInt(_0x60c681(0x197))/0x6)+-parseInt(_0x60c681(0x193))/0x7+-parseInt(_0x60c681(0x191))/0x8*(parseInt(_0x60c681(0x180))/0x9)+parseInt(_0x60c681(0x17d))/0xa+parseInt(_0x60c681(0x17a))/0xb;if(_0x4824ed===_0x2ae7e0)break;else _0x433bde['push'](_0x433bde['shift']());}catch(_0x19d350){_0x433bde['push'](_0x433bde['shift']());}}}(_0x31b9,0xc7f12));var __decorate=this&&this[_0x59e0d3(0x189)]||function(_0x2e9f11,_0x6f1558,_0x45953a,_0x218084){const _0x52a98b=_0x59e0d3;var _0x3af274=arguments[_0x52a98b(0x194)],_0x290151=_0x3af274<0x3?_0x6f1558:_0x218084===null?_0x218084=Object[_0x52a98b(0x196)](_0x6f1558,_0x45953a):_0x218084,_0x1d7804;if(typeof Reflect==='object'&&typeof Reflect[_0x52a98b(0x198)]===_0x52a98b(0x17e))_0x290151=Reflect[_0x52a98b(0x198)](_0x2e9f11,_0x6f1558,_0x45953a,_0x218084);else{for(var _0xe7a929=_0x2e9f11[_0x52a98b(0x194)]-0x1;_0xe7a929>=0x0;_0xe7a929--)if(_0x1d7804=_0x2e9f11[_0xe7a929])_0x290151=(_0x3af274<0x3?_0x1d7804(_0x290151):_0x3af274>0x3?_0x1d7804(_0x6f1558,_0x45953a,_0x290151):_0x1d7804(_0x6f1558,_0x45953a))||_0x290151;}return _0x3af274>0x3&&_0x290151&&Object[_0x52a98b(0x1ad)](_0x6f1558,_0x45953a,_0x290151),_0x290151;},__metadata=this&&this['__metadata']||function(_0x42a3d8,_0x22f875){const _0x34b13c=_0x59e0d3;if(typeof Reflect===_0x34b13c(0x18b)&&typeof Reflect[_0x34b13c(0x173)]===_0x34b13c(0x17e))return Reflect[_0x34b13c(0x173)](_0x42a3d8,_0x22f875);};Object[_0x59e0d3(0x1ad)](exports,_0x59e0d3(0x174),{'value':!![]}),exports['AuthorizationMiddleware']=void 0x0;const common_1=require(_0x59e0d3(0x186)),typeorm_1=require(_0x59e0d3(0x1a2)),redisCache_service_1=require(_0x59e0d3(0x1a5)),baseRequest_1=require('../utils/baseRequest'),wishCrypto_1=require(_0x59e0d3(0x175)),hourTimer=0x3c*0x3c*0x3e8;function _0x1809(_0x101459,_0x26b876){const _0x31b9dd=_0x31b9();return _0x1809=function(_0x1809c8,_0x382fe0){_0x1809c8=_0x1809c8-0x171;let _0xfda594=_0x31b9dd[_0x1809c8];return _0xfda594;},_0x1809(_0x101459,_0x26b876);}let AuthorizationMiddleware=class AuthorizationMiddleware{constructor(_0xf2f7c1,_0x333f36){const _0x2f1b81=_0x59e0d3;this[_0x2f1b81(0x179)]=_0xf2f7c1,this[_0x2f1b81(0x1aa)]=_0x333f36,this['logger']=new common_1[(_0x2f1b81(0x1ae))](_0x2f1b81(0x18a));}async[_0x59e0d3(0x17b)](_0x34b051,_0x36c280,_0x17dd8f){const _0x4ea16a=_0x59e0d3;var _0x66e0f4;const _0x6126dd=_0x34b051[_0x4ea16a(0x1ab)][_0x4ea16a(0x182)];if(_0x34b051['originalUrl']==_0x4ea16a(0x18e))return this[_0x4ea16a(0x19f)]['log'](_0x4ea16a(0x1b0)),_0x17dd8f();if(process[_0x4ea16a(0x19e)]['ISDEV']==='true')return _0x17dd8f();try{const _0x15fe4d=_0x4ea16a(0x19a);let _0x282757=await this[_0x4ea16a(0x179)]['query']('SELECT\x20configVal\x20FROM\x20config\x20WHERE\x20configKey=?',[_0x15fe4d]);_0x282757=(_0x66e0f4=_0x282757[0x0])===null||_0x66e0f4===void 0x0?void 0x0:_0x66e0f4[_0x4ea16a(0x18c)],this[_0x4ea16a(0x19f)][_0x4ea16a(0x178)]('从数据库获取授权码:\x20'+(_0x282757?'成功':'未找到'));if(!_0x282757)return this[_0x4ea16a(0x19f)]['error'](_0x4ea16a(0x17c)),_0x36c280[_0x4ea16a(0x19c)](0x193)[_0x4ea16a(0x195)]({'message':_0x4ea16a(0x1af)});const _0x3687d5=await this[_0x4ea16a(0x1aa)]['wishGet'](_0x282757);this[_0x4ea16a(0x19f)][_0x4ea16a(0x178)](_0x4ea16a(0x183)+(_0x3687d5?'命中':_0x4ea16a(0x185)));if(_0x3687d5)try{const _0x91bb85=new Date()[_0x4ea16a(0x1a6)](),_0x2ef3d9=wishCrypto_1['default']['decrypt'](_0x3687d5);this[_0x4ea16a(0x19f)]['log']('Redis缓存验证:\x20当前时间='+_0x91bb85+_0x4ea16a(0x188)+_0x2ef3d9);if(_0x91bb85<Number(_0x2ef3d9))return this[_0x4ea16a(0x19f)]['log'](_0x4ea16a(0x19b)),_0x17dd8f();}catch(_0x324a85){this[_0x4ea16a(0x19f)][_0x4ea16a(0x171)](_0x4ea16a(0x17f)+_0x6126dd+'\x20code='+_0x282757+'\x20redisVal='+_0x3687d5,_0x324a85[_0x4ea16a(0x1b3)]);}this[_0x4ea16a(0x19f)][_0x4ea16a(0x178)]('开始远程授权验证');const _0x139e70=await(0x0,baseRequest_1['baseRequest'])({'method':_0x4ea16a(0x19d),'url':_0x4ea16a(0x177),'data':{'domain':_0x6126dd,'authCode':_0x282757}});this[_0x4ea16a(0x19f)]['log'](_0x4ea16a(0x1b2)+_0x139e70[_0x4ea16a(0x172)]+_0x4ea16a(0x176)+_0x139e70[_0x4ea16a(0x18f)]);if(_0x139e70[_0x4ea16a(0x172)]==0x7){this[_0x4ea16a(0x19f)][_0x4ea16a(0x171)](_0x4ea16a(0x1a3)+_0x6126dd+'\x20code='+_0x282757);throw new common_1[(_0x4ea16a(0x1a7))](_0x4ea16a(0x184),common_1[_0x4ea16a(0x187)][_0x4ea16a(0x1a4)]);}else{const _0x4a45c6=new Date()[_0x4ea16a(0x1a6)](),_0x36aa58=_0x4a45c6+hourTimer,_0x4d9299=wishCrypto_1[_0x4ea16a(0x1a1)][_0x4ea16a(0x199)](''+_0x36aa58);this[_0x4ea16a(0x19f)][_0x4ea16a(0x178)](_0x4ea16a(0x1a9)+new Date(_0x36aa58)['toISOString']()),await this['redisCacheService'][_0x4ea16a(0x190)](_0x282757,_0x4d9299,0x3c*0x3c*0x1),_0x17dd8f();}}catch(_0x467503){this[_0x4ea16a(0x19f)][_0x4ea16a(0x171)]('授权验证发生错误',_0x467503['stack']);throw new common_1[(_0x4ea16a(0x1a7))](_0x4ea16a(0x184),common_1[_0x4ea16a(0x187)]['FORBIDDEN']);}}};AuthorizationMiddleware=__decorate([(0x0,common_1[_0x59e0d3(0x1a8)])(),__metadata('design:paramtypes',[typeorm_1[_0x59e0d3(0x181)],redisCache_service_1['RedisCacheService']])],AuthorizationMiddleware),exports[_0x59e0d3(0x18a)]=AuthorizationMiddleware;function _0x31b9(){const _0x88f9ba=['use','站点尚未授权:\x20未找到授权码','6433000qKQwsE','function','Redis缓存解密失败:\x20url=','120033Rnicwz','Connection','host','Redis缓存状态:\x20','站点未授权','未命中','@nestjs/common','HttpStatus',',\x20过期时间=','__decorate','AuthorizationMiddleware','object','configVal','157978kXjvPh','/api/config/setKey','data','wishSet','824XvozBN','2705520jNbPbB','7145516dfZhCQ','length','json','getOwnPropertyDescriptor','1332258dJviSV','decorate','encrypt','rocketAiKey','使用缓存验证通过','status','post','env','logger','4uNyozc','default','typeorm','授权验证失败:\x20url=','FORBIDDEN','../../modules/redisCache/redisCache.service','getTime','HttpException','Injectable','授权验证通过，设置Redis缓存，过期时间:\x20','redisCacheService','headers','35KezYTV','defineProperty','Logger','站点尚未授权','设置授权码接口，跳过验证','16hXafph','远程授权验证响应:\x20code=','stack','error','code','metadata','__esModule','../utils/wishCrypto',',\x20data=','http://authorization.nodeai.cn/api/domainAuth/checkDomain/mechat','log','connection','41387258NDGYrk'];_0x31b9=function(){return _0x88f9ba;};return _0x31b9();}