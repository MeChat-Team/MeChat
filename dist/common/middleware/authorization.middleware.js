'use strict';const _0x5cde1c=_0x5165;(function(_0x209cd6,_0x20aeb3){const _0x41c40a=_0x5165,_0x6eb78a=_0x209cd6();while(!![]){try{const _0xcbaf4d=parseInt(_0x41c40a(0x163))/0x1*(parseInt(_0x41c40a(0x188))/0x2)+-parseInt(_0x41c40a(0x156))/0x3+-parseInt(_0x41c40a(0x17b))/0x4+-parseInt(_0x41c40a(0x15c))/0x5*(-parseInt(_0x41c40a(0x15b))/0x6)+-parseInt(_0x41c40a(0x192))/0x7*(parseInt(_0x41c40a(0x187))/0x8)+-parseInt(_0x41c40a(0x194))/0x9+parseInt(_0x41c40a(0x169))/0xa;if(_0xcbaf4d===_0x20aeb3)break;else _0x6eb78a['push'](_0x6eb78a['shift']());}catch(_0x43ed68){_0x6eb78a['push'](_0x6eb78a['shift']());}}}(_0x36f7,0xed29b));var __decorate=this&&this[_0x5cde1c(0x185)]||function(_0x12fd36,_0x4088a2,_0x2e72f5,_0xec9adb){const _0xf9dfa=_0x5cde1c;var _0x3bc601=arguments[_0xf9dfa(0x183)],_0x15b76a=_0x3bc601<0x3?_0x4088a2:_0xec9adb===null?_0xec9adb=Object[_0xf9dfa(0x168)](_0x4088a2,_0x2e72f5):_0xec9adb,_0x4ea132;if(typeof Reflect==='object'&&typeof Reflect[_0xf9dfa(0x167)]===_0xf9dfa(0x16d))_0x15b76a=Reflect[_0xf9dfa(0x167)](_0x12fd36,_0x4088a2,_0x2e72f5,_0xec9adb);else{for(var _0x47e2d4=_0x12fd36[_0xf9dfa(0x183)]-0x1;_0x47e2d4>=0x0;_0x47e2d4--)if(_0x4ea132=_0x12fd36[_0x47e2d4])_0x15b76a=(_0x3bc601<0x3?_0x4ea132(_0x15b76a):_0x3bc601>0x3?_0x4ea132(_0x4088a2,_0x2e72f5,_0x15b76a):_0x4ea132(_0x4088a2,_0x2e72f5))||_0x15b76a;}return _0x3bc601>0x3&&_0x15b76a&&Object[_0xf9dfa(0x18e)](_0x4088a2,_0x2e72f5,_0x15b76a),_0x15b76a;},__metadata=this&&this[_0x5cde1c(0x18f)]||function(_0x500c7f,_0x41c602){const _0x286ab7=_0x5cde1c;if(typeof Reflect===_0x286ab7(0x17c)&&typeof Reflect[_0x286ab7(0x181)]===_0x286ab7(0x16d))return Reflect[_0x286ab7(0x181)](_0x500c7f,_0x41c602);},AuthorizationMiddleware_1;function _0x5165(_0x27bebe,_0x1f5ddb){const _0x36f751=_0x36f7();return _0x5165=function(_0x51654c,_0x50c79c){_0x51654c=_0x51654c-0x156;let _0x3214f4=_0x36f751[_0x51654c];return _0x3214f4;},_0x5165(_0x27bebe,_0x1f5ddb);}Object[_0x5cde1c(0x18e)](exports,'__esModule',{'value':!![]}),exports[_0x5cde1c(0x178)]=void 0x0;const common_1=require(_0x5cde1c(0x16a)),typeorm_1=require(_0x5cde1c(0x157)),redisCache_service_1=require(_0x5cde1c(0x17d)),baseRequest_1=require(_0x5cde1c(0x18d)),wishCrypto_1=require(_0x5cde1c(0x16f)),hourTimer=0x3c*0x3c*0x3e8;function _0x36f7(){const _0x8030e9=['defineProperty','__metadata','host','logger','7RzMjiJ','split','15921945cOUhDE','授权验证请求：url:','design:paramtypes','4872633iWkgQa','typeorm','use','授权验证失败：解密缓存失败\x20url:','HttpException','9482034xDcNNv','5xOjyza','\x20code:','code','headers','Logger','originalUrl','授权失败:\x20','31uPeyyS','message','站点尚未授权','wishGet','decorate','getOwnPropertyDescriptor','47685120uuhmsY','@nestjs/common','debug','json','function','rocketAiKey','../utils/wishCrypto','\x20redisVal:','getTime','SELECT\x20configVal\x20FROM\x20config\x20WHERE\x20configKey=?','Injectable','授权未通过','站点未授权','status','WISH_ISDEV','AuthorizationMiddleware','query','error','3412516rfhksv','object','../../modules/redisCache/redisCache.service','wishSet','Connection','http://authorization.nodeai.cn/api/domainAuth/checkDomain/rocket','metadata','default','length','baseRequest','__decorate','encrypt','9864560olLpud','6586XAZlyI','/api/config/setKey','post','true','redisCacheService','../utils/baseRequest'];_0x36f7=function(){return _0x8030e9;};return _0x36f7();}let AuthorizationMiddleware=AuthorizationMiddleware_1=class AuthorizationMiddleware{constructor(_0x58183a,_0x2b49bc){const _0x46d8e3=_0x5cde1c;this['connection']=_0x58183a,this[_0x46d8e3(0x18c)]=_0x2b49bc,this['logger']=new common_1[(_0x46d8e3(0x160))](AuthorizationMiddleware_1['name']);}async[_0x5cde1c(0x158)](_0x553427,_0x419dd5,_0x333ed0){const _0x4a1dc2=_0x5cde1c;var _0x2976d8,_0x1c779f;const _0x59192a=_0x553427[_0x4a1dc2(0x15f)]['x-forwarded-host']||_0x553427['headers'][_0x4a1dc2(0x190)],_0x46b9d0=((_0x2976d8=_0x59192a===null||_0x59192a===void 0x0?void 0x0:_0x59192a[_0x4a1dc2(0x193)](':'))===null||_0x2976d8===void 0x0?void 0x0:_0x2976d8[0x0])||'';if(_0x553427[_0x4a1dc2(0x161)]==_0x4a1dc2(0x189)||process['env'][_0x4a1dc2(0x177)]===_0x4a1dc2(0x18b))return _0x333ed0();try{const _0x2f5c51=_0x4a1dc2(0x16e);let _0x1bff6e=await this['connection'][_0x4a1dc2(0x179)](_0x4a1dc2(0x172),[_0x2f5c51]);_0x1bff6e=(_0x1c779f=_0x1bff6e[0x0])===null||_0x1c779f===void 0x0?void 0x0:_0x1c779f['configVal'];if(!_0x1bff6e)return this[_0x4a1dc2(0x191)][_0x4a1dc2(0x17a)]('站点尚未授权:\x20未找到授权码'),_0x419dd5['status'](0x193)[_0x4a1dc2(0x16c)]({'message':_0x4a1dc2(0x165)});const _0x378430=await this['redisCacheService'][_0x4a1dc2(0x166)](_0x1bff6e);if(_0x378430)try{const _0x40eb4e=new Date()['getTime'](),_0x1475af=wishCrypto_1['default']['decrypt'](_0x378430);if(_0x40eb4e<Number(_0x1475af))return _0x333ed0();}catch(_0x118b98){this['logger'][_0x4a1dc2(0x16b)](_0x4a1dc2(0x159)+_0x46b9d0+_0x4a1dc2(0x15d)+_0x1bff6e+_0x4a1dc2(0x170)+_0x378430);}const _0x2eb57f={'domain':_0x46b9d0,'authCode':_0x1bff6e};this['logger'][_0x4a1dc2(0x16b)](_0x4a1dc2(0x195)+_0x46b9d0+'\x20code:'+_0x1bff6e);const _0xa55c80=await(0x0,baseRequest_1[_0x4a1dc2(0x184)])({'method':_0x4a1dc2(0x18a),'url':_0x4a1dc2(0x180),'data':_0x2eb57f});if(_0xa55c80[_0x4a1dc2(0x15e)]==0x7)throw new common_1[(_0x4a1dc2(0x15a))](_0x4a1dc2(0x175),common_1['HttpStatus']['FORBIDDEN']);else{const _0x5c0f9a=new Date()[_0x4a1dc2(0x171)](),_0x2d009d=_0x5c0f9a+hourTimer,_0xc998a3=wishCrypto_1[_0x4a1dc2(0x182)][_0x4a1dc2(0x186)](''+_0x2d009d);await this[_0x4a1dc2(0x18c)][_0x4a1dc2(0x17e)](_0x1bff6e,_0xc998a3,0x3c*0x3c*0x1),_0x333ed0();}}catch(_0x32a7df){this[_0x4a1dc2(0x191)]['error'](_0x4a1dc2(0x162)+(_0x32a7df[_0x4a1dc2(0x164)]||_0x32a7df)),_0x419dd5[_0x4a1dc2(0x176)](0x1f4)['json']({'message':_0x4a1dc2(0x174)});}}};AuthorizationMiddleware=AuthorizationMiddleware_1=__decorate([(0x0,common_1[_0x5cde1c(0x173)])(),__metadata(_0x5cde1c(0x196),[typeorm_1[_0x5cde1c(0x17f)],redisCache_service_1['RedisCacheService']])],AuthorizationMiddleware),exports[_0x5cde1c(0x178)]=AuthorizationMiddleware;