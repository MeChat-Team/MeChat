'use strict';const _0x35d483=_0x204b;function _0x2c03(){const _0x415b42=['\x20redisVal=','x-forwarded-proto','授权验证发生错误','stringify','1405915AySOJB','\x20code=',',\x20过期时间=','typeorm','发送验证请求数据:\x20','站点尚未授权','error','true','1841565rkinUg','rocketAiKey','Injectable','域名验证\x20-\x20请求头信息：','远程授权验证响应:\x20','从数据库获取授权码:\x20','wishGet','status','../utils/baseRequest','54441jGTSiX','1723110kJlsWZ','logger','__esModule','40paPRCc','HttpException','__metadata','stack','metadata','getTime','HttpStatus','x-real-ip','function','headers','connection','ISDEV','x-forwarded-host','RedisCacheService','redisCacheService','originalUrl','log','query','getOwnPropertyDescriptor','decorate','3906035LHBlWf','x-forwarded-for','@nestjs/common','length','baseRequest','2kZTkTT','站点尚未授权:\x20未找到授权码','336352seLBGv','configVal','使用缓存验证通过','FORBIDDEN','未命中','use','Logger','json','AuthorizationMiddleware','defineProperty','object','站点未授权','5326290PSzeHi','default','design:paramtypes','Redis缓存验证:\x20当前时间=','域名验证\x20-\x20最终使用的域名:\x20','host','http://authorization.nodeai.cn/api/domainAuth/checkDomain/mechat','toISOString','code','授权验证失败:\x20url=','encrypt','/api/config/setKey'];_0x2c03=function(){return _0x415b42;};return _0x2c03();}function _0x204b(_0x230d7d,_0x461daa){const _0x2c03ee=_0x2c03();return _0x204b=function(_0x204b71,_0xeeaec3){_0x204b71=_0x204b71-0xe6;let _0x1aa096=_0x2c03ee[_0x204b71];return _0x1aa096;},_0x204b(_0x230d7d,_0x461daa);}(function(_0x26e91a,_0x46014a){const _0x40609a=_0x204b,_0x23fde2=_0x26e91a();while(!![]){try{const _0x2adad3=-parseInt(_0x40609a(0xf1))/0x1+parseInt(_0x40609a(0x10e))/0x2*(parseInt(_0x40609a(0xe8))/0x3)+parseInt(_0x40609a(0x110))/0x4+-parseInt(_0x40609a(0x109))/0x5+parseInt(_0x40609a(0xf2))/0x6+parseInt(_0x40609a(0x12c))/0x7*(parseInt(_0x40609a(0xf5))/0x8)+-parseInt(_0x40609a(0x11c))/0x9;if(_0x2adad3===_0x46014a)break;else _0x23fde2['push'](_0x23fde2['shift']());}catch(_0x34e503){_0x23fde2['push'](_0x23fde2['shift']());}}}(_0x2c03,0x892e7));var __decorate=this&&this['__decorate']||function(_0xb6792c,_0x17b10a,_0x40a0b2,_0x4c1b9f){const _0x46e8b8=_0x204b;var _0x1bbba6=arguments[_0x46e8b8(0x10c)],_0x4642aa=_0x1bbba6<0x3?_0x17b10a:_0x4c1b9f===null?_0x4c1b9f=Object[_0x46e8b8(0x107)](_0x17b10a,_0x40a0b2):_0x4c1b9f,_0xb502de;if(typeof Reflect===_0x46e8b8(0x11a)&&typeof Reflect[_0x46e8b8(0x108)]===_0x46e8b8(0xfd))_0x4642aa=Reflect[_0x46e8b8(0x108)](_0xb6792c,_0x17b10a,_0x40a0b2,_0x4c1b9f);else{for(var _0x2a8200=_0xb6792c['length']-0x1;_0x2a8200>=0x0;_0x2a8200--)if(_0xb502de=_0xb6792c[_0x2a8200])_0x4642aa=(_0x1bbba6<0x3?_0xb502de(_0x4642aa):_0x1bbba6>0x3?_0xb502de(_0x17b10a,_0x40a0b2,_0x4642aa):_0xb502de(_0x17b10a,_0x40a0b2))||_0x4642aa;}return _0x1bbba6>0x3&&_0x4642aa&&Object[_0x46e8b8(0x119)](_0x17b10a,_0x40a0b2,_0x4642aa),_0x4642aa;},__metadata=this&&this[_0x35d483(0xf7)]||function(_0x210e10,_0xd92e33){const _0xd4be38=_0x35d483;if(typeof Reflect===_0xd4be38(0x11a)&&typeof Reflect[_0xd4be38(0xf9)]===_0xd4be38(0xfd))return Reflect[_0xd4be38(0xf9)](_0x210e10,_0xd92e33);};Object[_0x35d483(0x119)](exports,_0x35d483(0xf4),{'value':!![]}),exports[_0x35d483(0x118)]=void 0x0;const common_1=require(_0x35d483(0x10b)),typeorm_1=require(_0x35d483(0x12f)),redisCache_service_1=require('../../modules/redisCache/redisCache.service'),baseRequest_1=require(_0x35d483(0xf0)),wishCrypto_1=require('../utils/wishCrypto'),hourTimer=0x3c*0x3c*0x3e8;let AuthorizationMiddleware=class AuthorizationMiddleware{constructor(_0xb0a6f4,_0x428172){const _0x5c9e9b=_0x35d483;this['connection']=_0xb0a6f4,this['redisCacheService']=_0x428172,this['logger']=new common_1[(_0x5c9e9b(0x116))](_0x5c9e9b(0x118));}async[_0x35d483(0x115)](_0x34ad46,_0x4d43ac,_0x243e12){const _0x4abbf9=_0x35d483;var _0xbccff;const _0x3aa8fd={'host':_0x34ad46[_0x4abbf9(0xfe)]['host'],'x-forwarded-host':_0x34ad46[_0x4abbf9(0xfe)][_0x4abbf9(0x101)],'x-forwarded-proto':_0x34ad46[_0x4abbf9(0xfe)][_0x4abbf9(0x129)],'x-real-ip':_0x34ad46[_0x4abbf9(0xfe)][_0x4abbf9(0xfc)],'x-forwarded-for':_0x34ad46['headers'][_0x4abbf9(0x10a)]},_0x4d81fa=_0x34ad46['headers'][_0x4abbf9(0x101)]||_0x34ad46[_0x4abbf9(0xfe)][_0x4abbf9(0x121)],_0x14e2d4=_0x34ad46[_0x4abbf9(0xfe)][_0x4abbf9(0x129)]||_0x34ad46['protocol'],_0x1fd881=''+_0x4d81fa;this[_0x4abbf9(0xf3)][_0x4abbf9(0x105)](_0x4abbf9(0xeb)),this[_0x4abbf9(0xf3)][_0x4abbf9(0x105)](JSON['stringify'](_0x3aa8fd,null,0x2)),this[_0x4abbf9(0xf3)][_0x4abbf9(0x105)](_0x4abbf9(0x120)+_0x1fd881);if(_0x34ad46[_0x4abbf9(0x104)]==_0x4abbf9(0x127))return this[_0x4abbf9(0xf3)]['log']('设置授权码接口，跳过验证'),_0x243e12();if(process['env'][_0x4abbf9(0x100)]===_0x4abbf9(0xe7))return _0x243e12();try{const _0xb7c706=_0x4abbf9(0xe9);let _0x5e1716=await this[_0x4abbf9(0xff)][_0x4abbf9(0x106)]('SELECT\x20configVal\x20FROM\x20config\x20WHERE\x20configKey=?',[_0xb7c706]);_0x5e1716=(_0xbccff=_0x5e1716[0x0])===null||_0xbccff===void 0x0?void 0x0:_0xbccff[_0x4abbf9(0x111)],this[_0x4abbf9(0xf3)][_0x4abbf9(0x105)](_0x4abbf9(0xed)+(_0x5e1716?'成功':'未找到'));if(!_0x5e1716)return this['logger'][_0x4abbf9(0xe6)](_0x4abbf9(0x10f)),_0x4d43ac[_0x4abbf9(0xef)](0x193)[_0x4abbf9(0x117)]({'message':_0x4abbf9(0x131)});const _0x440fbf=await this[_0x4abbf9(0x103)][_0x4abbf9(0xee)](_0x5e1716);this[_0x4abbf9(0xf3)]['log']('Redis缓存状态:\x20'+(_0x440fbf?'命中':_0x4abbf9(0x114)));if(_0x440fbf)try{const _0x38ce80=new Date()['getTime'](),_0x133187=wishCrypto_1['default']['decrypt'](_0x440fbf);this['logger'][_0x4abbf9(0x105)](_0x4abbf9(0x11f)+_0x38ce80+_0x4abbf9(0x12e)+_0x133187);if(_0x38ce80<Number(_0x133187))return this['logger'][_0x4abbf9(0x105)](_0x4abbf9(0x112)),_0x243e12();}catch(_0x5b675c){this[_0x4abbf9(0xf3)][_0x4abbf9(0xe6)]('Redis缓存解密失败:\x20url='+_0x1fd881+'\x20code='+_0x5e1716+_0x4abbf9(0x128)+_0x440fbf,_0x5b675c['stack']);}this[_0x4abbf9(0xf3)][_0x4abbf9(0x105)]('开始远程授权验证');const _0x47269c={'domain':_0x1fd881,'authCode':_0x5e1716};this[_0x4abbf9(0xf3)][_0x4abbf9(0x105)](_0x4abbf9(0x130)+JSON['stringify'](_0x47269c,null,0x2));const _0x587825=await(0x0,baseRequest_1[_0x4abbf9(0x10d)])({'method':'post','url':_0x4abbf9(0x122),'data':_0x47269c});this[_0x4abbf9(0xf3)][_0x4abbf9(0x105)](_0x4abbf9(0xec)+JSON[_0x4abbf9(0x12b)](_0x587825,null,0x2));if(_0x587825[_0x4abbf9(0x124)]==0x7){this['logger'][_0x4abbf9(0xe6)](_0x4abbf9(0x125)+_0x1fd881+_0x4abbf9(0x12d)+_0x5e1716);throw new common_1[(_0x4abbf9(0xf6))](_0x4abbf9(0x11b),common_1['HttpStatus'][_0x4abbf9(0x113)]);}else{const _0x4cac1f=new Date()[_0x4abbf9(0xfa)](),_0x16d4c5=_0x4cac1f+hourTimer,_0x25d72e=wishCrypto_1[_0x4abbf9(0x11d)][_0x4abbf9(0x126)](''+_0x16d4c5);this[_0x4abbf9(0xf3)]['log']('授权验证通过，设置Redis缓存，过期时间:\x20'+new Date(_0x16d4c5)[_0x4abbf9(0x123)]()),await this[_0x4abbf9(0x103)]['wishSet'](_0x5e1716,_0x25d72e,0x3c*0x3c*0x1),_0x243e12();}}catch(_0x83f5fa){this[_0x4abbf9(0xf3)][_0x4abbf9(0xe6)](_0x4abbf9(0x12a),_0x83f5fa[_0x4abbf9(0xf8)]);throw new common_1[(_0x4abbf9(0xf6))](_0x4abbf9(0x11b),common_1[_0x4abbf9(0xfb)][_0x4abbf9(0x113)]);}}};AuthorizationMiddleware=__decorate([(0x0,common_1[_0x35d483(0xea)])(),__metadata(_0x35d483(0x11e),[typeorm_1['Connection'],redisCache_service_1[_0x35d483(0x102)]])],AuthorizationMiddleware),exports[_0x35d483(0x118)]=AuthorizationMiddleware;