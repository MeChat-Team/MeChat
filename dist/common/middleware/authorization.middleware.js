'use strict';const _0x398008=_0x4add;(function(_0x413a53,_0x302e35){const _0x5d6d5d=_0x4add,_0x1ac530=_0x413a53();while(!![]){try{const _0xc3d9ef=-parseInt(_0x5d6d5d(0x20e))/0x1+-parseInt(_0x5d6d5d(0x221))/0x2*(parseInt(_0x5d6d5d(0x208))/0x3)+parseInt(_0x5d6d5d(0x20a))/0x4+parseInt(_0x5d6d5d(0x225))/0x5+parseInt(_0x5d6d5d(0x1f3))/0x6+-parseInt(_0x5d6d5d(0x20c))/0x7+parseInt(_0x5d6d5d(0x210))/0x8;if(_0xc3d9ef===_0x302e35)break;else _0x1ac530['push'](_0x1ac530['shift']());}catch(_0x6e9d60){_0x1ac530['push'](_0x1ac530['shift']());}}}(_0x3cbb,0x63baa));function _0x4add(_0x423d8c,_0x481743){const _0x3cbb63=_0x3cbb();return _0x4add=function(_0x4add0d,_0x376a04){_0x4add0d=_0x4add0d-0x1e5;let _0x12b994=_0x3cbb63[_0x4add0d];return _0x12b994;},_0x4add(_0x423d8c,_0x481743);}var __decorate=this&&this[_0x398008(0x1f1)]||function(_0x5b8462,_0x22a7c9,_0x2769d5,_0x12c9f5){const _0xd20414=_0x398008;var _0x14b297=arguments[_0xd20414(0x213)],_0x4b3d63=_0x14b297<0x3?_0x22a7c9:_0x12c9f5===null?_0x12c9f5=Object[_0xd20414(0x206)](_0x22a7c9,_0x2769d5):_0x12c9f5,_0x1b8382;if(typeof Reflect===_0xd20414(0x1f8)&&typeof Reflect[_0xd20414(0x222)]===_0xd20414(0x218))_0x4b3d63=Reflect['decorate'](_0x5b8462,_0x22a7c9,_0x2769d5,_0x12c9f5);else{for(var _0x575c47=_0x5b8462[_0xd20414(0x213)]-0x1;_0x575c47>=0x0;_0x575c47--)if(_0x1b8382=_0x5b8462[_0x575c47])_0x4b3d63=(_0x14b297<0x3?_0x1b8382(_0x4b3d63):_0x14b297>0x3?_0x1b8382(_0x22a7c9,_0x2769d5,_0x4b3d63):_0x1b8382(_0x22a7c9,_0x2769d5))||_0x4b3d63;}return _0x14b297>0x3&&_0x4b3d63&&Object[_0xd20414(0x1f2)](_0x22a7c9,_0x2769d5,_0x4b3d63),_0x4b3d63;},__metadata=this&&this[_0x398008(0x1f0)]||function(_0x1363ef,_0x4a95d4){const _0x58dfa8=_0x398008;if(typeof Reflect===_0x58dfa8(0x1f8)&&typeof Reflect[_0x58dfa8(0x219)]===_0x58dfa8(0x218))return Reflect[_0x58dfa8(0x219)](_0x1363ef,_0x4a95d4);},AuthorizationMiddleware_1;Object['defineProperty'](exports,_0x398008(0x212),{'value':!![]}),exports['AuthorizationMiddleware']=void 0x0;const common_1=require(_0x398008(0x21a)),typeorm_1=require(_0x398008(0x227)),redisCache_service_1=require(_0x398008(0x1ef)),baseRequest_1=require(_0x398008(0x205)),wishCrypto_1=require('../utils/wishCrypto'),hourTimer=0x3c*0x3c*0x3e8;let AuthorizationMiddleware=AuthorizationMiddleware_1=class AuthorizationMiddleware{constructor(_0x5f4bd3,_0x420f4c){const _0x4b1de7=_0x398008;this['connection']=_0x5f4bd3,this[_0x4b1de7(0x224)]=_0x420f4c,this[_0x4b1de7(0x207)]=new common_1['Logger'](AuthorizationMiddleware_1[_0x4b1de7(0x1e6)]);}async[_0x398008(0x220)](_0x31422,_0x3f926f,_0x49d1ef){const _0x212d87=_0x398008;var _0x38faa8,_0x55f1c6;const _0x3ee315=_0x31422[_0x212d87(0x1f9)][_0x212d87(0x1fe)]||_0x31422[_0x212d87(0x1f9)][_0x212d87(0x1fd)],_0x1a0544=((_0x38faa8=_0x3ee315===null||_0x3ee315===void 0x0?void 0x0:_0x3ee315[_0x212d87(0x1eb)](':'))===null||_0x38faa8===void 0x0?void 0x0:_0x38faa8[0x0])||'';if(_0x31422[_0x212d87(0x201)]==_0x212d87(0x21d))return this[_0x212d87(0x207)][_0x212d87(0x1e7)](_0x212d87(0x211)),_0x49d1ef();if(process[_0x212d87(0x217)][_0x212d87(0x223)]===_0x212d87(0x20d))return _0x49d1ef();try{const _0x172143=_0x212d87(0x20f);let _0x29f62d=await this[_0x212d87(0x202)][_0x212d87(0x204)]('SELECT\x20configVal\x20FROM\x20config\x20WHERE\x20configKey=?',[_0x172143]);_0x29f62d=(_0x55f1c6=_0x29f62d[0x0])===null||_0x55f1c6===void 0x0?void 0x0:_0x55f1c6['configVal'];if(!_0x29f62d)return this[_0x212d87(0x207)][_0x212d87(0x1e8)](_0x212d87(0x203)),_0x3f926f['status'](0x193)[_0x212d87(0x1fb)]({'message':_0x212d87(0x21f)});const _0x1d4fe4=await this[_0x212d87(0x224)][_0x212d87(0x1fc)](_0x29f62d);if(_0x1d4fe4)try{const _0x1f7851=new Date()['getTime'](),_0x4dc015=wishCrypto_1[_0x212d87(0x21c)][_0x212d87(0x1ff)](_0x1d4fe4);if(_0x1f7851<Number(_0x4dc015))return _0x49d1ef();}catch(_0x18ed4e){this['logger'][_0x212d87(0x214)](_0x212d87(0x21e)+_0x1a0544+_0x212d87(0x20b)+_0x29f62d+'\x20redisVal:'+_0x1d4fe4);}const _0x3bcfd6={'domain':_0x1a0544,'authCode':_0x29f62d};this[_0x212d87(0x207)]['debug'](_0x212d87(0x1ec)+_0x1a0544+_0x212d87(0x20b)+_0x29f62d);const _0x1d6b3f=await(0x0,baseRequest_1[_0x212d87(0x200)])({'method':_0x212d87(0x226),'url':_0x212d87(0x1e9),'data':_0x3bcfd6});if(_0x1d6b3f[_0x212d87(0x21b)]==0x7)throw new common_1[(_0x212d87(0x1fa))](_0x212d87(0x215),common_1[_0x212d87(0x1f6)]['FORBIDDEN']);else{const _0x1b9f4b=new Date()[_0x212d87(0x1e5)](),_0x32d76e=_0x1b9f4b+hourTimer,_0x554bf0=wishCrypto_1['default'][_0x212d87(0x1f5)](''+_0x32d76e);await this[_0x212d87(0x224)][_0x212d87(0x1f4)](_0x29f62d,_0x554bf0,0x3c*0x3c*0x1),_0x49d1ef();}}catch(_0x3cfea7){this['logger'][_0x212d87(0x1e8)](_0x212d87(0x1f7)+(_0x3cfea7[_0x212d87(0x1ed)]||_0x3cfea7)),_0x3f926f['status'](0x1f4)['json']({'message':_0x212d87(0x209)});}}};AuthorizationMiddleware=AuthorizationMiddleware_1=__decorate([(0x0,common_1['Injectable'])(),__metadata(_0x398008(0x1ea),[typeorm_1['Connection'],redisCache_service_1[_0x398008(0x216)]])],AuthorizationMiddleware),exports[_0x398008(0x1ee)]=AuthorizationMiddleware;function _0x3cbb(){const _0x44bcc9=['授权验证失败：解密缓存失败\x20url:','站点尚未授权','use','1042ggXmCb','decorate','ISDEV','redisCacheService','2618825QXcoAn','post','typeorm','getTime','name','log','error','http://authorization.nodeai.cn/api/domainAuth/checkDomain/mechat','design:paramtypes','split','授权验证请求：url:','message','AuthorizationMiddleware','../../modules/redisCache/redisCache.service','__metadata','__decorate','defineProperty','2442066TECzGL','wishSet','encrypt','HttpStatus','授权失败:\x20','object','headers','HttpException','json','wishGet','host','x-forwarded-host','decrypt','baseRequest','originalUrl','connection','站点尚未授权:\x20未找到授权码','query','../utils/baseRequest','getOwnPropertyDescriptor','logger','2721EBumEV','授权未通过','920856uOaWyN','\x20code:','4036557WYkCBu','true','778638bFJCVH','rocketAiKey','8602688PqYwFU','Received\x20a\x20request\x20to\x20/api/config/setKey','__esModule','length','debug','站点未授权','RedisCacheService','env','function','metadata','@nestjs/common','code','default','/api/config/setKey'];_0x3cbb=function(){return _0x44bcc9;};return _0x3cbb();}