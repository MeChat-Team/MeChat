'use strict';const _0x54c6d6=_0x4b6c;(function(_0x1e37fc,_0x44d86d){const _0x15bade=_0x4b6c,_0x180d38=_0x1e37fc();while(!![]){try{const _0x310de7=parseInt(_0x15bade(0x203))/0x1*(-parseInt(_0x15bade(0x1f7))/0x2)+-parseInt(_0x15bade(0x1e3))/0x3*(parseInt(_0x15bade(0x1ff))/0x4)+-parseInt(_0x15bade(0x1ca))/0x5+parseInt(_0x15bade(0x1d2))/0x6*(-parseInt(_0x15bade(0x1cb))/0x7)+parseInt(_0x15bade(0x1fa))/0x8+-parseInt(_0x15bade(0x1e2))/0x9*(-parseInt(_0x15bade(0x1e5))/0xa)+-parseInt(_0x15bade(0x1df))/0xb*(-parseInt(_0x15bade(0x1c9))/0xc);if(_0x310de7===_0x44d86d)break;else _0x180d38['push'](_0x180d38['shift']());}catch(_0x59b320){_0x180d38['push'](_0x180d38['shift']());}}}(_0x3e4b,0xde823));function _0x4b6c(_0x676777,_0x4dfc47){const _0x3e4b61=_0x3e4b();return _0x4b6c=function(_0x4b6cc5,_0x49fa88){_0x4b6cc5=_0x4b6cc5-0x1c6;let _0xe83707=_0x3e4b61[_0x4b6cc5];return _0xe83707;},_0x4b6c(_0x676777,_0x4dfc47);}var __decorate=this&&this['__decorate']||function(_0x166afe,_0x5e9438,_0x5e9819,_0x7d9a04){const _0x88aa82=_0x4b6c;var _0x1b11cc=arguments[_0x88aa82(0x202)],_0x531894=_0x1b11cc<0x3?_0x5e9438:_0x7d9a04===null?_0x7d9a04=Object[_0x88aa82(0x1e8)](_0x5e9438,_0x5e9819):_0x7d9a04,_0x578557;if(typeof Reflect===_0x88aa82(0x1e4)&&typeof Reflect[_0x88aa82(0x1c7)]==='function')_0x531894=Reflect[_0x88aa82(0x1c7)](_0x166afe,_0x5e9438,_0x5e9819,_0x7d9a04);else{for(var _0x289886=_0x166afe[_0x88aa82(0x202)]-0x1;_0x289886>=0x0;_0x289886--)if(_0x578557=_0x166afe[_0x289886])_0x531894=(_0x1b11cc<0x3?_0x578557(_0x531894):_0x1b11cc>0x3?_0x578557(_0x5e9438,_0x5e9819,_0x531894):_0x578557(_0x5e9438,_0x5e9819))||_0x531894;}return _0x1b11cc>0x3&&_0x531894&&Object[_0x88aa82(0x1fc)](_0x5e9438,_0x5e9819,_0x531894),_0x531894;},__metadata=this&&this[_0x54c6d6(0x1d1)]||function(_0x35e680,_0x13fd39){const _0x2e1dae=_0x54c6d6;if(typeof Reflect===_0x2e1dae(0x1e4)&&typeof Reflect[_0x2e1dae(0x1f8)]===_0x2e1dae(0x1e6))return Reflect[_0x2e1dae(0x1f8)](_0x35e680,_0x13fd39);},AuthorizationMiddleware_1;Object[_0x54c6d6(0x1fc)](exports,_0x54c6d6(0x1e7),{'value':!![]}),exports[_0x54c6d6(0x1f3)]=void 0x0;function _0x3e4b(){const _0x120bb1=['getOwnPropertyDescriptor','headers','HttpStatus','use','\x20redisVal:','Received\x20a\x20request\x20to\x20/api/config/setKey','wishSet','Injectable','../../modules/redisCache/redisCache.service','logger','授权验证失败：解密缓存失败\x20url:','AuthorizationMiddleware','getTime','redisCacheService','/api/config/setKey','6rgXznb','metadata','站点尚未授权:\x20未找到授权码','11133984buaiNf','授权未通过','defineProperty','Logger','json','3863360UOgqlt','FORBIDDEN','../utils/wishCrypto','length','166327HxoXhT','encrypt','error','授权验证请求：url:','name','decorate','env','12XCVXsW','7424855GGiqiO','9961dMcTzV','status','true','connection','授权失败:\x20','wishGet','__metadata','2166XbARSg','站点未授权','split','query','post','HttpException','ISDEV','configVal','typeorm','log','\x20code:','../utils/baseRequest','host','14461304BiXqVX','debug','default','18PNHjVm','3XfrztV','object','8342390LCGIeb','function','__esModule'];_0x3e4b=function(){return _0x120bb1;};return _0x3e4b();}const common_1=require('@nestjs/common'),typeorm_1=require(_0x54c6d6(0x1da)),redisCache_service_1=require(_0x54c6d6(0x1f0)),baseRequest_1=require(_0x54c6d6(0x1dd)),wishCrypto_1=require(_0x54c6d6(0x201)),hourTimer=0x3c*0x3c*0x3e8;let AuthorizationMiddleware=AuthorizationMiddleware_1=class AuthorizationMiddleware{constructor(_0x512ad2,_0x4b7f9d){const _0x3039bf=_0x54c6d6;this[_0x3039bf(0x1ce)]=_0x512ad2,this['redisCacheService']=_0x4b7f9d,this[_0x3039bf(0x1f1)]=new common_1[(_0x3039bf(0x1fd))](AuthorizationMiddleware_1[_0x3039bf(0x1c6)]);}async[_0x54c6d6(0x1eb)](_0x35addd,_0xd29360,_0xee1b8c){const _0x5d1ce8=_0x54c6d6;var _0x1c91e1,_0x4be87c;const _0x41cc12=_0x35addd['headers']['x-forwarded-host']||_0x35addd[_0x5d1ce8(0x1e9)][_0x5d1ce8(0x1de)],_0x3972a6=((_0x1c91e1=_0x41cc12===null||_0x41cc12===void 0x0?void 0x0:_0x41cc12[_0x5d1ce8(0x1d4)](':'))===null||_0x1c91e1===void 0x0?void 0x0:_0x1c91e1[0x0])||'';if(_0x35addd['originalUrl']==_0x5d1ce8(0x1f6))return this[_0x5d1ce8(0x1f1)][_0x5d1ce8(0x1db)](_0x5d1ce8(0x1ed)),_0xee1b8c();if(process[_0x5d1ce8(0x1c8)][_0x5d1ce8(0x1d8)]===_0x5d1ce8(0x1cd))return _0xee1b8c();try{const _0x94c783='rocketAiKey';let _0x152cfc=await this['connection'][_0x5d1ce8(0x1d5)]('SELECT\x20configVal\x20FROM\x20config\x20WHERE\x20configKey=?',[_0x94c783]);_0x152cfc=(_0x4be87c=_0x152cfc[0x0])===null||_0x4be87c===void 0x0?void 0x0:_0x4be87c[_0x5d1ce8(0x1d9)];if(!_0x152cfc)return this['logger'][_0x5d1ce8(0x205)](_0x5d1ce8(0x1f9)),_0xd29360[_0x5d1ce8(0x1cc)](0x193)[_0x5d1ce8(0x1fe)]({'message':'站点尚未授权'});const _0x7b7366=await this[_0x5d1ce8(0x1f5)][_0x5d1ce8(0x1d0)](_0x152cfc);if(_0x7b7366)try{const _0x36042c=new Date()[_0x5d1ce8(0x1f4)](),_0xba288a=wishCrypto_1['default']['decrypt'](_0x7b7366);if(_0x36042c<Number(_0xba288a))return _0xee1b8c();}catch(_0x4997ae){this[_0x5d1ce8(0x1f1)][_0x5d1ce8(0x1e0)](_0x5d1ce8(0x1f2)+_0x3972a6+_0x5d1ce8(0x1dc)+_0x152cfc+_0x5d1ce8(0x1ec)+_0x7b7366);}const _0x591b85={'domain':_0x3972a6,'authCode':_0x152cfc};this[_0x5d1ce8(0x1f1)][_0x5d1ce8(0x1e0)](_0x5d1ce8(0x206)+_0x3972a6+_0x5d1ce8(0x1dc)+_0x152cfc);const _0x49de6f=await(0x0,baseRequest_1['baseRequest'])({'method':_0x5d1ce8(0x1d6),'url':'http://authorization.nodeai.cn/api/domainAuth/checkDomain/mechat','data':_0x591b85});if(_0x49de6f['code']==0x7)throw new common_1[(_0x5d1ce8(0x1d7))](_0x5d1ce8(0x1d3),common_1[_0x5d1ce8(0x1ea)][_0x5d1ce8(0x200)]);else{const _0x13d71f=new Date()[_0x5d1ce8(0x1f4)](),_0x123db2=_0x13d71f+hourTimer,_0x20aeb7=wishCrypto_1[_0x5d1ce8(0x1e1)][_0x5d1ce8(0x204)](''+_0x123db2);await this[_0x5d1ce8(0x1f5)][_0x5d1ce8(0x1ee)](_0x152cfc,_0x20aeb7,0x3c*0x3c*0x1),_0xee1b8c();}}catch(_0x2ed211){this[_0x5d1ce8(0x1f1)][_0x5d1ce8(0x205)](_0x5d1ce8(0x1cf)+(_0x2ed211['message']||_0x2ed211)),_0xd29360['status'](0x1f4)[_0x5d1ce8(0x1fe)]({'message':_0x5d1ce8(0x1fb)});}}};AuthorizationMiddleware=AuthorizationMiddleware_1=__decorate([(0x0,common_1[_0x54c6d6(0x1ef)])(),__metadata('design:paramtypes',[typeorm_1['Connection'],redisCache_service_1['RedisCacheService']])],AuthorizationMiddleware),exports[_0x54c6d6(0x1f3)]=AuthorizationMiddleware;