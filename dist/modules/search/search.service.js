'use strict';const _0x28c6b3=_0x1853;function _0x1853(_0x376a3a,_0x2669d5){const _0x17611f=_0x1761();return _0x1853=function(_0x18539f,_0x38e800){_0x18539f=_0x18539f-0x8b;let _0x23ea94=_0x17611f[_0x18539f];return _0x23ea94;},_0x1853(_0x376a3a,_0x2669d5);}(function(_0x171e06,_0x221488){const _0x15efe5=_0x1853,_0xea2f25=_0x171e06();while(!![]){try{const _0xe09f37=parseInt(_0x15efe5(0xbe))/0x1*(-parseInt(_0x15efe5(0xc6))/0x2)+parseInt(_0x15efe5(0xbc))/0x3+-parseInt(_0x15efe5(0xc9))/0x4+parseInt(_0x15efe5(0xab))/0x5*(-parseInt(_0x15efe5(0x8e))/0x6)+parseInt(_0x15efe5(0xb8))/0x7+parseInt(_0x15efe5(0xcb))/0x8+-parseInt(_0x15efe5(0x8b))/0x9*(parseInt(_0x15efe5(0x9a))/0xa);if(_0xe09f37===_0x221488)break;else _0xea2f25['push'](_0xea2f25['shift']());}catch(_0x1fdc1e){_0xea2f25['push'](_0xea2f25['shift']());}}}(_0x1761,0xc99b0));var __decorate=this&&this[_0x28c6b3(0xa7)]||function(_0x2f040e,_0x5cf665,_0x2fdb39,_0x398389){const _0x3871db=_0x28c6b3;var _0x1c367c=arguments[_0x3871db(0xac)],_0x1c3d24=_0x1c367c<0x3?_0x5cf665:_0x398389===null?_0x398389=Object[_0x3871db(0x8c)](_0x5cf665,_0x2fdb39):_0x398389,_0x4c5254;if(typeof Reflect===_0x3871db(0x97)&&typeof Reflect[_0x3871db(0xaa)]==='function')_0x1c3d24=Reflect[_0x3871db(0xaa)](_0x2f040e,_0x5cf665,_0x2fdb39,_0x398389);else{for(var _0xb36ce0=_0x2f040e[_0x3871db(0xac)]-0x1;_0xb36ce0>=0x0;_0xb36ce0--)if(_0x4c5254=_0x2f040e[_0xb36ce0])_0x1c3d24=(_0x1c367c<0x3?_0x4c5254(_0x1c3d24):_0x1c367c>0x3?_0x4c5254(_0x5cf665,_0x2fdb39,_0x1c3d24):_0x4c5254(_0x5cf665,_0x2fdb39))||_0x1c3d24;}return _0x1c367c>0x3&&_0x1c3d24&&Object[_0x3871db(0xb9)](_0x5cf665,_0x2fdb39,_0x1c3d24),_0x1c3d24;},__metadata=this&&this[_0x28c6b3(0x93)]||function(_0x3b1bde,_0x3d0c52){const _0x1dd8ce=_0x28c6b3;if(typeof Reflect==='object'&&typeof Reflect[_0x1dd8ce(0xc5)]==='function')return Reflect[_0x1dd8ce(0xc5)](_0x3b1bde,_0x3d0c52);};function _0x1761(){const _0x1ed517=['stringify','user','GlobalConfigService','end','write','__decorate','ModelsService','fetchHotSearches','decorate','1417625gNOpXQ','length','Search\x20API\x20error:\x20','now','error','@nestjs/common','searchWithExternalAPI','slice','model','../globalConfig/globalConfig.service','CACHE_DURATION','../chat/chat.service','SearchService','9858156JVZwei','defineProperty','/search','\x20images','3671352tdGcyI','append','11248SEBVcy','https://www.coderutil.com/api/resou/v1/toutiao','format','HTTP\x20error!\x20status:\x20','searchParams','research','json','metadata','94kcWBET','design:paramtypes','toString','5215836hcLIct','search','5058144HDkhjN','350271YpMLOJ','getOwnPropertyDescriptor','status','12fgTWCM','Search\x20error:\x20','application/octet-stream;\x20charset=utf-8','__esModule','modelsService','__metadata','data','getHotSearches','Logger','object','hotSearchCache','chatService','10gZmtaA','hotSearchAccessKey','Hot\x20search\x20API\x20keys\x20not\x20configured','getCurrentModelKeyInfo','User\x20not\x20authenticated','timestamp','message','globalConfigService'];_0x1761=function(){return _0x1ed517;};return _0x1761();}Object[_0x28c6b3(0xb9)](exports,_0x28c6b3(0x91),{'value':!![]}),exports['SearchService']=void 0x0;const common_1=require(_0x28c6b3(0xb0)),globalConfig_service_1=require(_0x28c6b3(0xb4)),chat_service_1=require(_0x28c6b3(0xb6)),models_service_1=require('../models/models.service');let SearchService=class SearchService{constructor(_0x4ed613,_0x164251,_0xcbf9a5){const _0x2333b7=_0x28c6b3;this['globalConfigService']=_0x4ed613,this[_0x2333b7(0x99)]=_0x164251,this[_0x2333b7(0x92)]=_0xcbf9a5,this[_0x2333b7(0x98)]=null,this[_0x2333b7(0xb5)]=0xa*0x3c*0x3e8;}async[_0x28c6b3(0xb1)](_0x33d93a){const _0x2d9c21=_0x28c6b3;try{const {searchPlatformUrl:_0x2a5f0c}=await this[_0x2d9c21(0xa1)]['getConfigs'](['searchPlatformUrl']),_0xda3bc8=new URL(_0x2a5f0c+_0x2d9c21(0xba));_0xda3bc8[_0x2d9c21(0xc2)]['append']('q',_0x33d93a),_0xda3bc8[_0x2d9c21(0xc2)][_0x2d9c21(0xbd)](_0x2d9c21(0xc0),_0x2d9c21(0xc4));const _0x4a2ed2=await fetch(_0xda3bc8[_0x2d9c21(0xc8)](),{'method':'GET'});if(!_0x4a2ed2['ok'])throw new Error(_0x2d9c21(0xc1)+_0x4a2ed2['status']);const _0xd7ef95=await _0x4a2ed2[_0x2d9c21(0xc4)]();return _0xd7ef95['results']||[];}catch(_0x1eb1ce){common_1[_0x2d9c21(0x96)][_0x2d9c21(0xaf)](_0x2d9c21(0xad)+_0x1eb1ce[_0x2d9c21(0xa0)],_0x2d9c21(0xb7));throw _0x1eb1ce;}}async[_0x28c6b3(0xa9)](){const _0x3649ff=_0x28c6b3,_0x28d096=await this[_0x3649ff(0xa1)]['getConfigs']([_0x3649ff(0x9b),'hotSearchSecretKey']),_0x46260a=_0x28d096===null||_0x28d096===void 0x0?void 0x0:_0x28d096[_0x3649ff(0x9b)],_0x3979ec=_0x28d096===null||_0x28d096===void 0x0?void 0x0:_0x28d096['hotSearchSecretKey'];if(!_0x46260a||!_0x3979ec)throw new Error(_0x3649ff(0x9c));const _0x224d62=await fetch(_0x3649ff(0xbf),{'method':'GET','headers':{'access-key':_0x46260a,'secret-key':_0x3979ec}});if(!_0x224d62['ok'])throw new Error('HTTP\x20error!\x20status:\x20'+_0x224d62[_0x3649ff(0x8d)]);return await _0x224d62[_0x3649ff(0xc4)]();}async[_0x28c6b3(0x95)](){const _0xbfbdb2=_0x28c6b3;try{const _0x4a8af9=Date[_0xbfbdb2(0xae)]();if(this[_0xbfbdb2(0x98)]&&_0x4a8af9-this[_0xbfbdb2(0x98)][_0xbfbdb2(0x9f)]<this[_0xbfbdb2(0xb5)])return this['hotSearchCache'][_0xbfbdb2(0x94)];const _0x3aaef5=await this[_0xbfbdb2(0xa9)]();return this[_0xbfbdb2(0x98)]={'data':_0x3aaef5,'timestamp':_0x4a8af9},_0x3aaef5;}catch(_0x4aee8e){if(this['hotSearchCache'])return this[_0xbfbdb2(0x98)]['data'];throw _0x4aee8e;}}async[_0x28c6b3(0xca)](_0x96e012,_0x484153,_0xe3bce9){const _0x57c339=_0x28c6b3,{prompt:_0x5c8fc3,model:_0x115645,mode:_0x1e087c,parentMessageId:_0x2693b2}=_0x96e012;try{if(!_0x484153[_0x57c339(0xa3)])throw new Error(_0x57c339(0x9e));_0xe3bce9['setHeader']('Content-type',_0x57c339(0x90));if(_0x2693b2){const _0x4667d6=await this[_0x57c339(0x92)][_0x57c339(0x9d)](_0x115645);if(!_0x4667d6)throw new Error('Model\x20key\x20not\x20found.\x20Please\x20check\x20your\x20model\x20configuration.');const _0x5e5605=await this[_0x57c339(0x99)]['chatProcess']({'prompt':_0x5c8fc3,'model':_0x4667d6[_0x57c339(0xb3)],'options':{'parentMessageId':_0x2693b2,'usingNetwork':!![]}},_0x484153,_0xe3bce9);_0x5e5605&&_0x5e5605['id']&&_0xe3bce9[_0x57c339(0xa6)]('\x0a'+JSON[_0x57c339(0xa2)]({'parentMessageId':_0x5e5605['id']}));}else{const _0x5e5e96=await this[_0x57c339(0xb1)](_0x5c8fc3);_0xe3bce9[_0x57c339(0xa6)](JSON[_0x57c339(0xa2)]({'context':_0x5e5e96['slice'](0x0,0x14)}));if(_0x1e087c==='deep'||_0x1e087c===_0x57c339(0xc3)){const _0x350c59=await this['searchWithExternalAPI'](_0x5c8fc3+_0x57c339(0xbb));_0xe3bce9['write']('\x0a'+JSON[_0x57c339(0xa2)]({'images':_0x350c59[_0x57c339(0xb2)](0x0,0x5)}));}}_0xe3bce9[_0x57c339(0xa5)]();}catch(_0x31f387){common_1[_0x57c339(0x96)][_0x57c339(0xaf)](_0x57c339(0x8f)+_0x31f387[_0x57c339(0xa0)],_0x57c339(0xb7));throw _0x31f387;}}};SearchService=__decorate([(0x0,common_1['Injectable'])(),__metadata(_0x28c6b3(0xc7),[globalConfig_service_1[_0x28c6b3(0xa4)],chat_service_1['ChatService'],models_service_1[_0x28c6b3(0xa8)]])],SearchService),exports[_0x28c6b3(0xb7)]=SearchService;