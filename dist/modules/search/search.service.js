'use strict';function _0x377f(_0x38dc21,_0x14e06b){const _0x1dd7c0=_0x1dd7();return _0x377f=function(_0x377f9c,_0x312ebe){_0x377f9c=_0x377f9c-0x142;let _0x43c147=_0x1dd7c0[_0x377f9c];return _0x43c147;},_0x377f(_0x38dc21,_0x14e06b);}const _0x403b10=_0x377f;(function(_0x1be48b,_0x5eeb75){const _0x34346d=_0x377f,_0x36f008=_0x1be48b();while(!![]){try{const _0x39c1b9=parseInt(_0x34346d(0x148))/0x1*(parseInt(_0x34346d(0x17a))/0x2)+-parseInt(_0x34346d(0x177))/0x3+-parseInt(_0x34346d(0x164))/0x4+-parseInt(_0x34346d(0x160))/0x5*(parseInt(_0x34346d(0x14d))/0x6)+parseInt(_0x34346d(0x15f))/0x7+parseInt(_0x34346d(0x17b))/0x8+-parseInt(_0x34346d(0x173))/0x9*(-parseInt(_0x34346d(0x143))/0xa);if(_0x39c1b9===_0x5eeb75)break;else _0x36f008['push'](_0x36f008['shift']());}catch(_0x42c7b4){_0x36f008['push'](_0x36f008['shift']());}}}(_0x1dd7,0x4601a));var __decorate=this&&this[_0x403b10(0x17d)]||function(_0x3510ad,_0x21c3e7,_0x415aed,_0x1a836e){const _0xbba89d=_0x403b10;var _0xe01817=arguments[_0xbba89d(0x154)],_0x36f5dd=_0xe01817<0x3?_0x21c3e7:_0x1a836e===null?_0x1a836e=Object['getOwnPropertyDescriptor'](_0x21c3e7,_0x415aed):_0x1a836e,_0x3eb2ae;if(typeof Reflect===_0xbba89d(0x16c)&&typeof Reflect['decorate']===_0xbba89d(0x166))_0x36f5dd=Reflect['decorate'](_0x3510ad,_0x21c3e7,_0x415aed,_0x1a836e);else{for(var _0x52f95d=_0x3510ad['length']-0x1;_0x52f95d>=0x0;_0x52f95d--)if(_0x3eb2ae=_0x3510ad[_0x52f95d])_0x36f5dd=(_0xe01817<0x3?_0x3eb2ae(_0x36f5dd):_0xe01817>0x3?_0x3eb2ae(_0x21c3e7,_0x415aed,_0x36f5dd):_0x3eb2ae(_0x21c3e7,_0x415aed))||_0x36f5dd;}return _0xe01817>0x3&&_0x36f5dd&&Object[_0xbba89d(0x180)](_0x21c3e7,_0x415aed,_0x36f5dd),_0x36f5dd;},__metadata=this&&this[_0x403b10(0x15c)]||function(_0x5e1833,_0x54db00){const _0x5eb4ab=_0x403b10;if(typeof Reflect==='object'&&typeof Reflect[_0x5eb4ab(0x165)]===_0x5eb4ab(0x166))return Reflect['metadata'](_0x5e1833,_0x54db00);};Object[_0x403b10(0x180)](exports,_0x403b10(0x167),{'value':!![]}),exports[_0x403b10(0x142)]=void 0x0;function _0x1dd7(){const _0x4b641c=['CACHE_DURATION','searchWithExternalAPI','../globalConfig/globalConfig.service','chatProcess','../models/models.service','Logger','length','application/octet-stream;\x20charset=utf-8','Model\x20key\x20not\x20found.\x20Please\x20check\x20your\x20model\x20configuration.','chatService','user','model','status','Search\x20API\x20error:\x20','__metadata','deep','hotSearchAccessKey','1446921WuOSZe','825RrCJzj','message','data','toString','964172rUbKZA','metadata','function','__esModule','ChatService','@nestjs/common','json','globalConfigService','object','end','setHeader','stringify','fetchHotSearches','append','modelsService','171ccrSce','slice','timestamp','error','1579539FlsRwu','format','hotSearchSecretKey','3154htMTsJ','3034800KRDVOY','hotSearchCache','__decorate','/search','research','defineProperty','ModelsService','Content-type','SearchService','71110BhwSLm','HTTP\x20error!\x20status:\x20','Search\x20error:\x20','now','getConfigs','235xLFddo','getCurrentModelKeyInfo','Hot\x20search\x20API\x20keys\x20not\x20configured','results','GET','1362BrGMse'];_0x1dd7=function(){return _0x4b641c;};return _0x1dd7();}const common_1=require(_0x403b10(0x169)),globalConfig_service_1=require(_0x403b10(0x150)),chat_service_1=require('../chat/chat.service'),models_service_1=require(_0x403b10(0x152));let SearchService=class SearchService{constructor(_0x4a1b03,_0x186a32,_0x559ebd){const _0x39c150=_0x403b10;this[_0x39c150(0x16b)]=_0x4a1b03,this[_0x39c150(0x157)]=_0x186a32,this[_0x39c150(0x172)]=_0x559ebd,this[_0x39c150(0x17c)]=null,this[_0x39c150(0x14e)]=0xa*0x3c*0x3e8;}async['searchWithExternalAPI'](_0x3e918a){const _0x22f900=_0x403b10;try{const {searchPlatformUrl:_0x30bf4d}=await this[_0x22f900(0x16b)][_0x22f900(0x147)](['searchPlatformUrl']),_0x43e63b=new URL(_0x30bf4d+_0x22f900(0x17e));_0x43e63b['searchParams']['append']('q',_0x3e918a),_0x43e63b['searchParams'][_0x22f900(0x171)](_0x22f900(0x178),'json');const _0x4bfb61=await fetch(_0x43e63b[_0x22f900(0x163)](),{'method':'GET'});if(!_0x4bfb61['ok'])throw new Error(_0x22f900(0x144)+_0x4bfb61[_0x22f900(0x15a)]);const _0x1a9bc2=await _0x4bfb61[_0x22f900(0x16a)]();return _0x1a9bc2[_0x22f900(0x14b)]||[];}catch(_0x21840b){common_1[_0x22f900(0x153)]['error'](_0x22f900(0x15b)+_0x21840b[_0x22f900(0x161)],'SearchService');throw _0x21840b;}}async[_0x403b10(0x170)](){const _0x1b14e9=_0x403b10,_0x465190=await this[_0x1b14e9(0x16b)][_0x1b14e9(0x147)]([_0x1b14e9(0x15e),_0x1b14e9(0x179)]),_0x270540=_0x465190===null||_0x465190===void 0x0?void 0x0:_0x465190[_0x1b14e9(0x15e)],_0x9afcd1=_0x465190===null||_0x465190===void 0x0?void 0x0:_0x465190[_0x1b14e9(0x179)];if(!_0x270540||!_0x9afcd1)throw new Error(_0x1b14e9(0x14a));const _0x2e6ba1=await fetch('https://www.coderutil.com/api/resou/v1/toutiao',{'method':_0x1b14e9(0x14c),'headers':{'access-key':_0x270540,'secret-key':_0x9afcd1}});if(!_0x2e6ba1['ok'])throw new Error(_0x1b14e9(0x144)+_0x2e6ba1['status']);return await _0x2e6ba1[_0x1b14e9(0x16a)]();}async['getHotSearches'](){const _0x4e5781=_0x403b10;try{const _0x1d7a80=Date[_0x4e5781(0x146)]();if(this['hotSearchCache']&&_0x1d7a80-this[_0x4e5781(0x17c)][_0x4e5781(0x175)]<this['CACHE_DURATION'])return this['hotSearchCache'][_0x4e5781(0x162)];const _0x54f14e=await this['fetchHotSearches']();return this[_0x4e5781(0x17c)]={'data':_0x54f14e,'timestamp':_0x1d7a80},_0x54f14e;}catch(_0x1b81f5){if(this[_0x4e5781(0x17c)])return this[_0x4e5781(0x17c)][_0x4e5781(0x162)];throw _0x1b81f5;}}async['search'](_0x4453f2,_0x22bb13,_0x268bda){const _0x1f9285=_0x403b10,{prompt:_0x3fdebf,model:_0xab72d9,mode:_0x161d15,parentMessageId:_0x524dde}=_0x4453f2;try{if(!_0x22bb13[_0x1f9285(0x158)])throw new Error('User\x20not\x20authenticated');_0x268bda[_0x1f9285(0x16e)](_0x1f9285(0x182),_0x1f9285(0x155));if(_0x524dde){const _0x132d67=await this['modelsService'][_0x1f9285(0x149)](_0xab72d9);if(!_0x132d67)throw new Error(_0x1f9285(0x156));const _0xe4103c=await this[_0x1f9285(0x157)][_0x1f9285(0x151)]({'prompt':_0x3fdebf,'model':_0x132d67[_0x1f9285(0x159)],'options':{'parentMessageId':_0x524dde,'usingNetwork':!![]}},_0x22bb13,_0x268bda);_0xe4103c&&_0xe4103c['id']&&_0x268bda['write']('\x0a'+JSON['stringify']({'parentMessageId':_0xe4103c['id']}));}else{const _0x129dbe=await this[_0x1f9285(0x14f)](_0x3fdebf);_0x268bda['write'](JSON[_0x1f9285(0x16f)]({'context':_0x129dbe['slice'](0x0,0x14)}));if(_0x161d15===_0x1f9285(0x15d)||_0x161d15===_0x1f9285(0x17f)){const _0x3b11a7=await this[_0x1f9285(0x14f)](_0x3fdebf+'\x20images');_0x268bda['write']('\x0a'+JSON[_0x1f9285(0x16f)]({'images':_0x3b11a7[_0x1f9285(0x174)](0x0,0x5)}));}}_0x268bda[_0x1f9285(0x16d)]();}catch(_0x34d4fd){common_1[_0x1f9285(0x153)][_0x1f9285(0x176)](_0x1f9285(0x145)+_0x34d4fd[_0x1f9285(0x161)],_0x1f9285(0x142));throw _0x34d4fd;}}};SearchService=__decorate([(0x0,common_1['Injectable'])(),__metadata('design:paramtypes',[globalConfig_service_1['GlobalConfigService'],chat_service_1[_0x403b10(0x168)],models_service_1[_0x403b10(0x181)]])],SearchService),exports[_0x403b10(0x142)]=SearchService;