'use strict';const _0x5da932=_0x72f5;(function(_0x1ba798,_0x40a17b){const _0x1050fc=_0x72f5,_0x2f3455=_0x1ba798();while(!![]){try{const _0x587270=-parseInt(_0x1050fc(0xb2))/0x1*(-parseInt(_0x1050fc(0xd5))/0x2)+-parseInt(_0x1050fc(0xf4))/0x3*(parseInt(_0x1050fc(0xd7))/0x4)+-parseInt(_0x1050fc(0xb9))/0x5+parseInt(_0x1050fc(0xe2))/0x6+-parseInt(_0x1050fc(0xe8))/0x7+-parseInt(_0x1050fc(0xd4))/0x8+-parseInt(_0x1050fc(0xdb))/0x9*(-parseInt(_0x1050fc(0xeb))/0xa);if(_0x587270===_0x40a17b)break;else _0x2f3455['push'](_0x2f3455['shift']());}catch(_0x4817b3){_0x2f3455['push'](_0x2f3455['shift']());}}}(_0xfcaf,0x381f6));function _0x72f5(_0x63cd9e,_0x1578a9){const _0xfcafc9=_0xfcaf();return _0x72f5=function(_0x72f519,_0x4dcd97){_0x72f519=_0x72f519-0xb2;let _0x156438=_0xfcafc9[_0x72f519];return _0x156438;},_0x72f5(_0x63cd9e,_0x1578a9);}var __decorate=this&&this[_0x5da932(0xc9)]||function(_0x34e619,_0x3726b5,_0x4ea364,_0x2f339e){const _0x503185=_0x5da932;var _0x89faf1=arguments[_0x503185(0xb5)],_0x2e8671=_0x89faf1<0x3?_0x3726b5:_0x2f339e===null?_0x2f339e=Object[_0x503185(0xdd)](_0x3726b5,_0x4ea364):_0x2f339e,_0x5f43ee;if(typeof Reflect===_0x503185(0xf0)&&typeof Reflect['decorate']===_0x503185(0xd9))_0x2e8671=Reflect['decorate'](_0x34e619,_0x3726b5,_0x4ea364,_0x2f339e);else{for(var _0x45863e=_0x34e619[_0x503185(0xb5)]-0x1;_0x45863e>=0x0;_0x45863e--)if(_0x5f43ee=_0x34e619[_0x45863e])_0x2e8671=(_0x89faf1<0x3?_0x5f43ee(_0x2e8671):_0x89faf1>0x3?_0x5f43ee(_0x3726b5,_0x4ea364,_0x2e8671):_0x5f43ee(_0x3726b5,_0x4ea364))||_0x2e8671;}return _0x89faf1>0x3&&_0x2e8671&&Object[_0x503185(0xd8)](_0x3726b5,_0x4ea364,_0x2e8671),_0x2e8671;},__metadata=this&&this['__metadata']||function(_0x77e4d5,_0xb9d57d){const _0x583c8c=_0x5da932;if(typeof Reflect===_0x583c8c(0xf0)&&typeof Reflect[_0x583c8c(0xc4)]===_0x583c8c(0xd9))return Reflect[_0x583c8c(0xc4)](_0x77e4d5,_0xb9d57d);};Object[_0x5da932(0xd8)](exports,_0x5da932(0xed),{'value':!![]}),exports['SearchService']=void 0x0;const common_1=require(_0x5da932(0xb6)),globalConfig_service_1=require(_0x5da932(0xc1)),chat_service_1=require(_0x5da932(0xd6)),models_service_1=require(_0x5da932(0xdc));let SearchService=class SearchService{constructor(_0x1bbe98,_0x1c84af,_0x21e983){const _0x59f274=_0x5da932;this[_0x59f274(0xb8)]=_0x1bbe98,this[_0x59f274(0xd0)]=_0x1c84af,this[_0x59f274(0xc7)]=_0x21e983,this['hotSearchCache']=null,this[_0x59f274(0xef)]=0xa*0x3c*0x3e8;}async[_0x5da932(0xe7)](_0x3aff1d){const _0x5483db=_0x5da932;try{const {searchPlatformUrl:_0x1977ba}=await this['globalConfigService'][_0x5483db(0xcc)](['searchPlatformUrl']),_0x3672f7=new URL(_0x1977ba+_0x5483db(0xee));_0x3672f7['searchParams'][_0x5483db(0xc2)]('q',_0x3aff1d),_0x3672f7[_0x5483db(0xd3)]['append'](_0x5483db(0xc0),_0x5483db(0xbe));const _0x3f23f4=await fetch(_0x3672f7[_0x5483db(0xc8)](),{'method':_0x5483db(0xc3)});if(!_0x3f23f4['ok'])throw new Error('HTTP\x20error!\x20status:\x20'+_0x3f23f4['status']);const _0x1a33af=await _0x3f23f4[_0x5483db(0xbe)]();return _0x1a33af[_0x5483db(0xce)]||[];}catch(_0x45b472){common_1[_0x5483db(0xf3)][_0x5483db(0xf7)](_0x5483db(0xca)+_0x45b472['message'],_0x5483db(0xcb));throw _0x45b472;}}async[_0x5da932(0xb7)](){const _0x2c243f=_0x5da932,_0x52fb35=await this[_0x2c243f(0xb8)][_0x2c243f(0xcc)]([_0x2c243f(0xde),_0x2c243f(0xec),_0x2c243f(0xb4)]),{hotSearchAccessKey:_0x4ba8a7,hotSearchSecretKey:_0x34f439,hotSearchApiUrl:_0x599d1e}=_0x52fb35;if(!_0x4ba8a7||!_0x34f439)throw new Error('Hot\x20search\x20API\x20keys\x20not\x20configured');const _0x3400ef=_0x599d1e||_0x2c243f(0xbb),_0x51aa1d=await fetch(_0x3400ef,{'method':_0x2c243f(0xc3),'headers':{'access-key':_0x4ba8a7,'secret-key':_0x34f439}});if(!_0x51aa1d['ok'])throw new Error(_0x2c243f(0xd1)+_0x51aa1d[_0x2c243f(0xc5)]);const _0x5af3b2=await _0x51aa1d[_0x2c243f(0xbe)]();return _0x5af3b2;}async[_0x5da932(0xcd)](){const _0x6e686f=_0x5da932;try{const _0xdf3b40=Date['now']();if(this[_0x6e686f(0xf6)]&&_0xdf3b40-this[_0x6e686f(0xf6)][_0x6e686f(0xcf)]<this['CACHE_DURATION'])return this[_0x6e686f(0xf6)][_0x6e686f(0xbd)];const _0x50050e=await this['fetchHotSearches']();return this['hotSearchCache']={'data':_0x50050e,'timestamp':_0xdf3b40},_0x50050e;}catch(_0x1199d1){if(this[_0x6e686f(0xf6)])return this['hotSearchCache'][_0x6e686f(0xbd)];throw _0x1199d1;}}async[_0x5da932(0xe0)](_0x3729ce){const _0x2cb8fc=_0x5da932,_0x28a9a6=[{'configKey':_0x2cb8fc(0xde),'configVal':_0x3729ce[_0x2cb8fc(0xde)],'encry':0x1},{'configKey':_0x2cb8fc(0xec),'configVal':_0x3729ce[_0x2cb8fc(0xec)],'encry':0x1}];return _0x3729ce[_0x2cb8fc(0xb4)]&&_0x28a9a6[_0x2cb8fc(0xda)]({'configKey':_0x2cb8fc(0xb4),'configVal':_0x3729ce[_0x2cb8fc(0xb4)],'encry':0x0}),await this[_0x2cb8fc(0xb8)][_0x2cb8fc(0xf5)]({'settings':_0x28a9a6}),this[_0x2cb8fc(0xf6)]=null,{'message':_0x2cb8fc(0xbf)};}async[_0x5da932(0xe3)](_0x365608,_0x4cee0b,_0x3a9136){const _0x418fdf=_0x5da932,{prompt:_0x53eb42,model:_0x55c43e,mode:_0x537028,parentMessageId:_0x11de4c}=_0x365608;try{if(!_0x4cee0b[_0x418fdf(0xf1)])throw new Error(_0x418fdf(0xe1));_0x3a9136['setHeader']('Content-type',_0x418fdf(0xbc));if(_0x11de4c){const _0x30df1a=await this[_0x418fdf(0xc7)]['getCurrentModelKeyInfo'](_0x55c43e);if(!_0x30df1a)throw new Error('Model\x20key\x20not\x20found.\x20Please\x20check\x20your\x20model\x20configuration.');const _0x16e8d2=await this[_0x418fdf(0xd0)][_0x418fdf(0xd2)]({'prompt':_0x53eb42,'model':_0x30df1a['model'],'options':{'parentMessageId':_0x11de4c,'usingNetwork':!![]}},_0x4cee0b,_0x3a9136);_0x16e8d2&&_0x16e8d2['id']&&_0x3a9136[_0x418fdf(0xe6)]('\x0a'+JSON[_0x418fdf(0xb3)]({'parentMessageId':_0x16e8d2['id']}));}else{const _0x1edfef=await this['searchWithExternalAPI'](_0x53eb42);_0x3a9136[_0x418fdf(0xe6)](JSON[_0x418fdf(0xb3)]({'context':_0x1edfef['slice'](0x0,0x14)}));if(_0x537028===_0x418fdf(0xdf)||_0x537028===_0x418fdf(0xe9)){const _0x17ff05=await this['searchWithExternalAPI'](_0x53eb42+'\x20images');_0x3a9136[_0x418fdf(0xe6)]('\x0a'+JSON[_0x418fdf(0xb3)]({'images':_0x17ff05[_0x418fdf(0xea)](0x0,0x5)}));}}_0x3a9136[_0x418fdf(0xba)]();}catch(_0x4ac03b){common_1['Logger'][_0x418fdf(0xf7)]('Search\x20error:\x20'+_0x4ac03b[_0x418fdf(0xe5)],_0x418fdf(0xcb));throw _0x4ac03b;}}};function _0xfcaf(){const _0x3d4749=['json','热搜配置已更新','format','../globalConfig/globalConfig.service','append','GET','metadata','status','Injectable','modelsService','toString','__decorate','Search\x20API\x20error:\x20','SearchService','getConfigs','getHotSearches','results','timestamp','chatService','HTTP\x20error!\x20status:\x20','chatProcess','searchParams','3630968gTgskM','446324IMJXhc','../chat/chat.service','120548vWbDVW','defineProperty','function','push','13104slsaDB','../models/models.service','getOwnPropertyDescriptor','hotSearchAccessKey','deep','setHotSearchConfig','User\x20not\x20authenticated','2645712jkqxJv','search','ModelsService','message','write','searchWithExternalAPI','2795142yLCepo','research','slice','7450lDTKfJ','hotSearchSecretKey','__esModule','/search','CACHE_DURATION','object','user','GlobalConfigService','Logger','21kVTTgK','setConfig','hotSearchCache','error','1lzkFks','stringify','hotSearchApiUrl','length','@nestjs/common','fetchHotSearches','globalConfigService','2274100XzvABe','end','https://www.coderutil.com/api/resou/v1/toutiao','application/octet-stream;\x20charset=utf-8','data'];_0xfcaf=function(){return _0x3d4749;};return _0xfcaf();}SearchService=__decorate([(0x0,common_1[_0x5da932(0xc6)])(),__metadata('design:paramtypes',[globalConfig_service_1[_0x5da932(0xf2)],chat_service_1['ChatService'],models_service_1[_0x5da932(0xe4)]])],SearchService),exports[_0x5da932(0xcb)]=SearchService;