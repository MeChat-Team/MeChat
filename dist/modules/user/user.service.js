'use strict';const _0x39a0e0=_0x1fe3;(function(_0x541f61,_0x1ae022){const _0x5eed35=_0x1fe3,_0x1ab79c=_0x541f61();while(!![]){try{const _0x48d5ef=parseInt(_0x5eed35(0x1a9))/0x1+-parseInt(_0x5eed35(0x201))/0x2+parseInt(_0x5eed35(0x1a2))/0x3+-parseInt(_0x5eed35(0x1b1))/0x4*(parseInt(_0x5eed35(0x1b6))/0x5)+-parseInt(_0x5eed35(0x1c1))/0x6*(-parseInt(_0x5eed35(0x175))/0x7)+-parseInt(_0x5eed35(0x17d))/0x8+parseInt(_0x5eed35(0x19b))/0x9;if(_0x48d5ef===_0x1ae022)break;else _0x1ab79c['push'](_0x1ab79c['shift']());}catch(_0x527851){_0x1ab79c['push'](_0x1ab79c['shift']());}}}(_0x4675,0x41824));var __decorate=this&&this[_0x39a0e0(0x1cb)]||function(_0x4e3078,_0x5b2631,_0x2c26aa,_0x2f6a78){const _0x397374=_0x39a0e0;var _0xb270da=arguments[_0x397374(0x1be)],_0x38c74b=_0xb270da<0x3?_0x5b2631:_0x2f6a78===null?_0x2f6a78=Object[_0x397374(0x208)](_0x5b2631,_0x2c26aa):_0x2f6a78,_0x349b86;if(typeof Reflect===_0x397374(0x190)&&typeof Reflect['decorate']==='function')_0x38c74b=Reflect[_0x397374(0x1cd)](_0x4e3078,_0x5b2631,_0x2c26aa,_0x2f6a78);else{for(var _0x2afa55=_0x4e3078[_0x397374(0x1be)]-0x1;_0x2afa55>=0x0;_0x2afa55--)if(_0x349b86=_0x4e3078[_0x2afa55])_0x38c74b=(_0xb270da<0x3?_0x349b86(_0x38c74b):_0xb270da>0x3?_0x349b86(_0x5b2631,_0x2c26aa,_0x38c74b):_0x349b86(_0x5b2631,_0x2c26aa))||_0x38c74b;}return _0xb270da>0x3&&_0x38c74b&&Object['defineProperty'](_0x5b2631,_0x2c26aa,_0x38c74b),_0x38c74b;},__metadata=this&&this[_0x39a0e0(0x179)]||function(_0x327900,_0x19af5a){const _0x270a50=_0x39a0e0;if(typeof Reflect===_0x270a50(0x190)&&typeof Reflect[_0x270a50(0x1f2)]===_0x270a50(0x194))return Reflect[_0x270a50(0x1f2)](_0x327900,_0x19af5a);},__param=this&&this[_0x39a0e0(0x1e4)]||function(_0x58cead,_0x13782d){return function(_0x5c5af7,_0x180319){_0x13782d(_0x5c5af7,_0x180319,_0x58cead);};};Object[_0x39a0e0(0x173)](exports,'__esModule',{'value':!![]}),exports[_0x39a0e0(0x1b7)]=void 0x0;const balance_constant_1=require('../../common/constants/balance.constant'),verification_constant_1=require(_0x39a0e0(0x1ec)),utils_1=require(_0x39a0e0(0x171)),mailer_service_1=require(_0x39a0e0(0x18e)),common_1=require(_0x39a0e0(0x16c)),typeorm_1=require(_0x39a0e0(0x1f8)),bcrypt=require('bcryptjs'),_=require(_0x39a0e0(0x185)),typeorm_2=require(_0x39a0e0(0x1db)),config_entity_1=require(_0x39a0e0(0x1ad)),userBalance_service_1=require('../userBalance/userBalance.service'),user_constant_1=require('./../../common/constants/user.constant'),globalConfig_service_1=require(_0x39a0e0(0x193)),verification_service_1=require(_0x39a0e0(0x207)),user_entity_1=require(_0x39a0e0(0x1de));function _0x1fe3(_0x374165,_0x5270ca){const _0x467536=_0x4675();return _0x1fe3=function(_0x1fe35d,_0x3d8f0f){_0x1fe35d=_0x1fe35d-0x158;let _0xc18c96=_0x467536[_0x1fe35d];return _0xc18c96;},_0x1fe3(_0x374165,_0x5270ca);}let UserService=class UserService{constructor(_0x5a4b86,_0x42c122,_0xaa45f6,_0x4bdc22,_0xccaf51,_0x1558a9,_0x2d679d){const _0x1c23a2=_0x39a0e0;this[_0x1c23a2(0x1d4)]=_0x5a4b86,this[_0x1c23a2(0x204)]=_0x42c122,this[_0x1c23a2(0x1b2)]=_0xaa45f6,this[_0x1c23a2(0x1d5)]=_0x4bdc22,this[_0x1c23a2(0x1dd)]=_0xccaf51,this['globalConfigService']=_0x1558a9,this[_0x1c23a2(0x197)]=_0x2d679d;}async[_0x39a0e0(0x17a)](_0x1e5f17,_0x577f6c){const _0x1c6ea0=_0x39a0e0,{username:_0xb038c7,email:_0x31f806,password:_0x454177,client:client=0x0}=_0x1e5f17,_0x4ef0fd=[{'username':_0xb038c7},{'email':_0x31f806}],_0x499c2b=await this['userEntity']['findOne']({'where':_0x4ef0fd});if(_0x499c2b&&_0x499c2b['status']!==user_constant_1[_0x1c6ea0(0x1b8)][_0x1c6ea0(0x1f9)])throw new common_1[(_0x1c6ea0(0x17b))](_0x1c6ea0(0x1a1),common_1[_0x1c6ea0(0x1d2)]['BAD_REQUEST']);try{const _0x279e2c=_['cloneDeep'](_0x1e5f17),_0x20835e=bcrypt['hashSync'](_0x454177,0xa),_0x1caf29=(0x0,utils_1[_0x1c6ea0(0x19d)])(_0x577f6c);_0x279e2c[_0x1c6ea0(0x163)]=_0x20835e,_0x279e2c[_0x1c6ea0(0x15a)]=_0x1caf29,_0x279e2c[_0x1c6ea0(0x168)]=client;let _0x23c7db;if(!_0x499c2b){const _0x4a2b00=await this[_0x1c6ea0(0x16a)]['getConfigs']([_0x1c6ea0(0x1e8)]);_0x279e2c['avatar']=_0x4a2b00,_0x23c7db=await this[_0x1c6ea0(0x1d4)]['save'](_0x279e2c);}else _0x23c7db=_0x499c2b;const _0x1b02e5=await this['configEntity'][_0x1c6ea0(0x1d6)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x1c6ea0(0x1ae),_0x1c6ea0(0x19c),_0x1c6ea0(0x18d),_0x1c6ea0(0x170),_0x1c6ea0(0x15c),_0x1c6ea0(0x1a0)])}}),_0x1ec858=_0x1b02e5['reduce']((_0x5c6eb0,_0x2c3acc)=>{const _0x5c5f77=_0x1c6ea0;return _0x5c6eb0[_0x2c3acc[_0x5c5f77(0x169)]]=_0x2c3acc[_0x5c5f77(0x1f5)],_0x5c6eb0;},{}),_0x31ea3=_0x1ec858[_0x1c6ea0(0x1ae)]?Number(_0x1ec858[_0x1c6ea0(0x1ae)]):0x1;if(_0x31ea3){const _0x1cda65=_0x1ec858[_0x1c6ea0(0x1a0)]?Number(_0x1ec858[_0x1c6ea0(0x1a0)]):0x1e*0x3c,_0x332309=await this[_0x1c6ea0(0x1b2)]['createVerification'](_0x23c7db,verification_constant_1[_0x1c6ea0(0x1e3)]['Registration'],_0x1cda65),{code:_0x16b3be,email:_0x8c6899,id:_0x3318a1}=_0x332309,{registerVerifyEmailFrom:_0x4fda5c}=_0x1ec858;console[_0x1c6ea0(0x1bc)](_0x1c6ea0(0x1eb),_0x1ec858),console[_0x1c6ea0(0x1bc)](_0x1c6ea0(0x1c5)+_0x8c6899);}else{const {id:_0x3c9d8d}=_0x23c7db;await this['updateUserStatus'](_0x3c9d8d,user_constant_1[_0x1c6ea0(0x1b8)][_0x1c6ea0(0x187)]),await this[_0x1c6ea0(0x1dd)]['addBalanceToNewUser'](_0x3c9d8d);}return _0x23c7db;}catch(_0x4cd0cd){console[_0x1c6ea0(0x1bc)](_0x1c6ea0(0x1c8),_0x4cd0cd);throw _0x4cd0cd;}}async[_0x39a0e0(0x205)](){const _0x3edb25=_0x39a0e0,_0x433ef4=await this['userEntity']['findOne']({'where':{'role':_0x3edb25(0x1f1)}});return _0x433ef4;}async[_0x39a0e0(0x174)](_0xcb7a4a){const _0x293a84=_0x39a0e0,{username:_0x2b80a0,password:_0x2b04f6,uid:uid=0x0,phone:_0x19d08f}=_0xcb7a4a;let _0x243b54=null;if(uid>0x0){_0x243b54=await this['userEntity'][_0x293a84(0x186)]({'where':{'id':uid}});if(!_0x243b54)throw new common_1[(_0x293a84(0x17b))]('当前账户不存在！',common_1[_0x293a84(0x1d2)]['BAD_REQUEST']);if(!bcrypt[_0x293a84(0x1da)](_0x2b04f6,_0x243b54['password']))throw new common_1[(_0x293a84(0x17b))](_0x293a84(0x19e),common_1[_0x293a84(0x1d2)][_0x293a84(0x199)]);}if(_0x2b80a0&&_0x2b04f6){const _0xa482ba=[{'username':_0x2b80a0},{'email':_0x2b80a0},{'phone':_0x2b80a0}];_0x243b54=await this[_0x293a84(0x1d4)]['findOne']({'where':_0xa482ba});if(!_0x243b54)throw new common_1[(_0x293a84(0x17b))](_0x293a84(0x15d),common_1['HttpStatus']['BAD_REQUEST']);if(!bcrypt['compareSync'](_0x2b04f6,_0x243b54[_0x293a84(0x163)]))throw new common_1['HttpException'](_0x293a84(0x19e),common_1[_0x293a84(0x1d2)][_0x293a84(0x199)]);}if(!_0x243b54)throw new common_1[(_0x293a84(0x17b))](_0x293a84(0x15d),common_1[_0x293a84(0x1d2)][_0x293a84(0x199)]);if(_0x243b54[_0x293a84(0x1a5)]!==user_constant_1[_0x293a84(0x1b8)][_0x293a84(0x187)])throw new common_1['HttpException'](user_constant_1[_0x293a84(0x1f6)][_0x243b54[_0x293a84(0x1a5)]],common_1[_0x293a84(0x1d2)][_0x293a84(0x199)]);return _0x243b54;}async[_0x39a0e0(0x1d9)](_0x11246b,_0x54020e){const _0x2e1de5=_0x39a0e0,_0x4ca350=await this[_0x2e1de5(0x1d4)][_0x2e1de5(0x186)]({'where':{'id':_0x11246b}});return bcrypt[_0x2e1de5(0x1da)](_0x54020e,_0x4ca350[_0x2e1de5(0x163)]);}async[_0x39a0e0(0x1f0)](_0x156a93,_0x19b13e){const _0x37f845=_0x39a0e0,_0x473588=await this[_0x37f845(0x1d4)][_0x37f845(0x1d1)]({'id':_0x156a93},{'status':_0x19b13e});return _0x473588[_0x37f845(0x1e7)]>0x0;}async['getUserStatus'](_0x3c0f7c){const _0x172906=_0x39a0e0,_0x373c50=await this[_0x172906(0x1d4)]['findOne']({'where':{'id':_0x3c0f7c}});return _0x373c50[_0x172906(0x1a5)];}async[_0x39a0e0(0x18b)](_0x3a88d4){const _0xe7d5da=_0x39a0e0;return await this[_0xe7d5da(0x1d4)][_0xe7d5da(0x186)]({'where':{'id':_0x3a88d4}});}async[_0x39a0e0(0x191)](_0x58babe){const _0x536ce2=_0x39a0e0;return await this[_0x536ce2(0x1d4)][_0x536ce2(0x186)]({'where':{'id':_0x58babe}});}async['checkUserStatus'](_0x3a014d){const _0x125890=_0x39a0e0,{id:_0x2885cf,role:_0x4c0499}=_0x3a014d;if(_0x4c0499==='visitor')return!![];const _0xa03dca=await this[_0x125890(0x1d4)][_0x125890(0x186)]({'where':{'id':_0x2885cf}});if(!_0xa03dca)throw new common_1[(_0x125890(0x17b))]('当前用户信息失效、请重新登录！',common_1[_0x125890(0x1d2)][_0x125890(0x1b3)]);if(_0xa03dca[_0x125890(0x1a5)]===user_constant_1['UserStatusEnum'][_0x125890(0x1e2)])throw new common_1[(_0x125890(0x17b))](_0x125890(0x1a4),common_1[_0x125890(0x1d2)][_0x125890(0x199)]);if(_0xa03dca['status']===user_constant_1[_0x125890(0x1b8)][_0x125890(0x172)])throw new common_1[(_0x125890(0x17b))](_0x125890(0x19f),common_1[_0x125890(0x1d2)]['BAD_REQUEST']);}async[_0x39a0e0(0x182)](_0x1f224a){const _0x1fdcce=_0x39a0e0,_0x4b1eef=await this[_0x1fdcce(0x1d4)][_0x1fdcce(0x186)]({'where':{'id':_0x1f224a},'select':[_0x1fdcce(0x1af),_0x1fdcce(0x17c),'role',_0x1fdcce(0x1ca),'sign',_0x1fdcce(0x1c3),'consecutiveDays']});if(!_0x4b1eef)throw new common_1[(_0x1fdcce(0x17b))](_0x1fdcce(0x164),common_1['HttpStatus'][_0x1fdcce(0x1b3)]);_0x4b1eef[_0x1fdcce(0x165)]=!!(_0x4b1eef===null||_0x4b1eef===void 0x0?void 0x0:_0x4b1eef[_0x1fdcce(0x1c3)]),delete _0x4b1eef['openId'];const _0x9d8a2c=await this[_0x1fdcce(0x1dd)][_0x1fdcce(0x15e)](_0x1f224a),_0x5a6fbe=(_0x1f224a*0x7b+0x5f5e100)[_0x1fdcce(0x196)](0x24)['toUpperCase']()[_0x1fdcce(0x167)](-0x6);return _0x4b1eef['id']=_0x5a6fbe,{'userInfo':_0x4b1eef,'userBalance':Object[_0x1fdcce(0x1ab)]({},_0x9d8a2c)};}async[_0x39a0e0(0x18a)](_0x47d8a8){const _0x1322b4=_0x39a0e0;return await this[_0x1322b4(0x1d4)][_0x1322b4(0x186)]({'where':{'id':_0x47d8a8}});}async[_0x39a0e0(0x1fe)](_0x2fa891){return await this['userEntity']['findOne']({'where':{'openId':_0x2fa891}});}async[_0x39a0e0(0x1ed)](_0x8dd1cb,_0x345733){const _0x258aed=_0x39a0e0,{id:_0x266d42}=_0x345733[_0x258aed(0x203)],_0x25cd15=await this[_0x258aed(0x1d4)][_0x258aed(0x186)]({'where':{'id':_0x266d42}});if(!_0x25cd15)throw new common_1[(_0x258aed(0x17b))]('当前用户不存在！',common_1[_0x258aed(0x1d2)][_0x258aed(0x199)]);if(_0x8dd1cb[_0x258aed(0x1af)]&&_0x25cd15[_0x258aed(0x1af)]===_0x8dd1cb[_0x258aed(0x1af)])throw new common_1[(_0x258aed(0x17b))](_0x258aed(0x1bb),common_1['HttpStatus'][_0x258aed(0x199)]);if(_0x8dd1cb[_0x258aed(0x1af)]){const _0x3b2359=await this[_0x258aed(0x1a6)](_0x8dd1cb[_0x258aed(0x1af)],_0x266d42);if(_0x3b2359)throw new common_1[(_0x258aed(0x17b))](_0x258aed(0x198),common_1['HttpStatus'][_0x258aed(0x199)]);}const _0x468715=await this[_0x258aed(0x1d4)][_0x258aed(0x1d1)]({'id':_0x266d42},_0x8dd1cb);if(_0x468715[_0x258aed(0x1e7)]<=0x0)throw new common_1['HttpException'](_0x258aed(0x1dc),common_1[_0x258aed(0x1d2)][_0x258aed(0x199)]);return _0x258aed(0x1df);}async[_0x39a0e0(0x1a6)](_0x56279d,_0x4dbecd){const _0x3ec43d=_0x39a0e0,_0x1eadb2={'username':_0x56279d};_0x4dbecd&&(_0x1eadb2['id']=(0x0,typeorm_2[_0x3ec43d(0x1c6)])(_0x4dbecd));const _0x45f17f=await this[_0x3ec43d(0x1d4)][_0x3ec43d(0x186)]({'where':_0x1eadb2});return!!_0x45f17f;}async[_0x39a0e0(0x1c4)](_0x54f208,_0xabd382){const _0xe2e80a=_0x39a0e0,_0x4cece4=bcrypt[_0xe2e80a(0x1bd)](_0xabd382,0xa),_0x514001=await this[_0xe2e80a(0x1d4)][_0xe2e80a(0x1d1)]({'id':_0x54f208},{'password':_0x4cece4});if(_0x514001[_0xe2e80a(0x1e7)]<=0x0)throw new common_1[(_0xe2e80a(0x17b))]('修改密码失败、请重新试试吧。',common_1[_0xe2e80a(0x1d2)]['BAD_REQUEST']);}async[_0x39a0e0(0x184)](_0x3863da){const _0xeb4c95=_0x39a0e0,{userId:_0x5a3b6e,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x3863da;await this[_0xeb4c95(0x1dd)][_0xeb4c95(0x1c7)](_0x5a3b6e,{'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});const _0x18729d=await this[_0xeb4c95(0x1dd)][_0xeb4c95(0x181)]({'userId':_0x5a3b6e,'rechargeType':balance_constant_1[_0xeb4c95(0x1ac)][_0xeb4c95(0x188)],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'extent':''});return _0x18729d;}async[_0x39a0e0(0x16f)](_0x2db92c,_0x5976b7){const _0x129d94=_0x39a0e0,{page:page=0x1,size:size=0xa,username:_0x31f72e,email:_0x4a2849,status:_0x3fef3b,keyword:_0x386419,phone:_0xaee5c5}=_0x2db92c;let _0xc7c941={};_0x31f72e&&Object['assign'](_0xc7c941,{'username':(0x0,typeorm_2[_0x129d94(0x1c2)])('%'+_0x31f72e+'%')}),_0x4a2849&&Object[_0x129d94(0x1ab)](_0xc7c941,{'email':(0x0,typeorm_2[_0x129d94(0x1c2)])('%'+_0x4a2849+'%')}),_0xaee5c5&&Object[_0x129d94(0x1ab)](_0xc7c941,{'phone':(0x0,typeorm_2[_0x129d94(0x1c2)])('%'+_0xaee5c5+'%')}),_0x3fef3b&&Object[_0x129d94(0x1ab)](_0xc7c941,{'status':_0x3fef3b});_0x386419&&(_0xc7c941=[{'username':(0x0,typeorm_2['Like'])('%'+_0x386419+'%')},{'email':(0x0,typeorm_2['Like'])('%'+_0x386419+'%')},{'phone':(0x0,typeorm_2[_0x129d94(0x1c2)])('%'+_0x386419+'%')}]);const [_0x2bf8cf,_0xc9eacf]=await this[_0x129d94(0x1d4)][_0x129d94(0x1e9)]({'skip':(page-0x1)*size,'where':_0xc7c941,'take':size,'order':{'createdAt':_0x129d94(0x158)},'cache':!![],'select':[_0x129d94(0x1af),'avatar',_0x129d94(0x17f),_0x129d94(0x15b),'status','id',_0x129d94(0x1ca),'createdAt','lastLoginIp','phone',_0x129d94(0x1e5),'idCard']}),_0x2a5796=_0x2bf8cf[_0x129d94(0x180)](_0x28fe93=>_0x28fe93['id']),_0x500832=await this[_0x129d94(0x1dd)]['queryUserBalanceByIds'](_0x2a5796);return _0x2bf8cf[_0x129d94(0x192)](_0x5e1e63=>_0x5e1e63[_0x129d94(0x1ea)]=_0x500832[_0x129d94(0x1d6)](_0x5c48b0=>_0x5c48b0[_0x129d94(0x1b5)]===_0x5e1e63['id'])),_0x5976b7[_0x129d94(0x203)]['role']!==_0x129d94(0x1f1)&&_0x2bf8cf['forEach'](_0x13eaac=>_0x13eaac['email']=(0x0,utils_1[_0x129d94(0x1cc)])(_0x13eaac['email'])),_0x5976b7['user'][_0x129d94(0x17f)]!=='super'&&_0x2bf8cf[_0x129d94(0x192)](_0x217363=>_0x217363[_0x129d94(0x19a)]=(0x0,utils_1[_0x129d94(0x16d)])(_0x217363[_0x129d94(0x19a)])),_0x5976b7[_0x129d94(0x203)]['role']!=='super'&&_0x2bf8cf[_0x129d94(0x192)](_0x259bd5=>_0x259bd5[_0x129d94(0x1fb)]=(0x0,utils_1['maskIpAddress'])(_0x259bd5[_0x129d94(0x1fb)])),{'rows':_0x2bf8cf,'count':_0xc9eacf};}async[_0x39a0e0(0x1e0)]({id:_0x33e236}){const _0x58a77a=_0x39a0e0;return await this[_0x58a77a(0x1d4)]['findOne']({'where':{'id':_0x33e236},'select':[_0x58a77a(0x1af),_0x58a77a(0x17c),_0x58a77a(0x17f),_0x58a77a(0x15b),'status']});}async[_0x39a0e0(0x200)](_0x3d0969){const _0x4b9b77=_0x39a0e0,{id:_0x5cbde6,status:_0x4becec}=_0x3d0969,_0x2c8ea1=await this['userEntity'][_0x4b9b77(0x186)]({'where':{'id':_0x5cbde6}});if(!_0x2c8ea1)throw new common_1[(_0x4b9b77(0x17b))]('用户不存在！',common_1[_0x4b9b77(0x1d2)][_0x4b9b77(0x199)]);if(_0x2c8ea1[_0x4b9b77(0x17f)]===_0x4b9b77(0x1f1))throw new common_1[(_0x4b9b77(0x17b))](_0x4b9b77(0x1f4),common_1[_0x4b9b77(0x1d2)][_0x4b9b77(0x199)]);if(_0x2c8ea1['role']===_0x4b9b77(0x1f1))throw new common_1[(_0x4b9b77(0x17b))](_0x4b9b77(0x1f4),common_1[_0x4b9b77(0x1d2)][_0x4b9b77(0x199)]);const _0x5f94b1=await this[_0x4b9b77(0x1d4)]['update']({'id':_0x5cbde6},{'status':_0x4becec});if(_0x5f94b1[_0x4b9b77(0x1e7)]<=0x0)throw new common_1['HttpException'](_0x4b9b77(0x183),common_1[_0x4b9b77(0x1d2)][_0x4b9b77(0x199)]);return _0x4b9b77(0x1e6);}async[_0x39a0e0(0x189)](_0x42c923){const _0x4a56e5=_0x39a0e0,{id:_0x2ea8dc}=_0x42c923,_0x5dec4a=await this['userEntity'][_0x4a56e5(0x186)]({'where':{'id':_0x2ea8dc}});if(!_0x5dec4a)throw new common_1[(_0x4a56e5(0x17b))](_0x4a56e5(0x17e),common_1[_0x4a56e5(0x1d2)][_0x4a56e5(0x199)]);const _0xfde2f5=_0x4a56e5(0x1c0),_0x1e5de3=bcrypt[_0x4a56e5(0x1bd)](_0xfde2f5,0xa),_0x395350=await this[_0x4a56e5(0x1d4)][_0x4a56e5(0x1d1)]({'id':_0x2ea8dc},{'password':_0x1e5de3});if(_0x395350['affected']<=0x0)throw new common_1['HttpException'](_0x4a56e5(0x1c9),common_1[_0x4a56e5(0x1d2)]['BAD_REQUEST']);return _0x4a56e5(0x176)+_0xfde2f5+']成功!';}async[_0x39a0e0(0x1d8)](_0x3d9424,_0x60829d){const _0x328677=_0x39a0e0;return await this[_0x328677(0x1d4)][_0x328677(0x1d1)]({'id':_0x3d9424},{'lastLoginIp':_0x60829d});}async[_0x39a0e0(0x1b4)](_0x42a32b,_0x3690e3){const _0x23b19d=_0x39a0e0,_0x2cc118=await this['userEntity'][_0x23b19d(0x186)]({'where':{'openId':_0x42a32b}});if(!_0x2cc118){const _0x8a3515=await this[_0x23b19d(0x18c)](_0x42a32b);return await this[_0x23b19d(0x1dd)][_0x23b19d(0x18f)](_0x8a3515['id']),_0x8a3515;}return _0x2cc118;}async[_0x39a0e0(0x18c)](_0x4c1aea){const _0x5daea2=_0x39a0e0,_0x5c6f36=await this[_0x5daea2(0x16a)][_0x5daea2(0x1ce)]([_0x5daea2(0x1e8)]),_0x4a1dd7={'avatar':_0x5c6f36,'username':'用户'+(0x0,utils_1[_0x5daea2(0x1ee)])(),'status':user_constant_1[_0x5daea2(0x1b8)][_0x5daea2(0x187)],'sex':0x0,'email':(0x0,utils_1[_0x5daea2(0x1ee)])()+'@default.com','openId':_0x4c1aea},_0x2a63c7=await this[_0x5daea2(0x1d4)][_0x5daea2(0x1bf)](_0x4a1dd7);return _0x2a63c7;}async[_0x39a0e0(0x16e)](_0x2f005f){const _0x317d80=_0x39a0e0,{username:_0x3a1498,email:_0x305188,phone:_0x1c43cc}=_0x2f005f,_0x35ac6f=await this[_0x317d80(0x16a)]['getConfigs']([_0x317d80(0x1e8)]),_0x4271d4={'avatar':_0x35ac6f,'username':'用户'+(0x0,utils_1[_0x317d80(0x1ee)])(),'status':user_constant_1['UserStatusEnum'][_0x317d80(0x187)],'sex':0x0};_0x3a1498&&(_0x4271d4[_0x317d80(0x1af)]=_0x3a1498);_0x305188&&(_0x4271d4['email']=_0x305188);_0x1c43cc&&(_0x4271d4[_0x317d80(0x1fb)]=_0x1c43cc);const _0x4fdc1e=await this['userEntity']['save'](_0x4271d4);return _0x4fdc1e;}async[_0x39a0e0(0x1b9)](_0x298efd){const _0x4a1310=_0x39a0e0,{username:_0x5c2248,email:_0x25d15a,phone:_0x18e70b}=_0x298efd,_0x2ae36d=[];return _0x5c2248&&_0x2ae36d['push']({'username':_0x5c2248}),_0x25d15a&&_0x2ae36d[_0x4a1310(0x15f)]({'email':_0x25d15a}),_0x18e70b&&_0x2ae36d[_0x4a1310(0x15f)]({'phone':_0x18e70b}),await this[_0x4a1310(0x1d4)][_0x4a1310(0x186)]({'where':_0x2ae36d});}async['bindWx'](_0x546341,_0x440ef9){const _0x4b725a=_0x39a0e0;try{const _0x9667d1=await this[_0x4b725a(0x1d4)][_0x4b725a(0x186)]({'where':{'id':_0x440ef9}});if(!_0x9667d1)return{'status':![],'msg':_0x4b725a(0x1ef)};const _0x35e170=await this[_0x4b725a(0x1d4)]['findOne']({'where':{'openId':_0x546341}});if(_0x35e170)return{'status':![],'msg':_0x4b725a(0x161)};const _0x43ff24=await this['userEntity'][_0x4b725a(0x1d1)]({'id':_0x440ef9},{'openId':_0x546341});if(_0x43ff24['affected']<=0x0)return{'status':![],'msg':_0x4b725a(0x160)};return{'status':!![],'msg':'恭喜您绑定成功、后续可直接扫码登录了！'};}catch(_0x1107a1){return{'status':![],'msg':_0x4b725a(0x160)};}}async[_0x39a0e0(0x1fd)](_0x539cf6){const _0x519172=_0x39a0e0,_0x19678b=await this[_0x519172(0x1d4)][_0x519172(0x186)]({'where':{'id':_0x539cf6}});return _0x19678b===null||_0x19678b===void 0x0?void 0x0:_0x19678b[_0x519172(0x1c3)];}async[_0x39a0e0(0x1d7)](_0xf2e0d7){const _0x5eff56=_0x39a0e0,{username:_0x314535,phone:_0x191bee,email:_0x54d0e9}=_0xf2e0d7;if(_0x191bee){const _0x195c3b=await this[_0x5eff56(0x1d4)]['findOne']({'where':{'phone':_0x191bee}});if(_0x195c3b)return![];}if(_0x54d0e9){const _0x387a7c=await this[_0x5eff56(0x1d4)]['findOne']({'where':{'email':_0x54d0e9}});if(_0x387a7c)return![];}if(_0x314535){const _0x41fdc4=await this[_0x5eff56(0x1d4)][_0x5eff56(0x186)]({'where':{'username':_0x314535}});if(_0x41fdc4)return![];}if(!_0x191bee&&!_0x54d0e9&&!_0x314535)return![];return!![];}async[_0x39a0e0(0x206)](_0x5141f0){const _0x4e917e=_0x39a0e0,{username:_0x47d4fc,password:_0x3af68d,phone:_0x4c2d0f,phoneCode:_0x31e1f7}=_0x5141f0,_0x56bb9d=await this['userEntity'][_0x4e917e(0x186)]({'where':[{'username':_0x47d4fc},{'phone':_0x4c2d0f}]});if(_0x56bb9d&&_0x56bb9d[_0x4e917e(0x1af)]===_0x47d4fc)throw new common_1[(_0x4e917e(0x17b))](_0x4e917e(0x1a8),common_1['HttpStatus'][_0x4e917e(0x199)]);if(_0x56bb9d&&_0x56bb9d[_0x4e917e(0x1fb)]===_0x4c2d0f)throw new common_1[(_0x4e917e(0x17b))]('当前手机号已注册、请勿重复注册！',common_1[_0x4e917e(0x1d2)]['BAD_REQUEST']);}async[_0x39a0e0(0x1ff)](_0x5bc9d1){const _0x1e835e=_0x39a0e0,{username:_0x2903c3,email:_0x541ce1}=_0x5bc9d1;console['log']('校验邮箱注册:\x20开始\x20-\x20用户名:\x20'+_0x2903c3+_0x1e835e(0x1fc)+_0x541ce1);const _0x1819e9=await this[_0x1e835e(0x1d4)][_0x1e835e(0x186)]({'where':[{'username':_0x2903c3},{'email':_0x541ce1}]});if(_0x1819e9&&_0x1819e9[_0x1e835e(0x1af)]===_0x2903c3){console[_0x1e835e(0x1fa)](_0x1e835e(0x177)+_0x2903c3+_0x1e835e(0x16b));throw new common_1['HttpException'](_0x1e835e(0x1a8),common_1[_0x1e835e(0x1d2)][_0x1e835e(0x199)]);}if(_0x1819e9&&_0x1819e9['email']===_0x541ce1){console[_0x1e835e(0x1fa)]('校验失败:\x20邮箱\x20\x22'+_0x541ce1+'\x22\x20已被注册');throw new common_1[(_0x1e835e(0x17b))](_0x1e835e(0x166),common_1[_0x1e835e(0x1d2)][_0x1e835e(0x199)]);}console['log']('校验邮箱注册:\x20成功\x20-\x20用户名:\x20'+_0x2903c3+_0x1e835e(0x1fc)+_0x541ce1+_0x1e835e(0x1d3));}async[_0x39a0e0(0x1a3)](_0xc5cf3f){const _0x209485=_0x39a0e0;return await this[_0x209485(0x1d4)][_0x209485(0x1bf)](_0xc5cf3f);}async[_0x39a0e0(0x1aa)](_0x6337f2,_0x438dcd,_0x398c67){const _0x29944f=_0x39a0e0,_0x2375a1=await this[_0x29944f(0x1d4)][_0x29944f(0x186)]({'where':{'id':_0x6337f2}});!_0x2375a1&&common_1['Logger']['error'](_0x29944f(0x1a7));await this['userEntity'][_0x29944f(0x1d1)]({'id':_0x6337f2},{'realName':_0x438dcd,'idCard':_0x398c67});return;}async[_0x39a0e0(0x159)](_0x291c0e,_0x270d96,_0x3e54e2,_0x5a3578){const _0x3b9b07=_0x39a0e0,_0x1620ed=await this[_0x3b9b07(0x1d4)]['findOne']({'where':{'id':_0x291c0e}}),_0x2f7993=bcrypt[_0x3b9b07(0x1bd)](_0x5a3578,0xa);!_0x1620ed&&common_1[_0x3b9b07(0x1d0)]['error'](_0x3b9b07(0x1a7));if(!_0x270d96||!_0x3e54e2||!_0x2f7993)throw new common_1[(_0x3b9b07(0x17b))](_0x3b9b07(0x195),common_1[_0x3b9b07(0x1d2)][_0x3b9b07(0x199)]);await this[_0x3b9b07(0x1d4)][_0x3b9b07(0x1d1)]({'id':_0x291c0e},{'phone':_0x270d96,'username':_0x3e54e2,'password':_0x2f7993});return;}};UserService=__decorate([(0x0,common_1[_0x39a0e0(0x178)])(),__param(0x0,(0x0,typeorm_1[_0x39a0e0(0x162)])(user_entity_1[_0x39a0e0(0x1e1)])),__param(0x6,(0x0,typeorm_1[_0x39a0e0(0x162)])(config_entity_1[_0x39a0e0(0x202)])),__metadata(_0x39a0e0(0x1ba),[typeorm_2['Repository'],typeorm_2[_0x39a0e0(0x1cf)],verification_service_1['VerificationService'],mailer_service_1[_0x39a0e0(0x1b0)],userBalance_service_1[_0x39a0e0(0x1f7)],globalConfig_service_1[_0x39a0e0(0x1f3)],typeorm_2['Repository']])],UserService),exports[_0x39a0e0(0x1b7)]=UserService;function _0x4675(){const _0x358c4b=['ADMIN_GIFT','resetUserPass','getUserById','queryUserInfoById','createUserFromOpenId','registerVerifyEmailTitle','../mailer/mailer.service','addBalanceToNewUser','object','queryOneUserInfo','forEach','./../globalConfig/globalConfig.service','function','参数错误！','toString','configEntity','用户名已存在！','BAD_REQUEST','lastLoginIp','5552307clvKTS','registerBaseUrl','getClientIp','当前密码错误！','您的账户已被封禁、如有疑问、请联系管理员！','registerVerifyExpir','用户名或者邮箱已被注册！','256425KJKZxY','createUser','您的账户已被永久加入黑名单、如有疑问、请联系管理员！','status','isUsernameTaken','用户不存在','用户名已存在、请更换用户名！','38638QmhgcM','saveRealNameInfo','assign','RechargeType','../globalConfig/config.entity','isVerifyEmail','username','MailerService','32AcEHQm','verificationService','UNAUTHORIZED','getUserFromOpenId','userId','68680fGZDKi','UserService','UserStatusEnum','getUserByContact','design:paramtypes','没有变更，无需更改！','log','hashSync','length','save','123456','494034xWQCUF','Like','openId','updateUserPassword','尝试发送邮件到:\x20','Not','addBalanceToUser','error:\x20','重置密码失败！','email','__decorate','maskEmail','decorate','getConfigs','Connection','Logger','update','HttpStatus','\x20未被占用','userEntity','mailerService','find','verifyUserRegister','savaLoginIp','verifyUserPassword','compareSync','typeorm','修改用户信息失败！','userBalanceService','./user.entity','修改用户信息成功！','queryOne','UserEntity','BLACKLISTED','VerificationEnum','__param','realName','修改用户状态成功！','affected','userDefautlAvatar','findAndCount','balanceInfo','configMap:\x20','../../common/constants/verification.constant','updateInfo','createRandomUid','当前绑定用户不存在！','updateUserStatus','super','metadata','GlobalConfigService','超级管理员不可被操作！','configVal','UserStatusErrMsg','UserBalanceService','@nestjs/typeorm','PENDING','error','phone',',\x20邮箱:\x20','getOpenIdByUserId','getUserOpenId','verifyUserRegisterByEmail','updateStatus','19070mguWSS','ConfigEntity','user','connection','getSuper','verifyUserRegisterByPhone','./../verification/verification.service','getOwnPropertyDescriptor','DESC','updateUserPhone','registerIp','sign','registerVerifyEmailFrom','当前账户不存在！','queryUserBalance','push','绑定微信失败、请联系管理员！','该微信已绑定其他账号！','InjectRepository','password','当前用户信息失效、请重新登录！','isBindWx','当前邮箱已注册、请勿重复注册！','slice','client','configKey','globalConfigService','\x22\x20已存在','@nestjs/common','maskIpAddress','createUserFromContact','queryAll','registerVerifyEmailDesc','../../common/utils','LOCKED','defineProperty','verifyUserCredentials','14scUgXu','密码重置为[','校验失败:\x20用户名\x20\x22','Injectable','__metadata','createUserAndVerifycation','HttpException','avatar','4143736uDSeDw','用户不存在！','role','map','saveRecordRechargeLog','getUserInfo','修改用户状态失败！','userRecharge','lodash','findOne','ACTIVE'];_0x4675=function(){return _0x358c4b;};return _0x4675();}