'use strict';const _0x485823=_0x2bc5;(function(_0x50295f,_0x363cc8){const _0x27e2d8=_0x2bc5,_0x27fa7f=_0x50295f();while(!![]){try{const _0x38674a=-parseInt(_0x27e2d8(0x210))/0x1+-parseInt(_0x27e2d8(0x22a))/0x2*(parseInt(_0x27e2d8(0x25a))/0x3)+parseInt(_0x27e2d8(0x205))/0x4*(parseInt(_0x27e2d8(0x1c9))/0x5)+parseInt(_0x27e2d8(0x232))/0x6+-parseInt(_0x27e2d8(0x263))/0x7*(-parseInt(_0x27e2d8(0x261))/0x8)+parseInt(_0x27e2d8(0x243))/0x9+-parseInt(_0x27e2d8(0x218))/0xa;if(_0x38674a===_0x363cc8)break;else _0x27fa7f['push'](_0x27fa7f['shift']());}catch(_0xf5a871){_0x27fa7f['push'](_0x27fa7f['shift']());}}}(_0x4fd9,0x99009));function _0x2bc5(_0x332ef1,_0x3031a9){const _0x4fd9a7=_0x4fd9();return _0x2bc5=function(_0x2bc557,_0x1e252f){_0x2bc557=_0x2bc557-0x1c0;let _0x4fb104=_0x4fd9a7[_0x2bc557];return _0x4fb104;},_0x2bc5(_0x332ef1,_0x3031a9);}function _0x4fd9(){const _0x1de579=['client','2759907cKqHrM','compareSync','校验邮箱注册:\x20成功\x20-\x20用户名:\x20','尝试发送邮件到:\x20','updateUserStatus','updateUserPassword','registerIp','128vcnxZr','恭喜您绑定成功、后续可直接扫码登录了！','470099BTbiVM','idCard','当前用户信息失效、请重新登录！','Not','__param','../../common/constants/balance.constant','verifyUserRegisterByPhone','用户名已存在、请更换用户名！','DESC','GlobalConfigService','校验失败:\x20邮箱\x20\x22','511960YYEGIc','createUserAndVerifycation','@nestjs/typeorm','maskIpAddress','avatar','ACTIVE','该微信已绑定其他账号！','savaLoginIp','超级管理员不可被操作！','metadata','sign','没有变更，无需更改！','userDefautlAvatar','lastLoginIp','updateUserPhone','update','assign','用户名已存在！','updateStatus','queryOne','addBalanceToNewUser','./../verification/verification.service','phone','密码重置为[','consecutiveDays','verifyUserCredentials','mailerService','error','lodash','\x22\x20已被注册','function','bcryptjs','verifyUserPassword','当前绑定用户不存在！','./../globalConfig/globalConfig.service','修改用户状态成功！','Registration','createRandomUid','当前账户不存在！','findOne','Like','slice','getClientIp','RechargeType','save','username','forEach','userBalanceService','registerVerifyExpir','toString','defineProperty','registerBaseUrl','BAD_REQUEST','queryUserBalanceByIds','用户不存在！','visitor','checkUserStatus','updateInfo','affected','修改用户状态失败！','32PWPAAG','Injectable','userEntity','当前邮箱已注册、请勿重复注册！','getUserByContact','createUserFromOpenId','password','configEntity','绑定微信失败、请联系管理员！','globalConfigService','isUsernameTaken','1251229mrdbZZ','VerificationService','getUserInfo','resetUserPass','role','UserStatusEnum','../../common/utils','registerVerifyEmailFrom','288750Srmtse','修改用户信息成功！','../globalConfig/config.entity','object','UserService','typeorm','createVerification','@default.com','修改用户信息失败！','map','createUser','openId','bindWx','InjectRepository','queryUserBalance','ConfigEntity','用户不存在','push','2TAUYqP','getUserStatus','connection','addBalanceToUser','./../../common/constants/user.constant','../userBalance/userBalance.service','getConfigs','error:\x20','2415450pllYUB','isVerifyEmail','123456','VerificationEnum','getSuper','toUpperCase','maskEmail','MailerService','HttpStatus','status','\x22\x20已存在','getUserOpenId','configVal','find','cloneDeep','super','length','4774923hZUtzH','./user.entity','\x20未被占用','verificationService','hashSync','../../common/constants/verification.constant','realName','registerVerifyEmailDesc','校验失败:\x20用户名\x20\x22','user','email','HttpException','用户名或者邮箱已被注册！','isBindWx','PENDING','UserBalanceService','Repository','saveRecordRechargeLog','../mailer/mailer.service','decorate','log','userId'];_0x4fd9=function(){return _0x1de579;};return _0x4fd9();}var __decorate=this&&this['__decorate']||function(_0x2a7a59,_0x19eb09,_0x45acb0,_0x46527d){const _0x165689=_0x2bc5;var _0x4d99a6=arguments[_0x165689(0x242)],_0x9de7b0=_0x4d99a6<0x3?_0x19eb09:_0x46527d===null?_0x46527d=Object['getOwnPropertyDescriptor'](_0x19eb09,_0x45acb0):_0x46527d,_0x4a5b48;if(typeof Reflect===_0x165689(0x21b)&&typeof Reflect[_0x165689(0x256)]===_0x165689(0x1e7))_0x9de7b0=Reflect['decorate'](_0x2a7a59,_0x19eb09,_0x45acb0,_0x46527d);else{for(var _0x5c78b3=_0x2a7a59['length']-0x1;_0x5c78b3>=0x0;_0x5c78b3--)if(_0x4a5b48=_0x2a7a59[_0x5c78b3])_0x9de7b0=(_0x4d99a6<0x3?_0x4a5b48(_0x9de7b0):_0x4d99a6>0x3?_0x4a5b48(_0x19eb09,_0x45acb0,_0x9de7b0):_0x4a5b48(_0x19eb09,_0x45acb0))||_0x9de7b0;}return _0x4d99a6>0x3&&_0x9de7b0&&Object[_0x165689(0x1fb)](_0x19eb09,_0x45acb0,_0x9de7b0),_0x9de7b0;},__metadata=this&&this['__metadata']||function(_0xa1b289,_0x1d2a71){const _0x350fac=_0x2bc5;if(typeof Reflect===_0x350fac(0x21b)&&typeof Reflect[_0x350fac(0x1d2)]==='function')return Reflect[_0x350fac(0x1d2)](_0xa1b289,_0x1d2a71);},__param=this&&this[_0x485823(0x1c2)]||function(_0x1a2858,_0x25f605){return function(_0x50053d,_0x2ef8d7){_0x25f605(_0x50053d,_0x2ef8d7,_0x1a2858);};};Object[_0x485823(0x1fb)](exports,'__esModule',{'value':!![]}),exports[_0x485823(0x21c)]=void 0x0;const balance_constant_1=require(_0x485823(0x1c3)),verification_constant_1=require(_0x485823(0x248)),utils_1=require(_0x485823(0x216)),mailer_service_1=require(_0x485823(0x255)),common_1=require('@nestjs/common'),typeorm_1=require(_0x485823(0x1cb)),bcrypt=require(_0x485823(0x1e8)),_=require(_0x485823(0x1e5)),typeorm_2=require(_0x485823(0x21d)),config_entity_1=require(_0x485823(0x21a)),userBalance_service_1=require(_0x485823(0x22f)),user_constant_1=require(_0x485823(0x22e)),globalConfig_service_1=require(_0x485823(0x1eb)),verification_service_1=require(_0x485823(0x1de)),user_entity_1=require(_0x485823(0x244));let UserService=class UserService{constructor(_0x1f77f8,_0x321d0c,_0x32b439,_0x229745,_0x571412,_0x19cb7f,_0x585206){const _0x235066=_0x485823;this[_0x235066(0x207)]=_0x1f77f8,this[_0x235066(0x22c)]=_0x321d0c,this['verificationService']=_0x32b439,this[_0x235066(0x1e3)]=_0x229745,this['userBalanceService']=_0x571412,this['globalConfigService']=_0x19cb7f,this[_0x235066(0x20c)]=_0x585206;}async[_0x485823(0x1ca)](_0x2f8b52,_0x458a6a){const _0x3d167e=_0x485823,{username:_0x114352,email:_0x37996b,password:_0x417956,client:client=0x0}=_0x2f8b52,_0x7647d7=[{'username':_0x114352},{'email':_0x37996b}],_0x31055b=await this[_0x3d167e(0x207)][_0x3d167e(0x1f0)]({'where':_0x7647d7});if(_0x31055b&&_0x31055b[_0x3d167e(0x23b)]!==user_constant_1['UserStatusEnum'][_0x3d167e(0x251)])throw new common_1[(_0x3d167e(0x24e))](_0x3d167e(0x24f),common_1[_0x3d167e(0x23a)][_0x3d167e(0x1fd)]);try{const _0x3b04f6=_[_0x3d167e(0x240)](_0x2f8b52),_0x1691d2=bcrypt[_0x3d167e(0x247)](_0x417956,0xa),_0x3a051a=(0x0,utils_1[_0x3d167e(0x1f3)])(_0x458a6a);_0x3b04f6['password']=_0x1691d2,_0x3b04f6[_0x3d167e(0x260)]=_0x3a051a,_0x3b04f6[_0x3d167e(0x259)]=client;let _0x5ea228;if(!_0x31055b){const _0x3174e3=await this[_0x3d167e(0x20e)][_0x3d167e(0x230)]([_0x3d167e(0x1d5)]);_0x3b04f6[_0x3d167e(0x1cd)]=_0x3174e3,_0x5ea228=await this['userEntity']['save'](_0x3b04f6);}else _0x5ea228=_0x31055b;const _0x2716c6=await this[_0x3d167e(0x20c)][_0x3d167e(0x23f)]({'where':{'configKey':(0x0,typeorm_2['In'])(['isVerifyEmail',_0x3d167e(0x1fc),'registerVerifyEmailTitle',_0x3d167e(0x24a),_0x3d167e(0x217),_0x3d167e(0x1f9)])}}),_0x5b39a9=_0x2716c6['reduce']((_0x315fd6,_0x35a460)=>{const _0x1e7aec=_0x3d167e;return _0x315fd6[_0x35a460['configKey']]=_0x35a460[_0x1e7aec(0x23e)],_0x315fd6;},{}),_0x1df188=_0x5b39a9[_0x3d167e(0x233)]?Number(_0x5b39a9['isVerifyEmail']):0x1;if(_0x1df188){const _0x4dc705=_0x5b39a9[_0x3d167e(0x1f9)]?Number(_0x5b39a9[_0x3d167e(0x1f9)]):0x1e*0x3c,_0x3af01c=await this[_0x3d167e(0x246)][_0x3d167e(0x21e)](_0x5ea228,verification_constant_1[_0x3d167e(0x235)][_0x3d167e(0x1ed)],_0x4dc705),{code:_0x37a829,email:_0x114561,id:_0x1fc998}=_0x3af01c,{registerVerifyEmailFrom:_0x63b92f}=_0x5b39a9;console[_0x3d167e(0x257)]('configMap:\x20',_0x5b39a9),console['log'](_0x3d167e(0x25d)+_0x114561);}else{const {id:_0x245415}=_0x5ea228;await this[_0x3d167e(0x25e)](_0x245415,user_constant_1[_0x3d167e(0x215)][_0x3d167e(0x1ce)]),await this[_0x3d167e(0x1f8)][_0x3d167e(0x1dd)](_0x245415);}return _0x5ea228;}catch(_0x2930a9){console[_0x3d167e(0x257)](_0x3d167e(0x231),_0x2930a9);throw _0x2930a9;}}async[_0x485823(0x236)](){const _0x2d2ad5=_0x485823,_0x54025e=await this[_0x2d2ad5(0x207)][_0x2d2ad5(0x1f0)]({'where':{'role':_0x2d2ad5(0x241)}});return _0x54025e;}async[_0x485823(0x1e2)](_0x4c7bba){const _0x56d9f0=_0x485823,{username:_0xb2d3a7,password:_0x31405a,uid:uid=0x0,phone:_0x3c22ea}=_0x4c7bba;let _0x415c40=null;if(uid>0x0){_0x415c40=await this[_0x56d9f0(0x207)]['findOne']({'where':{'id':uid}});if(!_0x415c40)throw new common_1['HttpException'](_0x56d9f0(0x1ef),common_1[_0x56d9f0(0x23a)][_0x56d9f0(0x1fd)]);if(!bcrypt[_0x56d9f0(0x25b)](_0x31405a,_0x415c40[_0x56d9f0(0x20b)]))throw new common_1[(_0x56d9f0(0x24e))]('当前密码错误！',common_1[_0x56d9f0(0x23a)][_0x56d9f0(0x1fd)]);}if(_0xb2d3a7&&_0x31405a){const _0x240508=[{'username':_0xb2d3a7},{'email':_0xb2d3a7},{'phone':_0xb2d3a7}];_0x415c40=await this[_0x56d9f0(0x207)][_0x56d9f0(0x1f0)]({'where':_0x240508});if(!_0x415c40)throw new common_1[(_0x56d9f0(0x24e))](_0x56d9f0(0x1ef),common_1[_0x56d9f0(0x23a)][_0x56d9f0(0x1fd)]);if(!bcrypt[_0x56d9f0(0x25b)](_0x31405a,_0x415c40[_0x56d9f0(0x20b)]))throw new common_1['HttpException']('当前密码错误！',common_1[_0x56d9f0(0x23a)][_0x56d9f0(0x1fd)]);}if(!_0x415c40)throw new common_1[(_0x56d9f0(0x24e))]('当前账户不存在！',common_1[_0x56d9f0(0x23a)]['BAD_REQUEST']);if(_0x415c40[_0x56d9f0(0x23b)]!==user_constant_1[_0x56d9f0(0x215)][_0x56d9f0(0x1ce)])throw new common_1[(_0x56d9f0(0x24e))](user_constant_1['UserStatusErrMsg'][_0x415c40[_0x56d9f0(0x23b)]],common_1[_0x56d9f0(0x23a)][_0x56d9f0(0x1fd)]);return _0x415c40;}async[_0x485823(0x1e9)](_0xa0337d,_0xbe4f74){const _0x2bada0=_0x485823,_0x261115=await this['userEntity'][_0x2bada0(0x1f0)]({'where':{'id':_0xa0337d}});return bcrypt[_0x2bada0(0x25b)](_0xbe4f74,_0x261115[_0x2bada0(0x20b)]);}async[_0x485823(0x25e)](_0x163358,_0x3a9c18){const _0x543cf4=_0x485823,_0x1cdf7f=await this[_0x543cf4(0x207)][_0x543cf4(0x1d8)]({'id':_0x163358},{'status':_0x3a9c18});return _0x1cdf7f[_0x543cf4(0x203)]>0x0;}async[_0x485823(0x22b)](_0x1cfa6e){const _0x1c18dd=_0x485823,_0x1add20=await this[_0x1c18dd(0x207)][_0x1c18dd(0x1f0)]({'where':{'id':_0x1cfa6e}});return _0x1add20[_0x1c18dd(0x23b)];}async['queryUserInfoById'](_0xf77055){return await this['userEntity']['findOne']({'where':{'id':_0xf77055}});}async['queryOneUserInfo'](_0x1653f1){const _0x310ff6=_0x485823;return await this['userEntity'][_0x310ff6(0x1f0)]({'where':{'id':_0x1653f1}});}async[_0x485823(0x201)](_0x15482e){const _0x41b4a3=_0x485823,{id:_0x3fcbcc,role:_0xa6fd74}=_0x15482e;if(_0xa6fd74===_0x41b4a3(0x200))return!![];const _0x39da1c=await this['userEntity'][_0x41b4a3(0x1f0)]({'where':{'id':_0x3fcbcc}});if(!_0x39da1c)throw new common_1[(_0x41b4a3(0x24e))](_0x41b4a3(0x1c0),common_1[_0x41b4a3(0x23a)]['UNAUTHORIZED']);if(_0x39da1c[_0x41b4a3(0x23b)]===user_constant_1[_0x41b4a3(0x215)]['BLACKLISTED'])throw new common_1[(_0x41b4a3(0x24e))]('您的账户已被永久加入黑名单、如有疑问、请联系管理员！',common_1[_0x41b4a3(0x23a)][_0x41b4a3(0x1fd)]);if(_0x39da1c[_0x41b4a3(0x23b)]===user_constant_1['UserStatusEnum']['LOCKED'])throw new common_1['HttpException']('您的账户已被封禁、如有疑问、请联系管理员！',common_1[_0x41b4a3(0x23a)][_0x41b4a3(0x1fd)]);}async[_0x485823(0x212)](_0x2b9594){const _0x44c8fb=_0x485823,_0x3dac97=await this[_0x44c8fb(0x207)][_0x44c8fb(0x1f0)]({'where':{'id':_0x2b9594},'select':[_0x44c8fb(0x1f6),_0x44c8fb(0x1cd),_0x44c8fb(0x214),_0x44c8fb(0x24d),_0x44c8fb(0x1d3),_0x44c8fb(0x223),_0x44c8fb(0x1e1)]});if(!_0x3dac97)throw new common_1[(_0x44c8fb(0x24e))](_0x44c8fb(0x1c0),common_1['HttpStatus']['UNAUTHORIZED']);_0x3dac97[_0x44c8fb(0x250)]=!!(_0x3dac97===null||_0x3dac97===void 0x0?void 0x0:_0x3dac97['openId']),delete _0x3dac97['openId'];const _0x1b4fc5=await this[_0x44c8fb(0x1f8)][_0x44c8fb(0x226)](_0x2b9594),_0x28504d=(_0x2b9594*0x7b+0x5f5e100)[_0x44c8fb(0x1fa)](0x24)[_0x44c8fb(0x237)]()[_0x44c8fb(0x1f2)](-0x6);return _0x3dac97['id']=_0x28504d,{'userInfo':_0x3dac97,'userBalance':Object['assign']({},_0x1b4fc5)};}async['getUserById'](_0x17aa05){const _0x348dbf=_0x485823;return await this[_0x348dbf(0x207)]['findOne']({'where':{'id':_0x17aa05}});}async[_0x485823(0x23d)](_0x59b335){const _0x36f913=_0x485823;return await this[_0x36f913(0x207)]['findOne']({'where':{'openId':_0x59b335}});}async[_0x485823(0x202)](_0x1f2ed3,_0x167351){const _0xa7b65e=_0x485823,{id:_0x3ce3a8}=_0x167351['user'],_0xdd2263=await this[_0xa7b65e(0x207)][_0xa7b65e(0x1f0)]({'where':{'id':_0x3ce3a8}});if(!_0xdd2263)throw new common_1[(_0xa7b65e(0x24e))]('当前用户不存在！',common_1[_0xa7b65e(0x23a)][_0xa7b65e(0x1fd)]);if(_0x1f2ed3[_0xa7b65e(0x1f6)]&&_0xdd2263[_0xa7b65e(0x1f6)]===_0x1f2ed3[_0xa7b65e(0x1f6)])throw new common_1[(_0xa7b65e(0x24e))](_0xa7b65e(0x1d4),common_1[_0xa7b65e(0x23a)][_0xa7b65e(0x1fd)]);if(_0x1f2ed3[_0xa7b65e(0x1f6)]){const _0x50c2bb=await this[_0xa7b65e(0x20f)](_0x1f2ed3[_0xa7b65e(0x1f6)],_0x3ce3a8);if(_0x50c2bb)throw new common_1[(_0xa7b65e(0x24e))](_0xa7b65e(0x1da),common_1[_0xa7b65e(0x23a)][_0xa7b65e(0x1fd)]);}const _0x47cbbf=await this['userEntity'][_0xa7b65e(0x1d8)]({'id':_0x3ce3a8},_0x1f2ed3);if(_0x47cbbf[_0xa7b65e(0x203)]<=0x0)throw new common_1[(_0xa7b65e(0x24e))](_0xa7b65e(0x220),common_1['HttpStatus'][_0xa7b65e(0x1fd)]);return _0xa7b65e(0x219);}async[_0x485823(0x20f)](_0x436988,_0x2b2407){const _0x1f6da5=_0x485823,_0x385759={'username':_0x436988};_0x2b2407&&(_0x385759['id']=(0x0,typeorm_2[_0x1f6da5(0x1c1)])(_0x2b2407));const _0x52984e=await this[_0x1f6da5(0x207)]['findOne']({'where':_0x385759});return!!_0x52984e;}async[_0x485823(0x25f)](_0x11aa2b,_0x13e6dc){const _0x2ea711=_0x485823,_0x36dbac=bcrypt[_0x2ea711(0x247)](_0x13e6dc,0xa),_0x2d0c04=await this['userEntity'][_0x2ea711(0x1d8)]({'id':_0x11aa2b},{'password':_0x36dbac});if(_0x2d0c04['affected']<=0x0)throw new common_1[(_0x2ea711(0x24e))]('修改密码失败、请重新试试吧。',common_1['HttpStatus'][_0x2ea711(0x1fd)]);}async['userRecharge'](_0x28ad8a){const _0x421f0a=_0x485823,{userId:_0x267f9d,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x28ad8a;await this['userBalanceService'][_0x421f0a(0x22d)](_0x267f9d,{'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});const _0x259752=await this[_0x421f0a(0x1f8)][_0x421f0a(0x254)]({'userId':_0x267f9d,'rechargeType':balance_constant_1[_0x421f0a(0x1f4)]['ADMIN_GIFT'],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'extent':''});return _0x259752;}async['queryAll'](_0x1b00c4,_0x4f69a5){const _0x1186c1=_0x485823,{page:page=0x1,size:size=0xa,username:_0x1034a6,email:_0x5cfac6,status:_0x2566ab,keyword:_0x44b09c,phone:_0x14cc86}=_0x1b00c4;let _0x28c1b6={};_0x1034a6&&Object[_0x1186c1(0x1d9)](_0x28c1b6,{'username':(0x0,typeorm_2[_0x1186c1(0x1f1)])('%'+_0x1034a6+'%')}),_0x5cfac6&&Object[_0x1186c1(0x1d9)](_0x28c1b6,{'email':(0x0,typeorm_2[_0x1186c1(0x1f1)])('%'+_0x5cfac6+'%')}),_0x14cc86&&Object[_0x1186c1(0x1d9)](_0x28c1b6,{'phone':(0x0,typeorm_2['Like'])('%'+_0x14cc86+'%')}),_0x2566ab&&Object[_0x1186c1(0x1d9)](_0x28c1b6,{'status':_0x2566ab});_0x44b09c&&(_0x28c1b6=[{'username':(0x0,typeorm_2[_0x1186c1(0x1f1)])('%'+_0x44b09c+'%')},{'email':(0x0,typeorm_2[_0x1186c1(0x1f1)])('%'+_0x44b09c+'%')},{'phone':(0x0,typeorm_2[_0x1186c1(0x1f1)])('%'+_0x44b09c+'%')}]);const [_0x45287a,_0x2c516f]=await this['userEntity']['findAndCount']({'skip':(page-0x1)*size,'where':_0x28c1b6,'take':size,'order':{'createdAt':_0x1186c1(0x1c6)},'cache':!![],'select':[_0x1186c1(0x1f6),'avatar',_0x1186c1(0x214),_0x1186c1(0x1d3),_0x1186c1(0x23b),'id',_0x1186c1(0x24d),'createdAt',_0x1186c1(0x1d6),'phone',_0x1186c1(0x249),_0x1186c1(0x264)]}),_0x28479a=_0x45287a[_0x1186c1(0x221)](_0x5ef634=>_0x5ef634['id']),_0x2f37e2=await this[_0x1186c1(0x1f8)][_0x1186c1(0x1fe)](_0x28479a);return _0x45287a['forEach'](_0x329ced=>_0x329ced['balanceInfo']=_0x2f37e2[_0x1186c1(0x23f)](_0x44862f=>_0x44862f[_0x1186c1(0x258)]===_0x329ced['id'])),_0x4f69a5[_0x1186c1(0x24c)][_0x1186c1(0x214)]!==_0x1186c1(0x241)&&_0x45287a[_0x1186c1(0x1f7)](_0x80a8b7=>_0x80a8b7[_0x1186c1(0x24d)]=(0x0,utils_1[_0x1186c1(0x238)])(_0x80a8b7['email'])),_0x4f69a5['user']['role']!==_0x1186c1(0x241)&&_0x45287a[_0x1186c1(0x1f7)](_0x167448=>_0x167448[_0x1186c1(0x1d6)]=(0x0,utils_1[_0x1186c1(0x1cc)])(_0x167448[_0x1186c1(0x1d6)])),_0x4f69a5[_0x1186c1(0x24c)]['role']!==_0x1186c1(0x241)&&_0x45287a[_0x1186c1(0x1f7)](_0x1592fc=>_0x1592fc[_0x1186c1(0x1df)]=(0x0,utils_1[_0x1186c1(0x1cc)])(_0x1592fc[_0x1186c1(0x1df)])),{'rows':_0x45287a,'count':_0x2c516f};}async[_0x485823(0x1dc)]({id:_0xee9941}){const _0x41ad60=_0x485823;return await this[_0x41ad60(0x207)][_0x41ad60(0x1f0)]({'where':{'id':_0xee9941},'select':[_0x41ad60(0x1f6),'avatar',_0x41ad60(0x214),_0x41ad60(0x1d3),'status']});}async[_0x485823(0x1db)](_0x3fb903){const _0x5c0514=_0x485823,{id:_0x1266f1,status:_0x2d408e}=_0x3fb903,_0xb671f0=await this[_0x5c0514(0x207)][_0x5c0514(0x1f0)]({'where':{'id':_0x1266f1}});if(!_0xb671f0)throw new common_1[(_0x5c0514(0x24e))]('用户不存在！',common_1[_0x5c0514(0x23a)][_0x5c0514(0x1fd)]);if(_0xb671f0[_0x5c0514(0x214)]===_0x5c0514(0x241))throw new common_1[(_0x5c0514(0x24e))](_0x5c0514(0x1d1),common_1[_0x5c0514(0x23a)][_0x5c0514(0x1fd)]);if(_0xb671f0['role']==='super')throw new common_1['HttpException'](_0x5c0514(0x1d1),common_1['HttpStatus']['BAD_REQUEST']);const _0x513a67=await this[_0x5c0514(0x207)]['update']({'id':_0x1266f1},{'status':_0x2d408e});if(_0x513a67[_0x5c0514(0x203)]<=0x0)throw new common_1['HttpException'](_0x5c0514(0x204),common_1[_0x5c0514(0x23a)][_0x5c0514(0x1fd)]);return _0x5c0514(0x1ec);}async[_0x485823(0x213)](_0x151d93){const _0x1f1ef7=_0x485823,{id:_0x2b69df}=_0x151d93,_0x306897=await this['userEntity']['findOne']({'where':{'id':_0x2b69df}});if(!_0x306897)throw new common_1[(_0x1f1ef7(0x24e))](_0x1f1ef7(0x1ff),common_1['HttpStatus']['BAD_REQUEST']);const _0x5e3d89=_0x1f1ef7(0x234),_0x14689f=bcrypt['hashSync'](_0x5e3d89,0xa),_0x57be2a=await this['userEntity'][_0x1f1ef7(0x1d8)]({'id':_0x2b69df},{'password':_0x14689f});if(_0x57be2a[_0x1f1ef7(0x203)]<=0x0)throw new common_1[(_0x1f1ef7(0x24e))]('重置密码失败！',common_1[_0x1f1ef7(0x23a)][_0x1f1ef7(0x1fd)]);return _0x1f1ef7(0x1e0)+_0x5e3d89+']成功!';}async[_0x485823(0x1d0)](_0x30842d,_0x4ada09){const _0x5aa773=_0x485823;return await this[_0x5aa773(0x207)][_0x5aa773(0x1d8)]({'id':_0x30842d},{'lastLoginIp':_0x4ada09});}async['getUserFromOpenId'](_0x3f4659,_0x5d3fc6){const _0x2f35ef=_0x485823,_0x548cb9=await this[_0x2f35ef(0x207)][_0x2f35ef(0x1f0)]({'where':{'openId':_0x3f4659}});if(!_0x548cb9){const _0x5e4433=await this[_0x2f35ef(0x20a)](_0x3f4659);return await this['userBalanceService'][_0x2f35ef(0x1dd)](_0x5e4433['id']),_0x5e4433;}return _0x548cb9;}async[_0x485823(0x20a)](_0x1ecbd4){const _0x17e906=_0x485823,_0x8efa18=await this[_0x17e906(0x20e)]['getConfigs']([_0x17e906(0x1d5)]),_0x12f336={'avatar':_0x8efa18,'username':'用户'+(0x0,utils_1[_0x17e906(0x1ee)])(),'status':user_constant_1[_0x17e906(0x215)][_0x17e906(0x1ce)],'sex':0x0,'email':(0x0,utils_1[_0x17e906(0x1ee)])()+_0x17e906(0x21f),'openId':_0x1ecbd4},_0x496ff6=await this[_0x17e906(0x207)][_0x17e906(0x1f5)](_0x12f336);return _0x496ff6;}async['createUserFromContact'](_0x4f2b4c){const _0x4c034e=_0x485823,{username:_0x5f4463,email:_0x32e26b,phone:_0xbfda69}=_0x4f2b4c,_0x52d2be=await this['globalConfigService'][_0x4c034e(0x230)]([_0x4c034e(0x1d5)]),_0x11a06a={'avatar':_0x52d2be,'username':'用户'+(0x0,utils_1[_0x4c034e(0x1ee)])(),'status':user_constant_1[_0x4c034e(0x215)][_0x4c034e(0x1ce)],'sex':0x0};_0x5f4463&&(_0x11a06a[_0x4c034e(0x1f6)]=_0x5f4463);_0x32e26b&&(_0x11a06a[_0x4c034e(0x24d)]=_0x32e26b);_0xbfda69&&(_0x11a06a['phone']=_0xbfda69);const _0x991bad=await this[_0x4c034e(0x207)][_0x4c034e(0x1f5)](_0x11a06a);return _0x991bad;}async[_0x485823(0x209)](_0x3c5da2){const _0x4f2ee1=_0x485823,{username:_0x34ec77,email:_0x39afe2,phone:_0x186a4b}=_0x3c5da2,_0xe4625f=[];return _0x34ec77&&_0xe4625f[_0x4f2ee1(0x229)]({'username':_0x34ec77}),_0x39afe2&&_0xe4625f[_0x4f2ee1(0x229)]({'email':_0x39afe2}),_0x186a4b&&_0xe4625f[_0x4f2ee1(0x229)]({'phone':_0x186a4b}),await this['userEntity'][_0x4f2ee1(0x1f0)]({'where':_0xe4625f});}async[_0x485823(0x224)](_0x447525,_0xa3ba4){const _0x5d702d=_0x485823;try{const _0x46c2c4=await this[_0x5d702d(0x207)][_0x5d702d(0x1f0)]({'where':{'id':_0xa3ba4}});if(!_0x46c2c4)return{'status':![],'msg':_0x5d702d(0x1ea)};const _0x9717bb=await this['userEntity'][_0x5d702d(0x1f0)]({'where':{'openId':_0x447525}});if(_0x9717bb)return{'status':![],'msg':_0x5d702d(0x1cf)};const _0x56c1bf=await this[_0x5d702d(0x207)][_0x5d702d(0x1d8)]({'id':_0xa3ba4},{'openId':_0x447525});if(_0x56c1bf[_0x5d702d(0x203)]<=0x0)return{'status':![],'msg':'绑定微信失败、请联系管理员！'};return{'status':!![],'msg':_0x5d702d(0x262)};}catch(_0x4c7348){return{'status':![],'msg':_0x5d702d(0x20d)};}}async['getOpenIdByUserId'](_0x1ee09a){const _0x507d91=_0x485823,_0x282758=await this[_0x507d91(0x207)][_0x507d91(0x1f0)]({'where':{'id':_0x1ee09a}});return _0x282758===null||_0x282758===void 0x0?void 0x0:_0x282758[_0x507d91(0x223)];}async['verifyUserRegister'](_0x5efdb8){const _0x1f8d4e=_0x485823,{username:_0x26b9d9,phone:_0xf22a60,email:_0x1d742d}=_0x5efdb8;if(_0xf22a60){const _0x513968=await this[_0x1f8d4e(0x207)][_0x1f8d4e(0x1f0)]({'where':{'phone':_0xf22a60}});if(_0x513968)return![];}if(_0x1d742d){const _0x3b5dde=await this['userEntity'][_0x1f8d4e(0x1f0)]({'where':{'email':_0x1d742d}});if(_0x3b5dde)return![];}if(_0x26b9d9){const _0x59b5ef=await this[_0x1f8d4e(0x207)][_0x1f8d4e(0x1f0)]({'where':{'username':_0x26b9d9}});if(_0x59b5ef)return![];}if(!_0xf22a60&&!_0x1d742d&&!_0x26b9d9)return![];return!![];}async[_0x485823(0x1c4)](_0x138ebb){const _0x3467a7=_0x485823,{username:_0x29e285,password:_0x2e93d4,phone:_0x510286,phoneCode:_0x16fdbf}=_0x138ebb,_0x4e1269=await this[_0x3467a7(0x207)][_0x3467a7(0x1f0)]({'where':[{'username':_0x29e285},{'phone':_0x510286}]});if(_0x4e1269&&_0x4e1269[_0x3467a7(0x1f6)]===_0x29e285)throw new common_1['HttpException'](_0x3467a7(0x1c5),common_1[_0x3467a7(0x23a)]['BAD_REQUEST']);if(_0x4e1269&&_0x4e1269[_0x3467a7(0x1df)]===_0x510286)throw new common_1[(_0x3467a7(0x24e))]('当前手机号已注册、请勿重复注册！',common_1['HttpStatus'][_0x3467a7(0x1fd)]);}async['verifyUserRegisterByEmail'](_0x1827ea){const _0x362bc4=_0x485823,{username:_0x4b0c43,email:_0x5b24c7}=_0x1827ea;console['log']('校验邮箱注册:\x20开始\x20-\x20用户名:\x20'+_0x4b0c43+',\x20邮箱:\x20'+_0x5b24c7);const _0x2456e8=await this[_0x362bc4(0x207)]['findOne']({'where':[{'username':_0x4b0c43},{'email':_0x5b24c7}]});if(_0x2456e8&&_0x2456e8[_0x362bc4(0x1f6)]===_0x4b0c43){console[_0x362bc4(0x1e4)](_0x362bc4(0x24b)+_0x4b0c43+_0x362bc4(0x23c));throw new common_1[(_0x362bc4(0x24e))]('用户名已存在、请更换用户名！',common_1[_0x362bc4(0x23a)]['BAD_REQUEST']);}if(_0x2456e8&&_0x2456e8[_0x362bc4(0x24d)]===_0x5b24c7){console[_0x362bc4(0x1e4)](_0x362bc4(0x1c8)+_0x5b24c7+_0x362bc4(0x1e6));throw new common_1[(_0x362bc4(0x24e))](_0x362bc4(0x208),common_1[_0x362bc4(0x23a)]['BAD_REQUEST']);}console['log'](_0x362bc4(0x25c)+_0x4b0c43+',\x20邮箱:\x20'+_0x5b24c7+_0x362bc4(0x245));}async[_0x485823(0x222)](_0x1eba89){const _0x28e24b=_0x485823;return await this[_0x28e24b(0x207)]['save'](_0x1eba89);}async['saveRealNameInfo'](_0x5b99f8,_0x33fa15,_0x33eb72){const _0x2249e9=_0x485823,_0x415df9=await this['userEntity'][_0x2249e9(0x1f0)]({'where':{'id':_0x5b99f8}});!_0x415df9&&common_1['Logger'][_0x2249e9(0x1e4)]('用户不存在');await this[_0x2249e9(0x207)][_0x2249e9(0x1d8)]({'id':_0x5b99f8},{'realName':_0x33fa15,'idCard':_0x33eb72});return;}async[_0x485823(0x1d7)](_0x46bda1,_0x1a4157,_0x1ba713,_0x4875e6){const _0x36c22d=_0x485823,_0x415222=await this[_0x36c22d(0x207)]['findOne']({'where':{'id':_0x46bda1}}),_0x491182=bcrypt[_0x36c22d(0x247)](_0x4875e6,0xa);!_0x415222&&common_1['Logger'][_0x36c22d(0x1e4)](_0x36c22d(0x228));if(!_0x1a4157||!_0x1ba713||!_0x491182)throw new common_1[(_0x36c22d(0x24e))]('参数错误！',common_1[_0x36c22d(0x23a)][_0x36c22d(0x1fd)]);await this['userEntity'][_0x36c22d(0x1d8)]({'id':_0x46bda1},{'phone':_0x1a4157,'username':_0x1ba713,'password':_0x491182});return;}};UserService=__decorate([(0x0,common_1[_0x485823(0x206)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(user_entity_1['UserEntity'])),__param(0x6,(0x0,typeorm_1[_0x485823(0x225)])(config_entity_1[_0x485823(0x227)])),__metadata('design:paramtypes',[typeorm_2[_0x485823(0x253)],typeorm_2['Connection'],verification_service_1[_0x485823(0x211)],mailer_service_1[_0x485823(0x239)],userBalance_service_1[_0x485823(0x252)],globalConfig_service_1[_0x485823(0x1c7)],typeorm_2[_0x485823(0x253)]])],UserService),exports[_0x485823(0x21c)]=UserService;