'use strict';const _0x2eb740=_0x1af4;function _0x1af4(_0x166e78,_0x292807){const _0x591837=_0x5918();return _0x1af4=function(_0x1af425,_0x274012){_0x1af425=_0x1af425-0x1a8;let _0x42cc74=_0x591837[_0x1af425];return _0x42cc74;},_0x1af4(_0x166e78,_0x292807);}(function(_0x39340d,_0x379653){const _0x3419ce=_0x1af4,_0x4db975=_0x39340d();while(!![]){try{const _0x3cf2c3=parseInt(_0x3419ce(0x210))/0x1*(parseInt(_0x3419ce(0x20f))/0x2)+-parseInt(_0x3419ce(0x253))/0x3+-parseInt(_0x3419ce(0x22c))/0x4+-parseInt(_0x3419ce(0x1cf))/0x5+-parseInt(_0x3419ce(0x22e))/0x6+parseInt(_0x3419ce(0x20e))/0x7*(-parseInt(_0x3419ce(0x23e))/0x8)+parseInt(_0x3419ce(0x219))/0x9*(parseInt(_0x3419ce(0x24b))/0xa);if(_0x3cf2c3===_0x379653)break;else _0x4db975['push'](_0x4db975['shift']());}catch(_0x42aa95){_0x4db975['push'](_0x4db975['shift']());}}}(_0x5918,0x1fe52));var __decorate=this&&this[_0x2eb740(0x1d3)]||function(_0x316981,_0x3ec977,_0x573c1a,_0x5bf49d){const _0x264f91=_0x2eb740;var _0x38d260=arguments[_0x264f91(0x1cb)],_0x535413=_0x38d260<0x3?_0x3ec977:_0x5bf49d===null?_0x5bf49d=Object[_0x264f91(0x1f3)](_0x3ec977,_0x573c1a):_0x5bf49d,_0x249a54;if(typeof Reflect===_0x264f91(0x1c4)&&typeof Reflect[_0x264f91(0x20a)]==='function')_0x535413=Reflect[_0x264f91(0x20a)](_0x316981,_0x3ec977,_0x573c1a,_0x5bf49d);else{for(var _0x413835=_0x316981['length']-0x1;_0x413835>=0x0;_0x413835--)if(_0x249a54=_0x316981[_0x413835])_0x535413=(_0x38d260<0x3?_0x249a54(_0x535413):_0x38d260>0x3?_0x249a54(_0x3ec977,_0x573c1a,_0x535413):_0x249a54(_0x3ec977,_0x573c1a))||_0x535413;}return _0x38d260>0x3&&_0x535413&&Object['defineProperty'](_0x3ec977,_0x573c1a,_0x535413),_0x535413;},__metadata=this&&this[_0x2eb740(0x252)]||function(_0x3e4d7f,_0x2de1cf){const _0x1e257b=_0x2eb740;if(typeof Reflect==='object'&&typeof Reflect[_0x1e257b(0x254)]==='function')return Reflect[_0x1e257b(0x254)](_0x3e4d7f,_0x2de1cf);},__param=this&&this[_0x2eb740(0x200)]||function(_0x1acfff,_0x5761fe){return function(_0x52b1be,_0x3917fb){_0x5761fe(_0x52b1be,_0x3917fb,_0x1acfff);};};Object['defineProperty'](exports,_0x2eb740(0x230),{'value':!![]}),exports[_0x2eb740(0x1f7)]=void 0x0;function _0x5918(){const _0x2db27f=['lastLoginIp','LOCKED','250910yNifuN','123456','status','createUserAndVerifycation','__decorate','avatar','没有变更，无需更改！','updateUserStatus','username','当前用户信息失效、请重新登录！','error:\x20','email','addBalanceToUser','userRecharge','verifyUserRegister','error','verificationService','configEntity','@nestjs/typeorm','saveRealNameInfo','queryOneUserInfo','bcryptjs','用户不存在！','VerificationService','@nestjs/common','\x20未被占用','createUserFromContact','getUserOpenId','\x22\x20已存在','VerificationEnum','RechargeType','getSuper','HttpStatus','consecutiveDays','重置密码失败！','userEntity','getOwnPropertyDescriptor','修改密码失败、请重新试试吧。','getConfigs',']成功!','UserService','assign','isUsernameTaken','update','visitor','UserEntity','updateStatus','修改用户状态成功！','forEach','__param','createdAt','configMap:\x20','configVal','findOne','configKey','MailerService','修改用户状态失败！','用户名已存在！','checkUserStatus','decorate','updateUserPassword','Not','ACTIVE','3087iflPFY','356lZhqqD','664SPnQVp','queryAll','userBalanceService','HttpException','userId','typeorm','BAD_REQUEST','bindWx','addBalanceToNewUser','6019830CVxfsM','maskEmail','getUserStatus','affected','verifyUserRegisterByPhone','密码重置为[','sign','当前密码错误！','InjectRepository','password','./../verification/verification.service','createUserFromOpenId','savaLoginIp','role','校验邮箱注册:\x20成功\x20-\x20用户名:\x20','getClientIp','当前绑定用户不存在！','registerVerifyEmailFrom','Like','297228LBQIQC','registerBaseUrl','645036ytuOyz','修改用户信息成功！','__esModule','log','balanceInfo','user',',\x20邮箱:\x20','PENDING','maskIpAddress','UserStatusErrMsg','createRandomUid','该微信已绑定其他账号！','toString','@default.com','design:paramtypes','updateUserPhone','3208IOrncT','校验失败:\x20用户名\x20\x22','globalConfigService','isVerifyEmail','BLACKLISTED','reduce','queryOne','../globalConfig/config.entity','当前账户不存在！','super','./user.entity','getUserByContact','Injectable','10TroxGh','当前用户不存在！','push','Repository','Logger','resetUserPass','map','__metadata','742752aszEYR','metadata','ADMIN_GIFT','UserStatusEnum','save','userDefautlAvatar','idCard','openId','../../common/utils','超级管理员不可被操作！','UNAUTHORIZED','toUpperCase','校验邮箱注册:\x20开始\x20-\x20用户名:\x20','getOpenIdByUserId','compareSync','mailerService','queryUserInfoById','getUserFromOpenId','lodash','当前邮箱已注册、请勿重复注册！','hashSync','\x22\x20已被注册','phone','find','修改用户信息失败！','registerVerifyEmailDesc','./../../common/constants/user.constant','queryUserBalanceByIds','../mailer/mailer.service','当前手机号已注册、请勿重复注册！','saveRecordRechargeLog','object','Registration','../userBalance/userBalance.service','registerVerifyExpir','用户名已存在、请更换用户名！','slice','绑定微信失败、请联系管理员！','length','用户不存在'];_0x5918=function(){return _0x2db27f;};return _0x5918();}const balance_constant_1=require('../../common/constants/balance.constant'),verification_constant_1=require('../../common/constants/verification.constant'),utils_1=require(_0x2eb740(0x1ad)),mailer_service_1=require(_0x2eb740(0x1c1)),common_1=require(_0x2eb740(0x1e7)),typeorm_1=require(_0x2eb740(0x1e1)),bcrypt=require(_0x2eb740(0x1e4)),_=require(_0x2eb740(0x1b7)),typeorm_2=require(_0x2eb740(0x215)),config_entity_1=require(_0x2eb740(0x245)),userBalance_service_1=require(_0x2eb740(0x1c6)),user_constant_1=require(_0x2eb740(0x1bf)),globalConfig_service_1=require('./../globalConfig/globalConfig.service'),verification_service_1=require(_0x2eb740(0x223)),user_entity_1=require(_0x2eb740(0x248));let UserService=class UserService{constructor(_0x2f9beb,_0x3019a1,_0x327eb4,_0x2167bd,_0x424ae1,_0x3ffcba,_0x3f283a){const _0x393553=_0x2eb740;this[_0x393553(0x1f2)]=_0x2f9beb,this['connection']=_0x3019a1,this['verificationService']=_0x327eb4,this[_0x393553(0x1b4)]=_0x2167bd,this[_0x393553(0x212)]=_0x424ae1,this[_0x393553(0x240)]=_0x3ffcba,this['configEntity']=_0x3f283a;}async[_0x2eb740(0x1d2)](_0x69cad3,_0x210fbf){const _0x4f84a8=_0x2eb740,{username:_0x576e91,email:_0x4dd32d,password:_0x3fd65e,client:client=0x0}=_0x69cad3,_0x4e6638=[{'username':_0x576e91},{'email':_0x4dd32d}],_0x21ecb3=await this[_0x4f84a8(0x1f2)][_0x4f84a8(0x204)]({'where':_0x4e6638});if(_0x21ecb3&&_0x21ecb3[_0x4f84a8(0x1d1)]!==user_constant_1['UserStatusEnum'][_0x4f84a8(0x235)])throw new common_1[(_0x4f84a8(0x213))]('用户名或者邮箱已被注册！',common_1[_0x4f84a8(0x1ef)][_0x4f84a8(0x216)]);try{const _0x378af7=_['cloneDeep'](_0x69cad3),_0x285703=bcrypt[_0x4f84a8(0x1b9)](_0x3fd65e,0xa),_0x1475e8=(0x0,utils_1[_0x4f84a8(0x228)])(_0x210fbf);_0x378af7[_0x4f84a8(0x222)]=_0x285703,_0x378af7['registerIp']=_0x1475e8,_0x378af7['client']=client;let _0x35900f;if(!_0x21ecb3){const _0x3909ac=await this[_0x4f84a8(0x240)][_0x4f84a8(0x1f5)]([_0x4f84a8(0x1aa)]);_0x378af7[_0x4f84a8(0x1d4)]=_0x3909ac,_0x35900f=await this[_0x4f84a8(0x1f2)]['save'](_0x378af7);}else _0x35900f=_0x21ecb3;const _0x421810=await this[_0x4f84a8(0x1e0)][_0x4f84a8(0x1bc)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x4f84a8(0x241),_0x4f84a8(0x22d),'registerVerifyEmailTitle',_0x4f84a8(0x1be),_0x4f84a8(0x22a),_0x4f84a8(0x1c7)])}}),_0x226f6e=_0x421810[_0x4f84a8(0x243)]((_0x14b7c6,_0x59c77c)=>{const _0x322130=_0x4f84a8;return _0x14b7c6[_0x59c77c[_0x322130(0x205)]]=_0x59c77c[_0x322130(0x203)],_0x14b7c6;},{}),_0x90ec1a=_0x226f6e['isVerifyEmail']?Number(_0x226f6e[_0x4f84a8(0x241)]):0x1;if(_0x90ec1a){const _0x16e643=_0x226f6e[_0x4f84a8(0x1c7)]?Number(_0x226f6e[_0x4f84a8(0x1c7)]):0x1e*0x3c,_0x4aea0f=await this[_0x4f84a8(0x1df)]['createVerification'](_0x35900f,verification_constant_1[_0x4f84a8(0x1ec)][_0x4f84a8(0x1c5)],_0x16e643),{code:_0xbb303,email:_0x614eb6,id:_0xde0a9e}=_0x4aea0f,{registerVerifyEmailFrom:_0x4daf14}=_0x226f6e;console[_0x4f84a8(0x231)](_0x4f84a8(0x202),_0x226f6e),console[_0x4f84a8(0x231)]('尝试发送邮件到:\x20'+_0x614eb6);}else{const {id:_0x27346d}=_0x35900f;await this[_0x4f84a8(0x1d6)](_0x27346d,user_constant_1[_0x4f84a8(0x1a8)][_0x4f84a8(0x20d)]),await this[_0x4f84a8(0x212)][_0x4f84a8(0x218)](_0x27346d);}return _0x35900f;}catch(_0x3c7be9){console['log'](_0x4f84a8(0x1d9),_0x3c7be9);throw _0x3c7be9;}}async[_0x2eb740(0x1ee)](){const _0x4a75ff=_0x2eb740,_0x32f4d5=await this[_0x4a75ff(0x1f2)][_0x4a75ff(0x204)]({'where':{'role':_0x4a75ff(0x247)}});return _0x32f4d5;}async['verifyUserCredentials'](_0x8cb40f){const _0x15c7e5=_0x2eb740,{username:_0x4f61cf,password:_0x1d6d4e,uid:uid=0x0,phone:_0x53ed23}=_0x8cb40f;let _0x168ce1=null;if(uid>0x0){_0x168ce1=await this[_0x15c7e5(0x1f2)]['findOne']({'where':{'id':uid}});if(!_0x168ce1)throw new common_1[(_0x15c7e5(0x213))]('当前账户不存在！',common_1[_0x15c7e5(0x1ef)][_0x15c7e5(0x216)]);if(!bcrypt[_0x15c7e5(0x1b3)](_0x1d6d4e,_0x168ce1[_0x15c7e5(0x222)]))throw new common_1[(_0x15c7e5(0x213))](_0x15c7e5(0x220),common_1['HttpStatus'][_0x15c7e5(0x216)]);}if(_0x4f61cf&&_0x1d6d4e){const _0x88d43f=[{'username':_0x4f61cf},{'email':_0x4f61cf},{'phone':_0x4f61cf}];_0x168ce1=await this[_0x15c7e5(0x1f2)]['findOne']({'where':_0x88d43f});if(!_0x168ce1)throw new common_1[(_0x15c7e5(0x213))](_0x15c7e5(0x246),common_1['HttpStatus'][_0x15c7e5(0x216)]);if(!bcrypt[_0x15c7e5(0x1b3)](_0x1d6d4e,_0x168ce1[_0x15c7e5(0x222)]))throw new common_1[(_0x15c7e5(0x213))](_0x15c7e5(0x220),common_1[_0x15c7e5(0x1ef)][_0x15c7e5(0x216)]);}if(!_0x168ce1)throw new common_1[(_0x15c7e5(0x213))](_0x15c7e5(0x246),common_1[_0x15c7e5(0x1ef)]['BAD_REQUEST']);if(_0x168ce1[_0x15c7e5(0x1d1)]!==user_constant_1[_0x15c7e5(0x1a8)][_0x15c7e5(0x20d)])throw new common_1['HttpException'](user_constant_1[_0x15c7e5(0x237)][_0x168ce1['status']],common_1[_0x15c7e5(0x1ef)][_0x15c7e5(0x216)]);return _0x168ce1;}async['verifyUserPassword'](_0x52a94b,_0x2ac802){const _0xeda5d=_0x2eb740,_0x3524d0=await this[_0xeda5d(0x1f2)][_0xeda5d(0x204)]({'where':{'id':_0x52a94b}});return bcrypt[_0xeda5d(0x1b3)](_0x2ac802,_0x3524d0['password']);}async[_0x2eb740(0x1d6)](_0xd27819,_0x52f43f){const _0x2d8fc2=_0x2eb740,_0x52fc3c=await this[_0x2d8fc2(0x1f2)][_0x2d8fc2(0x1fa)]({'id':_0xd27819},{'status':_0x52f43f});return _0x52fc3c[_0x2d8fc2(0x21c)]>0x0;}async[_0x2eb740(0x21b)](_0x512542){const _0x1e9149=_0x2eb740,_0x576c4a=await this[_0x1e9149(0x1f2)][_0x1e9149(0x204)]({'where':{'id':_0x512542}});return _0x576c4a['status'];}async[_0x2eb740(0x1b5)](_0x5ce59f){const _0x57be7e=_0x2eb740;return await this[_0x57be7e(0x1f2)][_0x57be7e(0x204)]({'where':{'id':_0x5ce59f}});}async[_0x2eb740(0x1e3)](_0x335a54){const _0xc98a29=_0x2eb740;return await this[_0xc98a29(0x1f2)][_0xc98a29(0x204)]({'where':{'id':_0x335a54}});}async[_0x2eb740(0x209)](_0x52e2d0){const _0x1ec54d=_0x2eb740,{id:_0x342107,role:_0x1f6c59}=_0x52e2d0;if(_0x1f6c59===_0x1ec54d(0x1fb))return!![];const _0x200476=await this[_0x1ec54d(0x1f2)]['findOne']({'where':{'id':_0x342107}});if(!_0x200476)throw new common_1[(_0x1ec54d(0x213))](_0x1ec54d(0x1d8),common_1['HttpStatus'][_0x1ec54d(0x1af)]);if(_0x200476[_0x1ec54d(0x1d1)]===user_constant_1[_0x1ec54d(0x1a8)][_0x1ec54d(0x242)])throw new common_1[(_0x1ec54d(0x213))]('您的账户已被永久加入黑名单、如有疑问、请联系管理员！',common_1[_0x1ec54d(0x1ef)][_0x1ec54d(0x216)]);if(_0x200476[_0x1ec54d(0x1d1)]===user_constant_1['UserStatusEnum'][_0x1ec54d(0x1ce)])throw new common_1['HttpException']('您的账户已被封禁、如有疑问、请联系管理员！',common_1['HttpStatus'][_0x1ec54d(0x216)]);}async['getUserInfo'](_0x4c9848){const _0x3280a0=_0x2eb740,_0x37a5cb=await this['userEntity']['findOne']({'where':{'id':_0x4c9848},'select':[_0x3280a0(0x1d7),'avatar','role',_0x3280a0(0x1da),_0x3280a0(0x21f),_0x3280a0(0x1ac),_0x3280a0(0x1f0)]});if(!_0x37a5cb)throw new common_1['HttpException'](_0x3280a0(0x1d8),common_1[_0x3280a0(0x1ef)][_0x3280a0(0x1af)]);_0x37a5cb['isBindWx']=!!(_0x37a5cb===null||_0x37a5cb===void 0x0?void 0x0:_0x37a5cb[_0x3280a0(0x1ac)]),delete _0x37a5cb[_0x3280a0(0x1ac)];const _0x2a0293=await this[_0x3280a0(0x212)]['queryUserBalance'](_0x4c9848),_0x4a7f2b=(_0x4c9848*0x7b+0x5f5e100)[_0x3280a0(0x23a)](0x24)[_0x3280a0(0x1b0)]()[_0x3280a0(0x1c9)](-0x6);return _0x37a5cb['id']=_0x4a7f2b,{'userInfo':_0x37a5cb,'userBalance':Object[_0x3280a0(0x1f8)]({},_0x2a0293)};}async['getUserById'](_0x41e5f8){const _0x34e726=_0x2eb740;return await this['userEntity'][_0x34e726(0x204)]({'where':{'id':_0x41e5f8}});}async[_0x2eb740(0x1ea)](_0x966395){const _0x5ec205=_0x2eb740;return await this['userEntity'][_0x5ec205(0x204)]({'where':{'openId':_0x966395}});}async['updateInfo'](_0x8e0893,_0x203b30){const _0x3108af=_0x2eb740,{id:_0x1095ee}=_0x203b30[_0x3108af(0x233)],_0x1c6aad=await this[_0x3108af(0x1f2)][_0x3108af(0x204)]({'where':{'id':_0x1095ee}});if(!_0x1c6aad)throw new common_1[(_0x3108af(0x213))](_0x3108af(0x24c),common_1[_0x3108af(0x1ef)][_0x3108af(0x216)]);if(_0x8e0893[_0x3108af(0x1d7)]&&_0x1c6aad['username']===_0x8e0893[_0x3108af(0x1d7)])throw new common_1[(_0x3108af(0x213))](_0x3108af(0x1d5),common_1[_0x3108af(0x1ef)][_0x3108af(0x216)]);if(_0x8e0893['username']){const _0x4757c2=await this[_0x3108af(0x1f9)](_0x8e0893[_0x3108af(0x1d7)],_0x1095ee);if(_0x4757c2)throw new common_1[(_0x3108af(0x213))](_0x3108af(0x208),common_1[_0x3108af(0x1ef)][_0x3108af(0x216)]);}const _0x249ec8=await this[_0x3108af(0x1f2)]['update']({'id':_0x1095ee},_0x8e0893);if(_0x249ec8[_0x3108af(0x21c)]<=0x0)throw new common_1[(_0x3108af(0x213))](_0x3108af(0x1bd),common_1['HttpStatus'][_0x3108af(0x216)]);return _0x3108af(0x22f);}async[_0x2eb740(0x1f9)](_0x1e24d4,_0x642dd){const _0x350f4d=_0x2eb740,_0xf8743={'username':_0x1e24d4};_0x642dd&&(_0xf8743['id']=(0x0,typeorm_2[_0x350f4d(0x20c)])(_0x642dd));const _0x6ff756=await this['userEntity'][_0x350f4d(0x204)]({'where':_0xf8743});return!!_0x6ff756;}async[_0x2eb740(0x20b)](_0xb9ae0b,_0x3ca3b9){const _0x253e10=_0x2eb740,_0x33bd8c=bcrypt['hashSync'](_0x3ca3b9,0xa),_0x30f68e=await this[_0x253e10(0x1f2)][_0x253e10(0x1fa)]({'id':_0xb9ae0b},{'password':_0x33bd8c});if(_0x30f68e[_0x253e10(0x21c)]<=0x0)throw new common_1[(_0x253e10(0x213))](_0x253e10(0x1f4),common_1['HttpStatus'][_0x253e10(0x216)]);}async[_0x2eb740(0x1dc)](_0x40e6c7){const _0x267b75=_0x2eb740,{userId:_0x2743f8,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x40e6c7;await this[_0x267b75(0x212)][_0x267b75(0x1db)](_0x2743f8,{'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});const _0x4582d6=await this[_0x267b75(0x212)][_0x267b75(0x1c3)]({'userId':_0x2743f8,'rechargeType':balance_constant_1[_0x267b75(0x1ed)][_0x267b75(0x255)],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'extent':''});return _0x4582d6;}async[_0x2eb740(0x211)](_0x2ac0e3,_0x3c1e0c){const _0x4eb668=_0x2eb740,{page:page=0x1,size:size=0xa,username:_0x2257e0,email:_0x161ddc,status:_0x43fa03,keyword:_0x496757,phone:_0x34087f}=_0x2ac0e3;let _0x417998={};_0x2257e0&&Object[_0x4eb668(0x1f8)](_0x417998,{'username':(0x0,typeorm_2[_0x4eb668(0x22b)])('%'+_0x2257e0+'%')}),_0x161ddc&&Object[_0x4eb668(0x1f8)](_0x417998,{'email':(0x0,typeorm_2['Like'])('%'+_0x161ddc+'%')}),_0x34087f&&Object[_0x4eb668(0x1f8)](_0x417998,{'phone':(0x0,typeorm_2[_0x4eb668(0x22b)])('%'+_0x34087f+'%')}),_0x43fa03&&Object['assign'](_0x417998,{'status':_0x43fa03});_0x496757&&(_0x417998=[{'username':(0x0,typeorm_2[_0x4eb668(0x22b)])('%'+_0x496757+'%')},{'email':(0x0,typeorm_2[_0x4eb668(0x22b)])('%'+_0x496757+'%')},{'phone':(0x0,typeorm_2['Like'])('%'+_0x496757+'%')}]);const [_0x2778b8,_0x4304e3]=await this[_0x4eb668(0x1f2)]['findAndCount']({'skip':(page-0x1)*size,'where':_0x417998,'take':size,'order':{'createdAt':'DESC'},'cache':!![],'select':[_0x4eb668(0x1d7),_0x4eb668(0x1d4),'role',_0x4eb668(0x21f),_0x4eb668(0x1d1),'id','email',_0x4eb668(0x201),_0x4eb668(0x1cd),_0x4eb668(0x1bb),'realName',_0x4eb668(0x1ab)]}),_0x489a5b=_0x2778b8[_0x4eb668(0x251)](_0x25d3e9=>_0x25d3e9['id']),_0x13dad9=await this[_0x4eb668(0x212)][_0x4eb668(0x1c0)](_0x489a5b);return _0x2778b8[_0x4eb668(0x1ff)](_0x158841=>_0x158841[_0x4eb668(0x232)]=_0x13dad9['find'](_0x130fcd=>_0x130fcd[_0x4eb668(0x214)]===_0x158841['id'])),_0x3c1e0c['user']['role']!==_0x4eb668(0x247)&&_0x2778b8['forEach'](_0x5c9a81=>_0x5c9a81['email']=(0x0,utils_1[_0x4eb668(0x21a)])(_0x5c9a81[_0x4eb668(0x1da)])),_0x3c1e0c['user'][_0x4eb668(0x226)]!==_0x4eb668(0x247)&&_0x2778b8[_0x4eb668(0x1ff)](_0x30ff54=>_0x30ff54['lastLoginIp']=(0x0,utils_1[_0x4eb668(0x236)])(_0x30ff54[_0x4eb668(0x1cd)])),_0x3c1e0c[_0x4eb668(0x233)][_0x4eb668(0x226)]!==_0x4eb668(0x247)&&_0x2778b8[_0x4eb668(0x1ff)](_0x47b556=>_0x47b556['phone']=(0x0,utils_1['maskIpAddress'])(_0x47b556[_0x4eb668(0x1bb)])),{'rows':_0x2778b8,'count':_0x4304e3};}async[_0x2eb740(0x244)]({id:_0xf45430}){const _0x37bc2c=_0x2eb740;return await this[_0x37bc2c(0x1f2)]['findOne']({'where':{'id':_0xf45430},'select':[_0x37bc2c(0x1d7),_0x37bc2c(0x1d4),'role',_0x37bc2c(0x21f),_0x37bc2c(0x1d1)]});}async[_0x2eb740(0x1fd)](_0x57aa2f){const _0x5a869d=_0x2eb740,{id:_0x143122,status:_0x456147}=_0x57aa2f,_0x4b5170=await this[_0x5a869d(0x1f2)]['findOne']({'where':{'id':_0x143122}});if(!_0x4b5170)throw new common_1[(_0x5a869d(0x213))](_0x5a869d(0x1e5),common_1['HttpStatus'][_0x5a869d(0x216)]);if(_0x4b5170[_0x5a869d(0x226)]==='super')throw new common_1[(_0x5a869d(0x213))](_0x5a869d(0x1ae),common_1[_0x5a869d(0x1ef)]['BAD_REQUEST']);if(_0x4b5170['role']===_0x5a869d(0x247))throw new common_1[(_0x5a869d(0x213))](_0x5a869d(0x1ae),common_1[_0x5a869d(0x1ef)]['BAD_REQUEST']);const _0x3f91a1=await this[_0x5a869d(0x1f2)][_0x5a869d(0x1fa)]({'id':_0x143122},{'status':_0x456147});if(_0x3f91a1[_0x5a869d(0x21c)]<=0x0)throw new common_1[(_0x5a869d(0x213))](_0x5a869d(0x207),common_1['HttpStatus'][_0x5a869d(0x216)]);return _0x5a869d(0x1fe);}async[_0x2eb740(0x250)](_0x57f7ac){const _0x3ae1a2=_0x2eb740,{id:_0x5bd21f}=_0x57f7ac,_0x53e82a=await this[_0x3ae1a2(0x1f2)][_0x3ae1a2(0x204)]({'where':{'id':_0x5bd21f}});if(!_0x53e82a)throw new common_1[(_0x3ae1a2(0x213))](_0x3ae1a2(0x1e5),common_1['HttpStatus']['BAD_REQUEST']);const _0x100af1=_0x3ae1a2(0x1d0),_0x9fd76a=bcrypt[_0x3ae1a2(0x1b9)](_0x100af1,0xa),_0x3ce3dd=await this[_0x3ae1a2(0x1f2)][_0x3ae1a2(0x1fa)]({'id':_0x5bd21f},{'password':_0x9fd76a});if(_0x3ce3dd[_0x3ae1a2(0x21c)]<=0x0)throw new common_1[(_0x3ae1a2(0x213))](_0x3ae1a2(0x1f1),common_1[_0x3ae1a2(0x1ef)][_0x3ae1a2(0x216)]);return _0x3ae1a2(0x21e)+_0x100af1+_0x3ae1a2(0x1f6);}async[_0x2eb740(0x225)](_0x194028,_0x5d7aec){const _0x4d23dd=_0x2eb740;return await this[_0x4d23dd(0x1f2)][_0x4d23dd(0x1fa)]({'id':_0x194028},{'lastLoginIp':_0x5d7aec});}async[_0x2eb740(0x1b6)](_0x427dc4,_0x4c7e16){const _0x227566=_0x2eb740,_0x1353fa=await this[_0x227566(0x1f2)][_0x227566(0x204)]({'where':{'openId':_0x427dc4}});if(!_0x1353fa){const _0x86c2a6=await this['createUserFromOpenId'](_0x427dc4);return await this['userBalanceService'][_0x227566(0x218)](_0x86c2a6['id']),_0x86c2a6;}return _0x1353fa;}async[_0x2eb740(0x224)](_0x3a9d28){const _0x56795e=_0x2eb740,_0x35aeda=await this['globalConfigService'][_0x56795e(0x1f5)]([_0x56795e(0x1aa)]),_0x361aea={'avatar':_0x35aeda,'username':'用户'+(0x0,utils_1['createRandomUid'])(),'status':user_constant_1['UserStatusEnum']['ACTIVE'],'sex':0x0,'email':(0x0,utils_1[_0x56795e(0x238)])()+_0x56795e(0x23b),'openId':_0x3a9d28},_0x2e4961=await this['userEntity'][_0x56795e(0x1a9)](_0x361aea);return _0x2e4961;}async[_0x2eb740(0x1e9)](_0x2da7f1){const _0xa338b8=_0x2eb740,{username:_0x1dfa68,email:_0x323f3a,phone:_0x4b9062}=_0x2da7f1,_0x12582c=await this['globalConfigService'][_0xa338b8(0x1f5)]([_0xa338b8(0x1aa)]),_0x508699={'avatar':_0x12582c,'username':'用户'+(0x0,utils_1['createRandomUid'])(),'status':user_constant_1[_0xa338b8(0x1a8)][_0xa338b8(0x20d)],'sex':0x0};_0x1dfa68&&(_0x508699[_0xa338b8(0x1d7)]=_0x1dfa68);_0x323f3a&&(_0x508699[_0xa338b8(0x1da)]=_0x323f3a);_0x4b9062&&(_0x508699[_0xa338b8(0x1bb)]=_0x4b9062);const _0x5d4e57=await this[_0xa338b8(0x1f2)][_0xa338b8(0x1a9)](_0x508699);return _0x5d4e57;}async[_0x2eb740(0x249)](_0x57e089){const _0x24e7bd=_0x2eb740,{username:_0x526f16,email:_0x189b04,phone:_0x518315}=_0x57e089,_0x39fca1=[];return _0x526f16&&_0x39fca1[_0x24e7bd(0x24d)]({'username':_0x526f16}),_0x189b04&&_0x39fca1[_0x24e7bd(0x24d)]({'email':_0x189b04}),_0x518315&&_0x39fca1[_0x24e7bd(0x24d)]({'phone':_0x518315}),await this[_0x24e7bd(0x1f2)][_0x24e7bd(0x204)]({'where':_0x39fca1});}async[_0x2eb740(0x217)](_0x520dc0,_0x56e8a9){const _0x531d39=_0x2eb740;try{const _0x50a30c=await this[_0x531d39(0x1f2)][_0x531d39(0x204)]({'where':{'id':_0x56e8a9}});if(!_0x50a30c)return{'status':![],'msg':_0x531d39(0x229)};const _0x4279c8=await this['userEntity'][_0x531d39(0x204)]({'where':{'openId':_0x520dc0}});if(_0x4279c8)return{'status':![],'msg':_0x531d39(0x239)};const _0x1b6e0b=await this['userEntity'][_0x531d39(0x1fa)]({'id':_0x56e8a9},{'openId':_0x520dc0});if(_0x1b6e0b['affected']<=0x0)return{'status':![],'msg':'绑定微信失败、请联系管理员！'};return{'status':!![],'msg':'恭喜您绑定成功、后续可直接扫码登录了！'};}catch(_0x11d63a){return{'status':![],'msg':_0x531d39(0x1ca)};}}async[_0x2eb740(0x1b2)](_0x475f60){const _0xabbd7c=_0x2eb740,_0x4dffd6=await this[_0xabbd7c(0x1f2)][_0xabbd7c(0x204)]({'where':{'id':_0x475f60}});return _0x4dffd6===null||_0x4dffd6===void 0x0?void 0x0:_0x4dffd6[_0xabbd7c(0x1ac)];}async[_0x2eb740(0x1dd)](_0x2b9099){const _0x56a1f6=_0x2eb740,{username:_0x232b64,phone:_0x2052cb,email:_0x23e16a}=_0x2b9099;if(_0x2052cb){const _0xbde29f=await this[_0x56a1f6(0x1f2)][_0x56a1f6(0x204)]({'where':{'phone':_0x2052cb}});if(_0xbde29f)return![];}if(_0x23e16a){const _0x50580e=await this[_0x56a1f6(0x1f2)][_0x56a1f6(0x204)]({'where':{'email':_0x23e16a}});if(_0x50580e)return![];}if(_0x232b64){const _0xa29ebf=await this[_0x56a1f6(0x1f2)][_0x56a1f6(0x204)]({'where':{'username':_0x232b64}});if(_0xa29ebf)return![];}if(!_0x2052cb&&!_0x23e16a&&!_0x232b64)return![];return!![];}async[_0x2eb740(0x21d)](_0x2a2935){const _0x17677e=_0x2eb740,{username:_0x3b7237,password:_0x2dbd66,phone:_0x30c258,phoneCode:_0x4b2839}=_0x2a2935,_0x177f71=await this[_0x17677e(0x1f2)][_0x17677e(0x204)]({'where':[{'username':_0x3b7237},{'phone':_0x30c258}]});if(_0x177f71&&_0x177f71['username']===_0x3b7237)throw new common_1[(_0x17677e(0x213))](_0x17677e(0x1c8),common_1[_0x17677e(0x1ef)][_0x17677e(0x216)]);if(_0x177f71&&_0x177f71[_0x17677e(0x1bb)]===_0x30c258)throw new common_1[(_0x17677e(0x213))](_0x17677e(0x1c2),common_1[_0x17677e(0x1ef)][_0x17677e(0x216)]);}async['verifyUserRegisterByEmail'](_0xacbc9c){const _0x34efb1=_0x2eb740,{username:_0x2f187f,email:_0x7ed402}=_0xacbc9c;console[_0x34efb1(0x231)](_0x34efb1(0x1b1)+_0x2f187f+_0x34efb1(0x234)+_0x7ed402);const _0x425a1c=await this[_0x34efb1(0x1f2)][_0x34efb1(0x204)]({'where':[{'username':_0x2f187f},{'email':_0x7ed402}]});if(_0x425a1c&&_0x425a1c[_0x34efb1(0x1d7)]===_0x2f187f){console[_0x34efb1(0x1de)](_0x34efb1(0x23f)+_0x2f187f+_0x34efb1(0x1eb));throw new common_1[(_0x34efb1(0x213))](_0x34efb1(0x1c8),common_1[_0x34efb1(0x1ef)]['BAD_REQUEST']);}if(_0x425a1c&&_0x425a1c[_0x34efb1(0x1da)]===_0x7ed402){console[_0x34efb1(0x1de)]('校验失败:\x20邮箱\x20\x22'+_0x7ed402+_0x34efb1(0x1ba));throw new common_1['HttpException'](_0x34efb1(0x1b8),common_1['HttpStatus']['BAD_REQUEST']);}console[_0x34efb1(0x231)](_0x34efb1(0x227)+_0x2f187f+_0x34efb1(0x234)+_0x7ed402+_0x34efb1(0x1e8));}async['createUser'](_0x530c36){const _0x9c4af4=_0x2eb740;return await this[_0x9c4af4(0x1f2)][_0x9c4af4(0x1a9)](_0x530c36);}async[_0x2eb740(0x1e2)](_0x167308,_0x5e1919,_0x47a675){const _0x1223bf=_0x2eb740,_0x48c866=await this[_0x1223bf(0x1f2)][_0x1223bf(0x204)]({'where':{'id':_0x167308}});!_0x48c866&&common_1[_0x1223bf(0x24f)][_0x1223bf(0x1de)](_0x1223bf(0x1cc));await this['userEntity']['update']({'id':_0x167308},{'realName':_0x5e1919,'idCard':_0x47a675});return;}async[_0x2eb740(0x23d)](_0x5c159e,_0x1573b2,_0x4ae2c1,_0x4debf0){const _0x1a6636=_0x2eb740,_0x3490f8=await this['userEntity'][_0x1a6636(0x204)]({'where':{'id':_0x5c159e}}),_0x5bebbe=bcrypt['hashSync'](_0x4debf0,0xa);!_0x3490f8&&common_1[_0x1a6636(0x24f)][_0x1a6636(0x1de)]('用户不存在');if(!_0x1573b2||!_0x4ae2c1||!_0x5bebbe)throw new common_1['HttpException']('参数错误！',common_1[_0x1a6636(0x1ef)][_0x1a6636(0x216)]);await this[_0x1a6636(0x1f2)][_0x1a6636(0x1fa)]({'id':_0x5c159e},{'phone':_0x1573b2,'username':_0x4ae2c1,'password':_0x5bebbe});return;}};UserService=__decorate([(0x0,common_1[_0x2eb740(0x24a)])(),__param(0x0,(0x0,typeorm_1[_0x2eb740(0x221)])(user_entity_1[_0x2eb740(0x1fc)])),__param(0x6,(0x0,typeorm_1[_0x2eb740(0x221)])(config_entity_1['ConfigEntity'])),__metadata(_0x2eb740(0x23c),[typeorm_2['Repository'],typeorm_2['Connection'],verification_service_1[_0x2eb740(0x1e6)],mailer_service_1[_0x2eb740(0x206)],userBalance_service_1['UserBalanceService'],globalConfig_service_1['GlobalConfigService'],typeorm_2[_0x2eb740(0x24e)]])],UserService),exports['UserService']=UserService;