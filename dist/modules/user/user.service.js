'use strict';const _0x1b0c15=_0x2f0b;(function(_0xbd7e52,_0x3778b7){const _0x37c01b=_0x2f0b,_0xef4900=_0xbd7e52();while(!![]){try{const _0xcbabea=-parseInt(_0x37c01b(0xac))/0x1+parseInt(_0x37c01b(0xa5))/0x2*(parseInt(_0x37c01b(0xbf))/0x3)+-parseInt(_0x37c01b(0xb9))/0x4*(-parseInt(_0x37c01b(0x8b))/0x5)+-parseInt(_0x37c01b(0x12f))/0x6+parseInt(_0x37c01b(0x125))/0x7+-parseInt(_0x37c01b(0x10a))/0x8+parseInt(_0x37c01b(0x11b))/0x9;if(_0xcbabea===_0x3778b7)break;else _0xef4900['push'](_0xef4900['shift']());}catch(_0x1c1a15){_0xef4900['push'](_0xef4900['shift']());}}}(_0x2964,0xd1219));function _0x2f0b(_0x4eb059,_0x53d9da){const _0x2964e5=_0x2964();return _0x2f0b=function(_0x2f0b19,_0x563f66){_0x2f0b19=_0x2f0b19-0x87;let _0x1589e8=_0x2964e5[_0x2f0b19];return _0x1589e8;},_0x2f0b(_0x4eb059,_0x53d9da);}function _0x2964(){const _0x5675df=['verificationService','当前密码错误！','用户不存在！','@default.com','校验失败:\x20邮箱\x20\x22','该微信已绑定其他账号！','registerVerifyEmailTitle','status','configEntity','createUserFromContact','updateUserStatus','绑定微信失败、请联系管理员！','log','saveRealNameInfo','updateInfo','verifyUserCredentials','toString','74cSMXoL','registerVerifyExpir','configVal','lastLoginIp','push','./../verification/verification.service','getOwnPropertyDescriptor','1469321HCjkuC','createUserAndVerifycation','\x22\x20已被注册','checkUserStatus','当前手机号已注册、请勿重复注册！','../../common/utils','idCard','cloneDeep','object','getUserInfo','user','当前邮箱已注册、请勿重复注册！','role','76IEGAcc','__esModule','RechargeType','getConfigs','@nestjs/common','forEach','80814WkjJnM','../mailer/mailer.service','visitor','您的账户已被永久加入黑名单、如有疑问、请联系管理员！','configKey','design:paramtypes','updateUserPhone','typeorm','registerBaseUrl','userRecharge','getUserByContact','用户名已存在、请更换用户名！','GlobalConfigService','当前账户不存在！','./../globalConfig/globalConfig.service','verifyUserRegister','LOCKED','getOpenIdByUserId','createdAt','Logger','findAndCount','userBalanceService','密码重置为[','修改用户信息失败！','queryUserInfoById','createRandomUid','metadata','super','getSuper','queryUserBalance','修改用户状态成功！','maskIpAddress','修改用户信息成功！','resetUserPass','email','__param','Injectable','修改密码失败、请重新试试吧。','Registration','assign','error','BLACKLISTED','__metadata','MailerService','InjectRepository','bindWx','重置密码失败！','verifyUserRegisterByPhone','Not','BAD_REQUEST','defineProperty','\x22\x20已存在','registerVerifyEmailDesc','function','HttpException','find','isBindWx','findOne','Like','UserService','userEntity','ACTIVE','affected','updateStatus','username','ConfigEntity','length','getUserStatus','hashSync','userDefautlAvatar','update','当前绑定用户不存在！','当前用户不存在！','Repository','DESC','20944lynVOs','reduce','\x20未被占用','sign','error:\x20','您的账户已被封禁、如有疑问、请联系管理员！','globalConfigService','save','queryAll','phone','openId','用户名已存在！','@nestjs/typeorm','decorate','map','verifyUserPassword','saveRecordRechargeLog','9921222Kjzmpq','UserStatusEnum','用户名或者邮箱已被注册！','HttpStatus','用户不存在','PENDING','校验邮箱注册:\x20开始\x20-\x20用户名:\x20','校验失败:\x20用户名\x20\x22','balanceInfo','UNAUTHORIZED','4318874kMSMyc','connection','../../common/constants/verification.constant','password','lodash','createUser','尝试发送邮件到:\x20','addBalanceToNewUser','123456','avatar','4227582XGDWdZ','compareSync',']成功!','恭喜您绑定成功、后续可直接扫码登录了！','./../../common/constants/user.constant','isVerifyEmail','超级管理员不可被操作！','83445DuPnhP','createVerification',',\x20邮箱:\x20','当前用户信息失效、请重新登录！','savaLoginIp','updateUserPassword','getUserById','verifyUserRegisterByEmail','isUsernameTaken'];_0x2964=function(){return _0x5675df;};return _0x2964();}var __decorate=this&&this['__decorate']||function(_0x156b50,_0x326675,_0x19f879,_0x51325f){const _0x5f5b47=_0x2f0b;var _0x3e967e=arguments[_0x5f5b47(0x101)],_0x8d5e6c=_0x3e967e<0x3?_0x326675:_0x51325f===null?_0x51325f=Object[_0x5f5b47(0xab)](_0x326675,_0x19f879):_0x51325f,_0x1438b5;if(typeof Reflect===_0x5f5b47(0xb4)&&typeof Reflect[_0x5f5b47(0x117)]===_0x5f5b47(0xf4))_0x8d5e6c=Reflect[_0x5f5b47(0x117)](_0x156b50,_0x326675,_0x19f879,_0x51325f);else{for(var _0x291e6d=_0x156b50['length']-0x1;_0x291e6d>=0x0;_0x291e6d--)if(_0x1438b5=_0x156b50[_0x291e6d])_0x8d5e6c=(_0x3e967e<0x3?_0x1438b5(_0x8d5e6c):_0x3e967e>0x3?_0x1438b5(_0x326675,_0x19f879,_0x8d5e6c):_0x1438b5(_0x326675,_0x19f879))||_0x8d5e6c;}return _0x3e967e>0x3&&_0x8d5e6c&&Object[_0x5f5b47(0xf1)](_0x326675,_0x19f879,_0x8d5e6c),_0x8d5e6c;},__metadata=this&&this[_0x1b0c15(0xe9)]||function(_0xee3e6a,_0x1804da){const _0x2af21b=_0x1b0c15;if(typeof Reflect===_0x2af21b(0xb4)&&typeof Reflect[_0x2af21b(0xd9)]===_0x2af21b(0xf4))return Reflect[_0x2af21b(0xd9)](_0xee3e6a,_0x1804da);},__param=this&&this[_0x1b0c15(0xe2)]||function(_0xd311c8,_0x386c73){return function(_0x34713f,_0x33bf94){_0x386c73(_0x34713f,_0x33bf94,_0xd311c8);};};Object[_0x1b0c15(0xf1)](exports,_0x1b0c15(0xba),{'value':!![]}),exports['UserService']=void 0x0;const balance_constant_1=require('../../common/constants/balance.constant'),verification_constant_1=require(_0x1b0c15(0x127)),utils_1=require(_0x1b0c15(0xb1)),mailer_service_1=require(_0x1b0c15(0xc0)),common_1=require(_0x1b0c15(0xbd)),typeorm_1=require(_0x1b0c15(0x116)),bcrypt=require('bcryptjs'),_=require(_0x1b0c15(0x129)),typeorm_2=require(_0x1b0c15(0xc6)),config_entity_1=require('../globalConfig/config.entity'),userBalance_service_1=require('../userBalance/userBalance.service'),user_constant_1=require(_0x1b0c15(0x88)),globalConfig_service_1=require(_0x1b0c15(0xcd)),verification_service_1=require(_0x1b0c15(0xaa)),user_entity_1=require('./user.entity');let UserService=class UserService{constructor(_0x5b8d1e,_0xf749b6,_0x1e86a6,_0x303e67,_0x5a0763,_0x39c62d,_0x1ad364){const _0x428bd9=_0x1b0c15;this[_0x428bd9(0xfb)]=_0x5b8d1e,this[_0x428bd9(0x126)]=_0xf749b6,this[_0x428bd9(0x94)]=_0x1e86a6,this['mailerService']=_0x303e67,this['userBalanceService']=_0x5a0763,this[_0x428bd9(0x110)]=_0x39c62d,this[_0x428bd9(0x9c)]=_0x1ad364;}async[_0x1b0c15(0xad)](_0x569893,_0x2be5b2){const _0x3cedf9=_0x1b0c15,{username:_0x2ebde8,email:_0x1550e7,password:_0x46dcd2,client:client=0x0}=_0x569893,_0x51105e=[{'username':_0x2ebde8},{'email':_0x1550e7}],_0x45035b=await this[_0x3cedf9(0xfb)]['findOne']({'where':_0x51105e});if(_0x45035b&&_0x45035b[_0x3cedf9(0x9b)]!==user_constant_1['UserStatusEnum'][_0x3cedf9(0x120)])throw new common_1['HttpException'](_0x3cedf9(0x11d),common_1[_0x3cedf9(0x11e)][_0x3cedf9(0xf0)]);try{const _0x5cd8b6=_[_0x3cedf9(0xb3)](_0x569893),_0x1462cb=bcrypt[_0x3cedf9(0x103)](_0x46dcd2,0xa),_0x5bb527=(0x0,utils_1['getClientIp'])(_0x2be5b2);_0x5cd8b6['password']=_0x1462cb,_0x5cd8b6['registerIp']=_0x5bb527,_0x5cd8b6['client']=client;let _0x524501;if(!_0x45035b){const _0x416d1e=await this[_0x3cedf9(0x110)]['getConfigs'](['userDefautlAvatar']);_0x5cd8b6[_0x3cedf9(0x12e)]=_0x416d1e,_0x524501=await this[_0x3cedf9(0xfb)][_0x3cedf9(0x111)](_0x5cd8b6);}else _0x524501=_0x45035b;const _0x4b87d5=await this[_0x3cedf9(0x9c)][_0x3cedf9(0xf6)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x3cedf9(0x89),_0x3cedf9(0xc7),_0x3cedf9(0x9a),_0x3cedf9(0xf3),'registerVerifyEmailFrom',_0x3cedf9(0xa6)])}}),_0x322182=_0x4b87d5[_0x3cedf9(0x10b)]((_0x199dfa,_0x3fdbf0)=>{const _0xfff722=_0x3cedf9;return _0x199dfa[_0x3fdbf0[_0xfff722(0xc3)]]=_0x3fdbf0[_0xfff722(0xa7)],_0x199dfa;},{}),_0x460f53=_0x322182[_0x3cedf9(0x89)]?Number(_0x322182[_0x3cedf9(0x89)]):0x1;if(_0x460f53){const _0x32bdb1=_0x322182['registerVerifyExpir']?Number(_0x322182['registerVerifyExpir']):0x1e*0x3c,_0x57f140=await this['verificationService'][_0x3cedf9(0x8c)](_0x524501,verification_constant_1['VerificationEnum'][_0x3cedf9(0xe5)],_0x32bdb1),{code:_0x5935ef,email:_0x570c31,id:_0x9e3be8}=_0x57f140,{registerVerifyEmailFrom:_0x2061c1}=_0x322182;console[_0x3cedf9(0xa0)]('configMap:\x20',_0x322182),console[_0x3cedf9(0xa0)](_0x3cedf9(0x12b)+_0x570c31);}else{const {id:_0x1c3d6b}=_0x524501;await this[_0x3cedf9(0x9e)](_0x1c3d6b,user_constant_1['UserStatusEnum'][_0x3cedf9(0xfc)]),await this['userBalanceService'][_0x3cedf9(0x12c)](_0x1c3d6b);}return _0x524501;}catch(_0x78ddb6){console['log'](_0x3cedf9(0x10e),_0x78ddb6);throw _0x78ddb6;}}async[_0x1b0c15(0xdb)](){const _0x270733=_0x1b0c15,_0x2d7564=await this[_0x270733(0xfb)][_0x270733(0xf8)]({'where':{'role':_0x270733(0xda)}});return _0x2d7564;}async[_0x1b0c15(0xa3)](_0xe431bd){const _0x3ed716=_0x1b0c15,{username:_0x2174ce,password:_0x57a620,uid:uid=0x0,phone:_0xa7e939}=_0xe431bd;let _0x373837=null;if(uid>0x0){_0x373837=await this[_0x3ed716(0xfb)][_0x3ed716(0xf8)]({'where':{'id':uid}});if(!_0x373837)throw new common_1[(_0x3ed716(0xf5))](_0x3ed716(0xcc),common_1[_0x3ed716(0x11e)][_0x3ed716(0xf0)]);if(!bcrypt[_0x3ed716(0x130)](_0x57a620,_0x373837[_0x3ed716(0x128)]))throw new common_1[(_0x3ed716(0xf5))](_0x3ed716(0x95),common_1[_0x3ed716(0x11e)]['BAD_REQUEST']);}if(_0x2174ce&&_0x57a620){const _0x3fe9d2=[{'username':_0x2174ce},{'email':_0x2174ce},{'phone':_0x2174ce}];_0x373837=await this[_0x3ed716(0xfb)]['findOne']({'where':_0x3fe9d2});if(!_0x373837)throw new common_1[(_0x3ed716(0xf5))](_0x3ed716(0xcc),common_1[_0x3ed716(0x11e)][_0x3ed716(0xf0)]);if(!bcrypt[_0x3ed716(0x130)](_0x57a620,_0x373837[_0x3ed716(0x128)]))throw new common_1['HttpException'](_0x3ed716(0x95),common_1[_0x3ed716(0x11e)][_0x3ed716(0xf0)]);}if(!_0x373837)throw new common_1[(_0x3ed716(0xf5))](_0x3ed716(0xcc),common_1[_0x3ed716(0x11e)][_0x3ed716(0xf0)]);if(_0x373837[_0x3ed716(0x9b)]!==user_constant_1[_0x3ed716(0x11c)][_0x3ed716(0xfc)])throw new common_1[(_0x3ed716(0xf5))](user_constant_1['UserStatusErrMsg'][_0x373837['status']],common_1[_0x3ed716(0x11e)]['BAD_REQUEST']);return _0x373837;}async[_0x1b0c15(0x119)](_0x279b36,_0x1b472f){const _0x3c3009=_0x1b0c15,_0x5ce5b2=await this[_0x3c3009(0xfb)][_0x3c3009(0xf8)]({'where':{'id':_0x279b36}});return bcrypt[_0x3c3009(0x130)](_0x1b472f,_0x5ce5b2[_0x3c3009(0x128)]);}async[_0x1b0c15(0x9e)](_0x4b7a78,_0x973694){const _0x2fbfe3=_0x1b0c15,_0x56368e=await this[_0x2fbfe3(0xfb)][_0x2fbfe3(0x105)]({'id':_0x4b7a78},{'status':_0x973694});return _0x56368e[_0x2fbfe3(0xfd)]>0x0;}async[_0x1b0c15(0x102)](_0x44a60d){const _0x24063b=_0x1b0c15,_0x100317=await this[_0x24063b(0xfb)][_0x24063b(0xf8)]({'where':{'id':_0x44a60d}});return _0x100317[_0x24063b(0x9b)];}async[_0x1b0c15(0xd7)](_0x25e37e){const _0x530344=_0x1b0c15;return await this[_0x530344(0xfb)]['findOne']({'where':{'id':_0x25e37e}});}async['queryOneUserInfo'](_0x4c1dbf){const _0x3b623d=_0x1b0c15;return await this[_0x3b623d(0xfb)]['findOne']({'where':{'id':_0x4c1dbf}});}async[_0x1b0c15(0xaf)](_0x9c31f){const _0x352265=_0x1b0c15,{id:_0x2bb733,role:_0x2e2183}=_0x9c31f;if(_0x2e2183===_0x352265(0xc1))return!![];const _0x51ba90=await this['userEntity']['findOne']({'where':{'id':_0x2bb733}});if(!_0x51ba90)throw new common_1['HttpException'](_0x352265(0x8e),common_1[_0x352265(0x11e)][_0x352265(0x124)]);if(_0x51ba90[_0x352265(0x9b)]===user_constant_1['UserStatusEnum'][_0x352265(0xe8)])throw new common_1['HttpException'](_0x352265(0xc2),common_1[_0x352265(0x11e)]['BAD_REQUEST']);if(_0x51ba90['status']===user_constant_1[_0x352265(0x11c)][_0x352265(0xcf)])throw new common_1['HttpException'](_0x352265(0x10f),common_1[_0x352265(0x11e)][_0x352265(0xf0)]);}async[_0x1b0c15(0xb5)](_0x12c168){const _0x56068c=_0x1b0c15,_0x36059b=await this[_0x56068c(0xfb)][_0x56068c(0xf8)]({'where':{'id':_0x12c168},'select':['username',_0x56068c(0x12e),_0x56068c(0xb8),'email','sign','openId','consecutiveDays']});if(!_0x36059b)throw new common_1[(_0x56068c(0xf5))](_0x56068c(0x8e),common_1[_0x56068c(0x11e)][_0x56068c(0x124)]);_0x36059b[_0x56068c(0xf7)]=!!(_0x36059b===null||_0x36059b===void 0x0?void 0x0:_0x36059b[_0x56068c(0x114)]),delete _0x36059b[_0x56068c(0x114)];const _0x29d389=await this['userBalanceService'][_0x56068c(0xdc)](_0x12c168),_0x11ae48=(_0x12c168*0x7b+0x5f5e100)[_0x56068c(0xa4)](0x24)['toUpperCase']()['slice'](-0x6);return _0x36059b['id']=_0x11ae48,{'userInfo':_0x36059b,'userBalance':Object[_0x56068c(0xe6)]({},_0x29d389)};}async[_0x1b0c15(0x91)](_0x548da4){const _0x180570=_0x1b0c15;return await this['userEntity'][_0x180570(0xf8)]({'where':{'id':_0x548da4}});}async['getUserOpenId'](_0x156114){const _0x5dda5a=_0x1b0c15;return await this[_0x5dda5a(0xfb)]['findOne']({'where':{'openId':_0x156114}});}async[_0x1b0c15(0xa2)](_0x50be84,_0x11a2b0){const _0x5862d2=_0x1b0c15,{id:_0x480c15}=_0x11a2b0['user'],_0xdd5868=await this['userEntity'][_0x5862d2(0xf8)]({'where':{'id':_0x480c15}});if(!_0xdd5868)throw new common_1[(_0x5862d2(0xf5))](_0x5862d2(0x107),common_1[_0x5862d2(0x11e)]['BAD_REQUEST']);if(_0x50be84['username']&&_0xdd5868[_0x5862d2(0xff)]===_0x50be84[_0x5862d2(0xff)])throw new common_1[(_0x5862d2(0xf5))]('没有变更，无需更改！',common_1['HttpStatus'][_0x5862d2(0xf0)]);if(_0x50be84[_0x5862d2(0xff)]){const _0x2144dc=await this[_0x5862d2(0x93)](_0x50be84['username'],_0x480c15);if(_0x2144dc)throw new common_1[(_0x5862d2(0xf5))](_0x5862d2(0x115),common_1[_0x5862d2(0x11e)]['BAD_REQUEST']);}const _0x2790ca=await this[_0x5862d2(0xfb)][_0x5862d2(0x105)]({'id':_0x480c15},_0x50be84);if(_0x2790ca[_0x5862d2(0xfd)]<=0x0)throw new common_1['HttpException'](_0x5862d2(0xd6),common_1[_0x5862d2(0x11e)][_0x5862d2(0xf0)]);return _0x5862d2(0xdf);}async[_0x1b0c15(0x93)](_0x16f2dd,_0x177a08){const _0xa58ff4=_0x1b0c15,_0x566187={'username':_0x16f2dd};_0x177a08&&(_0x566187['id']=(0x0,typeorm_2[_0xa58ff4(0xef)])(_0x177a08));const _0x2d5915=await this[_0xa58ff4(0xfb)][_0xa58ff4(0xf8)]({'where':_0x566187});return!!_0x2d5915;}async[_0x1b0c15(0x90)](_0x427489,_0x140c9c){const _0x161ecc=_0x1b0c15,_0x1ab6c3=bcrypt['hashSync'](_0x140c9c,0xa),_0x266073=await this[_0x161ecc(0xfb)][_0x161ecc(0x105)]({'id':_0x427489},{'password':_0x1ab6c3});if(_0x266073['affected']<=0x0)throw new common_1['HttpException'](_0x161ecc(0xe4),common_1[_0x161ecc(0x11e)][_0x161ecc(0xf0)]);}async[_0x1b0c15(0xc8)](_0x90f98){const _0x5b07df=_0x1b0c15,{userId:_0x2de1c9,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x90f98;await this['userBalanceService']['addBalanceToUser'](_0x2de1c9,{'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});const _0xb13f2c=await this[_0x5b07df(0xd4)][_0x5b07df(0x11a)]({'userId':_0x2de1c9,'rechargeType':balance_constant_1[_0x5b07df(0xbb)]['ADMIN_GIFT'],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'extent':''});return _0xb13f2c;}async[_0x1b0c15(0x112)](_0x54e53a,_0x1aafec){const _0x6aad6d=_0x1b0c15,{page:page=0x1,size:size=0xa,username:_0x347747,email:_0x34d8a0,status:_0x5430c2,keyword:_0x1fe9c3,phone:_0x505509}=_0x54e53a;let _0x45f6ed={};_0x347747&&Object['assign'](_0x45f6ed,{'username':(0x0,typeorm_2[_0x6aad6d(0xf9)])('%'+_0x347747+'%')}),_0x34d8a0&&Object['assign'](_0x45f6ed,{'email':(0x0,typeorm_2['Like'])('%'+_0x34d8a0+'%')}),_0x505509&&Object[_0x6aad6d(0xe6)](_0x45f6ed,{'phone':(0x0,typeorm_2[_0x6aad6d(0xf9)])('%'+_0x505509+'%')}),_0x5430c2&&Object[_0x6aad6d(0xe6)](_0x45f6ed,{'status':_0x5430c2});_0x1fe9c3&&(_0x45f6ed=[{'username':(0x0,typeorm_2[_0x6aad6d(0xf9)])('%'+_0x1fe9c3+'%')},{'email':(0x0,typeorm_2[_0x6aad6d(0xf9)])('%'+_0x1fe9c3+'%')},{'phone':(0x0,typeorm_2[_0x6aad6d(0xf9)])('%'+_0x1fe9c3+'%')}]);const [_0x16cbb3,_0x1e5f2f]=await this[_0x6aad6d(0xfb)][_0x6aad6d(0xd3)]({'skip':(page-0x1)*size,'where':_0x45f6ed,'take':size,'order':{'createdAt':_0x6aad6d(0x109)},'cache':!![],'select':['username',_0x6aad6d(0x12e),_0x6aad6d(0xb8),_0x6aad6d(0x10d),'status','id',_0x6aad6d(0xe1),_0x6aad6d(0xd1),'lastLoginIp',_0x6aad6d(0x113),'realName',_0x6aad6d(0xb2)]}),_0x4caebf=_0x16cbb3[_0x6aad6d(0x118)](_0x360786=>_0x360786['id']),_0x14c759=await this[_0x6aad6d(0xd4)]['queryUserBalanceByIds'](_0x4caebf);return _0x16cbb3[_0x6aad6d(0xbe)](_0x2e0a53=>_0x2e0a53[_0x6aad6d(0x123)]=_0x14c759[_0x6aad6d(0xf6)](_0xecc014=>_0xecc014['userId']===_0x2e0a53['id'])),_0x1aafec['user'][_0x6aad6d(0xb8)]!=='super'&&_0x16cbb3[_0x6aad6d(0xbe)](_0x3a9bbb=>_0x3a9bbb[_0x6aad6d(0xe1)]=(0x0,utils_1['maskEmail'])(_0x3a9bbb[_0x6aad6d(0xe1)])),_0x1aafec[_0x6aad6d(0xb6)][_0x6aad6d(0xb8)]!==_0x6aad6d(0xda)&&_0x16cbb3[_0x6aad6d(0xbe)](_0x4ca030=>_0x4ca030[_0x6aad6d(0xa8)]=(0x0,utils_1[_0x6aad6d(0xde)])(_0x4ca030[_0x6aad6d(0xa8)])),_0x1aafec[_0x6aad6d(0xb6)][_0x6aad6d(0xb8)]!=='super'&&_0x16cbb3[_0x6aad6d(0xbe)](_0x32489c=>_0x32489c[_0x6aad6d(0x113)]=(0x0,utils_1[_0x6aad6d(0xde)])(_0x32489c[_0x6aad6d(0x113)])),{'rows':_0x16cbb3,'count':_0x1e5f2f};}async['queryOne']({id:_0x1b415e}){const _0x3dd5c0=_0x1b0c15;return await this[_0x3dd5c0(0xfb)][_0x3dd5c0(0xf8)]({'where':{'id':_0x1b415e},'select':[_0x3dd5c0(0xff),_0x3dd5c0(0x12e),_0x3dd5c0(0xb8),_0x3dd5c0(0x10d),_0x3dd5c0(0x9b)]});}async[_0x1b0c15(0xfe)](_0x53b9ad){const _0x255949=_0x1b0c15,{id:_0x1dbbcf,status:_0x3aa017}=_0x53b9ad,_0x1ad13a=await this[_0x255949(0xfb)][_0x255949(0xf8)]({'where':{'id':_0x1dbbcf}});if(!_0x1ad13a)throw new common_1['HttpException'](_0x255949(0x96),common_1[_0x255949(0x11e)][_0x255949(0xf0)]);if(_0x1ad13a[_0x255949(0xb8)]===_0x255949(0xda))throw new common_1[(_0x255949(0xf5))](_0x255949(0x8a),common_1[_0x255949(0x11e)][_0x255949(0xf0)]);if(_0x1ad13a[_0x255949(0xb8)]===_0x255949(0xda))throw new common_1[(_0x255949(0xf5))]('超级管理员不可被操作！',common_1[_0x255949(0x11e)][_0x255949(0xf0)]);const _0x289712=await this[_0x255949(0xfb)][_0x255949(0x105)]({'id':_0x1dbbcf},{'status':_0x3aa017});if(_0x289712[_0x255949(0xfd)]<=0x0)throw new common_1[(_0x255949(0xf5))]('修改用户状态失败！',common_1[_0x255949(0x11e)][_0x255949(0xf0)]);return _0x255949(0xdd);}async[_0x1b0c15(0xe0)](_0xd0f2bd){const _0x506ad4=_0x1b0c15,{id:_0x5a80e1}=_0xd0f2bd,_0xcd3272=await this[_0x506ad4(0xfb)][_0x506ad4(0xf8)]({'where':{'id':_0x5a80e1}});if(!_0xcd3272)throw new common_1['HttpException'](_0x506ad4(0x96),common_1['HttpStatus'][_0x506ad4(0xf0)]);const _0x517d5b=_0x506ad4(0x12d),_0x4a2cdc=bcrypt[_0x506ad4(0x103)](_0x517d5b,0xa),_0x36ca3f=await this[_0x506ad4(0xfb)][_0x506ad4(0x105)]({'id':_0x5a80e1},{'password':_0x4a2cdc});if(_0x36ca3f[_0x506ad4(0xfd)]<=0x0)throw new common_1['HttpException'](_0x506ad4(0xed),common_1[_0x506ad4(0x11e)][_0x506ad4(0xf0)]);return _0x506ad4(0xd5)+_0x517d5b+_0x506ad4(0x131);}async[_0x1b0c15(0x8f)](_0x587351,_0x94e4a4){const _0x38eaf0=_0x1b0c15;return await this[_0x38eaf0(0xfb)][_0x38eaf0(0x105)]({'id':_0x587351},{'lastLoginIp':_0x94e4a4});}async['getUserFromOpenId'](_0x28cc36,_0x595fb0){const _0x1d8a1a=_0x1b0c15,_0x73d5ff=await this[_0x1d8a1a(0xfb)][_0x1d8a1a(0xf8)]({'where':{'openId':_0x28cc36}});if(!_0x73d5ff){const _0x473148=await this['createUserFromOpenId'](_0x28cc36);return await this[_0x1d8a1a(0xd4)][_0x1d8a1a(0x12c)](_0x473148['id']),_0x473148;}return _0x73d5ff;}async['createUserFromOpenId'](_0x5ada0b){const _0x48c511=_0x1b0c15,_0x1886c9=await this[_0x48c511(0x110)][_0x48c511(0xbc)]([_0x48c511(0x104)]),_0x29af9c={'avatar':_0x1886c9,'username':'用户'+(0x0,utils_1[_0x48c511(0xd8)])(),'status':user_constant_1[_0x48c511(0x11c)][_0x48c511(0xfc)],'sex':0x0,'email':(0x0,utils_1[_0x48c511(0xd8)])()+_0x48c511(0x97),'openId':_0x5ada0b},_0x4e693c=await this[_0x48c511(0xfb)][_0x48c511(0x111)](_0x29af9c);return _0x4e693c;}async[_0x1b0c15(0x9d)](_0x4da00d){const _0x3e9a19=_0x1b0c15,{username:_0x4c97ba,email:_0x3d83b8,phone:_0x487cca}=_0x4da00d,_0x182180=await this[_0x3e9a19(0x110)][_0x3e9a19(0xbc)]([_0x3e9a19(0x104)]),_0x1ef708={'avatar':_0x182180,'username':'用户'+(0x0,utils_1[_0x3e9a19(0xd8)])(),'status':user_constant_1[_0x3e9a19(0x11c)][_0x3e9a19(0xfc)],'sex':0x0};_0x4c97ba&&(_0x1ef708[_0x3e9a19(0xff)]=_0x4c97ba);_0x3d83b8&&(_0x1ef708[_0x3e9a19(0xe1)]=_0x3d83b8);_0x487cca&&(_0x1ef708[_0x3e9a19(0x113)]=_0x487cca);const _0x3d6f9a=await this[_0x3e9a19(0xfb)]['save'](_0x1ef708);return _0x3d6f9a;}async[_0x1b0c15(0xc9)](_0x3220a6){const _0x4c4f42=_0x1b0c15,{username:_0x41a849,email:_0x5ea92c,phone:_0x2771f6}=_0x3220a6,_0x4e1829=[];return _0x41a849&&_0x4e1829['push']({'username':_0x41a849}),_0x5ea92c&&_0x4e1829[_0x4c4f42(0xa9)]({'email':_0x5ea92c}),_0x2771f6&&_0x4e1829['push']({'phone':_0x2771f6}),await this['userEntity'][_0x4c4f42(0xf8)]({'where':_0x4e1829});}async[_0x1b0c15(0xec)](_0x48cbd6,_0xe317ea){const _0x41e9a4=_0x1b0c15;try{const _0x2149bc=await this[_0x41e9a4(0xfb)]['findOne']({'where':{'id':_0xe317ea}});if(!_0x2149bc)return{'status':![],'msg':_0x41e9a4(0x106)};const _0x5cab08=await this[_0x41e9a4(0xfb)][_0x41e9a4(0xf8)]({'where':{'openId':_0x48cbd6}});if(_0x5cab08)return{'status':![],'msg':_0x41e9a4(0x99)};const _0x36926a=await this[_0x41e9a4(0xfb)][_0x41e9a4(0x105)]({'id':_0xe317ea},{'openId':_0x48cbd6});if(_0x36926a['affected']<=0x0)return{'status':![],'msg':_0x41e9a4(0x9f)};return{'status':!![],'msg':_0x41e9a4(0x87)};}catch(_0x3d1e14){return{'status':![],'msg':_0x41e9a4(0x9f)};}}async[_0x1b0c15(0xd0)](_0xf9fb0){const _0x45902d=_0x1b0c15,_0x3482f9=await this[_0x45902d(0xfb)][_0x45902d(0xf8)]({'where':{'id':_0xf9fb0}});return _0x3482f9===null||_0x3482f9===void 0x0?void 0x0:_0x3482f9[_0x45902d(0x114)];}async[_0x1b0c15(0xce)](_0x353aee){const _0x55f0ea=_0x1b0c15,{username:_0x1a6c28,phone:_0x25c7ed,email:_0x5896a6}=_0x353aee;if(_0x25c7ed){const _0x401967=await this['userEntity'][_0x55f0ea(0xf8)]({'where':{'phone':_0x25c7ed}});if(_0x401967)return![];}if(_0x5896a6){const _0x3b8326=await this[_0x55f0ea(0xfb)][_0x55f0ea(0xf8)]({'where':{'email':_0x5896a6}});if(_0x3b8326)return![];}if(_0x1a6c28){const _0x29f473=await this[_0x55f0ea(0xfb)][_0x55f0ea(0xf8)]({'where':{'username':_0x1a6c28}});if(_0x29f473)return![];}if(!_0x25c7ed&&!_0x5896a6&&!_0x1a6c28)return![];return!![];}async[_0x1b0c15(0xee)](_0x13d5f7){const _0x4f53e9=_0x1b0c15,{username:_0x43e8fd,password:_0x262c4b,phone:_0x4926f7,phoneCode:_0xcac552}=_0x13d5f7,_0x21ec3d=await this[_0x4f53e9(0xfb)][_0x4f53e9(0xf8)]({'where':[{'username':_0x43e8fd},{'phone':_0x4926f7}]});if(_0x21ec3d&&_0x21ec3d[_0x4f53e9(0xff)]===_0x43e8fd)throw new common_1[(_0x4f53e9(0xf5))](_0x4f53e9(0xca),common_1['HttpStatus']['BAD_REQUEST']);if(_0x21ec3d&&_0x21ec3d[_0x4f53e9(0x113)]===_0x4926f7)throw new common_1[(_0x4f53e9(0xf5))](_0x4f53e9(0xb0),common_1['HttpStatus'][_0x4f53e9(0xf0)]);}async[_0x1b0c15(0x92)](_0x1096ff){const _0x1874c8=_0x1b0c15,{username:_0x325b41,email:_0x230402}=_0x1096ff;console[_0x1874c8(0xa0)](_0x1874c8(0x121)+_0x325b41+',\x20邮箱:\x20'+_0x230402);const _0x1e3642=await this[_0x1874c8(0xfb)][_0x1874c8(0xf8)]({'where':[{'username':_0x325b41},{'email':_0x230402}]});if(_0x1e3642&&_0x1e3642['username']===_0x325b41){console['error'](_0x1874c8(0x122)+_0x325b41+_0x1874c8(0xf2));throw new common_1['HttpException'](_0x1874c8(0xca),common_1['HttpStatus']['BAD_REQUEST']);}if(_0x1e3642&&_0x1e3642['email']===_0x230402){console['error'](_0x1874c8(0x98)+_0x230402+_0x1874c8(0xae));throw new common_1[(_0x1874c8(0xf5))](_0x1874c8(0xb7),common_1[_0x1874c8(0x11e)][_0x1874c8(0xf0)]);}console[_0x1874c8(0xa0)]('校验邮箱注册:\x20成功\x20-\x20用户名:\x20'+_0x325b41+_0x1874c8(0x8d)+_0x230402+_0x1874c8(0x10c));}async[_0x1b0c15(0x12a)](_0x4c2a09){const _0x4497d6=_0x1b0c15;return await this[_0x4497d6(0xfb)][_0x4497d6(0x111)](_0x4c2a09);}async[_0x1b0c15(0xa1)](_0x189bd9,_0x4b032f,_0x1d7678){const _0x11fe92=_0x1b0c15,_0x429fdd=await this[_0x11fe92(0xfb)][_0x11fe92(0xf8)]({'where':{'id':_0x189bd9}});!_0x429fdd&&common_1[_0x11fe92(0xd2)][_0x11fe92(0xe7)](_0x11fe92(0x11f));await this[_0x11fe92(0xfb)][_0x11fe92(0x105)]({'id':_0x189bd9},{'realName':_0x4b032f,'idCard':_0x1d7678});return;}async[_0x1b0c15(0xc5)](_0x396215,_0x39d0a2,_0xa475d5,_0x57edf0){const _0x551521=_0x1b0c15,_0x1444a5=await this[_0x551521(0xfb)]['findOne']({'where':{'id':_0x396215}}),_0x39ed36=bcrypt[_0x551521(0x103)](_0x57edf0,0xa);!_0x1444a5&&common_1[_0x551521(0xd2)][_0x551521(0xe7)](_0x551521(0x11f));if(!_0x39d0a2||!_0xa475d5||!_0x39ed36)throw new common_1['HttpException']('参数错误！',common_1[_0x551521(0x11e)][_0x551521(0xf0)]);await this[_0x551521(0xfb)][_0x551521(0x105)]({'id':_0x396215},{'phone':_0x39d0a2,'username':_0xa475d5,'password':_0x39ed36});return;}};UserService=__decorate([(0x0,common_1[_0x1b0c15(0xe3)])(),__param(0x0,(0x0,typeorm_1[_0x1b0c15(0xeb)])(user_entity_1['UserEntity'])),__param(0x6,(0x0,typeorm_1[_0x1b0c15(0xeb)])(config_entity_1[_0x1b0c15(0x100)])),__metadata(_0x1b0c15(0xc4),[typeorm_2[_0x1b0c15(0x108)],typeorm_2['Connection'],verification_service_1['VerificationService'],mailer_service_1[_0x1b0c15(0xea)],userBalance_service_1['UserBalanceService'],globalConfig_service_1[_0x1b0c15(0xcb)],typeorm_2[_0x1b0c15(0x108)]])],UserService),exports[_0x1b0c15(0xfa)]=UserService;