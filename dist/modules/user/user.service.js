'use strict';const _0x418b8a=_0x35cc;(function(_0x2298e4,_0x1c84d9){const _0x172439=_0x35cc,_0x295eca=_0x2298e4();while(!![]){try{const _0x232473=-parseInt(_0x172439(0x126))/0x1*(parseInt(_0x172439(0xa7))/0x2)+-parseInt(_0x172439(0x112))/0x3+-parseInt(_0x172439(0x132))/0x4+parseInt(_0x172439(0xbb))/0x5*(parseInt(_0x172439(0xc8))/0x6)+-parseInt(_0x172439(0xe5))/0x7*(-parseInt(_0x172439(0x121))/0x8)+parseInt(_0x172439(0xec))/0x9+parseInt(_0x172439(0xf1))/0xa*(parseInt(_0x172439(0xa4))/0xb);if(_0x232473===_0x1c84d9)break;else _0x295eca['push'](_0x295eca['shift']());}catch(_0x1ecd0f){_0x295eca['push'](_0x295eca['shift']());}}}(_0x13a9,0xce96b));var __decorate=this&&this[_0x418b8a(0xad)]||function(_0x363075,_0x4fb5ee,_0x2a60ef,_0x1d898b){const _0x4db541=_0x418b8a;var _0x301a53=arguments[_0x4db541(0x101)],_0x183b15=_0x301a53<0x3?_0x4fb5ee:_0x1d898b===null?_0x1d898b=Object[_0x4db541(0xa1)](_0x4fb5ee,_0x2a60ef):_0x1d898b,_0x1e5054;if(typeof Reflect==='object'&&typeof Reflect[_0x4db541(0xbc)]===_0x4db541(0xef))_0x183b15=Reflect[_0x4db541(0xbc)](_0x363075,_0x4fb5ee,_0x2a60ef,_0x1d898b);else{for(var _0x15a4d1=_0x363075[_0x4db541(0x101)]-0x1;_0x15a4d1>=0x0;_0x15a4d1--)if(_0x1e5054=_0x363075[_0x15a4d1])_0x183b15=(_0x301a53<0x3?_0x1e5054(_0x183b15):_0x301a53>0x3?_0x1e5054(_0x4fb5ee,_0x2a60ef,_0x183b15):_0x1e5054(_0x4fb5ee,_0x2a60ef))||_0x183b15;}return _0x301a53>0x3&&_0x183b15&&Object[_0x4db541(0xf7)](_0x4fb5ee,_0x2a60ef,_0x183b15),_0x183b15;},__metadata=this&&this['__metadata']||function(_0x3cc6d9,_0x247c37){const _0x3437a6=_0x418b8a;if(typeof Reflect==='object'&&typeof Reflect[_0x3437a6(0x106)]==='function')return Reflect[_0x3437a6(0x106)](_0x3cc6d9,_0x247c37);},__param=this&&this[_0x418b8a(0x125)]||function(_0x386749,_0x250898){return function(_0x3dbba6,_0x3a87d4){_0x250898(_0x3dbba6,_0x3a87d4,_0x386749);};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[_0x418b8a(0xa5)]=void 0x0;function _0x13a9(){const _0x184ae8=['typeorm','getUserById','../../common/utils','校验失败:\x20邮箱\x20\x22','./../globalConfig/globalConfig.service','您的账户已被封禁、如有疑问、请联系管理员！','createUserFromOpenId','用户不存在','当前账户不存在！','恭喜您绑定成功、后续可直接扫码登录了！','35hjjivk','密码重置为[','queryUserBalanceByIds','没有变更，无需更改！','maskIpAddress','./user.entity','./../../common/constants/user.constant','1268874nzkWZR','当前密码错误！','compareSync','function','修改用户信息失败！','48050AdLqGa','参数错误！','getConfigs','verificationService','user','../mailer/mailer.service','defineProperty','queryOneUserInfo','DESC','createVerification','isUsernameTaken','updateStatus','RechargeType','getUserOpenId','updateUserStatus','校验失败:\x20用户名\x20\x22','length','您的账户已被永久加入黑名单、如有疑问、请联系管理员！','getUserStatus','assign','verifyUserPassword','metadata','registerVerifyExpir','ADMIN_GIFT','bindWx','当前邮箱已注册、请勿重复注册！','该微信已绑定其他账号！','hashSync','Repository','ACTIVE','userId','\x20未被占用','error','2491746qRGNzF','checkUserStatus','registerVerifyEmailDesc','configVal','getUserFromOpenId','../userBalance/userBalance.service','verifyUserRegister','saveRecordRechargeLog','email','error:\x20','avatar','userBalanceService','find','findAndCount','校验邮箱注册:\x20开始\x20-\x20用户名:\x20','2448360jgqoaW','@nestjs/common','VerificationEnum','configKey','__param','91rydfXk',',\x20邮箱:\x20','createUserAndVerifycation','BLACKLISTED','findOne',']成功!','超级管理员不可被操作！','update','isBindWx','map','queryUserBalance','registerBaseUrl','3342996nDySuR','username','affected','UNAUTHORIZED','configEntity','globalConfigService','log','createRandomUid','cloneDeep','mailerService','修改用户状态失败！','UserStatusEnum','updateUserPhone','maskEmail','BAD_REQUEST','尝试发送邮件到:\x20','role','123456','createdAt','addBalanceToUser','lastLoginIp','getOwnPropertyDescriptor','当前绑定用户不存在！','phone','1573NJGlDu','UserService','绑定微信失败、请联系管理员！','3886KjyhMj','../../common/constants/verification.constant','HttpException','getUserByContact','resetUserPass','UserEntity','__decorate','queryUserInfoById','super','userDefautlAvatar','saveRealNameInfo','isVerifyEmail','Like','UserStatusErrMsg','用户名已存在、请更换用户名！','@default.com','forEach','userEntity','当前手机号已注册、请勿重复注册！','save','5GPndQA','decorate','openId','balanceInfo','registerVerifyEmailTitle','status','verifyUserCredentials','Connection','UserBalanceService','修改密码失败、请重新试试吧。','PENDING','InjectRepository','../globalConfig/config.entity','1986030znVYNr','password','realName','updateUserPassword','connection','Registration','queryAll','Logger','当前用户信息失效、请重新登录！','savaLoginIp','MailerService','HttpStatus','addBalanceToNewUser','getOpenIdByUserId','configMap:\x20','sign','createUserFromContact','用户不存在！','reduce'];_0x13a9=function(){return _0x184ae8;};return _0x13a9();}function _0x35cc(_0x3d945d,_0x330541){const _0x13a99b=_0x13a9();return _0x35cc=function(_0x35cc1b,_0x5600e8){_0x35cc1b=_0x35cc1b-0x90;let _0x5486bf=_0x13a99b[_0x35cc1b];return _0x5486bf;},_0x35cc(_0x3d945d,_0x330541);}const balance_constant_1=require('../../common/constants/balance.constant'),verification_constant_1=require(_0x418b8a(0xa8)),utils_1=require(_0x418b8a(0xdd)),mailer_service_1=require(_0x418b8a(0xf6)),common_1=require(_0x418b8a(0x122)),typeorm_1=require('@nestjs/typeorm'),bcrypt=require('bcryptjs'),_=require('lodash'),typeorm_2=require(_0x418b8a(0xdb)),config_entity_1=require(_0x418b8a(0xc7)),userBalance_service_1=require(_0x418b8a(0x117)),user_constant_1=require(_0x418b8a(0xeb)),globalConfig_service_1=require(_0x418b8a(0xdf)),verification_service_1=require('./../verification/verification.service'),user_entity_1=require(_0x418b8a(0xea));let UserService=class UserService{constructor(_0x4d637a,_0x321c91,_0xbf85ca,_0x53f934,_0x48b5d5,_0x105d83,_0x2dd074){const _0x489d62=_0x418b8a;this['userEntity']=_0x4d637a,this[_0x489d62(0xcc)]=_0x321c91,this['verificationService']=_0xbf85ca,this[_0x489d62(0x95)]=_0x53f934,this[_0x489d62(0x11d)]=_0x48b5d5,this[_0x489d62(0x91)]=_0x105d83,this[_0x489d62(0x90)]=_0x2dd074;}async[_0x418b8a(0x128)](_0x17083e,_0x3fbc95){const _0x513f9f=_0x418b8a,{username:_0x29b395,email:_0x1afe79,password:_0xc36fa4,client:client=0x0}=_0x17083e,_0x2508d3=[{'username':_0x29b395},{'email':_0x1afe79}],_0x3eaa82=await this[_0x513f9f(0xb8)][_0x513f9f(0x12a)]({'where':_0x2508d3});if(_0x3eaa82&&_0x3eaa82[_0x513f9f(0xc0)]!==user_constant_1[_0x513f9f(0x97)][_0x513f9f(0xc5)])throw new common_1[(_0x513f9f(0xa9))]('用户名或者邮箱已被注册！',common_1[_0x513f9f(0xd3)]['BAD_REQUEST']);try{const _0x1e3bd4=_[_0x513f9f(0x94)](_0x17083e),_0x5d6dd1=bcrypt['hashSync'](_0xc36fa4,0xa),_0x55c47b=(0x0,utils_1['getClientIp'])(_0x3fbc95);_0x1e3bd4[_0x513f9f(0xc9)]=_0x5d6dd1,_0x1e3bd4['registerIp']=_0x55c47b,_0x1e3bd4['client']=client;let _0x52a020;if(!_0x3eaa82){const _0x5dc166=await this[_0x513f9f(0x91)][_0x513f9f(0xf3)]([_0x513f9f(0xb0)]);_0x1e3bd4['avatar']=_0x5dc166,_0x52a020=await this[_0x513f9f(0xb8)][_0x513f9f(0xba)](_0x1e3bd4);}else _0x52a020=_0x3eaa82;const _0x562ab1=await this[_0x513f9f(0x90)]['find']({'where':{'configKey':(0x0,typeorm_2['In'])([_0x513f9f(0xb2),_0x513f9f(0x131),_0x513f9f(0xbf),_0x513f9f(0x114),'registerVerifyEmailFrom',_0x513f9f(0x107)])}}),_0x58afaf=_0x562ab1[_0x513f9f(0xda)]((_0x3bd553,_0x49c800)=>{const _0x45eaca=_0x513f9f;return _0x3bd553[_0x49c800[_0x45eaca(0x124)]]=_0x49c800[_0x45eaca(0x115)],_0x3bd553;},{}),_0x14f32c=_0x58afaf[_0x513f9f(0xb2)]?Number(_0x58afaf[_0x513f9f(0xb2)]):0x1;if(_0x14f32c){const _0x2a1e6e=_0x58afaf[_0x513f9f(0x107)]?Number(_0x58afaf['registerVerifyExpir']):0x1e*0x3c,_0x3effe0=await this[_0x513f9f(0xf4)][_0x513f9f(0xfa)](_0x52a020,verification_constant_1[_0x513f9f(0x123)][_0x513f9f(0xcd)],_0x2a1e6e),{code:_0x42251e,email:_0x297430,id:_0x3bc1a2}=_0x3effe0,{registerVerifyEmailFrom:_0x233b74}=_0x58afaf;console[_0x513f9f(0x92)](_0x513f9f(0xd6),_0x58afaf),console[_0x513f9f(0x92)](_0x513f9f(0x9b)+_0x297430);}else{const {id:_0xeeddea}=_0x52a020;await this[_0x513f9f(0xff)](_0xeeddea,user_constant_1[_0x513f9f(0x97)]['ACTIVE']),await this[_0x513f9f(0x11d)][_0x513f9f(0xd4)](_0xeeddea);}return _0x52a020;}catch(_0x4a2433){console[_0x513f9f(0x92)](_0x513f9f(0x11b),_0x4a2433);throw _0x4a2433;}}async['getSuper'](){const _0x5bab87=_0x418b8a,_0x68cd42=await this[_0x5bab87(0xb8)][_0x5bab87(0x12a)]({'where':{'role':'super'}});return _0x68cd42;}async[_0x418b8a(0xc1)](_0x5acaa1){const _0x1f78bf=_0x418b8a,{username:_0xa34f1a,password:_0x11cfda,uid:uid=0x0,phone:_0x17c041}=_0x5acaa1;let _0x21ab8b=null;if(uid>0x0){_0x21ab8b=await this[_0x1f78bf(0xb8)][_0x1f78bf(0x12a)]({'where':{'id':uid}});if(!_0x21ab8b)throw new common_1[(_0x1f78bf(0xa9))](_0x1f78bf(0xe3),common_1['HttpStatus'][_0x1f78bf(0x9a)]);if(!bcrypt[_0x1f78bf(0xee)](_0x11cfda,_0x21ab8b['password']))throw new common_1[(_0x1f78bf(0xa9))](_0x1f78bf(0xed),common_1[_0x1f78bf(0xd3)][_0x1f78bf(0x9a)]);}if(_0xa34f1a&&_0x11cfda){const _0x306184=[{'username':_0xa34f1a},{'email':_0xa34f1a},{'phone':_0xa34f1a}];_0x21ab8b=await this[_0x1f78bf(0xb8)][_0x1f78bf(0x12a)]({'where':_0x306184});if(!_0x21ab8b)throw new common_1[(_0x1f78bf(0xa9))]('当前账户不存在！',common_1[_0x1f78bf(0xd3)][_0x1f78bf(0x9a)]);if(!bcrypt[_0x1f78bf(0xee)](_0x11cfda,_0x21ab8b[_0x1f78bf(0xc9)]))throw new common_1[(_0x1f78bf(0xa9))](_0x1f78bf(0xed),common_1['HttpStatus']['BAD_REQUEST']);}if(!_0x21ab8b)throw new common_1[(_0x1f78bf(0xa9))](_0x1f78bf(0xe3),common_1[_0x1f78bf(0xd3)]['BAD_REQUEST']);if(_0x21ab8b[_0x1f78bf(0xc0)]!==user_constant_1[_0x1f78bf(0x97)][_0x1f78bf(0x10e)])throw new common_1[(_0x1f78bf(0xa9))](user_constant_1[_0x1f78bf(0xb4)][_0x21ab8b[_0x1f78bf(0xc0)]],common_1[_0x1f78bf(0xd3)][_0x1f78bf(0x9a)]);return _0x21ab8b;}async[_0x418b8a(0x105)](_0x378442,_0x30b385){const _0x1defbe=_0x418b8a,_0x17af97=await this['userEntity']['findOne']({'where':{'id':_0x378442}});return bcrypt['compareSync'](_0x30b385,_0x17af97[_0x1defbe(0xc9)]);}async[_0x418b8a(0xff)](_0x3447a5,_0x489d1c){const _0x53c60e=_0x418b8a,_0xdd162a=await this['userEntity'][_0x53c60e(0x12d)]({'id':_0x3447a5},{'status':_0x489d1c});return _0xdd162a[_0x53c60e(0x134)]>0x0;}async[_0x418b8a(0x103)](_0x2383e5){const _0x1096ec=_0x418b8a,_0x2235cd=await this[_0x1096ec(0xb8)][_0x1096ec(0x12a)]({'where':{'id':_0x2383e5}});return _0x2235cd[_0x1096ec(0xc0)];}async[_0x418b8a(0xae)](_0x5ee749){const _0x3f5cf1=_0x418b8a;return await this[_0x3f5cf1(0xb8)][_0x3f5cf1(0x12a)]({'where':{'id':_0x5ee749}});}async[_0x418b8a(0xf8)](_0x2b00da){const _0x308fd2=_0x418b8a;return await this['userEntity'][_0x308fd2(0x12a)]({'where':{'id':_0x2b00da}});}async[_0x418b8a(0x113)](_0x259e9c){const _0x478d7e=_0x418b8a,{id:_0x400e0c,role:_0x24e9a4}=_0x259e9c;if(_0x24e9a4==='visitor')return!![];const _0x4ce93=await this['userEntity'][_0x478d7e(0x12a)]({'where':{'id':_0x400e0c}});if(!_0x4ce93)throw new common_1['HttpException'](_0x478d7e(0xd0),common_1['HttpStatus']['UNAUTHORIZED']);if(_0x4ce93[_0x478d7e(0xc0)]===user_constant_1[_0x478d7e(0x97)][_0x478d7e(0x129)])throw new common_1[(_0x478d7e(0xa9))](_0x478d7e(0x102),common_1[_0x478d7e(0xd3)][_0x478d7e(0x9a)]);if(_0x4ce93['status']===user_constant_1[_0x478d7e(0x97)]['LOCKED'])throw new common_1[(_0x478d7e(0xa9))](_0x478d7e(0xe0),common_1[_0x478d7e(0xd3)][_0x478d7e(0x9a)]);}async['getUserInfo'](_0x36579d){const _0x5771e7=_0x418b8a,_0x599587=await this['userEntity']['findOne']({'where':{'id':_0x36579d},'select':[_0x5771e7(0x133),'avatar',_0x5771e7(0x9c),_0x5771e7(0x11a),_0x5771e7(0xd7),_0x5771e7(0xbd),'consecutiveDays']});if(!_0x599587)throw new common_1['HttpException'](_0x5771e7(0xd0),common_1[_0x5771e7(0xd3)][_0x5771e7(0x135)]);_0x599587[_0x5771e7(0x12e)]=!!(_0x599587===null||_0x599587===void 0x0?void 0x0:_0x599587[_0x5771e7(0xbd)]),delete _0x599587[_0x5771e7(0xbd)];const _0x12bc82=await this[_0x5771e7(0x11d)][_0x5771e7(0x130)](_0x36579d),_0x1262fb=(_0x36579d*0x7b+0x5f5e100)['toString'](0x24)['toUpperCase']()['slice'](-0x6);return _0x599587['id']=_0x1262fb,{'userInfo':_0x599587,'userBalance':Object[_0x5771e7(0x104)]({},_0x12bc82)};}async[_0x418b8a(0xdc)](_0x544d3c){const _0x14e2b7=_0x418b8a;return await this[_0x14e2b7(0xb8)][_0x14e2b7(0x12a)]({'where':{'id':_0x544d3c}});}async[_0x418b8a(0xfe)](_0x53e2b8){const _0x34dc93=_0x418b8a;return await this[_0x34dc93(0xb8)][_0x34dc93(0x12a)]({'where':{'openId':_0x53e2b8}});}async['updateInfo'](_0x593730,_0x28beed){const _0x3852b9=_0x418b8a,{id:_0x100636}=_0x28beed['user'],_0x2c3db8=await this[_0x3852b9(0xb8)][_0x3852b9(0x12a)]({'where':{'id':_0x100636}});if(!_0x2c3db8)throw new common_1[(_0x3852b9(0xa9))]('当前用户不存在！',common_1[_0x3852b9(0xd3)]['BAD_REQUEST']);if(_0x593730[_0x3852b9(0x133)]&&_0x2c3db8[_0x3852b9(0x133)]===_0x593730[_0x3852b9(0x133)])throw new common_1[(_0x3852b9(0xa9))](_0x3852b9(0xe8),common_1['HttpStatus']['BAD_REQUEST']);if(_0x593730[_0x3852b9(0x133)]){const _0x3f73dc=await this[_0x3852b9(0xfb)](_0x593730[_0x3852b9(0x133)],_0x100636);if(_0x3f73dc)throw new common_1[(_0x3852b9(0xa9))]('用户名已存在！',common_1[_0x3852b9(0xd3)]['BAD_REQUEST']);}const _0x54176b=await this[_0x3852b9(0xb8)][_0x3852b9(0x12d)]({'id':_0x100636},_0x593730);if(_0x54176b[_0x3852b9(0x134)]<=0x0)throw new common_1[(_0x3852b9(0xa9))](_0x3852b9(0xf0),common_1[_0x3852b9(0xd3)]['BAD_REQUEST']);return'修改用户信息成功！';}async[_0x418b8a(0xfb)](_0x47f491,_0x33508c){const _0x51d422=_0x418b8a,_0x32daa7={'username':_0x47f491};_0x33508c&&(_0x32daa7['id']=(0x0,typeorm_2['Not'])(_0x33508c));const _0x50ae18=await this[_0x51d422(0xb8)][_0x51d422(0x12a)]({'where':_0x32daa7});return!!_0x50ae18;}async[_0x418b8a(0xcb)](_0x30c7d4,_0x599cec){const _0x185bd7=_0x418b8a,_0x45bbd7=bcrypt[_0x185bd7(0x10c)](_0x599cec,0xa),_0x189181=await this[_0x185bd7(0xb8)]['update']({'id':_0x30c7d4},{'password':_0x45bbd7});if(_0x189181[_0x185bd7(0x134)]<=0x0)throw new common_1[(_0x185bd7(0xa9))](_0x185bd7(0xc4),common_1[_0x185bd7(0xd3)]['BAD_REQUEST']);}async['userRecharge'](_0x2b7238){const _0x15dcd2=_0x418b8a,{userId:_0x534198,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x2b7238;await this['userBalanceService'][_0x15dcd2(0x9f)](_0x534198,{'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});const _0x10ddbd=await this[_0x15dcd2(0x11d)][_0x15dcd2(0x119)]({'userId':_0x534198,'rechargeType':balance_constant_1[_0x15dcd2(0xfd)][_0x15dcd2(0x108)],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'extent':''});return _0x10ddbd;}async[_0x418b8a(0xce)](_0x8f72f6,_0x565666){const _0x1c28e3=_0x418b8a,{page:page=0x1,size:size=0xa,username:_0x4d1a45,email:_0x467b79,status:_0x12fd94,keyword:_0x5c48bc,phone:_0x2d2933}=_0x8f72f6;let _0xb0f824={};_0x4d1a45&&Object[_0x1c28e3(0x104)](_0xb0f824,{'username':(0x0,typeorm_2['Like'])('%'+_0x4d1a45+'%')}),_0x467b79&&Object[_0x1c28e3(0x104)](_0xb0f824,{'email':(0x0,typeorm_2[_0x1c28e3(0xb3)])('%'+_0x467b79+'%')}),_0x2d2933&&Object[_0x1c28e3(0x104)](_0xb0f824,{'phone':(0x0,typeorm_2['Like'])('%'+_0x2d2933+'%')}),_0x12fd94&&Object[_0x1c28e3(0x104)](_0xb0f824,{'status':_0x12fd94});_0x5c48bc&&(_0xb0f824=[{'username':(0x0,typeorm_2[_0x1c28e3(0xb3)])('%'+_0x5c48bc+'%')},{'email':(0x0,typeorm_2[_0x1c28e3(0xb3)])('%'+_0x5c48bc+'%')},{'phone':(0x0,typeorm_2['Like'])('%'+_0x5c48bc+'%')}]);const [_0x40adf6,_0x1f1e90]=await this[_0x1c28e3(0xb8)][_0x1c28e3(0x11f)]({'skip':(page-0x1)*size,'where':_0xb0f824,'take':size,'order':{'createdAt':_0x1c28e3(0xf9)},'cache':!![],'select':['username','avatar',_0x1c28e3(0x9c),_0x1c28e3(0xd7),_0x1c28e3(0xc0),'id','email',_0x1c28e3(0x9e),_0x1c28e3(0xa0),_0x1c28e3(0xa3),_0x1c28e3(0xca),'idCard']}),_0x2e3d9e=_0x40adf6[_0x1c28e3(0x12f)](_0xd4681e=>_0xd4681e['id']),_0x5f0115=await this[_0x1c28e3(0x11d)][_0x1c28e3(0xe7)](_0x2e3d9e);return _0x40adf6[_0x1c28e3(0xb7)](_0x518ece=>_0x518ece[_0x1c28e3(0xbe)]=_0x5f0115[_0x1c28e3(0x11e)](_0x4377b7=>_0x4377b7[_0x1c28e3(0x10f)]===_0x518ece['id'])),_0x565666[_0x1c28e3(0xf5)][_0x1c28e3(0x9c)]!=='super'&&_0x40adf6[_0x1c28e3(0xb7)](_0x3c862c=>_0x3c862c[_0x1c28e3(0x11a)]=(0x0,utils_1[_0x1c28e3(0x99)])(_0x3c862c[_0x1c28e3(0x11a)])),_0x565666[_0x1c28e3(0xf5)][_0x1c28e3(0x9c)]!==_0x1c28e3(0xaf)&&_0x40adf6[_0x1c28e3(0xb7)](_0x11922f=>_0x11922f[_0x1c28e3(0xa0)]=(0x0,utils_1[_0x1c28e3(0xe9)])(_0x11922f['lastLoginIp'])),_0x565666[_0x1c28e3(0xf5)][_0x1c28e3(0x9c)]!==_0x1c28e3(0xaf)&&_0x40adf6[_0x1c28e3(0xb7)](_0x348d01=>_0x348d01[_0x1c28e3(0xa3)]=(0x0,utils_1[_0x1c28e3(0xe9)])(_0x348d01[_0x1c28e3(0xa3)])),{'rows':_0x40adf6,'count':_0x1f1e90};}async['queryOne']({id:_0x19d877}){const _0x395df5=_0x418b8a;return await this[_0x395df5(0xb8)]['findOne']({'where':{'id':_0x19d877},'select':[_0x395df5(0x133),_0x395df5(0x11c),_0x395df5(0x9c),_0x395df5(0xd7),'status']});}async[_0x418b8a(0xfc)](_0x1eb704){const _0x5e550d=_0x418b8a,{id:_0x27a206,status:_0x3592f1}=_0x1eb704,_0x272b73=await this['userEntity'][_0x5e550d(0x12a)]({'where':{'id':_0x27a206}});if(!_0x272b73)throw new common_1[(_0x5e550d(0xa9))](_0x5e550d(0xd9),common_1[_0x5e550d(0xd3)][_0x5e550d(0x9a)]);if(_0x272b73[_0x5e550d(0x9c)]==='super')throw new common_1[(_0x5e550d(0xa9))](_0x5e550d(0x12c),common_1['HttpStatus'][_0x5e550d(0x9a)]);if(_0x272b73[_0x5e550d(0x9c)]===_0x5e550d(0xaf))throw new common_1[(_0x5e550d(0xa9))](_0x5e550d(0x12c),common_1[_0x5e550d(0xd3)][_0x5e550d(0x9a)]);const _0x4b2893=await this[_0x5e550d(0xb8)][_0x5e550d(0x12d)]({'id':_0x27a206},{'status':_0x3592f1});if(_0x4b2893[_0x5e550d(0x134)]<=0x0)throw new common_1[(_0x5e550d(0xa9))](_0x5e550d(0x96),common_1['HttpStatus']['BAD_REQUEST']);return'修改用户状态成功！';}async[_0x418b8a(0xab)](_0x5afbde){const _0x511493=_0x418b8a,{id:_0x234cb1}=_0x5afbde,_0x50d138=await this['userEntity'][_0x511493(0x12a)]({'where':{'id':_0x234cb1}});if(!_0x50d138)throw new common_1['HttpException'](_0x511493(0xd9),common_1[_0x511493(0xd3)][_0x511493(0x9a)]);const _0x5ea250=_0x511493(0x9d),_0x51908e=bcrypt[_0x511493(0x10c)](_0x5ea250,0xa),_0x8bd8dc=await this[_0x511493(0xb8)][_0x511493(0x12d)]({'id':_0x234cb1},{'password':_0x51908e});if(_0x8bd8dc[_0x511493(0x134)]<=0x0)throw new common_1['HttpException']('重置密码失败！',common_1['HttpStatus'][_0x511493(0x9a)]);return _0x511493(0xe6)+_0x5ea250+_0x511493(0x12b);}async[_0x418b8a(0xd1)](_0x3ec7dd,_0x5ca9f8){const _0x389772=_0x418b8a;return await this[_0x389772(0xb8)]['update']({'id':_0x3ec7dd},{'lastLoginIp':_0x5ca9f8});}async[_0x418b8a(0x116)](_0x49050a,_0x34440d){const _0x289064=_0x418b8a,_0x48c136=await this[_0x289064(0xb8)][_0x289064(0x12a)]({'where':{'openId':_0x49050a}});if(!_0x48c136){const _0x434ab8=await this['createUserFromOpenId'](_0x49050a);return await this[_0x289064(0x11d)][_0x289064(0xd4)](_0x434ab8['id']),_0x434ab8;}return _0x48c136;}async[_0x418b8a(0xe1)](_0x5afb4d){const _0x4bc939=_0x418b8a,_0x359329=await this[_0x4bc939(0x91)][_0x4bc939(0xf3)](['userDefautlAvatar']),_0x23d738={'avatar':_0x359329,'username':'用户'+(0x0,utils_1[_0x4bc939(0x93)])(),'status':user_constant_1['UserStatusEnum']['ACTIVE'],'sex':0x0,'email':(0x0,utils_1[_0x4bc939(0x93)])()+_0x4bc939(0xb6),'openId':_0x5afb4d},_0x2036c3=await this['userEntity'][_0x4bc939(0xba)](_0x23d738);return _0x2036c3;}async[_0x418b8a(0xd8)](_0x3c57c4){const _0x1c243c=_0x418b8a,{username:_0x1c80c3,email:_0x2f494e,phone:_0x45aa7f}=_0x3c57c4,_0x598c2f=await this[_0x1c243c(0x91)][_0x1c243c(0xf3)](['userDefautlAvatar']),_0x476515={'avatar':_0x598c2f,'username':'用户'+(0x0,utils_1[_0x1c243c(0x93)])(),'status':user_constant_1[_0x1c243c(0x97)][_0x1c243c(0x10e)],'sex':0x0};_0x1c80c3&&(_0x476515[_0x1c243c(0x133)]=_0x1c80c3);_0x2f494e&&(_0x476515[_0x1c243c(0x11a)]=_0x2f494e);_0x45aa7f&&(_0x476515[_0x1c243c(0xa3)]=_0x45aa7f);const _0x1e2bf1=await this[_0x1c243c(0xb8)][_0x1c243c(0xba)](_0x476515);return _0x1e2bf1;}async[_0x418b8a(0xaa)](_0x12f38f){const _0x195db3=_0x418b8a,{username:_0x13e9d1,email:_0x9ffa07,phone:_0x3a1193}=_0x12f38f,_0x295783=[];return _0x13e9d1&&_0x295783['push']({'username':_0x13e9d1}),_0x9ffa07&&_0x295783['push']({'email':_0x9ffa07}),_0x3a1193&&_0x295783['push']({'phone':_0x3a1193}),await this[_0x195db3(0xb8)][_0x195db3(0x12a)]({'where':_0x295783});}async[_0x418b8a(0x109)](_0x1437d4,_0x14e677){const _0x4c7bd8=_0x418b8a;try{const _0xa0b103=await this[_0x4c7bd8(0xb8)]['findOne']({'where':{'id':_0x14e677}});if(!_0xa0b103)return{'status':![],'msg':_0x4c7bd8(0xa2)};const _0x53c48e=await this['userEntity'][_0x4c7bd8(0x12a)]({'where':{'openId':_0x1437d4}});if(_0x53c48e)return{'status':![],'msg':_0x4c7bd8(0x10b)};const _0x31ff1d=await this[_0x4c7bd8(0xb8)][_0x4c7bd8(0x12d)]({'id':_0x14e677},{'openId':_0x1437d4});if(_0x31ff1d[_0x4c7bd8(0x134)]<=0x0)return{'status':![],'msg':_0x4c7bd8(0xa6)};return{'status':!![],'msg':_0x4c7bd8(0xe4)};}catch(_0x42981b){return{'status':![],'msg':'绑定微信失败、请联系管理员！'};}}async[_0x418b8a(0xd5)](_0x284b3e){const _0x356ba8=_0x418b8a,_0x5ed08d=await this[_0x356ba8(0xb8)][_0x356ba8(0x12a)]({'where':{'id':_0x284b3e}});return _0x5ed08d===null||_0x5ed08d===void 0x0?void 0x0:_0x5ed08d[_0x356ba8(0xbd)];}async[_0x418b8a(0x118)](_0x30091f){const _0xd1b952=_0x418b8a,{username:_0x3b2156,phone:_0x48e425,email:_0x51141e}=_0x30091f;if(_0x48e425){const _0x1efa1e=await this[_0xd1b952(0xb8)][_0xd1b952(0x12a)]({'where':{'phone':_0x48e425}});if(_0x1efa1e)return![];}if(_0x51141e){const _0x50ddd1=await this['userEntity'][_0xd1b952(0x12a)]({'where':{'email':_0x51141e}});if(_0x50ddd1)return![];}if(_0x3b2156){const _0x1a4de2=await this[_0xd1b952(0xb8)][_0xd1b952(0x12a)]({'where':{'username':_0x3b2156}});if(_0x1a4de2)return![];}if(!_0x48e425&&!_0x51141e&&!_0x3b2156)return![];return!![];}async['verifyUserRegisterByPhone'](_0x10a011){const _0x408a3f=_0x418b8a,{username:_0x12f16a,password:_0x3ce4ac,phone:_0x1c72bc,phoneCode:_0x40b092}=_0x10a011,_0x4194c0=await this[_0x408a3f(0xb8)][_0x408a3f(0x12a)]({'where':[{'username':_0x12f16a},{'phone':_0x1c72bc}]});if(_0x4194c0&&_0x4194c0[_0x408a3f(0x133)]===_0x12f16a)throw new common_1[(_0x408a3f(0xa9))](_0x408a3f(0xb5),common_1[_0x408a3f(0xd3)][_0x408a3f(0x9a)]);if(_0x4194c0&&_0x4194c0['phone']===_0x1c72bc)throw new common_1[(_0x408a3f(0xa9))](_0x408a3f(0xb9),common_1['HttpStatus'][_0x408a3f(0x9a)]);}async['verifyUserRegisterByEmail'](_0x54bca8){const _0x469fca=_0x418b8a,{username:_0x13c021,email:_0x42e04b}=_0x54bca8;console[_0x469fca(0x92)](_0x469fca(0x120)+_0x13c021+_0x469fca(0x127)+_0x42e04b);const _0x10656d=await this[_0x469fca(0xb8)][_0x469fca(0x12a)]({'where':[{'username':_0x13c021},{'email':_0x42e04b}]});if(_0x10656d&&_0x10656d['username']===_0x13c021){console[_0x469fca(0x111)](_0x469fca(0x100)+_0x13c021+'\x22\x20已存在');throw new common_1[(_0x469fca(0xa9))]('用户名已存在、请更换用户名！',common_1[_0x469fca(0xd3)]['BAD_REQUEST']);}if(_0x10656d&&_0x10656d[_0x469fca(0x11a)]===_0x42e04b){console[_0x469fca(0x111)](_0x469fca(0xde)+_0x42e04b+'\x22\x20已被注册');throw new common_1[(_0x469fca(0xa9))](_0x469fca(0x10a),common_1['HttpStatus'][_0x469fca(0x9a)]);}console[_0x469fca(0x92)]('校验邮箱注册:\x20成功\x20-\x20用户名:\x20'+_0x13c021+_0x469fca(0x127)+_0x42e04b+_0x469fca(0x110));}async['createUser'](_0x28444d){const _0x51eb76=_0x418b8a;return await this[_0x51eb76(0xb8)]['save'](_0x28444d);}async[_0x418b8a(0xb1)](_0x26f2c3,_0x383fb6,_0x325191){const _0x419ac8=_0x418b8a,_0x3fd419=await this[_0x419ac8(0xb8)]['findOne']({'where':{'id':_0x26f2c3}});!_0x3fd419&&common_1[_0x419ac8(0xcf)][_0x419ac8(0x111)]('用户不存在');await this[_0x419ac8(0xb8)][_0x419ac8(0x12d)]({'id':_0x26f2c3},{'realName':_0x383fb6,'idCard':_0x325191});return;}async[_0x418b8a(0x98)](_0x422602,_0x342e51,_0x4d3b8f,_0x50fe94){const _0x148670=_0x418b8a,_0x3299ce=await this[_0x148670(0xb8)][_0x148670(0x12a)]({'where':{'id':_0x422602}}),_0x340f25=bcrypt[_0x148670(0x10c)](_0x50fe94,0xa);!_0x3299ce&&common_1[_0x148670(0xcf)][_0x148670(0x111)](_0x148670(0xe2));if(!_0x342e51||!_0x4d3b8f||!_0x340f25)throw new common_1[(_0x148670(0xa9))](_0x148670(0xf2),common_1[_0x148670(0xd3)][_0x148670(0x9a)]);await this['userEntity'][_0x148670(0x12d)]({'id':_0x422602},{'phone':_0x342e51,'username':_0x4d3b8f,'password':_0x340f25});return;}};UserService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x418b8a(0xc6)])(user_entity_1[_0x418b8a(0xac)])),__param(0x6,(0x0,typeorm_1['InjectRepository'])(config_entity_1['ConfigEntity'])),__metadata('design:paramtypes',[typeorm_2[_0x418b8a(0x10d)],typeorm_2[_0x418b8a(0xc2)],verification_service_1['VerificationService'],mailer_service_1[_0x418b8a(0xd2)],userBalance_service_1[_0x418b8a(0xc3)],globalConfig_service_1['GlobalConfigService'],typeorm_2[_0x418b8a(0x10d)]])],UserService),exports[_0x418b8a(0xa5)]=UserService;