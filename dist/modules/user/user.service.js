'use strict';function _0x309c(_0x2dafe6,_0x5413b1){const _0x3ac504=_0x3ac5();return _0x309c=function(_0x309cc8,_0x26d8f4){_0x309cc8=_0x309cc8-0xb2;let _0x2a3950=_0x3ac504[_0x309cc8];return _0x2a3950;},_0x309c(_0x2dafe6,_0x5413b1);}const _0x307898=_0x309c;(function(_0x4f0418,_0x83f37a){const _0x53286e=_0x309c,_0x4fdf11=_0x4f0418();while(!![]){try{const _0x3f8773=-parseInt(_0x53286e(0x101))/0x1*(parseInt(_0x53286e(0x118))/0x2)+parseInt(_0x53286e(0x150))/0x3+-parseInt(_0x53286e(0x121))/0x4*(-parseInt(_0x53286e(0xd0))/0x5)+parseInt(_0x53286e(0x116))/0x6+parseInt(_0x53286e(0x11f))/0x7+parseInt(_0x53286e(0xc0))/0x8+-parseInt(_0x53286e(0xe3))/0x9;if(_0x3f8773===_0x83f37a)break;else _0x4fdf11['push'](_0x4fdf11['shift']());}catch(_0x34acd5){_0x4fdf11['push'](_0x4fdf11['shift']());}}}(_0x3ac5,0x8946c));var __decorate=this&&this['__decorate']||function(_0x1885ae,_0xea5f2d,_0xd23e9e,_0x2a1e60){const _0x326ce7=_0x309c;var _0x3ebe48=arguments[_0x326ce7(0xc4)],_0x493a74=_0x3ebe48<0x3?_0xea5f2d:_0x2a1e60===null?_0x2a1e60=Object[_0x326ce7(0xe8)](_0xea5f2d,_0xd23e9e):_0x2a1e60,_0x5caa9c;if(typeof Reflect===_0x326ce7(0xf6)&&typeof Reflect[_0x326ce7(0xb9)]==='function')_0x493a74=Reflect[_0x326ce7(0xb9)](_0x1885ae,_0xea5f2d,_0xd23e9e,_0x2a1e60);else{for(var _0x37f579=_0x1885ae[_0x326ce7(0xc4)]-0x1;_0x37f579>=0x0;_0x37f579--)if(_0x5caa9c=_0x1885ae[_0x37f579])_0x493a74=(_0x3ebe48<0x3?_0x5caa9c(_0x493a74):_0x3ebe48>0x3?_0x5caa9c(_0xea5f2d,_0xd23e9e,_0x493a74):_0x5caa9c(_0xea5f2d,_0xd23e9e))||_0x493a74;}return _0x3ebe48>0x3&&_0x493a74&&Object[_0x326ce7(0x12b)](_0xea5f2d,_0xd23e9e,_0x493a74),_0x493a74;},__metadata=this&&this['__metadata']||function(_0x58db17,_0x395681){const _0x44ef65=_0x309c;if(typeof Reflect==='object'&&typeof Reflect[_0x44ef65(0x136)]===_0x44ef65(0xf9))return Reflect[_0x44ef65(0x136)](_0x58db17,_0x395681);},__param=this&&this[_0x307898(0xc2)]||function(_0x361014,_0x1f1776){return function(_0x49be11,_0x5e6b6b){_0x1f1776(_0x49be11,_0x5e6b6b,_0x361014);};};Object[_0x307898(0x12b)](exports,_0x307898(0xc1),{'value':!![]}),exports[_0x307898(0x114)]=void 0x0;function _0x3ac5(){const _0x4b8ee1=['queryUserInfoById','saveRecordRechargeLog','userDefautlAvatar','verificationService','GlobalConfigService','当前手机号已注册、请勿重复注册！','getOpenIdByUserId','userId','forEach','client','hashSync','affected','createUser','assign','./../../common/constants/user.constant','push','密码重置为[','18677421dxgtfn','UserBalanceService','UserEntity','mailerService','realName','getOwnPropertyDescriptor','username','VerificationEnum','Not','role','getUserStatus','getConfigs','getUserInfo','globalConfigService',',\x20邮箱:\x20','createdAt','compareSync','bcryptjs','用户名已存在、请更换用户名！','object','isBindWx','queryOne','function','当前用户信息失效、请重新登录！','status','\x22\x20已存在','超级管理员不可被操作！','configMap:\x20','修改密码失败、请重新试试吧。','../userBalance/userBalance.service','1jlAGVK','校验失败:\x20用户名\x20\x22','修改用户状态成功！','findAndCount','Repository','configKey','cloneDeep','verifyUserRegister','email','registerVerifyExpir','VerificationService','用户名已存在！','LOCKED','idCard',']成功!','addBalanceToUser','HttpException','修改用户状态失败！','queryOneUserInfo','UserService','registerBaseUrl','5267592wWJXrf','isVerifyEmail','460958iMmQZo','openId','savaLoginIp','user','updateUserStatus','您的账户已被封禁、如有疑问、请联系管理员！','consecutiveDays','3913441eipesT','userEntity','2196424bTXIOo','userBalanceService','log','sign','getUserByContact','error:\x20','UserStatusErrMsg','userRecharge','error','用户不存在！','defineProperty','updateUserPassword','registerVerifyEmailTitle','用户名或者邮箱已被注册！','registerIp','getUserOpenId','当前用户不存在！','createRandomUid','绑定微信失败、请联系管理员！','createUserFromContact','当前账户不存在！','metadata','visitor','lodash','password','PENDING','../../common/constants/verification.constant','当前绑定用户不存在！','createVerification','registerVerifyEmailFrom','toUpperCase','bindWx','ACTIVE','find','avatar','@default.com','当前邮箱已注册、请勿重复注册！','findOne','重置密码失败！','Injectable','Like','BAD_REQUEST','恭喜您绑定成功、后续可直接扫码登录了！','configVal','configEntity','../globalConfig/config.entity','getSuper','1154901rGVpMp','@nestjs/typeorm','校验邮箱注册:\x20成功\x20-\x20用户名:\x20','您的账户已被永久加入黑名单、如有疑问、请联系管理员！','getUserById','toString','BLACKLISTED','verifyUserRegisterByPhone','queryUserBalanceByIds','verifyUserPassword','maskIpAddress','Logger','save','phone','verifyUserCredentials','connection','super','queryAll','参数错误！','../../common/utils','queryUserBalance','checkUserStatus','createUserAndVerifycation','lastLoginIp','slice','Connection','decorate','ConfigEntity','HttpStatus','addBalanceToNewUser','isUsernameTaken','UserStatusEnum','update','3975712hwUhyN','__esModule','__param','saveRealNameInfo','length','UNAUTHORIZED','updateInfo','123456','当前密码错误！','\x20未被占用','createUserFromOpenId','DESC','InjectRepository','尝试发送邮件到:\x20','maskEmail','没有变更，无需更改！','5uMGMRp','reduce'];_0x3ac5=function(){return _0x4b8ee1;};return _0x3ac5();}const balance_constant_1=require('../../common/constants/balance.constant'),verification_constant_1=require(_0x307898(0x13b)),utils_1=require(_0x307898(0xb2)),mailer_service_1=require('../mailer/mailer.service'),common_1=require('@nestjs/common'),typeorm_1=require(_0x307898(0x151)),bcrypt=require(_0x307898(0xf4)),_=require(_0x307898(0x138)),typeorm_2=require('typeorm'),config_entity_1=require(_0x307898(0x14e)),userBalance_service_1=require(_0x307898(0x100)),user_constant_1=require(_0x307898(0xe0)),globalConfig_service_1=require('./../globalConfig/globalConfig.service'),verification_service_1=require('./../verification/verification.service'),user_entity_1=require('./user.entity');let UserService=class UserService{constructor(_0x4a41e3,_0xfac8f3,_0x3199e2,_0x2af6f1,_0x358ce9,_0x210135,_0x4393f5){const _0x5436b2=_0x307898;this[_0x5436b2(0x120)]=_0x4a41e3,this[_0x5436b2(0x15f)]=_0xfac8f3,this[_0x5436b2(0xd5)]=_0x3199e2,this[_0x5436b2(0xe6)]=_0x2af6f1,this[_0x5436b2(0x122)]=_0x358ce9,this[_0x5436b2(0xf0)]=_0x210135,this[_0x5436b2(0x14d)]=_0x4393f5;}async[_0x307898(0xb5)](_0x4414da,_0x49b4a7){const _0x10a1a8=_0x307898,{username:_0x49b36b,email:_0x213e57,password:_0x4a0826,client:client=0x0}=_0x4414da,_0x2810a9=[{'username':_0x49b36b},{'email':_0x213e57}],_0x421190=await this[_0x10a1a8(0x120)]['findOne']({'where':_0x2810a9});if(_0x421190&&_0x421190[_0x10a1a8(0xfb)]!==user_constant_1[_0x10a1a8(0xbe)][_0x10a1a8(0x13a)])throw new common_1[(_0x10a1a8(0x111))](_0x10a1a8(0x12e),common_1[_0x10a1a8(0xbb)][_0x10a1a8(0x14a)]);try{const _0x5c67b4=_[_0x10a1a8(0x107)](_0x4414da),_0x1f2b1c=bcrypt[_0x10a1a8(0xdc)](_0x4a0826,0xa),_0x52acd6=(0x0,utils_1['getClientIp'])(_0x49b4a7);_0x5c67b4[_0x10a1a8(0x139)]=_0x1f2b1c,_0x5c67b4[_0x10a1a8(0x12f)]=_0x52acd6,_0x5c67b4[_0x10a1a8(0xdb)]=client;let _0x3f2d5d;if(!_0x421190){const _0x5668f9=await this[_0x10a1a8(0xf0)][_0x10a1a8(0xee)]([_0x10a1a8(0xd4)]);_0x5c67b4[_0x10a1a8(0x143)]=_0x5668f9,_0x3f2d5d=await this[_0x10a1a8(0x120)][_0x10a1a8(0x15c)](_0x5c67b4);}else _0x3f2d5d=_0x421190;const _0x3d42f7=await this['configEntity'][_0x10a1a8(0x142)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x10a1a8(0x117),_0x10a1a8(0x115),_0x10a1a8(0x12d),'registerVerifyEmailDesc',_0x10a1a8(0x13e),_0x10a1a8(0x10a)])}}),_0x4f4aaa=_0x3d42f7[_0x10a1a8(0xd1)]((_0x48ff74,_0xcbc585)=>{const _0x1ef52c=_0x10a1a8;return _0x48ff74[_0xcbc585[_0x1ef52c(0x106)]]=_0xcbc585[_0x1ef52c(0x14c)],_0x48ff74;},{}),_0x9e1525=_0x4f4aaa['isVerifyEmail']?Number(_0x4f4aaa[_0x10a1a8(0x117)]):0x1;if(_0x9e1525){const _0x2b9a6f=_0x4f4aaa[_0x10a1a8(0x10a)]?Number(_0x4f4aaa['registerVerifyExpir']):0x1e*0x3c,_0x73188e=await this[_0x10a1a8(0xd5)][_0x10a1a8(0x13d)](_0x3f2d5d,verification_constant_1[_0x10a1a8(0xea)]['Registration'],_0x2b9a6f),{code:_0x301a55,email:_0x20c8d8,id:_0x47efac}=_0x73188e,{registerVerifyEmailFrom:_0xa644f2}=_0x4f4aaa;console[_0x10a1a8(0x123)](_0x10a1a8(0xfe),_0x4f4aaa),console[_0x10a1a8(0x123)](_0x10a1a8(0xcd)+_0x20c8d8);}else{const {id:_0x53d5c8}=_0x3f2d5d;await this[_0x10a1a8(0x11c)](_0x53d5c8,user_constant_1[_0x10a1a8(0xbe)]['ACTIVE']),await this['userBalanceService'][_0x10a1a8(0xbc)](_0x53d5c8);}return _0x3f2d5d;}catch(_0x4f3a6d){console['log'](_0x10a1a8(0x126),_0x4f3a6d);throw _0x4f3a6d;}}async[_0x307898(0x14f)](){const _0x3a6bdd=_0x307898,_0x4b6aa2=await this[_0x3a6bdd(0x120)][_0x3a6bdd(0x146)]({'where':{'role':_0x3a6bdd(0x160)}});return _0x4b6aa2;}async[_0x307898(0x15e)](_0x2fabcb){const _0x5d6eff=_0x307898,{username:_0x422a6d,password:_0x1c51a7,uid:uid=0x0,phone:_0x549282}=_0x2fabcb;let _0x1dbb1c=null;if(uid>0x0){_0x1dbb1c=await this[_0x5d6eff(0x120)][_0x5d6eff(0x146)]({'where':{'id':uid}});if(!_0x1dbb1c)throw new common_1[(_0x5d6eff(0x111))]('当前账户不存在！',common_1['HttpStatus'][_0x5d6eff(0x14a)]);if(!bcrypt['compareSync'](_0x1c51a7,_0x1dbb1c[_0x5d6eff(0x139)]))throw new common_1['HttpException'](_0x5d6eff(0xc8),common_1['HttpStatus']['BAD_REQUEST']);}if(_0x422a6d&&_0x1c51a7){const _0x7ac984=[{'username':_0x422a6d},{'email':_0x422a6d},{'phone':_0x422a6d}];_0x1dbb1c=await this[_0x5d6eff(0x120)]['findOne']({'where':_0x7ac984});if(!_0x1dbb1c)throw new common_1[(_0x5d6eff(0x111))](_0x5d6eff(0x135),common_1[_0x5d6eff(0xbb)][_0x5d6eff(0x14a)]);if(!bcrypt['compareSync'](_0x1c51a7,_0x1dbb1c[_0x5d6eff(0x139)]))throw new common_1[(_0x5d6eff(0x111))](_0x5d6eff(0xc8),common_1[_0x5d6eff(0xbb)][_0x5d6eff(0x14a)]);}if(!_0x1dbb1c)throw new common_1[(_0x5d6eff(0x111))](_0x5d6eff(0x135),common_1[_0x5d6eff(0xbb)][_0x5d6eff(0x14a)]);if(_0x1dbb1c[_0x5d6eff(0xfb)]!==user_constant_1['UserStatusEnum'][_0x5d6eff(0x141)])throw new common_1[(_0x5d6eff(0x111))](user_constant_1[_0x5d6eff(0x127)][_0x1dbb1c[_0x5d6eff(0xfb)]],common_1[_0x5d6eff(0xbb)]['BAD_REQUEST']);return _0x1dbb1c;}async[_0x307898(0x159)](_0x1559a0,_0x236d6c){const _0x5edca9=_0x307898,_0x58b8d0=await this[_0x5edca9(0x120)]['findOne']({'where':{'id':_0x1559a0}});return bcrypt[_0x5edca9(0xf3)](_0x236d6c,_0x58b8d0['password']);}async[_0x307898(0x11c)](_0x5a5b85,_0x455988){const _0xe8a792=_0x307898,_0x5a989f=await this[_0xe8a792(0x120)][_0xe8a792(0xbf)]({'id':_0x5a5b85},{'status':_0x455988});return _0x5a989f[_0xe8a792(0xdd)]>0x0;}async[_0x307898(0xed)](_0x5efc3a){const _0xca77b3=_0x307898,_0x23189c=await this[_0xca77b3(0x120)][_0xca77b3(0x146)]({'where':{'id':_0x5efc3a}});return _0x23189c[_0xca77b3(0xfb)];}async[_0x307898(0xd2)](_0x4f93fd){const _0x2ce9b7=_0x307898;return await this[_0x2ce9b7(0x120)][_0x2ce9b7(0x146)]({'where':{'id':_0x4f93fd}});}async[_0x307898(0x113)](_0x50f485){const _0x46793b=_0x307898;return await this[_0x46793b(0x120)][_0x46793b(0x146)]({'where':{'id':_0x50f485}});}async[_0x307898(0xb4)](_0xcc8c17){const _0x541d6f=_0x307898,{id:_0x53dec3,role:_0x39ee9d}=_0xcc8c17;if(_0x39ee9d===_0x541d6f(0x137))return!![];const _0x49b15f=await this['userEntity'][_0x541d6f(0x146)]({'where':{'id':_0x53dec3}});if(!_0x49b15f)throw new common_1['HttpException'](_0x541d6f(0xfa),common_1[_0x541d6f(0xbb)][_0x541d6f(0xc5)]);if(_0x49b15f[_0x541d6f(0xfb)]===user_constant_1[_0x541d6f(0xbe)][_0x541d6f(0x156)])throw new common_1[(_0x541d6f(0x111))](_0x541d6f(0x153),common_1[_0x541d6f(0xbb)][_0x541d6f(0x14a)]);if(_0x49b15f['status']===user_constant_1[_0x541d6f(0xbe)][_0x541d6f(0x10d)])throw new common_1[(_0x541d6f(0x111))](_0x541d6f(0x11d),common_1['HttpStatus']['BAD_REQUEST']);}async[_0x307898(0xef)](_0x420ea5){const _0x44e946=_0x307898,_0x246249=await this[_0x44e946(0x120)]['findOne']({'where':{'id':_0x420ea5},'select':[_0x44e946(0xe9),_0x44e946(0x143),'role',_0x44e946(0x109),_0x44e946(0x124),_0x44e946(0x119),_0x44e946(0x11e)]});if(!_0x246249)throw new common_1[(_0x44e946(0x111))](_0x44e946(0xfa),common_1[_0x44e946(0xbb)][_0x44e946(0xc5)]);_0x246249[_0x44e946(0xf7)]=!!(_0x246249===null||_0x246249===void 0x0?void 0x0:_0x246249[_0x44e946(0x119)]),delete _0x246249['openId'];const _0x477989=await this[_0x44e946(0x122)][_0x44e946(0xb3)](_0x420ea5),_0x5844c0=(_0x420ea5*0x7b+0x5f5e100)[_0x44e946(0x155)](0x24)[_0x44e946(0x13f)]()[_0x44e946(0xb7)](-0x6);return _0x246249['id']=_0x5844c0,{'userInfo':_0x246249,'userBalance':Object['assign']({},_0x477989)};}async[_0x307898(0x154)](_0x1b3b50){const _0x500b78=_0x307898;return await this[_0x500b78(0x120)][_0x500b78(0x146)]({'where':{'id':_0x1b3b50}});}async[_0x307898(0x130)](_0xd5b796){const _0x185c09=_0x307898;return await this['userEntity'][_0x185c09(0x146)]({'where':{'openId':_0xd5b796}});}async[_0x307898(0xc6)](_0x2f89e8,_0x34df5c){const _0x5234e4=_0x307898,{id:_0xf05047}=_0x34df5c[_0x5234e4(0x11b)],_0x39d06e=await this[_0x5234e4(0x120)][_0x5234e4(0x146)]({'where':{'id':_0xf05047}});if(!_0x39d06e)throw new common_1[(_0x5234e4(0x111))](_0x5234e4(0x131),common_1[_0x5234e4(0xbb)]['BAD_REQUEST']);if(_0x2f89e8[_0x5234e4(0xe9)]&&_0x39d06e[_0x5234e4(0xe9)]===_0x2f89e8['username'])throw new common_1[(_0x5234e4(0x111))](_0x5234e4(0xcf),common_1[_0x5234e4(0xbb)][_0x5234e4(0x14a)]);if(_0x2f89e8[_0x5234e4(0xe9)]){const _0x40f387=await this[_0x5234e4(0xbd)](_0x2f89e8['username'],_0xf05047);if(_0x40f387)throw new common_1['HttpException'](_0x5234e4(0x10c),common_1[_0x5234e4(0xbb)][_0x5234e4(0x14a)]);}const _0x104988=await this[_0x5234e4(0x120)][_0x5234e4(0xbf)]({'id':_0xf05047},_0x2f89e8);if(_0x104988[_0x5234e4(0xdd)]<=0x0)throw new common_1[(_0x5234e4(0x111))]('修改用户信息失败！',common_1['HttpStatus']['BAD_REQUEST']);return'修改用户信息成功！';}async[_0x307898(0xbd)](_0x488128,_0x412d6e){const _0x2b0842=_0x307898,_0x4354be={'username':_0x488128};_0x412d6e&&(_0x4354be['id']=(0x0,typeorm_2[_0x2b0842(0xeb)])(_0x412d6e));const _0x2efe21=await this[_0x2b0842(0x120)][_0x2b0842(0x146)]({'where':_0x4354be});return!!_0x2efe21;}async[_0x307898(0x12c)](_0x7259d,_0x12000c){const _0x52382e=_0x307898,_0x2221e7=bcrypt[_0x52382e(0xdc)](_0x12000c,0xa),_0x882860=await this[_0x52382e(0x120)][_0x52382e(0xbf)]({'id':_0x7259d},{'password':_0x2221e7});if(_0x882860['affected']<=0x0)throw new common_1[(_0x52382e(0x111))](_0x52382e(0xff),common_1['HttpStatus'][_0x52382e(0x14a)]);}async[_0x307898(0x128)](_0x461059){const _0x1133ba=_0x307898,{userId:_0x57b799,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x461059;await this[_0x1133ba(0x122)][_0x1133ba(0x110)](_0x57b799,{'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});const _0x3a33e1=await this['userBalanceService'][_0x1133ba(0xd3)]({'userId':_0x57b799,'rechargeType':balance_constant_1['RechargeType']['ADMIN_GIFT'],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'extent':''});return _0x3a33e1;}async[_0x307898(0x161)](_0x382614,_0x24774e){const _0x2eb13e=_0x307898,{page:page=0x1,size:size=0xa,username:_0xb2992b,email:_0x5af1b4,status:_0x1f36cb,keyword:_0x3226f3,phone:_0x2a211d}=_0x382614;let _0x53fb54={};_0xb2992b&&Object[_0x2eb13e(0xdf)](_0x53fb54,{'username':(0x0,typeorm_2['Like'])('%'+_0xb2992b+'%')}),_0x5af1b4&&Object['assign'](_0x53fb54,{'email':(0x0,typeorm_2[_0x2eb13e(0x149)])('%'+_0x5af1b4+'%')}),_0x2a211d&&Object[_0x2eb13e(0xdf)](_0x53fb54,{'phone':(0x0,typeorm_2['Like'])('%'+_0x2a211d+'%')}),_0x1f36cb&&Object[_0x2eb13e(0xdf)](_0x53fb54,{'status':_0x1f36cb});_0x3226f3&&(_0x53fb54=[{'username':(0x0,typeorm_2[_0x2eb13e(0x149)])('%'+_0x3226f3+'%')},{'email':(0x0,typeorm_2['Like'])('%'+_0x3226f3+'%')},{'phone':(0x0,typeorm_2[_0x2eb13e(0x149)])('%'+_0x3226f3+'%')}]);const [_0x3796eb,_0x8d651a]=await this[_0x2eb13e(0x120)][_0x2eb13e(0x104)]({'skip':(page-0x1)*size,'where':_0x53fb54,'take':size,'order':{'createdAt':_0x2eb13e(0xcb)},'cache':!![],'select':[_0x2eb13e(0xe9),'avatar',_0x2eb13e(0xec),_0x2eb13e(0x124),_0x2eb13e(0xfb),'id',_0x2eb13e(0x109),_0x2eb13e(0xf2),_0x2eb13e(0xb6),_0x2eb13e(0x15d),_0x2eb13e(0xe7),_0x2eb13e(0x10e)]}),_0x45cbae=_0x3796eb['map'](_0x26e77e=>_0x26e77e['id']),_0x40c612=await this[_0x2eb13e(0x122)][_0x2eb13e(0x158)](_0x45cbae);return _0x3796eb[_0x2eb13e(0xda)](_0x3b6b28=>_0x3b6b28['balanceInfo']=_0x40c612['find'](_0x4c3a16=>_0x4c3a16[_0x2eb13e(0xd9)]===_0x3b6b28['id'])),_0x24774e[_0x2eb13e(0x11b)][_0x2eb13e(0xec)]!==_0x2eb13e(0x160)&&_0x3796eb[_0x2eb13e(0xda)](_0x119f82=>_0x119f82[_0x2eb13e(0x109)]=(0x0,utils_1[_0x2eb13e(0xce)])(_0x119f82[_0x2eb13e(0x109)])),_0x24774e[_0x2eb13e(0x11b)][_0x2eb13e(0xec)]!==_0x2eb13e(0x160)&&_0x3796eb[_0x2eb13e(0xda)](_0x1b830f=>_0x1b830f['lastLoginIp']=(0x0,utils_1[_0x2eb13e(0x15a)])(_0x1b830f[_0x2eb13e(0xb6)])),_0x24774e[_0x2eb13e(0x11b)][_0x2eb13e(0xec)]!==_0x2eb13e(0x160)&&_0x3796eb[_0x2eb13e(0xda)](_0x3362d6=>_0x3362d6['phone']=(0x0,utils_1[_0x2eb13e(0x15a)])(_0x3362d6['phone'])),{'rows':_0x3796eb,'count':_0x8d651a};}async[_0x307898(0xf8)]({id:_0x410e85}){const _0x4a5559=_0x307898;return await this[_0x4a5559(0x120)][_0x4a5559(0x146)]({'where':{'id':_0x410e85},'select':[_0x4a5559(0xe9),'avatar',_0x4a5559(0xec),_0x4a5559(0x124),_0x4a5559(0xfb)]});}async['updateStatus'](_0x126893){const _0x32efd1=_0x307898,{id:_0x13584f,status:_0x39232e}=_0x126893,_0x3863e0=await this[_0x32efd1(0x120)][_0x32efd1(0x146)]({'where':{'id':_0x13584f}});if(!_0x3863e0)throw new common_1['HttpException'](_0x32efd1(0x12a),common_1[_0x32efd1(0xbb)][_0x32efd1(0x14a)]);if(_0x3863e0[_0x32efd1(0xec)]==='super')throw new common_1[(_0x32efd1(0x111))](_0x32efd1(0xfd),common_1[_0x32efd1(0xbb)][_0x32efd1(0x14a)]);if(_0x3863e0[_0x32efd1(0xec)]===_0x32efd1(0x160))throw new common_1[(_0x32efd1(0x111))](_0x32efd1(0xfd),common_1['HttpStatus'][_0x32efd1(0x14a)]);const _0x373712=await this[_0x32efd1(0x120)][_0x32efd1(0xbf)]({'id':_0x13584f},{'status':_0x39232e});if(_0x373712[_0x32efd1(0xdd)]<=0x0)throw new common_1[(_0x32efd1(0x111))](_0x32efd1(0x112),common_1[_0x32efd1(0xbb)][_0x32efd1(0x14a)]);return _0x32efd1(0x103);}async['resetUserPass'](_0x4ec54e){const _0x3f1ae4=_0x307898,{id:_0x347797}=_0x4ec54e,_0x32d027=await this['userEntity'][_0x3f1ae4(0x146)]({'where':{'id':_0x347797}});if(!_0x32d027)throw new common_1['HttpException'](_0x3f1ae4(0x12a),common_1[_0x3f1ae4(0xbb)][_0x3f1ae4(0x14a)]);const _0x5d3a2e=_0x3f1ae4(0xc7),_0x1235af=bcrypt[_0x3f1ae4(0xdc)](_0x5d3a2e,0xa),_0x2d99ae=await this[_0x3f1ae4(0x120)]['update']({'id':_0x347797},{'password':_0x1235af});if(_0x2d99ae[_0x3f1ae4(0xdd)]<=0x0)throw new common_1[(_0x3f1ae4(0x111))](_0x3f1ae4(0x147),common_1[_0x3f1ae4(0xbb)][_0x3f1ae4(0x14a)]);return _0x3f1ae4(0xe2)+_0x5d3a2e+_0x3f1ae4(0x10f);}async[_0x307898(0x11a)](_0x21e218,_0x5eea29){const _0x395449=_0x307898;return await this[_0x395449(0x120)]['update']({'id':_0x21e218},{'lastLoginIp':_0x5eea29});}async['getUserFromOpenId'](_0xc274a1,_0x1bcd8d){const _0x2bb010=_0x307898,_0x440caa=await this['userEntity'][_0x2bb010(0x146)]({'where':{'openId':_0xc274a1}});if(!_0x440caa){const _0x3ff283=await this[_0x2bb010(0xca)](_0xc274a1);return await this[_0x2bb010(0x122)][_0x2bb010(0xbc)](_0x3ff283['id']),_0x3ff283;}return _0x440caa;}async[_0x307898(0xca)](_0x2561da){const _0x3739a7=_0x307898,_0x4cde6f=await this[_0x3739a7(0xf0)][_0x3739a7(0xee)](['userDefautlAvatar']),_0x37e4d0={'avatar':_0x4cde6f,'username':'用户'+(0x0,utils_1[_0x3739a7(0x132)])(),'status':user_constant_1[_0x3739a7(0xbe)][_0x3739a7(0x141)],'sex':0x0,'email':(0x0,utils_1[_0x3739a7(0x132)])()+_0x3739a7(0x144),'openId':_0x2561da},_0x64e5ff=await this[_0x3739a7(0x120)][_0x3739a7(0x15c)](_0x37e4d0);return _0x64e5ff;}async[_0x307898(0x134)](_0x37e3e7){const _0x2136d7=_0x307898,{username:_0x5e9d83,email:_0x209361,phone:_0x374f21}=_0x37e3e7,_0x37866e=await this[_0x2136d7(0xf0)][_0x2136d7(0xee)](['userDefautlAvatar']),_0x4f8c80={'avatar':_0x37866e,'username':'用户'+(0x0,utils_1[_0x2136d7(0x132)])(),'status':user_constant_1['UserStatusEnum']['ACTIVE'],'sex':0x0};_0x5e9d83&&(_0x4f8c80[_0x2136d7(0xe9)]=_0x5e9d83);_0x209361&&(_0x4f8c80[_0x2136d7(0x109)]=_0x209361);_0x374f21&&(_0x4f8c80[_0x2136d7(0x15d)]=_0x374f21);const _0x461ab6=await this[_0x2136d7(0x120)]['save'](_0x4f8c80);return _0x461ab6;}async[_0x307898(0x125)](_0x5c8d16){const _0x5ee277=_0x307898,{username:_0x577371,email:_0x4c7d90,phone:_0x483ce2}=_0x5c8d16,_0x4aa8b9=[];return _0x577371&&_0x4aa8b9[_0x5ee277(0xe1)]({'username':_0x577371}),_0x4c7d90&&_0x4aa8b9[_0x5ee277(0xe1)]({'email':_0x4c7d90}),_0x483ce2&&_0x4aa8b9[_0x5ee277(0xe1)]({'phone':_0x483ce2}),await this['userEntity']['findOne']({'where':_0x4aa8b9});}async[_0x307898(0x140)](_0x159127,_0x528db4){const _0x3d0c92=_0x307898;try{const _0x14f98a=await this[_0x3d0c92(0x120)][_0x3d0c92(0x146)]({'where':{'id':_0x528db4}});if(!_0x14f98a)return{'status':![],'msg':_0x3d0c92(0x13c)};const _0x5497ab=await this['userEntity']['findOne']({'where':{'openId':_0x159127}});if(_0x5497ab)return{'status':![],'msg':'该微信已绑定其他账号！'};const _0x4d9620=await this[_0x3d0c92(0x120)]['update']({'id':_0x528db4},{'openId':_0x159127});if(_0x4d9620[_0x3d0c92(0xdd)]<=0x0)return{'status':![],'msg':_0x3d0c92(0x133)};return{'status':!![],'msg':_0x3d0c92(0x14b)};}catch(_0x4cc232){return{'status':![],'msg':'绑定微信失败、请联系管理员！'};}}async[_0x307898(0xd8)](_0x19e29e){const _0x46ac5e=_0x307898,_0x1f5a4b=await this[_0x46ac5e(0x120)]['findOne']({'where':{'id':_0x19e29e}});return _0x1f5a4b===null||_0x1f5a4b===void 0x0?void 0x0:_0x1f5a4b['openId'];}async[_0x307898(0x108)](_0x128a44){const _0x1d364a=_0x307898,{username:_0x45fcd1,phone:_0x2e0b65,email:_0x46cf12}=_0x128a44;if(_0x2e0b65){const _0x4e2797=await this[_0x1d364a(0x120)][_0x1d364a(0x146)]({'where':{'phone':_0x2e0b65}});if(_0x4e2797)return![];}if(_0x46cf12){const _0x2a5c1d=await this['userEntity']['findOne']({'where':{'email':_0x46cf12}});if(_0x2a5c1d)return![];}if(_0x45fcd1){const _0x10a353=await this[_0x1d364a(0x120)]['findOne']({'where':{'username':_0x45fcd1}});if(_0x10a353)return![];}if(!_0x2e0b65&&!_0x46cf12&&!_0x45fcd1)return![];return!![];}async[_0x307898(0x157)](_0x6942ba){const _0x25b9de=_0x307898,{username:_0x4412a1,password:_0x2ca9e5,phone:_0x31b33c,phoneCode:_0x24c766}=_0x6942ba,_0x128d90=await this[_0x25b9de(0x120)]['findOne']({'where':[{'username':_0x4412a1},{'phone':_0x31b33c}]});if(_0x128d90&&_0x128d90[_0x25b9de(0xe9)]===_0x4412a1)throw new common_1[(_0x25b9de(0x111))](_0x25b9de(0xf5),common_1[_0x25b9de(0xbb)][_0x25b9de(0x14a)]);if(_0x128d90&&_0x128d90[_0x25b9de(0x15d)]===_0x31b33c)throw new common_1['HttpException'](_0x25b9de(0xd7),common_1['HttpStatus'][_0x25b9de(0x14a)]);}async['verifyUserRegisterByEmail'](_0x4286e8){const _0x165f86=_0x307898,{username:_0x203ddf,email:_0x4555a5}=_0x4286e8;console['log']('校验邮箱注册:\x20开始\x20-\x20用户名:\x20'+_0x203ddf+_0x165f86(0xf1)+_0x4555a5);const _0x22a69f=await this[_0x165f86(0x120)][_0x165f86(0x146)]({'where':[{'username':_0x203ddf},{'email':_0x4555a5}]});if(_0x22a69f&&_0x22a69f['username']===_0x203ddf){console[_0x165f86(0x129)](_0x165f86(0x102)+_0x203ddf+_0x165f86(0xfc));throw new common_1['HttpException'](_0x165f86(0xf5),common_1[_0x165f86(0xbb)]['BAD_REQUEST']);}if(_0x22a69f&&_0x22a69f['email']===_0x4555a5){console[_0x165f86(0x129)]('校验失败:\x20邮箱\x20\x22'+_0x4555a5+'\x22\x20已被注册');throw new common_1[(_0x165f86(0x111))](_0x165f86(0x145),common_1[_0x165f86(0xbb)]['BAD_REQUEST']);}console['log'](_0x165f86(0x152)+_0x203ddf+',\x20邮箱:\x20'+_0x4555a5+_0x165f86(0xc9));}async[_0x307898(0xde)](_0x593cbe){const _0x3185bd=_0x307898;return await this[_0x3185bd(0x120)][_0x3185bd(0x15c)](_0x593cbe);}async[_0x307898(0xc3)](_0x4d78fe,_0xccc537,_0x9f9475){const _0x98b455=_0x307898,_0x501cdf=await this[_0x98b455(0x120)]['findOne']({'where':{'id':_0x4d78fe}});!_0x501cdf&&common_1[_0x98b455(0x15b)][_0x98b455(0x129)]('用户不存在');await this[_0x98b455(0x120)][_0x98b455(0xbf)]({'id':_0x4d78fe},{'realName':_0xccc537,'idCard':_0x9f9475});return;}async['updateUserPhone'](_0x56f3b3,_0x340eb8,_0x3ddf49,_0x9986fa){const _0x445235=_0x307898,_0x1bbf5b=await this[_0x445235(0x120)][_0x445235(0x146)]({'where':{'id':_0x56f3b3}}),_0x43220c=bcrypt['hashSync'](_0x9986fa,0xa);!_0x1bbf5b&&common_1[_0x445235(0x15b)]['error']('用户不存在');if(!_0x340eb8||!_0x3ddf49||!_0x43220c)throw new common_1[(_0x445235(0x111))](_0x445235(0x162),common_1[_0x445235(0xbb)][_0x445235(0x14a)]);await this[_0x445235(0x120)][_0x445235(0xbf)]({'id':_0x56f3b3},{'phone':_0x340eb8,'username':_0x3ddf49,'password':_0x43220c});return;}};UserService=__decorate([(0x0,common_1[_0x307898(0x148)])(),__param(0x0,(0x0,typeorm_1[_0x307898(0xcc)])(user_entity_1[_0x307898(0xe5)])),__param(0x6,(0x0,typeorm_1[_0x307898(0xcc)])(config_entity_1[_0x307898(0xba)])),__metadata('design:paramtypes',[typeorm_2[_0x307898(0x105)],typeorm_2[_0x307898(0xb8)],verification_service_1[_0x307898(0x10b)],mailer_service_1['MailerService'],userBalance_service_1[_0x307898(0xe4)],globalConfig_service_1[_0x307898(0xd6)],typeorm_2[_0x307898(0x105)]])],UserService),exports[_0x307898(0x114)]=UserService;