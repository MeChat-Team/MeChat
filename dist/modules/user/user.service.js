'use strict';const _0x12ab42=_0x35a2;(function(_0x1146fd,_0x24460f){const _0x2163ef=_0x35a2,_0x1d2c90=_0x1146fd();while(!![]){try{const _0x56a26b=-parseInt(_0x2163ef(0x283))/0x1+-parseInt(_0x2163ef(0x278))/0x2+-parseInt(_0x2163ef(0x1f4))/0x3*(-parseInt(_0x2163ef(0x240))/0x4)+-parseInt(_0x2163ef(0x212))/0x5+-parseInt(_0x2163ef(0x23e))/0x6+-parseInt(_0x2163ef(0x213))/0x7+parseInt(_0x2163ef(0x20d))/0x8;if(_0x56a26b===_0x24460f)break;else _0x1d2c90['push'](_0x1d2c90['shift']());}catch(_0x29b8aa){_0x1d2c90['push'](_0x1d2c90['shift']());}}}(_0x3c29,0xc6e3a));function _0x35a2(_0x3e0236,_0x2cd285){const _0x3c291a=_0x3c29();return _0x35a2=function(_0x35a26b,_0x2af8af){_0x35a26b=_0x35a26b-0x1ed;let _0x5cee5c=_0x3c291a[_0x35a26b];return _0x5cee5c;},_0x35a2(_0x3e0236,_0x2cd285);}var __decorate=this&&this[_0x12ab42(0x226)]||function(_0x403b82,_0x4fbec1,_0x47e6d0,_0x479385){const _0xb09f1b=_0x12ab42;var _0x356bc6=arguments[_0xb09f1b(0x262)],_0x4b65e9=_0x356bc6<0x3?_0x4fbec1:_0x479385===null?_0x479385=Object['getOwnPropertyDescriptor'](_0x4fbec1,_0x47e6d0):_0x479385,_0x3fdaf1;if(typeof Reflect===_0xb09f1b(0x233)&&typeof Reflect[_0xb09f1b(0x288)]===_0xb09f1b(0x1f9))_0x4b65e9=Reflect[_0xb09f1b(0x288)](_0x403b82,_0x4fbec1,_0x47e6d0,_0x479385);else{for(var _0x1277b5=_0x403b82[_0xb09f1b(0x262)]-0x1;_0x1277b5>=0x0;_0x1277b5--)if(_0x3fdaf1=_0x403b82[_0x1277b5])_0x4b65e9=(_0x356bc6<0x3?_0x3fdaf1(_0x4b65e9):_0x356bc6>0x3?_0x3fdaf1(_0x4fbec1,_0x47e6d0,_0x4b65e9):_0x3fdaf1(_0x4fbec1,_0x47e6d0))||_0x4b65e9;}return _0x356bc6>0x3&&_0x4b65e9&&Object[_0xb09f1b(0x249)](_0x4fbec1,_0x47e6d0,_0x4b65e9),_0x4b65e9;},__metadata=this&&this[_0x12ab42(0x24a)]||function(_0x1db551,_0x9f60c6){const _0x5e5bdb=_0x12ab42;if(typeof Reflect===_0x5e5bdb(0x233)&&typeof Reflect[_0x5e5bdb(0x1f5)]==='function')return Reflect['metadata'](_0x1db551,_0x9f60c6);},__param=this&&this[_0x12ab42(0x243)]||function(_0xc36b0,_0x23f30a){return function(_0x5c6673,_0x14bbb7){_0x23f30a(_0x5c6673,_0x14bbb7,_0xc36b0);};};function _0x3c29(){const _0x1dd391=['createVerification','userBalanceService','verifyUserPassword','user','ConfigEntity','getOpenIdByUserId','Not','超级管理员不可被操作！','configMap:\x20','修改用户状态成功！','UserService','phone','getUserOpenId','super','password','9vrakqN','metadata','当前手机号已注册、请勿重复注册！','当前邮箱已注册、请勿重复注册！','updateStatus','function','queryUserBalance','maskEmail','findAndCount','openId','getClientIp','toString',']成功!','maskIpAddress','当前用户不存在！','hashSync','queryOne','registerVerifyEmailDesc','username','typeorm','save','avatar','Like','@default.com','visitor','28401208XTqoph','../../common/constants/verification.constant','userId','isVerifyEmail','registerVerifyEmailFrom','6060340gdNjLS','8512119IjZwMU','getUserFromOpenId','./../verification/verification.service','updateUserPassword','\x20未被占用','bindWx','email','createUserFromOpenId','mailerService','addBalanceToUser','sign','createdAt','addBalanceToNewUser','lodash','saveRealNameInfo','用户名已存在、请更换用户名！','createUserFromContact','error:\x20','@nestjs/typeorm','__decorate','用户名或者邮箱已被注册！','find','registerVerifyEmailTitle','当前账户不存在！','当前用户信息失效、请重新登录！','update','userDefautlAvatar','InjectRepository','没有变更，无需更改！','forEach','error','registerBaseUrl','object','push','idCard','queryAll','verifyUserRegister','queryUserInfoById','Repository','ACTIVE','verifyUserRegisterByPhone','verificationService','Logger','2810922IqLqVc','UserStatusEnum','1897404nOZPTB','修改用户信息成功！','参数错误！','__param','MailerService','registerIp','123456','updateUserStatus','__esModule','defineProperty','__metadata','getUserStatus','重置密码失败！','UserEntity','registerVerifyExpir','globalConfigService','configVal','Injectable','当前密码错误！','../globalConfig/config.entity','ADMIN_GIFT','isUsernameTaken','UserBalanceService',',\x20邮箱:\x20','VerificationEnum','status','affected','您的账户已被永久加入黑名单、如有疑问、请联系管理员！','role','修改密码失败、请重新试试吧。','design:paramtypes','尝试发送邮件到:\x20','cloneDeep','VerificationService','length','findOne','balanceInfo','verifyUserCredentials','getUserById','HttpException','compareSync','lastLoginIp','../mailer/mailer.service','RechargeType','../userBalance/userBalance.service','您的账户已被封禁、如有疑问、请联系管理员！','getConfigs','log','getSuper','该微信已绑定其他账号！','getUserInfo','../../common/constants/balance.constant','./../../common/constants/user.constant','isBindWx','用户不存在！','HttpStatus','1489476sTHXEP','绑定微信失败、请联系管理员！','assign','configKey','savaLoginIp','./../globalConfig/globalConfig.service','BAD_REQUEST','校验邮箱注册:\x20开始\x20-\x20用户名:\x20','userEntity','client','UserStatusErrMsg','517244ovgnsQ','slice','createRandomUid','updateInfo','LOCKED','decorate','Connection','configEntity','resetUserPass'];_0x3c29=function(){return _0x1dd391;};return _0x3c29();}Object[_0x12ab42(0x249)](exports,_0x12ab42(0x248),{'value':!![]}),exports[_0x12ab42(0x1ef)]=void 0x0;const balance_constant_1=require(_0x12ab42(0x273)),verification_constant_1=require(_0x12ab42(0x20e)),utils_1=require('../../common/utils'),mailer_service_1=require(_0x12ab42(0x26a)),common_1=require('@nestjs/common'),typeorm_1=require(_0x12ab42(0x225)),bcrypt=require('bcryptjs'),_=require(_0x12ab42(0x220)),typeorm_2=require(_0x12ab42(0x207)),config_entity_1=require(_0x12ab42(0x253)),userBalance_service_1=require(_0x12ab42(0x26c)),user_constant_1=require(_0x12ab42(0x274)),globalConfig_service_1=require(_0x12ab42(0x27d)),verification_service_1=require(_0x12ab42(0x215)),user_entity_1=require('./user.entity');let UserService=class UserService{constructor(_0x272740,_0x599b4b,_0x3fa06b,_0xd97256,_0x16915f,_0x5ace4b,_0x415ae6){const _0x11064c=_0x12ab42;this[_0x11064c(0x280)]=_0x272740,this['connection']=_0x599b4b,this[_0x11064c(0x23c)]=_0x3fa06b,this[_0x11064c(0x21b)]=_0xd97256,this[_0x11064c(0x28d)]=_0x16915f,this[_0x11064c(0x24f)]=_0x5ace4b,this[_0x11064c(0x28a)]=_0x415ae6;}async['createUserAndVerifycation'](_0x3ecc8b,_0x5a5961){const _0x18e817=_0x12ab42,{username:_0x3e2124,email:_0x58b6eb,password:_0x2f9dc6,client:client=0x0}=_0x3ecc8b,_0x379193=[{'username':_0x3e2124},{'email':_0x58b6eb}],_0x292557=await this['userEntity'][_0x18e817(0x263)]({'where':_0x379193});if(_0x292557&&_0x292557['status']!==user_constant_1[_0x18e817(0x23f)]['PENDING'])throw new common_1[(_0x18e817(0x267))](_0x18e817(0x227),common_1[_0x18e817(0x277)][_0x18e817(0x27e)]);try{const _0x414bcc=_[_0x18e817(0x260)](_0x3ecc8b),_0x183eaa=bcrypt[_0x18e817(0x203)](_0x2f9dc6,0xa),_0x2c6712=(0x0,utils_1[_0x18e817(0x1fe)])(_0x5a5961);_0x414bcc[_0x18e817(0x1f3)]=_0x183eaa,_0x414bcc[_0x18e817(0x245)]=_0x2c6712,_0x414bcc[_0x18e817(0x281)]=client;let _0x403b34;if(!_0x292557){const _0xa0dbf0=await this[_0x18e817(0x24f)][_0x18e817(0x26e)](['userDefautlAvatar']);_0x414bcc[_0x18e817(0x209)]=_0xa0dbf0,_0x403b34=await this['userEntity'][_0x18e817(0x208)](_0x414bcc);}else _0x403b34=_0x292557;const _0x135dc0=await this['configEntity'][_0x18e817(0x228)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x18e817(0x210),_0x18e817(0x232),_0x18e817(0x229),_0x18e817(0x205),_0x18e817(0x211),_0x18e817(0x24e)])}}),_0xae71cb=_0x135dc0['reduce']((_0x4f3d2f,_0x7a6caf)=>{const _0x4de98d=_0x18e817;return _0x4f3d2f[_0x7a6caf[_0x4de98d(0x27b)]]=_0x7a6caf[_0x4de98d(0x250)],_0x4f3d2f;},{}),_0x1dd4e6=_0xae71cb['isVerifyEmail']?Number(_0xae71cb[_0x18e817(0x210)]):0x1;if(_0x1dd4e6){const _0x12fa70=_0xae71cb['registerVerifyExpir']?Number(_0xae71cb[_0x18e817(0x24e)]):0x1e*0x3c,_0x290752=await this['verificationService'][_0x18e817(0x28c)](_0x403b34,verification_constant_1[_0x18e817(0x258)]['Registration'],_0x12fa70),{code:_0x307d5c,email:_0x4c5b28,id:_0x1b6065}=_0x290752,{registerVerifyEmailFrom:_0x380a1f}=_0xae71cb;console['log'](_0x18e817(0x1ed),_0xae71cb),console[_0x18e817(0x26f)](_0x18e817(0x25f)+_0x4c5b28);}else{const {id:_0x39f937}=_0x403b34;await this[_0x18e817(0x247)](_0x39f937,user_constant_1['UserStatusEnum'][_0x18e817(0x23a)]),await this[_0x18e817(0x28d)][_0x18e817(0x21f)](_0x39f937);}return _0x403b34;}catch(_0x33408a){console['log'](_0x18e817(0x224),_0x33408a);throw _0x33408a;}}async[_0x12ab42(0x270)](){const _0x446927=_0x12ab42,_0xc8f654=await this[_0x446927(0x280)][_0x446927(0x263)]({'where':{'role':_0x446927(0x1f2)}});return _0xc8f654;}async[_0x12ab42(0x265)](_0x5e2ad6){const _0x5d1e25=_0x12ab42,{username:_0x3e652a,password:_0xd4b398,uid:uid=0x0,phone:_0x286700}=_0x5e2ad6;let _0x50347e=null;if(uid>0x0){_0x50347e=await this['userEntity'][_0x5d1e25(0x263)]({'where':{'id':uid}});if(!_0x50347e)throw new common_1[(_0x5d1e25(0x267))](_0x5d1e25(0x22a),common_1[_0x5d1e25(0x277)]['BAD_REQUEST']);if(!bcrypt[_0x5d1e25(0x268)](_0xd4b398,_0x50347e[_0x5d1e25(0x1f3)]))throw new common_1['HttpException']('当前密码错误！',common_1['HttpStatus']['BAD_REQUEST']);}if(_0x3e652a&&_0xd4b398){const _0x2c18b7=[{'username':_0x3e652a},{'email':_0x3e652a},{'phone':_0x3e652a}];_0x50347e=await this[_0x5d1e25(0x280)][_0x5d1e25(0x263)]({'where':_0x2c18b7});if(!_0x50347e)throw new common_1[(_0x5d1e25(0x267))](_0x5d1e25(0x22a),common_1[_0x5d1e25(0x277)][_0x5d1e25(0x27e)]);if(!bcrypt[_0x5d1e25(0x268)](_0xd4b398,_0x50347e['password']))throw new common_1[(_0x5d1e25(0x267))](_0x5d1e25(0x252),common_1[_0x5d1e25(0x277)][_0x5d1e25(0x27e)]);}if(!_0x50347e)throw new common_1[(_0x5d1e25(0x267))]('当前账户不存在！',common_1[_0x5d1e25(0x277)][_0x5d1e25(0x27e)]);if(_0x50347e[_0x5d1e25(0x259)]!==user_constant_1['UserStatusEnum'][_0x5d1e25(0x23a)])throw new common_1['HttpException'](user_constant_1[_0x5d1e25(0x282)][_0x50347e[_0x5d1e25(0x259)]],common_1[_0x5d1e25(0x277)][_0x5d1e25(0x27e)]);return _0x50347e;}async[_0x12ab42(0x28e)](_0x5afb85,_0x256ce3){const _0x373568=_0x12ab42,_0x1af0bf=await this[_0x373568(0x280)]['findOne']({'where':{'id':_0x5afb85}});return bcrypt['compareSync'](_0x256ce3,_0x1af0bf[_0x373568(0x1f3)]);}async['updateUserStatus'](_0x127d94,_0x1dcbce){const _0x3c5c32=_0x12ab42,_0x1b516d=await this[_0x3c5c32(0x280)][_0x3c5c32(0x22c)]({'id':_0x127d94},{'status':_0x1dcbce});return _0x1b516d[_0x3c5c32(0x25a)]>0x0;}async[_0x12ab42(0x24b)](_0x9051e6){const _0x1e511f=_0x12ab42,_0x5d084d=await this['userEntity'][_0x1e511f(0x263)]({'where':{'id':_0x9051e6}});return _0x5d084d[_0x1e511f(0x259)];}async[_0x12ab42(0x238)](_0x24b55e){const _0x161b46=_0x12ab42;return await this['userEntity'][_0x161b46(0x263)]({'where':{'id':_0x24b55e}});}async['queryOneUserInfo'](_0x40a55c){const _0x132998=_0x12ab42;return await this[_0x132998(0x280)][_0x132998(0x263)]({'where':{'id':_0x40a55c}});}async['checkUserStatus'](_0x5eb07d){const _0xc2ead0=_0x12ab42,{id:_0x13f142,role:_0x4930ac}=_0x5eb07d;if(_0x4930ac===_0xc2ead0(0x20c))return!![];const _0x45a5aa=await this['userEntity'][_0xc2ead0(0x263)]({'where':{'id':_0x13f142}});if(!_0x45a5aa)throw new common_1[(_0xc2ead0(0x267))](_0xc2ead0(0x22b),common_1[_0xc2ead0(0x277)]['UNAUTHORIZED']);if(_0x45a5aa[_0xc2ead0(0x259)]===user_constant_1[_0xc2ead0(0x23f)]['BLACKLISTED'])throw new common_1[(_0xc2ead0(0x267))](_0xc2ead0(0x25b),common_1[_0xc2ead0(0x277)][_0xc2ead0(0x27e)]);if(_0x45a5aa['status']===user_constant_1['UserStatusEnum'][_0xc2ead0(0x287)])throw new common_1[(_0xc2ead0(0x267))](_0xc2ead0(0x26d),common_1[_0xc2ead0(0x277)][_0xc2ead0(0x27e)]);}async[_0x12ab42(0x272)](_0x2d95c8){const _0x373f0a=_0x12ab42,_0x4bf3b2=await this[_0x373f0a(0x280)]['findOne']({'where':{'id':_0x2d95c8},'select':['username','avatar',_0x373f0a(0x25c),_0x373f0a(0x219),_0x373f0a(0x21d),_0x373f0a(0x1fd),'consecutiveDays']});if(!_0x4bf3b2)throw new common_1[(_0x373f0a(0x267))]('当前用户信息失效、请重新登录！',common_1[_0x373f0a(0x277)]['UNAUTHORIZED']);_0x4bf3b2[_0x373f0a(0x275)]=!!(_0x4bf3b2===null||_0x4bf3b2===void 0x0?void 0x0:_0x4bf3b2[_0x373f0a(0x1fd)]),delete _0x4bf3b2['openId'];const _0x4c9b03=await this['userBalanceService'][_0x373f0a(0x1fa)](_0x2d95c8),_0x5b618c=(_0x2d95c8*0x7b+0x5f5e100)[_0x373f0a(0x1ff)](0x24)['toUpperCase']()[_0x373f0a(0x284)](-0x6);return _0x4bf3b2['id']=_0x5b618c,{'userInfo':_0x4bf3b2,'userBalance':Object[_0x373f0a(0x27a)]({},_0x4c9b03)};}async[_0x12ab42(0x266)](_0x57569a){const _0x236224=_0x12ab42;return await this[_0x236224(0x280)][_0x236224(0x263)]({'where':{'id':_0x57569a}});}async[_0x12ab42(0x1f1)](_0xc0a19f){const _0x5ec9bf=_0x12ab42;return await this[_0x5ec9bf(0x280)][_0x5ec9bf(0x263)]({'where':{'openId':_0xc0a19f}});}async[_0x12ab42(0x286)](_0x502f3a,_0x28017b){const _0x4263b7=_0x12ab42,{id:_0x26ddac}=_0x28017b[_0x4263b7(0x28f)],_0x3ba32e=await this[_0x4263b7(0x280)][_0x4263b7(0x263)]({'where':{'id':_0x26ddac}});if(!_0x3ba32e)throw new common_1[(_0x4263b7(0x267))](_0x4263b7(0x202),common_1[_0x4263b7(0x277)][_0x4263b7(0x27e)]);if(_0x502f3a['username']&&_0x3ba32e[_0x4263b7(0x206)]===_0x502f3a['username'])throw new common_1[(_0x4263b7(0x267))](_0x4263b7(0x22f),common_1[_0x4263b7(0x277)][_0x4263b7(0x27e)]);if(_0x502f3a['username']){const _0x32eda0=await this['isUsernameTaken'](_0x502f3a['username'],_0x26ddac);if(_0x32eda0)throw new common_1[(_0x4263b7(0x267))]('用户名已存在！',common_1[_0x4263b7(0x277)]['BAD_REQUEST']);}const _0x125a25=await this[_0x4263b7(0x280)][_0x4263b7(0x22c)]({'id':_0x26ddac},_0x502f3a);if(_0x125a25[_0x4263b7(0x25a)]<=0x0)throw new common_1[(_0x4263b7(0x267))]('修改用户信息失败！',common_1['HttpStatus'][_0x4263b7(0x27e)]);return _0x4263b7(0x241);}async[_0x12ab42(0x255)](_0x491f3c,_0x2373ed){const _0x1f36f1=_0x12ab42,_0x43136d={'username':_0x491f3c};_0x2373ed&&(_0x43136d['id']=(0x0,typeorm_2[_0x1f36f1(0x292)])(_0x2373ed));const _0x2f10b0=await this[_0x1f36f1(0x280)][_0x1f36f1(0x263)]({'where':_0x43136d});return!!_0x2f10b0;}async[_0x12ab42(0x216)](_0x1dc0c0,_0x55c45a){const _0x69ec13=_0x12ab42,_0x130c53=bcrypt[_0x69ec13(0x203)](_0x55c45a,0xa),_0x244588=await this[_0x69ec13(0x280)][_0x69ec13(0x22c)]({'id':_0x1dc0c0},{'password':_0x130c53});if(_0x244588[_0x69ec13(0x25a)]<=0x0)throw new common_1[(_0x69ec13(0x267))](_0x69ec13(0x25d),common_1[_0x69ec13(0x277)]['BAD_REQUEST']);}async['userRecharge'](_0x27b870){const _0x4026e7=_0x12ab42,{userId:_0x402708,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x27b870;await this[_0x4026e7(0x28d)][_0x4026e7(0x21c)](_0x402708,{'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});const _0x27ad41=await this['userBalanceService']['saveRecordRechargeLog']({'userId':_0x402708,'rechargeType':balance_constant_1[_0x4026e7(0x26b)][_0x4026e7(0x254)],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'extent':''});return _0x27ad41;}async[_0x12ab42(0x236)](_0x2ce4c1,_0x8e36e1){const _0x5a5be4=_0x12ab42,{page:page=0x1,size:size=0xa,username:_0x401b0d,email:_0x53c3f6,status:_0x2a218f,keyword:_0x47cc1d,phone:_0x1804c9}=_0x2ce4c1;let _0x219366={};_0x401b0d&&Object[_0x5a5be4(0x27a)](_0x219366,{'username':(0x0,typeorm_2[_0x5a5be4(0x20a)])('%'+_0x401b0d+'%')}),_0x53c3f6&&Object[_0x5a5be4(0x27a)](_0x219366,{'email':(0x0,typeorm_2[_0x5a5be4(0x20a)])('%'+_0x53c3f6+'%')}),_0x1804c9&&Object[_0x5a5be4(0x27a)](_0x219366,{'phone':(0x0,typeorm_2[_0x5a5be4(0x20a)])('%'+_0x1804c9+'%')}),_0x2a218f&&Object[_0x5a5be4(0x27a)](_0x219366,{'status':_0x2a218f});_0x47cc1d&&(_0x219366=[{'username':(0x0,typeorm_2[_0x5a5be4(0x20a)])('%'+_0x47cc1d+'%')},{'email':(0x0,typeorm_2[_0x5a5be4(0x20a)])('%'+_0x47cc1d+'%')},{'phone':(0x0,typeorm_2[_0x5a5be4(0x20a)])('%'+_0x47cc1d+'%')}]);const [_0x2e913d,_0x33c9d1]=await this[_0x5a5be4(0x280)][_0x5a5be4(0x1fc)]({'skip':(page-0x1)*size,'where':_0x219366,'take':size,'order':{'createdAt':'DESC'},'cache':!![],'select':[_0x5a5be4(0x206),'avatar','role','sign',_0x5a5be4(0x259),'id',_0x5a5be4(0x219),_0x5a5be4(0x21e),'lastLoginIp',_0x5a5be4(0x1f0),'realName',_0x5a5be4(0x235)]}),_0x1ab196=_0x2e913d['map'](_0x5816d8=>_0x5816d8['id']),_0xf2ccda=await this[_0x5a5be4(0x28d)]['queryUserBalanceByIds'](_0x1ab196);return _0x2e913d[_0x5a5be4(0x230)](_0x54b238=>_0x54b238[_0x5a5be4(0x264)]=_0xf2ccda[_0x5a5be4(0x228)](_0x1e8c05=>_0x1e8c05[_0x5a5be4(0x20f)]===_0x54b238['id'])),_0x8e36e1[_0x5a5be4(0x28f)][_0x5a5be4(0x25c)]!==_0x5a5be4(0x1f2)&&_0x2e913d[_0x5a5be4(0x230)](_0x5ca466=>_0x5ca466[_0x5a5be4(0x219)]=(0x0,utils_1[_0x5a5be4(0x1fb)])(_0x5ca466[_0x5a5be4(0x219)])),_0x8e36e1['user'][_0x5a5be4(0x25c)]!==_0x5a5be4(0x1f2)&&_0x2e913d[_0x5a5be4(0x230)](_0x404d38=>_0x404d38[_0x5a5be4(0x269)]=(0x0,utils_1[_0x5a5be4(0x201)])(_0x404d38['lastLoginIp'])),_0x8e36e1[_0x5a5be4(0x28f)][_0x5a5be4(0x25c)]!=='super'&&_0x2e913d['forEach'](_0x1f17ef=>_0x1f17ef[_0x5a5be4(0x1f0)]=(0x0,utils_1[_0x5a5be4(0x201)])(_0x1f17ef[_0x5a5be4(0x1f0)])),{'rows':_0x2e913d,'count':_0x33c9d1};}async[_0x12ab42(0x204)]({id:_0x455a03}){const _0x16dda7=_0x12ab42;return await this[_0x16dda7(0x280)]['findOne']({'where':{'id':_0x455a03},'select':[_0x16dda7(0x206),'avatar','role',_0x16dda7(0x21d),_0x16dda7(0x259)]});}async[_0x12ab42(0x1f8)](_0x3ed15a){const _0x2f2d97=_0x12ab42,{id:_0x496c68,status:_0x176e53}=_0x3ed15a,_0x3a780f=await this[_0x2f2d97(0x280)][_0x2f2d97(0x263)]({'where':{'id':_0x496c68}});if(!_0x3a780f)throw new common_1['HttpException'](_0x2f2d97(0x276),common_1[_0x2f2d97(0x277)][_0x2f2d97(0x27e)]);if(_0x3a780f['role']==='super')throw new common_1['HttpException'](_0x2f2d97(0x293),common_1[_0x2f2d97(0x277)][_0x2f2d97(0x27e)]);if(_0x3a780f[_0x2f2d97(0x25c)]===_0x2f2d97(0x1f2))throw new common_1[(_0x2f2d97(0x267))]('超级管理员不可被操作！',common_1[_0x2f2d97(0x277)]['BAD_REQUEST']);const _0x44d4b4=await this['userEntity']['update']({'id':_0x496c68},{'status':_0x176e53});if(_0x44d4b4['affected']<=0x0)throw new common_1['HttpException']('修改用户状态失败！',common_1[_0x2f2d97(0x277)]['BAD_REQUEST']);return _0x2f2d97(0x1ee);}async[_0x12ab42(0x28b)](_0x14279a){const _0x1aad7d=_0x12ab42,{id:_0x251aa0}=_0x14279a,_0x26c97f=await this[_0x1aad7d(0x280)]['findOne']({'where':{'id':_0x251aa0}});if(!_0x26c97f)throw new common_1[(_0x1aad7d(0x267))](_0x1aad7d(0x276),common_1['HttpStatus'][_0x1aad7d(0x27e)]);const _0x453f16=_0x1aad7d(0x246),_0x3abfda=bcrypt[_0x1aad7d(0x203)](_0x453f16,0xa),_0x542cce=await this['userEntity'][_0x1aad7d(0x22c)]({'id':_0x251aa0},{'password':_0x3abfda});if(_0x542cce[_0x1aad7d(0x25a)]<=0x0)throw new common_1['HttpException'](_0x1aad7d(0x24c),common_1[_0x1aad7d(0x277)][_0x1aad7d(0x27e)]);return'密码重置为['+_0x453f16+_0x1aad7d(0x200);}async[_0x12ab42(0x27c)](_0x519074,_0x5095e2){const _0x3263a1=_0x12ab42;return await this[_0x3263a1(0x280)][_0x3263a1(0x22c)]({'id':_0x519074},{'lastLoginIp':_0x5095e2});}async[_0x12ab42(0x214)](_0x39c696,_0x14c58f){const _0x2f0988=_0x12ab42,_0xad4d03=await this['userEntity'][_0x2f0988(0x263)]({'where':{'openId':_0x39c696}});if(!_0xad4d03){const _0x1b5cf8=await this[_0x2f0988(0x21a)](_0x39c696);return await this[_0x2f0988(0x28d)]['addBalanceToNewUser'](_0x1b5cf8['id']),_0x1b5cf8;}return _0xad4d03;}async[_0x12ab42(0x21a)](_0x2e8c6f){const _0xc8a384=_0x12ab42,_0x39c82b=await this['globalConfigService'][_0xc8a384(0x26e)]([_0xc8a384(0x22d)]),_0x3a8f11={'avatar':_0x39c82b,'username':'用户'+(0x0,utils_1[_0xc8a384(0x285)])(),'status':user_constant_1['UserStatusEnum']['ACTIVE'],'sex':0x0,'email':(0x0,utils_1[_0xc8a384(0x285)])()+_0xc8a384(0x20b),'openId':_0x2e8c6f},_0xcdea23=await this[_0xc8a384(0x280)][_0xc8a384(0x208)](_0x3a8f11);return _0xcdea23;}async[_0x12ab42(0x223)](_0x376bd0){const _0x2a5d3=_0x12ab42,{username:_0xbb2c51,email:_0x5cee12,phone:_0x25075d}=_0x376bd0,_0x4fc44d=await this[_0x2a5d3(0x24f)][_0x2a5d3(0x26e)]([_0x2a5d3(0x22d)]),_0x253f0f={'avatar':_0x4fc44d,'username':'用户'+(0x0,utils_1[_0x2a5d3(0x285)])(),'status':user_constant_1['UserStatusEnum']['ACTIVE'],'sex':0x0};_0xbb2c51&&(_0x253f0f['username']=_0xbb2c51);_0x5cee12&&(_0x253f0f['email']=_0x5cee12);_0x25075d&&(_0x253f0f[_0x2a5d3(0x1f0)]=_0x25075d);const _0x3e850d=await this[_0x2a5d3(0x280)]['save'](_0x253f0f);return _0x3e850d;}async['getUserByContact'](_0x481546){const _0xdc7274=_0x12ab42,{username:_0x5bb86b,email:_0x3868d9,phone:_0x23a5a2}=_0x481546,_0x35d9b8=[];return _0x5bb86b&&_0x35d9b8['push']({'username':_0x5bb86b}),_0x3868d9&&_0x35d9b8[_0xdc7274(0x234)]({'email':_0x3868d9}),_0x23a5a2&&_0x35d9b8[_0xdc7274(0x234)]({'phone':_0x23a5a2}),await this[_0xdc7274(0x280)]['findOne']({'where':_0x35d9b8});}async[_0x12ab42(0x218)](_0x1e539f,_0x359456){const _0x586484=_0x12ab42;try{const _0x1694bf=await this['userEntity'][_0x586484(0x263)]({'where':{'id':_0x359456}});if(!_0x1694bf)return{'status':![],'msg':'当前绑定用户不存在！'};const _0x5d6408=await this[_0x586484(0x280)][_0x586484(0x263)]({'where':{'openId':_0x1e539f}});if(_0x5d6408)return{'status':![],'msg':_0x586484(0x271)};const _0x31e439=await this[_0x586484(0x280)][_0x586484(0x22c)]({'id':_0x359456},{'openId':_0x1e539f});if(_0x31e439['affected']<=0x0)return{'status':![],'msg':_0x586484(0x279)};return{'status':!![],'msg':'恭喜您绑定成功、后续可直接扫码登录了！'};}catch(_0x366eb0){return{'status':![],'msg':'绑定微信失败、请联系管理员！'};}}async[_0x12ab42(0x291)](_0x449ccf){const _0x4f32bc=_0x12ab42,_0x179404=await this[_0x4f32bc(0x280)][_0x4f32bc(0x263)]({'where':{'id':_0x449ccf}});return _0x179404===null||_0x179404===void 0x0?void 0x0:_0x179404['openId'];}async[_0x12ab42(0x237)](_0x1382d6){const _0x2ea044=_0x12ab42,{username:_0x152993,phone:_0x199978,email:_0x5d8b4c}=_0x1382d6;if(_0x199978){const _0x2c34e6=await this[_0x2ea044(0x280)][_0x2ea044(0x263)]({'where':{'phone':_0x199978}});if(_0x2c34e6)return![];}if(_0x5d8b4c){const _0x2babb8=await this[_0x2ea044(0x280)][_0x2ea044(0x263)]({'where':{'email':_0x5d8b4c}});if(_0x2babb8)return![];}if(_0x152993){const _0x4257ad=await this['userEntity'][_0x2ea044(0x263)]({'where':{'username':_0x152993}});if(_0x4257ad)return![];}if(!_0x199978&&!_0x5d8b4c&&!_0x152993)return![];return!![];}async[_0x12ab42(0x23b)](_0x10c2d0){const _0x2f8103=_0x12ab42,{username:_0x40aee1,password:_0x235aff,phone:_0x578461,phoneCode:_0x442849}=_0x10c2d0,_0x255ad0=await this[_0x2f8103(0x280)][_0x2f8103(0x263)]({'where':[{'username':_0x40aee1},{'phone':_0x578461}]});if(_0x255ad0&&_0x255ad0[_0x2f8103(0x206)]===_0x40aee1)throw new common_1[(_0x2f8103(0x267))](_0x2f8103(0x222),common_1['HttpStatus']['BAD_REQUEST']);if(_0x255ad0&&_0x255ad0[_0x2f8103(0x1f0)]===_0x578461)throw new common_1[(_0x2f8103(0x267))](_0x2f8103(0x1f6),common_1['HttpStatus'][_0x2f8103(0x27e)]);}async['verifyUserRegisterByEmail'](_0x8a12df){const _0x28866f=_0x12ab42,{username:_0x3c58df,email:_0x5835d7}=_0x8a12df;console[_0x28866f(0x26f)](_0x28866f(0x27f)+_0x3c58df+_0x28866f(0x257)+_0x5835d7);const _0x1eb94f=await this['userEntity'][_0x28866f(0x263)]({'where':[{'username':_0x3c58df},{'email':_0x5835d7}]});if(_0x1eb94f&&_0x1eb94f['username']===_0x3c58df){console['error']('校验失败:\x20用户名\x20\x22'+_0x3c58df+'\x22\x20已存在');throw new common_1[(_0x28866f(0x267))](_0x28866f(0x222),common_1['HttpStatus'][_0x28866f(0x27e)]);}if(_0x1eb94f&&_0x1eb94f['email']===_0x5835d7){console[_0x28866f(0x231)]('校验失败:\x20邮箱\x20\x22'+_0x5835d7+'\x22\x20已被注册');throw new common_1[(_0x28866f(0x267))](_0x28866f(0x1f7),common_1[_0x28866f(0x277)]['BAD_REQUEST']);}console[_0x28866f(0x26f)]('校验邮箱注册:\x20成功\x20-\x20用户名:\x20'+_0x3c58df+',\x20邮箱:\x20'+_0x5835d7+_0x28866f(0x217));}async['createUser'](_0xee96a1){const _0x13aceb=_0x12ab42;return await this[_0x13aceb(0x280)][_0x13aceb(0x208)](_0xee96a1);}async[_0x12ab42(0x221)](_0xe0c51a,_0x4f2564,_0x3e2271){const _0x25ea66=_0x12ab42,_0x51628a=await this[_0x25ea66(0x280)]['findOne']({'where':{'id':_0xe0c51a}});!_0x51628a&&common_1['Logger'][_0x25ea66(0x231)]('用户不存在');await this[_0x25ea66(0x280)]['update']({'id':_0xe0c51a},{'realName':_0x4f2564,'idCard':_0x3e2271});return;}async['updateUserPhone'](_0xbc22c7,_0x3b1026,_0x7fa6eb,_0x3e5264){const _0x27ffc4=_0x12ab42,_0x106157=await this['userEntity'][_0x27ffc4(0x263)]({'where':{'id':_0xbc22c7}}),_0x38c988=bcrypt[_0x27ffc4(0x203)](_0x3e5264,0xa);!_0x106157&&common_1[_0x27ffc4(0x23d)][_0x27ffc4(0x231)]('用户不存在');if(!_0x3b1026||!_0x7fa6eb||!_0x38c988)throw new common_1[(_0x27ffc4(0x267))](_0x27ffc4(0x242),common_1[_0x27ffc4(0x277)]['BAD_REQUEST']);await this[_0x27ffc4(0x280)][_0x27ffc4(0x22c)]({'id':_0xbc22c7},{'phone':_0x3b1026,'username':_0x7fa6eb,'password':_0x38c988});return;}};UserService=__decorate([(0x0,common_1[_0x12ab42(0x251)])(),__param(0x0,(0x0,typeorm_1[_0x12ab42(0x22e)])(user_entity_1[_0x12ab42(0x24d)])),__param(0x6,(0x0,typeorm_1['InjectRepository'])(config_entity_1[_0x12ab42(0x290)])),__metadata(_0x12ab42(0x25e),[typeorm_2[_0x12ab42(0x239)],typeorm_2[_0x12ab42(0x289)],verification_service_1[_0x12ab42(0x261)],mailer_service_1[_0x12ab42(0x244)],userBalance_service_1[_0x12ab42(0x256)],globalConfig_service_1['GlobalConfigService'],typeorm_2[_0x12ab42(0x239)]])],UserService),exports[_0x12ab42(0x1ef)]=UserService;