'use strict';const _0x2d403d=_0x2098;function _0x2098(_0x19c8c6,_0x2c9bb0){const _0x2337ee=_0x2337();return _0x2098=function(_0x2098d7,_0x1450c6){_0x2098d7=_0x2098d7-0x11d;let _0x5c4b27=_0x2337ee[_0x2098d7];return _0x5c4b27;},_0x2098(_0x19c8c6,_0x2c9bb0);}(function(_0x2f4199,_0x3673ba){const _0x49a56a=_0x2098,_0x5969db=_0x2f4199();while(!![]){try{const _0x5455f1=parseInt(_0x49a56a(0x127))/0x1*(-parseInt(_0x49a56a(0x135))/0x2)+parseInt(_0x49a56a(0x174))/0x3*(parseInt(_0x49a56a(0x178))/0x4)+parseInt(_0x49a56a(0x1ba))/0x5*(-parseInt(_0x49a56a(0x1ae))/0x6)+-parseInt(_0x49a56a(0x15f))/0x7*(-parseInt(_0x49a56a(0x19a))/0x8)+-parseInt(_0x49a56a(0x195))/0x9*(-parseInt(_0x49a56a(0x184))/0xa)+parseInt(_0x49a56a(0x189))/0xb+parseInt(_0x49a56a(0x1a6))/0xc*(-parseInt(_0x49a56a(0x15b))/0xd);if(_0x5455f1===_0x3673ba)break;else _0x5969db['push'](_0x5969db['shift']());}catch(_0x49e1d8){_0x5969db['push'](_0x5969db['shift']());}}}(_0x2337,0x481da));var __decorate=this&&this[_0x2d403d(0x16e)]||function(_0x10bdc3,_0x49ba7e,_0x5df623,_0x58500f){const _0xaf1be2=_0x2d403d;var _0x52a7dd=arguments['length'],_0x537661=_0x52a7dd<0x3?_0x49ba7e:_0x58500f===null?_0x58500f=Object[_0xaf1be2(0x1bd)](_0x49ba7e,_0x5df623):_0x58500f,_0x47e1d3;if(typeof Reflect===_0xaf1be2(0x130)&&typeof Reflect[_0xaf1be2(0x155)]===_0xaf1be2(0x1a1))_0x537661=Reflect[_0xaf1be2(0x155)](_0x10bdc3,_0x49ba7e,_0x5df623,_0x58500f);else{for(var _0x46692a=_0x10bdc3[_0xaf1be2(0x1c7)]-0x1;_0x46692a>=0x0;_0x46692a--)if(_0x47e1d3=_0x10bdc3[_0x46692a])_0x537661=(_0x52a7dd<0x3?_0x47e1d3(_0x537661):_0x52a7dd>0x3?_0x47e1d3(_0x49ba7e,_0x5df623,_0x537661):_0x47e1d3(_0x49ba7e,_0x5df623))||_0x537661;}return _0x52a7dd>0x3&&_0x537661&&Object[_0xaf1be2(0x1c0)](_0x49ba7e,_0x5df623,_0x537661),_0x537661;},__metadata=this&&this[_0x2d403d(0x150)]||function(_0x2f370b,_0x22479f){const _0x2536d6=_0x2d403d;if(typeof Reflect===_0x2536d6(0x130)&&typeof Reflect['metadata']==='function')return Reflect[_0x2536d6(0x185)](_0x2f370b,_0x22479f);},__param=this&&this[_0x2d403d(0x192)]||function(_0x4be1ec,_0x5cbd08){return function(_0x1dfc1a,_0x32a9a1){_0x5cbd08(_0x1dfc1a,_0x32a9a1,_0x4be1ec);};};function _0x2337(){const _0x1d2bbe=['compareSync','../globalConfig/config.entity','error:\x20','createRandomUid','savaLoginIp','user','userDefautlAvatar','avatar','尝试发送邮件到:\x20','BAD_REQUEST','重置密码失败！','toString','save','registerVerifyExpir','createUserAndVerifycation','isBindWx','affected','用户名已存在、请更换用户名！','verifyUserCredentials','getUserInfo','../mailer/mailer.service','createUserFromContact','__metadata','createVerification','saveRecordRechargeLog','DESC','Like','decorate','createdAt','verifyUserRegister','当前密码错误！','密码重置为[','queryUserInfoById','13nXlrES','status','HttpException','isUsernameTaken','7IEKzHB','queryUserBalance','connection','Connection','Not','updateStatus','typeorm','校验失败:\x20用户名\x20\x22','getConfigs','verifyUserRegisterByPhone','修改密码失败、请重新试试吧。','realName','修改用户状态成功！','您的账户已被封禁、如有疑问、请联系管理员！','find','__decorate','UNAUTHORIZED','RechargeType','修改用户信息成功！','log','UserStatusEnum','6099tMuBcr','bcryptjs','idCard','\x22\x20已存在','220UvPfLa','updateInfo','InjectRepository','@nestjs/typeorm','ACTIVE','slice','verificationService','BLACKLISTED','userBalanceService','forEach','configKey','当前手机号已注册、请勿重复注册！','45110OyIxav','metadata','assign','UserService','visitor','3409835UYBQfi','openId','configEntity','error','maskEmail','resetUserPass','addBalanceToUser','getUserByContact','./../../common/constants/user.constant','__param','getUserById','修改用户信息失败！','594JSBOaz','PENDING','bindWx','reduce','当前用户信息失效、请重新登录！','3798248gUAmuM','../../common/utils','getUserStatus','ADMIN_GIFT','consecutiveDays','超级管理员不可被操作！','queryOneUserInfo','function','getOpenIdByUserId','@nestjs/common','UserEntity','./../verification/verification.service','455772wNuoMI','UserStatusErrMsg','修改用户状态失败！','maskIpAddress','findOne','Logger','lastLoginIp','__esModule','6LaYkci','createUserFromOpenId','username','VerificationService','isVerifyEmail','GlobalConfigService','userEntity','HttpStatus','当前账户不存在！','UserBalanceService','123456','queryOne','2938185SXeoiQ','MailerService','userId','getOwnPropertyDescriptor','getUserFromOpenId','用户名或者邮箱已被注册！','defineProperty','sign','\x22\x20已被注册','registerVerifyEmailDesc','balanceInfo','saveRealNameInfo','校验邮箱注册:\x20开始\x20-\x20用户名:\x20','length','role','用户不存在！','globalConfigService','configMap:\x20','configVal','./user.entity','addBalanceToNewUser','./../globalConfig/globalConfig.service','queryUserBalanceByIds','client','password','Repository','cloneDeep','校验失败:\x20邮箱\x20\x22','phone','绑定微信失败、请联系管理员！','恭喜您绑定成功、后续可直接扫码登录了！','createUser','verifyUserPassword','273303uxwCsq','updateUserStatus','../../common/constants/verification.constant','toUpperCase','super','verifyUserRegisterByEmail','hashSync','update','参数错误！','object','Registration',',\x20邮箱:\x20','ConfigEntity','push','2cdBili','mailerService','email','lodash','用户名已存在！'];_0x2337=function(){return _0x1d2bbe;};return _0x2337();}Object[_0x2d403d(0x1c0)](exports,_0x2d403d(0x1ad),{'value':!![]}),exports[_0x2d403d(0x187)]=void 0x0;const balance_constant_1=require('../../common/constants/balance.constant'),verification_constant_1=require(_0x2d403d(0x129)),utils_1=require(_0x2d403d(0x19b)),mailer_service_1=require(_0x2d403d(0x14e)),common_1=require(_0x2d403d(0x1a3)),typeorm_1=require(_0x2d403d(0x17b)),bcrypt=require(_0x2d403d(0x175)),_=require(_0x2d403d(0x138)),typeorm_2=require(_0x2d403d(0x165)),config_entity_1=require(_0x2d403d(0x13b)),userBalance_service_1=require('../userBalance/userBalance.service'),user_constant_1=require(_0x2d403d(0x191)),globalConfig_service_1=require(_0x2d403d(0x1cf)),verification_service_1=require(_0x2d403d(0x1a5)),user_entity_1=require(_0x2d403d(0x1cd));let UserService=class UserService{constructor(_0x51c007,_0x2573a3,_0x167f66,_0x117e57,_0x1cd24b,_0x29789c,_0x2b1116){const _0x36ac8d=_0x2d403d;this[_0x36ac8d(0x1b4)]=_0x51c007,this[_0x36ac8d(0x161)]=_0x2573a3,this[_0x36ac8d(0x17e)]=_0x167f66,this[_0x36ac8d(0x136)]=_0x117e57,this['userBalanceService']=_0x1cd24b,this[_0x36ac8d(0x1ca)]=_0x29789c,this[_0x36ac8d(0x18b)]=_0x2b1116;}async[_0x2d403d(0x148)](_0x2ae4d5,_0xc03822){const _0x14eda6=_0x2d403d,{username:_0xfcade8,email:_0x9ed3bd,password:_0xffe515,client:client=0x0}=_0x2ae4d5,_0x438679=[{'username':_0xfcade8},{'email':_0x9ed3bd}],_0x473fa5=await this[_0x14eda6(0x1b4)]['findOne']({'where':_0x438679});if(_0x473fa5&&_0x473fa5[_0x14eda6(0x15c)]!==user_constant_1[_0x14eda6(0x173)][_0x14eda6(0x196)])throw new common_1['HttpException'](_0x14eda6(0x1bf),common_1[_0x14eda6(0x1b5)][_0x14eda6(0x143)]);try{const _0x1f9275=_[_0x14eda6(0x120)](_0x2ae4d5),_0x5e8b31=bcrypt[_0x14eda6(0x12d)](_0xffe515,0xa),_0x474983=(0x0,utils_1['getClientIp'])(_0xc03822);_0x1f9275['password']=_0x5e8b31,_0x1f9275['registerIp']=_0x474983,_0x1f9275[_0x14eda6(0x11d)]=client;let _0x4bc439;if(!_0x473fa5){const _0x57a5e7=await this[_0x14eda6(0x1ca)][_0x14eda6(0x167)](['userDefautlAvatar']);_0x1f9275['avatar']=_0x57a5e7,_0x4bc439=await this[_0x14eda6(0x1b4)][_0x14eda6(0x146)](_0x1f9275);}else _0x4bc439=_0x473fa5;const _0x997fcb=await this[_0x14eda6(0x18b)]['find']({'where':{'configKey':(0x0,typeorm_2['In'])([_0x14eda6(0x1b2),'registerBaseUrl','registerVerifyEmailTitle',_0x14eda6(0x1c3),'registerVerifyEmailFrom',_0x14eda6(0x147)])}}),_0x473f59=_0x997fcb[_0x14eda6(0x198)]((_0x1e4c87,_0x58e585)=>{const _0x37f99a=_0x14eda6;return _0x1e4c87[_0x58e585[_0x37f99a(0x182)]]=_0x58e585[_0x37f99a(0x1cc)],_0x1e4c87;},{}),_0x10eeef=_0x473f59[_0x14eda6(0x1b2)]?Number(_0x473f59[_0x14eda6(0x1b2)]):0x1;if(_0x10eeef){const _0x290053=_0x473f59['registerVerifyExpir']?Number(_0x473f59[_0x14eda6(0x147)]):0x1e*0x3c,_0x4a5a42=await this[_0x14eda6(0x17e)][_0x14eda6(0x151)](_0x4bc439,verification_constant_1['VerificationEnum'][_0x14eda6(0x131)],_0x290053),{code:_0x2199ee,email:_0x34faa3,id:_0xe48f5d}=_0x4a5a42,{registerVerifyEmailFrom:_0xc84013}=_0x473f59;console['log'](_0x14eda6(0x1cb),_0x473f59),console['log'](_0x14eda6(0x142)+_0x34faa3);}else{const {id:_0x5c4ae9}=_0x4bc439;await this[_0x14eda6(0x128)](_0x5c4ae9,user_constant_1[_0x14eda6(0x173)][_0x14eda6(0x17c)]),await this[_0x14eda6(0x180)][_0x14eda6(0x1ce)](_0x5c4ae9);}return _0x4bc439;}catch(_0x2d83a5){console[_0x14eda6(0x172)](_0x14eda6(0x13c),_0x2d83a5);throw _0x2d83a5;}}async['getSuper'](){const _0x4347d1=_0x2d403d,_0x466bdf=await this[_0x4347d1(0x1b4)]['findOne']({'where':{'role':_0x4347d1(0x12b)}});return _0x466bdf;}async[_0x2d403d(0x14c)](_0x592683){const _0x374e12=_0x2d403d,{username:_0x371b27,password:_0x2c110d,uid:uid=0x0,phone:_0x55dd09}=_0x592683;let _0x32dfd9=null;if(uid>0x0){_0x32dfd9=await this[_0x374e12(0x1b4)][_0x374e12(0x1aa)]({'where':{'id':uid}});if(!_0x32dfd9)throw new common_1[(_0x374e12(0x15d))](_0x374e12(0x1b6),common_1[_0x374e12(0x1b5)]['BAD_REQUEST']);if(!bcrypt['compareSync'](_0x2c110d,_0x32dfd9['password']))throw new common_1[(_0x374e12(0x15d))](_0x374e12(0x158),common_1[_0x374e12(0x1b5)]['BAD_REQUEST']);}if(_0x371b27&&_0x2c110d){const _0x1c8ab5=[{'username':_0x371b27},{'email':_0x371b27},{'phone':_0x371b27}];_0x32dfd9=await this['userEntity']['findOne']({'where':_0x1c8ab5});if(!_0x32dfd9)throw new common_1[(_0x374e12(0x15d))]('当前账户不存在！',common_1[_0x374e12(0x1b5)][_0x374e12(0x143)]);if(!bcrypt[_0x374e12(0x13a)](_0x2c110d,_0x32dfd9[_0x374e12(0x11e)]))throw new common_1[(_0x374e12(0x15d))]('当前密码错误！',common_1[_0x374e12(0x1b5)][_0x374e12(0x143)]);}if(!_0x32dfd9)throw new common_1['HttpException'](_0x374e12(0x1b6),common_1[_0x374e12(0x1b5)][_0x374e12(0x143)]);if(_0x32dfd9['status']!==user_constant_1[_0x374e12(0x173)]['ACTIVE'])throw new common_1['HttpException'](user_constant_1[_0x374e12(0x1a7)][_0x32dfd9[_0x374e12(0x15c)]],common_1['HttpStatus']['BAD_REQUEST']);return _0x32dfd9;}async[_0x2d403d(0x126)](_0x37969f,_0x209a02){const _0xf7b32a=_0x2d403d,_0x1116ec=await this[_0xf7b32a(0x1b4)][_0xf7b32a(0x1aa)]({'where':{'id':_0x37969f}});return bcrypt[_0xf7b32a(0x13a)](_0x209a02,_0x1116ec[_0xf7b32a(0x11e)]);}async[_0x2d403d(0x128)](_0x27f990,_0x3184b6){const _0x32a1be=_0x2d403d,_0x32f6b7=await this[_0x32a1be(0x1b4)][_0x32a1be(0x12e)]({'id':_0x27f990},{'status':_0x3184b6});return _0x32f6b7[_0x32a1be(0x14a)]>0x0;}async[_0x2d403d(0x19c)](_0x49723a){const _0x87e175=_0x2d403d,_0x449b69=await this['userEntity'][_0x87e175(0x1aa)]({'where':{'id':_0x49723a}});return _0x449b69[_0x87e175(0x15c)];}async[_0x2d403d(0x15a)](_0x55b604){const _0x84410a=_0x2d403d;return await this[_0x84410a(0x1b4)][_0x84410a(0x1aa)]({'where':{'id':_0x55b604}});}async[_0x2d403d(0x1a0)](_0x22d779){const _0x4d75ad=_0x2d403d;return await this[_0x4d75ad(0x1b4)][_0x4d75ad(0x1aa)]({'where':{'id':_0x22d779}});}async['checkUserStatus'](_0x5ce04f){const _0x55296b=_0x2d403d,{id:_0x2dcccf,role:_0x37c0d1}=_0x5ce04f;if(_0x37c0d1===_0x55296b(0x188))return!![];const _0x157964=await this[_0x55296b(0x1b4)][_0x55296b(0x1aa)]({'where':{'id':_0x2dcccf}});if(!_0x157964)throw new common_1[(_0x55296b(0x15d))]('当前用户信息失效、请重新登录！',common_1['HttpStatus']['UNAUTHORIZED']);if(_0x157964[_0x55296b(0x15c)]===user_constant_1[_0x55296b(0x173)][_0x55296b(0x17f)])throw new common_1[(_0x55296b(0x15d))]('您的账户已被永久加入黑名单、如有疑问、请联系管理员！',common_1[_0x55296b(0x1b5)][_0x55296b(0x143)]);if(_0x157964[_0x55296b(0x15c)]===user_constant_1['UserStatusEnum']['LOCKED'])throw new common_1[(_0x55296b(0x15d))](_0x55296b(0x16c),common_1[_0x55296b(0x1b5)]['BAD_REQUEST']);}async[_0x2d403d(0x14d)](_0x331769){const _0x396d4e=_0x2d403d,_0x199c6d=await this[_0x396d4e(0x1b4)]['findOne']({'where':{'id':_0x331769},'select':[_0x396d4e(0x1b0),_0x396d4e(0x141),_0x396d4e(0x1c8),_0x396d4e(0x137),'sign','openId',_0x396d4e(0x19e)]});if(!_0x199c6d)throw new common_1[(_0x396d4e(0x15d))](_0x396d4e(0x199),common_1[_0x396d4e(0x1b5)][_0x396d4e(0x16f)]);_0x199c6d[_0x396d4e(0x149)]=!!(_0x199c6d===null||_0x199c6d===void 0x0?void 0x0:_0x199c6d[_0x396d4e(0x18a)]),delete _0x199c6d[_0x396d4e(0x18a)];const _0x2d60c2=await this[_0x396d4e(0x180)][_0x396d4e(0x160)](_0x331769),_0x3534b3=(_0x331769*0x7b+0x5f5e100)[_0x396d4e(0x145)](0x24)[_0x396d4e(0x12a)]()[_0x396d4e(0x17d)](-0x6);return _0x199c6d['id']=_0x3534b3,{'userInfo':_0x199c6d,'userBalance':Object[_0x396d4e(0x186)]({},_0x2d60c2)};}async[_0x2d403d(0x193)](_0x5f5b9e){return await this['userEntity']['findOne']({'where':{'id':_0x5f5b9e}});}async['getUserOpenId'](_0x4c71a6){const _0xd155fa=_0x2d403d;return await this[_0xd155fa(0x1b4)][_0xd155fa(0x1aa)]({'where':{'openId':_0x4c71a6}});}async[_0x2d403d(0x179)](_0x3206e1,_0x8cc922){const _0x5ddb20=_0x2d403d,{id:_0x592c85}=_0x8cc922['user'],_0x3471a8=await this[_0x5ddb20(0x1b4)][_0x5ddb20(0x1aa)]({'where':{'id':_0x592c85}});if(!_0x3471a8)throw new common_1[(_0x5ddb20(0x15d))]('当前用户不存在！',common_1['HttpStatus'][_0x5ddb20(0x143)]);if(_0x3206e1['username']&&_0x3471a8['username']===_0x3206e1[_0x5ddb20(0x1b0)])throw new common_1[(_0x5ddb20(0x15d))]('没有变更，无需更改！',common_1[_0x5ddb20(0x1b5)][_0x5ddb20(0x143)]);if(_0x3206e1[_0x5ddb20(0x1b0)]){const _0x4a8354=await this[_0x5ddb20(0x15e)](_0x3206e1['username'],_0x592c85);if(_0x4a8354)throw new common_1[(_0x5ddb20(0x15d))](_0x5ddb20(0x139),common_1['HttpStatus'][_0x5ddb20(0x143)]);}const _0x434953=await this[_0x5ddb20(0x1b4)]['update']({'id':_0x592c85},_0x3206e1);if(_0x434953[_0x5ddb20(0x14a)]<=0x0)throw new common_1[(_0x5ddb20(0x15d))](_0x5ddb20(0x194),common_1['HttpStatus'][_0x5ddb20(0x143)]);return _0x5ddb20(0x171);}async[_0x2d403d(0x15e)](_0x548428,_0x35217b){const _0x2fa0aa=_0x2d403d,_0x119111={'username':_0x548428};_0x35217b&&(_0x119111['id']=(0x0,typeorm_2[_0x2fa0aa(0x163)])(_0x35217b));const _0x22d167=await this[_0x2fa0aa(0x1b4)][_0x2fa0aa(0x1aa)]({'where':_0x119111});return!!_0x22d167;}async['updateUserPassword'](_0x49465a,_0x4cc998){const _0x39026e=_0x2d403d,_0x48b4b2=bcrypt[_0x39026e(0x12d)](_0x4cc998,0xa),_0x5d46fc=await this[_0x39026e(0x1b4)][_0x39026e(0x12e)]({'id':_0x49465a},{'password':_0x48b4b2});if(_0x5d46fc[_0x39026e(0x14a)]<=0x0)throw new common_1['HttpException'](_0x39026e(0x169),common_1[_0x39026e(0x1b5)][_0x39026e(0x143)]);}async['userRecharge'](_0x48b9b4){const _0x247c5c=_0x2d403d,{userId:_0x313653,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x48b9b4;await this['userBalanceService'][_0x247c5c(0x18f)](_0x313653,{'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});const _0x50362f=await this[_0x247c5c(0x180)][_0x247c5c(0x152)]({'userId':_0x313653,'rechargeType':balance_constant_1[_0x247c5c(0x170)][_0x247c5c(0x19d)],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'extent':''});return _0x50362f;}async['queryAll'](_0x4a1e47,_0x1dfde0){const _0xa6b29c=_0x2d403d,{page:page=0x1,size:size=0xa,username:_0x3ec4ef,email:_0x3122e4,status:_0x24a48a,keyword:_0x23fbfa,phone:_0x3a16ca}=_0x4a1e47;let _0x157524={};_0x3ec4ef&&Object[_0xa6b29c(0x186)](_0x157524,{'username':(0x0,typeorm_2[_0xa6b29c(0x154)])('%'+_0x3ec4ef+'%')}),_0x3122e4&&Object[_0xa6b29c(0x186)](_0x157524,{'email':(0x0,typeorm_2['Like'])('%'+_0x3122e4+'%')}),_0x3a16ca&&Object[_0xa6b29c(0x186)](_0x157524,{'phone':(0x0,typeorm_2[_0xa6b29c(0x154)])('%'+_0x3a16ca+'%')}),_0x24a48a&&Object[_0xa6b29c(0x186)](_0x157524,{'status':_0x24a48a});_0x23fbfa&&(_0x157524=[{'username':(0x0,typeorm_2[_0xa6b29c(0x154)])('%'+_0x23fbfa+'%')},{'email':(0x0,typeorm_2[_0xa6b29c(0x154)])('%'+_0x23fbfa+'%')},{'phone':(0x0,typeorm_2[_0xa6b29c(0x154)])('%'+_0x23fbfa+'%')}]);const [_0x1b2b4e,_0x496169]=await this['userEntity']['findAndCount']({'skip':(page-0x1)*size,'where':_0x157524,'take':size,'order':{'createdAt':_0xa6b29c(0x153)},'cache':!![],'select':[_0xa6b29c(0x1b0),_0xa6b29c(0x141),'role',_0xa6b29c(0x1c1),_0xa6b29c(0x15c),'id',_0xa6b29c(0x137),_0xa6b29c(0x156),_0xa6b29c(0x1ac),_0xa6b29c(0x122),_0xa6b29c(0x16a),_0xa6b29c(0x176)]}),_0x10eebc=_0x1b2b4e['map'](_0x37f5ee=>_0x37f5ee['id']),_0x4e2119=await this[_0xa6b29c(0x180)][_0xa6b29c(0x1d0)](_0x10eebc);return _0x1b2b4e[_0xa6b29c(0x181)](_0x7db6b1=>_0x7db6b1[_0xa6b29c(0x1c4)]=_0x4e2119[_0xa6b29c(0x16d)](_0x1b4aa0=>_0x1b4aa0[_0xa6b29c(0x1bc)]===_0x7db6b1['id'])),_0x1dfde0[_0xa6b29c(0x13f)][_0xa6b29c(0x1c8)]!==_0xa6b29c(0x12b)&&_0x1b2b4e[_0xa6b29c(0x181)](_0x50fc16=>_0x50fc16[_0xa6b29c(0x137)]=(0x0,utils_1[_0xa6b29c(0x18d)])(_0x50fc16[_0xa6b29c(0x137)])),_0x1dfde0[_0xa6b29c(0x13f)][_0xa6b29c(0x1c8)]!==_0xa6b29c(0x12b)&&_0x1b2b4e[_0xa6b29c(0x181)](_0x184018=>_0x184018['lastLoginIp']=(0x0,utils_1['maskIpAddress'])(_0x184018[_0xa6b29c(0x1ac)])),_0x1dfde0[_0xa6b29c(0x13f)]['role']!==_0xa6b29c(0x12b)&&_0x1b2b4e['forEach'](_0x2a3f2b=>_0x2a3f2b[_0xa6b29c(0x122)]=(0x0,utils_1[_0xa6b29c(0x1a9)])(_0x2a3f2b[_0xa6b29c(0x122)])),{'rows':_0x1b2b4e,'count':_0x496169};}async[_0x2d403d(0x1b9)]({id:_0xaaa75f}){const _0x54b287=_0x2d403d;return await this['userEntity'][_0x54b287(0x1aa)]({'where':{'id':_0xaaa75f},'select':[_0x54b287(0x1b0),_0x54b287(0x141),_0x54b287(0x1c8),_0x54b287(0x1c1),_0x54b287(0x15c)]});}async[_0x2d403d(0x164)](_0x48023e){const _0x44a032=_0x2d403d,{id:_0x515a54,status:_0x419267}=_0x48023e,_0x4fcf31=await this[_0x44a032(0x1b4)][_0x44a032(0x1aa)]({'where':{'id':_0x515a54}});if(!_0x4fcf31)throw new common_1['HttpException'](_0x44a032(0x1c9),common_1['HttpStatus'][_0x44a032(0x143)]);if(_0x4fcf31[_0x44a032(0x1c8)]===_0x44a032(0x12b))throw new common_1[(_0x44a032(0x15d))](_0x44a032(0x19f),common_1[_0x44a032(0x1b5)][_0x44a032(0x143)]);if(_0x4fcf31[_0x44a032(0x1c8)]==='super')throw new common_1[(_0x44a032(0x15d))](_0x44a032(0x19f),common_1['HttpStatus']['BAD_REQUEST']);const _0x2f420e=await this[_0x44a032(0x1b4)][_0x44a032(0x12e)]({'id':_0x515a54},{'status':_0x419267});if(_0x2f420e['affected']<=0x0)throw new common_1[(_0x44a032(0x15d))](_0x44a032(0x1a8),common_1[_0x44a032(0x1b5)][_0x44a032(0x143)]);return _0x44a032(0x16b);}async[_0x2d403d(0x18e)](_0x3ff645){const _0x45f37c=_0x2d403d,{id:_0x20de91}=_0x3ff645,_0x33b47e=await this['userEntity'][_0x45f37c(0x1aa)]({'where':{'id':_0x20de91}});if(!_0x33b47e)throw new common_1[(_0x45f37c(0x15d))](_0x45f37c(0x1c9),common_1[_0x45f37c(0x1b5)][_0x45f37c(0x143)]);const _0x4f94d6=_0x45f37c(0x1b8),_0x12ce2d=bcrypt[_0x45f37c(0x12d)](_0x4f94d6,0xa),_0x358945=await this[_0x45f37c(0x1b4)][_0x45f37c(0x12e)]({'id':_0x20de91},{'password':_0x12ce2d});if(_0x358945[_0x45f37c(0x14a)]<=0x0)throw new common_1['HttpException'](_0x45f37c(0x144),common_1[_0x45f37c(0x1b5)][_0x45f37c(0x143)]);return _0x45f37c(0x159)+_0x4f94d6+']成功!';}async[_0x2d403d(0x13e)](_0x5a040d,_0x4a91dc){const _0x55b937=_0x2d403d;return await this[_0x55b937(0x1b4)][_0x55b937(0x12e)]({'id':_0x5a040d},{'lastLoginIp':_0x4a91dc});}async[_0x2d403d(0x1be)](_0x2b311f,_0x1ac1e5){const _0xb161f7=_0x2d403d,_0x2b7ac9=await this['userEntity'][_0xb161f7(0x1aa)]({'where':{'openId':_0x2b311f}});if(!_0x2b7ac9){const _0x239830=await this[_0xb161f7(0x1af)](_0x2b311f);return await this[_0xb161f7(0x180)]['addBalanceToNewUser'](_0x239830['id']),_0x239830;}return _0x2b7ac9;}async[_0x2d403d(0x1af)](_0x1c9e10){const _0x56e30f=_0x2d403d,_0x1b4dc9=await this[_0x56e30f(0x1ca)][_0x56e30f(0x167)]([_0x56e30f(0x140)]),_0x23e4e0={'avatar':_0x1b4dc9,'username':'用户'+(0x0,utils_1[_0x56e30f(0x13d)])(),'status':user_constant_1[_0x56e30f(0x173)][_0x56e30f(0x17c)],'sex':0x0,'email':(0x0,utils_1[_0x56e30f(0x13d)])()+'@default.com','openId':_0x1c9e10},_0x5ed225=await this[_0x56e30f(0x1b4)]['save'](_0x23e4e0);return _0x5ed225;}async[_0x2d403d(0x14f)](_0x15a8f7){const _0x134db5=_0x2d403d,{username:_0x305486,email:_0x26e5f3,phone:_0x5e3c40}=_0x15a8f7,_0x477d35=await this[_0x134db5(0x1ca)][_0x134db5(0x167)]([_0x134db5(0x140)]),_0x15c9f7={'avatar':_0x477d35,'username':'用户'+(0x0,utils_1[_0x134db5(0x13d)])(),'status':user_constant_1[_0x134db5(0x173)][_0x134db5(0x17c)],'sex':0x0};_0x305486&&(_0x15c9f7[_0x134db5(0x1b0)]=_0x305486);_0x26e5f3&&(_0x15c9f7[_0x134db5(0x137)]=_0x26e5f3);_0x5e3c40&&(_0x15c9f7['phone']=_0x5e3c40);const _0x8d03c=await this['userEntity'][_0x134db5(0x146)](_0x15c9f7);return _0x8d03c;}async[_0x2d403d(0x190)](_0x4abf59){const _0x9c063a=_0x2d403d,{username:_0x11a970,email:_0x36abe0,phone:_0x3a4b36}=_0x4abf59,_0x13aa3b=[];return _0x11a970&&_0x13aa3b[_0x9c063a(0x134)]({'username':_0x11a970}),_0x36abe0&&_0x13aa3b['push']({'email':_0x36abe0}),_0x3a4b36&&_0x13aa3b[_0x9c063a(0x134)]({'phone':_0x3a4b36}),await this['userEntity'][_0x9c063a(0x1aa)]({'where':_0x13aa3b});}async[_0x2d403d(0x197)](_0x153e8d,_0x44ad7b){const _0x98c32f=_0x2d403d;try{const _0x279700=await this[_0x98c32f(0x1b4)][_0x98c32f(0x1aa)]({'where':{'id':_0x44ad7b}});if(!_0x279700)return{'status':![],'msg':'当前绑定用户不存在！'};const _0x511050=await this[_0x98c32f(0x1b4)][_0x98c32f(0x1aa)]({'where':{'openId':_0x153e8d}});if(_0x511050)return{'status':![],'msg':'该微信已绑定其他账号！'};const _0x5158fe=await this[_0x98c32f(0x1b4)][_0x98c32f(0x12e)]({'id':_0x44ad7b},{'openId':_0x153e8d});if(_0x5158fe[_0x98c32f(0x14a)]<=0x0)return{'status':![],'msg':_0x98c32f(0x123)};return{'status':!![],'msg':_0x98c32f(0x124)};}catch(_0x3d96a2){return{'status':![],'msg':_0x98c32f(0x123)};}}async[_0x2d403d(0x1a2)](_0x17a256){const _0xc130e1=_0x2d403d,_0x436264=await this[_0xc130e1(0x1b4)][_0xc130e1(0x1aa)]({'where':{'id':_0x17a256}});return _0x436264===null||_0x436264===void 0x0?void 0x0:_0x436264[_0xc130e1(0x18a)];}async[_0x2d403d(0x157)](_0xfbfa){const _0x10cea4=_0x2d403d,{username:_0x37a192,phone:_0x40a018,email:_0x3f2e0c}=_0xfbfa;if(_0x40a018){const _0x568b37=await this[_0x10cea4(0x1b4)][_0x10cea4(0x1aa)]({'where':{'phone':_0x40a018}});if(_0x568b37)return![];}if(_0x3f2e0c){const _0xf53f61=await this[_0x10cea4(0x1b4)][_0x10cea4(0x1aa)]({'where':{'email':_0x3f2e0c}});if(_0xf53f61)return![];}if(_0x37a192){const _0x2eca8e=await this[_0x10cea4(0x1b4)][_0x10cea4(0x1aa)]({'where':{'username':_0x37a192}});if(_0x2eca8e)return![];}if(!_0x40a018&&!_0x3f2e0c&&!_0x37a192)return![];return!![];}async[_0x2d403d(0x168)](_0x5e6131){const _0xef1ae2=_0x2d403d,{username:_0xa530c2,password:_0x2a04f2,phone:_0x2b5159,phoneCode:_0x225fe3}=_0x5e6131,_0x2ac4ed=await this['userEntity'][_0xef1ae2(0x1aa)]({'where':[{'username':_0xa530c2},{'phone':_0x2b5159}]});if(_0x2ac4ed&&_0x2ac4ed[_0xef1ae2(0x1b0)]===_0xa530c2)throw new common_1[(_0xef1ae2(0x15d))](_0xef1ae2(0x14b),common_1[_0xef1ae2(0x1b5)][_0xef1ae2(0x143)]);if(_0x2ac4ed&&_0x2ac4ed['phone']===_0x2b5159)throw new common_1[(_0xef1ae2(0x15d))](_0xef1ae2(0x183),common_1[_0xef1ae2(0x1b5)][_0xef1ae2(0x143)]);}async[_0x2d403d(0x12c)](_0x51170f){const _0x96cb55=_0x2d403d,{username:_0x33a9ca,email:_0x4866b0}=_0x51170f;console[_0x96cb55(0x172)](_0x96cb55(0x1c6)+_0x33a9ca+_0x96cb55(0x132)+_0x4866b0);const _0x42cf21=await this[_0x96cb55(0x1b4)][_0x96cb55(0x1aa)]({'where':[{'username':_0x33a9ca},{'email':_0x4866b0}]});if(_0x42cf21&&_0x42cf21['username']===_0x33a9ca){console['error'](_0x96cb55(0x166)+_0x33a9ca+_0x96cb55(0x177));throw new common_1[(_0x96cb55(0x15d))](_0x96cb55(0x14b),common_1[_0x96cb55(0x1b5)][_0x96cb55(0x143)]);}if(_0x42cf21&&_0x42cf21['email']===_0x4866b0){console[_0x96cb55(0x18c)](_0x96cb55(0x121)+_0x4866b0+_0x96cb55(0x1c2));throw new common_1['HttpException']('当前邮箱已注册、请勿重复注册！',common_1[_0x96cb55(0x1b5)][_0x96cb55(0x143)]);}console[_0x96cb55(0x172)]('校验邮箱注册:\x20成功\x20-\x20用户名:\x20'+_0x33a9ca+',\x20邮箱:\x20'+_0x4866b0+'\x20未被占用');}async[_0x2d403d(0x125)](_0x16484d){const _0x59306a=_0x2d403d;return await this[_0x59306a(0x1b4)][_0x59306a(0x146)](_0x16484d);}async[_0x2d403d(0x1c5)](_0x4b3d45,_0x5dc924,_0x17fa29){const _0x55f2f1=_0x2d403d,_0x1bf4cd=await this[_0x55f2f1(0x1b4)][_0x55f2f1(0x1aa)]({'where':{'id':_0x4b3d45}});!_0x1bf4cd&&common_1[_0x55f2f1(0x1ab)][_0x55f2f1(0x18c)]('用户不存在');await this[_0x55f2f1(0x1b4)]['update']({'id':_0x4b3d45},{'realName':_0x5dc924,'idCard':_0x17fa29});return;}async['updateUserPhone'](_0x1cd161,_0x469cc8,_0x23197b,_0x4cafe4){const _0x636960=_0x2d403d,_0x4265ec=await this[_0x636960(0x1b4)][_0x636960(0x1aa)]({'where':{'id':_0x1cd161}}),_0xafb815=bcrypt[_0x636960(0x12d)](_0x4cafe4,0xa);!_0x4265ec&&common_1[_0x636960(0x1ab)][_0x636960(0x18c)]('用户不存在');if(!_0x469cc8||!_0x23197b||!_0xafb815)throw new common_1[(_0x636960(0x15d))](_0x636960(0x12f),common_1[_0x636960(0x1b5)][_0x636960(0x143)]);await this[_0x636960(0x1b4)][_0x636960(0x12e)]({'id':_0x1cd161},{'phone':_0x469cc8,'username':_0x23197b,'password':_0xafb815});return;}};UserService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x2d403d(0x17a)])(user_entity_1[_0x2d403d(0x1a4)])),__param(0x6,(0x0,typeorm_1[_0x2d403d(0x17a)])(config_entity_1[_0x2d403d(0x133)])),__metadata('design:paramtypes',[typeorm_2[_0x2d403d(0x11f)],typeorm_2[_0x2d403d(0x162)],verification_service_1[_0x2d403d(0x1b1)],mailer_service_1[_0x2d403d(0x1bb)],userBalance_service_1[_0x2d403d(0x1b7)],globalConfig_service_1[_0x2d403d(0x1b3)],typeorm_2[_0x2d403d(0x11f)]])],UserService),exports[_0x2d403d(0x187)]=UserService;