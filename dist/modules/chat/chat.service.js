'use strict';function _0x51ed(_0x2b027d,_0x1ba797){const _0x5d28cf=_0x5d28();return _0x51ed=function(_0x51ed69,_0x2e6f33){_0x51ed69=_0x51ed69-0x99;let _0x26de06=_0x5d28cf[_0x51ed69];return _0x26de06;},_0x51ed(_0x2b027d,_0x1ba797);}const _0x31d6ea=_0x51ed;(function(_0x390613,_0xdef33f){const _0x3568f2=_0x51ed,_0x443141=_0x390613();while(!![]){try{const _0x319238=parseInt(_0x3568f2(0xe1))/0x1*(-parseInt(_0x3568f2(0x169))/0x2)+parseInt(_0x3568f2(0xc0))/0x3*(-parseInt(_0x3568f2(0x147))/0x4)+-parseInt(_0x3568f2(0x14e))/0x5+parseInt(_0x3568f2(0x116))/0x6*(-parseInt(_0x3568f2(0x180))/0x7)+-parseInt(_0x3568f2(0x9c))/0x8*(-parseInt(_0x3568f2(0x122))/0x9)+parseInt(_0x3568f2(0x152))/0xa*(parseInt(_0x3568f2(0x12d))/0xb)+parseInt(_0x3568f2(0x155))/0xc;if(_0x319238===_0xdef33f)break;else _0x443141['push'](_0x443141['shift']());}catch(_0x5987bc){_0x443141['push'](_0x443141['shift']());}}}(_0x5d28,0xa4e36));var __decorate=this&&this[_0x31d6ea(0x189)]||function(_0x5a6558,_0x49068b,_0xac4aca,_0x34896f){const _0x5668e2=_0x31d6ea;var _0x2ed2cd=arguments['length'],_0x519224=_0x2ed2cd<0x3?_0x49068b:_0x34896f===null?_0x34896f=Object[_0x5668e2(0x99)](_0x49068b,_0xac4aca):_0x34896f,_0xfc8417;if(typeof Reflect==='object'&&typeof Reflect['decorate']==='function')_0x519224=Reflect[_0x5668e2(0x136)](_0x5a6558,_0x49068b,_0xac4aca,_0x34896f);else{for(var _0x20fb0b=_0x5a6558[_0x5668e2(0x11c)]-0x1;_0x20fb0b>=0x0;_0x20fb0b--)if(_0xfc8417=_0x5a6558[_0x20fb0b])_0x519224=(_0x2ed2cd<0x3?_0xfc8417(_0x519224):_0x2ed2cd>0x3?_0xfc8417(_0x49068b,_0xac4aca,_0x519224):_0xfc8417(_0x49068b,_0xac4aca))||_0x519224;}return _0x2ed2cd>0x3&&_0x519224&&Object[_0x5668e2(0xf5)](_0x49068b,_0xac4aca,_0x519224),_0x519224;},__metadata=this&&this[_0x31d6ea(0xfd)]||function(_0x520854,_0x346d4f){const _0x4ab01c=_0x31d6ea;if(typeof Reflect===_0x4ab01c(0x113)&&typeof Reflect['metadata']==='function')return Reflect[_0x4ab01c(0xc5)](_0x520854,_0x346d4f);},__param=this&&this[_0x31d6ea(0x112)]||function(_0xe10049,_0x137fdb){return function(_0x591056,_0x23ec45){_0x137fdb(_0x591056,_0x23ec45,_0xe10049);};};Object[_0x31d6ea(0xf5)](exports,_0x31d6ea(0x145),{'value':!![]}),exports[_0x31d6ea(0xc9)]=void 0x0;const utils_1=require(_0x31d6ea(0xdb)),common_1=require(_0x31d6ea(0xce)),typeorm_1=require(_0x31d6ea(0x10d)),axios_1=require(_0x31d6ea(0xd2)),typeorm_2=require(_0x31d6ea(0xbb)),aiPPT_1=require(_0x31d6ea(0x150)),cogVideo_service_1=require(_0x31d6ea(0x177)),fluxDraw_service_1=require(_0x31d6ea(0x195)),lumaVideo_service_1=require(_0x31d6ea(0xe9)),midjourneyDraw_service_1=require(_0x31d6ea(0xe4)),openaiChat_service_1=require(_0x31d6ea(0x17b)),openaiDraw_service_1=require(_0x31d6ea(0xc7)),stableDiffusion_service_1=require(_0x31d6ea(0xde)),suno_service_1=require('../ai/suno.service'),app_entity_1=require(_0x31d6ea(0x100)),autoreply_service_1=require(_0x31d6ea(0x192)),badWords_service_1=require(_0x31d6ea(0x105)),chatGroup_service_1=require(_0x31d6ea(0x187)),chatLog_service_1=require(_0x31d6ea(0xb3)),config_entity_1=require('../globalConfig/config.entity'),globalConfig_service_1=require(_0x31d6ea(0x142)),models_service_1=require('../models/models.service'),plugin_entity_1=require(_0x31d6ea(0xe3)),upload_service_1=require('../upload/upload.service'),user_service_1=require(_0x31d6ea(0xd7)),userBalance_service_1=require(_0x31d6ea(0xbd));let ChatService=class ChatService{constructor(_0x5f2269,_0x55ec7f,_0x37ef8d,_0x123765,_0x184501,_0x51d5f2,_0x57c3a8,_0x186a4a,_0x487ea3,_0x1fd401,_0x104c5c,_0xd903a5,_0x516ce9,_0x52961d,_0x63e5fa,_0x2e2ae4,_0x448a83,_0x37608c,_0x34eab9,_0x2b7862,_0x4337ef){const _0x264328=_0x31d6ea;this['configEntity']=_0x5f2269,this[_0x264328(0x13f)]=_0x55ec7f,this['pluginEntity']=_0x37ef8d,this[_0x264328(0xec)]=_0x123765,this[_0x264328(0xbc)]=_0x184501,this[_0x264328(0xac)]=_0x51d5f2,this[_0x264328(0xb9)]=_0x57c3a8,this[_0x264328(0xd9)]=_0x186a4a,this['userBalanceService']=_0x487ea3,this['userService']=_0x1fd401,this[_0x264328(0x114)]=_0x104c5c,this[_0x264328(0xc6)]=_0xd903a5,this[_0x264328(0x193)]=_0x516ce9,this['globalConfigService']=_0x52961d,this[_0x264328(0x14a)]=_0x63e5fa,this['modelsService']=_0x2e2ae4,this[_0x264328(0x194)]=_0x448a83,this[_0x264328(0xb1)]=_0x37608c,this[_0x264328(0xdc)]=_0x34eab9,this[_0x264328(0xc1)]=_0x2b7862,this[_0x264328(0xad)]=_0x4337ef;}async[_0x31d6ea(0x144)](_0x228afa,_0x6d19f8,_0x454c8f){const _0x3345b8=_0x31d6ea;await this['userBalanceService']['checkUserCertification'](_0x6d19f8['user']['id']);const {options:options={},usingPluginId:_0x463a70,appId:appId=null,specialModel:_0xc22f4f,prompt:_0x4c89e2,fileInfo:_0x3eda1c,extraParam:_0x240eb7,model:_0x4d8652,drawId:_0x23ecb6,customId:_0xb8a4de,action:_0x5a5905,modelName:_0x2311c1,modelAvatar:_0x258c85}=_0x228afa;let _0x2b6f87;if(_0xc22f4f)_0x2b6f87=await this['appEntity'][_0x3345b8(0x16b)]({'where':{'des':_0xc22f4f,'isSystemReserved':!![]}});else{if(appId){_0x2b6f87=await this[_0x3345b8(0x13f)][_0x3345b8(0x16b)]({'where':{'id':appId,'status':(0x0,typeorm_2['In'])([0x1,0x3,0x4,0x5])}});if(!_0x2b6f87)throw new common_1[(_0x3345b8(0xa4))](_0x3345b8(0xe0),common_1[_0x3345b8(0xd4)][_0x3345b8(0x131)]);}}const {groupId:_0x141153,fileParsing:_0x9d9833}=options,{openaiTimeout:_0x1afff0,openaiBaseUrl:_0x165d95,openaiBaseKey:_0x463e7d,systemPreMessage:_0x51e148,isMjTranslate:_0x58100e,mjTranslatePrompt:_0x584b4b,openaiTemperature:_0x12044a,openaiBaseModel:_0x516398,isGeneratePromptReference:_0x31418c,isConvertToBase64:_0x2599d8,isSensitiveWordFilter:_0x1431ac}=await this[_0x3345b8(0x13b)][_0x3345b8(0x19c)]([_0x3345b8(0x14c),_0x3345b8(0xd1),_0x3345b8(0x15a),_0x3345b8(0xba),_0x3345b8(0x183),_0x3345b8(0xc4),_0x3345b8(0x17e),_0x3345b8(0x9b),_0x3345b8(0x12a),_0x3345b8(0xa8),_0x3345b8(0x186)]);await this['userService']['checkUserStatus'](_0x6d19f8[_0x3345b8(0x157)]),_0x454c8f&&_0x454c8f['setHeader'](_0x3345b8(0x178),_0x3345b8(0x162));if(_0x1431ac==='1'){const _0x5a724f=await this[_0x3345b8(0xc6)][_0x3345b8(0x9e)](_0x4c89e2,_0x6d19f8[_0x3345b8(0x157)]['id']);if(_0x5a724f[_0x3345b8(0x11c)]>0x0){const _0x3aaba3='您提交的信息中包含违规的内容，我们已对您的账户进行标记，请合规使用！';throw new common_1[(_0x3345b8(0xa4))](_0x3aaba3,common_1[_0x3345b8(0xd4)]['BAD_REQUEST']);}}const _0x88902=await this[_0x3345b8(0x193)][_0x3345b8(0x13e)](_0x4c89e2);let _0x43abc9=null,_0x2ffb04='',_0x6cd22d='';_0x454c8f&&_0x454c8f[_0x3345b8(0xc8)](0xc8);let _0x3d7317=null;const _0x42298d=(0x0,utils_1['getClientIp'])(_0x6d19f8);let _0x4c0dce,_0x3094a5='',_0x446368;_0x463a70&&(_0x446368=await this[_0x3345b8(0x127)][_0x3345b8(0x16b)]({'where':{'id':_0x463a70}}));if(_0x2b6f87){const {isGPTs:_0x3d0707,gizmoID:_0x3a68cb,name:_0x3e2928,isFixedModel:_0x79248b,appModel:_0x2bdc71,coverImg:_0x429c03}=_0x2b6f87;_0x3094a5=_0x429c03,_0x2ffb04=_0x3e2928;if(_0x3d0707)_0x43abc9=await this[_0x3345b8(0x17f)]['getCurrentModelKeyInfo'](_0x3345b8(0x176)),_0x43abc9[_0x3345b8(0x15d)]=_0x3345b8(0xb7)+_0x3a68cb;else!_0x3d0707&&_0x79248b&&_0x2bdc71?(_0x2b6f87['preset']&&(_0x6cd22d=_0x2b6f87[_0x3345b8(0xf7)]),_0x43abc9=await this[_0x3345b8(0x17f)][_0x3345b8(0x18c)](_0x2bdc71),_0x43abc9[_0x3345b8(0x15d)]=_0x2bdc71,_0x9d9833&&(_0x6cd22d=_0x6cd22d+_0x3345b8(0x10c)+_0x9d9833+_0x3345b8(0xed)),common_1[_0x3345b8(0xdf)][_0x3345b8(0x16f)](_0x3345b8(0x13d)+_0x6cd22d,_0x3345b8(0xc9))):(_0x2b6f87[_0x3345b8(0xf7)]&&(_0x6cd22d=_0x2b6f87[_0x3345b8(0xf7)]),_0x43abc9=await this[_0x3345b8(0x17f)][_0x3345b8(0x18c)](_0x4d8652),_0x9d9833&&(_0x6cd22d=_0x6cd22d+'以下是我提供给你的知识库：【'+_0x9d9833+_0x3345b8(0xed)),common_1[_0x3345b8(0xdf)][_0x3345b8(0x16f)](_0x3345b8(0xfe)+_0x6cd22d,'ChatService'));}else{const _0x440efc=await this['chatGroupService'][_0x3345b8(0x11b)](_0x141153);if(_0x446368&&_0x446368[_0x3345b8(0x14d)]===0x0){let _0x3ccd50='';try{_0x3ccd50=await this['usePlugin'](_0x4c89e2,_0x446368[_0x3345b8(0x16c)]),common_1['Logger']['log'](_0x3345b8(0x140)+_0x3ccd50,_0x3345b8(0xc9));}catch(_0x16a534){_0x3ccd50=_0x4c89e2,common_1['Logger'][_0x3345b8(0x163)](_0x3345b8(0xd6)+_0x16a534);}_0x6cd22d=_0x3ccd50,_0x43abc9=await this[_0x3345b8(0x17f)][_0x3345b8(0x18c)](_0x4d8652),common_1[_0x3345b8(0xdf)][_0x3345b8(0x16f)](_0x3345b8(0x168)+_0x6cd22d,'ChatService');}else{if(_0x9d9833)_0x6cd22d='以下是我提供给你的知识库：【'+_0x9d9833+_0x3345b8(0xed),_0x43abc9=await this['modelsService'][_0x3345b8(0x18c)](_0x4d8652),common_1[_0x3345b8(0xdf)]['log'](_0x3345b8(0x12b)+_0x6cd22d,_0x3345b8(0xc9));else{const _0x49a296=new Date()['toISOString']()[_0x3345b8(0x171)]('T')[0x0];_0x6cd22d=_0x51e148+(_0x3345b8(0x9a)+_0x49a296),_0x43abc9=await this[_0x3345b8(0x17f)][_0x3345b8(0x18c)](_0x4d8652),common_1['Logger']['log'](_0x3345b8(0xae)+_0x6cd22d,_0x3345b8(0xc9));}}}if(!_0x43abc9){common_1[_0x3345b8(0xdf)][_0x3345b8(0xd5)](_0x3345b8(0xb8),_0x3345b8(0xc9)),_0x43abc9=await this[_0x3345b8(0x17f)]['getCurrentModelKeyInfo'](_0x516398);const _0x288658=await this[_0x3345b8(0x14a)][_0x3345b8(0x11b)](_0x141153);let _0x510c6d=_0x288658[_0x3345b8(0x15f)];try{const _0x3c1ae0=JSON[_0x3345b8(0xf1)](_0x288658[_0x3345b8(0x15f)]);_0x3c1ae0[_0x3345b8(0x137)]&&(_0x3c1ae0[_0x3345b8(0x137)][_0x3345b8(0x165)]=_0x43abc9['modelName'],_0x3c1ae0[_0x3345b8(0x137)][_0x3345b8(0x15d)]=_0x43abc9[_0x3345b8(0x15d)],_0x510c6d=JSON[_0x3345b8(0xfb)](_0x3c1ae0));}catch(_0x45e62c){common_1[_0x3345b8(0xdf)][_0x3345b8(0xd5)](_0x3345b8(0x12e),_0x3345b8(0xc9));throw new common_1[(_0x3345b8(0xa4))]('配置解析错误！',common_1[_0x3345b8(0xd4)][_0x3345b8(0x131)]);}await this['chatGroupService'][_0x3345b8(0xb5)]({'groupId':_0x141153,'title':_0x288658[_0x3345b8(0x19b)],'isSticky':![],'config':_0x510c6d,'fileUrl':''},_0x6d19f8);}const {deduct:_0x1ee2a4,isTokenBased:_0x30bc6f,tokenFeeRatio:_0x4ce1b3,deductType:_0x9feae5,key:_0x2d40ae,id:_0x54312e,maxRounds:_0x276e41,proxyUrl:_0x3f4c8c,maxModelTokens:_0x236417,timeout:_0x4726f5,model:_0xe81637,isFileUpload:_0x5d8267,keyType:_0x21e846}=_0x43abc9;if(await this[_0x3345b8(0xac)][_0x3345b8(0xa2)](_0x6d19f8['user'],_0xe81637))throw new common_1[(_0x3345b8(0xa4))](_0x3345b8(0xee),common_1[_0x3345b8(0xd4)][_0x3345b8(0x151)]);if(_0x58100e==='1'&&_0x5a5905===_0x3345b8(0x10b)&&_0x4d8652==='midjourney'){const [_0x2ffbe8,_0x2cd717]=_0x4c89e2[_0x3345b8(0x171)](/(?= --)/),_0xfabf68=/(https?:\/\/[^\s]+)/g,_0xb1961=_0x2ffbe8[_0x3345b8(0xef)](_0xfabf68)||[];let _0x8aeb2c=_0x2ffbe8[_0x3345b8(0x11f)](_0xfabf68,'')[_0x3345b8(0xbe)]();const _0x452f2a=await this[_0x3345b8(0xbc)][_0x3345b8(0x130)](_0x8aeb2c,_0x584b4b||_0x3345b8(0x146)),_0x2db173=[..._0xb1961,_0x452f2a][_0x3345b8(0x158)]('\x20')[_0x3345b8(0xbe)]();_0x4c0dce=_0x2cd717?''+_0x2db173+_0x2cd717:_0x2db173,_0x5d8267==='1'&&_0x3eda1c&&(_0x4c0dce=_0x3eda1c+'\x20'+_0x4c0dce);}else _0x4c0dce=_0x5d8267==='1'&&_0x3eda1c?_0x3eda1c+'\x20'+_0x4c89e2:_0x4c89e2;await this[_0x3345b8(0x15c)][_0x3345b8(0x141)](_0x6d19f8,_0x9feae5,_0x1ee2a4);const _0x33386a=_0x2311c1,_0x384a90=(0x0,utils_1['formatUrl'])(_0x3f4c8c||_0x165d95||_0x3345b8(0xf3)),_0x4450bc=_0x2d40ae||_0x463e7d,_0x395107=(_0x4726f5||_0x1afff0||0x12c)*0x3e8,_0x20f7b9=Number(_0x12044a)||0x1;if(_0x141153){const _0x15664b=await this[_0x3345b8(0x14a)][_0x3345b8(0x11b)](_0x141153);this['updateChatTitle'](_0x141153,_0x15664b,_0x21e846,_0x4c89e2,_0x6d19f8),await this[_0x3345b8(0x14a)][_0x3345b8(0x174)](_0x141153);}const _0x451874=await this['chatLogService'][_0x3345b8(0x119)]({'appId':appId,'curIp':_0x42298d,'userId':_0x6d19f8[_0x3345b8(0x157)]['id'],'type':_0x21e846?_0x21e846:0x1,'prompt':_0x4c89e2,'fileInfo':_0x3eda1c?_0x3eda1c:null,'answer':'','promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0xe81637,'modelName':'我','role':_0x3345b8(0x157),'groupId':_0x141153?_0x141153:null}),_0x212030=await this[_0x3345b8(0xac)][_0x3345b8(0x119)]({'appId':appId?appId:null,'action':_0x5a5905?_0x5a5905:null,'curIp':_0x42298d,'userId':_0x6d19f8[_0x3345b8(0x157)]['id'],'type':_0x21e846?_0x21e846:0x1,'prompt':_0x4c89e2,'fileInfo':null,'answer':'','progress':'0%','promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0xe81637,'modelName':_0x33386a,'role':_0x3345b8(0xa9),'groupId':_0x141153?_0x141153:null,'status':0x2,'modelAvatar':(_0x446368===null||_0x446368===void 0x0?void 0x0:_0x446368[_0x3345b8(0x110)])||_0x3094a5||_0x258c85||'','pluginParam':(_0x446368===null||_0x446368===void 0x0?void 0x0:_0x446368[_0x3345b8(0x16c)])?_0x446368['parameters']:_0x21e846===0x2?_0xe81637:null}),_0x562c41=_0x451874['id'],_0x3cb42c=_0x212030['id'];if(_0x88902['answer']&&_0x454c8f){if(_0x88902[_0x3345b8(0x108)]===0x0){const _0x196112=_0x88902['answer'][_0x3345b8(0x171)](''),_0x5216fc=_0x2e3031=>{const _0x4a3b4f=_0x3345b8;if(_0x2e3031<_0x196112[_0x4a3b4f(0x11c)]){const _0x47fc7b={'text':_0x196112[_0x2e3031]};_0x454c8f[_0x4a3b4f(0xab)](JSON['stringify'](_0x47fc7b)+'\x0a'),setTimeout(()=>_0x5216fc(_0x2e3031+0x1),0xa);}else _0x454c8f[_0x4a3b4f(0xe6)]();};_0x5216fc(0x0),await this[_0x3345b8(0xac)][_0x3345b8(0x184)](_0x3cb42c,{'answer':_0x88902[_0x3345b8(0xcc)]});return;}else _0x6cd22d=_0x6cd22d+_0x88902[_0x3345b8(0xcc)];}const {messagesHistory:_0x354726}=await this[_0x3345b8(0xe5)](_0x4c89e2,{'groupId':_0x141153,'systemMessage':_0x6cd22d,'maxModelTokens':_0x236417,'maxRounds':_0x276e41,'isConvertToBase64':_0x2599d8,'fileInfo':_0x3eda1c,'model':_0xe81637,'isFileUpload':_0x5d8267},this[_0x3345b8(0xac)]);let _0x35eac1=_0x5a5905!=='UPSCALE'&&_0xe81637==='midjourney'?_0x1ee2a4*0x4:_0x1ee2a4;const _0x5bacd5=new AbortController();try{if(_0x454c8f){_0x454c8f['on']('close',()=>{const _0x5eef30=_0x3345b8;_0x5bacd5[_0x5eef30(0x1a1)]();});let _0x48dd5b,_0x46da04=!![];try{if((_0xe81637==='dall-e-3'||_0xe81637===_0x3345b8(0x129)||_0xe81637==='ai-ppt'||_0xe81637===_0x3345b8(0xd8)||_0xe81637===_0x3345b8(0x18a)||_0xe81637[_0x3345b8(0xdd)]('stable-diffusion')||_0xe81637[_0x3345b8(0xdd)](_0x3345b8(0x13c))||_0xe81637[_0x3345b8(0xdd)]('flux'))&&_0x21e846===0x2){if(_0xe81637===_0x3345b8(0x111))_0x48dd5b=this[_0x3345b8(0x194)][_0x3345b8(0x109)]({'prompt':_0x4c89e2,'extraParam':_0x240eb7,'apiKey':_0x4450bc,'proxyUrl':_0x384a90,'model':_0xe81637,'timeout':_0x395107,'modelName':_0x33386a,'groupId':_0x141153,'onSuccess':async _0x4867c5=>{const _0x4c7640=_0x3345b8;await this['chatLogService'][_0x4c7640(0x184)](_0x3cb42c,{'fileInfo':_0x4867c5===null||_0x4867c5===void 0x0?void 0x0:_0x4867c5['fileInfo'],'answer':(_0x4867c5===null||_0x4867c5===void 0x0?void 0x0:_0x4867c5[_0x4c7640(0xcc)])||_0x4c89e2,'progress':'100%','status':_0x4867c5['status']});},'onFailure':async _0x3879ce=>{const _0x22b37f=_0x3345b8;await this[_0x22b37f(0xac)][_0x22b37f(0x184)](_0x3cb42c,{'answer':_0x22b37f(0x17a),'status':_0x3879ce[_0x22b37f(0xc8)]});}},this[_0x3345b8(0xe5)]),await this[_0x3345b8(0xac)][_0x3345b8(0x184)](_0x3cb42c,{'answer':_0x3345b8(0xcb)});else{if(_0xe81637==='ai-ppt')common_1['Logger'][_0x3345b8(0x16f)](_0x3345b8(0xea),_0x3345b8(0x164)),_0x48dd5b=this[_0x3345b8(0xad)][_0x3345b8(0x191)]({'usePrompt':_0x4c0dce,'prompt':_0x4c89e2,'apiKey':_0x4450bc,'proxyUrl':_0x384a90,'model':_0xe81637,'modelName':_0x33386a,'drawId':_0x23ecb6,'customId':_0xb8a4de,'action':_0x5a5905,'timeout':_0x395107,'assistantLogId':_0x3cb42c,'extraParam':_0x240eb7,'fileInfo':_0x3eda1c}),await this['chatLogService'][_0x3345b8(0x184)](_0x3cb42c,{'answer':_0x3345b8(0x153)});else{if(_0xe81637['includes'](_0x3345b8(0x14b)))_0x48dd5b=this[_0x3345b8(0xc1)]['fluxDraw']({'prompt':_0x4c89e2,'extraParam':_0x240eb7,'apiKey':_0x4450bc,'proxyUrl':_0x384a90,'model':_0xe81637,'timeout':_0x395107,'modelName':_0x33386a,'groupId':_0x141153,'onSuccess':async _0x5d61fb=>{const _0x69d4bb=_0x3345b8;await this[_0x69d4bb(0xac)]['updateChatLog'](_0x3cb42c,{'fileInfo':_0x5d61fb===null||_0x5d61fb===void 0x0?void 0x0:_0x5d61fb[_0x69d4bb(0xf8)],'answer':(_0x5d61fb===null||_0x5d61fb===void 0x0?void 0x0:_0x5d61fb[_0x69d4bb(0xcc)])||_0x4c89e2,'progress':_0x69d4bb(0x133),'status':_0x5d61fb['status']});},'onFailure':async _0x285d19=>{const _0x1663f6=_0x3345b8;await this[_0x1663f6(0xac)][_0x1663f6(0x184)](_0x3cb42c,{'answer':'绘图失败','status':_0x285d19['status']});}},this[_0x3345b8(0xe5)]),await this['chatLogService']['updateChatLog'](_0x3cb42c,{'answer':_0x3345b8(0xcb)});else{if(_0xe81637[_0x3345b8(0xdd)](_0x3345b8(0xd8)))_0x48dd5b=this[_0x3345b8(0xec)][_0x3345b8(0xa7)]({'assistantLogId':_0x3cb42c,'apiKey':_0x4450bc,'action':_0x5a5905,'prompt':_0x4c89e2,'timeout':_0x395107,'proxyUrl':_0x384a90,'taskData':_0xb8a4de}),await this[_0x3345b8(0xac)]['updateChatLog'](_0x3cb42c,{'answer':_0x3345b8(0x106)});else{if(_0xe81637[_0x3345b8(0xdd)](_0x3345b8(0x18a)))_0x48dd5b=this[_0x3345b8(0xb1)][_0x3345b8(0x175)]({'fileInfo':_0x3eda1c,'extraParam':_0x240eb7,'assistantLogId':_0x3cb42c,'apiKey':_0x4450bc,'action':_0x5a5905,'prompt':_0x4c89e2,'model':_0xe81637,'timeout':_0x395107,'proxyUrl':_0x384a90,'taskData':_0xb8a4de,'onGenerate':async _0xfba3c1=>{const _0x18660e=_0x3345b8;await this[_0x18660e(0xac)][_0x18660e(0x184)](_0x3cb42c,{'fileInfo':_0xfba3c1===null||_0xfba3c1===void 0x0?void 0x0:_0xfba3c1['fileInfo'],'answer':(_0xfba3c1===null||_0xfba3c1===void 0x0?void 0x0:_0xfba3c1[_0x18660e(0xcc)])||_0x4c89e2,'status':0x2});},'onSuccess':async _0x2fb671=>{const _0x45b373=_0x3345b8;await this[_0x45b373(0xac)][_0x45b373(0x184)](_0x3cb42c,{'fileInfo':_0x2fb671===null||_0x2fb671===void 0x0?void 0x0:_0x2fb671[_0x45b373(0xf8)],'answer':(_0x2fb671===null||_0x2fb671===void 0x0?void 0x0:_0x2fb671[_0x45b373(0xcc)])||_0x4c89e2,'progress':'100%','status':0x3});},'onFailure':async _0x428ecc=>{const _0x4cd03a=_0x3345b8;await this[_0x4cd03a(0xac)]['updateChatLog'](_0x3cb42c,{'answer':_0x428ecc['errMsg'],'status':0x4});}}),await this[_0x3345b8(0xac)][_0x3345b8(0x184)](_0x3cb42c,{'answer':_0x3345b8(0x118)});else{if(_0xe81637[_0x3345b8(0xdd)](_0x3345b8(0x13c)))_0x48dd5b=this[_0x3345b8(0xdc)][_0x3345b8(0xd0)]({'fileInfo':_0x3eda1c,'extraParam':_0x240eb7,'assistantLogId':_0x3cb42c,'apiKey':_0x4450bc,'action':_0x5a5905,'prompt':_0x4c89e2,'model':_0xe81637,'timeout':_0x395107,'proxyUrl':_0x384a90,'taskData':_0xb8a4de,'onGenerate':async _0x3f010a=>{const _0x1419a5=_0x3345b8;await this[_0x1419a5(0xac)]['updateChatLog'](_0x3cb42c,{'fileInfo':_0x3f010a===null||_0x3f010a===void 0x0?void 0x0:_0x3f010a[_0x1419a5(0xf8)],'answer':(_0x3f010a===null||_0x3f010a===void 0x0?void 0x0:_0x3f010a[_0x1419a5(0xcc)])||_0x4c89e2,'status':0x2});},'onSuccess':async _0x277885=>{const _0x25f038=_0x3345b8;await this[_0x25f038(0xac)][_0x25f038(0x184)](_0x3cb42c,{'fileInfo':_0x277885===null||_0x277885===void 0x0?void 0x0:_0x277885['fileInfo'],'answer':(_0x277885===null||_0x277885===void 0x0?void 0x0:_0x277885['answer'])||_0x4c89e2,'progress':_0x25f038(0x133),'status':0x3});},'onFailure':async _0x1c5947=>{const _0x578f51=_0x3345b8;await this[_0x578f51(0xac)][_0x578f51(0x184)](_0x3cb42c,{'answer':_0x1c5947[_0x578f51(0x138)],'status':0x4});}}),await this[_0x3345b8(0xac)][_0x3345b8(0x184)](_0x3cb42c,{'answer':_0x3345b8(0x118)});else _0xe81637[_0x3345b8(0xdd)]('stable-diffusion')?(_0x48dd5b=this[_0x3345b8(0xd9)][_0x3345b8(0xb0)]({'chatId':_0x3cb42c,'maxModelTokens':_0x236417,'apiKey':_0x4450bc,'model':_0xe81637,'modelName':_0x33386a,'modelType':_0x21e846,'prompt':_0x4c89e2,'fileInfo':_0x3eda1c,'isFileUpload':_0x5d8267,'timeout':_0x395107,'proxyUrl':_0x384a90,'onSuccess':async _0x57dd60=>{const _0x34ae73=_0x3345b8;await this[_0x34ae73(0xac)][_0x34ae73(0x184)](_0x3cb42c,{'fileInfo':_0x57dd60===null||_0x57dd60===void 0x0?void 0x0:_0x57dd60[_0x34ae73(0xf8)],'answer':(_0x57dd60===null||_0x57dd60===void 0x0?void 0x0:_0x57dd60[_0x34ae73(0xcc)])||_0x4c89e2,'progress':_0x34ae73(0x133),'status':0x3});},'onFailure':async _0x60d2fb=>{const _0x4311ed=_0x3345b8;await this[_0x4311ed(0xac)][_0x4311ed(0x184)](_0x3cb42c,{'answer':'生成失败','status':0x4});}}),await this['chatLogService']['updateChatLog'](_0x3cb42c,{'answer':_0x3345b8(0xcb)})):(_0x48dd5b=await this[_0x3345b8(0xb9)][_0x3345b8(0x160)]({'usePrompt':_0x4c0dce,'prompt':_0x4c89e2,'apiKey':_0x4450bc,'proxyUrl':_0x384a90,'model':_0xe81637,'modelName':_0x33386a,'drawId':_0x23ecb6,'customId':_0xb8a4de,'action':_0x5a5905,'fileInfo':_0x3eda1c,'timeout':_0x395107,'assistantLogId':_0x3cb42c,'pluginName':_0x446368}),await this['chatLogService'][_0x3345b8(0x184)](_0x3cb42c,{'answer':_0x48dd5b[_0x3345b8(0xcc)],'status':_0x48dd5b[_0x3345b8(0xc8)]}));}}}}}_0x48dd5b[_0x3345b8(0xc8)]!==0x5?(await this['modelsService']['saveUseLog'](_0x54312e,0x1),await this[_0x3345b8(0x15c)]['deductFromBalance'](_0x6d19f8[_0x3345b8(0x157)]['id'],_0x9feae5,_0x35eac1)):common_1[_0x3345b8(0xdf)][_0x3345b8(0x16f)](_0x3345b8(0xf6),_0x3345b8(0xc9));const _0x57b58f=await this[_0x3345b8(0x15c)][_0x3345b8(0xda)](_0x6d19f8[_0x3345b8(0x157)]['id']);return _0x48dd5b['userBalance']=Object[_0x3345b8(0x182)]({},_0x57b58f),_0x48dd5b[_0x3345b8(0x167)]=_0x48dd5b[_0x3345b8(0xcc)],_0x48dd5b['status']=_0x48dd5b[_0x3345b8(0xc8)]||0x2,_0x48dd5b[_0x3345b8(0x15d)]=_0x4d8652,_0x48dd5b['modelName']=_0x2311c1,_0x454c8f[_0x3345b8(0xab)]('\x0a'+JSON[_0x3345b8(0xfb)](_0x48dd5b));}else{_0x48dd5b=await this['openAIChatService']['openAIChat'](_0x354726,{'chatId':_0x3cb42c,'maxModelTokens':_0x236417,'apiKey':_0x4450bc,'model':_0xe81637,'modelName':_0x33386a,'temperature':_0x20f7b9,'modelType':_0x21e846,'prompt':_0x4c89e2,'fileInfo':_0x3eda1c,'isFileUpload':_0x5d8267,'timeout':_0x395107,'proxyUrl':_0x384a90,'modelAvatar':_0x258c85,'onProgress':_0x4bbc31=>{const _0xed5605=_0x3345b8;_0x454c8f['write'](_0x46da04?JSON[_0xed5605(0xfb)](_0x4bbc31):'\x0a'+JSON['stringify'](_0x4bbc31)),_0x46da04=![];},'onFailure':async _0x1fed1b=>{const _0x4c7bde=_0x3345b8;await this['chatLogService'][_0x4c7bde(0x184)](_0x3cb42c,{'answer':_0x1fed1b['errMsg'],'status':0x4});},'abortController':_0x5bacd5});if(_0x48dd5b['errMsg'])return common_1[_0x3345b8(0xdf)][_0x3345b8(0x163)](_0x3345b8(0xd3)+_0x6d19f8[_0x3345b8(0x157)]['id']+_0x3345b8(0x9f)+_0x33386a+'\x20模型:\x20'+_0x4d8652+_0x3345b8(0xff),_0x3345b8(0xc9)),_0x454c8f['write']('\x0a'+JSON[_0x3345b8(0xfb)](_0x48dd5b));let _0x367a1f='';_0x354726[_0x3345b8(0x9d)](_0x1cbb72=>{_0x367a1f+=_0x1cbb72['content']+'\x20';});const _0x1ba816=await(0x0,utils_1[_0x3345b8(0x11a)])(_0x367a1f),_0x48c786=await(0x0,utils_1[_0x3345b8(0x11a)])(_0x48dd5b[_0x3345b8(0xcc)]);await this[_0x3345b8(0xac)][_0x3345b8(0x184)](_0x562c41,{'promptTokens':_0x1ba816,'completionTokens':_0x48c786,'totalTokens':_0x1ba816+_0x48c786});let _0x4679b6=_0x48dd5b['answer'];if(_0x1431ac==='1'){const _0x4144eb=await this['badWordsService'][_0x3345b8(0x9e)](_0x48dd5b[_0x3345b8(0xcc)],_0x6d19f8[_0x3345b8(0x157)]['id']);if(_0x4144eb[_0x3345b8(0x11c)]>0x0){const _0x1889c1=new RegExp(_0x4144eb[_0x3345b8(0x158)]('|'),'gi');_0x4679b6=_0x4679b6[_0x3345b8(0x11f)](_0x1889c1,_0x60dc6a=>'*'[_0x3345b8(0x159)](_0x60dc6a[_0x3345b8(0x11c)]));}}await this[_0x3345b8(0xac)][_0x3345b8(0x184)](_0x3cb42c,{'fileInfo':_0x48dd5b===null||_0x48dd5b===void 0x0?void 0x0:_0x48dd5b['fileInfo'],'answer':_0x4679b6,'promptTokens':_0x1ba816,'completionTokens':_0x48c786,'totalTokens':_0x1ba816+_0x48c786,'status':0x3});try{if(_0x31418c==='1'){const _0x55a45a=await this['openAIChatService'][_0x3345b8(0x130)](_0x3345b8(0x190)+_0x4c89e2+'}以及\x20AI\x20的回答{'+_0x48dd5b['answer']+'}，生成三个更进入一步的提问，用{}包裹每个问题，不需要分行，不需要其他任何内容，单个提问不超过30个字');await this['chatLogService']['updateChatLog'](_0x3cb42c,{'promptReference':_0x55a45a});}}catch(_0x4277f7){common_1[_0x3345b8(0xdf)]['error'](_0x3345b8(0x18d)+_0x4277f7);}_0x30bc6f===!![]&&(_0x35eac1=_0x1ee2a4*Math['ceil']((_0x1ba816+_0x48c786)/_0x4ce1b3));await this[_0x3345b8(0x15c)][_0x3345b8(0xb4)](_0x6d19f8[_0x3345b8(0x157)]['id'],_0x9feae5,_0x35eac1,_0x1ba816+_0x48c786),await this[_0x3345b8(0x17f)][_0x3345b8(0x198)](_0x54312e,_0x1ba816+_0x48c786),common_1[_0x3345b8(0xdf)][_0x3345b8(0x16f)]('用户ID:\x20'+_0x6d19f8[_0x3345b8(0x157)]['id']+_0x3345b8(0x9f)+_0x33386a+_0x3345b8(0x17c)+_0x4d8652+_0x3345b8(0x197)+(_0x1ba816+_0x48c786)+_0x3345b8(0x13a)+_0x35eac1,'ChatService');const _0x176fb6=await this['userBalanceService'][_0x3345b8(0xda)](_0x6d19f8['user']['id']);return _0x48dd5b[_0x3345b8(0x135)]=Object[_0x3345b8(0x182)]({},_0x176fb6),_0x454c8f[_0x3345b8(0xab)]('\x0a'+JSON[_0x3345b8(0xfb)](_0x48dd5b));}}catch(_0x5ae984){common_1[_0x3345b8(0xdf)]['error'](_0x3345b8(0xb6),_0x5ae984),await this['chatLogService'][_0x3345b8(0x184)](_0x3cb42c,{'status':0x5}),_0x48dd5b={'error':_0x3345b8(0x117)};}}else return _0x3d7317=await this[_0x3345b8(0xbc)][_0x3345b8(0x156)](_0x354726,{'chatId':_0x3cb42c,'maxModelTokens':_0x236417,'apiKey':_0x4450bc,'model':_0xe81637,'modelName':_0x33386a,'modelType':_0x21e846,'temperature':_0x20f7b9,'prompt':_0x4c89e2,'fileInfo':_0x3eda1c,'isFileUpload':_0x5d8267,'timeout':_0x395107,'proxyUrl':_0x384a90,'abortController':_0x5bacd5}),await this[_0x3345b8(0x15c)]['deductFromBalance'](_0x6d19f8[_0x3345b8(0x157)]['id'],_0x9feae5,_0x35eac1),_0x3d7317['answer'];}catch(_0x285c62){common_1[_0x3345b8(0xdf)]['error'](_0x3345b8(0xf0),_0x4450bc,_0x285c62);if(_0x454c8f)return _0x454c8f[_0x3345b8(0xab)](_0x3345b8(0x196));else throw new common_1[(_0x3345b8(0xa4))](_0x3345b8(0x196),common_1[_0x3345b8(0xd4)]['BAD_REQUEST']);}finally{_0x454c8f&&_0x454c8f[_0x3345b8(0xe6)]();}}async[_0x31d6ea(0xaa)](_0x525802,_0x382f05){const _0xacd025=_0x31d6ea,{pluginUrl:_0x1902e3,pluginKey:_0x59db85}=await this['globalConfigService'][_0xacd025(0x19c)](['pluginUrl',_0xacd025(0x10e)]),_0x5d051d=_0x59db85,_0x6b18ba=_0x1902e3,_0x1d3f8c={'method':'POST','url':_0x6b18ba+_0xacd025(0x19e)+_0x382f05,'headers':{'Content-Type':_0xacd025(0xa1),'Authorization':'Bearer\x20'+_0x5d051d},'data':{'prompt':_0x525802}};try{const _0x5dc4ad=await(0x0,axios_1['default'])(_0x1d3f8c);return common_1[_0xacd025(0xdf)][_0xacd025(0x16f)](_0xacd025(0x139)+JSON['stringify'](_0x5dc4ad[_0xacd025(0x132)],null,0x2),_0xacd025(0xf2)),_0x5dc4ad['data'][_0xacd025(0x167)];}catch(_0x26abbf){common_1[_0xacd025(0xdf)]['error'](_0xacd025(0x134),_0x26abbf);}}async[_0x31d6ea(0x1a0)](_0x8e401,_0xc5bae4,_0x43b830,_0x408c18,_0x5dcc0d){const _0x11c10d=_0x31d6ea;if((_0xc5bae4===null||_0xc5bae4===void 0x0?void 0x0:_0xc5bae4[_0x11c10d(0x19b)])===_0x11c10d(0x14f)){let _0x6f2229;if(_0x43b830===0x1)try{_0x6f2229=await this[_0x11c10d(0xbc)][_0x11c10d(0x130)](_0x11c10d(0x190)+_0x408c18+'}，给这个对话取一个名字，不超过10个字'),_0x6f2229['length']>0xf&&(_0x6f2229=_0x6f2229[_0x11c10d(0xcf)](0x0,0xf));}catch(_0xa227a){common_1[_0x11c10d(0xdf)][_0x11c10d(0x163)](_0x11c10d(0x18d)+_0xa227a),_0x6f2229=_0x408c18[_0x11c10d(0xcf)](0x0,0xa);}else _0x6f2229=_0x11c10d(0x10f);this['chatGroupService'][_0x11c10d(0xb5)]({'groupId':_0x8e401,'title':_0x6f2229,'isSticky':![],'config':'','fileUrl':''},_0x5dcc0d)[_0x11c10d(0xf9)](()=>common_1[_0x11c10d(0xdf)][_0x11c10d(0x16f)]('更新标题名称为:\x20'+_0x6f2229,'ChatService'))[_0x11c10d(0x123)](_0x5bdb14=>common_1[_0x11c10d(0xdf)][_0x11c10d(0x163)](_0x11c10d(0xfa)+_0x5bdb14));}}async[_0x31d6ea(0xe5)](_0x43cb0e,_0x221ad6,_0x4f3e5d){const _0x499df1=_0x31d6ea;let {systemMessage:systemMessage='',fileInfo:_0x192fef,groupId:_0xd0938f,maxRounds:maxRounds=0x5,maxModelTokens:maxModelTokens=0x1f40,isFileUpload:isFileUpload=0x0,isConvertToBase64:_0x226233}=_0x221ad6;systemMessage[_0x499df1(0x11c)]>maxModelTokens&&(common_1[_0x499df1(0xdf)]['log']('系统消息超过最大长度，将被截断',_0x499df1(0xc9)),systemMessage=systemMessage['slice'](0x0,maxModelTokens));let _0x599a12=[];systemMessage&&_0x599a12[_0x499df1(0x16a)]({'role':_0x499df1(0x15b),'content':systemMessage});if(_0xd0938f){const _0x3e71e7=await _0x4f3e5d[_0x499df1(0xf4)](_0xd0938f,maxRounds);let _0xd3d189=null;for(const _0x396e09 of _0x3e71e7){try{let _0x100ef1;if((isFileUpload===0x2||isFileUpload===0x3)&&_0x396e09[_0x499df1(0xf8)]&&_0x396e09[_0x499df1(0x166)]===_0x499df1(0x157)){const _0x32dd1e=await Promise['all'](_0x396e09[_0x499df1(0xf8)]['split'](',')[_0x499df1(0x179)](async _0x3eb80f=>({'type':_0x499df1(0x126),'image_url':{'url':_0x226233==='1'?await this[_0x499df1(0xca)](_0x3eb80f[_0x499df1(0xbe)]()):_0x3eb80f[_0x499df1(0xbe)]()}})));_0x100ef1=[{'type':_0x499df1(0x167),'text':_0x396e09[_0x499df1(0x167)]},..._0x32dd1e];}else isFileUpload===0x1&&_0x396e09[_0x499df1(0xf8)]&&_0x396e09[_0x499df1(0x166)]==='user'?_0x100ef1=_0x396e09[_0x499df1(0xf8)]+'\x0a'+_0x396e09['text']:_0x100ef1=_0x396e09[_0x499df1(0x167)];if(_0x396e09[_0x499df1(0x166)]===_0x499df1(0x157))_0xd3d189={'role':_0x396e09['role'],'content':_0x100ef1};else{if(_0x396e09['role']===_0x499df1(0xa9)){const _0x3cb863=Array['isArray'](_0x100ef1)?JSON['stringify'](_0x100ef1):_0x100ef1;_0xd3d189&&_0x3cb863[_0x499df1(0xbe)]()!==''&&(_0x599a12[_0x499df1(0x16a)](_0xd3d189),_0x599a12[_0x499df1(0x16a)]({'role':_0x396e09[_0x499df1(0x166)],'content':_0x100ef1}),_0xd3d189=null);}}}catch(_0x390f4a){common_1[_0x499df1(0xdf)][_0x499df1(0x163)](_0x499df1(0x103),_0x390f4a,_0x499df1(0x172),JSON['stringify'](_0x396e09,null,0x2));}}}let _0x4c790d;if((isFileUpload===0x2||isFileUpload===0x3)&&_0x192fef){const _0x417a76=await Promise[_0x499df1(0xa3)](_0x192fef[_0x499df1(0x171)](',')[_0x499df1(0x179)](async _0x42838b=>({'type':_0x499df1(0x126),'image_url':{'url':_0x226233==='1'?await this['convertUrlToBase64'](_0x42838b[_0x499df1(0xbe)]()):_0x42838b['trim']()}})));_0x4c790d=[{'type':_0x499df1(0x167),'text':_0x43cb0e},..._0x417a76];}else isFileUpload===0x1&&_0x192fef?_0x4c790d=_0x192fef+'\x0a'+_0x43cb0e:_0x4c790d=_0x43cb0e;_0x599a12[_0x499df1(0x16a)]({'role':_0x499df1(0x157),'content':_0x4c790d});let _0xc0f5f3=await(0x0,utils_1['getTokenCount'])(_0x599a12),_0x5be2fe;maxModelTokens<0x1f40?_0x5be2fe=0xfa0:_0x5be2fe=maxModelTokens-0xfa0;while(_0xc0f5f3>_0x5be2fe){if(_0x599a12[_0x499df1(0x11c)]===0x2&&_0x599a12[0x0]['role']===_0x499df1(0x15b)&&_0x599a12[0x1][_0x499df1(0x166)]===_0x499df1(0x157))break;let _0x18be9d=![];for(let _0xf3a673=0x0;_0xf3a673<_0x599a12[_0x499df1(0x11c)];_0xf3a673++){if(_0x599a12[_0xf3a673][_0x499df1(0x166)]!==_0x499df1(0x15b)&&_0x599a12[_0xf3a673+0x1]&&_0x599a12[_0xf3a673+0x1]['role']==='assistant'){_0x599a12[_0x499df1(0x15e)](_0xf3a673,0x2),_0x18be9d=!![];break;}}if(!_0x18be9d)for(let _0x22d81e=0x0;_0x22d81e<_0x599a12[_0x499df1(0x11c)];_0x22d81e++){if(_0x599a12[_0x22d81e][_0x499df1(0x166)]===_0x499df1(0x157)){_0x599a12[_0x499df1(0x15e)](_0x22d81e,0x1);break;}}_0xc0f5f3=await(0x0,utils_1[_0x499df1(0x11a)])(_0x599a12);if(_0x599a12[_0x499df1(0x11c)]<=0x2)break;}return{'messagesHistory':_0x599a12,'round':_0x599a12[_0x499df1(0x11c)]};}async[_0x31d6ea(0xca)](_0x248472){const _0x2c507b=_0x31d6ea;try{console['log'](_0x2c507b(0x102)+_0x248472);const _0x1e1ca3=await axios_1[_0x2c507b(0x104)]['get'](_0x248472,{'responseType':_0x2c507b(0xe7)}),_0x58823d=Buffer[_0x2c507b(0x121)](_0x1e1ca3['data'],'binary');console[_0x2c507b(0x16f)](_0x2c507b(0x12f)+_0x248472);const _0x35b523='data:'+_0x1e1ca3[_0x2c507b(0x18b)]['content-type']+_0x2c507b(0x16d)+_0x58823d['toString'](_0x2c507b(0xc2));return console[_0x2c507b(0x16f)](_0x2c507b(0x18e)+_0x248472),_0x35b523;}catch(_0x9dea46){return console['error'](_0x2c507b(0x148),_0x9dea46),console[_0x2c507b(0x11d)]('返回原始链接:\x20'+_0x248472),_0x248472;}}async[_0x31d6ea(0xaf)](_0x4cb56c,_0x15c5a9,_0x49c1d5){const _0x1a7a64=_0x31d6ea,{chatId:_0x150880,prompt:_0x256a77}=_0x4cb56c,_0x28cc1c=await this[_0x1a7a64(0x17f)][_0x1a7a64(0x18c)](_0x1a7a64(0xa5)),{openaiTimeout:_0x2631c7,openaiBaseUrl:_0x476523,openaiBaseKey:_0x66d22c,openaiVoice:_0xd8c9cf}=await this['globalConfigService'][_0x1a7a64(0x19c)]([_0x1a7a64(0x14c),'openaiBaseUrl','openaiBaseKey',_0x1a7a64(0xe2)]),{key:_0x34c895,proxyUrl:_0x54dded,deduct:_0x339e20,deductType:_0x511405,timeout:_0x3081c4}=_0x28cc1c,_0x12cb6b=_0x34c895||_0x66d22c,_0x3a300c=(0x0,utils_1['formatUrl'])(_0x54dded||_0x476523),_0x25a386=(_0x3081c4||_0x2631c7)*0x3e8;await this[_0x1a7a64(0x15c)][_0x1a7a64(0x141)](_0x15c5a9,_0x511405,_0x339e20),common_1[_0x1a7a64(0xdf)][_0x1a7a64(0x16f)](_0x1a7a64(0x199),_0x256a77,'TTSService');const _0x347b66={'method':'POST','url':_0x3a300c+_0x1a7a64(0x115),'headers':{'Content-Type':_0x1a7a64(0xa1),'Authorization':_0x1a7a64(0x188)+_0x12cb6b},'responseType':_0x1a7a64(0xe7),'timeout':_0x25a386,'data':{'model':_0x1a7a64(0xa5),'input':_0x256a77,'voice':_0xd8c9cf||'onyx'}};try{const _0x5325fc=await(0x0,axios_1[_0x1a7a64(0x104)])(_0x347b66);common_1[_0x1a7a64(0xdf)]['log'](_0x1a7a64(0xcd),_0x1a7a64(0x124));const _0x4e2e41=Buffer[_0x1a7a64(0x121)](_0x5325fc[_0x1a7a64(0x132)]),_0x99be36=new Date(),_0x5250d0=_0x99be36[_0x1a7a64(0xc3)](),_0x86f252=String(_0x99be36[_0x1a7a64(0x170)]()+0x1)[_0x1a7a64(0x19a)](0x2,'0'),_0x7bb02a=String(_0x99be36[_0x1a7a64(0xeb)]())[_0x1a7a64(0x19a)](0x2,'0'),_0x1c7ebb=''+_0x5250d0+_0x86f252+'/'+_0x7bb02a,_0x5bc754=await this[_0x1a7a64(0x114)][_0x1a7a64(0x12c)]({'buffer':_0x4e2e41,'mimetype':_0x1a7a64(0x143)},_0x1a7a64(0x19d)+_0x1c7ebb);await Promise[_0x1a7a64(0xa3)]([this['chatLogService'][_0x1a7a64(0x184)](_0x150880,{'ttsUrl':_0x5bc754}),this['userBalanceService'][_0x1a7a64(0xb4)](_0x15c5a9['user']['id'],_0x511405,_0x339e20)]),_0x49c1d5[_0x1a7a64(0xc8)](0xc8)[_0x1a7a64(0x128)]({'ttsUrl':_0x5bc754});}catch(_0x758913){common_1[_0x1a7a64(0xdf)][_0x1a7a64(0x163)](_0x1a7a64(0x120),_0x758913,_0x1a7a64(0x124)),_0x49c1d5[_0x1a7a64(0xc8)](0x1f4)['send']({'error':_0x1a7a64(0xb2)});}}};function _0x5d28(){const _0x3e3d24=['BadWordsService','chatGroupService','flux','openaiTimeout','isSystemPlugin','3711970FIBpRl','新对话','../ai/aiPPT','TOO_MANY_REQUESTS','542440VjjhVT','生成中','UserBalanceService','15301356dYOQXU','openAIChat','user','join','repeat','openaiBaseKey','system','userBalanceService','model','splice','config','midjourneyDraw','CogVideoService','application/octet-stream;\x20charset=utf-8','error','DrawService','modelName','role','text','使用插件预设:\x20','570686pGXGLK','push','findOne','parameters',';base64,','Injectable','log','getMonth','split','记录:','OpenAIChatService','updateTime','lumaVideo','gpts','../ai/cogVideo.service','Content-type','map','绘图失败','../ai/openaiChat.service','\x20模型:\x20','Repository','openaiTemperature','modelsService','7fHxCZw','ModelsService','assign','isMjTranslate','updateChatLog','design:paramtypes','isSensitiveWordFilter','../chatGroup/chatGroup.service','Bearer\x20','__decorate','luma-video','headers','getCurrentModelKeyInfo','调用\x20chatFree\x20出错:\x20','成功转换URL为Base64:\x20','AutoreplyService','根据用户提问{','aiPPT','../autoreply/autoreply.service','autoreplyService','openAIDrawService','../ai/fluxDraw.service','发生未知错误，请稍后再试','\x20消耗token:\x20','saveUseLog','开始\x20TTS\x20请求:','padStart','title','getConfigs','audio/openai/','/plugins/','InjectRepository','updateChatTitle','abort','getOwnPropertyDescriptor','\x0a\x20Current\x20date:\x20','openaiBaseModel','874936ChFSIQ','forEach','checkBadWords','\x20模型名称:\x20','LumaVideoService','application/json','checkModelLimits','all','HttpException','tts-1','ConfigEntity','suno','isConvertToBase64','assistant','usePlugin','write','chatLogService','aiPptService','使用全局预设:\x20','ttsProcess','sdxl','lumaVideoService','Failed\x20to\x20process\x20TTS\x20request','../chatLog/chatLog.service','deductFromBalance','update','发生错误:','gpt-4-gizmo-','未找到当前模型key，切换至全局模型','midjourneyService','systemPreMessage','typeorm','openAIChatService','../userBalance/userBalance.service','trim','UploadService','15rbwrWl','fluxDrawService','base64','getFullYear','mjTranslatePrompt','metadata','badWordsService','../ai/openaiDraw.service','status','ChatService','convertUrlToBase64','绘制中','answer','TTS\x20请求获取成功','@nestjs/common','slice','cogVideo','openaiBaseUrl','axios','用户ID:\x20','HttpStatus','debug','插件调用错误:\x20','../user/user.service','suno-music','stableDiffusionService','queryUserBalance','../../common/utils','cogVideoService','includes','../ai/stableDiffusion.service','Logger','你当前使用的应用已被下架、请删除当前对话开启新的对话吧！','2YvzLzW','openaiVoice','../plugin/plugin.entity','../ai/midjourneyDraw.service','buildMessageFromParentMessageId','end','arraybuffer','SunoService','../ai/lumaVideo.service','开始生成PPT','getDate','sunoService','】，在回答问题之前，先检索知识库内有没有相关的内容，尽量使用知识库中获取到的信息来回答我的问题，以知识库中的为准。','1\x20小时内对话次数过多，请切换模型或稍后再试！','match','chat-error\x20<----------------------------------------->','parse','PluginService','https://api.openai.com','chatHistory','defineProperty','任务提交失败，不执行扣费','preset','fileInfo','then','更新对话组标题失败:\x20','stringify','GlobalConfigService','__metadata','使用应用预设:\x20','\x20回复出错，本次不扣除积分','../app/app.entity','UserService','正在尝试转换URL为Base64:\x20','处理历史记录时出错:','default','../badWords/badWords.service','提交成功，歌曲生成中','ChatGroupService','isAIReplyEnabled','dalleDraw','OpenAIDrawService','IMAGINE','以下是我提供给你的知识库：【','@nestjs/typeorm','pluginKey','创意\x20AI','pluginImg','dall-e-3','__param','object','uploadService','/v1/audio/speech','1688886FyrROH','处理请求时发生错误','提交成功，视频生成中','saveChatLog','getTokenCount','getGroupInfoFromId','length','warn','MidjourneyService','replace','TTS\x20请求或上传过程失败:','from','9KQsSGV','catch','TTSService','AppEntity','image_url','pluginEntity','send','midjourney','isGeneratePromptReference','使用文件解析:\x20','uploadFile','187SbVTUo','模型切换错误，请检查全局模型配置！','成功获取图片，正在转换为Base64:\x20','chatFree','BAD_REQUEST','data','100%','error:\x20','userBalance','decorate','modelInfo','errMsg','插件调用成功\x20返回结果:\x20',',\x20消耗积分：\x20','globalConfigService','cog-video','固定模型、使用应用预设:\x20','checkAutoReply','appEntity','插件返回结果:\x20','validateBalance','../globalConfig/globalConfig.service','audio/mpeg','chatProcess','__esModule','Translate\x20any\x20given\x20phrase\x20from\x20any\x20language\x20into\x20English.\x20For\x20instance,\x20when\x20I\x20input\x20\x27{可爱的熊猫}\x27,\x20you\x20should\x20output\x20\x27{cute\x20panda}\x27,\x20with\x20no\x20period\x20at\x20the\x20end.','29348BsatYz','转换URL为Base64时发生错误:'];_0x5d28=function(){return _0x3e3d24;};return _0x5d28();}ChatService=__decorate([(0x0,common_1[_0x31d6ea(0x16e)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(config_entity_1[_0x31d6ea(0xa6)])),__param(0x1,(0x0,typeorm_1[_0x31d6ea(0x19f)])(app_entity_1[_0x31d6ea(0x125)])),__param(0x2,(0x0,typeorm_1[_0x31d6ea(0x19f)])(plugin_entity_1['PluginEntity'])),__metadata(_0x31d6ea(0x185),[typeorm_2[_0x31d6ea(0x17d)],typeorm_2[_0x31d6ea(0x17d)],typeorm_2[_0x31d6ea(0x17d)],suno_service_1[_0x31d6ea(0xe8)],openaiChat_service_1[_0x31d6ea(0x173)],chatLog_service_1['ChatLogService'],midjourneyDraw_service_1[_0x31d6ea(0x11e)],stableDiffusion_service_1['StableDiffusionService'],userBalance_service_1[_0x31d6ea(0x154)],user_service_1[_0x31d6ea(0x101)],upload_service_1[_0x31d6ea(0xbf)],badWords_service_1[_0x31d6ea(0x149)],autoreply_service_1[_0x31d6ea(0x18f)],globalConfig_service_1[_0x31d6ea(0xfc)],chatGroup_service_1[_0x31d6ea(0x107)],models_service_1[_0x31d6ea(0x181)],openaiDraw_service_1[_0x31d6ea(0x10a)],lumaVideo_service_1[_0x31d6ea(0xa0)],cogVideo_service_1[_0x31d6ea(0x161)],fluxDraw_service_1['FluxDrawService'],aiPPT_1['AiPptService']])],ChatService),exports[_0x31d6ea(0xc9)]=ChatService;