'use strict';const _0x132c1f=_0x2350;(function(_0x2488c8,_0x56d8aa){const _0x3a8c0c=_0x2350,_0x4c2d76=_0x2488c8();while(!![]){try{const _0x461b39=-parseInt(_0x3a8c0c(0x18d))/0x1+parseInt(_0x3a8c0c(0x1db))/0x2*(-parseInt(_0x3a8c0c(0x1fe))/0x3)+-parseInt(_0x3a8c0c(0x1ef))/0x4*(-parseInt(_0x3a8c0c(0x189))/0x5)+-parseInt(_0x3a8c0c(0x145))/0x6*(-parseInt(_0x3a8c0c(0x135))/0x7)+-parseInt(_0x3a8c0c(0x12f))/0x8*(-parseInt(_0x3a8c0c(0x118))/0x9)+parseInt(_0x3a8c0c(0x121))/0xa*(parseInt(_0x3a8c0c(0x1c9))/0xb)+parseInt(_0x3a8c0c(0x13a))/0xc;if(_0x461b39===_0x56d8aa)break;else _0x4c2d76['push'](_0x4c2d76['shift']());}catch(_0x21cc8a){_0x4c2d76['push'](_0x4c2d76['shift']());}}}(_0x308b,0xf19ad));function _0x2350(_0x4591d0,_0x5ebd64){const _0x308b1a=_0x308b();return _0x2350=function(_0x235041,_0x54fb93){_0x235041=_0x235041-0x116;let _0x17e1bb=_0x308b1a[_0x235041];return _0x17e1bb;},_0x2350(_0x4591d0,_0x5ebd64);}var __decorate=this&&this[_0x132c1f(0x13c)]||function(_0x817685,_0x377713,_0x366e99,_0x432320){const _0x3638e8=_0x132c1f;var _0x3848dd=arguments[_0x3638e8(0x138)],_0x1bbffc=_0x3848dd<0x3?_0x377713:_0x432320===null?_0x432320=Object['getOwnPropertyDescriptor'](_0x377713,_0x366e99):_0x432320,_0x4b9513;if(typeof Reflect===_0x3638e8(0x182)&&typeof Reflect[_0x3638e8(0x166)]===_0x3638e8(0x127))_0x1bbffc=Reflect['decorate'](_0x817685,_0x377713,_0x366e99,_0x432320);else{for(var _0x3508eb=_0x817685[_0x3638e8(0x138)]-0x1;_0x3508eb>=0x0;_0x3508eb--)if(_0x4b9513=_0x817685[_0x3508eb])_0x1bbffc=(_0x3848dd<0x3?_0x4b9513(_0x1bbffc):_0x3848dd>0x3?_0x4b9513(_0x377713,_0x366e99,_0x1bbffc):_0x4b9513(_0x377713,_0x366e99))||_0x1bbffc;}return _0x3848dd>0x3&&_0x1bbffc&&Object['defineProperty'](_0x377713,_0x366e99,_0x1bbffc),_0x1bbffc;},__metadata=this&&this[_0x132c1f(0x1fb)]||function(_0x45e420,_0x58161c){const _0x18f365=_0x132c1f;if(typeof Reflect===_0x18f365(0x182)&&typeof Reflect[_0x18f365(0x17f)]==='function')return Reflect[_0x18f365(0x17f)](_0x45e420,_0x58161c);},__param=this&&this[_0x132c1f(0x1bb)]||function(_0x15c827,_0x239443){return function(_0x5c50c8,_0x33c9cb){_0x239443(_0x5c50c8,_0x33c9cb,_0x15c827);};};Object[_0x132c1f(0x132)](exports,'__esModule',{'value':!![]}),exports[_0x132c1f(0x124)]=void 0x0;const utils_1=require(_0x132c1f(0x12b)),common_1=require('@nestjs/common'),typeorm_1=require(_0x132c1f(0x1dc)),axios_1=require(_0x132c1f(0x1c3)),typeorm_2=require('typeorm'),aiPPT_1=require(_0x132c1f(0x1ec)),cogVideo_service_1=require(_0x132c1f(0x1a1)),fluxDraw_service_1=require(_0x132c1f(0x1be)),lumaVideo_service_1=require(_0x132c1f(0x1e0)),midjourneyDraw_service_1=require(_0x132c1f(0x196)),openaiChat_service_1=require('../ai/openaiChat.service'),openaiDraw_service_1=require(_0x132c1f(0x15d)),stableDiffusion_service_1=require('../ai/stableDiffusion.service'),suno_service_1=require(_0x132c1f(0x1b9)),app_entity_1=require(_0x132c1f(0x149)),autoreply_service_1=require('../autoreply/autoreply.service'),badWords_service_1=require(_0x132c1f(0x1ba)),chatGroup_service_1=require('../chatGroup/chatGroup.service'),chatLog_service_1=require(_0x132c1f(0x1e8)),config_entity_1=require(_0x132c1f(0x199)),globalConfig_service_1=require('../globalConfig/globalConfig.service'),models_service_1=require(_0x132c1f(0x1c2)),plugin_entity_1=require('../plugin/plugin.entity'),upload_service_1=require('../upload/upload.service'),user_service_1=require('../user/user.service'),userBalance_service_1=require('../userBalance/userBalance.service');function _0x308b(){const _0x28f0cf=['toISOString','deductFromBalance','开始\x20TTS\x20请求:','arraybuffer','padStart','cog-video','warn','headers','role','userService','\x20消耗token:\x20','push','globalConfigService','getMonth','image_url','aiPPT','记录:','UploadService','../ai/suno.service','../badWords/badWords.service','__param','queryUserBalance','提交成功，歌曲生成中','../ai/fluxDraw.service','preset','你当前使用的应用已被下架、请删除当前对话开启新的对话吧！','使用全局预设:\x20','../models/models.service','axios','系统消息超过最大长度，将被截断','以下是我提供给你的知识库：【','用户ID:\x20','close','TTS\x20请求或上传过程失败:','303677TTbdfq','UserService','LumaVideoService','成功转换URL为Base64:\x20','usePlugin','fluxDrawService','配置解析错误！','IMAGINE','PluginService','luma-video','BAD_REQUEST','trim','pluginImg','插件返回结果:\x20',';base64,','getGroupInfoFromId','更新标题名称为:\x20','AutoreplyService','864172kRDWTV','@nestjs/typeorm','write','chatLogService','创意\x20AI','../ai/lumaVideo.service','updateChatLog','audio/openai/','answer','未找到当前模型key，切换至全局模型','gpts','getCurrentModelKeyInfo','status','../chatLog/chatLog.service','openAIDrawService','生成失败','OpenAIChatService','../ai/aiPPT','get','openaiTemperature','158380wGgQqq','isSensitiveWordFilter','openAIChatService','插件调用错误:\x20','title','ModelsService','splice','HttpStatus','isArray','Logger','OpenAIDrawService','systemPreMessage','__metadata','flux','model','9nmReGr','aiPptService','midjourneyDraw','send','cogVideo','saveChatLog','stable-diffusion','3979953EFkEHY','modelsService','checkAutoReply','error','modelInfo','POST','Injectable','lumaVideo','error:\x20','50IhZFuF','text','发生未知错误，请稍后再试','ChatService','debug','调用\x20chatFree\x20出错:\x20','function','checkBadWords','uploadFile','binary','../../common/utils','all','InjectRepository','ttsProcess','8PXWhXP','errMsg','update','defineProperty','isSystemPlugin','pluginUrl','758548EHfUtk','根据用户提问{','uploadService','length','chat-error\x20<----------------------------------------->','7180848UZysVl','ai-ppt','__decorate','生成中','getConfigs','openaiBaseKey','chatGroupService','design:paramtypes','mjTranslatePrompt','setHeader','checkUserStatus','96zVTHRE','buildMessageFromParentMessageId','assistant','模型切换错误，请检查全局模型配置！','../app/app.entity','findOne','catch','\x20模型名称:\x20','cogVideoService','end','then','绘制中','ChatGroupService','modelName','Bearer\x20','chatFree','】，在回答问题之前，先检索知识库内有没有相关的内容，尽量使用知识库中获取到的信息来回答我的问题，以知识库中的为准。','checkModelLimits','UPSCALE','固定模型、使用应用预设:\x20','content','updateTime','parameters','1\x20小时内对话次数过多，请切换模型或稍后再试！','../ai/openaiDraw.service','application/octet-stream;\x20charset=utf-8','插件调用成功\x20返回结果:\x20','SunoService','formatUrl','sdxl','config','user','userBalanceService','decorate','处理历史记录时出错:','stringify','appEntity','audio/mpeg','100%','ChatLogService','HttpException','\x20模型:\x20','正在尝试转换URL为Base64:\x20','fileInfo','includes','stableDiffusionService','发生错误:','userBalance','tts-1','开始生成PPT','base64','ConfigEntity','UserBalanceService','autoreplyService','log','split','replace','isAIReplyEnabled','metadata','/plugins/','getTokenCount','object','midjourney','成功获取图片，正在转换为Base64:\x20','system','TTSService','default','TTS\x20请求获取成功','80tPkvwP','处理请求时发生错误','ceil','midjourneyService','1260129oXuBLN','data:','chatHistory','application/json','pluginEntity','https://api.openai.com','badWordsService','Repository','data','../ai/midjourneyDraw.service','assign','isMjTranslate','../globalConfig/config.entity','slice','提交成功，视频生成中','dalleDraw','convertUrlToBase64','sunoService','pluginKey','openAIChat','../ai/cogVideo.service','join','任务提交失败，不执行扣费','dall-e-3','openaiBaseUrl','CogVideoService'];_0x308b=function(){return _0x28f0cf;};return _0x308b();}let ChatService=class ChatService{constructor(_0x3083f8,_0x5615fc,_0x3146fa,_0x45cc58,_0x522a8b,_0x208a96,_0x29b9aa,_0x1db9e1,_0x4509fd,_0x28afa9,_0x3ac2f5,_0x276503,_0x242c81,_0x10fc7d,_0x43555b,_0x3911bc,_0x342371,_0x74f405,_0x3b7f97,_0x428827,_0x27b005){const _0x3d4276=_0x132c1f;this['configEntity']=_0x3083f8,this[_0x3d4276(0x169)]=_0x5615fc,this['pluginEntity']=_0x3146fa,this[_0x3d4276(0x19e)]=_0x45cc58,this['openAIChatService']=_0x522a8b,this['chatLogService']=_0x208a96,this[_0x3d4276(0x18c)]=_0x29b9aa,this[_0x3d4276(0x172)]=_0x1db9e1,this['userBalanceService']=_0x4509fd,this[_0x3d4276(0x1b0)]=_0x28afa9,this[_0x3d4276(0x137)]=_0x3ac2f5,this[_0x3d4276(0x193)]=_0x276503,this[_0x3d4276(0x17a)]=_0x242c81,this[_0x3d4276(0x1b3)]=_0x10fc7d,this['chatGroupService']=_0x43555b,this['modelsService']=_0x3911bc,this['openAIDrawService']=_0x342371,this['lumaVideoService']=_0x74f405,this[_0x3d4276(0x14d)]=_0x3b7f97,this['fluxDrawService']=_0x428827,this['aiPptService']=_0x27b005;}async['chatProcess'](_0xf7a935,_0x258392,_0x1ff728){const _0x3e2b43=_0x132c1f;await this[_0x3e2b43(0x165)]['checkUserCertification'](_0x258392[_0x3e2b43(0x164)]['id']);const {options:options={},usingPluginId:_0x3b773c,appId:appId=null,specialModel:_0x3221cb,prompt:_0x586b89,fileInfo:_0x4ec67b,extraParam:_0x213c67,model:_0x348ff7,drawId:_0x4d1ed3,customId:_0x2e9e81,action:_0x13ab39,modelName:_0xe08db3,modelAvatar:_0x171984}=_0xf7a935;let _0x3a8127;if(_0x3221cb)_0x3a8127=await this[_0x3e2b43(0x169)][_0x3e2b43(0x14a)]({'where':{'des':_0x3221cb,'isSystemReserved':!![]}});else{if(appId){_0x3a8127=await this[_0x3e2b43(0x169)][_0x3e2b43(0x14a)]({'where':{'id':appId,'status':(0x0,typeorm_2['In'])([0x1,0x3,0x4,0x5])}});if(!_0x3a8127)throw new common_1[(_0x3e2b43(0x16d))](_0x3e2b43(0x1c0),common_1[_0x3e2b43(0x1f6)][_0x3e2b43(0x1d3)]);}}const {groupId:_0x2253d3,fileParsing:_0x5bd4fe}=options,{openaiTimeout:_0x2b9d98,openaiBaseUrl:_0xfc28a4,openaiBaseKey:_0x381b87,systemPreMessage:_0x3032cc,isMjTranslate:_0x481de7,mjTranslatePrompt:_0x38182e,openaiTemperature:_0x4a1421,openaiBaseModel:_0x396ad6,isGeneratePromptReference:_0x1d2820,isConvertToBase64:_0x21dc16,isSensitiveWordFilter:_0x4dc7a4}=await this[_0x3e2b43(0x1b3)][_0x3e2b43(0x13e)](['openaiTimeout',_0x3e2b43(0x1a5),_0x3e2b43(0x13f),_0x3e2b43(0x1fa),_0x3e2b43(0x198),_0x3e2b43(0x142),_0x3e2b43(0x1ee),'openaiBaseModel','isGeneratePromptReference','isConvertToBase64',_0x3e2b43(0x1f0)]);await this[_0x3e2b43(0x1b0)][_0x3e2b43(0x144)](_0x258392[_0x3e2b43(0x164)]),_0x1ff728&&_0x1ff728[_0x3e2b43(0x143)]('Content-type',_0x3e2b43(0x15e));if(_0x4dc7a4==='1'){const _0x496db4=await this[_0x3e2b43(0x193)][_0x3e2b43(0x128)](_0x586b89,_0x258392[_0x3e2b43(0x164)]['id']);if(_0x496db4[_0x3e2b43(0x138)]>0x0){const _0x1d3fcb='您提交的信息中包含违规的内容，我们已对您的账户进行标记，请合规使用！';throw new common_1['HttpException'](_0x1d3fcb,common_1[_0x3e2b43(0x1f6)][_0x3e2b43(0x1d3)]);}}const _0xb9e784=await this['autoreplyService'][_0x3e2b43(0x11a)](_0x586b89);let _0x4c37e0=null,_0x3f45bd='',_0x231d4d='';_0x1ff728&&_0x1ff728['status'](0xc8);let _0x4375e0=null;const _0x119662=(0x0,utils_1['getClientIp'])(_0x258392);let _0xc38097,_0x2c4193='',_0x5ede94;_0x3b773c&&(_0x5ede94=await this[_0x3e2b43(0x191)][_0x3e2b43(0x14a)]({'where':{'id':_0x3b773c}}));if(_0x3a8127){const {isGPTs:_0xbb9144,gizmoID:_0x2d939d,name:_0x508e27,isFixedModel:_0x162028,appModel:_0x1d92a1,coverImg:_0x4b7842}=_0x3a8127;_0x2c4193=_0x4b7842,_0x3f45bd=_0x508e27;if(_0xbb9144)_0x4c37e0=await this[_0x3e2b43(0x119)][_0x3e2b43(0x1e6)](_0x3e2b43(0x1e5)),_0x4c37e0[_0x3e2b43(0x1fd)]='gpt-4-gizmo-'+_0x2d939d;else!_0xbb9144&&_0x162028&&_0x1d92a1?(_0x3a8127[_0x3e2b43(0x1bf)]&&(_0x231d4d=_0x3a8127[_0x3e2b43(0x1bf)]),_0x4c37e0=await this[_0x3e2b43(0x119)][_0x3e2b43(0x1e6)](_0x1d92a1),_0x4c37e0[_0x3e2b43(0x1fd)]=_0x1d92a1,_0x5bd4fe&&(_0x231d4d=_0x231d4d+_0x3e2b43(0x1c5)+_0x5bd4fe+_0x3e2b43(0x155)),common_1[_0x3e2b43(0x1f8)][_0x3e2b43(0x17b)](_0x3e2b43(0x158)+_0x231d4d,_0x3e2b43(0x124))):(_0x3a8127[_0x3e2b43(0x1bf)]&&(_0x231d4d=_0x3a8127['preset']),_0x4c37e0=await this[_0x3e2b43(0x119)][_0x3e2b43(0x1e6)](_0x348ff7),_0x5bd4fe&&(_0x231d4d=_0x231d4d+_0x3e2b43(0x1c5)+_0x5bd4fe+'】，在回答问题之前，先检索知识库内有没有相关的内容，尽量使用知识库中获取到的信息来回答我的问题，以知识库中的为准。'),common_1[_0x3e2b43(0x1f8)][_0x3e2b43(0x17b)]('使用应用预设:\x20'+_0x231d4d,_0x3e2b43(0x124)));}else{const _0x3dee48=await this['chatGroupService'][_0x3e2b43(0x1d8)](_0x2253d3);if(_0x5ede94&&_0x5ede94[_0x3e2b43(0x133)]===0x0){let _0x3c1de7='';try{_0x3c1de7=await this[_0x3e2b43(0x1cd)](_0x586b89,_0x5ede94[_0x3e2b43(0x15b)]),common_1['Logger'][_0x3e2b43(0x17b)](_0x3e2b43(0x1d6)+_0x3c1de7,_0x3e2b43(0x124));}catch(_0x458961){_0x3c1de7=_0x586b89,common_1[_0x3e2b43(0x1f8)]['error'](_0x3e2b43(0x1f2)+_0x458961);}_0x231d4d=_0x3c1de7,_0x4c37e0=await this[_0x3e2b43(0x119)][_0x3e2b43(0x1e6)](_0x348ff7),common_1[_0x3e2b43(0x1f8)]['log']('使用插件预设:\x20'+_0x231d4d,_0x3e2b43(0x124));}else{if(_0x5bd4fe)_0x231d4d=_0x3e2b43(0x1c5)+_0x5bd4fe+_0x3e2b43(0x155),_0x4c37e0=await this['modelsService'][_0x3e2b43(0x1e6)](_0x348ff7),common_1[_0x3e2b43(0x1f8)][_0x3e2b43(0x17b)]('使用文件解析:\x20'+_0x231d4d,'ChatService');else{const _0x58cb18=new Date()[_0x3e2b43(0x1a7)]()[_0x3e2b43(0x17c)]('T')[0x0];_0x231d4d=_0x3032cc+('\x0a\x20Current\x20date:\x20'+_0x58cb18),_0x4c37e0=await this[_0x3e2b43(0x119)]['getCurrentModelKeyInfo'](_0x348ff7),common_1[_0x3e2b43(0x1f8)]['log'](_0x3e2b43(0x1c1)+_0x231d4d,'ChatService');}}}if(!_0x4c37e0){common_1[_0x3e2b43(0x1f8)][_0x3e2b43(0x125)](_0x3e2b43(0x1e4),_0x3e2b43(0x124)),_0x4c37e0=await this[_0x3e2b43(0x119)]['getCurrentModelKeyInfo'](_0x396ad6);const _0xff64fc=await this[_0x3e2b43(0x140)][_0x3e2b43(0x1d8)](_0x2253d3);let _0x432030=_0xff64fc[_0x3e2b43(0x163)];try{const _0xc119a9=JSON['parse'](_0xff64fc[_0x3e2b43(0x163)]);_0xc119a9[_0x3e2b43(0x11c)]&&(_0xc119a9['modelInfo']['modelName']=_0x4c37e0['modelName'],_0xc119a9[_0x3e2b43(0x11c)]['model']=_0x4c37e0[_0x3e2b43(0x1fd)],_0x432030=JSON[_0x3e2b43(0x168)](_0xc119a9));}catch(_0x2a39d8){common_1['Logger'][_0x3e2b43(0x125)](_0x3e2b43(0x148),_0x3e2b43(0x124));throw new common_1[(_0x3e2b43(0x16d))](_0x3e2b43(0x1cf),common_1[_0x3e2b43(0x1f6)][_0x3e2b43(0x1d3)]);}await this[_0x3e2b43(0x140)][_0x3e2b43(0x131)]({'groupId':_0x2253d3,'title':_0xff64fc[_0x3e2b43(0x1f3)],'isSticky':![],'config':_0x432030,'fileUrl':''},_0x258392);}const {deduct:_0xad31eb,isTokenBased:_0x24f8cc,tokenFeeRatio:_0x2d05d4,deductType:_0x499eba,key:_0x3c4835,id:_0x3e7439,maxRounds:_0x4f7535,proxyUrl:_0x141755,maxModelTokens:_0x381169,timeout:_0xb300e8,model:_0xdbd5a2,isFileUpload:_0x16294e,keyType:_0x1ccfd0}=_0x4c37e0;if(await this[_0x3e2b43(0x1de)][_0x3e2b43(0x156)](_0x258392['user'],_0xdbd5a2))throw new common_1[(_0x3e2b43(0x16d))](_0x3e2b43(0x15c),common_1[_0x3e2b43(0x1f6)]['TOO_MANY_REQUESTS']);if(_0x481de7==='1'&&_0x13ab39===_0x3e2b43(0x1d0)&&_0x348ff7===_0x3e2b43(0x183)){const [_0x5a0244,_0x3b5af0]=_0x586b89[_0x3e2b43(0x17c)](/(?= --)/),_0x27dd1d=/(https?:\/\/[^\s]+)/g,_0x1f7c17=_0x5a0244['match'](_0x27dd1d)||[];let _0x4f2f81=_0x5a0244[_0x3e2b43(0x17d)](_0x27dd1d,'')['trim']();const _0x2c4621=await this[_0x3e2b43(0x1f1)][_0x3e2b43(0x154)](_0x4f2f81,_0x38182e||'Translate\x20any\x20given\x20phrase\x20from\x20any\x20language\x20into\x20English.\x20For\x20instance,\x20when\x20I\x20input\x20\x27{可爱的熊猫}\x27,\x20you\x20should\x20output\x20\x27{cute\x20panda}\x27,\x20with\x20no\x20period\x20at\x20the\x20end.'),_0x52fb0e=[..._0x1f7c17,_0x2c4621][_0x3e2b43(0x1a2)]('\x20')[_0x3e2b43(0x1d4)]();_0xc38097=_0x3b5af0?''+_0x52fb0e+_0x3b5af0:_0x52fb0e,_0x16294e==='1'&&_0x4ec67b&&(_0xc38097=_0x4ec67b+'\x20'+_0xc38097);}else _0xc38097=_0x16294e==='1'&&_0x4ec67b?_0x4ec67b+'\x20'+_0x586b89:_0x586b89;await this[_0x3e2b43(0x165)]['validateBalance'](_0x258392,_0x499eba,_0xad31eb);const _0x3d61ce=_0xe08db3,_0x563c0f=(0x0,utils_1[_0x3e2b43(0x161)])(_0x141755||_0xfc28a4||_0x3e2b43(0x192)),_0x44ebfd=_0x3c4835||_0x381b87,_0x22a66a=(_0xb300e8||_0x2b9d98||0x12c)*0x3e8,_0x1770f6=Number(_0x4a1421)||0x1;if(_0x2253d3){const _0x53bd16=await this[_0x3e2b43(0x140)][_0x3e2b43(0x1d8)](_0x2253d3);this['updateChatTitle'](_0x2253d3,_0x53bd16,_0x1ccfd0,_0x586b89,_0x258392),await this[_0x3e2b43(0x140)][_0x3e2b43(0x15a)](_0x2253d3);}const _0x31f6bd=await this[_0x3e2b43(0x1de)][_0x3e2b43(0x116)]({'appId':appId,'curIp':_0x119662,'userId':_0x258392[_0x3e2b43(0x164)]['id'],'type':_0x1ccfd0?_0x1ccfd0:0x1,'prompt':_0x586b89,'fileInfo':_0x4ec67b?_0x4ec67b:null,'answer':'','promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0xdbd5a2,'modelName':'我','role':_0x3e2b43(0x164),'groupId':_0x2253d3?_0x2253d3:null}),_0x54ffa3=await this[_0x3e2b43(0x1de)][_0x3e2b43(0x116)]({'appId':appId?appId:null,'action':_0x13ab39?_0x13ab39:null,'curIp':_0x119662,'userId':_0x258392[_0x3e2b43(0x164)]['id'],'type':_0x1ccfd0?_0x1ccfd0:0x1,'prompt':_0x586b89,'fileInfo':null,'answer':'','progress':'0%','promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0xdbd5a2,'modelName':_0x3d61ce,'role':_0x3e2b43(0x147),'groupId':_0x2253d3?_0x2253d3:null,'status':0x2,'modelAvatar':(_0x5ede94===null||_0x5ede94===void 0x0?void 0x0:_0x5ede94[_0x3e2b43(0x1d5)])||_0x2c4193||_0x171984||'','pluginParam':(_0x5ede94===null||_0x5ede94===void 0x0?void 0x0:_0x5ede94[_0x3e2b43(0x15b)])?_0x5ede94[_0x3e2b43(0x15b)]:_0x1ccfd0===0x2?_0xdbd5a2:null}),_0x66697a=_0x31f6bd['id'],_0x4ddf31=_0x54ffa3['id'];if(_0xb9e784['answer']&&_0x1ff728){if(_0xb9e784[_0x3e2b43(0x17e)]===0x0){const _0x3c6db6=_0xb9e784[_0x3e2b43(0x1e3)][_0x3e2b43(0x17c)](''),_0x35e710=_0x44ea00=>{const _0x37a804=_0x3e2b43;if(_0x44ea00<_0x3c6db6[_0x37a804(0x138)]){const _0x3a48e6={'text':_0x3c6db6[_0x44ea00]};_0x1ff728[_0x37a804(0x1dd)](JSON[_0x37a804(0x168)](_0x3a48e6)+'\x0a'),setTimeout(()=>_0x35e710(_0x44ea00+0x1),0xa);}else _0x1ff728[_0x37a804(0x14e)]();};_0x35e710(0x0),await this[_0x3e2b43(0x1de)]['updateChatLog'](_0x4ddf31,{'answer':_0xb9e784[_0x3e2b43(0x1e3)]});return;}else _0x231d4d=_0x231d4d+_0xb9e784[_0x3e2b43(0x1e3)];}const {messagesHistory:_0x53bfaf}=await this[_0x3e2b43(0x146)](_0x586b89,{'groupId':_0x2253d3,'systemMessage':_0x231d4d,'maxModelTokens':_0x381169,'maxRounds':_0x4f7535,'isConvertToBase64':_0x21dc16,'fileInfo':_0x4ec67b,'model':_0xdbd5a2,'isFileUpload':_0x16294e},this['chatLogService']);let _0x175146=_0x13ab39!==_0x3e2b43(0x157)&&_0xdbd5a2===_0x3e2b43(0x183)?_0xad31eb*0x4:_0xad31eb;const _0x5c0bc7=new AbortController();try{if(_0x1ff728){_0x1ff728['on'](_0x3e2b43(0x1c7),()=>{_0x5c0bc7['abort']();});let _0x556e32,_0x235a4f=!![];try{if((_0xdbd5a2===_0x3e2b43(0x1a4)||_0xdbd5a2===_0x3e2b43(0x183)||_0xdbd5a2==='ai-ppt'||_0xdbd5a2==='suno-music'||_0xdbd5a2===_0x3e2b43(0x1d2)||_0xdbd5a2[_0x3e2b43(0x171)]('stable-diffusion')||_0xdbd5a2['includes'](_0x3e2b43(0x1ac))||_0xdbd5a2['includes'](_0x3e2b43(0x1fc)))&&_0x1ccfd0===0x2){if(_0xdbd5a2===_0x3e2b43(0x1a4))_0x556e32=this[_0x3e2b43(0x1e9)][_0x3e2b43(0x19c)]({'prompt':_0x586b89,'extraParam':_0x213c67,'apiKey':_0x44ebfd,'proxyUrl':_0x563c0f,'model':_0xdbd5a2,'timeout':_0x22a66a,'modelName':_0x3d61ce,'groupId':_0x2253d3,'onSuccess':async _0x118aec=>{const _0x30bf43=_0x3e2b43;await this['chatLogService'][_0x30bf43(0x1e1)](_0x4ddf31,{'fileInfo':_0x118aec===null||_0x118aec===void 0x0?void 0x0:_0x118aec['fileInfo'],'answer':(_0x118aec===null||_0x118aec===void 0x0?void 0x0:_0x118aec[_0x30bf43(0x1e3)])||_0x586b89,'progress':_0x30bf43(0x16b),'status':_0x118aec[_0x30bf43(0x1e7)]});},'onFailure':async _0x5ebb66=>{const _0x350cd3=_0x3e2b43;await this[_0x350cd3(0x1de)]['updateChatLog'](_0x4ddf31,{'answer':'绘图失败','status':_0x5ebb66[_0x350cd3(0x1e7)]});}},this['buildMessageFromParentMessageId']),await this['chatLogService']['updateChatLog'](_0x4ddf31,{'answer':_0x3e2b43(0x150)});else{if(_0xdbd5a2===_0x3e2b43(0x13b))common_1['Logger'][_0x3e2b43(0x17b)](_0x3e2b43(0x176),'DrawService'),_0x556e32=this[_0x3e2b43(0x1ff)][_0x3e2b43(0x1b6)]({'usePrompt':_0xc38097,'prompt':_0x586b89,'apiKey':_0x44ebfd,'proxyUrl':_0x563c0f,'model':_0xdbd5a2,'modelName':_0x3d61ce,'drawId':_0x4d1ed3,'customId':_0x2e9e81,'action':_0x13ab39,'timeout':_0x22a66a,'assistantLogId':_0x4ddf31,'extraParam':_0x213c67,'fileInfo':_0x4ec67b}),await this['chatLogService'][_0x3e2b43(0x1e1)](_0x4ddf31,{'answer':_0x3e2b43(0x13d)});else{if(_0xdbd5a2[_0x3e2b43(0x171)](_0x3e2b43(0x1fc)))_0x556e32=this[_0x3e2b43(0x1ce)]['fluxDraw']({'prompt':_0x586b89,'extraParam':_0x213c67,'apiKey':_0x44ebfd,'proxyUrl':_0x563c0f,'model':_0xdbd5a2,'timeout':_0x22a66a,'modelName':_0x3d61ce,'groupId':_0x2253d3,'onSuccess':async _0x107634=>{const _0x3d1b67=_0x3e2b43;await this['chatLogService'][_0x3d1b67(0x1e1)](_0x4ddf31,{'fileInfo':_0x107634===null||_0x107634===void 0x0?void 0x0:_0x107634[_0x3d1b67(0x170)],'answer':(_0x107634===null||_0x107634===void 0x0?void 0x0:_0x107634[_0x3d1b67(0x1e3)])||_0x586b89,'progress':_0x3d1b67(0x16b),'status':_0x107634[_0x3d1b67(0x1e7)]});},'onFailure':async _0x4568eb=>{const _0x461171=_0x3e2b43;await this['chatLogService'][_0x461171(0x1e1)](_0x4ddf31,{'answer':'绘图失败','status':_0x4568eb[_0x461171(0x1e7)]});}},this[_0x3e2b43(0x146)]),await this[_0x3e2b43(0x1de)][_0x3e2b43(0x1e1)](_0x4ddf31,{'answer':_0x3e2b43(0x150)});else{if(_0xdbd5a2[_0x3e2b43(0x171)]('suno-music'))_0x556e32=this[_0x3e2b43(0x19e)]['suno']({'assistantLogId':_0x4ddf31,'apiKey':_0x44ebfd,'action':_0x13ab39,'prompt':_0x586b89,'timeout':_0x22a66a,'proxyUrl':_0x563c0f,'taskData':_0x2e9e81}),await this[_0x3e2b43(0x1de)][_0x3e2b43(0x1e1)](_0x4ddf31,{'answer':_0x3e2b43(0x1bd)});else{if(_0xdbd5a2[_0x3e2b43(0x171)](_0x3e2b43(0x1d2)))_0x556e32=this['lumaVideoService'][_0x3e2b43(0x11f)]({'fileInfo':_0x4ec67b,'extraParam':_0x213c67,'assistantLogId':_0x4ddf31,'apiKey':_0x44ebfd,'action':_0x13ab39,'prompt':_0x586b89,'model':_0xdbd5a2,'timeout':_0x22a66a,'proxyUrl':_0x563c0f,'taskData':_0x2e9e81,'onGenerate':async _0x536c05=>{const _0x252c91=_0x3e2b43;await this[_0x252c91(0x1de)][_0x252c91(0x1e1)](_0x4ddf31,{'fileInfo':_0x536c05===null||_0x536c05===void 0x0?void 0x0:_0x536c05[_0x252c91(0x170)],'answer':(_0x536c05===null||_0x536c05===void 0x0?void 0x0:_0x536c05[_0x252c91(0x1e3)])||_0x586b89,'status':0x2});},'onSuccess':async _0x1705b4=>{const _0x16f4b4=_0x3e2b43;await this[_0x16f4b4(0x1de)][_0x16f4b4(0x1e1)](_0x4ddf31,{'fileInfo':_0x1705b4===null||_0x1705b4===void 0x0?void 0x0:_0x1705b4['fileInfo'],'answer':(_0x1705b4===null||_0x1705b4===void 0x0?void 0x0:_0x1705b4[_0x16f4b4(0x1e3)])||_0x586b89,'progress':_0x16f4b4(0x16b),'status':0x3});},'onFailure':async _0x2e4979=>{const _0x1f57f3=_0x3e2b43;await this[_0x1f57f3(0x1de)][_0x1f57f3(0x1e1)](_0x4ddf31,{'answer':_0x2e4979[_0x1f57f3(0x130)],'status':0x4});}}),await this[_0x3e2b43(0x1de)][_0x3e2b43(0x1e1)](_0x4ddf31,{'answer':'提交成功，视频生成中'});else{if(_0xdbd5a2[_0x3e2b43(0x171)](_0x3e2b43(0x1ac)))_0x556e32=this['cogVideoService'][_0x3e2b43(0x202)]({'fileInfo':_0x4ec67b,'extraParam':_0x213c67,'assistantLogId':_0x4ddf31,'apiKey':_0x44ebfd,'action':_0x13ab39,'prompt':_0x586b89,'model':_0xdbd5a2,'timeout':_0x22a66a,'proxyUrl':_0x563c0f,'taskData':_0x2e9e81,'onGenerate':async _0x5aeeb0=>{const _0x5c24d3=_0x3e2b43;await this['chatLogService'][_0x5c24d3(0x1e1)](_0x4ddf31,{'fileInfo':_0x5aeeb0===null||_0x5aeeb0===void 0x0?void 0x0:_0x5aeeb0['fileInfo'],'answer':(_0x5aeeb0===null||_0x5aeeb0===void 0x0?void 0x0:_0x5aeeb0[_0x5c24d3(0x1e3)])||_0x586b89,'status':0x2});},'onSuccess':async _0xbe392d=>{const _0x3cdc4e=_0x3e2b43;await this[_0x3cdc4e(0x1de)][_0x3cdc4e(0x1e1)](_0x4ddf31,{'fileInfo':_0xbe392d===null||_0xbe392d===void 0x0?void 0x0:_0xbe392d[_0x3cdc4e(0x170)],'answer':(_0xbe392d===null||_0xbe392d===void 0x0?void 0x0:_0xbe392d[_0x3cdc4e(0x1e3)])||_0x586b89,'progress':_0x3cdc4e(0x16b),'status':0x3});},'onFailure':async _0x22b7a3=>{const _0x9f74d9=_0x3e2b43;await this[_0x9f74d9(0x1de)][_0x9f74d9(0x1e1)](_0x4ddf31,{'answer':_0x22b7a3[_0x9f74d9(0x130)],'status':0x4});}}),await this[_0x3e2b43(0x1de)]['updateChatLog'](_0x4ddf31,{'answer':_0x3e2b43(0x19b)});else _0xdbd5a2['includes'](_0x3e2b43(0x117))?(_0x556e32=this[_0x3e2b43(0x172)][_0x3e2b43(0x162)]({'chatId':_0x4ddf31,'maxModelTokens':_0x381169,'apiKey':_0x44ebfd,'model':_0xdbd5a2,'modelName':_0x3d61ce,'modelType':_0x1ccfd0,'prompt':_0x586b89,'fileInfo':_0x4ec67b,'isFileUpload':_0x16294e,'timeout':_0x22a66a,'proxyUrl':_0x563c0f,'onSuccess':async _0x4e055f=>{const _0x4ed956=_0x3e2b43;await this['chatLogService'][_0x4ed956(0x1e1)](_0x4ddf31,{'fileInfo':_0x4e055f===null||_0x4e055f===void 0x0?void 0x0:_0x4e055f[_0x4ed956(0x170)],'answer':(_0x4e055f===null||_0x4e055f===void 0x0?void 0x0:_0x4e055f[_0x4ed956(0x1e3)])||_0x586b89,'progress':_0x4ed956(0x16b),'status':0x3});},'onFailure':async _0x46770c=>{const _0x5227e8=_0x3e2b43;await this['chatLogService'][_0x5227e8(0x1e1)](_0x4ddf31,{'answer':_0x5227e8(0x1ea),'status':0x4});}}),await this[_0x3e2b43(0x1de)]['updateChatLog'](_0x4ddf31,{'answer':_0x3e2b43(0x150)})):(_0x556e32=await this[_0x3e2b43(0x18c)][_0x3e2b43(0x200)]({'usePrompt':_0xc38097,'prompt':_0x586b89,'apiKey':_0x44ebfd,'proxyUrl':_0x563c0f,'model':_0xdbd5a2,'modelName':_0x3d61ce,'drawId':_0x4d1ed3,'customId':_0x2e9e81,'action':_0x13ab39,'fileInfo':_0x4ec67b,'timeout':_0x22a66a,'assistantLogId':_0x4ddf31,'pluginName':_0x5ede94}),await this['chatLogService']['updateChatLog'](_0x4ddf31,{'answer':_0x556e32[_0x3e2b43(0x1e3)],'status':_0x556e32[_0x3e2b43(0x1e7)]}));}}}}}_0x556e32[_0x3e2b43(0x1e7)]!==0x5?(await this[_0x3e2b43(0x119)]['saveUseLog'](_0x3e7439,0x1),await this[_0x3e2b43(0x165)][_0x3e2b43(0x1a8)](_0x258392['user']['id'],_0x499eba,_0x175146)):common_1[_0x3e2b43(0x1f8)][_0x3e2b43(0x17b)](_0x3e2b43(0x1a3),_0x3e2b43(0x124));const _0x457e1d=await this['userBalanceService'][_0x3e2b43(0x1bc)](_0x258392[_0x3e2b43(0x164)]['id']);return _0x556e32[_0x3e2b43(0x174)]=Object[_0x3e2b43(0x197)]({},_0x457e1d),_0x556e32[_0x3e2b43(0x122)]=_0x556e32['answer'],_0x556e32[_0x3e2b43(0x1e7)]=_0x556e32[_0x3e2b43(0x1e7)]||0x2,_0x556e32[_0x3e2b43(0x1fd)]=_0x348ff7,_0x556e32[_0x3e2b43(0x152)]=_0xe08db3,_0x1ff728[_0x3e2b43(0x1dd)]('\x0a'+JSON['stringify'](_0x556e32));}else{_0x556e32=await this[_0x3e2b43(0x1f1)][_0x3e2b43(0x1a0)](_0x53bfaf,{'chatId':_0x4ddf31,'maxModelTokens':_0x381169,'apiKey':_0x44ebfd,'model':_0xdbd5a2,'modelName':_0x3d61ce,'temperature':_0x1770f6,'modelType':_0x1ccfd0,'prompt':_0x586b89,'fileInfo':_0x4ec67b,'isFileUpload':_0x16294e,'timeout':_0x22a66a,'proxyUrl':_0x563c0f,'modelAvatar':_0x171984,'onProgress':_0x3adcf0=>{const _0x1153dc=_0x3e2b43;_0x1ff728[_0x1153dc(0x1dd)](_0x235a4f?JSON['stringify'](_0x3adcf0):'\x0a'+JSON[_0x1153dc(0x168)](_0x3adcf0)),_0x235a4f=![];},'onFailure':async _0x34ffa6=>{const _0x2c7373=_0x3e2b43;await this[_0x2c7373(0x1de)]['updateChatLog'](_0x4ddf31,{'answer':_0x34ffa6[_0x2c7373(0x130)],'status':0x4});},'abortController':_0x5c0bc7});if(_0x556e32[_0x3e2b43(0x130)])return common_1[_0x3e2b43(0x1f8)][_0x3e2b43(0x11b)](_0x3e2b43(0x1c6)+_0x258392['user']['id']+_0x3e2b43(0x14c)+_0x3d61ce+_0x3e2b43(0x16e)+_0x348ff7+'\x20回复出错，本次不扣除积分',_0x3e2b43(0x124)),_0x1ff728['write']('\x0a'+JSON[_0x3e2b43(0x168)](_0x556e32));let _0x2db102='';_0x53bfaf['forEach'](_0x3d09cb=>{const _0x70e7c7=_0x3e2b43;_0x2db102+=_0x3d09cb[_0x70e7c7(0x159)]+'\x20';});const _0x3ed15b=await(0x0,utils_1[_0x3e2b43(0x181)])(_0x2db102),_0x48c51d=await(0x0,utils_1['getTokenCount'])(_0x556e32[_0x3e2b43(0x1e3)]);await this['chatLogService']['updateChatLog'](_0x66697a,{'promptTokens':_0x3ed15b,'completionTokens':_0x48c51d,'totalTokens':_0x3ed15b+_0x48c51d});let _0x426b4a=_0x556e32[_0x3e2b43(0x1e3)];if(_0x4dc7a4==='1'){const _0x4c8b10=await this[_0x3e2b43(0x193)][_0x3e2b43(0x128)](_0x556e32[_0x3e2b43(0x1e3)],_0x258392[_0x3e2b43(0x164)]['id']);if(_0x4c8b10[_0x3e2b43(0x138)]>0x0){const _0x45abb6=new RegExp(_0x4c8b10['join']('|'),'gi');_0x426b4a=_0x426b4a[_0x3e2b43(0x17d)](_0x45abb6,_0x3d096a=>'*'['repeat'](_0x3d096a[_0x3e2b43(0x138)]));}}await this[_0x3e2b43(0x1de)]['updateChatLog'](_0x4ddf31,{'fileInfo':_0x556e32===null||_0x556e32===void 0x0?void 0x0:_0x556e32[_0x3e2b43(0x170)],'answer':_0x426b4a,'promptTokens':_0x3ed15b,'completionTokens':_0x48c51d,'totalTokens':_0x3ed15b+_0x48c51d,'status':0x3});try{if(_0x1d2820==='1'){const _0x126b9f=await this[_0x3e2b43(0x1f1)][_0x3e2b43(0x154)]('根据用户提问{'+_0x586b89+'}以及\x20AI\x20的回答{'+_0x556e32[_0x3e2b43(0x1e3)]+'}，生成三个更进入一步的提问，用{}包裹每个问题，不需要分行，不需要其他任何内容，单个提问不超过30个字');await this[_0x3e2b43(0x1de)][_0x3e2b43(0x1e1)](_0x4ddf31,{'promptReference':_0x126b9f});}}catch(_0x43a450){common_1[_0x3e2b43(0x1f8)][_0x3e2b43(0x11b)](_0x3e2b43(0x126)+_0x43a450);}_0x24f8cc===!![]&&(_0x175146=_0xad31eb*Math[_0x3e2b43(0x18b)]((_0x3ed15b+_0x48c51d)/_0x2d05d4));await this[_0x3e2b43(0x165)][_0x3e2b43(0x1a8)](_0x258392['user']['id'],_0x499eba,_0x175146,_0x3ed15b+_0x48c51d),await this[_0x3e2b43(0x119)]['saveUseLog'](_0x3e7439,_0x3ed15b+_0x48c51d),common_1[_0x3e2b43(0x1f8)][_0x3e2b43(0x17b)](_0x3e2b43(0x1c6)+_0x258392['user']['id']+_0x3e2b43(0x14c)+_0x3d61ce+_0x3e2b43(0x16e)+_0x348ff7+_0x3e2b43(0x1b1)+(_0x3ed15b+_0x48c51d)+',\x20消耗积分：\x20'+_0x175146,_0x3e2b43(0x124));const _0x2ce0b2=await this[_0x3e2b43(0x165)]['queryUserBalance'](_0x258392[_0x3e2b43(0x164)]['id']);return _0x556e32[_0x3e2b43(0x174)]=Object[_0x3e2b43(0x197)]({},_0x2ce0b2),_0x1ff728[_0x3e2b43(0x1dd)]('\x0a'+JSON[_0x3e2b43(0x168)](_0x556e32));}}catch(_0x97e26a){common_1[_0x3e2b43(0x1f8)][_0x3e2b43(0x11b)](_0x3e2b43(0x173),_0x97e26a),await this[_0x3e2b43(0x1de)][_0x3e2b43(0x1e1)](_0x4ddf31,{'status':0x5}),_0x556e32={'error':_0x3e2b43(0x18a)};}}else return _0x4375e0=await this[_0x3e2b43(0x1f1)][_0x3e2b43(0x1a0)](_0x53bfaf,{'chatId':_0x4ddf31,'maxModelTokens':_0x381169,'apiKey':_0x44ebfd,'model':_0xdbd5a2,'modelName':_0x3d61ce,'modelType':_0x1ccfd0,'temperature':_0x1770f6,'prompt':_0x586b89,'fileInfo':_0x4ec67b,'isFileUpload':_0x16294e,'timeout':_0x22a66a,'proxyUrl':_0x563c0f,'abortController':_0x5c0bc7}),await this[_0x3e2b43(0x165)][_0x3e2b43(0x1a8)](_0x258392[_0x3e2b43(0x164)]['id'],_0x499eba,_0x175146),_0x4375e0['answer'];}catch(_0x49b761){common_1['Logger'][_0x3e2b43(0x11b)](_0x3e2b43(0x139),_0x44ebfd,_0x49b761);if(_0x1ff728)return _0x1ff728[_0x3e2b43(0x1dd)](_0x3e2b43(0x123));else throw new common_1['HttpException'](_0x3e2b43(0x123),common_1['HttpStatus'][_0x3e2b43(0x1d3)]);}finally{_0x1ff728&&_0x1ff728[_0x3e2b43(0x14e)]();}}async[_0x132c1f(0x1cd)](_0x348b6b,_0xf5f060){const _0x3bd570=_0x132c1f,{pluginUrl:_0x15b24d,pluginKey:_0x3ae968}=await this[_0x3bd570(0x1b3)][_0x3bd570(0x13e)]([_0x3bd570(0x134),_0x3bd570(0x19f)]),_0x53795c=_0x3ae968,_0x46a537=_0x15b24d,_0x53c994={'method':'POST','url':_0x46a537+_0x3bd570(0x180)+_0xf5f060,'headers':{'Content-Type':_0x3bd570(0x190),'Authorization':_0x3bd570(0x153)+_0x53795c},'data':{'prompt':_0x348b6b}};try{const _0x25ef86=await(0x0,axios_1['default'])(_0x53c994);return common_1[_0x3bd570(0x1f8)][_0x3bd570(0x17b)](_0x3bd570(0x15f)+JSON[_0x3bd570(0x168)](_0x25ef86[_0x3bd570(0x195)],null,0x2),_0x3bd570(0x1d1)),_0x25ef86[_0x3bd570(0x195)][_0x3bd570(0x122)];}catch(_0x292f3e){common_1['Logger'][_0x3bd570(0x11b)](_0x3bd570(0x120),_0x292f3e);}}async['updateChatTitle'](_0x37e89b,_0xf59984,_0x302214,_0xf3d913,_0x171e78){const _0x34a0b0=_0x132c1f;if((_0xf59984===null||_0xf59984===void 0x0?void 0x0:_0xf59984[_0x34a0b0(0x1f3)])==='新对话'){let _0x476777;if(_0x302214===0x1)try{_0x476777=await this[_0x34a0b0(0x1f1)][_0x34a0b0(0x154)](_0x34a0b0(0x136)+_0xf3d913+'}，给这个对话取一个名字，不超过10个字'),_0x476777['length']>0xf&&(_0x476777=_0x476777['slice'](0x0,0xf));}catch(_0xd329eb){common_1[_0x34a0b0(0x1f8)][_0x34a0b0(0x11b)](_0x34a0b0(0x126)+_0xd329eb),_0x476777=_0xf3d913[_0x34a0b0(0x19a)](0x0,0xa);}else _0x476777=_0x34a0b0(0x1df);this[_0x34a0b0(0x140)][_0x34a0b0(0x131)]({'groupId':_0x37e89b,'title':_0x476777,'isSticky':![],'config':'','fileUrl':''},_0x171e78)[_0x34a0b0(0x14f)](()=>common_1[_0x34a0b0(0x1f8)][_0x34a0b0(0x17b)](_0x34a0b0(0x1d9)+_0x476777,_0x34a0b0(0x124)))[_0x34a0b0(0x14b)](_0x408dde=>common_1[_0x34a0b0(0x1f8)][_0x34a0b0(0x11b)]('更新对话组标题失败:\x20'+_0x408dde));}}async[_0x132c1f(0x146)](_0x3c0d19,_0x15830c,_0x1b9da1){const _0x2cf6d2=_0x132c1f;let {systemMessage:systemMessage='',fileInfo:_0x3a8853,groupId:_0x31eb4f,maxRounds:maxRounds=0x5,maxModelTokens:maxModelTokens=0x1f40,isFileUpload:isFileUpload=0x0,isConvertToBase64:_0x3dfca0}=_0x15830c;systemMessage[_0x2cf6d2(0x138)]>maxModelTokens&&(common_1[_0x2cf6d2(0x1f8)][_0x2cf6d2(0x17b)](_0x2cf6d2(0x1c4),_0x2cf6d2(0x124)),systemMessage=systemMessage[_0x2cf6d2(0x19a)](0x0,maxModelTokens));let _0x4054ee=[];systemMessage&&_0x4054ee[_0x2cf6d2(0x1b2)]({'role':_0x2cf6d2(0x185),'content':systemMessage});if(_0x31eb4f){const _0x2daf56=await _0x1b9da1[_0x2cf6d2(0x18f)](_0x31eb4f,maxRounds);let _0x207752=null;for(const _0x15a3b1 of _0x2daf56){try{let _0x3874b;if((isFileUpload===0x2||isFileUpload===0x3)&&_0x15a3b1[_0x2cf6d2(0x170)]&&_0x15a3b1[_0x2cf6d2(0x1af)]===_0x2cf6d2(0x164)){const _0x749876=await Promise[_0x2cf6d2(0x12c)](_0x15a3b1[_0x2cf6d2(0x170)][_0x2cf6d2(0x17c)](',')['map'](async _0x3a221b=>({'type':_0x2cf6d2(0x1b5),'image_url':{'url':_0x3dfca0==='1'?await this[_0x2cf6d2(0x19d)](_0x3a221b[_0x2cf6d2(0x1d4)]()):_0x3a221b[_0x2cf6d2(0x1d4)]()}})));_0x3874b=[{'type':_0x2cf6d2(0x122),'text':_0x15a3b1['text']},..._0x749876];}else isFileUpload===0x1&&_0x15a3b1[_0x2cf6d2(0x170)]&&_0x15a3b1['role']===_0x2cf6d2(0x164)?_0x3874b=_0x15a3b1[_0x2cf6d2(0x170)]+'\x0a'+_0x15a3b1['text']:_0x3874b=_0x15a3b1[_0x2cf6d2(0x122)];if(_0x15a3b1[_0x2cf6d2(0x1af)]===_0x2cf6d2(0x164))_0x207752={'role':_0x15a3b1[_0x2cf6d2(0x1af)],'content':_0x3874b};else{if(_0x15a3b1[_0x2cf6d2(0x1af)]==='assistant'){const _0x389c07=Array[_0x2cf6d2(0x1f7)](_0x3874b)?JSON[_0x2cf6d2(0x168)](_0x3874b):_0x3874b;_0x207752&&_0x389c07[_0x2cf6d2(0x1d4)]()!==''&&(_0x4054ee['push'](_0x207752),_0x4054ee['push']({'role':_0x15a3b1[_0x2cf6d2(0x1af)],'content':_0x3874b}),_0x207752=null);}}}catch(_0x1f4546){common_1[_0x2cf6d2(0x1f8)][_0x2cf6d2(0x11b)](_0x2cf6d2(0x167),_0x1f4546,_0x2cf6d2(0x1b7),JSON[_0x2cf6d2(0x168)](_0x15a3b1,null,0x2));}}}let _0x28973f;if((isFileUpload===0x2||isFileUpload===0x3)&&_0x3a8853){const _0x26d389=await Promise['all'](_0x3a8853[_0x2cf6d2(0x17c)](',')['map'](async _0xf50d77=>({'type':_0x2cf6d2(0x1b5),'image_url':{'url':_0x3dfca0==='1'?await this[_0x2cf6d2(0x19d)](_0xf50d77[_0x2cf6d2(0x1d4)]()):_0xf50d77[_0x2cf6d2(0x1d4)]()}})));_0x28973f=[{'type':_0x2cf6d2(0x122),'text':_0x3c0d19},..._0x26d389];}else isFileUpload===0x1&&_0x3a8853?_0x28973f=_0x3a8853+'\x0a'+_0x3c0d19:_0x28973f=_0x3c0d19;_0x4054ee[_0x2cf6d2(0x1b2)]({'role':_0x2cf6d2(0x164),'content':_0x28973f});let _0x341df5=await(0x0,utils_1['getTokenCount'])(_0x4054ee),_0x48ac80;maxModelTokens<0x1f40?_0x48ac80=0xfa0:_0x48ac80=maxModelTokens-0xfa0;while(_0x341df5>_0x48ac80){if(_0x4054ee[_0x2cf6d2(0x138)]===0x2&&_0x4054ee[0x0][_0x2cf6d2(0x1af)]===_0x2cf6d2(0x185)&&_0x4054ee[0x1][_0x2cf6d2(0x1af)]===_0x2cf6d2(0x164))break;let _0xbfd39e=![];for(let _0xea2e82=0x0;_0xea2e82<_0x4054ee[_0x2cf6d2(0x138)];_0xea2e82++){if(_0x4054ee[_0xea2e82]['role']!==_0x2cf6d2(0x185)&&_0x4054ee[_0xea2e82+0x1]&&_0x4054ee[_0xea2e82+0x1]['role']===_0x2cf6d2(0x147)){_0x4054ee[_0x2cf6d2(0x1f5)](_0xea2e82,0x2),_0xbfd39e=!![];break;}}if(!_0xbfd39e)for(let _0x5c46be=0x0;_0x5c46be<_0x4054ee[_0x2cf6d2(0x138)];_0x5c46be++){if(_0x4054ee[_0x5c46be]['role']===_0x2cf6d2(0x164)){_0x4054ee[_0x2cf6d2(0x1f5)](_0x5c46be,0x1);break;}}_0x341df5=await(0x0,utils_1[_0x2cf6d2(0x181)])(_0x4054ee);if(_0x4054ee[_0x2cf6d2(0x138)]<=0x2)break;}return{'messagesHistory':_0x4054ee,'round':_0x4054ee[_0x2cf6d2(0x138)]};}async[_0x132c1f(0x19d)](_0x18686c){const _0x183cbf=_0x132c1f;try{console['log'](_0x183cbf(0x16f)+_0x18686c);const _0x2df347=await axios_1[_0x183cbf(0x187)][_0x183cbf(0x1ed)](_0x18686c,{'responseType':_0x183cbf(0x1aa)}),_0x4e401b=Buffer['from'](_0x2df347[_0x183cbf(0x195)],_0x183cbf(0x12a));console[_0x183cbf(0x17b)](_0x183cbf(0x184)+_0x18686c);const _0x47490e=_0x183cbf(0x18e)+_0x2df347[_0x183cbf(0x1ae)]['content-type']+_0x183cbf(0x1d7)+_0x4e401b['toString'](_0x183cbf(0x177));return console[_0x183cbf(0x17b)](_0x183cbf(0x1cc)+_0x18686c),_0x47490e;}catch(_0x13465f){return console[_0x183cbf(0x11b)]('转换URL为Base64时发生错误:',_0x13465f),console[_0x183cbf(0x1ad)]('返回原始链接:\x20'+_0x18686c),_0x18686c;}}async[_0x132c1f(0x12e)](_0x4f9192,_0x20cd45,_0x2a7fad){const _0x40d25f=_0x132c1f,{chatId:_0xbc9fab,prompt:_0x49d350}=_0x4f9192,_0x427108=await this[_0x40d25f(0x119)][_0x40d25f(0x1e6)](_0x40d25f(0x175)),{openaiTimeout:_0x3f886e,openaiBaseUrl:_0x5c5e30,openaiBaseKey:_0x52f49b,openaiVoice:_0x274b11}=await this[_0x40d25f(0x1b3)]['getConfigs'](['openaiTimeout',_0x40d25f(0x1a5),_0x40d25f(0x13f),'openaiVoice']),{key:_0x429892,proxyUrl:_0x3392ab,deduct:_0x5ee5ad,deductType:_0x4acb25,timeout:_0x566547}=_0x427108,_0x228993=_0x429892||_0x52f49b,_0x3b0b81=(0x0,utils_1[_0x40d25f(0x161)])(_0x3392ab||_0x5c5e30),_0x2f5cb7=(_0x566547||_0x3f886e)*0x3e8;await this[_0x40d25f(0x165)]['validateBalance'](_0x20cd45,_0x4acb25,_0x5ee5ad),common_1[_0x40d25f(0x1f8)][_0x40d25f(0x17b)](_0x40d25f(0x1a9),_0x49d350,_0x40d25f(0x186));const _0x58d7bc={'method':_0x40d25f(0x11d),'url':_0x3b0b81+'/v1/audio/speech','headers':{'Content-Type':_0x40d25f(0x190),'Authorization':'Bearer\x20'+_0x228993},'responseType':'arraybuffer','timeout':_0x2f5cb7,'data':{'model':_0x40d25f(0x175),'input':_0x49d350,'voice':_0x274b11||'onyx'}};try{const _0x468f42=await(0x0,axios_1['default'])(_0x58d7bc);common_1['Logger'][_0x40d25f(0x17b)](_0x40d25f(0x188),_0x40d25f(0x186));const _0x54252f=Buffer['from'](_0x468f42['data']),_0x2c9f0b=new Date(),_0x1eb870=_0x2c9f0b['getFullYear'](),_0x3a5c35=String(_0x2c9f0b[_0x40d25f(0x1b4)]()+0x1)[_0x40d25f(0x1ab)](0x2,'0'),_0x4b674f=String(_0x2c9f0b['getDate']())['padStart'](0x2,'0'),_0x3938c1=''+_0x1eb870+_0x3a5c35+'/'+_0x4b674f,_0x6abea8=await this[_0x40d25f(0x137)][_0x40d25f(0x129)]({'buffer':_0x54252f,'mimetype':_0x40d25f(0x16a)},_0x40d25f(0x1e2)+_0x3938c1);await Promise[_0x40d25f(0x12c)]([this['chatLogService']['updateChatLog'](_0xbc9fab,{'ttsUrl':_0x6abea8}),this[_0x40d25f(0x165)]['deductFromBalance'](_0x20cd45[_0x40d25f(0x164)]['id'],_0x4acb25,_0x5ee5ad)]),_0x2a7fad[_0x40d25f(0x1e7)](0xc8)[_0x40d25f(0x201)]({'ttsUrl':_0x6abea8});}catch(_0xe50d2f){common_1[_0x40d25f(0x1f8)][_0x40d25f(0x11b)](_0x40d25f(0x1c8),_0xe50d2f,'TTSService'),_0x2a7fad[_0x40d25f(0x1e7)](0x1f4)['send']({'error':'Failed\x20to\x20process\x20TTS\x20request'});}}};ChatService=__decorate([(0x0,common_1[_0x132c1f(0x11e)])(),__param(0x0,(0x0,typeorm_1[_0x132c1f(0x12d)])(config_entity_1[_0x132c1f(0x178)])),__param(0x1,(0x0,typeorm_1[_0x132c1f(0x12d)])(app_entity_1['AppEntity'])),__param(0x2,(0x0,typeorm_1[_0x132c1f(0x12d)])(plugin_entity_1['PluginEntity'])),__metadata(_0x132c1f(0x141),[typeorm_2[_0x132c1f(0x194)],typeorm_2[_0x132c1f(0x194)],typeorm_2['Repository'],suno_service_1[_0x132c1f(0x160)],openaiChat_service_1[_0x132c1f(0x1eb)],chatLog_service_1[_0x132c1f(0x16c)],midjourneyDraw_service_1['MidjourneyService'],stableDiffusion_service_1['StableDiffusionService'],userBalance_service_1[_0x132c1f(0x179)],user_service_1[_0x132c1f(0x1ca)],upload_service_1[_0x132c1f(0x1b8)],badWords_service_1['BadWordsService'],autoreply_service_1[_0x132c1f(0x1da)],globalConfig_service_1['GlobalConfigService'],chatGroup_service_1[_0x132c1f(0x151)],models_service_1[_0x132c1f(0x1f4)],openaiDraw_service_1[_0x132c1f(0x1f9)],lumaVideo_service_1[_0x132c1f(0x1cb)],cogVideo_service_1[_0x132c1f(0x1a6)],fluxDraw_service_1['FluxDrawService'],aiPPT_1['AiPptService']])],ChatService),exports[_0x132c1f(0x124)]=ChatService;