'use strict';const _0x4f80b8=_0xa2ca;(function(_0x2fb976,_0x42d039){const _0x5183ca=_0xa2ca,_0x57f7aa=_0x2fb976();while(!![]){try{const _0x595b96=-parseInt(_0x5183ca(0x190))/0x1+parseInt(_0x5183ca(0x222))/0x2+parseInt(_0x5183ca(0x23c))/0x3+-parseInt(_0x5183ca(0x234))/0x4*(parseInt(_0x5183ca(0x22c))/0x5)+-parseInt(_0x5183ca(0x25e))/0x6*(-parseInt(_0x5183ca(0x20f))/0x7)+-parseInt(_0x5183ca(0x19e))/0x8+parseInt(_0x5183ca(0x1ea))/0x9;if(_0x595b96===_0x42d039)break;else _0x57f7aa['push'](_0x57f7aa['shift']());}catch(_0x359e31){_0x57f7aa['push'](_0x57f7aa['shift']());}}}(_0x4c8a,0x4e0c3));function _0xa2ca(_0x175e42,_0x602a11){const _0x4c8afe=_0x4c8a();return _0xa2ca=function(_0xa2cad6,_0x1df067){_0xa2cad6=_0xa2cad6-0x18e;let _0x1aba15=_0x4c8afe[_0xa2cad6];return _0x1aba15;},_0xa2ca(_0x175e42,_0x602a11);}var __decorate=this&&this[_0x4f80b8(0x1e1)]||function(_0x107424,_0x1ebf8b,_0x5abf09,_0xe93b19){const _0x5df459=_0x4f80b8;var _0x33f890=arguments[_0x5df459(0x24e)],_0x171535=_0x33f890<0x3?_0x1ebf8b:_0xe93b19===null?_0xe93b19=Object[_0x5df459(0x1a2)](_0x1ebf8b,_0x5abf09):_0xe93b19,_0x11e2ef;if(typeof Reflect===_0x5df459(0x246)&&typeof Reflect[_0x5df459(0x21f)]==='function')_0x171535=Reflect[_0x5df459(0x21f)](_0x107424,_0x1ebf8b,_0x5abf09,_0xe93b19);else{for(var _0x1ea1c5=_0x107424[_0x5df459(0x24e)]-0x1;_0x1ea1c5>=0x0;_0x1ea1c5--)if(_0x11e2ef=_0x107424[_0x1ea1c5])_0x171535=(_0x33f890<0x3?_0x11e2ef(_0x171535):_0x33f890>0x3?_0x11e2ef(_0x1ebf8b,_0x5abf09,_0x171535):_0x11e2ef(_0x1ebf8b,_0x5abf09))||_0x171535;}return _0x33f890>0x3&&_0x171535&&Object[_0x5df459(0x265)](_0x1ebf8b,_0x5abf09,_0x171535),_0x171535;},__metadata=this&&this[_0x4f80b8(0x21c)]||function(_0x1eff02,_0x5eff42){const _0x13e536=_0x4f80b8;if(typeof Reflect===_0x13e536(0x246)&&typeof Reflect['metadata']===_0x13e536(0x1e5))return Reflect['metadata'](_0x1eff02,_0x5eff42);},__param=this&&this[_0x4f80b8(0x232)]||function(_0x35abc8,_0x38db98){return function(_0x182d64,_0x5dc7fb){_0x38db98(_0x182d64,_0x5dc7fb,_0x35abc8);};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[_0x4f80b8(0x228)]=void 0x0;function _0x4c8a(){const _0x40b529=['toISOString','push','modelName','data','UPSCALE','UploadService','midjourney','Bearer\x20','getTokenCount','object','all','title','cog-video','发生错误:','isGeneratePromptReference','】，在回答问题之前，先检索知识库内有没有相关的内容，尽量使用知识库中获取到的信息来回答我的问题，以知识库中的为准。','DrawService','length','openaiBaseModel','ModelsService','您提交的信息中包含违规的内容，我们已对您的账户进行标记，请合规使用！','debug','openAIChatService','模型切换错误，请检查全局模型配置！','typeorm','chatFree','1\x20小时内对话次数过多，请切换模型或稍后再试！','/plugins/','lumaVideo','\x20模型名称:\x20','setHeader','创意\x20AI','autoreplyService','54042zIEJsa','HttpStatus','aiPptService','isConvertToBase64','配置解析错误！','fluxDraw','usePlugin','defineProperty','uploadService','正在尝试转换URL为Base64:\x20','发生未知错误，请稍后再试','AutoreplyService','../autoreply/autoreply.service','返回原始链接:\x20','configEntity','buildMessageFromParentMessageId','绘制中','suno-music','warn','saveUseLog','转换URL为Base64时发生错误:','systemPreMessage','gpts','Repository','openAIDrawService','validateBalance','join','convertUrlToBase64','send','modelInfo','trim','CogVideoService','updateChatTitle','SunoService','openaiVoice','开始\x20TTS\x20请求:','fluxDrawService','answer','close','checkAutoReply','TOO_MANY_REQUESTS','使用全局预设:\x20','luma-video','stringify','\x20消耗token:\x20','preset','TTS\x20请求或上传过程失败:','openaiBaseKey','formatUrl','abort','455586gJTVsH','default','text','cogVideoService','../app/app.entity','../ai/openaiChat.service','BAD_REQUEST','update','end','绘图失败','suno','fileInfo','生成失败','includes','2081680jCxIEf','StableDiffusionService','ChatLogService','data:','getOwnPropertyDescriptor','binary','100%','InjectRepository','openaiBaseUrl','../globalConfig/config.entity','isAIReplyEnabled',',\x20消耗积分：\x20','用户ID:\x20','UserService','assign','userService','toString','findOne','flux','TTSService','生成中','Content-type','}以及\x20AI\x20的回答{','globalConfigService','openaiTimeout','以下是我提供给你的知识库：【','ChatGroupService','parameters','config','pluginEntity','未找到当前模型key，切换至全局模型','GlobalConfigService','content','arraybuffer','write',';base64,','splice','getFullYear','stableDiffusionService','error','chatHistory','model','提交成功，歌曲生成中','sdxl','updateTime','isSensitiveWordFilter','OpenAIChatService','../ai/midjourneyDraw.service','../models/models.service','assistant','PluginEntity','AppEntity','badWordsService','error:\x20','appEntity','userBalanceService','成功获取图片，正在转换为Base64:\x20','../ai/cogVideo.service','updateChatLog','dalleDraw','match','@nestjs/typeorm','role','ConfigEntity','checkUserStatus','../badWords/badWords.service','getCurrentModelKeyInfo','__decorate','base64','from','catch','function','isMjTranslate','padStart','Injectable','chatGroupService','5373891luJtPR','getGroupInfoFromId','system','application/octet-stream;\x20charset=utf-8','image_url','../ai/stableDiffusion.service','sunoService','../userBalance/userBalance.service','}，给这个对话取一个名字，不超过10个字','design:paramtypes','../../common/utils','midjourneyService','../globalConfig/globalConfig.service','dall-e-3','tts-1','midjourneyDraw','parse','isSystemPlugin','Failed\x20to\x20process\x20TTS\x20request','deductFromBalance','调用\x20chatFree\x20出错:\x20','getClientIp','modelsService','checkBadWords','isArray','axios','status','lumaVideoService','开始生成PPT','}，生成三个更进入一步的提问，用{}包裹每个问题，不需要分行，不需要其他任何内容，单个提问不超过30个字','../ai/suno.service','user','chatLogService','LumaVideoService','HttpException','ai-ppt','TTS\x20请求获取成功','196GUbwmd','getMonth','repeat','PluginService','FluxDrawService','@nestjs/common','POST','https://api.openai.com','getConfigs','replace','slice','ceil','使用文件解析:\x20','__metadata','log','../chatGroup/chatGroup.service','decorate','新对话','errMsg','864396OHbApS','saveChatLog','../chatLog/chatLog.service','使用应用预设:\x20','pluginKey','\x20回复出错，本次不扣除积分','ChatService','../ai/lumaVideo.service','userBalance','../ai/fluxDraw.service','745zwqnrj','onyx','split','pluginImg','application/json','系统消息超过最大长度，将被截断','__param','任务提交失败，不执行扣费','14792eMfVeP','ttsProcess','根据用户提问{','audio/mpeg','checkModelLimits','/v1/audio/speech','Logger','\x20模型:\x20','914964kIouEW'];_0x4c8a=function(){return _0x40b529;};return _0x4c8a();}const utils_1=require(_0x4f80b8(0x1f4)),common_1=require(_0x4f80b8(0x214)),typeorm_1=require(_0x4f80b8(0x1db)),axios_1=require(_0x4f80b8(0x203)),typeorm_2=require(_0x4f80b8(0x255)),aiPPT_1=require('../ai/aiPPT'),cogVideo_service_1=require(_0x4f80b8(0x1d7)),fluxDraw_service_1=require(_0x4f80b8(0x22b)),lumaVideo_service_1=require(_0x4f80b8(0x229)),midjourneyDraw_service_1=require(_0x4f80b8(0x1cd)),openaiChat_service_1=require(_0x4f80b8(0x195)),openaiDraw_service_1=require('../ai/openaiDraw.service'),stableDiffusion_service_1=require(_0x4f80b8(0x1ef)),suno_service_1=require(_0x4f80b8(0x208)),app_entity_1=require(_0x4f80b8(0x194)),autoreply_service_1=require(_0x4f80b8(0x26a)),badWords_service_1=require(_0x4f80b8(0x1df)),chatGroup_service_1=require(_0x4f80b8(0x21e)),chatLog_service_1=require(_0x4f80b8(0x224)),config_entity_1=require(_0x4f80b8(0x1a7)),globalConfig_service_1=require(_0x4f80b8(0x1f6)),models_service_1=require(_0x4f80b8(0x1ce)),plugin_entity_1=require('../plugin/plugin.entity'),upload_service_1=require('../upload/upload.service'),user_service_1=require('../user/user.service'),userBalance_service_1=require(_0x4f80b8(0x1f1));let ChatService=class ChatService{constructor(_0x5dc48e,_0x2993c5,_0x1d9cdd,_0x37d182,_0x31b894,_0x225ac5,_0x46d305,_0x46e17f,_0x538c76,_0xacc127,_0x5d809b,_0x10d4ec,_0xbe6f0e,_0x298cb5,_0x3c5a14,_0x257fc7,_0x44aef4,_0x493fce,_0x29c520,_0x1b3541,_0x40746d){const _0x324b8e=_0x4f80b8;this[_0x324b8e(0x26c)]=_0x5dc48e,this[_0x324b8e(0x1d4)]=_0x2993c5,this[_0x324b8e(0x1bb)]=_0x1d9cdd,this[_0x324b8e(0x1f0)]=_0x37d182,this[_0x324b8e(0x253)]=_0x31b894,this[_0x324b8e(0x20a)]=_0x225ac5,this['midjourneyService']=_0x46d305,this[_0x324b8e(0x1c4)]=_0x46e17f,this[_0x324b8e(0x1d5)]=_0x538c76,this[_0x324b8e(0x1ad)]=_0xacc127,this[_0x324b8e(0x266)]=_0x5d809b,this['badWordsService']=_0x10d4ec,this[_0x324b8e(0x25d)]=_0xbe6f0e,this[_0x324b8e(0x1b5)]=_0x298cb5,this[_0x324b8e(0x1e9)]=_0x3c5a14,this[_0x324b8e(0x200)]=_0x257fc7,this[_0x324b8e(0x276)]=_0x44aef4,this[_0x324b8e(0x205)]=_0x493fce,this[_0x324b8e(0x193)]=_0x29c520,this[_0x324b8e(0x282)]=_0x1b3541,this[_0x324b8e(0x260)]=_0x40746d;}async['chatProcess'](_0xbf9afd,_0x30e9a8,_0x393be3){const _0x41d727=_0x4f80b8;await this['userBalanceService']['checkUserCertification'](_0x30e9a8['user']['id']);const {options:options={},usingPluginId:_0x2edc18,appId:appId=null,specialModel:_0x3ba7f4,prompt:_0x459bbf,fileInfo:_0x5a128f,extraParam:_0x39385c,model:_0x5334f9,drawId:_0x12e199,customId:_0x4e14a9,action:_0x2ed439,modelName:_0xd163a3,modelAvatar:_0x35c7d6}=_0xbf9afd;let _0x438f5a;if(_0x3ba7f4)_0x438f5a=await this[_0x41d727(0x1d4)][_0x41d727(0x1af)]({'where':{'des':_0x3ba7f4,'isSystemReserved':!![]}});else{if(appId){_0x438f5a=await this[_0x41d727(0x1d4)]['findOne']({'where':{'id':appId,'status':(0x0,typeorm_2['In'])([0x1,0x3,0x4,0x5])}});if(!_0x438f5a)throw new common_1['HttpException']('你当前使用的应用已被下架、请删除当前对话开启新的对话吧！',common_1['HttpStatus'][_0x41d727(0x196)]);}}const {groupId:_0x183059,fileParsing:_0xec2ce1}=options,{openaiTimeout:_0x47efda,openaiBaseUrl:_0x565b3d,openaiBaseKey:_0x1bd285,systemPreMessage:_0x492696,isMjTranslate:_0x1883a0,mjTranslatePrompt:_0x269af1,openaiTemperature:_0x2264e7,openaiBaseModel:_0x20de41,isGeneratePromptReference:_0x17fac8,isConvertToBase64:_0x3ead43,isSensitiveWordFilter:_0x14c80a}=await this[_0x41d727(0x1b5)][_0x41d727(0x217)]([_0x41d727(0x1b6),'openaiBaseUrl',_0x41d727(0x28d),_0x41d727(0x273),_0x41d727(0x1e6),'mjTranslatePrompt','openaiTemperature',_0x41d727(0x24f),_0x41d727(0x24b),_0x41d727(0x261),_0x41d727(0x1cb)]);await this[_0x41d727(0x1ad)][_0x41d727(0x1de)](_0x30e9a8[_0x41d727(0x209)]),_0x393be3&&_0x393be3[_0x41d727(0x25b)](_0x41d727(0x1b3),_0x41d727(0x1ed));if(_0x14c80a==='1'){const _0x4b9bf0=await this[_0x41d727(0x1d2)][_0x41d727(0x201)](_0x459bbf,_0x30e9a8[_0x41d727(0x209)]['id']);if(_0x4b9bf0[_0x41d727(0x24e)]>0x0){const _0x1a4baa=_0x41d727(0x251);throw new common_1[(_0x41d727(0x20c))](_0x1a4baa,common_1[_0x41d727(0x25f)][_0x41d727(0x196)]);}}const _0x329de9=await this[_0x41d727(0x25d)][_0x41d727(0x285)](_0x459bbf);let _0x2b6b88=null,_0x137084='',_0x5dcf22='';_0x393be3&&_0x393be3[_0x41d727(0x204)](0xc8);let _0x27f8fc=null;const _0x24be22=(0x0,utils_1[_0x41d727(0x1ff)])(_0x30e9a8);let _0x50b6fa,_0x35c483='',_0x52b6e2;_0x2edc18&&(_0x52b6e2=await this[_0x41d727(0x1bb)][_0x41d727(0x1af)]({'where':{'id':_0x2edc18}}));if(_0x438f5a){const {isGPTs:_0x4407d3,gizmoID:_0x1c6a8b,name:_0x2ca741,isFixedModel:_0x578051,appModel:_0x482b6e,coverImg:_0x311ed3}=_0x438f5a;_0x35c483=_0x311ed3,_0x137084=_0x2ca741;if(_0x4407d3)_0x2b6b88=await this[_0x41d727(0x200)][_0x41d727(0x1e0)](_0x41d727(0x274)),_0x2b6b88[_0x41d727(0x1c7)]='gpt-4-gizmo-'+_0x1c6a8b;else!_0x4407d3&&_0x578051&&_0x482b6e?(_0x438f5a['preset']&&(_0x5dcf22=_0x438f5a[_0x41d727(0x28b)]),_0x2b6b88=await this['modelsService'][_0x41d727(0x1e0)](_0x482b6e),_0x2b6b88[_0x41d727(0x1c7)]=_0x482b6e,_0xec2ce1&&(_0x5dcf22=_0x5dcf22+_0x41d727(0x1b7)+_0xec2ce1+_0x41d727(0x24c)),common_1[_0x41d727(0x23a)][_0x41d727(0x21d)]('固定模型、使用应用预设:\x20'+_0x5dcf22,_0x41d727(0x228))):(_0x438f5a[_0x41d727(0x28b)]&&(_0x5dcf22=_0x438f5a[_0x41d727(0x28b)]),_0x2b6b88=await this[_0x41d727(0x200)][_0x41d727(0x1e0)](_0x5334f9),_0xec2ce1&&(_0x5dcf22=_0x5dcf22+'以下是我提供给你的知识库：【'+_0xec2ce1+_0x41d727(0x24c)),common_1[_0x41d727(0x23a)][_0x41d727(0x21d)](_0x41d727(0x225)+_0x5dcf22,'ChatService'));}else{const _0x2a39aa=await this[_0x41d727(0x1e9)][_0x41d727(0x1eb)](_0x183059);if(_0x52b6e2&&_0x52b6e2[_0x41d727(0x1fb)]===0x0){let _0x43ebbe='';try{_0x43ebbe=await this[_0x41d727(0x264)](_0x459bbf,_0x52b6e2[_0x41d727(0x1b9)]),common_1['Logger'][_0x41d727(0x21d)]('插件返回结果:\x20'+_0x43ebbe,'ChatService');}catch(_0x1a1e99){_0x43ebbe=_0x459bbf,common_1[_0x41d727(0x23a)][_0x41d727(0x1c5)]('插件调用错误:\x20'+_0x1a1e99);}_0x5dcf22=_0x43ebbe,_0x2b6b88=await this[_0x41d727(0x200)][_0x41d727(0x1e0)](_0x5334f9),common_1['Logger'][_0x41d727(0x21d)]('使用插件预设:\x20'+_0x5dcf22,_0x41d727(0x228));}else{if(_0xec2ce1)_0x5dcf22='以下是我提供给你的知识库：【'+_0xec2ce1+_0x41d727(0x24c),_0x2b6b88=await this[_0x41d727(0x200)][_0x41d727(0x1e0)](_0x5334f9),common_1['Logger']['log'](_0x41d727(0x21b)+_0x5dcf22,_0x41d727(0x228));else{const _0xa4809d=new Date()[_0x41d727(0x23d)]()[_0x41d727(0x22e)]('T')[0x0];_0x5dcf22=_0x492696+('\x0a\x20Current\x20date:\x20'+_0xa4809d),_0x2b6b88=await this[_0x41d727(0x200)][_0x41d727(0x1e0)](_0x5334f9),common_1[_0x41d727(0x23a)]['log'](_0x41d727(0x287)+_0x5dcf22,_0x41d727(0x228));}}}if(!_0x2b6b88){common_1[_0x41d727(0x23a)][_0x41d727(0x252)](_0x41d727(0x1bc),_0x41d727(0x228)),_0x2b6b88=await this[_0x41d727(0x200)]['getCurrentModelKeyInfo'](_0x20de41);const _0x955560=await this[_0x41d727(0x1e9)][_0x41d727(0x1eb)](_0x183059);let _0x4fcffd=_0x955560[_0x41d727(0x1ba)];try{const _0xa255c2=JSON[_0x41d727(0x1fa)](_0x955560[_0x41d727(0x1ba)]);_0xa255c2[_0x41d727(0x27b)]&&(_0xa255c2[_0x41d727(0x27b)]['modelName']=_0x2b6b88[_0x41d727(0x23f)],_0xa255c2[_0x41d727(0x27b)][_0x41d727(0x1c7)]=_0x2b6b88[_0x41d727(0x1c7)],_0x4fcffd=JSON[_0x41d727(0x289)](_0xa255c2));}catch(_0x104582){common_1[_0x41d727(0x23a)][_0x41d727(0x252)](_0x41d727(0x254),_0x41d727(0x228));throw new common_1[(_0x41d727(0x20c))](_0x41d727(0x262),common_1[_0x41d727(0x25f)][_0x41d727(0x196)]);}await this[_0x41d727(0x1e9)][_0x41d727(0x197)]({'groupId':_0x183059,'title':_0x955560[_0x41d727(0x248)],'isSticky':![],'config':_0x4fcffd,'fileUrl':''},_0x30e9a8);}const {deduct:_0x2f834d,isTokenBased:_0xc7cf70,tokenFeeRatio:_0x55856d,deductType:_0x246234,key:_0x5edbfa,id:_0x2e282d,maxRounds:_0x55d62f,proxyUrl:_0x640e4a,maxModelTokens:_0x4766ea,timeout:_0x2fea22,model:_0x7b9e34,isFileUpload:_0x8191d3,keyType:_0x4a807c}=_0x2b6b88;if(await this[_0x41d727(0x20a)][_0x41d727(0x238)](_0x30e9a8[_0x41d727(0x209)],_0x7b9e34))throw new common_1['HttpException'](_0x41d727(0x257),common_1['HttpStatus'][_0x41d727(0x286)]);if(_0x1883a0==='1'&&_0x2ed439==='IMAGINE'&&_0x5334f9===_0x41d727(0x243)){const [_0x88f9dc,_0x4859a6]=_0x459bbf['split'](/(?= --)/),_0x2e4776=/(https?:\/\/[^\s]+)/g,_0xf4b902=_0x88f9dc[_0x41d727(0x1da)](_0x2e4776)||[];let _0x5ee3f1=_0x88f9dc[_0x41d727(0x218)](_0x2e4776,'')['trim']();const _0x7c835a=await this['openAIChatService'][_0x41d727(0x256)](_0x5ee3f1,_0x269af1||'Translate\x20any\x20given\x20phrase\x20from\x20any\x20language\x20into\x20English.\x20For\x20instance,\x20when\x20I\x20input\x20\x27{可爱的熊猫}\x27,\x20you\x20should\x20output\x20\x27{cute\x20panda}\x27,\x20with\x20no\x20period\x20at\x20the\x20end.'),_0x2cd5e7=[..._0xf4b902,_0x7c835a][_0x41d727(0x278)]('\x20')[_0x41d727(0x27c)]();_0x50b6fa=_0x4859a6?''+_0x2cd5e7+_0x4859a6:_0x2cd5e7,_0x8191d3==='1'&&_0x5a128f&&(_0x50b6fa=_0x5a128f+'\x20'+_0x50b6fa);}else _0x50b6fa=_0x8191d3==='1'&&_0x5a128f?_0x5a128f+'\x20'+_0x459bbf:_0x459bbf;await this[_0x41d727(0x1d5)][_0x41d727(0x277)](_0x30e9a8,_0x246234,_0x2f834d);const _0x563e5b=_0xd163a3,_0x5f5624=(0x0,utils_1[_0x41d727(0x18e)])(_0x640e4a||_0x565b3d||_0x41d727(0x216)),_0x57f8d9=_0x5edbfa||_0x1bd285,_0xde819f=(_0x2fea22||_0x47efda||0x12c)*0x3e8,_0x1022c2=Number(_0x2264e7)||0x1;if(_0x183059){const _0x23c9e9=await this[_0x41d727(0x1e9)]['getGroupInfoFromId'](_0x183059);this[_0x41d727(0x27e)](_0x183059,_0x23c9e9,_0x4a807c,_0x459bbf,_0x30e9a8),await this['chatGroupService'][_0x41d727(0x1ca)](_0x183059);}const _0x126804=await this['chatLogService'][_0x41d727(0x223)]({'appId':appId,'curIp':_0x24be22,'userId':_0x30e9a8[_0x41d727(0x209)]['id'],'type':_0x4a807c?_0x4a807c:0x1,'prompt':_0x459bbf,'fileInfo':_0x5a128f?_0x5a128f:null,'answer':'','promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x7b9e34,'modelName':'我','role':_0x41d727(0x209),'groupId':_0x183059?_0x183059:null}),_0x3cb6a1=await this[_0x41d727(0x20a)]['saveChatLog']({'appId':appId?appId:null,'action':_0x2ed439?_0x2ed439:null,'curIp':_0x24be22,'userId':_0x30e9a8[_0x41d727(0x209)]['id'],'type':_0x4a807c?_0x4a807c:0x1,'prompt':_0x459bbf,'fileInfo':null,'answer':'','progress':'0%','promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x7b9e34,'modelName':_0x563e5b,'role':'assistant','groupId':_0x183059?_0x183059:null,'status':0x2,'modelAvatar':(_0x52b6e2===null||_0x52b6e2===void 0x0?void 0x0:_0x52b6e2[_0x41d727(0x22f)])||_0x35c483||_0x35c7d6||'','pluginParam':(_0x52b6e2===null||_0x52b6e2===void 0x0?void 0x0:_0x52b6e2[_0x41d727(0x1b9)])?_0x52b6e2[_0x41d727(0x1b9)]:_0x4a807c===0x2?_0x7b9e34:null}),_0xc43afb=_0x126804['id'],_0x2486b5=_0x3cb6a1['id'];if(_0x329de9[_0x41d727(0x283)]&&_0x393be3){if(_0x329de9[_0x41d727(0x1a8)]===0x0){const _0x4b7740=_0x329de9[_0x41d727(0x283)][_0x41d727(0x22e)](''),_0x3cc198=_0x13ea95=>{const _0xef008b=_0x41d727;if(_0x13ea95<_0x4b7740[_0xef008b(0x24e)]){const _0x5b2437={'text':_0x4b7740[_0x13ea95]};_0x393be3['write'](JSON[_0xef008b(0x289)](_0x5b2437)+'\x0a'),setTimeout(()=>_0x3cc198(_0x13ea95+0x1),0xa);}else _0x393be3[_0xef008b(0x198)]();};_0x3cc198(0x0),await this[_0x41d727(0x20a)][_0x41d727(0x1d8)](_0x2486b5,{'answer':_0x329de9[_0x41d727(0x283)]});return;}else _0x5dcf22=_0x5dcf22+_0x329de9[_0x41d727(0x283)];}const {messagesHistory:_0x114b68}=await this['buildMessageFromParentMessageId'](_0x459bbf,{'groupId':_0x183059,'systemMessage':_0x5dcf22,'maxModelTokens':_0x4766ea,'maxRounds':_0x55d62f,'isConvertToBase64':_0x3ead43,'fileInfo':_0x5a128f,'model':_0x7b9e34,'isFileUpload':_0x8191d3},this['chatLogService']);let _0x1c0207=_0x2ed439!==_0x41d727(0x241)&&_0x7b9e34===_0x41d727(0x243)?_0x2f834d*0x4:_0x2f834d;const _0x50a4f5=new AbortController();try{if(_0x393be3){_0x393be3['on'](_0x41d727(0x284),()=>{const _0x4e4549=_0x41d727;_0x50a4f5[_0x4e4549(0x18f)]();});let _0x27739a,_0x30a2d4=!![];try{if((_0x7b9e34===_0x41d727(0x1f7)||_0x7b9e34==='midjourney'||_0x7b9e34===_0x41d727(0x20d)||_0x7b9e34===_0x41d727(0x26f)||_0x7b9e34===_0x41d727(0x288)||_0x7b9e34[_0x41d727(0x19d)]('stable-diffusion')||_0x7b9e34[_0x41d727(0x19d)](_0x41d727(0x249))||_0x7b9e34['includes'](_0x41d727(0x1b0)))&&_0x4a807c===0x2){if(_0x7b9e34==='dall-e-3')_0x27739a=this[_0x41d727(0x276)][_0x41d727(0x1d9)]({'prompt':_0x459bbf,'extraParam':_0x39385c,'apiKey':_0x57f8d9,'proxyUrl':_0x5f5624,'model':_0x7b9e34,'timeout':_0xde819f,'modelName':_0x563e5b,'groupId':_0x183059,'onSuccess':async _0x430d27=>{const _0x1577b8=_0x41d727;await this[_0x1577b8(0x20a)]['updateChatLog'](_0x2486b5,{'fileInfo':_0x430d27===null||_0x430d27===void 0x0?void 0x0:_0x430d27[_0x1577b8(0x19b)],'answer':(_0x430d27===null||_0x430d27===void 0x0?void 0x0:_0x430d27[_0x1577b8(0x283)])||_0x459bbf,'progress':'100%','status':_0x430d27[_0x1577b8(0x204)]});},'onFailure':async _0x4d0e93=>{const _0x32cf1a=_0x41d727;await this[_0x32cf1a(0x20a)][_0x32cf1a(0x1d8)](_0x2486b5,{'answer':_0x32cf1a(0x199),'status':_0x4d0e93['status']});}},this[_0x41d727(0x26d)]),await this['chatLogService']['updateChatLog'](_0x2486b5,{'answer':_0x41d727(0x26e)});else{if(_0x7b9e34==='ai-ppt')common_1[_0x41d727(0x23a)][_0x41d727(0x21d)](_0x41d727(0x206),_0x41d727(0x24d)),_0x27739a=this['aiPptService']['aiPPT']({'usePrompt':_0x50b6fa,'prompt':_0x459bbf,'apiKey':_0x57f8d9,'proxyUrl':_0x5f5624,'model':_0x7b9e34,'modelName':_0x563e5b,'drawId':_0x12e199,'customId':_0x4e14a9,'action':_0x2ed439,'timeout':_0xde819f,'assistantLogId':_0x2486b5,'extraParam':_0x39385c,'fileInfo':_0x5a128f}),await this['chatLogService']['updateChatLog'](_0x2486b5,{'answer':_0x41d727(0x1b2)});else{if(_0x7b9e34[_0x41d727(0x19d)]('flux'))_0x27739a=this[_0x41d727(0x282)][_0x41d727(0x263)]({'prompt':_0x459bbf,'extraParam':_0x39385c,'apiKey':_0x57f8d9,'proxyUrl':_0x5f5624,'model':_0x7b9e34,'timeout':_0xde819f,'modelName':_0x563e5b,'groupId':_0x183059,'onSuccess':async _0x357af=>{const _0x287b3a=_0x41d727;await this[_0x287b3a(0x20a)][_0x287b3a(0x1d8)](_0x2486b5,{'fileInfo':_0x357af===null||_0x357af===void 0x0?void 0x0:_0x357af[_0x287b3a(0x19b)],'answer':(_0x357af===null||_0x357af===void 0x0?void 0x0:_0x357af[_0x287b3a(0x283)])||_0x459bbf,'progress':_0x287b3a(0x1a4),'status':_0x357af[_0x287b3a(0x204)]});},'onFailure':async _0x28ea83=>{const _0x136af0=_0x41d727;await this[_0x136af0(0x20a)][_0x136af0(0x1d8)](_0x2486b5,{'answer':_0x136af0(0x199),'status':_0x28ea83[_0x136af0(0x204)]});}},this[_0x41d727(0x26d)]),await this[_0x41d727(0x20a)]['updateChatLog'](_0x2486b5,{'answer':_0x41d727(0x26e)});else{if(_0x7b9e34[_0x41d727(0x19d)]('suno-music'))_0x27739a=this[_0x41d727(0x1f0)][_0x41d727(0x19a)]({'assistantLogId':_0x2486b5,'apiKey':_0x57f8d9,'action':_0x2ed439,'prompt':_0x459bbf,'timeout':_0xde819f,'proxyUrl':_0x5f5624,'taskData':_0x4e14a9}),await this['chatLogService']['updateChatLog'](_0x2486b5,{'answer':_0x41d727(0x1c8)});else{if(_0x7b9e34[_0x41d727(0x19d)](_0x41d727(0x288)))_0x27739a=this[_0x41d727(0x205)][_0x41d727(0x259)]({'fileInfo':_0x5a128f,'extraParam':_0x39385c,'assistantLogId':_0x2486b5,'apiKey':_0x57f8d9,'action':_0x2ed439,'prompt':_0x459bbf,'model':_0x7b9e34,'timeout':_0xde819f,'proxyUrl':_0x5f5624,'taskData':_0x4e14a9,'onGenerate':async _0x2916c1=>{const _0x273036=_0x41d727;await this['chatLogService'][_0x273036(0x1d8)](_0x2486b5,{'fileInfo':_0x2916c1===null||_0x2916c1===void 0x0?void 0x0:_0x2916c1['fileInfo'],'answer':(_0x2916c1===null||_0x2916c1===void 0x0?void 0x0:_0x2916c1[_0x273036(0x283)])||_0x459bbf,'status':0x2});},'onSuccess':async _0x2bb74f=>{const _0x595ffc=_0x41d727;await this[_0x595ffc(0x20a)]['updateChatLog'](_0x2486b5,{'fileInfo':_0x2bb74f===null||_0x2bb74f===void 0x0?void 0x0:_0x2bb74f[_0x595ffc(0x19b)],'answer':(_0x2bb74f===null||_0x2bb74f===void 0x0?void 0x0:_0x2bb74f[_0x595ffc(0x283)])||_0x459bbf,'progress':_0x595ffc(0x1a4),'status':0x3});},'onFailure':async _0x53d758=>{const _0x783662=_0x41d727;await this[_0x783662(0x20a)][_0x783662(0x1d8)](_0x2486b5,{'answer':_0x53d758[_0x783662(0x221)],'status':0x4});}}),await this['chatLogService'][_0x41d727(0x1d8)](_0x2486b5,{'answer':'提交成功，视频生成中'});else{if(_0x7b9e34[_0x41d727(0x19d)](_0x41d727(0x249)))_0x27739a=this[_0x41d727(0x193)]['cogVideo']({'fileInfo':_0x5a128f,'extraParam':_0x39385c,'assistantLogId':_0x2486b5,'apiKey':_0x57f8d9,'action':_0x2ed439,'prompt':_0x459bbf,'model':_0x7b9e34,'timeout':_0xde819f,'proxyUrl':_0x5f5624,'taskData':_0x4e14a9,'onGenerate':async _0x237e04=>{const _0x7f6d78=_0x41d727;await this[_0x7f6d78(0x20a)][_0x7f6d78(0x1d8)](_0x2486b5,{'fileInfo':_0x237e04===null||_0x237e04===void 0x0?void 0x0:_0x237e04['fileInfo'],'answer':(_0x237e04===null||_0x237e04===void 0x0?void 0x0:_0x237e04[_0x7f6d78(0x283)])||_0x459bbf,'status':0x2});},'onSuccess':async _0x5be843=>{const _0x353997=_0x41d727;await this[_0x353997(0x20a)][_0x353997(0x1d8)](_0x2486b5,{'fileInfo':_0x5be843===null||_0x5be843===void 0x0?void 0x0:_0x5be843[_0x353997(0x19b)],'answer':(_0x5be843===null||_0x5be843===void 0x0?void 0x0:_0x5be843[_0x353997(0x283)])||_0x459bbf,'progress':_0x353997(0x1a4),'status':0x3});},'onFailure':async _0x45e9cc=>{const _0x559f92=_0x41d727;await this[_0x559f92(0x20a)][_0x559f92(0x1d8)](_0x2486b5,{'answer':_0x45e9cc[_0x559f92(0x221)],'status':0x4});}}),await this[_0x41d727(0x20a)][_0x41d727(0x1d8)](_0x2486b5,{'answer':'提交成功，视频生成中'});else _0x7b9e34[_0x41d727(0x19d)]('stable-diffusion')?(_0x27739a=this['stableDiffusionService'][_0x41d727(0x1c9)]({'chatId':_0x2486b5,'maxModelTokens':_0x4766ea,'apiKey':_0x57f8d9,'model':_0x7b9e34,'modelName':_0x563e5b,'modelType':_0x4a807c,'prompt':_0x459bbf,'fileInfo':_0x5a128f,'isFileUpload':_0x8191d3,'timeout':_0xde819f,'proxyUrl':_0x5f5624,'onSuccess':async _0x1709e3=>{const _0x3b0fb0=_0x41d727;await this[_0x3b0fb0(0x20a)][_0x3b0fb0(0x1d8)](_0x2486b5,{'fileInfo':_0x1709e3===null||_0x1709e3===void 0x0?void 0x0:_0x1709e3[_0x3b0fb0(0x19b)],'answer':(_0x1709e3===null||_0x1709e3===void 0x0?void 0x0:_0x1709e3[_0x3b0fb0(0x283)])||_0x459bbf,'progress':_0x3b0fb0(0x1a4),'status':0x3});},'onFailure':async _0x33055a=>{const _0x1fddb2=_0x41d727;await this[_0x1fddb2(0x20a)][_0x1fddb2(0x1d8)](_0x2486b5,{'answer':_0x1fddb2(0x19c),'status':0x4});}}),await this[_0x41d727(0x20a)][_0x41d727(0x1d8)](_0x2486b5,{'answer':'绘制中'})):(_0x27739a=await this[_0x41d727(0x1f5)][_0x41d727(0x1f9)]({'usePrompt':_0x50b6fa,'prompt':_0x459bbf,'apiKey':_0x57f8d9,'proxyUrl':_0x5f5624,'model':_0x7b9e34,'modelName':_0x563e5b,'drawId':_0x12e199,'customId':_0x4e14a9,'action':_0x2ed439,'fileInfo':_0x5a128f,'timeout':_0xde819f,'assistantLogId':_0x2486b5,'pluginName':_0x52b6e2}),await this[_0x41d727(0x20a)][_0x41d727(0x1d8)](_0x2486b5,{'answer':_0x27739a['answer'],'status':_0x27739a[_0x41d727(0x204)]}));}}}}}_0x27739a[_0x41d727(0x204)]!==0x5?(await this[_0x41d727(0x200)][_0x41d727(0x271)](_0x2e282d,0x1),await this[_0x41d727(0x1d5)][_0x41d727(0x1fd)](_0x30e9a8[_0x41d727(0x209)]['id'],_0x246234,_0x1c0207)):common_1['Logger'][_0x41d727(0x21d)](_0x41d727(0x233),_0x41d727(0x228));const _0x570dcb=await this[_0x41d727(0x1d5)]['queryUserBalance'](_0x30e9a8['user']['id']);return _0x27739a['userBalance']=Object[_0x41d727(0x1ac)]({},_0x570dcb),_0x27739a[_0x41d727(0x192)]=_0x27739a[_0x41d727(0x283)],_0x27739a['status']=_0x27739a[_0x41d727(0x204)]||0x2,_0x27739a[_0x41d727(0x1c7)]=_0x5334f9,_0x27739a[_0x41d727(0x23f)]=_0xd163a3,_0x393be3[_0x41d727(0x1c0)]('\x0a'+JSON[_0x41d727(0x289)](_0x27739a));}else{_0x27739a=await this['openAIChatService']['openAIChat'](_0x114b68,{'chatId':_0x2486b5,'maxModelTokens':_0x4766ea,'apiKey':_0x57f8d9,'model':_0x7b9e34,'modelName':_0x563e5b,'temperature':_0x1022c2,'modelType':_0x4a807c,'prompt':_0x459bbf,'fileInfo':_0x5a128f,'isFileUpload':_0x8191d3,'timeout':_0xde819f,'proxyUrl':_0x5f5624,'modelAvatar':_0x35c7d6,'onProgress':_0x18237b=>{const _0x5374c7=_0x41d727;_0x393be3[_0x5374c7(0x1c0)](_0x30a2d4?JSON['stringify'](_0x18237b):'\x0a'+JSON['stringify'](_0x18237b)),_0x30a2d4=![];},'onFailure':async _0x39ebbb=>{const _0x38759e=_0x41d727;await this['chatLogService'][_0x38759e(0x1d8)](_0x2486b5,{'answer':_0x39ebbb['errMsg'],'status':0x4});},'abortController':_0x50a4f5});if(_0x27739a[_0x41d727(0x221)])return common_1[_0x41d727(0x23a)]['error'](_0x41d727(0x1aa)+_0x30e9a8[_0x41d727(0x209)]['id']+_0x41d727(0x25a)+_0x563e5b+'\x20模型:\x20'+_0x5334f9+_0x41d727(0x227),'ChatService'),_0x393be3[_0x41d727(0x1c0)]('\x0a'+JSON['stringify'](_0x27739a));let _0x227acd='';_0x114b68['forEach'](_0x9f95a7=>{const _0x195f34=_0x41d727;_0x227acd+=_0x9f95a7[_0x195f34(0x1be)]+'\x20';});const _0x1d005c=await(0x0,utils_1[_0x41d727(0x245)])(_0x227acd),_0x3334fd=await(0x0,utils_1[_0x41d727(0x245)])(_0x27739a[_0x41d727(0x283)]);await this[_0x41d727(0x20a)]['updateChatLog'](_0xc43afb,{'promptTokens':_0x1d005c,'completionTokens':_0x3334fd,'totalTokens':_0x1d005c+_0x3334fd});let _0x21ac9d=_0x27739a[_0x41d727(0x283)];if(_0x14c80a==='1'){const _0x2f0197=await this[_0x41d727(0x1d2)][_0x41d727(0x201)](_0x27739a[_0x41d727(0x283)],_0x30e9a8[_0x41d727(0x209)]['id']);if(_0x2f0197['length']>0x0){const _0x5d9f15=new RegExp(_0x2f0197['join']('|'),'gi');_0x21ac9d=_0x21ac9d[_0x41d727(0x218)](_0x5d9f15,_0x37824a=>'*'[_0x41d727(0x211)](_0x37824a['length']));}}await this[_0x41d727(0x20a)][_0x41d727(0x1d8)](_0x2486b5,{'fileInfo':_0x27739a===null||_0x27739a===void 0x0?void 0x0:_0x27739a[_0x41d727(0x19b)],'answer':_0x21ac9d,'promptTokens':_0x1d005c,'completionTokens':_0x3334fd,'totalTokens':_0x1d005c+_0x3334fd,'status':0x3});try{if(_0x17fac8==='1'){const _0x279dc8=await this[_0x41d727(0x253)][_0x41d727(0x256)](_0x41d727(0x236)+_0x459bbf+_0x41d727(0x1b4)+_0x27739a['answer']+_0x41d727(0x207));await this[_0x41d727(0x20a)][_0x41d727(0x1d8)](_0x2486b5,{'promptReference':_0x279dc8});}}catch(_0x2f0530){common_1[_0x41d727(0x23a)][_0x41d727(0x1c5)](_0x41d727(0x1fe)+_0x2f0530);}_0xc7cf70===!![]&&(_0x1c0207=_0x2f834d*Math[_0x41d727(0x21a)]((_0x1d005c+_0x3334fd)/_0x55856d));await this[_0x41d727(0x1d5)][_0x41d727(0x1fd)](_0x30e9a8[_0x41d727(0x209)]['id'],_0x246234,_0x1c0207,_0x1d005c+_0x3334fd),await this['modelsService']['saveUseLog'](_0x2e282d,_0x1d005c+_0x3334fd),common_1[_0x41d727(0x23a)][_0x41d727(0x21d)](_0x41d727(0x1aa)+_0x30e9a8[_0x41d727(0x209)]['id']+_0x41d727(0x25a)+_0x563e5b+_0x41d727(0x23b)+_0x5334f9+_0x41d727(0x28a)+(_0x1d005c+_0x3334fd)+_0x41d727(0x1a9)+_0x1c0207,_0x41d727(0x228));const _0x3c5d5d=await this[_0x41d727(0x1d5)]['queryUserBalance'](_0x30e9a8[_0x41d727(0x209)]['id']);return _0x27739a[_0x41d727(0x22a)]=Object[_0x41d727(0x1ac)]({},_0x3c5d5d),_0x393be3[_0x41d727(0x1c0)]('\x0a'+JSON[_0x41d727(0x289)](_0x27739a));}}catch(_0x102d10){common_1[_0x41d727(0x23a)][_0x41d727(0x1c5)](_0x41d727(0x24a),_0x102d10),await this['chatLogService'][_0x41d727(0x1d8)](_0x2486b5,{'status':0x5}),_0x27739a={'error':'处理请求时发生错误'};}}else return _0x27f8fc=await this['openAIChatService']['openAIChat'](_0x114b68,{'chatId':_0x2486b5,'maxModelTokens':_0x4766ea,'apiKey':_0x57f8d9,'model':_0x7b9e34,'modelName':_0x563e5b,'modelType':_0x4a807c,'temperature':_0x1022c2,'prompt':_0x459bbf,'fileInfo':_0x5a128f,'isFileUpload':_0x8191d3,'timeout':_0xde819f,'proxyUrl':_0x5f5624,'abortController':_0x50a4f5}),await this[_0x41d727(0x1d5)][_0x41d727(0x1fd)](_0x30e9a8[_0x41d727(0x209)]['id'],_0x246234,_0x1c0207),_0x27f8fc[_0x41d727(0x283)];}catch(_0x2cb0b2){common_1['Logger'][_0x41d727(0x1c5)]('chat-error\x20<----------------------------------------->',_0x57f8d9,_0x2cb0b2);if(_0x393be3)return _0x393be3[_0x41d727(0x1c0)](_0x41d727(0x268));else throw new common_1[(_0x41d727(0x20c))]('发生未知错误，请稍后再试',common_1['HttpStatus'][_0x41d727(0x196)]);}finally{_0x393be3&&_0x393be3['end']();}}async[_0x4f80b8(0x264)](_0x436efc,_0x54f868){const _0x3db34c=_0x4f80b8,{pluginUrl:_0x5d2e24,pluginKey:_0x530b33}=await this[_0x3db34c(0x1b5)][_0x3db34c(0x217)](['pluginUrl',_0x3db34c(0x226)]),_0x289f58=_0x530b33,_0xc7c547=_0x5d2e24,_0x43a3ff={'method':_0x3db34c(0x215),'url':_0xc7c547+_0x3db34c(0x258)+_0x54f868,'headers':{'Content-Type':'application/json','Authorization':_0x3db34c(0x244)+_0x289f58},'data':{'prompt':_0x436efc}};try{const _0x32661b=await(0x0,axios_1[_0x3db34c(0x191)])(_0x43a3ff);return common_1[_0x3db34c(0x23a)][_0x3db34c(0x21d)]('插件调用成功\x20返回结果:\x20'+JSON['stringify'](_0x32661b[_0x3db34c(0x240)],null,0x2),_0x3db34c(0x212)),_0x32661b[_0x3db34c(0x240)][_0x3db34c(0x192)];}catch(_0x428371){common_1[_0x3db34c(0x23a)][_0x3db34c(0x1c5)](_0x3db34c(0x1d3),_0x428371);}}async[_0x4f80b8(0x27e)](_0x449a96,_0x404c46,_0x428855,_0x2d7ebd,_0x3e767a){const _0x94d95c=_0x4f80b8;if((_0x404c46===null||_0x404c46===void 0x0?void 0x0:_0x404c46[_0x94d95c(0x248)])===_0x94d95c(0x220)){let _0x1e6e8c;if(_0x428855===0x1)try{_0x1e6e8c=await this[_0x94d95c(0x253)][_0x94d95c(0x256)](_0x94d95c(0x236)+_0x2d7ebd+_0x94d95c(0x1f2)),_0x1e6e8c[_0x94d95c(0x24e)]>0xf&&(_0x1e6e8c=_0x1e6e8c['slice'](0x0,0xf));}catch(_0x2b7b66){common_1[_0x94d95c(0x23a)][_0x94d95c(0x1c5)](_0x94d95c(0x1fe)+_0x2b7b66),_0x1e6e8c=_0x2d7ebd[_0x94d95c(0x219)](0x0,0xa);}else _0x1e6e8c=_0x94d95c(0x25c);this[_0x94d95c(0x1e9)]['update']({'groupId':_0x449a96,'title':_0x1e6e8c,'isSticky':![],'config':'','fileUrl':''},_0x3e767a)['then'](()=>common_1['Logger']['log']('更新标题名称为:\x20'+_0x1e6e8c,_0x94d95c(0x228)))[_0x94d95c(0x1e4)](_0x537db3=>common_1[_0x94d95c(0x23a)][_0x94d95c(0x1c5)]('更新对话组标题失败:\x20'+_0x537db3));}}async[_0x4f80b8(0x26d)](_0x41f884,_0x4e54eb,_0x39a68b){const _0x4d698b=_0x4f80b8;let {systemMessage:systemMessage='',fileInfo:_0x53a856,groupId:_0x1038d7,maxRounds:maxRounds=0x5,maxModelTokens:maxModelTokens=0x1f40,isFileUpload:isFileUpload=0x0,isConvertToBase64:_0x160e4e}=_0x4e54eb;systemMessage[_0x4d698b(0x24e)]>maxModelTokens&&(common_1['Logger'][_0x4d698b(0x21d)](_0x4d698b(0x231),_0x4d698b(0x228)),systemMessage=systemMessage[_0x4d698b(0x219)](0x0,maxModelTokens));let _0x3579ca=[];systemMessage&&_0x3579ca['push']({'role':_0x4d698b(0x1ec),'content':systemMessage});if(_0x1038d7){const _0x5be8fe=await _0x39a68b[_0x4d698b(0x1c6)](_0x1038d7,maxRounds);let _0x5555dc=null;for(const _0x6535a2 of _0x5be8fe){try{let _0x4b67a0;if((isFileUpload===0x2||isFileUpload===0x3)&&_0x6535a2[_0x4d698b(0x19b)]&&_0x6535a2['role']==='user'){const _0x54ad24=await Promise[_0x4d698b(0x247)](_0x6535a2['fileInfo']['split'](',')['map'](async _0x3430c7=>({'type':'image_url','image_url':{'url':_0x160e4e==='1'?await this[_0x4d698b(0x279)](_0x3430c7[_0x4d698b(0x27c)]()):_0x3430c7['trim']()}})));_0x4b67a0=[{'type':_0x4d698b(0x192),'text':_0x6535a2[_0x4d698b(0x192)]},..._0x54ad24];}else isFileUpload===0x1&&_0x6535a2[_0x4d698b(0x19b)]&&_0x6535a2['role']===_0x4d698b(0x209)?_0x4b67a0=_0x6535a2['fileInfo']+'\x0a'+_0x6535a2[_0x4d698b(0x192)]:_0x4b67a0=_0x6535a2['text'];if(_0x6535a2[_0x4d698b(0x1dc)]===_0x4d698b(0x209))_0x5555dc={'role':_0x6535a2['role'],'content':_0x4b67a0};else{if(_0x6535a2[_0x4d698b(0x1dc)]===_0x4d698b(0x1cf)){const _0x20201a=Array[_0x4d698b(0x202)](_0x4b67a0)?JSON[_0x4d698b(0x289)](_0x4b67a0):_0x4b67a0;_0x5555dc&&_0x20201a['trim']()!==''&&(_0x3579ca[_0x4d698b(0x23e)](_0x5555dc),_0x3579ca['push']({'role':_0x6535a2[_0x4d698b(0x1dc)],'content':_0x4b67a0}),_0x5555dc=null);}}}catch(_0x3dca91){common_1[_0x4d698b(0x23a)][_0x4d698b(0x1c5)]('处理历史记录时出错:',_0x3dca91,'记录:',JSON[_0x4d698b(0x289)](_0x6535a2,null,0x2));}}}let _0x38d1f3;if((isFileUpload===0x2||isFileUpload===0x3)&&_0x53a856){const _0x7bcba7=await Promise[_0x4d698b(0x247)](_0x53a856[_0x4d698b(0x22e)](',')['map'](async _0x151f31=>({'type':_0x4d698b(0x1ee),'image_url':{'url':_0x160e4e==='1'?await this[_0x4d698b(0x279)](_0x151f31[_0x4d698b(0x27c)]()):_0x151f31[_0x4d698b(0x27c)]()}})));_0x38d1f3=[{'type':_0x4d698b(0x192),'text':_0x41f884},..._0x7bcba7];}else isFileUpload===0x1&&_0x53a856?_0x38d1f3=_0x53a856+'\x0a'+_0x41f884:_0x38d1f3=_0x41f884;_0x3579ca[_0x4d698b(0x23e)]({'role':_0x4d698b(0x209),'content':_0x38d1f3});let _0x5c2af6=await(0x0,utils_1[_0x4d698b(0x245)])(_0x3579ca),_0x35ac98;maxModelTokens<0x1f40?_0x35ac98=0xfa0:_0x35ac98=maxModelTokens-0xfa0;while(_0x5c2af6>_0x35ac98){if(_0x3579ca['length']===0x2&&_0x3579ca[0x0][_0x4d698b(0x1dc)]===_0x4d698b(0x1ec)&&_0x3579ca[0x1][_0x4d698b(0x1dc)]==='user')break;let _0x459f57=![];for(let _0x446365=0x0;_0x446365<_0x3579ca[_0x4d698b(0x24e)];_0x446365++){if(_0x3579ca[_0x446365][_0x4d698b(0x1dc)]!==_0x4d698b(0x1ec)&&_0x3579ca[_0x446365+0x1]&&_0x3579ca[_0x446365+0x1][_0x4d698b(0x1dc)]===_0x4d698b(0x1cf)){_0x3579ca[_0x4d698b(0x1c2)](_0x446365,0x2),_0x459f57=!![];break;}}if(!_0x459f57)for(let _0x53c9c9=0x0;_0x53c9c9<_0x3579ca[_0x4d698b(0x24e)];_0x53c9c9++){if(_0x3579ca[_0x53c9c9][_0x4d698b(0x1dc)]===_0x4d698b(0x209)){_0x3579ca[_0x4d698b(0x1c2)](_0x53c9c9,0x1);break;}}_0x5c2af6=await(0x0,utils_1[_0x4d698b(0x245)])(_0x3579ca);if(_0x3579ca['length']<=0x2)break;}return{'messagesHistory':_0x3579ca,'round':_0x3579ca[_0x4d698b(0x24e)]};}async[_0x4f80b8(0x279)](_0x25da15){const _0x3db58a=_0x4f80b8;try{console[_0x3db58a(0x21d)](_0x3db58a(0x267)+_0x25da15);const _0x35540d=await axios_1[_0x3db58a(0x191)]['get'](_0x25da15,{'responseType':_0x3db58a(0x1bf)}),_0xa99edb=Buffer[_0x3db58a(0x1e3)](_0x35540d['data'],_0x3db58a(0x1a3));console[_0x3db58a(0x21d)](_0x3db58a(0x1d6)+_0x25da15);const _0x448694=_0x3db58a(0x1a1)+_0x35540d['headers']['content-type']+_0x3db58a(0x1c1)+_0xa99edb[_0x3db58a(0x1ae)](_0x3db58a(0x1e2));return console['log']('成功转换URL为Base64:\x20'+_0x25da15),_0x448694;}catch(_0x36c733){return console['error'](_0x3db58a(0x272),_0x36c733),console[_0x3db58a(0x270)](_0x3db58a(0x26b)+_0x25da15),_0x25da15;}}async[_0x4f80b8(0x235)](_0x140937,_0x4d9fb2,_0x272dc4){const _0x15d020=_0x4f80b8,{chatId:_0x43bdc8,prompt:_0x3f54d5}=_0x140937,_0x18b457=await this[_0x15d020(0x200)][_0x15d020(0x1e0)](_0x15d020(0x1f8)),{openaiTimeout:_0x5e682f,openaiBaseUrl:_0x2b46a9,openaiBaseKey:_0x46ed29,openaiVoice:_0x289dee}=await this[_0x15d020(0x1b5)][_0x15d020(0x217)](['openaiTimeout',_0x15d020(0x1a6),_0x15d020(0x28d),_0x15d020(0x280)]),{key:_0x5f100,proxyUrl:_0x7ce168,deduct:_0x3f4c5a,deductType:_0x3fade3,timeout:_0x3a3103}=_0x18b457,_0x523f89=_0x5f100||_0x46ed29,_0x5a0344=(0x0,utils_1['formatUrl'])(_0x7ce168||_0x2b46a9),_0x5defa2=(_0x3a3103||_0x5e682f)*0x3e8;await this['userBalanceService'][_0x15d020(0x277)](_0x4d9fb2,_0x3fade3,_0x3f4c5a),common_1['Logger']['log'](_0x15d020(0x281),_0x3f54d5,'TTSService');const _0x1132d2={'method':'POST','url':_0x5a0344+_0x15d020(0x239),'headers':{'Content-Type':_0x15d020(0x230),'Authorization':_0x15d020(0x244)+_0x523f89},'responseType':'arraybuffer','timeout':_0x5defa2,'data':{'model':_0x15d020(0x1f8),'input':_0x3f54d5,'voice':_0x289dee||_0x15d020(0x22d)}};try{const _0x2d4ad5=await(0x0,axios_1[_0x15d020(0x191)])(_0x1132d2);common_1[_0x15d020(0x23a)][_0x15d020(0x21d)](_0x15d020(0x20e),'TTSService');const _0x15bb30=Buffer[_0x15d020(0x1e3)](_0x2d4ad5['data']),_0x592b55=new Date(),_0x1f98af=_0x592b55[_0x15d020(0x1c3)](),_0x59eb92=String(_0x592b55[_0x15d020(0x210)]()+0x1)[_0x15d020(0x1e7)](0x2,'0'),_0x1a9145=String(_0x592b55['getDate']())[_0x15d020(0x1e7)](0x2,'0'),_0x596a64=''+_0x1f98af+_0x59eb92+'/'+_0x1a9145,_0x36332a=await this['uploadService']['uploadFile']({'buffer':_0x15bb30,'mimetype':_0x15d020(0x237)},'audio/openai/'+_0x596a64);await Promise[_0x15d020(0x247)]([this[_0x15d020(0x20a)]['updateChatLog'](_0x43bdc8,{'ttsUrl':_0x36332a}),this[_0x15d020(0x1d5)][_0x15d020(0x1fd)](_0x4d9fb2[_0x15d020(0x209)]['id'],_0x3fade3,_0x3f4c5a)]),_0x272dc4[_0x15d020(0x204)](0xc8)[_0x15d020(0x27a)]({'ttsUrl':_0x36332a});}catch(_0x369826){common_1['Logger'][_0x15d020(0x1c5)](_0x15d020(0x28c),_0x369826,_0x15d020(0x1b1)),_0x272dc4[_0x15d020(0x204)](0x1f4)[_0x15d020(0x27a)]({'error':_0x15d020(0x1fc)});}}};ChatService=__decorate([(0x0,common_1[_0x4f80b8(0x1e8)])(),__param(0x0,(0x0,typeorm_1[_0x4f80b8(0x1a5)])(config_entity_1[_0x4f80b8(0x1dd)])),__param(0x1,(0x0,typeorm_1[_0x4f80b8(0x1a5)])(app_entity_1[_0x4f80b8(0x1d1)])),__param(0x2,(0x0,typeorm_1[_0x4f80b8(0x1a5)])(plugin_entity_1[_0x4f80b8(0x1d0)])),__metadata(_0x4f80b8(0x1f3),[typeorm_2[_0x4f80b8(0x275)],typeorm_2['Repository'],typeorm_2['Repository'],suno_service_1[_0x4f80b8(0x27f)],openaiChat_service_1[_0x4f80b8(0x1cc)],chatLog_service_1[_0x4f80b8(0x1a0)],midjourneyDraw_service_1['MidjourneyService'],stableDiffusion_service_1[_0x4f80b8(0x19f)],userBalance_service_1['UserBalanceService'],user_service_1[_0x4f80b8(0x1ab)],upload_service_1[_0x4f80b8(0x242)],badWords_service_1['BadWordsService'],autoreply_service_1[_0x4f80b8(0x269)],globalConfig_service_1[_0x4f80b8(0x1bd)],chatGroup_service_1[_0x4f80b8(0x1b8)],models_service_1[_0x4f80b8(0x250)],openaiDraw_service_1['OpenAIDrawService'],lumaVideo_service_1[_0x4f80b8(0x20b)],cogVideo_service_1[_0x4f80b8(0x27d)],fluxDraw_service_1[_0x4f80b8(0x213)],aiPPT_1['AiPptService']])],ChatService),exports['ChatService']=ChatService;