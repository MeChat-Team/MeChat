'use strict';const _0x2b9ff2=_0x25d4;(function(_0x342491,_0x46169c){const _0x11b40e=_0x25d4,_0x48ddc2=_0x342491();while(!![]){try{const _0x1e96f9=parseInt(_0x11b40e(0x20b))/0x1*(-parseInt(_0x11b40e(0x23a))/0x2)+-parseInt(_0x11b40e(0x187))/0x3*(-parseInt(_0x11b40e(0x1f6))/0x4)+parseInt(_0x11b40e(0x208))/0x5*(-parseInt(_0x11b40e(0x235))/0x6)+-parseInt(_0x11b40e(0x1a6))/0x7*(-parseInt(_0x11b40e(0x21a))/0x8)+parseInt(_0x11b40e(0x225))/0x9*(parseInt(_0x11b40e(0x222))/0xa)+-parseInt(_0x11b40e(0x1cc))/0xb+parseInt(_0x11b40e(0x260))/0xc*(parseInt(_0x11b40e(0x23f))/0xd);if(_0x1e96f9===_0x46169c)break;else _0x48ddc2['push'](_0x48ddc2['shift']());}catch(_0x5f166e){_0x48ddc2['push'](_0x48ddc2['shift']());}}}(_0x4ef5,0x96f75));var __decorate=this&&this[_0x2b9ff2(0x171)]||function(_0x15d222,_0x4bbf55,_0x4a2791,_0x59d96f){const _0x41fcc1=_0x2b9ff2;var _0x4d6cae=arguments[_0x41fcc1(0x218)],_0x214d6f=_0x4d6cae<0x3?_0x4bbf55:_0x59d96f===null?_0x59d96f=Object[_0x41fcc1(0x181)](_0x4bbf55,_0x4a2791):_0x59d96f,_0x287b0f;if(typeof Reflect===_0x41fcc1(0x248)&&typeof Reflect[_0x41fcc1(0x242)]===_0x41fcc1(0x201))_0x214d6f=Reflect[_0x41fcc1(0x242)](_0x15d222,_0x4bbf55,_0x4a2791,_0x59d96f);else{for(var _0x5d402c=_0x15d222['length']-0x1;_0x5d402c>=0x0;_0x5d402c--)if(_0x287b0f=_0x15d222[_0x5d402c])_0x214d6f=(_0x4d6cae<0x3?_0x287b0f(_0x214d6f):_0x4d6cae>0x3?_0x287b0f(_0x4bbf55,_0x4a2791,_0x214d6f):_0x287b0f(_0x4bbf55,_0x4a2791))||_0x214d6f;}return _0x4d6cae>0x3&&_0x214d6f&&Object[_0x41fcc1(0x1c3)](_0x4bbf55,_0x4a2791,_0x214d6f),_0x214d6f;},__metadata=this&&this[_0x2b9ff2(0x16e)]||function(_0xec1a11,_0x1c8032){const _0x22337d=_0x2b9ff2;if(typeof Reflect===_0x22337d(0x248)&&typeof Reflect[_0x22337d(0x195)]===_0x22337d(0x201))return Reflect[_0x22337d(0x195)](_0xec1a11,_0x1c8032);},__param=this&&this['__param']||function(_0x2d915c,_0xdc8eee){return function(_0x5ef5c6,_0x25c06d){_0xdc8eee(_0x5ef5c6,_0x25c06d,_0x2d915c);};};function _0x4ef5(){const _0x448ad0=['cog-video','8440GxPjxh','push','getMonth','1854WIMoCK','midjourney','100%','gpt-4-gizmo-','toString','chatGroupService','../ai/midjourneyDraw.service','SunoService','checkAutoReply','BAD_REQUEST','使用文件解析:\x20','返回原始链接:\x20','ChatGroupService','flux','isConvertToBase64','你当前使用的应用已被下架、请删除当前对话开启新的对话吧！','2257482AyKbGo','suno','生成失败','】，在回答问题之前，先检索知识库内有没有相关的内容，尽量使用知识库中获取到的信息来回答我的问题，以知识库中的为准。','}，给这个对话取一个名字，不超过10个字','2388052MyXhBD','content-type','POST','ModelsService','chatProcess','3054259nQCnsq','updateTime','使用全局预设:\x20','decorate','globalConfigService','openaiBaseKey','lumaVideo','queryUserBalance','convertUrlToBase64','object','midjourneyService','midjourneyDraw','1\x20小时内对话次数过多，请切换模型或稍后再试！','配置解析错误！','PluginService','更新对话组标题失败:\x20','toISOString','https://api.openai.com','未找到当前模型key，切换至全局模型','updateChatTitle','pluginEntity','usePlugin','InjectRepository','TTS\x20请求获取成功','}以及\x20AI\x20的回答{','HttpStatus','from','deductFromBalance','aiPptService','BadWordsService','提交成功，视频生成中','HttpException','sunoService','12lpUYDY','生成中','新对话','binary','../upload/upload.service','getGroupInfoFromId','../autoreply/autoreply.service','DrawService',';base64,','TTS\x20请求或上传过程失败:','then','application/json','@nestjs/typeorm','cogVideoService','模型切换错误，请检查全局模型配置！','model','debug','__metadata','插件调用错误:\x20','padStart','__decorate','user','stableDiffusionService','map','formatUrl','buildMessageFromParentMessageId','luma-video','data','用户ID:\x20','preset','userService','checkUserStatus','getClientIp','ChatService','base64','userBalanceService','getOwnPropertyDescriptor','openaiBaseUrl','../plugin/plugin.entity','TOO_MANY_REQUESTS','openAIChat','\x20模型:\x20','33NzQIHr','trim','modelsService','fluxDrawService','正在尝试转换URL为Base64:\x20','findOne','sdxl','join','getFullYear','StableDiffusionService','../ai/cogVideo.service','badWordsService','log','image_url','metadata','updateChatLog','replace','arraybuffer','../ai/lumaVideo.service','提交成功，歌曲生成中','@nestjs/common','stable-diffusion','ai-ppt','Bearer\x20','getTokenCount','suno-music','系统消息超过最大长度，将被截断','configEntity','AppEntity','../ai/openaiChat.service','answer','91VkyGSi','转换URL为Base64时发生错误:','UploadService','uploadService','chat-error\x20<----------------------------------------->','split',',\x20消耗积分：\x20','modelName','openAIDrawService','开始生成PPT','chatHistory','lumaVideoService','dall-e-3','typeorm','close','chatLogService','更新标题名称为:\x20','成功转换URL为Base64:\x20','splice','FluxDrawService','chatFree','../badWords/badWords.service','../ai/openaiDraw.service','\x20消耗token:\x20','IMAGINE','UPSCALE','PluginEntity','getConfigs','text','defineProperty','mjTranslatePrompt','getCurrentModelKeyInfo','autoreplyService','\x20回复出错，本次不扣除积分','system','Content-type','AiPptService','OpenAIChatService','313093QmXYqN','userBalance','stringify','ceil','根据用户提问{','isArray','tts-1','default','match','application/octet-stream;\x20charset=utf-8','openAIChatService','Translate\x20any\x20given\x20phrase\x20from\x20any\x20language\x20into\x20English.\x20For\x20instance,\x20when\x20I\x20input\x20\x27{可爱的熊猫}\x27,\x20you\x20should\x20output\x20\x27{cute\x20panda}\x27,\x20with\x20no\x20period\x20at\x20the\x20end.','UserBalanceService','content','error','all','成功获取图片，正在转换为Base64:\x20','data:','../ai/suno.service','Logger','errMsg','您提交的信息中包含违规的内容，我们已对您的账户进行标记，请合规使用！','LumaVideoService','发生未知错误，请稍后再试','使用应用预设:\x20','openaiBaseModel','发生错误:','以下是我提供给你的知识库：【','axios','send','config','fileInfo','isSystemPlugin','ConfigEntity','status','validateBalance','checkBadWords','isGeneratePromptReference','处理历史记录时出错:','assistant','catch','ttsProcess','261796XdThCS','cogVideo','使用插件预设:\x20','parameters','绘制中','\x20模型名称:\x20','forEach','../globalConfig/config.entity','onyx','UserService','pluginImg','function','MidjourneyService','parse','/plugins/','绘图失败','headers','任务提交失败，不执行扣费','5PItgdV','GlobalConfigService','openaiVoice','1fOkofA','调用\x20chatFree\x20出错:\x20','write','../ai/stableDiffusion.service','checkModelLimits','OpenAIDrawService','pluginUrl','saveUseLog','}，生成三个更进入一步的提问，用{}包裹每个问题，不需要分行，不需要其他任何内容，单个提问不超过30个字','../userBalance/userBalance.service','Injectable','/v1/audio/speech','Repository','length','fluxDraw','669752WkVbbI','update','includes','role','appEntity','slice','openaiTimeout'];_0x4ef5=function(){return _0x448ad0;};return _0x4ef5();}Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[_0x2b9ff2(0x17e)]=void 0x0;const utils_1=require('../../common/utils'),common_1=require(_0x2b9ff2(0x19b)),typeorm_1=require(_0x2b9ff2(0x169)),axios_1=require(_0x2b9ff2(0x1e8)),typeorm_2=require(_0x2b9ff2(0x1b3)),aiPPT_1=require('../ai/aiPPT'),cogVideo_service_1=require(_0x2b9ff2(0x191)),fluxDraw_service_1=require('../ai/fluxDraw.service'),lumaVideo_service_1=require(_0x2b9ff2(0x199)),midjourneyDraw_service_1=require(_0x2b9ff2(0x22b)),openaiChat_service_1=require(_0x2b9ff2(0x1a4)),openaiDraw_service_1=require(_0x2b9ff2(0x1bc)),stableDiffusion_service_1=require(_0x2b9ff2(0x20e)),suno_service_1=require(_0x2b9ff2(0x1de)),app_entity_1=require('../app/app.entity'),autoreply_service_1=require(_0x2b9ff2(0x163)),badWords_service_1=require(_0x2b9ff2(0x1bb)),chatGroup_service_1=require('../chatGroup/chatGroup.service'),chatLog_service_1=require('../chatLog/chatLog.service'),config_entity_1=require(_0x2b9ff2(0x1fd)),globalConfig_service_1=require('../globalConfig/globalConfig.service'),models_service_1=require('../models/models.service'),plugin_entity_1=require(_0x2b9ff2(0x183)),upload_service_1=require(_0x2b9ff2(0x161)),user_service_1=require('../user/user.service'),userBalance_service_1=require(_0x2b9ff2(0x214));let ChatService=class ChatService{constructor(_0x25b675,_0x546bb5,_0x1af290,_0xb1fe47,_0x55f823,_0x2e57dd,_0x4306b8,_0x49d034,_0x5b66a0,_0x5d0a04,_0xd7d35f,_0x5d23da,_0x1cf897,_0x4c8c31,_0x23f291,_0x2307fe,_0x25d829,_0x592488,_0x539c8b,_0xc6d165,_0x148e49){const _0x327808=_0x2b9ff2;this[_0x327808(0x1a2)]=_0x25b675,this[_0x327808(0x21e)]=_0x546bb5,this['pluginEntity']=_0x1af290,this[_0x327808(0x25f)]=_0xb1fe47,this['openAIChatService']=_0x55f823,this['chatLogService']=_0x2e57dd,this[_0x327808(0x249)]=_0x4306b8,this[_0x327808(0x173)]=_0x49d034,this['userBalanceService']=_0x5b66a0,this[_0x327808(0x17b)]=_0x5d0a04,this[_0x327808(0x1a9)]=_0xd7d35f,this['badWordsService']=_0x5d23da,this[_0x327808(0x1c6)]=_0x1cf897,this[_0x327808(0x243)]=_0x4c8c31,this[_0x327808(0x22a)]=_0x23f291,this[_0x327808(0x189)]=_0x2307fe,this[_0x327808(0x1ae)]=_0x25d829,this[_0x327808(0x1b1)]=_0x592488,this[_0x327808(0x16a)]=_0x539c8b,this[_0x327808(0x18a)]=_0xc6d165,this[_0x327808(0x25b)]=_0x148e49;}async[_0x2b9ff2(0x23e)](_0x34dfbe,_0xe56e9b,_0x1fd676){const _0x2ee0f4=_0x2b9ff2;await this[_0x2ee0f4(0x180)]['checkUserCertification'](_0xe56e9b[_0x2ee0f4(0x172)]['id']);const {options:options={},usingPluginId:_0xb8f801,appId:appId=null,specialModel:_0x251544,prompt:_0x42a8fa,fileInfo:_0x4ca128,extraParam:_0x6f87a0,model:_0x53ee6e,drawId:_0x78e6be,customId:_0x22bae5,action:_0x4fd716,modelName:_0x491b42,modelAvatar:_0x5c839d}=_0x34dfbe;let _0x25e9f0;if(_0x251544)_0x25e9f0=await this[_0x2ee0f4(0x21e)][_0x2ee0f4(0x18c)]({'where':{'des':_0x251544,'isSystemReserved':!![]}});else{if(appId){_0x25e9f0=await this[_0x2ee0f4(0x21e)][_0x2ee0f4(0x18c)]({'where':{'id':appId,'status':(0x0,typeorm_2['In'])([0x1,0x3,0x4,0x5])}});if(!_0x25e9f0)throw new common_1[(_0x2ee0f4(0x25e))](_0x2ee0f4(0x234),common_1[_0x2ee0f4(0x258)]['BAD_REQUEST']);}}const {groupId:_0x10638b,fileParsing:_0x18ce89}=options,{openaiTimeout:_0x33f5dc,openaiBaseUrl:_0x818544,openaiBaseKey:_0x331d65,systemPreMessage:_0x50f745,isMjTranslate:_0x4656da,mjTranslatePrompt:_0x5be9a0,openaiTemperature:_0x507683,openaiBaseModel:_0x2b62a6,isGeneratePromptReference:_0x3ae8a8,isConvertToBase64:_0x1b7421,isSensitiveWordFilter:_0x544fbb}=await this[_0x2ee0f4(0x243)][_0x2ee0f4(0x1c1)]([_0x2ee0f4(0x220),_0x2ee0f4(0x182),_0x2ee0f4(0x244),'systemPreMessage','isMjTranslate',_0x2ee0f4(0x1c4),'openaiTemperature',_0x2ee0f4(0x1e5),_0x2ee0f4(0x1f1),_0x2ee0f4(0x233),'isSensitiveWordFilter']);await this[_0x2ee0f4(0x17b)][_0x2ee0f4(0x17c)](_0xe56e9b[_0x2ee0f4(0x172)]),_0x1fd676&&_0x1fd676['setHeader'](_0x2ee0f4(0x1c9),_0x2ee0f4(0x1d5));if(_0x544fbb==='1'){const _0x46d95b=await this[_0x2ee0f4(0x192)][_0x2ee0f4(0x1f0)](_0x42a8fa,_0xe56e9b['user']['id']);if(_0x46d95b[_0x2ee0f4(0x218)]>0x0){const _0x42f7b7=_0x2ee0f4(0x1e1);throw new common_1[(_0x2ee0f4(0x25e))](_0x42f7b7,common_1[_0x2ee0f4(0x258)]['BAD_REQUEST']);}}const _0x35bff3=await this[_0x2ee0f4(0x1c6)][_0x2ee0f4(0x22d)](_0x42a8fa);let _0x395f58=null,_0x81cbac='',_0x52d2f4='';_0x1fd676&&_0x1fd676[_0x2ee0f4(0x1ee)](0xc8);let _0x45a70c=null;const _0x3aab37=(0x0,utils_1[_0x2ee0f4(0x17d)])(_0xe56e9b);let _0x240581,_0x53b046='',_0x8d71ca;_0xb8f801&&(_0x8d71ca=await this[_0x2ee0f4(0x253)][_0x2ee0f4(0x18c)]({'where':{'id':_0xb8f801}}));if(_0x25e9f0){const {isGPTs:_0xda361a,gizmoID:_0x16c7fa,name:_0x53effc,isFixedModel:_0x89f99,appModel:_0x27cfbc,coverImg:_0x2e3cd4}=_0x25e9f0;_0x53b046=_0x2e3cd4,_0x81cbac=_0x53effc;if(_0xda361a)_0x395f58=await this[_0x2ee0f4(0x189)][_0x2ee0f4(0x1c5)]('gpts'),_0x395f58[_0x2ee0f4(0x16c)]=_0x2ee0f4(0x228)+_0x16c7fa;else!_0xda361a&&_0x89f99&&_0x27cfbc?(_0x25e9f0['preset']&&(_0x52d2f4=_0x25e9f0['preset']),_0x395f58=await this[_0x2ee0f4(0x189)][_0x2ee0f4(0x1c5)](_0x27cfbc),_0x395f58[_0x2ee0f4(0x16c)]=_0x27cfbc,_0x18ce89&&(_0x52d2f4=_0x52d2f4+_0x2ee0f4(0x1e7)+_0x18ce89+'】，在回答问题之前，先检索知识库内有没有相关的内容，尽量使用知识库中获取到的信息来回答我的问题，以知识库中的为准。'),common_1[_0x2ee0f4(0x1df)][_0x2ee0f4(0x193)]('固定模型、使用应用预设:\x20'+_0x52d2f4,_0x2ee0f4(0x17e))):(_0x25e9f0['preset']&&(_0x52d2f4=_0x25e9f0[_0x2ee0f4(0x17a)]),_0x395f58=await this[_0x2ee0f4(0x189)][_0x2ee0f4(0x1c5)](_0x53ee6e),_0x18ce89&&(_0x52d2f4=_0x52d2f4+_0x2ee0f4(0x1e7)+_0x18ce89+_0x2ee0f4(0x238)),common_1['Logger'][_0x2ee0f4(0x193)](_0x2ee0f4(0x1e4)+_0x52d2f4,_0x2ee0f4(0x17e)));}else{const _0xf3175f=await this[_0x2ee0f4(0x22a)][_0x2ee0f4(0x162)](_0x10638b);if(_0x8d71ca&&_0x8d71ca[_0x2ee0f4(0x1ec)]===0x0){let _0x24eaba='';try{_0x24eaba=await this['usePlugin'](_0x42a8fa,_0x8d71ca[_0x2ee0f4(0x1f9)]),common_1[_0x2ee0f4(0x1df)][_0x2ee0f4(0x193)]('插件返回结果:\x20'+_0x24eaba,_0x2ee0f4(0x17e));}catch(_0x34411c){_0x24eaba=_0x42a8fa,common_1[_0x2ee0f4(0x1df)]['error'](_0x2ee0f4(0x16f)+_0x34411c);}_0x52d2f4=_0x24eaba,_0x395f58=await this[_0x2ee0f4(0x189)][_0x2ee0f4(0x1c5)](_0x53ee6e),common_1[_0x2ee0f4(0x1df)][_0x2ee0f4(0x193)](_0x2ee0f4(0x1f8)+_0x52d2f4,'ChatService');}else{if(_0x18ce89)_0x52d2f4=_0x2ee0f4(0x1e7)+_0x18ce89+'】，在回答问题之前，先检索知识库内有没有相关的内容，尽量使用知识库中获取到的信息来回答我的问题，以知识库中的为准。',_0x395f58=await this[_0x2ee0f4(0x189)][_0x2ee0f4(0x1c5)](_0x53ee6e),common_1[_0x2ee0f4(0x1df)][_0x2ee0f4(0x193)](_0x2ee0f4(0x22f)+_0x52d2f4,_0x2ee0f4(0x17e));else{const _0x432679=new Date()[_0x2ee0f4(0x24f)]()['split']('T')[0x0];_0x52d2f4=_0x50f745+('\x0a\x20Current\x20date:\x20'+_0x432679),_0x395f58=await this['modelsService']['getCurrentModelKeyInfo'](_0x53ee6e),common_1[_0x2ee0f4(0x1df)][_0x2ee0f4(0x193)](_0x2ee0f4(0x241)+_0x52d2f4,_0x2ee0f4(0x17e));}}}if(!_0x395f58){common_1[_0x2ee0f4(0x1df)][_0x2ee0f4(0x16d)](_0x2ee0f4(0x251),_0x2ee0f4(0x17e)),_0x395f58=await this[_0x2ee0f4(0x189)][_0x2ee0f4(0x1c5)](_0x2b62a6);const _0x265a5d=await this[_0x2ee0f4(0x22a)][_0x2ee0f4(0x162)](_0x10638b);let _0x4e0b46=_0x265a5d['config'];try{const _0x457b5e=JSON[_0x2ee0f4(0x203)](_0x265a5d[_0x2ee0f4(0x1ea)]);_0x457b5e['modelInfo']&&(_0x457b5e['modelInfo'][_0x2ee0f4(0x1ad)]=_0x395f58['modelName'],_0x457b5e['modelInfo']['model']=_0x395f58[_0x2ee0f4(0x16c)],_0x4e0b46=JSON[_0x2ee0f4(0x1ce)](_0x457b5e));}catch(_0x33cc3c){common_1[_0x2ee0f4(0x1df)][_0x2ee0f4(0x16d)](_0x2ee0f4(0x16b),_0x2ee0f4(0x17e));throw new common_1[(_0x2ee0f4(0x25e))](_0x2ee0f4(0x24c),common_1[_0x2ee0f4(0x258)][_0x2ee0f4(0x22e)]);}await this['chatGroupService'][_0x2ee0f4(0x21b)]({'groupId':_0x10638b,'title':_0x265a5d['title'],'isSticky':![],'config':_0x4e0b46,'fileUrl':''},_0xe56e9b);}const {deduct:_0x13cedd,isTokenBased:_0x2c5fd4,tokenFeeRatio:_0x5ab144,deductType:_0x87cb5e,key:_0x42ac87,id:_0x20d260,maxRounds:_0x13b2dd,proxyUrl:_0x59bd93,maxModelTokens:_0x6c23ff,timeout:_0x3f0e8a,model:_0x264c93,isFileUpload:_0x3dc586,keyType:_0x5c0569}=_0x395f58;if(await this[_0x2ee0f4(0x1b5)][_0x2ee0f4(0x20f)](_0xe56e9b[_0x2ee0f4(0x172)],_0x264c93))throw new common_1[(_0x2ee0f4(0x25e))](_0x2ee0f4(0x24b),common_1[_0x2ee0f4(0x258)][_0x2ee0f4(0x184)]);if(_0x4656da==='1'&&_0x4fd716===_0x2ee0f4(0x1be)&&_0x53ee6e==='midjourney'){const [_0x338646,_0x3f3c67]=_0x42a8fa[_0x2ee0f4(0x1ab)](/(?= --)/),_0x35b137=/(https?:\/\/[^\s]+)/g,_0x57c7ba=_0x338646[_0x2ee0f4(0x1d4)](_0x35b137)||[];let _0x1eb1f4=_0x338646[_0x2ee0f4(0x197)](_0x35b137,'')['trim']();const _0x559363=await this[_0x2ee0f4(0x1d6)][_0x2ee0f4(0x1ba)](_0x1eb1f4,_0x5be9a0||_0x2ee0f4(0x1d7)),_0x183264=[..._0x57c7ba,_0x559363]['join']('\x20')['trim']();_0x240581=_0x3f3c67?''+_0x183264+_0x3f3c67:_0x183264,_0x3dc586==='1'&&_0x4ca128&&(_0x240581=_0x4ca128+'\x20'+_0x240581);}else _0x240581=_0x3dc586==='1'&&_0x4ca128?_0x4ca128+'\x20'+_0x42a8fa:_0x42a8fa;await this[_0x2ee0f4(0x180)]['validateBalance'](_0xe56e9b,_0x87cb5e,_0x13cedd);const _0x1c076f=_0x491b42,_0x17a554=(0x0,utils_1[_0x2ee0f4(0x175)])(_0x59bd93||_0x818544||_0x2ee0f4(0x250)),_0xd4c51b=_0x42ac87||_0x331d65,_0x565e83=(_0x3f0e8a||_0x33f5dc||0x12c)*0x3e8,_0x3c44b3=Number(_0x507683)||0x1;if(_0x10638b){const _0x1888d3=await this[_0x2ee0f4(0x22a)][_0x2ee0f4(0x162)](_0x10638b);this[_0x2ee0f4(0x252)](_0x10638b,_0x1888d3,_0x5c0569,_0x42a8fa,_0xe56e9b),await this[_0x2ee0f4(0x22a)][_0x2ee0f4(0x240)](_0x10638b);}const _0x252be2=await this[_0x2ee0f4(0x1b5)]['saveChatLog']({'appId':appId,'curIp':_0x3aab37,'userId':_0xe56e9b[_0x2ee0f4(0x172)]['id'],'type':_0x5c0569?_0x5c0569:0x1,'prompt':_0x42a8fa,'fileInfo':_0x4ca128?_0x4ca128:null,'answer':'','promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x264c93,'modelName':'我','role':'user','groupId':_0x10638b?_0x10638b:null}),_0x1d9ad0=await this[_0x2ee0f4(0x1b5)]['saveChatLog']({'appId':appId?appId:null,'action':_0x4fd716?_0x4fd716:null,'curIp':_0x3aab37,'userId':_0xe56e9b[_0x2ee0f4(0x172)]['id'],'type':_0x5c0569?_0x5c0569:0x1,'prompt':_0x42a8fa,'fileInfo':null,'answer':'','progress':'0%','promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x264c93,'modelName':_0x1c076f,'role':_0x2ee0f4(0x1f3),'groupId':_0x10638b?_0x10638b:null,'status':0x2,'modelAvatar':(_0x8d71ca===null||_0x8d71ca===void 0x0?void 0x0:_0x8d71ca[_0x2ee0f4(0x200)])||_0x53b046||_0x5c839d||'','pluginParam':(_0x8d71ca===null||_0x8d71ca===void 0x0?void 0x0:_0x8d71ca[_0x2ee0f4(0x1f9)])?_0x8d71ca[_0x2ee0f4(0x1f9)]:_0x5c0569===0x2?_0x264c93:null}),_0x3e2991=_0x252be2['id'],_0x489e30=_0x1d9ad0['id'];if(_0x35bff3[_0x2ee0f4(0x1a5)]&&_0x1fd676){if(_0x35bff3['isAIReplyEnabled']===0x0){const _0x5eb57b=_0x35bff3[_0x2ee0f4(0x1a5)][_0x2ee0f4(0x1ab)](''),_0x367764=_0x3147fd=>{const _0x3da6bc=_0x2ee0f4;if(_0x3147fd<_0x5eb57b[_0x3da6bc(0x218)]){const _0x3799b2={'text':_0x5eb57b[_0x3147fd]};_0x1fd676[_0x3da6bc(0x20d)](JSON[_0x3da6bc(0x1ce)](_0x3799b2)+'\x0a'),setTimeout(()=>_0x367764(_0x3147fd+0x1),0xa);}else _0x1fd676['end']();};_0x367764(0x0),await this[_0x2ee0f4(0x1b5)][_0x2ee0f4(0x196)](_0x489e30,{'answer':_0x35bff3[_0x2ee0f4(0x1a5)]});return;}else _0x52d2f4=_0x52d2f4+_0x35bff3['answer'];}const {messagesHistory:_0x487c7b}=await this['buildMessageFromParentMessageId'](_0x42a8fa,{'groupId':_0x10638b,'systemMessage':_0x52d2f4,'maxModelTokens':_0x6c23ff,'maxRounds':_0x13b2dd,'isConvertToBase64':_0x1b7421,'fileInfo':_0x4ca128,'model':_0x264c93,'isFileUpload':_0x3dc586},this['chatLogService']);let _0x443636=_0x4fd716!==_0x2ee0f4(0x1bf)&&_0x264c93==='midjourney'?_0x13cedd*0x4:_0x13cedd;const _0x85c1a=new AbortController();try{if(_0x1fd676){_0x1fd676['on'](_0x2ee0f4(0x1b4),()=>{_0x85c1a['abort']();});let _0xe5cd94,_0x1baa72=!![];try{if((_0x264c93===_0x2ee0f4(0x1b2)||_0x264c93===_0x2ee0f4(0x226)||_0x264c93===_0x2ee0f4(0x19d)||_0x264c93==='suno-music'||_0x264c93===_0x2ee0f4(0x177)||_0x264c93[_0x2ee0f4(0x21c)](_0x2ee0f4(0x19c))||_0x264c93[_0x2ee0f4(0x21c)](_0x2ee0f4(0x221))||_0x264c93['includes'](_0x2ee0f4(0x232)))&&_0x5c0569===0x2){if(_0x264c93===_0x2ee0f4(0x1b2))_0xe5cd94=this['openAIDrawService']['dalleDraw']({'prompt':_0x42a8fa,'extraParam':_0x6f87a0,'apiKey':_0xd4c51b,'proxyUrl':_0x17a554,'model':_0x264c93,'timeout':_0x565e83,'modelName':_0x1c076f,'groupId':_0x10638b,'onSuccess':async _0x1ee76f=>{const _0x30a0ce=_0x2ee0f4;await this[_0x30a0ce(0x1b5)][_0x30a0ce(0x196)](_0x489e30,{'fileInfo':_0x1ee76f===null||_0x1ee76f===void 0x0?void 0x0:_0x1ee76f[_0x30a0ce(0x1eb)],'answer':(_0x1ee76f===null||_0x1ee76f===void 0x0?void 0x0:_0x1ee76f['answer'])||_0x42a8fa,'progress':_0x30a0ce(0x227),'status':_0x1ee76f[_0x30a0ce(0x1ee)]});},'onFailure':async _0x19b762=>{const _0x35b2e0=_0x2ee0f4;await this[_0x35b2e0(0x1b5)][_0x35b2e0(0x196)](_0x489e30,{'answer':'绘图失败','status':_0x19b762['status']});}},this[_0x2ee0f4(0x176)]),await this['chatLogService'][_0x2ee0f4(0x196)](_0x489e30,{'answer':_0x2ee0f4(0x1fa)});else{if(_0x264c93===_0x2ee0f4(0x19d))common_1[_0x2ee0f4(0x1df)][_0x2ee0f4(0x193)](_0x2ee0f4(0x1af),_0x2ee0f4(0x164)),_0xe5cd94=this[_0x2ee0f4(0x25b)]['aiPPT']({'usePrompt':_0x240581,'prompt':_0x42a8fa,'apiKey':_0xd4c51b,'proxyUrl':_0x17a554,'model':_0x264c93,'modelName':_0x1c076f,'drawId':_0x78e6be,'customId':_0x22bae5,'action':_0x4fd716,'timeout':_0x565e83,'assistantLogId':_0x489e30,'extraParam':_0x6f87a0,'fileInfo':_0x4ca128}),await this['chatLogService'][_0x2ee0f4(0x196)](_0x489e30,{'answer':_0x2ee0f4(0x261)});else{if(_0x264c93[_0x2ee0f4(0x21c)](_0x2ee0f4(0x232)))_0xe5cd94=this[_0x2ee0f4(0x18a)][_0x2ee0f4(0x219)]({'prompt':_0x42a8fa,'extraParam':_0x6f87a0,'apiKey':_0xd4c51b,'proxyUrl':_0x17a554,'model':_0x264c93,'timeout':_0x565e83,'modelName':_0x1c076f,'groupId':_0x10638b,'onSuccess':async _0x78b988=>{const _0xbb7976=_0x2ee0f4;await this[_0xbb7976(0x1b5)][_0xbb7976(0x196)](_0x489e30,{'fileInfo':_0x78b988===null||_0x78b988===void 0x0?void 0x0:_0x78b988[_0xbb7976(0x1eb)],'answer':(_0x78b988===null||_0x78b988===void 0x0?void 0x0:_0x78b988[_0xbb7976(0x1a5)])||_0x42a8fa,'progress':_0xbb7976(0x227),'status':_0x78b988[_0xbb7976(0x1ee)]});},'onFailure':async _0x16eae9=>{const _0x3c7885=_0x2ee0f4;await this[_0x3c7885(0x1b5)][_0x3c7885(0x196)](_0x489e30,{'answer':_0x3c7885(0x205),'status':_0x16eae9[_0x3c7885(0x1ee)]});}},this['buildMessageFromParentMessageId']),await this[_0x2ee0f4(0x1b5)][_0x2ee0f4(0x196)](_0x489e30,{'answer':_0x2ee0f4(0x1fa)});else{if(_0x264c93['includes'](_0x2ee0f4(0x1a0)))_0xe5cd94=this[_0x2ee0f4(0x25f)][_0x2ee0f4(0x236)]({'assistantLogId':_0x489e30,'apiKey':_0xd4c51b,'action':_0x4fd716,'prompt':_0x42a8fa,'timeout':_0x565e83,'proxyUrl':_0x17a554,'taskData':_0x22bae5}),await this['chatLogService']['updateChatLog'](_0x489e30,{'answer':_0x2ee0f4(0x19a)});else{if(_0x264c93['includes'](_0x2ee0f4(0x177)))_0xe5cd94=this['lumaVideoService'][_0x2ee0f4(0x245)]({'fileInfo':_0x4ca128,'extraParam':_0x6f87a0,'assistantLogId':_0x489e30,'apiKey':_0xd4c51b,'action':_0x4fd716,'prompt':_0x42a8fa,'model':_0x264c93,'timeout':_0x565e83,'proxyUrl':_0x17a554,'taskData':_0x22bae5,'onGenerate':async _0x33e686=>{const _0x5b40a5=_0x2ee0f4;await this['chatLogService'][_0x5b40a5(0x196)](_0x489e30,{'fileInfo':_0x33e686===null||_0x33e686===void 0x0?void 0x0:_0x33e686[_0x5b40a5(0x1eb)],'answer':(_0x33e686===null||_0x33e686===void 0x0?void 0x0:_0x33e686['answer'])||_0x42a8fa,'status':0x2});},'onSuccess':async _0x1abafc=>{const _0x19eefb=_0x2ee0f4;await this[_0x19eefb(0x1b5)]['updateChatLog'](_0x489e30,{'fileInfo':_0x1abafc===null||_0x1abafc===void 0x0?void 0x0:_0x1abafc[_0x19eefb(0x1eb)],'answer':(_0x1abafc===null||_0x1abafc===void 0x0?void 0x0:_0x1abafc['answer'])||_0x42a8fa,'progress':_0x19eefb(0x227),'status':0x3});},'onFailure':async _0x1784b7=>{const _0x5bfe0a=_0x2ee0f4;await this[_0x5bfe0a(0x1b5)][_0x5bfe0a(0x196)](_0x489e30,{'answer':_0x1784b7['errMsg'],'status':0x4});}}),await this[_0x2ee0f4(0x1b5)][_0x2ee0f4(0x196)](_0x489e30,{'answer':'提交成功，视频生成中'});else{if(_0x264c93['includes'](_0x2ee0f4(0x221)))_0xe5cd94=this['cogVideoService'][_0x2ee0f4(0x1f7)]({'fileInfo':_0x4ca128,'extraParam':_0x6f87a0,'assistantLogId':_0x489e30,'apiKey':_0xd4c51b,'action':_0x4fd716,'prompt':_0x42a8fa,'model':_0x264c93,'timeout':_0x565e83,'proxyUrl':_0x17a554,'taskData':_0x22bae5,'onGenerate':async _0x5b3c3f=>{const _0x4a9534=_0x2ee0f4;await this[_0x4a9534(0x1b5)]['updateChatLog'](_0x489e30,{'fileInfo':_0x5b3c3f===null||_0x5b3c3f===void 0x0?void 0x0:_0x5b3c3f['fileInfo'],'answer':(_0x5b3c3f===null||_0x5b3c3f===void 0x0?void 0x0:_0x5b3c3f[_0x4a9534(0x1a5)])||_0x42a8fa,'status':0x2});},'onSuccess':async _0x501cbe=>{const _0x462ec6=_0x2ee0f4;await this['chatLogService'][_0x462ec6(0x196)](_0x489e30,{'fileInfo':_0x501cbe===null||_0x501cbe===void 0x0?void 0x0:_0x501cbe[_0x462ec6(0x1eb)],'answer':(_0x501cbe===null||_0x501cbe===void 0x0?void 0x0:_0x501cbe[_0x462ec6(0x1a5)])||_0x42a8fa,'progress':_0x462ec6(0x227),'status':0x3});},'onFailure':async _0x22cc0c=>{const _0x286c0e=_0x2ee0f4;await this['chatLogService'][_0x286c0e(0x196)](_0x489e30,{'answer':_0x22cc0c[_0x286c0e(0x1e0)],'status':0x4});}}),await this['chatLogService'][_0x2ee0f4(0x196)](_0x489e30,{'answer':_0x2ee0f4(0x25d)});else _0x264c93[_0x2ee0f4(0x21c)](_0x2ee0f4(0x19c))?(_0xe5cd94=this[_0x2ee0f4(0x173)][_0x2ee0f4(0x18d)]({'chatId':_0x489e30,'maxModelTokens':_0x6c23ff,'apiKey':_0xd4c51b,'model':_0x264c93,'modelName':_0x1c076f,'modelType':_0x5c0569,'prompt':_0x42a8fa,'fileInfo':_0x4ca128,'isFileUpload':_0x3dc586,'timeout':_0x565e83,'proxyUrl':_0x17a554,'onSuccess':async _0x2b3303=>{const _0x28f384=_0x2ee0f4;await this[_0x28f384(0x1b5)][_0x28f384(0x196)](_0x489e30,{'fileInfo':_0x2b3303===null||_0x2b3303===void 0x0?void 0x0:_0x2b3303[_0x28f384(0x1eb)],'answer':(_0x2b3303===null||_0x2b3303===void 0x0?void 0x0:_0x2b3303['answer'])||_0x42a8fa,'progress':_0x28f384(0x227),'status':0x3});},'onFailure':async _0xb2dffc=>{const _0x284988=_0x2ee0f4;await this[_0x284988(0x1b5)][_0x284988(0x196)](_0x489e30,{'answer':_0x284988(0x237),'status':0x4});}}),await this[_0x2ee0f4(0x1b5)][_0x2ee0f4(0x196)](_0x489e30,{'answer':_0x2ee0f4(0x1fa)})):(_0xe5cd94=await this[_0x2ee0f4(0x249)][_0x2ee0f4(0x24a)]({'usePrompt':_0x240581,'prompt':_0x42a8fa,'apiKey':_0xd4c51b,'proxyUrl':_0x17a554,'model':_0x264c93,'modelName':_0x1c076f,'drawId':_0x78e6be,'customId':_0x22bae5,'action':_0x4fd716,'fileInfo':_0x4ca128,'timeout':_0x565e83,'assistantLogId':_0x489e30,'pluginName':_0x8d71ca}),await this['chatLogService']['updateChatLog'](_0x489e30,{'answer':_0xe5cd94['answer'],'status':_0xe5cd94[_0x2ee0f4(0x1ee)]}));}}}}}_0xe5cd94[_0x2ee0f4(0x1ee)]!==0x5?(await this[_0x2ee0f4(0x189)][_0x2ee0f4(0x212)](_0x20d260,0x1),await this[_0x2ee0f4(0x180)][_0x2ee0f4(0x25a)](_0xe56e9b[_0x2ee0f4(0x172)]['id'],_0x87cb5e,_0x443636)):common_1[_0x2ee0f4(0x1df)]['log'](_0x2ee0f4(0x207),_0x2ee0f4(0x17e));const _0x7ea7b7=await this[_0x2ee0f4(0x180)][_0x2ee0f4(0x246)](_0xe56e9b[_0x2ee0f4(0x172)]['id']);return _0xe5cd94[_0x2ee0f4(0x1cd)]=Object['assign']({},_0x7ea7b7),_0xe5cd94[_0x2ee0f4(0x1c2)]=_0xe5cd94['answer'],_0xe5cd94['status']=_0xe5cd94[_0x2ee0f4(0x1ee)]||0x2,_0xe5cd94['model']=_0x53ee6e,_0xe5cd94[_0x2ee0f4(0x1ad)]=_0x491b42,_0x1fd676['write']('\x0a'+JSON[_0x2ee0f4(0x1ce)](_0xe5cd94));}else{_0xe5cd94=await this[_0x2ee0f4(0x1d6)]['openAIChat'](_0x487c7b,{'chatId':_0x489e30,'maxModelTokens':_0x6c23ff,'apiKey':_0xd4c51b,'model':_0x264c93,'modelName':_0x1c076f,'temperature':_0x3c44b3,'modelType':_0x5c0569,'prompt':_0x42a8fa,'fileInfo':_0x4ca128,'isFileUpload':_0x3dc586,'timeout':_0x565e83,'proxyUrl':_0x17a554,'modelAvatar':_0x5c839d,'onProgress':_0x20a0fb=>{const _0x4c7b23=_0x2ee0f4;_0x1fd676['write'](_0x1baa72?JSON[_0x4c7b23(0x1ce)](_0x20a0fb):'\x0a'+JSON[_0x4c7b23(0x1ce)](_0x20a0fb)),_0x1baa72=![];},'onFailure':async _0x16ad6d=>{const _0x179e13=_0x2ee0f4;await this['chatLogService'][_0x179e13(0x196)](_0x489e30,{'answer':_0x16ad6d['errMsg'],'status':0x4});},'abortController':_0x85c1a});if(_0xe5cd94[_0x2ee0f4(0x1e0)])return common_1[_0x2ee0f4(0x1df)][_0x2ee0f4(0x1da)](_0x2ee0f4(0x179)+_0xe56e9b[_0x2ee0f4(0x172)]['id']+_0x2ee0f4(0x1fb)+_0x1c076f+_0x2ee0f4(0x186)+_0x53ee6e+_0x2ee0f4(0x1c7),_0x2ee0f4(0x17e)),_0x1fd676[_0x2ee0f4(0x20d)]('\x0a'+JSON[_0x2ee0f4(0x1ce)](_0xe5cd94));let _0x249e8b='';_0x487c7b[_0x2ee0f4(0x1fc)](_0x15894b=>{const _0x22faaa=_0x2ee0f4;_0x249e8b+=_0x15894b[_0x22faaa(0x1d9)]+'\x20';});const _0x569409=await(0x0,utils_1[_0x2ee0f4(0x19f)])(_0x249e8b),_0x5c5f72=await(0x0,utils_1['getTokenCount'])(_0xe5cd94[_0x2ee0f4(0x1a5)]);await this[_0x2ee0f4(0x1b5)][_0x2ee0f4(0x196)](_0x3e2991,{'promptTokens':_0x569409,'completionTokens':_0x5c5f72,'totalTokens':_0x569409+_0x5c5f72});let _0x8bc88b=_0xe5cd94[_0x2ee0f4(0x1a5)];if(_0x544fbb==='1'){const _0x3bd305=await this[_0x2ee0f4(0x192)]['checkBadWords'](_0xe5cd94[_0x2ee0f4(0x1a5)],_0xe56e9b[_0x2ee0f4(0x172)]['id']);if(_0x3bd305[_0x2ee0f4(0x218)]>0x0){const _0x2f7fe5=new RegExp(_0x3bd305[_0x2ee0f4(0x18e)]('|'),'gi');_0x8bc88b=_0x8bc88b[_0x2ee0f4(0x197)](_0x2f7fe5,_0x15d473=>'*'['repeat'](_0x15d473['length']));}}await this[_0x2ee0f4(0x1b5)][_0x2ee0f4(0x196)](_0x489e30,{'fileInfo':_0xe5cd94===null||_0xe5cd94===void 0x0?void 0x0:_0xe5cd94[_0x2ee0f4(0x1eb)],'answer':_0x8bc88b,'promptTokens':_0x569409,'completionTokens':_0x5c5f72,'totalTokens':_0x569409+_0x5c5f72,'status':0x3});try{if(_0x3ae8a8==='1'){const _0x470d57=await this['openAIChatService']['chatFree'](_0x2ee0f4(0x1d0)+_0x42a8fa+_0x2ee0f4(0x257)+_0xe5cd94['answer']+_0x2ee0f4(0x213));await this[_0x2ee0f4(0x1b5)]['updateChatLog'](_0x489e30,{'promptReference':_0x470d57});}}catch(_0x483cb4){common_1[_0x2ee0f4(0x1df)][_0x2ee0f4(0x1da)](_0x2ee0f4(0x20c)+_0x483cb4);}_0x2c5fd4===!![]&&(_0x443636=_0x13cedd*Math[_0x2ee0f4(0x1cf)]((_0x569409+_0x5c5f72)/_0x5ab144));await this[_0x2ee0f4(0x180)]['deductFromBalance'](_0xe56e9b['user']['id'],_0x87cb5e,_0x443636,_0x569409+_0x5c5f72),await this['modelsService'][_0x2ee0f4(0x212)](_0x20d260,_0x569409+_0x5c5f72),common_1[_0x2ee0f4(0x1df)][_0x2ee0f4(0x193)](_0x2ee0f4(0x179)+_0xe56e9b[_0x2ee0f4(0x172)]['id']+'\x20模型名称:\x20'+_0x1c076f+_0x2ee0f4(0x186)+_0x53ee6e+_0x2ee0f4(0x1bd)+(_0x569409+_0x5c5f72)+_0x2ee0f4(0x1ac)+_0x443636,_0x2ee0f4(0x17e));const _0x10972a=await this[_0x2ee0f4(0x180)][_0x2ee0f4(0x246)](_0xe56e9b[_0x2ee0f4(0x172)]['id']);return _0xe5cd94[_0x2ee0f4(0x1cd)]=Object['assign']({},_0x10972a),_0x1fd676[_0x2ee0f4(0x20d)]('\x0a'+JSON[_0x2ee0f4(0x1ce)](_0xe5cd94));}}catch(_0x345d49){common_1[_0x2ee0f4(0x1df)][_0x2ee0f4(0x1da)](_0x2ee0f4(0x1e6),_0x345d49),await this[_0x2ee0f4(0x1b5)][_0x2ee0f4(0x196)](_0x489e30,{'status':0x5}),_0xe5cd94={'error':'处理请求时发生错误'};}}else return _0x45a70c=await this[_0x2ee0f4(0x1d6)][_0x2ee0f4(0x185)](_0x487c7b,{'chatId':_0x489e30,'maxModelTokens':_0x6c23ff,'apiKey':_0xd4c51b,'model':_0x264c93,'modelName':_0x1c076f,'modelType':_0x5c0569,'temperature':_0x3c44b3,'prompt':_0x42a8fa,'fileInfo':_0x4ca128,'isFileUpload':_0x3dc586,'timeout':_0x565e83,'proxyUrl':_0x17a554,'abortController':_0x85c1a}),await this['userBalanceService']['deductFromBalance'](_0xe56e9b[_0x2ee0f4(0x172)]['id'],_0x87cb5e,_0x443636),_0x45a70c[_0x2ee0f4(0x1a5)];}catch(_0x98a992){common_1[_0x2ee0f4(0x1df)]['error'](_0x2ee0f4(0x1aa),_0xd4c51b,_0x98a992);if(_0x1fd676)return _0x1fd676[_0x2ee0f4(0x20d)](_0x2ee0f4(0x1e3));else throw new common_1['HttpException']('发生未知错误，请稍后再试',common_1[_0x2ee0f4(0x258)][_0x2ee0f4(0x22e)]);}finally{_0x1fd676&&_0x1fd676['end']();}}async[_0x2b9ff2(0x254)](_0x528906,_0x3f7038){const _0x44014d=_0x2b9ff2,{pluginUrl:_0x365c93,pluginKey:_0x5452ab}=await this[_0x44014d(0x243)][_0x44014d(0x1c1)]([_0x44014d(0x211),'pluginKey']),_0x5d203b=_0x5452ab,_0x363ca=_0x365c93,_0x372619={'method':_0x44014d(0x23c),'url':_0x363ca+_0x44014d(0x204)+_0x3f7038,'headers':{'Content-Type':_0x44014d(0x168),'Authorization':_0x44014d(0x19e)+_0x5d203b},'data':{'prompt':_0x528906}};try{const _0x2b42ba=await(0x0,axios_1[_0x44014d(0x1d3)])(_0x372619);return common_1['Logger'][_0x44014d(0x193)]('插件调用成功\x20返回结果:\x20'+JSON[_0x44014d(0x1ce)](_0x2b42ba[_0x44014d(0x178)],null,0x2),_0x44014d(0x24d)),_0x2b42ba[_0x44014d(0x178)][_0x44014d(0x1c2)];}catch(_0x255825){common_1[_0x44014d(0x1df)][_0x44014d(0x1da)]('error:\x20',_0x255825);}}async[_0x2b9ff2(0x252)](_0x428d93,_0xb1a6eb,_0x2d482b,_0x55287a,_0x287829){const _0x323a84=_0x2b9ff2;if((_0xb1a6eb===null||_0xb1a6eb===void 0x0?void 0x0:_0xb1a6eb['title'])===_0x323a84(0x262)){let _0x1fb52d;if(_0x2d482b===0x1)try{_0x1fb52d=await this[_0x323a84(0x1d6)][_0x323a84(0x1ba)](_0x323a84(0x1d0)+_0x55287a+_0x323a84(0x239)),_0x1fb52d[_0x323a84(0x218)]>0xf&&(_0x1fb52d=_0x1fb52d[_0x323a84(0x21f)](0x0,0xf));}catch(_0x3fb5cb){common_1[_0x323a84(0x1df)]['error'](_0x323a84(0x20c)+_0x3fb5cb),_0x1fb52d=_0x55287a[_0x323a84(0x21f)](0x0,0xa);}else _0x1fb52d='创意\x20AI';this[_0x323a84(0x22a)][_0x323a84(0x21b)]({'groupId':_0x428d93,'title':_0x1fb52d,'isSticky':![],'config':'','fileUrl':''},_0x287829)[_0x323a84(0x167)](()=>common_1[_0x323a84(0x1df)][_0x323a84(0x193)](_0x323a84(0x1b6)+_0x1fb52d,_0x323a84(0x17e)))[_0x323a84(0x1f4)](_0x2bd3a5=>common_1[_0x323a84(0x1df)]['error'](_0x323a84(0x24e)+_0x2bd3a5));}}async[_0x2b9ff2(0x176)](_0x4de724,_0x4e62df,_0x32ca3f){const _0x2946a1=_0x2b9ff2;let {systemMessage:systemMessage='',fileInfo:_0x14e858,groupId:_0x2eb7ea,maxRounds:maxRounds=0x5,maxModelTokens:maxModelTokens=0x1f40,isFileUpload:isFileUpload=0x0,isConvertToBase64:_0x36fc25}=_0x4e62df;systemMessage[_0x2946a1(0x218)]>maxModelTokens&&(common_1[_0x2946a1(0x1df)][_0x2946a1(0x193)](_0x2946a1(0x1a1),_0x2946a1(0x17e)),systemMessage=systemMessage['slice'](0x0,maxModelTokens));let _0x3c41bf=[];systemMessage&&_0x3c41bf['push']({'role':_0x2946a1(0x1c8),'content':systemMessage});if(_0x2eb7ea){const _0x316979=await _0x32ca3f[_0x2946a1(0x1b0)](_0x2eb7ea,maxRounds);let _0x2e9cae=null;for(const _0xa83ea6 of _0x316979){try{let _0x418218;if((isFileUpload===0x2||isFileUpload===0x3)&&_0xa83ea6[_0x2946a1(0x1eb)]&&_0xa83ea6[_0x2946a1(0x21d)]==='user'){const _0x54a561=await Promise[_0x2946a1(0x1db)](_0xa83ea6[_0x2946a1(0x1eb)][_0x2946a1(0x1ab)](',')[_0x2946a1(0x174)](async _0x186feb=>({'type':_0x2946a1(0x194),'image_url':{'url':_0x36fc25==='1'?await this[_0x2946a1(0x247)](_0x186feb[_0x2946a1(0x188)]()):_0x186feb[_0x2946a1(0x188)]()}})));_0x418218=[{'type':_0x2946a1(0x1c2),'text':_0xa83ea6[_0x2946a1(0x1c2)]},..._0x54a561];}else isFileUpload===0x1&&_0xa83ea6[_0x2946a1(0x1eb)]&&_0xa83ea6[_0x2946a1(0x21d)]===_0x2946a1(0x172)?_0x418218=_0xa83ea6[_0x2946a1(0x1eb)]+'\x0a'+_0xa83ea6[_0x2946a1(0x1c2)]:_0x418218=_0xa83ea6[_0x2946a1(0x1c2)];if(_0xa83ea6[_0x2946a1(0x21d)]===_0x2946a1(0x172))_0x2e9cae={'role':_0xa83ea6[_0x2946a1(0x21d)],'content':_0x418218};else{if(_0xa83ea6[_0x2946a1(0x21d)]===_0x2946a1(0x1f3)){const _0x3aeca9=Array[_0x2946a1(0x1d1)](_0x418218)?JSON[_0x2946a1(0x1ce)](_0x418218):_0x418218;_0x2e9cae&&_0x3aeca9[_0x2946a1(0x188)]()!==''&&(_0x3c41bf[_0x2946a1(0x223)](_0x2e9cae),_0x3c41bf[_0x2946a1(0x223)]({'role':_0xa83ea6['role'],'content':_0x418218}),_0x2e9cae=null);}}}catch(_0x13a646){common_1[_0x2946a1(0x1df)][_0x2946a1(0x1da)](_0x2946a1(0x1f2),_0x13a646,'记录:',JSON[_0x2946a1(0x1ce)](_0xa83ea6,null,0x2));}}}let _0x5493f1;if((isFileUpload===0x2||isFileUpload===0x3)&&_0x14e858){const _0x5c733b=await Promise[_0x2946a1(0x1db)](_0x14e858['split'](',')['map'](async _0x161bf9=>({'type':_0x2946a1(0x194),'image_url':{'url':_0x36fc25==='1'?await this[_0x2946a1(0x247)](_0x161bf9[_0x2946a1(0x188)]()):_0x161bf9[_0x2946a1(0x188)]()}})));_0x5493f1=[{'type':_0x2946a1(0x1c2),'text':_0x4de724},..._0x5c733b];}else isFileUpload===0x1&&_0x14e858?_0x5493f1=_0x14e858+'\x0a'+_0x4de724:_0x5493f1=_0x4de724;_0x3c41bf['push']({'role':_0x2946a1(0x172),'content':_0x5493f1});let _0x4b520f=await(0x0,utils_1[_0x2946a1(0x19f)])(_0x3c41bf),_0x41a027;maxModelTokens<0x1f40?_0x41a027=0xfa0:_0x41a027=maxModelTokens-0xfa0;while(_0x4b520f>_0x41a027){if(_0x3c41bf[_0x2946a1(0x218)]===0x2&&_0x3c41bf[0x0]['role']===_0x2946a1(0x1c8)&&_0x3c41bf[0x1][_0x2946a1(0x21d)]===_0x2946a1(0x172))break;let _0x53055a=![];for(let _0x1abdd6=0x0;_0x1abdd6<_0x3c41bf[_0x2946a1(0x218)];_0x1abdd6++){if(_0x3c41bf[_0x1abdd6][_0x2946a1(0x21d)]!==_0x2946a1(0x1c8)&&_0x3c41bf[_0x1abdd6+0x1]&&_0x3c41bf[_0x1abdd6+0x1]['role']===_0x2946a1(0x1f3)){_0x3c41bf[_0x2946a1(0x1b8)](_0x1abdd6,0x2),_0x53055a=!![];break;}}if(!_0x53055a)for(let _0x444153=0x0;_0x444153<_0x3c41bf[_0x2946a1(0x218)];_0x444153++){if(_0x3c41bf[_0x444153][_0x2946a1(0x21d)]===_0x2946a1(0x172)){_0x3c41bf[_0x2946a1(0x1b8)](_0x444153,0x1);break;}}_0x4b520f=await(0x0,utils_1['getTokenCount'])(_0x3c41bf);if(_0x3c41bf[_0x2946a1(0x218)]<=0x2)break;}return{'messagesHistory':_0x3c41bf,'round':_0x3c41bf['length']};}async[_0x2b9ff2(0x247)](_0x4a835c){const _0x51fd21=_0x2b9ff2;try{console[_0x51fd21(0x193)](_0x51fd21(0x18b)+_0x4a835c);const _0x34ea3a=await axios_1[_0x51fd21(0x1d3)]['get'](_0x4a835c,{'responseType':_0x51fd21(0x198)}),_0x5aac1d=Buffer[_0x51fd21(0x259)](_0x34ea3a[_0x51fd21(0x178)],_0x51fd21(0x263));console[_0x51fd21(0x193)](_0x51fd21(0x1dc)+_0x4a835c);const _0x972862=_0x51fd21(0x1dd)+_0x34ea3a[_0x51fd21(0x206)][_0x51fd21(0x23b)]+_0x51fd21(0x165)+_0x5aac1d[_0x51fd21(0x229)](_0x51fd21(0x17f));return console['log'](_0x51fd21(0x1b7)+_0x4a835c),_0x972862;}catch(_0x580fb4){return console[_0x51fd21(0x1da)](_0x51fd21(0x1a7),_0x580fb4),console['warn'](_0x51fd21(0x230)+_0x4a835c),_0x4a835c;}}async[_0x2b9ff2(0x1f5)](_0x5671da,_0x2c2dfb,_0x2b98b4){const _0x259bc2=_0x2b9ff2,{chatId:_0x51d8c9,prompt:_0x2e1db6}=_0x5671da,_0x3f05aa=await this['modelsService'][_0x259bc2(0x1c5)](_0x259bc2(0x1d2)),{openaiTimeout:_0xafe7ac,openaiBaseUrl:_0xc73328,openaiBaseKey:_0x417321,openaiVoice:_0x5a4c20}=await this[_0x259bc2(0x243)]['getConfigs']([_0x259bc2(0x220),_0x259bc2(0x182),_0x259bc2(0x244),_0x259bc2(0x20a)]),{key:_0x53cf2e,proxyUrl:_0x5e3991,deduct:_0x24f5bc,deductType:_0x2f9671,timeout:_0x3e37ef}=_0x3f05aa,_0x18f672=_0x53cf2e||_0x417321,_0x1febe2=(0x0,utils_1[_0x259bc2(0x175)])(_0x5e3991||_0xc73328),_0xfc2169=(_0x3e37ef||_0xafe7ac)*0x3e8;await this[_0x259bc2(0x180)][_0x259bc2(0x1ef)](_0x2c2dfb,_0x2f9671,_0x24f5bc),common_1['Logger'][_0x259bc2(0x193)]('开始\x20TTS\x20请求:',_0x2e1db6,'TTSService');const _0x30e26f={'method':_0x259bc2(0x23c),'url':_0x1febe2+_0x259bc2(0x216),'headers':{'Content-Type':_0x259bc2(0x168),'Authorization':'Bearer\x20'+_0x18f672},'responseType':'arraybuffer','timeout':_0xfc2169,'data':{'model':'tts-1','input':_0x2e1db6,'voice':_0x5a4c20||_0x259bc2(0x1fe)}};try{const _0x10b059=await(0x0,axios_1[_0x259bc2(0x1d3)])(_0x30e26f);common_1[_0x259bc2(0x1df)]['log'](_0x259bc2(0x256),'TTSService');const _0x95e99a=Buffer[_0x259bc2(0x259)](_0x10b059[_0x259bc2(0x178)]),_0x1ad1e9=new Date(),_0x3bba43=_0x1ad1e9[_0x259bc2(0x18f)](),_0x4c8810=String(_0x1ad1e9[_0x259bc2(0x224)]()+0x1)[_0x259bc2(0x170)](0x2,'0'),_0x3a2351=String(_0x1ad1e9['getDate']())[_0x259bc2(0x170)](0x2,'0'),_0x5e6a57=''+_0x3bba43+_0x4c8810+'/'+_0x3a2351,_0xdaaef8=await this[_0x259bc2(0x1a9)]['uploadFile']({'buffer':_0x95e99a,'mimetype':'audio/mpeg'},'audio/openai/'+_0x5e6a57);await Promise[_0x259bc2(0x1db)]([this['chatLogService'][_0x259bc2(0x196)](_0x51d8c9,{'ttsUrl':_0xdaaef8}),this['userBalanceService']['deductFromBalance'](_0x2c2dfb[_0x259bc2(0x172)]['id'],_0x2f9671,_0x24f5bc)]),_0x2b98b4[_0x259bc2(0x1ee)](0xc8)[_0x259bc2(0x1e9)]({'ttsUrl':_0xdaaef8});}catch(_0x1a66e2){common_1[_0x259bc2(0x1df)][_0x259bc2(0x1da)](_0x259bc2(0x166),_0x1a66e2,'TTSService'),_0x2b98b4[_0x259bc2(0x1ee)](0x1f4)['send']({'error':'Failed\x20to\x20process\x20TTS\x20request'});}}};function _0x25d4(_0xcd9421,_0x273efc){const _0x4ef593=_0x4ef5();return _0x25d4=function(_0x25d4cd,_0x5eea96){_0x25d4cd=_0x25d4cd-0x161;let _0x5b409c=_0x4ef593[_0x25d4cd];return _0x5b409c;},_0x25d4(_0xcd9421,_0x273efc);}ChatService=__decorate([(0x0,common_1[_0x2b9ff2(0x215)])(),__param(0x0,(0x0,typeorm_1[_0x2b9ff2(0x255)])(config_entity_1[_0x2b9ff2(0x1ed)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(app_entity_1[_0x2b9ff2(0x1a3)])),__param(0x2,(0x0,typeorm_1[_0x2b9ff2(0x255)])(plugin_entity_1[_0x2b9ff2(0x1c0)])),__metadata('design:paramtypes',[typeorm_2[_0x2b9ff2(0x217)],typeorm_2['Repository'],typeorm_2['Repository'],suno_service_1[_0x2b9ff2(0x22c)],openaiChat_service_1[_0x2b9ff2(0x1cb)],chatLog_service_1['ChatLogService'],midjourneyDraw_service_1[_0x2b9ff2(0x202)],stableDiffusion_service_1[_0x2b9ff2(0x190)],userBalance_service_1[_0x2b9ff2(0x1d8)],user_service_1[_0x2b9ff2(0x1ff)],upload_service_1[_0x2b9ff2(0x1a8)],badWords_service_1[_0x2b9ff2(0x25c)],autoreply_service_1['AutoreplyService'],globalConfig_service_1[_0x2b9ff2(0x209)],chatGroup_service_1[_0x2b9ff2(0x231)],models_service_1[_0x2b9ff2(0x23d)],openaiDraw_service_1[_0x2b9ff2(0x210)],lumaVideo_service_1[_0x2b9ff2(0x1e2)],cogVideo_service_1['CogVideoService'],fluxDraw_service_1[_0x2b9ff2(0x1b9)],aiPPT_1[_0x2b9ff2(0x1ca)]])],ChatService),exports[_0x2b9ff2(0x17e)]=ChatService;