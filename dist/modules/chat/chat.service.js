'use strict';const _0x369b67=_0x1cee;(function(_0x2fb7bf,_0x220353){const _0x43eb04=_0x1cee,_0x55b0eb=_0x2fb7bf();while(!![]){try{const _0x2e6799=parseInt(_0x43eb04(0x1fc))/0x1*(parseInt(_0x43eb04(0x1c1))/0x2)+-parseInt(_0x43eb04(0x1f1))/0x3*(parseInt(_0x43eb04(0x237))/0x4)+parseInt(_0x43eb04(0x1c0))/0x5+parseInt(_0x43eb04(0x26a))/0x6+parseInt(_0x43eb04(0x25b))/0x7+-parseInt(_0x43eb04(0x1d9))/0x8*(-parseInt(_0x43eb04(0x1c4))/0x9)+-parseInt(_0x43eb04(0x179))/0xa;if(_0x2e6799===_0x220353)break;else _0x55b0eb['push'](_0x55b0eb['shift']());}catch(_0x565f82){_0x55b0eb['push'](_0x55b0eb['shift']());}}}(_0x3d59,0x9a40d));var __decorate=this&&this[_0x369b67(0x256)]||function(_0x243c99,_0x1e8151,_0x2d5775,_0x401920){const _0x1d499e=_0x369b67;var _0x5efc1a=arguments[_0x1d499e(0x177)],_0x1ce3b1=_0x5efc1a<0x3?_0x1e8151:_0x401920===null?_0x401920=Object['getOwnPropertyDescriptor'](_0x1e8151,_0x2d5775):_0x401920,_0x1b652d;if(typeof Reflect==='object'&&typeof Reflect['decorate']==='function')_0x1ce3b1=Reflect['decorate'](_0x243c99,_0x1e8151,_0x2d5775,_0x401920);else{for(var _0x558e65=_0x243c99[_0x1d499e(0x177)]-0x1;_0x558e65>=0x0;_0x558e65--)if(_0x1b652d=_0x243c99[_0x558e65])_0x1ce3b1=(_0x5efc1a<0x3?_0x1b652d(_0x1ce3b1):_0x5efc1a>0x3?_0x1b652d(_0x1e8151,_0x2d5775,_0x1ce3b1):_0x1b652d(_0x1e8151,_0x2d5775))||_0x1ce3b1;}return _0x5efc1a>0x3&&_0x1ce3b1&&Object['defineProperty'](_0x1e8151,_0x2d5775,_0x1ce3b1),_0x1ce3b1;},__metadata=this&&this[_0x369b67(0x1a5)]||function(_0x5e4e32,_0x258026){const _0x49ae01=_0x369b67;if(typeof Reflect==='object'&&typeof Reflect[_0x49ae01(0x1ca)]===_0x49ae01(0x267))return Reflect[_0x49ae01(0x1ca)](_0x5e4e32,_0x258026);},__param=this&&this[_0x369b67(0x1aa)]||function(_0x4ff59d,_0x500a0c){return function(_0x4549ae,_0x41f032){_0x500a0c(_0x4549ae,_0x41f032,_0x4ff59d);};};Object['defineProperty'](exports,_0x369b67(0x241),{'value':!![]}),exports[_0x369b67(0x213)]=void 0x0;const utils_1=require(_0x369b67(0x246)),common_1=require('@nestjs/common'),typeorm_1=require('@nestjs/typeorm'),axios_1=require(_0x369b67(0x199)),typeorm_2=require(_0x369b67(0x1f2)),aiPPT_1=require(_0x369b67(0x1bc)),cogVideo_service_1=require(_0x369b67(0x189)),fluxDraw_service_1=require(_0x369b67(0x249)),lumaVideo_service_1=require('../ai/lumaVideo.service'),midjourneyDraw_service_1=require('../ai/midjourneyDraw.service'),openaiChat_service_1=require('../ai/openaiChat.service'),openaiDraw_service_1=require(_0x369b67(0x222)),stableDiffusion_service_1=require(_0x369b67(0x24a)),suno_service_1=require('../ai/suno.service'),app_entity_1=require(_0x369b67(0x263)),autoreply_service_1=require(_0x369b67(0x1fd)),badWords_service_1=require(_0x369b67(0x1a4)),chatGroup_service_1=require(_0x369b67(0x25f)),chatLog_service_1=require('../chatLog/chatLog.service'),config_entity_1=require(_0x369b67(0x23e)),globalConfig_service_1=require(_0x369b67(0x18e)),models_service_1=require('../models/models.service'),plugin_entity_1=require(_0x369b67(0x21c)),upload_service_1=require(_0x369b67(0x23f)),user_service_1=require(_0x369b67(0x1a1)),userBalance_service_1=require(_0x369b67(0x209));function _0x1cee(_0x2aa5d8,_0x212715){const _0x3d59c6=_0x3d59();return _0x1cee=function(_0x1ceeec,_0x3809c2){_0x1ceeec=_0x1ceeec-0x16f;let _0x2eb5dd=_0x3d59c6[_0x1ceeec];return _0x2eb5dd;},_0x1cee(_0x2aa5d8,_0x212715);}function _0x3d59(){const _0x35b4e1=['update','axios','TTS\x20请求或上传过程失败:','CogVideoService','cogVideoService','使用应用预设:\x20','write','base64','openaiBaseUrl','../user/user.service','flux','isSensitiveWordFilter','../badWords/badWords.service','__metadata','checkBadWords','user','HttpException','发生未知错误，请稍后再试','__param','/plugins/','ai-ppt','Bearer\x20','openaiTemperature','text',',\x20消耗积分：\x20','生成中','以下是我提供给你的知识库：【','生成失败','更新对话组标题失败:\x20','push','处理请求时发生错误','deductFromBalance','log','模型切换错误，请检查全局模型配置！','queryUserBalance','任务提交失败，不执行扣费','../ai/aiPPT','modelInfo','data:','dall-e-3','1304815DibqNy','371608nBGFrC','trim','chatHistory','3987vPanlr','cogVideo','chatLogService','status','padStart','转换URL为Base64时发生错误:','metadata','OpenAIDrawService','fluxDrawService','uploadService','openAIChatService','AppEntity','发生错误:','/v1/audio/speech','AutoreplyService','根据用户提问{','midjourneyDraw','split','getConfigs','luma-video','AiPptService','7816fVOqYf','\x0a\x20Current\x20date:\x20','application/octet-stream;\x20charset=utf-8','pluginUrl','role','map','parameters','GlobalConfigService','openaiBaseKey','DrawService','assign','userBalance','chatGroupService','setHeader','catch','chatFree','getGroupInfoFromId','isSystemPlugin','audio/openai/','用户ID:\x20','stringify','get','mjTranslatePrompt','aiPptService','2641344SIPmqy','typeorm','isConvertToBase64','openaiTimeout','}，给这个对话取一个名字，不超过10个字','headers','gpts','cog-video','插件返回结果:\x20','findOne','FluxDrawService','1AbWpFD','../autoreply/autoreply.service','绘制中','isAIReplyEnabled','end','system','getTokenCount','saveChatLog','gpt-4-gizmo-','StableDiffusionService','开始\x20TTS\x20请求:','getClientIp','answer','../userBalance/userBalance.service','isGeneratePromptReference','LumaVideoService','dalleDraw','title','getCurrentModelKeyInfo','midjourneyService','ChatGroupService','onyx','ttsProcess','ChatService','TOO_MANY_REQUESTS','IMAGINE','ChatLogService','updateChatLog','}以及\x20AI\x20的回答{','arraybuffer','UploadService','pluginKey','../plugin/plugin.entity','SunoService','Repository','convertUrlToBase64','default','image_url','../ai/openaiDraw.service','design:paramtypes','data','checkUserCertification','Failed\x20to\x20process\x20TTS\x20request',';base64,','\x20回复出错，本次不扣除积分','badWordsService','}，生成三个更进入一步的提问，用{}包裹每个问题，不需要分行，不需要其他任何内容，单个提问不超过30个字','appEntity','saveUseLog','aiPPT','errMsg','all','parse','checkUserStatus','suno-music','isArray','Logger','系统消息超过最大长度，将被截断','application/json','4vgITrb','fileInfo','绘图失败','BAD_REQUEST','autoreplyService','开始生成PPT','modelName','../globalConfig/config.entity','../upload/upload.service','preset','__esModule','content','toString','】，在回答问题之前，先检索知识库内有没有相关的内容，尽量使用知识库中获取到的信息来回答我的问题，以知识库中的为准。','stable-diffusion','../../common/utils','\x20模型:\x20','validateBalance','../ai/fluxDraw.service','../ai/stableDiffusion.service','formatUrl','openAIChat','PluginService','tts-1','lumaVideoService','userService','close','POST','forEach','HttpStatus','stableDiffusionService','__decorate','UserBalanceService','userBalanceService','globalConfigService','openAIDrawService','8009351KYdKgG','toISOString','from','slice','../chatGroup/chatGroup.service','replace','UPSCALE','match','../app/app.entity','OpenAIChatService','error:\x20','使用插件预设:\x20','function','openaiVoice','1\x20小时内对话次数过多，请切换模型或稍后再试！','4222512XQtPeW','debug','includes','pluginEntity','midjourney','getFullYear','content-type','modelsService','getMonth','length','buildMessageFromParentMessageId','12152540jPzBBk','返回原始链接:\x20','splice','使用文件解析:\x20','getDate','abort','成功获取图片，正在转换为Base64:\x20','assistant','model','config','updateChatTitle','binary','你当前使用的应用已被下架、请删除当前对话开启新的对话吧！','提交成功，视频生成中','正在尝试转换URL为Base64:\x20','配置解析错误！','../ai/cogVideo.service','InjectRepository','提交成功，歌曲生成中','调用\x20chatFree\x20出错:\x20','send','../globalConfig/globalConfig.service','100%','error','chatProcess','记录:','checkModelLimits','usePlugin','checkAutoReply','TTS\x20请求获取成功','sunoService'];_0x3d59=function(){return _0x35b4e1;};return _0x3d59();}let ChatService=class ChatService{constructor(_0x12f76a,_0x1db456,_0x3cf2bf,_0x5bd853,_0x245234,_0x1b8634,_0x1f11a3,_0x257241,_0x98704a,_0x30ecb1,_0xc91774,_0xcbd044,_0x37a7dc,_0x53ecb7,_0x28d448,_0x23476e,_0x544cea,_0x5ead4e,_0x3bc48a,_0x4f493f,_0x497365){const _0x3df062=_0x369b67;this['configEntity']=_0x12f76a,this[_0x3df062(0x22b)]=_0x1db456,this['pluginEntity']=_0x3cf2bf,this[_0x3df062(0x197)]=_0x5bd853,this[_0x3df062(0x1ce)]=_0x245234,this[_0x3df062(0x1c6)]=_0x1b8634,this['midjourneyService']=_0x1f11a3,this['stableDiffusionService']=_0x257241,this[_0x3df062(0x258)]=_0x98704a,this[_0x3df062(0x250)]=_0x30ecb1,this[_0x3df062(0x1cd)]=_0xc91774,this[_0x3df062(0x229)]=_0xcbd044,this[_0x3df062(0x23b)]=_0x37a7dc,this[_0x3df062(0x259)]=_0x53ecb7,this[_0x3df062(0x1e5)]=_0x28d448,this[_0x3df062(0x175)]=_0x23476e,this[_0x3df062(0x25a)]=_0x544cea,this[_0x3df062(0x24f)]=_0x5ead4e,this[_0x3df062(0x19c)]=_0x3bc48a,this[_0x3df062(0x1cc)]=_0x4f493f,this['aiPptService']=_0x497365;}async[_0x369b67(0x191)](_0x47eaff,_0x157c15,_0x384bf1){const _0x5ed033=_0x369b67;await this[_0x5ed033(0x258)][_0x5ed033(0x225)](_0x157c15['user']['id']);const {options:options={},usingPluginId:_0x5bbc0d,appId:appId=null,specialModel:_0x1049c8,prompt:_0x1aab0d,fileInfo:_0x249772,extraParam:_0x13d82b,model:_0xae784a,drawId:_0x160a61,customId:_0x1560cc,action:_0x448fc4,modelName:_0x30fc34,modelAvatar:_0x4302da}=_0x47eaff;let _0x4441df;if(_0x1049c8)_0x4441df=await this[_0x5ed033(0x22b)][_0x5ed033(0x1fa)]({'where':{'des':_0x1049c8,'isSystemReserved':!![]}});else{if(appId){_0x4441df=await this[_0x5ed033(0x22b)][_0x5ed033(0x1fa)]({'where':{'id':appId,'status':(0x0,typeorm_2['In'])([0x1,0x3,0x4,0x5])}});if(!_0x4441df)throw new common_1[(_0x5ed033(0x1a8))](_0x5ed033(0x185),common_1[_0x5ed033(0x254)][_0x5ed033(0x23a)]);}}const {groupId:_0x290651,fileParsing:_0x50f060}=options,{openaiTimeout:_0x318eda,openaiBaseUrl:_0x27fe95,openaiBaseKey:_0x599c66,systemPreMessage:_0x1d8d04,isMjTranslate:_0x1e68fc,mjTranslatePrompt:_0x39096d,openaiTemperature:_0x1c3bb3,openaiBaseModel:_0x6e9f5b,isGeneratePromptReference:_0x4c56b4,isConvertToBase64:_0x166e20,isSensitiveWordFilter:_0x23ce42}=await this[_0x5ed033(0x259)][_0x5ed033(0x1d6)]([_0x5ed033(0x1f4),_0x5ed033(0x1a0),'openaiBaseKey','systemPreMessage','isMjTranslate',_0x5ed033(0x1ef),_0x5ed033(0x1ae),'openaiBaseModel',_0x5ed033(0x20a),_0x5ed033(0x1f3),_0x5ed033(0x1a3)]);await this['userService'][_0x5ed033(0x231)](_0x157c15[_0x5ed033(0x1a7)]),_0x384bf1&&_0x384bf1[_0x5ed033(0x1e6)]('Content-type',_0x5ed033(0x1db));if(_0x23ce42==='1'){const _0x33bba0=await this[_0x5ed033(0x229)][_0x5ed033(0x1a6)](_0x1aab0d,_0x157c15[_0x5ed033(0x1a7)]['id']);if(_0x33bba0['length']>0x0){const _0x25a568='您提交的信息中包含违规的内容，我们已对您的账户进行标记，请合规使用！';throw new common_1['HttpException'](_0x25a568,common_1[_0x5ed033(0x254)][_0x5ed033(0x23a)]);}}const _0x16fdae=await this[_0x5ed033(0x23b)][_0x5ed033(0x195)](_0x1aab0d);let _0x2e0bd9=null,_0x35e4d5='',_0x2b6d95='';_0x384bf1&&_0x384bf1[_0x5ed033(0x1c7)](0xc8);let _0x3b5e25=null;const _0x73ca49=(0x0,utils_1[_0x5ed033(0x207)])(_0x157c15);let _0x19d4aa,_0x3fc15b='',_0x15374c;_0x5bbc0d&&(_0x15374c=await this[_0x5ed033(0x171)]['findOne']({'where':{'id':_0x5bbc0d}}));if(_0x4441df){const {isGPTs:_0x5b187d,gizmoID:_0x4f8e96,name:_0x101938,isFixedModel:_0x580303,appModel:_0x225826,coverImg:_0x49783c}=_0x4441df;_0x3fc15b=_0x49783c,_0x35e4d5=_0x101938;if(_0x5b187d)_0x2e0bd9=await this[_0x5ed033(0x175)][_0x5ed033(0x20e)](_0x5ed033(0x1f7)),_0x2e0bd9[_0x5ed033(0x181)]=_0x5ed033(0x204)+_0x4f8e96;else!_0x5b187d&&_0x580303&&_0x225826?(_0x4441df[_0x5ed033(0x240)]&&(_0x2b6d95=_0x4441df[_0x5ed033(0x240)]),_0x2e0bd9=await this[_0x5ed033(0x175)][_0x5ed033(0x20e)](_0x225826),_0x2e0bd9['model']=_0x225826,_0x50f060&&(_0x2b6d95=_0x2b6d95+'以下是我提供给你的知识库：【'+_0x50f060+_0x5ed033(0x244)),common_1['Logger'][_0x5ed033(0x1b8)]('固定模型、使用应用预设:\x20'+_0x2b6d95,_0x5ed033(0x213))):(_0x4441df[_0x5ed033(0x240)]&&(_0x2b6d95=_0x4441df[_0x5ed033(0x240)]),_0x2e0bd9=await this['modelsService'][_0x5ed033(0x20e)](_0xae784a),_0x50f060&&(_0x2b6d95=_0x2b6d95+'以下是我提供给你的知识库：【'+_0x50f060+_0x5ed033(0x244)),common_1[_0x5ed033(0x234)][_0x5ed033(0x1b8)](_0x5ed033(0x19d)+_0x2b6d95,_0x5ed033(0x213)));}else{const _0x955939=await this[_0x5ed033(0x1e5)][_0x5ed033(0x1e9)](_0x290651);if(_0x15374c&&_0x15374c[_0x5ed033(0x1ea)]===0x0){let _0x3b5458='';try{_0x3b5458=await this[_0x5ed033(0x194)](_0x1aab0d,_0x15374c[_0x5ed033(0x1df)]),common_1[_0x5ed033(0x234)][_0x5ed033(0x1b8)](_0x5ed033(0x1f9)+_0x3b5458,_0x5ed033(0x213));}catch(_0x1b4edf){_0x3b5458=_0x1aab0d,common_1[_0x5ed033(0x234)]['error']('插件调用错误:\x20'+_0x1b4edf);}_0x2b6d95=_0x3b5458,_0x2e0bd9=await this[_0x5ed033(0x175)][_0x5ed033(0x20e)](_0xae784a),common_1['Logger']['log'](_0x5ed033(0x266)+_0x2b6d95,_0x5ed033(0x213));}else{if(_0x50f060)_0x2b6d95=_0x5ed033(0x1b2)+_0x50f060+_0x5ed033(0x244),_0x2e0bd9=await this[_0x5ed033(0x175)][_0x5ed033(0x20e)](_0xae784a),common_1[_0x5ed033(0x234)][_0x5ed033(0x1b8)](_0x5ed033(0x17c)+_0x2b6d95,_0x5ed033(0x213));else{const _0x1333f7=new Date()[_0x5ed033(0x25c)]()[_0x5ed033(0x1d5)]('T')[0x0];_0x2b6d95=_0x1d8d04+(_0x5ed033(0x1da)+_0x1333f7),_0x2e0bd9=await this['modelsService'][_0x5ed033(0x20e)](_0xae784a),common_1['Logger']['log']('使用全局预设:\x20'+_0x2b6d95,_0x5ed033(0x213));}}}if(!_0x2e0bd9){common_1[_0x5ed033(0x234)]['debug']('未找到当前模型key，切换至全局模型',_0x5ed033(0x213)),_0x2e0bd9=await this[_0x5ed033(0x175)][_0x5ed033(0x20e)](_0x6e9f5b);const _0x4af47b=await this[_0x5ed033(0x1e5)][_0x5ed033(0x1e9)](_0x290651);let _0x2e6881=_0x4af47b['config'];try{const _0x1f95d1=JSON[_0x5ed033(0x230)](_0x4af47b[_0x5ed033(0x182)]);_0x1f95d1[_0x5ed033(0x1bd)]&&(_0x1f95d1[_0x5ed033(0x1bd)][_0x5ed033(0x23d)]=_0x2e0bd9[_0x5ed033(0x23d)],_0x1f95d1[_0x5ed033(0x1bd)][_0x5ed033(0x181)]=_0x2e0bd9['model'],_0x2e6881=JSON[_0x5ed033(0x1ed)](_0x1f95d1));}catch(_0xd53445){common_1[_0x5ed033(0x234)][_0x5ed033(0x16f)](_0x5ed033(0x1b9),_0x5ed033(0x213));throw new common_1[(_0x5ed033(0x1a8))](_0x5ed033(0x188),common_1[_0x5ed033(0x254)][_0x5ed033(0x23a)]);}await this['chatGroupService'][_0x5ed033(0x198)]({'groupId':_0x290651,'title':_0x4af47b[_0x5ed033(0x20d)],'isSticky':![],'config':_0x2e6881,'fileUrl':''},_0x157c15);}const {deduct:_0x4ddfe0,isTokenBased:_0x273382,tokenFeeRatio:_0x3e1373,deductType:_0x6d5591,key:_0xaee3d5,id:_0x344b3e,maxRounds:_0x19dc19,proxyUrl:_0x44aca7,maxModelTokens:_0x234578,timeout:_0x1c9ed8,model:_0x294a81,isFileUpload:_0x1e2952,keyType:_0x53954e}=_0x2e0bd9;if(await this[_0x5ed033(0x1c6)][_0x5ed033(0x193)](_0x157c15['user'],_0x294a81))throw new common_1[(_0x5ed033(0x1a8))](_0x5ed033(0x269),common_1[_0x5ed033(0x254)][_0x5ed033(0x214)]);if(_0x1e68fc==='1'&&_0x448fc4===_0x5ed033(0x215)&&_0xae784a==='midjourney'){const [_0x2c095a,_0x50eaad]=_0x1aab0d[_0x5ed033(0x1d5)](/(?= --)/),_0x5c6a56=/(https?:\/\/[^\s]+)/g,_0x4e0c9a=_0x2c095a[_0x5ed033(0x262)](_0x5c6a56)||[];let _0x4830d3=_0x2c095a[_0x5ed033(0x260)](_0x5c6a56,'')[_0x5ed033(0x1c2)]();const _0x2961ba=await this['openAIChatService'][_0x5ed033(0x1e8)](_0x4830d3,_0x39096d||'Translate\x20any\x20given\x20phrase\x20from\x20any\x20language\x20into\x20English.\x20For\x20instance,\x20when\x20I\x20input\x20\x27{可爱的熊猫}\x27,\x20you\x20should\x20output\x20\x27{cute\x20panda}\x27,\x20with\x20no\x20period\x20at\x20the\x20end.'),_0x42e9c3=[..._0x4e0c9a,_0x2961ba]['join']('\x20')[_0x5ed033(0x1c2)]();_0x19d4aa=_0x50eaad?''+_0x42e9c3+_0x50eaad:_0x42e9c3,_0x1e2952==='1'&&_0x249772&&(_0x19d4aa=_0x249772+'\x20'+_0x19d4aa);}else _0x19d4aa=_0x1e2952==='1'&&_0x249772?_0x249772+'\x20'+_0x1aab0d:_0x1aab0d;await this['userBalanceService'][_0x5ed033(0x248)](_0x157c15,_0x6d5591,_0x4ddfe0);const _0x1dcc2b=_0x30fc34,_0x3849c7=(0x0,utils_1[_0x5ed033(0x24b)])(_0x44aca7||_0x27fe95||'https://api.openai.com'),_0x8c2796=_0xaee3d5||_0x599c66,_0x1afc54=(_0x1c9ed8||_0x318eda||0x12c)*0x3e8,_0x425980=Number(_0x1c3bb3)||0x1;if(_0x290651){const _0x4d928f=await this['chatGroupService'][_0x5ed033(0x1e9)](_0x290651);this['updateChatTitle'](_0x290651,_0x4d928f,_0x53954e,_0x1aab0d,_0x157c15),await this[_0x5ed033(0x1e5)]['updateTime'](_0x290651);}const _0xb2fbaa=await this[_0x5ed033(0x1c6)][_0x5ed033(0x203)]({'appId':appId,'curIp':_0x73ca49,'userId':_0x157c15[_0x5ed033(0x1a7)]['id'],'type':_0x53954e?_0x53954e:0x1,'prompt':_0x1aab0d,'fileInfo':_0x249772?_0x249772:null,'answer':'','promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x294a81,'modelName':'我','role':_0x5ed033(0x1a7),'groupId':_0x290651?_0x290651:null}),_0x27c069=await this[_0x5ed033(0x1c6)][_0x5ed033(0x203)]({'appId':appId?appId:null,'action':_0x448fc4?_0x448fc4:null,'curIp':_0x73ca49,'userId':_0x157c15[_0x5ed033(0x1a7)]['id'],'type':_0x53954e?_0x53954e:0x1,'prompt':_0x1aab0d,'fileInfo':null,'answer':'','progress':'0%','promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x294a81,'modelName':_0x1dcc2b,'role':_0x5ed033(0x180),'groupId':_0x290651?_0x290651:null,'status':0x2,'modelAvatar':(_0x15374c===null||_0x15374c===void 0x0?void 0x0:_0x15374c['pluginImg'])||_0x3fc15b||_0x4302da||'','pluginParam':(_0x15374c===null||_0x15374c===void 0x0?void 0x0:_0x15374c[_0x5ed033(0x1df)])?_0x15374c[_0x5ed033(0x1df)]:_0x53954e===0x2?_0x294a81:null}),_0x50f9af=_0xb2fbaa['id'],_0x1bb514=_0x27c069['id'];if(_0x16fdae[_0x5ed033(0x208)]&&_0x384bf1){if(_0x16fdae[_0x5ed033(0x1ff)]===0x0){const _0x4f2e5f=_0x16fdae[_0x5ed033(0x208)][_0x5ed033(0x1d5)](''),_0x32ec03=_0x4ff428=>{const _0x3a6185=_0x5ed033;if(_0x4ff428<_0x4f2e5f[_0x3a6185(0x177)]){const _0x4465d5={'text':_0x4f2e5f[_0x4ff428]};_0x384bf1['write'](JSON[_0x3a6185(0x1ed)](_0x4465d5)+'\x0a'),setTimeout(()=>_0x32ec03(_0x4ff428+0x1),0xa);}else _0x384bf1[_0x3a6185(0x200)]();};_0x32ec03(0x0),await this['chatLogService'][_0x5ed033(0x217)](_0x1bb514,{'answer':_0x16fdae[_0x5ed033(0x208)]});return;}else _0x2b6d95=_0x2b6d95+_0x16fdae['answer'];}const {messagesHistory:_0x354016}=await this[_0x5ed033(0x178)](_0x1aab0d,{'groupId':_0x290651,'systemMessage':_0x2b6d95,'maxModelTokens':_0x234578,'maxRounds':_0x19dc19,'isConvertToBase64':_0x166e20,'fileInfo':_0x249772,'model':_0x294a81,'isFileUpload':_0x1e2952},this[_0x5ed033(0x1c6)]);let _0xc97456=_0x448fc4!==_0x5ed033(0x261)&&_0x294a81===_0x5ed033(0x172)?_0x4ddfe0*0x4:_0x4ddfe0;const _0x3a9841=new AbortController();try{if(_0x384bf1){_0x384bf1['on'](_0x5ed033(0x251),()=>{const _0x1c8fce=_0x5ed033;_0x3a9841[_0x1c8fce(0x17e)]();});let _0x5e8fe3,_0x58bae9=!![];try{if((_0x294a81===_0x5ed033(0x1bf)||_0x294a81===_0x5ed033(0x172)||_0x294a81==='ai-ppt'||_0x294a81===_0x5ed033(0x232)||_0x294a81===_0x5ed033(0x1d7)||_0x294a81['includes'](_0x5ed033(0x245))||_0x294a81[_0x5ed033(0x170)](_0x5ed033(0x1f8))||_0x294a81['includes'](_0x5ed033(0x1a2)))&&_0x53954e===0x2){if(_0x294a81===_0x5ed033(0x1bf))_0x5e8fe3=this[_0x5ed033(0x25a)][_0x5ed033(0x20c)]({'prompt':_0x1aab0d,'extraParam':_0x13d82b,'apiKey':_0x8c2796,'proxyUrl':_0x3849c7,'model':_0x294a81,'timeout':_0x1afc54,'modelName':_0x1dcc2b,'groupId':_0x290651,'onSuccess':async _0x13cceb=>{const _0x3e7527=_0x5ed033;await this[_0x3e7527(0x1c6)][_0x3e7527(0x217)](_0x1bb514,{'fileInfo':_0x13cceb===null||_0x13cceb===void 0x0?void 0x0:_0x13cceb[_0x3e7527(0x238)],'answer':(_0x13cceb===null||_0x13cceb===void 0x0?void 0x0:_0x13cceb['answer'])||_0x1aab0d,'progress':_0x3e7527(0x18f),'status':_0x13cceb[_0x3e7527(0x1c7)]});},'onFailure':async _0x12601e=>{const _0x4a02dd=_0x5ed033;await this['chatLogService'][_0x4a02dd(0x217)](_0x1bb514,{'answer':_0x4a02dd(0x239),'status':_0x12601e[_0x4a02dd(0x1c7)]});}},this[_0x5ed033(0x178)]),await this[_0x5ed033(0x1c6)][_0x5ed033(0x217)](_0x1bb514,{'answer':_0x5ed033(0x1fe)});else{if(_0x294a81===_0x5ed033(0x1ac))common_1[_0x5ed033(0x234)][_0x5ed033(0x1b8)](_0x5ed033(0x23c),_0x5ed033(0x1e2)),_0x5e8fe3=this[_0x5ed033(0x1f0)][_0x5ed033(0x22d)]({'usePrompt':_0x19d4aa,'prompt':_0x1aab0d,'apiKey':_0x8c2796,'proxyUrl':_0x3849c7,'model':_0x294a81,'modelName':_0x1dcc2b,'drawId':_0x160a61,'customId':_0x1560cc,'action':_0x448fc4,'timeout':_0x1afc54,'assistantLogId':_0x1bb514,'extraParam':_0x13d82b,'fileInfo':_0x249772}),await this[_0x5ed033(0x1c6)][_0x5ed033(0x217)](_0x1bb514,{'answer':_0x5ed033(0x1b1)});else{if(_0x294a81['includes'](_0x5ed033(0x1a2)))_0x5e8fe3=this[_0x5ed033(0x1cc)]['fluxDraw']({'prompt':_0x1aab0d,'extraParam':_0x13d82b,'apiKey':_0x8c2796,'proxyUrl':_0x3849c7,'model':_0x294a81,'timeout':_0x1afc54,'modelName':_0x1dcc2b,'groupId':_0x290651,'onSuccess':async _0x150864=>{const _0x444179=_0x5ed033;await this[_0x444179(0x1c6)][_0x444179(0x217)](_0x1bb514,{'fileInfo':_0x150864===null||_0x150864===void 0x0?void 0x0:_0x150864[_0x444179(0x238)],'answer':(_0x150864===null||_0x150864===void 0x0?void 0x0:_0x150864[_0x444179(0x208)])||_0x1aab0d,'progress':_0x444179(0x18f),'status':_0x150864[_0x444179(0x1c7)]});},'onFailure':async _0xfa3c93=>{const _0x45fe86=_0x5ed033;await this[_0x45fe86(0x1c6)][_0x45fe86(0x217)](_0x1bb514,{'answer':_0x45fe86(0x239),'status':_0xfa3c93[_0x45fe86(0x1c7)]});}},this[_0x5ed033(0x178)]),await this[_0x5ed033(0x1c6)][_0x5ed033(0x217)](_0x1bb514,{'answer':_0x5ed033(0x1fe)});else{if(_0x294a81['includes']('suno-music'))_0x5e8fe3=this[_0x5ed033(0x197)]['suno']({'assistantLogId':_0x1bb514,'apiKey':_0x8c2796,'action':_0x448fc4,'prompt':_0x1aab0d,'timeout':_0x1afc54,'proxyUrl':_0x3849c7,'taskData':_0x1560cc}),await this[_0x5ed033(0x1c6)]['updateChatLog'](_0x1bb514,{'answer':_0x5ed033(0x18b)});else{if(_0x294a81['includes'](_0x5ed033(0x1d7)))_0x5e8fe3=this[_0x5ed033(0x24f)]['lumaVideo']({'fileInfo':_0x249772,'extraParam':_0x13d82b,'assistantLogId':_0x1bb514,'apiKey':_0x8c2796,'action':_0x448fc4,'prompt':_0x1aab0d,'model':_0x294a81,'timeout':_0x1afc54,'proxyUrl':_0x3849c7,'taskData':_0x1560cc,'onGenerate':async _0x37c393=>{const _0x59b096=_0x5ed033;await this[_0x59b096(0x1c6)][_0x59b096(0x217)](_0x1bb514,{'fileInfo':_0x37c393===null||_0x37c393===void 0x0?void 0x0:_0x37c393['fileInfo'],'answer':(_0x37c393===null||_0x37c393===void 0x0?void 0x0:_0x37c393['answer'])||_0x1aab0d,'status':0x2});},'onSuccess':async _0x216856=>{const _0x4421f6=_0x5ed033;await this[_0x4421f6(0x1c6)][_0x4421f6(0x217)](_0x1bb514,{'fileInfo':_0x216856===null||_0x216856===void 0x0?void 0x0:_0x216856[_0x4421f6(0x238)],'answer':(_0x216856===null||_0x216856===void 0x0?void 0x0:_0x216856[_0x4421f6(0x208)])||_0x1aab0d,'progress':'100%','status':0x3});},'onFailure':async _0x541838=>{const _0xefeb1d=_0x5ed033;await this[_0xefeb1d(0x1c6)][_0xefeb1d(0x217)](_0x1bb514,{'answer':_0x541838[_0xefeb1d(0x22e)],'status':0x4});}}),await this['chatLogService']['updateChatLog'](_0x1bb514,{'answer':_0x5ed033(0x186)});else{if(_0x294a81[_0x5ed033(0x170)](_0x5ed033(0x1f8)))_0x5e8fe3=this[_0x5ed033(0x19c)][_0x5ed033(0x1c5)]({'fileInfo':_0x249772,'extraParam':_0x13d82b,'assistantLogId':_0x1bb514,'apiKey':_0x8c2796,'action':_0x448fc4,'prompt':_0x1aab0d,'model':_0x294a81,'timeout':_0x1afc54,'proxyUrl':_0x3849c7,'taskData':_0x1560cc,'onGenerate':async _0x4eff8e=>{const _0x4ad2e1=_0x5ed033;await this[_0x4ad2e1(0x1c6)][_0x4ad2e1(0x217)](_0x1bb514,{'fileInfo':_0x4eff8e===null||_0x4eff8e===void 0x0?void 0x0:_0x4eff8e[_0x4ad2e1(0x238)],'answer':(_0x4eff8e===null||_0x4eff8e===void 0x0?void 0x0:_0x4eff8e[_0x4ad2e1(0x208)])||_0x1aab0d,'status':0x2});},'onSuccess':async _0x51a6d7=>{const _0x35d518=_0x5ed033;await this[_0x35d518(0x1c6)][_0x35d518(0x217)](_0x1bb514,{'fileInfo':_0x51a6d7===null||_0x51a6d7===void 0x0?void 0x0:_0x51a6d7['fileInfo'],'answer':(_0x51a6d7===null||_0x51a6d7===void 0x0?void 0x0:_0x51a6d7[_0x35d518(0x208)])||_0x1aab0d,'progress':'100%','status':0x3});},'onFailure':async _0x1e8ff4=>{const _0x14b5ea=_0x5ed033;await this[_0x14b5ea(0x1c6)]['updateChatLog'](_0x1bb514,{'answer':_0x1e8ff4['errMsg'],'status':0x4});}}),await this['chatLogService']['updateChatLog'](_0x1bb514,{'answer':_0x5ed033(0x186)});else _0x294a81[_0x5ed033(0x170)](_0x5ed033(0x245))?(_0x5e8fe3=this[_0x5ed033(0x255)]['sdxl']({'chatId':_0x1bb514,'maxModelTokens':_0x234578,'apiKey':_0x8c2796,'model':_0x294a81,'modelName':_0x1dcc2b,'modelType':_0x53954e,'prompt':_0x1aab0d,'fileInfo':_0x249772,'isFileUpload':_0x1e2952,'timeout':_0x1afc54,'proxyUrl':_0x3849c7,'onSuccess':async _0x4a037a=>{const _0x2b6d06=_0x5ed033;await this[_0x2b6d06(0x1c6)]['updateChatLog'](_0x1bb514,{'fileInfo':_0x4a037a===null||_0x4a037a===void 0x0?void 0x0:_0x4a037a[_0x2b6d06(0x238)],'answer':(_0x4a037a===null||_0x4a037a===void 0x0?void 0x0:_0x4a037a[_0x2b6d06(0x208)])||_0x1aab0d,'progress':_0x2b6d06(0x18f),'status':0x3});},'onFailure':async _0x27357c=>{const _0x4357a0=_0x5ed033;await this[_0x4357a0(0x1c6)][_0x4357a0(0x217)](_0x1bb514,{'answer':_0x4357a0(0x1b3),'status':0x4});}}),await this['chatLogService'][_0x5ed033(0x217)](_0x1bb514,{'answer':_0x5ed033(0x1fe)})):(_0x5e8fe3=await this[_0x5ed033(0x20f)][_0x5ed033(0x1d4)]({'usePrompt':_0x19d4aa,'prompt':_0x1aab0d,'apiKey':_0x8c2796,'proxyUrl':_0x3849c7,'model':_0x294a81,'modelName':_0x1dcc2b,'drawId':_0x160a61,'customId':_0x1560cc,'action':_0x448fc4,'fileInfo':_0x249772,'timeout':_0x1afc54,'assistantLogId':_0x1bb514,'pluginName':_0x15374c}),await this[_0x5ed033(0x1c6)][_0x5ed033(0x217)](_0x1bb514,{'answer':_0x5e8fe3[_0x5ed033(0x208)],'status':_0x5e8fe3[_0x5ed033(0x1c7)]}));}}}}}_0x5e8fe3[_0x5ed033(0x1c7)]!==0x5?(await this[_0x5ed033(0x175)][_0x5ed033(0x22c)](_0x344b3e,0x1),await this[_0x5ed033(0x258)]['deductFromBalance'](_0x157c15[_0x5ed033(0x1a7)]['id'],_0x6d5591,_0xc97456)):common_1[_0x5ed033(0x234)][_0x5ed033(0x1b8)](_0x5ed033(0x1bb),_0x5ed033(0x213));const _0x4a758a=await this[_0x5ed033(0x258)]['queryUserBalance'](_0x157c15['user']['id']);return _0x5e8fe3['userBalance']=Object[_0x5ed033(0x1e3)]({},_0x4a758a),_0x5e8fe3[_0x5ed033(0x1af)]=_0x5e8fe3[_0x5ed033(0x208)],_0x5e8fe3[_0x5ed033(0x1c7)]=_0x5e8fe3[_0x5ed033(0x1c7)]||0x2,_0x5e8fe3[_0x5ed033(0x181)]=_0xae784a,_0x5e8fe3[_0x5ed033(0x23d)]=_0x30fc34,_0x384bf1[_0x5ed033(0x19e)]('\x0a'+JSON[_0x5ed033(0x1ed)](_0x5e8fe3));}else{_0x5e8fe3=await this['openAIChatService'][_0x5ed033(0x24c)](_0x354016,{'chatId':_0x1bb514,'maxModelTokens':_0x234578,'apiKey':_0x8c2796,'model':_0x294a81,'modelName':_0x1dcc2b,'temperature':_0x425980,'modelType':_0x53954e,'prompt':_0x1aab0d,'fileInfo':_0x249772,'isFileUpload':_0x1e2952,'timeout':_0x1afc54,'proxyUrl':_0x3849c7,'modelAvatar':_0x4302da,'onProgress':_0x3af781=>{const _0x2fc955=_0x5ed033;_0x384bf1[_0x2fc955(0x19e)](_0x58bae9?JSON[_0x2fc955(0x1ed)](_0x3af781):'\x0a'+JSON[_0x2fc955(0x1ed)](_0x3af781)),_0x58bae9=![];},'onFailure':async _0x53277f=>{const _0x3cfd80=_0x5ed033;await this[_0x3cfd80(0x1c6)]['updateChatLog'](_0x1bb514,{'answer':_0x53277f['errMsg'],'status':0x4});},'abortController':_0x3a9841});if(_0x5e8fe3['errMsg'])return common_1[_0x5ed033(0x234)]['error'](_0x5ed033(0x1ec)+_0x157c15[_0x5ed033(0x1a7)]['id']+'\x20模型名称:\x20'+_0x1dcc2b+_0x5ed033(0x247)+_0xae784a+_0x5ed033(0x228),_0x5ed033(0x213)),_0x384bf1[_0x5ed033(0x19e)]('\x0a'+JSON[_0x5ed033(0x1ed)](_0x5e8fe3));let _0x5ac709='';_0x354016[_0x5ed033(0x253)](_0x31904a=>{const _0x99654f=_0x5ed033;_0x5ac709+=_0x31904a[_0x99654f(0x242)]+'\x20';});const _0x294641=await(0x0,utils_1[_0x5ed033(0x202)])(_0x5ac709),_0xba283=await(0x0,utils_1['getTokenCount'])(_0x5e8fe3[_0x5ed033(0x208)]);await this[_0x5ed033(0x1c6)][_0x5ed033(0x217)](_0x50f9af,{'promptTokens':_0x294641,'completionTokens':_0xba283,'totalTokens':_0x294641+_0xba283});let _0x358ef1=_0x5e8fe3[_0x5ed033(0x208)];if(_0x23ce42==='1'){const _0xd1122=await this[_0x5ed033(0x229)][_0x5ed033(0x1a6)](_0x5e8fe3[_0x5ed033(0x208)],_0x157c15[_0x5ed033(0x1a7)]['id']);if(_0xd1122['length']>0x0){const _0x5a99cf=new RegExp(_0xd1122['join']('|'),'gi');_0x358ef1=_0x358ef1[_0x5ed033(0x260)](_0x5a99cf,_0x406138=>'*'['repeat'](_0x406138[_0x5ed033(0x177)]));}}await this[_0x5ed033(0x1c6)][_0x5ed033(0x217)](_0x1bb514,{'fileInfo':_0x5e8fe3===null||_0x5e8fe3===void 0x0?void 0x0:_0x5e8fe3[_0x5ed033(0x238)],'answer':_0x358ef1,'promptTokens':_0x294641,'completionTokens':_0xba283,'totalTokens':_0x294641+_0xba283,'status':0x3});try{if(_0x4c56b4==='1'){const _0x2d435e=await this['openAIChatService'][_0x5ed033(0x1e8)](_0x5ed033(0x1d3)+_0x1aab0d+_0x5ed033(0x218)+_0x5e8fe3[_0x5ed033(0x208)]+_0x5ed033(0x22a));await this[_0x5ed033(0x1c6)]['updateChatLog'](_0x1bb514,{'promptReference':_0x2d435e});}}catch(_0x4d38a3){common_1[_0x5ed033(0x234)][_0x5ed033(0x190)]('调用\x20chatFree\x20出错:\x20'+_0x4d38a3);}_0x273382===!![]&&(_0xc97456=_0x4ddfe0*Math['ceil']((_0x294641+_0xba283)/_0x3e1373));await this['userBalanceService']['deductFromBalance'](_0x157c15[_0x5ed033(0x1a7)]['id'],_0x6d5591,_0xc97456,_0x294641+_0xba283),await this[_0x5ed033(0x175)]['saveUseLog'](_0x344b3e,_0x294641+_0xba283),common_1['Logger'][_0x5ed033(0x1b8)](_0x5ed033(0x1ec)+_0x157c15[_0x5ed033(0x1a7)]['id']+'\x20模型名称:\x20'+_0x1dcc2b+_0x5ed033(0x247)+_0xae784a+'\x20消耗token:\x20'+(_0x294641+_0xba283)+_0x5ed033(0x1b0)+_0xc97456,_0x5ed033(0x213));const _0x9ff484=await this[_0x5ed033(0x258)][_0x5ed033(0x1ba)](_0x157c15['user']['id']);return _0x5e8fe3[_0x5ed033(0x1e4)]=Object[_0x5ed033(0x1e3)]({},_0x9ff484),_0x384bf1['write']('\x0a'+JSON[_0x5ed033(0x1ed)](_0x5e8fe3));}}catch(_0x43ccef){common_1[_0x5ed033(0x234)][_0x5ed033(0x190)](_0x5ed033(0x1d0),_0x43ccef),await this[_0x5ed033(0x1c6)][_0x5ed033(0x217)](_0x1bb514,{'status':0x5}),_0x5e8fe3={'error':_0x5ed033(0x1b6)};}}else return _0x3b5e25=await this[_0x5ed033(0x1ce)][_0x5ed033(0x24c)](_0x354016,{'chatId':_0x1bb514,'maxModelTokens':_0x234578,'apiKey':_0x8c2796,'model':_0x294a81,'modelName':_0x1dcc2b,'modelType':_0x53954e,'temperature':_0x425980,'prompt':_0x1aab0d,'fileInfo':_0x249772,'isFileUpload':_0x1e2952,'timeout':_0x1afc54,'proxyUrl':_0x3849c7,'abortController':_0x3a9841}),await this[_0x5ed033(0x258)][_0x5ed033(0x1b7)](_0x157c15[_0x5ed033(0x1a7)]['id'],_0x6d5591,_0xc97456),_0x3b5e25[_0x5ed033(0x208)];}catch(_0xab5e25){common_1[_0x5ed033(0x234)][_0x5ed033(0x190)]('chat-error\x20<----------------------------------------->',_0x8c2796,_0xab5e25);if(_0x384bf1)return _0x384bf1[_0x5ed033(0x19e)]('发生未知错误，请稍后再试');else throw new common_1[(_0x5ed033(0x1a8))](_0x5ed033(0x1a9),common_1[_0x5ed033(0x254)]['BAD_REQUEST']);}finally{_0x384bf1&&_0x384bf1['end']();}}async[_0x369b67(0x194)](_0x282f3f,_0x68bacb){const _0x30ab0e=_0x369b67,{pluginUrl:_0x4abb29,pluginKey:_0x1ffc3e}=await this['globalConfigService'][_0x30ab0e(0x1d6)]([_0x30ab0e(0x1dc),_0x30ab0e(0x21b)]),_0x3081a7=_0x1ffc3e,_0x3cf1a6=_0x4abb29,_0x349b94={'method':_0x30ab0e(0x252),'url':_0x3cf1a6+_0x30ab0e(0x1ab)+_0x68bacb,'headers':{'Content-Type':_0x30ab0e(0x236),'Authorization':_0x30ab0e(0x1ad)+_0x3081a7},'data':{'prompt':_0x282f3f}};try{const _0x3f0945=await(0x0,axios_1[_0x30ab0e(0x220)])(_0x349b94);return common_1[_0x30ab0e(0x234)][_0x30ab0e(0x1b8)]('插件调用成功\x20返回结果:\x20'+JSON[_0x30ab0e(0x1ed)](_0x3f0945[_0x30ab0e(0x224)],null,0x2),_0x30ab0e(0x24d)),_0x3f0945[_0x30ab0e(0x224)]['text'];}catch(_0x556c8e){common_1[_0x30ab0e(0x234)]['error'](_0x30ab0e(0x265),_0x556c8e);}}async[_0x369b67(0x183)](_0xba31d0,_0x38a8be,_0x1efcaa,_0xee9139,_0x21605e){const _0x3b9635=_0x369b67;if((_0x38a8be===null||_0x38a8be===void 0x0?void 0x0:_0x38a8be[_0x3b9635(0x20d)])==='新对话'){let _0x2fee22;if(_0x1efcaa===0x1)try{_0x2fee22=await this[_0x3b9635(0x1ce)][_0x3b9635(0x1e8)](_0x3b9635(0x1d3)+_0xee9139+_0x3b9635(0x1f5)),_0x2fee22[_0x3b9635(0x177)]>0xf&&(_0x2fee22=_0x2fee22[_0x3b9635(0x25e)](0x0,0xf));}catch(_0x1c081b){common_1['Logger'][_0x3b9635(0x190)](_0x3b9635(0x18c)+_0x1c081b),_0x2fee22=_0xee9139['slice'](0x0,0xa);}else _0x2fee22='创意\x20AI';this[_0x3b9635(0x1e5)]['update']({'groupId':_0xba31d0,'title':_0x2fee22,'isSticky':![],'config':'','fileUrl':''},_0x21605e)['then'](()=>common_1['Logger'][_0x3b9635(0x1b8)]('更新标题名称为:\x20'+_0x2fee22,_0x3b9635(0x213)))[_0x3b9635(0x1e7)](_0x20c56c=>common_1[_0x3b9635(0x234)][_0x3b9635(0x190)](_0x3b9635(0x1b4)+_0x20c56c));}}async['buildMessageFromParentMessageId'](_0x294809,_0x113f65,_0x4e1ddd){const _0x2c21eb=_0x369b67;let {systemMessage:systemMessage='',fileInfo:_0x2bba6f,groupId:_0x4d7fbb,maxRounds:maxRounds=0x5,maxModelTokens:maxModelTokens=0x1f40,isFileUpload:isFileUpload=0x0,isConvertToBase64:_0x6a9077}=_0x113f65;systemMessage[_0x2c21eb(0x177)]>maxModelTokens&&(common_1[_0x2c21eb(0x234)]['log'](_0x2c21eb(0x235),'ChatService'),systemMessage=systemMessage[_0x2c21eb(0x25e)](0x0,maxModelTokens));let _0x25bab6=[];systemMessage&&_0x25bab6[_0x2c21eb(0x1b5)]({'role':_0x2c21eb(0x201),'content':systemMessage});if(_0x4d7fbb){const _0x585f84=await _0x4e1ddd[_0x2c21eb(0x1c3)](_0x4d7fbb,maxRounds);let _0x9ca21f=null;for(const _0x4da806 of _0x585f84){try{let _0x458fa4;if((isFileUpload===0x2||isFileUpload===0x3)&&_0x4da806[_0x2c21eb(0x238)]&&_0x4da806['role']===_0x2c21eb(0x1a7)){const _0x24aeb8=await Promise[_0x2c21eb(0x22f)](_0x4da806[_0x2c21eb(0x238)][_0x2c21eb(0x1d5)](',')[_0x2c21eb(0x1de)](async _0x4e0a78=>({'type':_0x2c21eb(0x221),'image_url':{'url':_0x6a9077==='1'?await this[_0x2c21eb(0x21f)](_0x4e0a78['trim']()):_0x4e0a78[_0x2c21eb(0x1c2)]()}})));_0x458fa4=[{'type':_0x2c21eb(0x1af),'text':_0x4da806['text']},..._0x24aeb8];}else isFileUpload===0x1&&_0x4da806[_0x2c21eb(0x238)]&&_0x4da806[_0x2c21eb(0x1dd)]===_0x2c21eb(0x1a7)?_0x458fa4=_0x4da806[_0x2c21eb(0x238)]+'\x0a'+_0x4da806['text']:_0x458fa4=_0x4da806['text'];if(_0x4da806[_0x2c21eb(0x1dd)]===_0x2c21eb(0x1a7))_0x9ca21f={'role':_0x4da806[_0x2c21eb(0x1dd)],'content':_0x458fa4};else{if(_0x4da806[_0x2c21eb(0x1dd)]==='assistant'){const _0x46db26=Array[_0x2c21eb(0x233)](_0x458fa4)?JSON['stringify'](_0x458fa4):_0x458fa4;_0x9ca21f&&_0x46db26[_0x2c21eb(0x1c2)]()!==''&&(_0x25bab6['push'](_0x9ca21f),_0x25bab6[_0x2c21eb(0x1b5)]({'role':_0x4da806[_0x2c21eb(0x1dd)],'content':_0x458fa4}),_0x9ca21f=null);}}}catch(_0x505793){common_1[_0x2c21eb(0x234)][_0x2c21eb(0x190)]('处理历史记录时出错:',_0x505793,_0x2c21eb(0x192),JSON['stringify'](_0x4da806,null,0x2));}}}let _0x16fc8a;if((isFileUpload===0x2||isFileUpload===0x3)&&_0x2bba6f){const _0x3b8400=await Promise['all'](_0x2bba6f[_0x2c21eb(0x1d5)](',')[_0x2c21eb(0x1de)](async _0x428406=>({'type':'image_url','image_url':{'url':_0x6a9077==='1'?await this[_0x2c21eb(0x21f)](_0x428406['trim']()):_0x428406[_0x2c21eb(0x1c2)]()}})));_0x16fc8a=[{'type':_0x2c21eb(0x1af),'text':_0x294809},..._0x3b8400];}else isFileUpload===0x1&&_0x2bba6f?_0x16fc8a=_0x2bba6f+'\x0a'+_0x294809:_0x16fc8a=_0x294809;_0x25bab6[_0x2c21eb(0x1b5)]({'role':_0x2c21eb(0x1a7),'content':_0x16fc8a});let _0x534e19=await(0x0,utils_1[_0x2c21eb(0x202)])(_0x25bab6),_0x58dcc9;maxModelTokens<0x1f40?_0x58dcc9=0xfa0:_0x58dcc9=maxModelTokens-0xfa0;while(_0x534e19>_0x58dcc9){if(_0x25bab6[_0x2c21eb(0x177)]===0x2&&_0x25bab6[0x0][_0x2c21eb(0x1dd)]===_0x2c21eb(0x201)&&_0x25bab6[0x1][_0x2c21eb(0x1dd)]===_0x2c21eb(0x1a7))break;let _0x2f8718=![];for(let _0x3602be=0x0;_0x3602be<_0x25bab6['length'];_0x3602be++){if(_0x25bab6[_0x3602be][_0x2c21eb(0x1dd)]!==_0x2c21eb(0x201)&&_0x25bab6[_0x3602be+0x1]&&_0x25bab6[_0x3602be+0x1][_0x2c21eb(0x1dd)]===_0x2c21eb(0x180)){_0x25bab6[_0x2c21eb(0x17b)](_0x3602be,0x2),_0x2f8718=!![];break;}}if(!_0x2f8718)for(let _0x5a0844=0x0;_0x5a0844<_0x25bab6['length'];_0x5a0844++){if(_0x25bab6[_0x5a0844][_0x2c21eb(0x1dd)]==='user'){_0x25bab6['splice'](_0x5a0844,0x1);break;}}_0x534e19=await(0x0,utils_1['getTokenCount'])(_0x25bab6);if(_0x25bab6[_0x2c21eb(0x177)]<=0x2)break;}return{'messagesHistory':_0x25bab6,'round':_0x25bab6[_0x2c21eb(0x177)]};}async[_0x369b67(0x21f)](_0x1a9ad3){const _0x47439f=_0x369b67;try{console[_0x47439f(0x1b8)](_0x47439f(0x187)+_0x1a9ad3);const _0x1be710=await axios_1[_0x47439f(0x220)][_0x47439f(0x1ee)](_0x1a9ad3,{'responseType':_0x47439f(0x219)}),_0xfb7a3=Buffer['from'](_0x1be710['data'],_0x47439f(0x184));console[_0x47439f(0x1b8)](_0x47439f(0x17f)+_0x1a9ad3);const _0xbad56=_0x47439f(0x1be)+_0x1be710[_0x47439f(0x1f6)][_0x47439f(0x174)]+_0x47439f(0x227)+_0xfb7a3[_0x47439f(0x243)](_0x47439f(0x19f));return console[_0x47439f(0x1b8)]('成功转换URL为Base64:\x20'+_0x1a9ad3),_0xbad56;}catch(_0x2da380){return console[_0x47439f(0x190)](_0x47439f(0x1c9),_0x2da380),console['warn'](_0x47439f(0x17a)+_0x1a9ad3),_0x1a9ad3;}}async[_0x369b67(0x212)](_0xb99718,_0xbf75b9,_0x524506){const _0x55ce34=_0x369b67,{chatId:_0x5d9c18,prompt:_0x3df94f}=_0xb99718,_0x20e2d4=await this[_0x55ce34(0x175)][_0x55ce34(0x20e)](_0x55ce34(0x24e)),{openaiTimeout:_0x296e5f,openaiBaseUrl:_0xda53e9,openaiBaseKey:_0x435516,openaiVoice:_0x2c3e55}=await this[_0x55ce34(0x259)]['getConfigs'](['openaiTimeout',_0x55ce34(0x1a0),_0x55ce34(0x1e1),_0x55ce34(0x268)]),{key:_0x4edb8b,proxyUrl:_0x5b3f75,deduct:_0x513eb3,deductType:_0x34c08a,timeout:_0x281e28}=_0x20e2d4,_0x4ba0ec=_0x4edb8b||_0x435516,_0x180f01=(0x0,utils_1['formatUrl'])(_0x5b3f75||_0xda53e9),_0x35e60f=(_0x281e28||_0x296e5f)*0x3e8;await this['userBalanceService'][_0x55ce34(0x248)](_0xbf75b9,_0x34c08a,_0x513eb3),common_1[_0x55ce34(0x234)][_0x55ce34(0x1b8)](_0x55ce34(0x206),_0x3df94f,'TTSService');const _0x142204={'method':'POST','url':_0x180f01+_0x55ce34(0x1d1),'headers':{'Content-Type':'application/json','Authorization':_0x55ce34(0x1ad)+_0x4ba0ec},'responseType':_0x55ce34(0x219),'timeout':_0x35e60f,'data':{'model':'tts-1','input':_0x3df94f,'voice':_0x2c3e55||_0x55ce34(0x211)}};try{const _0x2f9939=await(0x0,axios_1[_0x55ce34(0x220)])(_0x142204);common_1[_0x55ce34(0x234)][_0x55ce34(0x1b8)](_0x55ce34(0x196),'TTSService');const _0xa58f6d=Buffer[_0x55ce34(0x25d)](_0x2f9939[_0x55ce34(0x224)]),_0x3cf910=new Date(),_0x41459c=_0x3cf910[_0x55ce34(0x173)](),_0x5954eb=String(_0x3cf910[_0x55ce34(0x176)]()+0x1)[_0x55ce34(0x1c8)](0x2,'0'),_0x48b40a=String(_0x3cf910[_0x55ce34(0x17d)]())[_0x55ce34(0x1c8)](0x2,'0'),_0x484c70=''+_0x41459c+_0x5954eb+'/'+_0x48b40a,_0x150789=await this[_0x55ce34(0x1cd)]['uploadFile']({'buffer':_0xa58f6d,'mimetype':'audio/mpeg'},_0x55ce34(0x1eb)+_0x484c70);await Promise[_0x55ce34(0x22f)]([this[_0x55ce34(0x1c6)][_0x55ce34(0x217)](_0x5d9c18,{'ttsUrl':_0x150789}),this['userBalanceService'][_0x55ce34(0x1b7)](_0xbf75b9[_0x55ce34(0x1a7)]['id'],_0x34c08a,_0x513eb3)]),_0x524506[_0x55ce34(0x1c7)](0xc8)[_0x55ce34(0x18d)]({'ttsUrl':_0x150789});}catch(_0x21ade8){common_1[_0x55ce34(0x234)][_0x55ce34(0x190)](_0x55ce34(0x19a),_0x21ade8,'TTSService'),_0x524506[_0x55ce34(0x1c7)](0x1f4)[_0x55ce34(0x18d)]({'error':_0x55ce34(0x226)});}}};ChatService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x369b67(0x18a)])(config_entity_1['ConfigEntity'])),__param(0x1,(0x0,typeorm_1[_0x369b67(0x18a)])(app_entity_1[_0x369b67(0x1cf)])),__param(0x2,(0x0,typeorm_1[_0x369b67(0x18a)])(plugin_entity_1['PluginEntity'])),__metadata(_0x369b67(0x223),[typeorm_2[_0x369b67(0x21e)],typeorm_2[_0x369b67(0x21e)],typeorm_2['Repository'],suno_service_1[_0x369b67(0x21d)],openaiChat_service_1[_0x369b67(0x264)],chatLog_service_1[_0x369b67(0x216)],midjourneyDraw_service_1['MidjourneyService'],stableDiffusion_service_1[_0x369b67(0x205)],userBalance_service_1[_0x369b67(0x257)],user_service_1['UserService'],upload_service_1[_0x369b67(0x21a)],badWords_service_1['BadWordsService'],autoreply_service_1[_0x369b67(0x1d2)],globalConfig_service_1[_0x369b67(0x1e0)],chatGroup_service_1[_0x369b67(0x210)],models_service_1['ModelsService'],openaiDraw_service_1[_0x369b67(0x1cb)],lumaVideo_service_1[_0x369b67(0x20b)],cogVideo_service_1[_0x369b67(0x19b)],fluxDraw_service_1[_0x369b67(0x1fb)],aiPPT_1[_0x369b67(0x1d8)]])],ChatService),exports[_0x369b67(0x213)]=ChatService;