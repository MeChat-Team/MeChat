'use strict';const _0x4ba8c6=_0x2892;function _0x2892(_0x1431d2,_0x2169f6){const _0x3ba406=_0x3ba4();return _0x2892=function(_0x289255,_0x46f5e0){_0x289255=_0x289255-0x1ab;let _0x1aa6c4=_0x3ba406[_0x289255];return _0x1aa6c4;},_0x2892(_0x1431d2,_0x2169f6);}(function(_0x2881ce,_0x58c2b4){const _0x10a6a5=_0x2892,_0x725c6e=_0x2881ce();while(!![]){try{const _0x50e4a7=-parseInt(_0x10a6a5(0x282))/0x1+-parseInt(_0x10a6a5(0x29c))/0x2*(parseInt(_0x10a6a5(0x1ad))/0x3)+parseInt(_0x10a6a5(0x211))/0x4+parseInt(_0x10a6a5(0x201))/0x5*(-parseInt(_0x10a6a5(0x1c1))/0x6)+-parseInt(_0x10a6a5(0x281))/0x7+-parseInt(_0x10a6a5(0x277))/0x8*(parseInt(_0x10a6a5(0x238))/0x9)+parseInt(_0x10a6a5(0x22a))/0xa*(parseInt(_0x10a6a5(0x26c))/0xb);if(_0x50e4a7===_0x58c2b4)break;else _0x725c6e['push'](_0x725c6e['shift']());}catch(_0x14bde0){_0x725c6e['push'](_0x725c6e['shift']());}}}(_0x3ba4,0xe72b7));var __decorate=this&&this[_0x4ba8c6(0x1e9)]||function(_0x1506eb,_0x195530,_0x28e377,_0x488267){const _0x52aab5=_0x4ba8c6;var _0x1887fb=arguments[_0x52aab5(0x27a)],_0x446a63=_0x1887fb<0x3?_0x195530:_0x488267===null?_0x488267=Object[_0x52aab5(0x1c3)](_0x195530,_0x28e377):_0x488267,_0x539866;if(typeof Reflect==='object'&&typeof Reflect[_0x52aab5(0x261)]===_0x52aab5(0x254))_0x446a63=Reflect[_0x52aab5(0x261)](_0x1506eb,_0x195530,_0x28e377,_0x488267);else{for(var _0x2391da=_0x1506eb[_0x52aab5(0x27a)]-0x1;_0x2391da>=0x0;_0x2391da--)if(_0x539866=_0x1506eb[_0x2391da])_0x446a63=(_0x1887fb<0x3?_0x539866(_0x446a63):_0x1887fb>0x3?_0x539866(_0x195530,_0x28e377,_0x446a63):_0x539866(_0x195530,_0x28e377))||_0x446a63;}return _0x1887fb>0x3&&_0x446a63&&Object[_0x52aab5(0x1d6)](_0x195530,_0x28e377,_0x446a63),_0x446a63;},__metadata=this&&this[_0x4ba8c6(0x234)]||function(_0x3c8a7b,_0x502b54){const _0x5896ba=_0x4ba8c6;if(typeof Reflect===_0x5896ba(0x1fc)&&typeof Reflect[_0x5896ba(0x243)]===_0x5896ba(0x254))return Reflect[_0x5896ba(0x243)](_0x3c8a7b,_0x502b54);},__param=this&&this[_0x4ba8c6(0x1ea)]||function(_0x45b05d,_0x21c8a2){return function(_0x30a5a3,_0xa9b43a){_0x21c8a2(_0x30a5a3,_0xa9b43a,_0x45b05d);};};Object[_0x4ba8c6(0x1d6)](exports,_0x4ba8c6(0x262),{'value':!![]}),exports[_0x4ba8c6(0x1c5)]=void 0x0;const utils_1=require(_0x4ba8c6(0x28c)),common_1=require(_0x4ba8c6(0x1fa)),typeorm_1=require(_0x4ba8c6(0x1c9)),axios_1=require(_0x4ba8c6(0x237)),typeorm_2=require(_0x4ba8c6(0x247)),aiPPT_1=require(_0x4ba8c6(0x213)),cogVideo_service_1=require(_0x4ba8c6(0x2a4)),fluxDraw_service_1=require(_0x4ba8c6(0x25a)),lumaVideo_service_1=require(_0x4ba8c6(0x1d0)),midjourneyDraw_service_1=require(_0x4ba8c6(0x214)),openaiChat_service_1=require(_0x4ba8c6(0x2aa)),openaiDraw_service_1=require('../ai/openaiDraw.service'),stableDiffusion_service_1=require('../ai/stableDiffusion.service'),suno_service_1=require(_0x4ba8c6(0x2a8)),app_entity_1=require(_0x4ba8c6(0x20c)),autoreply_service_1=require(_0x4ba8c6(0x1f5)),badWords_service_1=require('../badWords/badWords.service'),chatGroup_service_1=require(_0x4ba8c6(0x257)),chatLog_service_1=require(_0x4ba8c6(0x1d8)),config_entity_1=require(_0x4ba8c6(0x1d4)),globalConfig_service_1=require(_0x4ba8c6(0x24c)),models_service_1=require(_0x4ba8c6(0x22f)),plugin_entity_1=require(_0x4ba8c6(0x263)),upload_service_1=require(_0x4ba8c6(0x25e)),user_service_1=require(_0x4ba8c6(0x260)),userBalance_service_1=require(_0x4ba8c6(0x1fd));let ChatService=class ChatService{constructor(_0x3231d2,_0x3361c3,_0xc39a87,_0x44aace,_0xf839cd,_0x103421,_0x244ee6,_0x2bf066,_0x20ef0e,_0x2ecec2,_0x1e41fc,_0x32b57d,_0x73570f,_0x153df2,_0x48d780,_0x9c6a10,_0x46852b,_0x79774e,_0x5d101e,_0x3d9330,_0x480a14){const _0x2826a9=_0x4ba8c6;this['configEntity']=_0x3231d2,this[_0x2826a9(0x1f4)]=_0x3361c3,this[_0x2826a9(0x1ee)]=_0xc39a87,this['sunoService']=_0x44aace,this[_0x2826a9(0x219)]=_0xf839cd,this[_0x2826a9(0x1ec)]=_0x103421,this['midjourneyService']=_0x244ee6,this['stableDiffusionService']=_0x2bf066,this[_0x2826a9(0x1b8)]=_0x20ef0e,this[_0x2826a9(0x253)]=_0x2ecec2,this['uploadService']=_0x1e41fc,this[_0x2826a9(0x296)]=_0x32b57d,this[_0x2826a9(0x1ca)]=_0x73570f,this['globalConfigService']=_0x153df2,this[_0x2826a9(0x223)]=_0x48d780,this[_0x2826a9(0x27d)]=_0x9c6a10,this[_0x2826a9(0x299)]=_0x46852b,this['lumaVideoService']=_0x79774e,this[_0x2826a9(0x24e)]=_0x5d101e,this[_0x2826a9(0x1b7)]=_0x3d9330,this[_0x2826a9(0x1dd)]=_0x480a14;}async[_0x4ba8c6(0x220)](_0x20efec,_0xda0d09,_0x40f55e){const _0x234d15=_0x4ba8c6;await this['userBalanceService']['checkUserCertification'](_0xda0d09[_0x234d15(0x25b)]['id']);const {options:options={},usingPluginId:_0x33d31f,appId:appId=null,specialModel:_0x52adc0,prompt:_0x4ba0ef,fileInfo:_0x1821ea,extraParam:_0x2387a4,model:_0x65f501,drawId:_0x2ec9be,customId:_0x509bae,action:_0x8b8e35,modelName:_0x4c84de,modelAvatar:_0x2ac3b3}=_0x20efec;let _0x36a4d0;if(_0x52adc0)_0x36a4d0=await this[_0x234d15(0x1f4)][_0x234d15(0x224)]({'where':{'des':_0x52adc0,'isSystemReserved':!![]}});else{if(appId){_0x36a4d0=await this['appEntity'][_0x234d15(0x224)]({'where':{'id':appId,'status':(0x0,typeorm_2['In'])([0x1,0x3,0x4,0x5])}});if(!_0x36a4d0)throw new common_1[(_0x234d15(0x1e1))](_0x234d15(0x1f1),common_1[_0x234d15(0x21b)][_0x234d15(0x1be)]);}}const {groupId:_0x42f9cf,fileParsing:_0x4b4575}=options,{openaiTimeout:_0x3c6b40,openaiBaseUrl:_0x242245,openaiBaseKey:_0x4ce7c4,systemPreMessage:_0x372ee3,isMjTranslate:_0x562c85,mjTranslatePrompt:_0x430485,openaiTemperature:_0x11bdb5,openaiBaseModel:_0x43a330,isGeneratePromptReference:_0x588f99,isConvertToBase64:_0xdaeb55,isSensitiveWordFilter:_0x4b9c26}=await this[_0x234d15(0x1f2)]['getConfigs'](['openaiTimeout',_0x234d15(0x1bf),_0x234d15(0x24f),_0x234d15(0x264),'isMjTranslate',_0x234d15(0x208),_0x234d15(0x1c6),_0x234d15(0x1bd),_0x234d15(0x1de),_0x234d15(0x1b0),_0x234d15(0x1b6)]);await this[_0x234d15(0x253)][_0x234d15(0x1dc)](_0xda0d09['user']),_0x40f55e&&_0x40f55e['setHeader']('Content-type',_0x234d15(0x274));if(_0x4b9c26==='1'){const _0x3e22e4=await this[_0x234d15(0x296)][_0x234d15(0x1c7)](_0x4ba0ef,_0xda0d09[_0x234d15(0x25b)]['id']);if(_0x3e22e4['length']>0x0){const _0x55b4f2='您提交的信息中包含违规的内容，我们已对您的账户进行标记，请合规使用！';throw new common_1[(_0x234d15(0x1e1))](_0x55b4f2,common_1[_0x234d15(0x21b)][_0x234d15(0x1be)]);}}const _0x471d77=await this[_0x234d15(0x1ca)][_0x234d15(0x20a)](_0x4ba0ef);let _0x41920a=null,_0x4fe274='',_0x165754='';_0x40f55e&&_0x40f55e[_0x234d15(0x1cc)](0xc8);let _0x46666e=null;const _0x31d72f=(0x0,utils_1[_0x234d15(0x265)])(_0xda0d09);let _0x461af7,_0x136c26='',_0x324acc;_0x33d31f&&(_0x324acc=await this[_0x234d15(0x1ee)][_0x234d15(0x224)]({'where':{'id':_0x33d31f}}));if(_0x36a4d0){const {isGPTs:_0x1c892,gizmoID:_0x15d129,name:_0x597f4d,isFixedModel:_0x368f7c,appModel:_0x4fac7c,coverImg:_0x43e77d}=_0x36a4d0;_0x136c26=_0x43e77d,_0x4fe274=_0x597f4d;if(_0x1c892)_0x41920a=await this['modelsService'][_0x234d15(0x287)]('gpts'),_0x41920a[_0x234d15(0x29e)]='gpt-4-gizmo-'+_0x15d129;else!_0x1c892&&_0x368f7c&&_0x4fac7c?(_0x36a4d0[_0x234d15(0x246)]&&(_0x165754=_0x36a4d0[_0x234d15(0x246)]),_0x41920a=await this[_0x234d15(0x27d)]['getCurrentModelKeyInfo'](_0x4fac7c),_0x41920a['model']=_0x4fac7c,_0x4b4575&&(_0x165754=_0x165754+_0x234d15(0x1f7)+_0x4b4575+_0x234d15(0x226)),common_1['Logger'][_0x234d15(0x212)](_0x234d15(0x249)+_0x165754,'ChatService')):(_0x36a4d0[_0x234d15(0x246)]&&(_0x165754=_0x36a4d0[_0x234d15(0x246)]),_0x41920a=await this[_0x234d15(0x27d)]['getCurrentModelKeyInfo'](_0x65f501),_0x4b4575&&(_0x165754=_0x165754+'以下是我提供给你的知识库：【'+_0x4b4575+_0x234d15(0x226)),common_1[_0x234d15(0x259)][_0x234d15(0x212)](_0x234d15(0x22e)+_0x165754,_0x234d15(0x1c5)));}else{const _0x197bb4=await this[_0x234d15(0x223)][_0x234d15(0x1c0)](_0x42f9cf);if(_0x324acc&&_0x324acc[_0x234d15(0x1c2)]===0x0){let _0x4b56c6='';try{_0x4b56c6=await this[_0x234d15(0x20d)](_0x4ba0ef,_0x324acc[_0x234d15(0x250)]),common_1[_0x234d15(0x259)][_0x234d15(0x212)]('插件返回结果:\x20'+_0x4b56c6,'ChatService');}catch(_0x2a4aca){_0x4b56c6=_0x4ba0ef,common_1[_0x234d15(0x259)][_0x234d15(0x21c)](_0x234d15(0x1d2)+_0x2a4aca);}_0x165754=_0x4b56c6,_0x41920a=await this[_0x234d15(0x27d)]['getCurrentModelKeyInfo'](_0x65f501),common_1['Logger']['log'](_0x234d15(0x28d)+_0x165754,_0x234d15(0x1c5));}else{if(_0x4b4575)_0x165754='以下是我提供给你的知识库：【'+_0x4b4575+'】，在回答问题之前，先检索知识库内有没有相关的内容，尽量使用知识库中获取到的信息来回答我的问题，以知识库中的为准。',_0x41920a=await this[_0x234d15(0x27d)]['getCurrentModelKeyInfo'](_0x65f501),common_1[_0x234d15(0x259)]['log'](_0x234d15(0x26a)+_0x165754,'ChatService');else{const _0x4e4d2e=new Date()[_0x234d15(0x272)]()[_0x234d15(0x26d)]('T')[0x0];_0x165754=_0x372ee3+('\x0a\x20Current\x20date:\x20'+_0x4e4d2e),_0x41920a=await this[_0x234d15(0x27d)][_0x234d15(0x287)](_0x65f501),common_1['Logger'][_0x234d15(0x212)](_0x234d15(0x22d)+_0x165754,_0x234d15(0x1c5));}}}if(!_0x41920a){common_1[_0x234d15(0x259)][_0x234d15(0x245)](_0x234d15(0x1d5),_0x234d15(0x1c5)),_0x41920a=await this[_0x234d15(0x27d)]['getCurrentModelKeyInfo'](_0x43a330);const _0x599d59=await this[_0x234d15(0x223)][_0x234d15(0x1c0)](_0x42f9cf);let _0x391157=_0x599d59[_0x234d15(0x2a9)];try{const _0x16ffa5=JSON[_0x234d15(0x285)](_0x599d59[_0x234d15(0x2a9)]);_0x16ffa5[_0x234d15(0x244)]&&(_0x16ffa5['modelInfo'][_0x234d15(0x222)]=_0x41920a['modelName'],_0x16ffa5[_0x234d15(0x244)]['model']=_0x41920a[_0x234d15(0x29e)],_0x391157=JSON[_0x234d15(0x1c4)](_0x16ffa5));}catch(_0x524af5){common_1[_0x234d15(0x259)][_0x234d15(0x245)](_0x234d15(0x2ac),_0x234d15(0x1c5));throw new common_1['HttpException'](_0x234d15(0x1fb),common_1[_0x234d15(0x21b)][_0x234d15(0x1be)]);}await this[_0x234d15(0x223)]['update']({'groupId':_0x42f9cf,'title':_0x599d59[_0x234d15(0x2a7)],'isSticky':![],'config':_0x391157,'fileUrl':''},_0xda0d09);}const {deduct:_0x2b3867,isTokenBased:_0xc497ef,tokenFeeRatio:_0x3a20b7,deductType:_0x48b635,key:_0x15886a,id:_0x29b5a0,maxRounds:_0x41afdf,proxyUrl:_0x3f26b8,maxModelTokens:_0x1d6ade,timeout:_0x3f03c9,model:_0x3780cb,isFileUpload:_0x33e9e7,keyType:_0x43c143}=_0x41920a;if(await this['chatLogService'][_0x234d15(0x242)](_0xda0d09['user'],_0x3780cb))throw new common_1[(_0x234d15(0x1e1))](_0x234d15(0x1e6),common_1[_0x234d15(0x21b)][_0x234d15(0x1e0)]);if(_0x562c85==='1'&&_0x8b8e35==='IMAGINE'&&_0x65f501==='midjourney'){const [_0x30625d,_0x54c1d8]=_0x4ba0ef[_0x234d15(0x26d)](/(?= --)/),_0x109348=/(https?:\/\/[^\s]+)/g,_0x4822e0=_0x30625d['match'](_0x109348)||[];let _0x194f6b=_0x30625d[_0x234d15(0x25f)](_0x109348,'')[_0x234d15(0x292)]();const _0x2bb491=await this[_0x234d15(0x219)][_0x234d15(0x1d1)](_0x194f6b,_0x430485||_0x234d15(0x24a)),_0x479a80=[..._0x4822e0,_0x2bb491][_0x234d15(0x275)]('\x20')[_0x234d15(0x292)]();_0x461af7=_0x54c1d8?''+_0x479a80+_0x54c1d8:_0x479a80,_0x33e9e7==='1'&&_0x1821ea&&(_0x461af7=_0x1821ea+'\x20'+_0x461af7);}else _0x461af7=_0x33e9e7==='1'&&_0x1821ea?_0x1821ea+'\x20'+_0x4ba0ef:_0x4ba0ef;await this[_0x234d15(0x1b8)][_0x234d15(0x210)](_0xda0d09,_0x48b635,_0x2b3867);const _0x19c0c1=_0x4c84de,_0x17258d=(0x0,utils_1[_0x234d15(0x23e)])(_0x3f26b8||_0x242245||_0x234d15(0x2ae)),_0x51e189=_0x15886a||_0x4ce7c4,_0x3013a4=(_0x3f03c9||_0x3c6b40||0x12c)*0x3e8,_0x18e433=Number(_0x11bdb5)||0x1;if(_0x42f9cf){const _0x4e950c=await this['chatGroupService']['getGroupInfoFromId'](_0x42f9cf);this[_0x234d15(0x1f0)](_0x42f9cf,_0x4e950c,_0x43c143,_0x4ba0ef,_0xda0d09),await this['chatGroupService']['updateTime'](_0x42f9cf);}const _0x570e44=await this[_0x234d15(0x1ec)][_0x234d15(0x1d3)]({'appId':appId,'curIp':_0x31d72f,'userId':_0xda0d09[_0x234d15(0x25b)]['id'],'type':_0x43c143?_0x43c143:0x1,'prompt':_0x4ba0ef,'fileInfo':_0x1821ea?_0x1821ea:null,'answer':'','promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x3780cb,'modelName':'我','role':_0x234d15(0x25b),'groupId':_0x42f9cf?_0x42f9cf:null}),_0x37b3e1=await this[_0x234d15(0x1ec)][_0x234d15(0x1d3)]({'appId':appId?appId:null,'action':_0x8b8e35?_0x8b8e35:null,'curIp':_0x31d72f,'userId':_0xda0d09[_0x234d15(0x25b)]['id'],'type':_0x43c143?_0x43c143:0x1,'prompt':_0x4ba0ef,'fileInfo':null,'answer':'','progress':'0%','promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x3780cb,'modelName':_0x19c0c1,'role':'assistant','groupId':_0x42f9cf?_0x42f9cf:null,'status':0x2,'modelAvatar':(_0x324acc===null||_0x324acc===void 0x0?void 0x0:_0x324acc['pluginImg'])||_0x136c26||_0x2ac3b3||'','pluginParam':(_0x324acc===null||_0x324acc===void 0x0?void 0x0:_0x324acc[_0x234d15(0x250)])?_0x324acc['parameters']:_0x43c143===0x2?_0x3780cb:null}),_0x1a133d=_0x570e44['id'],_0x2d8812=_0x37b3e1['id'];if(_0x471d77[_0x234d15(0x1e7)]&&_0x40f55e){if(_0x471d77[_0x234d15(0x28a)]===0x0){const _0x371b96=_0x471d77['answer'][_0x234d15(0x26d)](''),_0x425d33=_0x13360a=>{const _0x354678=_0x234d15;if(_0x13360a<_0x371b96[_0x354678(0x27a)]){const _0x100307={'text':_0x371b96[_0x13360a]};_0x40f55e['write'](JSON['stringify'](_0x100307)+'\x0a'),setTimeout(()=>_0x425d33(_0x13360a+0x1),0xa);}else _0x40f55e[_0x354678(0x23a)]();};_0x425d33(0x0),await this[_0x234d15(0x1ec)]['updateChatLog'](_0x2d8812,{'answer':_0x471d77[_0x234d15(0x1e7)]});return;}else _0x165754=_0x165754+_0x471d77[_0x234d15(0x1e7)];}const {messagesHistory:_0x2d4459}=await this[_0x234d15(0x1ef)](_0x4ba0ef,{'groupId':_0x42f9cf,'systemMessage':_0x165754,'maxModelTokens':_0x1d6ade,'maxRounds':_0x41afdf,'isConvertToBase64':_0xdaeb55,'fileInfo':_0x1821ea,'model':_0x3780cb,'isFileUpload':_0x33e9e7},this[_0x234d15(0x1ec)]);let _0xd00134=_0x8b8e35!==_0x234d15(0x278)&&_0x3780cb===_0x234d15(0x276)?_0x2b3867*0x4:_0x2b3867;const _0x330942=new AbortController();try{if(_0x40f55e){_0x40f55e['on'](_0x234d15(0x1d7),()=>{const _0x367e8c=_0x234d15;_0x330942[_0x367e8c(0x266)]();});let _0x47f348,_0x4c6e8c=!![];try{if((_0x3780cb===_0x234d15(0x1f8)||_0x3780cb===_0x234d15(0x276)||_0x3780cb===_0x234d15(0x248)||_0x3780cb===_0x234d15(0x22b)||_0x3780cb===_0x234d15(0x230)||_0x3780cb['includes'](_0x234d15(0x273))||_0x3780cb[_0x234d15(0x294)]('cog-video')||_0x3780cb[_0x234d15(0x294)](_0x234d15(0x27e)))&&_0x43c143===0x2){if(_0x3780cb==='dall-e-3')_0x47f348=this[_0x234d15(0x299)][_0x234d15(0x269)]({'prompt':_0x4ba0ef,'extraParam':_0x2387a4,'apiKey':_0x51e189,'proxyUrl':_0x17258d,'model':_0x3780cb,'timeout':_0x3013a4,'modelName':_0x19c0c1,'groupId':_0x42f9cf,'onSuccess':async _0x3ad986=>{const _0x12417b=_0x234d15;await this[_0x12417b(0x1ec)][_0x12417b(0x205)](_0x2d8812,{'fileInfo':_0x3ad986===null||_0x3ad986===void 0x0?void 0x0:_0x3ad986['fileInfo'],'answer':(_0x3ad986===null||_0x3ad986===void 0x0?void 0x0:_0x3ad986[_0x12417b(0x1e7)])||_0x4ba0ef,'progress':_0x12417b(0x1eb),'status':_0x3ad986[_0x12417b(0x1cc)]});},'onFailure':async _0x271275=>{const _0x4a0524=_0x234d15;await this[_0x4a0524(0x1ec)][_0x4a0524(0x205)](_0x2d8812,{'answer':'绘图失败','status':_0x271275[_0x4a0524(0x1cc)]});}},this[_0x234d15(0x1ef)]),await this[_0x234d15(0x1ec)]['updateChatLog'](_0x2d8812,{'answer':_0x234d15(0x23b)});else{if(_0x3780cb==='ai-ppt')common_1[_0x234d15(0x259)][_0x234d15(0x212)](_0x234d15(0x1e8),'DrawService'),_0x47f348=this[_0x234d15(0x1dd)][_0x234d15(0x251)]({'usePrompt':_0x461af7,'prompt':_0x4ba0ef,'apiKey':_0x51e189,'proxyUrl':_0x17258d,'model':_0x3780cb,'modelName':_0x19c0c1,'drawId':_0x2ec9be,'customId':_0x509bae,'action':_0x8b8e35,'timeout':_0x3013a4,'assistantLogId':_0x2d8812,'extraParam':_0x2387a4,'fileInfo':_0x1821ea}),await this[_0x234d15(0x1ec)][_0x234d15(0x205)](_0x2d8812,{'answer':'生成中'});else{if(_0x3780cb[_0x234d15(0x294)](_0x234d15(0x27e)))_0x47f348=this[_0x234d15(0x1b7)][_0x234d15(0x27c)]({'prompt':_0x4ba0ef,'extraParam':_0x2387a4,'apiKey':_0x51e189,'proxyUrl':_0x17258d,'model':_0x3780cb,'timeout':_0x3013a4,'modelName':_0x19c0c1,'groupId':_0x42f9cf,'onSuccess':async _0x45f176=>{const _0x4e5bf1=_0x234d15;await this[_0x4e5bf1(0x1ec)][_0x4e5bf1(0x205)](_0x2d8812,{'fileInfo':_0x45f176===null||_0x45f176===void 0x0?void 0x0:_0x45f176[_0x4e5bf1(0x1b5)],'answer':(_0x45f176===null||_0x45f176===void 0x0?void 0x0:_0x45f176['answer'])||_0x4ba0ef,'progress':'100%','status':_0x45f176[_0x4e5bf1(0x1cc)]});},'onFailure':async _0xcab1ba=>{const _0x43518=_0x234d15;await this[_0x43518(0x1ec)][_0x43518(0x205)](_0x2d8812,{'answer':_0x43518(0x202),'status':_0xcab1ba[_0x43518(0x1cc)]});}},this[_0x234d15(0x1ef)]),await this[_0x234d15(0x1ec)][_0x234d15(0x205)](_0x2d8812,{'answer':_0x234d15(0x23b)});else{if(_0x3780cb[_0x234d15(0x294)](_0x234d15(0x22b)))_0x47f348=this[_0x234d15(0x27f)][_0x234d15(0x271)]({'assistantLogId':_0x2d8812,'apiKey':_0x51e189,'action':_0x8b8e35,'prompt':_0x4ba0ef,'timeout':_0x3013a4,'proxyUrl':_0x17258d,'taskData':_0x509bae}),await this[_0x234d15(0x1ec)][_0x234d15(0x205)](_0x2d8812,{'answer':_0x234d15(0x24d)});else{if(_0x3780cb[_0x234d15(0x294)](_0x234d15(0x230)))_0x47f348=this['lumaVideoService'][_0x234d15(0x2ad)]({'fileInfo':_0x1821ea,'extraParam':_0x2387a4,'assistantLogId':_0x2d8812,'apiKey':_0x51e189,'action':_0x8b8e35,'prompt':_0x4ba0ef,'model':_0x3780cb,'timeout':_0x3013a4,'proxyUrl':_0x17258d,'taskData':_0x509bae,'onGenerate':async _0x27525c=>{const _0x9ec78=_0x234d15;await this[_0x9ec78(0x1ec)][_0x9ec78(0x205)](_0x2d8812,{'fileInfo':_0x27525c===null||_0x27525c===void 0x0?void 0x0:_0x27525c[_0x9ec78(0x1b5)],'answer':(_0x27525c===null||_0x27525c===void 0x0?void 0x0:_0x27525c[_0x9ec78(0x1e7)])||_0x4ba0ef,'status':0x2});},'onSuccess':async _0x233e98=>{const _0x25ba64=_0x234d15;await this[_0x25ba64(0x1ec)]['updateChatLog'](_0x2d8812,{'fileInfo':_0x233e98===null||_0x233e98===void 0x0?void 0x0:_0x233e98[_0x25ba64(0x1b5)],'answer':(_0x233e98===null||_0x233e98===void 0x0?void 0x0:_0x233e98[_0x25ba64(0x1e7)])||_0x4ba0ef,'progress':_0x25ba64(0x1eb),'status':0x3});},'onFailure':async _0x2ef0f2=>{const _0x4bf142=_0x234d15;await this['chatLogService'][_0x4bf142(0x205)](_0x2d8812,{'answer':_0x2ef0f2[_0x4bf142(0x233)],'status':0x4});}}),await this[_0x234d15(0x1ec)][_0x234d15(0x205)](_0x2d8812,{'answer':'提交成功，视频生成中'});else{if(_0x3780cb[_0x234d15(0x294)]('cog-video'))_0x47f348=this['cogVideoService']['cogVideo']({'fileInfo':_0x1821ea,'extraParam':_0x2387a4,'assistantLogId':_0x2d8812,'apiKey':_0x51e189,'action':_0x8b8e35,'prompt':_0x4ba0ef,'model':_0x3780cb,'timeout':_0x3013a4,'proxyUrl':_0x17258d,'taskData':_0x509bae,'onGenerate':async _0x322e3b=>{const _0x268a1e=_0x234d15;await this['chatLogService'][_0x268a1e(0x205)](_0x2d8812,{'fileInfo':_0x322e3b===null||_0x322e3b===void 0x0?void 0x0:_0x322e3b[_0x268a1e(0x1b5)],'answer':(_0x322e3b===null||_0x322e3b===void 0x0?void 0x0:_0x322e3b[_0x268a1e(0x1e7)])||_0x4ba0ef,'status':0x2});},'onSuccess':async _0x1c9ea3=>{const _0x38105a=_0x234d15;await this[_0x38105a(0x1ec)]['updateChatLog'](_0x2d8812,{'fileInfo':_0x1c9ea3===null||_0x1c9ea3===void 0x0?void 0x0:_0x1c9ea3[_0x38105a(0x1b5)],'answer':(_0x1c9ea3===null||_0x1c9ea3===void 0x0?void 0x0:_0x1c9ea3[_0x38105a(0x1e7)])||_0x4ba0ef,'progress':_0x38105a(0x1eb),'status':0x3});},'onFailure':async _0x1a7abb=>{const _0x1b3ad7=_0x234d15;await this[_0x1b3ad7(0x1ec)][_0x1b3ad7(0x205)](_0x2d8812,{'answer':_0x1a7abb[_0x1b3ad7(0x233)],'status':0x4});}}),await this[_0x234d15(0x1ec)][_0x234d15(0x205)](_0x2d8812,{'answer':_0x234d15(0x218)});else _0x3780cb[_0x234d15(0x294)](_0x234d15(0x273))?(_0x47f348=this[_0x234d15(0x20e)][_0x234d15(0x25d)]({'chatId':_0x2d8812,'maxModelTokens':_0x1d6ade,'apiKey':_0x51e189,'model':_0x3780cb,'modelName':_0x19c0c1,'modelType':_0x43c143,'prompt':_0x4ba0ef,'fileInfo':_0x1821ea,'isFileUpload':_0x33e9e7,'timeout':_0x3013a4,'proxyUrl':_0x17258d,'onSuccess':async _0x5cdfbc=>{const _0x56d2de=_0x234d15;await this['chatLogService']['updateChatLog'](_0x2d8812,{'fileInfo':_0x5cdfbc===null||_0x5cdfbc===void 0x0?void 0x0:_0x5cdfbc[_0x56d2de(0x1b5)],'answer':(_0x5cdfbc===null||_0x5cdfbc===void 0x0?void 0x0:_0x5cdfbc[_0x56d2de(0x1e7)])||_0x4ba0ef,'progress':_0x56d2de(0x1eb),'status':0x3});},'onFailure':async _0x345810=>{const _0x1986e8=_0x234d15;await this[_0x1986e8(0x1ec)][_0x1986e8(0x205)](_0x2d8812,{'answer':_0x1986e8(0x1b4),'status':0x4});}}),await this[_0x234d15(0x1ec)][_0x234d15(0x205)](_0x2d8812,{'answer':_0x234d15(0x23b)})):(_0x47f348=await this['midjourneyService'][_0x234d15(0x1ed)]({'usePrompt':_0x461af7,'prompt':_0x4ba0ef,'apiKey':_0x51e189,'proxyUrl':_0x17258d,'model':_0x3780cb,'modelName':_0x19c0c1,'drawId':_0x2ec9be,'customId':_0x509bae,'action':_0x8b8e35,'fileInfo':_0x1821ea,'timeout':_0x3013a4,'assistantLogId':_0x2d8812,'pluginName':_0x324acc}),await this['chatLogService']['updateChatLog'](_0x2d8812,{'answer':_0x47f348[_0x234d15(0x1e7)],'status':_0x47f348[_0x234d15(0x1cc)]}));}}}}}_0x47f348['status']!==0x5?(await this[_0x234d15(0x27d)]['saveUseLog'](_0x29b5a0,0x1),await this[_0x234d15(0x1b8)][_0x234d15(0x26b)](_0xda0d09['user']['id'],_0x48b635,_0xd00134)):common_1[_0x234d15(0x259)][_0x234d15(0x212)](_0x234d15(0x228),_0x234d15(0x1c5));const _0x4f1605=await this[_0x234d15(0x1b8)][_0x234d15(0x298)](_0xda0d09['user']['id']);return _0x47f348[_0x234d15(0x284)]=Object['assign']({},_0x4f1605),_0x47f348[_0x234d15(0x2a3)]=_0x47f348[_0x234d15(0x1e7)],_0x47f348[_0x234d15(0x1cc)]=_0x47f348[_0x234d15(0x1cc)]||0x2,_0x47f348[_0x234d15(0x29e)]=_0x65f501,_0x47f348[_0x234d15(0x222)]=_0x4c84de,_0x40f55e['write']('\x0a'+JSON[_0x234d15(0x1c4)](_0x47f348));}else{_0x47f348=await this[_0x234d15(0x219)][_0x234d15(0x2af)](_0x2d4459,{'chatId':_0x2d8812,'maxModelTokens':_0x1d6ade,'apiKey':_0x51e189,'model':_0x3780cb,'modelName':_0x19c0c1,'temperature':_0x18e433,'modelType':_0x43c143,'prompt':_0x4ba0ef,'fileInfo':_0x1821ea,'isFileUpload':_0x33e9e7,'timeout':_0x3013a4,'proxyUrl':_0x17258d,'modelAvatar':_0x2ac3b3,'onProgress':_0x37cfa6=>{const _0xb17423=_0x234d15;_0x40f55e[_0xb17423(0x26e)](_0x4c6e8c?JSON[_0xb17423(0x1c4)](_0x37cfa6):'\x0a'+JSON[_0xb17423(0x1c4)](_0x37cfa6)),_0x4c6e8c=![];},'onFailure':async _0x3c0344=>{const _0x1e7a2a=_0x234d15;await this['chatLogService'][_0x1e7a2a(0x205)](_0x2d8812,{'answer':_0x3c0344[_0x1e7a2a(0x233)],'status':0x4});},'abortController':_0x330942});if(_0x47f348[_0x234d15(0x233)])return common_1['Logger'][_0x234d15(0x21c)](_0x234d15(0x295)+_0xda0d09[_0x234d15(0x25b)]['id']+_0x234d15(0x297)+_0x19c0c1+_0x234d15(0x1df)+_0x65f501+_0x234d15(0x1e2),'ChatService'),_0x40f55e[_0x234d15(0x26e)]('\x0a'+JSON[_0x234d15(0x1c4)](_0x47f348));let _0x4477b4='';_0x2d4459[_0x234d15(0x1e3)](_0xa820c1=>{const _0x28a529=_0x234d15;_0x4477b4+=_0xa820c1[_0x28a529(0x268)]+'\x20';});const _0xee5d6b=await(0x0,utils_1['getTokenCount'])(_0x4477b4),_0x504402=await(0x0,utils_1[_0x234d15(0x1e4)])(_0x47f348[_0x234d15(0x1e7)]);await this[_0x234d15(0x1ec)]['updateChatLog'](_0x1a133d,{'promptTokens':_0xee5d6b,'completionTokens':_0x504402,'totalTokens':_0xee5d6b+_0x504402});let _0x4aac55=_0x47f348[_0x234d15(0x1e7)];if(_0x4b9c26==='1'){const _0x390de7=await this[_0x234d15(0x296)][_0x234d15(0x1c7)](_0x47f348[_0x234d15(0x1e7)],_0xda0d09[_0x234d15(0x25b)]['id']);if(_0x390de7['length']>0x0){const _0x76d80c=new RegExp(_0x390de7[_0x234d15(0x275)]('|'),'gi');_0x4aac55=_0x4aac55[_0x234d15(0x25f)](_0x76d80c,_0x109f46=>'*'['repeat'](_0x109f46[_0x234d15(0x27a)]));}}await this[_0x234d15(0x1ec)][_0x234d15(0x205)](_0x2d8812,{'fileInfo':_0x47f348===null||_0x47f348===void 0x0?void 0x0:_0x47f348[_0x234d15(0x1b5)],'answer':_0x4aac55,'promptTokens':_0xee5d6b,'completionTokens':_0x504402,'totalTokens':_0xee5d6b+_0x504402,'status':0x3});try{if(_0x588f99==='1'){const _0x42cac0=await this[_0x234d15(0x219)][_0x234d15(0x1d1)](_0x234d15(0x236)+_0x4ba0ef+_0x234d15(0x229)+_0x47f348[_0x234d15(0x1e7)]+_0x234d15(0x25c));await this[_0x234d15(0x1ec)][_0x234d15(0x205)](_0x2d8812,{'promptReference':_0x42cac0});}}catch(_0x43b251){common_1[_0x234d15(0x259)][_0x234d15(0x21c)](_0x234d15(0x1b2)+_0x43b251);}_0xc497ef===!![]&&(_0xd00134=_0x2b3867*Math[_0x234d15(0x1f3)]((_0xee5d6b+_0x504402)/_0x3a20b7));await this[_0x234d15(0x1b8)]['deductFromBalance'](_0xda0d09[_0x234d15(0x25b)]['id'],_0x48b635,_0xd00134,_0xee5d6b+_0x504402),await this['modelsService'][_0x234d15(0x28b)](_0x29b5a0,_0xee5d6b+_0x504402),common_1[_0x234d15(0x259)]['log'](_0x234d15(0x295)+_0xda0d09['user']['id']+'\x20模型名称:\x20'+_0x19c0c1+'\x20模型:\x20'+_0x65f501+_0x234d15(0x215)+(_0xee5d6b+_0x504402)+_0x234d15(0x2a6)+_0xd00134,_0x234d15(0x1c5));const _0x3d9183=await this[_0x234d15(0x1b8)][_0x234d15(0x298)](_0xda0d09['user']['id']);return _0x47f348['userBalance']=Object[_0x234d15(0x21e)]({},_0x3d9183),_0x40f55e[_0x234d15(0x26e)]('\x0a'+JSON[_0x234d15(0x1c4)](_0x47f348));}}catch(_0x38e7c3){common_1[_0x234d15(0x259)]['error']('发生错误:',_0x38e7c3),await this[_0x234d15(0x1ec)][_0x234d15(0x205)](_0x2d8812,{'status':0x5}),_0x47f348={'error':_0x234d15(0x235)};}}else return _0x46666e=await this[_0x234d15(0x219)][_0x234d15(0x2af)](_0x2d4459,{'chatId':_0x2d8812,'maxModelTokens':_0x1d6ade,'apiKey':_0x51e189,'model':_0x3780cb,'modelName':_0x19c0c1,'modelType':_0x43c143,'temperature':_0x18e433,'prompt':_0x4ba0ef,'fileInfo':_0x1821ea,'isFileUpload':_0x33e9e7,'timeout':_0x3013a4,'proxyUrl':_0x17258d,'abortController':_0x330942}),await this['userBalanceService']['deductFromBalance'](_0xda0d09['user']['id'],_0x48b635,_0xd00134),_0x46666e[_0x234d15(0x1e7)];}catch(_0x1e641a){common_1[_0x234d15(0x259)][_0x234d15(0x21c)](_0x234d15(0x21d),_0x51e189,_0x1e641a);if(_0x40f55e)return _0x40f55e[_0x234d15(0x26e)](_0x234d15(0x1d9));else throw new common_1[(_0x234d15(0x1e1))](_0x234d15(0x1d9),common_1['HttpStatus'][_0x234d15(0x1be)]);}finally{_0x40f55e&&_0x40f55e['end']();}}async[_0x4ba8c6(0x20d)](_0xdbb87c,_0xbdfbed){const _0x11208b=_0x4ba8c6,{pluginUrl:_0x42d21f,pluginKey:_0xec6c74}=await this[_0x11208b(0x1f2)][_0x11208b(0x1af)]([_0x11208b(0x288),'pluginKey']),_0x230575=_0xec6c74,_0x3a4676=_0x42d21f,_0x124c31={'method':_0x11208b(0x289),'url':_0x3a4676+_0x11208b(0x291)+_0xbdfbed,'headers':{'Content-Type':'application/json','Authorization':_0x11208b(0x23c)+_0x230575},'data':{'prompt':_0xdbb87c}};try{const _0x250c2d=await(0x0,axios_1[_0x11208b(0x1ff)])(_0x124c31);return common_1[_0x11208b(0x259)]['log'](_0x11208b(0x217)+JSON['stringify'](_0x250c2d[_0x11208b(0x1cb)],null,0x2),'PluginService'),_0x250c2d['data'][_0x11208b(0x2a3)];}catch(_0x187900){common_1[_0x11208b(0x259)]['error'](_0x11208b(0x1f6),_0x187900);}}async[_0x4ba8c6(0x1f0)](_0x58dd3c,_0x5e1523,_0x25aac1,_0x149016,_0x4dd5ac){const _0x7e352c=_0x4ba8c6;if((_0x5e1523===null||_0x5e1523===void 0x0?void 0x0:_0x5e1523[_0x7e352c(0x2a7)])===_0x7e352c(0x27b)){let _0x294d23;if(_0x25aac1===0x1)try{_0x294d23=await this[_0x7e352c(0x219)]['chatFree'](_0x7e352c(0x236)+_0x149016+_0x7e352c(0x1bb)),_0x294d23['length']>0xf&&(_0x294d23=_0x294d23['slice'](0x0,0xf));}catch(_0x416846){common_1[_0x7e352c(0x259)]['error'](_0x7e352c(0x1b2)+_0x416846),_0x294d23=_0x149016[_0x7e352c(0x1c8)](0x0,0xa);}else _0x294d23='创意\x20AI';this[_0x7e352c(0x223)][_0x7e352c(0x290)]({'groupId':_0x58dd3c,'title':_0x294d23,'isSticky':![],'config':'','fileUrl':''},_0x4dd5ac)['then'](()=>common_1['Logger'][_0x7e352c(0x212)](_0x7e352c(0x1ab)+_0x294d23,_0x7e352c(0x1c5)))[_0x7e352c(0x1da)](_0x11643e=>common_1['Logger'][_0x7e352c(0x21c)](_0x7e352c(0x23d)+_0x11643e));}}async['buildMessageFromParentMessageId'](_0xbee8b3,_0x48e05d,_0x3c9667){const _0x6e25c5=_0x4ba8c6;let {systemMessage:systemMessage='',fileInfo:_0x37cd5e,groupId:_0x3f70eb,maxRounds:maxRounds=0x5,maxModelTokens:maxModelTokens=0x1f40,isFileUpload:isFileUpload=0x0,isConvertToBase64:_0x1ec485}=_0x48e05d;systemMessage[_0x6e25c5(0x27a)]>maxModelTokens&&(common_1[_0x6e25c5(0x259)][_0x6e25c5(0x212)]('系统消息超过最大长度，将被截断','ChatService'),systemMessage=systemMessage[_0x6e25c5(0x1c8)](0x0,maxModelTokens));let _0x31a42a=[];systemMessage&&_0x31a42a[_0x6e25c5(0x256)]({'role':'system','content':systemMessage});if(_0x3f70eb){const _0x408cbb=await _0x3c9667[_0x6e25c5(0x207)](_0x3f70eb,maxRounds);let _0x285e7a=null;for(const _0x354f4c of _0x408cbb){try{let _0x47773c;if((isFileUpload===0x2||isFileUpload===0x3)&&_0x354f4c[_0x6e25c5(0x1b5)]&&_0x354f4c[_0x6e25c5(0x1ae)]===_0x6e25c5(0x25b)){const _0x589718=await Promise[_0x6e25c5(0x216)](_0x354f4c[_0x6e25c5(0x1b5)][_0x6e25c5(0x26d)](',')[_0x6e25c5(0x23f)](async _0x451f46=>({'type':_0x6e25c5(0x1b3),'image_url':{'url':_0x1ec485==='1'?await this[_0x6e25c5(0x29a)](_0x451f46[_0x6e25c5(0x292)]()):_0x451f46[_0x6e25c5(0x292)]()}})));_0x47773c=[{'type':_0x6e25c5(0x2a3),'text':_0x354f4c['text']},..._0x589718];}else isFileUpload===0x1&&_0x354f4c[_0x6e25c5(0x1b5)]&&_0x354f4c['role']===_0x6e25c5(0x25b)?_0x47773c=_0x354f4c[_0x6e25c5(0x1b5)]+'\x0a'+_0x354f4c['text']:_0x47773c=_0x354f4c[_0x6e25c5(0x2a3)];if(_0x354f4c[_0x6e25c5(0x1ae)]==='user')_0x285e7a={'role':_0x354f4c[_0x6e25c5(0x1ae)],'content':_0x47773c};else{if(_0x354f4c[_0x6e25c5(0x1ae)]===_0x6e25c5(0x1f9)){const _0x7c4de4=Array['isArray'](_0x47773c)?JSON[_0x6e25c5(0x1c4)](_0x47773c):_0x47773c;_0x285e7a&&_0x7c4de4['trim']()!==''&&(_0x31a42a['push'](_0x285e7a),_0x31a42a[_0x6e25c5(0x256)]({'role':_0x354f4c[_0x6e25c5(0x1ae)],'content':_0x47773c}),_0x285e7a=null);}}}catch(_0x15175d){common_1[_0x6e25c5(0x259)]['error'](_0x6e25c5(0x232),_0x15175d,'记录:',JSON[_0x6e25c5(0x1c4)](_0x354f4c,null,0x2));}}}let _0x32a079;if((isFileUpload===0x2||isFileUpload===0x3)&&_0x37cd5e){const _0x275fbb=await Promise[_0x6e25c5(0x216)](_0x37cd5e[_0x6e25c5(0x26d)](',')[_0x6e25c5(0x23f)](async _0x5a0ccc=>({'type':_0x6e25c5(0x1b3),'image_url':{'url':_0x1ec485==='1'?await this[_0x6e25c5(0x29a)](_0x5a0ccc['trim']()):_0x5a0ccc['trim']()}})));_0x32a079=[{'type':_0x6e25c5(0x2a3),'text':_0xbee8b3},..._0x275fbb];}else isFileUpload===0x1&&_0x37cd5e?_0x32a079=_0x37cd5e+'\x0a'+_0xbee8b3:_0x32a079=_0xbee8b3;_0x31a42a[_0x6e25c5(0x256)]({'role':_0x6e25c5(0x25b),'content':_0x32a079});let _0x580585=await(0x0,utils_1[_0x6e25c5(0x1e4)])(_0x31a42a),_0x1e2dd1;maxModelTokens<0x1f40?_0x1e2dd1=0xfa0:_0x1e2dd1=maxModelTokens-0xfa0;while(_0x580585>_0x1e2dd1){if(_0x31a42a[_0x6e25c5(0x27a)]===0x2&&_0x31a42a[0x0]['role']===_0x6e25c5(0x258)&&_0x31a42a[0x1]['role']==='user')break;let _0x2f6fa1=![];for(let _0xfafe75=0x0;_0xfafe75<_0x31a42a[_0x6e25c5(0x27a)];_0xfafe75++){if(_0x31a42a[_0xfafe75][_0x6e25c5(0x1ae)]!==_0x6e25c5(0x258)&&_0x31a42a[_0xfafe75+0x1]&&_0x31a42a[_0xfafe75+0x1][_0x6e25c5(0x1ae)]===_0x6e25c5(0x1f9)){_0x31a42a[_0x6e25c5(0x2a5)](_0xfafe75,0x2),_0x2f6fa1=!![];break;}}if(!_0x2f6fa1)for(let _0xad484c=0x0;_0xad484c<_0x31a42a[_0x6e25c5(0x27a)];_0xad484c++){if(_0x31a42a[_0xad484c]['role']===_0x6e25c5(0x25b)){_0x31a42a[_0x6e25c5(0x2a5)](_0xad484c,0x1);break;}}_0x580585=await(0x0,utils_1['getTokenCount'])(_0x31a42a);if(_0x31a42a[_0x6e25c5(0x27a)]<=0x2)break;}return{'messagesHistory':_0x31a42a,'round':_0x31a42a[_0x6e25c5(0x27a)]};}async[_0x4ba8c6(0x29a)](_0x10a2e7){const _0x47e1fc=_0x4ba8c6;try{console['log']('正在尝试转换URL为Base64:\x20'+_0x10a2e7);const _0xfd1055=await axios_1[_0x47e1fc(0x1ff)]['get'](_0x10a2e7,{'responseType':_0x47e1fc(0x1ac)}),_0x275095=Buffer[_0x47e1fc(0x267)](_0xfd1055['data'],_0x47e1fc(0x241));console[_0x47e1fc(0x212)](_0x47e1fc(0x1fe)+_0x10a2e7);const _0x1a55d3=_0x47e1fc(0x2a0)+_0xfd1055[_0x47e1fc(0x1ba)][_0x47e1fc(0x21f)]+_0x47e1fc(0x239)+_0x275095[_0x47e1fc(0x279)](_0x47e1fc(0x21a));return console['log'](_0x47e1fc(0x270)+_0x10a2e7),_0x1a55d3;}catch(_0xa01d3f){return console[_0x47e1fc(0x21c)](_0x47e1fc(0x24b),_0xa01d3f),console[_0x47e1fc(0x221)](_0x47e1fc(0x20b)+_0x10a2e7),_0x10a2e7;}}async[_0x4ba8c6(0x2a1)](_0x93d262,_0x45a8fb,_0x47d23f){const _0x169604=_0x4ba8c6,{chatId:_0x26d81c,prompt:_0x3858b2}=_0x93d262,_0xf77ff5=await this[_0x169604(0x27d)]['getCurrentModelKeyInfo']('tts-1'),{openaiTimeout:_0x38a274,openaiBaseUrl:_0x41d324,openaiBaseKey:_0x2fdae9,openaiVoice:_0x4bab60}=await this[_0x169604(0x1f2)][_0x169604(0x1af)]([_0x169604(0x2a2),_0x169604(0x1bf),_0x169604(0x24f),'openaiVoice']),{key:_0x1bf6d8,proxyUrl:_0x13e210,deduct:_0x43d7a2,deductType:_0x4431b7,timeout:_0x7bdb65}=_0xf77ff5,_0x12ac15=_0x1bf6d8||_0x2fdae9,_0x1eeab5=(0x0,utils_1[_0x169604(0x23e)])(_0x13e210||_0x41d324),_0x2007fc=(_0x7bdb65||_0x38a274)*0x3e8;await this['userBalanceService']['validateBalance'](_0x45a8fb,_0x4431b7,_0x43d7a2),common_1['Logger'][_0x169604(0x212)](_0x169604(0x227),_0x3858b2,_0x169604(0x255));const _0x407311={'method':'POST','url':_0x1eeab5+_0x169604(0x29f),'headers':{'Content-Type':_0x169604(0x240),'Authorization':'Bearer\x20'+_0x12ac15},'responseType':_0x169604(0x1ac),'timeout':_0x2007fc,'data':{'model':_0x169604(0x22c),'input':_0x3858b2,'voice':_0x4bab60||_0x169604(0x29d)}};try{const _0x46e2b7=await(0x0,axios_1[_0x169604(0x1ff)])(_0x407311);common_1['Logger']['log'](_0x169604(0x28e),_0x169604(0x255));const _0x45707a=Buffer['from'](_0x46e2b7[_0x169604(0x1cb)]),_0xd88e8f=new Date(),_0x4a5dfd=_0xd88e8f[_0x169604(0x28f)](),_0xbcbbd6=String(_0xd88e8f[_0x169604(0x1b1)]()+0x1)[_0x169604(0x2ab)](0x2,'0'),_0x1acdec=String(_0xd88e8f[_0x169604(0x200)]())[_0x169604(0x2ab)](0x2,'0'),_0x5d3968=''+_0x4a5dfd+_0xbcbbd6+'/'+_0x1acdec,_0x26ae0c=await this[_0x169604(0x206)][_0x169604(0x20f)]({'buffer':_0x45707a,'mimetype':_0x169604(0x231)},_0x169604(0x283)+_0x5d3968);await Promise['all']([this[_0x169604(0x1ec)]['updateChatLog'](_0x26d81c,{'ttsUrl':_0x26ae0c}),this[_0x169604(0x1b8)][_0x169604(0x26b)](_0x45a8fb[_0x169604(0x25b)]['id'],_0x4431b7,_0x43d7a2)]),_0x47d23f['status'](0xc8)['send']({'ttsUrl':_0x26ae0c});}catch(_0x1c00f6){common_1[_0x169604(0x259)]['error']('TTS\x20请求或上传过程失败:',_0x1c00f6,_0x169604(0x255)),_0x47d23f['status'](0x1f4)['send']({'error':_0x169604(0x1cd)});}}};ChatService=__decorate([(0x0,common_1[_0x4ba8c6(0x203)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(config_entity_1['ConfigEntity'])),__param(0x1,(0x0,typeorm_1[_0x4ba8c6(0x26f)])(app_entity_1[_0x4ba8c6(0x286)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(plugin_entity_1['PluginEntity'])),__metadata(_0x4ba8c6(0x29b),[typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2['Repository'],suno_service_1[_0x4ba8c6(0x204)],openaiChat_service_1[_0x4ba8c6(0x1bc)],chatLog_service_1[_0x4ba8c6(0x225)],midjourneyDraw_service_1['MidjourneyService'],stableDiffusion_service_1['StableDiffusionService'],userBalance_service_1[_0x4ba8c6(0x1e5)],user_service_1[_0x4ba8c6(0x209)],upload_service_1[_0x4ba8c6(0x1ce)],badWords_service_1['BadWordsService'],autoreply_service_1[_0x4ba8c6(0x1b9)],globalConfig_service_1['GlobalConfigService'],chatGroup_service_1[_0x4ba8c6(0x252)],models_service_1['ModelsService'],openaiDraw_service_1['OpenAIDrawService'],lumaVideo_service_1[_0x4ba8c6(0x1db)],cogVideo_service_1[_0x4ba8c6(0x280)],fluxDraw_service_1[_0x4ba8c6(0x293)],aiPPT_1[_0x4ba8c6(0x1cf)]])],ChatService),exports[_0x4ba8c6(0x1c5)]=ChatService;function _0x3ba4(){const _0x28b4d0=['模型切换错误，请检查全局模型配置！','lumaVideo','https://api.openai.com','openAIChat','更新标题名称为:\x20','arraybuffer','338196MBtyUp','role','getConfigs','isConvertToBase64','getMonth','调用\x20chatFree\x20出错:\x20','image_url','生成失败','fileInfo','isSensitiveWordFilter','fluxDrawService','userBalanceService','AutoreplyService','headers','}，给这个对话取一个名字，不超过10个字','OpenAIChatService','openaiBaseModel','BAD_REQUEST','openaiBaseUrl','getGroupInfoFromId','6fuhusr','isSystemPlugin','getOwnPropertyDescriptor','stringify','ChatService','openaiTemperature','checkBadWords','slice','@nestjs/typeorm','autoreplyService','data','status','Failed\x20to\x20process\x20TTS\x20request','UploadService','AiPptService','../ai/lumaVideo.service','chatFree','插件调用错误:\x20','saveChatLog','../globalConfig/config.entity','未找到当前模型key，切换至全局模型','defineProperty','close','../chatLog/chatLog.service','发生未知错误，请稍后再试','catch','LumaVideoService','checkUserStatus','aiPptService','isGeneratePromptReference','\x20模型:\x20','TOO_MANY_REQUESTS','HttpException','\x20回复出错，本次不扣除积分','forEach','getTokenCount','UserBalanceService','1\x20小时内对话次数过多，请切换模型或稍后再试！','answer','开始生成PPT','__decorate','__param','100%','chatLogService','midjourneyDraw','pluginEntity','buildMessageFromParentMessageId','updateChatTitle','你当前使用的应用已被下架、请删除当前对话开启新的对话吧！','globalConfigService','ceil','appEntity','../autoreply/autoreply.service','error:\x20','以下是我提供给你的知识库：【','dall-e-3','assistant','@nestjs/common','配置解析错误！','object','../userBalance/userBalance.service','成功获取图片，正在转换为Base64:\x20','default','getDate','3754980hQpiDo','绘图失败','Injectable','SunoService','updateChatLog','uploadService','chatHistory','mjTranslatePrompt','UserService','checkAutoReply','返回原始链接:\x20','../app/app.entity','usePlugin','stableDiffusionService','uploadFile','validateBalance','2997392xmCOXS','log','../ai/aiPPT','../ai/midjourneyDraw.service','\x20消耗token:\x20','all','插件调用成功\x20返回结果:\x20','提交成功，视频生成中','openAIChatService','base64','HttpStatus','error','chat-error\x20<----------------------------------------->','assign','content-type','chatProcess','warn','modelName','chatGroupService','findOne','ChatLogService','】，在回答问题之前，先检索知识库内有没有相关的内容，尽量使用知识库中获取到的信息来回答我的问题，以知识库中的为准。','开始\x20TTS\x20请求:','任务提交失败，不执行扣费','}以及\x20AI\x20的回答{','5110YKLgAU','suno-music','tts-1','使用全局预设:\x20','使用应用预设:\x20','../models/models.service','luma-video','audio/mpeg','处理历史记录时出错:','errMsg','__metadata','处理请求时发生错误','根据用户提问{','axios','3926151OAIock',';base64,','end','绘制中','Bearer\x20','更新对话组标题失败:\x20','formatUrl','map','application/json','binary','checkModelLimits','metadata','modelInfo','debug','preset','typeorm','ai-ppt','固定模型、使用应用预设:\x20','Translate\x20any\x20given\x20phrase\x20from\x20any\x20language\x20into\x20English.\x20For\x20instance,\x20when\x20I\x20input\x20\x27{可爱的熊猫}\x27,\x20you\x20should\x20output\x20\x27{cute\x20panda}\x27,\x20with\x20no\x20period\x20at\x20the\x20end.','转换URL为Base64时发生错误:','../globalConfig/globalConfig.service','提交成功，歌曲生成中','cogVideoService','openaiBaseKey','parameters','aiPPT','ChatGroupService','userService','function','TTSService','push','../chatGroup/chatGroup.service','system','Logger','../ai/fluxDraw.service','user','}，生成三个更进入一步的提问，用{}包裹每个问题，不需要分行，不需要其他任何内容，单个提问不超过30个字','sdxl','../upload/upload.service','replace','../user/user.service','decorate','__esModule','../plugin/plugin.entity','systemPreMessage','getClientIp','abort','from','content','dalleDraw','使用文件解析:\x20','deductFromBalance','70158masgEc','split','write','InjectRepository','成功转换URL为Base64:\x20','suno','toISOString','stable-diffusion','application/octet-stream;\x20charset=utf-8','join','midjourney','8DegxKT','UPSCALE','toString','length','新对话','fluxDraw','modelsService','flux','sunoService','CogVideoService','1610497KcjHmD','178813YNSduh','audio/openai/','userBalance','parse','AppEntity','getCurrentModelKeyInfo','pluginUrl','POST','isAIReplyEnabled','saveUseLog','../../common/utils','使用插件预设:\x20','TTS\x20请求获取成功','getFullYear','update','/plugins/','trim','FluxDrawService','includes','用户ID:\x20','badWordsService','\x20模型名称:\x20','queryUserBalance','openAIDrawService','convertUrlToBase64','design:paramtypes','26kRFJQd','onyx','model','/v1/audio/speech','data:','ttsProcess','openaiTimeout','text','../ai/cogVideo.service','splice',',\x20消耗积分：\x20','title','../ai/suno.service','config','../ai/openaiChat.service','padStart'];_0x3ba4=function(){return _0x28b4d0;};return _0x3ba4();}