'use strict';function _0x2e98(){const _0x3400ae=['18eEgEJS','6516FUmGxe','isArray','113722LRIZpO','arraybuffer','POST','openaiTemperature','checkModelLimits','stableDiffusionService','}，给这个对话取一个名字，不超过10个字','getConfigs','@nestjs/common','axios','MidjourneyService','1\x20小时内对话次数过多，请切换模型或稍后再试！','userBalance','binary',',\x20消耗积分：\x20','chatFree','UserBalanceService','function','push','ceil','setHeader','validateBalance','../chatLog/chatLog.service','Failed\x20to\x20process\x20TTS\x20request','toISOString','../ai/aiPPT','status','convertUrlToBase64','image_url','发生未知错误，请稍后再试','chat-error\x20<----------------------------------------->','lumaVideo','pluginUrl','openaiVoice','updateChatLog','badWordsService','split','openAIChat','globalConfigService','data','../chatGroup/chatGroup.service','chatHistory','../upload/upload.service','DrawService','splice','checkBadWords','FluxDrawService','固定模型、使用应用预设:\x20','\x20模型:\x20','openaiBaseKey','使用全局预设:\x20','preset','close','error:\x20','audio/openai/','chatProcess','config','getGroupInfoFromId','__decorate','1685229dvRlQh','GlobalConfigService','绘制中','application/json','../ai/fluxDraw.service','getOwnPropertyDescriptor','model','buildMessageFromParentMessageId','debug','modelName','}，生成三个更进入一步的提问，用{}包裹每个问题，不需要分行，不需要其他任何内容，单个提问不超过30个字','text','/v1/audio/speech','onyx','Bearer\x20','saveUseLog','你当前使用的应用已被下架、请删除当前对话开启新的对话吧！','Content-type','parameters','更新对话组标题失败:\x20','autoreplyService','object','update','modelInfo','__metadata','includes','suno-music','updateChatTitle','提交成功，歌曲生成中','CogVideoService','处理历史记录时出错:','lumaVideoService','then','TTSService','../badWords/badWords.service','formatUrl','suno','map','checkUserStatus','repeat','转换URL为Base64时发生错误:','openAIChatService','记录:','answer','padStart','正在尝试转换URL为Base64:\x20','user','PluginEntity','100%','../ai/midjourneyDraw.service','调用\x20chatFree\x20出错:\x20','gpts','ChatService','sdxl','cogVideoService','flux','BadWordsService','openAIDrawService','13KmPwEc','发生错误:','PluginService','】，在回答问题之前，先检索知识库内有没有相关的内容，尽量使用知识库中获取到的信息来回答我的问题，以知识库中的为准。','OpenAIDrawService','end','midjourney','system','pluginEntity','aiPptService','getFullYear','8plOTXB','send','30552dIEnIq','955ItcCRj','\x0a\x20Current\x20date:\x20','\x20模型名称:\x20','openaiBaseModel','stable-diffusion','BAD_REQUEST','queryUserBalance','处理请求时发生错误','usePlugin','assign','../globalConfig/config.entity','parse','checkAutoReply','replace','新对话','开始\x20TTS\x20请求:','isAIReplyEnabled','61KVsmQd','插件调用错误:\x20','@nestjs/typeorm','../../common/utils','AutoreplyService','match','updateTime','get','deductFromBalance','role','userBalanceService','AppEntity','ai-ppt','../ai/stableDiffusion.service','用户ID:\x20','assistant','cogVideo','InjectRepository','../ai/openaiChat.service','根据用户提问{','pluginImg','decorate','dalleDraw','返回原始链接:\x20','userService','modelsService','sunoService','midjourneyService','getTokenCount','base64','getClientIp','../plugin/plugin.entity','以下是我提供给你的知识库：【','default','midjourneyDraw','模型切换错误，请检查全局模型配置！','cog-video','all','ModelsService','6800070lGnRby','UploadService','chatLogService','您提交的信息中包含违规的内容，我们已对您的账户进行标记，请合规使用！','aiPPT','forEach','ChatLogService','Logger','length','}以及\x20AI\x20的回答{','任务提交失败，不执行扣费','https://api.openai.com','dall-e-3','isSensitiveWordFilter','audio/mpeg','../ai/cogVideo.service','getCurrentModelKeyInfo','isConvertToBase64','HttpStatus','5614KQXucU','data:','errMsg','提交成功，视频生成中','TTS\x20请求获取成功','Translate\x20any\x20given\x20phrase\x20from\x20any\x20language\x20into\x20English.\x20For\x20instance,\x20when\x20I\x20input\x20\x27{可爱的熊猫}\x27,\x20you\x20should\x20output\x20\x27{cute\x20panda}\x27,\x20with\x20no\x20period\x20at\x20the\x20end.','插件返回结果:\x20','使用插件预设:\x20','isSystemPlugin','SunoService','uploadService','stringify','headers','write','ChatGroupService','fluxDraw','__esModule','log','openaiBaseUrl','Repository','getMonth','chatGroupService','application/octet-stream;\x20charset=utf-8',';base64,','from','isMjTranslate','join','luma-video','appEntity','fileInfo','\x20回复出错，本次不扣除积分','ttsProcess','Injectable','../userBalance/userBalance.service','error','../ai/suno.service','ConfigEntity','title','fluxDrawService','开始生成PPT','AiPptService','findOne','成功获取图片，正在转换为Base64:\x20','8646ouiWgs','toString','HttpException','978zvVusA','getDate','checkUserCertification','trim','13316WEwMQM'];_0x2e98=function(){return _0x3400ae;};return _0x2e98();}const _0x5384be=_0x58e5;function _0x58e5(_0x4d3e85,_0xbcd300){const _0x2e9889=_0x2e98();return _0x58e5=function(_0x58e599,_0x543fad){_0x58e599=_0x58e599-0x171;let _0x2d99a2=_0x2e9889[_0x58e599];return _0x2d99a2;},_0x58e5(_0x4d3e85,_0xbcd300);}(function(_0x86ad96,_0x5d6def){const _0x23e980=_0x58e5,_0x2d9dc3=_0x86ad96();while(!![]){try{const _0x507f89=parseInt(_0x23e980(0x26b))/0x1*(-parseInt(_0x23e980(0x1a1))/0x2)+-parseInt(_0x23e980(0x1cf))/0x3*(parseInt(_0x23e980(0x1d3))/0x4)+-parseInt(_0x23e980(0x25a))/0x5*(-parseInt(_0x23e980(0x259))/0x6)+-parseInt(_0x23e980(0x212))/0x7*(-parseInt(_0x23e980(0x257))/0x8)+parseInt(_0x23e980(0x1d4))/0x9*(parseInt(_0x23e980(0x18e))/0xa)+parseInt(_0x23e980(0x1cc))/0xb*(-parseInt(_0x23e980(0x1d5))/0xc)+parseInt(_0x23e980(0x24c))/0xd*(-parseInt(_0x23e980(0x1d7))/0xe);if(_0x507f89===_0x5d6def)break;else _0x2d9dc3['push'](_0x2d9dc3['shift']());}catch(_0x21f6a3){_0x2d9dc3['push'](_0x2d9dc3['shift']());}}}(_0x2e98,0xd750b));var __decorate=this&&this[_0x5384be(0x211)]||function(_0x3f1cee,_0x1dcb16,_0x474c11,_0x4f9bef){const _0x1ca351=_0x5384be;var _0x17c279=arguments[_0x1ca351(0x196)],_0x91aa84=_0x17c279<0x3?_0x1dcb16:_0x4f9bef===null?_0x4f9bef=Object[_0x1ca351(0x217)](_0x1dcb16,_0x474c11):_0x4f9bef,_0x18888c;if(typeof Reflect===_0x1ca351(0x227)&&typeof Reflect[_0x1ca351(0x17c)]===_0x1ca351(0x1e8))_0x91aa84=Reflect['decorate'](_0x3f1cee,_0x1dcb16,_0x474c11,_0x4f9bef);else{for(var _0x71bae3=_0x3f1cee[_0x1ca351(0x196)]-0x1;_0x71bae3>=0x0;_0x71bae3--)if(_0x18888c=_0x3f1cee[_0x71bae3])_0x91aa84=(_0x17c279<0x3?_0x18888c(_0x91aa84):_0x17c279>0x3?_0x18888c(_0x1dcb16,_0x474c11,_0x91aa84):_0x18888c(_0x1dcb16,_0x474c11))||_0x91aa84;}return _0x17c279>0x3&&_0x91aa84&&Object['defineProperty'](_0x1dcb16,_0x474c11,_0x91aa84),_0x91aa84;},__metadata=this&&this[_0x5384be(0x22a)]||function(_0x2a7451,_0x1601f7){const _0x27640c=_0x5384be;if(typeof Reflect==='object'&&typeof Reflect['metadata']===_0x27640c(0x1e8))return Reflect['metadata'](_0x2a7451,_0x1601f7);},__param=this&&this['__param']||function(_0x53c0d3,_0x2b9ac9){return function(_0x37c182,_0x3b7cd6){_0x2b9ac9(_0x37c182,_0x3b7cd6,_0x53c0d3);};};Object['defineProperty'](exports,_0x5384be(0x1b1),{'value':!![]}),exports[_0x5384be(0x246)]=void 0x0;const utils_1=require(_0x5384be(0x26e)),common_1=require(_0x5384be(0x1df)),typeorm_1=require(_0x5384be(0x26d)),axios_1=require(_0x5384be(0x1e0)),typeorm_2=require('typeorm'),aiPPT_1=require(_0x5384be(0x1f0)),cogVideo_service_1=require(_0x5384be(0x19d)),fluxDraw_service_1=require(_0x5384be(0x216)),lumaVideo_service_1=require('../ai/lumaVideo.service'),midjourneyDraw_service_1=require(_0x5384be(0x243)),openaiChat_service_1=require(_0x5384be(0x179)),openaiDraw_service_1=require('../ai/openaiDraw.service'),stableDiffusion_service_1=require(_0x5384be(0x174)),suno_service_1=require(_0x5384be(0x1c4)),app_entity_1=require('../app/app.entity'),autoreply_service_1=require('../autoreply/autoreply.service'),badWords_service_1=require(_0x5384be(0x234)),chatGroup_service_1=require(_0x5384be(0x1ff)),chatLog_service_1=require(_0x5384be(0x1ed)),config_entity_1=require(_0x5384be(0x264)),globalConfig_service_1=require('../globalConfig/globalConfig.service'),models_service_1=require('../models/models.service'),plugin_entity_1=require(_0x5384be(0x186)),upload_service_1=require(_0x5384be(0x201)),user_service_1=require('../user/user.service'),userBalance_service_1=require(_0x5384be(0x1c2));let ChatService=class ChatService{constructor(_0x258916,_0x1371bd,_0x316112,_0xadf3da,_0x3f8405,_0x3f955d,_0x23d5ad,_0x4bfb5e,_0xe27cc8,_0x42e399,_0x13a15c,_0x58a9d1,_0x4450c4,_0x2a4cce,_0xec35c9,_0x24f3bb,_0x2ba4cf,_0x56f5ef,_0x436a11,_0x3ec641,_0x51722d){const _0x247134=_0x5384be;this['configEntity']=_0x258916,this['appEntity']=_0x1371bd,this['pluginEntity']=_0x316112,this[_0x247134(0x181)]=_0xadf3da,this['openAIChatService']=_0x3f8405,this[_0x247134(0x190)]=_0x3f955d,this[_0x247134(0x182)]=_0x23d5ad,this[_0x247134(0x1dc)]=_0x4bfb5e,this['userBalanceService']=_0xe27cc8,this[_0x247134(0x17f)]=_0x42e399,this['uploadService']=_0x13a15c,this['badWordsService']=_0x58a9d1,this[_0x247134(0x226)]=_0x4450c4,this[_0x247134(0x1fd)]=_0x2a4cce,this[_0x247134(0x1b6)]=_0xec35c9,this[_0x247134(0x180)]=_0x24f3bb,this['openAIDrawService']=_0x2ba4cf,this[_0x247134(0x231)]=_0x56f5ef,this[_0x247134(0x248)]=_0x436a11,this['fluxDrawService']=_0x3ec641,this['aiPptService']=_0x51722d;}async[_0x5384be(0x20e)](_0x4731a0,_0x3dbaf6,_0x53245c){const _0x450634=_0x5384be;await this['userBalanceService'][_0x450634(0x1d1)](_0x3dbaf6['user']['id']);const {options:options={},usingPluginId:_0x40fb4c,appId:appId=null,specialModel:_0x46cce5,prompt:_0x492657,fileInfo:_0x361e50,extraParam:_0x14b6fa,model:_0x442987,drawId:_0x59d283,customId:_0x16de0e,action:_0x140cd5,modelName:_0x38f6e1,modelAvatar:_0x5e9646}=_0x4731a0;let _0x8ef275;if(_0x46cce5)_0x8ef275=await this[_0x450634(0x1bd)][_0x450634(0x1ca)]({'where':{'des':_0x46cce5,'isSystemReserved':!![]}});else{if(appId){_0x8ef275=await this[_0x450634(0x1bd)][_0x450634(0x1ca)]({'where':{'id':appId,'status':(0x0,typeorm_2['In'])([0x1,0x3,0x4,0x5])}});if(!_0x8ef275)throw new common_1[(_0x450634(0x1ce))](_0x450634(0x222),common_1[_0x450634(0x1a0)][_0x450634(0x25f)]);}}const {groupId:_0x53b1a6,fileParsing:_0x5829b5}=options,{openaiTimeout:_0xf887c6,openaiBaseUrl:_0x45d3b5,openaiBaseKey:_0x13d1e7,systemPreMessage:_0x20f992,isMjTranslate:_0x31b74b,mjTranslatePrompt:_0x27be24,openaiTemperature:_0x27584f,openaiBaseModel:_0x2a30ef,isGeneratePromptReference:_0x189fd1,isConvertToBase64:_0x422d3c,isSensitiveWordFilter:_0x55fbcb}=await this['globalConfigService'][_0x450634(0x1de)](['openaiTimeout',_0x450634(0x1b3),'openaiBaseKey','systemPreMessage',_0x450634(0x1ba),'mjTranslatePrompt',_0x450634(0x1da),_0x450634(0x25d),'isGeneratePromptReference',_0x450634(0x19f),_0x450634(0x19b)]);await this['userService'][_0x450634(0x238)](_0x3dbaf6['user']),_0x53245c&&_0x53245c[_0x450634(0x1eb)](_0x450634(0x223),_0x450634(0x1b7));if(_0x55fbcb==='1'){const _0x5a4e3d=await this['badWordsService']['checkBadWords'](_0x492657,_0x3dbaf6[_0x450634(0x240)]['id']);if(_0x5a4e3d[_0x450634(0x196)]>0x0){const _0x4b64de=_0x450634(0x191);throw new common_1['HttpException'](_0x4b64de,common_1[_0x450634(0x1a0)][_0x450634(0x25f)]);}}const _0x3c20e5=await this[_0x450634(0x226)][_0x450634(0x266)](_0x492657);let _0x501df7=null,_0x4e714f='',_0x37ff1c='';_0x53245c&&_0x53245c['status'](0xc8);let _0x2248f3=null;const _0x5f0a42=(0x0,utils_1[_0x450634(0x185)])(_0x3dbaf6);let _0x2e8929,_0xe7ce38='',_0x5c9ae2;_0x40fb4c&&(_0x5c9ae2=await this[_0x450634(0x254)]['findOne']({'where':{'id':_0x40fb4c}}));if(_0x8ef275){const {isGPTs:_0x17c84a,gizmoID:_0x42d3e5,name:_0x2ce614,isFixedModel:_0x16ed9e,appModel:_0x12d14b,coverImg:_0xc2f340}=_0x8ef275;_0xe7ce38=_0xc2f340,_0x4e714f=_0x2ce614;if(_0x17c84a)_0x501df7=await this[_0x450634(0x180)][_0x450634(0x19e)](_0x450634(0x245)),_0x501df7['model']='gpt-4-gizmo-'+_0x42d3e5;else!_0x17c84a&&_0x16ed9e&&_0x12d14b?(_0x8ef275['preset']&&(_0x37ff1c=_0x8ef275[_0x450634(0x20a)]),_0x501df7=await this['modelsService']['getCurrentModelKeyInfo'](_0x12d14b),_0x501df7[_0x450634(0x218)]=_0x12d14b,_0x5829b5&&(_0x37ff1c=_0x37ff1c+_0x450634(0x187)+_0x5829b5+_0x450634(0x24f)),common_1[_0x450634(0x195)]['log'](_0x450634(0x206)+_0x37ff1c,_0x450634(0x246))):(_0x8ef275[_0x450634(0x20a)]&&(_0x37ff1c=_0x8ef275[_0x450634(0x20a)]),_0x501df7=await this[_0x450634(0x180)]['getCurrentModelKeyInfo'](_0x442987),_0x5829b5&&(_0x37ff1c=_0x37ff1c+'以下是我提供给你的知识库：【'+_0x5829b5+_0x450634(0x24f)),common_1[_0x450634(0x195)][_0x450634(0x1b2)]('使用应用预设:\x20'+_0x37ff1c,_0x450634(0x246)));}else{const _0x3113d8=await this[_0x450634(0x1b6)][_0x450634(0x210)](_0x53b1a6);if(_0x5c9ae2&&_0x5c9ae2[_0x450634(0x1a9)]===0x0){let _0x3f9bda='';try{_0x3f9bda=await this[_0x450634(0x262)](_0x492657,_0x5c9ae2[_0x450634(0x224)]),common_1[_0x450634(0x195)][_0x450634(0x1b2)](_0x450634(0x1a7)+_0x3f9bda,_0x450634(0x246));}catch(_0x4f5348){_0x3f9bda=_0x492657,common_1[_0x450634(0x195)][_0x450634(0x1c3)](_0x450634(0x26c)+_0x4f5348);}_0x37ff1c=_0x3f9bda,_0x501df7=await this[_0x450634(0x180)][_0x450634(0x19e)](_0x442987),common_1[_0x450634(0x195)]['log'](_0x450634(0x1a8)+_0x37ff1c,_0x450634(0x246));}else{if(_0x5829b5)_0x37ff1c=_0x450634(0x187)+_0x5829b5+_0x450634(0x24f),_0x501df7=await this[_0x450634(0x180)][_0x450634(0x19e)](_0x442987),common_1[_0x450634(0x195)]['log']('使用文件解析:\x20'+_0x37ff1c,_0x450634(0x246));else{const _0x3e9023=new Date()[_0x450634(0x1ef)]()['split']('T')[0x0];_0x37ff1c=_0x20f992+(_0x450634(0x25b)+_0x3e9023),_0x501df7=await this[_0x450634(0x180)][_0x450634(0x19e)](_0x442987),common_1[_0x450634(0x195)][_0x450634(0x1b2)](_0x450634(0x209)+_0x37ff1c,_0x450634(0x246));}}}if(!_0x501df7){common_1[_0x450634(0x195)][_0x450634(0x21a)]('未找到当前模型key，切换至全局模型',_0x450634(0x246)),_0x501df7=await this[_0x450634(0x180)][_0x450634(0x19e)](_0x2a30ef);const _0x489944=await this[_0x450634(0x1b6)][_0x450634(0x210)](_0x53b1a6);let _0x21ae7e=_0x489944['config'];try{const _0x590235=JSON[_0x450634(0x265)](_0x489944[_0x450634(0x20f)]);_0x590235[_0x450634(0x229)]&&(_0x590235[_0x450634(0x229)]['modelName']=_0x501df7[_0x450634(0x21b)],_0x590235['modelInfo'][_0x450634(0x218)]=_0x501df7[_0x450634(0x218)],_0x21ae7e=JSON[_0x450634(0x1ac)](_0x590235));}catch(_0x14de63){common_1['Logger'][_0x450634(0x21a)](_0x450634(0x18a),_0x450634(0x246));throw new common_1[(_0x450634(0x1ce))]('配置解析错误！',common_1['HttpStatus'][_0x450634(0x25f)]);}await this[_0x450634(0x1b6)][_0x450634(0x228)]({'groupId':_0x53b1a6,'title':_0x489944[_0x450634(0x1c6)],'isSticky':![],'config':_0x21ae7e,'fileUrl':''},_0x3dbaf6);}const {deduct:_0x18e7ac,isTokenBased:_0x443fc7,tokenFeeRatio:_0x5b91b4,deductType:_0xb98957,key:_0x19663d,id:_0x51cf54,maxRounds:_0xc100ab,proxyUrl:_0x5e65da,maxModelTokens:_0x367ffc,timeout:_0x4c6f7d,model:_0x2ea8c6,isFileUpload:_0x2c4923,keyType:_0x372085}=_0x501df7;if(await this[_0x450634(0x190)][_0x450634(0x1db)](_0x3dbaf6[_0x450634(0x240)],_0x2ea8c6))throw new common_1['HttpException'](_0x450634(0x1e2),common_1[_0x450634(0x1a0)]['TOO_MANY_REQUESTS']);if(_0x31b74b==='1'&&_0x140cd5==='IMAGINE'&&_0x442987===_0x450634(0x252)){const [_0x2df396,_0x2cc52c]=_0x492657['split'](/(?= --)/),_0x239c5f=/(https?:\/\/[^\s]+)/g,_0x271fdf=_0x2df396[_0x450634(0x270)](_0x239c5f)||[];let _0x473aa6=_0x2df396['replace'](_0x239c5f,'')[_0x450634(0x1d2)]();const _0x5aa14d=await this['openAIChatService'][_0x450634(0x1e6)](_0x473aa6,_0x27be24||_0x450634(0x1a6)),_0x16859f=[..._0x271fdf,_0x5aa14d][_0x450634(0x1bb)]('\x20')[_0x450634(0x1d2)]();_0x2e8929=_0x2cc52c?''+_0x16859f+_0x2cc52c:_0x16859f,_0x2c4923==='1'&&_0x361e50&&(_0x2e8929=_0x361e50+'\x20'+_0x2e8929);}else _0x2e8929=_0x2c4923==='1'&&_0x361e50?_0x361e50+'\x20'+_0x492657:_0x492657;await this[_0x450634(0x171)]['validateBalance'](_0x3dbaf6,_0xb98957,_0x18e7ac);const _0x4addac=_0x38f6e1,_0x2ac3c4=(0x0,utils_1[_0x450634(0x235)])(_0x5e65da||_0x45d3b5||_0x450634(0x199)),_0x1b607d=_0x19663d||_0x13d1e7,_0xe71897=(_0x4c6f7d||_0xf887c6||0x12c)*0x3e8,_0xa63a88=Number(_0x27584f)||0x1;if(_0x53b1a6){const _0x3f457b=await this['chatGroupService']['getGroupInfoFromId'](_0x53b1a6);this[_0x450634(0x22d)](_0x53b1a6,_0x3f457b,_0x372085,_0x492657,_0x3dbaf6),await this['chatGroupService'][_0x450634(0x271)](_0x53b1a6);}const _0x2aecd2=await this['chatLogService']['saveChatLog']({'appId':appId,'curIp':_0x5f0a42,'userId':_0x3dbaf6[_0x450634(0x240)]['id'],'type':_0x372085?_0x372085:0x1,'prompt':_0x492657,'fileInfo':_0x361e50?_0x361e50:null,'answer':'','promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x2ea8c6,'modelName':'我','role':_0x450634(0x240),'groupId':_0x53b1a6?_0x53b1a6:null}),_0x5b9a68=await this[_0x450634(0x190)]['saveChatLog']({'appId':appId?appId:null,'action':_0x140cd5?_0x140cd5:null,'curIp':_0x5f0a42,'userId':_0x3dbaf6['user']['id'],'type':_0x372085?_0x372085:0x1,'prompt':_0x492657,'fileInfo':null,'answer':'','progress':'0%','promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x2ea8c6,'modelName':_0x4addac,'role':_0x450634(0x176),'groupId':_0x53b1a6?_0x53b1a6:null,'status':0x2,'modelAvatar':(_0x5c9ae2===null||_0x5c9ae2===void 0x0?void 0x0:_0x5c9ae2[_0x450634(0x17b)])||_0xe7ce38||_0x5e9646||'','pluginParam':(_0x5c9ae2===null||_0x5c9ae2===void 0x0?void 0x0:_0x5c9ae2[_0x450634(0x224)])?_0x5c9ae2[_0x450634(0x224)]:_0x372085===0x2?_0x2ea8c6:null}),_0xd98cde=_0x2aecd2['id'],_0x4546eb=_0x5b9a68['id'];if(_0x3c20e5[_0x450634(0x23d)]&&_0x53245c){if(_0x3c20e5[_0x450634(0x26a)]===0x0){const _0x54ca03=_0x3c20e5['answer'][_0x450634(0x1fb)](''),_0x4bc02e=_0x17b495=>{const _0x1c8fe5=_0x450634;if(_0x17b495<_0x54ca03[_0x1c8fe5(0x196)]){const _0x4e8b5c={'text':_0x54ca03[_0x17b495]};_0x53245c[_0x1c8fe5(0x1ae)](JSON['stringify'](_0x4e8b5c)+'\x0a'),setTimeout(()=>_0x4bc02e(_0x17b495+0x1),0xa);}else _0x53245c[_0x1c8fe5(0x251)]();};_0x4bc02e(0x0),await this[_0x450634(0x190)]['updateChatLog'](_0x4546eb,{'answer':_0x3c20e5[_0x450634(0x23d)]});return;}else _0x37ff1c=_0x37ff1c+_0x3c20e5[_0x450634(0x23d)];}const {messagesHistory:_0x59c35c}=await this[_0x450634(0x219)](_0x492657,{'groupId':_0x53b1a6,'systemMessage':_0x37ff1c,'maxModelTokens':_0x367ffc,'maxRounds':_0xc100ab,'isConvertToBase64':_0x422d3c,'fileInfo':_0x361e50,'model':_0x2ea8c6,'isFileUpload':_0x2c4923},this['chatLogService']);let _0x1f19f1=_0x140cd5!=='UPSCALE'&&_0x2ea8c6==='midjourney'?_0x18e7ac*0x4:_0x18e7ac;const _0x39ba2c=new AbortController();try{if(_0x53245c){_0x53245c['on'](_0x450634(0x20b),()=>{_0x39ba2c['abort']();});let _0x4809bf,_0x4c571a=!![];try{if((_0x2ea8c6===_0x450634(0x19a)||_0x2ea8c6===_0x450634(0x252)||_0x2ea8c6===_0x450634(0x173)||_0x2ea8c6===_0x450634(0x22c)||_0x2ea8c6===_0x450634(0x1bc)||_0x2ea8c6['includes']('stable-diffusion')||_0x2ea8c6[_0x450634(0x22b)](_0x450634(0x18b))||_0x2ea8c6[_0x450634(0x22b)](_0x450634(0x249)))&&_0x372085===0x2){if(_0x2ea8c6==='dall-e-3')_0x4809bf=this[_0x450634(0x24b)][_0x450634(0x17d)]({'prompt':_0x492657,'extraParam':_0x14b6fa,'apiKey':_0x1b607d,'proxyUrl':_0x2ac3c4,'model':_0x2ea8c6,'timeout':_0xe71897,'modelName':_0x4addac,'groupId':_0x53b1a6,'onSuccess':async _0x2fefc3=>{const _0xb0f882=_0x450634;await this['chatLogService'][_0xb0f882(0x1f9)](_0x4546eb,{'fileInfo':_0x2fefc3===null||_0x2fefc3===void 0x0?void 0x0:_0x2fefc3[_0xb0f882(0x1be)],'answer':(_0x2fefc3===null||_0x2fefc3===void 0x0?void 0x0:_0x2fefc3[_0xb0f882(0x23d)])||_0x492657,'progress':_0xb0f882(0x242),'status':_0x2fefc3[_0xb0f882(0x1f1)]});},'onFailure':async _0x1faf47=>{const _0x2a988e=_0x450634;await this[_0x2a988e(0x190)]['updateChatLog'](_0x4546eb,{'answer':'绘图失败','status':_0x1faf47[_0x2a988e(0x1f1)]});}},this[_0x450634(0x219)]),await this[_0x450634(0x190)][_0x450634(0x1f9)](_0x4546eb,{'answer':_0x450634(0x214)});else{if(_0x2ea8c6===_0x450634(0x173))common_1[_0x450634(0x195)][_0x450634(0x1b2)](_0x450634(0x1c8),_0x450634(0x202)),_0x4809bf=this[_0x450634(0x255)][_0x450634(0x192)]({'usePrompt':_0x2e8929,'prompt':_0x492657,'apiKey':_0x1b607d,'proxyUrl':_0x2ac3c4,'model':_0x2ea8c6,'modelName':_0x4addac,'drawId':_0x59d283,'customId':_0x16de0e,'action':_0x140cd5,'timeout':_0xe71897,'assistantLogId':_0x4546eb,'extraParam':_0x14b6fa,'fileInfo':_0x361e50}),await this[_0x450634(0x190)]['updateChatLog'](_0x4546eb,{'answer':'生成中'});else{if(_0x2ea8c6[_0x450634(0x22b)](_0x450634(0x249)))_0x4809bf=this[_0x450634(0x1c7)][_0x450634(0x1b0)]({'prompt':_0x492657,'extraParam':_0x14b6fa,'apiKey':_0x1b607d,'proxyUrl':_0x2ac3c4,'model':_0x2ea8c6,'timeout':_0xe71897,'modelName':_0x4addac,'groupId':_0x53b1a6,'onSuccess':async _0x5a9803=>{const _0x28b5a2=_0x450634;await this[_0x28b5a2(0x190)][_0x28b5a2(0x1f9)](_0x4546eb,{'fileInfo':_0x5a9803===null||_0x5a9803===void 0x0?void 0x0:_0x5a9803[_0x28b5a2(0x1be)],'answer':(_0x5a9803===null||_0x5a9803===void 0x0?void 0x0:_0x5a9803[_0x28b5a2(0x23d)])||_0x492657,'progress':_0x28b5a2(0x242),'status':_0x5a9803[_0x28b5a2(0x1f1)]});},'onFailure':async _0x1e6ae2=>{const _0x44466d=_0x450634;await this['chatLogService'][_0x44466d(0x1f9)](_0x4546eb,{'answer':'绘图失败','status':_0x1e6ae2[_0x44466d(0x1f1)]});}},this[_0x450634(0x219)]),await this[_0x450634(0x190)][_0x450634(0x1f9)](_0x4546eb,{'answer':_0x450634(0x214)});else{if(_0x2ea8c6[_0x450634(0x22b)](_0x450634(0x22c)))_0x4809bf=this['sunoService'][_0x450634(0x236)]({'assistantLogId':_0x4546eb,'apiKey':_0x1b607d,'action':_0x140cd5,'prompt':_0x492657,'timeout':_0xe71897,'proxyUrl':_0x2ac3c4,'taskData':_0x16de0e}),await this[_0x450634(0x190)]['updateChatLog'](_0x4546eb,{'answer':_0x450634(0x22e)});else{if(_0x2ea8c6['includes'](_0x450634(0x1bc)))_0x4809bf=this[_0x450634(0x231)][_0x450634(0x1f6)]({'fileInfo':_0x361e50,'extraParam':_0x14b6fa,'assistantLogId':_0x4546eb,'apiKey':_0x1b607d,'action':_0x140cd5,'prompt':_0x492657,'model':_0x2ea8c6,'timeout':_0xe71897,'proxyUrl':_0x2ac3c4,'taskData':_0x16de0e,'onGenerate':async _0x40e9ce=>{const _0x1022ba=_0x450634;await this[_0x1022ba(0x190)][_0x1022ba(0x1f9)](_0x4546eb,{'fileInfo':_0x40e9ce===null||_0x40e9ce===void 0x0?void 0x0:_0x40e9ce['fileInfo'],'answer':(_0x40e9ce===null||_0x40e9ce===void 0x0?void 0x0:_0x40e9ce[_0x1022ba(0x23d)])||_0x492657,'status':0x2});},'onSuccess':async _0x5bf13d=>{const _0x1bcc4e=_0x450634;await this[_0x1bcc4e(0x190)]['updateChatLog'](_0x4546eb,{'fileInfo':_0x5bf13d===null||_0x5bf13d===void 0x0?void 0x0:_0x5bf13d['fileInfo'],'answer':(_0x5bf13d===null||_0x5bf13d===void 0x0?void 0x0:_0x5bf13d['answer'])||_0x492657,'progress':_0x1bcc4e(0x242),'status':0x3});},'onFailure':async _0x4d5bd5=>{const _0x58c44e=_0x450634;await this['chatLogService'][_0x58c44e(0x1f9)](_0x4546eb,{'answer':_0x4d5bd5[_0x58c44e(0x1a3)],'status':0x4});}}),await this['chatLogService'][_0x450634(0x1f9)](_0x4546eb,{'answer':_0x450634(0x1a4)});else{if(_0x2ea8c6['includes'](_0x450634(0x18b)))_0x4809bf=this[_0x450634(0x248)][_0x450634(0x177)]({'fileInfo':_0x361e50,'extraParam':_0x14b6fa,'assistantLogId':_0x4546eb,'apiKey':_0x1b607d,'action':_0x140cd5,'prompt':_0x492657,'model':_0x2ea8c6,'timeout':_0xe71897,'proxyUrl':_0x2ac3c4,'taskData':_0x16de0e,'onGenerate':async _0x122fc9=>{const _0x2a9aea=_0x450634;await this[_0x2a9aea(0x190)][_0x2a9aea(0x1f9)](_0x4546eb,{'fileInfo':_0x122fc9===null||_0x122fc9===void 0x0?void 0x0:_0x122fc9['fileInfo'],'answer':(_0x122fc9===null||_0x122fc9===void 0x0?void 0x0:_0x122fc9[_0x2a9aea(0x23d)])||_0x492657,'status':0x2});},'onSuccess':async _0x3e72ab=>{const _0x2f5825=_0x450634;await this[_0x2f5825(0x190)]['updateChatLog'](_0x4546eb,{'fileInfo':_0x3e72ab===null||_0x3e72ab===void 0x0?void 0x0:_0x3e72ab['fileInfo'],'answer':(_0x3e72ab===null||_0x3e72ab===void 0x0?void 0x0:_0x3e72ab[_0x2f5825(0x23d)])||_0x492657,'progress':_0x2f5825(0x242),'status':0x3});},'onFailure':async _0x319494=>{const _0x2ff04f=_0x450634;await this[_0x2ff04f(0x190)]['updateChatLog'](_0x4546eb,{'answer':_0x319494[_0x2ff04f(0x1a3)],'status':0x4});}}),await this[_0x450634(0x190)][_0x450634(0x1f9)](_0x4546eb,{'answer':_0x450634(0x1a4)});else _0x2ea8c6[_0x450634(0x22b)](_0x450634(0x25e))?(_0x4809bf=this[_0x450634(0x1dc)][_0x450634(0x247)]({'chatId':_0x4546eb,'maxModelTokens':_0x367ffc,'apiKey':_0x1b607d,'model':_0x2ea8c6,'modelName':_0x4addac,'modelType':_0x372085,'prompt':_0x492657,'fileInfo':_0x361e50,'isFileUpload':_0x2c4923,'timeout':_0xe71897,'proxyUrl':_0x2ac3c4,'onSuccess':async _0x155c60=>{const _0x51f161=_0x450634;await this[_0x51f161(0x190)]['updateChatLog'](_0x4546eb,{'fileInfo':_0x155c60===null||_0x155c60===void 0x0?void 0x0:_0x155c60['fileInfo'],'answer':(_0x155c60===null||_0x155c60===void 0x0?void 0x0:_0x155c60[_0x51f161(0x23d)])||_0x492657,'progress':_0x51f161(0x242),'status':0x3});},'onFailure':async _0x35322c=>{const _0x228e45=_0x450634;await this['chatLogService'][_0x228e45(0x1f9)](_0x4546eb,{'answer':'生成失败','status':0x4});}}),await this['chatLogService'][_0x450634(0x1f9)](_0x4546eb,{'answer':_0x450634(0x214)})):(_0x4809bf=await this[_0x450634(0x182)][_0x450634(0x189)]({'usePrompt':_0x2e8929,'prompt':_0x492657,'apiKey':_0x1b607d,'proxyUrl':_0x2ac3c4,'model':_0x2ea8c6,'modelName':_0x4addac,'drawId':_0x59d283,'customId':_0x16de0e,'action':_0x140cd5,'fileInfo':_0x361e50,'timeout':_0xe71897,'assistantLogId':_0x4546eb,'pluginName':_0x5c9ae2}),await this[_0x450634(0x190)]['updateChatLog'](_0x4546eb,{'answer':_0x4809bf[_0x450634(0x23d)],'status':_0x4809bf[_0x450634(0x1f1)]}));}}}}}_0x4809bf[_0x450634(0x1f1)]!==0x5?(await this[_0x450634(0x180)][_0x450634(0x221)](_0x51cf54,0x1),await this[_0x450634(0x171)][_0x450634(0x273)](_0x3dbaf6[_0x450634(0x240)]['id'],_0xb98957,_0x1f19f1)):common_1[_0x450634(0x195)][_0x450634(0x1b2)](_0x450634(0x198),_0x450634(0x246));const _0x3e4970=await this[_0x450634(0x171)][_0x450634(0x260)](_0x3dbaf6[_0x450634(0x240)]['id']);return _0x4809bf['userBalance']=Object[_0x450634(0x263)]({},_0x3e4970),_0x4809bf[_0x450634(0x21d)]=_0x4809bf['answer'],_0x4809bf[_0x450634(0x1f1)]=_0x4809bf['status']||0x2,_0x4809bf[_0x450634(0x218)]=_0x442987,_0x4809bf[_0x450634(0x21b)]=_0x38f6e1,_0x53245c[_0x450634(0x1ae)]('\x0a'+JSON[_0x450634(0x1ac)](_0x4809bf));}else{_0x4809bf=await this[_0x450634(0x23b)][_0x450634(0x1fc)](_0x59c35c,{'chatId':_0x4546eb,'maxModelTokens':_0x367ffc,'apiKey':_0x1b607d,'model':_0x2ea8c6,'modelName':_0x4addac,'temperature':_0xa63a88,'modelType':_0x372085,'prompt':_0x492657,'fileInfo':_0x361e50,'isFileUpload':_0x2c4923,'timeout':_0xe71897,'proxyUrl':_0x2ac3c4,'modelAvatar':_0x5e9646,'onProgress':_0x1be5a2=>{const _0x4d46a4=_0x450634;_0x53245c[_0x4d46a4(0x1ae)](_0x4c571a?JSON[_0x4d46a4(0x1ac)](_0x1be5a2):'\x0a'+JSON[_0x4d46a4(0x1ac)](_0x1be5a2)),_0x4c571a=![];},'onFailure':async _0x366df4=>{const _0x5bc9f1=_0x450634;await this[_0x5bc9f1(0x190)][_0x5bc9f1(0x1f9)](_0x4546eb,{'answer':_0x366df4['errMsg'],'status':0x4});},'abortController':_0x39ba2c});if(_0x4809bf[_0x450634(0x1a3)])return common_1[_0x450634(0x195)][_0x450634(0x1c3)](_0x450634(0x175)+_0x3dbaf6['user']['id']+_0x450634(0x25c)+_0x4addac+_0x450634(0x207)+_0x442987+_0x450634(0x1bf),'ChatService'),_0x53245c[_0x450634(0x1ae)]('\x0a'+JSON[_0x450634(0x1ac)](_0x4809bf));let _0x7803b3='';_0x59c35c[_0x450634(0x193)](_0x3e2c1f=>{_0x7803b3+=_0x3e2c1f['content']+'\x20';});const _0x5dd521=await(0x0,utils_1[_0x450634(0x183)])(_0x7803b3),_0x2bc894=await(0x0,utils_1['getTokenCount'])(_0x4809bf['answer']);await this[_0x450634(0x190)][_0x450634(0x1f9)](_0xd98cde,{'promptTokens':_0x5dd521,'completionTokens':_0x2bc894,'totalTokens':_0x5dd521+_0x2bc894});let _0x3313fa=_0x4809bf[_0x450634(0x23d)];if(_0x55fbcb==='1'){const _0x895aed=await this[_0x450634(0x1fa)][_0x450634(0x204)](_0x4809bf[_0x450634(0x23d)],_0x3dbaf6[_0x450634(0x240)]['id']);if(_0x895aed['length']>0x0){const _0x476478=new RegExp(_0x895aed[_0x450634(0x1bb)]('|'),'gi');_0x3313fa=_0x3313fa[_0x450634(0x267)](_0x476478,_0x38b94f=>'*'[_0x450634(0x239)](_0x38b94f[_0x450634(0x196)]));}}await this['chatLogService'][_0x450634(0x1f9)](_0x4546eb,{'fileInfo':_0x4809bf===null||_0x4809bf===void 0x0?void 0x0:_0x4809bf[_0x450634(0x1be)],'answer':_0x3313fa,'promptTokens':_0x5dd521,'completionTokens':_0x2bc894,'totalTokens':_0x5dd521+_0x2bc894,'status':0x3});try{if(_0x189fd1==='1'){const _0x2e1af9=await this[_0x450634(0x23b)]['chatFree'](_0x450634(0x17a)+_0x492657+_0x450634(0x197)+_0x4809bf[_0x450634(0x23d)]+_0x450634(0x21c));await this['chatLogService'][_0x450634(0x1f9)](_0x4546eb,{'promptReference':_0x2e1af9});}}catch(_0x51ccbb){common_1['Logger'][_0x450634(0x1c3)]('调用\x20chatFree\x20出错:\x20'+_0x51ccbb);}_0x443fc7===!![]&&(_0x1f19f1=_0x18e7ac*Math[_0x450634(0x1ea)]((_0x5dd521+_0x2bc894)/_0x5b91b4));await this[_0x450634(0x171)][_0x450634(0x273)](_0x3dbaf6[_0x450634(0x240)]['id'],_0xb98957,_0x1f19f1,_0x5dd521+_0x2bc894),await this['modelsService']['saveUseLog'](_0x51cf54,_0x5dd521+_0x2bc894),common_1['Logger']['log'](_0x450634(0x175)+_0x3dbaf6[_0x450634(0x240)]['id']+_0x450634(0x25c)+_0x4addac+_0x450634(0x207)+_0x442987+'\x20消耗token:\x20'+(_0x5dd521+_0x2bc894)+_0x450634(0x1e5)+_0x1f19f1,_0x450634(0x246));const _0xa53380=await this['userBalanceService'][_0x450634(0x260)](_0x3dbaf6[_0x450634(0x240)]['id']);return _0x4809bf[_0x450634(0x1e3)]=Object[_0x450634(0x263)]({},_0xa53380),_0x53245c[_0x450634(0x1ae)]('\x0a'+JSON['stringify'](_0x4809bf));}}catch(_0x445fe0){common_1['Logger'][_0x450634(0x1c3)](_0x450634(0x24d),_0x445fe0),await this[_0x450634(0x190)][_0x450634(0x1f9)](_0x4546eb,{'status':0x5}),_0x4809bf={'error':_0x450634(0x261)};}}else return _0x2248f3=await this[_0x450634(0x23b)][_0x450634(0x1fc)](_0x59c35c,{'chatId':_0x4546eb,'maxModelTokens':_0x367ffc,'apiKey':_0x1b607d,'model':_0x2ea8c6,'modelName':_0x4addac,'modelType':_0x372085,'temperature':_0xa63a88,'prompt':_0x492657,'fileInfo':_0x361e50,'isFileUpload':_0x2c4923,'timeout':_0xe71897,'proxyUrl':_0x2ac3c4,'abortController':_0x39ba2c}),await this['userBalanceService'][_0x450634(0x273)](_0x3dbaf6['user']['id'],_0xb98957,_0x1f19f1),_0x2248f3['answer'];}catch(_0x1f287e){common_1[_0x450634(0x195)][_0x450634(0x1c3)](_0x450634(0x1f5),_0x1b607d,_0x1f287e);if(_0x53245c)return _0x53245c[_0x450634(0x1ae)](_0x450634(0x1f4));else throw new common_1[(_0x450634(0x1ce))]('发生未知错误，请稍后再试',common_1['HttpStatus'][_0x450634(0x25f)]);}finally{_0x53245c&&_0x53245c[_0x450634(0x251)]();}}async[_0x5384be(0x262)](_0x3e69f6,_0x190b80){const _0xc4064c=_0x5384be,{pluginUrl:_0x1a0e8e,pluginKey:_0x1af05f}=await this['globalConfigService'][_0xc4064c(0x1de)]([_0xc4064c(0x1f7),'pluginKey']),_0x315485=_0x1af05f,_0x480b3b=_0x1a0e8e,_0x45cb6a={'method':_0xc4064c(0x1d9),'url':_0x480b3b+'/plugins/'+_0x190b80,'headers':{'Content-Type':_0xc4064c(0x215),'Authorization':_0xc4064c(0x220)+_0x315485},'data':{'prompt':_0x3e69f6}};try{const _0x5cf62c=await(0x0,axios_1[_0xc4064c(0x188)])(_0x45cb6a);return common_1['Logger']['log']('插件调用成功\x20返回结果:\x20'+JSON[_0xc4064c(0x1ac)](_0x5cf62c['data'],null,0x2),_0xc4064c(0x24e)),_0x5cf62c[_0xc4064c(0x1fe)][_0xc4064c(0x21d)];}catch(_0x381a68){common_1['Logger'][_0xc4064c(0x1c3)](_0xc4064c(0x20c),_0x381a68);}}async[_0x5384be(0x22d)](_0x8b1a0f,_0x2935f9,_0x28824d,_0x1ef2d9,_0x2f1881){const _0x276964=_0x5384be;if((_0x2935f9===null||_0x2935f9===void 0x0?void 0x0:_0x2935f9[_0x276964(0x1c6)])===_0x276964(0x268)){let _0x25dec0;if(_0x28824d===0x1)try{_0x25dec0=await this['openAIChatService']['chatFree'](_0x276964(0x17a)+_0x1ef2d9+_0x276964(0x1dd)),_0x25dec0['length']>0xf&&(_0x25dec0=_0x25dec0['slice'](0x0,0xf));}catch(_0x2d0c4b){common_1[_0x276964(0x195)][_0x276964(0x1c3)](_0x276964(0x244)+_0x2d0c4b),_0x25dec0=_0x1ef2d9['slice'](0x0,0xa);}else _0x25dec0='创意\x20AI';this[_0x276964(0x1b6)]['update']({'groupId':_0x8b1a0f,'title':_0x25dec0,'isSticky':![],'config':'','fileUrl':''},_0x2f1881)[_0x276964(0x232)](()=>common_1[_0x276964(0x195)][_0x276964(0x1b2)]('更新标题名称为:\x20'+_0x25dec0,_0x276964(0x246)))['catch'](_0x237076=>common_1[_0x276964(0x195)][_0x276964(0x1c3)](_0x276964(0x225)+_0x237076));}}async[_0x5384be(0x219)](_0x6a4760,_0x248b99,_0x41c41f){const _0x3f98a4=_0x5384be;let {systemMessage:systemMessage='',fileInfo:_0x42a418,groupId:_0x11cd33,maxRounds:maxRounds=0x5,maxModelTokens:maxModelTokens=0x1f40,isFileUpload:isFileUpload=0x0,isConvertToBase64:_0x34ed86}=_0x248b99;systemMessage['length']>maxModelTokens&&(common_1['Logger'][_0x3f98a4(0x1b2)]('系统消息超过最大长度，将被截断',_0x3f98a4(0x246)),systemMessage=systemMessage['slice'](0x0,maxModelTokens));let _0x35f579=[];systemMessage&&_0x35f579[_0x3f98a4(0x1e9)]({'role':_0x3f98a4(0x253),'content':systemMessage});if(_0x11cd33){const _0x2c723c=await _0x41c41f[_0x3f98a4(0x200)](_0x11cd33,maxRounds);let _0x7e7c59=null;for(const _0x13eea9 of _0x2c723c){try{let _0x3ac494;if((isFileUpload===0x2||isFileUpload===0x3)&&_0x13eea9['fileInfo']&&_0x13eea9[_0x3f98a4(0x274)]===_0x3f98a4(0x240)){const _0x21373b=await Promise[_0x3f98a4(0x18c)](_0x13eea9[_0x3f98a4(0x1be)][_0x3f98a4(0x1fb)](',')[_0x3f98a4(0x237)](async _0x4e86bc=>({'type':_0x3f98a4(0x1f3),'image_url':{'url':_0x34ed86==='1'?await this[_0x3f98a4(0x1f2)](_0x4e86bc[_0x3f98a4(0x1d2)]()):_0x4e86bc[_0x3f98a4(0x1d2)]()}})));_0x3ac494=[{'type':_0x3f98a4(0x21d),'text':_0x13eea9[_0x3f98a4(0x21d)]},..._0x21373b];}else isFileUpload===0x1&&_0x13eea9[_0x3f98a4(0x1be)]&&_0x13eea9['role']===_0x3f98a4(0x240)?_0x3ac494=_0x13eea9['fileInfo']+'\x0a'+_0x13eea9['text']:_0x3ac494=_0x13eea9[_0x3f98a4(0x21d)];if(_0x13eea9[_0x3f98a4(0x274)]===_0x3f98a4(0x240))_0x7e7c59={'role':_0x13eea9[_0x3f98a4(0x274)],'content':_0x3ac494};else{if(_0x13eea9[_0x3f98a4(0x274)]===_0x3f98a4(0x176)){const _0x472179=Array[_0x3f98a4(0x1d6)](_0x3ac494)?JSON[_0x3f98a4(0x1ac)](_0x3ac494):_0x3ac494;_0x7e7c59&&_0x472179[_0x3f98a4(0x1d2)]()!==''&&(_0x35f579['push'](_0x7e7c59),_0x35f579[_0x3f98a4(0x1e9)]({'role':_0x13eea9[_0x3f98a4(0x274)],'content':_0x3ac494}),_0x7e7c59=null);}}}catch(_0x197a28){common_1['Logger'][_0x3f98a4(0x1c3)](_0x3f98a4(0x230),_0x197a28,_0x3f98a4(0x23c),JSON[_0x3f98a4(0x1ac)](_0x13eea9,null,0x2));}}}let _0x2427f4;if((isFileUpload===0x2||isFileUpload===0x3)&&_0x42a418){const _0x5f43a7=await Promise[_0x3f98a4(0x18c)](_0x42a418['split'](',')[_0x3f98a4(0x237)](async _0x252759=>({'type':_0x3f98a4(0x1f3),'image_url':{'url':_0x34ed86==='1'?await this[_0x3f98a4(0x1f2)](_0x252759['trim']()):_0x252759[_0x3f98a4(0x1d2)]()}})));_0x2427f4=[{'type':_0x3f98a4(0x21d),'text':_0x6a4760},..._0x5f43a7];}else isFileUpload===0x1&&_0x42a418?_0x2427f4=_0x42a418+'\x0a'+_0x6a4760:_0x2427f4=_0x6a4760;_0x35f579['push']({'role':_0x3f98a4(0x240),'content':_0x2427f4});let _0x261222=await(0x0,utils_1[_0x3f98a4(0x183)])(_0x35f579),_0x44bc66;maxModelTokens<0x1f40?_0x44bc66=0xfa0:_0x44bc66=maxModelTokens-0xfa0;while(_0x261222>_0x44bc66){if(_0x35f579[_0x3f98a4(0x196)]===0x2&&_0x35f579[0x0]['role']==='system'&&_0x35f579[0x1][_0x3f98a4(0x274)]===_0x3f98a4(0x240))break;let _0x14c055=![];for(let _0x248964=0x0;_0x248964<_0x35f579['length'];_0x248964++){if(_0x35f579[_0x248964][_0x3f98a4(0x274)]!==_0x3f98a4(0x253)&&_0x35f579[_0x248964+0x1]&&_0x35f579[_0x248964+0x1]['role']===_0x3f98a4(0x176)){_0x35f579[_0x3f98a4(0x203)](_0x248964,0x2),_0x14c055=!![];break;}}if(!_0x14c055)for(let _0x9daf26=0x0;_0x9daf26<_0x35f579[_0x3f98a4(0x196)];_0x9daf26++){if(_0x35f579[_0x9daf26][_0x3f98a4(0x274)]===_0x3f98a4(0x240)){_0x35f579['splice'](_0x9daf26,0x1);break;}}_0x261222=await(0x0,utils_1[_0x3f98a4(0x183)])(_0x35f579);if(_0x35f579[_0x3f98a4(0x196)]<=0x2)break;}return{'messagesHistory':_0x35f579,'round':_0x35f579[_0x3f98a4(0x196)]};}async[_0x5384be(0x1f2)](_0x2ec592){const _0x4c3bd6=_0x5384be;try{console[_0x4c3bd6(0x1b2)](_0x4c3bd6(0x23f)+_0x2ec592);const _0x2dfd00=await axios_1[_0x4c3bd6(0x188)][_0x4c3bd6(0x272)](_0x2ec592,{'responseType':_0x4c3bd6(0x1d8)}),_0x18ecf6=Buffer[_0x4c3bd6(0x1b9)](_0x2dfd00[_0x4c3bd6(0x1fe)],_0x4c3bd6(0x1e4));console[_0x4c3bd6(0x1b2)](_0x4c3bd6(0x1cb)+_0x2ec592);const _0x9fc29b=_0x4c3bd6(0x1a2)+_0x2dfd00[_0x4c3bd6(0x1ad)]['content-type']+_0x4c3bd6(0x1b8)+_0x18ecf6[_0x4c3bd6(0x1cd)](_0x4c3bd6(0x184));return console[_0x4c3bd6(0x1b2)]('成功转换URL为Base64:\x20'+_0x2ec592),_0x9fc29b;}catch(_0x332efd){return console[_0x4c3bd6(0x1c3)](_0x4c3bd6(0x23a),_0x332efd),console['warn'](_0x4c3bd6(0x17e)+_0x2ec592),_0x2ec592;}}async[_0x5384be(0x1c0)](_0x12dd2b,_0x35780a,_0x48a01c){const _0xd40949=_0x5384be,{chatId:_0x4211db,prompt:_0x4813d4}=_0x12dd2b,_0x3957af=await this[_0xd40949(0x180)][_0xd40949(0x19e)]('tts-1'),{openaiTimeout:_0x236635,openaiBaseUrl:_0x1bc992,openaiBaseKey:_0x2e4873,openaiVoice:_0x36baaf}=await this[_0xd40949(0x1fd)][_0xd40949(0x1de)](['openaiTimeout',_0xd40949(0x1b3),_0xd40949(0x208),_0xd40949(0x1f8)]),{key:_0x19a9d,proxyUrl:_0x1624a0,deduct:_0x4504c2,deductType:_0x54ee96,timeout:_0x2bea51}=_0x3957af,_0xdb840b=_0x19a9d||_0x2e4873,_0x167af8=(0x0,utils_1[_0xd40949(0x235)])(_0x1624a0||_0x1bc992),_0x49bfdc=(_0x2bea51||_0x236635)*0x3e8;await this[_0xd40949(0x171)][_0xd40949(0x1ec)](_0x35780a,_0x54ee96,_0x4504c2),common_1[_0xd40949(0x195)][_0xd40949(0x1b2)](_0xd40949(0x269),_0x4813d4,_0xd40949(0x233));const _0x440f25={'method':_0xd40949(0x1d9),'url':_0x167af8+_0xd40949(0x21e),'headers':{'Content-Type':'application/json','Authorization':'Bearer\x20'+_0xdb840b},'responseType':_0xd40949(0x1d8),'timeout':_0x49bfdc,'data':{'model':'tts-1','input':_0x4813d4,'voice':_0x36baaf||_0xd40949(0x21f)}};try{const _0x208a38=await(0x0,axios_1['default'])(_0x440f25);common_1[_0xd40949(0x195)][_0xd40949(0x1b2)](_0xd40949(0x1a5),_0xd40949(0x233));const _0x426cb9=Buffer[_0xd40949(0x1b9)](_0x208a38[_0xd40949(0x1fe)]),_0x2b56a9=new Date(),_0x16fdbf=_0x2b56a9[_0xd40949(0x256)](),_0x5c1f21=String(_0x2b56a9[_0xd40949(0x1b5)]()+0x1)[_0xd40949(0x23e)](0x2,'0'),_0xc0ea6f=String(_0x2b56a9[_0xd40949(0x1d0)]())[_0xd40949(0x23e)](0x2,'0'),_0x14e2c2=''+_0x16fdbf+_0x5c1f21+'/'+_0xc0ea6f,_0xca9b58=await this[_0xd40949(0x1ab)]['uploadFile']({'buffer':_0x426cb9,'mimetype':_0xd40949(0x19c)},_0xd40949(0x20d)+_0x14e2c2);await Promise[_0xd40949(0x18c)]([this[_0xd40949(0x190)]['updateChatLog'](_0x4211db,{'ttsUrl':_0xca9b58}),this['userBalanceService'][_0xd40949(0x273)](_0x35780a['user']['id'],_0x54ee96,_0x4504c2)]),_0x48a01c[_0xd40949(0x1f1)](0xc8)['send']({'ttsUrl':_0xca9b58});}catch(_0x2c18f6){common_1[_0xd40949(0x195)][_0xd40949(0x1c3)]('TTS\x20请求或上传过程失败:',_0x2c18f6,'TTSService'),_0x48a01c[_0xd40949(0x1f1)](0x1f4)[_0xd40949(0x258)]({'error':_0xd40949(0x1ee)});}}};ChatService=__decorate([(0x0,common_1[_0x5384be(0x1c1)])(),__param(0x0,(0x0,typeorm_1[_0x5384be(0x178)])(config_entity_1[_0x5384be(0x1c5)])),__param(0x1,(0x0,typeorm_1[_0x5384be(0x178)])(app_entity_1[_0x5384be(0x172)])),__param(0x2,(0x0,typeorm_1[_0x5384be(0x178)])(plugin_entity_1[_0x5384be(0x241)])),__metadata('design:paramtypes',[typeorm_2[_0x5384be(0x1b4)],typeorm_2['Repository'],typeorm_2[_0x5384be(0x1b4)],suno_service_1[_0x5384be(0x1aa)],openaiChat_service_1['OpenAIChatService'],chatLog_service_1[_0x5384be(0x194)],midjourneyDraw_service_1[_0x5384be(0x1e1)],stableDiffusion_service_1['StableDiffusionService'],userBalance_service_1[_0x5384be(0x1e7)],user_service_1['UserService'],upload_service_1[_0x5384be(0x18f)],badWords_service_1[_0x5384be(0x24a)],autoreply_service_1[_0x5384be(0x26f)],globalConfig_service_1[_0x5384be(0x213)],chatGroup_service_1[_0x5384be(0x1af)],models_service_1[_0x5384be(0x18d)],openaiDraw_service_1[_0x5384be(0x250)],lumaVideo_service_1['LumaVideoService'],cogVideo_service_1[_0x5384be(0x22f)],fluxDraw_service_1[_0x5384be(0x205)],aiPPT_1[_0x5384be(0x1c9)]])],ChatService),exports['ChatService']=ChatService;