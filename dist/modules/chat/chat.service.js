'use strict';const _0x412d3d=_0xce30;(function(_0x397f32,_0x15d166){const _0x362c26=_0xce30,_0x4d7040=_0x397f32();while(!![]){try{const _0x3a82fe=parseInt(_0x362c26(0x2d6))/0x1+-parseInt(_0x362c26(0x291))/0x2+parseInt(_0x362c26(0x297))/0x3*(-parseInt(_0x362c26(0x258))/0x4)+parseInt(_0x362c26(0x248))/0x5*(parseInt(_0x362c26(0x299))/0x6)+parseInt(_0x362c26(0x2cd))/0x7+parseInt(_0x362c26(0x28a))/0x8*(-parseInt(_0x362c26(0x286))/0x9)+-parseInt(_0x362c26(0x2d0))/0xa;if(_0x3a82fe===_0x15d166)break;else _0x4d7040['push'](_0x4d7040['shift']());}catch(_0x78e38f){_0x4d7040['push'](_0x4d7040['shift']());}}}(_0xc8c1,0x5cdee));function _0xc8c1(){const _0x1a8cba=['from','14712Itulto','lumaVideo','../ai/openaiChat.service','isMjTranslate','DrawService','MidjourneyService','all','stable-diffusion','push','chatLogService','checkAutoReply','splice','checkUserCertification','answer','@nestjs/common','updateChatTitle','user','../ai/lumaVideo.service','role','binary','Logger','openaiVoice','../chatGroup/chatGroup.service','fileInfo','userBalanceService','data:','queryUserBalance','uploadFile','chatProcess','padStart','forEach','fluxDraw','content-type','提交成功，视频生成中','../badWords/badWords.service','插件调用成功\x20返回结果:\x20','isSystemPlugin','pluginKey','assistant','openAIChat','length','match','split','setHeader','config','转换URL为Base64时发生错误:','446022yyyERh','object','getFullYear','模型切换错误，请检查全局模型配置！','16OTamNX','__metadata','创意\x20AI','error:\x20','UploadService','dall-e-3','GlobalConfigService','904938EOmOaL','HttpStatus','modelName','defineProperty','处理历史记录时出错:','update','393Cpdjzo','modelsService','456kJInFO','log','globalConfigService','getConfigs','使用应用预设:\x20','配置解析错误！','SunoService','convertUrlToBase64','调用\x20chatFree\x20出错:\x20','configEntity','AppEntity','你当前使用的应用已被下架、请删除当前对话开启新的对话吧！',';base64,','}以及\x20AI\x20的回答{','toISOString','errMsg','getGroupInfoFromId','base64','】，在回答问题之前，先检索知识库内有没有相关的内容，尽量使用知识库中获取到的信息来回答我的问题，以知识库中的为准。','systemPreMessage','OpenAIChatService','openaiTimeout','image_url','openaiBaseModel','TOO_MANY_REQUESTS','headers','openAIDrawService','isSensitiveWordFilter','decorate','__decorate','\x0a\x20Current\x20date:\x20','../chatLog/chatLog.service','ttsProcess','includes','100%','catch','get','用户ID:\x20','data','OpenAIDrawService',',\x20消耗积分：\x20','openaiBaseUrl','pluginUrl','assign','任务提交失败，不执行扣费','LumaVideoService','sdxl','发生未知错误，请稍后再试','application/json','trim','../../common/utils','TTSService','5304425WBFetD','checkModelLimits','chat-error\x20<----------------------------------------->','4309680cctuVk','UserBalanceService','../ai/openaiDraw.service','userBalance','开始生成PPT','chatGroupService','351162pOxGpv','正在尝试转换URL为Base64:\x20','../ai/aiPPT','debug','openAIChatService','audio/mpeg','repeat','userService','modelInfo','chatHistory','luma-video','Content-type','发生错误:','HttpException','FluxDrawService','text','midjourneyDraw','error','getCurrentModelKeyInfo','ModelsService','formatUrl','function','处理请求时发生错误','stringify','saveUseLog','PluginService','parameters','slice','audio/openai/','buildMessageFromParentMessageId','使用插件预设:\x20','isAIReplyEnabled','saveChatLog','更新对话组标题失败:\x20','validateBalance','绘制中','design:paramtypes','AutoreplyService','uploadService','Repository','ChatGroupService','getMonth','pluginImg','/v1/audio/speech','appEntity','cogVideoService','application/octet-stream;\x20charset=utf-8','../autoreply/autoreply.service','../ai/cogVideo.service','../ai/stableDiffusion.service','UPSCALE','model','../userBalance/userBalance.service','POST','getOwnPropertyDescriptor','BAD_REQUEST','arraybuffer','badWordsService','checkUserStatus','ai-ppt','isConvertToBase64','openaiBaseKey','toString','fluxDrawService','您提交的信息中包含违规的内容，我们已对您的账户进行标记，请合规使用！','ChatService','sunoService','绘图失败','metadata','../plugin/plugin.entity','status','dalleDraw','\x20模型名称:\x20','map','根据用户提问{','usePlugin','CogVideoService','使用全局预设:\x20','title','../ai/midjourneyDraw.service','preset','gpt-4-gizmo-','system','使用文件解析:\x20','typeorm','@nestjs/typeorm','suno-music','getTokenCount','pluginEntity','deductFromBalance','stableDiffusionService','新对话','更新标题名称为:\x20','固定模型、使用应用预设:\x20','../globalConfig/config.entity','parse','成功获取图片，正在转换为Base64:\x20','updateChatLog','checkBadWords','1\x20小时内对话次数过多，请切换模型或稍后再试！','midjourneyService','以下是我提供给你的知识库：【','getDate','write','Bearer\x20','aiPptService','findOne','chatFree','openaiTemperature','replace','BadWordsService','TTS\x20请求或上传过程失败:','default','send','../models/models.service','gpts','插件返回结果:\x20','Failed\x20to\x20process\x20TTS\x20request','\x20消耗token:\x20','onyx','cog-video','插件调用错误:\x20','成功转换URL为Base64:\x20','48410ndRpiu','\x20模型:\x20','midjourney','tts-1','lumaVideoService','StableDiffusionService','}，生成三个更进入一步的提问，用{}包裹每个问题，不需要分行，不需要其他任何内容，单个提问不超过30个字','../app/app.entity','abort','flux','join','记录:','../ai/suno.service','autoreplyService','InjectRepository'];_0xc8c1=function(){return _0x1a8cba;};return _0xc8c1();}function _0xce30(_0xa93ece,_0x50fb07){const _0xc8c1d6=_0xc8c1();return _0xce30=function(_0xce3064,_0x419c5d){_0xce3064=_0xce3064-0x1da;let _0x5a7317=_0xc8c1d6[_0xce3064];return _0x5a7317;},_0xce30(_0xa93ece,_0x50fb07);}var __decorate=this&&this[_0x412d3d(0x2b6)]||function(_0x12e01f,_0x251744,_0xd03d21,_0x559bb1){const _0x4b7201=_0x412d3d;var _0x9ab57a=arguments['length'],_0x26da89=_0x9ab57a<0x3?_0x251744:_0x559bb1===null?_0x559bb1=Object[_0x4b7201(0x203)](_0x251744,_0xd03d21):_0x559bb1,_0x3101ae;if(typeof Reflect==='object'&&typeof Reflect[_0x4b7201(0x2b5)]===_0x4b7201(0x1e2))_0x26da89=Reflect[_0x4b7201(0x2b5)](_0x12e01f,_0x251744,_0xd03d21,_0x559bb1);else{for(var _0xfd5016=_0x12e01f['length']-0x1;_0xfd5016>=0x0;_0xfd5016--)if(_0x3101ae=_0x12e01f[_0xfd5016])_0x26da89=(_0x9ab57a<0x3?_0x3101ae(_0x26da89):_0x9ab57a>0x3?_0x3101ae(_0x251744,_0xd03d21,_0x26da89):_0x3101ae(_0x251744,_0xd03d21))||_0x26da89;}return _0x9ab57a>0x3&&_0x26da89&&Object[_0x4b7201(0x294)](_0x251744,_0xd03d21,_0x26da89),_0x26da89;},__metadata=this&&this[_0x412d3d(0x28b)]||function(_0xc9e40a,_0x4cefc5){const _0x14e233=_0x412d3d;if(typeof Reflect===_0x14e233(0x287)&&typeof Reflect[_0x14e233(0x211)]===_0x14e233(0x1e2))return Reflect[_0x14e233(0x211)](_0xc9e40a,_0x4cefc5);},__param=this&&this['__param']||function(_0x24a7ae,_0x7f638a){return function(_0x48f4bc,_0x4b2074){_0x7f638a(_0x48f4bc,_0x4b2074,_0x24a7ae);};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[_0x412d3d(0x20e)]=void 0x0;const utils_1=require(_0x412d3d(0x2cb)),common_1=require(_0x412d3d(0x266)),typeorm_1=require(_0x412d3d(0x222)),axios_1=require('axios'),typeorm_2=require(_0x412d3d(0x221)),aiPPT_1=require(_0x412d3d(0x2d8)),cogVideo_service_1=require(_0x412d3d(0x1fd)),fluxDraw_service_1=require('../ai/fluxDraw.service'),lumaVideo_service_1=require(_0x412d3d(0x269)),midjourneyDraw_service_1=require(_0x412d3d(0x21c)),openaiChat_service_1=require(_0x412d3d(0x25a)),openaiDraw_service_1=require(_0x412d3d(0x2d2)),stableDiffusion_service_1=require(_0x412d3d(0x1fe)),suno_service_1=require(_0x412d3d(0x254)),app_entity_1=require(_0x412d3d(0x24f)),autoreply_service_1=require(_0x412d3d(0x1fc)),badWords_service_1=require(_0x412d3d(0x27a)),chatGroup_service_1=require(_0x412d3d(0x26e)),chatLog_service_1=require(_0x412d3d(0x2b8)),config_entity_1=require(_0x412d3d(0x22b)),globalConfig_service_1=require('../globalConfig/globalConfig.service'),models_service_1=require(_0x412d3d(0x23f)),plugin_entity_1=require(_0x412d3d(0x212)),upload_service_1=require('../upload/upload.service'),user_service_1=require('../user/user.service'),userBalance_service_1=require(_0x412d3d(0x201));let ChatService=class ChatService{constructor(_0x3ddb51,_0x6f878f,_0x43c345,_0x48b717,_0x10ece1,_0x3eaedc,_0x5b4ded,_0x1d1286,_0x33ebe9,_0x1b684e,_0x3fe845,_0x6bad18,_0x2ef7ea,_0x1395b1,_0x24c573,_0x3b757b,_0x43cc14,_0x3aea06,_0x5efd23,_0x1138f2,_0x561228){const _0x52919b=_0x412d3d;this[_0x52919b(0x2a2)]=_0x3ddb51,this[_0x52919b(0x1f9)]=_0x6f878f,this['pluginEntity']=_0x43c345,this[_0x52919b(0x20f)]=_0x48b717,this[_0x52919b(0x2da)]=_0x10ece1,this[_0x52919b(0x261)]=_0x3eaedc,this[_0x52919b(0x231)]=_0x5b4ded,this[_0x52919b(0x227)]=_0x1d1286,this[_0x52919b(0x270)]=_0x33ebe9,this['userService']=_0x1b684e,this[_0x52919b(0x1f3)]=_0x3fe845,this[_0x52919b(0x206)]=_0x6bad18,this[_0x52919b(0x255)]=_0x2ef7ea,this['globalConfigService']=_0x1395b1,this[_0x52919b(0x2d5)]=_0x24c573,this['modelsService']=_0x3b757b,this[_0x52919b(0x2b3)]=_0x43cc14,this[_0x52919b(0x24c)]=_0x3aea06,this['cogVideoService']=_0x5efd23,this[_0x52919b(0x20c)]=_0x1138f2,this[_0x52919b(0x236)]=_0x561228;}async[_0x412d3d(0x274)](_0x525b63,_0x18d016,_0x928e4a){const _0x49b4d2=_0x412d3d;await this[_0x49b4d2(0x270)][_0x49b4d2(0x264)](_0x18d016[_0x49b4d2(0x268)]['id']);const {options:options={},usingPluginId:_0x19a49d,appId:appId=null,specialModel:_0x3acaf2,prompt:_0x1401df,fileInfo:_0x59e330,extraParam:_0x277dc,model:_0x16b52f,drawId:_0x11a677,customId:_0x539800,action:_0x220dd6,modelName:_0x3b7cf5,modelAvatar:_0x59acf7}=_0x525b63;let _0xc3a2ee;if(_0x3acaf2)_0xc3a2ee=await this[_0x49b4d2(0x1f9)]['findOne']({'where':{'des':_0x3acaf2,'isSystemReserved':!![]}});else{if(appId){_0xc3a2ee=await this[_0x49b4d2(0x1f9)][_0x49b4d2(0x237)]({'where':{'id':appId,'status':(0x0,typeorm_2['In'])([0x1,0x3,0x4,0x5])}});if(!_0xc3a2ee)throw new common_1[(_0x49b4d2(0x1da))](_0x49b4d2(0x2a4),common_1[_0x49b4d2(0x292)][_0x49b4d2(0x204)]);}}const {groupId:_0x29fdd2,fileParsing:_0x1f96a5}=options,{openaiTimeout:_0x857550,openaiBaseUrl:_0x166f98,openaiBaseKey:_0x43e466,systemPreMessage:_0x37debb,isMjTranslate:_0x153b0a,mjTranslatePrompt:_0x453c28,openaiTemperature:_0x107138,openaiBaseModel:_0x1f4a60,isGeneratePromptReference:_0xa6ab9a,isConvertToBase64:_0x3082bf,isSensitiveWordFilter:_0x339c84}=await this[_0x49b4d2(0x29b)][_0x49b4d2(0x29c)]([_0x49b4d2(0x2ae),_0x49b4d2(0x2c2),_0x49b4d2(0x20a),_0x49b4d2(0x2ac),_0x49b4d2(0x25b),'mjTranslatePrompt',_0x49b4d2(0x239),_0x49b4d2(0x2b0),'isGeneratePromptReference',_0x49b4d2(0x209),_0x49b4d2(0x2b4)]);await this[_0x49b4d2(0x2dd)][_0x49b4d2(0x207)](_0x18d016[_0x49b4d2(0x268)]),_0x928e4a&&_0x928e4a[_0x49b4d2(0x283)](_0x49b4d2(0x2e1),_0x49b4d2(0x1fb));if(_0x339c84==='1'){const _0x4c0133=await this['badWordsService'][_0x49b4d2(0x22f)](_0x1401df,_0x18d016[_0x49b4d2(0x268)]['id']);if(_0x4c0133[_0x49b4d2(0x280)]>0x0){const _0x462b96=_0x49b4d2(0x20d);throw new common_1[(_0x49b4d2(0x1da))](_0x462b96,common_1[_0x49b4d2(0x292)][_0x49b4d2(0x204)]);}}const _0x557ae8=await this['autoreplyService'][_0x49b4d2(0x262)](_0x1401df);let _0x12d383=null,_0x5bc80c='',_0x319b00='';_0x928e4a&&_0x928e4a[_0x49b4d2(0x213)](0xc8);let _0x334898=null;const _0x579556=(0x0,utils_1['getClientIp'])(_0x18d016);let _0x150f16,_0x24e320='',_0x5e1b7f;_0x19a49d&&(_0x5e1b7f=await this[_0x49b4d2(0x225)][_0x49b4d2(0x237)]({'where':{'id':_0x19a49d}}));if(_0xc3a2ee){const {isGPTs:_0x7ae5f8,gizmoID:_0x407350,name:_0x2a8d7e,isFixedModel:_0x208e8e,appModel:_0x5f48c3,coverImg:_0x9e763e}=_0xc3a2ee;_0x24e320=_0x9e763e,_0x5bc80c=_0x2a8d7e;if(_0x7ae5f8)_0x12d383=await this[_0x49b4d2(0x298)][_0x49b4d2(0x1df)](_0x49b4d2(0x240)),_0x12d383[_0x49b4d2(0x200)]=_0x49b4d2(0x21e)+_0x407350;else!_0x7ae5f8&&_0x208e8e&&_0x5f48c3?(_0xc3a2ee[_0x49b4d2(0x21d)]&&(_0x319b00=_0xc3a2ee[_0x49b4d2(0x21d)]),_0x12d383=await this[_0x49b4d2(0x298)][_0x49b4d2(0x1df)](_0x5f48c3),_0x12d383[_0x49b4d2(0x200)]=_0x5f48c3,_0x1f96a5&&(_0x319b00=_0x319b00+_0x49b4d2(0x232)+_0x1f96a5+_0x49b4d2(0x2ab)),common_1[_0x49b4d2(0x26c)]['log'](_0x49b4d2(0x22a)+_0x319b00,'ChatService')):(_0xc3a2ee['preset']&&(_0x319b00=_0xc3a2ee[_0x49b4d2(0x21d)]),_0x12d383=await this['modelsService'][_0x49b4d2(0x1df)](_0x16b52f),_0x1f96a5&&(_0x319b00=_0x319b00+_0x49b4d2(0x232)+_0x1f96a5+_0x49b4d2(0x2ab)),common_1[_0x49b4d2(0x26c)][_0x49b4d2(0x29a)](_0x49b4d2(0x29d)+_0x319b00,'ChatService'));}else{const _0x742eab=await this[_0x49b4d2(0x2d5)][_0x49b4d2(0x2a9)](_0x29fdd2);if(_0x5e1b7f&&_0x5e1b7f[_0x49b4d2(0x27c)]===0x0){let _0x45938b='';try{_0x45938b=await this[_0x49b4d2(0x218)](_0x1401df,_0x5e1b7f['parameters']),common_1[_0x49b4d2(0x26c)][_0x49b4d2(0x29a)](_0x49b4d2(0x241)+_0x45938b,_0x49b4d2(0x20e));}catch(_0x387fff){_0x45938b=_0x1401df,common_1['Logger'][_0x49b4d2(0x1de)](_0x49b4d2(0x246)+_0x387fff);}_0x319b00=_0x45938b,_0x12d383=await this[_0x49b4d2(0x298)]['getCurrentModelKeyInfo'](_0x16b52f),common_1[_0x49b4d2(0x26c)][_0x49b4d2(0x29a)](_0x49b4d2(0x1eb)+_0x319b00,'ChatService');}else{if(_0x1f96a5)_0x319b00='以下是我提供给你的知识库：【'+_0x1f96a5+_0x49b4d2(0x2ab),_0x12d383=await this[_0x49b4d2(0x298)][_0x49b4d2(0x1df)](_0x16b52f),common_1[_0x49b4d2(0x26c)][_0x49b4d2(0x29a)](_0x49b4d2(0x220)+_0x319b00,'ChatService');else{const _0x56f075=new Date()[_0x49b4d2(0x2a7)]()['split']('T')[0x0];_0x319b00=_0x37debb+(_0x49b4d2(0x2b7)+_0x56f075),_0x12d383=await this[_0x49b4d2(0x298)][_0x49b4d2(0x1df)](_0x16b52f),common_1[_0x49b4d2(0x26c)][_0x49b4d2(0x29a)](_0x49b4d2(0x21a)+_0x319b00,'ChatService');}}}if(!_0x12d383){common_1[_0x49b4d2(0x26c)][_0x49b4d2(0x2d9)]('未找到当前模型key，切换至全局模型',_0x49b4d2(0x20e)),_0x12d383=await this[_0x49b4d2(0x298)][_0x49b4d2(0x1df)](_0x1f4a60);const _0x168d40=await this[_0x49b4d2(0x2d5)][_0x49b4d2(0x2a9)](_0x29fdd2);let _0x3a72be=_0x168d40[_0x49b4d2(0x284)];try{const _0x57401e=JSON[_0x49b4d2(0x22c)](_0x168d40[_0x49b4d2(0x284)]);_0x57401e[_0x49b4d2(0x2de)]&&(_0x57401e[_0x49b4d2(0x2de)][_0x49b4d2(0x293)]=_0x12d383['modelName'],_0x57401e[_0x49b4d2(0x2de)]['model']=_0x12d383['model'],_0x3a72be=JSON[_0x49b4d2(0x1e4)](_0x57401e));}catch(_0x4d54f1){common_1[_0x49b4d2(0x26c)][_0x49b4d2(0x2d9)](_0x49b4d2(0x289),_0x49b4d2(0x20e));throw new common_1[(_0x49b4d2(0x1da))](_0x49b4d2(0x29e),common_1['HttpStatus'][_0x49b4d2(0x204)]);}await this[_0x49b4d2(0x2d5)][_0x49b4d2(0x296)]({'groupId':_0x29fdd2,'title':_0x168d40[_0x49b4d2(0x21b)],'isSticky':![],'config':_0x3a72be,'fileUrl':''},_0x18d016);}const {deduct:_0x1fba91,isTokenBased:_0x1e0b55,tokenFeeRatio:_0x455d8c,deductType:_0x3c8768,key:_0x2d3050,id:_0x4482ab,maxRounds:_0x4d29df,proxyUrl:_0x315440,maxModelTokens:_0x24441c,timeout:_0x46f59a,model:_0x18f35b,isFileUpload:_0x5e2e92,keyType:_0x42915f}=_0x12d383;if(await this[_0x49b4d2(0x261)][_0x49b4d2(0x2ce)](_0x18d016['user'],_0x18f35b))throw new common_1[(_0x49b4d2(0x1da))](_0x49b4d2(0x230),common_1[_0x49b4d2(0x292)][_0x49b4d2(0x2b1)]);if(_0x153b0a==='1'&&_0x220dd6==='IMAGINE'&&_0x16b52f===_0x49b4d2(0x24a)){const [_0x55a81c,_0x1b8f75]=_0x1401df['split'](/(?= --)/),_0x965ecd=/(https?:\/\/[^\s]+)/g,_0xc3b297=_0x55a81c[_0x49b4d2(0x281)](_0x965ecd)||[];let _0x14cce1=_0x55a81c[_0x49b4d2(0x23a)](_0x965ecd,'')[_0x49b4d2(0x2ca)]();const _0x44b40d=await this[_0x49b4d2(0x2da)][_0x49b4d2(0x238)](_0x14cce1,_0x453c28||'Translate\x20any\x20given\x20phrase\x20from\x20any\x20language\x20into\x20English.\x20For\x20instance,\x20when\x20I\x20input\x20\x27{可爱的熊猫}\x27,\x20you\x20should\x20output\x20\x27{cute\x20panda}\x27,\x20with\x20no\x20period\x20at\x20the\x20end.'),_0x5a377=[..._0xc3b297,_0x44b40d][_0x49b4d2(0x252)]('\x20')[_0x49b4d2(0x2ca)]();_0x150f16=_0x1b8f75?''+_0x5a377+_0x1b8f75:_0x5a377,_0x5e2e92==='1'&&_0x59e330&&(_0x150f16=_0x59e330+'\x20'+_0x150f16);}else _0x150f16=_0x5e2e92==='1'&&_0x59e330?_0x59e330+'\x20'+_0x1401df:_0x1401df;await this['userBalanceService'][_0x49b4d2(0x1ef)](_0x18d016,_0x3c8768,_0x1fba91);const _0x382fe9=_0x3b7cf5,_0x14078c=(0x0,utils_1[_0x49b4d2(0x1e1)])(_0x315440||_0x166f98||'https://api.openai.com'),_0x343abe=_0x2d3050||_0x43e466,_0x105dec=(_0x46f59a||_0x857550||0x12c)*0x3e8,_0x3fd7df=Number(_0x107138)||0x1;if(_0x29fdd2){const _0xb9ad13=await this[_0x49b4d2(0x2d5)][_0x49b4d2(0x2a9)](_0x29fdd2);this['updateChatTitle'](_0x29fdd2,_0xb9ad13,_0x42915f,_0x1401df,_0x18d016),await this[_0x49b4d2(0x2d5)]['updateTime'](_0x29fdd2);}const _0x425025=await this['chatLogService']['saveChatLog']({'appId':appId,'curIp':_0x579556,'userId':_0x18d016[_0x49b4d2(0x268)]['id'],'type':_0x42915f?_0x42915f:0x1,'prompt':_0x1401df,'fileInfo':_0x59e330?_0x59e330:null,'answer':'','promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x18f35b,'modelName':'我','role':'user','groupId':_0x29fdd2?_0x29fdd2:null}),_0x291582=await this[_0x49b4d2(0x261)][_0x49b4d2(0x1ed)]({'appId':appId?appId:null,'action':_0x220dd6?_0x220dd6:null,'curIp':_0x579556,'userId':_0x18d016[_0x49b4d2(0x268)]['id'],'type':_0x42915f?_0x42915f:0x1,'prompt':_0x1401df,'fileInfo':null,'answer':'','progress':'0%','promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x18f35b,'modelName':_0x382fe9,'role':_0x49b4d2(0x27e),'groupId':_0x29fdd2?_0x29fdd2:null,'status':0x2,'modelAvatar':(_0x5e1b7f===null||_0x5e1b7f===void 0x0?void 0x0:_0x5e1b7f[_0x49b4d2(0x1f7)])||_0x24e320||_0x59acf7||'','pluginParam':(_0x5e1b7f===null||_0x5e1b7f===void 0x0?void 0x0:_0x5e1b7f[_0x49b4d2(0x1e7)])?_0x5e1b7f[_0x49b4d2(0x1e7)]:_0x42915f===0x2?_0x18f35b:null}),_0x18357b=_0x425025['id'],_0x434956=_0x291582['id'];if(_0x557ae8[_0x49b4d2(0x265)]&&_0x928e4a){if(_0x557ae8[_0x49b4d2(0x1ec)]===0x0){const _0x350751=_0x557ae8['answer']['split'](''),_0x3a95cc=_0x4d5781=>{const _0x4adcf4=_0x49b4d2;if(_0x4d5781<_0x350751[_0x4adcf4(0x280)]){const _0x137b2b={'text':_0x350751[_0x4d5781]};_0x928e4a['write'](JSON[_0x4adcf4(0x1e4)](_0x137b2b)+'\x0a'),setTimeout(()=>_0x3a95cc(_0x4d5781+0x1),0xa);}else _0x928e4a['end']();};_0x3a95cc(0x0),await this[_0x49b4d2(0x261)][_0x49b4d2(0x22e)](_0x434956,{'answer':_0x557ae8[_0x49b4d2(0x265)]});return;}else _0x319b00=_0x319b00+_0x557ae8['answer'];}const {messagesHistory:_0x3bb786}=await this[_0x49b4d2(0x1ea)](_0x1401df,{'groupId':_0x29fdd2,'systemMessage':_0x319b00,'maxModelTokens':_0x24441c,'maxRounds':_0x4d29df,'isConvertToBase64':_0x3082bf,'fileInfo':_0x59e330,'model':_0x18f35b,'isFileUpload':_0x5e2e92},this[_0x49b4d2(0x261)]);let _0x1bbd0c=_0x220dd6!==_0x49b4d2(0x1ff)&&_0x18f35b===_0x49b4d2(0x24a)?_0x1fba91*0x4:_0x1fba91;const _0x75f426=new AbortController();try{if(_0x928e4a){_0x928e4a['on']('close',()=>{const _0x40108a=_0x49b4d2;_0x75f426[_0x40108a(0x250)]();});let _0x302a9f,_0x27c9ae=!![];try{if((_0x18f35b===_0x49b4d2(0x28f)||_0x18f35b===_0x49b4d2(0x24a)||_0x18f35b==='ai-ppt'||_0x18f35b===_0x49b4d2(0x223)||_0x18f35b===_0x49b4d2(0x2e0)||_0x18f35b[_0x49b4d2(0x2ba)](_0x49b4d2(0x25f))||_0x18f35b[_0x49b4d2(0x2ba)](_0x49b4d2(0x245))||_0x18f35b[_0x49b4d2(0x2ba)]('flux'))&&_0x42915f===0x2){if(_0x18f35b===_0x49b4d2(0x28f))_0x302a9f=this[_0x49b4d2(0x2b3)][_0x49b4d2(0x214)]({'prompt':_0x1401df,'extraParam':_0x277dc,'apiKey':_0x343abe,'proxyUrl':_0x14078c,'model':_0x18f35b,'timeout':_0x105dec,'modelName':_0x382fe9,'groupId':_0x29fdd2,'onSuccess':async _0x13930e=>{const _0x1a47f6=_0x49b4d2;await this[_0x1a47f6(0x261)][_0x1a47f6(0x22e)](_0x434956,{'fileInfo':_0x13930e===null||_0x13930e===void 0x0?void 0x0:_0x13930e[_0x1a47f6(0x26f)],'answer':(_0x13930e===null||_0x13930e===void 0x0?void 0x0:_0x13930e[_0x1a47f6(0x265)])||_0x1401df,'progress':_0x1a47f6(0x2bb),'status':_0x13930e[_0x1a47f6(0x213)]});},'onFailure':async _0x56ed5e=>{const _0x2341f3=_0x49b4d2;await this['chatLogService']['updateChatLog'](_0x434956,{'answer':_0x2341f3(0x210),'status':_0x56ed5e['status']});}},this['buildMessageFromParentMessageId']),await this[_0x49b4d2(0x261)][_0x49b4d2(0x22e)](_0x434956,{'answer':_0x49b4d2(0x1f0)});else{if(_0x18f35b===_0x49b4d2(0x208))common_1[_0x49b4d2(0x26c)]['log'](_0x49b4d2(0x2d4),_0x49b4d2(0x25c)),_0x302a9f=this[_0x49b4d2(0x236)]['aiPPT']({'usePrompt':_0x150f16,'prompt':_0x1401df,'apiKey':_0x343abe,'proxyUrl':_0x14078c,'model':_0x18f35b,'modelName':_0x382fe9,'drawId':_0x11a677,'customId':_0x539800,'action':_0x220dd6,'timeout':_0x105dec,'assistantLogId':_0x434956,'extraParam':_0x277dc,'fileInfo':_0x59e330}),await this[_0x49b4d2(0x261)][_0x49b4d2(0x22e)](_0x434956,{'answer':'生成中'});else{if(_0x18f35b[_0x49b4d2(0x2ba)](_0x49b4d2(0x251)))_0x302a9f=this[_0x49b4d2(0x20c)][_0x49b4d2(0x277)]({'prompt':_0x1401df,'extraParam':_0x277dc,'apiKey':_0x343abe,'proxyUrl':_0x14078c,'model':_0x18f35b,'timeout':_0x105dec,'modelName':_0x382fe9,'groupId':_0x29fdd2,'onSuccess':async _0x2d0b01=>{const _0x4a81bb=_0x49b4d2;await this['chatLogService'][_0x4a81bb(0x22e)](_0x434956,{'fileInfo':_0x2d0b01===null||_0x2d0b01===void 0x0?void 0x0:_0x2d0b01[_0x4a81bb(0x26f)],'answer':(_0x2d0b01===null||_0x2d0b01===void 0x0?void 0x0:_0x2d0b01[_0x4a81bb(0x265)])||_0x1401df,'progress':'100%','status':_0x2d0b01[_0x4a81bb(0x213)]});},'onFailure':async _0x173ea2=>{const _0x29752a=_0x49b4d2;await this['chatLogService']['updateChatLog'](_0x434956,{'answer':_0x29752a(0x210),'status':_0x173ea2[_0x29752a(0x213)]});}},this['buildMessageFromParentMessageId']),await this[_0x49b4d2(0x261)][_0x49b4d2(0x22e)](_0x434956,{'answer':_0x49b4d2(0x1f0)});else{if(_0x18f35b[_0x49b4d2(0x2ba)]('suno-music'))_0x302a9f=this[_0x49b4d2(0x20f)]['suno']({'assistantLogId':_0x434956,'apiKey':_0x343abe,'action':_0x220dd6,'prompt':_0x1401df,'timeout':_0x105dec,'proxyUrl':_0x14078c,'taskData':_0x539800}),await this[_0x49b4d2(0x261)][_0x49b4d2(0x22e)](_0x434956,{'answer':'提交成功，歌曲生成中'});else{if(_0x18f35b[_0x49b4d2(0x2ba)](_0x49b4d2(0x2e0)))_0x302a9f=this[_0x49b4d2(0x24c)][_0x49b4d2(0x259)]({'fileInfo':_0x59e330,'extraParam':_0x277dc,'assistantLogId':_0x434956,'apiKey':_0x343abe,'action':_0x220dd6,'prompt':_0x1401df,'model':_0x18f35b,'timeout':_0x105dec,'proxyUrl':_0x14078c,'taskData':_0x539800,'onGenerate':async _0x72f22d=>{const _0x230991=_0x49b4d2;await this[_0x230991(0x261)][_0x230991(0x22e)](_0x434956,{'fileInfo':_0x72f22d===null||_0x72f22d===void 0x0?void 0x0:_0x72f22d[_0x230991(0x26f)],'answer':(_0x72f22d===null||_0x72f22d===void 0x0?void 0x0:_0x72f22d[_0x230991(0x265)])||_0x1401df,'status':0x2});},'onSuccess':async _0x36971d=>{const _0x27c937=_0x49b4d2;await this[_0x27c937(0x261)][_0x27c937(0x22e)](_0x434956,{'fileInfo':_0x36971d===null||_0x36971d===void 0x0?void 0x0:_0x36971d['fileInfo'],'answer':(_0x36971d===null||_0x36971d===void 0x0?void 0x0:_0x36971d['answer'])||_0x1401df,'progress':_0x27c937(0x2bb),'status':0x3});},'onFailure':async _0x2e9275=>{const _0x400289=_0x49b4d2;await this[_0x400289(0x261)][_0x400289(0x22e)](_0x434956,{'answer':_0x2e9275[_0x400289(0x2a8)],'status':0x4});}}),await this[_0x49b4d2(0x261)][_0x49b4d2(0x22e)](_0x434956,{'answer':'提交成功，视频生成中'});else{if(_0x18f35b[_0x49b4d2(0x2ba)]('cog-video'))_0x302a9f=this[_0x49b4d2(0x1fa)]['cogVideo']({'fileInfo':_0x59e330,'extraParam':_0x277dc,'assistantLogId':_0x434956,'apiKey':_0x343abe,'action':_0x220dd6,'prompt':_0x1401df,'model':_0x18f35b,'timeout':_0x105dec,'proxyUrl':_0x14078c,'taskData':_0x539800,'onGenerate':async _0x32e6fb=>{const _0x416bef=_0x49b4d2;await this[_0x416bef(0x261)][_0x416bef(0x22e)](_0x434956,{'fileInfo':_0x32e6fb===null||_0x32e6fb===void 0x0?void 0x0:_0x32e6fb[_0x416bef(0x26f)],'answer':(_0x32e6fb===null||_0x32e6fb===void 0x0?void 0x0:_0x32e6fb[_0x416bef(0x265)])||_0x1401df,'status':0x2});},'onSuccess':async _0x4525fc=>{const _0x37443b=_0x49b4d2;await this['chatLogService'][_0x37443b(0x22e)](_0x434956,{'fileInfo':_0x4525fc===null||_0x4525fc===void 0x0?void 0x0:_0x4525fc[_0x37443b(0x26f)],'answer':(_0x4525fc===null||_0x4525fc===void 0x0?void 0x0:_0x4525fc[_0x37443b(0x265)])||_0x1401df,'progress':'100%','status':0x3});},'onFailure':async _0x3976eb=>{const _0x129574=_0x49b4d2;await this['chatLogService'][_0x129574(0x22e)](_0x434956,{'answer':_0x3976eb[_0x129574(0x2a8)],'status':0x4});}}),await this[_0x49b4d2(0x261)][_0x49b4d2(0x22e)](_0x434956,{'answer':_0x49b4d2(0x279)});else _0x18f35b[_0x49b4d2(0x2ba)]('stable-diffusion')?(_0x302a9f=this['stableDiffusionService'][_0x49b4d2(0x2c7)]({'chatId':_0x434956,'maxModelTokens':_0x24441c,'apiKey':_0x343abe,'model':_0x18f35b,'modelName':_0x382fe9,'modelType':_0x42915f,'prompt':_0x1401df,'fileInfo':_0x59e330,'isFileUpload':_0x5e2e92,'timeout':_0x105dec,'proxyUrl':_0x14078c,'onSuccess':async _0x398dcf=>{const _0x5ceadb=_0x49b4d2;await this[_0x5ceadb(0x261)][_0x5ceadb(0x22e)](_0x434956,{'fileInfo':_0x398dcf===null||_0x398dcf===void 0x0?void 0x0:_0x398dcf[_0x5ceadb(0x26f)],'answer':(_0x398dcf===null||_0x398dcf===void 0x0?void 0x0:_0x398dcf[_0x5ceadb(0x265)])||_0x1401df,'progress':_0x5ceadb(0x2bb),'status':0x3});},'onFailure':async _0x2f9ee0=>{const _0x344b0e=_0x49b4d2;await this[_0x344b0e(0x261)][_0x344b0e(0x22e)](_0x434956,{'answer':'生成失败','status':0x4});}}),await this[_0x49b4d2(0x261)]['updateChatLog'](_0x434956,{'answer':_0x49b4d2(0x1f0)})):(_0x302a9f=await this[_0x49b4d2(0x231)][_0x49b4d2(0x1dd)]({'usePrompt':_0x150f16,'prompt':_0x1401df,'apiKey':_0x343abe,'proxyUrl':_0x14078c,'model':_0x18f35b,'modelName':_0x382fe9,'drawId':_0x11a677,'customId':_0x539800,'action':_0x220dd6,'fileInfo':_0x59e330,'timeout':_0x105dec,'assistantLogId':_0x434956,'pluginName':_0x5e1b7f}),await this['chatLogService'][_0x49b4d2(0x22e)](_0x434956,{'answer':_0x302a9f[_0x49b4d2(0x265)],'status':_0x302a9f[_0x49b4d2(0x213)]}));}}}}}_0x302a9f[_0x49b4d2(0x213)]!==0x5?(await this[_0x49b4d2(0x298)][_0x49b4d2(0x1e5)](_0x4482ab,0x1),await this['userBalanceService']['deductFromBalance'](_0x18d016['user']['id'],_0x3c8768,_0x1bbd0c)):common_1[_0x49b4d2(0x26c)]['log'](_0x49b4d2(0x2c5),_0x49b4d2(0x20e));const _0x31e04d=await this[_0x49b4d2(0x270)]['queryUserBalance'](_0x18d016[_0x49b4d2(0x268)]['id']);return _0x302a9f[_0x49b4d2(0x2d3)]=Object[_0x49b4d2(0x2c4)]({},_0x31e04d),_0x302a9f['text']=_0x302a9f['answer'],_0x302a9f[_0x49b4d2(0x213)]=_0x302a9f['status']||0x2,_0x302a9f[_0x49b4d2(0x200)]=_0x16b52f,_0x302a9f['modelName']=_0x3b7cf5,_0x928e4a[_0x49b4d2(0x234)]('\x0a'+JSON[_0x49b4d2(0x1e4)](_0x302a9f));}else{_0x302a9f=await this[_0x49b4d2(0x2da)][_0x49b4d2(0x27f)](_0x3bb786,{'chatId':_0x434956,'maxModelTokens':_0x24441c,'apiKey':_0x343abe,'model':_0x18f35b,'modelName':_0x382fe9,'temperature':_0x3fd7df,'modelType':_0x42915f,'prompt':_0x1401df,'fileInfo':_0x59e330,'isFileUpload':_0x5e2e92,'timeout':_0x105dec,'proxyUrl':_0x14078c,'modelAvatar':_0x59acf7,'onProgress':_0x3cdd32=>{const _0xb52406=_0x49b4d2;_0x928e4a[_0xb52406(0x234)](_0x27c9ae?JSON[_0xb52406(0x1e4)](_0x3cdd32):'\x0a'+JSON['stringify'](_0x3cdd32)),_0x27c9ae=![];},'onFailure':async _0x3aad61=>{const _0x54e64c=_0x49b4d2;await this[_0x54e64c(0x261)][_0x54e64c(0x22e)](_0x434956,{'answer':_0x3aad61[_0x54e64c(0x2a8)],'status':0x4});},'abortController':_0x75f426});if(_0x302a9f[_0x49b4d2(0x2a8)])return common_1[_0x49b4d2(0x26c)][_0x49b4d2(0x1de)]('用户ID:\x20'+_0x18d016[_0x49b4d2(0x268)]['id']+_0x49b4d2(0x215)+_0x382fe9+_0x49b4d2(0x249)+_0x16b52f+'\x20回复出错，本次不扣除积分',_0x49b4d2(0x20e)),_0x928e4a[_0x49b4d2(0x234)]('\x0a'+JSON[_0x49b4d2(0x1e4)](_0x302a9f));let _0x2ceb32='';_0x3bb786[_0x49b4d2(0x276)](_0x441f68=>{_0x2ceb32+=_0x441f68['content']+'\x20';});const _0x3887a8=await(0x0,utils_1[_0x49b4d2(0x224)])(_0x2ceb32),_0x4f7eb9=await(0x0,utils_1[_0x49b4d2(0x224)])(_0x302a9f[_0x49b4d2(0x265)]);await this[_0x49b4d2(0x261)][_0x49b4d2(0x22e)](_0x18357b,{'promptTokens':_0x3887a8,'completionTokens':_0x4f7eb9,'totalTokens':_0x3887a8+_0x4f7eb9});let _0x3caf56=_0x302a9f[_0x49b4d2(0x265)];if(_0x339c84==='1'){const _0xa38642=await this['badWordsService'][_0x49b4d2(0x22f)](_0x302a9f['answer'],_0x18d016['user']['id']);if(_0xa38642['length']>0x0){const _0x478168=new RegExp(_0xa38642[_0x49b4d2(0x252)]('|'),'gi');_0x3caf56=_0x3caf56[_0x49b4d2(0x23a)](_0x478168,_0x2f91ce=>'*'[_0x49b4d2(0x2dc)](_0x2f91ce[_0x49b4d2(0x280)]));}}await this[_0x49b4d2(0x261)][_0x49b4d2(0x22e)](_0x434956,{'fileInfo':_0x302a9f===null||_0x302a9f===void 0x0?void 0x0:_0x302a9f[_0x49b4d2(0x26f)],'answer':_0x3caf56,'promptTokens':_0x3887a8,'completionTokens':_0x4f7eb9,'totalTokens':_0x3887a8+_0x4f7eb9,'status':0x3});try{if(_0xa6ab9a==='1'){const _0x5ac9b0=await this[_0x49b4d2(0x2da)]['chatFree'](_0x49b4d2(0x217)+_0x1401df+_0x49b4d2(0x2a6)+_0x302a9f[_0x49b4d2(0x265)]+_0x49b4d2(0x24e));await this[_0x49b4d2(0x261)][_0x49b4d2(0x22e)](_0x434956,{'promptReference':_0x5ac9b0});}}catch(_0xa787a4){common_1[_0x49b4d2(0x26c)]['error'](_0x49b4d2(0x2a1)+_0xa787a4);}_0x1e0b55===!![]&&(_0x1bbd0c=_0x1fba91*Math['ceil']((_0x3887a8+_0x4f7eb9)/_0x455d8c));await this['userBalanceService'][_0x49b4d2(0x226)](_0x18d016[_0x49b4d2(0x268)]['id'],_0x3c8768,_0x1bbd0c,_0x3887a8+_0x4f7eb9),await this[_0x49b4d2(0x298)][_0x49b4d2(0x1e5)](_0x4482ab,_0x3887a8+_0x4f7eb9),common_1[_0x49b4d2(0x26c)][_0x49b4d2(0x29a)](_0x49b4d2(0x2be)+_0x18d016[_0x49b4d2(0x268)]['id']+'\x20模型名称:\x20'+_0x382fe9+_0x49b4d2(0x249)+_0x16b52f+_0x49b4d2(0x243)+(_0x3887a8+_0x4f7eb9)+_0x49b4d2(0x2c1)+_0x1bbd0c,_0x49b4d2(0x20e));const _0x2caaf2=await this[_0x49b4d2(0x270)][_0x49b4d2(0x272)](_0x18d016[_0x49b4d2(0x268)]['id']);return _0x302a9f[_0x49b4d2(0x2d3)]=Object[_0x49b4d2(0x2c4)]({},_0x2caaf2),_0x928e4a['write']('\x0a'+JSON['stringify'](_0x302a9f));}}catch(_0x546179){common_1['Logger'][_0x49b4d2(0x1de)](_0x49b4d2(0x2e2),_0x546179),await this[_0x49b4d2(0x261)]['updateChatLog'](_0x434956,{'status':0x5}),_0x302a9f={'error':_0x49b4d2(0x1e3)};}}else return _0x334898=await this['openAIChatService'][_0x49b4d2(0x27f)](_0x3bb786,{'chatId':_0x434956,'maxModelTokens':_0x24441c,'apiKey':_0x343abe,'model':_0x18f35b,'modelName':_0x382fe9,'modelType':_0x42915f,'temperature':_0x3fd7df,'prompt':_0x1401df,'fileInfo':_0x59e330,'isFileUpload':_0x5e2e92,'timeout':_0x105dec,'proxyUrl':_0x14078c,'abortController':_0x75f426}),await this[_0x49b4d2(0x270)][_0x49b4d2(0x226)](_0x18d016[_0x49b4d2(0x268)]['id'],_0x3c8768,_0x1bbd0c),_0x334898[_0x49b4d2(0x265)];}catch(_0x127ff7){common_1[_0x49b4d2(0x26c)][_0x49b4d2(0x1de)](_0x49b4d2(0x2cf),_0x343abe,_0x127ff7);if(_0x928e4a)return _0x928e4a['write'](_0x49b4d2(0x2c8));else throw new common_1[(_0x49b4d2(0x1da))]('发生未知错误，请稍后再试',common_1[_0x49b4d2(0x292)]['BAD_REQUEST']);}finally{_0x928e4a&&_0x928e4a['end']();}}async['usePlugin'](_0x18e7cc,_0x4db5f8){const _0x379be0=_0x412d3d,{pluginUrl:_0x493835,pluginKey:_0x2964a3}=await this['globalConfigService']['getConfigs']([_0x379be0(0x2c3),_0x379be0(0x27d)]),_0x3553b5=_0x2964a3,_0x55a01b=_0x493835,_0x21bc84={'method':_0x379be0(0x202),'url':_0x55a01b+'/plugins/'+_0x4db5f8,'headers':{'Content-Type':_0x379be0(0x2c9),'Authorization':_0x379be0(0x235)+_0x3553b5},'data':{'prompt':_0x18e7cc}};try{const _0x1dcf8d=await(0x0,axios_1[_0x379be0(0x23d)])(_0x21bc84);return common_1[_0x379be0(0x26c)][_0x379be0(0x29a)](_0x379be0(0x27b)+JSON[_0x379be0(0x1e4)](_0x1dcf8d[_0x379be0(0x2bf)],null,0x2),_0x379be0(0x1e6)),_0x1dcf8d[_0x379be0(0x2bf)][_0x379be0(0x1dc)];}catch(_0x55cad5){common_1[_0x379be0(0x26c)]['error'](_0x379be0(0x28d),_0x55cad5);}}async[_0x412d3d(0x267)](_0x13853f,_0x50ccf9,_0x258e69,_0x1d2978,_0x58d5ee){const _0x2a8186=_0x412d3d;if((_0x50ccf9===null||_0x50ccf9===void 0x0?void 0x0:_0x50ccf9[_0x2a8186(0x21b)])===_0x2a8186(0x228)){let _0x207035;if(_0x258e69===0x1)try{_0x207035=await this[_0x2a8186(0x2da)][_0x2a8186(0x238)]('根据用户提问{'+_0x1d2978+'}，给这个对话取一个名字，不超过10个字'),_0x207035['length']>0xf&&(_0x207035=_0x207035['slice'](0x0,0xf));}catch(_0x27b287){common_1[_0x2a8186(0x26c)][_0x2a8186(0x1de)](_0x2a8186(0x2a1)+_0x27b287),_0x207035=_0x1d2978[_0x2a8186(0x1e8)](0x0,0xa);}else _0x207035=_0x2a8186(0x28c);this[_0x2a8186(0x2d5)]['update']({'groupId':_0x13853f,'title':_0x207035,'isSticky':![],'config':'','fileUrl':''},_0x58d5ee)['then'](()=>common_1[_0x2a8186(0x26c)][_0x2a8186(0x29a)](_0x2a8186(0x229)+_0x207035,_0x2a8186(0x20e)))[_0x2a8186(0x2bc)](_0x4e7fba=>common_1['Logger'][_0x2a8186(0x1de)](_0x2a8186(0x1ee)+_0x4e7fba));}}async['buildMessageFromParentMessageId'](_0x15cfde,_0x529ab8,_0x34e545){const _0x23a01b=_0x412d3d;let {systemMessage:systemMessage='',fileInfo:_0x2b2278,groupId:_0x1732eb,maxRounds:maxRounds=0x5,maxModelTokens:maxModelTokens=0x1f40,isFileUpload:isFileUpload=0x0,isConvertToBase64:_0x5b0ef8}=_0x529ab8;systemMessage[_0x23a01b(0x280)]>maxModelTokens&&(common_1[_0x23a01b(0x26c)][_0x23a01b(0x29a)]('系统消息超过最大长度，将被截断','ChatService'),systemMessage=systemMessage[_0x23a01b(0x1e8)](0x0,maxModelTokens));let _0x5f149d=[];systemMessage&&_0x5f149d[_0x23a01b(0x260)]({'role':_0x23a01b(0x21f),'content':systemMessage});if(_0x1732eb){const _0x4190d3=await _0x34e545[_0x23a01b(0x2df)](_0x1732eb,maxRounds);let _0x1d8865=null;for(const _0x41b911 of _0x4190d3){try{let _0x4b0987;if((isFileUpload===0x2||isFileUpload===0x3)&&_0x41b911['fileInfo']&&_0x41b911[_0x23a01b(0x26a)]===_0x23a01b(0x268)){const _0x434491=await Promise[_0x23a01b(0x25e)](_0x41b911[_0x23a01b(0x26f)][_0x23a01b(0x282)](',')[_0x23a01b(0x216)](async _0x177e2c=>({'type':_0x23a01b(0x2af),'image_url':{'url':_0x5b0ef8==='1'?await this[_0x23a01b(0x2a0)](_0x177e2c[_0x23a01b(0x2ca)]()):_0x177e2c[_0x23a01b(0x2ca)]()}})));_0x4b0987=[{'type':'text','text':_0x41b911[_0x23a01b(0x1dc)]},..._0x434491];}else isFileUpload===0x1&&_0x41b911[_0x23a01b(0x26f)]&&_0x41b911['role']===_0x23a01b(0x268)?_0x4b0987=_0x41b911[_0x23a01b(0x26f)]+'\x0a'+_0x41b911[_0x23a01b(0x1dc)]:_0x4b0987=_0x41b911[_0x23a01b(0x1dc)];if(_0x41b911[_0x23a01b(0x26a)]===_0x23a01b(0x268))_0x1d8865={'role':_0x41b911[_0x23a01b(0x26a)],'content':_0x4b0987};else{if(_0x41b911['role']===_0x23a01b(0x27e)){const _0x272d01=Array['isArray'](_0x4b0987)?JSON[_0x23a01b(0x1e4)](_0x4b0987):_0x4b0987;_0x1d8865&&_0x272d01['trim']()!==''&&(_0x5f149d[_0x23a01b(0x260)](_0x1d8865),_0x5f149d['push']({'role':_0x41b911[_0x23a01b(0x26a)],'content':_0x4b0987}),_0x1d8865=null);}}}catch(_0x159e33){common_1[_0x23a01b(0x26c)][_0x23a01b(0x1de)](_0x23a01b(0x295),_0x159e33,_0x23a01b(0x253),JSON['stringify'](_0x41b911,null,0x2));}}}let _0x30de15;if((isFileUpload===0x2||isFileUpload===0x3)&&_0x2b2278){const _0x23d650=await Promise[_0x23a01b(0x25e)](_0x2b2278[_0x23a01b(0x282)](',')[_0x23a01b(0x216)](async _0x101ba5=>({'type':_0x23a01b(0x2af),'image_url':{'url':_0x5b0ef8==='1'?await this[_0x23a01b(0x2a0)](_0x101ba5[_0x23a01b(0x2ca)]()):_0x101ba5['trim']()}})));_0x30de15=[{'type':_0x23a01b(0x1dc),'text':_0x15cfde},..._0x23d650];}else isFileUpload===0x1&&_0x2b2278?_0x30de15=_0x2b2278+'\x0a'+_0x15cfde:_0x30de15=_0x15cfde;_0x5f149d[_0x23a01b(0x260)]({'role':_0x23a01b(0x268),'content':_0x30de15});let _0x47be6a=await(0x0,utils_1['getTokenCount'])(_0x5f149d),_0x25ff4c;maxModelTokens<0x1f40?_0x25ff4c=0xfa0:_0x25ff4c=maxModelTokens-0xfa0;while(_0x47be6a>_0x25ff4c){if(_0x5f149d[_0x23a01b(0x280)]===0x2&&_0x5f149d[0x0][_0x23a01b(0x26a)]===_0x23a01b(0x21f)&&_0x5f149d[0x1]['role']===_0x23a01b(0x268))break;let _0x48b310=![];for(let _0x4132d2=0x0;_0x4132d2<_0x5f149d[_0x23a01b(0x280)];_0x4132d2++){if(_0x5f149d[_0x4132d2][_0x23a01b(0x26a)]!==_0x23a01b(0x21f)&&_0x5f149d[_0x4132d2+0x1]&&_0x5f149d[_0x4132d2+0x1][_0x23a01b(0x26a)]===_0x23a01b(0x27e)){_0x5f149d[_0x23a01b(0x263)](_0x4132d2,0x2),_0x48b310=!![];break;}}if(!_0x48b310)for(let _0xb59379=0x0;_0xb59379<_0x5f149d['length'];_0xb59379++){if(_0x5f149d[_0xb59379][_0x23a01b(0x26a)]===_0x23a01b(0x268)){_0x5f149d[_0x23a01b(0x263)](_0xb59379,0x1);break;}}_0x47be6a=await(0x0,utils_1[_0x23a01b(0x224)])(_0x5f149d);if(_0x5f149d[_0x23a01b(0x280)]<=0x2)break;}return{'messagesHistory':_0x5f149d,'round':_0x5f149d[_0x23a01b(0x280)]};}async[_0x412d3d(0x2a0)](_0x212c8c){const _0x164ca0=_0x412d3d;try{console[_0x164ca0(0x29a)](_0x164ca0(0x2d7)+_0x212c8c);const _0x1abe99=await axios_1[_0x164ca0(0x23d)][_0x164ca0(0x2bd)](_0x212c8c,{'responseType':_0x164ca0(0x205)}),_0x166b49=Buffer[_0x164ca0(0x257)](_0x1abe99[_0x164ca0(0x2bf)],_0x164ca0(0x26b));console[_0x164ca0(0x29a)](_0x164ca0(0x22d)+_0x212c8c);const _0x21623d=_0x164ca0(0x271)+_0x1abe99[_0x164ca0(0x2b2)][_0x164ca0(0x278)]+_0x164ca0(0x2a5)+_0x166b49[_0x164ca0(0x20b)](_0x164ca0(0x2aa));return console[_0x164ca0(0x29a)](_0x164ca0(0x247)+_0x212c8c),_0x21623d;}catch(_0x3dc30b){return console[_0x164ca0(0x1de)](_0x164ca0(0x285),_0x3dc30b),console['warn']('返回原始链接:\x20'+_0x212c8c),_0x212c8c;}}async[_0x412d3d(0x2b9)](_0x4131e5,_0x1682f9,_0x6d8a8a){const _0x5e7864=_0x412d3d,{chatId:_0x5126be,prompt:_0x264929}=_0x4131e5,_0x7fec22=await this[_0x5e7864(0x298)][_0x5e7864(0x1df)](_0x5e7864(0x24b)),{openaiTimeout:_0x263fcb,openaiBaseUrl:_0x1d06a1,openaiBaseKey:_0x276016,openaiVoice:_0x1f3f28}=await this[_0x5e7864(0x29b)][_0x5e7864(0x29c)]([_0x5e7864(0x2ae),_0x5e7864(0x2c2),_0x5e7864(0x20a),_0x5e7864(0x26d)]),{key:_0x495e68,proxyUrl:_0x10f4e9,deduct:_0x2f3e07,deductType:_0x40182f,timeout:_0x121bc2}=_0x7fec22,_0x58600e=_0x495e68||_0x276016,_0x279f4b=(0x0,utils_1[_0x5e7864(0x1e1)])(_0x10f4e9||_0x1d06a1),_0x273cac=(_0x121bc2||_0x263fcb)*0x3e8;await this[_0x5e7864(0x270)][_0x5e7864(0x1ef)](_0x1682f9,_0x40182f,_0x2f3e07),common_1['Logger'][_0x5e7864(0x29a)]('开始\x20TTS\x20请求:',_0x264929,_0x5e7864(0x2cc));const _0x2d6d55={'method':_0x5e7864(0x202),'url':_0x279f4b+_0x5e7864(0x1f8),'headers':{'Content-Type':_0x5e7864(0x2c9),'Authorization':_0x5e7864(0x235)+_0x58600e},'responseType':_0x5e7864(0x205),'timeout':_0x273cac,'data':{'model':'tts-1','input':_0x264929,'voice':_0x1f3f28||_0x5e7864(0x244)}};try{const _0x135349=await(0x0,axios_1[_0x5e7864(0x23d)])(_0x2d6d55);common_1[_0x5e7864(0x26c)][_0x5e7864(0x29a)]('TTS\x20请求获取成功',_0x5e7864(0x2cc));const _0x408f76=Buffer[_0x5e7864(0x257)](_0x135349[_0x5e7864(0x2bf)]),_0x59430a=new Date(),_0x3a0394=_0x59430a[_0x5e7864(0x288)](),_0x157ba9=String(_0x59430a[_0x5e7864(0x1f6)]()+0x1)['padStart'](0x2,'0'),_0x3d2f55=String(_0x59430a[_0x5e7864(0x233)]())[_0x5e7864(0x275)](0x2,'0'),_0x5a5d37=''+_0x3a0394+_0x157ba9+'/'+_0x3d2f55,_0x2b8314=await this['uploadService'][_0x5e7864(0x273)]({'buffer':_0x408f76,'mimetype':_0x5e7864(0x2db)},_0x5e7864(0x1e9)+_0x5a5d37);await Promise['all']([this['chatLogService'][_0x5e7864(0x22e)](_0x5126be,{'ttsUrl':_0x2b8314}),this[_0x5e7864(0x270)][_0x5e7864(0x226)](_0x1682f9[_0x5e7864(0x268)]['id'],_0x40182f,_0x2f3e07)]),_0x6d8a8a[_0x5e7864(0x213)](0xc8)[_0x5e7864(0x23e)]({'ttsUrl':_0x2b8314});}catch(_0x1bb36b){common_1[_0x5e7864(0x26c)][_0x5e7864(0x1de)](_0x5e7864(0x23c),_0x1bb36b,_0x5e7864(0x2cc)),_0x6d8a8a[_0x5e7864(0x213)](0x1f4)[_0x5e7864(0x23e)]({'error':_0x5e7864(0x242)});}}};ChatService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(config_entity_1['ConfigEntity'])),__param(0x1,(0x0,typeorm_1[_0x412d3d(0x256)])(app_entity_1[_0x412d3d(0x2a3)])),__param(0x2,(0x0,typeorm_1[_0x412d3d(0x256)])(plugin_entity_1['PluginEntity'])),__metadata(_0x412d3d(0x1f1),[typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2[_0x412d3d(0x1f4)],suno_service_1[_0x412d3d(0x29f)],openaiChat_service_1[_0x412d3d(0x2ad)],chatLog_service_1['ChatLogService'],midjourneyDraw_service_1[_0x412d3d(0x25d)],stableDiffusion_service_1[_0x412d3d(0x24d)],userBalance_service_1[_0x412d3d(0x2d1)],user_service_1['UserService'],upload_service_1[_0x412d3d(0x28e)],badWords_service_1[_0x412d3d(0x23b)],autoreply_service_1[_0x412d3d(0x1f2)],globalConfig_service_1[_0x412d3d(0x290)],chatGroup_service_1[_0x412d3d(0x1f5)],models_service_1[_0x412d3d(0x1e0)],openaiDraw_service_1[_0x412d3d(0x2c0)],lumaVideo_service_1[_0x412d3d(0x2c6)],cogVideo_service_1[_0x412d3d(0x219)],fluxDraw_service_1[_0x412d3d(0x1db)],aiPPT_1['AiPptService']])],ChatService),exports[_0x412d3d(0x20e)]=ChatService;