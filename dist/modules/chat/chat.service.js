'use strict';const _0x2690ef=_0x3064;(function(_0x53c8e6,_0x3908e2){const _0x57baff=_0x3064,_0x337620=_0x53c8e6();while(!![]){try{const _0x3abab3=parseInt(_0x57baff(0xd2))/0x1*(-parseInt(_0x57baff(0x12b))/0x2)+parseInt(_0x57baff(0xeb))/0x3+parseInt(_0x57baff(0xc8))/0x4*(parseInt(_0x57baff(0x90))/0x5)+-parseInt(_0x57baff(0x10a))/0x6*(parseInt(_0x57baff(0xa2))/0x7)+parseInt(_0x57baff(0x7a))/0x8*(parseInt(_0x57baff(0xc4))/0x9)+-parseInt(_0x57baff(0x160))/0xa+parseInt(_0x57baff(0x14b))/0xb*(parseInt(_0x57baff(0x119))/0xc);if(_0x3abab3===_0x3908e2)break;else _0x337620['push'](_0x337620['shift']());}catch(_0x32dbc7){_0x337620['push'](_0x337620['shift']());}}}(_0xa365,0xa2dc1));function _0xa365(){const _0x277e63=['abort','join','getTokenCount','】，在回答问题之前，先检索知识库内有没有相关的内容，尽量使用知识库中获取到的信息来回答我的问题，以知识库中的为准。','HttpException','data','from','default','更新标题名称为:\x20','pluginUrl','gpts','object','../ai/lumaVideo.service','pluginEntity','AppEntity','100%','base64','转换URL为Base64时发生错误:','1991eioeCf','ceil','\x20回复出错，本次不扣除积分','midjourneyDraw','AiPptService','modelsService','模型切换错误，请检查全局模型配置！','PluginService','stableDiffusionService','saveUseLog','write','@nestjs/typeorm','根据用户提问{','DrawService','lumaVideoService','match','startsWith','../user/user.service','preset','split','POST','8518780sSAMMl','../ai/suno.service','axios','getMonth','绘制中','setHeader','updateTime','ai-ppt','cogVideoService','OpenAIDrawService','parse','stable-diffusion','../ai/midjourneyDraw.service','chatGroupService','chat-error\x20<----------------------------------------->','MidjourneyService','metadata','checkUserStatus','TTSService','title','发生未知错误，请稍后再试','处理请求时发生错误','openAIChat','suno-music','/plugins/','InjectRepository','send','lumaVideo','isSystemPlugin','all','../upload/upload.service','model','role','5142808OgTonG','../ai/cogVideo.service','toString','以下是我提供给你的知识库：【','chatHistory','isMjTranslate','成功转换URL为Base64:\x20','deductFromBalance','slice','__metadata','\x20模型名称:\x20','__decorate','插件调用成功\x20返回结果:\x20','openaiTimeout','GlobalConfigService','saveChatLog','cogVideo','midjourney-turbo','../ai/aiPPT','返回原始链接:\x20','UploadService','getClientIp','9695nfDOhn','checkBadWords','ChatGroupService','close','新对话','map','splice','\x0a\x20Current\x20date:\x20','updateChatLog','\x20模型:\x20','openaiBaseModel','system','CogVideoService','dall-e-3','appEntity','SunoService','开始\x20TTS\x20请求:','系统消息超过最大长度，将被截断','20713waOvhH','创意\x20AI','fluxDrawService','end','PluginEntity','openAIChatService','convertUrlToBase64','../ai/fluxDraw.service','openaiBaseUrl','then','cog-video','pluginImg','updateChatTitle','error','../app/app.entity','HttpStatus','提交成功，歌曲生成中','onyx','warn','ChatService','userBalanceService','fileInfo','formatUrl','config','ModelsService','LumaVideoService','globalConfigService','chatLogService','parameters','replace','systemPreMessage','modelInfo','openAIDrawService','sunoService','9HVpUXA','chatProcess','TTS\x20请求获取成功','userBalance','2068nbRsXw','Logger','插件返回结果:\x20','midjourneyService','aiPPT','application/octet-stream;\x20charset=utf-8','push','debug','使用全局预设:\x20','TTS\x20请求或上传过程失败:','1FwBVAo','AutoreplyService','trim','content','生成失败','buildMessageFromParentMessageId','提交成功，视频生成中','dalleDraw','正在尝试转换URL为Base64:\x20','queryUserBalance','绘图失败','Failed\x20to\x20process\x20TTS\x20request','assign','image_url','开始生成PPT','您提交的信息中包含违规的内容，我们已对您的账户进行标记，请合规使用！','length','UserBalanceService','catch','getGroupInfoFromId','uploadFile','midjourney','badWordsService','arraybuffer','getConfigs','757359EkbZAd','BadWordsService','生成中',',\x20消耗积分：\x20','调用\x20chatFree\x20出错:\x20','记录:','成功获取图片，正在转换为Base64:\x20','../userBalance/userBalance.service','errMsg','Injectable','openaiBaseKey','chatFree','decorate','midjourney-relax','mjTranslatePrompt','modelName','luma-video','isArray','toISOString','user','openaiVoice','FluxDrawService','使用插件预设:\x20','typeorm','https://api.openai.com','text','isConvertToBase64','BAD_REQUEST','update','未找到当前模型key，切换至全局模型','status','1584DIiIsi','使用应用预设:\x20','midjourney-fast','uploadService','data:','assistant','Repository','}，生成三个更进入一步的提问，用{}包裹每个问题，不需要分行，不需要其他任何内容，单个提问不超过30个字','配置解析错误！','answer','1\x20小时内对话次数过多，请切换模型或稍后再试！','checkModelLimits','application/json','}，给这个对话取一个名字，不超过10个字','你当前使用的应用已被下架、请删除当前对话开启新的对话吧！','38484QwFFWK','userService','../badWords/badWords.service','getCurrentModelKeyInfo','StableDiffusionService','tts-1','isGeneratePromptReference','发生错误:','UserService','includes','stringify','audio/openai/','aiPptService','ttsProcess','validateBalance','处理历史记录时出错:','autoreplyService','flux','356214bWMbdx','/v1/audio/speech','getFullYear','log','getOwnPropertyDescriptor','../autoreply/autoreply.service','OpenAIChatService','findOne','../globalConfig/globalConfig.service','content-type','../models/models.service','\x20消耗token:\x20','function','padStart'];_0xa365=function(){return _0x277e63;};return _0xa365();}var __decorate=this&&this[_0x2690ef(0x85)]||function(_0x196610,_0x42bf52,_0x2e48cc,_0x3735bc){const _0x49da02=_0x2690ef;var _0x1e8ba9=arguments['length'],_0x328605=_0x1e8ba9<0x3?_0x42bf52:_0x3735bc===null?_0x3735bc=Object[_0x49da02(0x12f)](_0x42bf52,_0x2e48cc):_0x3735bc,_0x4b2dbf;if(typeof Reflect===_0x49da02(0x144)&&typeof Reflect[_0x49da02(0xf7)]===_0x49da02(0x137))_0x328605=Reflect[_0x49da02(0xf7)](_0x196610,_0x42bf52,_0x2e48cc,_0x3735bc);else{for(var _0x21b4e5=_0x196610[_0x49da02(0xe2)]-0x1;_0x21b4e5>=0x0;_0x21b4e5--)if(_0x4b2dbf=_0x196610[_0x21b4e5])_0x328605=(_0x1e8ba9<0x3?_0x4b2dbf(_0x328605):_0x1e8ba9>0x3?_0x4b2dbf(_0x42bf52,_0x2e48cc,_0x328605):_0x4b2dbf(_0x42bf52,_0x2e48cc))||_0x328605;}return _0x1e8ba9>0x3&&_0x328605&&Object['defineProperty'](_0x42bf52,_0x2e48cc,_0x328605),_0x328605;},__metadata=this&&this[_0x2690ef(0x83)]||function(_0x4df57c,_0x3206bf){const _0x29f295=_0x2690ef;if(typeof Reflect===_0x29f295(0x144)&&typeof Reflect['metadata']===_0x29f295(0x137))return Reflect[_0x29f295(0x170)](_0x4df57c,_0x3206bf);},__param=this&&this['__param']||function(_0x3dd31d,_0x1cfebd){return function(_0xf7a259,_0x233538){_0x1cfebd(_0xf7a259,_0x233538,_0x3dd31d);};};function _0x3064(_0x5a15ab,_0x53b604){const _0xa3656a=_0xa365();return _0x3064=function(_0x3064e4,_0x1abb9a){_0x3064e4=_0x3064e4-0x72;let _0x3017cb=_0xa3656a[_0x3064e4];return _0x3017cb;},_0x3064(_0x5a15ab,_0x53b604);}Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[_0x2690ef(0xb5)]=void 0x0;const utils_1=require('../../common/utils'),common_1=require('@nestjs/common'),typeorm_1=require(_0x2690ef(0x156)),axios_1=require(_0x2690ef(0x162)),typeorm_2=require(_0x2690ef(0x102)),aiPPT_1=require(_0x2690ef(0x8c)),cogVideo_service_1=require(_0x2690ef(0x7b)),fluxDraw_service_1=require(_0x2690ef(0xa9)),lumaVideo_service_1=require(_0x2690ef(0x145)),midjourneyDraw_service_1=require(_0x2690ef(0x16c)),openaiChat_service_1=require('../ai/openaiChat.service'),openaiDraw_service_1=require('../ai/openaiDraw.service'),stableDiffusion_service_1=require('../ai/stableDiffusion.service'),suno_service_1=require(_0x2690ef(0x161)),app_entity_1=require(_0x2690ef(0xb0)),autoreply_service_1=require(_0x2690ef(0x130)),badWords_service_1=require(_0x2690ef(0x11b)),chatGroup_service_1=require('../chatGroup/chatGroup.service'),chatLog_service_1=require('../chatLog/chatLog.service'),config_entity_1=require('../globalConfig/config.entity'),globalConfig_service_1=require(_0x2690ef(0x133)),models_service_1=require(_0x2690ef(0x135)),plugin_entity_1=require('../plugin/plugin.entity'),upload_service_1=require(_0x2690ef(0x77)),user_service_1=require(_0x2690ef(0x15c)),userBalance_service_1=require(_0x2690ef(0xf2));let ChatService=class ChatService{constructor(_0x34e8e6,_0xcdba13,_0x10d35d,_0x526501,_0xb4c4e7,_0x9a784d,_0x5aa3af,_0x21d925,_0x48dd0a,_0x2c912e,_0x55f983,_0x3f79a9,_0x47bb43,_0x377b9d,_0x2e87fc,_0x12938a,_0x1e6ae1,_0x503ba6,_0x43598f,_0x5e6546,_0x435819){const _0x536745=_0x2690ef;this['configEntity']=_0x34e8e6,this[_0x536745(0x9e)]=_0xcdba13,this['pluginEntity']=_0x10d35d,this[_0x536745(0xc3)]=_0x526501,this[_0x536745(0xa7)]=_0xb4c4e7,this[_0x536745(0xbd)]=_0x9a784d,this[_0x536745(0xcb)]=_0x5aa3af,this[_0x536745(0x153)]=_0x21d925,this[_0x536745(0xb6)]=_0x48dd0a,this[_0x536745(0x11a)]=_0x2c912e,this[_0x536745(0x10d)]=_0x55f983,this[_0x536745(0xe8)]=_0x3f79a9,this[_0x536745(0x129)]=_0x47bb43,this[_0x536745(0xbc)]=_0x377b9d,this[_0x536745(0x16d)]=_0x2e87fc,this[_0x536745(0x150)]=_0x12938a,this[_0x536745(0xc2)]=_0x1e6ae1,this['lumaVideoService']=_0x503ba6,this[_0x536745(0x168)]=_0x43598f,this['fluxDrawService']=_0x5e6546,this[_0x536745(0x125)]=_0x435819;}async[_0x2690ef(0xc5)](_0x1db105,_0x158cc3,_0x178d9a){const _0x3889ad=_0x2690ef;await this['userBalanceService']['checkUserCertification'](_0x158cc3[_0x3889ad(0xfe)]['id']);const {options:options={},usingPluginId:_0x2a02cc,appId:appId=null,specialModel:_0x3e2bda,prompt:_0x3bdc4c,fileInfo:_0x2878a1,extraParam:_0x309327,model:_0x120051,drawId:_0x1d2bd1,customId:_0x124528,action:_0x2ef21f,modelName:_0x560fa4,modelAvatar:_0x33f170}=_0x1db105;let _0x1716af;if(_0x3e2bda)_0x1716af=await this[_0x3889ad(0x9e)][_0x3889ad(0x132)]({'where':{'des':_0x3e2bda,'isSystemReserved':!![]}});else{if(appId){_0x1716af=await this['appEntity']['findOne']({'where':{'id':appId,'status':(0x0,typeorm_2['In'])([0x1,0x3,0x4,0x5])}});if(!_0x1716af)throw new common_1['HttpException'](_0x3889ad(0x118),common_1['HttpStatus']['BAD_REQUEST']);}}const {groupId:_0x1a54bd,fileParsing:_0x3ee8f0}=options,{openaiTimeout:_0x5a2f7e,openaiBaseUrl:_0x4d3813,openaiBaseKey:_0x45761,systemPreMessage:_0xe98698,isMjTranslate:_0x279126,mjTranslatePrompt:_0x3c6689,openaiTemperature:_0xa0d336,openaiBaseModel:_0x5cf630,isGeneratePromptReference:_0x1d1df6,isConvertToBase64:_0x4c8f68,isSensitiveWordFilter:_0x1308c6}=await this[_0x3889ad(0xbc)][_0x3889ad(0xea)]([_0x3889ad(0x87),_0x3889ad(0xaa),_0x3889ad(0xf5),_0x3889ad(0xc0),_0x3889ad(0x7f),_0x3889ad(0xf9),'openaiTemperature',_0x3889ad(0x9a),_0x3889ad(0x11f),_0x3889ad(0x105),'isSensitiveWordFilter']);await this[_0x3889ad(0x11a)][_0x3889ad(0x171)](_0x158cc3['user']),_0x178d9a&&_0x178d9a[_0x3889ad(0x165)]('Content-type',_0x3889ad(0xcd));if(_0x1308c6==='1'){const _0x427c34=await this[_0x3889ad(0xe8)][_0x3889ad(0x91)](_0x3bdc4c,_0x158cc3[_0x3889ad(0xfe)]['id']);if(_0x427c34[_0x3889ad(0xe2)]>0x0){const _0x386793=_0x3889ad(0xe1);throw new common_1[(_0x3889ad(0x13d))](_0x386793,common_1[_0x3889ad(0xb1)][_0x3889ad(0x106)]);}}const _0x5129b1=await this[_0x3889ad(0x129)]['checkAutoReply'](_0x3bdc4c);let _0x2797b5=null,_0x922ee3='',_0xbd8888='';_0x178d9a&&_0x178d9a['status'](0xc8);let _0x2c90ff=null;const _0x14b7a4=(0x0,utils_1[_0x3889ad(0x8f)])(_0x158cc3);let _0x14bf67,_0x11add4='',_0x14d74d;_0x2a02cc&&(_0x14d74d=await this[_0x3889ad(0x146)][_0x3889ad(0x132)]({'where':{'id':_0x2a02cc}}));if(_0x1716af){const {isGPTs:_0x2d9802,gizmoID:_0x237c7e,name:_0x4af299,isFixedModel:_0x2132c8,appModel:_0x22a629,coverImg:_0x1c0258}=_0x1716af;_0x11add4=_0x1c0258,_0x922ee3=_0x4af299;if(_0x2d9802)_0x2797b5=await this['modelsService'][_0x3889ad(0x11c)](_0x3889ad(0x143)),_0x2797b5['model']='gpt-4-gizmo-'+_0x237c7e;else!_0x2d9802&&_0x2132c8&&_0x22a629?(_0x1716af['preset']&&(_0xbd8888=_0x1716af[_0x3889ad(0x15d)]),_0x2797b5=await this['modelsService'][_0x3889ad(0x11c)](_0x22a629),_0x2797b5[_0x3889ad(0x78)]=_0x22a629,_0x3ee8f0&&(_0xbd8888=_0xbd8888+_0x3889ad(0x7d)+_0x3ee8f0+'】，在回答问题之前，先检索知识库内有没有相关的内容，尽量使用知识库中获取到的信息来回答我的问题，以知识库中的为准。'),common_1[_0x3889ad(0xc9)][_0x3889ad(0x12e)]('固定模型、使用应用预设:\x20'+_0xbd8888,_0x3889ad(0xb5))):(_0x1716af[_0x3889ad(0x15d)]&&(_0xbd8888=_0x1716af[_0x3889ad(0x15d)]),_0x2797b5=await this[_0x3889ad(0x150)][_0x3889ad(0x11c)](_0x120051),_0x3ee8f0&&(_0xbd8888=_0xbd8888+_0x3889ad(0x7d)+_0x3ee8f0+_0x3889ad(0x13c)),common_1[_0x3889ad(0xc9)][_0x3889ad(0x12e)](_0x3889ad(0x10b)+_0xbd8888,_0x3889ad(0xb5)));}else{const _0x50d3d6=await this[_0x3889ad(0x16d)]['getGroupInfoFromId'](_0x1a54bd);if(_0x14d74d&&_0x14d74d[_0x3889ad(0x75)]===0x0){let _0x310569='';try{_0x310569=await this['usePlugin'](_0x3bdc4c,_0x14d74d['parameters']),common_1[_0x3889ad(0xc9)][_0x3889ad(0x12e)](_0x3889ad(0xca)+_0x310569,_0x3889ad(0xb5));}catch(_0x5de8d1){_0x310569=_0x3bdc4c,common_1['Logger'][_0x3889ad(0xaf)]('插件调用错误:\x20'+_0x5de8d1);}_0xbd8888=_0x310569,_0x2797b5=await this['modelsService'][_0x3889ad(0x11c)](_0x120051),common_1[_0x3889ad(0xc9)][_0x3889ad(0x12e)](_0x3889ad(0x101)+_0xbd8888,_0x3889ad(0xb5));}else{if(_0x3ee8f0)_0xbd8888=_0x3889ad(0x7d)+_0x3ee8f0+_0x3889ad(0x13c),_0x2797b5=await this[_0x3889ad(0x150)]['getCurrentModelKeyInfo'](_0x120051),common_1[_0x3889ad(0xc9)][_0x3889ad(0x12e)]('使用文件解析:\x20'+_0xbd8888,_0x3889ad(0xb5));else{const _0x2b62df=new Date()[_0x3889ad(0xfd)]()['split']('T')[0x0];_0xbd8888=_0xe98698+(_0x3889ad(0x97)+_0x2b62df),_0x2797b5=await this[_0x3889ad(0x150)]['getCurrentModelKeyInfo'](_0x120051),common_1[_0x3889ad(0xc9)]['log'](_0x3889ad(0xd0)+_0xbd8888,_0x3889ad(0xb5));}}}if(!_0x2797b5){common_1[_0x3889ad(0xc9)][_0x3889ad(0xcf)](_0x3889ad(0x108),_0x3889ad(0xb5)),_0x2797b5=await this[_0x3889ad(0x150)][_0x3889ad(0x11c)](_0x5cf630);const _0x503a5a=await this['chatGroupService'][_0x3889ad(0xe5)](_0x1a54bd);let _0x919f06=_0x503a5a[_0x3889ad(0xb9)];try{const _0x51907d=JSON[_0x3889ad(0x16a)](_0x503a5a['config']);_0x51907d[_0x3889ad(0xc1)]&&(_0x51907d[_0x3889ad(0xc1)][_0x3889ad(0xfa)]=_0x2797b5['modelName'],_0x51907d['modelInfo'][_0x3889ad(0x78)]=_0x2797b5[_0x3889ad(0x78)],_0x919f06=JSON[_0x3889ad(0x123)](_0x51907d));}catch(_0x250ce7){common_1[_0x3889ad(0xc9)][_0x3889ad(0xcf)](_0x3889ad(0x151),_0x3889ad(0xb5));throw new common_1[(_0x3889ad(0x13d))](_0x3889ad(0x112),common_1[_0x3889ad(0xb1)][_0x3889ad(0x106)]);}await this[_0x3889ad(0x16d)][_0x3889ad(0x107)]({'groupId':_0x1a54bd,'title':_0x503a5a[_0x3889ad(0x173)],'isSticky':![],'config':_0x919f06,'fileUrl':''},_0x158cc3);}const {deduct:_0x5608df,isTokenBased:_0x25388e,tokenFeeRatio:_0x37e31c,deductType:_0x5d1b39,key:_0x299058,id:_0x438a48,maxRounds:_0x581816,proxyUrl:_0xaaf2a9,maxModelTokens:_0x1c2afb,timeout:_0x10cf8a,model:_0x122bbf,isFileUpload:_0x307d56,keyType:_0x218fcd}=_0x2797b5;if(await this['chatLogService'][_0x3889ad(0x115)](_0x158cc3[_0x3889ad(0xfe)],_0x122bbf))throw new common_1[(_0x3889ad(0x13d))](_0x3889ad(0x114),common_1[_0x3889ad(0xb1)]['TOO_MANY_REQUESTS']);if(_0x279126==='1'&&_0x2ef21f==='IMAGINE'&&(_0x120051===_0x3889ad(0xe7)||_0x120051===_0x3889ad(0xf8)||_0x120051===_0x3889ad(0x10c)||_0x120051===_0x3889ad(0x8b))){const [_0x20cd09,_0x45edc9]=_0x3bdc4c[_0x3889ad(0x15e)](/(?= --)/),_0x104bb2=/(https?:\/\/[^\s]+)/g,_0x157564=_0x20cd09[_0x3889ad(0x15a)](_0x104bb2)||[];let _0x7c2c92=_0x20cd09[_0x3889ad(0xbf)](_0x104bb2,'')[_0x3889ad(0xd4)]();const _0x13ea84=await this[_0x3889ad(0xa7)][_0x3889ad(0xf6)](_0x7c2c92,_0x3c6689||'Translate\x20any\x20given\x20phrase\x20from\x20any\x20language\x20into\x20English.\x20For\x20instance,\x20when\x20I\x20input\x20\x27{可爱的熊猫}\x27,\x20you\x20should\x20output\x20\x27{cute\x20panda}\x27,\x20with\x20no\x20period\x20at\x20the\x20end.'),_0x360424=[..._0x157564,_0x13ea84][_0x3889ad(0x13a)]('\x20')['trim']();_0x14bf67=_0x45edc9?''+_0x360424+_0x45edc9:_0x360424,_0x307d56==='1'&&_0x2878a1&&(_0x14bf67=_0x2878a1+'\x20'+_0x14bf67);}else _0x14bf67=_0x307d56==='1'&&_0x2878a1?_0x2878a1+'\x20'+_0x3bdc4c:_0x3bdc4c;await this['userBalanceService'][_0x3889ad(0x127)](_0x158cc3,_0x5d1b39,_0x5608df);const _0x4b5513=_0x560fa4,_0x2d8e71=(0x0,utils_1[_0x3889ad(0xb8)])(_0xaaf2a9||_0x4d3813||_0x3889ad(0x103)),_0x417f70=_0x299058||_0x45761,_0x5a9a3f=(_0x10cf8a||_0x5a2f7e||0x12c)*0x3e8,_0x569742=Number(_0xa0d336)||0x1;if(_0x1a54bd){const _0xb225a0=await this['chatGroupService']['getGroupInfoFromId'](_0x1a54bd);this['updateChatTitle'](_0x1a54bd,_0xb225a0,_0x218fcd,_0x3bdc4c,_0x158cc3),await this[_0x3889ad(0x16d)][_0x3889ad(0x166)](_0x1a54bd);}const _0x58abaa=await this[_0x3889ad(0xbd)][_0x3889ad(0x89)]({'appId':appId,'curIp':_0x14b7a4,'userId':_0x158cc3[_0x3889ad(0xfe)]['id'],'type':_0x218fcd?_0x218fcd:0x1,'prompt':_0x3bdc4c,'fileInfo':_0x2878a1?_0x2878a1:null,'answer':'','promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x122bbf,'modelName':'我','role':'user','groupId':_0x1a54bd?_0x1a54bd:null}),_0x1e6871=await this['chatLogService'][_0x3889ad(0x89)]({'appId':appId?appId:null,'action':_0x2ef21f?_0x2ef21f:null,'curIp':_0x14b7a4,'userId':_0x158cc3[_0x3889ad(0xfe)]['id'],'type':_0x218fcd?_0x218fcd:0x1,'prompt':_0x3bdc4c,'fileInfo':null,'answer':'','progress':'0%','promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x122bbf,'modelName':_0x4b5513,'role':'assistant','groupId':_0x1a54bd?_0x1a54bd:null,'status':0x2,'modelAvatar':(_0x14d74d===null||_0x14d74d===void 0x0?void 0x0:_0x14d74d[_0x3889ad(0xad)])||_0x11add4||_0x33f170||'','pluginParam':(_0x14d74d===null||_0x14d74d===void 0x0?void 0x0:_0x14d74d[_0x3889ad(0xbe)])?_0x14d74d[_0x3889ad(0xbe)]:_0x218fcd===0x2?_0x122bbf:null}),_0x5f007d=_0x58abaa['id'],_0x5492b7=_0x1e6871['id'];if(_0x5129b1[_0x3889ad(0x113)]&&_0x178d9a){if(_0x5129b1['isAIReplyEnabled']===0x0){const _0x451fee=_0x5129b1[_0x3889ad(0x113)][_0x3889ad(0x15e)](''),_0x36f93a=_0x45244a=>{const _0x87f593=_0x3889ad;if(_0x45244a<_0x451fee[_0x87f593(0xe2)]){const _0x4d0072={'text':_0x451fee[_0x45244a]};_0x178d9a[_0x87f593(0x155)](JSON[_0x87f593(0x123)](_0x4d0072)+'\x0a'),setTimeout(()=>_0x36f93a(_0x45244a+0x1),0xa);}else _0x178d9a[_0x87f593(0xa5)]();};_0x36f93a(0x0),await this[_0x3889ad(0xbd)][_0x3889ad(0x98)](_0x5492b7,{'answer':_0x5129b1[_0x3889ad(0x113)]});return;}else _0xbd8888=_0xbd8888+_0x5129b1['answer'];}const {messagesHistory:_0x24c990}=await this['buildMessageFromParentMessageId'](_0x3bdc4c,{'groupId':_0x1a54bd,'systemMessage':_0xbd8888,'maxModelTokens':_0x1c2afb,'maxRounds':_0x581816,'isConvertToBase64':_0x4c8f68,'fileInfo':_0x2878a1,'model':_0x122bbf,'isFileUpload':_0x307d56},this[_0x3889ad(0xbd)]);let _0x3922c4=_0x2ef21f!=='UPSCALE'&&_0x122bbf[_0x3889ad(0x15b)](_0x3889ad(0xe7))?_0x5608df*0x4:_0x5608df;const _0x5c8d1e=new AbortController();try{if(_0x178d9a){_0x178d9a['on'](_0x3889ad(0x93),()=>{const _0x5a4a22=_0x3889ad;_0x5c8d1e[_0x5a4a22(0x139)]();});let _0x11eac0,_0x557a48=!![];try{if((_0x122bbf===_0x3889ad(0x9d)||_0x122bbf===_0x3889ad(0xe7)||_0x122bbf===_0x3889ad(0xf8)||_0x122bbf==='ai-ppt'||_0x122bbf==='suno-music'||_0x122bbf===_0x3889ad(0xfb)||_0x122bbf[_0x3889ad(0x122)](_0x3889ad(0x16b))||_0x122bbf['includes'](_0x3889ad(0xac))||_0x122bbf[_0x3889ad(0x15b)]('midjourney')||_0x122bbf[_0x3889ad(0x122)](_0x3889ad(0x12a)))&&_0x218fcd===0x2){if(_0x122bbf===_0x3889ad(0x9d))_0x11eac0=this[_0x3889ad(0xc2)][_0x3889ad(0xd9)]({'prompt':_0x3bdc4c,'extraParam':_0x309327,'apiKey':_0x417f70,'proxyUrl':_0x2d8e71,'model':_0x122bbf,'timeout':_0x5a9a3f,'modelName':_0x4b5513,'groupId':_0x1a54bd,'onSuccess':async _0x369878=>{const _0x25e872=_0x3889ad;await this['chatLogService']['updateChatLog'](_0x5492b7,{'fileInfo':_0x369878===null||_0x369878===void 0x0?void 0x0:_0x369878['fileInfo'],'answer':(_0x369878===null||_0x369878===void 0x0?void 0x0:_0x369878[_0x25e872(0x113)])||_0x3bdc4c,'progress':_0x25e872(0x148),'status':_0x369878['status']});},'onFailure':async _0x5eb546=>{const _0x539fc2=_0x3889ad;await this[_0x539fc2(0xbd)][_0x539fc2(0x98)](_0x5492b7,{'answer':_0x539fc2(0xdc),'status':_0x5eb546[_0x539fc2(0x109)]});}},this[_0x3889ad(0xd7)]),await this[_0x3889ad(0xbd)][_0x3889ad(0x98)](_0x5492b7,{'answer':_0x3889ad(0x164)});else{if(_0x122bbf===_0x3889ad(0x167))common_1['Logger'][_0x3889ad(0x12e)](_0x3889ad(0xe0),_0x3889ad(0x158)),_0x11eac0=this['aiPptService'][_0x3889ad(0xcc)]({'usePrompt':_0x14bf67,'prompt':_0x3bdc4c,'apiKey':_0x417f70,'proxyUrl':_0x2d8e71,'model':_0x122bbf,'modelName':_0x4b5513,'drawId':_0x1d2bd1,'customId':_0x124528,'action':_0x2ef21f,'timeout':_0x5a9a3f,'assistantLogId':_0x5492b7,'extraParam':_0x309327,'fileInfo':_0x2878a1}),await this['chatLogService'][_0x3889ad(0x98)](_0x5492b7,{'answer':_0x3889ad(0xed)});else{if(_0x122bbf['includes'](_0x3889ad(0x12a)))_0x11eac0=this[_0x3889ad(0xa4)]['fluxDraw']({'prompt':_0x3bdc4c,'extraParam':_0x309327,'apiKey':_0x417f70,'proxyUrl':_0x2d8e71,'model':_0x122bbf,'timeout':_0x5a9a3f,'modelName':_0x4b5513,'groupId':_0x1a54bd,'onSuccess':async _0x37bf39=>{const _0x2e7b77=_0x3889ad;await this[_0x2e7b77(0xbd)][_0x2e7b77(0x98)](_0x5492b7,{'fileInfo':_0x37bf39===null||_0x37bf39===void 0x0?void 0x0:_0x37bf39[_0x2e7b77(0xb7)],'answer':(_0x37bf39===null||_0x37bf39===void 0x0?void 0x0:_0x37bf39['answer'])||_0x3bdc4c,'progress':_0x2e7b77(0x148),'status':_0x37bf39[_0x2e7b77(0x109)]});},'onFailure':async _0x577037=>{const _0x6f616d=_0x3889ad;await this[_0x6f616d(0xbd)][_0x6f616d(0x98)](_0x5492b7,{'answer':_0x6f616d(0xdc),'status':_0x577037[_0x6f616d(0x109)]});}},this[_0x3889ad(0xd7)]),await this[_0x3889ad(0xbd)][_0x3889ad(0x98)](_0x5492b7,{'answer':'绘制中'});else{if(_0x122bbf['includes'](_0x3889ad(0x177)))_0x11eac0=this[_0x3889ad(0xc3)]['suno']({'assistantLogId':_0x5492b7,'apiKey':_0x417f70,'action':_0x2ef21f,'prompt':_0x3bdc4c,'timeout':_0x5a9a3f,'proxyUrl':_0x2d8e71,'taskData':_0x124528}),await this['chatLogService']['updateChatLog'](_0x5492b7,{'answer':_0x3889ad(0xb2)});else{if(_0x122bbf[_0x3889ad(0x122)](_0x3889ad(0xfb)))_0x11eac0=this[_0x3889ad(0x159)][_0x3889ad(0x74)]({'fileInfo':_0x2878a1,'extraParam':_0x309327,'assistantLogId':_0x5492b7,'apiKey':_0x417f70,'action':_0x2ef21f,'prompt':_0x3bdc4c,'model':_0x122bbf,'timeout':_0x5a9a3f,'proxyUrl':_0x2d8e71,'taskData':_0x124528,'onGenerate':async _0x3b2b68=>{const _0x514354=_0x3889ad;await this['chatLogService'][_0x514354(0x98)](_0x5492b7,{'fileInfo':_0x3b2b68===null||_0x3b2b68===void 0x0?void 0x0:_0x3b2b68[_0x514354(0xb7)],'answer':(_0x3b2b68===null||_0x3b2b68===void 0x0?void 0x0:_0x3b2b68[_0x514354(0x113)])||_0x3bdc4c,'status':0x2});},'onSuccess':async _0x243a0b=>{const _0x3ee4b8=_0x3889ad;await this[_0x3ee4b8(0xbd)][_0x3ee4b8(0x98)](_0x5492b7,{'fileInfo':_0x243a0b===null||_0x243a0b===void 0x0?void 0x0:_0x243a0b[_0x3ee4b8(0xb7)],'answer':(_0x243a0b===null||_0x243a0b===void 0x0?void 0x0:_0x243a0b[_0x3ee4b8(0x113)])||_0x3bdc4c,'progress':'100%','status':0x3});},'onFailure':async _0x5b57f1=>{const _0x5b7d76=_0x3889ad;await this['chatLogService'][_0x5b7d76(0x98)](_0x5492b7,{'answer':_0x5b57f1['errMsg'],'status':0x4});}}),await this[_0x3889ad(0xbd)]['updateChatLog'](_0x5492b7,{'answer':_0x3889ad(0xd8)});else{if(_0x122bbf[_0x3889ad(0x122)](_0x3889ad(0xac)))_0x11eac0=this[_0x3889ad(0x168)][_0x3889ad(0x8a)]({'fileInfo':_0x2878a1,'extraParam':_0x309327,'assistantLogId':_0x5492b7,'apiKey':_0x417f70,'action':_0x2ef21f,'prompt':_0x3bdc4c,'model':_0x122bbf,'timeout':_0x5a9a3f,'proxyUrl':_0x2d8e71,'taskData':_0x124528,'onGenerate':async _0x1e9fe6=>{const _0x15a696=_0x3889ad;await this['chatLogService'][_0x15a696(0x98)](_0x5492b7,{'fileInfo':_0x1e9fe6===null||_0x1e9fe6===void 0x0?void 0x0:_0x1e9fe6[_0x15a696(0xb7)],'answer':(_0x1e9fe6===null||_0x1e9fe6===void 0x0?void 0x0:_0x1e9fe6[_0x15a696(0x113)])||_0x3bdc4c,'status':0x2});},'onSuccess':async _0x2be715=>{const _0x1d6879=_0x3889ad;await this[_0x1d6879(0xbd)]['updateChatLog'](_0x5492b7,{'fileInfo':_0x2be715===null||_0x2be715===void 0x0?void 0x0:_0x2be715[_0x1d6879(0xb7)],'answer':(_0x2be715===null||_0x2be715===void 0x0?void 0x0:_0x2be715[_0x1d6879(0x113)])||_0x3bdc4c,'progress':_0x1d6879(0x148),'status':0x3});},'onFailure':async _0x3cc4f9=>{const _0xec952e=_0x3889ad;await this[_0xec952e(0xbd)][_0xec952e(0x98)](_0x5492b7,{'answer':_0x3cc4f9[_0xec952e(0xf3)],'status':0x4});}}),await this[_0x3889ad(0xbd)][_0x3889ad(0x98)](_0x5492b7,{'answer':_0x3889ad(0xd8)});else _0x122bbf[_0x3889ad(0x122)](_0x3889ad(0x16b))?(_0x11eac0=this[_0x3889ad(0x153)]['sdxl']({'chatId':_0x5492b7,'maxModelTokens':_0x1c2afb,'apiKey':_0x417f70,'model':_0x122bbf,'modelName':_0x4b5513,'modelType':_0x218fcd,'prompt':_0x3bdc4c,'fileInfo':_0x2878a1,'isFileUpload':_0x307d56,'timeout':_0x5a9a3f,'proxyUrl':_0x2d8e71,'onSuccess':async _0x58aada=>{const _0x387e07=_0x3889ad;await this[_0x387e07(0xbd)][_0x387e07(0x98)](_0x5492b7,{'fileInfo':_0x58aada===null||_0x58aada===void 0x0?void 0x0:_0x58aada[_0x387e07(0xb7)],'answer':(_0x58aada===null||_0x58aada===void 0x0?void 0x0:_0x58aada[_0x387e07(0x113)])||_0x3bdc4c,'progress':'100%','status':0x3});},'onFailure':async _0x39d3ae=>{const _0x9c7f82=_0x3889ad;await this['chatLogService']['updateChatLog'](_0x5492b7,{'answer':_0x9c7f82(0xd6),'status':0x4});}}),await this[_0x3889ad(0xbd)][_0x3889ad(0x98)](_0x5492b7,{'answer':_0x3889ad(0x164)})):(_0x11eac0=await this[_0x3889ad(0xcb)][_0x3889ad(0x14e)]({'usePrompt':_0x14bf67,'prompt':_0x3bdc4c,'apiKey':_0x417f70,'proxyUrl':_0x2d8e71,'model':_0x3889ad(0xe7),'modelName':_0x4b5513,'drawId':_0x1d2bd1,'customId':_0x124528,'action':_0x2ef21f,'fileInfo':_0x2878a1,'timeout':_0x5a9a3f,'assistantLogId':_0x5492b7,'pluginName':_0x14d74d}),await this[_0x3889ad(0xbd)][_0x3889ad(0x98)](_0x5492b7,{'answer':_0x11eac0[_0x3889ad(0x113)],'status':_0x11eac0[_0x3889ad(0x109)]}));}}}}}_0x11eac0[_0x3889ad(0x109)]!==0x5?(await this[_0x3889ad(0x150)][_0x3889ad(0x154)](_0x438a48,0x1),await this[_0x3889ad(0xb6)]['deductFromBalance'](_0x158cc3[_0x3889ad(0xfe)]['id'],_0x5d1b39,_0x3922c4)):common_1[_0x3889ad(0xc9)][_0x3889ad(0x12e)]('任务提交失败，不执行扣费',_0x3889ad(0xb5));const _0x2446d2=await this['userBalanceService'][_0x3889ad(0xdb)](_0x158cc3['user']['id']);return _0x11eac0[_0x3889ad(0xc7)]=Object[_0x3889ad(0xde)]({},_0x2446d2),_0x11eac0[_0x3889ad(0x104)]=_0x11eac0['answer'],_0x11eac0[_0x3889ad(0x109)]=_0x11eac0[_0x3889ad(0x109)]||0x2,_0x11eac0[_0x3889ad(0x78)]=_0x120051,_0x11eac0[_0x3889ad(0xfa)]=_0x560fa4,_0x178d9a[_0x3889ad(0x155)]('\x0a'+JSON[_0x3889ad(0x123)](_0x11eac0));}else{_0x11eac0=await this[_0x3889ad(0xa7)][_0x3889ad(0x176)](_0x24c990,{'chatId':_0x5492b7,'maxModelTokens':_0x1c2afb,'apiKey':_0x417f70,'model':_0x122bbf,'modelName':_0x4b5513,'temperature':_0x569742,'modelType':_0x218fcd,'prompt':_0x3bdc4c,'fileInfo':_0x2878a1,'isFileUpload':_0x307d56,'timeout':_0x5a9a3f,'proxyUrl':_0x2d8e71,'modelAvatar':_0x33f170,'onProgress':_0x311d51=>{const _0x954962=_0x3889ad;_0x178d9a[_0x954962(0x155)](_0x557a48?JSON[_0x954962(0x123)](_0x311d51):'\x0a'+JSON['stringify'](_0x311d51)),_0x557a48=![];},'onFailure':async _0x1a3d0b=>{const _0x51fcba=_0x3889ad;await this['chatLogService'][_0x51fcba(0x98)](_0x5492b7,{'answer':_0x1a3d0b[_0x51fcba(0xf3)],'status':0x4});},'abortController':_0x5c8d1e});if(_0x11eac0[_0x3889ad(0xf3)])return common_1[_0x3889ad(0xc9)][_0x3889ad(0xaf)]('用户ID:\x20'+_0x158cc3[_0x3889ad(0xfe)]['id']+_0x3889ad(0x84)+_0x4b5513+_0x3889ad(0x99)+_0x120051+_0x3889ad(0x14d),_0x3889ad(0xb5)),_0x178d9a[_0x3889ad(0x155)]('\x0a'+JSON['stringify'](_0x11eac0));let _0x194662='';_0x24c990['forEach'](_0x2a35ee=>{const _0x4a1ca0=_0x3889ad;_0x194662+=_0x2a35ee[_0x4a1ca0(0xd5)]+'\x20';});const _0x501990=await(0x0,utils_1[_0x3889ad(0x13b)])(_0x194662),_0x21f532=await(0x0,utils_1[_0x3889ad(0x13b)])(_0x11eac0['answer']);await this['chatLogService'][_0x3889ad(0x98)](_0x5f007d,{'promptTokens':_0x501990,'completionTokens':_0x21f532,'totalTokens':_0x501990+_0x21f532});let _0x28694f=_0x11eac0[_0x3889ad(0x113)];if(_0x1308c6==='1'){const _0x442a61=await this[_0x3889ad(0xe8)][_0x3889ad(0x91)](_0x11eac0[_0x3889ad(0x113)],_0x158cc3[_0x3889ad(0xfe)]['id']);if(_0x442a61[_0x3889ad(0xe2)]>0x0){const _0x3237e1=new RegExp(_0x442a61['join']('|'),'gi');_0x28694f=_0x28694f[_0x3889ad(0xbf)](_0x3237e1,_0x3842ab=>'*'['repeat'](_0x3842ab[_0x3889ad(0xe2)]));}}await this[_0x3889ad(0xbd)][_0x3889ad(0x98)](_0x5492b7,{'fileInfo':_0x11eac0===null||_0x11eac0===void 0x0?void 0x0:_0x11eac0[_0x3889ad(0xb7)],'answer':_0x28694f,'promptTokens':_0x501990,'completionTokens':_0x21f532,'totalTokens':_0x501990+_0x21f532,'status':0x3});try{if(_0x1d1df6==='1'){const _0xc145f0=await this[_0x3889ad(0xa7)][_0x3889ad(0xf6)](_0x3889ad(0x157)+_0x3bdc4c+'}以及\x20AI\x20的回答{'+_0x11eac0['answer']+_0x3889ad(0x111));await this['chatLogService'][_0x3889ad(0x98)](_0x5492b7,{'promptReference':_0xc145f0});}}catch(_0x5359e2){common_1[_0x3889ad(0xc9)][_0x3889ad(0xaf)](_0x3889ad(0xef)+_0x5359e2);}_0x25388e===!![]&&(_0x3922c4=_0x5608df*Math[_0x3889ad(0x14c)]((_0x501990+_0x21f532)/_0x37e31c));await this[_0x3889ad(0xb6)][_0x3889ad(0x81)](_0x158cc3[_0x3889ad(0xfe)]['id'],_0x5d1b39,_0x3922c4,_0x501990+_0x21f532),await this['modelsService'][_0x3889ad(0x154)](_0x438a48,_0x501990+_0x21f532),common_1[_0x3889ad(0xc9)]['log']('用户ID:\x20'+_0x158cc3[_0x3889ad(0xfe)]['id']+'\x20模型名称:\x20'+_0x4b5513+'\x20模型:\x20'+_0x120051+_0x3889ad(0x136)+(_0x501990+_0x21f532)+_0x3889ad(0xee)+_0x3922c4,'ChatService');const _0x2bd1fd=await this[_0x3889ad(0xb6)][_0x3889ad(0xdb)](_0x158cc3[_0x3889ad(0xfe)]['id']);return _0x11eac0[_0x3889ad(0xc7)]=Object[_0x3889ad(0xde)]({},_0x2bd1fd),_0x178d9a[_0x3889ad(0x155)]('\x0a'+JSON['stringify'](_0x11eac0));}}catch(_0x5af28b){common_1[_0x3889ad(0xc9)][_0x3889ad(0xaf)](_0x3889ad(0x120),_0x5af28b),await this[_0x3889ad(0xbd)]['updateChatLog'](_0x5492b7,{'status':0x5}),_0x11eac0={'error':_0x3889ad(0x175)};}}else return _0x2c90ff=await this[_0x3889ad(0xa7)][_0x3889ad(0x176)](_0x24c990,{'chatId':_0x5492b7,'maxModelTokens':_0x1c2afb,'apiKey':_0x417f70,'model':_0x122bbf,'modelName':_0x4b5513,'modelType':_0x218fcd,'temperature':_0x569742,'prompt':_0x3bdc4c,'fileInfo':_0x2878a1,'isFileUpload':_0x307d56,'timeout':_0x5a9a3f,'proxyUrl':_0x2d8e71,'abortController':_0x5c8d1e}),await this[_0x3889ad(0xb6)][_0x3889ad(0x81)](_0x158cc3['user']['id'],_0x5d1b39,_0x3922c4),_0x2c90ff[_0x3889ad(0x113)];}catch(_0x487737){common_1[_0x3889ad(0xc9)][_0x3889ad(0xaf)](_0x3889ad(0x16e),_0x417f70,_0x487737);if(_0x178d9a)return _0x178d9a['write'](_0x3889ad(0x174));else throw new common_1[(_0x3889ad(0x13d))]('发生未知错误，请稍后再试',common_1[_0x3889ad(0xb1)][_0x3889ad(0x106)]);}finally{_0x178d9a&&_0x178d9a[_0x3889ad(0xa5)]();}}async['usePlugin'](_0x16c5a9,_0x7d1c37){const _0x205b28=_0x2690ef,{pluginUrl:_0x42e480,pluginKey:_0x1c2b54}=await this[_0x205b28(0xbc)][_0x205b28(0xea)]([_0x205b28(0x142),'pluginKey']),_0x583a82=_0x1c2b54,_0x3a7adf=_0x42e480,_0x25bb23={'method':_0x205b28(0x15f),'url':_0x3a7adf+_0x205b28(0x178)+_0x7d1c37,'headers':{'Content-Type':_0x205b28(0x116),'Authorization':'Bearer\x20'+_0x583a82},'data':{'prompt':_0x16c5a9}};try{const _0x103cfa=await(0x0,axios_1[_0x205b28(0x140)])(_0x25bb23);return common_1[_0x205b28(0xc9)][_0x205b28(0x12e)](_0x205b28(0x86)+JSON[_0x205b28(0x123)](_0x103cfa['data'],null,0x2),_0x205b28(0x152)),_0x103cfa[_0x205b28(0x13e)]['text'];}catch(_0x20e0fd){common_1[_0x205b28(0xc9)][_0x205b28(0xaf)]('error:\x20',_0x20e0fd);}}async[_0x2690ef(0xae)](_0x52d12f,_0x5e7668,_0x8b6ad,_0x32c8d4,_0x11fc0d){const _0x285d3a=_0x2690ef;if((_0x5e7668===null||_0x5e7668===void 0x0?void 0x0:_0x5e7668[_0x285d3a(0x173)])===_0x285d3a(0x94)){let _0x1744e1;if(_0x8b6ad===0x1)try{_0x1744e1=await this[_0x285d3a(0xa7)][_0x285d3a(0xf6)](_0x285d3a(0x157)+_0x32c8d4+_0x285d3a(0x117)),_0x1744e1[_0x285d3a(0xe2)]>0xf&&(_0x1744e1=_0x1744e1['slice'](0x0,0xf));}catch(_0x43de07){common_1['Logger'][_0x285d3a(0xaf)](_0x285d3a(0xef)+_0x43de07),_0x1744e1=_0x32c8d4[_0x285d3a(0x82)](0x0,0xa);}else _0x1744e1=_0x285d3a(0xa3);this[_0x285d3a(0x16d)][_0x285d3a(0x107)]({'groupId':_0x52d12f,'title':_0x1744e1,'isSticky':![],'config':'','fileUrl':''},_0x11fc0d)[_0x285d3a(0xab)](()=>common_1['Logger']['log'](_0x285d3a(0x141)+_0x1744e1,_0x285d3a(0xb5)))[_0x285d3a(0xe4)](_0x226139=>common_1[_0x285d3a(0xc9)]['error']('更新对话组标题失败:\x20'+_0x226139));}}async[_0x2690ef(0xd7)](_0x4e080e,_0x47581c,_0x22bb75){const _0x47794a=_0x2690ef;let {systemMessage:systemMessage='',fileInfo:_0x341a3b,groupId:_0x134394,maxRounds:maxRounds=0x5,maxModelTokens:maxModelTokens=0x1f40,isFileUpload:isFileUpload=0x0,isConvertToBase64:_0x469f2d}=_0x47581c;systemMessage[_0x47794a(0xe2)]>maxModelTokens&&(common_1[_0x47794a(0xc9)][_0x47794a(0x12e)](_0x47794a(0xa1),_0x47794a(0xb5)),systemMessage=systemMessage[_0x47794a(0x82)](0x0,maxModelTokens));let _0x32e912=[];systemMessage&&_0x32e912[_0x47794a(0xce)]({'role':_0x47794a(0x9b),'content':systemMessage});if(_0x134394){const _0x278231=await _0x22bb75[_0x47794a(0x7e)](_0x134394,maxRounds);let _0x19b8d6=null;for(const _0x49723c of _0x278231){try{let _0x53164f;if((isFileUpload===0x2||isFileUpload===0x3)&&_0x49723c[_0x47794a(0xb7)]&&_0x49723c['role']==='user'){const _0x55968d=await Promise[_0x47794a(0x76)](_0x49723c[_0x47794a(0xb7)][_0x47794a(0x15e)](',')[_0x47794a(0x95)](async _0x3cf592=>({'type':_0x47794a(0xdf),'image_url':{'url':_0x469f2d==='1'?await this[_0x47794a(0xa8)](_0x3cf592[_0x47794a(0xd4)]()):_0x3cf592[_0x47794a(0xd4)]()}})));_0x53164f=[{'type':_0x47794a(0x104),'text':_0x49723c[_0x47794a(0x104)]},..._0x55968d];}else isFileUpload===0x1&&_0x49723c['fileInfo']&&_0x49723c[_0x47794a(0x79)]===_0x47794a(0xfe)?_0x53164f=_0x49723c[_0x47794a(0xb7)]+'\x0a'+_0x49723c['text']:_0x53164f=_0x49723c[_0x47794a(0x104)];if(_0x49723c[_0x47794a(0x79)]==='user')_0x19b8d6={'role':_0x49723c[_0x47794a(0x79)],'content':_0x53164f};else{if(_0x49723c[_0x47794a(0x79)]===_0x47794a(0x10f)){const _0x397912=Array[_0x47794a(0xfc)](_0x53164f)?JSON['stringify'](_0x53164f):_0x53164f;_0x19b8d6&&_0x397912['trim']()!==''&&(_0x32e912[_0x47794a(0xce)](_0x19b8d6),_0x32e912[_0x47794a(0xce)]({'role':_0x49723c[_0x47794a(0x79)],'content':_0x53164f}),_0x19b8d6=null);}}}catch(_0xb5d1a5){common_1[_0x47794a(0xc9)][_0x47794a(0xaf)](_0x47794a(0x128),_0xb5d1a5,_0x47794a(0xf0),JSON['stringify'](_0x49723c,null,0x2));}}}let _0x15e6c0;if((isFileUpload===0x2||isFileUpload===0x3)&&_0x341a3b){const _0x3beeaf=await Promise[_0x47794a(0x76)](_0x341a3b['split'](',')[_0x47794a(0x95)](async _0x24dcc2=>({'type':_0x47794a(0xdf),'image_url':{'url':_0x469f2d==='1'?await this[_0x47794a(0xa8)](_0x24dcc2[_0x47794a(0xd4)]()):_0x24dcc2[_0x47794a(0xd4)]()}})));_0x15e6c0=[{'type':'text','text':_0x4e080e},..._0x3beeaf];}else isFileUpload===0x1&&_0x341a3b?_0x15e6c0=_0x341a3b+'\x0a'+_0x4e080e:_0x15e6c0=_0x4e080e;_0x32e912[_0x47794a(0xce)]({'role':_0x47794a(0xfe),'content':_0x15e6c0});let _0x16903a=await(0x0,utils_1[_0x47794a(0x13b)])(_0x32e912),_0x1a4061;maxModelTokens<0x1f40?_0x1a4061=0xfa0:_0x1a4061=maxModelTokens-0xfa0;while(_0x16903a>_0x1a4061){if(_0x32e912[_0x47794a(0xe2)]===0x2&&_0x32e912[0x0][_0x47794a(0x79)]==='system'&&_0x32e912[0x1][_0x47794a(0x79)]===_0x47794a(0xfe))break;let _0x1d910a=![];for(let _0x5625a0=0x0;_0x5625a0<_0x32e912[_0x47794a(0xe2)];_0x5625a0++){if(_0x32e912[_0x5625a0]['role']!=='system'&&_0x32e912[_0x5625a0+0x1]&&_0x32e912[_0x5625a0+0x1][_0x47794a(0x79)]===_0x47794a(0x10f)){_0x32e912[_0x47794a(0x96)](_0x5625a0,0x2),_0x1d910a=!![];break;}}if(!_0x1d910a)for(let _0x11bda1=0x0;_0x11bda1<_0x32e912[_0x47794a(0xe2)];_0x11bda1++){if(_0x32e912[_0x11bda1]['role']===_0x47794a(0xfe)){_0x32e912[_0x47794a(0x96)](_0x11bda1,0x1);break;}}_0x16903a=await(0x0,utils_1[_0x47794a(0x13b)])(_0x32e912);if(_0x32e912[_0x47794a(0xe2)]<=0x2)break;}return{'messagesHistory':_0x32e912,'round':_0x32e912[_0x47794a(0xe2)]};}async[_0x2690ef(0xa8)](_0x203901){const _0x11739=_0x2690ef;try{console['log'](_0x11739(0xda)+_0x203901);const _0x4f09f4=await axios_1['default']['get'](_0x203901,{'responseType':_0x11739(0xe9)}),_0x1ff82d=Buffer[_0x11739(0x13f)](_0x4f09f4[_0x11739(0x13e)],'binary');console[_0x11739(0x12e)](_0x11739(0xf1)+_0x203901);const _0x346239=_0x11739(0x10e)+_0x4f09f4['headers'][_0x11739(0x134)]+';base64,'+_0x1ff82d[_0x11739(0x7c)](_0x11739(0x149));return console[_0x11739(0x12e)](_0x11739(0x80)+_0x203901),_0x346239;}catch(_0xa7eebd){return console[_0x11739(0xaf)](_0x11739(0x14a),_0xa7eebd),console[_0x11739(0xb4)](_0x11739(0x8d)+_0x203901),_0x203901;}}async[_0x2690ef(0x126)](_0x267097,_0x34e9be,_0x1d5362){const _0x358197=_0x2690ef,{chatId:_0x536145,prompt:_0x1a6c55}=_0x267097,_0x2c5bd7=await this[_0x358197(0x150)]['getCurrentModelKeyInfo'](_0x358197(0x11e)),{openaiTimeout:_0x42d61c,openaiBaseUrl:_0x148309,openaiBaseKey:_0x336a54,openaiVoice:_0x1f6a51}=await this[_0x358197(0xbc)][_0x358197(0xea)](['openaiTimeout','openaiBaseUrl',_0x358197(0xf5),_0x358197(0xff)]),{key:_0x2213f4,proxyUrl:_0x5a26dc,deduct:_0x3511fd,deductType:_0x2dfee0,timeout:_0x2da3e9}=_0x2c5bd7,_0x589142=_0x2213f4||_0x336a54,_0x2993c4=(0x0,utils_1[_0x358197(0xb8)])(_0x5a26dc||_0x148309),_0x2a98dc=(_0x2da3e9||_0x42d61c)*0x3e8;await this[_0x358197(0xb6)][_0x358197(0x127)](_0x34e9be,_0x2dfee0,_0x3511fd),common_1[_0x358197(0xc9)][_0x358197(0x12e)](_0x358197(0xa0),_0x1a6c55,_0x358197(0x172));const _0x4b9f43={'method':_0x358197(0x15f),'url':_0x2993c4+_0x358197(0x12c),'headers':{'Content-Type':'application/json','Authorization':'Bearer\x20'+_0x589142},'responseType':_0x358197(0xe9),'timeout':_0x2a98dc,'data':{'model':_0x358197(0x11e),'input':_0x1a6c55,'voice':_0x1f6a51||_0x358197(0xb3)}};try{const _0x4f0ce6=await(0x0,axios_1[_0x358197(0x140)])(_0x4b9f43);common_1[_0x358197(0xc9)][_0x358197(0x12e)](_0x358197(0xc6),_0x358197(0x172));const _0x5c8276=Buffer[_0x358197(0x13f)](_0x4f0ce6[_0x358197(0x13e)]),_0x2cb4d4=new Date(),_0x41ceaa=_0x2cb4d4[_0x358197(0x12d)](),_0x3a34e8=String(_0x2cb4d4[_0x358197(0x163)]()+0x1)[_0x358197(0x138)](0x2,'0'),_0x4c8b1f=String(_0x2cb4d4['getDate']())[_0x358197(0x138)](0x2,'0'),_0x556fa5=''+_0x41ceaa+_0x3a34e8+'/'+_0x4c8b1f,_0x5dc2d8=await this[_0x358197(0x10d)][_0x358197(0xe6)]({'buffer':_0x5c8276,'mimetype':'audio/mpeg'},_0x358197(0x124)+_0x556fa5);await Promise[_0x358197(0x76)]([this[_0x358197(0xbd)][_0x358197(0x98)](_0x536145,{'ttsUrl':_0x5dc2d8}),this['userBalanceService']['deductFromBalance'](_0x34e9be['user']['id'],_0x2dfee0,_0x3511fd)]),_0x1d5362['status'](0xc8)[_0x358197(0x73)]({'ttsUrl':_0x5dc2d8});}catch(_0x557865){common_1['Logger']['error'](_0x358197(0xd1),_0x557865,'TTSService'),_0x1d5362[_0x358197(0x109)](0x1f4)[_0x358197(0x73)]({'error':_0x358197(0xdd)});}}};ChatService=__decorate([(0x0,common_1[_0x2690ef(0xf4)])(),__param(0x0,(0x0,typeorm_1[_0x2690ef(0x72)])(config_entity_1['ConfigEntity'])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(app_entity_1[_0x2690ef(0x147)])),__param(0x2,(0x0,typeorm_1[_0x2690ef(0x72)])(plugin_entity_1[_0x2690ef(0xa6)])),__metadata('design:paramtypes',[typeorm_2[_0x2690ef(0x110)],typeorm_2[_0x2690ef(0x110)],typeorm_2[_0x2690ef(0x110)],suno_service_1[_0x2690ef(0x9f)],openaiChat_service_1[_0x2690ef(0x131)],chatLog_service_1['ChatLogService'],midjourneyDraw_service_1[_0x2690ef(0x16f)],stableDiffusion_service_1[_0x2690ef(0x11d)],userBalance_service_1[_0x2690ef(0xe3)],user_service_1[_0x2690ef(0x121)],upload_service_1[_0x2690ef(0x8e)],badWords_service_1[_0x2690ef(0xec)],autoreply_service_1[_0x2690ef(0xd3)],globalConfig_service_1[_0x2690ef(0x88)],chatGroup_service_1[_0x2690ef(0x92)],models_service_1[_0x2690ef(0xba)],openaiDraw_service_1[_0x2690ef(0x169)],lumaVideo_service_1[_0x2690ef(0xbb)],cogVideo_service_1[_0x2690ef(0x9c)],fluxDraw_service_1[_0x2690ef(0x100)],aiPPT_1[_0x2690ef(0x14f)]])],ChatService),exports[_0x2690ef(0xb5)]=ChatService;