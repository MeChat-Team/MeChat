'use strict';const _0x5c14af=_0x49ae;(function(_0x3e62f5,_0x23a3ad){const _0x2bd8ef=_0x49ae,_0x42966e=_0x3e62f5();while(!![]){try{const _0x572ebc=parseInt(_0x2bd8ef(0x2b1))/0x1+parseInt(_0x2bd8ef(0x2a7))/0x2+-parseInt(_0x2bd8ef(0x22d))/0x3*(-parseInt(_0x2bd8ef(0x1ca))/0x4)+parseInt(_0x2bd8ef(0x1d2))/0x5*(parseInt(_0x2bd8ef(0x21b))/0x6)+-parseInt(_0x2bd8ef(0x280))/0x7*(parseInt(_0x2bd8ef(0x231))/0x8)+-parseInt(_0x2bd8ef(0x2c3))/0x9*(parseInt(_0x2bd8ef(0x1be))/0xa)+parseInt(_0x2bd8ef(0x230))/0xb*(-parseInt(_0x2bd8ef(0x22a))/0xc);if(_0x572ebc===_0x23a3ad)break;else _0x42966e['push'](_0x42966e['shift']());}catch(_0x322e50){_0x42966e['push'](_0x42966e['shift']());}}}(_0x153f,0xe9b63));var __decorate=this&&this[_0x5c14af(0x2ac)]||function(_0x2cd89c,_0xaf65ca,_0x327e0a,_0x1353b6){const _0x32890c=_0x5c14af;var _0x38738b=arguments[_0x32890c(0x206)],_0x5c8a6f=_0x38738b<0x3?_0xaf65ca:_0x1353b6===null?_0x1353b6=Object[_0x32890c(0x298)](_0xaf65ca,_0x327e0a):_0x1353b6,_0x44b001;if(typeof Reflect==='object'&&typeof Reflect[_0x32890c(0x279)]===_0x32890c(0x297))_0x5c8a6f=Reflect['decorate'](_0x2cd89c,_0xaf65ca,_0x327e0a,_0x1353b6);else{for(var _0x3c2baf=_0x2cd89c[_0x32890c(0x206)]-0x1;_0x3c2baf>=0x0;_0x3c2baf--)if(_0x44b001=_0x2cd89c[_0x3c2baf])_0x5c8a6f=(_0x38738b<0x3?_0x44b001(_0x5c8a6f):_0x38738b>0x3?_0x44b001(_0xaf65ca,_0x327e0a,_0x5c8a6f):_0x44b001(_0xaf65ca,_0x327e0a))||_0x5c8a6f;}return _0x38738b>0x3&&_0x5c8a6f&&Object[_0x32890c(0x239)](_0xaf65ca,_0x327e0a,_0x5c8a6f),_0x5c8a6f;},__metadata=this&&this[_0x5c14af(0x27a)]||function(_0x5f56c2,_0xa60be1){const _0x3161ce=_0x5c14af;if(typeof Reflect===_0x3161ce(0x1cb)&&typeof Reflect[_0x3161ce(0x1de)]===_0x3161ce(0x297))return Reflect[_0x3161ce(0x1de)](_0x5f56c2,_0xa60be1);},__param=this&&this[_0x5c14af(0x2a0)]||function(_0x38250c,_0x556e4c){return function(_0xa3933b,_0x5e1fdd){_0x556e4c(_0xa3933b,_0x5e1fdd,_0x38250c);};};Object[_0x5c14af(0x239)](exports,_0x5c14af(0x1ce),{'value':!![]}),exports['ChatService']=void 0x0;const utils_1=require('../../common/utils'),common_1=require(_0x5c14af(0x276)),typeorm_1=require(_0x5c14af(0x257)),axios_1=require(_0x5c14af(0x203)),typeorm_2=require(_0x5c14af(0x27c)),aiPPT_1=require(_0x5c14af(0x28d)),cogVideo_service_1=require(_0x5c14af(0x22c)),fluxDraw_service_1=require(_0x5c14af(0x1c2)),lumaVideo_service_1=require(_0x5c14af(0x263)),midjourneyDraw_service_1=require('../ai/midjourneyDraw.service'),openaiChat_service_1=require(_0x5c14af(0x24f)),openaiDraw_service_1=require(_0x5c14af(0x2b0)),stableDiffusion_service_1=require(_0x5c14af(0x24c)),suno_service_1=require(_0x5c14af(0x251)),app_entity_1=require('../app/app.entity'),autoreply_service_1=require('../autoreply/autoreply.service'),badWords_service_1=require(_0x5c14af(0x1bf)),chatGroup_service_1=require(_0x5c14af(0x1d6)),chatLog_service_1=require(_0x5c14af(0x21a)),config_entity_1=require('../globalConfig/config.entity'),globalConfig_service_1=require(_0x5c14af(0x235)),models_service_1=require(_0x5c14af(0x242)),plugin_entity_1=require('../plugin/plugin.entity'),upload_service_1=require(_0x5c14af(0x236)),user_service_1=require(_0x5c14af(0x2ab)),userBalance_service_1=require(_0x5c14af(0x214));let ChatService=class ChatService{constructor(_0x2482b2,_0x2e2593,_0xa386ac,_0x2bacc8,_0x3dda09,_0x156d52,_0x46a937,_0x531b16,_0x5330e8,_0x3a7491,_0x2004e6,_0x509489,_0x49b460,_0x20288a,_0x533043,_0x17bf7c,_0x274bb0,_0x547cb4,_0x127215,_0x2a400f,_0x254954){const _0x47787b=_0x5c14af;this[_0x47787b(0x1c4)]=_0x2482b2,this['appEntity']=_0x2e2593,this[_0x47787b(0x258)]=_0xa386ac,this[_0x47787b(0x283)]=_0x2bacc8,this[_0x47787b(0x1e9)]=_0x3dda09,this[_0x47787b(0x2a6)]=_0x156d52,this[_0x47787b(0x281)]=_0x46a937,this[_0x47787b(0x1dd)]=_0x531b16,this['userBalanceService']=_0x5330e8,this['userService']=_0x3a7491,this[_0x47787b(0x27e)]=_0x2004e6,this[_0x47787b(0x228)]=_0x509489,this[_0x47787b(0x1f1)]=_0x49b460,this[_0x47787b(0x261)]=_0x20288a,this['chatGroupService']=_0x533043,this['modelsService']=_0x17bf7c,this[_0x47787b(0x2bd)]=_0x274bb0,this[_0x47787b(0x1d7)]=_0x547cb4,this[_0x47787b(0x225)]=_0x127215,this[_0x47787b(0x27f)]=_0x2a400f,this[_0x47787b(0x291)]=_0x254954;}async[_0x5c14af(0x1fb)](_0x3270cf,_0x3b6e19,_0x2e981d){const _0x26d7d8=_0x5c14af;await this[_0x26d7d8(0x2bc)][_0x26d7d8(0x21c)](_0x3b6e19['user']['id']);const {options:options={},usingPluginId:_0x165235,appId:appId=null,specialModel:_0x3a09a9,prompt:_0x9a5ecc,fileInfo:_0x43cd03,extraParam:_0x3a7c7d,model:_0x8a619b,drawId:_0x30b88f,customId:_0x46c597,action:_0x4e381c,modelName:_0x210365,modelAvatar:_0x393cdd}=_0x3270cf;let _0x59785f;if(_0x3a09a9)_0x59785f=await this['appEntity']['findOne']({'where':{'des':_0x3a09a9,'isSystemReserved':!![]}});else{if(appId){_0x59785f=await this[_0x26d7d8(0x25f)][_0x26d7d8(0x1f6)]({'where':{'id':appId,'status':(0x0,typeorm_2['In'])([0x1,0x3,0x4,0x5])}});if(!_0x59785f)throw new common_1[(_0x26d7d8(0x296))](_0x26d7d8(0x1fe),common_1[_0x26d7d8(0x1ff)]['BAD_REQUEST']);}}const {groupId:_0x4557ac,fileParsing:_0x1f68e1}=options,{openaiTimeout:_0x2e4e8e,openaiBaseUrl:_0x55bbb5,openaiBaseKey:_0x252493,systemPreMessage:_0x6aace7,isMjTranslate:_0x3feef8,mjTranslatePrompt:_0x2420ab,openaiTemperature:_0x2ddea7,openaiBaseModel:_0x198487,isGeneratePromptReference:_0x577cb9,isConvertToBase64:_0x1bc5df,isSensitiveWordFilter:_0x4789eb}=await this['globalConfigService'][_0x26d7d8(0x201)]([_0x26d7d8(0x223),'openaiBaseUrl',_0x26d7d8(0x22b),'systemPreMessage',_0x26d7d8(0x1eb),_0x26d7d8(0x26d),'openaiTemperature','openaiBaseModel','isGeneratePromptReference',_0x26d7d8(0x2b8),'isSensitiveWordFilter']);await this[_0x26d7d8(0x292)][_0x26d7d8(0x2bb)](_0x3b6e19[_0x26d7d8(0x219)]),_0x2e981d&&_0x2e981d[_0x26d7d8(0x1c8)](_0x26d7d8(0x23a),_0x26d7d8(0x24d));if(_0x4789eb==='1'){const _0x21993c=await this[_0x26d7d8(0x228)]['checkBadWords'](_0x9a5ecc,_0x3b6e19[_0x26d7d8(0x219)]['id']);if(_0x21993c[_0x26d7d8(0x206)]>0x0){const _0x557764='您提交的信息中包含违规的内容，我们已对您的账户进行标记，请合规使用！';throw new common_1['HttpException'](_0x557764,common_1[_0x26d7d8(0x1ff)][_0x26d7d8(0x1cd)]);}}const _0x33eb02=await this[_0x26d7d8(0x1f1)]['checkAutoReply'](_0x9a5ecc);let _0x4db417=null,_0x2e5e7d='',_0x249d5a='';_0x2e981d&&_0x2e981d['status'](0xc8);let _0xe6bff7=null;const _0x4272c6=(0x0,utils_1[_0x26d7d8(0x22e)])(_0x3b6e19);let _0x21dcbb,_0x1a6061='',_0x459d14;_0x165235&&(_0x459d14=await this['pluginEntity'][_0x26d7d8(0x1f6)]({'where':{'id':_0x165235}}));if(_0x59785f){const {isGPTs:_0x15007f,gizmoID:_0xa0807e,name:_0x4a8098,isFixedModel:_0x84895c,appModel:_0x493231,coverImg:_0x91c584}=_0x59785f;_0x1a6061=_0x91c584,_0x2e5e7d=_0x4a8098;if(_0x15007f)_0x4db417=await this[_0x26d7d8(0x205)][_0x26d7d8(0x2a3)](_0x26d7d8(0x22f)),_0x4db417[_0x26d7d8(0x25a)]=_0x26d7d8(0x213)+_0xa0807e;else!_0x15007f&&_0x84895c&&_0x493231?(_0x59785f[_0x26d7d8(0x204)]&&(_0x249d5a=_0x59785f[_0x26d7d8(0x204)]),_0x4db417=await this[_0x26d7d8(0x205)][_0x26d7d8(0x2a3)](_0x493231),_0x4db417[_0x26d7d8(0x25a)]=_0x493231,_0x1f68e1&&(_0x249d5a=_0x249d5a+'以下是我提供给你的知识库：【'+_0x1f68e1+_0x26d7d8(0x2a4)),common_1['Logger'][_0x26d7d8(0x1da)](_0x26d7d8(0x254)+_0x249d5a,_0x26d7d8(0x290))):(_0x59785f['preset']&&(_0x249d5a=_0x59785f[_0x26d7d8(0x204)]),_0x4db417=await this[_0x26d7d8(0x205)]['getCurrentModelKeyInfo'](_0x8a619b),_0x1f68e1&&(_0x249d5a=_0x249d5a+'以下是我提供给你的知识库：【'+_0x1f68e1+_0x26d7d8(0x2a4)),common_1[_0x26d7d8(0x26b)][_0x26d7d8(0x1da)](_0x26d7d8(0x1e6)+_0x249d5a,_0x26d7d8(0x290)));}else{const _0x4c9d39=await this[_0x26d7d8(0x207)]['getGroupInfoFromId'](_0x4557ac);if(_0x459d14&&_0x459d14[_0x26d7d8(0x1b9)]===0x0){let _0x16f05a='';try{_0x16f05a=await this[_0x26d7d8(0x260)](_0x9a5ecc,_0x459d14[_0x26d7d8(0x2ae)]),common_1[_0x26d7d8(0x26b)]['log'](_0x26d7d8(0x237)+_0x16f05a,_0x26d7d8(0x290));}catch(_0x1e3e10){_0x16f05a=_0x9a5ecc,common_1[_0x26d7d8(0x26b)]['error'](_0x26d7d8(0x234)+_0x1e3e10);}_0x249d5a=_0x16f05a,_0x4db417=await this[_0x26d7d8(0x205)]['getCurrentModelKeyInfo'](_0x8a619b),common_1[_0x26d7d8(0x26b)][_0x26d7d8(0x1da)]('使用插件预设:\x20'+_0x249d5a,_0x26d7d8(0x290));}else{if(_0x1f68e1)_0x249d5a=_0x26d7d8(0x28e)+_0x1f68e1+_0x26d7d8(0x2a4),_0x4db417=await this[_0x26d7d8(0x205)]['getCurrentModelKeyInfo'](_0x8a619b),common_1[_0x26d7d8(0x26b)]['log'](_0x26d7d8(0x1c7)+_0x249d5a,_0x26d7d8(0x290));else{const _0x308ca8=new Date()[_0x26d7d8(0x2be)]()['split']('T')[0x0];_0x249d5a=_0x6aace7+(_0x26d7d8(0x202)+_0x308ca8),_0x4db417=await this[_0x26d7d8(0x205)][_0x26d7d8(0x2a3)](_0x8a619b),common_1[_0x26d7d8(0x26b)][_0x26d7d8(0x1da)]('使用全局预设:\x20'+_0x249d5a,_0x26d7d8(0x290));}}}if(!_0x4db417){common_1['Logger'][_0x26d7d8(0x1df)](_0x26d7d8(0x2c4),_0x26d7d8(0x290)),_0x4db417=await this[_0x26d7d8(0x205)][_0x26d7d8(0x2a3)](_0x198487);const _0x2cf381=await this['chatGroupService'][_0x26d7d8(0x282)](_0x4557ac);let _0x4fecd3=_0x2cf381[_0x26d7d8(0x295)];try{const _0x180ac0=JSON[_0x26d7d8(0x1e5)](_0x2cf381[_0x26d7d8(0x295)]);_0x180ac0[_0x26d7d8(0x29d)]&&(_0x180ac0[_0x26d7d8(0x29d)]['modelName']=_0x4db417[_0x26d7d8(0x20f)],_0x180ac0[_0x26d7d8(0x29d)][_0x26d7d8(0x25a)]=_0x4db417[_0x26d7d8(0x25a)],_0x4fecd3=JSON[_0x26d7d8(0x285)](_0x180ac0));}catch(_0x4db556){common_1['Logger']['debug']('模型切换错误，请检查全局模型配置！','ChatService');throw new common_1[(_0x26d7d8(0x296))]('配置解析错误！',common_1[_0x26d7d8(0x1ff)][_0x26d7d8(0x1cd)]);}await this[_0x26d7d8(0x207)][_0x26d7d8(0x221)]({'groupId':_0x4557ac,'title':_0x2cf381[_0x26d7d8(0x245)],'isSticky':![],'config':_0x4fecd3,'fileUrl':''},_0x3b6e19);}const {deduct:_0x334784,isTokenBased:_0x127269,tokenFeeRatio:_0x3e1245,deductType:_0x902e39,key:_0x33fcb0,id:_0x4db16e,maxRounds:_0x35ea87,proxyUrl:_0x4f07b1,maxModelTokens:_0x8cf9bb,timeout:_0x4e8109,model:_0x22bda1,isFileUpload:_0x474f87,keyType:_0x77c0c0}=_0x4db417;if(await this['chatLogService'][_0x26d7d8(0x20e)](_0x3b6e19[_0x26d7d8(0x219)],_0x22bda1))throw new common_1[(_0x26d7d8(0x296))]('1\x20小时内对话次数过多，请切换模型或稍后再试！',common_1[_0x26d7d8(0x1ff)][_0x26d7d8(0x1d8)]);if(_0x3feef8==='1'&&_0x4e381c===_0x26d7d8(0x1ef)&&_0x8a619b===_0x26d7d8(0x1d3)){const [_0x13505a,_0x3acf2e]=_0x9a5ecc['split'](/(?= --)/),_0x27ce6c=/(https?:\/\/[^\s]+)/g,_0x573d7e=_0x13505a['match'](_0x27ce6c)||[];let _0x30930f=_0x13505a[_0x26d7d8(0x278)](_0x27ce6c,'')[_0x26d7d8(0x267)]();const _0x4f04c3=await this[_0x26d7d8(0x1e9)]['chatFree'](_0x30930f,_0x2420ab||_0x26d7d8(0x1f9)),_0x25f390=[..._0x573d7e,_0x4f04c3][_0x26d7d8(0x1db)]('\x20')[_0x26d7d8(0x267)]();_0x21dcbb=_0x3acf2e?''+_0x25f390+_0x3acf2e:_0x25f390,_0x474f87==='1'&&_0x43cd03&&(_0x21dcbb=_0x43cd03+'\x20'+_0x21dcbb);}else _0x21dcbb=_0x474f87==='1'&&_0x43cd03?_0x43cd03+'\x20'+_0x9a5ecc:_0x9a5ecc;await this[_0x26d7d8(0x2bc)]['validateBalance'](_0x3b6e19,_0x902e39,_0x334784);const _0x22bb3f=_0x210365,_0x30dd98=(0x0,utils_1['formatUrl'])(_0x4f07b1||_0x55bbb5||_0x26d7d8(0x1fd)),_0x41debc=_0x33fcb0||_0x252493,_0x1001a2=(_0x4e8109||_0x2e4e8e||0x12c)*0x3e8,_0x29ee8e=Number(_0x2ddea7)||0x1;if(_0x4557ac){const _0x16aef7=await this[_0x26d7d8(0x207)][_0x26d7d8(0x282)](_0x4557ac);this[_0x26d7d8(0x24b)](_0x4557ac,_0x16aef7,_0x77c0c0,_0x9a5ecc,_0x3b6e19),await this[_0x26d7d8(0x207)][_0x26d7d8(0x1d1)](_0x4557ac);}const _0x22a817=await this['chatLogService'][_0x26d7d8(0x1ba)]({'appId':appId,'curIp':_0x4272c6,'userId':_0x3b6e19[_0x26d7d8(0x219)]['id'],'type':_0x77c0c0?_0x77c0c0:0x1,'prompt':_0x9a5ecc,'fileInfo':_0x43cd03?_0x43cd03:null,'answer':'','promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x22bda1,'modelName':'我','role':_0x26d7d8(0x219),'groupId':_0x4557ac?_0x4557ac:null}),_0x4df554=await this[_0x26d7d8(0x2a6)][_0x26d7d8(0x1ba)]({'appId':appId?appId:null,'action':_0x4e381c?_0x4e381c:null,'curIp':_0x4272c6,'userId':_0x3b6e19[_0x26d7d8(0x219)]['id'],'type':_0x77c0c0?_0x77c0c0:0x1,'prompt':_0x9a5ecc,'fileInfo':null,'answer':'','progress':'0%','promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x22bda1,'modelName':_0x22bb3f,'role':_0x26d7d8(0x2c2),'groupId':_0x4557ac?_0x4557ac:null,'status':0x2,'modelAvatar':(_0x459d14===null||_0x459d14===void 0x0?void 0x0:_0x459d14['pluginImg'])||_0x1a6061||_0x393cdd||'','pluginParam':(_0x459d14===null||_0x459d14===void 0x0?void 0x0:_0x459d14[_0x26d7d8(0x2ae)])?_0x459d14[_0x26d7d8(0x2ae)]:_0x77c0c0===0x2?_0x22bda1:null}),_0x3b2ed1=_0x22a817['id'],_0x1f3eac=_0x4df554['id'];if(_0x33eb02['answer']&&_0x2e981d){if(_0x33eb02['isAIReplyEnabled']===0x0){const _0x448499=_0x33eb02['answer'][_0x26d7d8(0x28f)](''),_0x59fc82=_0x33efa8=>{const _0x5f4b98=_0x26d7d8;if(_0x33efa8<_0x448499['length']){const _0x53c5ff={'text':_0x448499[_0x33efa8]};_0x2e981d[_0x5f4b98(0x259)](JSON[_0x5f4b98(0x285)](_0x53c5ff)+'\x0a'),setTimeout(()=>_0x59fc82(_0x33efa8+0x1),0xa);}else _0x2e981d[_0x5f4b98(0x1f5)]();};_0x59fc82(0x0),await this[_0x26d7d8(0x2a6)][_0x26d7d8(0x1ee)](_0x1f3eac,{'answer':_0x33eb02[_0x26d7d8(0x1bb)]});return;}else _0x249d5a=_0x249d5a+_0x33eb02[_0x26d7d8(0x1bb)];}const {messagesHistory:_0x52249d}=await this[_0x26d7d8(0x21d)](_0x9a5ecc,{'groupId':_0x4557ac,'systemMessage':_0x249d5a,'maxModelTokens':_0x8cf9bb,'maxRounds':_0x35ea87,'isConvertToBase64':_0x1bc5df,'fileInfo':_0x43cd03,'model':_0x22bda1,'isFileUpload':_0x474f87},this[_0x26d7d8(0x2a6)]);let _0x2440a8=_0x4e381c!==_0x26d7d8(0x1f4)&&_0x22bda1===_0x26d7d8(0x1d3)?_0x334784*0x4:_0x334784;const _0x4db185=new AbortController();try{if(_0x2e981d){_0x2e981d['on'](_0x26d7d8(0x1e4),()=>{_0x4db185['abort']();});let _0x1218cf,_0x57fb88=!![];try{if((_0x22bda1===_0x26d7d8(0x294)||_0x22bda1===_0x26d7d8(0x1d3)||_0x22bda1===_0x26d7d8(0x216)||_0x22bda1===_0x26d7d8(0x224)||_0x22bda1===_0x26d7d8(0x2b9)||_0x22bda1['includes']('stable-diffusion')||_0x22bda1['includes'](_0x26d7d8(0x1ed))||_0x22bda1[_0x26d7d8(0x1cf)](_0x26d7d8(0x2ba)))&&_0x77c0c0===0x2){if(_0x22bda1==='dall-e-3')_0x1218cf=this['openAIDrawService'][_0x26d7d8(0x1f2)]({'prompt':_0x9a5ecc,'extraParam':_0x3a7c7d,'apiKey':_0x41debc,'proxyUrl':_0x30dd98,'model':_0x22bda1,'timeout':_0x1001a2,'modelName':_0x22bb3f,'groupId':_0x4557ac,'onSuccess':async _0x19fb3b=>{const _0x3bdfed=_0x26d7d8;await this[_0x3bdfed(0x2a6)][_0x3bdfed(0x1ee)](_0x1f3eac,{'fileInfo':_0x19fb3b===null||_0x19fb3b===void 0x0?void 0x0:_0x19fb3b[_0x3bdfed(0x250)],'answer':(_0x19fb3b===null||_0x19fb3b===void 0x0?void 0x0:_0x19fb3b[_0x3bdfed(0x1bb)])||_0x9a5ecc,'progress':'100%','status':_0x19fb3b['status']});},'onFailure':async _0x332fdb=>{const _0x3a36b8=_0x26d7d8;await this[_0x3a36b8(0x2a6)]['updateChatLog'](_0x1f3eac,{'answer':_0x3a36b8(0x222),'status':_0x332fdb[_0x3a36b8(0x2aa)]});}},this[_0x26d7d8(0x21d)]),await this[_0x26d7d8(0x2a6)][_0x26d7d8(0x1ee)](_0x1f3eac,{'answer':_0x26d7d8(0x1e1)});else{if(_0x22bda1==='ai-ppt')common_1['Logger']['log'](_0x26d7d8(0x265),_0x26d7d8(0x1ec)),_0x1218cf=this['aiPptService'][_0x26d7d8(0x243)]({'usePrompt':_0x21dcbb,'prompt':_0x9a5ecc,'apiKey':_0x41debc,'proxyUrl':_0x30dd98,'model':_0x22bda1,'modelName':_0x22bb3f,'drawId':_0x30b88f,'customId':_0x46c597,'action':_0x4e381c,'timeout':_0x1001a2,'assistantLogId':_0x1f3eac,'extraParam':_0x3a7c7d,'fileInfo':_0x43cd03}),await this[_0x26d7d8(0x2a6)][_0x26d7d8(0x1ee)](_0x1f3eac,{'answer':_0x26d7d8(0x1f7)});else{if(_0x22bda1[_0x26d7d8(0x1cf)](_0x26d7d8(0x2ba)))_0x1218cf=this['fluxDrawService'][_0x26d7d8(0x2b3)]({'prompt':_0x9a5ecc,'extraParam':_0x3a7c7d,'apiKey':_0x41debc,'proxyUrl':_0x30dd98,'model':_0x22bda1,'timeout':_0x1001a2,'modelName':_0x22bb3f,'groupId':_0x4557ac,'onSuccess':async _0x346b3a=>{const _0x1252e9=_0x26d7d8;await this[_0x1252e9(0x2a6)]['updateChatLog'](_0x1f3eac,{'fileInfo':_0x346b3a===null||_0x346b3a===void 0x0?void 0x0:_0x346b3a[_0x1252e9(0x250)],'answer':(_0x346b3a===null||_0x346b3a===void 0x0?void 0x0:_0x346b3a[_0x1252e9(0x1bb)])||_0x9a5ecc,'progress':'100%','status':_0x346b3a['status']});},'onFailure':async _0x53bad2=>{const _0x43a8fc=_0x26d7d8;await this['chatLogService']['updateChatLog'](_0x1f3eac,{'answer':'绘图失败','status':_0x53bad2[_0x43a8fc(0x2aa)]});}},this[_0x26d7d8(0x21d)]),await this['chatLogService'][_0x26d7d8(0x1ee)](_0x1f3eac,{'answer':_0x26d7d8(0x1e1)});else{if(_0x22bda1[_0x26d7d8(0x1cf)]('suno-music'))_0x1218cf=this[_0x26d7d8(0x283)][_0x26d7d8(0x248)]({'assistantLogId':_0x1f3eac,'apiKey':_0x41debc,'action':_0x4e381c,'prompt':_0x9a5ecc,'timeout':_0x1001a2,'proxyUrl':_0x30dd98,'taskData':_0x46c597}),await this[_0x26d7d8(0x2a6)][_0x26d7d8(0x1ee)](_0x1f3eac,{'answer':_0x26d7d8(0x284)});else{if(_0x22bda1['includes'](_0x26d7d8(0x2b9)))_0x1218cf=this[_0x26d7d8(0x1d7)][_0x26d7d8(0x268)]({'fileInfo':_0x43cd03,'extraParam':_0x3a7c7d,'assistantLogId':_0x1f3eac,'apiKey':_0x41debc,'action':_0x4e381c,'prompt':_0x9a5ecc,'model':_0x22bda1,'timeout':_0x1001a2,'proxyUrl':_0x30dd98,'taskData':_0x46c597,'onGenerate':async _0x22f175=>{const _0x2e4e57=_0x26d7d8;await this[_0x2e4e57(0x2a6)][_0x2e4e57(0x1ee)](_0x1f3eac,{'fileInfo':_0x22f175===null||_0x22f175===void 0x0?void 0x0:_0x22f175[_0x2e4e57(0x250)],'answer':(_0x22f175===null||_0x22f175===void 0x0?void 0x0:_0x22f175[_0x2e4e57(0x1bb)])||_0x9a5ecc,'status':0x2});},'onSuccess':async _0x31049c=>{const _0x406031=_0x26d7d8;await this['chatLogService'][_0x406031(0x1ee)](_0x1f3eac,{'fileInfo':_0x31049c===null||_0x31049c===void 0x0?void 0x0:_0x31049c[_0x406031(0x250)],'answer':(_0x31049c===null||_0x31049c===void 0x0?void 0x0:_0x31049c[_0x406031(0x1bb)])||_0x9a5ecc,'progress':_0x406031(0x299),'status':0x3});},'onFailure':async _0x265d8c=>{await this['chatLogService']['updateChatLog'](_0x1f3eac,{'answer':_0x265d8c['errMsg'],'status':0x4});}}),await this[_0x26d7d8(0x2a6)][_0x26d7d8(0x1ee)](_0x1f3eac,{'answer':'提交成功，视频生成中'});else{if(_0x22bda1[_0x26d7d8(0x1cf)](_0x26d7d8(0x1ed)))_0x1218cf=this[_0x26d7d8(0x225)]['cogVideo']({'fileInfo':_0x43cd03,'extraParam':_0x3a7c7d,'assistantLogId':_0x1f3eac,'apiKey':_0x41debc,'action':_0x4e381c,'prompt':_0x9a5ecc,'model':_0x22bda1,'timeout':_0x1001a2,'proxyUrl':_0x30dd98,'taskData':_0x46c597,'onGenerate':async _0x2b7fb8=>{const _0x2641d0=_0x26d7d8;await this['chatLogService'][_0x2641d0(0x1ee)](_0x1f3eac,{'fileInfo':_0x2b7fb8===null||_0x2b7fb8===void 0x0?void 0x0:_0x2b7fb8[_0x2641d0(0x250)],'answer':(_0x2b7fb8===null||_0x2b7fb8===void 0x0?void 0x0:_0x2b7fb8[_0x2641d0(0x1bb)])||_0x9a5ecc,'status':0x2});},'onSuccess':async _0x187b45=>{const _0x1f7e97=_0x26d7d8;await this['chatLogService'][_0x1f7e97(0x1ee)](_0x1f3eac,{'fileInfo':_0x187b45===null||_0x187b45===void 0x0?void 0x0:_0x187b45[_0x1f7e97(0x250)],'answer':(_0x187b45===null||_0x187b45===void 0x0?void 0x0:_0x187b45[_0x1f7e97(0x1bb)])||_0x9a5ecc,'progress':'100%','status':0x3});},'onFailure':async _0x5ef296=>{const _0x53afca=_0x26d7d8;await this[_0x53afca(0x2a6)][_0x53afca(0x1ee)](_0x1f3eac,{'answer':_0x5ef296[_0x53afca(0x1d9)],'status':0x4});}}),await this['chatLogService'][_0x26d7d8(0x1ee)](_0x1f3eac,{'answer':_0x26d7d8(0x226)});else _0x22bda1[_0x26d7d8(0x1cf)](_0x26d7d8(0x24e))?(_0x1218cf=this[_0x26d7d8(0x1dd)][_0x26d7d8(0x256)]({'chatId':_0x1f3eac,'maxModelTokens':_0x8cf9bb,'apiKey':_0x41debc,'model':_0x22bda1,'modelName':_0x22bb3f,'modelType':_0x77c0c0,'prompt':_0x9a5ecc,'fileInfo':_0x43cd03,'isFileUpload':_0x474f87,'timeout':_0x1001a2,'proxyUrl':_0x30dd98,'onSuccess':async _0x9a8be1=>{const _0x4b0a48=_0x26d7d8;await this[_0x4b0a48(0x2a6)]['updateChatLog'](_0x1f3eac,{'fileInfo':_0x9a8be1===null||_0x9a8be1===void 0x0?void 0x0:_0x9a8be1[_0x4b0a48(0x250)],'answer':(_0x9a8be1===null||_0x9a8be1===void 0x0?void 0x0:_0x9a8be1[_0x4b0a48(0x1bb)])||_0x9a5ecc,'progress':'100%','status':0x3});},'onFailure':async _0x4a42e4=>{const _0x5a488e=_0x26d7d8;await this[_0x5a488e(0x2a6)][_0x5a488e(0x1ee)](_0x1f3eac,{'answer':_0x5a488e(0x20b),'status':0x4});}}),await this['chatLogService'][_0x26d7d8(0x1ee)](_0x1f3eac,{'answer':_0x26d7d8(0x1e1)})):(_0x1218cf=await this['midjourneyService']['midjourneyDraw']({'usePrompt':_0x21dcbb,'prompt':_0x9a5ecc,'apiKey':_0x41debc,'proxyUrl':_0x30dd98,'model':_0x22bda1,'modelName':_0x22bb3f,'drawId':_0x30b88f,'customId':_0x46c597,'action':_0x4e381c,'fileInfo':_0x43cd03,'timeout':_0x1001a2,'assistantLogId':_0x1f3eac,'pluginName':_0x459d14}),await this[_0x26d7d8(0x2a6)]['updateChatLog'](_0x1f3eac,{'answer':_0x1218cf[_0x26d7d8(0x1bb)],'status':_0x1218cf['status']}));}}}}}_0x1218cf[_0x26d7d8(0x2aa)]!==0x5?(await this[_0x26d7d8(0x205)]['saveUseLog'](_0x4db16e,0x1),await this[_0x26d7d8(0x2bc)][_0x26d7d8(0x272)](_0x3b6e19['user']['id'],_0x902e39,_0x2440a8)):common_1['Logger'][_0x26d7d8(0x1da)](_0x26d7d8(0x29e),'ChatService');const _0x33a113=await this[_0x26d7d8(0x2bc)][_0x26d7d8(0x27b)](_0x3b6e19[_0x26d7d8(0x219)]['id']);return _0x1218cf[_0x26d7d8(0x25d)]=Object[_0x26d7d8(0x2af)]({},_0x33a113),_0x1218cf[_0x26d7d8(0x2b5)]=_0x1218cf[_0x26d7d8(0x1bb)],_0x1218cf['status']=_0x1218cf[_0x26d7d8(0x2aa)]||0x2,_0x1218cf[_0x26d7d8(0x25a)]=_0x8a619b,_0x1218cf[_0x26d7d8(0x20f)]=_0x210365,_0x2e981d[_0x26d7d8(0x259)]('\x0a'+JSON[_0x26d7d8(0x285)](_0x1218cf));}else{_0x1218cf=await this['openAIChatService']['openAIChat'](_0x52249d,{'chatId':_0x1f3eac,'maxModelTokens':_0x8cf9bb,'apiKey':_0x41debc,'model':_0x22bda1,'modelName':_0x22bb3f,'temperature':_0x29ee8e,'modelType':_0x77c0c0,'prompt':_0x9a5ecc,'fileInfo':_0x43cd03,'isFileUpload':_0x474f87,'timeout':_0x1001a2,'proxyUrl':_0x30dd98,'modelAvatar':_0x393cdd,'onProgress':_0x1419d7=>{const _0x140ddc=_0x26d7d8;_0x2e981d['write'](_0x57fb88?JSON['stringify'](_0x1419d7):'\x0a'+JSON[_0x140ddc(0x285)](_0x1419d7)),_0x57fb88=![];},'onFailure':async _0x57eded=>{const _0x52662d=_0x26d7d8;await this['chatLogService'][_0x52662d(0x1ee)](_0x1f3eac,{'answer':_0x57eded[_0x52662d(0x1d9)],'status':0x4});},'abortController':_0x4db185});if(_0x1218cf['errMsg'])return common_1[_0x26d7d8(0x26b)][_0x26d7d8(0x2b4)](_0x26d7d8(0x1f0)+_0x3b6e19[_0x26d7d8(0x219)]['id']+_0x26d7d8(0x232)+_0x22bb3f+'\x20模型:\x20'+_0x8a619b+'\x20回复出错，本次不扣除积分',_0x26d7d8(0x290)),_0x2e981d[_0x26d7d8(0x259)]('\x0a'+JSON[_0x26d7d8(0x285)](_0x1218cf));let _0x2b0e7f='';_0x52249d[_0x26d7d8(0x269)](_0xe6a126=>{const _0x1a52d1=_0x26d7d8;_0x2b0e7f+=_0xe6a126[_0x1a52d1(0x287)]+'\x20';});const _0x2f4230=await(0x0,utils_1[_0x26d7d8(0x266)])(_0x2b0e7f),_0x20c0aa=await(0x0,utils_1[_0x26d7d8(0x266)])(_0x1218cf[_0x26d7d8(0x1bb)]);await this[_0x26d7d8(0x2a6)][_0x26d7d8(0x1ee)](_0x3b2ed1,{'promptTokens':_0x2f4230,'completionTokens':_0x20c0aa,'totalTokens':_0x2f4230+_0x20c0aa});let _0x398cde=_0x1218cf[_0x26d7d8(0x1bb)];if(_0x4789eb==='1'){const _0xceb991=await this[_0x26d7d8(0x228)][_0x26d7d8(0x208)](_0x1218cf['answer'],_0x3b6e19[_0x26d7d8(0x219)]['id']);if(_0xceb991[_0x26d7d8(0x206)]>0x0){const _0x1e0ca0=new RegExp(_0xceb991['join']('|'),'gi');_0x398cde=_0x398cde[_0x26d7d8(0x278)](_0x1e0ca0,_0x3c1a03=>'*'['repeat'](_0x3c1a03[_0x26d7d8(0x206)]));}}await this[_0x26d7d8(0x2a6)][_0x26d7d8(0x1ee)](_0x1f3eac,{'fileInfo':_0x1218cf===null||_0x1218cf===void 0x0?void 0x0:_0x1218cf[_0x26d7d8(0x250)],'answer':_0x398cde,'promptTokens':_0x2f4230,'completionTokens':_0x20c0aa,'totalTokens':_0x2f4230+_0x20c0aa,'status':0x3});try{if(_0x577cb9==='1'){const _0x3f05a0=await this[_0x26d7d8(0x1e9)][_0x26d7d8(0x20d)](_0x26d7d8(0x209)+_0x9a5ecc+_0x26d7d8(0x1c6)+_0x1218cf['answer']+_0x26d7d8(0x255));await this[_0x26d7d8(0x2a6)][_0x26d7d8(0x1ee)](_0x1f3eac,{'promptReference':_0x3f05a0});}}catch(_0xfbcb74){common_1['Logger'][_0x26d7d8(0x2b4)]('调用\x20chatFree\x20出错:\x20'+_0xfbcb74);}_0x127269===!![]&&(_0x2440a8=_0x334784*Math[_0x26d7d8(0x1fc)]((_0x2f4230+_0x20c0aa)/_0x3e1245));await this[_0x26d7d8(0x2bc)][_0x26d7d8(0x272)](_0x3b6e19[_0x26d7d8(0x219)]['id'],_0x902e39,_0x2440a8,_0x2f4230+_0x20c0aa),await this['modelsService'][_0x26d7d8(0x1e0)](_0x4db16e,_0x2f4230+_0x20c0aa),common_1[_0x26d7d8(0x26b)][_0x26d7d8(0x1da)](_0x26d7d8(0x1f0)+_0x3b6e19[_0x26d7d8(0x219)]['id']+_0x26d7d8(0x232)+_0x22bb3f+_0x26d7d8(0x1e2)+_0x8a619b+_0x26d7d8(0x1f3)+(_0x2f4230+_0x20c0aa)+_0x26d7d8(0x1c3)+_0x2440a8,'ChatService');const _0x5741b5=await this[_0x26d7d8(0x2bc)][_0x26d7d8(0x27b)](_0x3b6e19['user']['id']);return _0x1218cf[_0x26d7d8(0x25d)]=Object['assign']({},_0x5741b5),_0x2e981d[_0x26d7d8(0x259)]('\x0a'+JSON['stringify'](_0x1218cf));}}catch(_0x456f2c){common_1[_0x26d7d8(0x26b)][_0x26d7d8(0x2b4)](_0x26d7d8(0x28b),_0x456f2c),await this[_0x26d7d8(0x2a6)]['updateChatLog'](_0x1f3eac,{'status':0x5}),_0x1218cf={'error':'处理请求时发生错误'};}}else return _0xe6bff7=await this[_0x26d7d8(0x1e9)][_0x26d7d8(0x215)](_0x52249d,{'chatId':_0x1f3eac,'maxModelTokens':_0x8cf9bb,'apiKey':_0x41debc,'model':_0x22bda1,'modelName':_0x22bb3f,'modelType':_0x77c0c0,'temperature':_0x29ee8e,'prompt':_0x9a5ecc,'fileInfo':_0x43cd03,'isFileUpload':_0x474f87,'timeout':_0x1001a2,'proxyUrl':_0x30dd98,'abortController':_0x4db185}),await this[_0x26d7d8(0x2bc)][_0x26d7d8(0x272)](_0x3b6e19[_0x26d7d8(0x219)]['id'],_0x902e39,_0x2440a8),_0xe6bff7[_0x26d7d8(0x1bb)];}catch(_0x2aeaf5){common_1['Logger'][_0x26d7d8(0x2b4)](_0x26d7d8(0x1d4),_0x41debc,_0x2aeaf5);if(_0x2e981d)return _0x2e981d[_0x26d7d8(0x259)]('发生未知错误，请稍后再试');else throw new common_1[(_0x26d7d8(0x296))]('发生未知错误，请稍后再试',common_1[_0x26d7d8(0x1ff)][_0x26d7d8(0x1cd)]);}finally{_0x2e981d&&_0x2e981d['end']();}}async[_0x5c14af(0x260)](_0x147429,_0x5a163e){const _0xc70c0=_0x5c14af,{pluginUrl:_0x158842,pluginKey:_0x59bebd}=await this[_0xc70c0(0x261)]['getConfigs']([_0xc70c0(0x1c5),_0xc70c0(0x1e8)]),_0x304563=_0x59bebd,_0x2aef34=_0x158842,_0x545057={'method':_0xc70c0(0x29f),'url':_0x2aef34+_0xc70c0(0x270)+_0x5a163e,'headers':{'Content-Type':_0xc70c0(0x241),'Authorization':_0xc70c0(0x21f)+_0x304563},'data':{'prompt':_0x147429}};try{const _0x4f331b=await(0x0,axios_1[_0xc70c0(0x247)])(_0x545057);return common_1[_0xc70c0(0x26b)][_0xc70c0(0x1da)]('插件调用成功\x20返回结果:\x20'+JSON['stringify'](_0x4f331b['data'],null,0x2),_0xc70c0(0x1c1)),_0x4f331b[_0xc70c0(0x23c)][_0xc70c0(0x2b5)];}catch(_0xc7dad2){common_1[_0xc70c0(0x26b)][_0xc70c0(0x2b4)](_0xc70c0(0x2c5),_0xc7dad2);}}async[_0x5c14af(0x24b)](_0x11015e,_0x1b3e97,_0x460da3,_0x4f7286,_0x54f793){const _0x5ec6e3=_0x5c14af;if((_0x1b3e97===null||_0x1b3e97===void 0x0?void 0x0:_0x1b3e97['title'])==='新对话'){let _0x50991e;if(_0x460da3===0x1)try{_0x50991e=await this[_0x5ec6e3(0x1e9)]['chatFree'](_0x5ec6e3(0x209)+_0x4f7286+_0x5ec6e3(0x252)),_0x50991e[_0x5ec6e3(0x206)]>0xf&&(_0x50991e=_0x50991e['slice'](0x0,0xf));}catch(_0x3b4420){common_1[_0x5ec6e3(0x26b)][_0x5ec6e3(0x2b4)](_0x5ec6e3(0x26a)+_0x3b4420),_0x50991e=_0x4f7286[_0x5ec6e3(0x288)](0x0,0xa);}else _0x50991e=_0x5ec6e3(0x273);this[_0x5ec6e3(0x207)][_0x5ec6e3(0x221)]({'groupId':_0x11015e,'title':_0x50991e,'isSticky':![],'config':'','fileUrl':''},_0x54f793)[_0x5ec6e3(0x24a)](()=>common_1[_0x5ec6e3(0x26b)]['log'](_0x5ec6e3(0x23d)+_0x50991e,'ChatService'))['catch'](_0x5c73f6=>common_1[_0x5ec6e3(0x26b)]['error'](_0x5ec6e3(0x29c)+_0x5c73f6));}}async['buildMessageFromParentMessageId'](_0x13067c,_0x4617aa,_0x35c70d){const _0x5e8502=_0x5c14af;let {systemMessage:systemMessage='',fileInfo:_0x227af3,groupId:_0x3b1170,maxRounds:maxRounds=0x5,maxModelTokens:maxModelTokens=0x1f40,isFileUpload:isFileUpload=0x0,isConvertToBase64:_0x38daa5}=_0x4617aa;systemMessage[_0x5e8502(0x206)]>maxModelTokens&&(common_1[_0x5e8502(0x26b)][_0x5e8502(0x1da)](_0x5e8502(0x238),_0x5e8502(0x290)),systemMessage=systemMessage['slice'](0x0,maxModelTokens));let _0x3418ba=[];systemMessage&&_0x3418ba['push']({'role':'system','content':systemMessage});if(_0x3b1170){const _0x45ecdf=await _0x35c70d[_0x5e8502(0x227)](_0x3b1170,maxRounds);let _0x51bb1b=null;for(const _0x3b9a03 of _0x45ecdf){try{let _0x32fb89;if((isFileUpload===0x2||isFileUpload===0x3)&&_0x3b9a03[_0x5e8502(0x250)]&&_0x3b9a03[_0x5e8502(0x229)]===_0x5e8502(0x219)){const _0x26836d=await Promise[_0x5e8502(0x2c0)](_0x3b9a03[_0x5e8502(0x250)][_0x5e8502(0x28f)](',')['map'](async _0x586f5b=>({'type':_0x5e8502(0x25e),'image_url':{'url':_0x38daa5==='1'?await this[_0x5e8502(0x1e7)](_0x586f5b[_0x5e8502(0x267)]()):_0x586f5b[_0x5e8502(0x267)]()}})));_0x32fb89=[{'type':_0x5e8502(0x2b5),'text':_0x3b9a03[_0x5e8502(0x2b5)]},..._0x26836d];}else isFileUpload===0x1&&_0x3b9a03['fileInfo']&&_0x3b9a03[_0x5e8502(0x229)]==='user'?_0x32fb89=_0x3b9a03[_0x5e8502(0x250)]+'\x0a'+_0x3b9a03[_0x5e8502(0x2b5)]:_0x32fb89=_0x3b9a03['text'];if(_0x3b9a03[_0x5e8502(0x229)]===_0x5e8502(0x219))_0x51bb1b={'role':_0x3b9a03['role'],'content':_0x32fb89};else{if(_0x3b9a03[_0x5e8502(0x229)]==='assistant'){const _0x5b49b6=Array[_0x5e8502(0x262)](_0x32fb89)?JSON[_0x5e8502(0x285)](_0x32fb89):_0x32fb89;_0x51bb1b&&_0x5b49b6['trim']()!==''&&(_0x3418ba[_0x5e8502(0x220)](_0x51bb1b),_0x3418ba[_0x5e8502(0x220)]({'role':_0x3b9a03['role'],'content':_0x32fb89}),_0x51bb1b=null);}}}catch(_0x4ee0c8){common_1[_0x5e8502(0x26b)][_0x5e8502(0x2b4)](_0x5e8502(0x2b6),_0x4ee0c8,_0x5e8502(0x29a),JSON[_0x5e8502(0x285)](_0x3b9a03,null,0x2));}}}let _0x2e7e64;if((isFileUpload===0x2||isFileUpload===0x3)&&_0x227af3){const _0x354709=await Promise[_0x5e8502(0x2c0)](_0x227af3[_0x5e8502(0x28f)](',')[_0x5e8502(0x27d)](async _0x340341=>({'type':_0x5e8502(0x25e),'image_url':{'url':_0x38daa5==='1'?await this['convertUrlToBase64'](_0x340341[_0x5e8502(0x267)]()):_0x340341[_0x5e8502(0x267)]()}})));_0x2e7e64=[{'type':_0x5e8502(0x2b5),'text':_0x13067c},..._0x354709];}else isFileUpload===0x1&&_0x227af3?_0x2e7e64=_0x227af3+'\x0a'+_0x13067c:_0x2e7e64=_0x13067c;_0x3418ba[_0x5e8502(0x220)]({'role':_0x5e8502(0x219),'content':_0x2e7e64});let _0x30d9dd=await(0x0,utils_1[_0x5e8502(0x266)])(_0x3418ba),_0x102262;maxModelTokens<0x1f40?_0x102262=0xfa0:_0x102262=maxModelTokens-0xfa0;while(_0x30d9dd>_0x102262){if(_0x3418ba[_0x5e8502(0x206)]===0x2&&_0x3418ba[0x0][_0x5e8502(0x229)]==='system'&&_0x3418ba[0x1][_0x5e8502(0x229)]===_0x5e8502(0x219))break;let _0x417c7c=![];for(let _0x248302=0x0;_0x248302<_0x3418ba[_0x5e8502(0x206)];_0x248302++){if(_0x3418ba[_0x248302]['role']!=='system'&&_0x3418ba[_0x248302+0x1]&&_0x3418ba[_0x248302+0x1]['role']==='assistant'){_0x3418ba[_0x5e8502(0x20a)](_0x248302,0x2),_0x417c7c=!![];break;}}if(!_0x417c7c)for(let _0x5bdad3=0x0;_0x5bdad3<_0x3418ba['length'];_0x5bdad3++){if(_0x3418ba[_0x5bdad3]['role']==='user'){_0x3418ba[_0x5e8502(0x20a)](_0x5bdad3,0x1);break;}}_0x30d9dd=await(0x0,utils_1[_0x5e8502(0x266)])(_0x3418ba);if(_0x3418ba[_0x5e8502(0x206)]<=0x2)break;}return{'messagesHistory':_0x3418ba,'round':_0x3418ba['length']};}async[_0x5c14af(0x1e7)](_0x4110ef){const _0xa7ea97=_0x5c14af;try{console[_0xa7ea97(0x1da)](_0xa7ea97(0x26e)+_0x4110ef);const _0x1d66bd=await axios_1[_0xa7ea97(0x247)][_0xa7ea97(0x200)](_0x4110ef,{'responseType':_0xa7ea97(0x1ea)}),_0x561d46=Buffer[_0xa7ea97(0x25c)](_0x1d66bd[_0xa7ea97(0x23c)],_0xa7ea97(0x23e));console[_0xa7ea97(0x1da)](_0xa7ea97(0x23f)+_0x4110ef);const _0x278f74=_0xa7ea97(0x244)+_0x1d66bd[_0xa7ea97(0x28a)][_0xa7ea97(0x1c9)]+_0xa7ea97(0x264)+_0x561d46[_0xa7ea97(0x210)](_0xa7ea97(0x2b7));return console[_0xa7ea97(0x1da)](_0xa7ea97(0x2a5)+_0x4110ef),_0x278f74;}catch(_0x54fd49){return console[_0xa7ea97(0x2b4)](_0xa7ea97(0x293),_0x54fd49),console[_0xa7ea97(0x1bd)](_0xa7ea97(0x1cc)+_0x4110ef),_0x4110ef;}}async[_0x5c14af(0x2a1)](_0xb576e0,_0xee4b09,_0x5d83e2){const _0x58c8aa=_0x5c14af,{chatId:_0x542a66,prompt:_0x1d5fb9}=_0xb576e0,_0x2d17c7=await this[_0x58c8aa(0x205)][_0x58c8aa(0x2a3)](_0x58c8aa(0x212)),{openaiTimeout:_0x1b5e61,openaiBaseUrl:_0x433f23,openaiBaseKey:_0xa4072b,openaiVoice:_0xa3f877}=await this[_0x58c8aa(0x261)][_0x58c8aa(0x201)](['openaiTimeout',_0x58c8aa(0x277),'openaiBaseKey',_0x58c8aa(0x286)]),{key:_0xff5e20,proxyUrl:_0x5a1e33,deduct:_0x4e5adf,deductType:_0x4753ea,timeout:_0x11b965}=_0x2d17c7,_0x4788c9=_0xff5e20||_0xa4072b,_0x2e3a58=(0x0,utils_1[_0x58c8aa(0x25b)])(_0x5a1e33||_0x433f23),_0x3dc2ea=(_0x11b965||_0x1b5e61)*0x3e8;await this[_0x58c8aa(0x2bc)][_0x58c8aa(0x1dc)](_0xee4b09,_0x4753ea,_0x4e5adf),common_1[_0x58c8aa(0x26b)][_0x58c8aa(0x1da)](_0x58c8aa(0x218),_0x1d5fb9,_0x58c8aa(0x26f));const _0x249842={'method':_0x58c8aa(0x29f),'url':_0x2e3a58+'/v1/audio/speech','headers':{'Content-Type':_0x58c8aa(0x241),'Authorization':'Bearer\x20'+_0x4788c9},'responseType':_0x58c8aa(0x1ea),'timeout':_0x3dc2ea,'data':{'model':_0x58c8aa(0x212),'input':_0x1d5fb9,'voice':_0xa3f877||_0x58c8aa(0x271)}};try{const _0x22dfc9=await(0x0,axios_1[_0x58c8aa(0x247)])(_0x249842);common_1['Logger'][_0x58c8aa(0x1da)](_0x58c8aa(0x21e),_0x58c8aa(0x26f));const _0xc8a39f=Buffer[_0x58c8aa(0x25c)](_0x22dfc9[_0x58c8aa(0x23c)]),_0x23972a=new Date(),_0x4c9e97=_0x23972a[_0x58c8aa(0x1fa)](),_0x178ea3=String(_0x23972a[_0x58c8aa(0x2b2)]()+0x1)[_0x58c8aa(0x20c)](0x2,'0'),_0x2f9582=String(_0x23972a[_0x58c8aa(0x26c)]())[_0x58c8aa(0x20c)](0x2,'0'),_0x489fc9=''+_0x4c9e97+_0x178ea3+'/'+_0x2f9582,_0x45fae7=await this[_0x58c8aa(0x27e)][_0x58c8aa(0x2bf)]({'buffer':_0xc8a39f,'mimetype':_0x58c8aa(0x1e3)},_0x58c8aa(0x2c1)+_0x489fc9);await Promise['all']([this[_0x58c8aa(0x2a6)][_0x58c8aa(0x1ee)](_0x542a66,{'ttsUrl':_0x45fae7}),this[_0x58c8aa(0x2bc)][_0x58c8aa(0x272)](_0xee4b09[_0x58c8aa(0x219)]['id'],_0x4753ea,_0x4e5adf)]),_0x5d83e2[_0x58c8aa(0x2aa)](0xc8)['send']({'ttsUrl':_0x45fae7});}catch(_0x118ef8){common_1[_0x58c8aa(0x26b)][_0x58c8aa(0x2b4)](_0x58c8aa(0x233),_0x118ef8,'TTSService'),_0x5d83e2[_0x58c8aa(0x2aa)](0x1f4)[_0x58c8aa(0x289)]({'error':_0x58c8aa(0x28c)});}}};function _0x49ae(_0x36badb,_0x4e1605){const _0x153f04=_0x153f();return _0x49ae=function(_0x49ae9e,_0x5b9824){_0x49ae9e=_0x49ae9e-0x1b9;let _0x4a37b2=_0x153f04[_0x49ae9e];return _0x4a37b2;},_0x49ae(_0x36badb,_0x4e1605);}ChatService=__decorate([(0x0,common_1[_0x5c14af(0x249)])(),__param(0x0,(0x0,typeorm_1[_0x5c14af(0x1bc)])(config_entity_1['ConfigEntity'])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(app_entity_1[_0x5c14af(0x2a2)])),__param(0x2,(0x0,typeorm_1[_0x5c14af(0x1bc)])(plugin_entity_1[_0x5c14af(0x217)])),__metadata('design:paramtypes',[typeorm_2[_0x5c14af(0x211)],typeorm_2[_0x5c14af(0x211)],typeorm_2['Repository'],suno_service_1[_0x5c14af(0x246)],openaiChat_service_1['OpenAIChatService'],chatLog_service_1[_0x5c14af(0x23b)],midjourneyDraw_service_1[_0x5c14af(0x275)],stableDiffusion_service_1[_0x5c14af(0x29b)],userBalance_service_1[_0x5c14af(0x1f8)],user_service_1[_0x5c14af(0x253)],upload_service_1[_0x5c14af(0x1c0)],badWords_service_1[_0x5c14af(0x2a9)],autoreply_service_1[_0x5c14af(0x2a8)],globalConfig_service_1[_0x5c14af(0x1d0)],chatGroup_service_1[_0x5c14af(0x1d5)],models_service_1[_0x5c14af(0x2ad)],openaiDraw_service_1[_0x5c14af(0x240)],lumaVideo_service_1['LumaVideoService'],cogVideo_service_1['CogVideoService'],fluxDraw_service_1[_0x5c14af(0x274)],aiPPT_1['AiPptService']])],ChatService),exports[_0x5c14af(0x290)]=ChatService;function _0x153f(){const _0x30586a=['系统消息超过最大长度，将被截断','defineProperty','Content-type','ChatLogService','data','更新标题名称为:\x20','binary','成功获取图片，正在转换为Base64:\x20','OpenAIDrawService','application/json','../models/models.service','aiPPT','data:','title','SunoService','default','suno','Injectable','then','updateChatTitle','../ai/stableDiffusion.service','application/octet-stream;\x20charset=utf-8','stable-diffusion','../ai/openaiChat.service','fileInfo','../ai/suno.service','}，给这个对话取一个名字，不超过10个字','UserService','固定模型、使用应用预设:\x20','}，生成三个更进入一步的提问，用{}包裹每个问题，不需要分行，不需要其他任何内容，单个提问不超过30个字','sdxl','@nestjs/typeorm','pluginEntity','write','model','formatUrl','from','userBalance','image_url','appEntity','usePlugin','globalConfigService','isArray','../ai/lumaVideo.service',';base64,','开始生成PPT','getTokenCount','trim','lumaVideo','forEach','调用\x20chatFree\x20出错:\x20','Logger','getDate','mjTranslatePrompt','正在尝试转换URL为Base64:\x20','TTSService','/plugins/','onyx','deductFromBalance','创意\x20AI','FluxDrawService','MidjourneyService','@nestjs/common','openaiBaseUrl','replace','decorate','__metadata','queryUserBalance','typeorm','map','uploadService','fluxDrawService','1338295dvbJmo','midjourneyService','getGroupInfoFromId','sunoService','提交成功，歌曲生成中','stringify','openaiVoice','content','slice','send','headers','发生错误:','Failed\x20to\x20process\x20TTS\x20request','../ai/aiPPT','以下是我提供给你的知识库：【','split','ChatService','aiPptService','userService','转换URL为Base64时发生错误:','dall-e-3','config','HttpException','function','getOwnPropertyDescriptor','100%','记录:','StableDiffusionService','更新对话组标题失败:\x20','modelInfo','任务提交失败，不执行扣费','POST','__param','ttsProcess','AppEntity','getCurrentModelKeyInfo','】，在回答问题之前，先检索知识库内有没有相关的内容，尽量使用知识库中获取到的信息来回答我的问题，以知识库中的为准。','成功转换URL为Base64:\x20','chatLogService','3272400XvSsWA','AutoreplyService','BadWordsService','status','../user/user.service','__decorate','ModelsService','parameters','assign','../ai/openaiDraw.service','1616108EBTaWL','getMonth','fluxDraw','error','text','处理历史记录时出错:','base64','isConvertToBase64','luma-video','flux','checkUserStatus','userBalanceService','openAIDrawService','toISOString','uploadFile','all','audio/openai/','assistant','196263eDwyYc','未找到当前模型key，切换至全局模型','error:\x20','isSystemPlugin','saveChatLog','answer','InjectRepository','warn','390LuVKdw','../badWords/badWords.service','UploadService','PluginService','../ai/fluxDraw.service',',\x20消耗积分：\x20','configEntity','pluginUrl','}以及\x20AI\x20的回答{','使用文件解析:\x20','setHeader','content-type','5402036bkVTMC','object','返回原始链接:\x20','BAD_REQUEST','__esModule','includes','GlobalConfigService','updateTime','166585DQRKoH','midjourney','chat-error\x20<----------------------------------------->','ChatGroupService','../chatGroup/chatGroup.service','lumaVideoService','TOO_MANY_REQUESTS','errMsg','log','join','validateBalance','stableDiffusionService','metadata','debug','saveUseLog','绘制中','\x20模型:\x20','audio/mpeg','close','parse','使用应用预设:\x20','convertUrlToBase64','pluginKey','openAIChatService','arraybuffer','isMjTranslate','DrawService','cog-video','updateChatLog','IMAGINE','用户ID:\x20','autoreplyService','dalleDraw','\x20消耗token:\x20','UPSCALE','end','findOne','生成中','UserBalanceService','Translate\x20any\x20given\x20phrase\x20from\x20any\x20language\x20into\x20English.\x20For\x20instance,\x20when\x20I\x20input\x20\x27{可爱的熊猫}\x27,\x20you\x20should\x20output\x20\x27{cute\x20panda}\x27,\x20with\x20no\x20period\x20at\x20the\x20end.','getFullYear','chatProcess','ceil','https://api.openai.com','你当前使用的应用已被下架、请删除当前对话开启新的对话吧！','HttpStatus','get','getConfigs','\x0a\x20Current\x20date:\x20','axios','preset','modelsService','length','chatGroupService','checkBadWords','根据用户提问{','splice','生成失败','padStart','chatFree','checkModelLimits','modelName','toString','Repository','tts-1','gpt-4-gizmo-','../userBalance/userBalance.service','openAIChat','ai-ppt','PluginEntity','开始\x20TTS\x20请求:','user','../chatLog/chatLog.service','210vVLFdu','checkUserCertification','buildMessageFromParentMessageId','TTS\x20请求获取成功','Bearer\x20','push','update','绘图失败','openaiTimeout','suno-music','cogVideoService','提交成功，视频生成中','chatHistory','badWordsService','role','45239652CHFtiV','openaiBaseKey','../ai/cogVideo.service','3BAaoFf','getClientIp','gpts','11tdEVqU','8wQGcxA','\x20模型名称:\x20','TTS\x20请求或上传过程失败:','插件调用错误:\x20','../globalConfig/globalConfig.service','../upload/upload.service','插件返回结果:\x20'];_0x153f=function(){return _0x30586a;};return _0x153f();}