'use strict';const _0x3f8ccc=_0x112e;(function(_0x4e3a71,_0x572fba){const _0x29b33d=_0x112e,_0x46af7e=_0x4e3a71();while(!![]){try{const _0x1b1705=-parseInt(_0x29b33d(0x2d5))/0x1+-parseInt(_0x29b33d(0x2c7))/0x2*(-parseInt(_0x29b33d(0x23f))/0x3)+-parseInt(_0x29b33d(0x285))/0x4*(parseInt(_0x29b33d(0x28e))/0x5)+-parseInt(_0x29b33d(0x2a6))/0x6+parseInt(_0x29b33d(0x207))/0x7+parseInt(_0x29b33d(0x25f))/0x8+-parseInt(_0x29b33d(0x21c))/0x9*(parseInt(_0x29b33d(0x263))/0xa);if(_0x1b1705===_0x572fba)break;else _0x46af7e['push'](_0x46af7e['shift']());}catch(_0x44d95f){_0x46af7e['push'](_0x46af7e['shift']());}}}(_0x5c4e,0xdeeca));var __decorate=this&&this[_0x3f8ccc(0x225)]||function(_0x29d371,_0x393b3a,_0x5142a0,_0x5aa8de){const _0x59a344=_0x3f8ccc;var _0x391056=arguments[_0x59a344(0x1d8)],_0x1ece39=_0x391056<0x3?_0x393b3a:_0x5aa8de===null?_0x5aa8de=Object[_0x59a344(0x280)](_0x393b3a,_0x5142a0):_0x5aa8de,_0x212418;if(typeof Reflect===_0x59a344(0x29c)&&typeof Reflect['decorate']===_0x59a344(0x200))_0x1ece39=Reflect['decorate'](_0x29d371,_0x393b3a,_0x5142a0,_0x5aa8de);else{for(var _0x371c68=_0x29d371[_0x59a344(0x1d8)]-0x1;_0x371c68>=0x0;_0x371c68--)if(_0x212418=_0x29d371[_0x371c68])_0x1ece39=(_0x391056<0x3?_0x212418(_0x1ece39):_0x391056>0x3?_0x212418(_0x393b3a,_0x5142a0,_0x1ece39):_0x212418(_0x393b3a,_0x5142a0))||_0x1ece39;}return _0x391056>0x3&&_0x1ece39&&Object[_0x59a344(0x226)](_0x393b3a,_0x5142a0,_0x1ece39),_0x1ece39;},__metadata=this&&this[_0x3f8ccc(0x1ef)]||function(_0x263e9f,_0x39c942){const _0x19d42e=_0x3f8ccc;if(typeof Reflect===_0x19d42e(0x29c)&&typeof Reflect['metadata']===_0x19d42e(0x200))return Reflect[_0x19d42e(0x224)](_0x263e9f,_0x39c942);},__param=this&&this[_0x3f8ccc(0x2da)]||function(_0x54df7c,_0xc8186e){return function(_0x352f6a,_0x42937d){_0xc8186e(_0x352f6a,_0x42937d,_0x54df7c);};};Object[_0x3f8ccc(0x226)](exports,_0x3f8ccc(0x2ba),{'value':!![]}),exports[_0x3f8ccc(0x273)]=void 0x0;function _0x112e(_0x24fe7e,_0x174027){const _0x5c4e8f=_0x5c4e();return _0x112e=function(_0x112ee3,_0x269335){_0x112ee3=_0x112ee3-0x1d6;let _0x43fb2b=_0x5c4e8f[_0x112ee3];return _0x43fb2b;},_0x112e(_0x24fe7e,_0x174027);}const utils_1=require(_0x3f8ccc(0x27b)),common_1=require(_0x3f8ccc(0x1e6)),typeorm_1=require(_0x3f8ccc(0x2a9)),axios_1=require(_0x3f8ccc(0x24c)),typeorm_2=require(_0x3f8ccc(0x1ee)),aiPPT_1=require(_0x3f8ccc(0x2a1)),cogVideo_service_1=require(_0x3f8ccc(0x221)),fluxDraw_service_1=require('../ai/fluxDraw.service'),lumaVideo_service_1=require(_0x3f8ccc(0x26d)),midjourneyDraw_service_1=require(_0x3f8ccc(0x260)),openaiChat_service_1=require('../ai/openaiChat.service'),openaiDraw_service_1=require(_0x3f8ccc(0x26e)),stableDiffusion_service_1=require('../ai/stableDiffusion.service'),suno_service_1=require(_0x3f8ccc(0x22a)),app_entity_1=require(_0x3f8ccc(0x2d6)),autoreply_service_1=require(_0x3f8ccc(0x1da)),badWords_service_1=require(_0x3f8ccc(0x25e)),chatGroup_service_1=require(_0x3f8ccc(0x1ff)),chatLog_service_1=require(_0x3f8ccc(0x23b)),config_entity_1=require(_0x3f8ccc(0x1f0)),globalConfig_service_1=require(_0x3f8ccc(0x252)),models_service_1=require(_0x3f8ccc(0x2b7)),plugin_entity_1=require(_0x3f8ccc(0x240)),upload_service_1=require(_0x3f8ccc(0x2b0)),user_service_1=require(_0x3f8ccc(0x2d4)),userBalance_service_1=require(_0x3f8ccc(0x2cc));let ChatService=class ChatService{constructor(_0xef2b2,_0x465bcb,_0x237c61,_0x4115ce,_0x47dd26,_0x5c5c85,_0x1439ae,_0x50aba3,_0xf92dde,_0xc3f47d,_0x56b8b9,_0x4e2002,_0x22d815,_0x285a24,_0x99cc57,_0x7368b5,_0x29adc2,_0x1e84b7,_0x5abfab,_0x11543c,_0x25f626){const _0x14aefc=_0x3f8ccc;this[_0x14aefc(0x244)]=_0xef2b2,this[_0x14aefc(0x24f)]=_0x465bcb,this[_0x14aefc(0x297)]=_0x237c61,this[_0x14aefc(0x2c0)]=_0x4115ce,this['openAIChatService']=_0x47dd26,this['chatLogService']=_0x5c5c85,this[_0x14aefc(0x1f9)]=_0x1439ae,this[_0x14aefc(0x1e3)]=_0x50aba3,this['userBalanceService']=_0xf92dde,this[_0x14aefc(0x2dc)]=_0xc3f47d,this[_0x14aefc(0x27e)]=_0x56b8b9,this['badWordsService']=_0x4e2002,this[_0x14aefc(0x23a)]=_0x22d815,this[_0x14aefc(0x29f)]=_0x285a24,this[_0x14aefc(0x1e4)]=_0x99cc57,this['modelsService']=_0x7368b5,this['openAIDrawService']=_0x29adc2,this[_0x14aefc(0x1f3)]=_0x1e84b7,this['cogVideoService']=_0x5abfab,this[_0x14aefc(0x27d)]=_0x11543c,this[_0x14aefc(0x1d6)]=_0x25f626;}async[_0x3f8ccc(0x21f)](_0x18bafc,_0x129222,_0xd4c295){const _0x184237=_0x3f8ccc;await this['userBalanceService'][_0x184237(0x206)](_0x129222[_0x184237(0x255)]['id']);const {options:options={},usingPluginId:_0x19af75,appId:appId=null,specialModel:_0x1cb030,prompt:_0x5b3940,fileInfo:_0x44291d,extraParam:_0x1649f4,model:_0x3cabaa,drawId:_0x25da51,customId:_0x39223c,action:_0x574059,modelName:_0x118435,modelAvatar:_0xf0f680}=_0x18bafc;let _0xf6b946;if(_0x1cb030)_0xf6b946=await this[_0x184237(0x24f)][_0x184237(0x2d3)]({'where':{'des':_0x1cb030,'isSystemReserved':!![]}});else{if(appId){_0xf6b946=await this[_0x184237(0x24f)][_0x184237(0x2d3)]({'where':{'id':appId,'status':(0x0,typeorm_2['In'])([0x1,0x3,0x4,0x5])}});if(!_0xf6b946)throw new common_1[(_0x184237(0x28b))](_0x184237(0x248),common_1['HttpStatus'][_0x184237(0x1db)]);}}const {groupId:_0x329fb9,fileParsing:_0x7990ec}=options,{openaiTimeout:_0x166a6c,openaiBaseUrl:_0x1beea6,openaiBaseKey:_0x5148b5,systemPreMessage:_0x5737f2,isMjTranslate:_0xe381e8,mjTranslatePrompt:_0x5a35c2,openaiTemperature:_0x216b2c,openaiBaseModel:_0x1e3b40,isGeneratePromptReference:_0x261590,isConvertToBase64:_0x4e10e4,isSensitiveWordFilter:_0x4cc655}=await this[_0x184237(0x29f)][_0x184237(0x2e1)]([_0x184237(0x2cb),_0x184237(0x2a5),_0x184237(0x211),'systemPreMessage','isMjTranslate','mjTranslatePrompt',_0x184237(0x250),_0x184237(0x29b),_0x184237(0x230),_0x184237(0x203),_0x184237(0x291)]);await this[_0x184237(0x2dc)][_0x184237(0x1f2)](_0x129222[_0x184237(0x255)]),_0xd4c295&&_0xd4c295[_0x184237(0x26f)](_0x184237(0x219),_0x184237(0x1de));if(_0x4cc655==='1'){const _0xafea61=await this[_0x184237(0x28d)][_0x184237(0x262)](_0x5b3940,_0x129222[_0x184237(0x255)]['id']);if(_0xafea61[_0x184237(0x1d8)]>0x0){const _0x491ba6='您提交的信息中包含违规的内容，我们已对您的账户进行标记，请合规使用！';throw new common_1['HttpException'](_0x491ba6,common_1[_0x184237(0x2b8)][_0x184237(0x1db)]);}}const _0x113c55=await this[_0x184237(0x23a)][_0x184237(0x1f8)](_0x5b3940);let _0x4fb4c6=null,_0x3734b7='',_0xcf6891='';_0xd4c295&&_0xd4c295['status'](0xc8);let _0x257403=null;const _0x37bfad=(0x0,utils_1[_0x184237(0x292)])(_0x129222);let _0x37f2f0,_0x271856='',_0x5b21db;_0x19af75&&(_0x5b21db=await this[_0x184237(0x297)][_0x184237(0x2d3)]({'where':{'id':_0x19af75}}));if(_0xf6b946){const {isGPTs:_0x153c15,gizmoID:_0xaf5c3a,name:_0x2cf40e,isFixedModel:_0x5fa615,appModel:_0x1c956d,coverImg:_0x26adef}=_0xf6b946;_0x271856=_0x26adef,_0x3734b7=_0x2cf40e;if(_0x153c15)_0x4fb4c6=await this[_0x184237(0x21d)][_0x184237(0x212)](_0x184237(0x261)),_0x4fb4c6[_0x184237(0x1f6)]=_0x184237(0x259)+_0xaf5c3a;else!_0x153c15&&_0x5fa615&&_0x1c956d?(_0xf6b946[_0x184237(0x21e)]&&(_0xcf6891=_0xf6b946[_0x184237(0x21e)]),_0x4fb4c6=await this[_0x184237(0x21d)][_0x184237(0x212)](_0x1c956d),_0x4fb4c6['model']=_0x1c956d,_0x7990ec&&(_0xcf6891=_0xcf6891+_0x184237(0x20c)+_0x7990ec+_0x184237(0x21a)),common_1[_0x184237(0x279)]['log'](_0x184237(0x231)+_0xcf6891,'ChatService')):(_0xf6b946['preset']&&(_0xcf6891=_0xf6b946['preset']),_0x4fb4c6=await this['modelsService'][_0x184237(0x212)](_0x3cabaa),_0x7990ec&&(_0xcf6891=_0xcf6891+_0x184237(0x20c)+_0x7990ec+_0x184237(0x21a)),common_1[_0x184237(0x279)][_0x184237(0x220)](_0x184237(0x217)+_0xcf6891,'ChatService'));}else{const _0x453d69=await this[_0x184237(0x1e4)][_0x184237(0x271)](_0x329fb9);if(_0x5b21db&&_0x5b21db[_0x184237(0x2c6)]===0x0){let _0x30ff74='';try{_0x30ff74=await this['usePlugin'](_0x5b3940,_0x5b21db[_0x184237(0x2d1)]),common_1['Logger'][_0x184237(0x220)](_0x184237(0x1ed)+_0x30ff74,'ChatService');}catch(_0x41c261){_0x30ff74=_0x5b3940,common_1[_0x184237(0x279)][_0x184237(0x1d7)](_0x184237(0x222)+_0x41c261);}_0xcf6891=_0x30ff74,_0x4fb4c6=await this[_0x184237(0x21d)][_0x184237(0x212)](_0x3cabaa),common_1[_0x184237(0x279)]['log'](_0x184237(0x293)+_0xcf6891,_0x184237(0x273));}else{if(_0x7990ec)_0xcf6891=_0x184237(0x20c)+_0x7990ec+_0x184237(0x21a),_0x4fb4c6=await this['modelsService']['getCurrentModelKeyInfo'](_0x3cabaa),common_1[_0x184237(0x279)][_0x184237(0x220)]('使用文件解析:\x20'+_0xcf6891,'ChatService');else{const _0x28d004=new Date()[_0x184237(0x201)]()['split']('T')[0x0];_0xcf6891=_0x5737f2+('\x0a\x20Current\x20date:\x20'+_0x28d004),_0x4fb4c6=await this['modelsService'][_0x184237(0x212)](_0x3cabaa),common_1['Logger'][_0x184237(0x220)](_0x184237(0x241)+_0xcf6891,_0x184237(0x273));}}}if(!_0x4fb4c6){common_1[_0x184237(0x279)][_0x184237(0x1ec)]('未找到当前模型key，切换至全局模型','ChatService'),_0x4fb4c6=await this['modelsService'][_0x184237(0x212)](_0x1e3b40);const _0x5830eb=await this[_0x184237(0x1e4)][_0x184237(0x271)](_0x329fb9);let _0x138524=_0x5830eb['config'];try{const _0x27dd60=JSON[_0x184237(0x1dc)](_0x5830eb[_0x184237(0x27a)]);_0x27dd60[_0x184237(0x253)]&&(_0x27dd60[_0x184237(0x253)][_0x184237(0x1e8)]=_0x4fb4c6[_0x184237(0x1e8)],_0x27dd60[_0x184237(0x253)][_0x184237(0x1f6)]=_0x4fb4c6[_0x184237(0x1f6)],_0x138524=JSON[_0x184237(0x2b9)](_0x27dd60));}catch(_0x236d07){common_1['Logger'][_0x184237(0x1ec)](_0x184237(0x281),_0x184237(0x273));throw new common_1['HttpException'](_0x184237(0x2a7),common_1[_0x184237(0x2b8)][_0x184237(0x1db)]);}await this[_0x184237(0x1e4)][_0x184237(0x2ae)]({'groupId':_0x329fb9,'title':_0x5830eb['title'],'isSticky':![],'config':_0x138524,'fileUrl':''},_0x129222);}const {deduct:_0x551d1b,isTokenBased:_0x4b3b6c,tokenFeeRatio:_0x206398,deductType:_0x5553ef,key:_0x131fec,id:_0x46972d,maxRounds:_0x46bc72,proxyUrl:_0x2f17a8,maxModelTokens:_0x2a48ba,timeout:_0xcb819,model:_0x1fb57f,isFileUpload:_0x488fe2,keyType:_0x17e031}=_0x4fb4c6;if(await this[_0x184237(0x2b3)][_0x184237(0x2aa)](_0x129222[_0x184237(0x255)],_0x1fb57f))throw new common_1[(_0x184237(0x28b))](_0x184237(0x1dd),common_1['HttpStatus']['TOO_MANY_REQUESTS']);if(_0xe381e8==='1'&&_0x574059==='IMAGINE'&&_0x3cabaa===_0x184237(0x204)){const [_0x3fdb2b,_0xaecdd3]=_0x5b3940['split'](/(?= --)/),_0x4dd083=/(https?:\/\/[^\s]+)/g,_0x3090f1=_0x3fdb2b[_0x184237(0x2b1)](_0x4dd083)||[];let _0x22fb72=_0x3fdb2b[_0x184237(0x296)](_0x4dd083,'')[_0x184237(0x266)]();const _0x2b9d8c=await this[_0x184237(0x2d9)]['chatFree'](_0x22fb72,_0x5a35c2||_0x184237(0x2b4)),_0x22fb13=[..._0x3090f1,_0x2b9d8c][_0x184237(0x264)]('\x20')['trim']();_0x37f2f0=_0xaecdd3?''+_0x22fb13+_0xaecdd3:_0x22fb13,_0x488fe2==='1'&&_0x44291d&&(_0x37f2f0=_0x44291d+'\x20'+_0x37f2f0);}else _0x37f2f0=_0x488fe2==='1'&&_0x44291d?_0x44291d+'\x20'+_0x5b3940:_0x5b3940;await this['userBalanceService'][_0x184237(0x2be)](_0x129222,_0x5553ef,_0x551d1b);const _0x7c2d42=_0x118435,_0x2fd1b0=(0x0,utils_1[_0x184237(0x27f)])(_0x2f17a8||_0x1beea6||_0x184237(0x1d9)),_0x5d4eb8=_0x131fec||_0x5148b5,_0x380575=(_0xcb819||_0x166a6c||0x12c)*0x3e8,_0x34de25=Number(_0x216b2c)||0x1;if(_0x329fb9){const _0x50af5a=await this['chatGroupService'][_0x184237(0x271)](_0x329fb9);this[_0x184237(0x1fa)](_0x329fb9,_0x50af5a,_0x17e031,_0x5b3940,_0x129222),await this[_0x184237(0x1e4)]['updateTime'](_0x329fb9);}const _0x327045=await this[_0x184237(0x2b3)][_0x184237(0x26a)]({'appId':appId,'curIp':_0x37bfad,'userId':_0x129222[_0x184237(0x255)]['id'],'type':_0x17e031?_0x17e031:0x1,'prompt':_0x5b3940,'fileInfo':_0x44291d?_0x44291d:null,'answer':'','promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x1fb57f,'modelName':'我','role':'user','groupId':_0x329fb9?_0x329fb9:null}),_0x129dc8=await this[_0x184237(0x2b3)]['saveChatLog']({'appId':appId?appId:null,'action':_0x574059?_0x574059:null,'curIp':_0x37bfad,'userId':_0x129222['user']['id'],'type':_0x17e031?_0x17e031:0x1,'prompt':_0x5b3940,'fileInfo':null,'answer':'','progress':'0%','promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x1fb57f,'modelName':_0x7c2d42,'role':'assistant','groupId':_0x329fb9?_0x329fb9:null,'status':0x2,'modelAvatar':(_0x5b21db===null||_0x5b21db===void 0x0?void 0x0:_0x5b21db[_0x184237(0x2a4)])||_0x271856||_0xf0f680||'','pluginParam':(_0x5b21db===null||_0x5b21db===void 0x0?void 0x0:_0x5b21db[_0x184237(0x2d1)])?_0x5b21db[_0x184237(0x2d1)]:_0x17e031===0x2?_0x1fb57f:null}),_0x7a6bc1=_0x327045['id'],_0x5399e2=_0x129dc8['id'];if(_0x113c55[_0x184237(0x22d)]&&_0xd4c295){if(_0x113c55['isAIReplyEnabled']===0x0){const _0x19f87e=_0x113c55[_0x184237(0x22d)][_0x184237(0x2c3)](''),_0x8aaa71=_0x3c6563=>{const _0x64b815=_0x184237;if(_0x3c6563<_0x19f87e[_0x64b815(0x1d8)]){const _0x42a139={'text':_0x19f87e[_0x3c6563]};_0xd4c295[_0x64b815(0x1e0)](JSON['stringify'](_0x42a139)+'\x0a'),setTimeout(()=>_0x8aaa71(_0x3c6563+0x1),0xa);}else _0xd4c295[_0x64b815(0x20d)]();};_0x8aaa71(0x0),await this[_0x184237(0x2b3)]['updateChatLog'](_0x5399e2,{'answer':_0x113c55[_0x184237(0x22d)]});return;}else _0xcf6891=_0xcf6891+_0x113c55[_0x184237(0x22d)];}const {messagesHistory:_0x2b232a}=await this[_0x184237(0x29a)](_0x5b3940,{'groupId':_0x329fb9,'systemMessage':_0xcf6891,'maxModelTokens':_0x2a48ba,'maxRounds':_0x46bc72,'isConvertToBase64':_0x4e10e4,'fileInfo':_0x44291d,'model':_0x1fb57f,'isFileUpload':_0x488fe2},this['chatLogService']);let _0x8af9a1=_0x574059!==_0x184237(0x2bf)&&_0x1fb57f===_0x184237(0x204)?_0x551d1b*0x4:_0x551d1b;const _0x2927d4=new AbortController();try{if(_0xd4c295){_0xd4c295['on'](_0x184237(0x28a),()=>{const _0x4b323a=_0x184237;_0x2927d4[_0x4b323a(0x1f7)]();});let _0x160e31,_0x746f85=!![];try{if((_0x1fb57f===_0x184237(0x29d)||_0x1fb57f===_0x184237(0x204)||_0x1fb57f===_0x184237(0x1f5)||_0x1fb57f===_0x184237(0x25a)||_0x1fb57f==='luma-video'||_0x1fb57f[_0x184237(0x236)](_0x184237(0x2af))||_0x1fb57f['includes']('cog-video')||_0x1fb57f[_0x184237(0x236)](_0x184237(0x25d)))&&_0x17e031===0x2){if(_0x1fb57f===_0x184237(0x29d))_0x160e31=this[_0x184237(0x23d)][_0x184237(0x295)]({'prompt':_0x5b3940,'extraParam':_0x1649f4,'apiKey':_0x5d4eb8,'proxyUrl':_0x2fd1b0,'model':_0x1fb57f,'timeout':_0x380575,'modelName':_0x7c2d42,'groupId':_0x329fb9,'onSuccess':async _0xc79068=>{const _0x5d87f8=_0x184237;await this['chatLogService']['updateChatLog'](_0x5399e2,{'fileInfo':_0xc79068===null||_0xc79068===void 0x0?void 0x0:_0xc79068[_0x5d87f8(0x2dd)],'answer':(_0xc79068===null||_0xc79068===void 0x0?void 0x0:_0xc79068[_0x5d87f8(0x22d)])||_0x5b3940,'progress':_0x5d87f8(0x2b5),'status':_0xc79068[_0x5d87f8(0x205)]});},'onFailure':async _0x58cf77=>{const _0xda0022=_0x184237;await this[_0xda0022(0x2b3)][_0xda0022(0x2d0)](_0x5399e2,{'answer':'绘图失败','status':_0x58cf77[_0xda0022(0x205)]});}},this[_0x184237(0x29a)]),await this[_0x184237(0x2b3)][_0x184237(0x2d0)](_0x5399e2,{'answer':_0x184237(0x24a)});else{if(_0x1fb57f===_0x184237(0x1f5))common_1[_0x184237(0x279)]['log'](_0x184237(0x1fb),_0x184237(0x26c)),_0x160e31=this['aiPptService'][_0x184237(0x239)]({'usePrompt':_0x37f2f0,'prompt':_0x5b3940,'apiKey':_0x5d4eb8,'proxyUrl':_0x2fd1b0,'model':_0x1fb57f,'modelName':_0x7c2d42,'drawId':_0x25da51,'customId':_0x39223c,'action':_0x574059,'timeout':_0x380575,'assistantLogId':_0x5399e2,'extraParam':_0x1649f4,'fileInfo':_0x44291d}),await this[_0x184237(0x2b3)][_0x184237(0x2d0)](_0x5399e2,{'answer':_0x184237(0x227)});else{if(_0x1fb57f['includes'](_0x184237(0x25d)))_0x160e31=this[_0x184237(0x27d)][_0x184237(0x202)]({'prompt':_0x5b3940,'extraParam':_0x1649f4,'apiKey':_0x5d4eb8,'proxyUrl':_0x2fd1b0,'model':_0x1fb57f,'timeout':_0x380575,'modelName':_0x7c2d42,'groupId':_0x329fb9,'onSuccess':async _0x4cde4f=>{const _0xb3aa11=_0x184237;await this[_0xb3aa11(0x2b3)][_0xb3aa11(0x2d0)](_0x5399e2,{'fileInfo':_0x4cde4f===null||_0x4cde4f===void 0x0?void 0x0:_0x4cde4f[_0xb3aa11(0x2dd)],'answer':(_0x4cde4f===null||_0x4cde4f===void 0x0?void 0x0:_0x4cde4f[_0xb3aa11(0x22d)])||_0x5b3940,'progress':_0xb3aa11(0x2b5),'status':_0x4cde4f[_0xb3aa11(0x205)]});},'onFailure':async _0x138f04=>{const _0x323f62=_0x184237;await this[_0x323f62(0x2b3)][_0x323f62(0x2d0)](_0x5399e2,{'answer':'绘图失败','status':_0x138f04[_0x323f62(0x205)]});}},this[_0x184237(0x29a)]),await this['chatLogService'][_0x184237(0x2d0)](_0x5399e2,{'answer':_0x184237(0x24a)});else{if(_0x1fb57f['includes'](_0x184237(0x25a)))_0x160e31=this[_0x184237(0x2c0)]['suno']({'assistantLogId':_0x5399e2,'apiKey':_0x5d4eb8,'action':_0x574059,'prompt':_0x5b3940,'timeout':_0x380575,'proxyUrl':_0x2fd1b0,'taskData':_0x39223c}),await this[_0x184237(0x2b3)]['updateChatLog'](_0x5399e2,{'answer':_0x184237(0x2c8)});else{if(_0x1fb57f[_0x184237(0x236)](_0x184237(0x288)))_0x160e31=this[_0x184237(0x1f3)]['lumaVideo']({'fileInfo':_0x44291d,'extraParam':_0x1649f4,'assistantLogId':_0x5399e2,'apiKey':_0x5d4eb8,'action':_0x574059,'prompt':_0x5b3940,'model':_0x1fb57f,'timeout':_0x380575,'proxyUrl':_0x2fd1b0,'taskData':_0x39223c,'onGenerate':async _0x863def=>{const _0xf7f7bf=_0x184237;await this[_0xf7f7bf(0x2b3)][_0xf7f7bf(0x2d0)](_0x5399e2,{'fileInfo':_0x863def===null||_0x863def===void 0x0?void 0x0:_0x863def[_0xf7f7bf(0x2dd)],'answer':(_0x863def===null||_0x863def===void 0x0?void 0x0:_0x863def[_0xf7f7bf(0x22d)])||_0x5b3940,'status':0x2});},'onSuccess':async _0x26fd1b=>{const _0x84c03e=_0x184237;await this[_0x84c03e(0x2b3)][_0x84c03e(0x2d0)](_0x5399e2,{'fileInfo':_0x26fd1b===null||_0x26fd1b===void 0x0?void 0x0:_0x26fd1b['fileInfo'],'answer':(_0x26fd1b===null||_0x26fd1b===void 0x0?void 0x0:_0x26fd1b[_0x84c03e(0x22d)])||_0x5b3940,'progress':_0x84c03e(0x2b5),'status':0x3});},'onFailure':async _0x215b76=>{const _0x2a7e11=_0x184237;await this[_0x2a7e11(0x2b3)][_0x2a7e11(0x2d0)](_0x5399e2,{'answer':_0x215b76[_0x2a7e11(0x298)],'status':0x4});}}),await this['chatLogService']['updateChatLog'](_0x5399e2,{'answer':_0x184237(0x24d)});else{if(_0x1fb57f[_0x184237(0x236)](_0x184237(0x2de)))_0x160e31=this['cogVideoService'][_0x184237(0x2df)]({'fileInfo':_0x44291d,'extraParam':_0x1649f4,'assistantLogId':_0x5399e2,'apiKey':_0x5d4eb8,'action':_0x574059,'prompt':_0x5b3940,'model':_0x1fb57f,'timeout':_0x380575,'proxyUrl':_0x2fd1b0,'taskData':_0x39223c,'onGenerate':async _0x3d0024=>{const _0x267a14=_0x184237;await this['chatLogService'][_0x267a14(0x2d0)](_0x5399e2,{'fileInfo':_0x3d0024===null||_0x3d0024===void 0x0?void 0x0:_0x3d0024['fileInfo'],'answer':(_0x3d0024===null||_0x3d0024===void 0x0?void 0x0:_0x3d0024[_0x267a14(0x22d)])||_0x5b3940,'status':0x2});},'onSuccess':async _0xb3b415=>{const _0x2d4925=_0x184237;await this[_0x2d4925(0x2b3)][_0x2d4925(0x2d0)](_0x5399e2,{'fileInfo':_0xb3b415===null||_0xb3b415===void 0x0?void 0x0:_0xb3b415['fileInfo'],'answer':(_0xb3b415===null||_0xb3b415===void 0x0?void 0x0:_0xb3b415[_0x2d4925(0x22d)])||_0x5b3940,'progress':'100%','status':0x3});},'onFailure':async _0x786551=>{const _0x3eab0e=_0x184237;await this[_0x3eab0e(0x2b3)][_0x3eab0e(0x2d0)](_0x5399e2,{'answer':_0x786551[_0x3eab0e(0x298)],'status':0x4});}}),await this['chatLogService'][_0x184237(0x2d0)](_0x5399e2,{'answer':_0x184237(0x24d)});else _0x1fb57f[_0x184237(0x236)](_0x184237(0x2af))?(_0x160e31=this['stableDiffusionService']['sdxl']({'chatId':_0x5399e2,'maxModelTokens':_0x2a48ba,'apiKey':_0x5d4eb8,'model':_0x1fb57f,'modelName':_0x7c2d42,'modelType':_0x17e031,'prompt':_0x5b3940,'fileInfo':_0x44291d,'isFileUpload':_0x488fe2,'timeout':_0x380575,'proxyUrl':_0x2fd1b0,'onSuccess':async _0x481a51=>{const _0x2d2759=_0x184237;await this['chatLogService'][_0x2d2759(0x2d0)](_0x5399e2,{'fileInfo':_0x481a51===null||_0x481a51===void 0x0?void 0x0:_0x481a51[_0x2d2759(0x2dd)],'answer':(_0x481a51===null||_0x481a51===void 0x0?void 0x0:_0x481a51[_0x2d2759(0x22d)])||_0x5b3940,'progress':_0x2d2759(0x2b5),'status':0x3});},'onFailure':async _0xbfa505=>{const _0x1b9cb3=_0x184237;await this[_0x1b9cb3(0x2b3)][_0x1b9cb3(0x2d0)](_0x5399e2,{'answer':_0x1b9cb3(0x235),'status':0x4});}}),await this[_0x184237(0x2b3)][_0x184237(0x2d0)](_0x5399e2,{'answer':_0x184237(0x24a)})):(_0x160e31=await this['midjourneyService'][_0x184237(0x26b)]({'usePrompt':_0x37f2f0,'prompt':_0x5b3940,'apiKey':_0x5d4eb8,'proxyUrl':_0x2fd1b0,'model':_0x1fb57f,'modelName':_0x7c2d42,'drawId':_0x25da51,'customId':_0x39223c,'action':_0x574059,'fileInfo':_0x44291d,'timeout':_0x380575,'assistantLogId':_0x5399e2,'pluginName':_0x5b21db}),await this['chatLogService'][_0x184237(0x2d0)](_0x5399e2,{'answer':_0x160e31[_0x184237(0x22d)],'status':_0x160e31[_0x184237(0x205)]}));}}}}}_0x160e31[_0x184237(0x205)]!==0x5?(await this[_0x184237(0x21d)][_0x184237(0x265)](_0x46972d,0x1),await this[_0x184237(0x2ac)][_0x184237(0x27c)](_0x129222[_0x184237(0x255)]['id'],_0x5553ef,_0x8af9a1)):common_1[_0x184237(0x279)][_0x184237(0x220)](_0x184237(0x277),_0x184237(0x273));const _0x33c0c1=await this[_0x184237(0x2ac)][_0x184237(0x249)](_0x129222[_0x184237(0x255)]['id']);return _0x160e31[_0x184237(0x2d7)]=Object[_0x184237(0x2c5)]({},_0x33c0c1),_0x160e31[_0x184237(0x1eb)]=_0x160e31[_0x184237(0x22d)],_0x160e31[_0x184237(0x205)]=_0x160e31[_0x184237(0x205)]||0x2,_0x160e31[_0x184237(0x1f6)]=_0x3cabaa,_0x160e31[_0x184237(0x1e8)]=_0x118435,_0xd4c295[_0x184237(0x1e0)]('\x0a'+JSON[_0x184237(0x2b9)](_0x160e31));}else{_0x160e31=await this[_0x184237(0x2d9)][_0x184237(0x1ea)](_0x2b232a,{'chatId':_0x5399e2,'maxModelTokens':_0x2a48ba,'apiKey':_0x5d4eb8,'model':_0x1fb57f,'modelName':_0x7c2d42,'temperature':_0x34de25,'modelType':_0x17e031,'prompt':_0x5b3940,'fileInfo':_0x44291d,'isFileUpload':_0x488fe2,'timeout':_0x380575,'proxyUrl':_0x2fd1b0,'modelAvatar':_0xf0f680,'onProgress':_0x2c8155=>{const _0x4ba5df=_0x184237;_0xd4c295[_0x4ba5df(0x1e0)](_0x746f85?JSON[_0x4ba5df(0x2b9)](_0x2c8155):'\x0a'+JSON[_0x4ba5df(0x2b9)](_0x2c8155)),_0x746f85=![];},'onFailure':async _0x4b0184=>{const _0x1c3114=_0x184237;await this[_0x1c3114(0x2b3)]['updateChatLog'](_0x5399e2,{'answer':_0x4b0184[_0x1c3114(0x298)],'status':0x4});},'abortController':_0x2927d4});if(_0x160e31[_0x184237(0x298)])return common_1[_0x184237(0x279)][_0x184237(0x1d7)](_0x184237(0x1e5)+_0x129222[_0x184237(0x255)]['id']+'\x20模型名称:\x20'+_0x7c2d42+_0x184237(0x23c)+_0x3cabaa+_0x184237(0x2a8),_0x184237(0x273)),_0xd4c295[_0x184237(0x1e0)]('\x0a'+JSON[_0x184237(0x2b9)](_0x160e31));let _0x5ef1f3='';_0x2b232a[_0x184237(0x2a2)](_0x215d4a=>{const _0x97ebdb=_0x184237;_0x5ef1f3+=_0x215d4a[_0x97ebdb(0x210)]+'\x20';});const _0x2690ea=await(0x0,utils_1[_0x184237(0x25c)])(_0x5ef1f3),_0x2aed3a=await(0x0,utils_1[_0x184237(0x25c)])(_0x160e31[_0x184237(0x22d)]);await this[_0x184237(0x2b3)]['updateChatLog'](_0x7a6bc1,{'promptTokens':_0x2690ea,'completionTokens':_0x2aed3a,'totalTokens':_0x2690ea+_0x2aed3a});let _0x583cb1=_0x160e31[_0x184237(0x22d)];if(_0x4cc655==='1'){const _0x440d33=await this['badWordsService'][_0x184237(0x262)](_0x160e31['answer'],_0x129222[_0x184237(0x255)]['id']);if(_0x440d33[_0x184237(0x1d8)]>0x0){const _0x294546=new RegExp(_0x440d33['join']('|'),'gi');_0x583cb1=_0x583cb1[_0x184237(0x296)](_0x294546,_0x5dcd05=>'*'['repeat'](_0x5dcd05['length']));}}await this[_0x184237(0x2b3)][_0x184237(0x2d0)](_0x5399e2,{'fileInfo':_0x160e31===null||_0x160e31===void 0x0?void 0x0:_0x160e31['fileInfo'],'answer':_0x583cb1,'promptTokens':_0x2690ea,'completionTokens':_0x2aed3a,'totalTokens':_0x2690ea+_0x2aed3a,'status':0x3});try{if(_0x261590==='1'){const _0x1745d4=await this[_0x184237(0x2d9)][_0x184237(0x2c1)](_0x184237(0x23e)+_0x5b3940+_0x184237(0x2ab)+_0x160e31['answer']+'}，生成三个更进入一步的提问，用{}包裹每个问题，不需要分行，不需要其他任何内容，单个提问不超过30个字');await this['chatLogService'][_0x184237(0x2d0)](_0x5399e2,{'promptReference':_0x1745d4});}}catch(_0x209498){common_1['Logger'][_0x184237(0x1d7)]('调用\x20chatFree\x20出错:\x20'+_0x209498);}_0x4b3b6c===!![]&&(_0x8af9a1=_0x551d1b*Math[_0x184237(0x2b2)]((_0x2690ea+_0x2aed3a)/_0x206398));await this[_0x184237(0x2ac)][_0x184237(0x27c)](_0x129222['user']['id'],_0x5553ef,_0x8af9a1,_0x2690ea+_0x2aed3a),await this[_0x184237(0x21d)][_0x184237(0x265)](_0x46972d,_0x2690ea+_0x2aed3a),common_1[_0x184237(0x279)][_0x184237(0x220)](_0x184237(0x1e5)+_0x129222[_0x184237(0x255)]['id']+_0x184237(0x1e2)+_0x7c2d42+_0x184237(0x23c)+_0x3cabaa+_0x184237(0x283)+(_0x2690ea+_0x2aed3a)+_0x184237(0x1fe)+_0x8af9a1,_0x184237(0x273));const _0x218d0c=await this[_0x184237(0x2ac)][_0x184237(0x249)](_0x129222[_0x184237(0x255)]['id']);return _0x160e31[_0x184237(0x2d7)]=Object[_0x184237(0x2c5)]({},_0x218d0c),_0xd4c295['write']('\x0a'+JSON[_0x184237(0x2b9)](_0x160e31));}}catch(_0x1650a1){common_1[_0x184237(0x279)]['error'](_0x184237(0x233),_0x1650a1),await this['chatLogService']['updateChatLog'](_0x5399e2,{'status':0x5}),_0x160e31={'error':_0x184237(0x1e1)};}}else return _0x257403=await this['openAIChatService'][_0x184237(0x1ea)](_0x2b232a,{'chatId':_0x5399e2,'maxModelTokens':_0x2a48ba,'apiKey':_0x5d4eb8,'model':_0x1fb57f,'modelName':_0x7c2d42,'modelType':_0x17e031,'temperature':_0x34de25,'prompt':_0x5b3940,'fileInfo':_0x44291d,'isFileUpload':_0x488fe2,'timeout':_0x380575,'proxyUrl':_0x2fd1b0,'abortController':_0x2927d4}),await this[_0x184237(0x2ac)]['deductFromBalance'](_0x129222[_0x184237(0x255)]['id'],_0x5553ef,_0x8af9a1),_0x257403[_0x184237(0x22d)];}catch(_0x54a528){common_1[_0x184237(0x279)][_0x184237(0x1d7)](_0x184237(0x25b),_0x5d4eb8,_0x54a528);if(_0xd4c295)return _0xd4c295[_0x184237(0x1e0)](_0x184237(0x245));else throw new common_1[(_0x184237(0x28b))](_0x184237(0x245),common_1[_0x184237(0x2b8)]['BAD_REQUEST']);}finally{_0xd4c295&&_0xd4c295[_0x184237(0x20d)]();}}async[_0x3f8ccc(0x232)](_0x220c15,_0xbe5211){const _0x482da8=_0x3f8ccc,{pluginUrl:_0xefe01d,pluginKey:_0x5a1df6}=await this[_0x482da8(0x29f)][_0x482da8(0x2e1)]([_0x482da8(0x272),_0x482da8(0x257)]),_0x40e19c=_0x5a1df6,_0x15c87b=_0xefe01d,_0xd0d79e={'method':_0x482da8(0x208),'url':_0x15c87b+'/plugins/'+_0xbe5211,'headers':{'Content-Type':'application/json','Authorization':_0x482da8(0x21b)+_0x40e19c},'data':{'prompt':_0x220c15}};try{const _0x203a31=await(0x0,axios_1['default'])(_0xd0d79e);return common_1['Logger'][_0x482da8(0x220)](_0x482da8(0x247)+JSON[_0x482da8(0x2b9)](_0x203a31[_0x482da8(0x2cd)],null,0x2),_0x482da8(0x2a3)),_0x203a31['data'][_0x482da8(0x1eb)];}catch(_0x43f4b6){common_1[_0x482da8(0x279)][_0x482da8(0x1d7)](_0x482da8(0x258),_0x43f4b6);}}async[_0x3f8ccc(0x1fa)](_0x219c20,_0x3b770d,_0x37a5d4,_0x126b6b,_0x4addaf){const _0x37417e=_0x3f8ccc;if((_0x3b770d===null||_0x3b770d===void 0x0?void 0x0:_0x3b770d[_0x37417e(0x267)])===_0x37417e(0x228)){let _0x100648;if(_0x37a5d4===0x1)try{_0x100648=await this['openAIChatService'][_0x37417e(0x2c1)](_0x37417e(0x23e)+_0x126b6b+_0x37417e(0x289)),_0x100648['length']>0xf&&(_0x100648=_0x100648[_0x37417e(0x2bd)](0x0,0xf));}catch(_0x3828dc){common_1[_0x37417e(0x279)]['error'](_0x37417e(0x2c9)+_0x3828dc),_0x100648=_0x126b6b[_0x37417e(0x2bd)](0x0,0xa);}else _0x100648=_0x37417e(0x216);this[_0x37417e(0x1e4)][_0x37417e(0x2ae)]({'groupId':_0x219c20,'title':_0x100648,'isSticky':![],'config':'','fileUrl':''},_0x4addaf)[_0x37417e(0x237)](()=>common_1['Logger']['log'](_0x37417e(0x254)+_0x100648,_0x37417e(0x273)))[_0x37417e(0x1e7)](_0x43ee4b=>common_1[_0x37417e(0x279)][_0x37417e(0x1d7)](_0x37417e(0x20f)+_0x43ee4b));}}async[_0x3f8ccc(0x29a)](_0x122b4e,_0x117337,_0x32fd31){const _0x2b3238=_0x3f8ccc;let {systemMessage:systemMessage='',fileInfo:_0x3ee74f,groupId:_0x132a5d,maxRounds:maxRounds=0x5,maxModelTokens:maxModelTokens=0x1f40,isFileUpload:isFileUpload=0x0,isConvertToBase64:_0x503528}=_0x117337;systemMessage['length']>maxModelTokens&&(common_1['Logger'][_0x2b3238(0x220)]('系统消息超过最大长度，将被截断',_0x2b3238(0x273)),systemMessage=systemMessage[_0x2b3238(0x2bd)](0x0,maxModelTokens));let _0x595d1c=[];systemMessage&&_0x595d1c[_0x2b3238(0x2a0)]({'role':_0x2b3238(0x1fd),'content':systemMessage});if(_0x132a5d){const _0x1207e2=await _0x32fd31[_0x2b3238(0x274)](_0x132a5d,maxRounds);let _0x39f370=null;for(const _0x21078e of _0x1207e2){try{let _0x427aa9;if((isFileUpload===0x2||isFileUpload===0x3)&&_0x21078e[_0x2b3238(0x2dd)]&&_0x21078e['role']==='user'){const _0x550b29=await Promise['all'](_0x21078e[_0x2b3238(0x2dd)][_0x2b3238(0x2c3)](',')[_0x2b3238(0x213)](async _0x3a6851=>({'type':_0x2b3238(0x234),'image_url':{'url':_0x503528==='1'?await this[_0x2b3238(0x2ce)](_0x3a6851[_0x2b3238(0x266)]()):_0x3a6851[_0x2b3238(0x266)]()}})));_0x427aa9=[{'type':_0x2b3238(0x1eb),'text':_0x21078e['text']},..._0x550b29];}else isFileUpload===0x1&&_0x21078e[_0x2b3238(0x2dd)]&&_0x21078e['role']==='user'?_0x427aa9=_0x21078e[_0x2b3238(0x2dd)]+'\x0a'+_0x21078e[_0x2b3238(0x1eb)]:_0x427aa9=_0x21078e[_0x2b3238(0x1eb)];if(_0x21078e['role']===_0x2b3238(0x255))_0x39f370={'role':_0x21078e[_0x2b3238(0x209)],'content':_0x427aa9};else{if(_0x21078e[_0x2b3238(0x209)]===_0x2b3238(0x282)){const _0xcd9e18=Array[_0x2b3238(0x256)](_0x427aa9)?JSON[_0x2b3238(0x2b9)](_0x427aa9):_0x427aa9;_0x39f370&&_0xcd9e18[_0x2b3238(0x266)]()!==''&&(_0x595d1c['push'](_0x39f370),_0x595d1c[_0x2b3238(0x2a0)]({'role':_0x21078e[_0x2b3238(0x209)],'content':_0x427aa9}),_0x39f370=null);}}}catch(_0x3ace8d){common_1['Logger'][_0x2b3238(0x1d7)](_0x2b3238(0x238),_0x3ace8d,'记录:',JSON[_0x2b3238(0x2b9)](_0x21078e,null,0x2));}}}let _0x1dc26e;if((isFileUpload===0x2||isFileUpload===0x3)&&_0x3ee74f){const _0x50da7b=await Promise['all'](_0x3ee74f['split'](',')[_0x2b3238(0x213)](async _0x4dd907=>({'type':_0x2b3238(0x234),'image_url':{'url':_0x503528==='1'?await this['convertUrlToBase64'](_0x4dd907[_0x2b3238(0x266)]()):_0x4dd907[_0x2b3238(0x266)]()}})));_0x1dc26e=[{'type':_0x2b3238(0x1eb),'text':_0x122b4e},..._0x50da7b];}else isFileUpload===0x1&&_0x3ee74f?_0x1dc26e=_0x3ee74f+'\x0a'+_0x122b4e:_0x1dc26e=_0x122b4e;_0x595d1c[_0x2b3238(0x2a0)]({'role':_0x2b3238(0x255),'content':_0x1dc26e});let _0x1d8e8d=await(0x0,utils_1[_0x2b3238(0x25c)])(_0x595d1c),_0x2f107d;maxModelTokens<0x1f40?_0x2f107d=0xfa0:_0x2f107d=maxModelTokens-0xfa0;while(_0x1d8e8d>_0x2f107d){if(_0x595d1c['length']===0x2&&_0x595d1c[0x0][_0x2b3238(0x209)]===_0x2b3238(0x1fd)&&_0x595d1c[0x1][_0x2b3238(0x209)]===_0x2b3238(0x255))break;let _0x6cb54a=![];for(let _0x4f6f63=0x0;_0x4f6f63<_0x595d1c[_0x2b3238(0x1d8)];_0x4f6f63++){if(_0x595d1c[_0x4f6f63][_0x2b3238(0x209)]!==_0x2b3238(0x1fd)&&_0x595d1c[_0x4f6f63+0x1]&&_0x595d1c[_0x4f6f63+0x1][_0x2b3238(0x209)]==='assistant'){_0x595d1c[_0x2b3238(0x294)](_0x4f6f63,0x2),_0x6cb54a=!![];break;}}if(!_0x6cb54a)for(let _0x5e0d9a=0x0;_0x5e0d9a<_0x595d1c['length'];_0x5e0d9a++){if(_0x595d1c[_0x5e0d9a][_0x2b3238(0x209)]==='user'){_0x595d1c[_0x2b3238(0x294)](_0x5e0d9a,0x1);break;}}_0x1d8e8d=await(0x0,utils_1[_0x2b3238(0x25c)])(_0x595d1c);if(_0x595d1c['length']<=0x2)break;}return{'messagesHistory':_0x595d1c,'round':_0x595d1c['length']};}async[_0x3f8ccc(0x2ce)](_0x476852){const _0x42ee40=_0x3f8ccc;try{console[_0x42ee40(0x220)](_0x42ee40(0x22b)+_0x476852);const _0x5a99f7=await axios_1['default']['get'](_0x476852,{'responseType':_0x42ee40(0x20b)}),_0x4c07f6=Buffer[_0x42ee40(0x246)](_0x5a99f7[_0x42ee40(0x2cd)],_0x42ee40(0x29e));console[_0x42ee40(0x220)]('成功获取图片，正在转换为Base64:\x20'+_0x476852);const _0x186c2c='data:'+_0x5a99f7['headers'][_0x42ee40(0x2bc)]+';base64,'+_0x4c07f6[_0x42ee40(0x243)]('base64');return console[_0x42ee40(0x220)](_0x42ee40(0x229)+_0x476852),_0x186c2c;}catch(_0x4001b7){return console[_0x42ee40(0x1d7)](_0x42ee40(0x22f),_0x4001b7),console[_0x42ee40(0x2d2)](_0x42ee40(0x287)+_0x476852),_0x476852;}}async[_0x3f8ccc(0x20a)](_0x4c8ed1,_0x1c0cc3,_0x372bb8){const _0x5baa60=_0x3f8ccc,{chatId:_0x3054bc,prompt:_0x5af988}=_0x4c8ed1,_0x5e5ea1=await this[_0x5baa60(0x21d)][_0x5baa60(0x212)](_0x5baa60(0x275)),{openaiTimeout:_0x4cca26,openaiBaseUrl:_0x9a5aa6,openaiBaseKey:_0x4538fb,openaiVoice:_0x42a2d8}=await this['globalConfigService'][_0x5baa60(0x2e1)]([_0x5baa60(0x2cb),_0x5baa60(0x2a5),_0x5baa60(0x211),'openaiVoice']),{key:_0x2f6e7a,proxyUrl:_0x566c3a,deduct:_0x29e372,deductType:_0x4fa160,timeout:_0x5753dd}=_0x5e5ea1,_0x5c3ecb=_0x2f6e7a||_0x4538fb,_0x452d7c=(0x0,utils_1[_0x5baa60(0x27f)])(_0x566c3a||_0x9a5aa6),_0x291c5a=(_0x5753dd||_0x4cca26)*0x3e8;await this[_0x5baa60(0x2ac)]['validateBalance'](_0x1c0cc3,_0x4fa160,_0x29e372),common_1['Logger'][_0x5baa60(0x220)](_0x5baa60(0x2e0),_0x5af988,_0x5baa60(0x2c4));const _0x582b7b={'method':_0x5baa60(0x208),'url':_0x452d7c+_0x5baa60(0x270),'headers':{'Content-Type':_0x5baa60(0x269),'Authorization':'Bearer\x20'+_0x5c3ecb},'responseType':_0x5baa60(0x20b),'timeout':_0x291c5a,'data':{'model':_0x5baa60(0x275),'input':_0x5af988,'voice':_0x42a2d8||_0x5baa60(0x2d8)}};try{const _0x1a87a7=await(0x0,axios_1[_0x5baa60(0x2bb)])(_0x582b7b);common_1[_0x5baa60(0x279)][_0x5baa60(0x220)](_0x5baa60(0x2cf),_0x5baa60(0x2c4));const _0x2336e3=Buffer[_0x5baa60(0x246)](_0x1a87a7[_0x5baa60(0x2cd)]),_0x559d43=new Date(),_0x5a6f2a=_0x559d43[_0x5baa60(0x22e)](),_0x5d043d=String(_0x559d43[_0x5baa60(0x24b)]()+0x1)[_0x5baa60(0x2db)](0x2,'0'),_0x17d423=String(_0x559d43['getDate']())[_0x5baa60(0x2db)](0x2,'0'),_0x29508f=''+_0x5a6f2a+_0x5d043d+'/'+_0x17d423,_0x419889=await this[_0x5baa60(0x27e)][_0x5baa60(0x215)]({'buffer':_0x2336e3,'mimetype':_0x5baa60(0x24e)},_0x5baa60(0x242)+_0x29508f);await Promise['all']([this[_0x5baa60(0x2b3)][_0x5baa60(0x2d0)](_0x3054bc,{'ttsUrl':_0x419889}),this[_0x5baa60(0x2ac)][_0x5baa60(0x27c)](_0x1c0cc3[_0x5baa60(0x255)]['id'],_0x4fa160,_0x29e372)]),_0x372bb8['status'](0xc8)[_0x5baa60(0x1f4)]({'ttsUrl':_0x419889});}catch(_0x3986d3){common_1[_0x5baa60(0x279)][_0x5baa60(0x1d7)](_0x5baa60(0x2ad),_0x3986d3,'TTSService'),_0x372bb8[_0x5baa60(0x205)](0x1f4)[_0x5baa60(0x1f4)]({'error':'Failed\x20to\x20process\x20TTS\x20request'});}}};function _0x5c4e(){const _0x1b0e30=['转换URL为Base64时发生错误:','isGeneratePromptReference','固定模型、使用应用预设:\x20','usePlugin','发生错误:','image_url','生成失败','includes','then','处理历史记录时出错:','aiPPT','autoreplyService','../chatLog/chatLog.service','\x20模型:\x20','openAIDrawService','根据用户提问{','69eGpipQ','../plugin/plugin.entity','使用全局预设:\x20','audio/openai/','toString','configEntity','发生未知错误，请稍后再试','from','插件调用成功\x20返回结果:\x20','你当前使用的应用已被下架、请删除当前对话开启新的对话吧！','queryUserBalance','绘制中','getMonth','axios','提交成功，视频生成中','audio/mpeg','appEntity','openaiTemperature','PluginEntity','../globalConfig/globalConfig.service','modelInfo','更新标题名称为:\x20','user','isArray','pluginKey','error:\x20','gpt-4-gizmo-','suno-music','chat-error\x20<----------------------------------------->','getTokenCount','flux','../badWords/badWords.service','11509632RGmtSt','../ai/midjourneyDraw.service','gpts','checkBadWords','1477210PYLRSG','join','saveUseLog','trim','title','StableDiffusionService','application/json','saveChatLog','midjourneyDraw','DrawService','../ai/lumaVideo.service','../ai/openaiDraw.service','setHeader','/v1/audio/speech','getGroupInfoFromId','pluginUrl','ChatService','chatHistory','tts-1','GlobalConfigService','任务提交失败，不执行扣费','AppEntity','Logger','config','../../common/utils','deductFromBalance','fluxDrawService','uploadService','formatUrl','getOwnPropertyDescriptor','模型切换错误，请检查全局模型配置！','assistant','\x20消耗token:\x20','AiPptService','55492XLezRK','LumaVideoService','返回原始链接:\x20','luma-video','}，给这个对话取一个名字，不超过10个字','close','HttpException','UploadService','badWordsService','215sjmjkw','Repository','ConfigEntity','isSensitiveWordFilter','getClientIp','使用插件预设:\x20','splice','dalleDraw','replace','pluginEntity','errMsg','Injectable','buildMessageFromParentMessageId','openaiBaseModel','object','dall-e-3','binary','globalConfigService','push','../ai/aiPPT','forEach','PluginService','pluginImg','openaiBaseUrl','5947050NHZSDZ','配置解析错误！','\x20回复出错，本次不扣除积分','@nestjs/typeorm','checkModelLimits','}以及\x20AI\x20的回答{','userBalanceService','TTS\x20请求或上传过程失败:','update','stable-diffusion','../upload/upload.service','match','ceil','chatLogService','Translate\x20any\x20given\x20phrase\x20from\x20any\x20language\x20into\x20English.\x20For\x20instance,\x20when\x20I\x20input\x20\x27{可爱的熊猫}\x27,\x20you\x20should\x20output\x20\x27{cute\x20panda}\x27,\x20with\x20no\x20period\x20at\x20the\x20end.','100%','OpenAIChatService','../models/models.service','HttpStatus','stringify','__esModule','default','content-type','slice','validateBalance','UPSCALE','sunoService','chatFree','OpenAIDrawService','split','TTSService','assign','isSystemPlugin','118334YCFsoK','提交成功，歌曲生成中','调用\x20chatFree\x20出错:\x20','ChatGroupService','openaiTimeout','../userBalance/userBalance.service','data','convertUrlToBase64','TTS\x20请求获取成功','updateChatLog','parameters','warn','findOne','../user/user.service','422478amRjvf','../app/app.entity','userBalance','onyx','openAIChatService','__param','padStart','userService','fileInfo','cog-video','cogVideo','开始\x20TTS\x20请求:','getConfigs','aiPptService','error','length','https://api.openai.com','../autoreply/autoreply.service','BAD_REQUEST','parse','1\x20小时内对话次数过多，请切换模型或稍后再试！','application/octet-stream;\x20charset=utf-8','MidjourneyService','write','处理请求时发生错误','\x20模型名称:\x20','stableDiffusionService','chatGroupService','用户ID:\x20','@nestjs/common','catch','modelName','FluxDrawService','openAIChat','text','debug','插件返回结果:\x20','typeorm','__metadata','../globalConfig/config.entity','ModelsService','checkUserStatus','lumaVideoService','send','ai-ppt','model','abort','checkAutoReply','midjourneyService','updateChatTitle','开始生成PPT','UserService','system',',\x20消耗积分：\x20','../chatGroup/chatGroup.service','function','toISOString','fluxDraw','isConvertToBase64','midjourney','status','checkUserCertification','7070497ocsuCU','POST','role','ttsProcess','arraybuffer','以下是我提供给你的知识库：【','end','UserBalanceService','更新对话组标题失败:\x20','content','openaiBaseKey','getCurrentModelKeyInfo','map','ChatLogService','uploadFile','创意\x20AI','使用应用预设:\x20','AutoreplyService','Content-type','】，在回答问题之前，先检索知识库内有没有相关的内容，尽量使用知识库中获取到的信息来回答我的问题，以知识库中的为准。','Bearer\x20','54tVslLD','modelsService','preset','chatProcess','log','../ai/cogVideo.service','插件调用错误:\x20','SunoService','metadata','__decorate','defineProperty','生成中','新对话','成功转换URL为Base64:\x20','../ai/suno.service','正在尝试转换URL为Base64:\x20','CogVideoService','answer','getFullYear'];_0x5c4e=function(){return _0x1b0e30;};return _0x5c4e();}ChatService=__decorate([(0x0,common_1[_0x3f8ccc(0x299)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(config_entity_1[_0x3f8ccc(0x290)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(app_entity_1[_0x3f8ccc(0x278)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(plugin_entity_1[_0x3f8ccc(0x251)])),__metadata('design:paramtypes',[typeorm_2['Repository'],typeorm_2[_0x3f8ccc(0x28f)],typeorm_2[_0x3f8ccc(0x28f)],suno_service_1[_0x3f8ccc(0x223)],openaiChat_service_1[_0x3f8ccc(0x2b6)],chatLog_service_1[_0x3f8ccc(0x214)],midjourneyDraw_service_1[_0x3f8ccc(0x1df)],stableDiffusion_service_1[_0x3f8ccc(0x268)],userBalance_service_1[_0x3f8ccc(0x20e)],user_service_1[_0x3f8ccc(0x1fc)],upload_service_1[_0x3f8ccc(0x28c)],badWords_service_1['BadWordsService'],autoreply_service_1[_0x3f8ccc(0x218)],globalConfig_service_1[_0x3f8ccc(0x276)],chatGroup_service_1[_0x3f8ccc(0x2ca)],models_service_1[_0x3f8ccc(0x1f1)],openaiDraw_service_1[_0x3f8ccc(0x2c2)],lumaVideo_service_1[_0x3f8ccc(0x286)],cogVideo_service_1[_0x3f8ccc(0x22c)],fluxDraw_service_1[_0x3f8ccc(0x1e9)],aiPPT_1[_0x3f8ccc(0x284)]])],ChatService),exports[_0x3f8ccc(0x273)]=ChatService;