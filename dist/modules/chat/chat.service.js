'use strict';const _0x485f5f=_0x5c21;(function(_0x87c8d2,_0x475abe){const _0x58c601=_0x5c21,_0x50b646=_0x87c8d2();while(!![]){try{const _0x323659=parseInt(_0x58c601(0xff))/0x1+parseInt(_0x58c601(0x113))/0x2+parseInt(_0x58c601(0xe4))/0x3+-parseInt(_0x58c601(0x100))/0x4*(-parseInt(_0x58c601(0x159))/0x5)+parseInt(_0x58c601(0x17d))/0x6*(-parseInt(_0x58c601(0x1b0))/0x7)+parseInt(_0x58c601(0xc6))/0x8+-parseInt(_0x58c601(0x150))/0x9*(parseInt(_0x58c601(0xcd))/0xa);if(_0x323659===_0x475abe)break;else _0x50b646['push'](_0x50b646['shift']());}catch(_0x53b53d){_0x50b646['push'](_0x50b646['shift']());}}}(_0x309e,0x6403e));function _0x5c21(_0x40d0a0,_0x2dc520){const _0x309e0d=_0x309e();return _0x5c21=function(_0x5c2124,_0x971a3){_0x5c2124=_0x5c2124-0xc0;let _0x362ab1=_0x309e0d[_0x5c2124];return _0x362ab1;},_0x5c21(_0x40d0a0,_0x2dc520);}var __decorate=this&&this['__decorate']||function(_0x35c6fd,_0x55b5a7,_0x292a3b,_0x590700){const _0x524f45=_0x5c21;var _0x8449e1=arguments[_0x524f45(0x15d)],_0x3a3739=_0x8449e1<0x3?_0x55b5a7:_0x590700===null?_0x590700=Object[_0x524f45(0x16d)](_0x55b5a7,_0x292a3b):_0x590700,_0x31629d;if(typeof Reflect===_0x524f45(0xce)&&typeof Reflect[_0x524f45(0x174)]===_0x524f45(0x19c))_0x3a3739=Reflect[_0x524f45(0x174)](_0x35c6fd,_0x55b5a7,_0x292a3b,_0x590700);else{for(var _0x221aef=_0x35c6fd[_0x524f45(0x15d)]-0x1;_0x221aef>=0x0;_0x221aef--)if(_0x31629d=_0x35c6fd[_0x221aef])_0x3a3739=(_0x8449e1<0x3?_0x31629d(_0x3a3739):_0x8449e1>0x3?_0x31629d(_0x55b5a7,_0x292a3b,_0x3a3739):_0x31629d(_0x55b5a7,_0x292a3b))||_0x3a3739;}return _0x8449e1>0x3&&_0x3a3739&&Object[_0x524f45(0x170)](_0x55b5a7,_0x292a3b,_0x3a3739),_0x3a3739;},__metadata=this&&this[_0x485f5f(0x1b1)]||function(_0x5e0ed4,_0x3e9393){const _0x1c2443=_0x485f5f;if(typeof Reflect===_0x1c2443(0xce)&&typeof Reflect[_0x1c2443(0x181)]===_0x1c2443(0x19c))return Reflect[_0x1c2443(0x181)](_0x5e0ed4,_0x3e9393);},__param=this&&this[_0x485f5f(0xda)]||function(_0x2ca358,_0x2b158a){return function(_0x532d38,_0x56829f){_0x2b158a(_0x532d38,_0x56829f,_0x2ca358);};};Object[_0x485f5f(0x170)](exports,_0x485f5f(0x18e),{'value':!![]}),exports[_0x485f5f(0x12d)]=void 0x0;const utils_1=require('../../common/utils'),common_1=require(_0x485f5f(0x1a8)),typeorm_1=require(_0x485f5f(0x14d)),axios_1=require(_0x485f5f(0x158)),typeorm_2=require(_0x485f5f(0x119)),aiPPT_1=require('../ai/aiPPT'),cogVideo_service_1=require('../ai/cogVideo.service'),fluxDraw_service_1=require(_0x485f5f(0x102)),lumaVideo_service_1=require('../ai/lumaVideo.service'),midjourneyDraw_service_1=require('../ai/midjourneyDraw.service'),openaiChat_service_1=require(_0x485f5f(0xc9)),openaiDraw_service_1=require('../ai/openaiDraw.service'),stableDiffusion_service_1=require(_0x485f5f(0x17b)),suno_service_1=require('../ai/suno.service'),app_entity_1=require(_0x485f5f(0xf6)),autoreply_service_1=require(_0x485f5f(0x1a3)),badWords_service_1=require(_0x485f5f(0xeb)),chatGroup_service_1=require(_0x485f5f(0x18d)),chatLog_service_1=require(_0x485f5f(0x161)),config_entity_1=require('../globalConfig/config.entity'),globalConfig_service_1=require(_0x485f5f(0x188)),models_service_1=require(_0x485f5f(0xf7)),plugin_entity_1=require(_0x485f5f(0x1be)),upload_service_1=require(_0x485f5f(0x15b)),user_service_1=require(_0x485f5f(0xe7)),userBalance_service_1=require(_0x485f5f(0x11d));function _0x309e(){const _0x448865=['插件调用错误:\x20','openAIChatService','../badWords/badWords.service','使用插件预设:\x20','design:paramtypes','userBalance','配置解析错误！','SunoService','BadWordsService','成功转换URL为Base64:\x20','error','preset','绘图失败','../app/app.entity','../models/models.service','checkUserCertification','write','autoreplyService','\x20模型:\x20','IMAGINE','isSystemPlugin','update','464471ETqFKN','75008uweOXz','DrawService','../ai/fluxDraw.service','map','midjourneyService','lumaVideoService','tts-1','usePlugin','任务提交失败，不执行扣费','插件返回结果:\x20','isMjTranslate','openAIDrawService','uploadService','aiPptService','OpenAIDrawService','formatUrl','提交成功，歌曲生成中','创意\x20AI','audio/mpeg','577162PSYknC','1\x20小时内对话次数过多，请切换模型或稍后再试！','userBalanceService','saveChatLog','forEach','固定模型、使用应用预设:\x20','typeorm','返回原始链接:\x20','sunoService','fileInfo','../userBalance/userBalance.service','openaiBaseKey','AppEntity','assistant','midjourneyDraw','deductFromBalance','Bearer\x20','uploadFile','pluginEntity','Repository','}以及\x20AI\x20的回答{','Translate\x20any\x20given\x20phrase\x20from\x20any\x20language\x20into\x20English.\x20For\x20instance,\x20when\x20I\x20input\x20\x27{可爱的熊猫}\x27,\x20you\x20should\x20output\x20\x27{cute\x20panda}\x27,\x20with\x20no\x20period\x20at\x20the\x20end.','chatHistory','FluxDrawService','Content-type','errMsg','ChatService','gpts','https://api.openai.com','\x20回复出错，本次不扣除积分','调用\x20chatFree\x20出错:\x20',';base64,','UserService','openaiTimeout','debug','ModelsService','splice','正在尝试转换URL为Base64:\x20','stableDiffusionService','chatLogService','以下是我提供给你的知识库：【','用户ID:\x20','openaiBaseUrl','getFullYear','onyx','configEntity','text','modelInfo','BAD_REQUEST','saveUseLog','content','parameters','base64','isGeneratePromptReference','ChatLogService','cogVideoService','生成中','luma-video','@nestjs/typeorm','\x0a\x20Current\x20date:\x20','}，给这个对话取一个名字，不超过10个字','765GsSkhG','开始生成PPT','openAIChat','assign','toISOString','midjourney','checkModelLimits','updateTime','axios','35gVyCKK','ConfigEntity','../upload/upload.service','send','length','getConfigs','suno-music','提交成功，视频生成中','../chatLog/chatLog.service','InjectRepository','未找到当前模型key，切换至全局模型','error:\x20','ChatGroupService','\x20模型名称:\x20','getGroupInfoFromId','getMonth','记录:','LumaVideoService','UPSCALE','updateChatLog','getOwnPropertyDescriptor','arraybuffer',',\x20消耗积分：\x20','defineProperty','abort','userService','default','decorate','TTS\x20请求获取成功','then','data','getTokenCount','处理请求时发生错误','suno','../ai/stableDiffusion.service','生成失败','16074fGrjQN','fluxDraw','/v1/audio/speech','AiPptService','metadata','chatFree','trim','status','close','repeat','HttpException','../globalConfig/globalConfig.service','checkUserStatus','includes','flux','cogVideo','../chatGroup/chatGroup.service','__esModule','GlobalConfigService','你当前使用的应用已被下架、请删除当前对话开启新的对话吧！','ai-ppt','split','成功获取图片，正在转换为Base64:\x20','新对话','isSensitiveWordFilter','isAIReplyEnabled','image_url','user','PluginService','PluginEntity','answer','function','push','parse','checkBadWords','UserBalanceService','findOne','/plugins/','../autoreply/autoreply.service','buildMessageFromParentMessageId','title','根据用户提问{','isArray','@nestjs/common','CogVideoService','发生未知错误，请稍后再试','log','HttpStatus','】，在回答问题之前，先检索知识库内有没有相关的内容，尽量使用知识库中获取到的信息来回答我的问题，以知识库中的为准。','replace','join','497hscorc','__metadata','cog-video','modelName','toString','badWordsService','TTSService','100%','warn','lumaVideo','chatGroupService','system','POST','stringify','../plugin/plugin.entity','更新对话组标题失败:\x20','getCurrentModelKeyInfo','end','插件调用成功\x20返回结果:\x20','model','padStart','ttsProcess','convertUrlToBase64','application/json','UploadService','858768OocLcC','appEntity','Injectable','../ai/openaiChat.service','Failed\x20to\x20process\x20TTS\x20request','modelsService','openaiBaseModel','102540ZmzKcH','object','globalConfigService','OpenAIChatService','fluxDrawService','AutoreplyService','getDate','绘制中','stable-diffusion','\x20消耗token:\x20','使用文件解析:\x20','slice','dalleDraw','__param','all','role','queryUserBalance','content-type','aiPPT','from','config','ceil','validateBalance','1439397JoNpvh','checkAutoReply','Logger','../user/user.service','application/octet-stream;\x20charset=utf-8'];_0x309e=function(){return _0x448865;};return _0x309e();}let ChatService=class ChatService{constructor(_0x588697,_0x3a5abc,_0x1f3ebb,_0x16f7dc,_0x377fd5,_0x43abfc,_0x44d3da,_0x20529b,_0x472bee,_0x2a7074,_0x2dad81,_0x20ea26,_0x50cf77,_0x57cead,_0x44659b,_0x5eced5,_0x30ca4f,_0x4bd468,_0x1202fd,_0x2a20c9,_0xd8c46a){const _0x373203=_0x485f5f;this[_0x373203(0x140)]=_0x588697,this[_0x373203(0xc7)]=_0x3a5abc,this[_0x373203(0x125)]=_0x1f3ebb,this['sunoService']=_0x16f7dc,this[_0x373203(0xea)]=_0x377fd5,this['chatLogService']=_0x43abfc,this[_0x373203(0x104)]=_0x44d3da,this[_0x373203(0x139)]=_0x20529b,this[_0x373203(0x115)]=_0x472bee,this[_0x373203(0x172)]=_0x2a7074,this[_0x373203(0x10c)]=_0x2dad81,this[_0x373203(0x1b5)]=_0x20ea26,this[_0x373203(0xfa)]=_0x50cf77,this[_0x373203(0xcf)]=_0x57cead,this[_0x373203(0x1ba)]=_0x44659b,this['modelsService']=_0x5eced5,this['openAIDrawService']=_0x30ca4f,this['lumaVideoService']=_0x4bd468,this['cogVideoService']=_0x1202fd,this[_0x373203(0xd1)]=_0x2a20c9,this[_0x373203(0x10d)]=_0xd8c46a;}async['chatProcess'](_0x190f96,_0x4b68b6,_0x255925){const _0x287668=_0x485f5f;await this['userBalanceService'][_0x287668(0xf8)](_0x4b68b6[_0x287668(0x198)]['id']);const {options:options={},usingPluginId:_0x10b7da,appId:appId=null,specialModel:_0x5d3853,prompt:_0x270837,fileInfo:_0x4a0eb1,extraParam:_0x501d39,model:_0x2b9cf1,drawId:_0x293f88,customId:_0x174d01,action:_0xa399f7,modelName:_0x398f00,modelAvatar:_0x1ffa1d}=_0x190f96;let _0x48fac8;if(_0x5d3853)_0x48fac8=await this[_0x287668(0xc7)]['findOne']({'where':{'des':_0x5d3853,'isSystemReserved':!![]}});else{if(appId){_0x48fac8=await this['appEntity'][_0x287668(0x1a1)]({'where':{'id':appId,'status':(0x0,typeorm_2['In'])([0x1,0x3,0x4,0x5])}});if(!_0x48fac8)throw new common_1[(_0x287668(0x187))](_0x287668(0x190),common_1[_0x287668(0x1ac)][_0x287668(0x143)]);}}const {groupId:_0x4cebe2,fileParsing:_0x339bc3}=options,{openaiTimeout:_0x6811e3,openaiBaseUrl:_0x1ed764,openaiBaseKey:_0x299594,systemPreMessage:_0x38050e,isMjTranslate:_0x791d96,mjTranslatePrompt:_0x4f798b,openaiTemperature:_0x4f28f2,openaiBaseModel:_0x2817ea,isGeneratePromptReference:_0x48c71d,isConvertToBase64:_0x44916e,isSensitiveWordFilter:_0x5e7226}=await this['globalConfigService'][_0x287668(0x15e)]([_0x287668(0x134),'openaiBaseUrl',_0x287668(0x11e),'systemPreMessage',_0x287668(0x10a),'mjTranslatePrompt','openaiTemperature',_0x287668(0xcc),_0x287668(0x148),'isConvertToBase64',_0x287668(0x195)]);await this[_0x287668(0x172)][_0x287668(0x189)](_0x4b68b6[_0x287668(0x198)]),_0x255925&&_0x255925['setHeader'](_0x287668(0x12b),_0x287668(0xe8));if(_0x5e7226==='1'){const _0x4ced0d=await this[_0x287668(0x1b5)][_0x287668(0x19f)](_0x270837,_0x4b68b6[_0x287668(0x198)]['id']);if(_0x4ced0d[_0x287668(0x15d)]>0x0){const _0x15c721='您提交的信息中包含违规的内容，我们已对您的账户进行标记，请合规使用！';throw new common_1['HttpException'](_0x15c721,common_1[_0x287668(0x1ac)][_0x287668(0x143)]);}}const _0x2420f6=await this[_0x287668(0xfa)][_0x287668(0xe5)](_0x270837);let _0x57209d=null,_0x1bfa0c='',_0x10e030='';_0x255925&&_0x255925[_0x287668(0x184)](0xc8);let _0xf5cc00=null;const _0xe70bda=(0x0,utils_1['getClientIp'])(_0x4b68b6);let _0x3b8bbf,_0x4762a7='',_0x1a4c79;_0x10b7da&&(_0x1a4c79=await this[_0x287668(0x125)][_0x287668(0x1a1)]({'where':{'id':_0x10b7da}}));if(_0x48fac8){const {isGPTs:_0x44658d,gizmoID:_0x356eeb,name:_0x531bd3,isFixedModel:_0xd967e7,appModel:_0x2dc512,coverImg:_0x4c652b}=_0x48fac8;_0x4762a7=_0x4c652b,_0x1bfa0c=_0x531bd3;if(_0x44658d)_0x57209d=await this[_0x287668(0xcb)][_0x287668(0x1c0)](_0x287668(0x12e)),_0x57209d[_0x287668(0xc0)]='gpt-4-gizmo-'+_0x356eeb;else!_0x44658d&&_0xd967e7&&_0x2dc512?(_0x48fac8['preset']&&(_0x10e030=_0x48fac8[_0x287668(0xf4)]),_0x57209d=await this[_0x287668(0xcb)][_0x287668(0x1c0)](_0x2dc512),_0x57209d[_0x287668(0xc0)]=_0x2dc512,_0x339bc3&&(_0x10e030=_0x10e030+_0x287668(0x13b)+_0x339bc3+_0x287668(0x1ad)),common_1[_0x287668(0xe6)][_0x287668(0x1ab)](_0x287668(0x118)+_0x10e030,_0x287668(0x12d))):(_0x48fac8['preset']&&(_0x10e030=_0x48fac8[_0x287668(0xf4)]),_0x57209d=await this[_0x287668(0xcb)]['getCurrentModelKeyInfo'](_0x2b9cf1),_0x339bc3&&(_0x10e030=_0x10e030+_0x287668(0x13b)+_0x339bc3+_0x287668(0x1ad)),common_1['Logger']['log']('使用应用预设:\x20'+_0x10e030,_0x287668(0x12d)));}else{const _0xf6e083=await this[_0x287668(0x1ba)]['getGroupInfoFromId'](_0x4cebe2);if(_0x1a4c79&&_0x1a4c79[_0x287668(0xfd)]===0x0){let _0x50d33f='';try{_0x50d33f=await this[_0x287668(0x107)](_0x270837,_0x1a4c79['parameters']),common_1[_0x287668(0xe6)][_0x287668(0x1ab)](_0x287668(0x109)+_0x50d33f,_0x287668(0x12d));}catch(_0x3925ba){_0x50d33f=_0x270837,common_1[_0x287668(0xe6)][_0x287668(0xf3)](_0x287668(0xe9)+_0x3925ba);}_0x10e030=_0x50d33f,_0x57209d=await this[_0x287668(0xcb)][_0x287668(0x1c0)](_0x2b9cf1),common_1[_0x287668(0xe6)][_0x287668(0x1ab)](_0x287668(0xec)+_0x10e030,_0x287668(0x12d));}else{if(_0x339bc3)_0x10e030=_0x287668(0x13b)+_0x339bc3+_0x287668(0x1ad),_0x57209d=await this[_0x287668(0xcb)][_0x287668(0x1c0)](_0x2b9cf1),common_1['Logger']['log'](_0x287668(0xd7)+_0x10e030,'ChatService');else{const _0x571e8d=new Date()[_0x287668(0x154)]()[_0x287668(0x192)]('T')[0x0];_0x10e030=_0x38050e+(_0x287668(0x14e)+_0x571e8d),_0x57209d=await this[_0x287668(0xcb)][_0x287668(0x1c0)](_0x2b9cf1),common_1[_0x287668(0xe6)][_0x287668(0x1ab)]('使用全局预设:\x20'+_0x10e030,'ChatService');}}}if(!_0x57209d){common_1[_0x287668(0xe6)][_0x287668(0x135)](_0x287668(0x163),_0x287668(0x12d)),_0x57209d=await this[_0x287668(0xcb)][_0x287668(0x1c0)](_0x2817ea);const _0x1a7f0e=await this[_0x287668(0x1ba)][_0x287668(0x167)](_0x4cebe2);let _0x47e553=_0x1a7f0e[_0x287668(0xe1)];try{const _0x1a7704=JSON[_0x287668(0x19e)](_0x1a7f0e[_0x287668(0xe1)]);_0x1a7704[_0x287668(0x142)]&&(_0x1a7704[_0x287668(0x142)][_0x287668(0x1b3)]=_0x57209d['modelName'],_0x1a7704[_0x287668(0x142)][_0x287668(0xc0)]=_0x57209d[_0x287668(0xc0)],_0x47e553=JSON['stringify'](_0x1a7704));}catch(_0x313523){common_1[_0x287668(0xe6)][_0x287668(0x135)]('模型切换错误，请检查全局模型配置！',_0x287668(0x12d));throw new common_1[(_0x287668(0x187))](_0x287668(0xef),common_1['HttpStatus'][_0x287668(0x143)]);}await this[_0x287668(0x1ba)][_0x287668(0xfe)]({'groupId':_0x4cebe2,'title':_0x1a7f0e['title'],'isSticky':![],'config':_0x47e553,'fileUrl':''},_0x4b68b6);}const {deduct:_0xb13567,isTokenBased:_0x5cb5ac,tokenFeeRatio:_0x46cc98,deductType:_0x270246,key:_0x3f7378,id:_0xbfefcb,maxRounds:_0xb81d29,proxyUrl:_0x130c12,maxModelTokens:_0x324b81,timeout:_0x3bc7a3,model:_0x2203ee,isFileUpload:_0x48b678,keyType:_0x15fa5d}=_0x57209d;if(await this['chatLogService'][_0x287668(0x156)](_0x4b68b6[_0x287668(0x198)],_0x2203ee))throw new common_1[(_0x287668(0x187))](_0x287668(0x114),common_1[_0x287668(0x1ac)]['TOO_MANY_REQUESTS']);if(_0x791d96==='1'&&_0xa399f7===_0x287668(0xfc)&&_0x2b9cf1==='midjourney'){const [_0x95ceeb,_0x5641a3]=_0x270837['split'](/(?= --)/),_0x41460f=/(https?:\/\/[^\s]+)/g,_0x5ca609=_0x95ceeb['match'](_0x41460f)||[];let _0x22e75b=_0x95ceeb[_0x287668(0x1ae)](_0x41460f,'')[_0x287668(0x183)]();const _0x274a1b=await this['openAIChatService'][_0x287668(0x182)](_0x22e75b,_0x4f798b||_0x287668(0x128)),_0x3d2755=[..._0x5ca609,_0x274a1b][_0x287668(0x1af)]('\x20')[_0x287668(0x183)]();_0x3b8bbf=_0x5641a3?''+_0x3d2755+_0x5641a3:_0x3d2755,_0x48b678==='1'&&_0x4a0eb1&&(_0x3b8bbf=_0x4a0eb1+'\x20'+_0x3b8bbf);}else _0x3b8bbf=_0x48b678==='1'&&_0x4a0eb1?_0x4a0eb1+'\x20'+_0x270837:_0x270837;await this[_0x287668(0x115)][_0x287668(0xe3)](_0x4b68b6,_0x270246,_0xb13567);const _0x2cb839=_0x398f00,_0x24505f=(0x0,utils_1[_0x287668(0x10f)])(_0x130c12||_0x1ed764||_0x287668(0x12f)),_0x2b231d=_0x3f7378||_0x299594,_0x61789c=(_0x3bc7a3||_0x6811e3||0x12c)*0x3e8,_0x13166f=Number(_0x4f28f2)||0x1;if(_0x4cebe2){const _0x457b6f=await this[_0x287668(0x1ba)]['getGroupInfoFromId'](_0x4cebe2);this['updateChatTitle'](_0x4cebe2,_0x457b6f,_0x15fa5d,_0x270837,_0x4b68b6),await this['chatGroupService'][_0x287668(0x157)](_0x4cebe2);}const _0x186802=await this[_0x287668(0x13a)][_0x287668(0x116)]({'appId':appId,'curIp':_0xe70bda,'userId':_0x4b68b6[_0x287668(0x198)]['id'],'type':_0x15fa5d?_0x15fa5d:0x1,'prompt':_0x270837,'fileInfo':_0x4a0eb1?_0x4a0eb1:null,'answer':'','promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x2203ee,'modelName':'我','role':_0x287668(0x198),'groupId':_0x4cebe2?_0x4cebe2:null}),_0x5c3732=await this[_0x287668(0x13a)][_0x287668(0x116)]({'appId':appId?appId:null,'action':_0xa399f7?_0xa399f7:null,'curIp':_0xe70bda,'userId':_0x4b68b6[_0x287668(0x198)]['id'],'type':_0x15fa5d?_0x15fa5d:0x1,'prompt':_0x270837,'fileInfo':null,'answer':'','progress':'0%','promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x2203ee,'modelName':_0x2cb839,'role':_0x287668(0x120),'groupId':_0x4cebe2?_0x4cebe2:null,'status':0x2,'modelAvatar':(_0x1a4c79===null||_0x1a4c79===void 0x0?void 0x0:_0x1a4c79['pluginImg'])||_0x4762a7||_0x1ffa1d||'','pluginParam':(_0x1a4c79===null||_0x1a4c79===void 0x0?void 0x0:_0x1a4c79[_0x287668(0x146)])?_0x1a4c79[_0x287668(0x146)]:_0x15fa5d===0x2?_0x2203ee:null}),_0x3585ec=_0x186802['id'],_0x341933=_0x5c3732['id'];if(_0x2420f6['answer']&&_0x255925){if(_0x2420f6[_0x287668(0x196)]===0x0){const _0x14655c=_0x2420f6[_0x287668(0x19b)][_0x287668(0x192)](''),_0x16d905=_0x700951=>{const _0x24e2d5=_0x287668;if(_0x700951<_0x14655c[_0x24e2d5(0x15d)]){const _0x1d117d={'text':_0x14655c[_0x700951]};_0x255925[_0x24e2d5(0xf9)](JSON[_0x24e2d5(0x1bd)](_0x1d117d)+'\x0a'),setTimeout(()=>_0x16d905(_0x700951+0x1),0xa);}else _0x255925['end']();};_0x16d905(0x0),await this[_0x287668(0x13a)][_0x287668(0x16c)](_0x341933,{'answer':_0x2420f6[_0x287668(0x19b)]});return;}else _0x10e030=_0x10e030+_0x2420f6['answer'];}const {messagesHistory:_0x56c087}=await this[_0x287668(0x1a4)](_0x270837,{'groupId':_0x4cebe2,'systemMessage':_0x10e030,'maxModelTokens':_0x324b81,'maxRounds':_0xb81d29,'isConvertToBase64':_0x44916e,'fileInfo':_0x4a0eb1,'model':_0x2203ee,'isFileUpload':_0x48b678},this[_0x287668(0x13a)]);let _0x481160=_0xa399f7!==_0x287668(0x16b)&&_0x2203ee===_0x287668(0x155)?_0xb13567*0x4:_0xb13567;const _0x1cdb05=new AbortController();try{if(_0x255925){_0x255925['on'](_0x287668(0x185),()=>{const _0x173e8f=_0x287668;_0x1cdb05[_0x173e8f(0x171)]();});let _0x198219,_0x3c1829=!![];try{if((_0x2203ee==='dall-e-3'||_0x2203ee==='midjourney'||_0x2203ee===_0x287668(0x191)||_0x2203ee===_0x287668(0x15f)||_0x2203ee===_0x287668(0x14c)||_0x2203ee['includes'](_0x287668(0xd5))||_0x2203ee['includes'](_0x287668(0x1b2))||_0x2203ee[_0x287668(0x18a)](_0x287668(0x18b)))&&_0x15fa5d===0x2){if(_0x2203ee==='dall-e-3')_0x198219=this[_0x287668(0x10b)][_0x287668(0xd9)]({'prompt':_0x270837,'extraParam':_0x501d39,'apiKey':_0x2b231d,'proxyUrl':_0x24505f,'model':_0x2203ee,'timeout':_0x61789c,'modelName':_0x2cb839,'groupId':_0x4cebe2,'onSuccess':async _0x92dcf=>{const _0x231e0b=_0x287668;await this[_0x231e0b(0x13a)][_0x231e0b(0x16c)](_0x341933,{'fileInfo':_0x92dcf===null||_0x92dcf===void 0x0?void 0x0:_0x92dcf['fileInfo'],'answer':(_0x92dcf===null||_0x92dcf===void 0x0?void 0x0:_0x92dcf[_0x231e0b(0x19b)])||_0x270837,'progress':_0x231e0b(0x1b7),'status':_0x92dcf[_0x231e0b(0x184)]});},'onFailure':async _0x2028bc=>{const _0x44672b=_0x287668;await this['chatLogService'][_0x44672b(0x16c)](_0x341933,{'answer':'绘图失败','status':_0x2028bc[_0x44672b(0x184)]});}},this[_0x287668(0x1a4)]),await this['chatLogService']['updateChatLog'](_0x341933,{'answer':'绘制中'});else{if(_0x2203ee===_0x287668(0x191))common_1[_0x287668(0xe6)][_0x287668(0x1ab)](_0x287668(0x151),_0x287668(0x101)),_0x198219=this['aiPptService'][_0x287668(0xdf)]({'usePrompt':_0x3b8bbf,'prompt':_0x270837,'apiKey':_0x2b231d,'proxyUrl':_0x24505f,'model':_0x2203ee,'modelName':_0x2cb839,'drawId':_0x293f88,'customId':_0x174d01,'action':_0xa399f7,'timeout':_0x61789c,'assistantLogId':_0x341933,'extraParam':_0x501d39,'fileInfo':_0x4a0eb1}),await this[_0x287668(0x13a)][_0x287668(0x16c)](_0x341933,{'answer':_0x287668(0x14b)});else{if(_0x2203ee[_0x287668(0x18a)]('flux'))_0x198219=this[_0x287668(0xd1)][_0x287668(0x17e)]({'prompt':_0x270837,'extraParam':_0x501d39,'apiKey':_0x2b231d,'proxyUrl':_0x24505f,'model':_0x2203ee,'timeout':_0x61789c,'modelName':_0x2cb839,'groupId':_0x4cebe2,'onSuccess':async _0x28ca6b=>{const _0x1ab001=_0x287668;await this['chatLogService'][_0x1ab001(0x16c)](_0x341933,{'fileInfo':_0x28ca6b===null||_0x28ca6b===void 0x0?void 0x0:_0x28ca6b[_0x1ab001(0x11c)],'answer':(_0x28ca6b===null||_0x28ca6b===void 0x0?void 0x0:_0x28ca6b[_0x1ab001(0x19b)])||_0x270837,'progress':_0x1ab001(0x1b7),'status':_0x28ca6b[_0x1ab001(0x184)]});},'onFailure':async _0x1ee1c0=>{const _0x246f90=_0x287668;await this[_0x246f90(0x13a)]['updateChatLog'](_0x341933,{'answer':_0x246f90(0xf5),'status':_0x1ee1c0[_0x246f90(0x184)]});}},this[_0x287668(0x1a4)]),await this[_0x287668(0x13a)]['updateChatLog'](_0x341933,{'answer':_0x287668(0xd4)});else{if(_0x2203ee[_0x287668(0x18a)]('suno-music'))_0x198219=this[_0x287668(0x11b)][_0x287668(0x17a)]({'assistantLogId':_0x341933,'apiKey':_0x2b231d,'action':_0xa399f7,'prompt':_0x270837,'timeout':_0x61789c,'proxyUrl':_0x24505f,'taskData':_0x174d01}),await this['chatLogService'][_0x287668(0x16c)](_0x341933,{'answer':_0x287668(0x110)});else{if(_0x2203ee[_0x287668(0x18a)]('luma-video'))_0x198219=this[_0x287668(0x105)][_0x287668(0x1b9)]({'fileInfo':_0x4a0eb1,'extraParam':_0x501d39,'assistantLogId':_0x341933,'apiKey':_0x2b231d,'action':_0xa399f7,'prompt':_0x270837,'model':_0x2203ee,'timeout':_0x61789c,'proxyUrl':_0x24505f,'taskData':_0x174d01,'onGenerate':async _0x267696=>{const _0x3ff099=_0x287668;await this[_0x3ff099(0x13a)]['updateChatLog'](_0x341933,{'fileInfo':_0x267696===null||_0x267696===void 0x0?void 0x0:_0x267696[_0x3ff099(0x11c)],'answer':(_0x267696===null||_0x267696===void 0x0?void 0x0:_0x267696[_0x3ff099(0x19b)])||_0x270837,'status':0x2});},'onSuccess':async _0x51857e=>{const _0xbdce12=_0x287668;await this[_0xbdce12(0x13a)][_0xbdce12(0x16c)](_0x341933,{'fileInfo':_0x51857e===null||_0x51857e===void 0x0?void 0x0:_0x51857e[_0xbdce12(0x11c)],'answer':(_0x51857e===null||_0x51857e===void 0x0?void 0x0:_0x51857e[_0xbdce12(0x19b)])||_0x270837,'progress':'100%','status':0x3});},'onFailure':async _0x53060a=>{const _0x442690=_0x287668;await this[_0x442690(0x13a)][_0x442690(0x16c)](_0x341933,{'answer':_0x53060a[_0x442690(0x12c)],'status':0x4});}}),await this['chatLogService']['updateChatLog'](_0x341933,{'answer':'提交成功，视频生成中'});else{if(_0x2203ee[_0x287668(0x18a)](_0x287668(0x1b2)))_0x198219=this[_0x287668(0x14a)][_0x287668(0x18c)]({'fileInfo':_0x4a0eb1,'extraParam':_0x501d39,'assistantLogId':_0x341933,'apiKey':_0x2b231d,'action':_0xa399f7,'prompt':_0x270837,'model':_0x2203ee,'timeout':_0x61789c,'proxyUrl':_0x24505f,'taskData':_0x174d01,'onGenerate':async _0xc30190=>{const _0x594ca4=_0x287668;await this[_0x594ca4(0x13a)][_0x594ca4(0x16c)](_0x341933,{'fileInfo':_0xc30190===null||_0xc30190===void 0x0?void 0x0:_0xc30190[_0x594ca4(0x11c)],'answer':(_0xc30190===null||_0xc30190===void 0x0?void 0x0:_0xc30190[_0x594ca4(0x19b)])||_0x270837,'status':0x2});},'onSuccess':async _0x501edf=>{const _0x3d9dd4=_0x287668;await this['chatLogService'][_0x3d9dd4(0x16c)](_0x341933,{'fileInfo':_0x501edf===null||_0x501edf===void 0x0?void 0x0:_0x501edf[_0x3d9dd4(0x11c)],'answer':(_0x501edf===null||_0x501edf===void 0x0?void 0x0:_0x501edf[_0x3d9dd4(0x19b)])||_0x270837,'progress':'100%','status':0x3});},'onFailure':async _0x5eb1de=>{const _0x300a38=_0x287668;await this[_0x300a38(0x13a)][_0x300a38(0x16c)](_0x341933,{'answer':_0x5eb1de[_0x300a38(0x12c)],'status':0x4});}}),await this[_0x287668(0x13a)]['updateChatLog'](_0x341933,{'answer':_0x287668(0x160)});else _0x2203ee[_0x287668(0x18a)](_0x287668(0xd5))?(_0x198219=this['stableDiffusionService']['sdxl']({'chatId':_0x341933,'maxModelTokens':_0x324b81,'apiKey':_0x2b231d,'model':_0x2203ee,'modelName':_0x2cb839,'modelType':_0x15fa5d,'prompt':_0x270837,'fileInfo':_0x4a0eb1,'isFileUpload':_0x48b678,'timeout':_0x61789c,'proxyUrl':_0x24505f,'onSuccess':async _0x5a8910=>{const _0x4ec0ad=_0x287668;await this['chatLogService'][_0x4ec0ad(0x16c)](_0x341933,{'fileInfo':_0x5a8910===null||_0x5a8910===void 0x0?void 0x0:_0x5a8910[_0x4ec0ad(0x11c)],'answer':(_0x5a8910===null||_0x5a8910===void 0x0?void 0x0:_0x5a8910[_0x4ec0ad(0x19b)])||_0x270837,'progress':'100%','status':0x3});},'onFailure':async _0xeb466c=>{const _0x5414e7=_0x287668;await this[_0x5414e7(0x13a)]['updateChatLog'](_0x341933,{'answer':_0x5414e7(0x17c),'status':0x4});}}),await this[_0x287668(0x13a)][_0x287668(0x16c)](_0x341933,{'answer':'绘制中'})):(_0x198219=await this[_0x287668(0x104)][_0x287668(0x121)]({'usePrompt':_0x3b8bbf,'prompt':_0x270837,'apiKey':_0x2b231d,'proxyUrl':_0x24505f,'model':_0x2203ee,'modelName':_0x2cb839,'drawId':_0x293f88,'customId':_0x174d01,'action':_0xa399f7,'fileInfo':_0x4a0eb1,'timeout':_0x61789c,'assistantLogId':_0x341933,'pluginName':_0x1a4c79}),await this[_0x287668(0x13a)][_0x287668(0x16c)](_0x341933,{'answer':_0x198219[_0x287668(0x19b)],'status':_0x198219[_0x287668(0x184)]}));}}}}}_0x198219[_0x287668(0x184)]!==0x5?(await this[_0x287668(0xcb)][_0x287668(0x144)](_0xbfefcb,0x1),await this[_0x287668(0x115)]['deductFromBalance'](_0x4b68b6[_0x287668(0x198)]['id'],_0x270246,_0x481160)):common_1[_0x287668(0xe6)]['log'](_0x287668(0x108),_0x287668(0x12d));const _0x36e2a1=await this[_0x287668(0x115)][_0x287668(0xdd)](_0x4b68b6[_0x287668(0x198)]['id']);return _0x198219[_0x287668(0xee)]=Object[_0x287668(0x153)]({},_0x36e2a1),_0x198219[_0x287668(0x141)]=_0x198219['answer'],_0x198219['status']=_0x198219['status']||0x2,_0x198219[_0x287668(0xc0)]=_0x2b9cf1,_0x198219[_0x287668(0x1b3)]=_0x398f00,_0x255925['write']('\x0a'+JSON[_0x287668(0x1bd)](_0x198219));}else{_0x198219=await this[_0x287668(0xea)][_0x287668(0x152)](_0x56c087,{'chatId':_0x341933,'maxModelTokens':_0x324b81,'apiKey':_0x2b231d,'model':_0x2203ee,'modelName':_0x2cb839,'temperature':_0x13166f,'modelType':_0x15fa5d,'prompt':_0x270837,'fileInfo':_0x4a0eb1,'isFileUpload':_0x48b678,'timeout':_0x61789c,'proxyUrl':_0x24505f,'modelAvatar':_0x1ffa1d,'onProgress':_0xace7c5=>{const _0x5730f0=_0x287668;_0x255925[_0x5730f0(0xf9)](_0x3c1829?JSON[_0x5730f0(0x1bd)](_0xace7c5):'\x0a'+JSON[_0x5730f0(0x1bd)](_0xace7c5)),_0x3c1829=![];},'onFailure':async _0x1b67a4=>{const _0xf532fa=_0x287668;await this[_0xf532fa(0x13a)][_0xf532fa(0x16c)](_0x341933,{'answer':_0x1b67a4[_0xf532fa(0x12c)],'status':0x4});},'abortController':_0x1cdb05});if(_0x198219[_0x287668(0x12c)])return common_1[_0x287668(0xe6)][_0x287668(0xf3)](_0x287668(0x13c)+_0x4b68b6[_0x287668(0x198)]['id']+'\x20模型名称:\x20'+_0x2cb839+_0x287668(0xfb)+_0x2b9cf1+_0x287668(0x130),'ChatService'),_0x255925[_0x287668(0xf9)]('\x0a'+JSON['stringify'](_0x198219));let _0x28f524='';_0x56c087[_0x287668(0x117)](_0x51514a=>{const _0x412777=_0x287668;_0x28f524+=_0x51514a[_0x412777(0x145)]+'\x20';});const _0x1768e5=await(0x0,utils_1['getTokenCount'])(_0x28f524),_0x5e96c2=await(0x0,utils_1[_0x287668(0x178)])(_0x198219[_0x287668(0x19b)]);await this[_0x287668(0x13a)][_0x287668(0x16c)](_0x3585ec,{'promptTokens':_0x1768e5,'completionTokens':_0x5e96c2,'totalTokens':_0x1768e5+_0x5e96c2});let _0x4cf6b0=_0x198219[_0x287668(0x19b)];if(_0x5e7226==='1'){const _0x2c0f6a=await this[_0x287668(0x1b5)]['checkBadWords'](_0x198219['answer'],_0x4b68b6[_0x287668(0x198)]['id']);if(_0x2c0f6a[_0x287668(0x15d)]>0x0){const _0x3d4693=new RegExp(_0x2c0f6a['join']('|'),'gi');_0x4cf6b0=_0x4cf6b0[_0x287668(0x1ae)](_0x3d4693,_0x1e1a16=>'*'[_0x287668(0x186)](_0x1e1a16[_0x287668(0x15d)]));}}await this[_0x287668(0x13a)][_0x287668(0x16c)](_0x341933,{'fileInfo':_0x198219===null||_0x198219===void 0x0?void 0x0:_0x198219[_0x287668(0x11c)],'answer':_0x4cf6b0,'promptTokens':_0x1768e5,'completionTokens':_0x5e96c2,'totalTokens':_0x1768e5+_0x5e96c2,'status':0x3});try{if(_0x48c71d==='1'){const _0x301396=await this['openAIChatService']['chatFree']('根据用户提问{'+_0x270837+_0x287668(0x127)+_0x198219['answer']+'}，生成三个更进入一步的提问，用{}包裹每个问题，不需要分行，不需要其他任何内容，单个提问不超过30个字');await this[_0x287668(0x13a)][_0x287668(0x16c)](_0x341933,{'promptReference':_0x301396});}}catch(_0xa57d9d){common_1[_0x287668(0xe6)][_0x287668(0xf3)](_0x287668(0x131)+_0xa57d9d);}_0x5cb5ac===!![]&&(_0x481160=_0xb13567*Math[_0x287668(0xe2)]((_0x1768e5+_0x5e96c2)/_0x46cc98));await this[_0x287668(0x115)]['deductFromBalance'](_0x4b68b6[_0x287668(0x198)]['id'],_0x270246,_0x481160,_0x1768e5+_0x5e96c2),await this[_0x287668(0xcb)]['saveUseLog'](_0xbfefcb,_0x1768e5+_0x5e96c2),common_1[_0x287668(0xe6)]['log']('用户ID:\x20'+_0x4b68b6[_0x287668(0x198)]['id']+_0x287668(0x166)+_0x2cb839+_0x287668(0xfb)+_0x2b9cf1+_0x287668(0xd6)+(_0x1768e5+_0x5e96c2)+_0x287668(0x16f)+_0x481160,_0x287668(0x12d));const _0x964017=await this['userBalanceService'][_0x287668(0xdd)](_0x4b68b6[_0x287668(0x198)]['id']);return _0x198219['userBalance']=Object[_0x287668(0x153)]({},_0x964017),_0x255925[_0x287668(0xf9)]('\x0a'+JSON[_0x287668(0x1bd)](_0x198219));}}catch(_0x59ea4c){common_1[_0x287668(0xe6)][_0x287668(0xf3)]('发生错误:',_0x59ea4c),await this[_0x287668(0x13a)][_0x287668(0x16c)](_0x341933,{'status':0x5}),_0x198219={'error':_0x287668(0x179)};}}else return _0xf5cc00=await this[_0x287668(0xea)][_0x287668(0x152)](_0x56c087,{'chatId':_0x341933,'maxModelTokens':_0x324b81,'apiKey':_0x2b231d,'model':_0x2203ee,'modelName':_0x2cb839,'modelType':_0x15fa5d,'temperature':_0x13166f,'prompt':_0x270837,'fileInfo':_0x4a0eb1,'isFileUpload':_0x48b678,'timeout':_0x61789c,'proxyUrl':_0x24505f,'abortController':_0x1cdb05}),await this['userBalanceService'][_0x287668(0x122)](_0x4b68b6[_0x287668(0x198)]['id'],_0x270246,_0x481160),_0xf5cc00['answer'];}catch(_0x1ecb9f){common_1[_0x287668(0xe6)][_0x287668(0xf3)]('chat-error\x20<----------------------------------------->',_0x2b231d,_0x1ecb9f);if(_0x255925)return _0x255925[_0x287668(0xf9)](_0x287668(0x1aa));else throw new common_1[(_0x287668(0x187))](_0x287668(0x1aa),common_1[_0x287668(0x1ac)][_0x287668(0x143)]);}finally{_0x255925&&_0x255925[_0x287668(0x1c1)]();}}async[_0x485f5f(0x107)](_0xc1a1bf,_0x453804){const _0x2cc02d=_0x485f5f,{pluginUrl:_0xe915d0,pluginKey:_0x2951ca}=await this[_0x2cc02d(0xcf)]['getConfigs'](['pluginUrl','pluginKey']),_0xe36292=_0x2951ca,_0x108949=_0xe915d0,_0x38230c={'method':_0x2cc02d(0x1bc),'url':_0x108949+_0x2cc02d(0x1a2)+_0x453804,'headers':{'Content-Type':_0x2cc02d(0xc4),'Authorization':_0x2cc02d(0x123)+_0xe36292},'data':{'prompt':_0xc1a1bf}};try{const _0x2eada2=await(0x0,axios_1['default'])(_0x38230c);return common_1['Logger'][_0x2cc02d(0x1ab)](_0x2cc02d(0x1c2)+JSON[_0x2cc02d(0x1bd)](_0x2eada2[_0x2cc02d(0x177)],null,0x2),_0x2cc02d(0x199)),_0x2eada2[_0x2cc02d(0x177)]['text'];}catch(_0x4c115d){common_1['Logger']['error'](_0x2cc02d(0x164),_0x4c115d);}}async['updateChatTitle'](_0x4d4955,_0x20de0f,_0x50fe5d,_0xd2b872,_0x4a8389){const _0x204e8d=_0x485f5f;if((_0x20de0f===null||_0x20de0f===void 0x0?void 0x0:_0x20de0f[_0x204e8d(0x1a5)])===_0x204e8d(0x194)){let _0x5de728;if(_0x50fe5d===0x1)try{_0x5de728=await this[_0x204e8d(0xea)][_0x204e8d(0x182)](_0x204e8d(0x1a6)+_0xd2b872+_0x204e8d(0x14f)),_0x5de728[_0x204e8d(0x15d)]>0xf&&(_0x5de728=_0x5de728['slice'](0x0,0xf));}catch(_0x2fba70){common_1[_0x204e8d(0xe6)][_0x204e8d(0xf3)](_0x204e8d(0x131)+_0x2fba70),_0x5de728=_0xd2b872[_0x204e8d(0xd8)](0x0,0xa);}else _0x5de728=_0x204e8d(0x111);this[_0x204e8d(0x1ba)]['update']({'groupId':_0x4d4955,'title':_0x5de728,'isSticky':![],'config':'','fileUrl':''},_0x4a8389)[_0x204e8d(0x176)](()=>common_1['Logger'][_0x204e8d(0x1ab)]('更新标题名称为:\x20'+_0x5de728,'ChatService'))['catch'](_0x2c7676=>common_1[_0x204e8d(0xe6)]['error'](_0x204e8d(0x1bf)+_0x2c7676));}}async['buildMessageFromParentMessageId'](_0x3edbc6,_0x598b6a,_0x3e0e91){const _0x216763=_0x485f5f;let {systemMessage:systemMessage='',fileInfo:_0x32842f,groupId:_0x1d6c3d,maxRounds:maxRounds=0x5,maxModelTokens:maxModelTokens=0x1f40,isFileUpload:isFileUpload=0x0,isConvertToBase64:_0x27693e}=_0x598b6a;systemMessage[_0x216763(0x15d)]>maxModelTokens&&(common_1['Logger']['log']('系统消息超过最大长度，将被截断',_0x216763(0x12d)),systemMessage=systemMessage[_0x216763(0xd8)](0x0,maxModelTokens));let _0x3921b0=[];systemMessage&&_0x3921b0[_0x216763(0x19d)]({'role':_0x216763(0x1bb),'content':systemMessage});if(_0x1d6c3d){const _0x222bca=await _0x3e0e91[_0x216763(0x129)](_0x1d6c3d,maxRounds);let _0x3ddc84=null;for(const _0x3133a8 of _0x222bca){try{let _0x5b9a83;if((isFileUpload===0x2||isFileUpload===0x3)&&_0x3133a8[_0x216763(0x11c)]&&_0x3133a8[_0x216763(0xdc)]==='user'){const _0x2ccbe1=await Promise[_0x216763(0xdb)](_0x3133a8[_0x216763(0x11c)][_0x216763(0x192)](',')[_0x216763(0x103)](async _0x5cc448=>({'type':'image_url','image_url':{'url':_0x27693e==='1'?await this[_0x216763(0xc3)](_0x5cc448[_0x216763(0x183)]()):_0x5cc448[_0x216763(0x183)]()}})));_0x5b9a83=[{'type':_0x216763(0x141),'text':_0x3133a8['text']},..._0x2ccbe1];}else isFileUpload===0x1&&_0x3133a8[_0x216763(0x11c)]&&_0x3133a8[_0x216763(0xdc)]===_0x216763(0x198)?_0x5b9a83=_0x3133a8[_0x216763(0x11c)]+'\x0a'+_0x3133a8[_0x216763(0x141)]:_0x5b9a83=_0x3133a8[_0x216763(0x141)];if(_0x3133a8[_0x216763(0xdc)]==='user')_0x3ddc84={'role':_0x3133a8[_0x216763(0xdc)],'content':_0x5b9a83};else{if(_0x3133a8['role']===_0x216763(0x120)){const _0x237a97=Array[_0x216763(0x1a7)](_0x5b9a83)?JSON[_0x216763(0x1bd)](_0x5b9a83):_0x5b9a83;_0x3ddc84&&_0x237a97[_0x216763(0x183)]()!==''&&(_0x3921b0[_0x216763(0x19d)](_0x3ddc84),_0x3921b0[_0x216763(0x19d)]({'role':_0x3133a8[_0x216763(0xdc)],'content':_0x5b9a83}),_0x3ddc84=null);}}}catch(_0x49305e){common_1[_0x216763(0xe6)]['error']('处理历史记录时出错:',_0x49305e,_0x216763(0x169),JSON[_0x216763(0x1bd)](_0x3133a8,null,0x2));}}}let _0x2c6fbd;if((isFileUpload===0x2||isFileUpload===0x3)&&_0x32842f){const _0x2423ea=await Promise[_0x216763(0xdb)](_0x32842f[_0x216763(0x192)](',')[_0x216763(0x103)](async _0xe02bd3=>({'type':_0x216763(0x197),'image_url':{'url':_0x27693e==='1'?await this['convertUrlToBase64'](_0xe02bd3[_0x216763(0x183)]()):_0xe02bd3[_0x216763(0x183)]()}})));_0x2c6fbd=[{'type':_0x216763(0x141),'text':_0x3edbc6},..._0x2423ea];}else isFileUpload===0x1&&_0x32842f?_0x2c6fbd=_0x32842f+'\x0a'+_0x3edbc6:_0x2c6fbd=_0x3edbc6;_0x3921b0[_0x216763(0x19d)]({'role':'user','content':_0x2c6fbd});let _0x19d08a=await(0x0,utils_1['getTokenCount'])(_0x3921b0),_0x55cb24;maxModelTokens<0x1f40?_0x55cb24=0xfa0:_0x55cb24=maxModelTokens-0xfa0;while(_0x19d08a>_0x55cb24){if(_0x3921b0[_0x216763(0x15d)]===0x2&&_0x3921b0[0x0][_0x216763(0xdc)]===_0x216763(0x1bb)&&_0x3921b0[0x1][_0x216763(0xdc)]===_0x216763(0x198))break;let _0x3bd227=![];for(let _0x40aee0=0x0;_0x40aee0<_0x3921b0[_0x216763(0x15d)];_0x40aee0++){if(_0x3921b0[_0x40aee0][_0x216763(0xdc)]!==_0x216763(0x1bb)&&_0x3921b0[_0x40aee0+0x1]&&_0x3921b0[_0x40aee0+0x1][_0x216763(0xdc)]===_0x216763(0x120)){_0x3921b0[_0x216763(0x137)](_0x40aee0,0x2),_0x3bd227=!![];break;}}if(!_0x3bd227)for(let _0x55bdf4=0x0;_0x55bdf4<_0x3921b0['length'];_0x55bdf4++){if(_0x3921b0[_0x55bdf4]['role']===_0x216763(0x198)){_0x3921b0[_0x216763(0x137)](_0x55bdf4,0x1);break;}}_0x19d08a=await(0x0,utils_1[_0x216763(0x178)])(_0x3921b0);if(_0x3921b0[_0x216763(0x15d)]<=0x2)break;}return{'messagesHistory':_0x3921b0,'round':_0x3921b0[_0x216763(0x15d)]};}async[_0x485f5f(0xc3)](_0x4d1faf){const _0x21464f=_0x485f5f;try{console[_0x21464f(0x1ab)](_0x21464f(0x138)+_0x4d1faf);const _0x4eb534=await axios_1[_0x21464f(0x173)]['get'](_0x4d1faf,{'responseType':_0x21464f(0x16e)}),_0x517fa3=Buffer[_0x21464f(0xe0)](_0x4eb534['data'],'binary');console['log'](_0x21464f(0x193)+_0x4d1faf);const _0x18e62c='data:'+_0x4eb534['headers'][_0x21464f(0xde)]+_0x21464f(0x132)+_0x517fa3[_0x21464f(0x1b4)](_0x21464f(0x147));return console[_0x21464f(0x1ab)](_0x21464f(0xf2)+_0x4d1faf),_0x18e62c;}catch(_0x1f3179){return console[_0x21464f(0xf3)]('转换URL为Base64时发生错误:',_0x1f3179),console[_0x21464f(0x1b8)](_0x21464f(0x11a)+_0x4d1faf),_0x4d1faf;}}async[_0x485f5f(0xc2)](_0x4c8245,_0xf17b5d,_0x383032){const _0x455f70=_0x485f5f,{chatId:_0x212402,prompt:_0x26d2c2}=_0x4c8245,_0x45986f=await this[_0x455f70(0xcb)][_0x455f70(0x1c0)](_0x455f70(0x106)),{openaiTimeout:_0x413467,openaiBaseUrl:_0x16b929,openaiBaseKey:_0x59f4d7,openaiVoice:_0x1e9b60}=await this[_0x455f70(0xcf)][_0x455f70(0x15e)]([_0x455f70(0x134),_0x455f70(0x13d),_0x455f70(0x11e),'openaiVoice']),{key:_0x13da2e,proxyUrl:_0x3e2d06,deduct:_0x4339ae,deductType:_0x174781,timeout:_0x377cfc}=_0x45986f,_0x32482e=_0x13da2e||_0x59f4d7,_0x23455d=(0x0,utils_1[_0x455f70(0x10f)])(_0x3e2d06||_0x16b929),_0x3e1015=(_0x377cfc||_0x413467)*0x3e8;await this[_0x455f70(0x115)]['validateBalance'](_0xf17b5d,_0x174781,_0x4339ae),common_1[_0x455f70(0xe6)][_0x455f70(0x1ab)]('开始\x20TTS\x20请求:',_0x26d2c2,_0x455f70(0x1b6));const _0x4f11b5={'method':_0x455f70(0x1bc),'url':_0x23455d+_0x455f70(0x17f),'headers':{'Content-Type':_0x455f70(0xc4),'Authorization':_0x455f70(0x123)+_0x32482e},'responseType':_0x455f70(0x16e),'timeout':_0x3e1015,'data':{'model':'tts-1','input':_0x26d2c2,'voice':_0x1e9b60||_0x455f70(0x13f)}};try{const _0xa4b500=await(0x0,axios_1['default'])(_0x4f11b5);common_1[_0x455f70(0xe6)][_0x455f70(0x1ab)](_0x455f70(0x175),_0x455f70(0x1b6));const _0x549f03=Buffer[_0x455f70(0xe0)](_0xa4b500[_0x455f70(0x177)]),_0x2d6ea9=new Date(),_0xf40f1c=_0x2d6ea9[_0x455f70(0x13e)](),_0x1c5cf7=String(_0x2d6ea9[_0x455f70(0x168)]()+0x1)[_0x455f70(0xc1)](0x2,'0'),_0x307143=String(_0x2d6ea9[_0x455f70(0xd3)]())['padStart'](0x2,'0'),_0x5ea546=''+_0xf40f1c+_0x1c5cf7+'/'+_0x307143,_0x5d1eb3=await this[_0x455f70(0x10c)][_0x455f70(0x124)]({'buffer':_0x549f03,'mimetype':_0x455f70(0x112)},'audio/openai/'+_0x5ea546);await Promise[_0x455f70(0xdb)]([this[_0x455f70(0x13a)][_0x455f70(0x16c)](_0x212402,{'ttsUrl':_0x5d1eb3}),this[_0x455f70(0x115)][_0x455f70(0x122)](_0xf17b5d[_0x455f70(0x198)]['id'],_0x174781,_0x4339ae)]),_0x383032['status'](0xc8)[_0x455f70(0x15c)]({'ttsUrl':_0x5d1eb3});}catch(_0x2fa480){common_1[_0x455f70(0xe6)][_0x455f70(0xf3)]('TTS\x20请求或上传过程失败:',_0x2fa480,_0x455f70(0x1b6)),_0x383032[_0x455f70(0x184)](0x1f4)[_0x455f70(0x15c)]({'error':_0x455f70(0xca)});}}};ChatService=__decorate([(0x0,common_1[_0x485f5f(0xc8)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(config_entity_1[_0x485f5f(0x15a)])),__param(0x1,(0x0,typeorm_1[_0x485f5f(0x162)])(app_entity_1[_0x485f5f(0x11f)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(plugin_entity_1[_0x485f5f(0x19a)])),__metadata(_0x485f5f(0xed),[typeorm_2[_0x485f5f(0x126)],typeorm_2[_0x485f5f(0x126)],typeorm_2[_0x485f5f(0x126)],suno_service_1[_0x485f5f(0xf0)],openaiChat_service_1[_0x485f5f(0xd0)],chatLog_service_1[_0x485f5f(0x149)],midjourneyDraw_service_1['MidjourneyService'],stableDiffusion_service_1['StableDiffusionService'],userBalance_service_1[_0x485f5f(0x1a0)],user_service_1[_0x485f5f(0x133)],upload_service_1[_0x485f5f(0xc5)],badWords_service_1[_0x485f5f(0xf1)],autoreply_service_1[_0x485f5f(0xd2)],globalConfig_service_1[_0x485f5f(0x18f)],chatGroup_service_1[_0x485f5f(0x165)],models_service_1[_0x485f5f(0x136)],openaiDraw_service_1[_0x485f5f(0x10e)],lumaVideo_service_1[_0x485f5f(0x16a)],cogVideo_service_1[_0x485f5f(0x1a9)],fluxDraw_service_1[_0x485f5f(0x12a)],aiPPT_1[_0x485f5f(0x180)]])],ChatService),exports[_0x485f5f(0x12d)]=ChatService;