'use strict';const _0x862396=_0xecfe;(function(_0x17c10a,_0x17d2ee){const _0x3e8a51=_0xecfe,_0xaeb2be=_0x17c10a();while(!![]){try{const _0x327d03=parseInt(_0x3e8a51(0x1e3))/0x1+-parseInt(_0x3e8a51(0x153))/0x2*(-parseInt(_0x3e8a51(0x110))/0x3)+parseInt(_0x3e8a51(0xef))/0x4*(-parseInt(_0x3e8a51(0x155))/0x5)+-parseInt(_0x3e8a51(0x18a))/0x6+parseInt(_0x3e8a51(0x17e))/0x7+-parseInt(_0x3e8a51(0x1c1))/0x8*(-parseInt(_0x3e8a51(0xff))/0x9)+-parseInt(_0x3e8a51(0x148))/0xa*(-parseInt(_0x3e8a51(0x167))/0xb);if(_0x327d03===_0x17d2ee)break;else _0xaeb2be['push'](_0xaeb2be['shift']());}catch(_0x25eda3){_0xaeb2be['push'](_0xaeb2be['shift']());}}}(_0x4939,0x4b2f0));function _0xecfe(_0x48fe0b,_0x535071){const _0x49391a=_0x4939();return _0xecfe=function(_0xecfea1,_0x6e099){_0xecfea1=_0xecfea1-0xee;let _0x135d73=_0x49391a[_0xecfea1];return _0x135d73;},_0xecfe(_0x48fe0b,_0x535071);}var __decorate=this&&this[_0x862396(0x17d)]||function(_0x292839,_0x5df08b,_0x47ba7f,_0x2540e4){const _0x309cf5=_0x862396;var _0x27c5aa=arguments[_0x309cf5(0x16b)],_0x406445=_0x27c5aa<0x3?_0x5df08b:_0x2540e4===null?_0x2540e4=Object['getOwnPropertyDescriptor'](_0x5df08b,_0x47ba7f):_0x2540e4,_0x1d5e39;if(typeof Reflect==='object'&&typeof Reflect[_0x309cf5(0x1dd)]===_0x309cf5(0x1ab))_0x406445=Reflect[_0x309cf5(0x1dd)](_0x292839,_0x5df08b,_0x47ba7f,_0x2540e4);else{for(var _0x125385=_0x292839[_0x309cf5(0x16b)]-0x1;_0x125385>=0x0;_0x125385--)if(_0x1d5e39=_0x292839[_0x125385])_0x406445=(_0x27c5aa<0x3?_0x1d5e39(_0x406445):_0x27c5aa>0x3?_0x1d5e39(_0x5df08b,_0x47ba7f,_0x406445):_0x1d5e39(_0x5df08b,_0x47ba7f))||_0x406445;}return _0x27c5aa>0x3&&_0x406445&&Object[_0x309cf5(0x156)](_0x5df08b,_0x47ba7f,_0x406445),_0x406445;},__metadata=this&&this[_0x862396(0x194)]||function(_0x365295,_0x1ca5b5){const _0x23d87b=_0x862396;if(typeof Reflect==='object'&&typeof Reflect['metadata']===_0x23d87b(0x1ab))return Reflect[_0x23d87b(0x16d)](_0x365295,_0x1ca5b5);},__param=this&&this[_0x862396(0xf8)]||function(_0x8a35ab,_0x5a9981){return function(_0x2d06d5,_0x26db1d){_0x5a9981(_0x2d06d5,_0x26db1d,_0x8a35ab);};};function _0x4939(){const _0x332efc=['parse','您提交的信息中包含违规的内容，我们已对您的账户进行标记，请合规使用！','convertUrlToBase64','badWordsService','../upload/upload.service','error:\x20','chatGroupService','PluginEntity','typeorm','新对话','使用文件解析:\x20','uploadService','50jWDsxf','join','midjourney','}以及\x20AI\x20的回答{','AppEntity','tts-1','未找到当前模型key，切换至全局模型','绘图失败','includes','】，在回答问题之前，先检索知识库内有没有相关的内容，尽量使用知识库中获取到的信息来回答我的问题，以知识库中的为准。','slice','280KFIxdp','使用全局预设:\x20','155810eckLZv','defineProperty','getTokenCount','Repository','suno','}，给这个对话取一个名字，不超过10个字','openAIChatService','systemPreMessage','../globalConfig/config.entity','chatProcess','处理请求时发生错误','openaiTimeout','stringify','map','OpenAIChatService','DrawService','fluxDraw','updateChatLog','1025607ObQEnz','任务提交失败，不执行扣费','data','checkModelLimits','length','../globalConfig/globalConfig.service','metadata','TOO_MANY_REQUESTS','LumaVideoService','插件调用成功\x20返回结果:\x20','parameters','send','../userBalance/userBalance.service','isSystemPlugin','userService','chat-error\x20<----------------------------------------->','update','InjectRepository','replace','openaiBaseUrl','固定模型、使用应用预设:\x20','headers','__decorate','2975hdxXhK','ModelsService','Failed\x20to\x20process\x20TTS\x20request','AutoreplyService','openaiVoice','AiPptService','@nestjs/typeorm','splice','deductFromBalance','content','POST','../ai/openaiDraw.service','3243642kZRQWN','role','成功转换URL为Base64:\x20','title','forEach','checkUserStatus','isArray','content-type','FluxDrawService','../models/models.service','__metadata','get','ConfigEntity','用户ID:\x20','绘制中','\x20模型名称:\x20','application/json','saveChatLog','status','toString','../ai/stableDiffusion.service','sdxl','\x20回复出错，本次不扣除积分','lumaVideo',',\x20消耗积分：\x20','onyx','fileInfo','CogVideoService','axios','write','ChatService','BAD_REQUEST','default','function','openaiBaseModel','user','../app/app.entity','appEntity','}，生成三个更进入一步的提问，用{}包裹每个问题，不需要分行，不需要其他任何内容，单个提问不超过30个字','close','arraybuffer','application/octet-stream;\x20charset=utf-8','../ai/midjourneyDraw.service','midjourneyDraw','调用\x20chatFree\x20出错:\x20','model','提交成功，视频生成中','Bearer\x20','aiPPT','assistant','getCurrentModelKeyInfo','TTSService','转换URL为Base64时发生错误:','system','from','4367256kOqSrv','../ai/fluxDraw.service','Injectable','flux','\x20消耗token:\x20','midjourneyService','modelName','preset','开始\x20TTS\x20请求:','生成失败','queryUserBalance','formatUrl','提交成功，歌曲生成中','../chatGroup/chatGroup.service','TTS\x20请求或上传过程失败:','ChatLogService','pluginEntity','chatLogService','返回原始链接:\x20','../../common/utils','updateTime','binary','生成中','配置解析错误！','发生未知错误，请稍后再试','getDate','luma-video','../plugin/plugin.entity','decorate','answer','split','debug','push','sunoService','100134ZjbOHt','SunoService','@nestjs/common','modelInfo','lumaVideoService','/plugins/','uploadFile','../badWords/badWords.service','插件调用错误:\x20','globalConfigService','autoreplyService','chatFree','image_url','../autoreply/autoreply.service','HttpException','dalleDraw','validateBalance','openAIDrawService','64TJASIC',';base64,','stableDiffusionService','findOne','userBalanceService','all','\x20模型:\x20','base64','使用应用预设:\x20','__param','design:paramtypes','以下是我提供给你的知识库：【','../ai/suno.service','checkAutoReply','StableDiffusionService','ai-ppt','9CawJvE','data:','成功获取图片，正在转换为Base64:\x20','创意\x20AI','warn','usePlugin','isAIReplyEnabled','error','getGroupInfoFromId','gpt-4-gizmo-','aiPptService','text','cogVideo','assign','HttpStatus','Logger','isMjTranslate','5025tlOWiG','config','100%','isGeneratePromptReference','记录:','openaiBaseKey','dall-e-3','checkBadWords','TTS\x20请求获取成功','suno-music','stable-diffusion','PluginService','../chatLog/chatLog.service','cog-video','saveUseLog','audio/mpeg','errMsg','getConfigs','trim','../ai/cogVideo.service','updateChatTitle','../ai/openaiChat.service','../user/user.service','userBalance','处理历史记录时出错:','getClientIp','fluxDrawService','使用插件预设:\x20','end','openAIChat','configEntity','Content-type','modelsService','开始生成PPT','https://api.openai.com','../ai/aiPPT','/v1/audio/speech','setHeader','log','getFullYear','Translate\x20any\x20given\x20phrase\x20from\x20any\x20language\x20into\x20English.\x20For\x20instance,\x20when\x20I\x20input\x20\x27{可爱的熊猫}\x27,\x20you\x20should\x20output\x20\x27{cute\x20panda}\x27,\x20with\x20no\x20period\x20at\x20the\x20end.','padStart','buildMessageFromParentMessageId','\x0a\x20Current\x20date:\x20'];_0x4939=function(){return _0x332efc;};return _0x4939();}Object[_0x862396(0x156)](exports,'__esModule',{'value':!![]}),exports[_0x862396(0x1a8)]=void 0x0;const utils_1=require(_0x862396(0x1d4)),common_1=require(_0x862396(0x1e5)),typeorm_1=require(_0x862396(0x184)),axios_1=require(_0x862396(0x1a6)),typeorm_2=require(_0x862396(0x144)),aiPPT_1=require(_0x862396(0x133)),cogVideo_service_1=require(_0x862396(0x123)),fluxDraw_service_1=require(_0x862396(0x1c2)),lumaVideo_service_1=require('../ai/lumaVideo.service'),midjourneyDraw_service_1=require(_0x862396(0x1b4)),openaiChat_service_1=require(_0x862396(0x125)),openaiDraw_service_1=require(_0x862396(0x189)),stableDiffusion_service_1=require(_0x862396(0x19e)),suno_service_1=require(_0x862396(0xfb)),app_entity_1=require(_0x862396(0x1ae)),autoreply_service_1=require(_0x862396(0x1f0)),badWords_service_1=require(_0x862396(0x1ea)),chatGroup_service_1=require(_0x862396(0x1ce)),chatLog_service_1=require(_0x862396(0x11c)),config_entity_1=require(_0x862396(0x15d)),globalConfig_service_1=require(_0x862396(0x16c)),models_service_1=require(_0x862396(0x193)),plugin_entity_1=require(_0x862396(0x1dc)),upload_service_1=require(_0x862396(0x140)),user_service_1=require(_0x862396(0x126)),userBalance_service_1=require(_0x862396(0x173));let ChatService=class ChatService{constructor(_0x550eaa,_0xda1cff,_0x16382a,_0x56302f,_0x59d78f,_0x1401f5,_0x5e051c,_0x1b0aa3,_0x509405,_0x265599,_0x44a30c,_0x13e8f4,_0x3903b8,_0x1c7df9,_0x543f82,_0x98e070,_0x391675,_0x4d29e1,_0x184657,_0x23969e,_0x135f74){const _0x185352=_0x862396;this[_0x185352(0x12e)]=_0x550eaa,this[_0x185352(0x1af)]=_0xda1cff,this['pluginEntity']=_0x16382a,this[_0x185352(0x1e2)]=_0x56302f,this[_0x185352(0x15b)]=_0x59d78f,this[_0x185352(0x1d2)]=_0x1401f5,this[_0x185352(0x1c6)]=_0x5e051c,this[_0x185352(0xf1)]=_0x1b0aa3,this[_0x185352(0xf3)]=_0x509405,this[_0x185352(0x175)]=_0x265599,this[_0x185352(0x147)]=_0x44a30c,this[_0x185352(0x13f)]=_0x13e8f4,this[_0x185352(0x1ed)]=_0x3903b8,this[_0x185352(0x1ec)]=_0x1c7df9,this[_0x185352(0x142)]=_0x543f82,this['modelsService']=_0x98e070,this['openAIDrawService']=_0x391675,this[_0x185352(0x1e7)]=_0x4d29e1,this['cogVideoService']=_0x184657,this[_0x185352(0x12a)]=_0x23969e,this[_0x185352(0x109)]=_0x135f74;}async[_0x862396(0x15e)](_0x2f5530,_0x509b85,_0x1887fc){const _0x520533=_0x862396;await this[_0x520533(0xf3)]['checkUserCertification'](_0x509b85[_0x520533(0x1ad)]['id']);const {options:options={},usingPluginId:_0x5de3af,appId:appId=null,specialModel:_0xd4d097,prompt:_0x51d78a,fileInfo:_0x3b3005,extraParam:_0x3e9e3a,model:_0x367427,drawId:_0x182350,customId:_0xd164a6,action:_0x41bab7,modelName:_0x4e0252,modelAvatar:_0x27fc5f}=_0x2f5530;let _0x1fa5f6;if(_0xd4d097)_0x1fa5f6=await this['appEntity'][_0x520533(0xf2)]({'where':{'des':_0xd4d097,'isSystemReserved':!![]}});else{if(appId){_0x1fa5f6=await this[_0x520533(0x1af)][_0x520533(0xf2)]({'where':{'id':appId,'status':(0x0,typeorm_2['In'])([0x1,0x3,0x4,0x5])}});if(!_0x1fa5f6)throw new common_1['HttpException']('你当前使用的应用已被下架、请删除当前对话开启新的对话吧！',common_1['HttpStatus'][_0x520533(0x1a9)]);}}const {groupId:_0x4d80d1,fileParsing:_0xc56dd3}=options,{openaiTimeout:_0x144400,openaiBaseUrl:_0x58e7df,openaiBaseKey:_0x15c22a,systemPreMessage:_0x111a49,isMjTranslate:_0x5abb91,mjTranslatePrompt:_0x2ad4a7,openaiTemperature:_0x1c4e35,openaiBaseModel:_0x24246b,isGeneratePromptReference:_0x1cd741,isConvertToBase64:_0x4a8439,isSensitiveWordFilter:_0x598118}=await this['globalConfigService']['getConfigs'](['openaiTimeout',_0x520533(0x17a),_0x520533(0x115),_0x520533(0x15c),_0x520533(0x10f),'mjTranslatePrompt','openaiTemperature',_0x520533(0x1ac),_0x520533(0x113),'isConvertToBase64','isSensitiveWordFilter']);await this[_0x520533(0x175)][_0x520533(0x18f)](_0x509b85['user']),_0x1887fc&&_0x1887fc[_0x520533(0x135)](_0x520533(0x12f),_0x520533(0x1b3));if(_0x598118==='1'){const _0x3c0d45=await this[_0x520533(0x13f)][_0x520533(0x117)](_0x51d78a,_0x509b85[_0x520533(0x1ad)]['id']);if(_0x3c0d45[_0x520533(0x16b)]>0x0){const _0x1b23d7=_0x520533(0x13d);throw new common_1[(_0x520533(0x1f1))](_0x1b23d7,common_1[_0x520533(0x10d)][_0x520533(0x1a9)]);}}const _0x285c59=await this[_0x520533(0x1ed)][_0x520533(0xfc)](_0x51d78a);let _0x9d75dd=null,_0x206187='',_0x3f7e21='';_0x1887fc&&_0x1887fc[_0x520533(0x19c)](0xc8);let _0x54929e=null;const _0x3bd6a2=(0x0,utils_1[_0x520533(0x129)])(_0x509b85);let _0x3273cd,_0x414a89='',_0x368cfe;_0x5de3af&&(_0x368cfe=await this[_0x520533(0x1d1)][_0x520533(0xf2)]({'where':{'id':_0x5de3af}}));if(_0x1fa5f6){const {isGPTs:_0x1d1c95,gizmoID:_0x4b3a54,name:_0x53fb9b,isFixedModel:_0x41ae4c,appModel:_0xe64f60,coverImg:_0x7cd360}=_0x1fa5f6;_0x414a89=_0x7cd360,_0x206187=_0x53fb9b;if(_0x1d1c95)_0x9d75dd=await this[_0x520533(0x130)][_0x520533(0x1bc)]('gpts'),_0x9d75dd['model']=_0x520533(0x108)+_0x4b3a54;else!_0x1d1c95&&_0x41ae4c&&_0xe64f60?(_0x1fa5f6['preset']&&(_0x3f7e21=_0x1fa5f6[_0x520533(0x1c8)]),_0x9d75dd=await this[_0x520533(0x130)][_0x520533(0x1bc)](_0xe64f60),_0x9d75dd['model']=_0xe64f60,_0xc56dd3&&(_0x3f7e21=_0x3f7e21+_0x520533(0xfa)+_0xc56dd3+_0x520533(0x151)),common_1[_0x520533(0x10e)][_0x520533(0x136)](_0x520533(0x17b)+_0x3f7e21,'ChatService')):(_0x1fa5f6[_0x520533(0x1c8)]&&(_0x3f7e21=_0x1fa5f6[_0x520533(0x1c8)]),_0x9d75dd=await this['modelsService'][_0x520533(0x1bc)](_0x367427),_0xc56dd3&&(_0x3f7e21=_0x3f7e21+_0x520533(0xfa)+_0xc56dd3+_0x520533(0x151)),common_1['Logger'][_0x520533(0x136)](_0x520533(0xf7)+_0x3f7e21,'ChatService'));}else{const _0x38d4f8=await this[_0x520533(0x142)][_0x520533(0x107)](_0x4d80d1);if(_0x368cfe&&_0x368cfe[_0x520533(0x174)]===0x0){let _0x5c3768='';try{_0x5c3768=await this['usePlugin'](_0x51d78a,_0x368cfe['parameters']),common_1[_0x520533(0x10e)][_0x520533(0x136)]('插件返回结果:\x20'+_0x5c3768,_0x520533(0x1a8));}catch(_0x5d88ca){_0x5c3768=_0x51d78a,common_1[_0x520533(0x10e)][_0x520533(0x106)](_0x520533(0x1eb)+_0x5d88ca);}_0x3f7e21=_0x5c3768,_0x9d75dd=await this[_0x520533(0x130)][_0x520533(0x1bc)](_0x367427),common_1['Logger'][_0x520533(0x136)](_0x520533(0x12b)+_0x3f7e21,_0x520533(0x1a8));}else{if(_0xc56dd3)_0x3f7e21=_0x520533(0xfa)+_0xc56dd3+_0x520533(0x151),_0x9d75dd=await this[_0x520533(0x130)][_0x520533(0x1bc)](_0x367427),common_1[_0x520533(0x10e)][_0x520533(0x136)](_0x520533(0x146)+_0x3f7e21,'ChatService');else{const _0x491209=new Date()['toISOString']()['split']('T')[0x0];_0x3f7e21=_0x111a49+(_0x520533(0x13b)+_0x491209),_0x9d75dd=await this['modelsService']['getCurrentModelKeyInfo'](_0x367427),common_1[_0x520533(0x10e)][_0x520533(0x136)](_0x520533(0x154)+_0x3f7e21,'ChatService');}}}if(!_0x9d75dd){common_1[_0x520533(0x10e)]['debug'](_0x520533(0x14e),_0x520533(0x1a8)),_0x9d75dd=await this[_0x520533(0x130)][_0x520533(0x1bc)](_0x24246b);const _0x5b85f6=await this[_0x520533(0x142)][_0x520533(0x107)](_0x4d80d1);let _0x1e8047=_0x5b85f6[_0x520533(0x111)];try{const _0x478ac2=JSON[_0x520533(0x13c)](_0x5b85f6[_0x520533(0x111)]);_0x478ac2[_0x520533(0x1e6)]&&(_0x478ac2[_0x520533(0x1e6)][_0x520533(0x1c7)]=_0x9d75dd[_0x520533(0x1c7)],_0x478ac2['modelInfo']['model']=_0x9d75dd[_0x520533(0x1b7)],_0x1e8047=JSON[_0x520533(0x161)](_0x478ac2));}catch(_0xf23c7e){common_1[_0x520533(0x10e)][_0x520533(0x1e0)]('模型切换错误，请检查全局模型配置！',_0x520533(0x1a8));throw new common_1['HttpException'](_0x520533(0x1d8),common_1['HttpStatus'][_0x520533(0x1a9)]);}await this['chatGroupService'][_0x520533(0x177)]({'groupId':_0x4d80d1,'title':_0x5b85f6['title'],'isSticky':![],'config':_0x1e8047,'fileUrl':''},_0x509b85);}const {deduct:_0x4a836d,isTokenBased:_0xc28530,tokenFeeRatio:_0x36bf26,deductType:_0x2d9d2c,key:_0x3d25bf,id:_0x35ea24,maxRounds:_0x4d06d1,proxyUrl:_0x34b57e,maxModelTokens:_0xfb3d66,timeout:_0x33a797,model:_0x4fb29b,isFileUpload:_0x3c0bd2,keyType:_0x1c5cb3}=_0x9d75dd;if(await this['chatLogService'][_0x520533(0x16a)](_0x509b85['user'],_0x4fb29b))throw new common_1[(_0x520533(0x1f1))]('1\x20小时内对话次数过多，请切换模型或稍后再试！',common_1['HttpStatus'][_0x520533(0x16e)]);if(_0x5abb91==='1'&&_0x41bab7==='IMAGINE'&&_0x367427===_0x520533(0x14a)){const [_0x2fd116,_0xe6cde2]=_0x51d78a[_0x520533(0x1df)](/(?= --)/),_0x38585c=/(https?:\/\/[^\s]+)/g,_0x396c22=_0x2fd116['match'](_0x38585c)||[];let _0x51a401=_0x2fd116[_0x520533(0x179)](_0x38585c,'')[_0x520533(0x122)]();const _0x216903=await this[_0x520533(0x15b)][_0x520533(0x1ee)](_0x51a401,_0x2ad4a7||_0x520533(0x138)),_0x5026f0=[..._0x396c22,_0x216903]['join']('\x20')[_0x520533(0x122)]();_0x3273cd=_0xe6cde2?''+_0x5026f0+_0xe6cde2:_0x5026f0,_0x3c0bd2==='1'&&_0x3b3005&&(_0x3273cd=_0x3b3005+'\x20'+_0x3273cd);}else _0x3273cd=_0x3c0bd2==='1'&&_0x3b3005?_0x3b3005+'\x20'+_0x51d78a:_0x51d78a;await this[_0x520533(0xf3)][_0x520533(0x1f3)](_0x509b85,_0x2d9d2c,_0x4a836d);const _0x332390=_0x4e0252,_0x435d06=(0x0,utils_1['formatUrl'])(_0x34b57e||_0x58e7df||_0x520533(0x132)),_0x1bd877=_0x3d25bf||_0x15c22a,_0x4c2fee=(_0x33a797||_0x144400||0x12c)*0x3e8,_0x34e8af=Number(_0x1c4e35)||0x1;if(_0x4d80d1){const _0x265aa4=await this[_0x520533(0x142)][_0x520533(0x107)](_0x4d80d1);this[_0x520533(0x124)](_0x4d80d1,_0x265aa4,_0x1c5cb3,_0x51d78a,_0x509b85),await this[_0x520533(0x142)][_0x520533(0x1d5)](_0x4d80d1);}const _0x198aa2=await this['chatLogService'][_0x520533(0x19b)]({'appId':appId,'curIp':_0x3bd6a2,'userId':_0x509b85[_0x520533(0x1ad)]['id'],'type':_0x1c5cb3?_0x1c5cb3:0x1,'prompt':_0x51d78a,'fileInfo':_0x3b3005?_0x3b3005:null,'answer':'','promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x4fb29b,'modelName':'我','role':_0x520533(0x1ad),'groupId':_0x4d80d1?_0x4d80d1:null}),_0x593e34=await this[_0x520533(0x1d2)][_0x520533(0x19b)]({'appId':appId?appId:null,'action':_0x41bab7?_0x41bab7:null,'curIp':_0x3bd6a2,'userId':_0x509b85[_0x520533(0x1ad)]['id'],'type':_0x1c5cb3?_0x1c5cb3:0x1,'prompt':_0x51d78a,'fileInfo':null,'answer':'','progress':'0%','promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x4fb29b,'modelName':_0x332390,'role':_0x520533(0x1bb),'groupId':_0x4d80d1?_0x4d80d1:null,'status':0x2,'modelAvatar':(_0x368cfe===null||_0x368cfe===void 0x0?void 0x0:_0x368cfe['pluginImg'])||_0x414a89||_0x27fc5f||'','pluginParam':(_0x368cfe===null||_0x368cfe===void 0x0?void 0x0:_0x368cfe[_0x520533(0x171)])?_0x368cfe['parameters']:_0x1c5cb3===0x2?_0x4fb29b:null}),_0x10f8e7=_0x198aa2['id'],_0x16de4e=_0x593e34['id'];if(_0x285c59[_0x520533(0x1de)]&&_0x1887fc){if(_0x285c59[_0x520533(0x105)]===0x0){const _0x8f0196=_0x285c59[_0x520533(0x1de)]['split'](''),_0x2b863c=_0x354836=>{const _0x59cfa1=_0x520533;if(_0x354836<_0x8f0196[_0x59cfa1(0x16b)]){const _0x2caeba={'text':_0x8f0196[_0x354836]};_0x1887fc['write'](JSON['stringify'](_0x2caeba)+'\x0a'),setTimeout(()=>_0x2b863c(_0x354836+0x1),0xa);}else _0x1887fc[_0x59cfa1(0x12c)]();};_0x2b863c(0x0),await this['chatLogService'][_0x520533(0x166)](_0x16de4e,{'answer':_0x285c59[_0x520533(0x1de)]});return;}else _0x3f7e21=_0x3f7e21+_0x285c59[_0x520533(0x1de)];}const {messagesHistory:_0x3d5b93}=await this[_0x520533(0x13a)](_0x51d78a,{'groupId':_0x4d80d1,'systemMessage':_0x3f7e21,'maxModelTokens':_0xfb3d66,'maxRounds':_0x4d06d1,'isConvertToBase64':_0x4a8439,'fileInfo':_0x3b3005,'model':_0x4fb29b,'isFileUpload':_0x3c0bd2},this[_0x520533(0x1d2)]);let _0x653e6c=_0x41bab7!=='UPSCALE'&&_0x4fb29b===_0x520533(0x14a)?_0x4a836d*0x4:_0x4a836d;const _0x42cb8f=new AbortController();try{if(_0x1887fc){_0x1887fc['on'](_0x520533(0x1b1),()=>{_0x42cb8f['abort']();});let _0x1d9349,_0x53de25=!![];try{if((_0x4fb29b===_0x520533(0x116)||_0x4fb29b===_0x520533(0x14a)||_0x4fb29b===_0x520533(0xfe)||_0x4fb29b===_0x520533(0x119)||_0x4fb29b==='luma-video'||_0x4fb29b[_0x520533(0x150)](_0x520533(0x11a))||_0x4fb29b['includes'](_0x520533(0x11d))||_0x4fb29b[_0x520533(0x150)](_0x520533(0x1c4)))&&_0x1c5cb3===0x2){if(_0x4fb29b===_0x520533(0x116))_0x1d9349=this[_0x520533(0xee)][_0x520533(0x1f2)]({'prompt':_0x51d78a,'extraParam':_0x3e9e3a,'apiKey':_0x1bd877,'proxyUrl':_0x435d06,'model':_0x4fb29b,'timeout':_0x4c2fee,'modelName':_0x332390,'groupId':_0x4d80d1,'onSuccess':async _0x16cb7d=>{const _0x546e46=_0x520533;await this[_0x546e46(0x1d2)][_0x546e46(0x166)](_0x16de4e,{'fileInfo':_0x16cb7d===null||_0x16cb7d===void 0x0?void 0x0:_0x16cb7d['fileInfo'],'answer':(_0x16cb7d===null||_0x16cb7d===void 0x0?void 0x0:_0x16cb7d[_0x546e46(0x1de)])||_0x51d78a,'progress':_0x546e46(0x112),'status':_0x16cb7d[_0x546e46(0x19c)]});},'onFailure':async _0x75dc0b=>{const _0x529a43=_0x520533;await this['chatLogService'][_0x529a43(0x166)](_0x16de4e,{'answer':_0x529a43(0x14f),'status':_0x75dc0b['status']});}},this[_0x520533(0x13a)]),await this['chatLogService'][_0x520533(0x166)](_0x16de4e,{'answer':_0x520533(0x198)});else{if(_0x4fb29b===_0x520533(0xfe))common_1['Logger'][_0x520533(0x136)](_0x520533(0x131),_0x520533(0x164)),_0x1d9349=this[_0x520533(0x109)][_0x520533(0x1ba)]({'usePrompt':_0x3273cd,'prompt':_0x51d78a,'apiKey':_0x1bd877,'proxyUrl':_0x435d06,'model':_0x4fb29b,'modelName':_0x332390,'drawId':_0x182350,'customId':_0xd164a6,'action':_0x41bab7,'timeout':_0x4c2fee,'assistantLogId':_0x16de4e,'extraParam':_0x3e9e3a,'fileInfo':_0x3b3005}),await this[_0x520533(0x1d2)][_0x520533(0x166)](_0x16de4e,{'answer':_0x520533(0x1d7)});else{if(_0x4fb29b[_0x520533(0x150)](_0x520533(0x1c4)))_0x1d9349=this[_0x520533(0x12a)][_0x520533(0x165)]({'prompt':_0x51d78a,'extraParam':_0x3e9e3a,'apiKey':_0x1bd877,'proxyUrl':_0x435d06,'model':_0x4fb29b,'timeout':_0x4c2fee,'modelName':_0x332390,'groupId':_0x4d80d1,'onSuccess':async _0x55f983=>{const _0x339014=_0x520533;await this['chatLogService'][_0x339014(0x166)](_0x16de4e,{'fileInfo':_0x55f983===null||_0x55f983===void 0x0?void 0x0:_0x55f983['fileInfo'],'answer':(_0x55f983===null||_0x55f983===void 0x0?void 0x0:_0x55f983['answer'])||_0x51d78a,'progress':_0x339014(0x112),'status':_0x55f983[_0x339014(0x19c)]});},'onFailure':async _0x324107=>{const _0x1f69fb=_0x520533;await this[_0x1f69fb(0x1d2)][_0x1f69fb(0x166)](_0x16de4e,{'answer':_0x1f69fb(0x14f),'status':_0x324107[_0x1f69fb(0x19c)]});}},this[_0x520533(0x13a)]),await this[_0x520533(0x1d2)][_0x520533(0x166)](_0x16de4e,{'answer':_0x520533(0x198)});else{if(_0x4fb29b[_0x520533(0x150)]('suno-music'))_0x1d9349=this[_0x520533(0x1e2)][_0x520533(0x159)]({'assistantLogId':_0x16de4e,'apiKey':_0x1bd877,'action':_0x41bab7,'prompt':_0x51d78a,'timeout':_0x4c2fee,'proxyUrl':_0x435d06,'taskData':_0xd164a6}),await this[_0x520533(0x1d2)]['updateChatLog'](_0x16de4e,{'answer':_0x520533(0x1cd)});else{if(_0x4fb29b[_0x520533(0x150)](_0x520533(0x1db)))_0x1d9349=this[_0x520533(0x1e7)][_0x520533(0x1a1)]({'fileInfo':_0x3b3005,'extraParam':_0x3e9e3a,'assistantLogId':_0x16de4e,'apiKey':_0x1bd877,'action':_0x41bab7,'prompt':_0x51d78a,'model':_0x4fb29b,'timeout':_0x4c2fee,'proxyUrl':_0x435d06,'taskData':_0xd164a6,'onGenerate':async _0x5562d1=>{const _0x3197ba=_0x520533;await this['chatLogService'][_0x3197ba(0x166)](_0x16de4e,{'fileInfo':_0x5562d1===null||_0x5562d1===void 0x0?void 0x0:_0x5562d1[_0x3197ba(0x1a4)],'answer':(_0x5562d1===null||_0x5562d1===void 0x0?void 0x0:_0x5562d1['answer'])||_0x51d78a,'status':0x2});},'onSuccess':async _0x5d213c=>{const _0x33a015=_0x520533;await this['chatLogService'][_0x33a015(0x166)](_0x16de4e,{'fileInfo':_0x5d213c===null||_0x5d213c===void 0x0?void 0x0:_0x5d213c[_0x33a015(0x1a4)],'answer':(_0x5d213c===null||_0x5d213c===void 0x0?void 0x0:_0x5d213c[_0x33a015(0x1de)])||_0x51d78a,'progress':_0x33a015(0x112),'status':0x3});},'onFailure':async _0x1fccbc=>{const _0x2b8553=_0x520533;await this[_0x2b8553(0x1d2)]['updateChatLog'](_0x16de4e,{'answer':_0x1fccbc[_0x2b8553(0x120)],'status':0x4});}}),await this[_0x520533(0x1d2)][_0x520533(0x166)](_0x16de4e,{'answer':_0x520533(0x1b8)});else{if(_0x4fb29b['includes'](_0x520533(0x11d)))_0x1d9349=this['cogVideoService'][_0x520533(0x10b)]({'fileInfo':_0x3b3005,'extraParam':_0x3e9e3a,'assistantLogId':_0x16de4e,'apiKey':_0x1bd877,'action':_0x41bab7,'prompt':_0x51d78a,'model':_0x4fb29b,'timeout':_0x4c2fee,'proxyUrl':_0x435d06,'taskData':_0xd164a6,'onGenerate':async _0x2e7ab7=>{const _0x23a31c=_0x520533;await this[_0x23a31c(0x1d2)][_0x23a31c(0x166)](_0x16de4e,{'fileInfo':_0x2e7ab7===null||_0x2e7ab7===void 0x0?void 0x0:_0x2e7ab7[_0x23a31c(0x1a4)],'answer':(_0x2e7ab7===null||_0x2e7ab7===void 0x0?void 0x0:_0x2e7ab7['answer'])||_0x51d78a,'status':0x2});},'onSuccess':async _0x1d9989=>{const _0x38bb8f=_0x520533;await this['chatLogService'][_0x38bb8f(0x166)](_0x16de4e,{'fileInfo':_0x1d9989===null||_0x1d9989===void 0x0?void 0x0:_0x1d9989[_0x38bb8f(0x1a4)],'answer':(_0x1d9989===null||_0x1d9989===void 0x0?void 0x0:_0x1d9989[_0x38bb8f(0x1de)])||_0x51d78a,'progress':_0x38bb8f(0x112),'status':0x3});},'onFailure':async _0x3ad6ea=>{const _0x5868f3=_0x520533;await this['chatLogService']['updateChatLog'](_0x16de4e,{'answer':_0x3ad6ea[_0x5868f3(0x120)],'status':0x4});}}),await this[_0x520533(0x1d2)][_0x520533(0x166)](_0x16de4e,{'answer':_0x520533(0x1b8)});else _0x4fb29b[_0x520533(0x150)]('stable-diffusion')?(_0x1d9349=this[_0x520533(0xf1)][_0x520533(0x19f)]({'chatId':_0x16de4e,'maxModelTokens':_0xfb3d66,'apiKey':_0x1bd877,'model':_0x4fb29b,'modelName':_0x332390,'modelType':_0x1c5cb3,'prompt':_0x51d78a,'fileInfo':_0x3b3005,'isFileUpload':_0x3c0bd2,'timeout':_0x4c2fee,'proxyUrl':_0x435d06,'onSuccess':async _0x572e04=>{const _0x3b7b64=_0x520533;await this[_0x3b7b64(0x1d2)][_0x3b7b64(0x166)](_0x16de4e,{'fileInfo':_0x572e04===null||_0x572e04===void 0x0?void 0x0:_0x572e04[_0x3b7b64(0x1a4)],'answer':(_0x572e04===null||_0x572e04===void 0x0?void 0x0:_0x572e04[_0x3b7b64(0x1de)])||_0x51d78a,'progress':'100%','status':0x3});},'onFailure':async _0x33967e=>{const _0x2f83aa=_0x520533;await this[_0x2f83aa(0x1d2)][_0x2f83aa(0x166)](_0x16de4e,{'answer':_0x2f83aa(0x1ca),'status':0x4});}}),await this[_0x520533(0x1d2)][_0x520533(0x166)](_0x16de4e,{'answer':_0x520533(0x198)})):(_0x1d9349=await this['midjourneyService'][_0x520533(0x1b5)]({'usePrompt':_0x3273cd,'prompt':_0x51d78a,'apiKey':_0x1bd877,'proxyUrl':_0x435d06,'model':_0x4fb29b,'modelName':_0x332390,'drawId':_0x182350,'customId':_0xd164a6,'action':_0x41bab7,'fileInfo':_0x3b3005,'timeout':_0x4c2fee,'assistantLogId':_0x16de4e,'pluginName':_0x368cfe}),await this[_0x520533(0x1d2)][_0x520533(0x166)](_0x16de4e,{'answer':_0x1d9349[_0x520533(0x1de)],'status':_0x1d9349[_0x520533(0x19c)]}));}}}}}_0x1d9349['status']!==0x5?(await this[_0x520533(0x130)][_0x520533(0x11e)](_0x35ea24,0x1),await this[_0x520533(0xf3)][_0x520533(0x186)](_0x509b85[_0x520533(0x1ad)]['id'],_0x2d9d2c,_0x653e6c)):common_1[_0x520533(0x10e)][_0x520533(0x136)](_0x520533(0x168),'ChatService');const _0xc2fe2=await this['userBalanceService']['queryUserBalance'](_0x509b85[_0x520533(0x1ad)]['id']);return _0x1d9349[_0x520533(0x127)]=Object[_0x520533(0x10c)]({},_0xc2fe2),_0x1d9349[_0x520533(0x10a)]=_0x1d9349[_0x520533(0x1de)],_0x1d9349[_0x520533(0x19c)]=_0x1d9349[_0x520533(0x19c)]||0x2,_0x1d9349[_0x520533(0x1b7)]=_0x367427,_0x1d9349[_0x520533(0x1c7)]=_0x4e0252,_0x1887fc[_0x520533(0x1a7)]('\x0a'+JSON[_0x520533(0x161)](_0x1d9349));}else{_0x1d9349=await this[_0x520533(0x15b)][_0x520533(0x12d)](_0x3d5b93,{'chatId':_0x16de4e,'maxModelTokens':_0xfb3d66,'apiKey':_0x1bd877,'model':_0x4fb29b,'modelName':_0x332390,'temperature':_0x34e8af,'modelType':_0x1c5cb3,'prompt':_0x51d78a,'fileInfo':_0x3b3005,'isFileUpload':_0x3c0bd2,'timeout':_0x4c2fee,'proxyUrl':_0x435d06,'modelAvatar':_0x27fc5f,'onProgress':_0x68b0e6=>{const _0x57d71d=_0x520533;_0x1887fc['write'](_0x53de25?JSON['stringify'](_0x68b0e6):'\x0a'+JSON[_0x57d71d(0x161)](_0x68b0e6)),_0x53de25=![];},'onFailure':async _0x240b19=>{const _0x4198d4=_0x520533;await this[_0x4198d4(0x1d2)]['updateChatLog'](_0x16de4e,{'answer':_0x240b19['errMsg'],'status':0x4});},'abortController':_0x42cb8f});if(_0x1d9349['errMsg'])return common_1[_0x520533(0x10e)][_0x520533(0x106)](_0x520533(0x197)+_0x509b85['user']['id']+_0x520533(0x199)+_0x332390+_0x520533(0xf5)+_0x367427+_0x520533(0x1a0),_0x520533(0x1a8)),_0x1887fc['write']('\x0a'+JSON[_0x520533(0x161)](_0x1d9349));let _0x55791d='';_0x3d5b93[_0x520533(0x18e)](_0x3ca0ce=>{const _0x35a4ca=_0x520533;_0x55791d+=_0x3ca0ce[_0x35a4ca(0x187)]+'\x20';});const _0x3bfb08=await(0x0,utils_1[_0x520533(0x157)])(_0x55791d),_0x433b45=await(0x0,utils_1[_0x520533(0x157)])(_0x1d9349[_0x520533(0x1de)]);await this[_0x520533(0x1d2)][_0x520533(0x166)](_0x10f8e7,{'promptTokens':_0x3bfb08,'completionTokens':_0x433b45,'totalTokens':_0x3bfb08+_0x433b45});let _0x636781=_0x1d9349[_0x520533(0x1de)];if(_0x598118==='1'){const _0x5d2e9b=await this[_0x520533(0x13f)][_0x520533(0x117)](_0x1d9349[_0x520533(0x1de)],_0x509b85[_0x520533(0x1ad)]['id']);if(_0x5d2e9b[_0x520533(0x16b)]>0x0){const _0x39f280=new RegExp(_0x5d2e9b[_0x520533(0x149)]('|'),'gi');_0x636781=_0x636781[_0x520533(0x179)](_0x39f280,_0x5e06f7=>'*'['repeat'](_0x5e06f7[_0x520533(0x16b)]));}}await this[_0x520533(0x1d2)]['updateChatLog'](_0x16de4e,{'fileInfo':_0x1d9349===null||_0x1d9349===void 0x0?void 0x0:_0x1d9349['fileInfo'],'answer':_0x636781,'promptTokens':_0x3bfb08,'completionTokens':_0x433b45,'totalTokens':_0x3bfb08+_0x433b45,'status':0x3});try{if(_0x1cd741==='1'){const _0x5107d8=await this[_0x520533(0x15b)]['chatFree']('根据用户提问{'+_0x51d78a+_0x520533(0x14b)+_0x1d9349['answer']+_0x520533(0x1b0));await this['chatLogService'][_0x520533(0x166)](_0x16de4e,{'promptReference':_0x5107d8});}}catch(_0x934c97){common_1[_0x520533(0x10e)][_0x520533(0x106)](_0x520533(0x1b6)+_0x934c97);}_0xc28530===!![]&&(_0x653e6c=_0x4a836d*Math['ceil']((_0x3bfb08+_0x433b45)/_0x36bf26));await this[_0x520533(0xf3)]['deductFromBalance'](_0x509b85[_0x520533(0x1ad)]['id'],_0x2d9d2c,_0x653e6c,_0x3bfb08+_0x433b45),await this['modelsService'][_0x520533(0x11e)](_0x35ea24,_0x3bfb08+_0x433b45),common_1[_0x520533(0x10e)]['log']('用户ID:\x20'+_0x509b85[_0x520533(0x1ad)]['id']+_0x520533(0x199)+_0x332390+_0x520533(0xf5)+_0x367427+_0x520533(0x1c5)+(_0x3bfb08+_0x433b45)+_0x520533(0x1a2)+_0x653e6c,'ChatService');const _0x12406c=await this[_0x520533(0xf3)][_0x520533(0x1cb)](_0x509b85[_0x520533(0x1ad)]['id']);return _0x1d9349[_0x520533(0x127)]=Object[_0x520533(0x10c)]({},_0x12406c),_0x1887fc[_0x520533(0x1a7)]('\x0a'+JSON[_0x520533(0x161)](_0x1d9349));}}catch(_0x4db3e4){common_1[_0x520533(0x10e)][_0x520533(0x106)]('发生错误:',_0x4db3e4),await this['chatLogService'][_0x520533(0x166)](_0x16de4e,{'status':0x5}),_0x1d9349={'error':_0x520533(0x15f)};}}else return _0x54929e=await this[_0x520533(0x15b)][_0x520533(0x12d)](_0x3d5b93,{'chatId':_0x16de4e,'maxModelTokens':_0xfb3d66,'apiKey':_0x1bd877,'model':_0x4fb29b,'modelName':_0x332390,'modelType':_0x1c5cb3,'temperature':_0x34e8af,'prompt':_0x51d78a,'fileInfo':_0x3b3005,'isFileUpload':_0x3c0bd2,'timeout':_0x4c2fee,'proxyUrl':_0x435d06,'abortController':_0x42cb8f}),await this[_0x520533(0xf3)][_0x520533(0x186)](_0x509b85[_0x520533(0x1ad)]['id'],_0x2d9d2c,_0x653e6c),_0x54929e['answer'];}catch(_0x35ae20){common_1[_0x520533(0x10e)]['error'](_0x520533(0x176),_0x1bd877,_0x35ae20);if(_0x1887fc)return _0x1887fc[_0x520533(0x1a7)](_0x520533(0x1d9));else throw new common_1[(_0x520533(0x1f1))]('发生未知错误，请稍后再试',common_1[_0x520533(0x10d)]['BAD_REQUEST']);}finally{_0x1887fc&&_0x1887fc[_0x520533(0x12c)]();}}async[_0x862396(0x104)](_0x43de5e,_0x5dc45a){const _0x35717a=_0x862396,{pluginUrl:_0x4f3491,pluginKey:_0x3652bc}=await this[_0x35717a(0x1ec)][_0x35717a(0x121)](['pluginUrl','pluginKey']),_0x1467cc=_0x3652bc,_0x4807f8=_0x4f3491,_0x1a49ef={'method':_0x35717a(0x188),'url':_0x4807f8+_0x35717a(0x1e8)+_0x5dc45a,'headers':{'Content-Type':_0x35717a(0x19a),'Authorization':_0x35717a(0x1b9)+_0x1467cc},'data':{'prompt':_0x43de5e}};try{const _0xf16552=await(0x0,axios_1[_0x35717a(0x1aa)])(_0x1a49ef);return common_1[_0x35717a(0x10e)][_0x35717a(0x136)](_0x35717a(0x170)+JSON['stringify'](_0xf16552[_0x35717a(0x169)],null,0x2),_0x35717a(0x11b)),_0xf16552[_0x35717a(0x169)][_0x35717a(0x10a)];}catch(_0x1f60bb){common_1['Logger'][_0x35717a(0x106)](_0x35717a(0x141),_0x1f60bb);}}async[_0x862396(0x124)](_0x18f864,_0x3d5e22,_0x4e943f,_0x23f4e4,_0x421756){const _0x2a304f=_0x862396;if((_0x3d5e22===null||_0x3d5e22===void 0x0?void 0x0:_0x3d5e22[_0x2a304f(0x18d)])===_0x2a304f(0x145)){let _0xa79d73;if(_0x4e943f===0x1)try{_0xa79d73=await this['openAIChatService']['chatFree']('根据用户提问{'+_0x23f4e4+_0x2a304f(0x15a)),_0xa79d73['length']>0xf&&(_0xa79d73=_0xa79d73[_0x2a304f(0x152)](0x0,0xf));}catch(_0x33559c){common_1[_0x2a304f(0x10e)][_0x2a304f(0x106)]('调用\x20chatFree\x20出错:\x20'+_0x33559c),_0xa79d73=_0x23f4e4[_0x2a304f(0x152)](0x0,0xa);}else _0xa79d73=_0x2a304f(0x102);this[_0x2a304f(0x142)][_0x2a304f(0x177)]({'groupId':_0x18f864,'title':_0xa79d73,'isSticky':![],'config':'','fileUrl':''},_0x421756)['then'](()=>common_1[_0x2a304f(0x10e)][_0x2a304f(0x136)]('更新标题名称为:\x20'+_0xa79d73,_0x2a304f(0x1a8)))['catch'](_0x3108fe=>common_1['Logger']['error']('更新对话组标题失败:\x20'+_0x3108fe));}}async[_0x862396(0x13a)](_0x41f716,_0x5c5e5a,_0x301302){const _0xf30775=_0x862396;let {systemMessage:systemMessage='',fileInfo:_0x33fe51,groupId:_0x3f5160,maxRounds:maxRounds=0x5,maxModelTokens:maxModelTokens=0x1f40,isFileUpload:isFileUpload=0x0,isConvertToBase64:_0x5427c3}=_0x5c5e5a;systemMessage[_0xf30775(0x16b)]>maxModelTokens&&(common_1[_0xf30775(0x10e)][_0xf30775(0x136)]('系统消息超过最大长度，将被截断',_0xf30775(0x1a8)),systemMessage=systemMessage[_0xf30775(0x152)](0x0,maxModelTokens));let _0x419d8c=[];systemMessage&&_0x419d8c[_0xf30775(0x1e1)]({'role':_0xf30775(0x1bf),'content':systemMessage});if(_0x3f5160){const _0x467ab0=await _0x301302['chatHistory'](_0x3f5160,maxRounds);let _0x166851=null;for(const _0x5449c3 of _0x467ab0){try{let _0x26e6fc;if((isFileUpload===0x2||isFileUpload===0x3)&&_0x5449c3[_0xf30775(0x1a4)]&&_0x5449c3[_0xf30775(0x18b)]===_0xf30775(0x1ad)){const _0xa1494f=await Promise[_0xf30775(0xf4)](_0x5449c3[_0xf30775(0x1a4)]['split'](',')['map'](async _0x2ce18b=>({'type':_0xf30775(0x1ef),'image_url':{'url':_0x5427c3==='1'?await this[_0xf30775(0x13e)](_0x2ce18b[_0xf30775(0x122)]()):_0x2ce18b['trim']()}})));_0x26e6fc=[{'type':'text','text':_0x5449c3['text']},..._0xa1494f];}else isFileUpload===0x1&&_0x5449c3['fileInfo']&&_0x5449c3[_0xf30775(0x18b)]===_0xf30775(0x1ad)?_0x26e6fc=_0x5449c3['fileInfo']+'\x0a'+_0x5449c3[_0xf30775(0x10a)]:_0x26e6fc=_0x5449c3[_0xf30775(0x10a)];if(_0x5449c3[_0xf30775(0x18b)]==='user')_0x166851={'role':_0x5449c3[_0xf30775(0x18b)],'content':_0x26e6fc};else{if(_0x5449c3[_0xf30775(0x18b)]===_0xf30775(0x1bb)){const _0x3da478=Array[_0xf30775(0x190)](_0x26e6fc)?JSON['stringify'](_0x26e6fc):_0x26e6fc;_0x166851&&_0x3da478[_0xf30775(0x122)]()!==''&&(_0x419d8c[_0xf30775(0x1e1)](_0x166851),_0x419d8c[_0xf30775(0x1e1)]({'role':_0x5449c3['role'],'content':_0x26e6fc}),_0x166851=null);}}}catch(_0x2eca75){common_1['Logger'][_0xf30775(0x106)](_0xf30775(0x128),_0x2eca75,_0xf30775(0x114),JSON[_0xf30775(0x161)](_0x5449c3,null,0x2));}}}let _0x438265;if((isFileUpload===0x2||isFileUpload===0x3)&&_0x33fe51){const _0x1e5232=await Promise[_0xf30775(0xf4)](_0x33fe51[_0xf30775(0x1df)](',')[_0xf30775(0x162)](async _0x26dce3=>({'type':_0xf30775(0x1ef),'image_url':{'url':_0x5427c3==='1'?await this[_0xf30775(0x13e)](_0x26dce3[_0xf30775(0x122)]()):_0x26dce3[_0xf30775(0x122)]()}})));_0x438265=[{'type':_0xf30775(0x10a),'text':_0x41f716},..._0x1e5232];}else isFileUpload===0x1&&_0x33fe51?_0x438265=_0x33fe51+'\x0a'+_0x41f716:_0x438265=_0x41f716;_0x419d8c[_0xf30775(0x1e1)]({'role':_0xf30775(0x1ad),'content':_0x438265});let _0x2f723b=await(0x0,utils_1[_0xf30775(0x157)])(_0x419d8c),_0x65623c;maxModelTokens<0x1f40?_0x65623c=0xfa0:_0x65623c=maxModelTokens-0xfa0;while(_0x2f723b>_0x65623c){if(_0x419d8c[_0xf30775(0x16b)]===0x2&&_0x419d8c[0x0][_0xf30775(0x18b)]===_0xf30775(0x1bf)&&_0x419d8c[0x1]['role']===_0xf30775(0x1ad))break;let _0x4602b1=![];for(let _0x23ffcd=0x0;_0x23ffcd<_0x419d8c[_0xf30775(0x16b)];_0x23ffcd++){if(_0x419d8c[_0x23ffcd]['role']!==_0xf30775(0x1bf)&&_0x419d8c[_0x23ffcd+0x1]&&_0x419d8c[_0x23ffcd+0x1][_0xf30775(0x18b)]===_0xf30775(0x1bb)){_0x419d8c[_0xf30775(0x185)](_0x23ffcd,0x2),_0x4602b1=!![];break;}}if(!_0x4602b1)for(let _0x5cc5cd=0x0;_0x5cc5cd<_0x419d8c[_0xf30775(0x16b)];_0x5cc5cd++){if(_0x419d8c[_0x5cc5cd][_0xf30775(0x18b)]===_0xf30775(0x1ad)){_0x419d8c['splice'](_0x5cc5cd,0x1);break;}}_0x2f723b=await(0x0,utils_1[_0xf30775(0x157)])(_0x419d8c);if(_0x419d8c[_0xf30775(0x16b)]<=0x2)break;}return{'messagesHistory':_0x419d8c,'round':_0x419d8c[_0xf30775(0x16b)]};}async[_0x862396(0x13e)](_0x2ade7f){const _0x2c3d70=_0x862396;try{console['log']('正在尝试转换URL为Base64:\x20'+_0x2ade7f);const _0x2c1ce6=await axios_1[_0x2c3d70(0x1aa)][_0x2c3d70(0x195)](_0x2ade7f,{'responseType':_0x2c3d70(0x1b2)}),_0x4f9ff4=Buffer[_0x2c3d70(0x1c0)](_0x2c1ce6[_0x2c3d70(0x169)],_0x2c3d70(0x1d6));console['log'](_0x2c3d70(0x101)+_0x2ade7f);const _0x33a259=_0x2c3d70(0x100)+_0x2c1ce6[_0x2c3d70(0x17c)][_0x2c3d70(0x191)]+_0x2c3d70(0xf0)+_0x4f9ff4[_0x2c3d70(0x19d)](_0x2c3d70(0xf6));return console[_0x2c3d70(0x136)](_0x2c3d70(0x18c)+_0x2ade7f),_0x33a259;}catch(_0xee3c4b){return console[_0x2c3d70(0x106)](_0x2c3d70(0x1be),_0xee3c4b),console[_0x2c3d70(0x103)](_0x2c3d70(0x1d3)+_0x2ade7f),_0x2ade7f;}}async['ttsProcess'](_0x24a409,_0xf8eca8,_0x5b7845){const _0x535c73=_0x862396,{chatId:_0x79ddf,prompt:_0x234039}=_0x24a409,_0x2cfc48=await this['modelsService']['getCurrentModelKeyInfo'](_0x535c73(0x14d)),{openaiTimeout:_0x25c5b4,openaiBaseUrl:_0xf7f5da,openaiBaseKey:_0x576fca,openaiVoice:_0x4c8b97}=await this['globalConfigService'][_0x535c73(0x121)]([_0x535c73(0x160),_0x535c73(0x17a),_0x535c73(0x115),_0x535c73(0x182)]),{key:_0x5cd6da,proxyUrl:_0x2fae84,deduct:_0x1531d3,deductType:_0x59e4f5,timeout:_0x1aa8c3}=_0x2cfc48,_0x12ccd2=_0x5cd6da||_0x576fca,_0x325f28=(0x0,utils_1[_0x535c73(0x1cc)])(_0x2fae84||_0xf7f5da),_0x523ac6=(_0x1aa8c3||_0x25c5b4)*0x3e8;await this[_0x535c73(0xf3)][_0x535c73(0x1f3)](_0xf8eca8,_0x59e4f5,_0x1531d3),common_1[_0x535c73(0x10e)][_0x535c73(0x136)](_0x535c73(0x1c9),_0x234039,_0x535c73(0x1bd));const _0x3b6c86={'method':_0x535c73(0x188),'url':_0x325f28+_0x535c73(0x134),'headers':{'Content-Type':_0x535c73(0x19a),'Authorization':'Bearer\x20'+_0x12ccd2},'responseType':'arraybuffer','timeout':_0x523ac6,'data':{'model':_0x535c73(0x14d),'input':_0x234039,'voice':_0x4c8b97||_0x535c73(0x1a3)}};try{const _0x56b9b7=await(0x0,axios_1[_0x535c73(0x1aa)])(_0x3b6c86);common_1[_0x535c73(0x10e)]['log'](_0x535c73(0x118),'TTSService');const _0x3ef578=Buffer[_0x535c73(0x1c0)](_0x56b9b7[_0x535c73(0x169)]),_0x1a8efe=new Date(),_0x2a5d8d=_0x1a8efe[_0x535c73(0x137)](),_0xba7271=String(_0x1a8efe['getMonth']()+0x1)['padStart'](0x2,'0'),_0x2ead46=String(_0x1a8efe[_0x535c73(0x1da)]())[_0x535c73(0x139)](0x2,'0'),_0x32c411=''+_0x2a5d8d+_0xba7271+'/'+_0x2ead46,_0x39a131=await this[_0x535c73(0x147)][_0x535c73(0x1e9)]({'buffer':_0x3ef578,'mimetype':_0x535c73(0x11f)},'audio/openai/'+_0x32c411);await Promise[_0x535c73(0xf4)]([this['chatLogService'][_0x535c73(0x166)](_0x79ddf,{'ttsUrl':_0x39a131}),this[_0x535c73(0xf3)]['deductFromBalance'](_0xf8eca8[_0x535c73(0x1ad)]['id'],_0x59e4f5,_0x1531d3)]),_0x5b7845[_0x535c73(0x19c)](0xc8)[_0x535c73(0x172)]({'ttsUrl':_0x39a131});}catch(_0x311346){common_1[_0x535c73(0x10e)]['error'](_0x535c73(0x1cf),_0x311346,'TTSService'),_0x5b7845[_0x535c73(0x19c)](0x1f4)[_0x535c73(0x172)]({'error':_0x535c73(0x180)});}}};ChatService=__decorate([(0x0,common_1[_0x862396(0x1c3)])(),__param(0x0,(0x0,typeorm_1[_0x862396(0x178)])(config_entity_1[_0x862396(0x196)])),__param(0x1,(0x0,typeorm_1[_0x862396(0x178)])(app_entity_1[_0x862396(0x14c)])),__param(0x2,(0x0,typeorm_1[_0x862396(0x178)])(plugin_entity_1[_0x862396(0x143)])),__metadata(_0x862396(0xf9),[typeorm_2[_0x862396(0x158)],typeorm_2[_0x862396(0x158)],typeorm_2[_0x862396(0x158)],suno_service_1[_0x862396(0x1e4)],openaiChat_service_1[_0x862396(0x163)],chatLog_service_1[_0x862396(0x1d0)],midjourneyDraw_service_1['MidjourneyService'],stableDiffusion_service_1[_0x862396(0xfd)],userBalance_service_1['UserBalanceService'],user_service_1['UserService'],upload_service_1['UploadService'],badWords_service_1['BadWordsService'],autoreply_service_1[_0x862396(0x181)],globalConfig_service_1['GlobalConfigService'],chatGroup_service_1['ChatGroupService'],models_service_1[_0x862396(0x17f)],openaiDraw_service_1['OpenAIDrawService'],lumaVideo_service_1[_0x862396(0x16f)],cogVideo_service_1[_0x862396(0x1a5)],fluxDraw_service_1[_0x862396(0x192)],aiPPT_1[_0x862396(0x183)]])],ChatService),exports[_0x862396(0x1a8)]=ChatService;