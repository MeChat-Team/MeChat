'use strict';const _0x2f54cc=_0x2b8f;(function(_0x50c0eb,_0x2ff4a1){const _0x524e7a=_0x2b8f,_0xb0c099=_0x50c0eb();while(!![]){try{const _0x469b1d=-parseInt(_0x524e7a(0x158))/0x1*(parseInt(_0x524e7a(0x14e))/0x2)+-parseInt(_0x524e7a(0xe0))/0x3+-parseInt(_0x524e7a(0x105))/0x4+-parseInt(_0x524e7a(0x143))/0x5+-parseInt(_0x524e7a(0x10d))/0x6*(-parseInt(_0x524e7a(0xea))/0x7)+parseInt(_0x524e7a(0x101))/0x8*(-parseInt(_0x524e7a(0x10a))/0x9)+parseInt(_0x524e7a(0x124))/0xa;if(_0x469b1d===_0x2ff4a1)break;else _0xb0c099['push'](_0xb0c099['shift']());}catch(_0x492ee8){_0xb0c099['push'](_0xb0c099['shift']());}}}(_0xe735,0x8bf22));function _0x2b8f(_0x2a6443,_0x21fb0e){const _0xe7350d=_0xe735();return _0x2b8f=function(_0x2b8fc8,_0x5f3d8b){_0x2b8fc8=_0x2b8fc8-0xcd;let _0x7942f1=_0xe7350d[_0x2b8fc8];return _0x7942f1;},_0x2b8f(_0x2a6443,_0x21fb0e);}var __decorate=this&&this[_0x2f54cc(0xe6)]||function(_0x467f64,_0xfd8d99,_0x992e39,_0x2274c0){const _0x2eb7fd=_0x2f54cc;var _0x1a298d=arguments['length'],_0x43ff99=_0x1a298d<0x3?_0xfd8d99:_0x2274c0===null?_0x2274c0=Object[_0x2eb7fd(0x13b)](_0xfd8d99,_0x992e39):_0x2274c0,_0x5a9953;if(typeof Reflect===_0x2eb7fd(0xde)&&typeof Reflect[_0x2eb7fd(0x111)]===_0x2eb7fd(0x138))_0x43ff99=Reflect[_0x2eb7fd(0x111)](_0x467f64,_0xfd8d99,_0x992e39,_0x2274c0);else{for(var _0x495786=_0x467f64['length']-0x1;_0x495786>=0x0;_0x495786--)if(_0x5a9953=_0x467f64[_0x495786])_0x43ff99=(_0x1a298d<0x3?_0x5a9953(_0x43ff99):_0x1a298d>0x3?_0x5a9953(_0xfd8d99,_0x992e39,_0x43ff99):_0x5a9953(_0xfd8d99,_0x992e39))||_0x43ff99;}return _0x1a298d>0x3&&_0x43ff99&&Object[_0x2eb7fd(0x125)](_0xfd8d99,_0x992e39,_0x43ff99),_0x43ff99;},__metadata=this&&this[_0x2f54cc(0x121)]||function(_0x4e3dec,_0x112511){const _0xf02a73=_0x2f54cc;if(typeof Reflect===_0xf02a73(0xde)&&typeof Reflect['metadata']==='function')return Reflect[_0xf02a73(0x147)](_0x4e3dec,_0x112511);},__param=this&&this['__param']||function(_0x5a181b,_0x5484a6){return function(_0x1ed6f3,_0x395a8e){_0x5484a6(_0x1ed6f3,_0x395a8e,_0x5a181b);};};Object[_0x2f54cc(0x125)](exports,'__esModule',{'value':!![]}),exports[_0x2f54cc(0xe3)]=void 0x0;const balance_constant_1=require(_0x2f54cc(0xf1)),utils_1=require(_0x2f54cc(0x107)),common_1=require('@nestjs/common'),typeorm_1=require(_0x2f54cc(0x11a)),exceljs_1=require(_0x2f54cc(0x12c)),typeorm_2=require('typeorm'),chatGroup_entity_1=require('../chatGroup/chatGroup.entity'),user_entity_1=require(_0x2f54cc(0x156)),chatLog_entity_1=require(_0x2f54cc(0xdc)),models_service_1=require(_0x2f54cc(0xe5));let ChatLogService=class ChatLogService{constructor(_0x160708,_0x6be0e4,_0x2a5b60,_0xcc43cc){const _0x17e45b=_0x2f54cc;this[_0x17e45b(0x12e)]=_0x160708,this[_0x17e45b(0xd0)]=_0x6be0e4,this[_0x17e45b(0xf3)]=_0x2a5b60,this[_0x17e45b(0x136)]=_0xcc43cc;}async[_0x2f54cc(0xdf)](_0x557888){const _0x260172=await this['chatLogEntity']['save'](_0x557888);return _0x260172;}async[_0x2f54cc(0x120)](_0x57223b,_0x248af3){const _0x1893c4=_0x2f54cc;return await this[_0x1893c4(0x12e)][_0x1893c4(0xd8)]({'id':_0x57223b},_0x248af3);}async[_0x2f54cc(0x112)](_0x4b6961){const _0x4cd138=_0x2f54cc;return await this[_0x4cd138(0x12e)][_0x4cd138(0x137)]({'where':{'id':_0x4b6961}});}async[_0x2f54cc(0x144)](_0x4abd08,_0x1ede4c){const _0xfa71cd=_0x2f54cc,{id:_0x5f38fb}=_0x4abd08['user'],{model:_0x341431}=_0x1ede4c,_0x6c666a={'userId':_0x5f38fb,'type':balance_constant_1[_0xfa71cd(0x114)][_0xfa71cd(0xf0)]};_0x341431&&(_0x6c666a[_0xfa71cd(0xed)]=_0x341431,_0x341431===_0xfa71cd(0x14b)&&(_0x6c666a[_0xfa71cd(0xed)]=(0x0,typeorm_2['In'])([_0xfa71cd(0x14b),_0xfa71cd(0x12b)])));const _0x5a7642=await this[_0xfa71cd(0x12e)][_0xfa71cd(0x115)]({'where':_0x6c666a,'order':{'id':'DESC'},'select':['id',_0xfa71cd(0x149),_0xfa71cd(0x103),'model',_0xfa71cd(0xf4),_0xfa71cd(0x10e)]});return _0x5a7642['forEach'](_0x2232db=>{const _0x30fe1c=_0xfa71cd;if(_0x2232db[_0x30fe1c(0xf4)]===_0x30fe1c(0xe1)){const _0x233d8b=_0x2232db['model']==='mj'?0x136:0xa0,_0x5b5434=_0x2232db[_0x30fe1c(0x149)][_0x30fe1c(0x13f)]('cos')?_0x30fe1c(0x116):'ali',_0x2ed027=_0x5b5434===_0x30fe1c(0x116)?_0x30fe1c(0x129)+_0x233d8b+_0x30fe1c(0x12a):_0x30fe1c(0xd2)+_0x233d8b;_0x2232db[_0x30fe1c(0x123)]=_0x2232db[_0x30fe1c(0x149)]+_0x2ed027;try{_0x2232db[_0x30fe1c(0x10e)]=_0x2232db[_0x30fe1c(0x10e)]?JSON[_0x30fe1c(0x134)](_0x2232db['fileInfo']):null;}catch(_0x201070){_0x2232db['fileInfo']={};}}}),_0x5a7642;}async[_0x2f54cc(0x100)](_0x1fd59c){const _0x2c1ed1=_0x2f54cc,{page:page=0x1,size:size=0x14,rec:_0x1f0ecc,userId:_0x1de166,model:_0x41d15b}=_0x1fd59c,_0x484754={'type':0x2,'prompt':(0x0,typeorm_2[_0x2c1ed1(0xd5)])(''),'answer':(0x0,typeorm_2['Not'])(''),'fileInfo':(0x0,typeorm_2[_0x2c1ed1(0xd5)])('')};_0x1f0ecc&&Object[_0x2c1ed1(0xf2)](_0x484754,{'rec':_0x1f0ecc}),_0x1de166&&Object[_0x2c1ed1(0xf2)](_0x484754,{'userId':_0x1de166});_0x41d15b?_0x484754[_0x2c1ed1(0xed)]=_0x41d15b:_0x484754[_0x2c1ed1(0xed)]=(0x0,typeorm_2['In'])([_0x2c1ed1(0xf9),_0x2c1ed1(0x12b),_0x2c1ed1(0x102)]);const [_0x31d183,_0x383e5d]=await this[_0x2c1ed1(0x12e)][_0x2c1ed1(0x13e)]({'order':{'id':_0x2c1ed1(0xd6)},'skip':(page-0x1)*size,'take':size,'where':_0x484754}),_0x4da332=_0x31d183['map'](_0x18cb7d=>_0x18cb7d[_0x2c1ed1(0xeb)])[_0x2c1ed1(0x14d)](_0xa17798=>_0xa17798<0x186a0),_0x2c618f=await this[_0x2c1ed1(0xd0)][_0x2c1ed1(0x115)]({'where':{'id':(0x0,typeorm_2['In'])(_0x4da332)},'select':['id',_0x2c1ed1(0xfd),'avatar',_0x2c1ed1(0x150)]});return _0x31d183[_0x2c1ed1(0xe4)](_0x367810=>{const _0x3621dd=_0x2c1ed1;_0x367810[_0x3621dd(0x126)]=_0x2c618f['find'](_0x551a19=>_0x551a19['id']===_0x367810[_0x3621dd(0xeb)]);}),_0x31d183[_0x2c1ed1(0xe4)](_0x270475=>{const _0x3faa39=_0x2c1ed1;var _0x945db0;const _0x5261aa=_0x270475['model']===_0x3faa39(0xf9)?0x136:0xa0,_0x2dcdc6=_0x270475[_0x3faa39(0x149)]['includes'](_0x3faa39(0x152))?_0x3faa39(0x116):_0x3faa39(0x151),_0x43123a=_0x2dcdc6===_0x3faa39(0x116)?'?imageView2/1/w/'+_0x5261aa+'/q/55':_0x3faa39(0xd2)+_0x5261aa;_0x270475['thumbImg']=_0x270475[_0x3faa39(0x149)]+_0x43123a;try{const _0x599a4c=_0x270475[_0x3faa39(0xd7)]?JSON[_0x3faa39(0x134)](_0x270475[_0x3faa39(0xd7)]):null;_0x599a4c&&(_0x599a4c?_0x270475[_0x3faa39(0xdd)]=((_0x945db0=_0x599a4c===null||_0x599a4c===void 0x0?void 0x0:_0x599a4c[_0x3faa39(0x110)][0x0])===null||_0x945db0===void 0x0?void 0x0:_0x945db0[_0x3faa39(0x110)][_0x3faa39(0xce)])===0x5:_0x270475[_0x3faa39(0xdd)]=![]);}catch(_0x3d1db3){console['log']('querAllDrawLog\x20Json\x20parse\x20error',_0x3d1db3);}}),{'rows':_0x31d183,'count':_0x383e5d};}async[_0x2f54cc(0x118)](_0x36a406){const _0x4761bf=_0x2f54cc,{id:_0x540f97}=_0x36a406,_0x38fef3=await this['chatLogEntity'][_0x4761bf(0x137)]({'where':{'id':_0x540f97}});return _0x38fef3;}async[_0x2f54cc(0xf8)](_0x22dc0a){const _0x1b64a6=_0x2f54cc,{id:_0x78c092}=_0x22dc0a,_0x2a218e=await this['chatLogEntity']['findOne']({'where':{'id':_0x78c092,'type':balance_constant_1['ChatType']['PAINT']}});if(!_0x2a218e)throw new common_1[(_0x1b64a6(0xef))](_0x1b64a6(0x117),common_1[_0x1b64a6(0x11f)][_0x1b64a6(0xd9)]);const _0x1cd594=_0x2a218e['rec']===0x1?0x0:0x1,_0xbd9e8a=await this[_0x1b64a6(0x12e)][_0x1b64a6(0xd8)]({'id':_0x78c092},{'rec':_0x1cd594});if(_0xbd9e8a[_0x1b64a6(0x113)]>0x0)return(_0x1cd594?'推荐':_0x1b64a6(0xda))+_0x1b64a6(0x106);throw new common_1[(_0x1b64a6(0xef))](_0x1b64a6(0x11d),common_1[_0x1b64a6(0x11f)]['BAD_REQUEST']);}async['exportExcel'](_0x599ca2,_0x2cea0a){const _0x1ef93c=_0x2f54cc,_0x808b3b={'type':balance_constant_1[_0x1ef93c(0x114)][_0x1ef93c(0x145)]},{page:page=0x1,size:size=0x1e,prompt:_0x488447,email:_0x44c263}=_0x599ca2;_0x488447&&Object[_0x1ef93c(0xf2)](_0x808b3b,{'prompt':(0x0,typeorm_2[_0x1ef93c(0x10f)])('%'+_0x488447+'%')});if(_0x44c263){const _0x1eb947=await this['userEntity'][_0x1ef93c(0x137)]({'where':{'email':_0x44c263}});(_0x1eb947===null||_0x1eb947===void 0x0?void 0x0:_0x1eb947['id'])&&Object[_0x1ef93c(0xf2)](_0x808b3b,{'userId':_0x1eb947['id']});}const [_0x423c63,_0x595ec5]=await this[_0x1ef93c(0x12e)][_0x1ef93c(0x13e)]({'order':{'id':_0x1ef93c(0xd6)},'skip':(page-0x1)*size,'take':size,'where':_0x808b3b}),_0x46b340=_0x423c63[_0x1ef93c(0x140)](_0x91ae3a=>_0x91ae3a[_0x1ef93c(0xeb)]),_0x3386dc=await this['userEntity']['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x46b340)}}),_0x12bfcd=_0x423c63['map'](_0x401a0b=>{const _0x21a05a=_0x1ef93c,_0x36297f=_0x3386dc[_0x21a05a(0x115)](_0x1a1a4f=>_0x1a1a4f['id']===_0x401a0b[_0x21a05a(0xeb)]);return{'username':_0x36297f?_0x36297f[_0x21a05a(0xfd)]:'','email':_0x36297f?_0x36297f[_0x21a05a(0x150)]:'','prompt':_0x401a0b[_0x21a05a(0x103)],'answer':_0x401a0b[_0x21a05a(0x149)],'createdAt':(0x0,utils_1[_0x21a05a(0x12d)])(_0x401a0b[_0x21a05a(0x148)])};}),_0x4577bc=new exceljs_1[(_0x1ef93c(0x133))][(_0x1ef93c(0x154))](),_0x48fc8d=_0x4577bc[_0x1ef93c(0x128)](_0x1ef93c(0x142));_0x48fc8d[_0x1ef93c(0x141)]=[{'header':'用户名','key':_0x1ef93c(0xfd),'width':0x14},{'header':_0x1ef93c(0x14a),'key':_0x1ef93c(0x150),'width':0x14},{'header':'提问时间','key':_0x1ef93c(0x148),'width':0x14},{'header':_0x1ef93c(0x139),'key':'prompt','width':0x50},{'header':_0x1ef93c(0x109),'key':'answer','width':0x96}],_0x12bfcd[_0x1ef93c(0xe4)](_0x5f0d0c=>_0x48fc8d[_0x1ef93c(0x11c)](_0x5f0d0c)),_0x2cea0a[_0x1ef93c(0xdb)](_0x1ef93c(0x153),'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'),_0x2cea0a[_0x1ef93c(0xdb)](_0x1ef93c(0x11b),_0x1ef93c(0xe9)+_0x1ef93c(0x157)),await _0x4577bc[_0x1ef93c(0x14c)][_0x1ef93c(0x10c)](_0x2cea0a),_0x2cea0a[_0x1ef93c(0x10b)]();}async[_0x2f54cc(0x14f)](_0x6793d9,_0x4bc038){const _0x4d077b=_0x2f54cc,{page:page=0x1,size:size=0x14,userId:_0x1dab53,prompt:_0x67b604}=_0x6793d9,_0x4fc41b={'type':balance_constant_1['ChatType']['NORMAL_CHAT'],'prompt':(0x0,typeorm_2['Not'])('')};_0x1dab53&&Object[_0x4d077b(0xf2)](_0x4fc41b,{'userId':_0x1dab53}),_0x67b604&&Object[_0x4d077b(0xf2)](_0x4fc41b,{'prompt':(0x0,typeorm_2['Like'])('%'+_0x67b604+'%')});const [_0x4f3c6f,_0x39a6e4]=await this[_0x4d077b(0x12e)][_0x4d077b(0x13e)]({'order':{'id':_0x4d077b(0xd6)},'skip':(page-0x1)*size,'take':size,'where':_0x4fc41b}),_0x303c1e=_0x4f3c6f[_0x4d077b(0x140)](_0x2168af=>_0x2168af['userId']),_0x365d18=await this[_0x4d077b(0xd0)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x303c1e)},'select':['id',_0x4d077b(0xfd),_0x4d077b(0x150)]});return _0x4f3c6f[_0x4d077b(0xe4)](_0x5b4475=>{const _0x13de71=_0x4d077b,{username:_0x6a05cf,email:_0x2e8898}=_0x365d18[_0x13de71(0x115)](_0x149fe6=>_0x149fe6['id']===_0x5b4475[_0x13de71(0xeb)])||{};_0x5b4475[_0x13de71(0xfd)]=_0x6a05cf,_0x5b4475[_0x13de71(0x150)]=_0x2e8898;}),_0x4bc038['user']['role']!==_0x4d077b(0xe7)&&_0x4f3c6f['forEach'](_0x208e18=>_0x208e18[_0x4d077b(0x150)]=(0x0,utils_1['maskEmail'])(_0x208e18['email'])),_0x4f3c6f[_0x4d077b(0xe4)](_0x2abdd4=>{const _0x36e913=_0x4d077b;!_0x2abdd4[_0x36e913(0x150)]&&(_0x2abdd4[_0x36e913(0x150)]=(_0x2abdd4===null||_0x2abdd4===void 0x0?void 0x0:_0x2abdd4[_0x36e913(0xeb)])+_0x36e913(0xd3)),!_0x2abdd4[_0x36e913(0xfd)]&&(_0x2abdd4['username']='游客'+(_0x2abdd4===null||_0x2abdd4===void 0x0?void 0x0:_0x2abdd4[_0x36e913(0xeb)]));}),{'rows':_0x4f3c6f,'count':_0x39a6e4};}async['chatList'](_0x16f182,_0x584305){const _0xbd43a2=_0x2f54cc,{id:_0x5411c3}=_0x16f182[_0xbd43a2(0xcd)],{groupId:_0x2b16f8}=_0x584305,_0x4f0ab5={'userId':_0x5411c3,'isDelete':![]};_0x2b16f8&&Object['assign'](_0x4f0ab5,{'groupId':_0x2b16f8});if(_0x2b16f8){const _0x17a308=await this[_0xbd43a2(0xf3)][_0xbd43a2(0xfa)]({'where':{'isDelete':![]}});if(_0x17a308===0x0)return[];}const _0x3176eb=await this[_0xbd43a2(0x12e)][_0xbd43a2(0x115)]({'where':_0x4f0ab5});return _0x3176eb[_0xbd43a2(0x140)](_0x487547=>{const _0x316a22=_0xbd43a2,{prompt:_0x1db210,role:_0x1f1213,answer:_0x2167d4,createdAt:_0x34c6a4,model:_0x18f6f1,modelName:_0x296e4c,type:_0x56c0cd,status:_0x2d8013,action:_0x372bae,drawId:_0x5c451e,id:_0x3f6c8d,fileInfo:_0x123a73,ttsUrl:_0x14936d,videoUrl:_0x15dba6,audioUrl:_0x1c2916,customId:_0x4859be,pluginParam:_0x527821,modelAvatar:_0x34d0e6,taskData:_0x33ddb1,promptReference:_0xfe5811}=_0x487547;return{'chatId':_0x3f6c8d,'dateTime':(0x0,utils_1[_0x316a22(0x12d)])(_0x34c6a4),'text':_0x1f1213==='user'?_0x1db210:_0x2167d4,'modelType':_0x56c0cd,'status':_0x2d8013,'action':_0x372bae,'drawId':_0x5c451e,'customId':_0x4859be,'inversion':_0x1f1213===_0x316a22(0xcd),'error':![],'fileInfo':_0x123a73,'ttsUrl':_0x14936d,'videoUrl':_0x15dba6,'audioUrl':_0x1c2916,'model':_0x18f6f1,'modelName':_0x296e4c,'pluginParam':_0x527821,'modelAvatar':_0x34d0e6,'taskData':_0x33ddb1,'promptReference':_0xfe5811};});}async[_0x2f54cc(0x135)](_0x589284,_0x4759c0){const _0x5f222a=_0x2f54cc;if(_0x4759c0===0x0)return[];const _0x2d8017={'isDelete':![],'groupId':_0x589284},_0x480c62=await this[_0x5f222a(0x12e)][_0x5f222a(0x115)]({'where':_0x2d8017,'order':{'createdAt':'DESC'},'take':_0x4759c0*0x2}),_0x3af394=_0x480c62['map'](_0x5a0166=>{const {role:_0x415e65,prompt:_0xbaa519,answer:_0x2e63b4,fileInfo:_0x124563}=_0x5a0166,_0x32acf1={'role':_0x415e65,'text':_0x415e65==='user'?_0xbaa519:_0x2e63b4,'fileInfo':_0x124563};return _0x32acf1;})[_0x5f222a(0xe8)]();return _0x3af394;}async[_0x2f54cc(0xd1)](_0x43afcf,_0x8e2f04){const _0x1bb2e1=_0x2f54cc,{id:_0x3adc1d}=_0x43afcf[_0x1bb2e1(0xcd)],{id:_0x1502e9}=_0x8e2f04,_0x43174e=await this[_0x1bb2e1(0x12e)][_0x1bb2e1(0x137)]({'where':{'id':_0x1502e9,'userId':_0x3adc1d}});if(!_0x43174e)throw new common_1['HttpException']('你删除的对话记录不存在、请检查！',common_1['HttpStatus'][_0x1bb2e1(0xd9)]);const _0x71e77d=await this[_0x1bb2e1(0x12e)][_0x1bb2e1(0xd8)]({'id':_0x1502e9},{'isDelete':!![]});if(_0x71e77d[_0x1bb2e1(0x113)]>0x0)return'删除对话记录成功！';else throw new common_1[(_0x1bb2e1(0xef))]('你删除的对话记录不存在、请检查！',common_1[_0x1bb2e1(0x11f)][_0x1bb2e1(0xd9)]);}async['delByGroupId'](_0x311bd2,_0x105e4f){const _0x24c856=_0x2f54cc,{groupId:_0x3a7072}=_0x105e4f,{id:_0x13779d}=_0x311bd2[_0x24c856(0xcd)],_0x2d62fc=await this[_0x24c856(0xf3)][_0x24c856(0x137)]({'where':{'id':_0x3a7072,'userId':_0x13779d}});if(!_0x2d62fc)throw new common_1[(_0x24c856(0xef))](_0x24c856(0xfc),common_1[_0x24c856(0x11f)][_0x24c856(0xd9)]);const _0x51b094=await this[_0x24c856(0x12e)][_0x24c856(0xd8)]({'groupId':_0x3a7072},{'isDelete':!![]});if(_0x51b094[_0x24c856(0x113)]>0x0)return _0x24c856(0x132);if(_0x51b094[_0x24c856(0x113)]===0x0)throw new common_1[(_0x24c856(0xef))]('当前页面已经没有东西可以删除了！',common_1[_0x24c856(0x11f)]['BAD_REQUEST']);}async[_0x2f54cc(0xfe)](_0x421785,_0xdbe622){const _0x7f4d0d=_0x2f54cc,{id:_0x34124e}=_0xdbe622,{id:_0x57c803}=_0x421785[_0x7f4d0d(0xcd)],_0x1c91e4=await this[_0x7f4d0d(0x12e)]['findOne']({'where':{'id':_0x34124e,'userId':_0x57c803}});if(!_0x1c91e4)throw new common_1[(_0x7f4d0d(0xef))](_0x7f4d0d(0xfc),common_1['HttpStatus']['BAD_REQUEST']);const {groupId:_0xf20d58}=_0x1c91e4,_0x2ca48d=await this[_0x7f4d0d(0x12e)][_0x7f4d0d(0xd8)]({'groupId':_0xf20d58,'id':(0x0,typeorm_2[_0x7f4d0d(0x146)])(_0x34124e)},{'isDelete':!![]});if(_0x2ca48d[_0x7f4d0d(0x113)]>0x0)return'删除对话记录成功！';else throw new common_1[(_0x7f4d0d(0xef))](_0x7f4d0d(0xee),common_1[_0x7f4d0d(0x11f)]['BAD_REQUEST']);}async['byAppId'](_0x4a2170,_0x90a1c2){const _0x56256d=_0x2f54cc,{id:_0x4e67ef}=_0x4a2170[_0x56256d(0xcd)],{appId:_0x54387c,page:page=0x1,size:size=0xa}=_0x90a1c2,[_0x5e0ea2,_0x290258]=await this[_0x56256d(0x12e)][_0x56256d(0x13e)]({'where':{'userId':_0x4e67ef,'appId':_0x54387c,'role':'assistant'},'order':{'id':_0x56256d(0xd6)},'take':size,'skip':(page-0x1)*size});return{'rows':_0x5e0ea2,'count':_0x290258};}async['checkModelLimits'](_0x1f8718,_0x20f3c8){const _0x57a532=_0x2f54cc,_0xe1a3df=0xe10*0x3e8,_0x59ef92=new Date(Date[_0x57a532(0xe2)]()-_0xe1a3df);try{const _0x5bfe38=await this['chatLogEntity'][_0x57a532(0xfa)]({'where':{'userId':_0x1f8718['id'],'model':_0x20f3c8,'createdAt':(0x0,typeorm_2['MoreThan'])(_0x59ef92)}}),_0x339411=Math[_0x57a532(0x104)](_0x5bfe38/0x2);common_1[_0x57a532(0x108)][_0x57a532(0x119)](_0x57a532(0x122)+_0x1f8718['id']+_0x57a532(0x12f)+_0x20f3c8+_0x57a532(0x11e)+(_0x339411+0x1)+'\x20次',_0x57a532(0xe3));let _0x806f5f;_0x20f3c8[_0x57a532(0xf7)](_0x57a532(0x127))?_0x806f5f=await this[_0x57a532(0x136)][_0x57a532(0xec)]('gpts'):_0x806f5f=await this[_0x57a532(0x136)][_0x57a532(0xec)](_0x20f3c8);const _0x3d1fc3=Number(_0x806f5f['modelLimits']);common_1[_0x57a532(0x108)][_0x57a532(0x119)](_0x57a532(0x130)+_0x20f3c8+_0x57a532(0xf6)+_0x3d1fc3,_0x57a532(0xe3));if(_0x339411>_0x3d1fc3)return!![];return![];}catch(_0x5ced99){common_1[_0x57a532(0x108)][_0x57a532(0xcf)]('查询数据库出错\x20-\x20用户ID:\x20'+_0x1f8718['id']+',\x20模型:\x20'+_0x20f3c8+_0x57a532(0xf5)+_0x5ced99[_0x57a532(0xff)],_0x5ced99[_0x57a532(0xd4)],'ChatLogService');}}};function _0xe735(){const _0x361a30=['attachment;\x20filename=','265027hgRHko','userId','getCurrentModelKeyInfo','model','当前页面已经没有东西可以删除了！','HttpException','PAINT','../../common/constants/balance.constant','assign','chatGroupEntity','type',',\x20错误信息:\x20','\x20的使用次数限制为\x20','startsWith','recDrawImg','midjourney','count','Injectable','你删除的对话记录不存在、请检查！','username','deleteChatsAfterId','message','querAllDrawLog','4312184giVjGL','stable-diffusion','prompt','ceil','2994804YOpHMY','图片成功！','../../common/utils','Logger','回答答案','9UaeqNT','end','write','156LIechA','fileInfo','Like','components','decorate','findOneChatLog','affected','ChatType','find','tencent','你推荐的图片不存在、请检查！','findOneDrawLog','log','@nestjs/typeorm','Content-Disposition','addRow','你操作的图片不存在、请检查！','\x20模型\x20','HttpStatus','updateChatLog','__metadata','用户ID:\x20','thumbImg','22068720niHnxX','defineProperty','userInfo','gpt-4-gizmo','addWorksheet','?imageView2/1/w/','/q/55','dall-e-3','exceljs','formatDate','chatLogEntity','\x20一小时内调用\x20','模型\x20','ChatGroupEntity','删除对话记录成功！','default','parse','chatHistory','modelsService','findOne','function','提问问题','design:paramtypes','getOwnPropertyDescriptor','ModelsService','InjectRepository','findAndCount','includes','map','columns','chatlog','4716450dzOFqW','querDrawLog','NORMAL_CHAT','MoreThanOrEqual','metadata','createdAt','answer','用户邮箱','DALL-E2','xlsx','filter','1306CdTLTc','querAllChatLog','email','ali','cos','Content-Type','Workbook','Repository','../user/user.entity','chat.xlsx','193SUGAIV','user','length','error','userEntity','deleteChatLog','?x-oss-process=image/resize,w_','@aiweb.com','stack','Not','DESC','extend','update','BAD_REQUEST','取消推荐','setHeader','./chatLog.entity','isGroup','object','saveChatLog','782991UanOJL','paintCount','now','ChatLogService','forEach','../models/models.service','__decorate','super','reverse'];_0xe735=function(){return _0x361a30;};return _0xe735();}ChatLogService=__decorate([(0x0,common_1[_0x2f54cc(0xfb)])(),__param(0x0,(0x0,typeorm_1[_0x2f54cc(0x13d)])(chatLog_entity_1['ChatLogEntity'])),__param(0x1,(0x0,typeorm_1[_0x2f54cc(0x13d)])(user_entity_1['UserEntity'])),__param(0x2,(0x0,typeorm_1[_0x2f54cc(0x13d)])(chatGroup_entity_1[_0x2f54cc(0x131)])),__metadata(_0x2f54cc(0x13a),[typeorm_2[_0x2f54cc(0x155)],typeorm_2[_0x2f54cc(0x155)],typeorm_2[_0x2f54cc(0x155)],models_service_1[_0x2f54cc(0x13c)]])],ChatLogService),exports[_0x2f54cc(0xe3)]=ChatLogService;