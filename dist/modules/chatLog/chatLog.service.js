'use strict';const _0x4bf618=_0x31f0;function _0x31f0(_0x100c2b,_0x113706){const _0x3e7ddc=_0x3e7d();return _0x31f0=function(_0x31f0f2,_0x31baf5){_0x31f0f2=_0x31f0f2-0x1f3;let _0x2c5a52=_0x3e7ddc[_0x31f0f2];return _0x2c5a52;},_0x31f0(_0x100c2b,_0x113706);}(function(_0x39ea3e,_0x28dad1){const _0x48c46f=_0x31f0,_0x1d4e8b=_0x39ea3e();while(!![]){try{const _0x19b38e=parseInt(_0x48c46f(0x223))/0x1*(-parseInt(_0x48c46f(0x27b))/0x2)+parseInt(_0x48c46f(0x201))/0x3+parseInt(_0x48c46f(0x273))/0x4*(-parseInt(_0x48c46f(0x242))/0x5)+parseInt(_0x48c46f(0x259))/0x6*(-parseInt(_0x48c46f(0x232))/0x7)+-parseInt(_0x48c46f(0x275))/0x8+parseInt(_0x48c46f(0x222))/0x9+-parseInt(_0x48c46f(0x255))/0xa;if(_0x19b38e===_0x28dad1)break;else _0x1d4e8b['push'](_0x1d4e8b['shift']());}catch(_0x11c406){_0x1d4e8b['push'](_0x1d4e8b['shift']());}}}(_0x3e7d,0xc48b7));function _0x3e7d(){const _0x32cb35=['fileInfo','parse','删除对话记录成功！','InjectRepository','581gfjeLe','../chatGroup/chatGroup.entity','UserEntity','metadata','图片成功！','updateChatLog','extend','getCurrentModelKeyInfo','assistant','__decorate','../models/models.service','querAllDrawLog','exportExcel','answer','paintCount','affected','25930loVidl','user',',\x20错误信息:\x20','取消推荐','@aiweb.com','DESC','defineProperty','./chatLog.entity','byAppId','default','Logger','exceljs','getOwnPropertyDescriptor','stack','components','MoreThanOrEqual','error','chatGroupEntity','delByGroupId','420890RZecax','update','thumbImg','Like','11478mUEHZn','decorate','typeorm','querDrawLog','PAINT','../../common/utils','userInfo','addWorksheet','username','你推荐的图片不存在、请检查！','save','email','cos','checkModelLimits','super','startsWith','userId','@nestjs/typeorm','type','模型\x20','\x20一小时内调用\x20','\x20模型\x20','用户名','formatDate','你操作的图片不存在、请检查！','ChatGroupEntity','388gakvLI','filter','3049096Kwlqbb','setHeader','map','count','isGroup','modelsService','2aNkKOt','BAD_REQUEST','gpt-4-gizmo','object','\x20的使用次数限制为\x20','当前页面已经没有东西可以删除了！','/q/55','MoreThan','userEntity','HttpStatus','avatar','attachment;\x20filename=','ChatLogService','Workbook','tencent','查询数据库出错\x20-\x20用户ID:\x20','deleteChatsAfterId','?x-oss-process=image/resize,w_','Not','你删除的对话记录不存在、请检查！','includes','__metadata','HttpException','3470037pcUDlC','deleteChatLog','用户邮箱','function','chatList','modelLimits','findOneChatLog','length','findAndCount','ali','model','querAllDrawLog\x20Json\x20parse\x20error','assign','NORMAL_CHAT','findOne','chatLogEntity','回答答案','rec','design:paramtypes','ModelsService','find','__esModule',',\x20模型:\x20','ChatType','createdAt','log','../user/user.entity','dall-e-3','reverse','用户ID:\x20','recDrawImg','saveChatLog','chat.xlsx','11733372xPTJdT','570293zVogkB','Content-Disposition','?imageView2/1/w/','Injectable','Repository','prompt','DALL-E2','forEach','ceil','midjourney','__param'];_0x3e7d=function(){return _0x32cb35;};return _0x3e7d();}var __decorate=this&&this[_0x4bf618(0x23b)]||function(_0x51519d,_0x1179fe,_0x1de9c7,_0x54d9f3){const _0x1f09e0=_0x4bf618;var _0x5e68bf=arguments[_0x1f09e0(0x208)],_0x508b21=_0x5e68bf<0x3?_0x1179fe:_0x54d9f3===null?_0x54d9f3=Object[_0x1f09e0(0x24e)](_0x1179fe,_0x1de9c7):_0x54d9f3,_0x2e8b5c;if(typeof Reflect===_0x1f09e0(0x27e)&&typeof Reflect[_0x1f09e0(0x25a)]==='function')_0x508b21=Reflect['decorate'](_0x51519d,_0x1179fe,_0x1de9c7,_0x54d9f3);else{for(var _0x12894c=_0x51519d['length']-0x1;_0x12894c>=0x0;_0x12894c--)if(_0x2e8b5c=_0x51519d[_0x12894c])_0x508b21=(_0x5e68bf<0x3?_0x2e8b5c(_0x508b21):_0x5e68bf>0x3?_0x2e8b5c(_0x1179fe,_0x1de9c7,_0x508b21):_0x2e8b5c(_0x1179fe,_0x1de9c7))||_0x508b21;}return _0x5e68bf>0x3&&_0x508b21&&Object['defineProperty'](_0x1179fe,_0x1de9c7,_0x508b21),_0x508b21;},__metadata=this&&this[_0x4bf618(0x1ff)]||function(_0x5976cc,_0x4580ce){const _0x108577=_0x4bf618;if(typeof Reflect===_0x108577(0x27e)&&typeof Reflect[_0x108577(0x235)]===_0x108577(0x204))return Reflect[_0x108577(0x235)](_0x5976cc,_0x4580ce);},__param=this&&this[_0x4bf618(0x22d)]||function(_0x169431,_0xd67da9){return function(_0x26e633,_0x273481){_0xd67da9(_0x26e633,_0x273481,_0x169431);};};Object[_0x4bf618(0x248)](exports,_0x4bf618(0x216),{'value':!![]}),exports[_0x4bf618(0x1f6)]=void 0x0;const balance_constant_1=require('../../common/constants/balance.constant'),utils_1=require(_0x4bf618(0x25e)),common_1=require('@nestjs/common'),typeorm_1=require(_0x4bf618(0x26a)),exceljs_1=require(_0x4bf618(0x24d)),typeorm_2=require(_0x4bf618(0x25b)),chatGroup_entity_1=require(_0x4bf618(0x233)),user_entity_1=require(_0x4bf618(0x21b)),chatLog_entity_1=require(_0x4bf618(0x249)),models_service_1=require(_0x4bf618(0x23c));let ChatLogService=class ChatLogService{constructor(_0x1c3189,_0x5b3878,_0x25ce14,_0x13eadf){const _0x13e885=_0x4bf618;this[_0x13e885(0x210)]=_0x1c3189,this[_0x13e885(0x283)]=_0x5b3878,this['chatGroupEntity']=_0x25ce14,this[_0x13e885(0x27a)]=_0x13eadf;}async[_0x4bf618(0x220)](_0x4eff55){const _0x4c7b5e=_0x4bf618,_0x25ea6a=await this[_0x4c7b5e(0x210)][_0x4c7b5e(0x263)](_0x4eff55);return _0x25ea6a;}async[_0x4bf618(0x237)](_0x4a6509,_0x2d7ae7){const _0x1ee4c2=_0x4bf618;return await this[_0x1ee4c2(0x210)][_0x1ee4c2(0x256)]({'id':_0x4a6509},_0x2d7ae7);}async[_0x4bf618(0x207)](_0x5ca452){const _0xdeed75=_0x4bf618;return await this[_0xdeed75(0x210)][_0xdeed75(0x20f)]({'where':{'id':_0x5ca452}});}async[_0x4bf618(0x25c)](_0x33aff4,_0x4d4c7f){const _0x2b1463=_0x4bf618,{id:_0x11a5fb}=_0x33aff4[_0x2b1463(0x243)],{model:_0x471801}=_0x4d4c7f,_0xeca26b={'userId':_0x11a5fb,'type':balance_constant_1['ChatType'][_0x2b1463(0x25d)]};_0x471801&&(_0xeca26b[_0x2b1463(0x20b)]=_0x471801,_0x471801===_0x2b1463(0x229)&&(_0xeca26b[_0x2b1463(0x20b)]=(0x0,typeorm_2['In'])([_0x2b1463(0x229),_0x2b1463(0x21c)])));const _0xde1afd=await this[_0x2b1463(0x210)]['find']({'where':_0xeca26b,'order':{'id':_0x2b1463(0x247)},'select':['id','answer',_0x2b1463(0x228),_0x2b1463(0x20b),_0x2b1463(0x26b),_0x2b1463(0x22e)]});return _0xde1afd[_0x2b1463(0x22a)](_0x4b45d5=>{const _0x245950=_0x2b1463;if(_0x4b45d5[_0x245950(0x26b)]===_0x245950(0x240)){const _0x20a5b4=_0x4b45d5['model']==='mj'?0x136:0xa0,_0x18af6d=_0x4b45d5[_0x245950(0x23f)][_0x245950(0x1fe)](_0x245950(0x265))?_0x245950(0x1f8):_0x245950(0x20a),_0x188ad4=_0x18af6d==='tencent'?_0x245950(0x225)+_0x20a5b4+'/q/55':_0x245950(0x1fb)+_0x20a5b4;_0x4b45d5[_0x245950(0x257)]=_0x4b45d5[_0x245950(0x23f)]+_0x188ad4;try{_0x4b45d5[_0x245950(0x22e)]=_0x4b45d5[_0x245950(0x22e)]?JSON[_0x245950(0x22f)](_0x4b45d5[_0x245950(0x22e)]):null;}catch(_0x32944e){_0x4b45d5[_0x245950(0x22e)]={};}}}),_0xde1afd;}async[_0x4bf618(0x23d)](_0x3c5a1a){const _0x4f13ba=_0x4bf618,{page:page=0x1,size:size=0x14,rec:_0x5e43e8,userId:_0x1c2d9b,model:_0x1cd670}=_0x3c5a1a,_0x544f1d={'type':0x2,'prompt':(0x0,typeorm_2[_0x4f13ba(0x1fc)])(''),'answer':(0x0,typeorm_2[_0x4f13ba(0x1fc)])(''),'fileInfo':(0x0,typeorm_2[_0x4f13ba(0x1fc)])('')};_0x5e43e8&&Object[_0x4f13ba(0x20d)](_0x544f1d,{'rec':_0x5e43e8}),_0x1c2d9b&&Object['assign'](_0x544f1d,{'userId':_0x1c2d9b});_0x1cd670?_0x544f1d['model']=_0x1cd670:_0x544f1d[_0x4f13ba(0x20b)]=(0x0,typeorm_2['In'])([_0x4f13ba(0x22c),_0x4f13ba(0x21c),'stable-diffusion']);const [_0x53f236,_0x1df77d]=await this['chatLogEntity'][_0x4f13ba(0x209)]({'order':{'id':_0x4f13ba(0x247)},'skip':(page-0x1)*size,'take':size,'where':_0x544f1d}),_0x3d8bb1=_0x53f236[_0x4f13ba(0x277)](_0x45ef89=>_0x45ef89[_0x4f13ba(0x269)])[_0x4f13ba(0x274)](_0x392241=>_0x392241<0x186a0),_0x4309e6=await this[_0x4f13ba(0x283)][_0x4f13ba(0x215)]({'where':{'id':(0x0,typeorm_2['In'])(_0x3d8bb1)},'select':['id',_0x4f13ba(0x261),_0x4f13ba(0x1f4),_0x4f13ba(0x264)]});return _0x53f236[_0x4f13ba(0x22a)](_0x386292=>{const _0x1276a7=_0x4f13ba;_0x386292[_0x1276a7(0x25f)]=_0x4309e6[_0x1276a7(0x215)](_0x52c5a3=>_0x52c5a3['id']===_0x386292['userId']);}),_0x53f236[_0x4f13ba(0x22a)](_0x1ab8f8=>{const _0x3895fe=_0x4f13ba;var _0x5c2007;const _0x398108=_0x1ab8f8['model']===_0x3895fe(0x22c)?0x136:0xa0,_0xfd78a6=_0x1ab8f8['answer'][_0x3895fe(0x1fe)](_0x3895fe(0x265))?_0x3895fe(0x1f8):_0x3895fe(0x20a),_0x53bab1=_0xfd78a6===_0x3895fe(0x1f8)?'?imageView2/1/w/'+_0x398108+_0x3895fe(0x281):'?x-oss-process=image/resize,w_'+_0x398108;_0x1ab8f8[_0x3895fe(0x257)]=_0x1ab8f8['answer']+_0x53bab1;try{const _0x27e6eb=_0x1ab8f8[_0x3895fe(0x238)]?JSON[_0x3895fe(0x22f)](_0x1ab8f8[_0x3895fe(0x238)]):null;_0x27e6eb&&(_0x27e6eb?_0x1ab8f8[_0x3895fe(0x279)]=((_0x5c2007=_0x27e6eb===null||_0x27e6eb===void 0x0?void 0x0:_0x27e6eb[_0x3895fe(0x250)][0x0])===null||_0x5c2007===void 0x0?void 0x0:_0x5c2007[_0x3895fe(0x250)][_0x3895fe(0x208)])===0x5:_0x1ab8f8[_0x3895fe(0x279)]=![]);}catch(_0x349a66){console[_0x3895fe(0x21a)](_0x3895fe(0x20c),_0x349a66);}}),{'rows':_0x53f236,'count':_0x1df77d};}async['findOneDrawLog'](_0x134978){const _0x4e788b=_0x4bf618,{id:_0xe76307}=_0x134978,_0x2a5a8b=await this[_0x4e788b(0x210)][_0x4e788b(0x20f)]({'where':{'id':_0xe76307}});return _0x2a5a8b;}async[_0x4bf618(0x21f)](_0xb402bc){const _0x4029da=_0x4bf618,{id:_0x4b0eb7}=_0xb402bc,_0x55c543=await this[_0x4029da(0x210)][_0x4029da(0x20f)]({'where':{'id':_0x4b0eb7,'type':balance_constant_1[_0x4029da(0x218)][_0x4029da(0x25d)]}});if(!_0x55c543)throw new common_1[(_0x4029da(0x200))](_0x4029da(0x262),common_1[_0x4029da(0x1f3)][_0x4029da(0x27c)]);const _0x451d41=_0x55c543[_0x4029da(0x212)]===0x1?0x0:0x1,_0x5516b0=await this['chatLogEntity']['update']({'id':_0x4b0eb7},{'rec':_0x451d41});if(_0x5516b0[_0x4029da(0x241)]>0x0)return(_0x451d41?'推荐':_0x4029da(0x245))+_0x4029da(0x236);throw new common_1[(_0x4029da(0x200))](_0x4029da(0x271),common_1['HttpStatus'][_0x4029da(0x27c)]);}async[_0x4bf618(0x23e)](_0x186ef1,_0x41e8f1){const _0x5e89aa=_0x4bf618,_0x3e0393={'type':balance_constant_1['ChatType'][_0x5e89aa(0x20e)]},{page:page=0x1,size:size=0x1e,prompt:_0x7cadc3,email:_0x163716}=_0x186ef1;_0x7cadc3&&Object[_0x5e89aa(0x20d)](_0x3e0393,{'prompt':(0x0,typeorm_2[_0x5e89aa(0x258)])('%'+_0x7cadc3+'%')});if(_0x163716){const _0x5e02d5=await this[_0x5e89aa(0x283)][_0x5e89aa(0x20f)]({'where':{'email':_0x163716}});(_0x5e02d5===null||_0x5e02d5===void 0x0?void 0x0:_0x5e02d5['id'])&&Object[_0x5e89aa(0x20d)](_0x3e0393,{'userId':_0x5e02d5['id']});}const [_0x19d7a6,_0x4fc43e]=await this[_0x5e89aa(0x210)][_0x5e89aa(0x209)]({'order':{'id':_0x5e89aa(0x247)},'skip':(page-0x1)*size,'take':size,'where':_0x3e0393}),_0x261437=_0x19d7a6[_0x5e89aa(0x277)](_0xb6ce9e=>_0xb6ce9e[_0x5e89aa(0x269)]),_0x4ceab3=await this[_0x5e89aa(0x283)][_0x5e89aa(0x215)]({'where':{'id':(0x0,typeorm_2['In'])(_0x261437)}}),_0x835552=_0x19d7a6['map'](_0x53d1fb=>{const _0x283e32=_0x5e89aa,_0x5cad9a=_0x4ceab3['find'](_0x1ac867=>_0x1ac867['id']===_0x53d1fb['userId']);return{'username':_0x5cad9a?_0x5cad9a['username']:'','email':_0x5cad9a?_0x5cad9a['email']:'','prompt':_0x53d1fb[_0x283e32(0x228)],'answer':_0x53d1fb[_0x283e32(0x23f)],'createdAt':(0x0,utils_1[_0x283e32(0x270)])(_0x53d1fb[_0x283e32(0x219)])};}),_0x1daad8=new exceljs_1[(_0x5e89aa(0x24b))][(_0x5e89aa(0x1f7))](),_0xb23403=_0x1daad8[_0x5e89aa(0x260)]('chatlog');_0xb23403['columns']=[{'header':_0x5e89aa(0x26f),'key':_0x5e89aa(0x261),'width':0x14},{'header':_0x5e89aa(0x203),'key':'email','width':0x14},{'header':'提问时间','key':_0x5e89aa(0x219),'width':0x14},{'header':'提问问题','key':'prompt','width':0x50},{'header':_0x5e89aa(0x211),'key':_0x5e89aa(0x23f),'width':0x96}],_0x835552[_0x5e89aa(0x22a)](_0xbb0b46=>_0xb23403['addRow'](_0xbb0b46)),_0x41e8f1[_0x5e89aa(0x276)]('Content-Type','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'),_0x41e8f1['setHeader'](_0x5e89aa(0x224),_0x5e89aa(0x1f5)+_0x5e89aa(0x221)),await _0x1daad8['xlsx']['write'](_0x41e8f1),_0x41e8f1['end']();}async['querAllChatLog'](_0x14074b,_0x5bcbb2){const _0x1e6747=_0x4bf618,{page:page=0x1,size:size=0x14,userId:_0x5f57b4,prompt:_0xba019f}=_0x14074b,_0x590ba5={'type':balance_constant_1['ChatType']['NORMAL_CHAT'],'prompt':(0x0,typeorm_2[_0x1e6747(0x1fc)])('')};_0x5f57b4&&Object[_0x1e6747(0x20d)](_0x590ba5,{'userId':_0x5f57b4}),_0xba019f&&Object[_0x1e6747(0x20d)](_0x590ba5,{'prompt':(0x0,typeorm_2[_0x1e6747(0x258)])('%'+_0xba019f+'%')});const [_0x536d84,_0x16788d]=await this[_0x1e6747(0x210)][_0x1e6747(0x209)]({'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size,'where':_0x590ba5}),_0x4f83a5=_0x536d84[_0x1e6747(0x277)](_0x4fceba=>_0x4fceba[_0x1e6747(0x269)]),_0x11575b=await this['userEntity'][_0x1e6747(0x215)]({'where':{'id':(0x0,typeorm_2['In'])(_0x4f83a5)},'select':['id',_0x1e6747(0x261),_0x1e6747(0x264)]});return _0x536d84[_0x1e6747(0x22a)](_0xf38af3=>{const _0x4e3f12=_0x1e6747,{username:_0x55e640,email:_0x1bead4}=_0x11575b['find'](_0x156d9d=>_0x156d9d['id']===_0xf38af3['userId'])||{};_0xf38af3[_0x4e3f12(0x261)]=_0x55e640,_0xf38af3[_0x4e3f12(0x264)]=_0x1bead4;}),_0x5bcbb2[_0x1e6747(0x243)]['role']!==_0x1e6747(0x267)&&_0x536d84[_0x1e6747(0x22a)](_0x1e7eeb=>_0x1e7eeb[_0x1e6747(0x264)]=(0x0,utils_1['maskEmail'])(_0x1e7eeb[_0x1e6747(0x264)])),_0x536d84[_0x1e6747(0x22a)](_0x5ece92=>{const _0x3bf57e=_0x1e6747;!_0x5ece92['email']&&(_0x5ece92[_0x3bf57e(0x264)]=(_0x5ece92===null||_0x5ece92===void 0x0?void 0x0:_0x5ece92[_0x3bf57e(0x269)])+_0x3bf57e(0x246)),!_0x5ece92[_0x3bf57e(0x261)]&&(_0x5ece92[_0x3bf57e(0x261)]='游客'+(_0x5ece92===null||_0x5ece92===void 0x0?void 0x0:_0x5ece92[_0x3bf57e(0x269)]));}),{'rows':_0x536d84,'count':_0x16788d};}async[_0x4bf618(0x205)](_0x3c44bc,_0x5483a0){const _0x354f99=_0x4bf618,{id:_0x3ae86b}=_0x3c44bc[_0x354f99(0x243)],{groupId:_0x18ea8d}=_0x5483a0,_0x442fc4={'userId':_0x3ae86b,'isDelete':![]};_0x18ea8d&&Object[_0x354f99(0x20d)](_0x442fc4,{'groupId':_0x18ea8d});if(_0x18ea8d){const _0x298c37=await this[_0x354f99(0x253)]['count']({'where':{'isDelete':![]}});if(_0x298c37===0x0)return[];}const _0x12c8a5=await this[_0x354f99(0x210)][_0x354f99(0x215)]({'where':_0x442fc4});return _0x12c8a5[_0x354f99(0x277)](_0x1ee67f=>{const _0x18f770=_0x354f99,{prompt:_0x3233fb,role:_0x586abc,answer:_0x4d1104,createdAt:_0x3a51bc,model:_0x58fa2c,modelName:_0xb3ea14,type:_0x3afb80,status:_0x45aae6,action:_0x495aea,drawId:_0x127647,id:_0x4985ff,fileInfo:_0x79df5b,ttsUrl:_0xc1a191,videoUrl:_0x442065,audioUrl:_0x172ba4,customId:_0x3b17d4,pluginParam:_0x347fda,modelAvatar:_0x21776e,taskData:_0x4a65fa,promptReference:_0x277823}=_0x1ee67f;return{'chatId':_0x4985ff,'dateTime':(0x0,utils_1['formatDate'])(_0x3a51bc),'text':_0x586abc==='user'?_0x3233fb:_0x4d1104,'modelType':_0x3afb80,'status':_0x45aae6,'action':_0x495aea,'drawId':_0x127647,'customId':_0x3b17d4,'inversion':_0x586abc===_0x18f770(0x243),'error':![],'fileInfo':_0x79df5b,'ttsUrl':_0xc1a191,'videoUrl':_0x442065,'audioUrl':_0x172ba4,'model':_0x58fa2c,'modelName':_0xb3ea14,'pluginParam':_0x347fda,'modelAvatar':_0x21776e,'taskData':_0x4a65fa,'promptReference':_0x277823};});}async['chatHistory'](_0x46a3b5,_0xb04997){const _0x576e5e=_0x4bf618;if(_0xb04997===0x0)return[];const _0x1e4adf={'isDelete':![],'groupId':_0x46a3b5},_0x4cf874=await this[_0x576e5e(0x210)]['find']({'where':_0x1e4adf,'order':{'createdAt':_0x576e5e(0x247)},'take':_0xb04997*0x2}),_0x41896c=_0x4cf874[_0x576e5e(0x277)](_0x1dddfb=>{const _0x26e867=_0x576e5e,{role:_0x221587,prompt:_0x33c645,answer:_0x227c74,fileInfo:_0x55a864}=_0x1dddfb,_0x79cd91={'role':_0x221587,'text':_0x221587===_0x26e867(0x243)?_0x33c645:_0x227c74,'fileInfo':_0x55a864};return _0x79cd91;})[_0x576e5e(0x21d)]();return _0x41896c;}async[_0x4bf618(0x202)](_0x33dc62,_0x2edbea){const _0x3b685f=_0x4bf618,{id:_0x1fffb7}=_0x33dc62[_0x3b685f(0x243)],{id:_0x124acd}=_0x2edbea,_0x75c920=await this['chatLogEntity'][_0x3b685f(0x20f)]({'where':{'id':_0x124acd,'userId':_0x1fffb7}});if(!_0x75c920)throw new common_1[(_0x3b685f(0x200))](_0x3b685f(0x1fd),common_1[_0x3b685f(0x1f3)][_0x3b685f(0x27c)]);const _0x324a79=await this[_0x3b685f(0x210)][_0x3b685f(0x256)]({'id':_0x124acd},{'isDelete':!![]});if(_0x324a79['affected']>0x0)return _0x3b685f(0x230);else throw new common_1[(_0x3b685f(0x200))]('你删除的对话记录不存在、请检查！',common_1[_0x3b685f(0x1f3)][_0x3b685f(0x27c)]);}async[_0x4bf618(0x254)](_0x41566a,_0x58207e){const _0x5f234d=_0x4bf618,{groupId:_0x2230c4}=_0x58207e,{id:_0x54e11d}=_0x41566a['user'],_0xf4e58c=await this[_0x5f234d(0x253)][_0x5f234d(0x20f)]({'where':{'id':_0x2230c4,'userId':_0x54e11d}});if(!_0xf4e58c)throw new common_1['HttpException'](_0x5f234d(0x1fd),common_1[_0x5f234d(0x1f3)]['BAD_REQUEST']);const _0x1d0e4c=await this['chatLogEntity'][_0x5f234d(0x256)]({'groupId':_0x2230c4},{'isDelete':!![]});if(_0x1d0e4c[_0x5f234d(0x241)]>0x0)return'删除对话记录成功！';if(_0x1d0e4c[_0x5f234d(0x241)]===0x0)throw new common_1['HttpException'](_0x5f234d(0x280),common_1[_0x5f234d(0x1f3)][_0x5f234d(0x27c)]);}async[_0x4bf618(0x1fa)](_0x21e092,_0x1e1a0f){const _0x447fab=_0x4bf618,{id:_0x3a5cfe}=_0x1e1a0f,{id:_0x293218}=_0x21e092['user'],_0xb17db6=await this[_0x447fab(0x210)]['findOne']({'where':{'id':_0x3a5cfe,'userId':_0x293218}});if(!_0xb17db6)throw new common_1[(_0x447fab(0x200))]('你删除的对话记录不存在、请检查！',common_1[_0x447fab(0x1f3)]['BAD_REQUEST']);const {groupId:_0x397e0d}=_0xb17db6,_0x8bb6d0=await this[_0x447fab(0x210)][_0x447fab(0x256)]({'groupId':_0x397e0d,'id':(0x0,typeorm_2[_0x447fab(0x251)])(_0x3a5cfe)},{'isDelete':!![]});if(_0x8bb6d0[_0x447fab(0x241)]>0x0)return'删除对话记录成功！';else throw new common_1[(_0x447fab(0x200))](_0x447fab(0x280),common_1[_0x447fab(0x1f3)]['BAD_REQUEST']);}async[_0x4bf618(0x24a)](_0x18d1bc,_0x13893b){const _0x4858fb=_0x4bf618,{id:_0xdbc044}=_0x18d1bc[_0x4858fb(0x243)],{appId:_0x1d29d3,page:page=0x1,size:size=0xa}=_0x13893b,[_0x55239a,_0x298dd5]=await this['chatLogEntity']['findAndCount']({'where':{'userId':_0xdbc044,'appId':_0x1d29d3,'role':_0x4858fb(0x23a)},'order':{'id':_0x4858fb(0x247)},'take':size,'skip':(page-0x1)*size});return{'rows':_0x55239a,'count':_0x298dd5};}async[_0x4bf618(0x266)](_0x5e3e64,_0xf6cb3c){const _0x2433fe=_0x4bf618,_0x5bd9aa=0xe10*0x3e8,_0xbffd9e=new Date(Date['now']()-_0x5bd9aa);try{const _0x1ffc34=await this['chatLogEntity'][_0x2433fe(0x278)]({'where':{'userId':_0x5e3e64['id'],'model':_0xf6cb3c,'createdAt':(0x0,typeorm_2[_0x2433fe(0x282)])(_0xbffd9e)}}),_0x401d6e=Math[_0x2433fe(0x22b)](_0x1ffc34/0x2);common_1['Logger'][_0x2433fe(0x21a)](_0x2433fe(0x21e)+_0x5e3e64['id']+_0x2433fe(0x26d)+_0xf6cb3c+_0x2433fe(0x26e)+(_0x401d6e+0x1)+'\x20次','ChatLogService');let _0x599977;_0xf6cb3c[_0x2433fe(0x268)](_0x2433fe(0x27d))?_0x599977=await this[_0x2433fe(0x27a)][_0x2433fe(0x239)]('gpts'):_0x599977=await this[_0x2433fe(0x27a)][_0x2433fe(0x239)](_0xf6cb3c);const _0x20e02a=Number(_0x599977[_0x2433fe(0x206)]);common_1[_0x2433fe(0x24c)]['log'](_0x2433fe(0x26c)+_0xf6cb3c+_0x2433fe(0x27f)+_0x20e02a,_0x2433fe(0x1f6));if(_0x401d6e>_0x20e02a)return!![];return![];}catch(_0x40068f){common_1[_0x2433fe(0x24c)][_0x2433fe(0x252)](_0x2433fe(0x1f9)+_0x5e3e64['id']+_0x2433fe(0x217)+_0xf6cb3c+_0x2433fe(0x244)+_0x40068f['message'],_0x40068f[_0x2433fe(0x24f)],_0x2433fe(0x1f6));}}};ChatLogService=__decorate([(0x0,common_1[_0x4bf618(0x226)])(),__param(0x0,(0x0,typeorm_1[_0x4bf618(0x231)])(chatLog_entity_1['ChatLogEntity'])),__param(0x1,(0x0,typeorm_1[_0x4bf618(0x231)])(user_entity_1[_0x4bf618(0x234)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(chatGroup_entity_1[_0x4bf618(0x272)])),__metadata(_0x4bf618(0x213),[typeorm_2[_0x4bf618(0x227)],typeorm_2[_0x4bf618(0x227)],typeorm_2['Repository'],models_service_1[_0x4bf618(0x214)]])],ChatLogService),exports[_0x4bf618(0x1f6)]=ChatLogService;