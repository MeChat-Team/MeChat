'use strict';const _0x42609b=_0x2166;function _0x1085(){const _0x6e68e5=['parse','ChatLogService','design:paramtypes','@aiweb.com','updateChatLog','Not','你推荐的图片不存在、请检查！','user','HttpException','?imageView2/1/w/','delByGroupId','MoreThan','@nestjs/typeorm','length','DALL-E2','addRow','DESC','390060IPzaKW','rec','querAllDrawLog\x20Json\x20parse\x20error','Workbook','PAINT','role','modelLimits','删除对话记录成功！','createdAt','formatDate','username','defineProperty','findOne','modelsService','Content-Disposition','log','./chatLog.entity','5DBqnFL','thumbImg','ChatLogEntity','maskEmail','saveChatLog','BAD_REQUEST','chatList','用户邮箱','isGroup','71998WEcueS','includes','getCurrentModelKeyInfo','findOneDrawLog','gpt-4-gizmo','exportExcel','checkModelLimits','dall-e-3','/q/55','find','avatar','2322316fBfFHO','\x20模型\x20','../../common/utils','cos','ModelsService','decorate','email','default','tencent','map','components','addWorksheet','affected','setHeader','NORMAL_CHAT','../models/models.service','userEntity','querAllDrawLog','update',',\x20错误信息:\x20','stable-diffusion','chat.xlsx','extend','Like','object','xlsx','326624eouNyj','4740771gPQDDa','now','HttpStatus','../chatGroup/chatGroup.entity','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet','你操作的图片不存在、请检查！','gpts','用户名','userInfo','当前页面已经没有东西可以删除了！','__esModule','findAndCount','chatGroupEntity','deleteChatsAfterId','ali','ChatType','querDrawLog','findOneChatLog','Content-Type','end','model','assistant','?x-oss-process=image/resize,w_','__metadata','querAllChatLog','Repository','recDrawImg','2185617PGnaaA','Logger','attachment;\x20filename=','\x20一小时内调用\x20','answer','提问时间','chatHistory','505698wYMYMV','你删除的对话记录不存在、请检查！','metadata','getOwnPropertyDescriptor','InjectRepository','save','assign','function','fileInfo','__decorate','../../common/constants/balance.constant','paintCount','prompt','forEach','1hqhPSP','userId','ceil','chatLogEntity','@nestjs/common','取消推荐','midjourney','filter','UserEntity'];_0x1085=function(){return _0x6e68e5;};return _0x1085();}function _0x2166(_0x49d95a,_0x545102){const _0x108546=_0x1085();return _0x2166=function(_0x2166f3,_0x3b487d){_0x2166f3=_0x2166f3-0x134;let _0x1b990e=_0x108546[_0x2166f3];return _0x1b990e;},_0x2166(_0x49d95a,_0x545102);}(function(_0x35c80f,_0xe87277){const _0x2e62e7=_0x2166,_0x1c3f92=_0x35c80f();while(!![]){try{const _0xbe5bf2=parseInt(_0x2e62e7(0x140))/0x1*(-parseInt(_0x2e62e7(0x174))/0x2)+-parseInt(_0x2e62e7(0x1b5))/0x3+parseInt(_0x2e62e7(0x17f))/0x4+parseInt(_0x2e62e7(0x16b))/0x5*(-parseInt(_0x2e62e7(0x1bc))/0x6)+parseInt(_0x2e62e7(0x19a))/0x7+-parseInt(_0x2e62e7(0x199))/0x8+parseInt(_0x2e62e7(0x15a))/0x9;if(_0xbe5bf2===_0xe87277)break;else _0x1c3f92['push'](_0x1c3f92['shift']());}catch(_0x40e637){_0x1c3f92['push'](_0x1c3f92['shift']());}}}(_0x1085,0x64783));var __decorate=this&&this[_0x42609b(0x13b)]||function(_0x2a58de,_0x49a07d,_0x253bf6,_0x1148c2){const _0x14b14c=_0x42609b;var _0x5bd50c=arguments[_0x14b14c(0x156)],_0x1d50c0=_0x5bd50c<0x3?_0x49a07d:_0x1148c2===null?_0x1148c2=Object[_0x14b14c(0x135)](_0x49a07d,_0x253bf6):_0x1148c2,_0x58782c;if(typeof Reflect===_0x14b14c(0x197)&&typeof Reflect[_0x14b14c(0x184)]===_0x14b14c(0x139))_0x1d50c0=Reflect[_0x14b14c(0x184)](_0x2a58de,_0x49a07d,_0x253bf6,_0x1148c2);else{for(var _0x26e565=_0x2a58de[_0x14b14c(0x156)]-0x1;_0x26e565>=0x0;_0x26e565--)if(_0x58782c=_0x2a58de[_0x26e565])_0x1d50c0=(_0x5bd50c<0x3?_0x58782c(_0x1d50c0):_0x5bd50c>0x3?_0x58782c(_0x49a07d,_0x253bf6,_0x1d50c0):_0x58782c(_0x49a07d,_0x253bf6))||_0x1d50c0;}return _0x5bd50c>0x3&&_0x1d50c0&&Object[_0x14b14c(0x165)](_0x49a07d,_0x253bf6,_0x1d50c0),_0x1d50c0;},__metadata=this&&this[_0x42609b(0x1b1)]||function(_0x3b5c15,_0x19df10){const _0x1e0ed3=_0x42609b;if(typeof Reflect===_0x1e0ed3(0x197)&&typeof Reflect[_0x1e0ed3(0x134)]===_0x1e0ed3(0x139))return Reflect[_0x1e0ed3(0x134)](_0x3b5c15,_0x19df10);},__param=this&&this['__param']||function(_0x2abc9b,_0x3c7d13){return function(_0x1e542b,_0x2ee0f7){_0x3c7d13(_0x1e542b,_0x2ee0f7,_0x2abc9b);};};Object[_0x42609b(0x165)](exports,_0x42609b(0x1a4),{'value':!![]}),exports[_0x42609b(0x14a)]=void 0x0;const balance_constant_1=require(_0x42609b(0x13c)),utils_1=require(_0x42609b(0x181)),common_1=require(_0x42609b(0x144)),typeorm_1=require(_0x42609b(0x155)),exceljs_1=require('exceljs'),typeorm_2=require('typeorm'),chatGroup_entity_1=require(_0x42609b(0x19d)),user_entity_1=require('../user/user.entity'),chatLog_entity_1=require(_0x42609b(0x16a)),models_service_1=require(_0x42609b(0x18e));let ChatLogService=class ChatLogService{constructor(_0x346d85,_0x3fcd4b,_0x33cd02,_0x32a5ef){const _0x943778=_0x42609b;this[_0x943778(0x143)]=_0x346d85,this[_0x943778(0x18f)]=_0x3fcd4b,this[_0x943778(0x1a6)]=_0x33cd02,this[_0x943778(0x167)]=_0x32a5ef;}async[_0x42609b(0x16f)](_0x522ccc){const _0x5e96ea=_0x42609b,_0x519fd0=await this[_0x5e96ea(0x143)][_0x5e96ea(0x137)](_0x522ccc);return _0x519fd0;}async[_0x42609b(0x14d)](_0x30e7b2,_0x5dc26d){const _0x2bd3c5=_0x42609b;return await this[_0x2bd3c5(0x143)][_0x2bd3c5(0x191)]({'id':_0x30e7b2},_0x5dc26d);}async[_0x42609b(0x1ab)](_0x45aca4){return await this['chatLogEntity']['findOne']({'where':{'id':_0x45aca4}});}async[_0x42609b(0x1aa)](_0x1fcac0,_0xac09ba){const _0x1a6169=_0x42609b,{id:_0x322fbf}=_0x1fcac0['user'],{model:_0x7f0740}=_0xac09ba,_0x44f14c={'userId':_0x322fbf,'type':balance_constant_1[_0x1a6169(0x1a9)][_0x1a6169(0x15e)]};_0x7f0740&&(_0x44f14c[_0x1a6169(0x1ae)]=_0x7f0740,_0x7f0740===_0x1a6169(0x157)&&(_0x44f14c[_0x1a6169(0x1ae)]=(0x0,typeorm_2['In'])([_0x1a6169(0x157),_0x1a6169(0x17b)])));const _0x546a4c=await this[_0x1a6169(0x143)]['find']({'where':_0x44f14c,'order':{'id':'DESC'},'select':['id',_0x1a6169(0x1b9),_0x1a6169(0x13e),_0x1a6169(0x1ae),'type','fileInfo']});return _0x546a4c[_0x1a6169(0x13f)](_0xc52f11=>{const _0x162adb=_0x1a6169;if(_0xc52f11['type']===_0x162adb(0x13d)){const _0x12e584=_0xc52f11['model']==='mj'?0x136:0xa0,_0x5b64b5=_0xc52f11['answer'][_0x162adb(0x175)](_0x162adb(0x182))?_0x162adb(0x187):_0x162adb(0x1a8),_0x34b8b1=_0x5b64b5===_0x162adb(0x187)?_0x162adb(0x152)+_0x12e584+_0x162adb(0x17c):_0x162adb(0x1b0)+_0x12e584;_0xc52f11['thumbImg']=_0xc52f11[_0x162adb(0x1b9)]+_0x34b8b1;try{_0xc52f11[_0x162adb(0x13a)]=_0xc52f11[_0x162adb(0x13a)]?JSON[_0x162adb(0x149)](_0xc52f11[_0x162adb(0x13a)]):null;}catch(_0x7d6ba3){_0xc52f11[_0x162adb(0x13a)]={};}}}),_0x546a4c;}async[_0x42609b(0x190)](_0x2fdde3){const _0x389546=_0x42609b,{page:page=0x1,size:size=0x14,rec:_0x51f378,userId:_0x31b49f,model:_0x1745bd}=_0x2fdde3,_0x3ec0a0={'type':0x2,'prompt':(0x0,typeorm_2[_0x389546(0x14e)])(''),'answer':(0x0,typeorm_2[_0x389546(0x14e)])(''),'fileInfo':(0x0,typeorm_2['Not'])('')};_0x51f378&&Object[_0x389546(0x138)](_0x3ec0a0,{'rec':_0x51f378}),_0x31b49f&&Object[_0x389546(0x138)](_0x3ec0a0,{'userId':_0x31b49f});_0x1745bd?_0x3ec0a0['model']=_0x1745bd:_0x3ec0a0[_0x389546(0x1ae)]=(0x0,typeorm_2['In'])([_0x389546(0x146),_0x389546(0x17b),_0x389546(0x193)]);const [_0x5a840a,_0x864bee]=await this[_0x389546(0x143)][_0x389546(0x1a5)]({'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size,'where':_0x3ec0a0}),_0x14156c=_0x5a840a[_0x389546(0x188)](_0x3d874b=>_0x3d874b[_0x389546(0x141)])[_0x389546(0x147)](_0x4a6fa8=>_0x4a6fa8<0x186a0),_0x534bd1=await this['userEntity'][_0x389546(0x17d)]({'where':{'id':(0x0,typeorm_2['In'])(_0x14156c)},'select':['id','username',_0x389546(0x17e),_0x389546(0x185)]});return _0x5a840a[_0x389546(0x13f)](_0x3d5b03=>{const _0x487b71=_0x389546;_0x3d5b03[_0x487b71(0x1a2)]=_0x534bd1['find'](_0x2bbdcc=>_0x2bbdcc['id']===_0x3d5b03[_0x487b71(0x141)]);}),_0x5a840a[_0x389546(0x13f)](_0x29fe9c=>{const _0x1d3d5f=_0x389546;var _0x2248c1;const _0x189a86=_0x29fe9c[_0x1d3d5f(0x1ae)]===_0x1d3d5f(0x146)?0x136:0xa0,_0x2d1101=_0x29fe9c[_0x1d3d5f(0x1b9)][_0x1d3d5f(0x175)]('cos')?_0x1d3d5f(0x187):_0x1d3d5f(0x1a8),_0x305391=_0x2d1101==='tencent'?_0x1d3d5f(0x152)+_0x189a86+_0x1d3d5f(0x17c):_0x1d3d5f(0x1b0)+_0x189a86;_0x29fe9c[_0x1d3d5f(0x16c)]=_0x29fe9c[_0x1d3d5f(0x1b9)]+_0x305391;try{const _0xca51f3=_0x29fe9c['extend']?JSON[_0x1d3d5f(0x149)](_0x29fe9c[_0x1d3d5f(0x195)]):null;_0xca51f3&&(_0xca51f3?_0x29fe9c[_0x1d3d5f(0x173)]=((_0x2248c1=_0xca51f3===null||_0xca51f3===void 0x0?void 0x0:_0xca51f3[_0x1d3d5f(0x189)][0x0])===null||_0x2248c1===void 0x0?void 0x0:_0x2248c1[_0x1d3d5f(0x189)][_0x1d3d5f(0x156)])===0x5:_0x29fe9c['isGroup']=![]);}catch(_0x472f3e){console[_0x1d3d5f(0x169)](_0x1d3d5f(0x15c),_0x472f3e);}}),{'rows':_0x5a840a,'count':_0x864bee};}async[_0x42609b(0x177)](_0x507cf4){const _0x322204=_0x42609b,{id:_0x203655}=_0x507cf4,_0x5e269a=await this['chatLogEntity'][_0x322204(0x166)]({'where':{'id':_0x203655}});return _0x5e269a;}async[_0x42609b(0x1b4)](_0x206718){const _0x26f9bd=_0x42609b,{id:_0x1fe149}=_0x206718,_0x2c635c=await this[_0x26f9bd(0x143)]['findOne']({'where':{'id':_0x1fe149,'type':balance_constant_1[_0x26f9bd(0x1a9)][_0x26f9bd(0x15e)]}});if(!_0x2c635c)throw new common_1['HttpException'](_0x26f9bd(0x14f),common_1['HttpStatus']['BAD_REQUEST']);const _0x4dcdf7=_0x2c635c[_0x26f9bd(0x15b)]===0x1?0x0:0x1,_0x489e15=await this[_0x26f9bd(0x143)][_0x26f9bd(0x191)]({'id':_0x1fe149},{'rec':_0x4dcdf7});if(_0x489e15[_0x26f9bd(0x18b)]>0x0)return(_0x4dcdf7?'推荐':_0x26f9bd(0x145))+'图片成功！';throw new common_1['HttpException'](_0x26f9bd(0x19f),common_1[_0x26f9bd(0x19c)]['BAD_REQUEST']);}async[_0x42609b(0x179)](_0x30f206,_0x45060f){const _0x5c8274=_0x42609b,_0x3b9d89={'type':balance_constant_1[_0x5c8274(0x1a9)][_0x5c8274(0x18d)]},{page:page=0x1,size:size=0x1e,prompt:_0x4fb001,email:_0x2d774d}=_0x30f206;_0x4fb001&&Object[_0x5c8274(0x138)](_0x3b9d89,{'prompt':(0x0,typeorm_2[_0x5c8274(0x196)])('%'+_0x4fb001+'%')});if(_0x2d774d){const _0x491388=await this[_0x5c8274(0x18f)][_0x5c8274(0x166)]({'where':{'email':_0x2d774d}});(_0x491388===null||_0x491388===void 0x0?void 0x0:_0x491388['id'])&&Object[_0x5c8274(0x138)](_0x3b9d89,{'userId':_0x491388['id']});}const [_0x5bfd9c,_0x53a98e]=await this[_0x5c8274(0x143)][_0x5c8274(0x1a5)]({'order':{'id':_0x5c8274(0x159)},'skip':(page-0x1)*size,'take':size,'where':_0x3b9d89}),_0x3cf8b8=_0x5bfd9c[_0x5c8274(0x188)](_0x4eafbd=>_0x4eafbd['userId']),_0x38739f=await this[_0x5c8274(0x18f)][_0x5c8274(0x17d)]({'where':{'id':(0x0,typeorm_2['In'])(_0x3cf8b8)}}),_0x3f7fe0=_0x5bfd9c[_0x5c8274(0x188)](_0x1ae96e=>{const _0x2b9408=_0x5c8274,_0x13e6e6=_0x38739f[_0x2b9408(0x17d)](_0xf1a603=>_0xf1a603['id']===_0x1ae96e[_0x2b9408(0x141)]);return{'username':_0x13e6e6?_0x13e6e6[_0x2b9408(0x164)]:'','email':_0x13e6e6?_0x13e6e6[_0x2b9408(0x185)]:'','prompt':_0x1ae96e[_0x2b9408(0x13e)],'answer':_0x1ae96e[_0x2b9408(0x1b9)],'createdAt':(0x0,utils_1[_0x2b9408(0x163)])(_0x1ae96e['createdAt'])};}),_0x347e8e=new exceljs_1[(_0x5c8274(0x186))][(_0x5c8274(0x15d))](),_0x7f2e7b=_0x347e8e[_0x5c8274(0x18a)]('chatlog');_0x7f2e7b['columns']=[{'header':_0x5c8274(0x1a1),'key':'username','width':0x14},{'header':_0x5c8274(0x172),'key':_0x5c8274(0x185),'width':0x14},{'header':_0x5c8274(0x1ba),'key':_0x5c8274(0x162),'width':0x14},{'header':'提问问题','key':_0x5c8274(0x13e),'width':0x50},{'header':'回答答案','key':_0x5c8274(0x1b9),'width':0x96}],_0x3f7fe0[_0x5c8274(0x13f)](_0x3384e6=>_0x7f2e7b[_0x5c8274(0x158)](_0x3384e6)),_0x45060f['setHeader'](_0x5c8274(0x1ac),_0x5c8274(0x19e)),_0x45060f[_0x5c8274(0x18c)](_0x5c8274(0x168),_0x5c8274(0x1b7)+_0x5c8274(0x194)),await _0x347e8e[_0x5c8274(0x198)]['write'](_0x45060f),_0x45060f[_0x5c8274(0x1ad)]();}async[_0x42609b(0x1b2)](_0x2c5a8e,_0x529c51){const _0x57cc61=_0x42609b,{page:page=0x1,size:size=0x14,userId:_0x126c94,prompt:_0x2087ff}=_0x2c5a8e,_0x2126c3={'type':balance_constant_1[_0x57cc61(0x1a9)][_0x57cc61(0x18d)],'prompt':(0x0,typeorm_2[_0x57cc61(0x14e)])('')};_0x126c94&&Object['assign'](_0x2126c3,{'userId':_0x126c94}),_0x2087ff&&Object[_0x57cc61(0x138)](_0x2126c3,{'prompt':(0x0,typeorm_2[_0x57cc61(0x196)])('%'+_0x2087ff+'%')});const [_0x4cfb85,_0xd375b]=await this[_0x57cc61(0x143)][_0x57cc61(0x1a5)]({'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size,'where':_0x2126c3}),_0x17382c=_0x4cfb85['map'](_0x520cbe=>_0x520cbe[_0x57cc61(0x141)]),_0x178853=await this[_0x57cc61(0x18f)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x17382c)},'select':['id','username',_0x57cc61(0x185)]});return _0x4cfb85['forEach'](_0x12c1fb=>{const _0x674292=_0x57cc61,{username:_0x18c88a,email:_0x71a6a8}=_0x178853[_0x674292(0x17d)](_0x27e208=>_0x27e208['id']===_0x12c1fb['userId'])||{};_0x12c1fb[_0x674292(0x164)]=_0x18c88a,_0x12c1fb['email']=_0x71a6a8;}),_0x529c51[_0x57cc61(0x150)][_0x57cc61(0x15f)]!=='super'&&_0x4cfb85[_0x57cc61(0x13f)](_0x4a4d1f=>_0x4a4d1f['email']=(0x0,utils_1[_0x57cc61(0x16e)])(_0x4a4d1f[_0x57cc61(0x185)])),_0x4cfb85['forEach'](_0x16dde5=>{const _0x5795b0=_0x57cc61;!_0x16dde5['email']&&(_0x16dde5[_0x5795b0(0x185)]=(_0x16dde5===null||_0x16dde5===void 0x0?void 0x0:_0x16dde5[_0x5795b0(0x141)])+_0x5795b0(0x14c)),!_0x16dde5[_0x5795b0(0x164)]&&(_0x16dde5[_0x5795b0(0x164)]='游客'+(_0x16dde5===null||_0x16dde5===void 0x0?void 0x0:_0x16dde5[_0x5795b0(0x141)]));}),{'rows':_0x4cfb85,'count':_0xd375b};}async[_0x42609b(0x171)](_0x4b0e24,_0xf73c53){const _0x4969e3=_0x42609b,{id:_0x219f04}=_0x4b0e24['user'],{groupId:_0x422e20}=_0xf73c53,_0x27e3aa={'userId':_0x219f04,'isDelete':![]};_0x422e20&&Object['assign'](_0x27e3aa,{'groupId':_0x422e20});if(_0x422e20){const _0x386c7c=await this[_0x4969e3(0x1a6)]['count']({'where':{'isDelete':![]}});if(_0x386c7c===0x0)return[];}const _0x3e8856=await this[_0x4969e3(0x143)][_0x4969e3(0x17d)]({'where':_0x27e3aa});return _0x3e8856[_0x4969e3(0x188)](_0x1d43db=>{const _0x4859a9=_0x4969e3,{prompt:_0x366c75,role:_0x255b35,answer:_0x58b2fd,createdAt:_0x18d5eb,model:_0x4764c7,modelName:_0x397955,type:_0x801c19,status:_0x58677c,action:_0x54191a,drawId:_0x1d21fe,id:_0x1b62b0,fileInfo:_0x1cbe02,ttsUrl:_0x4c5723,videoUrl:_0x5cd1db,audioUrl:_0x3fc055,customId:_0xb78d92,pluginParam:_0x1190e7,modelAvatar:_0x162f69,taskData:_0x21ea65,promptReference:_0x1f8ad9}=_0x1d43db;return{'chatId':_0x1b62b0,'dateTime':(0x0,utils_1['formatDate'])(_0x18d5eb),'text':_0x255b35===_0x4859a9(0x150)?_0x366c75:_0x58b2fd,'modelType':_0x801c19,'status':_0x58677c,'action':_0x54191a,'drawId':_0x1d21fe,'customId':_0xb78d92,'inversion':_0x255b35==='user','error':![],'fileInfo':_0x1cbe02,'ttsUrl':_0x4c5723,'videoUrl':_0x5cd1db,'audioUrl':_0x3fc055,'model':_0x4764c7,'modelName':_0x397955,'pluginParam':_0x1190e7,'modelAvatar':_0x162f69,'taskData':_0x21ea65,'promptReference':_0x1f8ad9};});}async[_0x42609b(0x1bb)](_0x5bf2ef,_0x172210){const _0x11694e=_0x42609b;if(_0x172210===0x0)return[];const _0x289bb9={'isDelete':![],'groupId':_0x5bf2ef},_0x582715=await this[_0x11694e(0x143)][_0x11694e(0x17d)]({'where':_0x289bb9,'order':{'createdAt':_0x11694e(0x159)},'take':_0x172210*0x2}),_0x195718=_0x582715[_0x11694e(0x188)](_0x554f01=>{const _0x2bde9f=_0x11694e,{role:_0x274f8b,prompt:_0x56baa9,answer:_0x3227a5,fileInfo:_0x3a9941}=_0x554f01,_0x2ed3eb={'role':_0x274f8b,'text':_0x274f8b===_0x2bde9f(0x150)?_0x56baa9:_0x3227a5,'fileInfo':_0x3a9941};return _0x2ed3eb;})['reverse']();return _0x195718;}async['deleteChatLog'](_0xbbf10d,_0x403b8f){const _0x1d6dae=_0x42609b,{id:_0x599d06}=_0xbbf10d[_0x1d6dae(0x150)],{id:_0xb1c421}=_0x403b8f,_0x31db37=await this[_0x1d6dae(0x143)][_0x1d6dae(0x166)]({'where':{'id':_0xb1c421,'userId':_0x599d06}});if(!_0x31db37)throw new common_1[(_0x1d6dae(0x151))](_0x1d6dae(0x1bd),common_1[_0x1d6dae(0x19c)][_0x1d6dae(0x170)]);const _0x51ff3f=await this['chatLogEntity']['update']({'id':_0xb1c421},{'isDelete':!![]});if(_0x51ff3f['affected']>0x0)return _0x1d6dae(0x161);else throw new common_1[(_0x1d6dae(0x151))](_0x1d6dae(0x1bd),common_1['HttpStatus'][_0x1d6dae(0x170)]);}async[_0x42609b(0x153)](_0xc8adf2,_0x44532e){const _0x38cc6e=_0x42609b,{groupId:_0x267373}=_0x44532e,{id:_0x482355}=_0xc8adf2[_0x38cc6e(0x150)],_0x1b8013=await this[_0x38cc6e(0x1a6)][_0x38cc6e(0x166)]({'where':{'id':_0x267373,'userId':_0x482355}});if(!_0x1b8013)throw new common_1[(_0x38cc6e(0x151))](_0x38cc6e(0x1bd),common_1['HttpStatus'][_0x38cc6e(0x170)]);const _0x1f7eb0=await this['chatLogEntity'][_0x38cc6e(0x191)]({'groupId':_0x267373},{'isDelete':!![]});if(_0x1f7eb0[_0x38cc6e(0x18b)]>0x0)return _0x38cc6e(0x161);if(_0x1f7eb0[_0x38cc6e(0x18b)]===0x0)throw new common_1['HttpException'](_0x38cc6e(0x1a3),common_1[_0x38cc6e(0x19c)][_0x38cc6e(0x170)]);}async[_0x42609b(0x1a7)](_0x3001dc,_0x2428ac){const _0x1f66c7=_0x42609b,{id:_0x577ea1}=_0x2428ac,{id:_0x4ac8df}=_0x3001dc[_0x1f66c7(0x150)],_0x152d75=await this[_0x1f66c7(0x143)][_0x1f66c7(0x166)]({'where':{'id':_0x577ea1,'userId':_0x4ac8df}});if(!_0x152d75)throw new common_1['HttpException'](_0x1f66c7(0x1bd),common_1[_0x1f66c7(0x19c)][_0x1f66c7(0x170)]);const {groupId:_0x262ff7}=_0x152d75,_0x5de628=await this[_0x1f66c7(0x143)]['update']({'groupId':_0x262ff7,'id':(0x0,typeorm_2['MoreThanOrEqual'])(_0x577ea1)},{'isDelete':!![]});if(_0x5de628[_0x1f66c7(0x18b)]>0x0)return _0x1f66c7(0x161);else throw new common_1[(_0x1f66c7(0x151))](_0x1f66c7(0x1a3),common_1[_0x1f66c7(0x19c)][_0x1f66c7(0x170)]);}async['byAppId'](_0x484681,_0x59ab07){const _0x3f608b=_0x42609b,{id:_0x3ade53}=_0x484681['user'],{appId:_0xceeb33,page:page=0x1,size:size=0xa}=_0x59ab07,[_0x15ecf8,_0x8a06d4]=await this[_0x3f608b(0x143)]['findAndCount']({'where':{'userId':_0x3ade53,'appId':_0xceeb33,'role':_0x3f608b(0x1af)},'order':{'id':_0x3f608b(0x159)},'take':size,'skip':(page-0x1)*size});return{'rows':_0x15ecf8,'count':_0x8a06d4};}async[_0x42609b(0x17a)](_0x1bf96e,_0x9d7e54){const _0x4bc92c=_0x42609b,_0x1a7bda=0xe10*0x3e8,_0xf7dc33=new Date(Date[_0x4bc92c(0x19b)]()-_0x1a7bda);try{const _0x44eb58=await this['chatLogEntity']['count']({'where':{'userId':_0x1bf96e['id'],'model':_0x9d7e54,'createdAt':(0x0,typeorm_2[_0x4bc92c(0x154)])(_0xf7dc33)}}),_0x5ad5e8=Math[_0x4bc92c(0x142)](_0x44eb58/0x2);common_1[_0x4bc92c(0x1b6)]['log']('用户ID:\x20'+_0x1bf96e['id']+_0x4bc92c(0x1b8)+_0x9d7e54+_0x4bc92c(0x180)+(_0x5ad5e8+0x1)+'\x20次',_0x4bc92c(0x14a));let _0x1a8a59;_0x9d7e54['startsWith'](_0x4bc92c(0x178))?_0x1a8a59=await this[_0x4bc92c(0x167)][_0x4bc92c(0x176)](_0x4bc92c(0x1a0)):_0x1a8a59=await this[_0x4bc92c(0x167)]['getCurrentModelKeyInfo'](_0x9d7e54);const _0x41e58c=Number(_0x1a8a59[_0x4bc92c(0x160)]);common_1[_0x4bc92c(0x1b6)][_0x4bc92c(0x169)]('模型\x20'+_0x9d7e54+'\x20的使用次数限制为\x20'+_0x41e58c,'ChatLogService');if(_0x5ad5e8>_0x41e58c)return!![];return![];}catch(_0x38b44a){common_1[_0x4bc92c(0x1b6)]['error']('查询数据库出错\x20-\x20用户ID:\x20'+_0x1bf96e['id']+',\x20模型:\x20'+_0x9d7e54+_0x4bc92c(0x192)+_0x38b44a['message'],_0x38b44a['stack'],'ChatLogService');}}};ChatLogService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x42609b(0x136)])(chatLog_entity_1[_0x42609b(0x16d)])),__param(0x1,(0x0,typeorm_1[_0x42609b(0x136)])(user_entity_1[_0x42609b(0x148)])),__param(0x2,(0x0,typeorm_1[_0x42609b(0x136)])(chatGroup_entity_1['ChatGroupEntity'])),__metadata(_0x42609b(0x14b),[typeorm_2[_0x42609b(0x1b3)],typeorm_2[_0x42609b(0x1b3)],typeorm_2[_0x42609b(0x1b3)],models_service_1[_0x42609b(0x183)]])],ChatLogService),exports[_0x42609b(0x14a)]=ChatLogService;