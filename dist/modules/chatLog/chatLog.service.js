'use strict';function _0x43fe(_0x21d545,_0x381da3){const _0x4b3742=_0x4b37();return _0x43fe=function(_0x43fefb,_0x284ab2){_0x43fefb=_0x43fefb-0x78;let _0x2d82ef=_0x4b3742[_0x43fefb];return _0x2d82ef;},_0x43fe(_0x21d545,_0x381da3);}const _0x27f742=_0x43fe;(function(_0x4ff270,_0x3f34bf){const _0xd8f931=_0x43fe,_0x26602a=_0x4ff270();while(!![]){try{const _0x3c92c4=-parseInt(_0xd8f931(0xbd))/0x1+-parseInt(_0xd8f931(0xe8))/0x2+parseInt(_0xd8f931(0xa0))/0x3*(parseInt(_0xd8f931(0xff))/0x4)+parseInt(_0xd8f931(0x7c))/0x5*(-parseInt(_0xd8f931(0xb5))/0x6)+-parseInt(_0xd8f931(0xc6))/0x7+-parseInt(_0xd8f931(0xaa))/0x8+parseInt(_0xd8f931(0xa6))/0x9;if(_0x3c92c4===_0x3f34bf)break;else _0x26602a['push'](_0x26602a['shift']());}catch(_0x3dbe60){_0x26602a['push'](_0x26602a['shift']());}}}(_0x4b37,0xb141e));var __decorate=this&&this[_0x27f742(0xdf)]||function(_0x2d23b0,_0xede991,_0x15f8dd,_0x5aa80f){const _0x7f967f=_0x27f742;var _0x18ab1b=arguments['length'],_0x3316f9=_0x18ab1b<0x3?_0xede991:_0x5aa80f===null?_0x5aa80f=Object[_0x7f967f(0x7b)](_0xede991,_0x15f8dd):_0x5aa80f,_0x14a856;if(typeof Reflect===_0x7f967f(0x101)&&typeof Reflect[_0x7f967f(0x8f)]==='function')_0x3316f9=Reflect[_0x7f967f(0x8f)](_0x2d23b0,_0xede991,_0x15f8dd,_0x5aa80f);else{for(var _0x42180e=_0x2d23b0[_0x7f967f(0x8e)]-0x1;_0x42180e>=0x0;_0x42180e--)if(_0x14a856=_0x2d23b0[_0x42180e])_0x3316f9=(_0x18ab1b<0x3?_0x14a856(_0x3316f9):_0x18ab1b>0x3?_0x14a856(_0xede991,_0x15f8dd,_0x3316f9):_0x14a856(_0xede991,_0x15f8dd))||_0x3316f9;}return _0x18ab1b>0x3&&_0x3316f9&&Object[_0x7f967f(0xc8)](_0xede991,_0x15f8dd,_0x3316f9),_0x3316f9;},__metadata=this&&this['__metadata']||function(_0x1c21de,_0x212ebc){const _0x2e04e6=_0x27f742;if(typeof Reflect===_0x2e04e6(0x101)&&typeof Reflect[_0x2e04e6(0x7f)]===_0x2e04e6(0xa7))return Reflect[_0x2e04e6(0x7f)](_0x1c21de,_0x212ebc);},__param=this&&this[_0x27f742(0xe3)]||function(_0x1d9588,_0x37d929){return function(_0xbc7301,_0x3db700){_0x37d929(_0xbc7301,_0x3db700,_0x1d9588);};};Object[_0x27f742(0xc8)](exports,_0x27f742(0xf7),{'value':!![]}),exports[_0x27f742(0xf1)]=void 0x0;const balance_constant_1=require(_0x27f742(0x96)),utils_1=require(_0x27f742(0x108)),common_1=require(_0x27f742(0x9e)),typeorm_1=require(_0x27f742(0xb7)),exceljs_1=require(_0x27f742(0x94)),typeorm_2=require('typeorm'),chatGroup_entity_1=require(_0x27f742(0xe0)),user_entity_1=require(_0x27f742(0x91)),chatLog_entity_1=require(_0x27f742(0xa1)),models_service_1=require(_0x27f742(0xc1));let ChatLogService=class ChatLogService{constructor(_0x267153,_0x51a521,_0xe26bb9,_0x263257){this['chatLogEntity']=_0x267153,this['userEntity']=_0x51a521,this['chatGroupEntity']=_0xe26bb9,this['modelsService']=_0x263257;}async['saveChatLog'](_0x17959e){const _0x5c74fa=_0x27f742,_0x13bf03=await this[_0x5c74fa(0x85)][_0x5c74fa(0x83)](_0x17959e);return _0x13bf03;}async[_0x27f742(0x88)](_0x798f4d,_0x5d9377){const _0x43d2ab=_0x27f742;return await this['chatLogEntity'][_0x43d2ab(0xfe)]({'id':_0x798f4d},_0x5d9377);}async[_0x27f742(0x78)](_0x5adb99){const _0xe23988=_0x27f742;return await this['chatLogEntity'][_0xe23988(0xd7)]({'where':{'id':_0x5adb99}});}async[_0x27f742(0x9d)](_0x1ad7b1,_0x271ca1){const _0x3058bd=_0x27f742,{id:_0x1235b5}=_0x1ad7b1[_0x3058bd(0x9a)],{model:_0x452212}=_0x271ca1,_0x2189d8={'userId':_0x1235b5,'type':balance_constant_1[_0x3058bd(0x95)]['PAINT']};_0x452212&&(_0x2189d8[_0x3058bd(0xb4)]=_0x452212,_0x452212===_0x3058bd(0xfd)&&(_0x2189d8[_0x3058bd(0xb4)]=(0x0,typeorm_2['In'])([_0x3058bd(0xfd),'dall-e-3'])));const _0x5b8f0a=await this['chatLogEntity']['find']({'where':_0x2189d8,'order':{'id':_0x3058bd(0xa8)},'select':['id',_0x3058bd(0x98),_0x3058bd(0xf0),_0x3058bd(0xb4),_0x3058bd(0xec),_0x3058bd(0x8a)]});return _0x5b8f0a['forEach'](_0x18cc56=>{const _0x3f4b78=_0x3058bd;if(_0x18cc56[_0x3f4b78(0xec)]==='paintCount'){const _0x69a108=_0x18cc56[_0x3f4b78(0xb4)]==='mj'?0x136:0xa0,_0x425cee=_0x18cc56[_0x3f4b78(0x98)][_0x3f4b78(0xc4)](_0x3f4b78(0x8d))?'tencent':_0x3f4b78(0x100),_0xb1976f=_0x425cee===_0x3f4b78(0xbc)?_0x3f4b78(0xd2)+_0x69a108+_0x3f4b78(0x82):_0x3f4b78(0xc3)+_0x69a108;_0x18cc56['thumbImg']=_0x18cc56[_0x3f4b78(0x98)]+_0xb1976f;try{_0x18cc56['fileInfo']=_0x18cc56[_0x3f4b78(0x8a)]?JSON['parse'](_0x18cc56[_0x3f4b78(0x8a)]):null;}catch(_0x5d2e84){_0x18cc56[_0x3f4b78(0x8a)]={};}}}),_0x5b8f0a;}async[_0x27f742(0xd8)](_0x50c0c6){const _0x1c5fdd=_0x27f742,{page:page=0x1,size:size=0x14,rec:_0x35f316,userId:_0x1313b6,model:_0x1edb9e}=_0x50c0c6,_0x55cb6c={'type':0x2,'prompt':(0x0,typeorm_2[_0x1c5fdd(0x103)])(''),'answer':(0x0,typeorm_2[_0x1c5fdd(0x103)])(''),'fileInfo':(0x0,typeorm_2[_0x1c5fdd(0x103)])('')};_0x35f316&&Object[_0x1c5fdd(0xc0)](_0x55cb6c,{'rec':_0x35f316}),_0x1313b6&&Object['assign'](_0x55cb6c,{'userId':_0x1313b6});_0x1edb9e?_0x55cb6c[_0x1c5fdd(0xb4)]=_0x1edb9e:_0x55cb6c['model']=(0x0,typeorm_2['In'])([_0x1c5fdd(0x84),_0x1c5fdd(0xcf),_0x1c5fdd(0x93)]);const [_0x344dcc,_0x3f05b9]=await this[_0x1c5fdd(0x85)]['findAndCount']({'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size,'where':_0x55cb6c}),_0x1acc0b=_0x344dcc[_0x1c5fdd(0xe6)](_0x3e32d1=>_0x3e32d1[_0x1c5fdd(0x7d)])[_0x1c5fdd(0x9b)](_0x438cdb=>_0x438cdb<0x186a0),_0x163e24=await this[_0x1c5fdd(0xea)][_0x1c5fdd(0xce)]({'where':{'id':(0x0,typeorm_2['In'])(_0x1acc0b)},'select':['id','username',_0x1c5fdd(0xf6),_0x1c5fdd(0xdd)]});return _0x344dcc['forEach'](_0x472c1e=>{const _0x1d0fe6=_0x1c5fdd;_0x472c1e['userInfo']=_0x163e24[_0x1d0fe6(0xce)](_0x7b53a1=>_0x7b53a1['id']===_0x472c1e[_0x1d0fe6(0x7d)]);}),_0x344dcc[_0x1c5fdd(0xba)](_0x155c2c=>{const _0x57d025=_0x1c5fdd;var _0x302d41;const _0x59a8ef=_0x155c2c[_0x57d025(0xb4)]===_0x57d025(0x84)?0x136:0xa0,_0x2509a7=_0x155c2c[_0x57d025(0x98)]['includes'](_0x57d025(0x8d))?_0x57d025(0xbc):'ali',_0x17e33d=_0x2509a7===_0x57d025(0xbc)?_0x57d025(0xd2)+_0x59a8ef+_0x57d025(0x82):_0x57d025(0xc3)+_0x59a8ef;_0x155c2c[_0x57d025(0xd9)]=_0x155c2c[_0x57d025(0x98)]+_0x17e33d;try{const _0x330bcd=_0x155c2c['extend']?JSON[_0x57d025(0xc9)](_0x155c2c[_0x57d025(0xb2)]):null;_0x330bcd&&(_0x330bcd?_0x155c2c['isGroup']=((_0x302d41=_0x330bcd===null||_0x330bcd===void 0x0?void 0x0:_0x330bcd[_0x57d025(0xae)][0x0])===null||_0x302d41===void 0x0?void 0x0:_0x302d41[_0x57d025(0xae)][_0x57d025(0x8e)])===0x5:_0x155c2c[_0x57d025(0xac)]=![]);}catch(_0x3a70ca){console[_0x57d025(0xb9)](_0x57d025(0xdc),_0x3a70ca);}}),{'rows':_0x344dcc,'count':_0x3f05b9};}async[_0x27f742(0xf9)](_0x3cc093){const _0x352806=_0x27f742,{id:_0x10ed44}=_0x3cc093,_0xb0a7c2=await this['chatLogEntity'][_0x352806(0xd7)]({'where':{'id':_0x10ed44}});return _0xb0a7c2;}async[_0x27f742(0xc5)](_0x51a9a7){const _0x4d1271=_0x27f742,{id:_0x209ae4}=_0x51a9a7,_0x3fe215=await this['chatLogEntity'][_0x4d1271(0xd7)]({'where':{'id':_0x209ae4,'type':balance_constant_1[_0x4d1271(0x95)]['PAINT']}});if(!_0x3fe215)throw new common_1[(_0x4d1271(0x80))](_0x4d1271(0xe1),common_1[_0x4d1271(0xef)]['BAD_REQUEST']);const _0x306a9a=_0x3fe215['rec']===0x1?0x0:0x1,_0x20f0a4=await this[_0x4d1271(0x85)][_0x4d1271(0xfe)]({'id':_0x209ae4},{'rec':_0x306a9a});if(_0x20f0a4['affected']>0x0)return(_0x306a9a?'推荐':_0x4d1271(0xca))+_0x4d1271(0x107);throw new common_1[(_0x4d1271(0x80))](_0x4d1271(0xfb),common_1[_0x4d1271(0xef)]['BAD_REQUEST']);}async[_0x27f742(0x106)](_0x23a223,_0x1db246){const _0x88629f=_0x27f742,_0x55a4e7={'type':balance_constant_1['ChatType'][_0x88629f(0xb1)]},{page:page=0x1,size:size=0x1e,prompt:_0x32f555,email:_0x5b132a}=_0x23a223;_0x32f555&&Object[_0x88629f(0xc0)](_0x55a4e7,{'prompt':(0x0,typeorm_2[_0x88629f(0x99)])('%'+_0x32f555+'%')});if(_0x5b132a){const _0x368749=await this[_0x88629f(0xea)][_0x88629f(0xd7)]({'where':{'email':_0x5b132a}});(_0x368749===null||_0x368749===void 0x0?void 0x0:_0x368749['id'])&&Object[_0x88629f(0xc0)](_0x55a4e7,{'userId':_0x368749['id']});}const [_0x39e15b,_0x5cb0f0]=await this[_0x88629f(0x85)][_0x88629f(0xa3)]({'order':{'id':_0x88629f(0xa8)},'skip':(page-0x1)*size,'take':size,'where':_0x55a4e7}),_0x59be36=_0x39e15b[_0x88629f(0xe6)](_0x30439d=>_0x30439d[_0x88629f(0x7d)]),_0x19d1d1=await this[_0x88629f(0xea)][_0x88629f(0xce)]({'where':{'id':(0x0,typeorm_2['In'])(_0x59be36)}}),_0x2d2e2a=_0x39e15b[_0x88629f(0xe6)](_0x1b130=>{const _0x44a293=_0x88629f,_0x546f74=_0x19d1d1[_0x44a293(0xce)](_0x3e5771=>_0x3e5771['id']===_0x1b130[_0x44a293(0x7d)]);return{'username':_0x546f74?_0x546f74[_0x44a293(0x9c)]:'','email':_0x546f74?_0x546f74[_0x44a293(0xdd)]:'','prompt':_0x1b130[_0x44a293(0xf0)],'answer':_0x1b130[_0x44a293(0x98)],'createdAt':(0x0,utils_1['formatDate'])(_0x1b130[_0x44a293(0xb0)])};}),_0x330f2f=new exceljs_1[(_0x88629f(0x105))]['Workbook'](),_0x1abc8a=_0x330f2f[_0x88629f(0xde)](_0x88629f(0xad));_0x1abc8a[_0x88629f(0xb3)]=[{'header':_0x88629f(0x79),'key':_0x88629f(0x9c),'width':0x14},{'header':_0x88629f(0x8c),'key':_0x88629f(0xdd),'width':0x14},{'header':_0x88629f(0xcc),'key':_0x88629f(0xb0),'width':0x14},{'header':_0x88629f(0x7e),'key':_0x88629f(0xf0),'width':0x50},{'header':_0x88629f(0x87),'key':_0x88629f(0x98),'width':0x96}],_0x2d2e2a[_0x88629f(0xba)](_0x6f1beb=>_0x1abc8a[_0x88629f(0xeb)](_0x6f1beb)),_0x1db246[_0x88629f(0xab)]('Content-Type',_0x88629f(0xaf)),_0x1db246[_0x88629f(0xab)](_0x88629f(0x97),_0x88629f(0xdb)+'chat.xlsx'),await _0x330f2f[_0x88629f(0xe7)][_0x88629f(0xbe)](_0x1db246),_0x1db246['end']();}async['querAllChatLog'](_0x3ad12f,_0x2fea5a){const _0xb7572b=_0x27f742,{page:page=0x1,size:size=0x14,userId:_0x419e03,prompt:_0x51b198}=_0x3ad12f,_0x1748dd={'type':balance_constant_1[_0xb7572b(0x95)][_0xb7572b(0xb1)],'prompt':(0x0,typeorm_2[_0xb7572b(0x103)])('')};_0x419e03&&Object[_0xb7572b(0xc0)](_0x1748dd,{'userId':_0x419e03}),_0x51b198&&Object[_0xb7572b(0xc0)](_0x1748dd,{'prompt':(0x0,typeorm_2[_0xb7572b(0x99)])('%'+_0x51b198+'%')});const [_0xaa672d,_0x3e1ca5]=await this[_0xb7572b(0x85)][_0xb7572b(0xa3)]({'order':{'id':_0xb7572b(0xa8)},'skip':(page-0x1)*size,'take':size,'where':_0x1748dd}),_0x4385da=_0xaa672d[_0xb7572b(0xe6)](_0x433f4d=>_0x433f4d[_0xb7572b(0x7d)]),_0x4e7ddb=await this[_0xb7572b(0xea)][_0xb7572b(0xce)]({'where':{'id':(0x0,typeorm_2['In'])(_0x4385da)},'select':['id',_0xb7572b(0x9c),'email']});return _0xaa672d['forEach'](_0x3d97e0=>{const _0x25ffe6=_0xb7572b,{username:_0x1d324e,email:_0x508155}=_0x4e7ddb[_0x25ffe6(0xce)](_0x1e1973=>_0x1e1973['id']===_0x3d97e0[_0x25ffe6(0x7d)])||{};_0x3d97e0[_0x25ffe6(0x9c)]=_0x1d324e,_0x3d97e0[_0x25ffe6(0xdd)]=_0x508155;}),_0x2fea5a['user'][_0xb7572b(0xc2)]!==_0xb7572b(0xd1)&&_0xaa672d[_0xb7572b(0xba)](_0x5924a3=>_0x5924a3[_0xb7572b(0xdd)]=(0x0,utils_1[_0xb7572b(0x89)])(_0x5924a3['email'])),_0xaa672d['forEach'](_0x9bf7ae=>{const _0x41deb0=_0xb7572b;!_0x9bf7ae[_0x41deb0(0xdd)]&&(_0x9bf7ae['email']=(_0x9bf7ae===null||_0x9bf7ae===void 0x0?void 0x0:_0x9bf7ae[_0x41deb0(0x7d)])+_0x41deb0(0xf5)),!_0x9bf7ae[_0x41deb0(0x9c)]&&(_0x9bf7ae[_0x41deb0(0x9c)]='游客'+(_0x9bf7ae===null||_0x9bf7ae===void 0x0?void 0x0:_0x9bf7ae['userId']));}),{'rows':_0xaa672d,'count':_0x3e1ca5};}async[_0x27f742(0xf8)](_0x3b9974,_0x27493f){const _0x2ff67b=_0x27f742,{id:_0x50b86c}=_0x3b9974['user'],{groupId:_0x1465d8}=_0x27493f,_0x48548d={'userId':_0x50b86c,'isDelete':![]};_0x1465d8&&Object[_0x2ff67b(0xc0)](_0x48548d,{'groupId':_0x1465d8});if(_0x1465d8){const _0x40ec7d=await this[_0x2ff67b(0x90)]['count']({'where':{'isDelete':![]}});if(_0x40ec7d===0x0)return[];}const _0x418e33=await this['chatLogEntity']['find']({'where':_0x48548d});return _0x418e33['map'](_0x1d24b6=>{const _0xfb57e=_0x2ff67b,{prompt:_0x25b4ae,role:_0x8a88c7,answer:_0x17230c,createdAt:_0x4fcdc2,model:_0x40b716,modelName:_0x183dd7,type:_0xef936c,status:_0x4e57c7,action:_0x58e09b,drawId:_0x17d5e4,id:_0x3ee01c,fileInfo:_0x54f8f7,ttsUrl:_0x5c120e,videoUrl:_0x3685f9,audioUrl:_0x2f7dac,customId:_0x3aecf3,pluginParam:_0x1c6013,modelAvatar:_0x5a0035,taskData:_0x1c0d00,promptReference:_0x3d7cdd}=_0x1d24b6;return{'chatId':_0x3ee01c,'dateTime':(0x0,utils_1[_0xfb57e(0xf2)])(_0x4fcdc2),'text':_0x8a88c7===_0xfb57e(0x9a)?_0x25b4ae:_0x17230c,'modelType':_0xef936c,'status':_0x4e57c7,'action':_0x58e09b,'drawId':_0x17d5e4,'customId':_0x3aecf3,'inversion':_0x8a88c7===_0xfb57e(0x9a),'error':![],'fileInfo':_0x54f8f7,'ttsUrl':_0x5c120e,'videoUrl':_0x3685f9,'audioUrl':_0x2f7dac,'model':_0x40b716,'modelName':_0x183dd7,'pluginParam':_0x1c6013,'modelAvatar':_0x5a0035,'taskData':_0x1c0d00,'promptReference':_0x3d7cdd};});}async[_0x27f742(0x104)](_0x279a24,_0x3a20fe){const _0x3beb8a=_0x27f742;if(_0x3a20fe===0x0)return[];const _0x41eee0={'isDelete':![],'groupId':_0x279a24},_0x5c720f=await this[_0x3beb8a(0x85)]['find']({'where':_0x41eee0,'order':{'createdAt':_0x3beb8a(0xa8)},'take':_0x3a20fe*0x2}),_0x1ebe86=_0x5c720f[_0x3beb8a(0xe6)](_0x8a7b6c=>{const {role:_0x280bcc,prompt:_0x34a8f5,answer:_0x3176bf,fileInfo:_0x3e2b1f}=_0x8a7b6c,_0x388f09={'role':_0x280bcc,'text':_0x280bcc==='user'?_0x34a8f5:_0x3176bf,'fileInfo':_0x3e2b1f};return _0x388f09;})[_0x3beb8a(0x86)]();return _0x1ebe86;}async[_0x27f742(0xbb)](_0x1e6a6d,_0x20dd53){const _0x1e18ed=_0x27f742,{id:_0xf083d9}=_0x1e6a6d[_0x1e18ed(0x9a)],{id:_0x5ada59}=_0x20dd53,_0x2693c4=await this['chatLogEntity'][_0x1e18ed(0xd7)]({'where':{'id':_0x5ada59,'userId':_0xf083d9}});if(!_0x2693c4)throw new common_1['HttpException'](_0x1e18ed(0xbf),common_1[_0x1e18ed(0xef)][_0x1e18ed(0x102)]);const _0x4cbba3=await this[_0x1e18ed(0x85)][_0x1e18ed(0xfe)]({'id':_0x5ada59},{'isDelete':!![]});if(_0x4cbba3[_0x1e18ed(0xd4)]>0x0)return _0x1e18ed(0xd3);else throw new common_1[(_0x1e18ed(0x80))](_0x1e18ed(0xbf),common_1[_0x1e18ed(0xef)][_0x1e18ed(0x102)]);}async['delByGroupId'](_0x4c214e,_0x3b82b0){const _0x11e59f=_0x27f742,{groupId:_0x125e86}=_0x3b82b0,{id:_0x8e6c80}=_0x4c214e[_0x11e59f(0x9a)],_0xaa7793=await this['chatGroupEntity'][_0x11e59f(0xd7)]({'where':{'id':_0x125e86,'userId':_0x8e6c80}});if(!_0xaa7793)throw new common_1[(_0x11e59f(0x80))](_0x11e59f(0xbf),common_1[_0x11e59f(0xef)][_0x11e59f(0x102)]);const _0x49af77=await this[_0x11e59f(0x85)][_0x11e59f(0xfe)]({'groupId':_0x125e86},{'isDelete':!![]});if(_0x49af77[_0x11e59f(0xd4)]>0x0)return _0x11e59f(0xd3);if(_0x49af77[_0x11e59f(0xd4)]===0x0)throw new common_1[(_0x11e59f(0x80))]('当前页面已经没有东西可以删除了！',common_1[_0x11e59f(0xef)][_0x11e59f(0x102)]);}async['deleteChatsAfterId'](_0x454b83,_0x1e4bb9){const _0x5024fa=_0x27f742,{id:_0x11d453}=_0x1e4bb9,{id:_0x4c56d3}=_0x454b83[_0x5024fa(0x9a)],_0x539eac=await this[_0x5024fa(0x85)][_0x5024fa(0xd7)]({'where':{'id':_0x11d453,'userId':_0x4c56d3}});if(!_0x539eac)throw new common_1[(_0x5024fa(0x80))]('你删除的对话记录不存在、请检查！',common_1[_0x5024fa(0xef)][_0x5024fa(0x102)]);const {groupId:_0x586aac}=_0x539eac,_0x520023=await this[_0x5024fa(0x85)][_0x5024fa(0xfe)]({'groupId':_0x586aac,'id':(0x0,typeorm_2[_0x5024fa(0xe4)])(_0x11d453)},{'isDelete':!![]});if(_0x520023['affected']>0x0)return _0x5024fa(0xd3);else throw new common_1[(_0x5024fa(0x80))]('当前页面已经没有东西可以删除了！',common_1[_0x5024fa(0xef)][_0x5024fa(0x102)]);}async[_0x27f742(0xf4)](_0x5e6544,_0x1c7564){const _0xb9f457=_0x27f742,{id:_0x467322}=_0x5e6544[_0xb9f457(0x9a)],{appId:_0x42831f,page:page=0x1,size:size=0xa}=_0x1c7564,[_0x5f0c61,_0x44bc1d]=await this[_0xb9f457(0x85)][_0xb9f457(0xa3)]({'where':{'userId':_0x467322,'appId':_0x42831f,'role':_0xb9f457(0xd0)},'order':{'id':_0xb9f457(0xa8)},'take':size,'skip':(page-0x1)*size});return{'rows':_0x5f0c61,'count':_0x44bc1d};}async['checkModelLimits'](_0x332a1a,_0xcf8b50){const _0x49a9b6=_0x27f742,_0x182f79=0xe10*0x3e8,_0x164a09=new Date(Date[_0x49a9b6(0xb6)]()-_0x182f79);try{const _0x19edad=await this[_0x49a9b6(0x85)]['count']({'where':{'userId':_0x332a1a['id'],'model':_0xcf8b50,'createdAt':(0x0,typeorm_2[_0x49a9b6(0xa9)])(_0x164a09)}}),_0x38c19=Math[_0x49a9b6(0xfa)](_0x19edad/0x2);common_1[_0x49a9b6(0xa2)][_0x49a9b6(0xb9)](_0x49a9b6(0xda)+_0x332a1a['id']+_0x49a9b6(0xed)+_0xcf8b50+_0x49a9b6(0x7a)+(_0x38c19+0x1)+'\x20次',_0x49a9b6(0xf1));let _0x3f99b0;_0xcf8b50[_0x49a9b6(0xa4)](_0x49a9b6(0xf3))?_0x3f99b0=await this[_0x49a9b6(0x81)][_0x49a9b6(0xd5)]('gpts'):_0x3f99b0=await this[_0x49a9b6(0x81)][_0x49a9b6(0xd5)](_0xcf8b50);const _0x29544f=Number(_0x3f99b0['modelLimits']);common_1['Logger'][_0x49a9b6(0xb9)](_0x49a9b6(0x92)+_0xcf8b50+_0x49a9b6(0xfc)+_0x29544f,_0x49a9b6(0xf1));if(_0x38c19>_0x29544f)return!![];return![];}catch(_0x14755e){common_1[_0x49a9b6(0xa2)][_0x49a9b6(0xa5)](_0x49a9b6(0xee)+_0x332a1a['id']+',\x20模型:\x20'+_0xcf8b50+_0x49a9b6(0xe9)+_0x14755e[_0x49a9b6(0xcb)],_0x14755e[_0x49a9b6(0xc7)],_0x49a9b6(0xf1));}}};ChatLogService=__decorate([(0x0,common_1[_0x27f742(0x9f)])(),__param(0x0,(0x0,typeorm_1[_0x27f742(0xd6)])(chatLog_entity_1[_0x27f742(0xe2)])),__param(0x1,(0x0,typeorm_1[_0x27f742(0xd6)])(user_entity_1['UserEntity'])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(chatGroup_entity_1[_0x27f742(0xe5)])),__metadata(_0x27f742(0x8b),[typeorm_2[_0x27f742(0xb8)],typeorm_2['Repository'],typeorm_2[_0x27f742(0xb8)],models_service_1[_0x27f742(0xcd)]])],ChatLogService),exports[_0x27f742(0xf1)]=ChatLogService;function _0x4b37(){const _0x595811=['midjourney','chatLogEntity','reverse','回答答案','updateChatLog','maskEmail','fileInfo','design:paramtypes','用户邮箱','cos','length','decorate','chatGroupEntity','../user/user.entity','模型\x20','stable-diffusion','exceljs','ChatType','../../common/constants/balance.constant','Content-Disposition','answer','Like','user','filter','username','querDrawLog','@nestjs/common','Injectable','649743kJxfbC','./chatLog.entity','Logger','findAndCount','startsWith','error','56803194UKSUgB','function','DESC','MoreThan','11179408felzJX','setHeader','isGroup','chatlog','components','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet','createdAt','NORMAL_CHAT','extend','columns','model','264RRzwhY','now','@nestjs/typeorm','Repository','log','forEach','deleteChatLog','tencent','1447356UePcPE','write','你删除的对话记录不存在、请检查！','assign','../models/models.service','role','?x-oss-process=image/resize,w_','includes','recDrawImg','8001413HZUwMF','stack','defineProperty','parse','取消推荐','message','提问时间','ModelsService','find','dall-e-3','assistant','super','?imageView2/1/w/','删除对话记录成功！','affected','getCurrentModelKeyInfo','InjectRepository','findOne','querAllDrawLog','thumbImg','用户ID:\x20','attachment;\x20filename=','querAllDrawLog\x20Json\x20parse\x20error','email','addWorksheet','__decorate','../chatGroup/chatGroup.entity','你推荐的图片不存在、请检查！','ChatLogEntity','__param','MoreThanOrEqual','ChatGroupEntity','map','xlsx','1559528YcqkzJ',',\x20错误信息:\x20','userEntity','addRow','type','\x20一小时内调用\x20','查询数据库出错\x20-\x20用户ID:\x20','HttpStatus','prompt','ChatLogService','formatDate','gpt-4-gizmo','byAppId','@aiweb.com','avatar','__esModule','chatList','findOneDrawLog','ceil','你操作的图片不存在、请检查！','\x20的使用次数限制为\x20','DALL-E2','update','4WlRTsZ','ali','object','BAD_REQUEST','Not','chatHistory','default','exportExcel','图片成功！','../../common/utils','findOneChatLog','用户名','\x20模型\x20','getOwnPropertyDescriptor','117545mGMuHS','userId','提问问题','metadata','HttpException','modelsService','/q/55','save'];_0x4b37=function(){return _0x595811;};return _0x4b37();}