'use strict';function _0x59bb(_0x218ca8,_0x32d83c){const _0xf08e61=_0xf08e();return _0x59bb=function(_0x59bb16,_0x5b07a0){_0x59bb16=_0x59bb16-0xd8;let _0x23e31c=_0xf08e61[_0x59bb16];return _0x23e31c;},_0x59bb(_0x218ca8,_0x32d83c);}const _0x51beb0=_0x59bb;(function(_0x2afd97,_0x170e09){const _0x2ab23f=_0x59bb,_0x420390=_0x2afd97();while(!![]){try{const _0x560e73=-parseInt(_0x2ab23f(0x121))/0x1+parseInt(_0x2ab23f(0xff))/0x2+-parseInt(_0x2ab23f(0xec))/0x3*(parseInt(_0x2ab23f(0x125))/0x4)+-parseInt(_0x2ab23f(0x149))/0x5+-parseInt(_0x2ab23f(0x15d))/0x6+parseInt(_0x2ab23f(0xe8))/0x7+parseInt(_0x2ab23f(0xe6))/0x8;if(_0x560e73===_0x170e09)break;else _0x420390['push'](_0x420390['shift']());}catch(_0x271d7d){_0x420390['push'](_0x420390['shift']());}}}(_0xf08e,0x35b56));function _0xf08e(){const _0x2f13ae=['affected','@aiweb.com','8605592OUIpAl','function','605122ORjCUt','default','tencent','图片成功！','150idmpuS','model','ali','xlsx','ChatLogService','typeorm','模型\x20','回答答案','maskEmail','querAllChatLog','gpts','../../common/utils','你推荐的图片不存在、请检查！','userEntity','chatLogEntity','UserEntity','/q/55','InjectRepository','object','221672voQPzs','chatlog','findAndCount','error','type','Logger','filter','deleteChatsAfterId','Workbook','assistant','createdAt','exportExcel','length','metadata','HttpException','getCurrentModelKeyInfo','checkModelLimits','取消推荐','dall-e-3','deleteChatLog','assign','paintCount','querDrawLog','getOwnPropertyDescriptor','now','./chatLog.entity','prompt','addRow','modelsService','用户名','PAINT','byAppId','updateChatLog','userId','244986iYlVgi','avatar','querAllDrawLog','@nestjs/typeorm','34156lVkhSq','defineProperty','thumbImg','recDrawImg','end','setHeader','ChatLogEntity','Content-Disposition','用户ID:\x20','role','findOneChatLog','HttpStatus','ceil','formatDate','includes','DALL-E2','user','parse','log','components','ChatType','querAllDrawLog\x20Json\x20parse\x20error','../user/user.entity','DESC','map','当前页面已经没有东西可以删除了！','forEach','reverse','answer','cos','chatGroupEntity','exceljs','rec','@nestjs/common','Repository','extend','1531640IqNJGf','MoreThan','super','用户邮箱','findOne','删除对话记录成功！','stable-diffusion','modelLimits','saveChatLog','NORMAL_CHAT','email','addWorksheet','isGroup','ModelsService','Like','update','save','midjourney','../models/models.service','fileInfo','448362rVdFli','__metadata','\x20一小时内调用\x20','count','?x-oss-process=image/resize,w_','?imageView2/1/w/','提问时间','username','Not','find','Injectable','查询数据库出错\x20-\x20用户ID:\x20','delByGroupId','\x20的使用次数限制为\x20','__decorate','../chatGroup/chatGroup.entity','__esModule','BAD_REQUEST'];_0xf08e=function(){return _0x2f13ae;};return _0xf08e();}var __decorate=this&&this[_0x51beb0(0xe0)]||function(_0x10491a,_0x18ed09,_0x4abfba,_0x5d2251){const _0x5bd4ff=_0x51beb0;var _0x5f5a6e=arguments[_0x5bd4ff(0x10b)],_0x3cf0d1=_0x5f5a6e<0x3?_0x18ed09:_0x5d2251===null?_0x5d2251=Object[_0x5bd4ff(0x116)](_0x18ed09,_0x4abfba):_0x5d2251,_0x4fba80;if(typeof Reflect==='object'&&typeof Reflect['decorate']==='function')_0x3cf0d1=Reflect['decorate'](_0x10491a,_0x18ed09,_0x4abfba,_0x5d2251);else{for(var _0x34b46e=_0x10491a[_0x5bd4ff(0x10b)]-0x1;_0x34b46e>=0x0;_0x34b46e--)if(_0x4fba80=_0x10491a[_0x34b46e])_0x3cf0d1=(_0x5f5a6e<0x3?_0x4fba80(_0x3cf0d1):_0x5f5a6e>0x3?_0x4fba80(_0x18ed09,_0x4abfba,_0x3cf0d1):_0x4fba80(_0x18ed09,_0x4abfba))||_0x3cf0d1;}return _0x5f5a6e>0x3&&_0x3cf0d1&&Object[_0x5bd4ff(0x126)](_0x18ed09,_0x4abfba,_0x3cf0d1),_0x3cf0d1;},__metadata=this&&this[_0x51beb0(0x15e)]||function(_0x44a911,_0x48d7c7){const _0x23e1d3=_0x51beb0;if(typeof Reflect===_0x23e1d3(0xfe)&&typeof Reflect[_0x23e1d3(0x10c)]===_0x23e1d3(0xe7))return Reflect[_0x23e1d3(0x10c)](_0x44a911,_0x48d7c7);},__param=this&&this['__param']||function(_0x5739e5,_0x4e7855){return function(_0x4487da,_0x33b7f6){_0x4e7855(_0x4487da,_0x33b7f6,_0x5739e5);};};Object['defineProperty'](exports,_0x51beb0(0xe2),{'value':!![]}),exports[_0x51beb0(0xf0)]=void 0x0;const balance_constant_1=require('../../common/constants/balance.constant'),utils_1=require(_0x51beb0(0xf7)),common_1=require(_0x51beb0(0x146)),typeorm_1=require(_0x51beb0(0x124)),exceljs_1=require(_0x51beb0(0x144)),typeorm_2=require(_0x51beb0(0xf1)),chatGroup_entity_1=require(_0x51beb0(0xe1)),user_entity_1=require(_0x51beb0(0x13b)),chatLog_entity_1=require(_0x51beb0(0x118)),models_service_1=require(_0x51beb0(0x15b));let ChatLogService=class ChatLogService{constructor(_0x758c7,_0x14b39b,_0x329567,_0x18a269){const _0x359ba5=_0x51beb0;this[_0x359ba5(0xfa)]=_0x758c7,this['userEntity']=_0x14b39b,this[_0x359ba5(0x143)]=_0x329567,this[_0x359ba5(0x11b)]=_0x18a269;}async[_0x51beb0(0x151)](_0x30dd6a){const _0xc2ec7e=_0x51beb0,_0x4aebd7=await this[_0xc2ec7e(0xfa)][_0xc2ec7e(0x159)](_0x30dd6a);return _0x4aebd7;}async[_0x51beb0(0x11f)](_0x2ead9f,_0x2ed4ed){const _0x439134=_0x51beb0;return await this['chatLogEntity'][_0x439134(0x158)]({'id':_0x2ead9f},_0x2ed4ed);}async[_0x51beb0(0x12f)](_0x2b8ddf){const _0x2422dd=_0x51beb0;return await this[_0x2422dd(0xfa)][_0x2422dd(0x14d)]({'where':{'id':_0x2b8ddf}});}async[_0x51beb0(0x115)](_0x3e4b6c,_0x5def6b){const _0x5917ef=_0x51beb0,{id:_0x582f15}=_0x3e4b6c['user'],{model:_0x403078}=_0x5def6b,_0x332bf3={'userId':_0x582f15,'type':balance_constant_1[_0x5917ef(0x139)]['PAINT']};_0x403078&&(_0x332bf3[_0x5917ef(0xed)]=_0x403078,_0x403078===_0x5917ef(0x134)&&(_0x332bf3[_0x5917ef(0xed)]=(0x0,typeorm_2['In'])([_0x5917ef(0x134),_0x5917ef(0x111)])));const _0x3d5a2f=await this[_0x5917ef(0xfa)]['find']({'where':_0x332bf3,'order':{'id':_0x5917ef(0x13c)},'select':['id',_0x5917ef(0x141),'prompt','model',_0x5917ef(0x103),_0x5917ef(0x15c)]});return _0x3d5a2f[_0x5917ef(0x13f)](_0x1cb8e8=>{const _0x155fac=_0x5917ef;if(_0x1cb8e8[_0x155fac(0x103)]===_0x155fac(0x114)){const _0x45129c=_0x1cb8e8[_0x155fac(0xed)]==='mj'?0x136:0xa0,_0x27b0e4=_0x1cb8e8[_0x155fac(0x141)][_0x155fac(0x133)](_0x155fac(0x142))?_0x155fac(0xea):'ali',_0x557fcc=_0x27b0e4==='tencent'?_0x155fac(0x162)+_0x45129c+_0x155fac(0xfc):_0x155fac(0x161)+_0x45129c;_0x1cb8e8[_0x155fac(0x127)]=_0x1cb8e8['answer']+_0x557fcc;try{_0x1cb8e8[_0x155fac(0x15c)]=_0x1cb8e8['fileInfo']?JSON[_0x155fac(0x136)](_0x1cb8e8[_0x155fac(0x15c)]):null;}catch(_0x2ef2a5){_0x1cb8e8['fileInfo']={};}}}),_0x3d5a2f;}async[_0x51beb0(0x123)](_0x1c193a){const _0x12c918=_0x51beb0,{page:page=0x1,size:size=0x14,rec:_0x272b7a,userId:_0x5daaec,model:_0x562e49}=_0x1c193a,_0x36356d={'type':0x2,'prompt':(0x0,typeorm_2[_0x12c918(0xda)])(''),'answer':(0x0,typeorm_2[_0x12c918(0xda)])(''),'fileInfo':(0x0,typeorm_2[_0x12c918(0xda)])('')};_0x272b7a&&Object['assign'](_0x36356d,{'rec':_0x272b7a}),_0x5daaec&&Object[_0x12c918(0x113)](_0x36356d,{'userId':_0x5daaec});_0x562e49?_0x36356d[_0x12c918(0xed)]=_0x562e49:_0x36356d[_0x12c918(0xed)]=(0x0,typeorm_2['In'])([_0x12c918(0x15a),'dall-e-3',_0x12c918(0x14f)]);const [_0x5bf2f3,_0x55cb33]=await this[_0x12c918(0xfa)]['findAndCount']({'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size,'where':_0x36356d}),_0x2cf6f0=_0x5bf2f3[_0x12c918(0x13d)](_0x14c338=>_0x14c338['userId'])[_0x12c918(0x105)](_0x2a9f92=>_0x2a9f92<0x186a0),_0x4f62bb=await this[_0x12c918(0xf9)][_0x12c918(0xdb)]({'where':{'id':(0x0,typeorm_2['In'])(_0x2cf6f0)},'select':['id','username',_0x12c918(0x122),_0x12c918(0x153)]});return _0x5bf2f3[_0x12c918(0x13f)](_0x7dde66=>{const _0x117a9b=_0x12c918;_0x7dde66['userInfo']=_0x4f62bb[_0x117a9b(0xdb)](_0xf8c606=>_0xf8c606['id']===_0x7dde66[_0x117a9b(0x120)]);}),_0x5bf2f3[_0x12c918(0x13f)](_0x1b5959=>{const _0xdabbe8=_0x12c918;var _0x134121;const _0x40f917=_0x1b5959[_0xdabbe8(0xed)]===_0xdabbe8(0x15a)?0x136:0xa0,_0x44ffc1=_0x1b5959[_0xdabbe8(0x141)][_0xdabbe8(0x133)]('cos')?_0xdabbe8(0xea):_0xdabbe8(0xee),_0x1f8482=_0x44ffc1===_0xdabbe8(0xea)?_0xdabbe8(0x162)+_0x40f917+_0xdabbe8(0xfc):_0xdabbe8(0x161)+_0x40f917;_0x1b5959[_0xdabbe8(0x127)]=_0x1b5959[_0xdabbe8(0x141)]+_0x1f8482;try{const _0xe7ae9=_0x1b5959[_0xdabbe8(0x148)]?JSON[_0xdabbe8(0x136)](_0x1b5959['extend']):null;_0xe7ae9&&(_0xe7ae9?_0x1b5959[_0xdabbe8(0x155)]=((_0x134121=_0xe7ae9===null||_0xe7ae9===void 0x0?void 0x0:_0xe7ae9['components'][0x0])===null||_0x134121===void 0x0?void 0x0:_0x134121[_0xdabbe8(0x138)][_0xdabbe8(0x10b)])===0x5:_0x1b5959['isGroup']=![]);}catch(_0x48db80){console[_0xdabbe8(0x137)](_0xdabbe8(0x13a),_0x48db80);}}),{'rows':_0x5bf2f3,'count':_0x55cb33};}async['findOneDrawLog'](_0x2c7c0e){const _0x144df3=_0x51beb0,{id:_0x2f74dc}=_0x2c7c0e,_0x89d070=await this['chatLogEntity'][_0x144df3(0x14d)]({'where':{'id':_0x2f74dc}});return _0x89d070;}async[_0x51beb0(0x128)](_0x1cd2cf){const _0x2c766e=_0x51beb0,{id:_0x3a627e}=_0x1cd2cf,_0x391bb5=await this[_0x2c766e(0xfa)][_0x2c766e(0x14d)]({'where':{'id':_0x3a627e,'type':balance_constant_1[_0x2c766e(0x139)][_0x2c766e(0x11d)]}});if(!_0x391bb5)throw new common_1[(_0x2c766e(0x10d))](_0x2c766e(0xf8),common_1[_0x2c766e(0x130)]['BAD_REQUEST']);const _0x46cb26=_0x391bb5[_0x2c766e(0x145)]===0x1?0x0:0x1,_0x430a2a=await this[_0x2c766e(0xfa)][_0x2c766e(0x158)]({'id':_0x3a627e},{'rec':_0x46cb26});if(_0x430a2a[_0x2c766e(0xe4)]>0x0)return(_0x46cb26?'推荐':_0x2c766e(0x110))+_0x2c766e(0xeb);throw new common_1['HttpException']('你操作的图片不存在、请检查！',common_1[_0x2c766e(0x130)][_0x2c766e(0xe3)]);}async[_0x51beb0(0x10a)](_0x20938c,_0x1a9fe9){const _0x4de3c6=_0x51beb0,_0x2853ff={'type':balance_constant_1[_0x4de3c6(0x139)][_0x4de3c6(0x152)]},{page:page=0x1,size:size=0x1e,prompt:_0x18624d,email:_0x521e5c}=_0x20938c;_0x18624d&&Object[_0x4de3c6(0x113)](_0x2853ff,{'prompt':(0x0,typeorm_2[_0x4de3c6(0x157)])('%'+_0x18624d+'%')});if(_0x521e5c){const _0x56bbd3=await this[_0x4de3c6(0xf9)][_0x4de3c6(0x14d)]({'where':{'email':_0x521e5c}});(_0x56bbd3===null||_0x56bbd3===void 0x0?void 0x0:_0x56bbd3['id'])&&Object[_0x4de3c6(0x113)](_0x2853ff,{'userId':_0x56bbd3['id']});}const [_0x1ef412,_0x593a81]=await this['chatLogEntity']['findAndCount']({'order':{'id':_0x4de3c6(0x13c)},'skip':(page-0x1)*size,'take':size,'where':_0x2853ff}),_0x75fbac=_0x1ef412['map'](_0x37401e=>_0x37401e[_0x4de3c6(0x120)]),_0x5e56ed=await this['userEntity']['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x75fbac)}}),_0x301d20=_0x1ef412[_0x4de3c6(0x13d)](_0x61861a=>{const _0x2abe53=_0x4de3c6,_0x5c7697=_0x5e56ed[_0x2abe53(0xdb)](_0x4497bb=>_0x4497bb['id']===_0x61861a[_0x2abe53(0x120)]);return{'username':_0x5c7697?_0x5c7697[_0x2abe53(0xd9)]:'','email':_0x5c7697?_0x5c7697[_0x2abe53(0x153)]:'','prompt':_0x61861a[_0x2abe53(0x119)],'answer':_0x61861a['answer'],'createdAt':(0x0,utils_1[_0x2abe53(0x132)])(_0x61861a[_0x2abe53(0x109)])};}),_0x433d9c=new exceljs_1[(_0x4de3c6(0xe9))][(_0x4de3c6(0x107))](),_0x159c5c=_0x433d9c[_0x4de3c6(0x154)](_0x4de3c6(0x100));_0x159c5c['columns']=[{'header':_0x4de3c6(0x11c),'key':_0x4de3c6(0xd9),'width':0x14},{'header':_0x4de3c6(0x14c),'key':_0x4de3c6(0x153),'width':0x14},{'header':_0x4de3c6(0xd8),'key':_0x4de3c6(0x109),'width':0x14},{'header':'提问问题','key':_0x4de3c6(0x119),'width':0x50},{'header':_0x4de3c6(0xf3),'key':_0x4de3c6(0x141),'width':0x96}],_0x301d20[_0x4de3c6(0x13f)](_0x1785fa=>_0x159c5c[_0x4de3c6(0x11a)](_0x1785fa)),_0x1a9fe9[_0x4de3c6(0x12a)]('Content-Type','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'),_0x1a9fe9[_0x4de3c6(0x12a)](_0x4de3c6(0x12c),'attachment;\x20filename='+'chat.xlsx'),await _0x433d9c[_0x4de3c6(0xef)]['write'](_0x1a9fe9),_0x1a9fe9[_0x4de3c6(0x129)]();}async[_0x51beb0(0xf5)](_0x37798e,_0x221ef9){const _0x58000d=_0x51beb0,{page:page=0x1,size:size=0x14,userId:_0x492c38,prompt:_0x3de4bb}=_0x37798e,_0x56d971={'type':balance_constant_1[_0x58000d(0x139)][_0x58000d(0x152)],'prompt':(0x0,typeorm_2[_0x58000d(0xda)])('')};_0x492c38&&Object[_0x58000d(0x113)](_0x56d971,{'userId':_0x492c38}),_0x3de4bb&&Object[_0x58000d(0x113)](_0x56d971,{'prompt':(0x0,typeorm_2['Like'])('%'+_0x3de4bb+'%')});const [_0xe61872,_0x14df10]=await this[_0x58000d(0xfa)][_0x58000d(0x101)]({'order':{'id':_0x58000d(0x13c)},'skip':(page-0x1)*size,'take':size,'where':_0x56d971}),_0x162a54=_0xe61872[_0x58000d(0x13d)](_0xea4ab1=>_0xea4ab1[_0x58000d(0x120)]),_0x5eb167=await this[_0x58000d(0xf9)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x162a54)},'select':['id',_0x58000d(0xd9),_0x58000d(0x153)]});return _0xe61872[_0x58000d(0x13f)](_0x423187=>{const _0x318540=_0x58000d,{username:_0x103e99,email:_0x5ebb99}=_0x5eb167[_0x318540(0xdb)](_0x4b0d4e=>_0x4b0d4e['id']===_0x423187[_0x318540(0x120)])||{};_0x423187[_0x318540(0xd9)]=_0x103e99,_0x423187[_0x318540(0x153)]=_0x5ebb99;}),_0x221ef9[_0x58000d(0x135)][_0x58000d(0x12e)]!==_0x58000d(0x14b)&&_0xe61872[_0x58000d(0x13f)](_0x2b871f=>_0x2b871f[_0x58000d(0x153)]=(0x0,utils_1[_0x58000d(0xf4)])(_0x2b871f[_0x58000d(0x153)])),_0xe61872[_0x58000d(0x13f)](_0x8b745b=>{const _0x159e13=_0x58000d;!_0x8b745b['email']&&(_0x8b745b[_0x159e13(0x153)]=(_0x8b745b===null||_0x8b745b===void 0x0?void 0x0:_0x8b745b['userId'])+_0x159e13(0xe5)),!_0x8b745b[_0x159e13(0xd9)]&&(_0x8b745b[_0x159e13(0xd9)]='游客'+(_0x8b745b===null||_0x8b745b===void 0x0?void 0x0:_0x8b745b[_0x159e13(0x120)]));}),{'rows':_0xe61872,'count':_0x14df10};}async['chatList'](_0x281b25,_0x28c11d){const _0x132f74=_0x51beb0,{id:_0x4d8d60}=_0x281b25[_0x132f74(0x135)],{groupId:_0x399bae}=_0x28c11d,_0x433c37={'userId':_0x4d8d60,'isDelete':![]};_0x399bae&&Object[_0x132f74(0x113)](_0x433c37,{'groupId':_0x399bae});if(_0x399bae){const _0x14b959=await this[_0x132f74(0x143)][_0x132f74(0x160)]({'where':{'isDelete':![]}});if(_0x14b959===0x0)return[];}const _0x1c2dad=await this[_0x132f74(0xfa)][_0x132f74(0xdb)]({'where':_0x433c37});return _0x1c2dad[_0x132f74(0x13d)](_0x4f679f=>{const _0x5cc71d=_0x132f74,{prompt:_0x541cf3,role:_0x196a98,answer:_0x251e8c,createdAt:_0x58e558,model:_0x4c8c68,modelName:_0x506310,type:_0x2b8ac7,status:_0x9bca0c,action:_0xa2996b,drawId:_0xae5b38,id:_0x282eed,fileInfo:_0x519ed1,ttsUrl:_0x35e7bc,videoUrl:_0x177a56,audioUrl:_0x1e01fe,customId:_0x19a73d,pluginParam:_0x435618,modelAvatar:_0x4fb460,taskData:_0x2a2e82,promptReference:_0xd087d}=_0x4f679f;return{'chatId':_0x282eed,'dateTime':(0x0,utils_1[_0x5cc71d(0x132)])(_0x58e558),'text':_0x196a98==='user'?_0x541cf3:_0x251e8c,'modelType':_0x2b8ac7,'status':_0x9bca0c,'action':_0xa2996b,'drawId':_0xae5b38,'customId':_0x19a73d,'inversion':_0x196a98===_0x5cc71d(0x135),'error':![],'fileInfo':_0x519ed1,'ttsUrl':_0x35e7bc,'videoUrl':_0x177a56,'audioUrl':_0x1e01fe,'model':_0x4c8c68,'modelName':_0x506310,'pluginParam':_0x435618,'modelAvatar':_0x4fb460,'taskData':_0x2a2e82,'promptReference':_0xd087d};});}async['chatHistory'](_0x32bb71,_0x4e2618){const _0xb092c0=_0x51beb0;if(_0x4e2618===0x0)return[];const _0x14c3cc={'isDelete':![],'groupId':_0x32bb71},_0x41d581=await this[_0xb092c0(0xfa)]['find']({'where':_0x14c3cc,'order':{'createdAt':'DESC'},'take':_0x4e2618*0x2}),_0x54439b=_0x41d581[_0xb092c0(0x13d)](_0x1a52cc=>{const _0x26c360=_0xb092c0,{role:_0x577499,prompt:_0x2a4eef,answer:_0x967be5,fileInfo:_0x3beb53}=_0x1a52cc,_0x1ada39={'role':_0x577499,'text':_0x577499===_0x26c360(0x135)?_0x2a4eef:_0x967be5,'fileInfo':_0x3beb53};return _0x1ada39;})[_0xb092c0(0x140)]();return _0x54439b;}async[_0x51beb0(0x112)](_0x3c3fa3,_0x1d0286){const _0x1046d5=_0x51beb0,{id:_0x3bdf5c}=_0x3c3fa3[_0x1046d5(0x135)],{id:_0x33f1ca}=_0x1d0286,_0x319d76=await this[_0x1046d5(0xfa)][_0x1046d5(0x14d)]({'where':{'id':_0x33f1ca,'userId':_0x3bdf5c}});if(!_0x319d76)throw new common_1[(_0x1046d5(0x10d))]('你删除的对话记录不存在、请检查！',common_1[_0x1046d5(0x130)]['BAD_REQUEST']);const _0x5ad4a2=await this[_0x1046d5(0xfa)][_0x1046d5(0x158)]({'id':_0x33f1ca},{'isDelete':!![]});if(_0x5ad4a2[_0x1046d5(0xe4)]>0x0)return _0x1046d5(0x14e);else throw new common_1['HttpException']('你删除的对话记录不存在、请检查！',common_1[_0x1046d5(0x130)][_0x1046d5(0xe3)]);}async[_0x51beb0(0xde)](_0xbdf554,_0x1dde88){const _0x15eef7=_0x51beb0,{groupId:_0x595250}=_0x1dde88,{id:_0x136e63}=_0xbdf554[_0x15eef7(0x135)],_0x14e098=await this[_0x15eef7(0x143)]['findOne']({'where':{'id':_0x595250,'userId':_0x136e63}});if(!_0x14e098)throw new common_1[(_0x15eef7(0x10d))]('你删除的对话记录不存在、请检查！',common_1[_0x15eef7(0x130)]['BAD_REQUEST']);const _0x35df5f=await this[_0x15eef7(0xfa)][_0x15eef7(0x158)]({'groupId':_0x595250},{'isDelete':!![]});if(_0x35df5f[_0x15eef7(0xe4)]>0x0)return _0x15eef7(0x14e);if(_0x35df5f[_0x15eef7(0xe4)]===0x0)throw new common_1[(_0x15eef7(0x10d))](_0x15eef7(0x13e),common_1[_0x15eef7(0x130)]['BAD_REQUEST']);}async[_0x51beb0(0x106)](_0x3da297,_0x6ee5c0){const _0x3b4d4c=_0x51beb0,{id:_0x21a38f}=_0x6ee5c0,{id:_0x4e139c}=_0x3da297[_0x3b4d4c(0x135)],_0x54214d=await this[_0x3b4d4c(0xfa)][_0x3b4d4c(0x14d)]({'where':{'id':_0x21a38f,'userId':_0x4e139c}});if(!_0x54214d)throw new common_1[(_0x3b4d4c(0x10d))]('你删除的对话记录不存在、请检查！',common_1[_0x3b4d4c(0x130)][_0x3b4d4c(0xe3)]);const {groupId:_0x58917a}=_0x54214d,_0x4dffb5=await this['chatLogEntity'][_0x3b4d4c(0x158)]({'groupId':_0x58917a,'id':(0x0,typeorm_2['MoreThanOrEqual'])(_0x21a38f)},{'isDelete':!![]});if(_0x4dffb5['affected']>0x0)return'删除对话记录成功！';else throw new common_1[(_0x3b4d4c(0x10d))](_0x3b4d4c(0x13e),common_1[_0x3b4d4c(0x130)][_0x3b4d4c(0xe3)]);}async[_0x51beb0(0x11e)](_0x51847e,_0x521d9f){const _0x430eb6=_0x51beb0,{id:_0x56862b}=_0x51847e[_0x430eb6(0x135)],{appId:_0x50c9d7,page:page=0x1,size:size=0xa}=_0x521d9f,[_0x3d7c33,_0x163c8b]=await this[_0x430eb6(0xfa)][_0x430eb6(0x101)]({'where':{'userId':_0x56862b,'appId':_0x50c9d7,'role':_0x430eb6(0x108)},'order':{'id':_0x430eb6(0x13c)},'take':size,'skip':(page-0x1)*size});return{'rows':_0x3d7c33,'count':_0x163c8b};}async[_0x51beb0(0x10f)](_0x20898e,_0x5e94f5){const _0x2900e3=_0x51beb0,_0x1955b2=0xe10*0x3e8,_0x484200=new Date(Date[_0x2900e3(0x117)]()-_0x1955b2);try{const _0x3ee45b=await this[_0x2900e3(0xfa)]['count']({'where':{'userId':_0x20898e['id'],'model':_0x5e94f5,'createdAt':(0x0,typeorm_2[_0x2900e3(0x14a)])(_0x484200)}}),_0x323f90=Math[_0x2900e3(0x131)](_0x3ee45b/0x2);common_1['Logger']['log'](_0x2900e3(0x12d)+_0x20898e['id']+_0x2900e3(0x15f)+_0x5e94f5+'\x20模型\x20'+(_0x323f90+0x1)+'\x20次','ChatLogService');let _0xbc6687;_0x5e94f5['startsWith']('gpt-4-gizmo')?_0xbc6687=await this['modelsService'][_0x2900e3(0x10e)](_0x2900e3(0xf6)):_0xbc6687=await this['modelsService'][_0x2900e3(0x10e)](_0x5e94f5);const _0x137b56=Number(_0xbc6687[_0x2900e3(0x150)]);common_1[_0x2900e3(0x104)]['log'](_0x2900e3(0xf2)+_0x5e94f5+_0x2900e3(0xdf)+_0x137b56,_0x2900e3(0xf0));if(_0x323f90>_0x137b56)return!![];return![];}catch(_0x53372a){common_1[_0x2900e3(0x104)][_0x2900e3(0x102)](_0x2900e3(0xdd)+_0x20898e['id']+',\x20模型:\x20'+_0x5e94f5+',\x20错误信息:\x20'+_0x53372a['message'],_0x53372a['stack'],_0x2900e3(0xf0));}}};ChatLogService=__decorate([(0x0,common_1[_0x51beb0(0xdc)])(),__param(0x0,(0x0,typeorm_1[_0x51beb0(0xfd)])(chatLog_entity_1[_0x51beb0(0x12b)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x51beb0(0xfb)])),__param(0x2,(0x0,typeorm_1[_0x51beb0(0xfd)])(chatGroup_entity_1['ChatGroupEntity'])),__metadata('design:paramtypes',[typeorm_2[_0x51beb0(0x147)],typeorm_2[_0x51beb0(0x147)],typeorm_2[_0x51beb0(0x147)],models_service_1[_0x51beb0(0x156)]])],ChatLogService),exports[_0x51beb0(0xf0)]=ChatLogService;