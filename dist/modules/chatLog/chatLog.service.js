'use strict';const _0x2aeffa=_0x1296;(function(_0x30c9f,_0x2857fe){const _0x2e2212=_0x1296,_0x994f16=_0x30c9f();while(!![]){try{const _0xe08aad=parseInt(_0x2e2212(0xfe))/0x1+-parseInt(_0x2e2212(0xde))/0x2*(parseInt(_0x2e2212(0x106))/0x3)+parseInt(_0x2e2212(0xbc))/0x4+-parseInt(_0x2e2212(0xca))/0x5*(-parseInt(_0x2e2212(0x113))/0x6)+-parseInt(_0x2e2212(0x10f))/0x7*(parseInt(_0x2e2212(0xf6))/0x8)+parseInt(_0x2e2212(0xfb))/0x9*(parseInt(_0x2e2212(0x9a))/0xa)+-parseInt(_0x2e2212(0x103))/0xb;if(_0xe08aad===_0x2857fe)break;else _0x994f16['push'](_0x994f16['shift']());}catch(_0x4ff360){_0x994f16['push'](_0x994f16['shift']());}}}(_0x4043,0x999fb));function _0x4043(){const _0x503aa1=['affected','addRow','Logger','PAINT','paintCount','__decorate','deleteChatsAfterId','userId','HttpException','thumbImg','chatlog','typeorm','Content-Disposition','10JXyGFb','ali','length','@nestjs/typeorm','exportExcel','删除对话记录成功！','components','metadata','error','gpts','./chatLog.entity','email',',\x20模型:\x20','Like','__param','find','log','querDrawLog','columns','dall-e-3','object','findOne','Injectable','Content-Type','UserEntity','findOneChatLog','getCurrentModelKeyInfo','chatGroupEntity','?imageView2/1/w/','userEntity','answer','chat.xlsx','@aiweb.com','用户ID:\x20','1678556nyZldv','checkModelLimits','update','now','InjectRepository',',\x20错误信息:\x20','count','MoreThanOrEqual','Repository','default','ChatLogService','forEach','design:paramtypes','userInfo','425BoUwYz','提问时间','chatLogEntity','function','ceil','recDrawImg','map','modelsService','parse','Not','@nestjs/common','你推荐的图片不存在、请检查！','findAndCount','super','../models/models.service','defineProperty','maskEmail','/q/55','midjourney','addWorksheet','5282dvQUwr','用户名','../chatGroup/chatGroup.entity','setHeader','Workbook','getOwnPropertyDescriptor','tencent','cos','createdAt','write','querAllDrawLog','DESC','attachment;\x20filename=','user','HttpStatus','role','assign','提问问题','__esModule','gpt-4-gizmo','model','BAD_REQUEST','username','NORMAL_CHAT','120PPmQrY','?x-oss-process=image/resize,w_','xlsx','../../common/utils','decorate','8442396BpSWku','startsWith','message','741359jOQWEv','querAllDrawLog\x20Json\x20parse\x20error','findOneDrawLog','formatDate','includes','18296476bXtHsk','avatar','prompt','519ZooCiZ','\x20一小时内调用\x20','模型\x20','ModelsService','assistant','__metadata','ChatType','ChatLogEntity','stack','259147uWeeNz','回答答案','filter','chatList','85110zaWwZQ','DALL-E2','你删除的对话记录不存在、请检查！','save','fileInfo','deleteChatLog','extend','当前页面已经没有东西可以删除了！'];_0x4043=function(){return _0x503aa1;};return _0x4043();}function _0x1296(_0x5579f9,_0x32d19d){const _0x404376=_0x4043();return _0x1296=function(_0x129625,_0x2cf6b6){_0x129625=_0x129625-0x8c;let _0x844eef=_0x404376[_0x129625];return _0x844eef;},_0x1296(_0x5579f9,_0x32d19d);}var __decorate=this&&this[_0x2aeffa(0x92)]||function(_0x747078,_0x3e157,_0x4e9e13,_0x213bfd){const _0x2f78b1=_0x2aeffa;var _0x54c5d3=arguments[_0x2f78b1(0x9c)],_0x4546f5=_0x54c5d3<0x3?_0x3e157:_0x213bfd===null?_0x213bfd=Object[_0x2f78b1(0xe3)](_0x3e157,_0x4e9e13):_0x213bfd,_0x531f84;if(typeof Reflect===_0x2f78b1(0xae)&&typeof Reflect[_0x2f78b1(0xfa)]===_0x2f78b1(0xcd))_0x4546f5=Reflect['decorate'](_0x747078,_0x3e157,_0x4e9e13,_0x213bfd);else{for(var _0x2b85e1=_0x747078[_0x2f78b1(0x9c)]-0x1;_0x2b85e1>=0x0;_0x2b85e1--)if(_0x531f84=_0x747078[_0x2b85e1])_0x4546f5=(_0x54c5d3<0x3?_0x531f84(_0x4546f5):_0x54c5d3>0x3?_0x531f84(_0x3e157,_0x4e9e13,_0x4546f5):_0x531f84(_0x3e157,_0x4e9e13))||_0x4546f5;}return _0x54c5d3>0x3&&_0x4546f5&&Object['defineProperty'](_0x3e157,_0x4e9e13,_0x4546f5),_0x4546f5;},__metadata=this&&this[_0x2aeffa(0x10b)]||function(_0x37d65f,_0x5043b7){const _0x15466f=_0x2aeffa;if(typeof Reflect==='object'&&typeof Reflect['metadata']==='function')return Reflect[_0x15466f(0xa1)](_0x37d65f,_0x5043b7);},__param=this&&this[_0x2aeffa(0xa8)]||function(_0x3b8ffe,_0x2d4a6e){return function(_0x4c0ebc,_0xeadc7f){_0x2d4a6e(_0x4c0ebc,_0xeadc7f,_0x3b8ffe);};};Object[_0x2aeffa(0xd9)](exports,_0x2aeffa(0xf0),{'value':!![]}),exports['ChatLogService']=void 0x0;const balance_constant_1=require('../../common/constants/balance.constant'),utils_1=require(_0x2aeffa(0xf9)),common_1=require(_0x2aeffa(0xd4)),typeorm_1=require(_0x2aeffa(0x9d)),exceljs_1=require('exceljs'),typeorm_2=require(_0x2aeffa(0x98)),chatGroup_entity_1=require(_0x2aeffa(0xe0)),user_entity_1=require('../user/user.entity'),chatLog_entity_1=require(_0x2aeffa(0xa4)),models_service_1=require(_0x2aeffa(0xd8));let ChatLogService=class ChatLogService{constructor(_0x1f46cc,_0x36c77b,_0x3878cb,_0x10adf6){const _0xa56d47=_0x2aeffa;this[_0xa56d47(0xcc)]=_0x1f46cc,this[_0xa56d47(0xb7)]=_0x36c77b,this[_0xa56d47(0xb5)]=_0x3878cb,this['modelsService']=_0x10adf6;}async['saveChatLog'](_0x666ed0){const _0x496859=_0x2aeffa,_0x1cb928=await this[_0x496859(0xcc)][_0x496859(0x116)](_0x666ed0);return _0x1cb928;}async['updateChatLog'](_0x320db9,_0x59c355){const _0x2f2d86=_0x2aeffa;return await this[_0x2f2d86(0xcc)][_0x2f2d86(0xbe)]({'id':_0x320db9},_0x59c355);}async[_0x2aeffa(0xb3)](_0x3df5de){const _0xb5317e=_0x2aeffa;return await this[_0xb5317e(0xcc)]['findOne']({'where':{'id':_0x3df5de}});}async[_0x2aeffa(0xab)](_0x269fdd,_0x4fb855){const _0x4fd753=_0x2aeffa,{id:_0x58f0ac}=_0x269fdd['user'],{model:_0x54be94}=_0x4fb855,_0x4c56a7={'userId':_0x58f0ac,'type':balance_constant_1[_0x4fd753(0x10c)][_0x4fd753(0x90)]};_0x54be94&&(_0x4c56a7['model']=_0x54be94,_0x54be94===_0x4fd753(0x114)&&(_0x4c56a7[_0x4fd753(0xf2)]=(0x0,typeorm_2['In'])([_0x4fd753(0x114),'dall-e-3'])));const _0x2f209e=await this[_0x4fd753(0xcc)][_0x4fd753(0xa9)]({'where':_0x4c56a7,'order':{'id':_0x4fd753(0xe9)},'select':['id','answer',_0x4fd753(0x105),_0x4fd753(0xf2),'type',_0x4fd753(0x117)]});return _0x2f209e[_0x4fd753(0xc7)](_0x4a98a0=>{const _0x3ca7fd=_0x4fd753;if(_0x4a98a0['type']===_0x3ca7fd(0x91)){const _0x2cf373=_0x4a98a0[_0x3ca7fd(0xf2)]==='mj'?0x136:0xa0,_0x2778ac=_0x4a98a0['answer'][_0x3ca7fd(0x102)](_0x3ca7fd(0xe5))?_0x3ca7fd(0xe4):_0x3ca7fd(0x9b),_0x1f08a0=_0x2778ac===_0x3ca7fd(0xe4)?'?imageView2/1/w/'+_0x2cf373+'/q/55':_0x3ca7fd(0xf7)+_0x2cf373;_0x4a98a0[_0x3ca7fd(0x96)]=_0x4a98a0[_0x3ca7fd(0xb8)]+_0x1f08a0;try{_0x4a98a0['fileInfo']=_0x4a98a0['fileInfo']?JSON[_0x3ca7fd(0xd2)](_0x4a98a0[_0x3ca7fd(0x117)]):null;}catch(_0x3c0e5a){_0x4a98a0['fileInfo']={};}}}),_0x2f209e;}async[_0x2aeffa(0xe8)](_0x5d052e){const _0x3cd566=_0x2aeffa,{page:page=0x1,size:size=0x14,rec:_0x2984d1,userId:_0x5db86f,model:_0x2788f7}=_0x5d052e,_0x390601={'type':0x2,'prompt':(0x0,typeorm_2[_0x3cd566(0xd3)])(''),'answer':(0x0,typeorm_2[_0x3cd566(0xd3)])(''),'fileInfo':(0x0,typeorm_2[_0x3cd566(0xd3)])('')};_0x2984d1&&Object[_0x3cd566(0xee)](_0x390601,{'rec':_0x2984d1}),_0x5db86f&&Object[_0x3cd566(0xee)](_0x390601,{'userId':_0x5db86f});_0x2788f7?_0x390601[_0x3cd566(0xf2)]=_0x2788f7:_0x390601[_0x3cd566(0xf2)]=(0x0,typeorm_2['In'])([_0x3cd566(0xdc),_0x3cd566(0xad),'stable-diffusion']);const [_0x45cbe8,_0x277579]=await this[_0x3cd566(0xcc)][_0x3cd566(0xd6)]({'order':{'id':_0x3cd566(0xe9)},'skip':(page-0x1)*size,'take':size,'where':_0x390601}),_0x2cfc1c=_0x45cbe8['map'](_0x11ba93=>_0x11ba93[_0x3cd566(0x94)])[_0x3cd566(0x111)](_0x21edbc=>_0x21edbc<0x186a0),_0x517dec=await this[_0x3cd566(0xb7)][_0x3cd566(0xa9)]({'where':{'id':(0x0,typeorm_2['In'])(_0x2cfc1c)},'select':['id',_0x3cd566(0xf4),_0x3cd566(0x104),_0x3cd566(0xa5)]});return _0x45cbe8[_0x3cd566(0xc7)](_0x2b3dd0=>{const _0x5e4e33=_0x3cd566;_0x2b3dd0[_0x5e4e33(0xc9)]=_0x517dec[_0x5e4e33(0xa9)](_0x4f4815=>_0x4f4815['id']===_0x2b3dd0[_0x5e4e33(0x94)]);}),_0x45cbe8['forEach'](_0x1e972f=>{const _0x110472=_0x3cd566;var _0x24249b;const _0x51c555=_0x1e972f[_0x110472(0xf2)]===_0x110472(0xdc)?0x136:0xa0,_0x389610=_0x1e972f[_0x110472(0xb8)][_0x110472(0x102)](_0x110472(0xe5))?_0x110472(0xe4):_0x110472(0x9b),_0x1a77d0=_0x389610===_0x110472(0xe4)?_0x110472(0xb6)+_0x51c555+_0x110472(0xdb):_0x110472(0xf7)+_0x51c555;_0x1e972f['thumbImg']=_0x1e972f['answer']+_0x1a77d0;try{const _0x2d94c3=_0x1e972f[_0x110472(0x119)]?JSON[_0x110472(0xd2)](_0x1e972f[_0x110472(0x119)]):null;_0x2d94c3&&(_0x2d94c3?_0x1e972f['isGroup']=((_0x24249b=_0x2d94c3===null||_0x2d94c3===void 0x0?void 0x0:_0x2d94c3[_0x110472(0xa0)][0x0])===null||_0x24249b===void 0x0?void 0x0:_0x24249b[_0x110472(0xa0)][_0x110472(0x9c)])===0x5:_0x1e972f['isGroup']=![]);}catch(_0x584ea5){console[_0x110472(0xaa)](_0x110472(0xff),_0x584ea5);}}),{'rows':_0x45cbe8,'count':_0x277579};}async[_0x2aeffa(0x100)](_0xdb3047){const _0x17184f=_0x2aeffa,{id:_0x9b336f}=_0xdb3047,_0x482c51=await this[_0x17184f(0xcc)][_0x17184f(0xaf)]({'where':{'id':_0x9b336f}});return _0x482c51;}async[_0x2aeffa(0xcf)](_0x5d6475){const _0x4a1238=_0x2aeffa,{id:_0x51ee2a}=_0x5d6475,_0x215673=await this[_0x4a1238(0xcc)][_0x4a1238(0xaf)]({'where':{'id':_0x51ee2a,'type':balance_constant_1[_0x4a1238(0x10c)][_0x4a1238(0x90)]}});if(!_0x215673)throw new common_1[(_0x4a1238(0x95))](_0x4a1238(0xd5),common_1['HttpStatus'][_0x4a1238(0xf3)]);const _0x29df91=_0x215673['rec']===0x1?0x0:0x1,_0x526d89=await this[_0x4a1238(0xcc)]['update']({'id':_0x51ee2a},{'rec':_0x29df91});if(_0x526d89['affected']>0x0)return(_0x29df91?'推荐':'取消推荐')+'图片成功！';throw new common_1[(_0x4a1238(0x95))]('你操作的图片不存在、请检查！',common_1[_0x4a1238(0xec)][_0x4a1238(0xf3)]);}async[_0x2aeffa(0x9e)](_0x5ea41a,_0x32460f){const _0x23e0d5=_0x2aeffa,_0x23afa3={'type':balance_constant_1['ChatType'][_0x23e0d5(0xf5)]},{page:page=0x1,size:size=0x1e,prompt:_0x43184f,email:_0xc8faba}=_0x5ea41a;_0x43184f&&Object['assign'](_0x23afa3,{'prompt':(0x0,typeorm_2[_0x23e0d5(0xa7)])('%'+_0x43184f+'%')});if(_0xc8faba){const _0x1e30ec=await this[_0x23e0d5(0xb7)][_0x23e0d5(0xaf)]({'where':{'email':_0xc8faba}});(_0x1e30ec===null||_0x1e30ec===void 0x0?void 0x0:_0x1e30ec['id'])&&Object[_0x23e0d5(0xee)](_0x23afa3,{'userId':_0x1e30ec['id']});}const [_0x4e00bc,_0x2068a6]=await this[_0x23e0d5(0xcc)]['findAndCount']({'order':{'id':_0x23e0d5(0xe9)},'skip':(page-0x1)*size,'take':size,'where':_0x23afa3}),_0x2bfb13=_0x4e00bc[_0x23e0d5(0xd0)](_0x8afefd=>_0x8afefd['userId']),_0x2fe991=await this[_0x23e0d5(0xb7)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x2bfb13)}}),_0x3f2802=_0x4e00bc[_0x23e0d5(0xd0)](_0x15c3c1=>{const _0x3150f2=_0x23e0d5,_0x52aca7=_0x2fe991[_0x3150f2(0xa9)](_0x4166d7=>_0x4166d7['id']===_0x15c3c1[_0x3150f2(0x94)]);return{'username':_0x52aca7?_0x52aca7[_0x3150f2(0xf4)]:'','email':_0x52aca7?_0x52aca7[_0x3150f2(0xa5)]:'','prompt':_0x15c3c1[_0x3150f2(0x105)],'answer':_0x15c3c1[_0x3150f2(0xb8)],'createdAt':(0x0,utils_1[_0x3150f2(0x101)])(_0x15c3c1['createdAt'])};}),_0x5cf34c=new exceljs_1[(_0x23e0d5(0xc5))][(_0x23e0d5(0xe2))](),_0x56cb21=_0x5cf34c[_0x23e0d5(0xdd)](_0x23e0d5(0x97));_0x56cb21[_0x23e0d5(0xac)]=[{'header':_0x23e0d5(0xdf),'key':_0x23e0d5(0xf4),'width':0x14},{'header':'用户邮箱','key':_0x23e0d5(0xa5),'width':0x14},{'header':_0x23e0d5(0xcb),'key':_0x23e0d5(0xe6),'width':0x14},{'header':_0x23e0d5(0xef),'key':_0x23e0d5(0x105),'width':0x50},{'header':_0x23e0d5(0x110),'key':_0x23e0d5(0xb8),'width':0x96}],_0x3f2802[_0x23e0d5(0xc7)](_0x524175=>_0x56cb21[_0x23e0d5(0x8e)](_0x524175)),_0x32460f[_0x23e0d5(0xe1)](_0x23e0d5(0xb1),'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'),_0x32460f['setHeader'](_0x23e0d5(0x99),_0x23e0d5(0xea)+_0x23e0d5(0xb9)),await _0x5cf34c[_0x23e0d5(0xf8)][_0x23e0d5(0xe7)](_0x32460f),_0x32460f['end']();}async['querAllChatLog'](_0x53d22f,_0x2c7b4c){const _0x380d37=_0x2aeffa,{page:page=0x1,size:size=0x14,userId:_0x45ab5f,prompt:_0x3b5ef9}=_0x53d22f,_0x41f1ca={'type':balance_constant_1[_0x380d37(0x10c)][_0x380d37(0xf5)],'prompt':(0x0,typeorm_2[_0x380d37(0xd3)])('')};_0x45ab5f&&Object[_0x380d37(0xee)](_0x41f1ca,{'userId':_0x45ab5f}),_0x3b5ef9&&Object[_0x380d37(0xee)](_0x41f1ca,{'prompt':(0x0,typeorm_2[_0x380d37(0xa7)])('%'+_0x3b5ef9+'%')});const [_0x19c2a2,_0x5a34cd]=await this[_0x380d37(0xcc)]['findAndCount']({'order':{'id':_0x380d37(0xe9)},'skip':(page-0x1)*size,'take':size,'where':_0x41f1ca}),_0x54a959=_0x19c2a2['map'](_0x5ee651=>_0x5ee651[_0x380d37(0x94)]),_0x317e92=await this[_0x380d37(0xb7)][_0x380d37(0xa9)]({'where':{'id':(0x0,typeorm_2['In'])(_0x54a959)},'select':['id',_0x380d37(0xf4),_0x380d37(0xa5)]});return _0x19c2a2[_0x380d37(0xc7)](_0x2b45d8=>{const _0x3df7cb=_0x380d37,{username:_0x4d2b82,email:_0x20d140}=_0x317e92[_0x3df7cb(0xa9)](_0x10b074=>_0x10b074['id']===_0x2b45d8[_0x3df7cb(0x94)])||{};_0x2b45d8['username']=_0x4d2b82,_0x2b45d8['email']=_0x20d140;}),_0x2c7b4c[_0x380d37(0xeb)][_0x380d37(0xed)]!==_0x380d37(0xd7)&&_0x19c2a2[_0x380d37(0xc7)](_0x447ce4=>_0x447ce4[_0x380d37(0xa5)]=(0x0,utils_1[_0x380d37(0xda)])(_0x447ce4['email'])),_0x19c2a2[_0x380d37(0xc7)](_0x21e90a=>{const _0x3f2cc1=_0x380d37;!_0x21e90a['email']&&(_0x21e90a[_0x3f2cc1(0xa5)]=(_0x21e90a===null||_0x21e90a===void 0x0?void 0x0:_0x21e90a[_0x3f2cc1(0x94)])+_0x3f2cc1(0xba)),!_0x21e90a[_0x3f2cc1(0xf4)]&&(_0x21e90a[_0x3f2cc1(0xf4)]='游客'+(_0x21e90a===null||_0x21e90a===void 0x0?void 0x0:_0x21e90a[_0x3f2cc1(0x94)]));}),{'rows':_0x19c2a2,'count':_0x5a34cd};}async[_0x2aeffa(0x112)](_0x83981c,_0xed7e3d){const _0x5679da=_0x2aeffa,{id:_0x32aecc}=_0x83981c[_0x5679da(0xeb)],{groupId:_0x1e74f3}=_0xed7e3d,_0x4bbd71={'userId':_0x32aecc,'isDelete':![]};_0x1e74f3&&Object[_0x5679da(0xee)](_0x4bbd71,{'groupId':_0x1e74f3});if(_0x1e74f3){const _0x96019c=await this['chatGroupEntity'][_0x5679da(0xc2)]({'where':{'isDelete':![]}});if(_0x96019c===0x0)return[];}const _0x4bfd73=await this['chatLogEntity'][_0x5679da(0xa9)]({'where':_0x4bbd71});return _0x4bfd73[_0x5679da(0xd0)](_0x367517=>{const _0x52cce3=_0x5679da,{prompt:_0x1ac300,role:_0x2dbf6e,answer:_0x267580,createdAt:_0xc5c53a,model:_0x5e7a6a,modelName:_0x149999,type:_0xd50b8b,status:_0x864535,action:_0x550510,drawId:_0x5c571a,id:_0x9b2df8,fileInfo:_0x223cd8,ttsUrl:_0x6e669b,videoUrl:_0x7839c8,audioUrl:_0x405f54,customId:_0x1fba08,pluginParam:_0x54ba7d,modelAvatar:_0x4cf7aa,taskData:_0x2ced27,promptReference:_0x134560}=_0x367517;return{'chatId':_0x9b2df8,'dateTime':(0x0,utils_1[_0x52cce3(0x101)])(_0xc5c53a),'text':_0x2dbf6e===_0x52cce3(0xeb)?_0x1ac300:_0x267580,'modelType':_0xd50b8b,'status':_0x864535,'action':_0x550510,'drawId':_0x5c571a,'customId':_0x1fba08,'inversion':_0x2dbf6e===_0x52cce3(0xeb),'error':![],'fileInfo':_0x223cd8,'ttsUrl':_0x6e669b,'videoUrl':_0x7839c8,'audioUrl':_0x405f54,'model':_0x5e7a6a,'modelName':_0x149999,'pluginParam':_0x54ba7d,'modelAvatar':_0x4cf7aa,'taskData':_0x2ced27,'promptReference':_0x134560};});}async['chatHistory'](_0x2f390e,_0x24d3ce){const _0x21cd79=_0x2aeffa;if(_0x24d3ce===0x0)return[];const _0x251283={'isDelete':![],'groupId':_0x2f390e},_0x5247aa=await this[_0x21cd79(0xcc)][_0x21cd79(0xa9)]({'where':_0x251283,'order':{'createdAt':'DESC'},'take':_0x24d3ce*0x2}),_0x3d22a9=_0x5247aa[_0x21cd79(0xd0)](_0x276a76=>{const _0x13c079=_0x21cd79,{role:_0x30fbac,prompt:_0x55b423,answer:_0x495c95,fileInfo:_0x6cbc32}=_0x276a76,_0x317f90={'role':_0x30fbac,'text':_0x30fbac===_0x13c079(0xeb)?_0x55b423:_0x495c95,'fileInfo':_0x6cbc32};return _0x317f90;})['reverse']();return _0x3d22a9;}async[_0x2aeffa(0x118)](_0x5882b4,_0x10ec53){const _0x3121f=_0x2aeffa,{id:_0x189df7}=_0x5882b4[_0x3121f(0xeb)],{id:_0x19c2a4}=_0x10ec53,_0x7e89b2=await this['chatLogEntity'][_0x3121f(0xaf)]({'where':{'id':_0x19c2a4,'userId':_0x189df7}});if(!_0x7e89b2)throw new common_1[(_0x3121f(0x95))](_0x3121f(0x115),common_1[_0x3121f(0xec)]['BAD_REQUEST']);const _0x1b2c2c=await this[_0x3121f(0xcc)][_0x3121f(0xbe)]({'id':_0x19c2a4},{'isDelete':!![]});if(_0x1b2c2c[_0x3121f(0x8d)]>0x0)return _0x3121f(0x9f);else throw new common_1[(_0x3121f(0x95))](_0x3121f(0x115),common_1['HttpStatus'][_0x3121f(0xf3)]);}async['delByGroupId'](_0x4a027a,_0x44f4cf){const _0x357efd=_0x2aeffa,{groupId:_0x17e40c}=_0x44f4cf,{id:_0x2b07ad}=_0x4a027a['user'],_0x2207ed=await this[_0x357efd(0xb5)][_0x357efd(0xaf)]({'where':{'id':_0x17e40c,'userId':_0x2b07ad}});if(!_0x2207ed)throw new common_1['HttpException'](_0x357efd(0x115),common_1[_0x357efd(0xec)][_0x357efd(0xf3)]);const _0x5651c1=await this[_0x357efd(0xcc)][_0x357efd(0xbe)]({'groupId':_0x17e40c},{'isDelete':!![]});if(_0x5651c1[_0x357efd(0x8d)]>0x0)return'删除对话记录成功！';if(_0x5651c1[_0x357efd(0x8d)]===0x0)throw new common_1['HttpException'](_0x357efd(0x8c),common_1['HttpStatus'][_0x357efd(0xf3)]);}async[_0x2aeffa(0x93)](_0x2494d6,_0x44f62f){const _0x9ba34d=_0x2aeffa,{id:_0x507190}=_0x44f62f,{id:_0x4d7f89}=_0x2494d6[_0x9ba34d(0xeb)],_0x250a85=await this[_0x9ba34d(0xcc)][_0x9ba34d(0xaf)]({'where':{'id':_0x507190,'userId':_0x4d7f89}});if(!_0x250a85)throw new common_1[(_0x9ba34d(0x95))](_0x9ba34d(0x115),common_1[_0x9ba34d(0xec)]['BAD_REQUEST']);const {groupId:_0x57f7a7}=_0x250a85,_0x365bea=await this['chatLogEntity'][_0x9ba34d(0xbe)]({'groupId':_0x57f7a7,'id':(0x0,typeorm_2[_0x9ba34d(0xc3)])(_0x507190)},{'isDelete':!![]});if(_0x365bea[_0x9ba34d(0x8d)]>0x0)return _0x9ba34d(0x9f);else throw new common_1['HttpException']('当前页面已经没有东西可以删除了！',common_1[_0x9ba34d(0xec)]['BAD_REQUEST']);}async['byAppId'](_0x320d27,_0x58ed6f){const _0x199467=_0x2aeffa,{id:_0x2c2ee5}=_0x320d27[_0x199467(0xeb)],{appId:_0x1ec011,page:page=0x1,size:size=0xa}=_0x58ed6f,[_0x181aae,_0x1bea9b]=await this[_0x199467(0xcc)]['findAndCount']({'where':{'userId':_0x2c2ee5,'appId':_0x1ec011,'role':_0x199467(0x10a)},'order':{'id':'DESC'},'take':size,'skip':(page-0x1)*size});return{'rows':_0x181aae,'count':_0x1bea9b};}async[_0x2aeffa(0xbd)](_0x487272,_0x36059e){const _0x122e2c=_0x2aeffa,_0x1d35f5=0xe10*0x3e8,_0x104d06=new Date(Date[_0x122e2c(0xbf)]()-_0x1d35f5);try{const _0x356f76=await this[_0x122e2c(0xcc)][_0x122e2c(0xc2)]({'where':{'userId':_0x487272['id'],'model':_0x36059e,'createdAt':(0x0,typeorm_2['MoreThan'])(_0x104d06)}}),_0x4d85fa=Math[_0x122e2c(0xce)](_0x356f76/0x2);common_1[_0x122e2c(0x8f)]['log'](_0x122e2c(0xbb)+_0x487272['id']+_0x122e2c(0x107)+_0x36059e+'\x20模型\x20'+(_0x4d85fa+0x1)+'\x20次','ChatLogService');let _0x31652b;_0x36059e[_0x122e2c(0xfc)](_0x122e2c(0xf1))?_0x31652b=await this[_0x122e2c(0xd1)]['getCurrentModelKeyInfo'](_0x122e2c(0xa3)):_0x31652b=await this[_0x122e2c(0xd1)][_0x122e2c(0xb4)](_0x36059e);const _0x302e78=Number(_0x31652b['modelLimits']);common_1['Logger'][_0x122e2c(0xaa)](_0x122e2c(0x108)+_0x36059e+'\x20的使用次数限制为\x20'+_0x302e78,_0x122e2c(0xc6));if(_0x4d85fa>_0x302e78)return!![];return![];}catch(_0x449898){common_1[_0x122e2c(0x8f)][_0x122e2c(0xa2)]('查询数据库出错\x20-\x20用户ID:\x20'+_0x487272['id']+_0x122e2c(0xa6)+_0x36059e+_0x122e2c(0xc1)+_0x449898[_0x122e2c(0xfd)],_0x449898[_0x122e2c(0x10e)],_0x122e2c(0xc6));}}};ChatLogService=__decorate([(0x0,common_1[_0x2aeffa(0xb0)])(),__param(0x0,(0x0,typeorm_1[_0x2aeffa(0xc0)])(chatLog_entity_1[_0x2aeffa(0x10d)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x2aeffa(0xb2)])),__param(0x2,(0x0,typeorm_1[_0x2aeffa(0xc0)])(chatGroup_entity_1['ChatGroupEntity'])),__metadata(_0x2aeffa(0xc8),[typeorm_2[_0x2aeffa(0xc4)],typeorm_2[_0x2aeffa(0xc4)],typeorm_2['Repository'],models_service_1[_0x2aeffa(0x109)]])],ChatLogService),exports[_0x2aeffa(0xc6)]=ChatLogService;