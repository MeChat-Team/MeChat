'use strict';const _0x2bb2f0=_0x3b63;(function(_0x321df6,_0x445751){const _0x206c54=_0x3b63,_0x127c04=_0x321df6();while(!![]){try{const _0xa80387=-parseInt(_0x206c54(0xc1))/0x1+parseInt(_0x206c54(0xe1))/0x2*(-parseInt(_0x206c54(0x76))/0x3)+-parseInt(_0x206c54(0xf3))/0x4*(parseInt(_0x206c54(0x7a))/0x5)+-parseInt(_0x206c54(0xd6))/0x6+parseInt(_0x206c54(0xae))/0x7*(parseInt(_0x206c54(0x78))/0x8)+-parseInt(_0x206c54(0xaa))/0x9*(-parseInt(_0x206c54(0x94))/0xa)+parseInt(_0x206c54(0x89))/0xb;if(_0xa80387===_0x445751)break;else _0x127c04['push'](_0x127c04['shift']());}catch(_0x3d97a2){_0x127c04['push'](_0x127c04['shift']());}}}(_0x449a,0xd03be));function _0x3b63(_0x4a7296,_0x56a2da){const _0x449aa8=_0x449a();return _0x3b63=function(_0x3b6326,_0x39cca6){_0x3b6326=_0x3b6326-0x6e;let _0x14a6e5=_0x449aa8[_0x3b6326];return _0x14a6e5;},_0x3b63(_0x4a7296,_0x56a2da);}function _0x449a(){const _0x508376=['32410543MEomdj','count','当前页面已经没有东西可以删除了！','\x20的使用次数限制为\x20','提问时间','\x20一小时内调用\x20','删除对话记录成功！','dall-e-3','delByGroupId','type','ceil','48110uotWPB','now','decorate','parse','thumbImg','exceljs','../chatGroup/chatGroup.entity','chatLogEntity','startsWith','update','forEach','midjourney','ali','components','PAINT','回答答案','maskEmail','../../common/utils','\x20模型\x20','gpts','你推荐的图片不存在、请检查！','attachment;\x20filename=','171psWFbS','findAndCount','addRow','NORMAL_CHAT','49469cKUzCk','DALL-E2','HttpException','defineProperty','error','查询数据库出错\x20-\x20用户ID:\x20','Like','querAllDrawLog\x20Json\x20parse\x20error','@nestjs/typeorm','Content-Type','图片成功！','stack','Repository','模型\x20','?x-oss-process=image/resize,w_','取消推荐','__param','assign','formatDate','228816gNBmRr','saveChatLog','用户ID:\x20','typeorm','querAllChatLog','getCurrentModelKeyInfo','modelsService','object','./chatLog.entity','message','assistant','exportExcel','__metadata','chatHistory','fileInfo','setHeader','chatGroupEntity','ChatLogService','extend','avatar','__decorate','5324364WPzQDF','prompt','Not','isGroup','addWorksheet','includes','find','reverse','deleteChatLog','tencent','xlsx','2CUKPzr','length','../models/models.service','用户邮箱','DESC','getOwnPropertyDescriptor','querDrawLog',',\x20错误信息:\x20','InjectRepository','checkModelLimits','UserEntity','../../common/constants/balance.constant','Content-Disposition','userId','Injectable','log','cos','BAD_REQUEST','141536uDtrEi','chatlog','model','createdAt','提问问题','recDrawImg','affected','updateChatLog','ChatType','@aiweb.com','../user/user.entity','username','@nestjs/common','metadata','answer','MoreThan','user','4388757ZrYMHK','?imageView2/1/w/','1688EVJtWE','end','155EiGOFE','userEntity','Logger','__esModule','findOne','gpt-4-gizmo','deleteChatsAfterId','paintCount','map','HttpStatus','email','你删除的对话记录不存在、请检查！','filter','design:paramtypes','findOneChatLog'];_0x449a=function(){return _0x508376;};return _0x449a();}var __decorate=this&&this[_0x2bb2f0(0xd5)]||function(_0x446256,_0x3ed914,_0x581957,_0x3a7512){const _0x3bd015=_0x2bb2f0;var _0x16fe5d=arguments[_0x3bd015(0xe2)],_0x38603f=_0x16fe5d<0x3?_0x3ed914:_0x3a7512===null?_0x3a7512=Object[_0x3bd015(0xe6)](_0x3ed914,_0x581957):_0x3a7512,_0x55dd51;if(typeof Reflect===_0x3bd015(0xc8)&&typeof Reflect[_0x3bd015(0x96)]==='function')_0x38603f=Reflect['decorate'](_0x446256,_0x3ed914,_0x581957,_0x3a7512);else{for(var _0x292c8d=_0x446256['length']-0x1;_0x292c8d>=0x0;_0x292c8d--)if(_0x55dd51=_0x446256[_0x292c8d])_0x38603f=(_0x16fe5d<0x3?_0x55dd51(_0x38603f):_0x16fe5d>0x3?_0x55dd51(_0x3ed914,_0x581957,_0x38603f):_0x55dd51(_0x3ed914,_0x581957))||_0x38603f;}return _0x16fe5d>0x3&&_0x38603f&&Object['defineProperty'](_0x3ed914,_0x581957,_0x38603f),_0x38603f;},__metadata=this&&this[_0x2bb2f0(0xcd)]||function(_0x15613e,_0x5698e0){const _0x21b25f=_0x2bb2f0;if(typeof Reflect===_0x21b25f(0xc8)&&typeof Reflect[_0x21b25f(0x72)]==='function')return Reflect[_0x21b25f(0x72)](_0x15613e,_0x5698e0);},__param=this&&this[_0x2bb2f0(0xbe)]||function(_0x58a450,_0x2fd6a2){return function(_0x309b18,_0x431d9a){_0x2fd6a2(_0x309b18,_0x431d9a,_0x58a450);};};Object[_0x2bb2f0(0xb1)](exports,_0x2bb2f0(0x7d),{'value':!![]}),exports[_0x2bb2f0(0xd2)]=void 0x0;const balance_constant_1=require(_0x2bb2f0(0xec)),utils_1=require(_0x2bb2f0(0xa5)),common_1=require(_0x2bb2f0(0x71)),typeorm_1=require(_0x2bb2f0(0xb6)),exceljs_1=require(_0x2bb2f0(0x99)),typeorm_2=require(_0x2bb2f0(0xc4)),chatGroup_entity_1=require(_0x2bb2f0(0x9a)),user_entity_1=require(_0x2bb2f0(0x6f)),chatLog_entity_1=require(_0x2bb2f0(0xc9)),models_service_1=require(_0x2bb2f0(0xe3));let ChatLogService=class ChatLogService{constructor(_0x32e95c,_0x4e0751,_0x13cefc,_0xf315cc){const _0x4edddb=_0x2bb2f0;this[_0x4edddb(0x9b)]=_0x32e95c,this[_0x4edddb(0x7b)]=_0x4e0751,this[_0x4edddb(0xd1)]=_0x13cefc,this[_0x4edddb(0xc7)]=_0xf315cc;}async[_0x2bb2f0(0xc2)](_0xef6b41){const _0x518703=_0x2bb2f0,_0x2b98cb=await this[_0x518703(0x9b)]['save'](_0xef6b41);return _0x2b98cb;}async[_0x2bb2f0(0xfa)](_0x33124c,_0xd89876){const _0x447f94=_0x2bb2f0;return await this[_0x447f94(0x9b)]['update']({'id':_0x33124c},_0xd89876);}async[_0x2bb2f0(0x88)](_0x40dab5){const _0x56d6cf=_0x2bb2f0;return await this[_0x56d6cf(0x9b)][_0x56d6cf(0x7e)]({'where':{'id':_0x40dab5}});}async[_0x2bb2f0(0xe7)](_0x5709c8,_0x17c4dd){const _0x461c79=_0x2bb2f0,{id:_0x1ae597}=_0x5709c8['user'],{model:_0x325b63}=_0x17c4dd,_0x1b2646={'userId':_0x1ae597,'type':balance_constant_1[_0x461c79(0xfb)][_0x461c79(0xa2)]};_0x325b63&&(_0x1b2646[_0x461c79(0xf5)]=_0x325b63,_0x325b63===_0x461c79(0xaf)&&(_0x1b2646[_0x461c79(0xf5)]=(0x0,typeorm_2['In'])([_0x461c79(0xaf),_0x461c79(0x90)])));const _0x3c357e=await this[_0x461c79(0x9b)][_0x461c79(0xdc)]({'where':_0x1b2646,'order':{'id':'DESC'},'select':['id',_0x461c79(0x73),_0x461c79(0xd7),_0x461c79(0xf5),_0x461c79(0x92),_0x461c79(0xcf)]});return _0x3c357e[_0x461c79(0x9e)](_0x225fe2=>{const _0x5a68f5=_0x461c79;if(_0x225fe2[_0x5a68f5(0x92)]===_0x5a68f5(0x81)){const _0x7a2001=_0x225fe2[_0x5a68f5(0xf5)]==='mj'?0x136:0xa0,_0xce1154=_0x225fe2[_0x5a68f5(0x73)][_0x5a68f5(0xdb)]('cos')?_0x5a68f5(0xdf):_0x5a68f5(0xa0),_0x4689ca=_0xce1154===_0x5a68f5(0xdf)?_0x5a68f5(0x77)+_0x7a2001+'/q/55':_0x5a68f5(0xbc)+_0x7a2001;_0x225fe2[_0x5a68f5(0x98)]=_0x225fe2[_0x5a68f5(0x73)]+_0x4689ca;try{_0x225fe2[_0x5a68f5(0xcf)]=_0x225fe2[_0x5a68f5(0xcf)]?JSON[_0x5a68f5(0x97)](_0x225fe2[_0x5a68f5(0xcf)]):null;}catch(_0x1f0c90){_0x225fe2['fileInfo']={};}}}),_0x3c357e;}async['querAllDrawLog'](_0x43e82c){const _0x26f3ce=_0x2bb2f0,{page:page=0x1,size:size=0x14,rec:_0x15a6f7,userId:_0x14bda2,model:_0x521326}=_0x43e82c,_0x21c40e={'type':0x2,'prompt':(0x0,typeorm_2['Not'])(''),'answer':(0x0,typeorm_2[_0x26f3ce(0xd8)])(''),'fileInfo':(0x0,typeorm_2[_0x26f3ce(0xd8)])('')};_0x15a6f7&&Object[_0x26f3ce(0xbf)](_0x21c40e,{'rec':_0x15a6f7}),_0x14bda2&&Object[_0x26f3ce(0xbf)](_0x21c40e,{'userId':_0x14bda2});_0x521326?_0x21c40e['model']=_0x521326:_0x21c40e['model']=(0x0,typeorm_2['In'])([_0x26f3ce(0x9f),_0x26f3ce(0x90),'stable-diffusion']);const [_0x4ce735,_0x18695a]=await this[_0x26f3ce(0x9b)][_0x26f3ce(0xab)]({'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size,'where':_0x21c40e}),_0x265793=_0x4ce735[_0x26f3ce(0x82)](_0x21ce00=>_0x21ce00[_0x26f3ce(0xee)])[_0x26f3ce(0x86)](_0x4db6e2=>_0x4db6e2<0x186a0),_0x100176=await this['userEntity'][_0x26f3ce(0xdc)]({'where':{'id':(0x0,typeorm_2['In'])(_0x265793)},'select':['id','username',_0x26f3ce(0xd4),_0x26f3ce(0x84)]});return _0x4ce735['forEach'](_0x4655ca=>{_0x4655ca['userInfo']=_0x100176['find'](_0x4c1c89=>_0x4c1c89['id']===_0x4655ca['userId']);}),_0x4ce735[_0x26f3ce(0x9e)](_0x4957db=>{const _0x845c17=_0x26f3ce;var _0x104d8d;const _0x164e60=_0x4957db[_0x845c17(0xf5)]==='midjourney'?0x136:0xa0,_0x2e8671=_0x4957db[_0x845c17(0x73)][_0x845c17(0xdb)](_0x845c17(0xf1))?_0x845c17(0xdf):_0x845c17(0xa0),_0x4c9622=_0x2e8671===_0x845c17(0xdf)?_0x845c17(0x77)+_0x164e60+'/q/55':_0x845c17(0xbc)+_0x164e60;_0x4957db[_0x845c17(0x98)]=_0x4957db[_0x845c17(0x73)]+_0x4c9622;try{const _0x36ec82=_0x4957db[_0x845c17(0xd3)]?JSON['parse'](_0x4957db[_0x845c17(0xd3)]):null;_0x36ec82&&(_0x36ec82?_0x4957db[_0x845c17(0xd9)]=((_0x104d8d=_0x36ec82===null||_0x36ec82===void 0x0?void 0x0:_0x36ec82[_0x845c17(0xa1)][0x0])===null||_0x104d8d===void 0x0?void 0x0:_0x104d8d['components'][_0x845c17(0xe2)])===0x5:_0x4957db['isGroup']=![]);}catch(_0x4d77fd){console[_0x845c17(0xf0)](_0x845c17(0xb5),_0x4d77fd);}}),{'rows':_0x4ce735,'count':_0x18695a};}async['findOneDrawLog'](_0xe01c3){const _0x2c67cc=_0x2bb2f0,{id:_0xa58f75}=_0xe01c3,_0x23ca36=await this[_0x2c67cc(0x9b)]['findOne']({'where':{'id':_0xa58f75}});return _0x23ca36;}async[_0x2bb2f0(0xf8)](_0x50974e){const _0x23f4e3=_0x2bb2f0,{id:_0xd33dfa}=_0x50974e,_0x2ed150=await this[_0x23f4e3(0x9b)][_0x23f4e3(0x7e)]({'where':{'id':_0xd33dfa,'type':balance_constant_1[_0x23f4e3(0xfb)][_0x23f4e3(0xa2)]}});if(!_0x2ed150)throw new common_1[(_0x23f4e3(0xb0))](_0x23f4e3(0xa8),common_1['HttpStatus'][_0x23f4e3(0xf2)]);const _0x53838e=_0x2ed150['rec']===0x1?0x0:0x1,_0x1479a9=await this[_0x23f4e3(0x9b)][_0x23f4e3(0x9d)]({'id':_0xd33dfa},{'rec':_0x53838e});if(_0x1479a9[_0x23f4e3(0xf9)]>0x0)return(_0x53838e?'推荐':_0x23f4e3(0xbd))+_0x23f4e3(0xb8);throw new common_1[(_0x23f4e3(0xb0))]('你操作的图片不存在、请检查！',common_1[_0x23f4e3(0x83)][_0x23f4e3(0xf2)]);}async[_0x2bb2f0(0xcc)](_0x4bffdd,_0x19fd9f){const _0x1c90a7=_0x2bb2f0,_0x3b8dfc={'type':balance_constant_1[_0x1c90a7(0xfb)][_0x1c90a7(0xad)]},{page:page=0x1,size:size=0x1e,prompt:_0x3b6202,email:_0x24fe91}=_0x4bffdd;_0x3b6202&&Object[_0x1c90a7(0xbf)](_0x3b8dfc,{'prompt':(0x0,typeorm_2['Like'])('%'+_0x3b6202+'%')});if(_0x24fe91){const _0x166403=await this[_0x1c90a7(0x7b)][_0x1c90a7(0x7e)]({'where':{'email':_0x24fe91}});(_0x166403===null||_0x166403===void 0x0?void 0x0:_0x166403['id'])&&Object['assign'](_0x3b8dfc,{'userId':_0x166403['id']});}const [_0x5b5c8d,_0x4edb46]=await this[_0x1c90a7(0x9b)][_0x1c90a7(0xab)]({'order':{'id':_0x1c90a7(0xe5)},'skip':(page-0x1)*size,'take':size,'where':_0x3b8dfc}),_0x551e42=_0x5b5c8d[_0x1c90a7(0x82)](_0x380fca=>_0x380fca[_0x1c90a7(0xee)]),_0x528de5=await this[_0x1c90a7(0x7b)][_0x1c90a7(0xdc)]({'where':{'id':(0x0,typeorm_2['In'])(_0x551e42)}}),_0x81b4cf=_0x5b5c8d[_0x1c90a7(0x82)](_0x5dadb9=>{const _0x13a375=_0x1c90a7,_0x5ed46d=_0x528de5[_0x13a375(0xdc)](_0xb5aa6d=>_0xb5aa6d['id']===_0x5dadb9['userId']);return{'username':_0x5ed46d?_0x5ed46d[_0x13a375(0x70)]:'','email':_0x5ed46d?_0x5ed46d[_0x13a375(0x84)]:'','prompt':_0x5dadb9[_0x13a375(0xd7)],'answer':_0x5dadb9[_0x13a375(0x73)],'createdAt':(0x0,utils_1[_0x13a375(0xc0)])(_0x5dadb9[_0x13a375(0xf6)])};}),_0x1be214=new exceljs_1['default']['Workbook'](),_0x4137aa=_0x1be214[_0x1c90a7(0xda)](_0x1c90a7(0xf4));_0x4137aa['columns']=[{'header':'用户名','key':_0x1c90a7(0x70),'width':0x14},{'header':_0x1c90a7(0xe4),'key':_0x1c90a7(0x84),'width':0x14},{'header':_0x1c90a7(0x8d),'key':'createdAt','width':0x14},{'header':_0x1c90a7(0xf7),'key':_0x1c90a7(0xd7),'width':0x50},{'header':_0x1c90a7(0xa3),'key':_0x1c90a7(0x73),'width':0x96}],_0x81b4cf[_0x1c90a7(0x9e)](_0xb14ff4=>_0x4137aa[_0x1c90a7(0xac)](_0xb14ff4)),_0x19fd9f[_0x1c90a7(0xd0)](_0x1c90a7(0xb7),'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'),_0x19fd9f[_0x1c90a7(0xd0)](_0x1c90a7(0xed),_0x1c90a7(0xa9)+'chat.xlsx'),await _0x1be214[_0x1c90a7(0xe0)]['write'](_0x19fd9f),_0x19fd9f[_0x1c90a7(0x79)]();}async[_0x2bb2f0(0xc5)](_0x519bc7,_0x42262e){const _0xd7c1a2=_0x2bb2f0,{page:page=0x1,size:size=0x14,userId:_0x345554,prompt:_0x43fa25}=_0x519bc7,_0x6ce654={'type':balance_constant_1[_0xd7c1a2(0xfb)][_0xd7c1a2(0xad)],'prompt':(0x0,typeorm_2[_0xd7c1a2(0xd8)])('')};_0x345554&&Object[_0xd7c1a2(0xbf)](_0x6ce654,{'userId':_0x345554}),_0x43fa25&&Object[_0xd7c1a2(0xbf)](_0x6ce654,{'prompt':(0x0,typeorm_2[_0xd7c1a2(0xb4)])('%'+_0x43fa25+'%')});const [_0xc6b07d,_0x993e5]=await this[_0xd7c1a2(0x9b)][_0xd7c1a2(0xab)]({'order':{'id':_0xd7c1a2(0xe5)},'skip':(page-0x1)*size,'take':size,'where':_0x6ce654}),_0x25b9a2=_0xc6b07d['map'](_0x218c8b=>_0x218c8b[_0xd7c1a2(0xee)]),_0x4495c5=await this[_0xd7c1a2(0x7b)][_0xd7c1a2(0xdc)]({'where':{'id':(0x0,typeorm_2['In'])(_0x25b9a2)},'select':['id',_0xd7c1a2(0x70),_0xd7c1a2(0x84)]});return _0xc6b07d['forEach'](_0x25fd19=>{const _0x1c660a=_0xd7c1a2,{username:_0x581d58,email:_0x31d3d6}=_0x4495c5[_0x1c660a(0xdc)](_0x29c18f=>_0x29c18f['id']===_0x25fd19[_0x1c660a(0xee)])||{};_0x25fd19[_0x1c660a(0x70)]=_0x581d58,_0x25fd19[_0x1c660a(0x84)]=_0x31d3d6;}),_0x42262e[_0xd7c1a2(0x75)]['role']!=='super'&&_0xc6b07d[_0xd7c1a2(0x9e)](_0x4c0246=>_0x4c0246[_0xd7c1a2(0x84)]=(0x0,utils_1[_0xd7c1a2(0xa4)])(_0x4c0246['email'])),_0xc6b07d[_0xd7c1a2(0x9e)](_0x422ad7=>{const _0x5e8729=_0xd7c1a2;!_0x422ad7['email']&&(_0x422ad7['email']=(_0x422ad7===null||_0x422ad7===void 0x0?void 0x0:_0x422ad7[_0x5e8729(0xee)])+_0x5e8729(0x6e)),!_0x422ad7[_0x5e8729(0x70)]&&(_0x422ad7[_0x5e8729(0x70)]='游客'+(_0x422ad7===null||_0x422ad7===void 0x0?void 0x0:_0x422ad7['userId']));}),{'rows':_0xc6b07d,'count':_0x993e5};}async['chatList'](_0x5920cd,_0x2362fb){const _0x18a3c8=_0x2bb2f0,{id:_0x1043ee}=_0x5920cd[_0x18a3c8(0x75)],{groupId:_0x2ba2e9}=_0x2362fb,_0x2f12d6={'userId':_0x1043ee,'isDelete':![]};_0x2ba2e9&&Object[_0x18a3c8(0xbf)](_0x2f12d6,{'groupId':_0x2ba2e9});if(_0x2ba2e9){const _0x6ee628=await this[_0x18a3c8(0xd1)][_0x18a3c8(0x8a)]({'where':{'isDelete':![]}});if(_0x6ee628===0x0)return[];}const _0x5b7da1=await this[_0x18a3c8(0x9b)]['find']({'where':_0x2f12d6});return _0x5b7da1['map'](_0x5ae020=>{const _0x1aea73=_0x18a3c8,{prompt:_0x472e03,role:_0x1e53a1,answer:_0x48d0b1,createdAt:_0x58afb5,model:_0xc1990b,modelName:_0x1406cb,type:_0x250202,status:_0x31484a,action:_0x65cdd2,drawId:_0x543f7e,id:_0x25db8a,fileInfo:_0x3c5b66,ttsUrl:_0x44a26b,videoUrl:_0x4d7b98,audioUrl:_0x1a8f7e,customId:_0x41ead5,pluginParam:_0x23f3a0,modelAvatar:_0x4572b2,taskData:_0x37546d,promptReference:_0x4c0a60}=_0x5ae020;return{'chatId':_0x25db8a,'dateTime':(0x0,utils_1[_0x1aea73(0xc0)])(_0x58afb5),'text':_0x1e53a1===_0x1aea73(0x75)?_0x472e03:_0x48d0b1,'modelType':_0x250202,'status':_0x31484a,'action':_0x65cdd2,'drawId':_0x543f7e,'customId':_0x41ead5,'inversion':_0x1e53a1===_0x1aea73(0x75),'error':![],'fileInfo':_0x3c5b66,'ttsUrl':_0x44a26b,'videoUrl':_0x4d7b98,'audioUrl':_0x1a8f7e,'model':_0xc1990b,'modelName':_0x1406cb,'pluginParam':_0x23f3a0,'modelAvatar':_0x4572b2,'taskData':_0x37546d,'promptReference':_0x4c0a60};});}async[_0x2bb2f0(0xce)](_0x33d9d5,_0x5635fe){const _0x14817d=_0x2bb2f0;if(_0x5635fe===0x0)return[];const _0x364849={'isDelete':![],'groupId':_0x33d9d5},_0x493a4f=await this[_0x14817d(0x9b)][_0x14817d(0xdc)]({'where':_0x364849,'order':{'createdAt':'DESC'},'take':_0x5635fe*0x2}),_0x111207=_0x493a4f[_0x14817d(0x82)](_0xffdc8c=>{const _0x4d92b3=_0x14817d,{role:_0xd6ec13,prompt:_0x1c83fa,answer:_0x3884b6,fileInfo:_0x44e4df}=_0xffdc8c,_0x2a05b3={'role':_0xd6ec13,'text':_0xd6ec13===_0x4d92b3(0x75)?_0x1c83fa:_0x3884b6,'fileInfo':_0x44e4df};return _0x2a05b3;})[_0x14817d(0xdd)]();return _0x111207;}async[_0x2bb2f0(0xde)](_0x4b95b0,_0xcffc8f){const _0x36075d=_0x2bb2f0,{id:_0x526eed}=_0x4b95b0[_0x36075d(0x75)],{id:_0x4d92df}=_0xcffc8f,_0x8b0ffd=await this[_0x36075d(0x9b)][_0x36075d(0x7e)]({'where':{'id':_0x4d92df,'userId':_0x526eed}});if(!_0x8b0ffd)throw new common_1[(_0x36075d(0xb0))](_0x36075d(0x85),common_1[_0x36075d(0x83)]['BAD_REQUEST']);const _0x42f7ad=await this[_0x36075d(0x9b)]['update']({'id':_0x4d92df},{'isDelete':!![]});if(_0x42f7ad[_0x36075d(0xf9)]>0x0)return'删除对话记录成功！';else throw new common_1[(_0x36075d(0xb0))](_0x36075d(0x85),common_1['HttpStatus']['BAD_REQUEST']);}async[_0x2bb2f0(0x91)](_0x367fe1,_0x3f340f){const _0x38663a=_0x2bb2f0,{groupId:_0x2611e6}=_0x3f340f,{id:_0xede96c}=_0x367fe1[_0x38663a(0x75)],_0x579da9=await this[_0x38663a(0xd1)][_0x38663a(0x7e)]({'where':{'id':_0x2611e6,'userId':_0xede96c}});if(!_0x579da9)throw new common_1[(_0x38663a(0xb0))]('你删除的对话记录不存在、请检查！',common_1[_0x38663a(0x83)]['BAD_REQUEST']);const _0x330cbe=await this[_0x38663a(0x9b)][_0x38663a(0x9d)]({'groupId':_0x2611e6},{'isDelete':!![]});if(_0x330cbe['affected']>0x0)return _0x38663a(0x8f);if(_0x330cbe[_0x38663a(0xf9)]===0x0)throw new common_1[(_0x38663a(0xb0))](_0x38663a(0x8b),common_1[_0x38663a(0x83)]['BAD_REQUEST']);}async[_0x2bb2f0(0x80)](_0x68629f,_0x483cec){const _0x3aea6b=_0x2bb2f0,{id:_0xf3c12}=_0x483cec,{id:_0x5bc950}=_0x68629f[_0x3aea6b(0x75)],_0x6a2a7b=await this[_0x3aea6b(0x9b)][_0x3aea6b(0x7e)]({'where':{'id':_0xf3c12,'userId':_0x5bc950}});if(!_0x6a2a7b)throw new common_1[(_0x3aea6b(0xb0))]('你删除的对话记录不存在、请检查！',common_1[_0x3aea6b(0x83)][_0x3aea6b(0xf2)]);const {groupId:_0x378414}=_0x6a2a7b,_0x381b1c=await this['chatLogEntity'][_0x3aea6b(0x9d)]({'groupId':_0x378414,'id':(0x0,typeorm_2['MoreThanOrEqual'])(_0xf3c12)},{'isDelete':!![]});if(_0x381b1c['affected']>0x0)return'删除对话记录成功！';else throw new common_1[(_0x3aea6b(0xb0))](_0x3aea6b(0x8b),common_1[_0x3aea6b(0x83)]['BAD_REQUEST']);}async['byAppId'](_0x5ae872,_0x32d5fb){const _0x4aa2ff=_0x2bb2f0,{id:_0x90cce7}=_0x5ae872[_0x4aa2ff(0x75)],{appId:_0x2afd60,page:page=0x1,size:size=0xa}=_0x32d5fb,[_0x2338f2,_0x4d3c6e]=await this[_0x4aa2ff(0x9b)]['findAndCount']({'where':{'userId':_0x90cce7,'appId':_0x2afd60,'role':_0x4aa2ff(0xcb)},'order':{'id':_0x4aa2ff(0xe5)},'take':size,'skip':(page-0x1)*size});return{'rows':_0x2338f2,'count':_0x4d3c6e};}async[_0x2bb2f0(0xea)](_0x552823,_0x4743f2){const _0x1105d3=_0x2bb2f0,_0x4f67c2=0xe10*0x3e8,_0x5a2c00=new Date(Date[_0x1105d3(0x95)]()-_0x4f67c2);try{const _0xd68993=await this['chatLogEntity'][_0x1105d3(0x8a)]({'where':{'userId':_0x552823['id'],'model':_0x4743f2,'createdAt':(0x0,typeorm_2[_0x1105d3(0x74)])(_0x5a2c00)}}),_0x1bd3c8=Math[_0x1105d3(0x93)](_0xd68993/0x2);common_1['Logger'][_0x1105d3(0xf0)](_0x1105d3(0xc3)+_0x552823['id']+_0x1105d3(0x8e)+_0x4743f2+_0x1105d3(0xa6)+(_0x1bd3c8+0x1)+'\x20次',_0x1105d3(0xd2));let _0x210588;_0x4743f2[_0x1105d3(0x9c)](_0x1105d3(0x7f))?_0x210588=await this['modelsService'][_0x1105d3(0xc6)](_0x1105d3(0xa7)):_0x210588=await this['modelsService'][_0x1105d3(0xc6)](_0x4743f2);const _0x2269f6=Number(_0x210588['modelLimits']);common_1['Logger'][_0x1105d3(0xf0)](_0x1105d3(0xbb)+_0x4743f2+_0x1105d3(0x8c)+_0x2269f6,_0x1105d3(0xd2));if(_0x1bd3c8>_0x2269f6)return!![];return![];}catch(_0x5a234b){common_1[_0x1105d3(0x7c)][_0x1105d3(0xb2)](_0x1105d3(0xb3)+_0x552823['id']+',\x20模型:\x20'+_0x4743f2+_0x1105d3(0xe8)+_0x5a234b[_0x1105d3(0xca)],_0x5a234b[_0x1105d3(0xb9)],_0x1105d3(0xd2));}}};ChatLogService=__decorate([(0x0,common_1[_0x2bb2f0(0xef)])(),__param(0x0,(0x0,typeorm_1[_0x2bb2f0(0xe9)])(chatLog_entity_1['ChatLogEntity'])),__param(0x1,(0x0,typeorm_1[_0x2bb2f0(0xe9)])(user_entity_1[_0x2bb2f0(0xeb)])),__param(0x2,(0x0,typeorm_1[_0x2bb2f0(0xe9)])(chatGroup_entity_1['ChatGroupEntity'])),__metadata(_0x2bb2f0(0x87),[typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2[_0x2bb2f0(0xba)],models_service_1['ModelsService']])],ChatLogService),exports[_0x2bb2f0(0xd2)]=ChatLogService;