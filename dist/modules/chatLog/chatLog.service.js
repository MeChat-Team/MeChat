'use strict';const _0x5df5e1=_0x5c5a;(function(_0x5798f6,_0x5ed2fd){const _0x1f8a0a=_0x5c5a,_0x35f1ca=_0x5798f6();while(!![]){try{const _0xea5937=-parseInt(_0x1f8a0a(0xc1))/0x1*(-parseInt(_0x1f8a0a(0xf3))/0x2)+parseInt(_0x1f8a0a(0xf1))/0x3+parseInt(_0x1f8a0a(0xdf))/0x4+-parseInt(_0x1f8a0a(0xac))/0x5*(parseInt(_0x1f8a0a(0x97))/0x6)+parseInt(_0x1f8a0a(0xbe))/0x7*(parseInt(_0x1f8a0a(0xf5))/0x8)+parseInt(_0x1f8a0a(0xa6))/0x9*(parseInt(_0x1f8a0a(0x96))/0xa)+-parseInt(_0x1f8a0a(0xc7))/0xb;if(_0xea5937===_0x5ed2fd)break;else _0x35f1ca['push'](_0x35f1ca['shift']());}catch(_0x3defde){_0x35f1ca['push'](_0x35f1ca['shift']());}}}(_0x35b3,0x22d6a));var __decorate=this&&this[_0x5df5e1(0x7a)]||function(_0x14560b,_0x2a76d3,_0x29dbdb,_0x2fa648){const _0x1580d5=_0x5df5e1;var _0xa57665=arguments[_0x1580d5(0x9b)],_0x255c92=_0xa57665<0x3?_0x2a76d3:_0x2fa648===null?_0x2fa648=Object[_0x1580d5(0xec)](_0x2a76d3,_0x29dbdb):_0x2fa648,_0x5d2320;if(typeof Reflect===_0x1580d5(0xb2)&&typeof Reflect[_0x1580d5(0xa7)]===_0x1580d5(0x8e))_0x255c92=Reflect[_0x1580d5(0xa7)](_0x14560b,_0x2a76d3,_0x29dbdb,_0x2fa648);else{for(var _0x2f1aeb=_0x14560b[_0x1580d5(0x9b)]-0x1;_0x2f1aeb>=0x0;_0x2f1aeb--)if(_0x5d2320=_0x14560b[_0x2f1aeb])_0x255c92=(_0xa57665<0x3?_0x5d2320(_0x255c92):_0xa57665>0x3?_0x5d2320(_0x2a76d3,_0x29dbdb,_0x255c92):_0x5d2320(_0x2a76d3,_0x29dbdb))||_0x255c92;}return _0xa57665>0x3&&_0x255c92&&Object[_0x1580d5(0xd4)](_0x2a76d3,_0x29dbdb,_0x255c92),_0x255c92;},__metadata=this&&this[_0x5df5e1(0xa0)]||function(_0x383db5,_0x33ab72){const _0x5882ad=_0x5df5e1;if(typeof Reflect==='object'&&typeof Reflect[_0x5882ad(0xcb)]===_0x5882ad(0x8e))return Reflect[_0x5882ad(0xcb)](_0x383db5,_0x33ab72);},__param=this&&this[_0x5df5e1(0xcd)]||function(_0x58599c,_0x2a2725){return function(_0x38ba7b,_0x36da60){_0x2a2725(_0x38ba7b,_0x36da60,_0x58599c);};};Object['defineProperty'](exports,_0x5df5e1(0xf2),{'value':!![]}),exports[_0x5df5e1(0xc8)]=void 0x0;const balance_constant_1=require(_0x5df5e1(0x8d)),utils_1=require(_0x5df5e1(0x91)),common_1=require('@nestjs/common'),typeorm_1=require(_0x5df5e1(0xfe)),exceljs_1=require(_0x5df5e1(0xc3)),typeorm_2=require(_0x5df5e1(0x85)),chatGroup_entity_1=require('../chatGroup/chatGroup.entity'),user_entity_1=require(_0x5df5e1(0xaa)),chatLog_entity_1=require(_0x5df5e1(0xd9)),models_service_1=require('../models/models.service');function _0x35b3(){const _0x29d913=['用户名','gpts','/q/55','error','querDrawLog','dall-e-3','?imageView2/1/w/','getOwnPropertyDescriptor','MoreThan','prompt','model','Like','634689KBYDMq','__esModule','72088QCvTGG','components','296pQzxqi','chatHistory','deleteChatLog','saveChatLog','parse','tencent','NORMAL_CHAT','update','\x20的使用次数限制为\x20','@nestjs/typeorm','你删除的对话记录不存在、请检查！','Injectable','userInfo','__decorate','find','用户邮箱','byAppId','message','ChatGroupEntity','ceil','当前页面已经没有东西可以删除了！','模型\x20','Repository','addWorksheet','typeorm','userId','recDrawImg','addRow','deleteChatsAfterId','DESC','paintCount','findOneChatLog','../../common/constants/balance.constant','function','map','avatar','../../common/utils','你操作的图片不存在、请检查！','reverse','setHeader','chatGroupEntity','10CMbLIM','6xoXJZk','@aiweb.com','getCurrentModelKeyInfo','ChatType','length','username','BAD_REQUEST','includes',',\x20错误信息:\x20','__metadata','affected','email','ali','querAllDrawLog','删除对话记录成功！','2335077iJZYrk','decorate','forEach','chat.xlsx','../user/user.entity','PAINT','1172845CxHolc','columns','startsWith','end','HttpStatus','取消推荐','object','\x20模型\x20','midjourney','modelsService','cos','InjectRepository','DALL-E2','Workbook','Not','write','assign','chatLogEntity','16478QMgWAT','你推荐的图片不存在、请检查！','rec','2BAGQXr','?x-oss-process=image/resize,w_','exceljs','isGroup','role','extend','2935812UWNhPL','ChatLogService','fileInfo','HttpException','metadata','now','__param','Content-Disposition','user','提问问题','assistant','delByGroupId','exportExcel','defineProperty','findOne','type','answer','userEntity','./chatLog.entity','图片成功！','\x20一小时内调用\x20','Logger','formatDate','gpt-4-gizmo','55828jWihJC','findAndCount','log','super','提问时间','modelLimits'];_0x35b3=function(){return _0x29d913;};return _0x35b3();}function _0x5c5a(_0x5f470b,_0x222c8b){const _0x35b3d8=_0x35b3();return _0x5c5a=function(_0x5c5aec,_0x27de25){_0x5c5aec=_0x5c5aec-0x7a;let _0x55a64c=_0x35b3d8[_0x5c5aec];return _0x55a64c;},_0x5c5a(_0x5f470b,_0x222c8b);}let ChatLogService=class ChatLogService{constructor(_0x39697b,_0x3a0b43,_0x2f5743,_0x53f05e){const _0x4cb726=_0x5df5e1;this[_0x4cb726(0xbd)]=_0x39697b,this['userEntity']=_0x3a0b43,this[_0x4cb726(0x95)]=_0x2f5743,this[_0x4cb726(0xb5)]=_0x53f05e;}async[_0x5df5e1(0xf8)](_0x2933d9){const _0x4f4758=_0x5df5e1,_0x4709e2=await this[_0x4f4758(0xbd)]['save'](_0x2933d9);return _0x4709e2;}async['updateChatLog'](_0x5dacfe,_0x510adc){const _0x9794c2=_0x5df5e1;return await this[_0x9794c2(0xbd)]['update']({'id':_0x5dacfe},_0x510adc);}async[_0x5df5e1(0x8c)](_0x1a2ba0){const _0x336eb8=_0x5df5e1;return await this[_0x336eb8(0xbd)][_0x336eb8(0xd5)]({'where':{'id':_0x1a2ba0}});}async[_0x5df5e1(0xe9)](_0x577b8f,_0x2b5b3a){const _0x26cf7b=_0x5df5e1,{id:_0x99a5ec}=_0x577b8f[_0x26cf7b(0xcf)],{model:_0xd9654c}=_0x2b5b3a,_0x39af21={'userId':_0x99a5ec,'type':balance_constant_1[_0x26cf7b(0x9a)][_0x26cf7b(0xab)]};_0xd9654c&&(_0x39af21[_0x26cf7b(0xef)]=_0xd9654c,_0xd9654c==='DALL-E2'&&(_0x39af21[_0x26cf7b(0xef)]=(0x0,typeorm_2['In'])([_0x26cf7b(0xb8),_0x26cf7b(0xea)])));const _0x42842e=await this[_0x26cf7b(0xbd)][_0x26cf7b(0x7b)]({'where':_0x39af21,'order':{'id':_0x26cf7b(0x8a)},'select':['id','answer',_0x26cf7b(0xee),'model',_0x26cf7b(0xd6),'fileInfo']});return _0x42842e['forEach'](_0x2409f2=>{const _0x40c96d=_0x26cf7b;if(_0x2409f2[_0x40c96d(0xd6)]===_0x40c96d(0x8b)){const _0x880f71=_0x2409f2[_0x40c96d(0xef)]==='mj'?0x136:0xa0,_0x17dca7=_0x2409f2[_0x40c96d(0xd7)]['includes'](_0x40c96d(0xb6))?'tencent':_0x40c96d(0xa3),_0x250d9a=_0x17dca7==='tencent'?'?imageView2/1/w/'+_0x880f71+'/q/55':_0x40c96d(0xc2)+_0x880f71;_0x2409f2['thumbImg']=_0x2409f2[_0x40c96d(0xd7)]+_0x250d9a;try{_0x2409f2[_0x40c96d(0xc9)]=_0x2409f2[_0x40c96d(0xc9)]?JSON[_0x40c96d(0xf9)](_0x2409f2[_0x40c96d(0xc9)]):null;}catch(_0x205a01){_0x2409f2[_0x40c96d(0xc9)]={};}}}),_0x42842e;}async[_0x5df5e1(0xa4)](_0x3818a0){const _0x44f79d=_0x5df5e1,{page:page=0x1,size:size=0x14,rec:_0x2b82e3,userId:_0xae2221,model:_0x59bb09}=_0x3818a0,_0x5a1b20={'type':0x2,'prompt':(0x0,typeorm_2[_0x44f79d(0xba)])(''),'answer':(0x0,typeorm_2[_0x44f79d(0xba)])(''),'fileInfo':(0x0,typeorm_2[_0x44f79d(0xba)])('')};_0x2b82e3&&Object['assign'](_0x5a1b20,{'rec':_0x2b82e3}),_0xae2221&&Object[_0x44f79d(0xbc)](_0x5a1b20,{'userId':_0xae2221});_0x59bb09?_0x5a1b20[_0x44f79d(0xef)]=_0x59bb09:_0x5a1b20['model']=(0x0,typeorm_2['In'])([_0x44f79d(0xb4),_0x44f79d(0xea),'stable-diffusion']);const [_0x28b2e6,_0x20074a]=await this[_0x44f79d(0xbd)][_0x44f79d(0xe0)]({'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size,'where':_0x5a1b20}),_0x4cc12e=_0x28b2e6['map'](_0x27d08f=>_0x27d08f['userId'])['filter'](_0xdf3a5e=>_0xdf3a5e<0x186a0),_0x2c3eb7=await this[_0x44f79d(0xd8)][_0x44f79d(0x7b)]({'where':{'id':(0x0,typeorm_2['In'])(_0x4cc12e)},'select':['id',_0x44f79d(0x9c),_0x44f79d(0x90),_0x44f79d(0xa2)]});return _0x28b2e6[_0x44f79d(0xa8)](_0x317285=>{const _0x362eaf=_0x44f79d;_0x317285[_0x362eaf(0x101)]=_0x2c3eb7[_0x362eaf(0x7b)](_0x1837cd=>_0x1837cd['id']===_0x317285['userId']);}),_0x28b2e6['forEach'](_0x483138=>{const _0x3da99f=_0x44f79d;var _0x3484a4;const _0x5c6451=_0x483138[_0x3da99f(0xef)]===_0x3da99f(0xb4)?0x136:0xa0,_0x457f08=_0x483138[_0x3da99f(0xd7)][_0x3da99f(0x9e)]('cos')?_0x3da99f(0xfa):'ali',_0xdecdcc=_0x457f08===_0x3da99f(0xfa)?_0x3da99f(0xeb)+_0x5c6451+_0x3da99f(0xe7):'?x-oss-process=image/resize,w_'+_0x5c6451;_0x483138['thumbImg']=_0x483138[_0x3da99f(0xd7)]+_0xdecdcc;try{const _0x16e40a=_0x483138[_0x3da99f(0xc6)]?JSON['parse'](_0x483138[_0x3da99f(0xc6)]):null;_0x16e40a&&(_0x16e40a?_0x483138[_0x3da99f(0xc4)]=((_0x3484a4=_0x16e40a===null||_0x16e40a===void 0x0?void 0x0:_0x16e40a[_0x3da99f(0xf4)][0x0])===null||_0x3484a4===void 0x0?void 0x0:_0x3484a4['components'][_0x3da99f(0x9b)])===0x5:_0x483138['isGroup']=![]);}catch(_0x6c5d99){console[_0x3da99f(0xe1)]('querAllDrawLog\x20Json\x20parse\x20error',_0x6c5d99);}}),{'rows':_0x28b2e6,'count':_0x20074a};}async['findOneDrawLog'](_0x2fab9a){const _0x4d5516=_0x5df5e1,{id:_0x294bfc}=_0x2fab9a,_0x13b584=await this[_0x4d5516(0xbd)]['findOne']({'where':{'id':_0x294bfc}});return _0x13b584;}async[_0x5df5e1(0x87)](_0x31321c){const _0x4ed4e4=_0x5df5e1,{id:_0x2d512e}=_0x31321c,_0x4daa0c=await this[_0x4ed4e4(0xbd)][_0x4ed4e4(0xd5)]({'where':{'id':_0x2d512e,'type':balance_constant_1[_0x4ed4e4(0x9a)][_0x4ed4e4(0xab)]}});if(!_0x4daa0c)throw new common_1[(_0x4ed4e4(0xca))](_0x4ed4e4(0xbf),common_1['HttpStatus']['BAD_REQUEST']);const _0x251ab5=_0x4daa0c[_0x4ed4e4(0xc0)]===0x1?0x0:0x1,_0xb3ba68=await this['chatLogEntity'][_0x4ed4e4(0xfc)]({'id':_0x2d512e},{'rec':_0x251ab5});if(_0xb3ba68['affected']>0x0)return(_0x251ab5?'推荐':_0x4ed4e4(0xb1))+_0x4ed4e4(0xda);throw new common_1[(_0x4ed4e4(0xca))](_0x4ed4e4(0x92),common_1[_0x4ed4e4(0xb0)][_0x4ed4e4(0x9d)]);}async[_0x5df5e1(0xd3)](_0x15a76f,_0x1f7c34){const _0x2f5100=_0x5df5e1,_0x18571c={'type':balance_constant_1[_0x2f5100(0x9a)][_0x2f5100(0xfb)]},{page:page=0x1,size:size=0x1e,prompt:_0x4ce74e,email:_0x4992a2}=_0x15a76f;_0x4ce74e&&Object[_0x2f5100(0xbc)](_0x18571c,{'prompt':(0x0,typeorm_2[_0x2f5100(0xf0)])('%'+_0x4ce74e+'%')});if(_0x4992a2){const _0x3bf75c=await this['userEntity'][_0x2f5100(0xd5)]({'where':{'email':_0x4992a2}});(_0x3bf75c===null||_0x3bf75c===void 0x0?void 0x0:_0x3bf75c['id'])&&Object[_0x2f5100(0xbc)](_0x18571c,{'userId':_0x3bf75c['id']});}const [_0x11e25f,_0x1fec6d]=await this[_0x2f5100(0xbd)][_0x2f5100(0xe0)]({'order':{'id':_0x2f5100(0x8a)},'skip':(page-0x1)*size,'take':size,'where':_0x18571c}),_0x34739b=_0x11e25f['map'](_0x2cf099=>_0x2cf099['userId']),_0x407313=await this[_0x2f5100(0xd8)][_0x2f5100(0x7b)]({'where':{'id':(0x0,typeorm_2['In'])(_0x34739b)}}),_0x5bf9b3=_0x11e25f[_0x2f5100(0x8f)](_0x2e853e=>{const _0x3e3450=_0x2f5100,_0x1faa9d=_0x407313[_0x3e3450(0x7b)](_0x2e8eb0=>_0x2e8eb0['id']===_0x2e853e[_0x3e3450(0x86)]);return{'username':_0x1faa9d?_0x1faa9d[_0x3e3450(0x9c)]:'','email':_0x1faa9d?_0x1faa9d[_0x3e3450(0xa2)]:'','prompt':_0x2e853e['prompt'],'answer':_0x2e853e[_0x3e3450(0xd7)],'createdAt':(0x0,utils_1[_0x3e3450(0xdd)])(_0x2e853e['createdAt'])};}),_0x5e6cee=new exceljs_1['default'][(_0x2f5100(0xb9))](),_0x926148=_0x5e6cee[_0x2f5100(0x84)]('chatlog');_0x926148[_0x2f5100(0xad)]=[{'header':_0x2f5100(0xe5),'key':_0x2f5100(0x9c),'width':0x14},{'header':_0x2f5100(0x7c),'key':'email','width':0x14},{'header':_0x2f5100(0xe3),'key':'createdAt','width':0x14},{'header':_0x2f5100(0xd0),'key':_0x2f5100(0xee),'width':0x50},{'header':'回答答案','key':_0x2f5100(0xd7),'width':0x96}],_0x5bf9b3[_0x2f5100(0xa8)](_0xb71029=>_0x926148[_0x2f5100(0x88)](_0xb71029)),_0x1f7c34[_0x2f5100(0x94)]('Content-Type','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'),_0x1f7c34[_0x2f5100(0x94)](_0x2f5100(0xce),'attachment;\x20filename='+_0x2f5100(0xa9)),await _0x5e6cee['xlsx'][_0x2f5100(0xbb)](_0x1f7c34),_0x1f7c34[_0x2f5100(0xaf)]();}async['querAllChatLog'](_0x18913f,_0x4abc44){const _0x2fabb9=_0x5df5e1,{page:page=0x1,size:size=0x14,userId:_0x187f77,prompt:_0x1c9973}=_0x18913f,_0xb5586d={'type':balance_constant_1[_0x2fabb9(0x9a)][_0x2fabb9(0xfb)],'prompt':(0x0,typeorm_2[_0x2fabb9(0xba)])('')};_0x187f77&&Object[_0x2fabb9(0xbc)](_0xb5586d,{'userId':_0x187f77}),_0x1c9973&&Object['assign'](_0xb5586d,{'prompt':(0x0,typeorm_2[_0x2fabb9(0xf0)])('%'+_0x1c9973+'%')});const [_0x2f0957,_0x35219f]=await this[_0x2fabb9(0xbd)][_0x2fabb9(0xe0)]({'order':{'id':_0x2fabb9(0x8a)},'skip':(page-0x1)*size,'take':size,'where':_0xb5586d}),_0x2a3a9d=_0x2f0957['map'](_0x18fbba=>_0x18fbba[_0x2fabb9(0x86)]),_0x28a3b2=await this['userEntity'][_0x2fabb9(0x7b)]({'where':{'id':(0x0,typeorm_2['In'])(_0x2a3a9d)},'select':['id',_0x2fabb9(0x9c),_0x2fabb9(0xa2)]});return _0x2f0957[_0x2fabb9(0xa8)](_0x24296d=>{const _0x1f8e14=_0x2fabb9,{username:_0x1cbce2,email:_0x534653}=_0x28a3b2[_0x1f8e14(0x7b)](_0x4518a8=>_0x4518a8['id']===_0x24296d[_0x1f8e14(0x86)])||{};_0x24296d[_0x1f8e14(0x9c)]=_0x1cbce2,_0x24296d[_0x1f8e14(0xa2)]=_0x534653;}),_0x4abc44['user'][_0x2fabb9(0xc5)]!==_0x2fabb9(0xe2)&&_0x2f0957[_0x2fabb9(0xa8)](_0x445d49=>_0x445d49[_0x2fabb9(0xa2)]=(0x0,utils_1['maskEmail'])(_0x445d49[_0x2fabb9(0xa2)])),_0x2f0957[_0x2fabb9(0xa8)](_0x875faf=>{const _0xa2ef1d=_0x2fabb9;!_0x875faf['email']&&(_0x875faf[_0xa2ef1d(0xa2)]=(_0x875faf===null||_0x875faf===void 0x0?void 0x0:_0x875faf[_0xa2ef1d(0x86)])+_0xa2ef1d(0x98)),!_0x875faf['username']&&(_0x875faf[_0xa2ef1d(0x9c)]='游客'+(_0x875faf===null||_0x875faf===void 0x0?void 0x0:_0x875faf['userId']));}),{'rows':_0x2f0957,'count':_0x35219f};}async['chatList'](_0x3e6338,_0x263ba7){const _0x2d2404=_0x5df5e1,{id:_0x327d07}=_0x3e6338['user'],{groupId:_0x5f0a2f}=_0x263ba7,_0x15d130={'userId':_0x327d07,'isDelete':![]};_0x5f0a2f&&Object[_0x2d2404(0xbc)](_0x15d130,{'groupId':_0x5f0a2f});if(_0x5f0a2f){const _0x2386d9=await this[_0x2d2404(0x95)]['count']({'where':{'isDelete':![]}});if(_0x2386d9===0x0)return[];}const _0x4825cf=await this['chatLogEntity'][_0x2d2404(0x7b)]({'where':_0x15d130});return _0x4825cf[_0x2d2404(0x8f)](_0x52d0f0=>{const _0x1cf8be=_0x2d2404,{prompt:_0x588500,role:_0x252ada,answer:_0xd2d67c,createdAt:_0x1936fe,model:_0x4135be,modelName:_0x34021e,type:_0x2ede32,status:_0xb1b17,action:_0x500909,drawId:_0x158102,id:_0x5a5a7a,fileInfo:_0x54a562,ttsUrl:_0x480b90,videoUrl:_0x55bd09,audioUrl:_0x1c9051,customId:_0x3d3f3a,pluginParam:_0x44859b,modelAvatar:_0x13784b,taskData:_0x549017,promptReference:_0x59fc2c}=_0x52d0f0;return{'chatId':_0x5a5a7a,'dateTime':(0x0,utils_1[_0x1cf8be(0xdd)])(_0x1936fe),'text':_0x252ada===_0x1cf8be(0xcf)?_0x588500:_0xd2d67c,'modelType':_0x2ede32,'status':_0xb1b17,'action':_0x500909,'drawId':_0x158102,'customId':_0x3d3f3a,'inversion':_0x252ada==='user','error':![],'fileInfo':_0x54a562,'ttsUrl':_0x480b90,'videoUrl':_0x55bd09,'audioUrl':_0x1c9051,'model':_0x4135be,'modelName':_0x34021e,'pluginParam':_0x44859b,'modelAvatar':_0x13784b,'taskData':_0x549017,'promptReference':_0x59fc2c};});}async[_0x5df5e1(0xf6)](_0x1ec227,_0x59aba2){const _0x410c4e=_0x5df5e1;if(_0x59aba2===0x0)return[];const _0x3711b1={'isDelete':![],'groupId':_0x1ec227},_0x22e8d0=await this[_0x410c4e(0xbd)][_0x410c4e(0x7b)]({'where':_0x3711b1,'order':{'createdAt':_0x410c4e(0x8a)},'take':_0x59aba2*0x2}),_0x2883ca=_0x22e8d0[_0x410c4e(0x8f)](_0x4044b1=>{const _0x15561d=_0x410c4e,{role:_0x58b980,prompt:_0x227388,answer:_0x223710,fileInfo:_0x33ff26}=_0x4044b1,_0x185445={'role':_0x58b980,'text':_0x58b980===_0x15561d(0xcf)?_0x227388:_0x223710,'fileInfo':_0x33ff26};return _0x185445;})[_0x410c4e(0x93)]();return _0x2883ca;}async[_0x5df5e1(0xf7)](_0x303311,_0x35d663){const _0x38d408=_0x5df5e1,{id:_0x5111e4}=_0x303311[_0x38d408(0xcf)],{id:_0x2ac81f}=_0x35d663,_0x691e52=await this['chatLogEntity']['findOne']({'where':{'id':_0x2ac81f,'userId':_0x5111e4}});if(!_0x691e52)throw new common_1[(_0x38d408(0xca))](_0x38d408(0xff),common_1[_0x38d408(0xb0)]['BAD_REQUEST']);const _0x24d1f0=await this[_0x38d408(0xbd)]['update']({'id':_0x2ac81f},{'isDelete':!![]});if(_0x24d1f0[_0x38d408(0xa1)]>0x0)return _0x38d408(0xa5);else throw new common_1[(_0x38d408(0xca))]('你删除的对话记录不存在、请检查！',common_1[_0x38d408(0xb0)][_0x38d408(0x9d)]);}async[_0x5df5e1(0xd2)](_0x4ed50c,_0x3d023e){const _0x5d866a=_0x5df5e1,{groupId:_0x11c7a8}=_0x3d023e,{id:_0x3ffea8}=_0x4ed50c[_0x5d866a(0xcf)],_0x3f9412=await this[_0x5d866a(0x95)]['findOne']({'where':{'id':_0x11c7a8,'userId':_0x3ffea8}});if(!_0x3f9412)throw new common_1[(_0x5d866a(0xca))](_0x5d866a(0xff),common_1[_0x5d866a(0xb0)][_0x5d866a(0x9d)]);const _0x447522=await this['chatLogEntity'][_0x5d866a(0xfc)]({'groupId':_0x11c7a8},{'isDelete':!![]});if(_0x447522[_0x5d866a(0xa1)]>0x0)return _0x5d866a(0xa5);if(_0x447522['affected']===0x0)throw new common_1[(_0x5d866a(0xca))](_0x5d866a(0x81),common_1[_0x5d866a(0xb0)][_0x5d866a(0x9d)]);}async[_0x5df5e1(0x89)](_0x575225,_0x19a0ed){const _0x21207c=_0x5df5e1,{id:_0x15b941}=_0x19a0ed,{id:_0x5ab916}=_0x575225[_0x21207c(0xcf)],_0x248958=await this[_0x21207c(0xbd)]['findOne']({'where':{'id':_0x15b941,'userId':_0x5ab916}});if(!_0x248958)throw new common_1['HttpException'](_0x21207c(0xff),common_1[_0x21207c(0xb0)]['BAD_REQUEST']);const {groupId:_0x5c1fb6}=_0x248958,_0x7351e=await this['chatLogEntity'][_0x21207c(0xfc)]({'groupId':_0x5c1fb6,'id':(0x0,typeorm_2['MoreThanOrEqual'])(_0x15b941)},{'isDelete':!![]});if(_0x7351e['affected']>0x0)return _0x21207c(0xa5);else throw new common_1['HttpException']('当前页面已经没有东西可以删除了！',common_1[_0x21207c(0xb0)][_0x21207c(0x9d)]);}async[_0x5df5e1(0x7d)](_0x2d4225,_0x10344f){const _0x393e2a=_0x5df5e1,{id:_0x3daf9e}=_0x2d4225[_0x393e2a(0xcf)],{appId:_0x39355c,page:page=0x1,size:size=0xa}=_0x10344f,[_0x37a91a,_0xd947d8]=await this[_0x393e2a(0xbd)]['findAndCount']({'where':{'userId':_0x3daf9e,'appId':_0x39355c,'role':_0x393e2a(0xd1)},'order':{'id':_0x393e2a(0x8a)},'take':size,'skip':(page-0x1)*size});return{'rows':_0x37a91a,'count':_0xd947d8};}async['checkModelLimits'](_0x27b5b1,_0xfcd1d){const _0x48a4cc=_0x5df5e1,_0x598b97=0xe10*0x3e8,_0x2167a6=new Date(Date[_0x48a4cc(0xcc)]()-_0x598b97);try{const _0x4d6bab=await this[_0x48a4cc(0xbd)]['count']({'where':{'userId':_0x27b5b1['id'],'model':_0xfcd1d,'createdAt':(0x0,typeorm_2[_0x48a4cc(0xed)])(_0x2167a6)}}),_0x1b1221=Math[_0x48a4cc(0x80)](_0x4d6bab/0x2);common_1[_0x48a4cc(0xdc)][_0x48a4cc(0xe1)]('用户ID:\x20'+_0x27b5b1['id']+_0x48a4cc(0xdb)+_0xfcd1d+_0x48a4cc(0xb3)+(_0x1b1221+0x1)+'\x20次','ChatLogService');let _0x4349aa;_0xfcd1d[_0x48a4cc(0xae)](_0x48a4cc(0xde))?_0x4349aa=await this[_0x48a4cc(0xb5)][_0x48a4cc(0x99)](_0x48a4cc(0xe6)):_0x4349aa=await this[_0x48a4cc(0xb5)][_0x48a4cc(0x99)](_0xfcd1d);const _0x55a01c=Number(_0x4349aa[_0x48a4cc(0xe4)]);common_1['Logger'][_0x48a4cc(0xe1)](_0x48a4cc(0x82)+_0xfcd1d+_0x48a4cc(0xfd)+_0x55a01c,_0x48a4cc(0xc8));if(_0x1b1221>_0x55a01c)return!![];return![];}catch(_0x27a1e6){common_1[_0x48a4cc(0xdc)][_0x48a4cc(0xe8)]('查询数据库出错\x20-\x20用户ID:\x20'+_0x27b5b1['id']+',\x20模型:\x20'+_0xfcd1d+_0x48a4cc(0x9f)+_0x27a1e6[_0x48a4cc(0x7e)],_0x27a1e6['stack'],'ChatLogService');}}};ChatLogService=__decorate([(0x0,common_1[_0x5df5e1(0x100)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(chatLog_entity_1['ChatLogEntity'])),__param(0x1,(0x0,typeorm_1[_0x5df5e1(0xb7)])(user_entity_1['UserEntity'])),__param(0x2,(0x0,typeorm_1[_0x5df5e1(0xb7)])(chatGroup_entity_1[_0x5df5e1(0x7f)])),__metadata('design:paramtypes',[typeorm_2[_0x5df5e1(0x83)],typeorm_2[_0x5df5e1(0x83)],typeorm_2[_0x5df5e1(0x83)],models_service_1['ModelsService']])],ChatLogService),exports['ChatLogService']=ChatLogService;