'use strict';const _0x5ea503=_0x2695;(function(_0xbe8dd,_0x1249fa){const _0x1905bf=_0x2695,_0x1419d6=_0xbe8dd();while(!![]){try{const _0x1b30c8=-parseInt(_0x1905bf(0xf9))/0x1*(-parseInt(_0x1905bf(0xb3))/0x2)+parseInt(_0x1905bf(0x8e))/0x3*(-parseInt(_0x1905bf(0xa3))/0x4)+-parseInt(_0x1905bf(0x107))/0x5*(-parseInt(_0x1905bf(0x8f))/0x6)+parseInt(_0x1905bf(0xda))/0x7+-parseInt(_0x1905bf(0xba))/0x8+-parseInt(_0x1905bf(0x94))/0x9*(parseInt(_0x1905bf(0xc0))/0xa)+parseInt(_0x1905bf(0x90))/0xb;if(_0x1b30c8===_0x1249fa)break;else _0x1419d6['push'](_0x1419d6['shift']());}catch(_0x4d065c){_0x1419d6['push'](_0x1419d6['shift']());}}}(_0x5679,0xd55f4));function _0x2695(_0x68b8ee,_0x5bde3a){const _0x5679b3=_0x5679();return _0x2695=function(_0x2695f0,_0x1354d8){_0x2695f0=_0x2695f0-0x7f;let _0x5507c1=_0x5679b3[_0x2695f0];return _0x5507c1;},_0x2695(_0x68b8ee,_0x5bde3a);}var __decorate=this&&this[_0x5ea503(0x87)]||function(_0x2b742e,_0x40c613,_0x171588,_0x38ebad){const _0x39b316=_0x5ea503;var _0x5f43b0=arguments[_0x39b316(0xa7)],_0x274230=_0x5f43b0<0x3?_0x40c613:_0x38ebad===null?_0x38ebad=Object[_0x39b316(0x81)](_0x40c613,_0x171588):_0x38ebad,_0x25c110;if(typeof Reflect===_0x39b316(0x8a)&&typeof Reflect[_0x39b316(0x96)]===_0x39b316(0xdb))_0x274230=Reflect[_0x39b316(0x96)](_0x2b742e,_0x40c613,_0x171588,_0x38ebad);else{for(var _0xc61323=_0x2b742e[_0x39b316(0xa7)]-0x1;_0xc61323>=0x0;_0xc61323--)if(_0x25c110=_0x2b742e[_0xc61323])_0x274230=(_0x5f43b0<0x3?_0x25c110(_0x274230):_0x5f43b0>0x3?_0x25c110(_0x40c613,_0x171588,_0x274230):_0x25c110(_0x40c613,_0x171588))||_0x274230;}return _0x5f43b0>0x3&&_0x274230&&Object[_0x39b316(0xe6)](_0x40c613,_0x171588,_0x274230),_0x274230;},__metadata=this&&this[_0x5ea503(0xac)]||function(_0x2a56ce,_0x17f112){const _0x1151cb=_0x5ea503;if(typeof Reflect===_0x1151cb(0x8a)&&typeof Reflect['metadata']===_0x1151cb(0xdb))return Reflect[_0x1151cb(0xa1)](_0x2a56ce,_0x17f112);},__param=this&&this[_0x5ea503(0xaa)]||function(_0x2233a4,_0x221e7b){return function(_0x41d121,_0x5ace23){_0x221e7b(_0x41d121,_0x5ace23,_0x2233a4);};};Object[_0x5ea503(0xe6)](exports,_0x5ea503(0xa8),{'value':!![]}),exports[_0x5ea503(0xc2)]=void 0x0;const balance_constant_1=require(_0x5ea503(0xec)),utils_1=require(_0x5ea503(0xee)),common_1=require(_0x5ea503(0xae)),typeorm_1=require('@nestjs/typeorm'),exceljs_1=require(_0x5ea503(0x92)),typeorm_2=require(_0x5ea503(0xcf)),chatGroup_entity_1=require(_0x5ea503(0xfd)),user_entity_1=require('../user/user.entity'),chatLog_entity_1=require(_0x5ea503(0xff)),models_service_1=require('../models/models.service');let ChatLogService=class ChatLogService{constructor(_0x222feb,_0x19da8d,_0x58f786,_0x1030f7){const _0x4c52de=_0x5ea503;this['chatLogEntity']=_0x222feb,this[_0x4c52de(0xf2)]=_0x19da8d,this[_0x4c52de(0x7f)]=_0x58f786,this[_0x4c52de(0xb7)]=_0x1030f7;}async[_0x5ea503(0xf1)](_0x3a8359){const _0x3f7e24=_0x5ea503,_0x58acbe=await this[_0x3f7e24(0xc3)]['save'](_0x3a8359);return _0x58acbe;}async[_0x5ea503(0xeb)](_0x4de57f,_0x21820c){const _0x1d60ee=_0x5ea503;return await this['chatLogEntity'][_0x1d60ee(0xde)]({'id':_0x4de57f},_0x21820c);}async[_0x5ea503(0xd8)](_0x5c8a5a){const _0x442eb1=_0x5ea503;return await this[_0x442eb1(0xc3)][_0x442eb1(0xb9)]({'where':{'id':_0x5c8a5a}});}async[_0x5ea503(0xf4)](_0x4eada5,_0x3c3800){const _0x234bc0=_0x5ea503,{id:_0xf9b536}=_0x4eada5['user'],{model:_0x5e5509}=_0x3c3800,_0x375179={'userId':_0xf9b536,'type':balance_constant_1[_0x234bc0(0xa9)][_0x234bc0(0xd0)]};_0x5e5509&&(_0x375179[_0x234bc0(0xef)]=_0x5e5509,_0x5e5509==='DALL-E2'&&(_0x375179['model']=(0x0,typeorm_2['In'])([_0x234bc0(0xe0),_0x234bc0(0xe1)])));const _0x416c3c=await this['chatLogEntity'][_0x234bc0(0x8c)]({'where':_0x375179,'order':{'id':_0x234bc0(0xd9)},'select':['id',_0x234bc0(0xf3),_0x234bc0(0xc6),_0x234bc0(0xef),'type','fileInfo']});return _0x416c3c[_0x234bc0(0xd1)](_0x2fc81a=>{const _0x24eb9b=_0x234bc0;if(_0x2fc81a[_0x24eb9b(0x10a)]===_0x24eb9b(0xe2)){const _0x4a4f18=_0x2fc81a[_0x24eb9b(0xef)]==='mj'?0x136:0xa0,_0x1103ad=_0x2fc81a[_0x24eb9b(0xf3)][_0x24eb9b(0xaf)]('cos')?_0x24eb9b(0x9c):_0x24eb9b(0xe5),_0x14e401=_0x1103ad===_0x24eb9b(0x9c)?_0x24eb9b(0x80)+_0x4a4f18+_0x24eb9b(0xd7):_0x24eb9b(0x95)+_0x4a4f18;_0x2fc81a[_0x24eb9b(0xf0)]=_0x2fc81a[_0x24eb9b(0xf3)]+_0x14e401;try{_0x2fc81a['fileInfo']=_0x2fc81a[_0x24eb9b(0x108)]?JSON[_0x24eb9b(0x102)](_0x2fc81a[_0x24eb9b(0x108)]):null;}catch(_0x10138b){_0x2fc81a[_0x24eb9b(0x108)]={};}}}),_0x416c3c;}async[_0x5ea503(0xc4)](_0x30e030){const _0xd94101=_0x5ea503,{page:page=0x1,size:size=0x14,rec:_0x5da35d,userId:_0x1bd405,model:_0x423cbe}=_0x30e030,_0x388228={'type':0x2,'prompt':(0x0,typeorm_2['Not'])(''),'answer':(0x0,typeorm_2['Not'])(''),'fileInfo':(0x0,typeorm_2[_0xd94101(0xb1)])('')};_0x5da35d&&Object['assign'](_0x388228,{'rec':_0x5da35d}),_0x1bd405&&Object[_0xd94101(0xbe)](_0x388228,{'userId':_0x1bd405});_0x423cbe?_0x388228['model']=_0x423cbe:_0x388228[_0xd94101(0xef)]=(0x0,typeorm_2['In'])([_0xd94101(0x91),_0xd94101(0xe1),_0xd94101(0xed)]);const [_0x41d5e5,_0x3eac8e]=await this[_0xd94101(0xc3)][_0xd94101(0x9b)]({'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size,'where':_0x388228}),_0x54251a=_0x41d5e5[_0xd94101(0x10e)](_0x4865c9=>_0x4865c9[_0xd94101(0xf8)])[_0xd94101(0x104)](_0x566fa3=>_0x566fa3<0x186a0),_0x2ec901=await this[_0xd94101(0xf2)][_0xd94101(0x8c)]({'where':{'id':(0x0,typeorm_2['In'])(_0x54251a)},'select':['id',_0xd94101(0x88),'avatar',_0xd94101(0x85)]});return _0x41d5e5['forEach'](_0x5825d6=>{const _0x2e34da=_0xd94101;_0x5825d6[_0x2e34da(0xa0)]=_0x2ec901[_0x2e34da(0x8c)](_0x2b289f=>_0x2b289f['id']===_0x5825d6[_0x2e34da(0xf8)]);}),_0x41d5e5[_0xd94101(0xd1)](_0x35db7e=>{const _0x4ce86e=_0xd94101;var _0x32fb32;const _0x1c1b7c=_0x35db7e[_0x4ce86e(0xef)]===_0x4ce86e(0x91)?0x136:0xa0,_0x558afc=_0x35db7e[_0x4ce86e(0xf3)]['includes'](_0x4ce86e(0xb4))?'tencent':_0x4ce86e(0xe5),_0x392495=_0x558afc===_0x4ce86e(0x9c)?_0x4ce86e(0x80)+_0x1c1b7c+_0x4ce86e(0xd7):_0x4ce86e(0x95)+_0x1c1b7c;_0x35db7e[_0x4ce86e(0xf0)]=_0x35db7e[_0x4ce86e(0xf3)]+_0x392495;try{const _0x559472=_0x35db7e[_0x4ce86e(0x82)]?JSON[_0x4ce86e(0x102)](_0x35db7e['extend']):null;_0x559472&&(_0x559472?_0x35db7e[_0x4ce86e(0xd2)]=((_0x32fb32=_0x559472===null||_0x559472===void 0x0?void 0x0:_0x559472[_0x4ce86e(0xdc)][0x0])===null||_0x32fb32===void 0x0?void 0x0:_0x32fb32['components'][_0x4ce86e(0xa7)])===0x5:_0x35db7e[_0x4ce86e(0xd2)]=![]);}catch(_0x535c67){console[_0x4ce86e(0xbf)](_0x4ce86e(0xb2),_0x535c67);}}),{'rows':_0x41d5e5,'count':_0x3eac8e};}async[_0x5ea503(0x100)](_0x1fba5d){const _0x477440=_0x5ea503,{id:_0x513dae}=_0x1fba5d,_0xd6ee41=await this[_0x477440(0xc3)][_0x477440(0xb9)]({'where':{'id':_0x513dae}});return _0xd6ee41;}async[_0x5ea503(0xb0)](_0x25dd5c){const _0x1db44a=_0x5ea503,{id:_0x1d4ee7}=_0x25dd5c,_0x5ab368=await this[_0x1db44a(0xc3)][_0x1db44a(0xb9)]({'where':{'id':_0x1d4ee7,'type':balance_constant_1[_0x1db44a(0xa9)][_0x1db44a(0xd0)]}});if(!_0x5ab368)throw new common_1[(_0x1db44a(0xc1))](_0x1db44a(0x101),common_1[_0x1db44a(0x9d)][_0x1db44a(0xa6)]);const _0xb7b1df=_0x5ab368[_0x1db44a(0xb5)]===0x1?0x0:0x1,_0x140dd5=await this[_0x1db44a(0xc3)][_0x1db44a(0xde)]({'id':_0x1d4ee7},{'rec':_0xb7b1df});if(_0x140dd5[_0x1db44a(0xa4)]>0x0)return(_0xb7b1df?'推荐':_0x1db44a(0x99))+_0x1db44a(0x89);throw new common_1[(_0x1db44a(0xc1))](_0x1db44a(0xad),common_1[_0x1db44a(0x9d)][_0x1db44a(0xa6)]);}async['exportExcel'](_0x464ffe,_0x384395){const _0x3201e0=_0x5ea503,_0x18973d={'type':balance_constant_1['ChatType'][_0x3201e0(0x9e)]},{page:page=0x1,size:size=0x1e,prompt:_0x351e30,email:_0x22a5b5}=_0x464ffe;_0x351e30&&Object[_0x3201e0(0xbe)](_0x18973d,{'prompt':(0x0,typeorm_2[_0x3201e0(0xd4)])('%'+_0x351e30+'%')});if(_0x22a5b5){const _0x6ee85=await this[_0x3201e0(0xf2)][_0x3201e0(0xb9)]({'where':{'email':_0x22a5b5}});(_0x6ee85===null||_0x6ee85===void 0x0?void 0x0:_0x6ee85['id'])&&Object['assign'](_0x18973d,{'userId':_0x6ee85['id']});}const [_0x27fc28,_0xc210e0]=await this[_0x3201e0(0xc3)]['findAndCount']({'order':{'id':_0x3201e0(0xd9)},'skip':(page-0x1)*size,'take':size,'where':_0x18973d}),_0x20dba5=_0x27fc28[_0x3201e0(0x10e)](_0x22ee71=>_0x22ee71[_0x3201e0(0xf8)]),_0x1986ea=await this[_0x3201e0(0xf2)][_0x3201e0(0x8c)]({'where':{'id':(0x0,typeorm_2['In'])(_0x20dba5)}}),_0x2de5a0=_0x27fc28[_0x3201e0(0x10e)](_0x21321=>{const _0x53740c=_0x3201e0,_0x3bcf70=_0x1986ea[_0x53740c(0x8c)](_0x4d50a6=>_0x4d50a6['id']===_0x21321['userId']);return{'username':_0x3bcf70?_0x3bcf70['username']:'','email':_0x3bcf70?_0x3bcf70[_0x53740c(0x85)]:'','prompt':_0x21321[_0x53740c(0xc6)],'answer':_0x21321[_0x53740c(0xf3)],'createdAt':(0x0,utils_1[_0x53740c(0xc9)])(_0x21321[_0x53740c(0xe9)])};}),_0x2c7f34=new exceljs_1['default'][(_0x3201e0(0xb8))](),_0x351341=_0x2c7f34[_0x3201e0(0xce)](_0x3201e0(0xe4));_0x351341[_0x3201e0(0xa5)]=[{'header':_0x3201e0(0x8d),'key':_0x3201e0(0x88),'width':0x14},{'header':_0x3201e0(0xb6),'key':_0x3201e0(0x85),'width':0x14},{'header':'提问时间','key':'createdAt','width':0x14},{'header':_0x3201e0(0xcb),'key':_0x3201e0(0xc6),'width':0x50},{'header':'回答答案','key':_0x3201e0(0xf3),'width':0x96}],_0x2de5a0[_0x3201e0(0xd1)](_0x29aef5=>_0x351341[_0x3201e0(0x10c)](_0x29aef5)),_0x384395[_0x3201e0(0xe8)](_0x3201e0(0x86),'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'),_0x384395[_0x3201e0(0xe8)]('Content-Disposition',_0x3201e0(0xe3)+_0x3201e0(0xcc)),await _0x2c7f34[_0x3201e0(0xd6)][_0x3201e0(0x97)](_0x384395),_0x384395['end']();}async[_0x5ea503(0x83)](_0x571cd5,_0x53b9d5){const _0x34b36c=_0x5ea503,{page:page=0x1,size:size=0x14,userId:_0x36c3b2,prompt:_0x16180a}=_0x571cd5,_0x44afca={'type':balance_constant_1[_0x34b36c(0xa9)][_0x34b36c(0x9e)],'prompt':(0x0,typeorm_2['Not'])('')};_0x36c3b2&&Object[_0x34b36c(0xbe)](_0x44afca,{'userId':_0x36c3b2}),_0x16180a&&Object[_0x34b36c(0xbe)](_0x44afca,{'prompt':(0x0,typeorm_2[_0x34b36c(0xd4)])('%'+_0x16180a+'%')});const [_0x1f20c6,_0x111bb2]=await this[_0x34b36c(0xc3)][_0x34b36c(0x9b)]({'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size,'where':_0x44afca}),_0x55065d=_0x1f20c6['map'](_0x202f47=>_0x202f47[_0x34b36c(0xf8)]),_0x3dd906=await this[_0x34b36c(0xf2)][_0x34b36c(0x8c)]({'where':{'id':(0x0,typeorm_2['In'])(_0x55065d)},'select':['id',_0x34b36c(0x88),_0x34b36c(0x85)]});return _0x1f20c6['forEach'](_0x48f71a=>{const _0x355db4=_0x34b36c,{username:_0x24c54f,email:_0x3f57fa}=_0x3dd906[_0x355db4(0x8c)](_0x3c2356=>_0x3c2356['id']===_0x48f71a[_0x355db4(0xf8)])||{};_0x48f71a['username']=_0x24c54f,_0x48f71a[_0x355db4(0x85)]=_0x3f57fa;}),_0x53b9d5[_0x34b36c(0xfb)][_0x34b36c(0xdf)]!==_0x34b36c(0x93)&&_0x1f20c6[_0x34b36c(0xd1)](_0x18d332=>_0x18d332[_0x34b36c(0x85)]=(0x0,utils_1[_0x34b36c(0xd3)])(_0x18d332[_0x34b36c(0x85)])),_0x1f20c6[_0x34b36c(0xd1)](_0x3f69cc=>{const _0x827736=_0x34b36c;!_0x3f69cc['email']&&(_0x3f69cc['email']=(_0x3f69cc===null||_0x3f69cc===void 0x0?void 0x0:_0x3f69cc['userId'])+_0x827736(0x105)),!_0x3f69cc[_0x827736(0x88)]&&(_0x3f69cc[_0x827736(0x88)]='游客'+(_0x3f69cc===null||_0x3f69cc===void 0x0?void 0x0:_0x3f69cc[_0x827736(0xf8)]));}),{'rows':_0x1f20c6,'count':_0x111bb2};}async['chatList'](_0x25b27b,_0x198062){const _0x5b717e=_0x5ea503,{id:_0x1a2e40}=_0x25b27b[_0x5b717e(0xfb)],{groupId:_0x24fb84}=_0x198062,_0x2335c4={'userId':_0x1a2e40,'isDelete':![]};_0x24fb84&&Object['assign'](_0x2335c4,{'groupId':_0x24fb84});if(_0x24fb84){const _0x4d1adb=await this[_0x5b717e(0x7f)][_0x5b717e(0x10b)]({'where':{'isDelete':![]}});if(_0x4d1adb===0x0)return[];}const _0x276fa9=await this['chatLogEntity'][_0x5b717e(0x8c)]({'where':_0x2335c4});return _0x276fa9['map'](_0x2db657=>{const _0x167414=_0x5b717e,{prompt:_0x2c0d6f,role:_0x3fcf90,answer:_0x5debf9,createdAt:_0x7f1454,model:_0xe39ae1,modelName:_0x382b1d,type:_0x106da0,status:_0x2b8920,action:_0x2b4332,drawId:_0x4752e5,id:_0x16db2d,fileInfo:_0x53eca5,ttsUrl:_0x208bb9,videoUrl:_0xf23a26,audioUrl:_0x223c92,customId:_0x29e59b,pluginParam:_0x55a2a4,modelAvatar:_0x1f9cf3,taskData:_0x4d6522,promptReference:_0x3797a0}=_0x2db657;return{'chatId':_0x16db2d,'dateTime':(0x0,utils_1[_0x167414(0xc9)])(_0x7f1454),'text':_0x3fcf90===_0x167414(0xfb)?_0x2c0d6f:_0x5debf9,'modelType':_0x106da0,'status':_0x2b8920,'action':_0x2b4332,'drawId':_0x4752e5,'customId':_0x29e59b,'inversion':_0x3fcf90==='user','error':![],'fileInfo':_0x53eca5,'ttsUrl':_0x208bb9,'videoUrl':_0xf23a26,'audioUrl':_0x223c92,'model':_0xe39ae1,'modelName':_0x382b1d,'pluginParam':_0x55a2a4,'modelAvatar':_0x1f9cf3,'taskData':_0x4d6522,'promptReference':_0x3797a0};});}async[_0x5ea503(0xc7)](_0x263040,_0x45c0d0){const _0xde7152=_0x5ea503;if(_0x45c0d0===0x0)return[];const _0x460a8b={'isDelete':![],'groupId':_0x263040},_0xa9b60e=await this[_0xde7152(0xc3)][_0xde7152(0x8c)]({'where':_0x460a8b,'order':{'createdAt':_0xde7152(0xd9)},'take':_0x45c0d0*0x2}),_0xc757ce=_0xa9b60e[_0xde7152(0x10e)](_0xb680f7=>{const {role:_0x4284a0,prompt:_0x4ac845,answer:_0x49b562,fileInfo:_0x22799c}=_0xb680f7,_0x3947a3={'role':_0x4284a0,'text':_0x4284a0==='user'?_0x4ac845:_0x49b562,'fileInfo':_0x22799c};return _0x3947a3;})[_0xde7152(0x8b)]();return _0xc757ce;}async['deleteChatLog'](_0x24c108,_0xe96c57){const _0x31ff41=_0x5ea503,{id:_0x4bcbba}=_0x24c108[_0x31ff41(0xfb)],{id:_0x368890}=_0xe96c57,_0xfd3d13=await this['chatLogEntity'][_0x31ff41(0xb9)]({'where':{'id':_0x368890,'userId':_0x4bcbba}});if(!_0xfd3d13)throw new common_1[(_0x31ff41(0xc1))]('你删除的对话记录不存在、请检查！',common_1[_0x31ff41(0x9d)][_0x31ff41(0xa6)]);const _0x438d54=await this['chatLogEntity'][_0x31ff41(0xde)]({'id':_0x368890},{'isDelete':!![]});if(_0x438d54['affected']>0x0)return _0x31ff41(0xf6);else throw new common_1[(_0x31ff41(0xc1))](_0x31ff41(0x10d),common_1['HttpStatus'][_0x31ff41(0xa6)]);}async[_0x5ea503(0xfe)](_0x589db1,_0x4f9119){const _0x1a02f7=_0x5ea503,{groupId:_0x25e572}=_0x4f9119,{id:_0x1d0207}=_0x589db1[_0x1a02f7(0xfb)],_0x2541d5=await this['chatGroupEntity'][_0x1a02f7(0xb9)]({'where':{'id':_0x25e572,'userId':_0x1d0207}});if(!_0x2541d5)throw new common_1[(_0x1a02f7(0xc1))]('你删除的对话记录不存在、请检查！',common_1['HttpStatus'][_0x1a02f7(0xa6)]);const _0x52318f=await this[_0x1a02f7(0xc3)][_0x1a02f7(0xde)]({'groupId':_0x25e572},{'isDelete':!![]});if(_0x52318f[_0x1a02f7(0xa4)]>0x0)return'删除对话记录成功！';if(_0x52318f[_0x1a02f7(0xa4)]===0x0)throw new common_1[(_0x1a02f7(0xc1))](_0x1a02f7(0xcd),common_1[_0x1a02f7(0x9d)][_0x1a02f7(0xa6)]);}async[_0x5ea503(0xfc)](_0x5d052a,_0x3f2d49){const _0x113edb=_0x5ea503,{id:_0x4d973e}=_0x3f2d49,{id:_0x4b6172}=_0x5d052a[_0x113edb(0xfb)],_0x3d292b=await this[_0x113edb(0xc3)][_0x113edb(0xb9)]({'where':{'id':_0x4d973e,'userId':_0x4b6172}});if(!_0x3d292b)throw new common_1[(_0x113edb(0xc1))]('你删除的对话记录不存在、请检查！',common_1['HttpStatus'][_0x113edb(0xa6)]);const {groupId:_0x1a2afa}=_0x3d292b,_0xa8f0a1=await this[_0x113edb(0xc3)][_0x113edb(0xde)]({'groupId':_0x1a2afa,'id':(0x0,typeorm_2['MoreThanOrEqual'])(_0x4d973e)},{'isDelete':!![]});if(_0xa8f0a1['affected']>0x0)return _0x113edb(0xf6);else throw new common_1['HttpException'](_0x113edb(0xcd),common_1[_0x113edb(0x9d)][_0x113edb(0xa6)]);}async[_0x5ea503(0xd5)](_0x394e6c,_0x3e64f1){const _0x36d681=_0x5ea503,{id:_0x3d9ee}=_0x394e6c[_0x36d681(0xfb)],{appId:_0x2ece26,page:page=0x1,size:size=0xa}=_0x3e64f1,[_0xb2237f,_0x257799]=await this['chatLogEntity'][_0x36d681(0x9b)]({'where':{'userId':_0x3d9ee,'appId':_0x2ece26,'role':_0x36d681(0xfa)},'order':{'id':_0x36d681(0xd9)},'take':size,'skip':(page-0x1)*size});return{'rows':_0xb2237f,'count':_0x257799};}async['checkModelLimits'](_0x3a9ef1,_0xc9937c){const _0x47dbda=_0x5ea503,_0x551227=0xe10*0x3e8,_0x2d8ef2=new Date(Date['now']()-_0x551227);try{const _0x2e6d20=await this[_0x47dbda(0xc3)][_0x47dbda(0x10b)]({'where':{'userId':_0x3a9ef1['id'],'model':_0xc9937c,'createdAt':(0x0,typeorm_2[_0x47dbda(0x106)])(_0x2d8ef2)}}),_0x122737=Math['ceil'](_0x2e6d20/0x2);common_1[_0x47dbda(0xf7)][_0x47dbda(0xbf)](_0x47dbda(0xbb)+_0x3a9ef1['id']+_0x47dbda(0xca)+_0xc9937c+_0x47dbda(0xa2)+(_0x122737+0x1)+'\x20次','ChatLogService');let _0x11ce51;_0xc9937c[_0x47dbda(0xc8)](_0x47dbda(0x9f))?_0x11ce51=await this[_0x47dbda(0xb7)]['getCurrentModelKeyInfo'](_0x47dbda(0x84)):_0x11ce51=await this['modelsService']['getCurrentModelKeyInfo'](_0xc9937c);const _0x448d46=Number(_0x11ce51[_0x47dbda(0xf5)]);common_1['Logger']['log'](_0x47dbda(0xea)+_0xc9937c+'\x20的使用次数限制为\x20'+_0x448d46,_0x47dbda(0xc2));if(_0x122737>_0x448d46)return!![];return![];}catch(_0x2cee44){common_1[_0x47dbda(0xf7)][_0x47dbda(0x9a)](_0x47dbda(0xbd)+_0x3a9ef1['id']+',\x20模型:\x20'+_0xc9937c+_0x47dbda(0x103)+_0x2cee44['message'],_0x2cee44['stack'],_0x47dbda(0xc2));}}};ChatLogService=__decorate([(0x0,common_1[_0x5ea503(0xab)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(chatLog_entity_1[_0x5ea503(0xdd)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(user_entity_1['UserEntity'])),__param(0x2,(0x0,typeorm_1[_0x5ea503(0xc5)])(chatGroup_entity_1[_0x5ea503(0xbc)])),__metadata(_0x5ea503(0x98),[typeorm_2[_0x5ea503(0x109)],typeorm_2[_0x5ea503(0x109)],typeorm_2['Repository'],models_service_1[_0x5ea503(0xe7)]])],ChatLogService),exports[_0x5ea503(0xc2)]=ChatLogService;function _0x5679(){const _0x778769=['querAllChatLog','gpts','email','Content-Type','__decorate','username','图片成功！','object','reverse','find','用户名','14661YixkGL','6rwkRDD','22944460pwPnpM','midjourney','exceljs','super','2988kFYGjk','?x-oss-process=image/resize,w_','decorate','write','design:paramtypes','取消推荐','error','findAndCount','tencent','HttpStatus','NORMAL_CHAT','gpt-4-gizmo','userInfo','metadata','\x20模型\x20','1236bZemoD','affected','columns','BAD_REQUEST','length','__esModule','ChatType','__param','Injectable','__metadata','你操作的图片不存在、请检查！','@nestjs/common','includes','recDrawImg','Not','querAllDrawLog\x20Json\x20parse\x20error','1124702znHYJX','cos','rec','用户邮箱','modelsService','Workbook','findOne','4899984IFTibW','用户ID:\x20','ChatGroupEntity','查询数据库出错\x20-\x20用户ID:\x20','assign','log','26140JkbVFV','HttpException','ChatLogService','chatLogEntity','querAllDrawLog','InjectRepository','prompt','chatHistory','startsWith','formatDate','\x20一小时内调用\x20','提问问题','chat.xlsx','当前页面已经没有东西可以删除了！','addWorksheet','typeorm','PAINT','forEach','isGroup','maskEmail','Like','byAppId','xlsx','/q/55','findOneChatLog','DESC','8018563TGPRXQ','function','components','ChatLogEntity','update','role','DALL-E2','dall-e-3','paintCount','attachment;\x20filename=','chatlog','ali','defineProperty','ModelsService','setHeader','createdAt','模型\x20','updateChatLog','../../common/constants/balance.constant','stable-diffusion','../../common/utils','model','thumbImg','saveChatLog','userEntity','answer','querDrawLog','modelLimits','删除对话记录成功！','Logger','userId','1wRgfqE','assistant','user','deleteChatsAfterId','../chatGroup/chatGroup.entity','delByGroupId','./chatLog.entity','findOneDrawLog','你推荐的图片不存在、请检查！','parse',',\x20错误信息:\x20','filter','@aiweb.com','MoreThan','353405vWxNfX','fileInfo','Repository','type','count','addRow','你删除的对话记录不存在、请检查！','map','chatGroupEntity','?imageView2/1/w/','getOwnPropertyDescriptor','extend'];_0x5679=function(){return _0x778769;};return _0x5679();}