'use strict';const _0x5092e7=_0x1005;(function(_0x4b3670,_0x4f1c94){const _0x56cdf6=_0x1005,_0x35b977=_0x4b3670();while(!![]){try{const _0x35b2aa=-parseInt(_0x56cdf6(0x116))/0x1*(parseInt(_0x56cdf6(0x108))/0x2)+parseInt(_0x56cdf6(0x144))/0x3+-parseInt(_0x56cdf6(0xff))/0x4+parseInt(_0x56cdf6(0x110))/0x5+parseInt(_0x56cdf6(0xc7))/0x6*(-parseInt(_0x56cdf6(0x133))/0x7)+parseInt(_0x56cdf6(0x104))/0x8*(-parseInt(_0x56cdf6(0x12c))/0x9)+-parseInt(_0x56cdf6(0xef))/0xa*(-parseInt(_0x56cdf6(0xe8))/0xb);if(_0x35b2aa===_0x4f1c94)break;else _0x35b977['push'](_0x35b977['shift']());}catch(_0x54b7ef){_0x35b977['push'](_0x35b977['shift']());}}}(_0x1697,0x5c445));function _0x1005(_0x4dee85,_0x5c4899){const _0x16970f=_0x1697();return _0x1005=function(_0x10058a,_0x30f8f4){_0x10058a=_0x10058a-0xb9;let _0x68a635=_0x16970f[_0x10058a];return _0x68a635;},_0x1005(_0x4dee85,_0x5c4899);}var __decorate=this&&this[_0x5092e7(0xfb)]||function(_0x40c64d,_0x2ddbcd,_0x25ac07,_0x1c8df7){const _0x54b1eb=_0x5092e7;var _0x353b2e=arguments['length'],_0x4b7ca5=_0x353b2e<0x3?_0x2ddbcd:_0x1c8df7===null?_0x1c8df7=Object[_0x54b1eb(0xd8)](_0x2ddbcd,_0x25ac07):_0x1c8df7,_0x1dd520;if(typeof Reflect===_0x54b1eb(0xd6)&&typeof Reflect[_0x54b1eb(0x142)]===_0x54b1eb(0xfc))_0x4b7ca5=Reflect[_0x54b1eb(0x142)](_0x40c64d,_0x2ddbcd,_0x25ac07,_0x1c8df7);else{for(var _0x210a36=_0x40c64d['length']-0x1;_0x210a36>=0x0;_0x210a36--)if(_0x1dd520=_0x40c64d[_0x210a36])_0x4b7ca5=(_0x353b2e<0x3?_0x1dd520(_0x4b7ca5):_0x353b2e>0x3?_0x1dd520(_0x2ddbcd,_0x25ac07,_0x4b7ca5):_0x1dd520(_0x2ddbcd,_0x25ac07))||_0x4b7ca5;}return _0x353b2e>0x3&&_0x4b7ca5&&Object[_0x54b1eb(0xbe)](_0x2ddbcd,_0x25ac07,_0x4b7ca5),_0x4b7ca5;},__metadata=this&&this[_0x5092e7(0xed)]||function(_0x18ea94,_0x53c865){const _0x436c94=_0x5092e7;if(typeof Reflect===_0x436c94(0xd6)&&typeof Reflect[_0x436c94(0xc9)]===_0x436c94(0xfc))return Reflect[_0x436c94(0xc9)](_0x18ea94,_0x53c865);},__param=this&&this[_0x5092e7(0x138)]||function(_0x100ae4,_0x2b63b2){return function(_0x3633e4,_0xae5c43){_0x2b63b2(_0x3633e4,_0xae5c43,_0x100ae4);};};Object[_0x5092e7(0xbe)](exports,_0x5092e7(0xf5),{'value':!![]}),exports[_0x5092e7(0x103)]=void 0x0;const balance_constant_1=require(_0x5092e7(0x137)),utils_1=require('../../common/utils'),common_1=require('@nestjs/common'),typeorm_1=require(_0x5092e7(0xf3)),exceljs_1=require(_0x5092e7(0x122)),typeorm_2=require(_0x5092e7(0x109)),chatGroup_entity_1=require('../chatGroup/chatGroup.entity'),user_entity_1=require(_0x5092e7(0xe3)),chatLog_entity_1=require('./chatLog.entity'),models_service_1=require('../models/models.service');let ChatLogService=class ChatLogService{constructor(_0x20f316,_0x47d9a1,_0xc7bd04,_0x45c9b7){const _0x3c5c22=_0x5092e7;this[_0x3c5c22(0xd2)]=_0x20f316,this[_0x3c5c22(0xf9)]=_0x47d9a1,this[_0x3c5c22(0xe4)]=_0xc7bd04,this[_0x3c5c22(0xd0)]=_0x45c9b7;}async[_0x5092e7(0x11c)](_0x170590){const _0x59bdd8=_0x5092e7,_0x2fbdc6=await this['chatLogEntity'][_0x59bdd8(0xbb)](_0x170590);return _0x2fbdc6;}async[_0x5092e7(0x10a)](_0x36d316,_0x2f9e46){const _0x3a5c32=_0x5092e7;return await this[_0x3a5c32(0xd2)]['update']({'id':_0x36d316},_0x2f9e46);}async[_0x5092e7(0xe1)](_0x588296){const _0x218b83=_0x5092e7;return await this[_0x218b83(0xd2)][_0x218b83(0x105)]({'where':{'id':_0x588296}});}async['querDrawLog'](_0x3413e3,_0x18d649){const _0x431017=_0x5092e7,{id:_0x482a8e}=_0x3413e3[_0x431017(0xf0)],{model:_0x1a6f23}=_0x18d649,_0x540d2e={'userId':_0x482a8e,'type':balance_constant_1[_0x431017(0xf2)][_0x431017(0xec)]};_0x1a6f23&&(_0x540d2e[_0x431017(0x106)]=_0x1a6f23,_0x1a6f23===_0x431017(0x12f)&&(_0x540d2e[_0x431017(0x106)]=(0x0,typeorm_2['In'])([_0x431017(0x12f),'dall-e-3'])));const _0x2908ca=await this['chatLogEntity'][_0x431017(0x120)]({'where':_0x540d2e,'order':{'id':_0x431017(0x13f)},'select':['id',_0x431017(0xc8),_0x431017(0x115),'model',_0x431017(0x136),'fileInfo']});return _0x2908ca[_0x431017(0xea)](_0x3a402e=>{const _0x5b6a07=_0x431017;if(_0x3a402e[_0x5b6a07(0x136)]===_0x5b6a07(0xca)){const _0x3c374b=_0x3a402e['model']==='mj'?0x136:0xa0,_0x51dd92=_0x3a402e['answer'][_0x5b6a07(0xd5)](_0x5b6a07(0x11f))?'tencent':_0x5b6a07(0x12d),_0x2ef2b8=_0x51dd92===_0x5b6a07(0xbf)?_0x5b6a07(0xf1)+_0x3c374b+_0x5b6a07(0x114):'?x-oss-process=image/resize,w_'+_0x3c374b;_0x3a402e['thumbImg']=_0x3a402e['answer']+_0x2ef2b8;try{_0x3a402e['fileInfo']=_0x3a402e[_0x5b6a07(0x128)]?JSON[_0x5b6a07(0xe2)](_0x3a402e[_0x5b6a07(0x128)]):null;}catch(_0x3c6a8b){_0x3a402e[_0x5b6a07(0x128)]={};}}}),_0x2908ca;}async['querAllDrawLog'](_0x541768){const _0x5e165b=_0x5092e7,{page:page=0x1,size:size=0x14,rec:_0x53f8c8,userId:_0x2ffa8b,model:_0x4bf285}=_0x541768,_0x319fab={'type':0x2,'prompt':(0x0,typeorm_2[_0x5e165b(0x145)])(''),'answer':(0x0,typeorm_2['Not'])(''),'fileInfo':(0x0,typeorm_2[_0x5e165b(0x145)])('')};_0x53f8c8&&Object['assign'](_0x319fab,{'rec':_0x53f8c8}),_0x2ffa8b&&Object[_0x5e165b(0x134)](_0x319fab,{'userId':_0x2ffa8b});_0x4bf285?_0x319fab['model']=_0x4bf285:_0x319fab[_0x5e165b(0x106)]=(0x0,typeorm_2['In'])([_0x5e165b(0x112),_0x5e165b(0x118),_0x5e165b(0xe5)]);const [_0x123e6b,_0x1edb13]=await this[_0x5e165b(0xd2)][_0x5e165b(0xcb)]({'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size,'where':_0x319fab}),_0x53d4a9=_0x123e6b[_0x5e165b(0xf6)](_0x20bb83=>_0x20bb83['userId'])['filter'](_0x182894=>_0x182894<0x186a0),_0x453514=await this['userEntity'][_0x5e165b(0x120)]({'where':{'id':(0x0,typeorm_2['In'])(_0x53d4a9)},'select':['id',_0x5e165b(0x127),_0x5e165b(0x141),'email']});return _0x123e6b['forEach'](_0x32968a=>{const _0x2be18a=_0x5e165b;_0x32968a[_0x2be18a(0x12a)]=_0x453514[_0x2be18a(0x120)](_0xe21812=>_0xe21812['id']===_0x32968a[_0x2be18a(0x129)]);}),_0x123e6b[_0x5e165b(0xea)](_0x49c89a=>{const _0x3cff91=_0x5e165b;var _0x3ec7f3;const _0x6dcf82=_0x49c89a[_0x3cff91(0x106)]===_0x3cff91(0x112)?0x136:0xa0,_0x5a864f=_0x49c89a['answer']['includes']('cos')?_0x3cff91(0xbf):_0x3cff91(0x12d),_0x40c6ba=_0x5a864f==='tencent'?'?imageView2/1/w/'+_0x6dcf82+'/q/55':_0x3cff91(0xd4)+_0x6dcf82;_0x49c89a[_0x3cff91(0x13c)]=_0x49c89a[_0x3cff91(0xc8)]+_0x40c6ba;try{const _0x4a4d75=_0x49c89a[_0x3cff91(0x11a)]?JSON['parse'](_0x49c89a['extend']):null;_0x4a4d75&&(_0x4a4d75?_0x49c89a[_0x3cff91(0xd3)]=((_0x3ec7f3=_0x4a4d75===null||_0x4a4d75===void 0x0?void 0x0:_0x4a4d75[_0x3cff91(0x11e)][0x0])===null||_0x3ec7f3===void 0x0?void 0x0:_0x3ec7f3[_0x3cff91(0x11e)]['length'])===0x5:_0x49c89a[_0x3cff91(0xd3)]=![]);}catch(_0x5eb2df){console[_0x3cff91(0xce)](_0x3cff91(0x11b),_0x5eb2df);}}),{'rows':_0x123e6b,'count':_0x1edb13};}async[_0x5092e7(0xc1)](_0x512644){const _0x5a9473=_0x5092e7,{id:_0x1f064f}=_0x512644,_0x3b811e=await this[_0x5a9473(0xd2)][_0x5a9473(0x105)]({'where':{'id':_0x1f064f}});return _0x3b811e;}async[_0x5092e7(0x10e)](_0x138af7){const _0x98b454=_0x5092e7,{id:_0x5ee432}=_0x138af7,_0xc30cd3=await this[_0x98b454(0xd2)]['findOne']({'where':{'id':_0x5ee432,'type':balance_constant_1[_0x98b454(0xf2)][_0x98b454(0xec)]}});if(!_0xc30cd3)throw new common_1[(_0x98b454(0xc4))](_0x98b454(0x11d),common_1[_0x98b454(0x12b)]['BAD_REQUEST']);const _0xe4340e=_0xc30cd3[_0x98b454(0xc5)]===0x1?0x0:0x1,_0x233e3c=await this['chatLogEntity'][_0x98b454(0xbd)]({'id':_0x5ee432},{'rec':_0xe4340e});if(_0x233e3c[_0x98b454(0xcd)]>0x0)return(_0xe4340e?'推荐':_0x98b454(0xbc))+_0x98b454(0xeb);throw new common_1[(_0x98b454(0xc4))]('你操作的图片不存在、请检查！',common_1[_0x98b454(0x12b)][_0x98b454(0xb9)]);}async[_0x5092e7(0x111)](_0x321dac,_0x3e8ecd){const _0x4fcd67=_0x5092e7,_0xbd89e0={'type':balance_constant_1[_0x4fcd67(0xf2)]['NORMAL_CHAT']},{page:page=0x1,size:size=0x1e,prompt:_0x197231,email:_0xb89dac}=_0x321dac;_0x197231&&Object['assign'](_0xbd89e0,{'prompt':(0x0,typeorm_2['Like'])('%'+_0x197231+'%')});if(_0xb89dac){const _0x55545c=await this[_0x4fcd67(0xf9)]['findOne']({'where':{'email':_0xb89dac}});(_0x55545c===null||_0x55545c===void 0x0?void 0x0:_0x55545c['id'])&&Object[_0x4fcd67(0x134)](_0xbd89e0,{'userId':_0x55545c['id']});}const [_0x31ea17,_0x518016]=await this['chatLogEntity'][_0x4fcd67(0xcb)]({'order':{'id':_0x4fcd67(0x13f)},'skip':(page-0x1)*size,'take':size,'where':_0xbd89e0}),_0x548ef2=_0x31ea17[_0x4fcd67(0xf6)](_0x4c2dab=>_0x4c2dab[_0x4fcd67(0x129)]),_0x129904=await this[_0x4fcd67(0xf9)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x548ef2)}}),_0xead43b=_0x31ea17[_0x4fcd67(0xf6)](_0x3b5ad0=>{const _0x2d1258=_0x4fcd67,_0x3fed58=_0x129904[_0x2d1258(0x120)](_0x284ddd=>_0x284ddd['id']===_0x3b5ad0[_0x2d1258(0x129)]);return{'username':_0x3fed58?_0x3fed58[_0x2d1258(0x127)]:'','email':_0x3fed58?_0x3fed58['email']:'','prompt':_0x3b5ad0[_0x2d1258(0x115)],'answer':_0x3b5ad0[_0x2d1258(0xc8)],'createdAt':(0x0,utils_1[_0x2d1258(0xdf)])(_0x3b5ad0['createdAt'])};}),_0x31820f=new exceljs_1[(_0x4fcd67(0xdb))][(_0x4fcd67(0xd1))](),_0x36f9f5=_0x31820f[_0x4fcd67(0x12e)](_0x4fcd67(0xdd));_0x36f9f5[_0x4fcd67(0x121)]=[{'header':_0x4fcd67(0xd9),'key':_0x4fcd67(0x127),'width':0x14},{'header':'用户邮箱','key':_0x4fcd67(0xe9),'width':0x14},{'header':'提问时间','key':_0x4fcd67(0xcc),'width':0x14},{'header':_0x4fcd67(0xf8),'key':_0x4fcd67(0x115),'width':0x50},{'header':'回答答案','key':_0x4fcd67(0xc8),'width':0x96}],_0xead43b[_0x4fcd67(0xea)](_0x1f1222=>_0x36f9f5[_0x4fcd67(0x140)](_0x1f1222)),_0x3e8ecd[_0x4fcd67(0x139)](_0x4fcd67(0x10d),_0x4fcd67(0xc6)),_0x3e8ecd['setHeader'](_0x4fcd67(0x10c),'attachment;\x20filename='+_0x4fcd67(0x10f)),await _0x31820f[_0x4fcd67(0x119)]['write'](_0x3e8ecd),_0x3e8ecd[_0x4fcd67(0xfd)]();}async[_0x5092e7(0x107)](_0x50b9c5,_0x23cf8c){const _0x19239b=_0x5092e7,{page:page=0x1,size:size=0x14,userId:_0x534bb6,prompt:_0x36b975}=_0x50b9c5,_0x4179c3={'type':balance_constant_1[_0x19239b(0xf2)][_0x19239b(0xdc)],'prompt':(0x0,typeorm_2[_0x19239b(0x145)])('')};_0x534bb6&&Object['assign'](_0x4179c3,{'userId':_0x534bb6}),_0x36b975&&Object[_0x19239b(0x134)](_0x4179c3,{'prompt':(0x0,typeorm_2[_0x19239b(0xd7)])('%'+_0x36b975+'%')});const [_0x347125,_0x15b719]=await this[_0x19239b(0xd2)][_0x19239b(0xcb)]({'order':{'id':_0x19239b(0x13f)},'skip':(page-0x1)*size,'take':size,'where':_0x4179c3}),_0x464e67=_0x347125['map'](_0x1a15c4=>_0x1a15c4[_0x19239b(0x129)]),_0x50fd11=await this['userEntity']['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x464e67)},'select':['id','username',_0x19239b(0xe9)]});return _0x347125[_0x19239b(0xea)](_0x1da03e=>{const _0x922eaa=_0x19239b,{username:_0x13bd04,email:_0x43abae}=_0x50fd11[_0x922eaa(0x120)](_0x4f38bc=>_0x4f38bc['id']===_0x1da03e['userId'])||{};_0x1da03e[_0x922eaa(0x127)]=_0x13bd04,_0x1da03e[_0x922eaa(0xe9)]=_0x43abae;}),_0x23cf8c[_0x19239b(0xf0)][_0x19239b(0xc0)]!=='super'&&_0x347125[_0x19239b(0xea)](_0x986924=>_0x986924[_0x19239b(0xe9)]=(0x0,utils_1[_0x19239b(0x13e)])(_0x986924[_0x19239b(0xe9)])),_0x347125[_0x19239b(0xea)](_0x3e14f9=>{const _0x32a0ec=_0x19239b;!_0x3e14f9[_0x32a0ec(0xe9)]&&(_0x3e14f9[_0x32a0ec(0xe9)]=(_0x3e14f9===null||_0x3e14f9===void 0x0?void 0x0:_0x3e14f9[_0x32a0ec(0x129)])+'@aiweb.com'),!_0x3e14f9[_0x32a0ec(0x127)]&&(_0x3e14f9['username']='游客'+(_0x3e14f9===null||_0x3e14f9===void 0x0?void 0x0:_0x3e14f9[_0x32a0ec(0x129)]));}),{'rows':_0x347125,'count':_0x15b719};}async['chatList'](_0x197ac1,_0x4f4c3d){const _0x172ba3=_0x5092e7,{id:_0x3eaab6}=_0x197ac1[_0x172ba3(0xf0)],{groupId:_0x4a1c92}=_0x4f4c3d,_0x218951={'userId':_0x3eaab6,'isDelete':![]};_0x4a1c92&&Object[_0x172ba3(0x134)](_0x218951,{'groupId':_0x4a1c92});if(_0x4a1c92){const _0x152942=await this[_0x172ba3(0xe4)][_0x172ba3(0x130)]({'where':{'isDelete':![]}});if(_0x152942===0x0)return[];}const _0x1bfd57=await this[_0x172ba3(0xd2)][_0x172ba3(0x120)]({'where':_0x218951});return _0x1bfd57['map'](_0x4c49f5=>{const _0x4aa0cf=_0x172ba3,{prompt:_0x32ae9b,role:_0x59524e,answer:_0x1130db,createdAt:_0x340800,model:_0x19e38b,modelName:_0x22bbb8,type:_0x1efb3c,status:_0x27010a,action:_0x2e4729,drawId:_0x235baf,id:_0x5ecccb,fileInfo:_0x46e2d6,ttsUrl:_0x30f194,videoUrl:_0xbd0af7,audioUrl:_0x63a4d7,customId:_0x5dafde,pluginParam:_0x1cb76b,modelAvatar:_0x28a870,taskData:_0x3834a1,promptReference:_0x4e14be}=_0x4c49f5;return{'chatId':_0x5ecccb,'dateTime':(0x0,utils_1['formatDate'])(_0x340800),'text':_0x59524e===_0x4aa0cf(0xf0)?_0x32ae9b:_0x1130db,'modelType':_0x1efb3c,'status':_0x27010a,'action':_0x2e4729,'drawId':_0x235baf,'customId':_0x5dafde,'inversion':_0x59524e===_0x4aa0cf(0xf0),'error':![],'fileInfo':_0x46e2d6,'ttsUrl':_0x30f194,'videoUrl':_0xbd0af7,'audioUrl':_0x63a4d7,'model':_0x19e38b,'modelName':_0x22bbb8,'pluginParam':_0x1cb76b,'modelAvatar':_0x28a870,'taskData':_0x3834a1,'promptReference':_0x4e14be};});}async[_0x5092e7(0xf7)](_0x8e7a32,_0x3a884f){const _0x464b66=_0x5092e7;if(_0x3a884f===0x0)return[];const _0x44db8d={'isDelete':![],'groupId':_0x8e7a32},_0x527457=await this['chatLogEntity'][_0x464b66(0x120)]({'where':_0x44db8d,'order':{'createdAt':_0x464b66(0x13f)},'take':_0x3a884f*0x2}),_0x12afa2=_0x527457[_0x464b66(0xf6)](_0x4bda71=>{const _0x4e0874=_0x464b66,{role:_0x5c175b,prompt:_0x19c079,answer:_0x311498,fileInfo:_0x500ef3}=_0x4bda71,_0x4d58d0={'role':_0x5c175b,'text':_0x5c175b===_0x4e0874(0xf0)?_0x19c079:_0x311498,'fileInfo':_0x500ef3};return _0x4d58d0;})[_0x464b66(0x13d)]();return _0x12afa2;}async[_0x5092e7(0x131)](_0xf33445,_0x57c5ce){const _0x510475=_0x5092e7,{id:_0xc065e7}=_0xf33445['user'],{id:_0xa330c}=_0x57c5ce,_0x42b14c=await this[_0x510475(0xd2)][_0x510475(0x105)]({'where':{'id':_0xa330c,'userId':_0xc065e7}});if(!_0x42b14c)throw new common_1[(_0x510475(0xc4))](_0x510475(0xba),common_1['HttpStatus'][_0x510475(0xb9)]);const _0x53d153=await this[_0x510475(0xd2)]['update']({'id':_0xa330c},{'isDelete':!![]});if(_0x53d153[_0x510475(0xcd)]>0x0)return _0x510475(0x126);else throw new common_1['HttpException']('你删除的对话记录不存在、请检查！',common_1[_0x510475(0x12b)][_0x510475(0xb9)]);}async[_0x5092e7(0xc2)](_0x443d91,_0x588aad){const _0x23372e=_0x5092e7,{groupId:_0x132c2f}=_0x588aad,{id:_0x435b53}=_0x443d91[_0x23372e(0xf0)],_0xd5810=await this['chatGroupEntity']['findOne']({'where':{'id':_0x132c2f,'userId':_0x435b53}});if(!_0xd5810)throw new common_1[(_0x23372e(0xc4))](_0x23372e(0xba),common_1[_0x23372e(0x12b)][_0x23372e(0xb9)]);const _0x42868a=await this[_0x23372e(0xd2)]['update']({'groupId':_0x132c2f},{'isDelete':!![]});if(_0x42868a[_0x23372e(0xcd)]>0x0)return _0x23372e(0x126);if(_0x42868a[_0x23372e(0xcd)]===0x0)throw new common_1[(_0x23372e(0xc4))](_0x23372e(0x135),common_1[_0x23372e(0x12b)][_0x23372e(0xb9)]);}async[_0x5092e7(0x102)](_0x2dcb25,_0x4a3fad){const _0x33b698=_0x5092e7,{id:_0x1ce7f1}=_0x4a3fad,{id:_0x4d91a0}=_0x2dcb25['user'],_0x554e47=await this[_0x33b698(0xd2)][_0x33b698(0x105)]({'where':{'id':_0x1ce7f1,'userId':_0x4d91a0}});if(!_0x554e47)throw new common_1[(_0x33b698(0xc4))]('你删除的对话记录不存在、请检查！',common_1[_0x33b698(0x12b)]['BAD_REQUEST']);const {groupId:_0x5755a9}=_0x554e47,_0x1d6ca6=await this[_0x33b698(0xd2)][_0x33b698(0xbd)]({'groupId':_0x5755a9,'id':(0x0,typeorm_2['MoreThanOrEqual'])(_0x1ce7f1)},{'isDelete':!![]});if(_0x1d6ca6[_0x33b698(0xcd)]>0x0)return _0x33b698(0x126);else throw new common_1[(_0x33b698(0xc4))](_0x33b698(0x135),common_1[_0x33b698(0x12b)]['BAD_REQUEST']);}async[_0x5092e7(0x10b)](_0x45118f,_0x25fceb){const _0x485a1f=_0x5092e7,{id:_0x2336d6}=_0x45118f[_0x485a1f(0xf0)],{appId:_0xbd1924,page:page=0x1,size:size=0xa}=_0x25fceb,[_0x4ea806,_0x40ed33]=await this[_0x485a1f(0xd2)][_0x485a1f(0xcb)]({'where':{'userId':_0x2336d6,'appId':_0xbd1924,'role':_0x485a1f(0x124)},'order':{'id':'DESC'},'take':size,'skip':(page-0x1)*size});return{'rows':_0x4ea806,'count':_0x40ed33};}async[_0x5092e7(0x100)](_0x46ad26,_0x31f76b){const _0x29a4c2=_0x5092e7,_0xbc8f5a=0xe10*0x3e8,_0x369b26=new Date(Date[_0x29a4c2(0xee)]()-_0xbc8f5a);try{const _0x1dceaa=await this[_0x29a4c2(0xd2)][_0x29a4c2(0x130)]({'where':{'userId':_0x46ad26['id'],'model':_0x31f76b,'createdAt':(0x0,typeorm_2[_0x29a4c2(0xe0)])(_0x369b26)}}),_0x37ecd6=Math['ceil'](_0x1dceaa/0x2);common_1[_0x29a4c2(0xf4)][_0x29a4c2(0xce)](_0x29a4c2(0xfe)+_0x46ad26['id']+'\x20一小时内调用\x20'+_0x31f76b+_0x29a4c2(0x13b)+(_0x37ecd6+0x1)+'\x20次',_0x29a4c2(0x103));let _0x224044;_0x31f76b[_0x29a4c2(0xfa)](_0x29a4c2(0xcf))?_0x224044=await this[_0x29a4c2(0xd0)][_0x29a4c2(0x117)](_0x29a4c2(0x13a)):_0x224044=await this['modelsService'][_0x29a4c2(0x117)](_0x31f76b);const _0x3c84dd=Number(_0x224044[_0x29a4c2(0x146)]);common_1[_0x29a4c2(0xf4)]['log']('模型\x20'+_0x31f76b+_0x29a4c2(0x101)+_0x3c84dd,_0x29a4c2(0x103));if(_0x37ecd6>_0x3c84dd)return!![];return![];}catch(_0x4d1932){common_1[_0x29a4c2(0xf4)][_0x29a4c2(0x125)]('查询数据库出错\x20-\x20用户ID:\x20'+_0x46ad26['id']+',\x20模型:\x20'+_0x31f76b+_0x29a4c2(0xe6)+_0x4d1932[_0x29a4c2(0x113)],_0x4d1932[_0x29a4c2(0xda)],_0x29a4c2(0x103));}}};function _0x1697(){const _0x3c9bab=['ModelsService','assistant','error','删除对话记录成功！','username','fileInfo','userId','userInfo','HttpStatus','1767933AdyJdY','ali','addWorksheet','DALL-E2','count','deleteChatLog','InjectRepository','7bJhnVY','assign','当前页面已经没有东西可以删除了！','type','../../common/constants/balance.constant','__param','setHeader','gpts','\x20模型\x20','thumbImg','reverse','maskEmail','DESC','addRow','avatar','decorate','design:paramtypes','1364685CKNPSQ','Not','modelLimits','BAD_REQUEST','你删除的对话记录不存在、请检查！','save','取消推荐','update','defineProperty','tencent','role','findOneDrawLog','delByGroupId','ChatGroupEntity','HttpException','rec','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet','2080398mFJExG','answer','metadata','paintCount','findAndCount','createdAt','affected','log','gpt-4-gizmo','modelsService','Workbook','chatLogEntity','isGroup','?x-oss-process=image/resize,w_','includes','object','Like','getOwnPropertyDescriptor','用户名','stack','default','NORMAL_CHAT','chatlog','Repository','formatDate','MoreThan','findOneChatLog','parse','../user/user.entity','chatGroupEntity','stable-diffusion',',\x20错误信息:\x20','Injectable','399520IENHxo','email','forEach','图片成功！','PAINT','__metadata','now','160NOkpcT','user','?imageView2/1/w/','ChatType','@nestjs/typeorm','Logger','__esModule','map','chatHistory','提问问题','userEntity','startsWith','__decorate','function','end','用户ID:\x20','751492DvmkkT','checkModelLimits','\x20的使用次数限制为\x20','deleteChatsAfterId','ChatLogService','8cbPZsp','findOne','model','querAllChatLog','117098JxESfh','typeorm','updateChatLog','byAppId','Content-Disposition','Content-Type','recDrawImg','chat.xlsx','1243000HwByPr','exportExcel','midjourney','message','/q/55','prompt','3RBhHCL','getCurrentModelKeyInfo','dall-e-3','xlsx','extend','querAllDrawLog\x20Json\x20parse\x20error','saveChatLog','你推荐的图片不存在、请检查！','components','cos','find','columns','exceljs'];_0x1697=function(){return _0x3c9bab;};return _0x1697();}ChatLogService=__decorate([(0x0,common_1[_0x5092e7(0xe7)])(),__param(0x0,(0x0,typeorm_1[_0x5092e7(0x132)])(chatLog_entity_1['ChatLogEntity'])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(user_entity_1['UserEntity'])),__param(0x2,(0x0,typeorm_1[_0x5092e7(0x132)])(chatGroup_entity_1[_0x5092e7(0xc3)])),__metadata(_0x5092e7(0x143),[typeorm_2['Repository'],typeorm_2[_0x5092e7(0xde)],typeorm_2[_0x5092e7(0xde)],models_service_1[_0x5092e7(0x123)]])],ChatLogService),exports[_0x5092e7(0x103)]=ChatLogService;