'use strict';const _0x20136e=_0x12bb;(function(_0x562d34,_0x4067ab){const _0x4918ec=_0x12bb,_0x402848=_0x562d34();while(!![]){try{const _0x470874=parseInt(_0x4918ec(0x124))/0x1*(parseInt(_0x4918ec(0x16c))/0x2)+parseInt(_0x4918ec(0x187))/0x3*(parseInt(_0x4918ec(0x148))/0x4)+parseInt(_0x4918ec(0x195))/0x5+parseInt(_0x4918ec(0x12c))/0x6*(parseInt(_0x4918ec(0x155))/0x7)+-parseInt(_0x4918ec(0x17c))/0x8*(-parseInt(_0x4918ec(0xd2))/0x9)+parseInt(_0x4918ec(0xf0))/0xa*(parseInt(_0x4918ec(0x156))/0xb)+-parseInt(_0x4918ec(0x10b))/0xc;if(_0x470874===_0x4067ab)break;else _0x402848['push'](_0x402848['shift']());}catch(_0xfeb3e){_0x402848['push'](_0x402848['shift']());}}}(_0x4c62,0xb7ab5));var __decorate=this&&this[_0x20136e(0xdd)]||function(_0x449e22,_0x5cc429,_0x59b331,_0x4865e8){const _0x1ffc41=_0x20136e;var _0x1cb5f0=arguments[_0x1ffc41(0x16d)],_0x21e04c=_0x1cb5f0<0x3?_0x5cc429:_0x4865e8===null?_0x4865e8=Object[_0x1ffc41(0x13b)](_0x5cc429,_0x59b331):_0x4865e8,_0x214909;if(typeof Reflect==='object'&&typeof Reflect[_0x1ffc41(0xfa)]===_0x1ffc41(0xcd))_0x21e04c=Reflect[_0x1ffc41(0xfa)](_0x449e22,_0x5cc429,_0x59b331,_0x4865e8);else{for(var _0x1c85f4=_0x449e22[_0x1ffc41(0x16d)]-0x1;_0x1c85f4>=0x0;_0x1c85f4--)if(_0x214909=_0x449e22[_0x1c85f4])_0x21e04c=(_0x1cb5f0<0x3?_0x214909(_0x21e04c):_0x1cb5f0>0x3?_0x214909(_0x5cc429,_0x59b331,_0x21e04c):_0x214909(_0x5cc429,_0x59b331))||_0x21e04c;}return _0x1cb5f0>0x3&&_0x21e04c&&Object[_0x1ffc41(0x120)](_0x5cc429,_0x59b331,_0x21e04c),_0x21e04c;},__metadata=this&&this[_0x20136e(0x133)]||function(_0x4c312b,_0x43e6de){const _0x56a20d=_0x20136e;if(typeof Reflect===_0x56a20d(0x175)&&typeof Reflect[_0x56a20d(0x153)]===_0x56a20d(0xcd))return Reflect[_0x56a20d(0x153)](_0x4c312b,_0x43e6de);},__param=this&&this[_0x20136e(0x186)]||function(_0x253de9,_0xaad53){return function(_0x5bda7e,_0x23ca03){_0xaad53(_0x5bda7e,_0x23ca03,_0x253de9);};};function _0x4c62(){const _0x539298=['本次支付类型:\x20','OrderEntity','createRandomNonceStr','payMpayNotifyUrl','910hMOZVS','payMpaySecret','nonce_str','payPlatform','payLtzfReturnUrl','../globalConfig/globalConfig.service','ltzfSign','join','affected','payLtzfSecret','decorate','get','pid','query','userBalanceService','微信Native支付失败','微信Native支付响应数据:\x20','notify','body','money','notifyHupi','post','wxpay','queryLtzf','../userBalance/userBalance.service','[WeChat\x20Pay\x20JSAPI]\x20支付请求过程中发生错误:\x20','key=','50358300EJOKqR','nonceStr','notify_url','appId','payEpay','payMpayApiQueryUrl','微信Native支付过程中发生错误，错误信息:\x20','InjectRepository','1.1','package','trade_type','payMpayPid','warn','GlobalConfigService','resource','payHupi','payHupiGatewayUrl','payWeChatAppId','message','hupi','transactions_native','defineProperty','epay',',\x20订单ID:\x20','push','750173CTKUYO','payWeChatSecret','Repository','appid','JSAPI支付失败','../crami/cramiPackage.entity','payWeChat','payHupiNotifyUrl','20250qJcXYf','wechatpay-node-v3','trade_status','notifyWeChat','map','pay','HttpStatus','__metadata','orderEntity','unsupported\x20pay\x20type','success','type','status:\x20','微信Native支付请求成功，但未返回code_url，响应数据:\x20','stringify','getOwnPropertyDescriptor','version','FAIL','toUpperCase','payWeChatNotifyUrl','payMpay','支付通知验证失败:\x20','notifyMpay','goodsId','createHash','payer','mpay','payHupiSecret','4KpLIkO','payWeChatMchId','https://api.ltzf.cn/api/wxpay/get_pay_order','payWeChatPublicKey','total','payEpayApiQueryUrl','Injectable','TRANSACTION.SUCCESS','application/x-www-form-urlencoded','payEpayApiPayUrl',',\x20用户ID:\x20','metadata','event_type','7pGsyqB','130592qyhElc','notifyLtzf','校验签名通过','payWeChatPrivateKey','sort','act','@nestjs/typeorm','notifyEpay','192.168.1.100','WxPay','paySign','param','payEpaySecret','time','openid','md5','payMpayApiPayUrl','sign_type','hash','addBalanceToOrder','hex','payLtzfNotifyUrl','4cRpnGx','length','order_url','payLtzf','log','ltzf','toFixed','https://api.xunhupay.com/payment/do.html','name','object','[WeChat\x20Pay\x20JSAPI]\x20发送支付请求参数:\x20','out_trade_order','SUCCESS','UserBalanceService','getConfigs','title','1223032pFLOan','update','Logger','HttpException','keys','payLtzfMchId','校验签名','clientip','微信Native支付请求成功，code_url:\x20','data','__param','850731PYWErN','https://api.xunhupay.com/payment/query.html','error:\x20','queryWeChat','alipay','failed','../order/order.entity','crypto','includes','UserService','cramiPackageEntity','error','attach','sign','7348340WqrfxX','globalConfigService','支付请求失败:\x20','status','now','order_no','payHupiAppId','payHupiReturnUrl','design:paramtypes','queryEpay','default','return_url','QRcode_url','axios','transactions_jsapi','@nestjs/common','out_trade_no','pay_channel','MD5','BAD_REQUEST','payType:\x20','PayService','开始进行微信Native支付流程，订单ID:\x20','套餐不存在!','function','mch_id','__esModule','timestamp','[WeChat\x20Pay\x20JSAPI]\x20完整的错误对象：','36LVIbxN','trade_order_id','TRADE_SUCCESS','userService','wechat-pay:\x20','完整的错误对象：','payEpayPid','native','queryHupi','../user/user.service','queryMpay','__decorate','digest','device','signType','toString','[WeChat\x20Pay\x20JSAPI]\x20开始JSAPI支付流程，用户ID:\x20','findOne','[WeChat\x20Pay\x20JSAPI]\x20用户OpenID:\x20','订单不存在!','onModuleInit','code_url','wechat','payMpayReturnUrl','[WeChat\x20Pay\x20JSAPI]\x20支付请求成功，返回结果:\x20','getOpenIdByUserId'];_0x4c62=function(){return _0x539298;};return _0x4c62();}Object[_0x20136e(0x120)](exports,_0x20136e(0xcf),{'value':!![]}),exports[_0x20136e(0xca)]=void 0x0;function _0x12bb(_0x1a021e,_0x15f50a){const _0x4c6233=_0x4c62();return _0x12bb=function(_0x12bb0f,_0x1a1fbf){_0x12bb0f=_0x12bb0f-0xc3;let _0x4846d1=_0x4c6233[_0x12bb0f];return _0x4846d1;},_0x12bb(_0x1a021e,_0x15f50a);}const utils_1=require('../../common/utils'),common_1=require(_0x20136e(0xc4)),typeorm_1=require(_0x20136e(0x15c)),axios_1=require(_0x20136e(0x1a2)),crypto=require(_0x20136e(0x18e)),typeorm_2=require('typeorm'),cramiPackage_entity_1=require(_0x20136e(0x129)),globalConfig_service_1=require(_0x20136e(0xf5)),order_entity_1=require(_0x20136e(0x18d)),user_service_1=require(_0x20136e(0xdb)),userBalance_service_1=require(_0x20136e(0x108));let PayService=class PayService{constructor(_0x569022,_0x5ebbd6,_0x3aaf08,_0x1db7d7,_0x340788){const _0x175dd5=_0x20136e;this['cramiPackageEntity']=_0x569022,this[_0x175dd5(0x134)]=_0x5ebbd6,this[_0x175dd5(0xfe)]=_0x3aaf08,this[_0x175dd5(0x196)]=_0x1db7d7,this[_0x175dd5(0xd5)]=_0x340788;}async[_0x20136e(0xe6)](){const _0x5b4e90=_0x20136e,_0x569f98=await(0x0,utils_1['importDynamic'])(_0x5b4e90(0x12d));this['WxPay']=(_0x569f98===null||_0x569f98===void 0x0?void 0x0:_0x569f98[_0x5b4e90(0x19f)])?_0x569f98[_0x5b4e90(0x19f)]:_0x569f98;}async[_0x20136e(0x101)](_0x18838e){const _0xe34f0e=_0x20136e;if(_0x18838e['param']=='epay')return this[_0xe34f0e(0x15d)](_0x18838e);if(_0x18838e[_0xe34f0e(0x193)]==_0xe34f0e(0x11e))return this[_0xe34f0e(0x104)](_0x18838e);if(_0x18838e['attach']==_0xe34f0e(0x171))return this[_0xe34f0e(0x157)](_0x18838e);if(typeof _0x18838e['resource']=='object')return this[_0xe34f0e(0x12f)](_0x18838e);return this[_0xe34f0e(0x142)](_0x18838e);}async[_0x20136e(0x131)](_0x26dee7,_0x5edf8e,_0x2c95fb=_0x20136e(0x106)){const _0x5a8af7=_0x20136e,_0x39d56e=await this[_0x5a8af7(0x134)][_0x5a8af7(0xe3)]({'where':{'userId':_0x26dee7,'orderId':_0x5edf8e}});if(!_0x39d56e)throw new common_1[(_0x5a8af7(0x17f))](_0x5a8af7(0xe5),common_1[_0x5a8af7(0x132)]['BAD_REQUEST']);const _0x402818=await this['cramiPackageEntity']['findOne']({'where':{'id':_0x39d56e[_0x5a8af7(0x143)]}});if(!_0x402818)throw new common_1['HttpException'](_0x5a8af7(0xcc),common_1[_0x5a8af7(0x132)][_0x5a8af7(0xc8)]);common_1['Logger']['log'](_0x5a8af7(0xec),_0x39d56e['payPlatform']);try{if(_0x39d56e[_0x5a8af7(0xf3)]==_0x5a8af7(0xe8))return this[_0x5a8af7(0x12a)](_0x26dee7,_0x5edf8e,_0x2c95fb);if(_0x39d56e[_0x5a8af7(0xf3)]=='epay')return this['payEpay'](_0x26dee7,_0x5edf8e,_0x2c95fb);if(_0x39d56e['payPlatform']==_0x5a8af7(0x146))return this[_0x5a8af7(0x140)](_0x26dee7,_0x5edf8e,_0x2c95fb);if(_0x39d56e[_0x5a8af7(0xf3)]==_0x5a8af7(0x11e))return this[_0x5a8af7(0x11a)](_0x26dee7,_0x5edf8e,_0x2c95fb);if(_0x39d56e[_0x5a8af7(0xf3)]==_0x5a8af7(0x171))return this[_0x5a8af7(0x16f)](_0x26dee7,_0x5edf8e,_0x2c95fb);}catch(_0x520ea4){common_1[_0x5a8af7(0x17e)][_0x5a8af7(0x170)](_0x5a8af7(0x197),_0x520ea4);throw new common_1[(_0x5a8af7(0x17f))]('支付请求失败!',common_1[_0x5a8af7(0x132)][_0x5a8af7(0xc8)]);}}async['query'](_0xf78278){const _0x5e12c8=_0x20136e,_0x3a0938=await this[_0x5e12c8(0x134)][_0x5e12c8(0xe3)]({'where':{'orderId':_0xf78278}});if(!_0x3a0938)throw new common_1[(_0x5e12c8(0x17f))](_0x5e12c8(0xe5),common_1[_0x5e12c8(0x132)]['BAD_REQUEST']);return _0x3a0938;}async[_0x20136e(0x104)](_0x12f092){const _0x336247=_0x20136e,_0x5ce05d=await this[_0x336247(0x196)][_0x336247(0x17a)]([_0x336247(0x147)]),_0x315f18=_0x12f092[_0x336247(0x168)];delete _0x12f092[_0x336247(0x168)];if(this[_0x336247(0x194)](_0x12f092,_0x5ce05d)!=_0x315f18)return _0x336247(0x18c);const _0x87129f=await this[_0x336247(0x134)]['findOne']({'where':{'orderId':_0x12f092[_0x336247(0xd3)],'status':0x0}});if(!_0x87129f)return'failed';await this[_0x336247(0xfe)][_0x336247(0x169)](_0x87129f);const _0x318998=await this['orderEntity']['update']({'orderId':_0x12f092['trade_order_id']},{'status':0x1,'paydAt':new Date()});if(_0x318998[_0x336247(0xf8)]!=0x1)return _0x336247(0x18c);return _0x336247(0x136);}async[_0x20136e(0x11a)](_0x3d758e,_0x281e18,_0xe6892d=_0x20136e(0x106)){const _0x1a5c3f=_0x20136e,_0x2f2ad0=await this[_0x1a5c3f(0x134)][_0x1a5c3f(0xe3)]({'where':{'userId':_0x3d758e,'orderId':_0x281e18}});if(!_0x2f2ad0)throw new common_1[(_0x1a5c3f(0x17f))](_0x1a5c3f(0xe5),common_1['HttpStatus'][_0x1a5c3f(0xc8)]);const _0x472ead=await this[_0x1a5c3f(0x191)][_0x1a5c3f(0xe3)]({'where':{'id':_0x2f2ad0['goodsId']}});if(!_0x472ead)throw new common_1[(_0x1a5c3f(0x17f))](_0x1a5c3f(0xcc),common_1['HttpStatus'][_0x1a5c3f(0xc8)]);const {payHupiAppId:_0x1feaaf,payHupiSecret:_0xe39814,payHupiNotifyUrl:_0x3121da,payHupiReturnUrl:_0x2d3e5e,payHupiGatewayUrl:_0x494ca7}=await this[_0x1a5c3f(0x196)][_0x1a5c3f(0x17a)]([_0x1a5c3f(0x19b),'payHupiSecret',_0x1a5c3f(0x12b),_0x1a5c3f(0x19c),_0x1a5c3f(0x11b)]),_0xca066e={};_0xca066e[_0x1a5c3f(0x13c)]=_0x1a5c3f(0x113),_0xca066e['appid']=_0x1feaaf,_0xca066e[_0x1a5c3f(0x163)]=(Date['now']()/0x3e8)[_0x1a5c3f(0x172)](0x0),_0xca066e[_0x1a5c3f(0xf2)]=(0x0,utils_1[_0x1a5c3f(0xee)])(0x20),_0xca066e[_0x1a5c3f(0xd3)]=_0x281e18,_0xca066e[_0x1a5c3f(0x17b)]=_0x472ead['name'],_0xca066e['total_fee']=_0x2f2ad0[_0x1a5c3f(0x14c)],_0xca066e[_0x1a5c3f(0x10d)]=_0x3121da,_0xca066e[_0x1a5c3f(0x1a0)]=_0x2d3e5e,_0xca066e[_0x1a5c3f(0x193)]='hupi',_0xca066e[_0x1a5c3f(0x168)]=this[_0x1a5c3f(0x194)](_0xca066e,_0xe39814);const {data:{errcode:_0x14222b,errmsg:_0x470b46,url_qrcode:_0x7dcdcf,url:_0x3ce3c6}}=await axios_1[_0x1a5c3f(0x19f)][_0x1a5c3f(0x105)](_0x494ca7||_0x1a5c3f(0x173),_0xca066e);if(_0x14222b!=0x0)throw new common_1[(_0x1a5c3f(0x17f))](_0x470b46,common_1[_0x1a5c3f(0x132)][_0x1a5c3f(0xc8)]);return{'url_qrcode':_0x7dcdcf,'url':_0x3ce3c6};}async[_0x20136e(0xda)](_0x33206e){const _0x29c4c2=_0x20136e,{payHupiAppId:_0x4185c7,payHupiSecret:_0x9627b8}=await this[_0x29c4c2(0x196)][_0x29c4c2(0x17a)](['payHupiAppId',_0x29c4c2(0x147)]),_0x49a492={};_0x49a492[_0x29c4c2(0x13c)]=_0x29c4c2(0x113),_0x49a492[_0x29c4c2(0x127)]=_0x4185c7,_0x49a492[_0x29c4c2(0x163)]=(Date['now']()/0x3e8)[_0x29c4c2(0x172)](0x0),_0x49a492[_0x29c4c2(0xf2)]=(0x0,utils_1[_0x29c4c2(0xee)])(0x20),_0x49a492[_0x29c4c2(0x177)]=_0x33206e,_0x49a492[_0x29c4c2(0x168)]=this[_0x29c4c2(0x194)](_0x49a492,_0x9627b8);const {data:{errcode:_0x45a7f3,errmsg:_0x2a7cc9,data:_0x5e3c4e}}=await axios_1[_0x29c4c2(0x19f)][_0x29c4c2(0x105)](_0x29c4c2(0x188),_0x49a492);if(_0x45a7f3!=0x0)throw new common_1[(_0x29c4c2(0x17f))](_0x2a7cc9,common_1[_0x29c4c2(0x132)][_0x29c4c2(0xc8)]);return _0x5e3c4e;}async['notifyEpay'](_0x49abc0){const _0x4d92c5=_0x20136e,_0xb63a71=_0x49abc0[_0x4d92c5(0x194)];delete _0x49abc0[_0x4d92c5(0x194)],delete _0x49abc0[_0x4d92c5(0x167)];const _0x1a3d96=await this[_0x4d92c5(0x196)][_0x4d92c5(0x17a)](['payEpaySecret']);if(this[_0x4d92c5(0x194)](_0x49abc0,_0x1a3d96)!=_0xb63a71)return'failed';common_1[_0x4d92c5(0x17e)]['log'](_0x4d92c5(0x158));const _0x5c03d9=await this['orderEntity'][_0x4d92c5(0xe3)]({'where':{'orderId':_0x49abc0[_0x4d92c5(0xc5)],'status':0x0}});if(!_0x5c03d9)return _0x4d92c5(0x18c);const _0x229b70=_0x49abc0[_0x4d92c5(0x12e)]==_0x4d92c5(0xd4)?0x1:0x2,_0x301a30=await this[_0x4d92c5(0x134)][_0x4d92c5(0x17d)]({'orderId':_0x49abc0[_0x4d92c5(0xc5)]},{'status':_0x229b70,'paydAt':new Date()});_0x229b70===0x1&&await this[_0x4d92c5(0xfe)][_0x4d92c5(0x169)](_0x5c03d9);if(_0x301a30[_0x4d92c5(0xf8)]!=0x1)return _0x4d92c5(0x18c);return'success';}async[_0x20136e(0x10f)](_0x1ffe8f,_0x57da17,_0xf10831=_0x20136e(0x18b)){const _0x1911e7=_0x20136e,_0x461260=await this[_0x1911e7(0x134)][_0x1911e7(0xe3)]({'where':{'userId':_0x1ffe8f,'orderId':_0x57da17}});if(!_0x461260)throw new common_1[(_0x1911e7(0x17f))]('订单不存在!',common_1[_0x1911e7(0x132)][_0x1911e7(0xc8)]);const _0x32bbbe=await this[_0x1911e7(0x191)][_0x1911e7(0xe3)]({'where':{'id':_0x461260[_0x1911e7(0x143)]}});if(!_0x32bbbe)throw new common_1[(_0x1911e7(0x17f))](_0x1911e7(0xcc),common_1[_0x1911e7(0x132)][_0x1911e7(0xc8)]);const {payEpayPid:_0x3f5f1d,payEpaySecret:_0x25b3d8,payEpayNotifyUrl:_0x5457bb,payEpayReturnUrl:_0x4c06e4,payEpayApiPayUrl:_0x2d1796}=await this[_0x1911e7(0x196)][_0x1911e7(0x17a)]([_0x1911e7(0xd8),_0x1911e7(0x162),'payEpayNotifyUrl','payEpayReturnUrl',_0x1911e7(0x151)]);let _0x30e5b7;_0x3f5f1d[_0x1911e7(0x16d)]<=0x10?_0x30e5b7=Number(_0x3f5f1d):_0x30e5b7=BigInt(_0x3f5f1d);const _0x558cde={};_0x558cde[_0x1911e7(0xfc)]=_0x30e5b7,_0x558cde[_0x1911e7(0x137)]=_0xf10831,_0x558cde['out_trade_no']=_0x57da17,_0x558cde[_0x1911e7(0x174)]=_0x32bbbe[_0x1911e7(0x174)],_0x558cde[_0x1911e7(0x103)]=_0x461260['total'],_0x558cde[_0x1911e7(0x183)]=_0x1911e7(0x15e),_0x558cde[_0x1911e7(0xdf)]='pc',_0x558cde[_0x1911e7(0x10d)]=_0x5457bb,_0x558cde[_0x1911e7(0x1a0)]=_0x4c06e4,_0x558cde[_0x1911e7(0x161)]=_0x1911e7(0x121),_0x558cde[_0x1911e7(0x194)]=this[_0x1911e7(0x194)](_0x558cde,_0x25b3d8),_0x558cde[_0x1911e7(0x167)]='MD5';const _0x2e8f31=new URLSearchParams(_0x558cde)[_0x1911e7(0xe1)](),_0x570dd7=_0x2d1796+'?'+_0x2e8f31;if(_0x2d1796[_0x1911e7(0x18f)]('submit.php'))return{'url_qrcode':null,'redirectUrl':_0x570dd7,'channel':_0xf10831,'isRedirect':!![]};else{const _0x181de9={'headers':{'Content-Type':'application/x-www-form-urlencoded'}},_0x5c220e=await axios_1[_0x1911e7(0x19f)][_0x1911e7(0x105)](_0x2d1796,_0x558cde,_0x181de9);common_1[_0x1911e7(0x17e)]['log']('epay\x20--->\x20res:\x20',_0x5c220e[_0x1911e7(0x185)]);const {data:{code:_0x373191,msg:_0x226c36,qrcode:_0x16f423}}=_0x5c220e;if(_0x373191!=0x1)throw new common_1[(_0x1911e7(0x17f))](_0x226c36,common_1[_0x1911e7(0x132)][_0x1911e7(0xc8)]);return{'url_qrcode':_0x16f423,'redirectUrl':null,'channel':_0xf10831,'isRedirect':![]};}}async[_0x20136e(0x19e)](_0x2bb65e){const _0x35e9c7=_0x20136e,{payEpayPid:_0x1a11c5,payEpaySecret:_0x161e87,payEpayApiQueryUrl:_0x5af3c1}=await this[_0x35e9c7(0x196)][_0x35e9c7(0x17a)]([_0x35e9c7(0xd8),_0x35e9c7(0x162),_0x35e9c7(0x14d)]),_0x21b930={};_0x21b930[_0x35e9c7(0x15b)]='order',_0x21b930[_0x35e9c7(0xc5)]=_0x2bb65e,_0x21b930[_0x35e9c7(0xfc)]=_0x1a11c5,_0x21b930['key']=_0x161e87;const {data:{code:_0x5f489c,msg:_0x4533d2,data:_0x3a0218}}=await axios_1[_0x35e9c7(0x19f)]['get'](_0x5af3c1,{'params':_0x21b930});if(_0x5f489c!=0x1)throw new common_1[(_0x35e9c7(0x17f))](_0x4533d2,common_1[_0x35e9c7(0x132)]['BAD_REQUEST']);return _0x3a0218;}async[_0x20136e(0x142)](_0x1b2edf){const _0x36599d=_0x20136e,_0x574e47=_0x1b2edf[_0x36599d(0x194)];delete _0x1b2edf[_0x36599d(0x194)],delete _0x1b2edf[_0x36599d(0x167)];const _0x4b0267=await this['globalConfigService'][_0x36599d(0x17a)](['payMpaySecret']);common_1[_0x36599d(0x17e)][_0x36599d(0x170)](_0x36599d(0x182));if(this[_0x36599d(0x194)](_0x1b2edf,_0x4b0267)!=_0x574e47)return _0x36599d(0x18c);common_1[_0x36599d(0x17e)][_0x36599d(0x170)](_0x36599d(0x158));const _0x10491b=await this[_0x36599d(0x134)][_0x36599d(0xe3)]({'where':{'orderId':_0x1b2edf[_0x36599d(0xc5)],'status':0x0}});if(!_0x10491b)return _0x36599d(0x18c);const _0x197fbd=_0x1b2edf[_0x36599d(0x12e)]==_0x36599d(0xd4)?0x1:0x2;common_1[_0x36599d(0x17e)]['log'](_0x36599d(0x138),_0x197fbd);const _0x4e0b8f=await this['orderEntity']['update']({'orderId':_0x1b2edf[_0x36599d(0xc5)]},{'status':_0x197fbd,'paydAt':new Date()});_0x197fbd===0x1&&await this[_0x36599d(0xfe)][_0x36599d(0x169)](_0x10491b);if(_0x4e0b8f['affected']!=0x1)return _0x36599d(0x18c);return _0x36599d(0x136);}async[_0x20136e(0x140)](_0x1b708d,_0x6f4f7e,_0x6ba0b4=_0x20136e(0x106)){const _0x121547=_0x20136e,_0x48f28d=await this['orderEntity']['findOne']({'where':{'userId':_0x1b708d,'orderId':_0x6f4f7e}});if(!_0x48f28d)throw new common_1[(_0x121547(0x17f))](_0x121547(0xe5),common_1['HttpStatus'][_0x121547(0xc8)]);const _0x3e1679=await this[_0x121547(0x191)][_0x121547(0xe3)]({'where':{'id':_0x48f28d[_0x121547(0x143)]}});if(!_0x3e1679)throw new common_1[(_0x121547(0x17f))](_0x121547(0xcc),common_1[_0x121547(0x132)]['BAD_REQUEST']);const {payMpayPid:_0x14c390,payMpaySecret:_0x57f719,payMpayNotifyUrl:_0x31bf90,payMpayReturnUrl:_0x4d84d5,payMpayApiPayUrl:_0x2c1367}=await this['globalConfigService']['getConfigs']([_0x121547(0x116),_0x121547(0xf1),_0x121547(0xef),_0x121547(0xe9),_0x121547(0x166)]),_0x1288a5={};_0x1288a5[_0x121547(0xfc)]=Number(_0x14c390),_0x1288a5[_0x121547(0x137)]=_0x6ba0b4,_0x1288a5[_0x121547(0xc5)]=_0x6f4f7e,_0x1288a5[_0x121547(0x174)]=_0x3e1679[_0x121547(0x174)],_0x1288a5[_0x121547(0x103)]=_0x48f28d['total'],_0x1288a5['notify_url']=_0x31bf90,_0x1288a5[_0x121547(0x1a0)]=_0x4d84d5,_0x1288a5[_0x121547(0x194)]=this[_0x121547(0x194)](_0x1288a5,_0x57f719),_0x1288a5[_0x121547(0x167)]=_0x121547(0xc7);const _0x48c742=new URLSearchParams(_0x1288a5)['toString'](),_0x5831ba=_0x2c1367+'?'+_0x48c742;return{'url_qrcode':null,'redirectUrl':_0x5831ba,'channel':_0x6ba0b4,'isRedirect':!![]};const _0x3f1f1e=await axios_1[_0x121547(0x19f)][_0x121547(0xfb)](_0x2c1367,{'params':_0x1288a5});}async[_0x20136e(0xdc)](_0x3d7e2a){const _0x2a0268=_0x20136e,{payMpayApiQueryUrl:_0x2901d8}=await this[_0x2a0268(0x196)][_0x2a0268(0x17a)]([_0x2a0268(0x116),_0x2a0268(0xf1),_0x2a0268(0x110)]),_0x59c7b9={};_0x59c7b9['type']=0x2,_0x59c7b9[_0x2a0268(0x19a)]=_0x3d7e2a;const {data:{code:_0x7b8a33,msg:_0x350c6d,data:_0x17169a}}=await axios_1['default'][_0x2a0268(0xfb)](_0x2901d8,{'params':_0x59c7b9});if(_0x7b8a33!=0x1)throw new common_1[(_0x2a0268(0x17f))](_0x350c6d,common_1[_0x2a0268(0x132)][_0x2a0268(0xc8)]);return _0x17169a;}async[_0x20136e(0x12f)](_0x1146b4){const _0x5125e6=_0x20136e;common_1[_0x5125e6(0x17e)][_0x5125e6(0x170)]('微信支付通知params:\x20',_0x1146b4);const {payWeChatAppId:_0x570537,payWeChatMchId:_0x260228,payWeChatSecret:_0x19773d,payWeChatPublicKey:_0x308865,payWeChatPrivateKey:_0x46ec12}=await this[_0x5125e6(0x196)]['getConfigs']([_0x5125e6(0x11c),_0x5125e6(0x149),_0x5125e6(0x125),_0x5125e6(0x14b),'payWeChatPrivateKey']),_0xc0922e=new this['WxPay']({'appid':_0x570537,'mchid':_0x260228,'publicKey':_0x308865,'privateKey':_0x46ec12});try{if(_0x1146b4[_0x5125e6(0x154)]==_0x5125e6(0x14f)){const {ciphertext:_0x2ac78f,associated_data:_0x400267,nonce:_0x34df12}=_0x1146b4[_0x5125e6(0x119)],_0x49e778=_0xc0922e['decipher_gcm'](_0x2ac78f,_0x400267,_0x34df12,_0x19773d),_0x11a663=await this['orderEntity']['findOne']({'where':{'orderId':_0x49e778[_0x5125e6(0xc5)],'status':0x0}});if(!_0x11a663)return _0x5125e6(0x18c);const _0x545f66=_0x49e778['trade_state']=='SUCCESS'?0x1:0x2,_0x5aaf5b=await this[_0x5125e6(0x134)]['update']({'orderId':_0x49e778[_0x5125e6(0xc5)]},{'status':_0x545f66,'paydAt':new Date()});_0x545f66===0x1&&await this['userBalanceService'][_0x5125e6(0x169)](_0x11a663);if(_0x5aaf5b['affected']!=0x1)return'failed';}return _0x5125e6(0x136);}catch(_0x3675da){return common_1['Logger'][_0x5125e6(0x170)](_0x5125e6(0x189),_0x3675da),common_1[_0x5125e6(0x17e)]['log'](_0x5125e6(0x141),_0x3675da),_0x5125e6(0x18c);}}async[_0x20136e(0x12a)](_0x396462,_0x1f00d7,_0x58c683=_0x20136e(0xd9)){const _0xa30d8f=_0x20136e;var _0x2e3af4,_0x5f5c96,_0x5aabd1,_0x1d8458,_0x47cc4e,_0x4fe538,_0x73c128;common_1[_0xa30d8f(0x17e)][_0xa30d8f(0x170)](_0xa30d8f(0xc9),_0x58c683);const _0x5b1d28=await this['orderEntity'][_0xa30d8f(0xe3)]({'where':{'userId':_0x396462,'orderId':_0x1f00d7}});if(!_0x5b1d28)throw new common_1[(_0xa30d8f(0x17f))](_0xa30d8f(0xe5),common_1[_0xa30d8f(0x132)]['BAD_REQUEST']);const _0x3e2f87=await this[_0xa30d8f(0x191)][_0xa30d8f(0xe3)]({'where':{'id':_0x5b1d28[_0xa30d8f(0x143)]}});if(!_0x3e2f87)throw new common_1[(_0xa30d8f(0x17f))]('套餐不存在!',common_1[_0xa30d8f(0x132)][_0xa30d8f(0xc8)]);const {payWeChatAppId:_0x1cedb8,payWeChatMchId:_0x5cb5e2,payWeChatPublicKey:_0x195fee,payWeChatPrivateKey:_0x8fb9a5,payWeChatNotifyUrl:_0x33273a}=await this[_0xa30d8f(0x196)][_0xa30d8f(0x17a)]([_0xa30d8f(0x11c),_0xa30d8f(0x149),_0xa30d8f(0x14b),_0xa30d8f(0x159),_0xa30d8f(0x13f)]),_0x4e32c1=new this[(_0xa30d8f(0x15f))]({'appid':_0x1cedb8,'mchid':_0x5cb5e2,'publicKey':_0x195fee,'privateKey':_0x8fb9a5}),_0x25a28e={'appid':_0x1cedb8,'mchid':_0x5cb5e2,'description':_0x3e2f87['name'],'out_trade_no':_0x1f00d7,'notify_url':_0x33273a,'amount':{'total':Math['round'](_0x5b1d28[_0xa30d8f(0x14c)]*0x64)}};common_1[_0xa30d8f(0x17e)]['log'](_0xa30d8f(0xd6),_0x25a28e);if(_0x58c683=='jsapi'){common_1[_0xa30d8f(0x17e)]['log'](_0xa30d8f(0xe2)+_0x396462+_0xa30d8f(0x122)+_0x1f00d7);const _0x178a8c=await this[_0xa30d8f(0xd5)][_0xa30d8f(0xeb)](_0x396462);common_1[_0xa30d8f(0x17e)][_0xa30d8f(0x170)](_0xa30d8f(0xe4)+_0x178a8c),_0x25a28e[_0xa30d8f(0x145)]={'openid':_0x178a8c},common_1['Logger'][_0xa30d8f(0x170)](_0xa30d8f(0x176),JSON['stringify'](_0x25a28e,null,0x2));try{const _0x3a8dd8=await _0x4e32c1[_0xa30d8f(0xc3)](_0x25a28e),_0x222f98=_0x3a8dd8[_0xa30d8f(0x185)]?_0x3a8dd8[_0xa30d8f(0x185)]:_0x3a8dd8;return common_1[_0xa30d8f(0x17e)][_0xa30d8f(0x170)](_0xa30d8f(0xea),JSON[_0xa30d8f(0x13a)](_0x222f98,null,0x2)),{'status':_0x3a8dd8[_0xa30d8f(0x198)]||'unknown','appId':_0x222f98['appId']||((_0x2e3af4=_0x222f98[_0xa30d8f(0x185)])===null||_0x2e3af4===void 0x0?void 0x0:_0x2e3af4[_0xa30d8f(0x10e)]),'timeStamp':_0x222f98['timeStamp']||((_0x5f5c96=_0x222f98[_0xa30d8f(0x185)])===null||_0x5f5c96===void 0x0?void 0x0:_0x5f5c96['timeStamp']),'nonceStr':_0x222f98[_0xa30d8f(0x10c)]||((_0x5aabd1=_0x222f98[_0xa30d8f(0x185)])===null||_0x5aabd1===void 0x0?void 0x0:_0x5aabd1[_0xa30d8f(0x10c)]),'package':_0x222f98[_0xa30d8f(0x114)]||((_0x1d8458=_0x222f98[_0xa30d8f(0x185)])===null||_0x1d8458===void 0x0?void 0x0:_0x1d8458[_0xa30d8f(0x114)]),'signType':_0x222f98[_0xa30d8f(0xe0)]||((_0x47cc4e=_0x222f98[_0xa30d8f(0x185)])===null||_0x47cc4e===void 0x0?void 0x0:_0x47cc4e['signType']),'paySign':_0x222f98['paySign']||((_0x4fe538=_0x222f98[_0xa30d8f(0x185)])===null||_0x4fe538===void 0x0?void 0x0:_0x4fe538[_0xa30d8f(0x160)])};}catch(_0x3d92fa){console[_0xa30d8f(0x192)](_0xa30d8f(0x109)+_0x3d92fa[_0xa30d8f(0x11d)],_0x3d92fa),console[_0xa30d8f(0x192)](_0xa30d8f(0xd1),_0x3d92fa);throw new common_1[(_0xa30d8f(0x17f))](_0xa30d8f(0x128),common_1[_0xa30d8f(0x132)][_0xa30d8f(0xc8)]);}}if(_0x58c683==_0xa30d8f(0xd9)){common_1[_0xa30d8f(0x17e)]['log'](_0xa30d8f(0xcb)+_0x1f00d7+_0xa30d8f(0x152)+_0x396462);try{const _0x5026de=await _0x4e32c1[_0xa30d8f(0x11f)](_0x25a28e);common_1['Logger'][_0xa30d8f(0x170)](_0xa30d8f(0x100),JSON[_0xa30d8f(0x13a)](_0x5026de,null,0x2));let _0x894277=_0x5026de[_0xa30d8f(0xe7)]||((_0x73c128=_0x5026de['data'])===null||_0x73c128===void 0x0?void 0x0:_0x73c128['code_url']);return!_0x894277?console[_0xa30d8f(0x192)](_0xa30d8f(0x139),JSON['stringify'](_0x5026de,null,0x2)):common_1[_0xa30d8f(0x17e)][_0xa30d8f(0x170)](_0xa30d8f(0x184)+_0x894277),{'url_qrcode':_0x894277,'isRedirect':![]};}catch(_0x3c833c){console[_0xa30d8f(0x192)](_0xa30d8f(0x111)+_0x3c833c[_0xa30d8f(0x11d)],_0x3c833c),console[_0xa30d8f(0x192)](_0xa30d8f(0xd7),_0x3c833c);throw new common_1[(_0xa30d8f(0x17f))](_0xa30d8f(0xff),common_1[_0xa30d8f(0x132)][_0xa30d8f(0xc8)]);}}else{console[_0xa30d8f(0x117)]('支付请求使用了不支持的支付类型:\x20'+_0x58c683);throw new common_1[(_0xa30d8f(0x17f))](_0xa30d8f(0x135),common_1['HttpStatus'][_0xa30d8f(0xc8)]);}}async[_0x20136e(0x18a)](_0x3fec1f){const _0x3b114b=_0x20136e,{payWeChatAppId:_0xb00359,payWeChatMchId:_0x1c9c42,payWeChatPublicKey:_0x18c853,payWeChatPrivateKey:_0x2b1ab8,payWeChatNotifyUrl:_0x38ec76}=await this['globalConfigService'][_0x3b114b(0x17a)](['payWeChatAppId',_0x3b114b(0x149),_0x3b114b(0x14b),_0x3b114b(0x159)]),_0x476f96=new this[(_0x3b114b(0x15f))]({'appid':_0xb00359,'mchid':_0x1c9c42,'publicKey':_0x18c853,'privateKey':_0x2b1ab8}),_0x18292f=await _0x476f96[_0x3b114b(0xfd)]({'out_trade_no':_0x3fec1f});return _0x18292f;}['sign'](_0x200892,_0x2a3c9b){const _0x56be5e=_0x20136e,_0x581f87=Object[_0x56be5e(0x180)](_0x200892)[_0x56be5e(0x15a)]()['map'](_0x3738e1=>_0x3738e1+'='+_0x200892[_0x3738e1])['join']('&')+_0x2a3c9b;return crypto['createHash'](_0x56be5e(0x165))['update'](_0x581f87)[_0x56be5e(0xde)](_0x56be5e(0x16a));}[_0x20136e(0xf6)](_0x2120b1,_0x30881f){const _0x257616=_0x20136e,_0x2f8348=Object['keys'](_0x2120b1);_0x2f8348[_0x257616(0x15a)]();const _0x76c55e=[];_0x2f8348[_0x257616(0x130)](_0x3c2e67=>{const _0x543eb2=_0x257616;_0x76c55e[_0x543eb2(0x123)](_0x3c2e67+'='+_0x2120b1[_0x3c2e67]);}),_0x76c55e[_0x257616(0x123)](_0x257616(0x10a)+_0x30881f);const _0x1c2eeb=_0x76c55e['join']('&');return crypto[_0x257616(0x144)](_0x257616(0x165))[_0x257616(0x17d)](_0x1c2eeb)['digest'](_0x257616(0x16a))[_0x257616(0x13e)]();}async['payLtzf'](_0xccae8,_0x960c03,_0x1b1fe2=_0x20136e(0x106)){const _0x2132f2=_0x20136e,_0x117003=await this[_0x2132f2(0x134)]['findOne']({'where':{'userId':_0xccae8,'orderId':_0x960c03}});if(!_0x117003)throw new common_1[(_0x2132f2(0x17f))]('订单不存在!',common_1[_0x2132f2(0x132)][_0x2132f2(0xc8)]);const _0x5599ed=await this[_0x2132f2(0x191)][_0x2132f2(0xe3)]({'where':{'id':_0x117003[_0x2132f2(0x143)]}});if(!_0x5599ed)throw new common_1[(_0x2132f2(0x17f))](_0x2132f2(0xcc),common_1[_0x2132f2(0x132)][_0x2132f2(0xc8)]);const {payLtzfMchId:_0x4304c3,payLtzfSecret:_0x2b607f,payLtzfNotifyUrl:_0x22de33,payLtzfReturnUrl:_0x2dbdf6}=await this[_0x2132f2(0x196)]['getConfigs']([_0x2132f2(0x181),'payLtzfSecret',_0x2132f2(0x16b),_0x2132f2(0xf4)]),_0x3ec3be={};_0x3ec3be['mch_id']=_0x4304c3,_0x3ec3be[_0x2132f2(0xd0)]=(Date[_0x2132f2(0x199)]()/0x3e8)[_0x2132f2(0x172)](0x0),_0x3ec3be[_0x2132f2(0xc5)]=_0x960c03,_0x3ec3be[_0x2132f2(0x102)]=_0x5599ed[_0x2132f2(0x174)],_0x3ec3be['total_fee']=_0x117003[_0x2132f2(0x14c)],_0x3ec3be[_0x2132f2(0x10d)]=_0x22de33,_0x3ec3be[_0x2132f2(0x194)]=this[_0x2132f2(0xf6)](_0x3ec3be,_0x2b607f),_0x3ec3be[_0x2132f2(0x193)]=_0x2132f2(0x171),_0x3ec3be[_0x2132f2(0x1a0)]=_0x2dbdf6;const _0x35610d=Object[_0x2132f2(0x180)](_0x3ec3be)[_0x2132f2(0x130)](_0x161b66=>encodeURIComponent(_0x161b66)+'='+encodeURIComponent(_0x3ec3be[_0x161b66]))[_0x2132f2(0xf7)]('&'),_0x243587={'headers':{'Content-Type':_0x2132f2(0x150)}},_0xb2a5c1=await axios_1[_0x2132f2(0x19f)][_0x2132f2(0x105)]('https://api.ltzf.cn/api/wxpay/jsapi_convenient',_0x35610d,_0x243587),{code:_0x565db6,data:_0x3e83ed,msg:_0x3db117}=_0xb2a5c1[_0x2132f2(0x185)];if(_0x565db6!=0x0)throw new common_1['HttpException'](_0x3db117,common_1[_0x2132f2(0x132)]['BAD_REQUEST']);const _0x21f206=_0x3e83ed[_0x2132f2(0x1a1)],_0x516018=_0x3e83ed[_0x2132f2(0x16e)];return{'url_qrcode':_0x21f206,'url':_0x516018};}async[_0x20136e(0x107)](_0x2fd4b8){const _0x55f84c=_0x20136e,{payLtzfMchId:_0x3d28f2,payLtzfSecret:_0xdc2a45}=await this[_0x55f84c(0x196)][_0x55f84c(0x17a)](['payLtzfMchId',_0x55f84c(0xf9)]),_0x12fe9a={};_0x12fe9a[_0x55f84c(0xce)]=_0x3d28f2,_0x12fe9a[_0x55f84c(0xd0)]=(Date[_0x55f84c(0x199)]()/0x3e8)[_0x55f84c(0x172)](0x0),_0x12fe9a[_0x55f84c(0xc5)]=_0x2fd4b8,_0x12fe9a[_0x55f84c(0x194)]=this[_0x55f84c(0xf6)](_0x12fe9a,_0xdc2a45);const _0xb35f3b=Object['keys'](_0x12fe9a)[_0x55f84c(0x130)](_0x174366=>encodeURIComponent(_0x174366)+'='+encodeURIComponent(_0x12fe9a[_0x174366]))[_0x55f84c(0xf7)]('&'),_0x335947={'headers':{'Content-Type':_0x55f84c(0x150)}},{data:{code:_0x27c35b,msg:_0x3958ba,data:_0x2752c9}}=await axios_1['default'][_0x55f84c(0x105)](_0x55f84c(0x14a),_0xb35f3b,_0x335947);if(_0x27c35b!=0x0)throw new common_1[(_0x55f84c(0x17f))](_0x3958ba+JSON[_0x55f84c(0x13a)](_0x12fe9a),common_1[_0x55f84c(0x132)][_0x55f84c(0xc8)]);return _0x2752c9;}async[_0x20136e(0x157)](_0x1a2e82){const _0x2771df=_0x20136e,_0x2e8036=await this[_0x2771df(0x196)]['getConfigs']([_0x2771df(0xf9)]),_0x4fd3f5=_0x1a2e82['sign'];delete _0x1a2e82['sign'],delete _0x1a2e82[_0x2771df(0xc6)],delete _0x1a2e82[_0x2771df(0x115)],delete _0x1a2e82['success_time'],delete _0x1a2e82[_0x2771df(0x193)],delete _0x1a2e82[_0x2771df(0x164)];if(this[_0x2771df(0xf6)](_0x1a2e82,_0x2e8036)!=_0x4fd3f5)return _0x2771df(0x13d);const _0x316241=await this['orderEntity'][_0x2771df(0xe3)]({'where':{'orderId':_0x1a2e82[_0x2771df(0xc5)],'status':0x0}});if(!_0x316241)return _0x2771df(0x13d);await this[_0x2771df(0xfe)]['addBalanceToOrder'](_0x316241);const _0xcf8e3b=await this[_0x2771df(0x134)][_0x2771df(0x17d)]({'orderId':_0x1a2e82[_0x2771df(0xc5)]},{'status':0x1,'paydAt':new Date()});if(_0xcf8e3b[_0x2771df(0xf8)]!=0x1)return _0x2771df(0x13d);return _0x2771df(0x178);}};PayService=__decorate([(0x0,common_1[_0x20136e(0x14e)])(),__param(0x0,(0x0,typeorm_1[_0x20136e(0x112)])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x1,(0x0,typeorm_1[_0x20136e(0x112)])(order_entity_1[_0x20136e(0xed)])),__metadata(_0x20136e(0x19d),[typeorm_2[_0x20136e(0x126)],typeorm_2[_0x20136e(0x126)],userBalance_service_1[_0x20136e(0x179)],globalConfig_service_1[_0x20136e(0x118)],user_service_1[_0x20136e(0x190)]])],PayService),exports[_0x20136e(0xca)]=PayService;