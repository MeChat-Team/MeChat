'use strict';const _0x54b2a4=_0x3b56;(function(_0x328202,_0x3db7dc){const _0x5703b8=_0x3b56,_0x347200=_0x328202();while(!![]){try{const _0x346945=-parseInt(_0x5703b8(0x147))/0x1*(parseInt(_0x5703b8(0x127))/0x2)+parseInt(_0x5703b8(0x16b))/0x3+parseInt(_0x5703b8(0x17a))/0x4+parseInt(_0x5703b8(0x146))/0x5+-parseInt(_0x5703b8(0x189))/0x6+parseInt(_0x5703b8(0x184))/0x7+parseInt(_0x5703b8(0x105))/0x8;if(_0x346945===_0x3db7dc)break;else _0x347200['push'](_0x347200['shift']());}catch(_0x1a566f){_0x347200['push'](_0x347200['shift']());}}}(_0x4962,0x3500f));var __decorate=this&&this[_0x54b2a4(0x198)]||function(_0x183433,_0x3678f3,_0xe34cb0,_0x3ada50){const _0x3d1ff1=_0x54b2a4;var _0x250c66=arguments[_0x3d1ff1(0x186)],_0x373973=_0x250c66<0x3?_0x3678f3:_0x3ada50===null?_0x3ada50=Object['getOwnPropertyDescriptor'](_0x3678f3,_0xe34cb0):_0x3ada50,_0x4ebf2d;if(typeof Reflect===_0x3d1ff1(0xec)&&typeof Reflect[_0x3d1ff1(0x165)]===_0x3d1ff1(0xce))_0x373973=Reflect[_0x3d1ff1(0x165)](_0x183433,_0x3678f3,_0xe34cb0,_0x3ada50);else{for(var _0x410b57=_0x183433[_0x3d1ff1(0x186)]-0x1;_0x410b57>=0x0;_0x410b57--)if(_0x4ebf2d=_0x183433[_0x410b57])_0x373973=(_0x250c66<0x3?_0x4ebf2d(_0x373973):_0x250c66>0x3?_0x4ebf2d(_0x3678f3,_0xe34cb0,_0x373973):_0x4ebf2d(_0x3678f3,_0xe34cb0))||_0x373973;}return _0x250c66>0x3&&_0x373973&&Object['defineProperty'](_0x3678f3,_0xe34cb0,_0x373973),_0x373973;},__metadata=this&&this[_0x54b2a4(0xe9)]||function(_0x56dd02,_0x46d7ac){const _0x3ca97c=_0x54b2a4;if(typeof Reflect===_0x3ca97c(0xec)&&typeof Reflect[_0x3ca97c(0x145)]===_0x3ca97c(0xce))return Reflect['metadata'](_0x56dd02,_0x46d7ac);},__param=this&&this['__param']||function(_0xff3e0f,_0x17dbf4){return function(_0x3add9b,_0x201143){_0x17dbf4(_0x3add9b,_0x201143,_0xff3e0f);};};function _0x3b56(_0x3d5fcf,_0x298109){const _0x4962e3=_0x4962();return _0x3b56=function(_0x3b56d2,_0x2d9247){_0x3b56d2=_0x3b56d2-0xc6;let _0x2f9eed=_0x4962e3[_0x3b56d2];return _0x2f9eed;},_0x3b56(_0x3d5fcf,_0x298109);}Object[_0x54b2a4(0x16c)](exports,_0x54b2a4(0x13d),{'value':!![]}),exports[_0x54b2a4(0xd8)]=void 0x0;const utils_1=require(_0x54b2a4(0xdd)),common_1=require(_0x54b2a4(0x13e)),typeorm_1=require(_0x54b2a4(0xd6)),axios_1=require(_0x54b2a4(0x19a)),crypto=require('crypto'),typeorm_2=require(_0x54b2a4(0xe1)),cramiPackage_entity_1=require(_0x54b2a4(0x103)),globalConfig_service_1=require(_0x54b2a4(0xf8)),order_entity_1=require(_0x54b2a4(0x132)),user_service_1=require(_0x54b2a4(0x110)),userBalance_service_1=require('../userBalance/userBalance.service');let PayService=class PayService{constructor(_0x5d6543,_0x53f82a,_0x2ecbc1,_0x1a24bb,_0x23e021){const _0x18b6c7=_0x54b2a4;this[_0x18b6c7(0x156)]=_0x5d6543,this[_0x18b6c7(0x115)]=_0x53f82a,this[_0x18b6c7(0x15f)]=_0x2ecbc1,this[_0x18b6c7(0x158)]=_0x1a24bb,this[_0x18b6c7(0xdf)]=_0x23e021;}async[_0x54b2a4(0xc7)](){const _0x31125c=_0x54b2a4,_0x3aa4ea=await(0x0,utils_1['importDynamic'])(_0x31125c(0xcb));this['WxPay']=(_0x3aa4ea===null||_0x3aa4ea===void 0x0?void 0x0:_0x3aa4ea['default'])?_0x3aa4ea[_0x31125c(0xd0)]:_0x3aa4ea;}async['notify'](_0x18a6d9){const _0x11ab58=_0x54b2a4;if(_0x18a6d9[_0x11ab58(0x191)]==_0x11ab58(0x16e))return this[_0x11ab58(0x176)](_0x18a6d9);if(_0x18a6d9['attach']=='hupi')return this[_0x11ab58(0x166)](_0x18a6d9);if(_0x18a6d9['attach']=='ltzf')return this[_0x11ab58(0x114)](_0x18a6d9);if(typeof _0x18a6d9[_0x11ab58(0x179)]==_0x11ab58(0xec))return this[_0x11ab58(0xd7)](_0x18a6d9);return this['notifyMpay'](_0x18a6d9);}async[_0x54b2a4(0xfd)](_0x2138bf,_0xda8fd,_0x3e880a=_0x54b2a4(0x169)){const _0x502c10=_0x54b2a4,_0x5675d0=await this['orderEntity']['findOne']({'where':{'userId':_0x2138bf,'orderId':_0xda8fd}});if(!_0x5675d0)throw new common_1[(_0x502c10(0xe5))]('订单不存在!',common_1[_0x502c10(0x123)][_0x502c10(0xd5)]);const _0xea59fc=await this[_0x502c10(0x156)][_0x502c10(0x12f)]({'where':{'id':_0x5675d0[_0x502c10(0x140)]}});if(!_0xea59fc)throw new common_1['HttpException']('套餐不存在!',common_1[_0x502c10(0x123)][_0x502c10(0xd5)]);common_1[_0x502c10(0xc8)][_0x502c10(0xcf)](_0x502c10(0x157),_0x5675d0['payPlatform']);try{if(_0x5675d0['payPlatform']==_0x502c10(0x10e))return this[_0x502c10(0x112)](_0x2138bf,_0xda8fd,_0x3e880a);if(_0x5675d0[_0x502c10(0x13a)]=='epay')return this[_0x502c10(0xfb)](_0x2138bf,_0xda8fd,_0x3e880a);if(_0x5675d0[_0x502c10(0x13a)]==_0x502c10(0x135))return this[_0x502c10(0x14a)](_0x2138bf,_0xda8fd,_0x3e880a);if(_0x5675d0[_0x502c10(0x13a)]==_0x502c10(0x154))return this[_0x502c10(0x14f)](_0x2138bf,_0xda8fd,_0x3e880a);if(_0x5675d0[_0x502c10(0x13a)]==_0x502c10(0xeb))return this[_0x502c10(0x19b)](_0x2138bf,_0xda8fd,_0x3e880a);}catch(_0x548405){common_1[_0x502c10(0xc8)]['log']('支付请求失败:\x20',_0x548405);throw new common_1[(_0x502c10(0xe5))](_0x502c10(0x162),common_1[_0x502c10(0x123)]['BAD_REQUEST']);}}async['query'](_0x530d82){const _0x2c36c4=_0x54b2a4,_0x566a8f=await this['orderEntity'][_0x2c36c4(0x12f)]({'where':{'orderId':_0x530d82}});if(!_0x566a8f)throw new common_1[(_0x2c36c4(0xe5))](_0x2c36c4(0x17f),common_1[_0x2c36c4(0x123)][_0x2c36c4(0xd5)]);return _0x566a8f;}async['notifyHupi'](_0x32f9c6){const _0x317ac8=_0x54b2a4,_0x12e476=await this['globalConfigService'][_0x317ac8(0x172)]([_0x317ac8(0xf4)]),_0x4044d7=_0x32f9c6[_0x317ac8(0x16f)];delete _0x32f9c6[_0x317ac8(0x16f)];if(this['sign'](_0x32f9c6,_0x12e476)!=_0x4044d7)return'failed';const _0x19c010=await this['orderEntity'][_0x317ac8(0x12f)]({'where':{'orderId':_0x32f9c6[_0x317ac8(0x187)],'status':0x0}});if(!_0x19c010)return _0x317ac8(0x12b);await this['userBalanceService'][_0x317ac8(0x173)](_0x19c010);const _0x467ddc=await this[_0x317ac8(0x115)][_0x317ac8(0x182)]({'orderId':_0x32f9c6['trade_order_id']},{'status':0x1,'paydAt':new Date()});if(_0x467ddc['affected']!=0x1)return'failed';return'success';}async[_0x54b2a4(0x14f)](_0x3f37e1,_0x52783b,_0x9d004a=_0x54b2a4(0x169)){const _0x421e23=_0x54b2a4,_0x295545=await this['orderEntity'][_0x421e23(0x12f)]({'where':{'userId':_0x3f37e1,'orderId':_0x52783b}});if(!_0x295545)throw new common_1[(_0x421e23(0xe5))](_0x421e23(0x17f),common_1[_0x421e23(0x123)][_0x421e23(0xd5)]);const _0x21f173=await this[_0x421e23(0x156)][_0x421e23(0x12f)]({'where':{'id':_0x295545['goodsId']}});if(!_0x21f173)throw new common_1[(_0x421e23(0xe5))](_0x421e23(0x126),common_1[_0x421e23(0x123)][_0x421e23(0xd5)]);const {payHupiAppId:_0x2aab44,payHupiSecret:_0x404152,payHupiNotifyUrl:_0x390702,payHupiReturnUrl:_0x42a9ea,payHupiGatewayUrl:_0x1ca75f}=await this[_0x421e23(0x158)]['getConfigs'](['payHupiAppId','payHupiSecret',_0x421e23(0x177),'payHupiReturnUrl',_0x421e23(0x181)]),_0x154f7d={};_0x154f7d[_0x421e23(0x11c)]=_0x421e23(0x109),_0x154f7d[_0x421e23(0x141)]=_0x2aab44,_0x154f7d[_0x421e23(0x175)]=(Date['now']()/0x3e8)[_0x421e23(0x111)](0x0),_0x154f7d[_0x421e23(0x102)]=(0x0,utils_1[_0x421e23(0xe8)])(0x20),_0x154f7d[_0x421e23(0x187)]=_0x52783b,_0x154f7d[_0x421e23(0x18a)]=_0x21f173['name'],_0x154f7d[_0x421e23(0x171)]=_0x295545[_0x421e23(0x139)],_0x154f7d['notify_url']=_0x390702,_0x154f7d[_0x421e23(0xc6)]=_0x42a9ea,_0x154f7d[_0x421e23(0x14e)]=_0x421e23(0x154),_0x154f7d[_0x421e23(0x16f)]=this[_0x421e23(0x134)](_0x154f7d,_0x404152);const {data:{errcode:_0x4e3352,errmsg:_0x420f6d,url_qrcode:_0x3b49b0,url:_0x441930}}=await axios_1[_0x421e23(0xd0)][_0x421e23(0x14b)](_0x1ca75f||_0x421e23(0x178),_0x154f7d);if(_0x4e3352!=0x0)throw new common_1[(_0x421e23(0xe5))](_0x420f6d,common_1[_0x421e23(0x123)][_0x421e23(0xd5)]);return{'url_qrcode':_0x3b49b0,'url':_0x441930};}async[_0x54b2a4(0x142)](_0x4c4c6e){const _0x3d6db9=_0x54b2a4,{payHupiAppId:_0xf1e7e9,payHupiSecret:_0x5b3882}=await this[_0x3d6db9(0x158)][_0x3d6db9(0x172)](['payHupiAppId',_0x3d6db9(0xf4)]),_0x5eaea2={};_0x5eaea2['version']='1.1',_0x5eaea2[_0x3d6db9(0x141)]=_0xf1e7e9,_0x5eaea2[_0x3d6db9(0x175)]=(Date[_0x3d6db9(0x195)]()/0x3e8)['toFixed'](0x0),_0x5eaea2['nonce_str']=(0x0,utils_1[_0x3d6db9(0xe8)])(0x20),_0x5eaea2[_0x3d6db9(0xf2)]=_0x4c4c6e,_0x5eaea2[_0x3d6db9(0x16f)]=this[_0x3d6db9(0x134)](_0x5eaea2,_0x5b3882);const {data:{errcode:_0x5cf32f,errmsg:_0x282275,data:_0x44dc41}}=await axios_1[_0x3d6db9(0xd0)]['post'](_0x3d6db9(0xdb),_0x5eaea2);if(_0x5cf32f!=0x0)throw new common_1[(_0x3d6db9(0xe5))](_0x282275,common_1['HttpStatus'][_0x3d6db9(0xd5)]);return _0x44dc41;}async[_0x54b2a4(0x176)](_0x242131){const _0x384410=_0x54b2a4,_0x5e189f=_0x242131[_0x384410(0x134)];delete _0x242131['sign'],delete _0x242131[_0x384410(0xe4)];const _0x55e546=await this['globalConfigService'][_0x384410(0x172)]([_0x384410(0xd9)]);if(this['sign'](_0x242131,_0x55e546)!=_0x5e189f)return _0x384410(0x12b);common_1[_0x384410(0xc8)][_0x384410(0xcf)](_0x384410(0x199));const _0x291caf=await this[_0x384410(0x115)][_0x384410(0x12f)]({'where':{'orderId':_0x242131['out_trade_no'],'status':0x0}});if(!_0x291caf)return _0x384410(0x12b);const _0x2ec6a2=_0x242131[_0x384410(0x167)]==_0x384410(0x138)?0x1:0x2,_0x5b1fb6=await this['orderEntity'][_0x384410(0x182)]({'orderId':_0x242131[_0x384410(0x15a)]},{'status':_0x2ec6a2,'paydAt':new Date()});_0x2ec6a2===0x1&&await this[_0x384410(0x15f)][_0x384410(0x173)](_0x291caf);if(_0x5b1fb6[_0x384410(0x10c)]!=0x1)return _0x384410(0x12b);return _0x384410(0x101);}async[_0x54b2a4(0xfb)](_0x2f62a3,_0x3dbf9b,_0x56bc97=_0x54b2a4(0x124)){const _0x3049b7=_0x54b2a4,_0x54dbf6=await this[_0x3049b7(0x115)]['findOne']({'where':{'userId':_0x2f62a3,'orderId':_0x3dbf9b}});if(!_0x54dbf6)throw new common_1[(_0x3049b7(0xe5))]('订单不存在!',common_1[_0x3049b7(0x123)][_0x3049b7(0xd5)]);const _0x558674=await this['cramiPackageEntity']['findOne']({'where':{'id':_0x54dbf6['goodsId']}});if(!_0x558674)throw new common_1[(_0x3049b7(0xe5))](_0x3049b7(0x126),common_1[_0x3049b7(0x123)][_0x3049b7(0xd5)]);const {payEpayPid:_0x1239ac,payEpaySecret:_0x3bf122,payEpayNotifyUrl:_0x58ef3d,payEpayReturnUrl:_0xf38531,payEpayApiPayUrl:_0x48d7b6}=await this[_0x3049b7(0x158)][_0x3049b7(0x172)]([_0x3049b7(0xfa),_0x3049b7(0xd9),'payEpayNotifyUrl',_0x3049b7(0x174),_0x3049b7(0x15e)]);let _0x5a5909;_0x1239ac[_0x3049b7(0x186)]<=0x10?_0x5a5909=Number(_0x1239ac):_0x5a5909=BigInt(_0x1239ac);const _0x5ecb9c={};_0x5ecb9c[_0x3049b7(0x15b)]=_0x5a5909,_0x5ecb9c[_0x3049b7(0x180)]=_0x56bc97,_0x5ecb9c[_0x3049b7(0x15a)]=_0x3dbf9b,_0x5ecb9c['name']=_0x558674[_0x3049b7(0x170)],_0x5ecb9c['money']=_0x54dbf6[_0x3049b7(0x139)],_0x5ecb9c['clientip']=_0x3049b7(0xf7),_0x5ecb9c[_0x3049b7(0xf1)]='pc',_0x5ecb9c[_0x3049b7(0x14c)]=_0x58ef3d,_0x5ecb9c[_0x3049b7(0xc6)]=_0xf38531,_0x5ecb9c['param']='epay',_0x5ecb9c[_0x3049b7(0x134)]=this[_0x3049b7(0x134)](_0x5ecb9c,_0x3bf122),_0x5ecb9c[_0x3049b7(0xe4)]=_0x3049b7(0x136);const _0x167cbb=new URLSearchParams(_0x5ecb9c)[_0x3049b7(0x151)](),_0x3a5eb0=_0x48d7b6+'?'+_0x167cbb;if(_0x48d7b6[_0x3049b7(0x12c)](_0x3049b7(0xea)))return{'url_qrcode':null,'redirectUrl':_0x3a5eb0,'channel':_0x56bc97,'isRedirect':!![]};else{const _0x96fbfd={'headers':{'Content-Type':_0x3049b7(0x164)}},_0x47c676=await axios_1['default'][_0x3049b7(0x14b)](_0x48d7b6,_0x5ecb9c,_0x96fbfd);common_1[_0x3049b7(0xc8)][_0x3049b7(0xcf)](_0x3049b7(0x131),_0x47c676['data']);const {data:{code:_0x5a63de,msg:_0x3ca38c,qrcode:_0xd43689}}=_0x47c676;if(_0x5a63de!=0x1)throw new common_1[(_0x3049b7(0xe5))](_0x3ca38c,common_1[_0x3049b7(0x123)][_0x3049b7(0xd5)]);return{'url_qrcode':_0xd43689,'redirectUrl':null,'channel':_0x56bc97,'isRedirect':![]};}}async[_0x54b2a4(0x194)](_0x4445c9){const _0x5d7c2c=_0x54b2a4,{payEpayPid:_0x31e6df,payEpaySecret:_0x5a9270,payEpayApiQueryUrl:_0x670fd1}=await this[_0x5d7c2c(0x158)]['getConfigs']([_0x5d7c2c(0xfa),'payEpaySecret',_0x5d7c2c(0x18b)]),_0x3869c1={};_0x3869c1['act']=_0x5d7c2c(0x159),_0x3869c1[_0x5d7c2c(0x15a)]=_0x4445c9,_0x3869c1[_0x5d7c2c(0x15b)]=_0x31e6df,_0x3869c1[_0x5d7c2c(0xe2)]=_0x5a9270;const {data:{code:_0x65aee,msg:_0x4ee919,data:_0x560f88}}=await axios_1['default'][_0x5d7c2c(0x13f)](_0x670fd1,{'params':_0x3869c1});if(_0x65aee!=0x1)throw new common_1[(_0x5d7c2c(0xe5))](_0x4ee919,common_1[_0x5d7c2c(0x123)][_0x5d7c2c(0xd5)]);return _0x560f88;}async[_0x54b2a4(0x11d)](_0x11d327){const _0x464801=_0x54b2a4,_0x2cbb87=_0x11d327[_0x464801(0x134)];delete _0x11d327[_0x464801(0x134)],delete _0x11d327[_0x464801(0xe4)];const _0x5507ad=await this['globalConfigService'][_0x464801(0x172)](['payMpaySecret']);common_1['Logger']['log'](_0x464801(0xf3));if(this[_0x464801(0x134)](_0x11d327,_0x5507ad)!=_0x2cbb87)return _0x464801(0x12b);common_1[_0x464801(0xc8)][_0x464801(0xcf)](_0x464801(0x199));const _0x45e2c8=await this['orderEntity'][_0x464801(0x12f)]({'where':{'orderId':_0x11d327[_0x464801(0x15a)],'status':0x0}});if(!_0x45e2c8)return'failed';const _0x36a63=_0x11d327[_0x464801(0x167)]==_0x464801(0x138)?0x1:0x2;common_1['Logger'][_0x464801(0xcf)](_0x464801(0x11f),_0x36a63);const _0x1b8c6f=await this['orderEntity'][_0x464801(0x182)]({'orderId':_0x11d327[_0x464801(0x15a)]},{'status':_0x36a63,'paydAt':new Date()});_0x36a63===0x1&&await this[_0x464801(0x15f)]['addBalanceToOrder'](_0x45e2c8);if(_0x1b8c6f[_0x464801(0x10c)]!=0x1)return _0x464801(0x12b);return _0x464801(0x101);}async['payMpay'](_0x4227bb,_0x2fed9a,_0x8670ad=_0x54b2a4(0x169)){const _0x5e4b9f=_0x54b2a4,_0x3d3184=await this[_0x5e4b9f(0x115)][_0x5e4b9f(0x12f)]({'where':{'userId':_0x4227bb,'orderId':_0x2fed9a}});if(!_0x3d3184)throw new common_1[(_0x5e4b9f(0xe5))]('订单不存在!',common_1[_0x5e4b9f(0x123)][_0x5e4b9f(0xd5)]);const _0x30403b=await this[_0x5e4b9f(0x156)][_0x5e4b9f(0x12f)]({'where':{'id':_0x3d3184[_0x5e4b9f(0x140)]}});if(!_0x30403b)throw new common_1[(_0x5e4b9f(0xe5))](_0x5e4b9f(0x126),common_1[_0x5e4b9f(0x123)]['BAD_REQUEST']);const {payMpayPid:_0x41ed30,payMpaySecret:_0x5c7bb2,payMpayNotifyUrl:_0x355712,payMpayReturnUrl:_0x19480b,payMpayApiPayUrl:_0x56b36f}=await this['globalConfigService']['getConfigs']([_0x5e4b9f(0xee),_0x5e4b9f(0x152),_0x5e4b9f(0x116),'payMpayReturnUrl',_0x5e4b9f(0x153)]),_0x2312f9={};_0x2312f9['pid']=Number(_0x41ed30),_0x2312f9['type']=_0x8670ad,_0x2312f9[_0x5e4b9f(0x15a)]=_0x2fed9a,_0x2312f9[_0x5e4b9f(0x170)]=_0x30403b[_0x5e4b9f(0x170)],_0x2312f9[_0x5e4b9f(0x104)]=_0x3d3184[_0x5e4b9f(0x139)],_0x2312f9[_0x5e4b9f(0x14c)]=_0x355712,_0x2312f9[_0x5e4b9f(0xc6)]=_0x19480b,_0x2312f9['sign']=this[_0x5e4b9f(0x134)](_0x2312f9,_0x5c7bb2),_0x2312f9[_0x5e4b9f(0xe4)]=_0x5e4b9f(0x136);const _0x69848c=new URLSearchParams(_0x2312f9)[_0x5e4b9f(0x151)](),_0x3c7fc5=_0x56b36f+'?'+_0x69848c;return{'url_qrcode':null,'redirectUrl':_0x3c7fc5,'channel':_0x8670ad,'isRedirect':!![]};const _0xd8792b=await axios_1[_0x5e4b9f(0xd0)][_0x5e4b9f(0x13f)](_0x56b36f,{'params':_0x2312f9});}async[_0x54b2a4(0x125)](_0x3b6932){const _0x5820ef=_0x54b2a4,{payMpayApiQueryUrl:_0x42242e}=await this[_0x5820ef(0x158)][_0x5820ef(0x172)]([_0x5820ef(0xee),'payMpaySecret','payMpayApiQueryUrl']),_0x11022b={};_0x11022b[_0x5820ef(0x180)]=0x2,_0x11022b[_0x5820ef(0x155)]=_0x3b6932;const {data:{code:_0x271ab2,msg:_0x909538,data:_0x385b76}}=await axios_1[_0x5820ef(0xd0)]['get'](_0x42242e,{'params':_0x11022b});if(_0x271ab2!=0x1)throw new common_1['HttpException'](_0x909538,common_1['HttpStatus'][_0x5820ef(0xd5)]);return _0x385b76;}async[_0x54b2a4(0xd7)](_0xe170b3){const _0x46a4ea=_0x54b2a4;common_1[_0x46a4ea(0xc8)][_0x46a4ea(0xcf)](_0x46a4ea(0xed),_0xe170b3);const {payWeChatAppId:_0x4bec73,payWeChatMchId:_0x93ae,payWeChatSecret:_0x3d9bbc,payWeChatPublicKey:_0x28283f,payWeChatPrivateKey:_0x14b141}=await this['globalConfigService'][_0x46a4ea(0x172)](['payWeChatAppId','payWeChatMchId',_0x46a4ea(0x18c),'payWeChatPublicKey',_0x46a4ea(0x12a)]),_0x119215=new this[(_0x46a4ea(0x113))]({'appid':_0x4bec73,'mchid':_0x93ae,'publicKey':_0x28283f,'privateKey':_0x14b141});try{if(_0xe170b3[_0x46a4ea(0x18f)]=='TRANSACTION.SUCCESS'){const {ciphertext:_0x5cab88,associated_data:_0x339c7a,nonce:_0x5afb44}=_0xe170b3[_0x46a4ea(0x179)],_0x476d8d=_0x119215[_0x46a4ea(0xde)](_0x5cab88,_0x339c7a,_0x5afb44,_0x3d9bbc),_0x4f1c19=await this[_0x46a4ea(0x115)][_0x46a4ea(0x12f)]({'where':{'orderId':_0x476d8d[_0x46a4ea(0x15a)],'status':0x0}});if(!_0x4f1c19)return _0x46a4ea(0x12b);const _0x2f1603=_0x476d8d[_0x46a4ea(0xe7)]=='SUCCESS'?0x1:0x2,_0x407608=await this[_0x46a4ea(0x115)]['update']({'orderId':_0x476d8d[_0x46a4ea(0x15a)]},{'status':_0x2f1603,'paydAt':new Date()});_0x2f1603===0x1&&await this['userBalanceService'][_0x46a4ea(0x173)](_0x4f1c19);if(_0x407608[_0x46a4ea(0x10c)]!=0x1)return _0x46a4ea(0x12b);}return _0x46a4ea(0x101);}catch(_0x31d5b6){return common_1['Logger'][_0x46a4ea(0xcf)](_0x46a4ea(0xe3),_0x31d5b6),common_1['Logger'][_0x46a4ea(0xcf)](_0x46a4ea(0x18e),_0x31d5b6),_0x46a4ea(0x12b);}}async[_0x54b2a4(0x112)](_0x1c317f,_0x273999,_0x17fb44='native'){const _0x28817d=_0x54b2a4;var _0x5721ae,_0x361b67,_0x4d9c49,_0x489923,_0x52d683,_0x13dd6d,_0x306827;common_1[_0x28817d(0xc8)]['log'](_0x28817d(0x106),_0x17fb44);const _0x2dcd62=await this['orderEntity']['findOne']({'where':{'userId':_0x1c317f,'orderId':_0x273999}});if(!_0x2dcd62)throw new common_1[(_0x28817d(0xe5))](_0x28817d(0x17f),common_1['HttpStatus'][_0x28817d(0xd5)]);const _0x5285dc=await this[_0x28817d(0x156)][_0x28817d(0x12f)]({'where':{'id':_0x2dcd62[_0x28817d(0x140)]}});if(!_0x5285dc)throw new common_1[(_0x28817d(0xe5))](_0x28817d(0x126),common_1[_0x28817d(0x123)][_0x28817d(0xd5)]);const {payWeChatAppId:_0x2be056,payWeChatMchId:_0x5bbdea,payWeChatPublicKey:_0x59b009,payWeChatPrivateKey:_0x4a5148,payWeChatNotifyUrl:_0x5bd330}=await this[_0x28817d(0x158)][_0x28817d(0x172)]([_0x28817d(0xfc),_0x28817d(0x168),_0x28817d(0x17d),_0x28817d(0x12a),'payWeChatNotifyUrl']),_0x2d1929=new this['WxPay']({'appid':_0x2be056,'mchid':_0x5bbdea,'publicKey':_0x59b009,'privateKey':_0x4a5148}),_0x57ab7c={'appid':_0x2be056,'mchid':_0x5bbdea,'description':_0x5285dc[_0x28817d(0x170)],'out_trade_no':_0x273999,'notify_url':_0x5bd330,'amount':{'total':Math[_0x28817d(0x161)](_0x2dcd62[_0x28817d(0x139)]*0x64)}};common_1[_0x28817d(0xc8)][_0x28817d(0xcf)]('wechat-pay:\x20',_0x57ab7c);if(_0x17fb44==_0x28817d(0x128)){common_1['Logger'][_0x28817d(0xcf)](_0x28817d(0x12e)+_0x1c317f+_0x28817d(0x129)+_0x273999);const _0x4d3e04=await this[_0x28817d(0xdf)]['getOpenIdByUserId'](_0x1c317f);common_1[_0x28817d(0xc8)][_0x28817d(0xcf)](_0x28817d(0xd4)+_0x4d3e04),_0x57ab7c[_0x28817d(0xca)]={'openid':_0x4d3e04},common_1['Logger'][_0x28817d(0xcf)](_0x28817d(0x10b),JSON[_0x28817d(0xff)](_0x57ab7c,null,0x2));try{const _0xeedb40=await _0x2d1929[_0x28817d(0x118)](_0x57ab7c),_0x4b9344=_0xeedb40[_0x28817d(0x133)]?_0xeedb40[_0x28817d(0x133)]:_0xeedb40;return common_1[_0x28817d(0xc8)]['log'](_0x28817d(0xc9),JSON['stringify'](_0x4b9344,null,0x2)),{'status':_0xeedb40['status']||_0x28817d(0x144),'appId':_0x4b9344[_0x28817d(0x10f)]||((_0x5721ae=_0x4b9344[_0x28817d(0x133)])===null||_0x5721ae===void 0x0?void 0x0:_0x5721ae[_0x28817d(0x10f)]),'timeStamp':_0x4b9344['timeStamp']||((_0x361b67=_0x4b9344[_0x28817d(0x133)])===null||_0x361b67===void 0x0?void 0x0:_0x361b67[_0x28817d(0x122)]),'nonceStr':_0x4b9344['nonceStr']||((_0x4d9c49=_0x4b9344[_0x28817d(0x133)])===null||_0x4d9c49===void 0x0?void 0x0:_0x4d9c49[_0x28817d(0x120)]),'package':_0x4b9344[_0x28817d(0x17e)]||((_0x489923=_0x4b9344[_0x28817d(0x133)])===null||_0x489923===void 0x0?void 0x0:_0x489923['package']),'signType':_0x4b9344[_0x28817d(0x15c)]||((_0x52d683=_0x4b9344[_0x28817d(0x133)])===null||_0x52d683===void 0x0?void 0x0:_0x52d683[_0x28817d(0x15c)]),'paySign':_0x4b9344['paySign']||((_0x13dd6d=_0x4b9344[_0x28817d(0x133)])===null||_0x13dd6d===void 0x0?void 0x0:_0x13dd6d['paySign'])};}catch(_0x9bba56){console[_0x28817d(0x12d)](_0x28817d(0xdc)+_0x9bba56[_0x28817d(0x100)],_0x9bba56),console['error']('[WeChat\x20Pay\x20JSAPI]\x20完整的错误对象：',_0x9bba56);throw new common_1[(_0x28817d(0xe5))](_0x28817d(0x10d),common_1[_0x28817d(0x123)]['BAD_REQUEST']);}}if(_0x17fb44==_0x28817d(0x137)){common_1['Logger'][_0x28817d(0xcf)]('开始进行微信Native支付流程，订单ID:\x20'+_0x273999+_0x28817d(0x16d)+_0x1c317f);try{const _0x371323=await _0x2d1929[_0x28817d(0x143)](_0x57ab7c);common_1[_0x28817d(0xc8)][_0x28817d(0xcf)]('微信Native支付响应数据:\x20',JSON[_0x28817d(0xff)](_0x371323,null,0x2));let _0x5dcc05=_0x371323[_0x28817d(0x14d)]||((_0x306827=_0x371323['data'])===null||_0x306827===void 0x0?void 0x0:_0x306827[_0x28817d(0x14d)]);return!_0x5dcc05?console[_0x28817d(0x12d)](_0x28817d(0xcc),JSON['stringify'](_0x371323,null,0x2)):common_1[_0x28817d(0xc8)]['log']('微信Native支付请求成功，code_url:\x20'+_0x5dcc05),{'url_qrcode':_0x5dcc05,'isRedirect':![]};}catch(_0x27817a){console[_0x28817d(0x12d)](_0x28817d(0xd1)+_0x27817a['message'],_0x27817a),console['error'](_0x28817d(0x13b),_0x27817a);throw new common_1['HttpException']('微信Native支付失败',common_1[_0x28817d(0x123)][_0x28817d(0xd5)]);}}else{console[_0x28817d(0x13c)](_0x28817d(0xf6)+_0x17fb44);throw new common_1[(_0x28817d(0xe5))]('unsupported\x20pay\x20type',common_1[_0x28817d(0x123)][_0x28817d(0xd5)]);}}async[_0x54b2a4(0x190)](_0x37ab8d){const _0x52b66c=_0x54b2a4,{payWeChatAppId:_0x53765a,payWeChatMchId:_0x4b656f,payWeChatPublicKey:_0x2af3ed,payWeChatPrivateKey:_0x39a8a1,payWeChatNotifyUrl:_0x2a873c}=await this['globalConfigService']['getConfigs']([_0x52b66c(0xfc),_0x52b66c(0x168),_0x52b66c(0x17d),'payWeChatPrivateKey']),_0x42cd84=new this[(_0x52b66c(0x113))]({'appid':_0x53765a,'mchid':_0x4b656f,'publicKey':_0x2af3ed,'privateKey':_0x39a8a1}),_0x4c9963=await _0x42cd84[_0x52b66c(0x18d)]({'out_trade_no':_0x37ab8d});return _0x4c9963;}['sign'](_0xabcb39,_0x5973ba){const _0xb4a3a0=_0x54b2a4,_0x3c51ce=Object[_0xb4a3a0(0x11a)](_0xabcb39)[_0xb4a3a0(0xf9)]()[_0xb4a3a0(0xd2)](_0x20f9ba=>_0x20f9ba+'='+_0xabcb39[_0x20f9ba])[_0xb4a3a0(0x10a)]('&')+_0x5973ba;return crypto[_0xb4a3a0(0xf5)](_0xb4a3a0(0x11e))[_0xb4a3a0(0x182)](_0x3c51ce)[_0xb4a3a0(0x160)](_0xb4a3a0(0x148));}[_0x54b2a4(0xfe)](_0x4a760f,_0x4adaf3){const _0x228967=_0x54b2a4,_0x4869e1=Object[_0x228967(0x11a)](_0x4a760f);_0x4869e1[_0x228967(0xf9)]();const _0x1cf40e=[];_0x4869e1[_0x228967(0xd2)](_0x3b892f=>{const _0xef46df=_0x228967;_0x1cf40e[_0xef46df(0xd3)](_0x3b892f+'='+_0x4a760f[_0x3b892f]);}),_0x1cf40e['push'](_0x228967(0x188)+_0x4adaf3);const _0x4b9011=_0x1cf40e['join']('&');return crypto['createHash'](_0x228967(0x11e))[_0x228967(0x182)](_0x4b9011)[_0x228967(0x160)](_0x228967(0x148))[_0x228967(0x193)]();}async['payLtzf'](_0x47814e,_0x3d2d07,_0xabe338=_0x54b2a4(0x169)){const _0x30ec2=_0x54b2a4,_0x552b09=await this['orderEntity'][_0x30ec2(0x12f)]({'where':{'userId':_0x47814e,'orderId':_0x3d2d07}});if(!_0x552b09)throw new common_1['HttpException']('订单不存在!',common_1[_0x30ec2(0x123)]['BAD_REQUEST']);const _0x5862bd=await this[_0x30ec2(0x156)][_0x30ec2(0x12f)]({'where':{'id':_0x552b09[_0x30ec2(0x140)]}});if(!_0x5862bd)throw new common_1[(_0x30ec2(0xe5))](_0x30ec2(0x126),common_1[_0x30ec2(0x123)][_0x30ec2(0xd5)]);const {payLtzfMchId:_0xf8ed61,payLtzfSecret:_0x3423a0,payLtzfNotifyUrl:_0x37f3c1,payLtzfReturnUrl:_0x218f91}=await this['globalConfigService'][_0x30ec2(0x172)](['payLtzfMchId',_0x30ec2(0x15d),_0x30ec2(0x11b),_0x30ec2(0x163)]),_0x46c38d={};_0x46c38d[_0x30ec2(0x130)]=_0xf8ed61,_0x46c38d[_0x30ec2(0xe6)]=(Date['now']()/0x3e8)[_0x30ec2(0x111)](0x0),_0x46c38d['out_trade_no']=_0x3d2d07,_0x46c38d[_0x30ec2(0xcd)]=_0x5862bd[_0x30ec2(0x170)],_0x46c38d[_0x30ec2(0x171)]=_0x552b09[_0x30ec2(0x139)],_0x46c38d[_0x30ec2(0x14c)]=_0x37f3c1,_0x46c38d[_0x30ec2(0x134)]=this[_0x30ec2(0xfe)](_0x46c38d,_0x3423a0),_0x46c38d[_0x30ec2(0x14e)]=_0x30ec2(0xeb),_0x46c38d[_0x30ec2(0xc6)]=_0x218f91;const _0x4744c2=Object[_0x30ec2(0x11a)](_0x46c38d)[_0x30ec2(0xd2)](_0x5b163f=>encodeURIComponent(_0x5b163f)+'='+encodeURIComponent(_0x46c38d[_0x5b163f]))['join']('&'),_0x5c5e71={'headers':{'Content-Type':_0x30ec2(0x164)}},_0x1f28a8=await axios_1[_0x30ec2(0xd0)][_0x30ec2(0x14b)]('https://api.ltzf.cn/api/wxpay/jsapi_convenient',_0x4744c2,_0x5c5e71),{code:_0x25ad26,data:_0x5f87f9,msg:_0x4d50a2}=_0x1f28a8['data'];if(_0x25ad26!=0x0)throw new common_1[(_0x30ec2(0xe5))](_0x4d50a2,common_1[_0x30ec2(0x123)]['BAD_REQUEST']);const _0x202ca7=_0x5f87f9[_0x30ec2(0x16a)],_0x2b77fa=_0x5f87f9['order_url'];return{'url_qrcode':_0x202ca7,'url':_0x2b77fa};}async[_0x54b2a4(0xe0)](_0xaf49eb){const _0x4f3d9c=_0x54b2a4,{payLtzfMchId:_0x291588,payLtzfSecret:_0x1c4e31}=await this[_0x4f3d9c(0x158)]['getConfigs']([_0x4f3d9c(0x150),_0x4f3d9c(0x15d)]),_0x4b6cdb={};_0x4b6cdb[_0x4f3d9c(0x130)]=_0x291588,_0x4b6cdb[_0x4f3d9c(0xe6)]=(Date[_0x4f3d9c(0x195)]()/0x3e8)[_0x4f3d9c(0x111)](0x0),_0x4b6cdb[_0x4f3d9c(0x15a)]=_0xaf49eb,_0x4b6cdb[_0x4f3d9c(0x134)]=this[_0x4f3d9c(0xfe)](_0x4b6cdb,_0x1c4e31);const _0x166a1e=Object[_0x4f3d9c(0x11a)](_0x4b6cdb)['map'](_0x1659fd=>encodeURIComponent(_0x1659fd)+'='+encodeURIComponent(_0x4b6cdb[_0x1659fd]))[_0x4f3d9c(0x10a)]('&'),_0x41030b={'headers':{'Content-Type':_0x4f3d9c(0x164)}},{data:{code:_0x374210,msg:_0x274548,data:_0x4f3651}}=await axios_1[_0x4f3d9c(0xd0)]['post'](_0x4f3d9c(0x196),_0x166a1e,_0x41030b);if(_0x374210!=0x0)throw new common_1[(_0x4f3d9c(0xe5))](_0x274548+JSON['stringify'](_0x4b6cdb),common_1['HttpStatus'][_0x4f3d9c(0xd5)]);return _0x4f3651;}async['notifyLtzf'](_0x158dba){const _0x117301=_0x54b2a4,_0x2ddabb=await this[_0x117301(0x158)]['getConfigs']([_0x117301(0x15d)]),_0x40117a=_0x158dba[_0x117301(0x134)];delete _0x158dba[_0x117301(0x134)],delete _0x158dba[_0x117301(0x107)],delete _0x158dba[_0x117301(0xef)],delete _0x158dba[_0x117301(0x17b)],delete _0x158dba['attach'],delete _0x158dba[_0x117301(0x183)];if(this['ltzfSign'](_0x158dba,_0x2ddabb)!=_0x40117a)return'FAIL';const _0x31a90c=await this[_0x117301(0x115)]['findOne']({'where':{'orderId':_0x158dba[_0x117301(0x15a)],'status':0x0}});if(!_0x31a90c)return _0x117301(0xda);await this[_0x117301(0x15f)][_0x117301(0x173)](_0x31a90c);const _0x286996=await this['orderEntity']['update']({'orderId':_0x158dba['out_trade_no']},{'status':0x1,'paydAt':new Date()});if(_0x286996[_0x117301(0x10c)]!=0x1)return _0x117301(0xda);return _0x117301(0xf0);}};PayService=__decorate([(0x0,common_1[_0x54b2a4(0x149)])(),__param(0x0,(0x0,typeorm_1[_0x54b2a4(0x197)])(cramiPackage_entity_1[_0x54b2a4(0x185)])),__param(0x1,(0x0,typeorm_1[_0x54b2a4(0x197)])(order_entity_1[_0x54b2a4(0x17c)])),__metadata(_0x54b2a4(0x117),[typeorm_2[_0x54b2a4(0x121)],typeorm_2[_0x54b2a4(0x121)],userBalance_service_1[_0x54b2a4(0x192)],globalConfig_service_1[_0x54b2a4(0x119)],user_service_1[_0x54b2a4(0x108)]])],PayService),exports[_0x54b2a4(0xd8)]=PayService;function _0x4962(){const _0xfb9fcb=['metadata','172970uVlRTb','1KUOOcq','hex','Injectable','payMpay','post','notify_url','code_url','attach','payHupi','payLtzfMchId','toString','payMpaySecret','payMpayApiPayUrl','hupi','order_no','cramiPackageEntity','本次支付类型:\x20','globalConfigService','order','out_trade_no','pid','signType','payLtzfSecret','payEpayApiPayUrl','userBalanceService','digest','round','支付请求失败!','payLtzfReturnUrl','application/x-www-form-urlencoded','decorate','notifyHupi','trade_status','payWeChatMchId','wxpay','QRcode_url','898485TGNnpj','defineProperty',',\x20用户ID:\x20','epay','hash','name','total_fee','getConfigs','addBalanceToOrder','payEpayReturnUrl','time','notifyEpay','payHupiNotifyUrl','https://api.xunhupay.com/payment/do.html','resource','1603380nfzPjG','success_time','OrderEntity','payWeChatPublicKey','package','订单不存在!','type','payHupiGatewayUrl','update','openid','1525111cCcLkb','CramiPackageEntity','length','trade_order_id','key=','2261658foDNXb','title','payEpayApiQueryUrl','payWeChatSecret','query','支付通知验证失败:\x20','event_type','queryWeChat','param','UserBalanceService','toUpperCase','queryEpay','now','https://api.ltzf.cn/api/wxpay/get_pay_order','InjectRepository','__decorate','校验签名通过','axios','payLtzf','return_url','onModuleInit','Logger','[WeChat\x20Pay\x20JSAPI]\x20支付请求成功，返回结果:\x20','payer','wechatpay-node-v3','微信Native支付请求成功，但未返回code_url，响应数据:\x20','body','function','log','default','微信Native支付过程中发生错误，错误信息:\x20','map','push','[WeChat\x20Pay\x20JSAPI]\x20用户OpenID:\x20','BAD_REQUEST','@nestjs/typeorm','notifyWeChat','PayService','payEpaySecret','FAIL','https://api.xunhupay.com/payment/query.html','[WeChat\x20Pay\x20JSAPI]\x20支付请求过程中发生错误:\x20','../../common/utils','decipher_gcm','userService','queryLtzf','typeorm','key','error:\x20','sign_type','HttpException','timestamp','trade_state','createRandomNonceStr','__metadata','submit.php','ltzf','object','微信支付通知params:\x20','payMpayPid','trade_type','SUCCESS','device','out_trade_order','校验签名','payHupiSecret','createHash','支付请求使用了不支持的支付类型:\x20','192.168.1.100','../globalConfig/globalConfig.service','sort','payEpayPid','payEpay','payWeChatAppId','pay','ltzfSign','stringify','message','success','nonce_str','../crami/cramiPackage.entity','money','15664vxteYf','payType:\x20','pay_channel','UserService','1.1','join','[WeChat\x20Pay\x20JSAPI]\x20发送支付请求参数:\x20','affected','JSAPI支付失败','wechat','appId','../user/user.service','toFixed','payWeChat','WxPay','notifyLtzf','orderEntity','payMpayNotifyUrl','design:paramtypes','transactions_jsapi','GlobalConfigService','keys','payLtzfNotifyUrl','version','notifyMpay','md5','status:\x20','nonceStr','Repository','timeStamp','HttpStatus','alipay','queryMpay','套餐不存在!','721438kXQweE','jsapi',',\x20订单ID:\x20','payWeChatPrivateKey','failed','includes','error','[WeChat\x20Pay\x20JSAPI]\x20开始JSAPI支付流程，用户ID:\x20','findOne','mch_id','epay\x20--->\x20res:\x20','../order/order.entity','data','sign','mpay','MD5','native','TRADE_SUCCESS','total','payPlatform','完整的错误对象：','warn','__esModule','@nestjs/common','get','goodsId','appid','queryHupi','transactions_native','unknown'];_0x4962=function(){return _0xfb9fcb;};return _0x4962();}