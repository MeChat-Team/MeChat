'use strict';const _0x5a2045=_0x49f6;(function(_0x43bb58,_0x530722){const _0x414f40=_0x49f6,_0x12f41d=_0x43bb58();while(!![]){try{const _0x2b0710=-parseInt(_0x414f40(0x1d7))/0x1+parseInt(_0x414f40(0x21c))/0x2+-parseInt(_0x414f40(0x26d))/0x3*(parseInt(_0x414f40(0x20a))/0x4)+parseInt(_0x414f40(0x22c))/0x5*(parseInt(_0x414f40(0x243))/0x6)+parseInt(_0x414f40(0x232))/0x7*(-parseInt(_0x414f40(0x259))/0x8)+-parseInt(_0x414f40(0x239))/0x9+parseInt(_0x414f40(0x221))/0xa;if(_0x2b0710===_0x530722)break;else _0x12f41d['push'](_0x12f41d['shift']());}catch(_0x22dfb8){_0x12f41d['push'](_0x12f41d['shift']());}}}(_0xf292,0x2f3a6));var __decorate=this&&this['__decorate']||function(_0x5eb52f,_0x3fb476,_0xe90c67,_0x329913){const _0x427bfe=_0x49f6;var _0x3d106a=arguments['length'],_0x34a209=_0x3d106a<0x3?_0x3fb476:_0x329913===null?_0x329913=Object[_0x427bfe(0x280)](_0x3fb476,_0xe90c67):_0x329913,_0xe50fd2;if(typeof Reflect===_0x427bfe(0x1cd)&&typeof Reflect['decorate']===_0x427bfe(0x231))_0x34a209=Reflect[_0x427bfe(0x235)](_0x5eb52f,_0x3fb476,_0xe90c67,_0x329913);else{for(var _0x28b976=_0x5eb52f[_0x427bfe(0x270)]-0x1;_0x28b976>=0x0;_0x28b976--)if(_0xe50fd2=_0x5eb52f[_0x28b976])_0x34a209=(_0x3d106a<0x3?_0xe50fd2(_0x34a209):_0x3d106a>0x3?_0xe50fd2(_0x3fb476,_0xe90c67,_0x34a209):_0xe50fd2(_0x3fb476,_0xe90c67))||_0x34a209;}return _0x3d106a>0x3&&_0x34a209&&Object[_0x427bfe(0x1f1)](_0x3fb476,_0xe90c67,_0x34a209),_0x34a209;},__metadata=this&&this[_0x5a2045(0x1ba)]||function(_0x3536c3,_0x151e7a){const _0x37a4e3=_0x5a2045;if(typeof Reflect===_0x37a4e3(0x1cd)&&typeof Reflect[_0x37a4e3(0x1de)]===_0x37a4e3(0x231))return Reflect[_0x37a4e3(0x1de)](_0x3536c3,_0x151e7a);},__param=this&&this[_0x5a2045(0x215)]||function(_0x4cc3e8,_0x5de2a5){return function(_0x32e0ae,_0x16358f){_0x5de2a5(_0x32e0ae,_0x16358f,_0x4cc3e8);};};Object[_0x5a2045(0x1f1)](exports,_0x5a2045(0x1fc),{'value':!![]}),exports[_0x5a2045(0x249)]=void 0x0;function _0x49f6(_0x2281c3,_0x239b12){const _0xf2922b=_0xf292();return _0x49f6=function(_0x49f634,_0x2d63bd){_0x49f634=_0x49f634-0x1b6;let _0x28cf1d=_0xf2922b[_0x49f634];return _0x28cf1d;},_0x49f6(_0x2281c3,_0x239b12);}function _0xf292(){const _0x3afe73=['nonce_str','[WeChat\x20Pay\x20JSAPI]\x20用户OpenID:\x20','appid','trade_status','../crami/cramiPackage.entity','getOwnPropertyDescriptor','https://api.ltzf.cn/api/wxpay/get_pay_order','log','notifyEpay','ltzf','keys','__metadata','payWeChat','total','套餐不存在!','FAIL','支付请求失败:\x20','queryMpay','sort','UserService','payWeChatNotifyUrl','toUpperCase','toFixed','payPlatform','payMpay','transactions_jsapi','HttpException','push','校验签名通过','支付请求使用了不支持的支付类型:\x20','object','package','jsapi','importDynamic','payType:\x20','act','findOne','nonceStr','goodsId','pay','375129zRBnxX','status','queryHupi','ltzfSign','order_url','message','BAD_REQUEST','metadata','pid','订单不存在!','total_fee','trade_state','epay','order_no','join','payLtzf','unsupported\x20pay\x20type','notifyHupi','../user/user.service','now','native','payHupiSecret','onModuleInit','微信Native支付响应数据:\x20','application/x-www-form-urlencoded','success','defineProperty','../order/order.entity','[WeChat\x20Pay\x20JSAPI]\x20完整的错误对象：','digest','MD5','crypto','map','queryWeChat','Logger','device','https://api.xunhupay.com/payment/query.html','__esModule','paySign','failed','完整的错误对象：','payLtzfMchId','hupi','payMpayApiPayUrl','stringify','payer','query','code_url','InjectRepository','payWeChatSecret','attach','1588vZJZUe','title','affected','update','SUCCESS','notifyLtzf','TRADE_SUCCESS','开始进行微信Native支付流程，订单ID:\x20','@nestjs/typeorm',',\x20订单ID:\x20','payWeChatAppId','__param','status:\x20','sign','../../common/utils','trade_order_id','payWeChatPrivateKey','timestamp','114508ZspbRt','addBalanceToOrder','getConfigs','userService','notifyWeChat','13097600oCSaCv','本次支付类型:\x20','payMpayApiQueryUrl','openid','decipher_gcm','payMpayReturnUrl','wechatpay-node-v3','userBalanceService','微信Native支付过程中发生错误，错误信息:\x20','type','axios','85sjpdjh','https://api.xunhupay.com/payment/do.html','wxpay','JSAPI支付失败','WxPay','function','15442FanfBH','error:\x20','cramiPackageEntity','decorate','orderEntity','HttpStatus','out_trade_order','2660967dBNejR','payMpayPid','校验签名','payHupiAppId','payMpaySecret','[WeChat\x20Pay\x20JSAPI]\x20支付请求过程中发生错误:\x20','mch_id','payEpayReturnUrl','sign_type','event_type','822SjfDsM','createRandomNonceStr','QRcode_url','includes','timeStamp','globalConfigService','PayService','支付请求失败!','out_trade_no','[WeChat\x20Pay\x20JSAPI]\x20支付请求成功，返回结果:\x20','post','data','支付通知验证失败:\x20','hex','order','warn','name','wechat-pay:\x20','@nestjs/common','toString','Injectable','payWeChatMchId','1384ipASYK','clientip','money','createHash','hash','error','payEpayNotifyUrl','queryLtzf','version','payLtzfSecret','payLtzfNotifyUrl','notify_url','get','success_time','payEpay','signType','payHupi','time','微信Native支付请求成功，code_url:\x20','Repository','933VVQNts','return_url','payHupiGatewayUrl','length','payEpaySecret','1.1','design:paramtypes','payWeChatPublicKey','param','default','appId','UserBalanceService','notify','key='];_0xf292=function(){return _0x3afe73;};return _0xf292();}const utils_1=require(_0x5a2045(0x218)),common_1=require(_0x5a2045(0x255)),typeorm_1=require(_0x5a2045(0x212)),axios_1=require(_0x5a2045(0x22b)),crypto=require(_0x5a2045(0x1f6)),typeorm_2=require('typeorm'),cramiPackage_entity_1=require(_0x5a2045(0x27f)),globalConfig_service_1=require('../globalConfig/globalConfig.service'),order_entity_1=require(_0x5a2045(0x1f2)),user_service_1=require(_0x5a2045(0x1e9)),userBalance_service_1=require('../userBalance/userBalance.service');let PayService=class PayService{constructor(_0x150af0,_0x424dad,_0x1dbb40,_0xe6abd3,_0x4e01a4){const _0x2009fb=_0x5a2045;this[_0x2009fb(0x234)]=_0x150af0,this['orderEntity']=_0x424dad,this[_0x2009fb(0x228)]=_0x1dbb40,this[_0x2009fb(0x248)]=_0xe6abd3,this[_0x2009fb(0x21f)]=_0x4e01a4;}async[_0x5a2045(0x1ed)](){const _0x333480=_0x5a2045,_0x2fab6d=await(0x0,utils_1[_0x333480(0x1d0)])(_0x333480(0x227));this[_0x333480(0x230)]=(_0x2fab6d===null||_0x2fab6d===void 0x0?void 0x0:_0x2fab6d[_0x333480(0x276)])?_0x2fab6d['default']:_0x2fab6d;}async[_0x5a2045(0x279)](_0x561b96){const _0x312c57=_0x5a2045;if(_0x561b96[_0x312c57(0x275)]==_0x312c57(0x1e3))return this[_0x312c57(0x1b7)](_0x561b96);if(_0x561b96[_0x312c57(0x209)]==_0x312c57(0x201))return this[_0x312c57(0x1e8)](_0x561b96);if(_0x561b96[_0x312c57(0x209)]==_0x312c57(0x1b8))return this[_0x312c57(0x20f)](_0x561b96);if(typeof _0x561b96['resource']==_0x312c57(0x1cd))return this[_0x312c57(0x220)](_0x561b96);return this['notifyMpay'](_0x561b96);}async[_0x5a2045(0x1d6)](_0x3418a3,_0x34a08e,_0x293dff=_0x5a2045(0x22e)){const _0x3e7dc4=_0x5a2045,_0xf0bc01=await this[_0x3e7dc4(0x236)][_0x3e7dc4(0x1d3)]({'where':{'userId':_0x3418a3,'orderId':_0x34a08e}});if(!_0xf0bc01)throw new common_1['HttpException']('订单不存在!',common_1[_0x3e7dc4(0x237)][_0x3e7dc4(0x1dd)]);const _0x253fb7=await this[_0x3e7dc4(0x234)][_0x3e7dc4(0x1d3)]({'where':{'id':_0xf0bc01[_0x3e7dc4(0x1d5)]}});if(!_0x253fb7)throw new common_1[(_0x3e7dc4(0x1c9))](_0x3e7dc4(0x1bd),common_1['HttpStatus']['BAD_REQUEST']);common_1[_0x3e7dc4(0x1f9)][_0x3e7dc4(0x1b6)](_0x3e7dc4(0x222),_0xf0bc01[_0x3e7dc4(0x1c6)]);try{if(_0xf0bc01[_0x3e7dc4(0x1c6)]=='wechat')return this[_0x3e7dc4(0x1bb)](_0x3418a3,_0x34a08e,_0x293dff);if(_0xf0bc01[_0x3e7dc4(0x1c6)]==_0x3e7dc4(0x1e3))return this[_0x3e7dc4(0x267)](_0x3418a3,_0x34a08e,_0x293dff);if(_0xf0bc01[_0x3e7dc4(0x1c6)]=='mpay')return this[_0x3e7dc4(0x1c7)](_0x3418a3,_0x34a08e,_0x293dff);if(_0xf0bc01[_0x3e7dc4(0x1c6)]==_0x3e7dc4(0x201))return this[_0x3e7dc4(0x269)](_0x3418a3,_0x34a08e,_0x293dff);if(_0xf0bc01[_0x3e7dc4(0x1c6)]==_0x3e7dc4(0x1b8))return this[_0x3e7dc4(0x1e6)](_0x3418a3,_0x34a08e,_0x293dff);}catch(_0x413678){common_1[_0x3e7dc4(0x1f9)][_0x3e7dc4(0x1b6)](_0x3e7dc4(0x1bf),_0x413678);throw new common_1[(_0x3e7dc4(0x1c9))](_0x3e7dc4(0x24a),common_1[_0x3e7dc4(0x237)][_0x3e7dc4(0x1dd)]);}}async[_0x5a2045(0x205)](_0x5cfd9a){const _0x3ae839=_0x5a2045,_0x5159ef=await this[_0x3ae839(0x236)]['findOne']({'where':{'orderId':_0x5cfd9a}});if(!_0x5159ef)throw new common_1[(_0x3ae839(0x1c9))](_0x3ae839(0x1e0),common_1['HttpStatus'][_0x3ae839(0x1dd)]);return _0x5159ef;}async[_0x5a2045(0x1e8)](_0x37104f){const _0x42f20e=_0x5a2045,_0x193bc7=await this[_0x42f20e(0x248)][_0x42f20e(0x21e)]([_0x42f20e(0x1ec)]),_0x27b81f=_0x37104f[_0x42f20e(0x25d)];delete _0x37104f[_0x42f20e(0x25d)];if(this['sign'](_0x37104f,_0x193bc7)!=_0x27b81f)return _0x42f20e(0x1fe);const _0x754eef=await this[_0x42f20e(0x236)]['findOne']({'where':{'orderId':_0x37104f[_0x42f20e(0x219)],'status':0x0}});if(!_0x754eef)return _0x42f20e(0x1fe);await this[_0x42f20e(0x228)][_0x42f20e(0x21d)](_0x754eef);const _0x6a2a11=await this[_0x42f20e(0x236)][_0x42f20e(0x20d)]({'orderId':_0x37104f[_0x42f20e(0x219)]},{'status':0x1,'paydAt':new Date()});if(_0x6a2a11[_0x42f20e(0x20c)]!=0x1)return _0x42f20e(0x1fe);return _0x42f20e(0x1f0);}async['payHupi'](_0x8c057,_0x17327a,_0x2e5148=_0x5a2045(0x22e)){const _0x3b3b7c=_0x5a2045,_0x1886eb=await this[_0x3b3b7c(0x236)][_0x3b3b7c(0x1d3)]({'where':{'userId':_0x8c057,'orderId':_0x17327a}});if(!_0x1886eb)throw new common_1['HttpException'](_0x3b3b7c(0x1e0),common_1['HttpStatus'][_0x3b3b7c(0x1dd)]);const _0x299e4a=await this[_0x3b3b7c(0x234)][_0x3b3b7c(0x1d3)]({'where':{'id':_0x1886eb[_0x3b3b7c(0x1d5)]}});if(!_0x299e4a)throw new common_1[(_0x3b3b7c(0x1c9))](_0x3b3b7c(0x1bd),common_1[_0x3b3b7c(0x237)][_0x3b3b7c(0x1dd)]);const {payHupiAppId:_0x1a1fc8,payHupiSecret:_0x357816,payHupiNotifyUrl:_0x4b4843,payHupiReturnUrl:_0x5437b0,payHupiGatewayUrl:_0xf53193}=await this['globalConfigService'][_0x3b3b7c(0x21e)](['payHupiAppId',_0x3b3b7c(0x1ec),'payHupiNotifyUrl','payHupiReturnUrl',_0x3b3b7c(0x26f)]),_0x14688c={};_0x14688c['version']=_0x3b3b7c(0x272),_0x14688c[_0x3b3b7c(0x27d)]=_0x1a1fc8,_0x14688c[_0x3b3b7c(0x26a)]=(Date[_0x3b3b7c(0x1ea)]()/0x3e8)[_0x3b3b7c(0x1c5)](0x0),_0x14688c[_0x3b3b7c(0x27b)]=(0x0,utils_1[_0x3b3b7c(0x244)])(0x20),_0x14688c[_0x3b3b7c(0x219)]=_0x17327a,_0x14688c[_0x3b3b7c(0x20b)]=_0x299e4a[_0x3b3b7c(0x253)],_0x14688c['total_fee']=_0x1886eb['total'],_0x14688c[_0x3b3b7c(0x264)]=_0x4b4843,_0x14688c[_0x3b3b7c(0x26e)]=_0x5437b0,_0x14688c[_0x3b3b7c(0x209)]=_0x3b3b7c(0x201),_0x14688c[_0x3b3b7c(0x25d)]=this[_0x3b3b7c(0x217)](_0x14688c,_0x357816);const {data:{errcode:_0x468e39,errmsg:_0x494cae,url_qrcode:_0x523c29,url:_0x47bf45}}=await axios_1[_0x3b3b7c(0x276)][_0x3b3b7c(0x24d)](_0xf53193||_0x3b3b7c(0x22d),_0x14688c);if(_0x468e39!=0x0)throw new common_1[(_0x3b3b7c(0x1c9))](_0x494cae,common_1[_0x3b3b7c(0x237)][_0x3b3b7c(0x1dd)]);return{'url_qrcode':_0x523c29,'url':_0x47bf45};}async[_0x5a2045(0x1d9)](_0x150100){const _0x27ead6=_0x5a2045,{payHupiAppId:_0x9ecd1c,payHupiSecret:_0x40c4c1}=await this['globalConfigService'][_0x27ead6(0x21e)]([_0x27ead6(0x23c),'payHupiSecret']),_0x5e653d={};_0x5e653d[_0x27ead6(0x261)]=_0x27ead6(0x272),_0x5e653d[_0x27ead6(0x27d)]=_0x9ecd1c,_0x5e653d[_0x27ead6(0x26a)]=(Date[_0x27ead6(0x1ea)]()/0x3e8)[_0x27ead6(0x1c5)](0x0),_0x5e653d[_0x27ead6(0x27b)]=(0x0,utils_1[_0x27ead6(0x244)])(0x20),_0x5e653d[_0x27ead6(0x238)]=_0x150100,_0x5e653d[_0x27ead6(0x25d)]=this[_0x27ead6(0x217)](_0x5e653d,_0x40c4c1);const {data:{errcode:_0x5f450d,errmsg:_0x36b080,data:_0x24b745}}=await axios_1[_0x27ead6(0x276)][_0x27ead6(0x24d)](_0x27ead6(0x1fb),_0x5e653d);if(_0x5f450d!=0x0)throw new common_1[(_0x27ead6(0x1c9))](_0x36b080,common_1['HttpStatus'][_0x27ead6(0x1dd)]);return _0x24b745;}async['notifyEpay'](_0x897121){const _0x453d4d=_0x5a2045,_0x970ee3=_0x897121['sign'];delete _0x897121['sign'],delete _0x897121[_0x453d4d(0x241)];const _0xc20f38=await this[_0x453d4d(0x248)][_0x453d4d(0x21e)]([_0x453d4d(0x271)]);if(this[_0x453d4d(0x217)](_0x897121,_0xc20f38)!=_0x970ee3)return _0x453d4d(0x1fe);common_1[_0x453d4d(0x1f9)][_0x453d4d(0x1b6)](_0x453d4d(0x1cb));const _0x4d7182=await this['orderEntity'][_0x453d4d(0x1d3)]({'where':{'orderId':_0x897121['out_trade_no'],'status':0x0}});if(!_0x4d7182)return'failed';const _0x1126f0=_0x897121[_0x453d4d(0x27e)]==_0x453d4d(0x210)?0x1:0x2,_0x134f33=await this[_0x453d4d(0x236)][_0x453d4d(0x20d)]({'orderId':_0x897121[_0x453d4d(0x24b)]},{'status':_0x1126f0,'paydAt':new Date()});_0x1126f0===0x1&&await this[_0x453d4d(0x228)][_0x453d4d(0x21d)](_0x4d7182);if(_0x134f33[_0x453d4d(0x20c)]!=0x1)return _0x453d4d(0x1fe);return _0x453d4d(0x1f0);}async[_0x5a2045(0x267)](_0x55355b,_0x230888,_0x4af29b='alipay'){const _0x4a78a6=_0x5a2045,_0x421759=await this[_0x4a78a6(0x236)][_0x4a78a6(0x1d3)]({'where':{'userId':_0x55355b,'orderId':_0x230888}});if(!_0x421759)throw new common_1['HttpException'](_0x4a78a6(0x1e0),common_1[_0x4a78a6(0x237)][_0x4a78a6(0x1dd)]);const _0x1b8a0e=await this[_0x4a78a6(0x234)][_0x4a78a6(0x1d3)]({'where':{'id':_0x421759[_0x4a78a6(0x1d5)]}});if(!_0x1b8a0e)throw new common_1[(_0x4a78a6(0x1c9))](_0x4a78a6(0x1bd),common_1['HttpStatus'][_0x4a78a6(0x1dd)]);const {payEpayPid:_0x2498bc,payEpaySecret:_0x3ea27f,payEpayNotifyUrl:_0x314376,payEpayReturnUrl:_0x12febf,payEpayApiPayUrl:_0x581430}=await this[_0x4a78a6(0x248)]['getConfigs'](['payEpayPid',_0x4a78a6(0x271),_0x4a78a6(0x25f),_0x4a78a6(0x240),'payEpayApiPayUrl']);let _0x2a7465;_0x2498bc[_0x4a78a6(0x270)]<=0x10?_0x2a7465=Number(_0x2498bc):_0x2a7465=BigInt(_0x2498bc);const _0x598008={};_0x598008[_0x4a78a6(0x1df)]=_0x2a7465,_0x598008['type']=_0x4af29b,_0x598008[_0x4a78a6(0x24b)]=_0x230888,_0x598008['name']=_0x1b8a0e['name'],_0x598008[_0x4a78a6(0x25b)]=_0x421759[_0x4a78a6(0x1bc)],_0x598008[_0x4a78a6(0x25a)]='192.168.1.100',_0x598008[_0x4a78a6(0x1fa)]='pc',_0x598008[_0x4a78a6(0x264)]=_0x314376,_0x598008[_0x4a78a6(0x26e)]=_0x12febf,_0x598008[_0x4a78a6(0x275)]=_0x4a78a6(0x1e3),_0x598008['sign']=this['sign'](_0x598008,_0x3ea27f),_0x598008[_0x4a78a6(0x241)]='MD5';const _0x10784e=new URLSearchParams(_0x598008)[_0x4a78a6(0x256)](),_0x3b307c=_0x581430+'?'+_0x10784e;if(_0x581430[_0x4a78a6(0x246)]('submit.php'))return{'url_qrcode':null,'redirectUrl':_0x3b307c,'channel':_0x4af29b,'isRedirect':!![]};else{const _0x388168={'headers':{'Content-Type':_0x4a78a6(0x1ef)}},_0x38ecc7=await axios_1[_0x4a78a6(0x276)][_0x4a78a6(0x24d)](_0x581430,_0x598008,_0x388168);common_1[_0x4a78a6(0x1f9)][_0x4a78a6(0x1b6)]('epay\x20--->\x20res:\x20',_0x38ecc7['data']);const {data:{code:_0x2f7e12,msg:_0x233abe,qrcode:_0x1a3817}}=_0x38ecc7;if(_0x2f7e12!=0x1)throw new common_1[(_0x4a78a6(0x1c9))](_0x233abe,common_1[_0x4a78a6(0x237)][_0x4a78a6(0x1dd)]);return{'url_qrcode':_0x1a3817,'redirectUrl':null,'channel':_0x4af29b,'isRedirect':![]};}}async['queryEpay'](_0x2efc8c){const _0x42b331=_0x5a2045,{payEpayPid:_0x3021be,payEpaySecret:_0x5cb3f2,payEpayApiQueryUrl:_0x435ae1}=await this['globalConfigService'][_0x42b331(0x21e)](['payEpayPid','payEpaySecret','payEpayApiQueryUrl']),_0x40b844={};_0x40b844[_0x42b331(0x1d2)]=_0x42b331(0x251),_0x40b844[_0x42b331(0x24b)]=_0x2efc8c,_0x40b844[_0x42b331(0x1df)]=_0x3021be,_0x40b844['key']=_0x5cb3f2;const {data:{code:_0x4bc12f,msg:_0x495a70,data:_0x37fc6d}}=await axios_1[_0x42b331(0x276)][_0x42b331(0x265)](_0x435ae1,{'params':_0x40b844});if(_0x4bc12f!=0x1)throw new common_1[(_0x42b331(0x1c9))](_0x495a70,common_1[_0x42b331(0x237)][_0x42b331(0x1dd)]);return _0x37fc6d;}async['notifyMpay'](_0x272cb4){const _0x297dfa=_0x5a2045,_0x51db0b=_0x272cb4[_0x297dfa(0x217)];delete _0x272cb4[_0x297dfa(0x217)],delete _0x272cb4[_0x297dfa(0x241)];const _0x1747e6=await this[_0x297dfa(0x248)][_0x297dfa(0x21e)]([_0x297dfa(0x23d)]);common_1[_0x297dfa(0x1f9)][_0x297dfa(0x1b6)](_0x297dfa(0x23b));if(this[_0x297dfa(0x217)](_0x272cb4,_0x1747e6)!=_0x51db0b)return _0x297dfa(0x1fe);common_1[_0x297dfa(0x1f9)][_0x297dfa(0x1b6)]('校验签名通过');const _0x2b99ec=await this[_0x297dfa(0x236)][_0x297dfa(0x1d3)]({'where':{'orderId':_0x272cb4[_0x297dfa(0x24b)],'status':0x0}});if(!_0x2b99ec)return'failed';const _0x509086=_0x272cb4[_0x297dfa(0x27e)]=='TRADE_SUCCESS'?0x1:0x2;common_1[_0x297dfa(0x1f9)]['log'](_0x297dfa(0x216),_0x509086);const _0x1e2c96=await this[_0x297dfa(0x236)][_0x297dfa(0x20d)]({'orderId':_0x272cb4[_0x297dfa(0x24b)]},{'status':_0x509086,'paydAt':new Date()});_0x509086===0x1&&await this['userBalanceService'][_0x297dfa(0x21d)](_0x2b99ec);if(_0x1e2c96[_0x297dfa(0x20c)]!=0x1)return _0x297dfa(0x1fe);return _0x297dfa(0x1f0);}async[_0x5a2045(0x1c7)](_0xc80938,_0xddd20b,_0x2e560d=_0x5a2045(0x22e)){const _0x522737=_0x5a2045,_0x250ebc=await this[_0x522737(0x236)][_0x522737(0x1d3)]({'where':{'userId':_0xc80938,'orderId':_0xddd20b}});if(!_0x250ebc)throw new common_1[(_0x522737(0x1c9))](_0x522737(0x1e0),common_1['HttpStatus'][_0x522737(0x1dd)]);const _0x12a6ba=await this[_0x522737(0x234)][_0x522737(0x1d3)]({'where':{'id':_0x250ebc[_0x522737(0x1d5)]}});if(!_0x12a6ba)throw new common_1[(_0x522737(0x1c9))](_0x522737(0x1bd),common_1[_0x522737(0x237)][_0x522737(0x1dd)]);const {payMpayPid:_0x4a5d79,payMpaySecret:_0x415127,payMpayNotifyUrl:_0x254191,payMpayReturnUrl:_0x479acb,payMpayApiPayUrl:_0x386972}=await this[_0x522737(0x248)][_0x522737(0x21e)]([_0x522737(0x23a),_0x522737(0x23d),'payMpayNotifyUrl',_0x522737(0x226),_0x522737(0x202)]),_0x536f1f={};_0x536f1f[_0x522737(0x1df)]=Number(_0x4a5d79),_0x536f1f['type']=_0x2e560d,_0x536f1f['out_trade_no']=_0xddd20b,_0x536f1f['name']=_0x12a6ba[_0x522737(0x253)],_0x536f1f['money']=_0x250ebc[_0x522737(0x1bc)],_0x536f1f[_0x522737(0x264)]=_0x254191,_0x536f1f[_0x522737(0x26e)]=_0x479acb,_0x536f1f['sign']=this[_0x522737(0x217)](_0x536f1f,_0x415127),_0x536f1f[_0x522737(0x241)]=_0x522737(0x1f5);const _0xa15b86=new URLSearchParams(_0x536f1f)[_0x522737(0x256)](),_0x2fafb5=_0x386972+'?'+_0xa15b86;return{'url_qrcode':null,'redirectUrl':_0x2fafb5,'channel':_0x2e560d,'isRedirect':!![]};const _0x132f0b=await axios_1[_0x522737(0x276)][_0x522737(0x265)](_0x386972,{'params':_0x536f1f});}async[_0x5a2045(0x1c0)](_0x13365f){const _0xae61ac=_0x5a2045,{payMpayApiQueryUrl:_0x46bc31}=await this[_0xae61ac(0x248)][_0xae61ac(0x21e)]([_0xae61ac(0x23a),'payMpaySecret',_0xae61ac(0x223)]),_0x107bbd={};_0x107bbd[_0xae61ac(0x22a)]=0x2,_0x107bbd[_0xae61ac(0x1e4)]=_0x13365f;const {data:{code:_0x58d26a,msg:_0x1d4d9b,data:_0x5f53b8}}=await axios_1[_0xae61ac(0x276)][_0xae61ac(0x265)](_0x46bc31,{'params':_0x107bbd});if(_0x58d26a!=0x1)throw new common_1['HttpException'](_0x1d4d9b,common_1['HttpStatus'][_0xae61ac(0x1dd)]);return _0x5f53b8;}async['notifyWeChat'](_0x5b760d){const _0x36a463=_0x5a2045;common_1[_0x36a463(0x1f9)]['log']('微信支付通知params:\x20',_0x5b760d);const {payWeChatAppId:_0x5d98fa,payWeChatMchId:_0x52cbea,payWeChatSecret:_0x51fed2,payWeChatPublicKey:_0x436e80,payWeChatPrivateKey:_0x19f0a5}=await this['globalConfigService'][_0x36a463(0x21e)](['payWeChatAppId','payWeChatMchId',_0x36a463(0x208),_0x36a463(0x274),_0x36a463(0x21a)]),_0x5a5309=new this['WxPay']({'appid':_0x5d98fa,'mchid':_0x52cbea,'publicKey':_0x436e80,'privateKey':_0x19f0a5});try{if(_0x5b760d[_0x36a463(0x242)]=='TRANSACTION.SUCCESS'){const {ciphertext:_0x1df19c,associated_data:_0x13c84d,nonce:_0x2bc3ff}=_0x5b760d['resource'],_0x14c9ca=_0x5a5309[_0x36a463(0x225)](_0x1df19c,_0x13c84d,_0x2bc3ff,_0x51fed2),_0x7947a1=await this[_0x36a463(0x236)][_0x36a463(0x1d3)]({'where':{'orderId':_0x14c9ca[_0x36a463(0x24b)],'status':0x0}});if(!_0x7947a1)return'failed';const _0x27d389=_0x14c9ca[_0x36a463(0x1e2)]==_0x36a463(0x20e)?0x1:0x2,_0x4873ba=await this[_0x36a463(0x236)][_0x36a463(0x20d)]({'orderId':_0x14c9ca[_0x36a463(0x24b)]},{'status':_0x27d389,'paydAt':new Date()});_0x27d389===0x1&&await this[_0x36a463(0x228)][_0x36a463(0x21d)](_0x7947a1);if(_0x4873ba['affected']!=0x1)return _0x36a463(0x1fe);}return _0x36a463(0x1f0);}catch(_0x43ed79){return common_1[_0x36a463(0x1f9)]['log'](_0x36a463(0x233),_0x43ed79),common_1[_0x36a463(0x1f9)]['log'](_0x36a463(0x24f),_0x43ed79),_0x36a463(0x1fe);}}async[_0x5a2045(0x1bb)](_0xb2d368,_0x28c58e,_0x2beae4=_0x5a2045(0x1eb)){const _0x3f0665=_0x5a2045;var _0x366670,_0x368eaa,_0x4369a7,_0x256aa8,_0x489aa4,_0x109d6d,_0x6147dd;common_1['Logger']['log'](_0x3f0665(0x1d1),_0x2beae4);const _0x5dda3d=await this[_0x3f0665(0x236)][_0x3f0665(0x1d3)]({'where':{'userId':_0xb2d368,'orderId':_0x28c58e}});if(!_0x5dda3d)throw new common_1[(_0x3f0665(0x1c9))](_0x3f0665(0x1e0),common_1['HttpStatus'][_0x3f0665(0x1dd)]);const _0x248854=await this[_0x3f0665(0x234)][_0x3f0665(0x1d3)]({'where':{'id':_0x5dda3d[_0x3f0665(0x1d5)]}});if(!_0x248854)throw new common_1[(_0x3f0665(0x1c9))](_0x3f0665(0x1bd),common_1[_0x3f0665(0x237)][_0x3f0665(0x1dd)]);const {payWeChatAppId:_0x2004d1,payWeChatMchId:_0x246b3b,payWeChatPublicKey:_0x44af0d,payWeChatPrivateKey:_0x39f1f6,payWeChatNotifyUrl:_0x2b0661}=await this[_0x3f0665(0x248)][_0x3f0665(0x21e)](['payWeChatAppId',_0x3f0665(0x258),_0x3f0665(0x274),_0x3f0665(0x21a),_0x3f0665(0x1c3)]),_0x49dc6d=new this['WxPay']({'appid':_0x2004d1,'mchid':_0x246b3b,'publicKey':_0x44af0d,'privateKey':_0x39f1f6}),_0x254052={'appid':_0x2004d1,'mchid':_0x246b3b,'description':_0x248854['name'],'out_trade_no':_0x28c58e,'notify_url':_0x2b0661,'amount':{'total':Math['round'](_0x5dda3d[_0x3f0665(0x1bc)]*0x64)}};common_1[_0x3f0665(0x1f9)]['log'](_0x3f0665(0x254),_0x254052);if(_0x2beae4==_0x3f0665(0x1cf)){common_1[_0x3f0665(0x1f9)][_0x3f0665(0x1b6)]('[WeChat\x20Pay\x20JSAPI]\x20开始JSAPI支付流程，用户ID:\x20'+_0xb2d368+_0x3f0665(0x213)+_0x28c58e);const _0x2b8c43=await this['userService']['getOpenIdByUserId'](_0xb2d368);common_1[_0x3f0665(0x1f9)][_0x3f0665(0x1b6)](_0x3f0665(0x27c)+_0x2b8c43),_0x254052[_0x3f0665(0x204)]={'openid':_0x2b8c43},common_1[_0x3f0665(0x1f9)][_0x3f0665(0x1b6)]('[WeChat\x20Pay\x20JSAPI]\x20发送支付请求参数:\x20',JSON[_0x3f0665(0x203)](_0x254052,null,0x2));try{const _0x172347=await _0x49dc6d[_0x3f0665(0x1c8)](_0x254052),_0x26cb5a=_0x172347[_0x3f0665(0x24e)]?_0x172347['data']:_0x172347;return common_1['Logger'][_0x3f0665(0x1b6)](_0x3f0665(0x24c),JSON[_0x3f0665(0x203)](_0x26cb5a,null,0x2)),{'status':_0x172347[_0x3f0665(0x1d8)]||'unknown','appId':_0x26cb5a[_0x3f0665(0x277)]||((_0x366670=_0x26cb5a[_0x3f0665(0x24e)])===null||_0x366670===void 0x0?void 0x0:_0x366670[_0x3f0665(0x277)]),'timeStamp':_0x26cb5a[_0x3f0665(0x247)]||((_0x368eaa=_0x26cb5a[_0x3f0665(0x24e)])===null||_0x368eaa===void 0x0?void 0x0:_0x368eaa['timeStamp']),'nonceStr':_0x26cb5a[_0x3f0665(0x1d4)]||((_0x4369a7=_0x26cb5a[_0x3f0665(0x24e)])===null||_0x4369a7===void 0x0?void 0x0:_0x4369a7[_0x3f0665(0x1d4)]),'package':_0x26cb5a['package']||((_0x256aa8=_0x26cb5a[_0x3f0665(0x24e)])===null||_0x256aa8===void 0x0?void 0x0:_0x256aa8[_0x3f0665(0x1ce)]),'signType':_0x26cb5a[_0x3f0665(0x268)]||((_0x489aa4=_0x26cb5a[_0x3f0665(0x24e)])===null||_0x489aa4===void 0x0?void 0x0:_0x489aa4[_0x3f0665(0x268)]),'paySign':_0x26cb5a['paySign']||((_0x109d6d=_0x26cb5a['data'])===null||_0x109d6d===void 0x0?void 0x0:_0x109d6d[_0x3f0665(0x1fd)])};}catch(_0xb4e6e){console[_0x3f0665(0x25e)](_0x3f0665(0x23e)+_0xb4e6e[_0x3f0665(0x1dc)],_0xb4e6e),console[_0x3f0665(0x25e)](_0x3f0665(0x1f3),_0xb4e6e);throw new common_1[(_0x3f0665(0x1c9))](_0x3f0665(0x22f),common_1[_0x3f0665(0x237)][_0x3f0665(0x1dd)]);}}if(_0x2beae4=='native'){common_1[_0x3f0665(0x1f9)][_0x3f0665(0x1b6)](_0x3f0665(0x211)+_0x28c58e+',\x20用户ID:\x20'+_0xb2d368);try{const _0x76cc1c=await _0x49dc6d['transactions_native'](_0x254052);common_1['Logger'][_0x3f0665(0x1b6)](_0x3f0665(0x1ee),JSON[_0x3f0665(0x203)](_0x76cc1c,null,0x2));let _0x584cfa=_0x76cc1c[_0x3f0665(0x206)]||((_0x6147dd=_0x76cc1c[_0x3f0665(0x24e)])===null||_0x6147dd===void 0x0?void 0x0:_0x6147dd[_0x3f0665(0x206)]);return!_0x584cfa?console[_0x3f0665(0x25e)]('微信Native支付请求成功，但未返回code_url，响应数据:\x20',JSON[_0x3f0665(0x203)](_0x76cc1c,null,0x2)):common_1[_0x3f0665(0x1f9)][_0x3f0665(0x1b6)](_0x3f0665(0x26b)+_0x584cfa),{'url_qrcode':_0x584cfa,'isRedirect':![]};}catch(_0xe0c6c5){console['error'](_0x3f0665(0x229)+_0xe0c6c5[_0x3f0665(0x1dc)],_0xe0c6c5),console[_0x3f0665(0x25e)](_0x3f0665(0x1ff),_0xe0c6c5);throw new common_1[(_0x3f0665(0x1c9))]('微信Native支付失败',common_1['HttpStatus']['BAD_REQUEST']);}}else{console[_0x3f0665(0x252)](_0x3f0665(0x1cc)+_0x2beae4);throw new common_1[(_0x3f0665(0x1c9))](_0x3f0665(0x1e7),common_1[_0x3f0665(0x237)][_0x3f0665(0x1dd)]);}}async[_0x5a2045(0x1f8)](_0x38f8f8){const _0x519024=_0x5a2045,{payWeChatAppId:_0x37e30d,payWeChatMchId:_0x5d1ebf,payWeChatPublicKey:_0x20856c,payWeChatPrivateKey:_0x13ae17,payWeChatNotifyUrl:_0x1951b7}=await this['globalConfigService'][_0x519024(0x21e)]([_0x519024(0x214),_0x519024(0x258),'payWeChatPublicKey',_0x519024(0x21a)]),_0x1f68bf=new this[(_0x519024(0x230))]({'appid':_0x37e30d,'mchid':_0x5d1ebf,'publicKey':_0x20856c,'privateKey':_0x13ae17}),_0x44733f=await _0x1f68bf[_0x519024(0x205)]({'out_trade_no':_0x38f8f8});return _0x44733f;}[_0x5a2045(0x217)](_0x213bec,_0x207e93){const _0x19a0c2=_0x5a2045,_0x55bac9=Object[_0x19a0c2(0x1b9)](_0x213bec)[_0x19a0c2(0x1c1)]()[_0x19a0c2(0x1f7)](_0x342a1b=>_0x342a1b+'='+_0x213bec[_0x342a1b])[_0x19a0c2(0x1e5)]('&')+_0x207e93;return crypto['createHash']('md5')[_0x19a0c2(0x20d)](_0x55bac9)[_0x19a0c2(0x1f4)]('hex');}[_0x5a2045(0x1da)](_0x13f63a,_0x3a1c2a){const _0x1771a6=_0x5a2045,_0x5cb81f=Object[_0x1771a6(0x1b9)](_0x13f63a);_0x5cb81f[_0x1771a6(0x1c1)]();const _0x327d7c=[];_0x5cb81f['map'](_0x2e56ce=>{const _0x8cd077=_0x1771a6;_0x327d7c[_0x8cd077(0x1ca)](_0x2e56ce+'='+_0x13f63a[_0x2e56ce]);}),_0x327d7c[_0x1771a6(0x1ca)](_0x1771a6(0x27a)+_0x3a1c2a);const _0x3c0ea1=_0x327d7c[_0x1771a6(0x1e5)]('&');return crypto[_0x1771a6(0x25c)]('md5')[_0x1771a6(0x20d)](_0x3c0ea1)[_0x1771a6(0x1f4)](_0x1771a6(0x250))[_0x1771a6(0x1c4)]();}async[_0x5a2045(0x1e6)](_0x1bb777,_0x6b4d07,_0x27636a=_0x5a2045(0x22e)){const _0x38a9a0=_0x5a2045,_0x1c20b0=await this[_0x38a9a0(0x236)][_0x38a9a0(0x1d3)]({'where':{'userId':_0x1bb777,'orderId':_0x6b4d07}});if(!_0x1c20b0)throw new common_1[(_0x38a9a0(0x1c9))](_0x38a9a0(0x1e0),common_1[_0x38a9a0(0x237)][_0x38a9a0(0x1dd)]);const _0x2037ce=await this[_0x38a9a0(0x234)]['findOne']({'where':{'id':_0x1c20b0[_0x38a9a0(0x1d5)]}});if(!_0x2037ce)throw new common_1[(_0x38a9a0(0x1c9))](_0x38a9a0(0x1bd),common_1[_0x38a9a0(0x237)][_0x38a9a0(0x1dd)]);const {payLtzfMchId:_0x187deb,payLtzfSecret:_0x302420,payLtzfNotifyUrl:_0x4c3ebd,payLtzfReturnUrl:_0x53b34c}=await this[_0x38a9a0(0x248)][_0x38a9a0(0x21e)]([_0x38a9a0(0x200),'payLtzfSecret',_0x38a9a0(0x263),'payLtzfReturnUrl']),_0x588d11={};_0x588d11[_0x38a9a0(0x23f)]=_0x187deb,_0x588d11[_0x38a9a0(0x21b)]=(Date[_0x38a9a0(0x1ea)]()/0x3e8)[_0x38a9a0(0x1c5)](0x0),_0x588d11['out_trade_no']=_0x6b4d07,_0x588d11['body']=_0x2037ce[_0x38a9a0(0x253)],_0x588d11[_0x38a9a0(0x1e1)]=_0x1c20b0['total'],_0x588d11[_0x38a9a0(0x264)]=_0x4c3ebd,_0x588d11[_0x38a9a0(0x217)]=this[_0x38a9a0(0x1da)](_0x588d11,_0x302420),_0x588d11['attach']=_0x38a9a0(0x1b8),_0x588d11['return_url']=_0x53b34c;const _0xf22d97=Object[_0x38a9a0(0x1b9)](_0x588d11)[_0x38a9a0(0x1f7)](_0x1c09dc=>encodeURIComponent(_0x1c09dc)+'='+encodeURIComponent(_0x588d11[_0x1c09dc]))['join']('&'),_0x4c20f7={'headers':{'Content-Type':_0x38a9a0(0x1ef)}},_0x75f1a=await axios_1[_0x38a9a0(0x276)][_0x38a9a0(0x24d)]('https://api.ltzf.cn/api/wxpay/jsapi_convenient',_0xf22d97,_0x4c20f7),{code:_0x184f06,data:_0x1fb9ac,msg:_0x5da3ce}=_0x75f1a[_0x38a9a0(0x24e)];if(_0x184f06!=0x0)throw new common_1[(_0x38a9a0(0x1c9))](_0x5da3ce,common_1[_0x38a9a0(0x237)]['BAD_REQUEST']);const _0x3b13d4=_0x1fb9ac[_0x38a9a0(0x245)],_0x401ab1=_0x1fb9ac[_0x38a9a0(0x1db)];return{'url_qrcode':_0x3b13d4,'url':_0x401ab1};}async[_0x5a2045(0x260)](_0x2d88c0){const _0x13da06=_0x5a2045,{payLtzfMchId:_0xc5b988,payLtzfSecret:_0x2c93e5}=await this[_0x13da06(0x248)]['getConfigs']([_0x13da06(0x200),_0x13da06(0x262)]),_0x3fde0c={};_0x3fde0c['mch_id']=_0xc5b988,_0x3fde0c['timestamp']=(Date['now']()/0x3e8)[_0x13da06(0x1c5)](0x0),_0x3fde0c[_0x13da06(0x24b)]=_0x2d88c0,_0x3fde0c[_0x13da06(0x217)]=this[_0x13da06(0x1da)](_0x3fde0c,_0x2c93e5);const _0x336e13=Object[_0x13da06(0x1b9)](_0x3fde0c)['map'](_0x44e5ef=>encodeURIComponent(_0x44e5ef)+'='+encodeURIComponent(_0x3fde0c[_0x44e5ef]))['join']('&'),_0x380837={'headers':{'Content-Type':_0x13da06(0x1ef)}},{data:{code:_0x56723e,msg:_0x4adc8b,data:_0x3ee441}}=await axios_1['default'][_0x13da06(0x24d)](_0x13da06(0x281),_0x336e13,_0x380837);if(_0x56723e!=0x0)throw new common_1[(_0x13da06(0x1c9))](_0x4adc8b+JSON[_0x13da06(0x203)](_0x3fde0c),common_1['HttpStatus'][_0x13da06(0x1dd)]);return _0x3ee441;}async[_0x5a2045(0x20f)](_0xc6ce7e){const _0x5b9c8b=_0x5a2045,_0xbf5d5e=await this['globalConfigService'][_0x5b9c8b(0x21e)](['payLtzfSecret']),_0x3e0954=_0xc6ce7e['sign'];delete _0xc6ce7e[_0x5b9c8b(0x217)],delete _0xc6ce7e['pay_channel'],delete _0xc6ce7e['trade_type'],delete _0xc6ce7e[_0x5b9c8b(0x266)],delete _0xc6ce7e[_0x5b9c8b(0x209)],delete _0xc6ce7e[_0x5b9c8b(0x224)];if(this[_0x5b9c8b(0x1da)](_0xc6ce7e,_0xbf5d5e)!=_0x3e0954)return _0x5b9c8b(0x1be);const _0x94cd75=await this[_0x5b9c8b(0x236)][_0x5b9c8b(0x1d3)]({'where':{'orderId':_0xc6ce7e[_0x5b9c8b(0x24b)],'status':0x0}});if(!_0x94cd75)return _0x5b9c8b(0x1be);await this[_0x5b9c8b(0x228)]['addBalanceToOrder'](_0x94cd75);const _0x56b2dd=await this[_0x5b9c8b(0x236)][_0x5b9c8b(0x20d)]({'orderId':_0xc6ce7e[_0x5b9c8b(0x24b)]},{'status':0x1,'paydAt':new Date()});if(_0x56b2dd[_0x5b9c8b(0x20c)]!=0x1)return'FAIL';return'SUCCESS';}};PayService=__decorate([(0x0,common_1[_0x5a2045(0x257)])(),__param(0x0,(0x0,typeorm_1[_0x5a2045(0x207)])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x1,(0x0,typeorm_1[_0x5a2045(0x207)])(order_entity_1['OrderEntity'])),__metadata(_0x5a2045(0x273),[typeorm_2[_0x5a2045(0x26c)],typeorm_2[_0x5a2045(0x26c)],userBalance_service_1[_0x5a2045(0x278)],globalConfig_service_1['GlobalConfigService'],user_service_1[_0x5a2045(0x1c2)]])],PayService),exports[_0x5a2045(0x249)]=PayService;