'use strict';const _0x5b0ee6=_0x32cb;(function(_0x4fbf33,_0x342e55){const _0x11629a=_0x32cb,_0x45d6a8=_0x4fbf33();while(!![]){try{const _0x4cf980=parseInt(_0x11629a(0x17e))/0x1*(parseInt(_0x11629a(0x23b))/0x2)+-parseInt(_0x11629a(0x209))/0x3*(parseInt(_0x11629a(0x182))/0x4)+-parseInt(_0x11629a(0x197))/0x5+-parseInt(_0x11629a(0x1ff))/0x6+-parseInt(_0x11629a(0x1d2))/0x7*(parseInt(_0x11629a(0x1ec))/0x8)+-parseInt(_0x11629a(0x1e7))/0x9+parseInt(_0x11629a(0x18a))/0xa;if(_0x4cf980===_0x342e55)break;else _0x45d6a8['push'](_0x45d6a8['shift']());}catch(_0x4853f9){_0x45d6a8['push'](_0x45d6a8['shift']());}}}(_0x6510,0x6e847));var __decorate=this&&this[_0x5b0ee6(0x1e9)]||function(_0x2a5bff,_0x3ac3a8,_0x24754b,_0x898c0d){const _0x17ddbb=_0x5b0ee6;var _0x265721=arguments['length'],_0x864b52=_0x265721<0x3?_0x3ac3a8:_0x898c0d===null?_0x898c0d=Object['getOwnPropertyDescriptor'](_0x3ac3a8,_0x24754b):_0x898c0d,_0x21cb18;if(typeof Reflect==='object'&&typeof Reflect[_0x17ddbb(0x224)]===_0x17ddbb(0x218))_0x864b52=Reflect[_0x17ddbb(0x224)](_0x2a5bff,_0x3ac3a8,_0x24754b,_0x898c0d);else{for(var _0x1b9689=_0x2a5bff[_0x17ddbb(0x1f6)]-0x1;_0x1b9689>=0x0;_0x1b9689--)if(_0x21cb18=_0x2a5bff[_0x1b9689])_0x864b52=(_0x265721<0x3?_0x21cb18(_0x864b52):_0x265721>0x3?_0x21cb18(_0x3ac3a8,_0x24754b,_0x864b52):_0x21cb18(_0x3ac3a8,_0x24754b))||_0x864b52;}return _0x265721>0x3&&_0x864b52&&Object[_0x17ddbb(0x204)](_0x3ac3a8,_0x24754b,_0x864b52),_0x864b52;},__metadata=this&&this['__metadata']||function(_0x16d0ff,_0x19ee46){const _0x1011fa=_0x5b0ee6;if(typeof Reflect===_0x1011fa(0x220)&&typeof Reflect['metadata']===_0x1011fa(0x218))return Reflect['metadata'](_0x16d0ff,_0x19ee46);},__param=this&&this['__param']||function(_0x2133ad,_0x40c1ff){return function(_0xb8d154,_0x4f9ebf){_0x40c1ff(_0xb8d154,_0x4f9ebf,_0x2133ad);};};function _0x6510(){const _0x2b5ebb=['pid','payWeChatPublicKey','toUpperCase',',\x20用户ID:\x20','notifyMpay','payEpayApiQueryUrl','payWeChatNotifyUrl','queryMpay','nonceStr','payEpayReturnUrl','getConfigs','微信Native支付请求成功，code_url:\x20','payEpay','md5','attach','resource','payLtzf','2QHzbUb','../../common/utils','native','套餐不存在!','TRANSACTION.SUCCESS','default','HttpException','notifyEpay','userBalanceService',',\x20订单ID:\x20','get','payEpayPid','userService','status:\x20','https://api.xunhupay.com/payment/do.html','param','success','payLtzfReturnUrl','round','883667EMrdUw','SUCCESS','notify_url','OrderEntity','61436OQsouv','payWeChat','paySign','act','payLtzfNotifyUrl','校验签名','digest','join','20268690ifraZK','[WeChat\x20Pay\x20JSAPI]\x20开始JSAPI支付流程，用户ID:\x20','payLtzfSecret','submit.php','includes','../crami/cramiPackage.entity','BAD_REQUEST','now','../globalConfig/globalConfig.service','globalConfigService','order_url','device','money','868090EdetUG','timeStamp','push','Repository','clientip','payMpayReturnUrl','WxPay','支付请求失败:\x20','toString','decipher_gcm','unknown','total','trade_state','payMpay','axios','error:\x20','../order/order.entity','PayService','payLtzfMchId','QRcode_url','wechat','affected','goodsId','nonce_str','timestamp','UserBalanceService','orderEntity','payWeChatMchId','wechat-pay:\x20','trade_order_id','notify','queryWeChat','error','../user/user.service','addBalanceToOrder','本次支付类型:\x20','total_fee','cramiPackageEntity','keys','notifyLtzf','payPlatform','hupi','payHupiNotifyUrl','pay','notifyHupi','Logger','payWeChatAppId','out_trade_order','trade_type','hex','payHupiAppId','@nestjs/typeorm','sign','payMpaySecret','sort','epay','alipay','[WeChat\x20Pay\x20JSAPI]\x20支付请求过程中发生错误:\x20','校验签名通过','391454hkWrKZ','appId','ltzf','微信Native支付响应数据:\x20','out_trade_no','1.1','application/x-www-form-urlencoded','log','toFixed','payHupi','订单不存在!','notifyWeChat','code_url','warn','微信Native支付失败','微信支付通知params:\x20','https://api.ltzf.cn/api/wxpay/jsapi_convenient','signType','payMpayPid','ltzfSign','开始进行微信Native支付流程，订单ID:\x20','6403104bxaSuH','data','__decorate','name','payMpayApiPayUrl','96aUUzdE','MD5','payWeChatPrivateKey','sign_type','type','message','https://api.ltzf.cn/api/wxpay/get_pay_order','epay\x20--->\x20res:\x20','openid','TRADE_SUCCESS','length','FAIL','status','stringify','payHupiGatewayUrl','findOne','InjectRepository','mch_id','design:paramtypes','2737848hHcxrz','success_time','payEpayApiPayUrl','createHash','importDynamic','defineProperty','HttpStatus','完整的错误对象：','order_no','Injectable','87Gdiosc','map','update','return_url','wxpay','unsupported\x20pay\x20type','CramiPackageEntity','wechatpay-node-v3','package','createRandomNonceStr','hash','failed','mpay','event_type','time','function','transactions_jsapi','__esModule','queryLtzf','payEpaySecret','jsapi','post','onModuleInit','object','transactions_native','支付请求失败!','GlobalConfigService','decorate','trade_status','getOpenIdByUserId','192.168.1.100','payHupiSecret','crypto'];_0x6510=function(){return _0x2b5ebb;};return _0x6510();}function _0x32cb(_0x227596,_0x50b8f2){const _0x651087=_0x6510();return _0x32cb=function(_0x32cbe1,_0x49165d){_0x32cbe1=_0x32cbe1-0x17c;let _0x476db9=_0x651087[_0x32cbe1];return _0x476db9;},_0x32cb(_0x227596,_0x50b8f2);}Object[_0x5b0ee6(0x204)](exports,_0x5b0ee6(0x21a),{'value':!![]}),exports[_0x5b0ee6(0x1a8)]=void 0x0;const utils_1=require(_0x5b0ee6(0x23c)),common_1=require('@nestjs/common'),typeorm_1=require(_0x5b0ee6(0x1ca)),axios_1=require(_0x5b0ee6(0x1a5)),crypto=require(_0x5b0ee6(0x229)),typeorm_2=require('typeorm'),cramiPackage_entity_1=require(_0x5b0ee6(0x18f)),globalConfig_service_1=require(_0x5b0ee6(0x192)),order_entity_1=require(_0x5b0ee6(0x1a7)),user_service_1=require(_0x5b0ee6(0x1b8)),userBalance_service_1=require('../userBalance/userBalance.service');let PayService=class PayService{constructor(_0x43ddae,_0x342c7,_0x41266d,_0x5250e1,_0x430fb8){const _0x74917c=_0x5b0ee6;this[_0x74917c(0x1bc)]=_0x43ddae,this[_0x74917c(0x1b1)]=_0x342c7,this['userBalanceService']=_0x41266d,this['globalConfigService']=_0x5250e1,this[_0x74917c(0x247)]=_0x430fb8;}async[_0x5b0ee6(0x21f)](){const _0x4c79cf=_0x5b0ee6,_0x103e0d=await(0x0,utils_1[_0x4c79cf(0x203)])(_0x4c79cf(0x210));this['WxPay']=(_0x103e0d===null||_0x103e0d===void 0x0?void 0x0:_0x103e0d[_0x4c79cf(0x240)])?_0x103e0d[_0x4c79cf(0x240)]:_0x103e0d;}async[_0x5b0ee6(0x1b5)](_0x2ec6e3){const _0x5278ca=_0x5b0ee6;if(_0x2ec6e3[_0x5278ca(0x24a)]==_0x5278ca(0x1ce))return this[_0x5278ca(0x242)](_0x2ec6e3);if(_0x2ec6e3['attach']==_0x5278ca(0x1c0))return this['notifyHupi'](_0x2ec6e3);if(_0x2ec6e3[_0x5278ca(0x238)]==_0x5278ca(0x1d4))return this[_0x5278ca(0x1be)](_0x2ec6e3);if(typeof _0x2ec6e3['resource']==_0x5278ca(0x220))return this['notifyWeChat'](_0x2ec6e3);return this[_0x5278ca(0x22e)](_0x2ec6e3);}async[_0x5b0ee6(0x1c2)](_0x12d4ff,_0x501695,_0x178f27=_0x5b0ee6(0x20d)){const _0xc38e01=_0x5b0ee6,_0x4592e4=await this[_0xc38e01(0x1b1)][_0xc38e01(0x1fb)]({'where':{'userId':_0x12d4ff,'orderId':_0x501695}});if(!_0x4592e4)throw new common_1['HttpException']('订单不存在!',common_1[_0xc38e01(0x205)][_0xc38e01(0x190)]);const _0x22fb4a=await this[_0xc38e01(0x1bc)]['findOne']({'where':{'id':_0x4592e4[_0xc38e01(0x1ad)]}});if(!_0x22fb4a)throw new common_1[(_0xc38e01(0x241))]('套餐不存在!',common_1[_0xc38e01(0x205)][_0xc38e01(0x190)]);common_1[_0xc38e01(0x1c4)][_0xc38e01(0x1d9)](_0xc38e01(0x1ba),_0x4592e4[_0xc38e01(0x1bf)]);try{if(_0x4592e4[_0xc38e01(0x1bf)]==_0xc38e01(0x1ab))return this['payWeChat'](_0x12d4ff,_0x501695,_0x178f27);if(_0x4592e4[_0xc38e01(0x1bf)]==_0xc38e01(0x1ce))return this['payEpay'](_0x12d4ff,_0x501695,_0x178f27);if(_0x4592e4[_0xc38e01(0x1bf)]==_0xc38e01(0x215))return this[_0xc38e01(0x1a4)](_0x12d4ff,_0x501695,_0x178f27);if(_0x4592e4[_0xc38e01(0x1bf)]==_0xc38e01(0x1c0))return this[_0xc38e01(0x1db)](_0x12d4ff,_0x501695,_0x178f27);if(_0x4592e4[_0xc38e01(0x1bf)]=='ltzf')return this[_0xc38e01(0x23a)](_0x12d4ff,_0x501695,_0x178f27);}catch(_0x9c7a87){common_1[_0xc38e01(0x1c4)][_0xc38e01(0x1d9)](_0xc38e01(0x19e),_0x9c7a87);throw new common_1[(_0xc38e01(0x241))](_0xc38e01(0x222),common_1[_0xc38e01(0x205)][_0xc38e01(0x190)]);}}async['query'](_0x492317){const _0x45dbdd=_0x5b0ee6,_0x4f58b6=await this['orderEntity'][_0x45dbdd(0x1fb)]({'where':{'orderId':_0x492317}});if(!_0x4f58b6)throw new common_1[(_0x45dbdd(0x241))]('订单不存在!',common_1[_0x45dbdd(0x205)]['BAD_REQUEST']);return _0x4f58b6;}async[_0x5b0ee6(0x1c3)](_0x5e97c2){const _0x2dd07a=_0x5b0ee6,_0x1aa9db=await this[_0x2dd07a(0x193)][_0x2dd07a(0x234)]([_0x2dd07a(0x228)]),_0x1f2d71=_0x5e97c2[_0x2dd07a(0x213)];delete _0x5e97c2[_0x2dd07a(0x213)];if(this['sign'](_0x5e97c2,_0x1aa9db)!=_0x1f2d71)return _0x2dd07a(0x214);const _0x693265=await this[_0x2dd07a(0x1b1)][_0x2dd07a(0x1fb)]({'where':{'orderId':_0x5e97c2[_0x2dd07a(0x1b4)],'status':0x0}});if(!_0x693265)return'failed';await this[_0x2dd07a(0x243)]['addBalanceToOrder'](_0x693265);const _0x5dd452=await this[_0x2dd07a(0x1b1)][_0x2dd07a(0x20b)]({'orderId':_0x5e97c2[_0x2dd07a(0x1b4)]},{'status':0x1,'paydAt':new Date()});if(_0x5dd452[_0x2dd07a(0x1ac)]!=0x1)return _0x2dd07a(0x214);return _0x2dd07a(0x24b);}async['payHupi'](_0x5124df,_0x396021,_0x241e23=_0x5b0ee6(0x20d)){const _0x27c943=_0x5b0ee6,_0x5aba44=await this[_0x27c943(0x1b1)]['findOne']({'where':{'userId':_0x5124df,'orderId':_0x396021}});if(!_0x5aba44)throw new common_1[(_0x27c943(0x241))](_0x27c943(0x1dc),common_1[_0x27c943(0x205)][_0x27c943(0x190)]);const _0x57ef46=await this[_0x27c943(0x1bc)][_0x27c943(0x1fb)]({'where':{'id':_0x5aba44[_0x27c943(0x1ad)]}});if(!_0x57ef46)throw new common_1['HttpException'](_0x27c943(0x23e),common_1[_0x27c943(0x205)][_0x27c943(0x190)]);const {payHupiAppId:_0x5380de,payHupiSecret:_0x4b8e1d,payHupiNotifyUrl:_0x5aee4d,payHupiReturnUrl:_0x473782,payHupiGatewayUrl:_0xf89a0a}=await this['globalConfigService']['getConfigs'](['payHupiAppId',_0x27c943(0x228),_0x27c943(0x1c1),'payHupiReturnUrl',_0x27c943(0x1fa)]),_0x3297cb={};_0x3297cb['version']=_0x27c943(0x1d7),_0x3297cb['appid']=_0x5380de,_0x3297cb[_0x27c943(0x217)]=(Date[_0x27c943(0x191)]()/0x3e8)['toFixed'](0x0),_0x3297cb['nonce_str']=(0x0,utils_1[_0x27c943(0x212)])(0x20),_0x3297cb[_0x27c943(0x1b4)]=_0x396021,_0x3297cb['title']=_0x57ef46[_0x27c943(0x1ea)],_0x3297cb[_0x27c943(0x1bb)]=_0x5aba44['total'],_0x3297cb[_0x27c943(0x180)]=_0x5aee4d,_0x3297cb[_0x27c943(0x20c)]=_0x473782,_0x3297cb[_0x27c943(0x238)]=_0x27c943(0x1c0),_0x3297cb[_0x27c943(0x213)]=this[_0x27c943(0x1cb)](_0x3297cb,_0x4b8e1d);const {data:{errcode:_0x3a2425,errmsg:_0x1cc96e,url_qrcode:_0x9ffccd,url:_0x4885d5}}=await axios_1[_0x27c943(0x240)][_0x27c943(0x21e)](_0xf89a0a||_0x27c943(0x249),_0x3297cb);if(_0x3a2425!=0x0)throw new common_1[(_0x27c943(0x241))](_0x1cc96e,common_1[_0x27c943(0x205)][_0x27c943(0x190)]);return{'url_qrcode':_0x9ffccd,'url':_0x4885d5};}async['queryHupi'](_0x54d3aa){const _0x36f12e=_0x5b0ee6,{payHupiAppId:_0x35ffb3,payHupiSecret:_0x4c7022}=await this[_0x36f12e(0x193)][_0x36f12e(0x234)]([_0x36f12e(0x1c9),_0x36f12e(0x228)]),_0x1e8388={};_0x1e8388['version']=_0x36f12e(0x1d7),_0x1e8388['appid']=_0x35ffb3,_0x1e8388[_0x36f12e(0x217)]=(Date['now']()/0x3e8)['toFixed'](0x0),_0x1e8388[_0x36f12e(0x1ae)]=(0x0,utils_1[_0x36f12e(0x212)])(0x20),_0x1e8388[_0x36f12e(0x1c6)]=_0x54d3aa,_0x1e8388[_0x36f12e(0x213)]=this[_0x36f12e(0x1cb)](_0x1e8388,_0x4c7022);const {data:{errcode:_0x3730f5,errmsg:_0x1d4f73,data:_0x24bb25}}=await axios_1['default']['post']('https://api.xunhupay.com/payment/query.html',_0x1e8388);if(_0x3730f5!=0x0)throw new common_1[(_0x36f12e(0x241))](_0x1d4f73,common_1[_0x36f12e(0x205)]['BAD_REQUEST']);return _0x24bb25;}async[_0x5b0ee6(0x242)](_0x473894){const _0x3fcbd9=_0x5b0ee6,_0x1c0833=_0x473894[_0x3fcbd9(0x1cb)];delete _0x473894[_0x3fcbd9(0x1cb)],delete _0x473894[_0x3fcbd9(0x1ef)];const _0x2d32d0=await this[_0x3fcbd9(0x193)][_0x3fcbd9(0x234)](['payEpaySecret']);if(this[_0x3fcbd9(0x1cb)](_0x473894,_0x2d32d0)!=_0x1c0833)return _0x3fcbd9(0x214);common_1[_0x3fcbd9(0x1c4)][_0x3fcbd9(0x1d9)]('校验签名通过');const _0x4d232c=await this[_0x3fcbd9(0x1b1)]['findOne']({'where':{'orderId':_0x473894[_0x3fcbd9(0x1d6)],'status':0x0}});if(!_0x4d232c)return _0x3fcbd9(0x214);const _0x33134d=_0x473894[_0x3fcbd9(0x225)]==_0x3fcbd9(0x1f5)?0x1:0x2,_0x21fc64=await this['orderEntity']['update']({'orderId':_0x473894['out_trade_no']},{'status':_0x33134d,'paydAt':new Date()});_0x33134d===0x1&&await this[_0x3fcbd9(0x243)]['addBalanceToOrder'](_0x4d232c);if(_0x21fc64[_0x3fcbd9(0x1ac)]!=0x1)return _0x3fcbd9(0x214);return'success';}async[_0x5b0ee6(0x236)](_0x181e71,_0x2daa58,_0x103aa8=_0x5b0ee6(0x1cf)){const _0x33e998=_0x5b0ee6,_0x278697=await this[_0x33e998(0x1b1)][_0x33e998(0x1fb)]({'where':{'userId':_0x181e71,'orderId':_0x2daa58}});if(!_0x278697)throw new common_1[(_0x33e998(0x241))](_0x33e998(0x1dc),common_1[_0x33e998(0x205)]['BAD_REQUEST']);const _0xa337e9=await this['cramiPackageEntity'][_0x33e998(0x1fb)]({'where':{'id':_0x278697[_0x33e998(0x1ad)]}});if(!_0xa337e9)throw new common_1[(_0x33e998(0x241))](_0x33e998(0x23e),common_1['HttpStatus'][_0x33e998(0x190)]);const {payEpayPid:_0x3e4cd,payEpaySecret:_0x4437e5,payEpayNotifyUrl:_0x2ecee2,payEpayReturnUrl:_0x1c739f,payEpayApiPayUrl:_0x531b26}=await this[_0x33e998(0x193)][_0x33e998(0x234)]([_0x33e998(0x246),_0x33e998(0x21c),'payEpayNotifyUrl',_0x33e998(0x233),_0x33e998(0x201)]);let _0x337d3a;_0x3e4cd[_0x33e998(0x1f6)]<=0x10?_0x337d3a=Number(_0x3e4cd):_0x337d3a=BigInt(_0x3e4cd);const _0x52afc1={};_0x52afc1[_0x33e998(0x22a)]=_0x337d3a,_0x52afc1[_0x33e998(0x1f0)]=_0x103aa8,_0x52afc1[_0x33e998(0x1d6)]=_0x2daa58,_0x52afc1[_0x33e998(0x1ea)]=_0xa337e9[_0x33e998(0x1ea)],_0x52afc1[_0x33e998(0x196)]=_0x278697[_0x33e998(0x1a2)],_0x52afc1[_0x33e998(0x19b)]=_0x33e998(0x227),_0x52afc1[_0x33e998(0x195)]='pc',_0x52afc1[_0x33e998(0x180)]=_0x2ecee2,_0x52afc1[_0x33e998(0x20c)]=_0x1c739f,_0x52afc1[_0x33e998(0x24a)]='epay',_0x52afc1[_0x33e998(0x1cb)]=this[_0x33e998(0x1cb)](_0x52afc1,_0x4437e5),_0x52afc1[_0x33e998(0x1ef)]=_0x33e998(0x1ed);const _0x46818d=new URLSearchParams(_0x52afc1)[_0x33e998(0x19f)](),_0x6ec822=_0x531b26+'?'+_0x46818d;if(_0x531b26[_0x33e998(0x18e)](_0x33e998(0x18d)))return{'url_qrcode':null,'redirectUrl':_0x6ec822,'channel':_0x103aa8,'isRedirect':!![]};else{const _0xc27cc9={'headers':{'Content-Type':'application/x-www-form-urlencoded'}},_0x593d9a=await axios_1[_0x33e998(0x240)][_0x33e998(0x21e)](_0x531b26,_0x52afc1,_0xc27cc9);common_1[_0x33e998(0x1c4)]['log'](_0x33e998(0x1f3),_0x593d9a[_0x33e998(0x1e8)]);const {data:{code:_0x4470e8,msg:_0x2727d0,qrcode:_0x1e50f7}}=_0x593d9a;if(_0x4470e8!=0x1)throw new common_1['HttpException'](_0x2727d0,common_1['HttpStatus'][_0x33e998(0x190)]);return{'url_qrcode':_0x1e50f7,'redirectUrl':null,'channel':_0x103aa8,'isRedirect':![]};}}async['queryEpay'](_0x1277fa){const _0x120330=_0x5b0ee6,{payEpayPid:_0xd03771,payEpaySecret:_0x3dce51,payEpayApiQueryUrl:_0x46fa6f}=await this[_0x120330(0x193)][_0x120330(0x234)]([_0x120330(0x246),'payEpaySecret',_0x120330(0x22f)]),_0x1b31f7={};_0x1b31f7[_0x120330(0x185)]='order',_0x1b31f7[_0x120330(0x1d6)]=_0x1277fa,_0x1b31f7[_0x120330(0x22a)]=_0xd03771,_0x1b31f7['key']=_0x3dce51;const {data:{code:_0x4fe035,msg:_0x54e84b,data:_0x38c842}}=await axios_1[_0x120330(0x240)][_0x120330(0x245)](_0x46fa6f,{'params':_0x1b31f7});if(_0x4fe035!=0x1)throw new common_1[(_0x120330(0x241))](_0x54e84b,common_1[_0x120330(0x205)][_0x120330(0x190)]);return _0x38c842;}async[_0x5b0ee6(0x22e)](_0x2a61ce){const _0xc2ee1=_0x5b0ee6,_0x248712=_0x2a61ce['sign'];delete _0x2a61ce['sign'],delete _0x2a61ce[_0xc2ee1(0x1ef)];const _0x36f6ce=await this[_0xc2ee1(0x193)][_0xc2ee1(0x234)]([_0xc2ee1(0x1cc)]);common_1[_0xc2ee1(0x1c4)][_0xc2ee1(0x1d9)](_0xc2ee1(0x187));if(this[_0xc2ee1(0x1cb)](_0x2a61ce,_0x36f6ce)!=_0x248712)return'failed';common_1[_0xc2ee1(0x1c4)][_0xc2ee1(0x1d9)](_0xc2ee1(0x1d1));const _0x5333a3=await this[_0xc2ee1(0x1b1)][_0xc2ee1(0x1fb)]({'where':{'orderId':_0x2a61ce[_0xc2ee1(0x1d6)],'status':0x0}});if(!_0x5333a3)return'failed';const _0x2b2640=_0x2a61ce[_0xc2ee1(0x225)]=='TRADE_SUCCESS'?0x1:0x2;common_1[_0xc2ee1(0x1c4)][_0xc2ee1(0x1d9)](_0xc2ee1(0x248),_0x2b2640);const _0x18f318=await this[_0xc2ee1(0x1b1)][_0xc2ee1(0x20b)]({'orderId':_0x2a61ce['out_trade_no']},{'status':_0x2b2640,'paydAt':new Date()});_0x2b2640===0x1&&await this[_0xc2ee1(0x243)][_0xc2ee1(0x1b9)](_0x5333a3);if(_0x18f318[_0xc2ee1(0x1ac)]!=0x1)return _0xc2ee1(0x214);return _0xc2ee1(0x24b);}async[_0x5b0ee6(0x1a4)](_0x2d87d8,_0x4553e6,_0x2f1578=_0x5b0ee6(0x20d)){const _0x123de3=_0x5b0ee6,_0x2ddf3f=await this[_0x123de3(0x1b1)][_0x123de3(0x1fb)]({'where':{'userId':_0x2d87d8,'orderId':_0x4553e6}});if(!_0x2ddf3f)throw new common_1[(_0x123de3(0x241))](_0x123de3(0x1dc),common_1[_0x123de3(0x205)][_0x123de3(0x190)]);const _0x356abf=await this[_0x123de3(0x1bc)][_0x123de3(0x1fb)]({'where':{'id':_0x2ddf3f[_0x123de3(0x1ad)]}});if(!_0x356abf)throw new common_1[(_0x123de3(0x241))](_0x123de3(0x23e),common_1[_0x123de3(0x205)][_0x123de3(0x190)]);const {payMpayPid:_0x4ab45b,payMpaySecret:_0x1722fe,payMpayNotifyUrl:_0x3362f,payMpayReturnUrl:_0xba5736,payMpayApiPayUrl:_0x46a10c}=await this[_0x123de3(0x193)][_0x123de3(0x234)]([_0x123de3(0x1e4),_0x123de3(0x1cc),'payMpayNotifyUrl',_0x123de3(0x19c),_0x123de3(0x1eb)]),_0x1cd40a={};_0x1cd40a[_0x123de3(0x22a)]=Number(_0x4ab45b),_0x1cd40a[_0x123de3(0x1f0)]=_0x2f1578,_0x1cd40a[_0x123de3(0x1d6)]=_0x4553e6,_0x1cd40a[_0x123de3(0x1ea)]=_0x356abf['name'],_0x1cd40a['money']=_0x2ddf3f[_0x123de3(0x1a2)],_0x1cd40a[_0x123de3(0x180)]=_0x3362f,_0x1cd40a[_0x123de3(0x20c)]=_0xba5736,_0x1cd40a[_0x123de3(0x1cb)]=this[_0x123de3(0x1cb)](_0x1cd40a,_0x1722fe),_0x1cd40a[_0x123de3(0x1ef)]=_0x123de3(0x1ed);const _0x96012b=new URLSearchParams(_0x1cd40a)['toString'](),_0x14e219=_0x46a10c+'?'+_0x96012b;return{'url_qrcode':null,'redirectUrl':_0x14e219,'channel':_0x2f1578,'isRedirect':!![]};const _0x3debd8=await axios_1[_0x123de3(0x240)][_0x123de3(0x245)](_0x46a10c,{'params':_0x1cd40a});}async[_0x5b0ee6(0x231)](_0x2bf37a){const _0x43f01a=_0x5b0ee6,{payMpayApiQueryUrl:_0x531e1d}=await this[_0x43f01a(0x193)]['getConfigs']([_0x43f01a(0x1e4),_0x43f01a(0x1cc),'payMpayApiQueryUrl']),_0x2839d4={};_0x2839d4[_0x43f01a(0x1f0)]=0x2,_0x2839d4[_0x43f01a(0x207)]=_0x2bf37a;const {data:{code:_0x1072c3,msg:_0x41d7c7,data:_0x2e2b2f}}=await axios_1[_0x43f01a(0x240)][_0x43f01a(0x245)](_0x531e1d,{'params':_0x2839d4});if(_0x1072c3!=0x1)throw new common_1[(_0x43f01a(0x241))](_0x41d7c7,common_1[_0x43f01a(0x205)][_0x43f01a(0x190)]);return _0x2e2b2f;}async[_0x5b0ee6(0x1dd)](_0x20393e){const _0x3fd3b3=_0x5b0ee6;common_1[_0x3fd3b3(0x1c4)]['log'](_0x3fd3b3(0x1e1),_0x20393e);const {payWeChatAppId:_0x145a44,payWeChatMchId:_0x1eba59,payWeChatSecret:_0x4345fd,payWeChatPublicKey:_0x3c0857,payWeChatPrivateKey:_0x4d4006}=await this[_0x3fd3b3(0x193)]['getConfigs']([_0x3fd3b3(0x1c5),_0x3fd3b3(0x1b2),'payWeChatSecret',_0x3fd3b3(0x22b),_0x3fd3b3(0x1ee)]),_0x5f0272=new this[(_0x3fd3b3(0x19d))]({'appid':_0x145a44,'mchid':_0x1eba59,'publicKey':_0x3c0857,'privateKey':_0x4d4006});try{if(_0x20393e[_0x3fd3b3(0x216)]==_0x3fd3b3(0x23f)){const {ciphertext:_0x4a0334,associated_data:_0x410035,nonce:_0x564e5c}=_0x20393e[_0x3fd3b3(0x239)],_0x364277=_0x5f0272[_0x3fd3b3(0x1a0)](_0x4a0334,_0x410035,_0x564e5c,_0x4345fd),_0xc69cba=await this['orderEntity'][_0x3fd3b3(0x1fb)]({'where':{'orderId':_0x364277['out_trade_no'],'status':0x0}});if(!_0xc69cba)return'failed';const _0x24738e=_0x364277[_0x3fd3b3(0x1a3)]==_0x3fd3b3(0x17f)?0x1:0x2,_0x1b0d33=await this[_0x3fd3b3(0x1b1)][_0x3fd3b3(0x20b)]({'orderId':_0x364277[_0x3fd3b3(0x1d6)]},{'status':_0x24738e,'paydAt':new Date()});_0x24738e===0x1&&await this[_0x3fd3b3(0x243)][_0x3fd3b3(0x1b9)](_0xc69cba);if(_0x1b0d33[_0x3fd3b3(0x1ac)]!=0x1)return'failed';}return _0x3fd3b3(0x24b);}catch(_0x1c1ad6){return common_1[_0x3fd3b3(0x1c4)][_0x3fd3b3(0x1d9)](_0x3fd3b3(0x1a6),_0x1c1ad6),common_1[_0x3fd3b3(0x1c4)][_0x3fd3b3(0x1d9)]('支付通知验证失败:\x20',_0x1c1ad6),_0x3fd3b3(0x214);}}async[_0x5b0ee6(0x183)](_0x54d0be,_0x17b6b4,_0xf53d25='native'){const _0x159d27=_0x5b0ee6;var _0x49c4a1,_0x29a152,_0x4377f8,_0x4e7d86,_0x3668c3,_0x9a9ccb,_0x5b8b9b;common_1[_0x159d27(0x1c4)][_0x159d27(0x1d9)]('payType:\x20',_0xf53d25);const _0x386dde=await this['orderEntity'][_0x159d27(0x1fb)]({'where':{'userId':_0x54d0be,'orderId':_0x17b6b4}});if(!_0x386dde)throw new common_1['HttpException'](_0x159d27(0x1dc),common_1['HttpStatus']['BAD_REQUEST']);const _0x443a89=await this['cramiPackageEntity'][_0x159d27(0x1fb)]({'where':{'id':_0x386dde['goodsId']}});if(!_0x443a89)throw new common_1[(_0x159d27(0x241))]('套餐不存在!',common_1[_0x159d27(0x205)][_0x159d27(0x190)]);const {payWeChatAppId:_0x5ae193,payWeChatMchId:_0x33600d,payWeChatPublicKey:_0x1735ba,payWeChatPrivateKey:_0x458a65,payWeChatNotifyUrl:_0x530e08}=await this[_0x159d27(0x193)][_0x159d27(0x234)](['payWeChatAppId','payWeChatMchId',_0x159d27(0x22b),_0x159d27(0x1ee),_0x159d27(0x230)]),_0xa10df2=new this[(_0x159d27(0x19d))]({'appid':_0x5ae193,'mchid':_0x33600d,'publicKey':_0x1735ba,'privateKey':_0x458a65}),_0x57c750={'appid':_0x5ae193,'mchid':_0x33600d,'description':_0x443a89['name'],'out_trade_no':_0x17b6b4,'notify_url':_0x530e08,'amount':{'total':Math[_0x159d27(0x17d)](_0x386dde['total']*0x64)}};common_1[_0x159d27(0x1c4)][_0x159d27(0x1d9)](_0x159d27(0x1b3),_0x57c750);if(_0xf53d25==_0x159d27(0x21d)){common_1['Logger'][_0x159d27(0x1d9)](_0x159d27(0x18b)+_0x54d0be+_0x159d27(0x244)+_0x17b6b4);const _0x3406ab=await this['userService'][_0x159d27(0x226)](_0x54d0be);common_1[_0x159d27(0x1c4)][_0x159d27(0x1d9)]('[WeChat\x20Pay\x20JSAPI]\x20用户OpenID:\x20'+_0x3406ab),_0x57c750['payer']={'openid':_0x3406ab},common_1[_0x159d27(0x1c4)][_0x159d27(0x1d9)]('[WeChat\x20Pay\x20JSAPI]\x20发送支付请求参数:\x20',JSON[_0x159d27(0x1f9)](_0x57c750,null,0x2));try{const _0x1effbe=await _0xa10df2[_0x159d27(0x219)](_0x57c750),_0x33ff2f=_0x1effbe[_0x159d27(0x1e8)]?_0x1effbe[_0x159d27(0x1e8)]:_0x1effbe;return common_1[_0x159d27(0x1c4)][_0x159d27(0x1d9)]('[WeChat\x20Pay\x20JSAPI]\x20支付请求成功，返回结果:\x20',JSON['stringify'](_0x33ff2f,null,0x2)),{'status':_0x1effbe[_0x159d27(0x1f8)]||_0x159d27(0x1a1),'appId':_0x33ff2f[_0x159d27(0x1d3)]||((_0x49c4a1=_0x33ff2f[_0x159d27(0x1e8)])===null||_0x49c4a1===void 0x0?void 0x0:_0x49c4a1[_0x159d27(0x1d3)]),'timeStamp':_0x33ff2f[_0x159d27(0x198)]||((_0x29a152=_0x33ff2f[_0x159d27(0x1e8)])===null||_0x29a152===void 0x0?void 0x0:_0x29a152[_0x159d27(0x198)]),'nonceStr':_0x33ff2f[_0x159d27(0x232)]||((_0x4377f8=_0x33ff2f[_0x159d27(0x1e8)])===null||_0x4377f8===void 0x0?void 0x0:_0x4377f8[_0x159d27(0x232)]),'package':_0x33ff2f[_0x159d27(0x211)]||((_0x4e7d86=_0x33ff2f[_0x159d27(0x1e8)])===null||_0x4e7d86===void 0x0?void 0x0:_0x4e7d86[_0x159d27(0x211)]),'signType':_0x33ff2f['signType']||((_0x3668c3=_0x33ff2f[_0x159d27(0x1e8)])===null||_0x3668c3===void 0x0?void 0x0:_0x3668c3[_0x159d27(0x1e3)]),'paySign':_0x33ff2f[_0x159d27(0x184)]||((_0x9a9ccb=_0x33ff2f[_0x159d27(0x1e8)])===null||_0x9a9ccb===void 0x0?void 0x0:_0x9a9ccb[_0x159d27(0x184)])};}catch(_0x5eab31){console['error'](_0x159d27(0x1d0)+_0x5eab31[_0x159d27(0x1f1)],_0x5eab31),console[_0x159d27(0x1b7)]('[WeChat\x20Pay\x20JSAPI]\x20完整的错误对象：',_0x5eab31);throw new common_1['HttpException']('JSAPI支付失败',common_1[_0x159d27(0x205)][_0x159d27(0x190)]);}}if(_0xf53d25==_0x159d27(0x23d)){common_1['Logger'][_0x159d27(0x1d9)](_0x159d27(0x1e6)+_0x17b6b4+_0x159d27(0x22d)+_0x54d0be);try{const _0x195e10=await _0xa10df2[_0x159d27(0x221)](_0x57c750);common_1[_0x159d27(0x1c4)][_0x159d27(0x1d9)](_0x159d27(0x1d5),JSON[_0x159d27(0x1f9)](_0x195e10,null,0x2));let _0x5af712=_0x195e10[_0x159d27(0x1de)]||((_0x5b8b9b=_0x195e10[_0x159d27(0x1e8)])===null||_0x5b8b9b===void 0x0?void 0x0:_0x5b8b9b[_0x159d27(0x1de)]);return!_0x5af712?console[_0x159d27(0x1b7)]('微信Native支付请求成功，但未返回code_url，响应数据:\x20',JSON[_0x159d27(0x1f9)](_0x195e10,null,0x2)):common_1[_0x159d27(0x1c4)][_0x159d27(0x1d9)](_0x159d27(0x235)+_0x5af712),{'url_qrcode':_0x5af712,'isRedirect':![]};}catch(_0x3ee306){console['error']('微信Native支付过程中发生错误，错误信息:\x20'+_0x3ee306[_0x159d27(0x1f1)],_0x3ee306),console[_0x159d27(0x1b7)](_0x159d27(0x206),_0x3ee306);throw new common_1[(_0x159d27(0x241))](_0x159d27(0x1e0),common_1[_0x159d27(0x205)][_0x159d27(0x190)]);}}else{console[_0x159d27(0x1df)]('支付请求使用了不支持的支付类型:\x20'+_0xf53d25);throw new common_1[(_0x159d27(0x241))](_0x159d27(0x20e),common_1[_0x159d27(0x205)][_0x159d27(0x190)]);}}async[_0x5b0ee6(0x1b6)](_0x510e32){const _0x241eea=_0x5b0ee6,{payWeChatAppId:_0x791eba,payWeChatMchId:_0x1ca712,payWeChatPublicKey:_0x2b29f8,payWeChatPrivateKey:_0x5e0ff7,payWeChatNotifyUrl:_0x4ea49b}=await this['globalConfigService'][_0x241eea(0x234)]([_0x241eea(0x1c5),_0x241eea(0x1b2),'payWeChatPublicKey','payWeChatPrivateKey']),_0x580ec5=new this[(_0x241eea(0x19d))]({'appid':_0x791eba,'mchid':_0x1ca712,'publicKey':_0x2b29f8,'privateKey':_0x5e0ff7}),_0x564a8d=await _0x580ec5['query']({'out_trade_no':_0x510e32});return _0x564a8d;}[_0x5b0ee6(0x1cb)](_0x320cbb,_0x5c3822){const _0x2a2c9f=_0x5b0ee6,_0x260d78=Object['keys'](_0x320cbb)['sort']()[_0x2a2c9f(0x20a)](_0xcec9b2=>_0xcec9b2+'='+_0x320cbb[_0xcec9b2])[_0x2a2c9f(0x189)]('&')+_0x5c3822;return crypto[_0x2a2c9f(0x202)](_0x2a2c9f(0x237))[_0x2a2c9f(0x20b)](_0x260d78)['digest'](_0x2a2c9f(0x1c8));}[_0x5b0ee6(0x1e5)](_0x3e7bd0,_0x5da083){const _0xd95b4c=_0x5b0ee6,_0xba35df=Object['keys'](_0x3e7bd0);_0xba35df[_0xd95b4c(0x1cd)]();const _0x17fd6a=[];_0xba35df[_0xd95b4c(0x20a)](_0x148395=>{const _0x2566ad=_0xd95b4c;_0x17fd6a[_0x2566ad(0x199)](_0x148395+'='+_0x3e7bd0[_0x148395]);}),_0x17fd6a[_0xd95b4c(0x199)]('key='+_0x5da083);const _0x1e98b7=_0x17fd6a[_0xd95b4c(0x189)]('&');return crypto[_0xd95b4c(0x202)](_0xd95b4c(0x237))['update'](_0x1e98b7)[_0xd95b4c(0x188)](_0xd95b4c(0x1c8))[_0xd95b4c(0x22c)]();}async['payLtzf'](_0x59e2fd,_0x55849b,_0x2caa32=_0x5b0ee6(0x20d)){const _0x554557=_0x5b0ee6,_0x250614=await this[_0x554557(0x1b1)][_0x554557(0x1fb)]({'where':{'userId':_0x59e2fd,'orderId':_0x55849b}});if(!_0x250614)throw new common_1['HttpException'](_0x554557(0x1dc),common_1[_0x554557(0x205)]['BAD_REQUEST']);const _0x54698a=await this[_0x554557(0x1bc)][_0x554557(0x1fb)]({'where':{'id':_0x250614[_0x554557(0x1ad)]}});if(!_0x54698a)throw new common_1[(_0x554557(0x241))](_0x554557(0x23e),common_1[_0x554557(0x205)][_0x554557(0x190)]);const {payLtzfMchId:_0x1086f9,payLtzfSecret:_0x3dfbd9,payLtzfNotifyUrl:_0x4563e6,payLtzfReturnUrl:_0x51dc4d}=await this[_0x554557(0x193)][_0x554557(0x234)]([_0x554557(0x1a9),_0x554557(0x18c),_0x554557(0x186),_0x554557(0x17c)]),_0x34e349={};_0x34e349[_0x554557(0x1fd)]=_0x1086f9,_0x34e349[_0x554557(0x1af)]=(Date['now']()/0x3e8)[_0x554557(0x1da)](0x0),_0x34e349[_0x554557(0x1d6)]=_0x55849b,_0x34e349['body']=_0x54698a[_0x554557(0x1ea)],_0x34e349['total_fee']=_0x250614[_0x554557(0x1a2)],_0x34e349[_0x554557(0x180)]=_0x4563e6,_0x34e349[_0x554557(0x1cb)]=this[_0x554557(0x1e5)](_0x34e349,_0x3dfbd9),_0x34e349['attach']='ltzf',_0x34e349[_0x554557(0x20c)]=_0x51dc4d;const _0x3f20d9=Object['keys'](_0x34e349)[_0x554557(0x20a)](_0x1ee475=>encodeURIComponent(_0x1ee475)+'='+encodeURIComponent(_0x34e349[_0x1ee475]))['join']('&'),_0x42ce9b={'headers':{'Content-Type':'application/x-www-form-urlencoded'}},_0x5ca357=await axios_1[_0x554557(0x240)][_0x554557(0x21e)](_0x554557(0x1e2),_0x3f20d9,_0x42ce9b),{code:_0x38b95d,data:_0xd21dc3,msg:_0x190dcf}=_0x5ca357[_0x554557(0x1e8)];if(_0x38b95d!=0x0)throw new common_1[(_0x554557(0x241))](_0x190dcf,common_1[_0x554557(0x205)]['BAD_REQUEST']);const _0x513ccf=_0xd21dc3[_0x554557(0x1aa)],_0x5d3cd3=_0xd21dc3[_0x554557(0x194)];return{'url_qrcode':_0x513ccf,'url':_0x5d3cd3};}async[_0x5b0ee6(0x21b)](_0x5e7348){const _0x463800=_0x5b0ee6,{payLtzfMchId:_0x53cc2d,payLtzfSecret:_0x17ad98}=await this['globalConfigService']['getConfigs']([_0x463800(0x1a9),'payLtzfSecret']),_0x139469={};_0x139469['mch_id']=_0x53cc2d,_0x139469[_0x463800(0x1af)]=(Date[_0x463800(0x191)]()/0x3e8)[_0x463800(0x1da)](0x0),_0x139469[_0x463800(0x1d6)]=_0x5e7348,_0x139469[_0x463800(0x1cb)]=this['ltzfSign'](_0x139469,_0x17ad98);const _0x15af52=Object[_0x463800(0x1bd)](_0x139469)[_0x463800(0x20a)](_0xff0e26=>encodeURIComponent(_0xff0e26)+'='+encodeURIComponent(_0x139469[_0xff0e26]))['join']('&'),_0x18ae7c={'headers':{'Content-Type':_0x463800(0x1d8)}},{data:{code:_0x4a9a90,msg:_0x30bcd9,data:_0x4b16a2}}=await axios_1[_0x463800(0x240)][_0x463800(0x21e)](_0x463800(0x1f2),_0x15af52,_0x18ae7c);if(_0x4a9a90!=0x0)throw new common_1[(_0x463800(0x241))](_0x30bcd9+JSON[_0x463800(0x1f9)](_0x139469),common_1[_0x463800(0x205)][_0x463800(0x190)]);return _0x4b16a2;}async[_0x5b0ee6(0x1be)](_0x4c5286){const _0x1ed4ac=_0x5b0ee6,_0x191a6d=await this[_0x1ed4ac(0x193)]['getConfigs'](['payLtzfSecret']),_0x41a2a2=_0x4c5286['sign'];delete _0x4c5286['sign'],delete _0x4c5286['pay_channel'],delete _0x4c5286[_0x1ed4ac(0x1c7)],delete _0x4c5286[_0x1ed4ac(0x200)],delete _0x4c5286['attach'],delete _0x4c5286[_0x1ed4ac(0x1f4)];if(this['ltzfSign'](_0x4c5286,_0x191a6d)!=_0x41a2a2)return _0x1ed4ac(0x1f7);const _0x5db429=await this[_0x1ed4ac(0x1b1)]['findOne']({'where':{'orderId':_0x4c5286['out_trade_no'],'status':0x0}});if(!_0x5db429)return _0x1ed4ac(0x1f7);await this[_0x1ed4ac(0x243)]['addBalanceToOrder'](_0x5db429);const _0x44941c=await this['orderEntity']['update']({'orderId':_0x4c5286[_0x1ed4ac(0x1d6)]},{'status':0x1,'paydAt':new Date()});if(_0x44941c[_0x1ed4ac(0x1ac)]!=0x1)return _0x1ed4ac(0x1f7);return _0x1ed4ac(0x17f);}};PayService=__decorate([(0x0,common_1[_0x5b0ee6(0x208)])(),__param(0x0,(0x0,typeorm_1[_0x5b0ee6(0x1fc)])(cramiPackage_entity_1[_0x5b0ee6(0x20f)])),__param(0x1,(0x0,typeorm_1[_0x5b0ee6(0x1fc)])(order_entity_1[_0x5b0ee6(0x181)])),__metadata(_0x5b0ee6(0x1fe),[typeorm_2[_0x5b0ee6(0x19a)],typeorm_2[_0x5b0ee6(0x19a)],userBalance_service_1[_0x5b0ee6(0x1b0)],globalConfig_service_1[_0x5b0ee6(0x223)],user_service_1['UserService']])],PayService),exports['PayService']=PayService;