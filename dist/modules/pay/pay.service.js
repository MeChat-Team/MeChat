'use strict';const _0x9e7147=_0x2bf0;(function(_0xd98a5f,_0x213a28){const _0x3f6ad6=_0x2bf0,_0x26449b=_0xd98a5f();while(!![]){try{const _0xf244b0=-parseInt(_0x3f6ad6(0x1e4))/0x1+-parseInt(_0x3f6ad6(0x1f4))/0x2+parseInt(_0x3f6ad6(0x24c))/0x3*(parseInt(_0x3f6ad6(0x269))/0x4)+-parseInt(_0x3f6ad6(0x23a))/0x5+parseInt(_0x3f6ad6(0x21e))/0x6*(parseInt(_0x3f6ad6(0x262))/0x7)+-parseInt(_0x3f6ad6(0x24f))/0x8*(-parseInt(_0x3f6ad6(0x273))/0x9)+parseInt(_0x3f6ad6(0x272))/0xa;if(_0xf244b0===_0x213a28)break;else _0x26449b['push'](_0x26449b['shift']());}catch(_0x529cdd){_0x26449b['push'](_0x26449b['shift']());}}}(_0x44a4,0xd0923));var __decorate=this&&this['__decorate']||function(_0x5cd2a4,_0x274cd3,_0x38acf6,_0x12780e){const _0x587601=_0x2bf0;var _0x4dc139=arguments[_0x587601(0x1da)],_0x3f17bc=_0x4dc139<0x3?_0x274cd3:_0x12780e===null?_0x12780e=Object[_0x587601(0x264)](_0x274cd3,_0x38acf6):_0x12780e,_0x5a73da;if(typeof Reflect===_0x587601(0x226)&&typeof Reflect[_0x587601(0x258)]===_0x587601(0x21f))_0x3f17bc=Reflect[_0x587601(0x258)](_0x5cd2a4,_0x274cd3,_0x38acf6,_0x12780e);else{for(var _0x2d6714=_0x5cd2a4[_0x587601(0x1da)]-0x1;_0x2d6714>=0x0;_0x2d6714--)if(_0x5a73da=_0x5cd2a4[_0x2d6714])_0x3f17bc=(_0x4dc139<0x3?_0x5a73da(_0x3f17bc):_0x4dc139>0x3?_0x5a73da(_0x274cd3,_0x38acf6,_0x3f17bc):_0x5a73da(_0x274cd3,_0x38acf6))||_0x3f17bc;}return _0x4dc139>0x3&&_0x3f17bc&&Object[_0x587601(0x1e5)](_0x274cd3,_0x38acf6,_0x3f17bc),_0x3f17bc;},__metadata=this&&this[_0x9e7147(0x222)]||function(_0x304982,_0x1f5dde){const _0x28c953=_0x9e7147;if(typeof Reflect===_0x28c953(0x226)&&typeof Reflect[_0x28c953(0x1ff)]===_0x28c953(0x21f))return Reflect[_0x28c953(0x1ff)](_0x304982,_0x1f5dde);},__param=this&&this['__param']||function(_0x327156,_0x446b8d){return function(_0x1aa4d9,_0x2399cd){_0x446b8d(_0x1aa4d9,_0x2399cd,_0x327156);};};Object[_0x9e7147(0x1e5)](exports,_0x9e7147(0x211),{'value':!![]}),exports['PayService']=void 0x0;const utils_1=require(_0x9e7147(0x248)),common_1=require(_0x9e7147(0x1c9)),typeorm_1=require(_0x9e7147(0x1c5)),axios_1=require(_0x9e7147(0x205)),crypto=require(_0x9e7147(0x1f6)),typeorm_2=require(_0x9e7147(0x252)),cramiPackage_entity_1=require('../crami/cramiPackage.entity'),globalConfig_service_1=require(_0x9e7147(0x1bd)),order_entity_1=require('../order/order.entity'),user_service_1=require(_0x9e7147(0x25e)),userBalance_service_1=require('../userBalance/userBalance.service');function _0x2bf0(_0x5a167c,_0x484a64){const _0x44a4d6=_0x44a4();return _0x2bf0=function(_0x2bf049,_0x49887d){_0x2bf049=_0x2bf049-0x1a4;let _0x804ddc=_0x44a4d6[_0x2bf049];return _0x804ddc;},_0x2bf0(_0x5a167c,_0x484a64);}function _0x44a4(){const _0x2fbd59=['md5','4529493dbQsNs','transactions_jsapi','act','1672XKxxkF','hupi','findOne','typeorm','payMpayReturnUrl','payWeChatSecret','payEpay','UserBalanceService','keys','decorate','trade_status','now','payMpayApiQueryUrl','[WeChat\x20Pay\x20JSAPI]\x20发送支付请求参数:\x20','appId','../user/user.service','affected','version','resource','4109MjzijP','https://api.ltzf.cn/api/wxpay/get_pay_order','getOwnPropertyDescriptor','design:paramtypes','appid','body','GlobalConfigService','4TLatsX','map','payMpaySecret','UserService','payWeChatMchId','支付请求使用了不支持的支付类型:\x20','key=','支付通知验证失败:\x20','notifyEpay','18735560CLBKXM','27927HdcGDU','paySign','package','sort','orderEntity','update','name','alipay','TRADE_SUCCESS','https://api.xunhupay.com/payment/query.html','payLtzfSecret','payLtzfNotifyUrl','payWeChatPublicKey','payHupiGatewayUrl','toUpperCase','device','nonce_str','192.168.1.100','payHupiSecret','total','WxPay','queryMpay','payPlatform','https://api.ltzf.cn/api/wxpay/jsapi_convenient','payHupiNotifyUrl','unsupported\x20pay\x20type','cramiPackageEntity','title','addBalanceToOrder','out_trade_no','error','Logger','transactions_native','payLtzfMchId','../globalConfig/globalConfig.service','join','createRandomNonceStr','微信Native支付响应数据:\x20','signType','code_url','pid','微信支付通知params:\x20','@nestjs/typeorm','notify_url','trade_state','[WeChat\x20Pay\x20JSAPI]\x20用户OpenID:\x20','@nestjs/common','校验签名通过','attach','SUCCESS','payEpayPid',',\x20用户ID:\x20','submit.php','queryLtzf','clientip','nonceStr','payWeChatAppId','toFixed','Repository','total_fee','trade_order_id','order_no','payEpayNotifyUrl','length','FAIL','data','[WeChat\x20Pay\x20JSAPI]\x20开始JSAPI支付流程，用户ID:\x20','notifyHupi','timeStamp','out_trade_order','HttpStatus','query','ltzf','1310870ChEphn','defineProperty','type','getOpenIdByUserId','userBalanceService','default','error:\x20','Injectable','微信Native支付请求成功，但未返回code_url，响应数据:\x20','status','includes','订单不存在!','payEpaySecret','digest','toString','trade_type','2594584XwvNeG','payHupiAppId','crypto','key','sign','push','BAD_REQUEST','userService','payHupi','wxpay','warn','metadata','notifyLtzf','hex','[WeChat\x20Pay\x20JSAPI]\x20支付请求成功，返回结果:\x20','本次支付类型:\x20','[WeChat\x20Pay\x20JSAPI]\x20完整的错误对象：','axios','get','微信Native支付失败','payWeChatPrivateKey','time','QRcode_url','message','payWeChat','param','payWeChatNotifyUrl','native','createHash','__esModule','return_url','[WeChat\x20Pay\x20JSAPI]\x20支付请求过程中发生错误:\x20','https://api.xunhupay.com/payment/do.html','order','payEpayApiPayUrl','微信Native支付请求成功，code_url:\x20','payer','epay','goodsId','套餐不存在!','unknown','post','4962EuUdQC','function','getConfigs','TRANSACTION.SUCCESS','__metadata','ltzfSign','timestamp','CramiPackageEntity','object','mch_id','round','payEpayReturnUrl','globalConfigService','notifyWeChat','money','notifyMpay','HttpException','sign_type','status:\x20','wechat-pay:\x20','InjectRepository','decipher_gcm','success_time','payLtzfReturnUrl','notify','success','1.1','failed','5274470oQqnXR','wechatpay-node-v3','epay\x20--->\x20res:\x20','openid','payMpayApiPayUrl','log','stringify','hash',',\x20订单ID:\x20','MD5','event_type','application/x-www-form-urlencoded','pay','payMpayNotifyUrl','../../common/utils','payEpayApiQueryUrl','JSAPI支付失败'];_0x44a4=function(){return _0x2fbd59;};return _0x44a4();}let PayService=class PayService{constructor(_0x1cdf38,_0x1cdd53,_0x1302c0,_0x32926b,_0x12f516){const _0x1c60f1=_0x9e7147;this[_0x1c60f1(0x1b5)]=_0x1cdf38,this[_0x1c60f1(0x277)]=_0x1cdd53,this[_0x1c60f1(0x1e8)]=_0x1302c0,this[_0x1c60f1(0x22a)]=_0x32926b,this[_0x1c60f1(0x1fb)]=_0x12f516;}async['onModuleInit'](){const _0x514059=_0x9e7147,_0xb40e7e=await(0x0,utils_1['importDynamic'])(_0x514059(0x23b));this[_0x514059(0x1af)]=(_0xb40e7e===null||_0xb40e7e===void 0x0?void 0x0:_0xb40e7e[_0x514059(0x1e9)])?_0xb40e7e[_0x514059(0x1e9)]:_0xb40e7e;}async[_0x9e7147(0x236)](_0x563051){const _0x4f752a=_0x9e7147;if(_0x563051[_0x4f752a(0x20d)]==_0x4f752a(0x219))return this['notifyEpay'](_0x563051);if(_0x563051['attach']==_0x4f752a(0x250))return this[_0x4f752a(0x1de)](_0x563051);if(_0x563051[_0x4f752a(0x1cb)]==_0x4f752a(0x1e3))return this['notifyLtzf'](_0x563051);if(typeof _0x563051[_0x4f752a(0x261)]==_0x4f752a(0x226))return this['notifyWeChat'](_0x563051);return this[_0x4f752a(0x22d)](_0x563051);}async[_0x9e7147(0x246)](_0x52022a,_0x262f81,_0x419418=_0x9e7147(0x1fd)){const _0x318bd6=_0x9e7147,_0x3880db=await this['orderEntity'][_0x318bd6(0x251)]({'where':{'userId':_0x52022a,'orderId':_0x262f81}});if(!_0x3880db)throw new common_1[(_0x318bd6(0x22e))](_0x318bd6(0x1ef),common_1[_0x318bd6(0x1e1)][_0x318bd6(0x1fa)]);const _0x2fec7c=await this[_0x318bd6(0x1b5)][_0x318bd6(0x251)]({'where':{'id':_0x3880db[_0x318bd6(0x21a)]}});if(!_0x2fec7c)throw new common_1[(_0x318bd6(0x22e))](_0x318bd6(0x21b),common_1[_0x318bd6(0x1e1)][_0x318bd6(0x1fa)]);common_1[_0x318bd6(0x1ba)]['log'](_0x318bd6(0x203),_0x3880db['payPlatform']);try{if(_0x3880db[_0x318bd6(0x1b1)]=='wechat')return this[_0x318bd6(0x20c)](_0x52022a,_0x262f81,_0x419418);if(_0x3880db[_0x318bd6(0x1b1)]=='epay')return this[_0x318bd6(0x255)](_0x52022a,_0x262f81,_0x419418);if(_0x3880db[_0x318bd6(0x1b1)]=='mpay')return this['payMpay'](_0x52022a,_0x262f81,_0x419418);if(_0x3880db['payPlatform']==_0x318bd6(0x250))return this[_0x318bd6(0x1fc)](_0x52022a,_0x262f81,_0x419418);if(_0x3880db[_0x318bd6(0x1b1)]=='ltzf')return this['payLtzf'](_0x52022a,_0x262f81,_0x419418);}catch(_0x358be1){common_1['Logger'][_0x318bd6(0x23f)]('支付请求失败:\x20',_0x358be1);throw new common_1['HttpException']('支付请求失败!',common_1[_0x318bd6(0x1e1)][_0x318bd6(0x1fa)]);}}async['query'](_0x37166c){const _0x51f368=_0x9e7147,_0x31bef3=await this['orderEntity'][_0x51f368(0x251)]({'where':{'orderId':_0x37166c}});if(!_0x31bef3)throw new common_1[(_0x51f368(0x22e))](_0x51f368(0x1ef),common_1[_0x51f368(0x1e1)][_0x51f368(0x1fa)]);return _0x31bef3;}async[_0x9e7147(0x1de)](_0x52f6a7){const _0x1dc03a=_0x9e7147,_0x19ef15=await this[_0x1dc03a(0x22a)][_0x1dc03a(0x220)](['payHupiSecret']),_0x2bae95=_0x52f6a7[_0x1dc03a(0x241)];delete _0x52f6a7['hash'];if(this[_0x1dc03a(0x1f8)](_0x52f6a7,_0x19ef15)!=_0x2bae95)return _0x1dc03a(0x239);const _0x35a526=await this[_0x1dc03a(0x277)][_0x1dc03a(0x251)]({'where':{'orderId':_0x52f6a7[_0x1dc03a(0x1d7)],'status':0x0}});if(!_0x35a526)return _0x1dc03a(0x239);await this['userBalanceService']['addBalanceToOrder'](_0x35a526);const _0x432362=await this['orderEntity'][_0x1dc03a(0x278)]({'orderId':_0x52f6a7['trade_order_id']},{'status':0x1,'paydAt':new Date()});if(_0x432362[_0x1dc03a(0x25f)]!=0x1)return _0x1dc03a(0x239);return _0x1dc03a(0x237);}async['payHupi'](_0x588e38,_0x2f6d02,_0x57944f=_0x9e7147(0x1fd)){const _0x4258f4=_0x9e7147,_0x155cd0=await this[_0x4258f4(0x277)][_0x4258f4(0x251)]({'where':{'userId':_0x588e38,'orderId':_0x2f6d02}});if(!_0x155cd0)throw new common_1['HttpException']('订单不存在!',common_1['HttpStatus'][_0x4258f4(0x1fa)]);const _0x12a796=await this[_0x4258f4(0x1b5)]['findOne']({'where':{'id':_0x155cd0[_0x4258f4(0x21a)]}});if(!_0x12a796)throw new common_1['HttpException']('套餐不存在!',common_1[_0x4258f4(0x1e1)][_0x4258f4(0x1fa)]);const {payHupiAppId:_0x1b3ae8,payHupiSecret:_0x5bf735,payHupiNotifyUrl:_0x1e259f,payHupiReturnUrl:_0x18270a,payHupiGatewayUrl:_0x144978}=await this[_0x4258f4(0x22a)]['getConfigs']([_0x4258f4(0x1f5),_0x4258f4(0x1ad),_0x4258f4(0x1b3),'payHupiReturnUrl',_0x4258f4(0x1a8)]),_0x35e003={};_0x35e003[_0x4258f4(0x260)]='1.1',_0x35e003[_0x4258f4(0x266)]=_0x1b3ae8,_0x35e003[_0x4258f4(0x209)]=(Date[_0x4258f4(0x25a)]()/0x3e8)[_0x4258f4(0x1d4)](0x0),_0x35e003['nonce_str']=(0x0,utils_1[_0x4258f4(0x1bf)])(0x20),_0x35e003['trade_order_id']=_0x2f6d02,_0x35e003[_0x4258f4(0x1b6)]=_0x12a796['name'],_0x35e003[_0x4258f4(0x1d6)]=_0x155cd0[_0x4258f4(0x1ae)],_0x35e003['notify_url']=_0x1e259f,_0x35e003[_0x4258f4(0x212)]=_0x18270a,_0x35e003[_0x4258f4(0x1cb)]=_0x4258f4(0x250),_0x35e003[_0x4258f4(0x241)]=this[_0x4258f4(0x1f8)](_0x35e003,_0x5bf735);const {data:{errcode:_0x54587c,errmsg:_0x4ea865,url_qrcode:_0x151b1a,url:_0x357cd5}}=await axios_1['default'][_0x4258f4(0x21d)](_0x144978||_0x4258f4(0x214),_0x35e003);if(_0x54587c!=0x0)throw new common_1[(_0x4258f4(0x22e))](_0x4ea865,common_1['HttpStatus'][_0x4258f4(0x1fa)]);return{'url_qrcode':_0x151b1a,'url':_0x357cd5};}async['queryHupi'](_0x553a9e){const _0x139fab=_0x9e7147,{payHupiAppId:_0x47c86a,payHupiSecret:_0x181491}=await this[_0x139fab(0x22a)]['getConfigs']([_0x139fab(0x1f5),'payHupiSecret']),_0x182575={};_0x182575[_0x139fab(0x260)]=_0x139fab(0x238),_0x182575[_0x139fab(0x266)]=_0x47c86a,_0x182575[_0x139fab(0x209)]=(Date['now']()/0x3e8)[_0x139fab(0x1d4)](0x0),_0x182575[_0x139fab(0x1ab)]=(0x0,utils_1[_0x139fab(0x1bf)])(0x20),_0x182575[_0x139fab(0x1e0)]=_0x553a9e,_0x182575[_0x139fab(0x241)]=this[_0x139fab(0x1f8)](_0x182575,_0x181491);const {data:{errcode:_0x2304c0,errmsg:_0x39a05c,data:_0x31545b}}=await axios_1[_0x139fab(0x1e9)]['post'](_0x139fab(0x1a4),_0x182575);if(_0x2304c0!=0x0)throw new common_1[(_0x139fab(0x22e))](_0x39a05c,common_1[_0x139fab(0x1e1)][_0x139fab(0x1fa)]);return _0x31545b;}async[_0x9e7147(0x271)](_0x5102ad){const _0x3f7a95=_0x9e7147,_0x539545=_0x5102ad[_0x3f7a95(0x1f8)];delete _0x5102ad[_0x3f7a95(0x1f8)],delete _0x5102ad[_0x3f7a95(0x22f)];const _0x4d8793=await this[_0x3f7a95(0x22a)][_0x3f7a95(0x220)](['payEpaySecret']);if(this[_0x3f7a95(0x1f8)](_0x5102ad,_0x4d8793)!=_0x539545)return _0x3f7a95(0x239);common_1[_0x3f7a95(0x1ba)]['log'](_0x3f7a95(0x1ca));const _0x1f1099=await this[_0x3f7a95(0x277)][_0x3f7a95(0x251)]({'where':{'orderId':_0x5102ad[_0x3f7a95(0x1b8)],'status':0x0}});if(!_0x1f1099)return'failed';const _0x48020e=_0x5102ad[_0x3f7a95(0x259)]==_0x3f7a95(0x27b)?0x1:0x2,_0x585b8f=await this[_0x3f7a95(0x277)][_0x3f7a95(0x278)]({'orderId':_0x5102ad[_0x3f7a95(0x1b8)]},{'status':_0x48020e,'paydAt':new Date()});_0x48020e===0x1&&await this[_0x3f7a95(0x1e8)]['addBalanceToOrder'](_0x1f1099);if(_0x585b8f[_0x3f7a95(0x25f)]!=0x1)return _0x3f7a95(0x239);return'success';}async[_0x9e7147(0x255)](_0x56be92,_0x2da318,_0x9f72f6=_0x9e7147(0x27a)){const _0x1aab5c=_0x9e7147,_0x4f0c4b=await this[_0x1aab5c(0x277)][_0x1aab5c(0x251)]({'where':{'userId':_0x56be92,'orderId':_0x2da318}});if(!_0x4f0c4b)throw new common_1['HttpException'](_0x1aab5c(0x1ef),common_1['HttpStatus'][_0x1aab5c(0x1fa)]);const _0x576b4a=await this['cramiPackageEntity'][_0x1aab5c(0x251)]({'where':{'id':_0x4f0c4b[_0x1aab5c(0x21a)]}});if(!_0x576b4a)throw new common_1['HttpException'](_0x1aab5c(0x21b),common_1[_0x1aab5c(0x1e1)]['BAD_REQUEST']);const {payEpayPid:_0x585779,payEpaySecret:_0x5ac058,payEpayNotifyUrl:_0x3c1186,payEpayReturnUrl:_0x466007,payEpayApiPayUrl:_0x413bbd}=await this['globalConfigService'][_0x1aab5c(0x220)](['payEpayPid',_0x1aab5c(0x1f0),_0x1aab5c(0x1d9),_0x1aab5c(0x229),_0x1aab5c(0x216)]);let _0x17f397;_0x585779['length']<=0x10?_0x17f397=Number(_0x585779):_0x17f397=BigInt(_0x585779);const _0x14061c={};_0x14061c[_0x1aab5c(0x1c3)]=_0x17f397,_0x14061c[_0x1aab5c(0x1e6)]=_0x9f72f6,_0x14061c[_0x1aab5c(0x1b8)]=_0x2da318,_0x14061c[_0x1aab5c(0x279)]=_0x576b4a[_0x1aab5c(0x279)],_0x14061c[_0x1aab5c(0x22c)]=_0x4f0c4b[_0x1aab5c(0x1ae)],_0x14061c[_0x1aab5c(0x1d1)]=_0x1aab5c(0x1ac),_0x14061c[_0x1aab5c(0x1aa)]='pc',_0x14061c['notify_url']=_0x3c1186,_0x14061c[_0x1aab5c(0x212)]=_0x466007,_0x14061c[_0x1aab5c(0x20d)]='epay',_0x14061c[_0x1aab5c(0x1f8)]=this[_0x1aab5c(0x1f8)](_0x14061c,_0x5ac058),_0x14061c[_0x1aab5c(0x22f)]='MD5';const _0x9dc937=new URLSearchParams(_0x14061c)[_0x1aab5c(0x1f2)](),_0x5222ad=_0x413bbd+'?'+_0x9dc937;if(_0x413bbd[_0x1aab5c(0x1ee)](_0x1aab5c(0x1cf)))return{'url_qrcode':null,'redirectUrl':_0x5222ad,'channel':_0x9f72f6,'isRedirect':!![]};else{const _0x1670a4={'headers':{'Content-Type':_0x1aab5c(0x245)}},_0x35ab4f=await axios_1[_0x1aab5c(0x1e9)][_0x1aab5c(0x21d)](_0x413bbd,_0x14061c,_0x1670a4);common_1['Logger'][_0x1aab5c(0x23f)](_0x1aab5c(0x23c),_0x35ab4f[_0x1aab5c(0x1dc)]);const {data:{code:_0x259669,msg:_0x1dc4b1,qrcode:_0x5f7de1}}=_0x35ab4f;if(_0x259669!=0x1)throw new common_1[(_0x1aab5c(0x22e))](_0x1dc4b1,common_1[_0x1aab5c(0x1e1)][_0x1aab5c(0x1fa)]);return{'url_qrcode':_0x5f7de1,'redirectUrl':null,'channel':_0x9f72f6,'isRedirect':![]};}}async['queryEpay'](_0x485045){const _0x39f5df=_0x9e7147,{payEpayPid:_0x4ef245,payEpaySecret:_0x5ca923,payEpayApiQueryUrl:_0x7f7fc1}=await this[_0x39f5df(0x22a)][_0x39f5df(0x220)]([_0x39f5df(0x1cd),_0x39f5df(0x1f0),_0x39f5df(0x249)]),_0x535c96={};_0x535c96[_0x39f5df(0x24e)]=_0x39f5df(0x215),_0x535c96[_0x39f5df(0x1b8)]=_0x485045,_0x535c96[_0x39f5df(0x1c3)]=_0x4ef245,_0x535c96[_0x39f5df(0x1f7)]=_0x5ca923;const {data:{code:_0x2fa85b,msg:_0x448892,data:_0x2ecd75}}=await axios_1[_0x39f5df(0x1e9)][_0x39f5df(0x206)](_0x7f7fc1,{'params':_0x535c96});if(_0x2fa85b!=0x1)throw new common_1[(_0x39f5df(0x22e))](_0x448892,common_1[_0x39f5df(0x1e1)][_0x39f5df(0x1fa)]);return _0x2ecd75;}async[_0x9e7147(0x22d)](_0x4f7de4){const _0x51598c=_0x9e7147,_0x1622e9=_0x4f7de4[_0x51598c(0x1f8)];delete _0x4f7de4[_0x51598c(0x1f8)],delete _0x4f7de4[_0x51598c(0x22f)];const _0x1621a9=await this['globalConfigService']['getConfigs'](['payMpaySecret']);common_1[_0x51598c(0x1ba)][_0x51598c(0x23f)]('校验签名');if(this[_0x51598c(0x1f8)](_0x4f7de4,_0x1621a9)!=_0x1622e9)return _0x51598c(0x239);common_1[_0x51598c(0x1ba)]['log'](_0x51598c(0x1ca));const _0x887ec=await this[_0x51598c(0x277)][_0x51598c(0x251)]({'where':{'orderId':_0x4f7de4['out_trade_no'],'status':0x0}});if(!_0x887ec)return _0x51598c(0x239);const _0xca2c8e=_0x4f7de4[_0x51598c(0x259)]==_0x51598c(0x27b)?0x1:0x2;common_1[_0x51598c(0x1ba)][_0x51598c(0x23f)](_0x51598c(0x230),_0xca2c8e);const _0x154808=await this[_0x51598c(0x277)][_0x51598c(0x278)]({'orderId':_0x4f7de4[_0x51598c(0x1b8)]},{'status':_0xca2c8e,'paydAt':new Date()});_0xca2c8e===0x1&&await this[_0x51598c(0x1e8)]['addBalanceToOrder'](_0x887ec);if(_0x154808[_0x51598c(0x25f)]!=0x1)return _0x51598c(0x239);return _0x51598c(0x237);}async['payMpay'](_0x45fcea,_0x2bcbff,_0xd08400='wxpay'){const _0x2238a9=_0x9e7147,_0x4cd3bc=await this[_0x2238a9(0x277)][_0x2238a9(0x251)]({'where':{'userId':_0x45fcea,'orderId':_0x2bcbff}});if(!_0x4cd3bc)throw new common_1['HttpException'](_0x2238a9(0x1ef),common_1[_0x2238a9(0x1e1)][_0x2238a9(0x1fa)]);const _0x550350=await this[_0x2238a9(0x1b5)][_0x2238a9(0x251)]({'where':{'id':_0x4cd3bc['goodsId']}});if(!_0x550350)throw new common_1[(_0x2238a9(0x22e))](_0x2238a9(0x21b),common_1['HttpStatus']['BAD_REQUEST']);const {payMpayPid:_0x5b6967,payMpaySecret:_0x25e87f,payMpayNotifyUrl:_0x39d295,payMpayReturnUrl:_0x949d5d,payMpayApiPayUrl:_0x1999d4}=await this['globalConfigService'][_0x2238a9(0x220)](['payMpayPid',_0x2238a9(0x26b),_0x2238a9(0x247),_0x2238a9(0x253),_0x2238a9(0x23e)]),_0x2d358e={};_0x2d358e[_0x2238a9(0x1c3)]=Number(_0x5b6967),_0x2d358e[_0x2238a9(0x1e6)]=_0xd08400,_0x2d358e[_0x2238a9(0x1b8)]=_0x2bcbff,_0x2d358e[_0x2238a9(0x279)]=_0x550350[_0x2238a9(0x279)],_0x2d358e[_0x2238a9(0x22c)]=_0x4cd3bc[_0x2238a9(0x1ae)],_0x2d358e[_0x2238a9(0x1c6)]=_0x39d295,_0x2d358e['return_url']=_0x949d5d,_0x2d358e[_0x2238a9(0x1f8)]=this[_0x2238a9(0x1f8)](_0x2d358e,_0x25e87f),_0x2d358e[_0x2238a9(0x22f)]=_0x2238a9(0x243);const _0x5881f6=new URLSearchParams(_0x2d358e)[_0x2238a9(0x1f2)](),_0x42aaae=_0x1999d4+'?'+_0x5881f6;return{'url_qrcode':null,'redirectUrl':_0x42aaae,'channel':_0xd08400,'isRedirect':!![]};const _0x5e829d=await axios_1[_0x2238a9(0x1e9)]['get'](_0x1999d4,{'params':_0x2d358e});}async[_0x9e7147(0x1b0)](_0x13bfe8){const _0x1d3692=_0x9e7147,{payMpayApiQueryUrl:_0x14589f}=await this[_0x1d3692(0x22a)][_0x1d3692(0x220)](['payMpayPid',_0x1d3692(0x26b),_0x1d3692(0x25b)]),_0x424920={};_0x424920['type']=0x2,_0x424920[_0x1d3692(0x1d8)]=_0x13bfe8;const {data:{code:_0x31497a,msg:_0x1475c9,data:_0x48f43a}}=await axios_1['default']['get'](_0x14589f,{'params':_0x424920});if(_0x31497a!=0x1)throw new common_1[(_0x1d3692(0x22e))](_0x1475c9,common_1[_0x1d3692(0x1e1)][_0x1d3692(0x1fa)]);return _0x48f43a;}async[_0x9e7147(0x22b)](_0x2e0c6b){const _0x29ad96=_0x9e7147;common_1[_0x29ad96(0x1ba)][_0x29ad96(0x23f)](_0x29ad96(0x1c4),_0x2e0c6b);const {payWeChatAppId:_0x3ee189,payWeChatMchId:_0x366672,payWeChatSecret:_0x5af443,payWeChatPublicKey:_0x4d758f,payWeChatPrivateKey:_0x3351e6}=await this[_0x29ad96(0x22a)][_0x29ad96(0x220)](['payWeChatAppId',_0x29ad96(0x26d),_0x29ad96(0x254),_0x29ad96(0x1a7),_0x29ad96(0x208)]),_0xaf14ca=new this[(_0x29ad96(0x1af))]({'appid':_0x3ee189,'mchid':_0x366672,'publicKey':_0x4d758f,'privateKey':_0x3351e6});try{if(_0x2e0c6b[_0x29ad96(0x244)]==_0x29ad96(0x221)){const {ciphertext:_0x1ba9c8,associated_data:_0x385b29,nonce:_0x122800}=_0x2e0c6b['resource'],_0x4d82da=_0xaf14ca[_0x29ad96(0x233)](_0x1ba9c8,_0x385b29,_0x122800,_0x5af443),_0x1c71dc=await this[_0x29ad96(0x277)]['findOne']({'where':{'orderId':_0x4d82da[_0x29ad96(0x1b8)],'status':0x0}});if(!_0x1c71dc)return _0x29ad96(0x239);const _0x318820=_0x4d82da[_0x29ad96(0x1c7)]==_0x29ad96(0x1cc)?0x1:0x2,_0x580e35=await this[_0x29ad96(0x277)][_0x29ad96(0x278)]({'orderId':_0x4d82da['out_trade_no']},{'status':_0x318820,'paydAt':new Date()});_0x318820===0x1&&await this[_0x29ad96(0x1e8)][_0x29ad96(0x1b7)](_0x1c71dc);if(_0x580e35[_0x29ad96(0x25f)]!=0x1)return _0x29ad96(0x239);}return'success';}catch(_0x50daaa){return common_1[_0x29ad96(0x1ba)][_0x29ad96(0x23f)](_0x29ad96(0x1ea),_0x50daaa),common_1['Logger']['log'](_0x29ad96(0x270),_0x50daaa),_0x29ad96(0x239);}}async['payWeChat'](_0x274d67,_0x1162f6,_0x39a243='native'){const _0x5aeab6=_0x9e7147;var _0x33ab4f,_0x28bfe9,_0x47b1d6,_0x10c67e,_0x66f249,_0x53ec8a,_0x24a1d0;common_1['Logger'][_0x5aeab6(0x23f)]('payType:\x20',_0x39a243);const _0x4eb2b9=await this[_0x5aeab6(0x277)][_0x5aeab6(0x251)]({'where':{'userId':_0x274d67,'orderId':_0x1162f6}});if(!_0x4eb2b9)throw new common_1['HttpException'](_0x5aeab6(0x1ef),common_1['HttpStatus']['BAD_REQUEST']);const _0x4fbf75=await this['cramiPackageEntity']['findOne']({'where':{'id':_0x4eb2b9[_0x5aeab6(0x21a)]}});if(!_0x4fbf75)throw new common_1[(_0x5aeab6(0x22e))](_0x5aeab6(0x21b),common_1[_0x5aeab6(0x1e1)][_0x5aeab6(0x1fa)]);const {payWeChatAppId:_0x48e71c,payWeChatMchId:_0x38b5f6,payWeChatPublicKey:_0x48b263,payWeChatPrivateKey:_0x477b6d,payWeChatNotifyUrl:_0x97f89}=await this[_0x5aeab6(0x22a)][_0x5aeab6(0x220)]([_0x5aeab6(0x1d3),_0x5aeab6(0x26d),_0x5aeab6(0x1a7),_0x5aeab6(0x208),_0x5aeab6(0x20e)]),_0x2b079b=new this['WxPay']({'appid':_0x48e71c,'mchid':_0x38b5f6,'publicKey':_0x48b263,'privateKey':_0x477b6d}),_0x3be4d3={'appid':_0x48e71c,'mchid':_0x38b5f6,'description':_0x4fbf75[_0x5aeab6(0x279)],'out_trade_no':_0x1162f6,'notify_url':_0x97f89,'amount':{'total':Math[_0x5aeab6(0x228)](_0x4eb2b9[_0x5aeab6(0x1ae)]*0x64)}};common_1['Logger'][_0x5aeab6(0x23f)](_0x5aeab6(0x231),_0x3be4d3);if(_0x39a243=='jsapi'){common_1[_0x5aeab6(0x1ba)][_0x5aeab6(0x23f)](_0x5aeab6(0x1dd)+_0x274d67+_0x5aeab6(0x242)+_0x1162f6);const _0x4878c9=await this[_0x5aeab6(0x1fb)][_0x5aeab6(0x1e7)](_0x274d67);common_1[_0x5aeab6(0x1ba)][_0x5aeab6(0x23f)](_0x5aeab6(0x1c8)+_0x4878c9),_0x3be4d3[_0x5aeab6(0x218)]={'openid':_0x4878c9},common_1[_0x5aeab6(0x1ba)][_0x5aeab6(0x23f)](_0x5aeab6(0x25c),JSON['stringify'](_0x3be4d3,null,0x2));try{const _0xe727fe=await _0x2b079b[_0x5aeab6(0x24d)](_0x3be4d3),_0x26304f=_0xe727fe[_0x5aeab6(0x1dc)]?_0xe727fe[_0x5aeab6(0x1dc)]:_0xe727fe;return common_1[_0x5aeab6(0x1ba)][_0x5aeab6(0x23f)](_0x5aeab6(0x202),JSON[_0x5aeab6(0x240)](_0x26304f,null,0x2)),{'status':_0xe727fe[_0x5aeab6(0x1ed)]||_0x5aeab6(0x21c),'appId':_0x26304f[_0x5aeab6(0x25d)]||((_0x33ab4f=_0x26304f[_0x5aeab6(0x1dc)])===null||_0x33ab4f===void 0x0?void 0x0:_0x33ab4f['appId']),'timeStamp':_0x26304f[_0x5aeab6(0x1df)]||((_0x28bfe9=_0x26304f[_0x5aeab6(0x1dc)])===null||_0x28bfe9===void 0x0?void 0x0:_0x28bfe9[_0x5aeab6(0x1df)]),'nonceStr':_0x26304f['nonceStr']||((_0x47b1d6=_0x26304f['data'])===null||_0x47b1d6===void 0x0?void 0x0:_0x47b1d6[_0x5aeab6(0x1d2)]),'package':_0x26304f[_0x5aeab6(0x275)]||((_0x10c67e=_0x26304f['data'])===null||_0x10c67e===void 0x0?void 0x0:_0x10c67e[_0x5aeab6(0x275)]),'signType':_0x26304f[_0x5aeab6(0x1c1)]||((_0x66f249=_0x26304f[_0x5aeab6(0x1dc)])===null||_0x66f249===void 0x0?void 0x0:_0x66f249[_0x5aeab6(0x1c1)]),'paySign':_0x26304f[_0x5aeab6(0x274)]||((_0x53ec8a=_0x26304f[_0x5aeab6(0x1dc)])===null||_0x53ec8a===void 0x0?void 0x0:_0x53ec8a['paySign'])};}catch(_0x3849e7){console[_0x5aeab6(0x1b9)](_0x5aeab6(0x213)+_0x3849e7[_0x5aeab6(0x20b)],_0x3849e7),console[_0x5aeab6(0x1b9)](_0x5aeab6(0x204),_0x3849e7);throw new common_1['HttpException'](_0x5aeab6(0x24a),common_1[_0x5aeab6(0x1e1)][_0x5aeab6(0x1fa)]);}}if(_0x39a243==_0x5aeab6(0x20f)){common_1[_0x5aeab6(0x1ba)][_0x5aeab6(0x23f)]('开始进行微信Native支付流程，订单ID:\x20'+_0x1162f6+_0x5aeab6(0x1ce)+_0x274d67);try{const _0x3705bb=await _0x2b079b[_0x5aeab6(0x1bb)](_0x3be4d3);common_1[_0x5aeab6(0x1ba)][_0x5aeab6(0x23f)](_0x5aeab6(0x1c0),JSON['stringify'](_0x3705bb,null,0x2));let _0x53b92b=_0x3705bb[_0x5aeab6(0x1c2)]||((_0x24a1d0=_0x3705bb[_0x5aeab6(0x1dc)])===null||_0x24a1d0===void 0x0?void 0x0:_0x24a1d0[_0x5aeab6(0x1c2)]);return!_0x53b92b?console[_0x5aeab6(0x1b9)](_0x5aeab6(0x1ec),JSON['stringify'](_0x3705bb,null,0x2)):common_1[_0x5aeab6(0x1ba)]['log'](_0x5aeab6(0x217)+_0x53b92b),{'url_qrcode':_0x53b92b,'isRedirect':![]};}catch(_0x4dd407){console['error']('微信Native支付过程中发生错误，错误信息:\x20'+_0x4dd407[_0x5aeab6(0x20b)],_0x4dd407),console[_0x5aeab6(0x1b9)]('完整的错误对象：',_0x4dd407);throw new common_1['HttpException'](_0x5aeab6(0x207),common_1[_0x5aeab6(0x1e1)]['BAD_REQUEST']);}}else{console[_0x5aeab6(0x1fe)](_0x5aeab6(0x26e)+_0x39a243);throw new common_1[(_0x5aeab6(0x22e))](_0x5aeab6(0x1b4),common_1['HttpStatus'][_0x5aeab6(0x1fa)]);}}async['queryWeChat'](_0x496d17){const _0x406dcb=_0x9e7147,{payWeChatAppId:_0x9d512d,payWeChatMchId:_0x3107af,payWeChatPublicKey:_0xeecba9,payWeChatPrivateKey:_0x13da16,payWeChatNotifyUrl:_0x37d55c}=await this[_0x406dcb(0x22a)][_0x406dcb(0x220)]([_0x406dcb(0x1d3),'payWeChatMchId','payWeChatPublicKey','payWeChatPrivateKey']),_0x15a8ef=new this[(_0x406dcb(0x1af))]({'appid':_0x9d512d,'mchid':_0x3107af,'publicKey':_0xeecba9,'privateKey':_0x13da16}),_0x5ec0be=await _0x15a8ef[_0x406dcb(0x1e2)]({'out_trade_no':_0x496d17});return _0x5ec0be;}['sign'](_0x5a10f9,_0x42b9e){const _0x3d2d60=_0x9e7147,_0x23df81=Object['keys'](_0x5a10f9)[_0x3d2d60(0x276)]()[_0x3d2d60(0x26a)](_0x46610c=>_0x46610c+'='+_0x5a10f9[_0x46610c])['join']('&')+_0x42b9e;return crypto[_0x3d2d60(0x210)]('md5')[_0x3d2d60(0x278)](_0x23df81)['digest'](_0x3d2d60(0x201));}[_0x9e7147(0x223)](_0x14f25e,_0x3992dc){const _0x368dcc=_0x9e7147,_0x5aa703=Object[_0x368dcc(0x257)](_0x14f25e);_0x5aa703[_0x368dcc(0x276)]();const _0x32b1df=[];_0x5aa703[_0x368dcc(0x26a)](_0x1760bb=>{const _0x43b34b=_0x368dcc;_0x32b1df[_0x43b34b(0x1f9)](_0x1760bb+'='+_0x14f25e[_0x1760bb]);}),_0x32b1df[_0x368dcc(0x1f9)](_0x368dcc(0x26f)+_0x3992dc);const _0x282e51=_0x32b1df[_0x368dcc(0x1be)]('&');return crypto[_0x368dcc(0x210)](_0x368dcc(0x24b))[_0x368dcc(0x278)](_0x282e51)[_0x368dcc(0x1f1)](_0x368dcc(0x201))[_0x368dcc(0x1a9)]();}async['payLtzf'](_0x150ca1,_0x5d5c67,_0x49f33d=_0x9e7147(0x1fd)){const _0x49403b=_0x9e7147,_0x111afe=await this['orderEntity']['findOne']({'where':{'userId':_0x150ca1,'orderId':_0x5d5c67}});if(!_0x111afe)throw new common_1[(_0x49403b(0x22e))](_0x49403b(0x1ef),common_1[_0x49403b(0x1e1)][_0x49403b(0x1fa)]);const _0x59f4cf=await this['cramiPackageEntity'][_0x49403b(0x251)]({'where':{'id':_0x111afe[_0x49403b(0x21a)]}});if(!_0x59f4cf)throw new common_1[(_0x49403b(0x22e))](_0x49403b(0x21b),common_1['HttpStatus'][_0x49403b(0x1fa)]);const {payLtzfMchId:_0x32b402,payLtzfSecret:_0x266f52,payLtzfNotifyUrl:_0x44e4c2,payLtzfReturnUrl:_0xe04803}=await this[_0x49403b(0x22a)][_0x49403b(0x220)]([_0x49403b(0x1bc),_0x49403b(0x1a5),_0x49403b(0x1a6),_0x49403b(0x235)]),_0x7fe112={};_0x7fe112['mch_id']=_0x32b402,_0x7fe112[_0x49403b(0x224)]=(Date[_0x49403b(0x25a)]()/0x3e8)['toFixed'](0x0),_0x7fe112[_0x49403b(0x1b8)]=_0x5d5c67,_0x7fe112[_0x49403b(0x267)]=_0x59f4cf[_0x49403b(0x279)],_0x7fe112[_0x49403b(0x1d6)]=_0x111afe[_0x49403b(0x1ae)],_0x7fe112[_0x49403b(0x1c6)]=_0x44e4c2,_0x7fe112[_0x49403b(0x1f8)]=this[_0x49403b(0x223)](_0x7fe112,_0x266f52),_0x7fe112[_0x49403b(0x1cb)]=_0x49403b(0x1e3),_0x7fe112['return_url']=_0xe04803;const _0x42aff8=Object[_0x49403b(0x257)](_0x7fe112)[_0x49403b(0x26a)](_0x54bd27=>encodeURIComponent(_0x54bd27)+'='+encodeURIComponent(_0x7fe112[_0x54bd27]))[_0x49403b(0x1be)]('&'),_0x406e2f={'headers':{'Content-Type':_0x49403b(0x245)}},_0x30adef=await axios_1['default']['post'](_0x49403b(0x1b2),_0x42aff8,_0x406e2f),{code:_0x41f28f,data:_0xf61a73,msg:_0x1c1e85}=_0x30adef['data'];if(_0x41f28f!=0x0)throw new common_1[(_0x49403b(0x22e))](_0x1c1e85,common_1[_0x49403b(0x1e1)][_0x49403b(0x1fa)]);const _0x2be8ac=_0xf61a73[_0x49403b(0x20a)],_0x31411a=_0xf61a73['order_url'];return{'url_qrcode':_0x2be8ac,'url':_0x31411a};}async[_0x9e7147(0x1d0)](_0x2cbbba){const _0x16e17e=_0x9e7147,{payLtzfMchId:_0x3f50d7,payLtzfSecret:_0x42ef43}=await this[_0x16e17e(0x22a)][_0x16e17e(0x220)]([_0x16e17e(0x1bc),'payLtzfSecret']),_0x4d26e6={};_0x4d26e6[_0x16e17e(0x227)]=_0x3f50d7,_0x4d26e6['timestamp']=(Date[_0x16e17e(0x25a)]()/0x3e8)[_0x16e17e(0x1d4)](0x0),_0x4d26e6['out_trade_no']=_0x2cbbba,_0x4d26e6[_0x16e17e(0x1f8)]=this['ltzfSign'](_0x4d26e6,_0x42ef43);const _0xfe10=Object['keys'](_0x4d26e6)[_0x16e17e(0x26a)](_0x1db9b2=>encodeURIComponent(_0x1db9b2)+'='+encodeURIComponent(_0x4d26e6[_0x1db9b2]))['join']('&'),_0x1cc1a2={'headers':{'Content-Type':_0x16e17e(0x245)}},{data:{code:_0x2e2be0,msg:_0x798de5,data:_0x4b8e05}}=await axios_1[_0x16e17e(0x1e9)][_0x16e17e(0x21d)](_0x16e17e(0x263),_0xfe10,_0x1cc1a2);if(_0x2e2be0!=0x0)throw new common_1[(_0x16e17e(0x22e))](_0x798de5+JSON['stringify'](_0x4d26e6),common_1['HttpStatus']['BAD_REQUEST']);return _0x4b8e05;}async[_0x9e7147(0x200)](_0x528df2){const _0x76a487=_0x9e7147,_0x1c7b83=await this[_0x76a487(0x22a)]['getConfigs']([_0x76a487(0x1a5)]),_0x2257af=_0x528df2[_0x76a487(0x1f8)];delete _0x528df2[_0x76a487(0x1f8)],delete _0x528df2['pay_channel'],delete _0x528df2[_0x76a487(0x1f3)],delete _0x528df2[_0x76a487(0x234)],delete _0x528df2[_0x76a487(0x1cb)],delete _0x528df2[_0x76a487(0x23d)];if(this[_0x76a487(0x223)](_0x528df2,_0x1c7b83)!=_0x2257af)return _0x76a487(0x1db);const _0x778f5a=await this[_0x76a487(0x277)][_0x76a487(0x251)]({'where':{'orderId':_0x528df2[_0x76a487(0x1b8)],'status':0x0}});if(!_0x778f5a)return _0x76a487(0x1db);await this[_0x76a487(0x1e8)][_0x76a487(0x1b7)](_0x778f5a);const _0x14edc5=await this[_0x76a487(0x277)][_0x76a487(0x278)]({'orderId':_0x528df2[_0x76a487(0x1b8)]},{'status':0x1,'paydAt':new Date()});if(_0x14edc5['affected']!=0x1)return _0x76a487(0x1db);return _0x76a487(0x1cc);}};PayService=__decorate([(0x0,common_1[_0x9e7147(0x1eb)])(),__param(0x0,(0x0,typeorm_1[_0x9e7147(0x232)])(cramiPackage_entity_1[_0x9e7147(0x225)])),__param(0x1,(0x0,typeorm_1[_0x9e7147(0x232)])(order_entity_1['OrderEntity'])),__metadata(_0x9e7147(0x265),[typeorm_2[_0x9e7147(0x1d5)],typeorm_2[_0x9e7147(0x1d5)],userBalance_service_1[_0x9e7147(0x256)],globalConfig_service_1[_0x9e7147(0x268)],user_service_1[_0x9e7147(0x26c)]])],PayService),exports['PayService']=PayService;