'use strict';const _0x4e08bd=_0x52e8;(function(_0x347683,_0x40d89b){const _0x508203=_0x52e8,_0x5c5eff=_0x347683();while(!![]){try{const _0x506738=parseInt(_0x508203(0x260))/0x1+parseInt(_0x508203(0x26e))/0x2+-parseInt(_0x508203(0x252))/0x3+parseInt(_0x508203(0x1c3))/0x4+parseInt(_0x508203(0x266))/0x5*(-parseInt(_0x508203(0x238))/0x6)+parseInt(_0x508203(0x1e1))/0x7*(-parseInt(_0x508203(0x22c))/0x8)+parseInt(_0x508203(0x25e))/0x9*(parseInt(_0x508203(0x220))/0xa);if(_0x506738===_0x40d89b)break;else _0x5c5eff['push'](_0x5c5eff['shift']());}catch(_0x5240c3){_0x5c5eff['push'](_0x5c5eff['shift']());}}}(_0x27c6,0x3449d));function _0x27c6(){const _0x303bdf=['payWeChatNotifyUrl','nonceStr','update','notifyHupi','payMpay','act','length','Injectable','ltzfSign','校验签名通过','sign','package','QRcode_url','globalConfigService','keys','trade_state','alipay','Logger','warn','payWeChat','微信Native支付请求成功，code_url:\x20','开始进行微信Native支付流程，订单ID:\x20','design:paramtypes','order_no','money','order','[WeChat\x20Pay\x20JSAPI]\x20开始JSAPI支付流程，用户ID:\x20','https://api.xunhupay.com/payment/do.html','UserService','join','https://api.xunhupay.com/payment/query.html','clientip','notifyLtzf','post','unsupported\x20pay\x20type','824416foiksm','校验签名','@nestjs/common','get','getConfigs','hex','payLtzfReturnUrl','key=','default','userBalanceService','stringify','../../common/utils','push','payWeChatSecret','openid','[WeChat\x20Pay\x20JSAPI]\x20发送支付请求参数:\x20','[WeChat\x20Pay\x20JSAPI]\x20用户OpenID:\x20','type','attach','onModuleInit','wxpay','axios','timestamp','套餐不存在!','微信Native支付请求成功，但未返回code_url，响应数据:\x20','payMpayApiQueryUrl','application/x-www-form-urlencoded','payer','payWeChatPrivateKey','body','663978emzkWN','完整的错误对象：','payLtzfSecret','epay','trade_order_id','HttpException','version','error','payMpayReturnUrl','payEpayPid','object','param','appId','return_url','ltzf','订单不存在!','resource','payEpay','../userBalance/userBalance.service','__param','notifyMpay','payHupiSecret','[WeChat\x20Pay\x20JSAPI]\x20支付请求过程中发生错误:\x20','pid','wechatpay-node-v3','userService','payMpaySecret','total','payLtzfNotifyUrl','md5','decipher_gcm','failed','微信Native支付失败','本次支付类型:\x20','payHupiReturnUrl','hash','unknown','key','queryLtzf','typeorm',',\x20订单ID:\x20','../globalConfig/globalConfig.service','cramiPackageEntity','TRANSACTION.SUCCESS','code_url','data','WxPay','payHupiNotifyUrl','sign_type','name',',\x20用户ID:\x20','notifyEpay','createHash','HttpStatus','error:\x20','payType:\x20','192.168.1.100','toFixed','payWeChatMchId','payLtzf','payMpayPid','[WeChat\x20Pay\x20JSAPI]\x20支付请求成功，返回结果:\x20','notify_url','454760EfxHdP','total_fee','epay\x20--->\x20res:\x20','submit.php','https://api.ltzf.cn/api/wxpay/get_pay_order','log','queryHupi','mch_id','InjectRepository','payEpayApiQueryUrl','message','wechat','16CtNPLM','Repository','getOpenIdByUserId','event_type','getOwnPropertyDescriptor','includes','FAIL','GlobalConfigService','payMpayApiPayUrl','status:\x20','findOne','payEpayReturnUrl','24RQifKP','defineProperty','hupi','signType','PayService','__metadata','orderEntity','@nestjs/typeorm','1.1','支付请求失败:\x20','trade_status','支付请求失败!','toString','now','payWeChatPublicKey','payLtzfMchId','nonce_str','payEpaySecret','jsapi','sort','payEpayApiPayUrl','goodsId','out_trade_no','__esModule','notifyWeChat','微信Native支付过程中发生错误，错误信息:\x20','1101474PvsmwO','addBalanceToOrder','success','title','BAD_REQUEST','transactions_jsapi','map','支付通知验证失败:\x20','metadata','native','payHupiAppId','notify','54AfUOLb','MD5','13724VXzWXZ','payPlatform','queryMpay','appid','payEpayNotifyUrl','createRandomNonceStr','108370cxQASJ','微信Native支付响应数据:\x20','mpay','out_trade_order','affected','decorate','transactions_native','timeStamp','730102ZbekRk','query','paySign','微信支付通知params:\x20','importDynamic','success_time','JSAPI支付失败','time','pay','payWeChatAppId','SUCCESS','TRADE_SUCCESS','digest'];_0x27c6=function(){return _0x303bdf;};return _0x27c6();}function _0x52e8(_0x4cfb89,_0x2fa60a){const _0x27c6f1=_0x27c6();return _0x52e8=function(_0x52e8d0,_0x44867f){_0x52e8d0=_0x52e8d0-0x1a8;let _0x71465a=_0x27c6f1[_0x52e8d0];return _0x71465a;},_0x52e8(_0x4cfb89,_0x2fa60a);}var __decorate=this&&this['__decorate']||function(_0x5658a2,_0x5d48d6,_0x490a36,_0x359b97){const _0x2ee7a8=_0x52e8;var _0x5deeb8=arguments[_0x2ee7a8(0x281)],_0x19df3f=_0x5deeb8<0x3?_0x5d48d6:_0x359b97===null?_0x359b97=Object[_0x2ee7a8(0x230)](_0x5d48d6,_0x490a36):_0x359b97,_0x10ebaf;if(typeof Reflect==='object'&&typeof Reflect[_0x2ee7a8(0x26b)]==='function')_0x19df3f=Reflect[_0x2ee7a8(0x26b)](_0x5658a2,_0x5d48d6,_0x490a36,_0x359b97);else{for(var _0x1f9d2a=_0x5658a2[_0x2ee7a8(0x281)]-0x1;_0x1f9d2a>=0x0;_0x1f9d2a--)if(_0x10ebaf=_0x5658a2[_0x1f9d2a])_0x19df3f=(_0x5deeb8<0x3?_0x10ebaf(_0x19df3f):_0x5deeb8>0x3?_0x10ebaf(_0x5d48d6,_0x490a36,_0x19df3f):_0x10ebaf(_0x5d48d6,_0x490a36))||_0x19df3f;}return _0x5deeb8>0x3&&_0x19df3f&&Object[_0x2ee7a8(0x239)](_0x5d48d6,_0x490a36,_0x19df3f),_0x19df3f;},__metadata=this&&this[_0x4e08bd(0x23d)]||function(_0x2b575f,_0x8c3631){const _0x464457=_0x4e08bd;if(typeof Reflect===_0x464457(0x1eb)&&typeof Reflect[_0x464457(0x25a)]==='function')return Reflect[_0x464457(0x25a)](_0x2b575f,_0x8c3631);},__param=this&&this[_0x4e08bd(0x1f4)]||function(_0x23a2a1,_0x447a94){return function(_0x697917,_0x4449f5){_0x447a94(_0x697917,_0x4449f5,_0x23a2a1);};};Object[_0x4e08bd(0x239)](exports,_0x4e08bd(0x24f),{'value':!![]}),exports[_0x4e08bd(0x23c)]=void 0x0;const utils_1=require(_0x4e08bd(0x1ce)),common_1=require(_0x4e08bd(0x1c5)),typeorm_1=require(_0x4e08bd(0x23f)),axios_1=require(_0x4e08bd(0x1d8)),crypto=require('crypto'),typeorm_2=require(_0x4e08bd(0x208)),cramiPackage_entity_1=require('../crami/cramiPackage.entity'),globalConfig_service_1=require(_0x4e08bd(0x20a)),order_entity_1=require('../order/order.entity'),user_service_1=require('../user/user.service'),userBalance_service_1=require(_0x4e08bd(0x1f3));let PayService=class PayService{constructor(_0x436d94,_0x3fb584,_0x235613,_0x322e1b,_0x553761){const _0x4f2f19=_0x4e08bd;this['cramiPackageEntity']=_0x436d94,this['orderEntity']=_0x3fb584,this[_0x4f2f19(0x1cc)]=_0x235613,this[_0x4f2f19(0x1ad)]=_0x322e1b,this[_0x4f2f19(0x1fa)]=_0x553761;}async[_0x4e08bd(0x1d6)](){const _0x4edf62=_0x4e08bd,_0x150b0a=await(0x0,utils_1[_0x4edf62(0x272)])(_0x4edf62(0x1f9));this[_0x4edf62(0x20f)]=(_0x150b0a===null||_0x150b0a===void 0x0?void 0x0:_0x150b0a[_0x4edf62(0x1cb)])?_0x150b0a[_0x4edf62(0x1cb)]:_0x150b0a;}async[_0x4e08bd(0x25d)](_0x3a7ce6){const _0xd9dbaa=_0x4e08bd;if(_0x3a7ce6[_0xd9dbaa(0x1ec)]=='epay')return this[_0xd9dbaa(0x214)](_0x3a7ce6);if(_0x3a7ce6[_0xd9dbaa(0x1d5)]==_0xd9dbaa(0x23a))return this[_0xd9dbaa(0x27e)](_0x3a7ce6);if(_0x3a7ce6[_0xd9dbaa(0x1d5)]==_0xd9dbaa(0x1ef))return this[_0xd9dbaa(0x1c0)](_0x3a7ce6);if(typeof _0x3a7ce6[_0xd9dbaa(0x1f1)]==_0xd9dbaa(0x1eb))return this[_0xd9dbaa(0x250)](_0x3a7ce6);return this[_0xd9dbaa(0x1f5)](_0x3a7ce6);}async[_0x4e08bd(0x276)](_0x1a5199,_0x570de4,_0x1a974c=_0x4e08bd(0x1d7)){const _0x58b8cf=_0x4e08bd,_0x3f7873=await this[_0x58b8cf(0x23e)]['findOne']({'where':{'userId':_0x1a5199,'orderId':_0x570de4}});if(!_0x3f7873)throw new common_1['HttpException'](_0x58b8cf(0x1f0),common_1[_0x58b8cf(0x216)][_0x58b8cf(0x256)]);const _0x279bd4=await this['cramiPackageEntity']['findOne']({'where':{'id':_0x3f7873['goodsId']}});if(!_0x279bd4)throw new common_1[(_0x58b8cf(0x1e6))](_0x58b8cf(0x1da),common_1[_0x58b8cf(0x216)][_0x58b8cf(0x256)]);common_1[_0x58b8cf(0x1b1)][_0x58b8cf(0x225)](_0x58b8cf(0x202),_0x3f7873[_0x58b8cf(0x261)]);try{if(_0x3f7873[_0x58b8cf(0x261)]==_0x58b8cf(0x22b))return this[_0x58b8cf(0x1b3)](_0x1a5199,_0x570de4,_0x1a974c);if(_0x3f7873[_0x58b8cf(0x261)]=='epay')return this[_0x58b8cf(0x1f2)](_0x1a5199,_0x570de4,_0x1a974c);if(_0x3f7873[_0x58b8cf(0x261)]==_0x58b8cf(0x268))return this[_0x58b8cf(0x27f)](_0x1a5199,_0x570de4,_0x1a974c);if(_0x3f7873[_0x58b8cf(0x261)]==_0x58b8cf(0x23a))return this['payHupi'](_0x1a5199,_0x570de4,_0x1a974c);if(_0x3f7873[_0x58b8cf(0x261)]==_0x58b8cf(0x1ef))return this[_0x58b8cf(0x21c)](_0x1a5199,_0x570de4,_0x1a974c);}catch(_0x553778){common_1[_0x58b8cf(0x1b1)][_0x58b8cf(0x225)](_0x58b8cf(0x241),_0x553778);throw new common_1['HttpException'](_0x58b8cf(0x243),common_1['HttpStatus'][_0x58b8cf(0x256)]);}}async[_0x4e08bd(0x26f)](_0x1f45b3){const _0x912870=_0x4e08bd,_0x20f083=await this[_0x912870(0x23e)][_0x912870(0x236)]({'where':{'orderId':_0x1f45b3}});if(!_0x20f083)throw new common_1[(_0x912870(0x1e6))](_0x912870(0x1f0),common_1[_0x912870(0x216)][_0x912870(0x256)]);return _0x20f083;}async[_0x4e08bd(0x27e)](_0x510fac){const _0x46fb38=_0x4e08bd,_0x1ae475=await this[_0x46fb38(0x1ad)][_0x46fb38(0x1c7)]([_0x46fb38(0x1f6)]),_0x3e9fe1=_0x510fac[_0x46fb38(0x204)];delete _0x510fac[_0x46fb38(0x204)];if(this[_0x46fb38(0x1aa)](_0x510fac,_0x1ae475)!=_0x3e9fe1)return _0x46fb38(0x200);const _0x37e97a=await this[_0x46fb38(0x23e)][_0x46fb38(0x236)]({'where':{'orderId':_0x510fac['trade_order_id'],'status':0x0}});if(!_0x37e97a)return'failed';await this['userBalanceService'][_0x46fb38(0x253)](_0x37e97a);const _0x5bbf99=await this[_0x46fb38(0x23e)][_0x46fb38(0x27d)]({'orderId':_0x510fac[_0x46fb38(0x1e5)]},{'status':0x1,'paydAt':new Date()});if(_0x5bbf99['affected']!=0x1)return _0x46fb38(0x200);return _0x46fb38(0x254);}async['payHupi'](_0x1117c8,_0x477e20,_0x5f3d3b='wxpay'){const _0x54368f=_0x4e08bd,_0x2030a4=await this['orderEntity']['findOne']({'where':{'userId':_0x1117c8,'orderId':_0x477e20}});if(!_0x2030a4)throw new common_1['HttpException'](_0x54368f(0x1f0),common_1['HttpStatus'][_0x54368f(0x256)]);const _0x9b8094=await this['cramiPackageEntity']['findOne']({'where':{'id':_0x2030a4[_0x54368f(0x24d)]}});if(!_0x9b8094)throw new common_1[(_0x54368f(0x1e6))](_0x54368f(0x1da),common_1[_0x54368f(0x216)][_0x54368f(0x256)]);const {payHupiAppId:_0x47c47b,payHupiSecret:_0x75aa18,payHupiNotifyUrl:_0x3543e0,payHupiReturnUrl:_0xbecb39,payHupiGatewayUrl:_0x7a4bd5}=await this[_0x54368f(0x1ad)][_0x54368f(0x1c7)]([_0x54368f(0x25c),_0x54368f(0x1f6),_0x54368f(0x210),_0x54368f(0x203),'payHupiGatewayUrl']),_0x1d59de={};_0x1d59de[_0x54368f(0x1e7)]=_0x54368f(0x240),_0x1d59de['appid']=_0x47c47b,_0x1d59de[_0x54368f(0x275)]=(Date['now']()/0x3e8)[_0x54368f(0x21a)](0x0),_0x1d59de['nonce_str']=(0x0,utils_1[_0x54368f(0x265)])(0x20),_0x1d59de['trade_order_id']=_0x477e20,_0x1d59de[_0x54368f(0x255)]=_0x9b8094['name'],_0x1d59de[_0x54368f(0x221)]=_0x2030a4[_0x54368f(0x1fc)],_0x1d59de[_0x54368f(0x21f)]=_0x3543e0,_0x1d59de[_0x54368f(0x1ee)]=_0xbecb39,_0x1d59de[_0x54368f(0x1d5)]=_0x54368f(0x23a),_0x1d59de['hash']=this['sign'](_0x1d59de,_0x75aa18);const {data:{errcode:_0x5017a2,errmsg:_0x432193,url_qrcode:_0x24dc1b,url:_0x1a8ac0}}=await axios_1[_0x54368f(0x1cb)]['post'](_0x7a4bd5||_0x54368f(0x1bb),_0x1d59de);if(_0x5017a2!=0x0)throw new common_1[(_0x54368f(0x1e6))](_0x432193,common_1[_0x54368f(0x216)]['BAD_REQUEST']);return{'url_qrcode':_0x24dc1b,'url':_0x1a8ac0};}async[_0x4e08bd(0x226)](_0x15259f){const _0x2d6ce0=_0x4e08bd,{payHupiAppId:_0x22878f,payHupiSecret:_0x3483ef}=await this['globalConfigService'][_0x2d6ce0(0x1c7)]([_0x2d6ce0(0x25c),_0x2d6ce0(0x1f6)]),_0x248afe={};_0x248afe[_0x2d6ce0(0x1e7)]=_0x2d6ce0(0x240),_0x248afe[_0x2d6ce0(0x263)]=_0x22878f,_0x248afe['time']=(Date[_0x2d6ce0(0x245)]()/0x3e8)[_0x2d6ce0(0x21a)](0x0),_0x248afe[_0x2d6ce0(0x248)]=(0x0,utils_1[_0x2d6ce0(0x265)])(0x20),_0x248afe[_0x2d6ce0(0x269)]=_0x15259f,_0x248afe[_0x2d6ce0(0x204)]=this[_0x2d6ce0(0x1aa)](_0x248afe,_0x3483ef);const {data:{errcode:_0x3bbb7e,errmsg:_0x27c463,data:_0x1322f3}}=await axios_1['default'][_0x2d6ce0(0x1c1)](_0x2d6ce0(0x1be),_0x248afe);if(_0x3bbb7e!=0x0)throw new common_1['HttpException'](_0x27c463,common_1[_0x2d6ce0(0x216)]['BAD_REQUEST']);return _0x1322f3;}async[_0x4e08bd(0x214)](_0x2c139b){const _0x39f377=_0x4e08bd,_0x4bd21a=_0x2c139b['sign'];delete _0x2c139b['sign'],delete _0x2c139b['sign_type'];const _0x1d712=await this['globalConfigService']['getConfigs'](['payEpaySecret']);if(this[_0x39f377(0x1aa)](_0x2c139b,_0x1d712)!=_0x4bd21a)return'failed';common_1[_0x39f377(0x1b1)]['log'](_0x39f377(0x1a9));const _0x585bb6=await this[_0x39f377(0x23e)][_0x39f377(0x236)]({'where':{'orderId':_0x2c139b[_0x39f377(0x24e)],'status':0x0}});if(!_0x585bb6)return'failed';const _0x196908=_0x2c139b[_0x39f377(0x242)]==_0x39f377(0x279)?0x1:0x2,_0x196fc4=await this[_0x39f377(0x23e)][_0x39f377(0x27d)]({'orderId':_0x2c139b[_0x39f377(0x24e)]},{'status':_0x196908,'paydAt':new Date()});_0x196908===0x1&&await this[_0x39f377(0x1cc)]['addBalanceToOrder'](_0x585bb6);if(_0x196fc4[_0x39f377(0x26a)]!=0x1)return _0x39f377(0x200);return _0x39f377(0x254);}async['payEpay'](_0x4e81f1,_0x53d0ca,_0x4720a0=_0x4e08bd(0x1b0)){const _0x210824=_0x4e08bd,_0x20156f=await this['orderEntity'][_0x210824(0x236)]({'where':{'userId':_0x4e81f1,'orderId':_0x53d0ca}});if(!_0x20156f)throw new common_1[(_0x210824(0x1e6))](_0x210824(0x1f0),common_1[_0x210824(0x216)][_0x210824(0x256)]);const _0x3293cd=await this[_0x210824(0x20b)][_0x210824(0x236)]({'where':{'id':_0x20156f[_0x210824(0x24d)]}});if(!_0x3293cd)throw new common_1['HttpException'](_0x210824(0x1da),common_1[_0x210824(0x216)][_0x210824(0x256)]);const {payEpayPid:_0x392bb8,payEpaySecret:_0x5e42fb,payEpayNotifyUrl:_0x294a4d,payEpayReturnUrl:_0x52dc12,payEpayApiPayUrl:_0x2e792a}=await this[_0x210824(0x1ad)][_0x210824(0x1c7)]([_0x210824(0x1ea),_0x210824(0x249),_0x210824(0x264),_0x210824(0x237),_0x210824(0x24c)]);let _0xc7b97;_0x392bb8[_0x210824(0x281)]<=0x10?_0xc7b97=Number(_0x392bb8):_0xc7b97=BigInt(_0x392bb8);const _0xc6a1fa={};_0xc6a1fa['pid']=_0xc7b97,_0xc6a1fa[_0x210824(0x1d4)]=_0x4720a0,_0xc6a1fa[_0x210824(0x24e)]=_0x53d0ca,_0xc6a1fa[_0x210824(0x212)]=_0x3293cd[_0x210824(0x212)],_0xc6a1fa[_0x210824(0x1b8)]=_0x20156f['total'],_0xc6a1fa[_0x210824(0x1bf)]=_0x210824(0x219),_0xc6a1fa['device']='pc',_0xc6a1fa[_0x210824(0x21f)]=_0x294a4d,_0xc6a1fa[_0x210824(0x1ee)]=_0x52dc12,_0xc6a1fa['param']=_0x210824(0x1e4),_0xc6a1fa[_0x210824(0x1aa)]=this[_0x210824(0x1aa)](_0xc6a1fa,_0x5e42fb),_0xc6a1fa[_0x210824(0x211)]='MD5';const _0x12471b=new URLSearchParams(_0xc6a1fa)[_0x210824(0x244)](),_0x57b357=_0x2e792a+'?'+_0x12471b;if(_0x2e792a[_0x210824(0x231)](_0x210824(0x223)))return{'url_qrcode':null,'redirectUrl':_0x57b357,'channel':_0x4720a0,'isRedirect':!![]};else{const _0x4ce34c={'headers':{'Content-Type':_0x210824(0x1dd)}},_0x6e12d0=await axios_1[_0x210824(0x1cb)]['post'](_0x2e792a,_0xc6a1fa,_0x4ce34c);common_1['Logger'][_0x210824(0x225)](_0x210824(0x222),_0x6e12d0[_0x210824(0x20e)]);const {data:{code:_0x2b1eca,msg:_0x1bf98a,qrcode:_0x29423e}}=_0x6e12d0;if(_0x2b1eca!=0x1)throw new common_1[(_0x210824(0x1e6))](_0x1bf98a,common_1['HttpStatus'][_0x210824(0x256)]);return{'url_qrcode':_0x29423e,'redirectUrl':null,'channel':_0x4720a0,'isRedirect':![]};}}async['queryEpay'](_0xc0b4fe){const _0x1f7349=_0x4e08bd,{payEpayPid:_0x583477,payEpaySecret:_0x22dda1,payEpayApiQueryUrl:_0x2e83fc}=await this[_0x1f7349(0x1ad)][_0x1f7349(0x1c7)]([_0x1f7349(0x1ea),'payEpaySecret',_0x1f7349(0x229)]),_0x2ba51e={};_0x2ba51e[_0x1f7349(0x280)]=_0x1f7349(0x1b9),_0x2ba51e[_0x1f7349(0x24e)]=_0xc0b4fe,_0x2ba51e[_0x1f7349(0x1f8)]=_0x583477,_0x2ba51e[_0x1f7349(0x206)]=_0x22dda1;const {data:{code:_0x7ca80a,msg:_0xa6e4a0,data:_0x4e1800}}=await axios_1[_0x1f7349(0x1cb)]['get'](_0x2e83fc,{'params':_0x2ba51e});if(_0x7ca80a!=0x1)throw new common_1[(_0x1f7349(0x1e6))](_0xa6e4a0,common_1[_0x1f7349(0x216)][_0x1f7349(0x256)]);return _0x4e1800;}async[_0x4e08bd(0x1f5)](_0x4debb7){const _0x56ca71=_0x4e08bd,_0x34c034=_0x4debb7[_0x56ca71(0x1aa)];delete _0x4debb7[_0x56ca71(0x1aa)],delete _0x4debb7['sign_type'];const _0x531211=await this['globalConfigService']['getConfigs'](['payMpaySecret']);common_1[_0x56ca71(0x1b1)][_0x56ca71(0x225)](_0x56ca71(0x1c4));if(this['sign'](_0x4debb7,_0x531211)!=_0x34c034)return _0x56ca71(0x200);common_1['Logger'][_0x56ca71(0x225)](_0x56ca71(0x1a9));const _0x5a1520=await this[_0x56ca71(0x23e)]['findOne']({'where':{'orderId':_0x4debb7[_0x56ca71(0x24e)],'status':0x0}});if(!_0x5a1520)return'failed';const _0x480409=_0x4debb7[_0x56ca71(0x242)]==_0x56ca71(0x279)?0x1:0x2;common_1[_0x56ca71(0x1b1)][_0x56ca71(0x225)](_0x56ca71(0x235),_0x480409);const _0xff3aa9=await this['orderEntity'][_0x56ca71(0x27d)]({'orderId':_0x4debb7['out_trade_no']},{'status':_0x480409,'paydAt':new Date()});_0x480409===0x1&&await this[_0x56ca71(0x1cc)][_0x56ca71(0x253)](_0x5a1520);if(_0xff3aa9[_0x56ca71(0x26a)]!=0x1)return _0x56ca71(0x200);return _0x56ca71(0x254);}async[_0x4e08bd(0x27f)](_0x359f03,_0x40ab46,_0x387725=_0x4e08bd(0x1d7)){const _0x2d3bcf=_0x4e08bd,_0x1e53dd=await this[_0x2d3bcf(0x23e)][_0x2d3bcf(0x236)]({'where':{'userId':_0x359f03,'orderId':_0x40ab46}});if(!_0x1e53dd)throw new common_1[(_0x2d3bcf(0x1e6))](_0x2d3bcf(0x1f0),common_1[_0x2d3bcf(0x216)][_0x2d3bcf(0x256)]);const _0x36d0a1=await this[_0x2d3bcf(0x20b)][_0x2d3bcf(0x236)]({'where':{'id':_0x1e53dd['goodsId']}});if(!_0x36d0a1)throw new common_1[(_0x2d3bcf(0x1e6))](_0x2d3bcf(0x1da),common_1[_0x2d3bcf(0x216)][_0x2d3bcf(0x256)]);const {payMpayPid:_0x28359a,payMpaySecret:_0x137d3c,payMpayNotifyUrl:_0x24fc09,payMpayReturnUrl:_0x128d40,payMpayApiPayUrl:_0x592ae2}=await this[_0x2d3bcf(0x1ad)][_0x2d3bcf(0x1c7)]([_0x2d3bcf(0x21d),_0x2d3bcf(0x1fb),'payMpayNotifyUrl',_0x2d3bcf(0x1e9),_0x2d3bcf(0x234)]),_0x3581d8={};_0x3581d8['pid']=Number(_0x28359a),_0x3581d8['type']=_0x387725,_0x3581d8[_0x2d3bcf(0x24e)]=_0x40ab46,_0x3581d8[_0x2d3bcf(0x212)]=_0x36d0a1[_0x2d3bcf(0x212)],_0x3581d8[_0x2d3bcf(0x1b8)]=_0x1e53dd[_0x2d3bcf(0x1fc)],_0x3581d8['notify_url']=_0x24fc09,_0x3581d8['return_url']=_0x128d40,_0x3581d8['sign']=this[_0x2d3bcf(0x1aa)](_0x3581d8,_0x137d3c),_0x3581d8[_0x2d3bcf(0x211)]=_0x2d3bcf(0x25f);const _0x4a8014=new URLSearchParams(_0x3581d8)[_0x2d3bcf(0x244)](),_0x536c91=_0x592ae2+'?'+_0x4a8014;return{'url_qrcode':null,'redirectUrl':_0x536c91,'channel':_0x387725,'isRedirect':!![]};const _0x3cc80e=await axios_1['default'][_0x2d3bcf(0x1c6)](_0x592ae2,{'params':_0x3581d8});}async[_0x4e08bd(0x262)](_0x272f6d){const _0x5a2af3=_0x4e08bd,{payMpayApiQueryUrl:_0xe0dc9a}=await this[_0x5a2af3(0x1ad)][_0x5a2af3(0x1c7)](['payMpayPid',_0x5a2af3(0x1fb),_0x5a2af3(0x1dc)]),_0x5e7989={};_0x5e7989[_0x5a2af3(0x1d4)]=0x2,_0x5e7989[_0x5a2af3(0x1b7)]=_0x272f6d;const {data:{code:_0x375022,msg:_0x394629,data:_0x15ff95}}=await axios_1[_0x5a2af3(0x1cb)][_0x5a2af3(0x1c6)](_0xe0dc9a,{'params':_0x5e7989});if(_0x375022!=0x1)throw new common_1[(_0x5a2af3(0x1e6))](_0x394629,common_1[_0x5a2af3(0x216)][_0x5a2af3(0x256)]);return _0x15ff95;}async['notifyWeChat'](_0xa25e66){const _0x1116fa=_0x4e08bd;common_1[_0x1116fa(0x1b1)]['log'](_0x1116fa(0x271),_0xa25e66);const {payWeChatAppId:_0x46b1a7,payWeChatMchId:_0xb5f4cf,payWeChatSecret:_0x33f984,payWeChatPublicKey:_0x254164,payWeChatPrivateKey:_0x74cb17}=await this[_0x1116fa(0x1ad)][_0x1116fa(0x1c7)]([_0x1116fa(0x277),_0x1116fa(0x21b),_0x1116fa(0x1d0),_0x1116fa(0x246),_0x1116fa(0x1df)]),_0x268a5a=new this[(_0x1116fa(0x20f))]({'appid':_0x46b1a7,'mchid':_0xb5f4cf,'publicKey':_0x254164,'privateKey':_0x74cb17});try{if(_0xa25e66[_0x1116fa(0x22f)]==_0x1116fa(0x20c)){const {ciphertext:_0x5e3ce4,associated_data:_0x27c1f8,nonce:_0x4e08c3}=_0xa25e66[_0x1116fa(0x1f1)],_0x36440b=_0x268a5a[_0x1116fa(0x1ff)](_0x5e3ce4,_0x27c1f8,_0x4e08c3,_0x33f984),_0x5442ab=await this['orderEntity'][_0x1116fa(0x236)]({'where':{'orderId':_0x36440b[_0x1116fa(0x24e)],'status':0x0}});if(!_0x5442ab)return _0x1116fa(0x200);const _0x446eb8=_0x36440b[_0x1116fa(0x1af)]==_0x1116fa(0x278)?0x1:0x2,_0x3bb294=await this[_0x1116fa(0x23e)][_0x1116fa(0x27d)]({'orderId':_0x36440b['out_trade_no']},{'status':_0x446eb8,'paydAt':new Date()});_0x446eb8===0x1&&await this[_0x1116fa(0x1cc)][_0x1116fa(0x253)](_0x5442ab);if(_0x3bb294[_0x1116fa(0x26a)]!=0x1)return _0x1116fa(0x200);}return'success';}catch(_0x463358){return common_1[_0x1116fa(0x1b1)][_0x1116fa(0x225)](_0x1116fa(0x217),_0x463358),common_1['Logger']['log'](_0x1116fa(0x259),_0x463358),_0x1116fa(0x200);}}async[_0x4e08bd(0x1b3)](_0x1cb244,_0xc114ff,_0x213c40=_0x4e08bd(0x25b)){const _0xac22e9=_0x4e08bd;var _0x14326b,_0x4b8747,_0xcd8a66,_0x32253c,_0x1b20e5,_0x256174,_0x552101;common_1[_0xac22e9(0x1b1)][_0xac22e9(0x225)](_0xac22e9(0x218),_0x213c40);const _0x25e33d=await this[_0xac22e9(0x23e)][_0xac22e9(0x236)]({'where':{'userId':_0x1cb244,'orderId':_0xc114ff}});if(!_0x25e33d)throw new common_1['HttpException']('订单不存在!',common_1[_0xac22e9(0x216)][_0xac22e9(0x256)]);const _0x335845=await this['cramiPackageEntity'][_0xac22e9(0x236)]({'where':{'id':_0x25e33d[_0xac22e9(0x24d)]}});if(!_0x335845)throw new common_1[(_0xac22e9(0x1e6))](_0xac22e9(0x1da),common_1['HttpStatus'][_0xac22e9(0x256)]);const {payWeChatAppId:_0x8e292c,payWeChatMchId:_0x3ddb0d,payWeChatPublicKey:_0xc49753,payWeChatPrivateKey:_0x467409,payWeChatNotifyUrl:_0xa1572e}=await this[_0xac22e9(0x1ad)][_0xac22e9(0x1c7)]([_0xac22e9(0x277),'payWeChatMchId',_0xac22e9(0x246),_0xac22e9(0x1df),_0xac22e9(0x27b)]),_0x33a7db=new this['WxPay']({'appid':_0x8e292c,'mchid':_0x3ddb0d,'publicKey':_0xc49753,'privateKey':_0x467409}),_0x57270f={'appid':_0x8e292c,'mchid':_0x3ddb0d,'description':_0x335845[_0xac22e9(0x212)],'out_trade_no':_0xc114ff,'notify_url':_0xa1572e,'amount':{'total':Math['round'](_0x25e33d[_0xac22e9(0x1fc)]*0x64)}};common_1[_0xac22e9(0x1b1)]['log']('wechat-pay:\x20',_0x57270f);if(_0x213c40==_0xac22e9(0x24a)){common_1[_0xac22e9(0x1b1)][_0xac22e9(0x225)](_0xac22e9(0x1ba)+_0x1cb244+_0xac22e9(0x209)+_0xc114ff);const _0x68dfe6=await this['userService'][_0xac22e9(0x22e)](_0x1cb244);common_1['Logger'][_0xac22e9(0x225)](_0xac22e9(0x1d3)+_0x68dfe6),_0x57270f[_0xac22e9(0x1de)]={'openid':_0x68dfe6},common_1['Logger']['log'](_0xac22e9(0x1d2),JSON['stringify'](_0x57270f,null,0x2));try{const _0xee7a10=await _0x33a7db[_0xac22e9(0x257)](_0x57270f),_0x47ea31=_0xee7a10[_0xac22e9(0x20e)]?_0xee7a10[_0xac22e9(0x20e)]:_0xee7a10;return common_1[_0xac22e9(0x1b1)][_0xac22e9(0x225)](_0xac22e9(0x21e),JSON[_0xac22e9(0x1cd)](_0x47ea31,null,0x2)),{'status':_0xee7a10['status']||_0xac22e9(0x205),'appId':_0x47ea31[_0xac22e9(0x1ed)]||((_0x14326b=_0x47ea31[_0xac22e9(0x20e)])===null||_0x14326b===void 0x0?void 0x0:_0x14326b[_0xac22e9(0x1ed)]),'timeStamp':_0x47ea31[_0xac22e9(0x26d)]||((_0x4b8747=_0x47ea31[_0xac22e9(0x20e)])===null||_0x4b8747===void 0x0?void 0x0:_0x4b8747[_0xac22e9(0x26d)]),'nonceStr':_0x47ea31[_0xac22e9(0x27c)]||((_0xcd8a66=_0x47ea31[_0xac22e9(0x20e)])===null||_0xcd8a66===void 0x0?void 0x0:_0xcd8a66[_0xac22e9(0x27c)]),'package':_0x47ea31[_0xac22e9(0x1ab)]||((_0x32253c=_0x47ea31[_0xac22e9(0x20e)])===null||_0x32253c===void 0x0?void 0x0:_0x32253c['package']),'signType':_0x47ea31['signType']||((_0x1b20e5=_0x47ea31['data'])===null||_0x1b20e5===void 0x0?void 0x0:_0x1b20e5[_0xac22e9(0x23b)]),'paySign':_0x47ea31[_0xac22e9(0x270)]||((_0x256174=_0x47ea31['data'])===null||_0x256174===void 0x0?void 0x0:_0x256174[_0xac22e9(0x270)])};}catch(_0x272c1e){console[_0xac22e9(0x1e8)](_0xac22e9(0x1f7)+_0x272c1e[_0xac22e9(0x22a)],_0x272c1e),console['error']('[WeChat\x20Pay\x20JSAPI]\x20完整的错误对象：',_0x272c1e);throw new common_1[(_0xac22e9(0x1e6))](_0xac22e9(0x274),common_1['HttpStatus'][_0xac22e9(0x256)]);}}if(_0x213c40==_0xac22e9(0x25b)){common_1[_0xac22e9(0x1b1)][_0xac22e9(0x225)](_0xac22e9(0x1b5)+_0xc114ff+_0xac22e9(0x213)+_0x1cb244);try{const _0x354423=await _0x33a7db[_0xac22e9(0x26c)](_0x57270f);common_1['Logger'][_0xac22e9(0x225)](_0xac22e9(0x267),JSON[_0xac22e9(0x1cd)](_0x354423,null,0x2));let _0x4d59a1=_0x354423[_0xac22e9(0x20d)]||((_0x552101=_0x354423[_0xac22e9(0x20e)])===null||_0x552101===void 0x0?void 0x0:_0x552101[_0xac22e9(0x20d)]);return!_0x4d59a1?console[_0xac22e9(0x1e8)](_0xac22e9(0x1db),JSON[_0xac22e9(0x1cd)](_0x354423,null,0x2)):common_1[_0xac22e9(0x1b1)]['log'](_0xac22e9(0x1b4)+_0x4d59a1),{'url_qrcode':_0x4d59a1,'isRedirect':![]};}catch(_0x106337){console['error'](_0xac22e9(0x251)+_0x106337[_0xac22e9(0x22a)],_0x106337),console['error'](_0xac22e9(0x1e2),_0x106337);throw new common_1[(_0xac22e9(0x1e6))](_0xac22e9(0x201),common_1[_0xac22e9(0x216)][_0xac22e9(0x256)]);}}else{console[_0xac22e9(0x1b2)]('支付请求使用了不支持的支付类型:\x20'+_0x213c40);throw new common_1[(_0xac22e9(0x1e6))](_0xac22e9(0x1c2),common_1[_0xac22e9(0x216)][_0xac22e9(0x256)]);}}async['queryWeChat'](_0x3e1b6f){const _0x1a0631=_0x4e08bd,{payWeChatAppId:_0xedc089,payWeChatMchId:_0x6ed677,payWeChatPublicKey:_0x4015d1,payWeChatPrivateKey:_0x389a00,payWeChatNotifyUrl:_0x3d8a19}=await this[_0x1a0631(0x1ad)]['getConfigs'](['payWeChatAppId',_0x1a0631(0x21b),_0x1a0631(0x246),_0x1a0631(0x1df)]),_0x475678=new this[(_0x1a0631(0x20f))]({'appid':_0xedc089,'mchid':_0x6ed677,'publicKey':_0x4015d1,'privateKey':_0x389a00}),_0x2caa3a=await _0x475678[_0x1a0631(0x26f)]({'out_trade_no':_0x3e1b6f});return _0x2caa3a;}[_0x4e08bd(0x1aa)](_0x3931cc,_0x35dd4d){const _0x333be7=_0x4e08bd,_0x13e0a0=Object[_0x333be7(0x1ae)](_0x3931cc)[_0x333be7(0x24b)]()[_0x333be7(0x258)](_0xdf26a=>_0xdf26a+'='+_0x3931cc[_0xdf26a])[_0x333be7(0x1bd)]('&')+_0x35dd4d;return crypto[_0x333be7(0x215)](_0x333be7(0x1fe))[_0x333be7(0x27d)](_0x13e0a0)[_0x333be7(0x27a)](_0x333be7(0x1c8));}[_0x4e08bd(0x1a8)](_0x17227d,_0x277d37){const _0x39fa64=_0x4e08bd,_0x4fbf3e=Object['keys'](_0x17227d);_0x4fbf3e[_0x39fa64(0x24b)]();const _0x17419c=[];_0x4fbf3e[_0x39fa64(0x258)](_0x514ba4=>{const _0x2b5a1d=_0x39fa64;_0x17419c[_0x2b5a1d(0x1cf)](_0x514ba4+'='+_0x17227d[_0x514ba4]);}),_0x17419c['push'](_0x39fa64(0x1ca)+_0x277d37);const _0x114cf6=_0x17419c[_0x39fa64(0x1bd)]('&');return crypto[_0x39fa64(0x215)](_0x39fa64(0x1fe))[_0x39fa64(0x27d)](_0x114cf6)[_0x39fa64(0x27a)](_0x39fa64(0x1c8))['toUpperCase']();}async[_0x4e08bd(0x21c)](_0x2c51ac,_0x586225,_0xd185c5=_0x4e08bd(0x1d7)){const _0xdc20cf=_0x4e08bd,_0x4370aa=await this['orderEntity']['findOne']({'where':{'userId':_0x2c51ac,'orderId':_0x586225}});if(!_0x4370aa)throw new common_1[(_0xdc20cf(0x1e6))](_0xdc20cf(0x1f0),common_1[_0xdc20cf(0x216)][_0xdc20cf(0x256)]);const _0x2ec305=await this[_0xdc20cf(0x20b)][_0xdc20cf(0x236)]({'where':{'id':_0x4370aa[_0xdc20cf(0x24d)]}});if(!_0x2ec305)throw new common_1[(_0xdc20cf(0x1e6))](_0xdc20cf(0x1da),common_1[_0xdc20cf(0x216)][_0xdc20cf(0x256)]);const {payLtzfMchId:_0x3d9f2c,payLtzfSecret:_0x8c6bfe,payLtzfNotifyUrl:_0x5bc50e,payLtzfReturnUrl:_0x266a95}=await this[_0xdc20cf(0x1ad)][_0xdc20cf(0x1c7)](['payLtzfMchId',_0xdc20cf(0x1e3),_0xdc20cf(0x1fd),_0xdc20cf(0x1c9)]),_0x213513={};_0x213513[_0xdc20cf(0x227)]=_0x3d9f2c,_0x213513['timestamp']=(Date[_0xdc20cf(0x245)]()/0x3e8)[_0xdc20cf(0x21a)](0x0),_0x213513['out_trade_no']=_0x586225,_0x213513[_0xdc20cf(0x1e0)]=_0x2ec305['name'],_0x213513[_0xdc20cf(0x221)]=_0x4370aa['total'],_0x213513[_0xdc20cf(0x21f)]=_0x5bc50e,_0x213513[_0xdc20cf(0x1aa)]=this[_0xdc20cf(0x1a8)](_0x213513,_0x8c6bfe),_0x213513[_0xdc20cf(0x1d5)]=_0xdc20cf(0x1ef),_0x213513[_0xdc20cf(0x1ee)]=_0x266a95;const _0x35bb6b=Object['keys'](_0x213513)['map'](_0x680f87=>encodeURIComponent(_0x680f87)+'='+encodeURIComponent(_0x213513[_0x680f87]))[_0xdc20cf(0x1bd)]('&'),_0x3eb19f={'headers':{'Content-Type':_0xdc20cf(0x1dd)}},_0x28837d=await axios_1[_0xdc20cf(0x1cb)][_0xdc20cf(0x1c1)]('https://api.ltzf.cn/api/wxpay/jsapi_convenient',_0x35bb6b,_0x3eb19f),{code:_0x10b89e,data:_0x1270fc,msg:_0x52a127}=_0x28837d[_0xdc20cf(0x20e)];if(_0x10b89e!=0x0)throw new common_1['HttpException'](_0x52a127,common_1[_0xdc20cf(0x216)][_0xdc20cf(0x256)]);const _0x235f0a=_0x1270fc[_0xdc20cf(0x1ac)],_0x47708f=_0x1270fc['order_url'];return{'url_qrcode':_0x235f0a,'url':_0x47708f};}async[_0x4e08bd(0x207)](_0x3e07e4){const _0x256122=_0x4e08bd,{payLtzfMchId:_0x2beeba,payLtzfSecret:_0x3acb10}=await this['globalConfigService'][_0x256122(0x1c7)]([_0x256122(0x247),_0x256122(0x1e3)]),_0x296422={};_0x296422[_0x256122(0x227)]=_0x2beeba,_0x296422[_0x256122(0x1d9)]=(Date['now']()/0x3e8)[_0x256122(0x21a)](0x0),_0x296422[_0x256122(0x24e)]=_0x3e07e4,_0x296422[_0x256122(0x1aa)]=this[_0x256122(0x1a8)](_0x296422,_0x3acb10);const _0x29c02c=Object[_0x256122(0x1ae)](_0x296422)[_0x256122(0x258)](_0x2b57d3=>encodeURIComponent(_0x2b57d3)+'='+encodeURIComponent(_0x296422[_0x2b57d3]))[_0x256122(0x1bd)]('&'),_0x15b06b={'headers':{'Content-Type':_0x256122(0x1dd)}},{data:{code:_0x567b8c,msg:_0x1d0e0a,data:_0x4503b5}}=await axios_1[_0x256122(0x1cb)][_0x256122(0x1c1)](_0x256122(0x224),_0x29c02c,_0x15b06b);if(_0x567b8c!=0x0)throw new common_1['HttpException'](_0x1d0e0a+JSON[_0x256122(0x1cd)](_0x296422),common_1[_0x256122(0x216)][_0x256122(0x256)]);return _0x4503b5;}async[_0x4e08bd(0x1c0)](_0x154fef){const _0x29ebc7=_0x4e08bd,_0x4c4a18=await this['globalConfigService'][_0x29ebc7(0x1c7)]([_0x29ebc7(0x1e3)]),_0x45d66b=_0x154fef[_0x29ebc7(0x1aa)];delete _0x154fef['sign'],delete _0x154fef['pay_channel'],delete _0x154fef['trade_type'],delete _0x154fef[_0x29ebc7(0x273)],delete _0x154fef[_0x29ebc7(0x1d5)],delete _0x154fef[_0x29ebc7(0x1d1)];if(this[_0x29ebc7(0x1a8)](_0x154fef,_0x4c4a18)!=_0x45d66b)return _0x29ebc7(0x232);const _0x401e6f=await this[_0x29ebc7(0x23e)][_0x29ebc7(0x236)]({'where':{'orderId':_0x154fef['out_trade_no'],'status':0x0}});if(!_0x401e6f)return _0x29ebc7(0x232);await this['userBalanceService'][_0x29ebc7(0x253)](_0x401e6f);const _0x125d33=await this[_0x29ebc7(0x23e)][_0x29ebc7(0x27d)]({'orderId':_0x154fef[_0x29ebc7(0x24e)]},{'status':0x1,'paydAt':new Date()});if(_0x125d33[_0x29ebc7(0x26a)]!=0x1)return _0x29ebc7(0x232);return _0x29ebc7(0x278);}};PayService=__decorate([(0x0,common_1[_0x4e08bd(0x282)])(),__param(0x0,(0x0,typeorm_1[_0x4e08bd(0x228)])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x1,(0x0,typeorm_1[_0x4e08bd(0x228)])(order_entity_1['OrderEntity'])),__metadata(_0x4e08bd(0x1b6),[typeorm_2[_0x4e08bd(0x22d)],typeorm_2['Repository'],userBalance_service_1['UserBalanceService'],globalConfig_service_1[_0x4e08bd(0x233)],user_service_1[_0x4e08bd(0x1bc)]])],PayService),exports['PayService']=PayService;