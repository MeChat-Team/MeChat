'use strict';const _0x2da662=_0x4445;(function(_0x3e2c80,_0x126623){const _0x52ab36=_0x4445,_0x30a048=_0x3e2c80();while(!![]){try{const _0x4102ce=parseInt(_0x52ab36(0x1c7))/0x1*(-parseInt(_0x52ab36(0x172))/0x2)+-parseInt(_0x52ab36(0x199))/0x3*(-parseInt(_0x52ab36(0x127))/0x4)+parseInt(_0x52ab36(0x191))/0x5*(-parseInt(_0x52ab36(0x1be))/0x6)+-parseInt(_0x52ab36(0x1af))/0x7*(parseInt(_0x52ab36(0x1e2))/0x8)+-parseInt(_0x52ab36(0x1dc))/0x9*(parseInt(_0x52ab36(0x13e))/0xa)+-parseInt(_0x52ab36(0x186))/0xb*(-parseInt(_0x52ab36(0x15f))/0xc)+-parseInt(_0x52ab36(0x1cb))/0xd*(-parseInt(_0x52ab36(0x1d5))/0xe);if(_0x4102ce===_0x126623)break;else _0x30a048['push'](_0x30a048['shift']());}catch(_0x1674ea){_0x30a048['push'](_0x30a048['shift']());}}}(_0x4cc0,0x1a9ec));var __decorate=this&&this[_0x2da662(0x18e)]||function(_0x83a0b8,_0x12472f,_0x5ad758,_0x568f50){const _0x323f1a=_0x2da662;var _0x2ed0f4=arguments['length'],_0xc05332=_0x2ed0f4<0x3?_0x12472f:_0x568f50===null?_0x568f50=Object[_0x323f1a(0x1e8)](_0x12472f,_0x5ad758):_0x568f50,_0x57a7a8;if(typeof Reflect==='object'&&typeof Reflect['decorate']===_0x323f1a(0x14f))_0xc05332=Reflect[_0x323f1a(0x188)](_0x83a0b8,_0x12472f,_0x5ad758,_0x568f50);else{for(var _0x131bfd=_0x83a0b8['length']-0x1;_0x131bfd>=0x0;_0x131bfd--)if(_0x57a7a8=_0x83a0b8[_0x131bfd])_0xc05332=(_0x2ed0f4<0x3?_0x57a7a8(_0xc05332):_0x2ed0f4>0x3?_0x57a7a8(_0x12472f,_0x5ad758,_0xc05332):_0x57a7a8(_0x12472f,_0x5ad758))||_0xc05332;}return _0x2ed0f4>0x3&&_0xc05332&&Object[_0x323f1a(0x12c)](_0x12472f,_0x5ad758,_0xc05332),_0xc05332;},__metadata=this&&this[_0x2da662(0x1d1)]||function(_0xe5d18c,_0x38f8a6){const _0x2110a5=_0x2da662;if(typeof Reflect===_0x2110a5(0x176)&&typeof Reflect[_0x2110a5(0x14a)]==='function')return Reflect[_0x2110a5(0x14a)](_0xe5d18c,_0x38f8a6);},__param=this&&this[_0x2da662(0x143)]||function(_0x51a2ae,_0x48bdb3){return function(_0x32b0d2,_0x1dabae){_0x48bdb3(_0x32b0d2,_0x1dabae,_0x51a2ae);};};function _0x4445(_0x3a883f,_0x2d2b17){const _0x4cc03d=_0x4cc0();return _0x4445=function(_0x44453b,_0x222f46){_0x44453b=_0x44453b-0x11a;let _0x49452b=_0x4cc03d[_0x44453b];return _0x49452b;},_0x4445(_0x3a883f,_0x2d2b17);}Object[_0x2da662(0x12c)](exports,_0x2da662(0x11e),{'value':!![]}),exports[_0x2da662(0x1cf)]=void 0x0;const utils_1=require(_0x2da662(0x173)),common_1=require(_0x2da662(0x18c)),typeorm_1=require(_0x2da662(0x187)),axios_1=require(_0x2da662(0x1ce)),crypto=require(_0x2da662(0x180)),typeorm_2=require('typeorm'),cramiPackage_entity_1=require('../crami/cramiPackage.entity'),globalConfig_service_1=require(_0x2da662(0x1a9)),order_entity_1=require(_0x2da662(0x1ab)),user_service_1=require(_0x2da662(0x1db)),userBalance_service_1=require(_0x2da662(0x11d));let PayService=class PayService{constructor(_0x17f7e6,_0x3a2c91,_0x2d1fef,_0x22cf16,_0x3ad08a){const _0xe54c1c=_0x2da662;this['cramiPackageEntity']=_0x17f7e6,this['orderEntity']=_0x3a2c91,this[_0xe54c1c(0x16a)]=_0x2d1fef,this[_0xe54c1c(0x141)]=_0x22cf16,this[_0xe54c1c(0x168)]=_0x3ad08a;}async[_0x2da662(0x15b)](){const _0xfda66a=_0x2da662,_0x272ced=await(0x0,utils_1[_0xfda66a(0x151)])(_0xfda66a(0x1a0));this[_0xfda66a(0x162)]=(_0x272ced===null||_0x272ced===void 0x0?void 0x0:_0x272ced[_0xfda66a(0x1c4)])?_0x272ced['default']:_0x272ced;}async[_0x2da662(0x184)](_0x231d5d){const _0x1501e5=_0x2da662;if(_0x231d5d['param']==_0x1501e5(0x1a1))return this[_0x1501e5(0x179)](_0x231d5d);if(_0x231d5d['attach']==_0x1501e5(0x1a7))return this[_0x1501e5(0x18b)](_0x231d5d);if(_0x231d5d[_0x1501e5(0x16f)]=='ltzf')return this[_0x1501e5(0x1cd)](_0x231d5d);if(typeof _0x231d5d[_0x1501e5(0x13a)]==_0x1501e5(0x176))return this[_0x1501e5(0x17f)](_0x231d5d);return this['notifyMpay'](_0x231d5d);}async[_0x2da662(0x120)](_0x5707c,_0x2dda50,_0x38bec1=_0x2da662(0x1ea)){const _0x4bbc21=_0x2da662,_0x33c27a=await this[_0x4bbc21(0x1a4)][_0x4bbc21(0x132)]({'where':{'userId':_0x5707c,'orderId':_0x2dda50}});if(!_0x33c27a)throw new common_1[(_0x4bbc21(0x164))](_0x4bbc21(0x17c),common_1['HttpStatus'][_0x4bbc21(0x1b9)]);const _0x1358be=await this['cramiPackageEntity'][_0x4bbc21(0x132)]({'where':{'id':_0x33c27a['goodsId']}});if(!_0x1358be)throw new common_1[(_0x4bbc21(0x164))]('套餐不存在!',common_1['HttpStatus'][_0x4bbc21(0x1b9)]);common_1[_0x4bbc21(0x166)][_0x4bbc21(0x16e)](_0x4bbc21(0x170),_0x33c27a['payPlatform']);try{if(_0x33c27a[_0x4bbc21(0x154)]=='wechat')return this[_0x4bbc21(0x1e9)](_0x5707c,_0x2dda50,_0x38bec1);if(_0x33c27a['payPlatform']==_0x4bbc21(0x1a1))return this[_0x4bbc21(0x15a)](_0x5707c,_0x2dda50,_0x38bec1);if(_0x33c27a[_0x4bbc21(0x154)]==_0x4bbc21(0x157))return this[_0x4bbc21(0x194)](_0x5707c,_0x2dda50,_0x38bec1);if(_0x33c27a[_0x4bbc21(0x154)]==_0x4bbc21(0x1a7))return this[_0x4bbc21(0x158)](_0x5707c,_0x2dda50,_0x38bec1);if(_0x33c27a[_0x4bbc21(0x154)]==_0x4bbc21(0x1a5))return this['payLtzf'](_0x5707c,_0x2dda50,_0x38bec1);}catch(_0x33ace4){common_1['Logger'][_0x4bbc21(0x16e)]('支付请求失败:\x20',_0x33ace4);throw new common_1[(_0x4bbc21(0x164))](_0x4bbc21(0x1b3),common_1['HttpStatus'][_0x4bbc21(0x1b9)]);}}async['query'](_0x287ccf){const _0x4e13fa=_0x2da662,_0x2c13a7=await this[_0x4e13fa(0x1a4)][_0x4e13fa(0x132)]({'where':{'orderId':_0x287ccf}});if(!_0x2c13a7)throw new common_1[(_0x4e13fa(0x164))](_0x4e13fa(0x17c),common_1[_0x4e13fa(0x11b)][_0x4e13fa(0x1b9)]);return _0x2c13a7;}async[_0x2da662(0x18b)](_0x341c09){const _0x2ccdf5=_0x2da662,_0x3c0224=await this[_0x2ccdf5(0x141)]['getConfigs']([_0x2ccdf5(0x139)]),_0x2908bd=_0x341c09[_0x2ccdf5(0x121)];delete _0x341c09[_0x2ccdf5(0x121)];if(this[_0x2ccdf5(0x1b0)](_0x341c09,_0x3c0224)!=_0x2908bd)return _0x2ccdf5(0x1e3);const _0x2e8977=await this['orderEntity'][_0x2ccdf5(0x132)]({'where':{'orderId':_0x341c09['trade_order_id'],'status':0x0}});if(!_0x2e8977)return _0x2ccdf5(0x1e3);await this[_0x2ccdf5(0x16a)][_0x2ccdf5(0x1bf)](_0x2e8977);const _0xf3b263=await this[_0x2ccdf5(0x1a4)][_0x2ccdf5(0x1c5)]({'orderId':_0x341c09[_0x2ccdf5(0x1c2)]},{'status':0x1,'paydAt':new Date()});if(_0xf3b263['affected']!=0x1)return _0x2ccdf5(0x1e3);return _0x2ccdf5(0x145);}async[_0x2da662(0x158)](_0x2a4d53,_0x64a86e,_0x16a403=_0x2da662(0x1ea)){const _0x1ddff5=_0x2da662,_0x33068d=await this[_0x1ddff5(0x1a4)][_0x1ddff5(0x132)]({'where':{'userId':_0x2a4d53,'orderId':_0x64a86e}});if(!_0x33068d)throw new common_1['HttpException'](_0x1ddff5(0x17c),common_1[_0x1ddff5(0x11b)][_0x1ddff5(0x1b9)]);const _0x3184b3=await this['cramiPackageEntity'][_0x1ddff5(0x132)]({'where':{'id':_0x33068d[_0x1ddff5(0x1e7)]}});if(!_0x3184b3)throw new common_1[(_0x1ddff5(0x164))](_0x1ddff5(0x12e),common_1[_0x1ddff5(0x11b)][_0x1ddff5(0x1b9)]);const {payHupiAppId:_0x359f5a,payHupiSecret:_0x45ae86,payHupiNotifyUrl:_0x42b7a2,payHupiReturnUrl:_0xca989b,payHupiGatewayUrl:_0x204f44}=await this[_0x1ddff5(0x141)][_0x1ddff5(0x17b)]([_0x1ddff5(0x1c6),_0x1ddff5(0x139),_0x1ddff5(0x159),'payHupiReturnUrl',_0x1ddff5(0x18f)]),_0x2153ce={};_0x2153ce[_0x1ddff5(0x11c)]=_0x1ddff5(0x1c9),_0x2153ce['appid']=_0x359f5a,_0x2153ce[_0x1ddff5(0x165)]=(Date['now']()/0x3e8)[_0x1ddff5(0x169)](0x0),_0x2153ce['nonce_str']=(0x0,utils_1[_0x1ddff5(0x1dd)])(0x20),_0x2153ce[_0x1ddff5(0x1c2)]=_0x64a86e,_0x2153ce['title']=_0x3184b3[_0x1ddff5(0x19a)],_0x2153ce['total_fee']=_0x33068d[_0x1ddff5(0x134)],_0x2153ce[_0x1ddff5(0x1d7)]=_0x42b7a2,_0x2153ce[_0x1ddff5(0x19e)]=_0xca989b,_0x2153ce[_0x1ddff5(0x16f)]=_0x1ddff5(0x1a7),_0x2153ce[_0x1ddff5(0x121)]=this[_0x1ddff5(0x1b0)](_0x2153ce,_0x45ae86);const {data:{errcode:_0x214a0b,errmsg:_0x5e4869,url_qrcode:_0x14ef89,url:_0x9ec65b}}=await axios_1[_0x1ddff5(0x1c4)][_0x1ddff5(0x133)](_0x204f44||_0x1ddff5(0x1e1),_0x2153ce);if(_0x214a0b!=0x0)throw new common_1[(_0x1ddff5(0x164))](_0x5e4869,common_1[_0x1ddff5(0x11b)][_0x1ddff5(0x1b9)]);return{'url_qrcode':_0x14ef89,'url':_0x9ec65b};}async[_0x2da662(0x13f)](_0x4c59a3){const _0x54b8db=_0x2da662,{payHupiAppId:_0x5db7e0,payHupiSecret:_0x2f5063}=await this[_0x54b8db(0x141)]['getConfigs']([_0x54b8db(0x1c6),_0x54b8db(0x139)]),_0x3a26ed={};_0x3a26ed[_0x54b8db(0x11c)]=_0x54b8db(0x1c9),_0x3a26ed[_0x54b8db(0x1e5)]=_0x5db7e0,_0x3a26ed['time']=(Date['now']()/0x3e8)['toFixed'](0x0),_0x3a26ed['nonce_str']=(0x0,utils_1[_0x54b8db(0x1dd)])(0x20),_0x3a26ed[_0x54b8db(0x12a)]=_0x4c59a3,_0x3a26ed[_0x54b8db(0x121)]=this[_0x54b8db(0x1b0)](_0x3a26ed,_0x2f5063);const {data:{errcode:_0x30f50f,errmsg:_0x47c38f,data:_0x45550a}}=await axios_1[_0x54b8db(0x1c4)]['post'](_0x54b8db(0x136),_0x3a26ed);if(_0x30f50f!=0x0)throw new common_1[(_0x54b8db(0x164))](_0x47c38f,common_1[_0x54b8db(0x11b)][_0x54b8db(0x1b9)]);return _0x45550a;}async[_0x2da662(0x179)](_0x4434b9){const _0x5990cc=_0x2da662,_0x59aeab=_0x4434b9[_0x5990cc(0x1b0)];delete _0x4434b9[_0x5990cc(0x1b0)],delete _0x4434b9['sign_type'];const _0x265b33=await this['globalConfigService'][_0x5990cc(0x17b)]([_0x5990cc(0x14b)]);if(this[_0x5990cc(0x1b0)](_0x4434b9,_0x265b33)!=_0x59aeab)return'failed';common_1[_0x5990cc(0x166)][_0x5990cc(0x16e)](_0x5990cc(0x1c1));const _0x30a4cd=await this[_0x5990cc(0x1a4)][_0x5990cc(0x132)]({'where':{'orderId':_0x4434b9['out_trade_no'],'status':0x0}});if(!_0x30a4cd)return'failed';const _0x5edc15=_0x4434b9[_0x5990cc(0x178)]==_0x5990cc(0x12b)?0x1:0x2,_0xc7c865=await this[_0x5990cc(0x1a4)][_0x5990cc(0x1c5)]({'orderId':_0x4434b9[_0x5990cc(0x1e0)]},{'status':_0x5edc15,'paydAt':new Date()});_0x5edc15===0x1&&await this['userBalanceService'][_0x5990cc(0x1bf)](_0x30a4cd);if(_0xc7c865['affected']!=0x1)return'failed';return'success';}async[_0x2da662(0x15a)](_0x38c8f5,_0x4d4f80,_0x37dd3f=_0x2da662(0x1d2)){const _0x1f423c=_0x2da662,_0x2daf15=await this[_0x1f423c(0x1a4)][_0x1f423c(0x132)]({'where':{'userId':_0x38c8f5,'orderId':_0x4d4f80}});if(!_0x2daf15)throw new common_1['HttpException'](_0x1f423c(0x17c),common_1[_0x1f423c(0x11b)][_0x1f423c(0x1b9)]);const _0x24848e=await this[_0x1f423c(0x1bb)][_0x1f423c(0x132)]({'where':{'id':_0x2daf15['goodsId']}});if(!_0x24848e)throw new common_1[(_0x1f423c(0x164))](_0x1f423c(0x12e),common_1[_0x1f423c(0x11b)][_0x1f423c(0x1b9)]);const {payEpayPid:_0x57263c,payEpaySecret:_0x57fa0c,payEpayNotifyUrl:_0x16dac1,payEpayReturnUrl:_0xcfd5ec,payEpayApiPayUrl:_0x1c99f6}=await this[_0x1f423c(0x141)]['getConfigs']([_0x1f423c(0x1a6),_0x1f423c(0x14b),_0x1f423c(0x14e),_0x1f423c(0x1c0),_0x1f423c(0x17d)]);let _0x43370c;_0x57263c[_0x1f423c(0x19c)]<=0x10?_0x43370c=Number(_0x57263c):_0x43370c=BigInt(_0x57263c);const _0x2455aa={};_0x2455aa[_0x1f423c(0x17a)]=_0x43370c,_0x2455aa[_0x1f423c(0x15d)]=_0x37dd3f,_0x2455aa[_0x1f423c(0x1e0)]=_0x4d4f80,_0x2455aa[_0x1f423c(0x19a)]=_0x24848e['name'],_0x2455aa[_0x1f423c(0x135)]=_0x2daf15[_0x1f423c(0x134)],_0x2455aa[_0x1f423c(0x1a2)]=_0x1f423c(0x1ec),_0x2455aa['device']='pc',_0x2455aa[_0x1f423c(0x1d7)]=_0x16dac1,_0x2455aa['return_url']=_0xcfd5ec,_0x2455aa['param']='epay',_0x2455aa['sign']=this['sign'](_0x2455aa,_0x57fa0c),_0x2455aa['sign_type']=_0x1f423c(0x128);const _0x4420ac=new URLSearchParams(_0x2455aa)[_0x1f423c(0x15c)](),_0x5b09a1=_0x1c99f6+'?'+_0x4420ac;if(_0x1c99f6[_0x1f423c(0x189)]('submit.php'))return{'url_qrcode':null,'redirectUrl':_0x5b09a1,'channel':_0x37dd3f,'isRedirect':!![]};else{const _0x5af0bf={'headers':{'Content-Type':_0x1f423c(0x12d)}},_0x128bb9=await axios_1['default'][_0x1f423c(0x133)](_0x1c99f6,_0x2455aa,_0x5af0bf);common_1[_0x1f423c(0x166)][_0x1f423c(0x16e)](_0x1f423c(0x12f),_0x128bb9[_0x1f423c(0x1bc)]);const {data:{code:_0x28c210,msg:_0x327ef2,qrcode:_0x36dcd5}}=_0x128bb9;if(_0x28c210!=0x1)throw new common_1['HttpException'](_0x327ef2,common_1['HttpStatus'][_0x1f423c(0x1b9)]);return{'url_qrcode':_0x36dcd5,'redirectUrl':null,'channel':_0x37dd3f,'isRedirect':![]};}}async[_0x2da662(0x130)](_0x2f9eb5){const _0x235ddf=_0x2da662,{payEpayPid:_0x29664a,payEpaySecret:_0x3149ae,payEpayApiQueryUrl:_0x18acea}=await this[_0x235ddf(0x141)][_0x235ddf(0x17b)]([_0x235ddf(0x1a6),'payEpaySecret','payEpayApiQueryUrl']),_0x11a256={};_0x11a256[_0x235ddf(0x1ba)]=_0x235ddf(0x1aa),_0x11a256[_0x235ddf(0x1e0)]=_0x2f9eb5,_0x11a256[_0x235ddf(0x17a)]=_0x29664a,_0x11a256[_0x235ddf(0x16c)]=_0x3149ae;const {data:{code:_0x40b8a7,msg:_0x5e5b51,data:_0x5ae450}}=await axios_1[_0x235ddf(0x1c4)][_0x235ddf(0x1d4)](_0x18acea,{'params':_0x11a256});if(_0x40b8a7!=0x1)throw new common_1[(_0x235ddf(0x164))](_0x5e5b51,common_1[_0x235ddf(0x11b)]['BAD_REQUEST']);return _0x5ae450;}async['notifyMpay'](_0x2b6421){const _0x4ab366=_0x2da662,_0x2e4892=_0x2b6421[_0x4ab366(0x1b0)];delete _0x2b6421[_0x4ab366(0x1b0)],delete _0x2b6421[_0x4ab366(0x14c)];const _0x38b030=await this[_0x4ab366(0x141)]['getConfigs']([_0x4ab366(0x190)]);common_1[_0x4ab366(0x166)]['log'](_0x4ab366(0x13d));if(this['sign'](_0x2b6421,_0x38b030)!=_0x2e4892)return _0x4ab366(0x1e3);common_1[_0x4ab366(0x166)][_0x4ab366(0x16e)](_0x4ab366(0x1c1));const _0x3c9ee1=await this['orderEntity'][_0x4ab366(0x132)]({'where':{'orderId':_0x2b6421[_0x4ab366(0x1e0)],'status':0x0}});if(!_0x3c9ee1)return _0x4ab366(0x1e3);const _0x40b7cf=_0x2b6421[_0x4ab366(0x178)]==_0x4ab366(0x12b)?0x1:0x2;common_1[_0x4ab366(0x166)][_0x4ab366(0x16e)](_0x4ab366(0x144),_0x40b7cf);const _0x4b0594=await this[_0x4ab366(0x1a4)][_0x4ab366(0x1c5)]({'orderId':_0x2b6421[_0x4ab366(0x1e0)]},{'status':_0x40b7cf,'paydAt':new Date()});_0x40b7cf===0x1&&await this[_0x4ab366(0x16a)][_0x4ab366(0x1bf)](_0x3c9ee1);if(_0x4b0594[_0x4ab366(0x122)]!=0x1)return'failed';return'success';}async[_0x2da662(0x194)](_0x253714,_0x1cf80b,_0x463598=_0x2da662(0x1ea)){const _0x19e1e1=_0x2da662,_0x5949e7=await this[_0x19e1e1(0x1a4)]['findOne']({'where':{'userId':_0x253714,'orderId':_0x1cf80b}});if(!_0x5949e7)throw new common_1[(_0x19e1e1(0x164))](_0x19e1e1(0x17c),common_1[_0x19e1e1(0x11b)]['BAD_REQUEST']);const _0x45a985=await this['cramiPackageEntity']['findOne']({'where':{'id':_0x5949e7[_0x19e1e1(0x1e7)]}});if(!_0x45a985)throw new common_1['HttpException']('套餐不存在!',common_1[_0x19e1e1(0x11b)]['BAD_REQUEST']);const {payMpayPid:_0x5397ea,payMpaySecret:_0x2c1a6b,payMpayNotifyUrl:_0xc068d9,payMpayReturnUrl:_0x3877b7,payMpayApiPayUrl:_0x3c6431}=await this[_0x19e1e1(0x141)]['getConfigs']([_0x19e1e1(0x163),'payMpaySecret',_0x19e1e1(0x142),'payMpayReturnUrl',_0x19e1e1(0x1da)]),_0x49b30b={};_0x49b30b[_0x19e1e1(0x17a)]=Number(_0x5397ea),_0x49b30b[_0x19e1e1(0x15d)]=_0x463598,_0x49b30b[_0x19e1e1(0x1e0)]=_0x1cf80b,_0x49b30b['name']=_0x45a985[_0x19e1e1(0x19a)],_0x49b30b['money']=_0x5949e7[_0x19e1e1(0x134)],_0x49b30b[_0x19e1e1(0x1d7)]=_0xc068d9,_0x49b30b['return_url']=_0x3877b7,_0x49b30b[_0x19e1e1(0x1b0)]=this[_0x19e1e1(0x1b0)](_0x49b30b,_0x2c1a6b),_0x49b30b['sign_type']=_0x19e1e1(0x128);const _0x12e2b8=new URLSearchParams(_0x49b30b)[_0x19e1e1(0x15c)](),_0x43aaea=_0x3c6431+'?'+_0x12e2b8;return{'url_qrcode':null,'redirectUrl':_0x43aaea,'channel':_0x463598,'isRedirect':!![]};const _0x5acbb4=await axios_1[_0x19e1e1(0x1c4)][_0x19e1e1(0x1d4)](_0x3c6431,{'params':_0x49b30b});}async[_0x2da662(0x1d3)](_0x5bf504){const _0x216473=_0x2da662,{payMpayApiQueryUrl:_0x16413b}=await this[_0x216473(0x141)][_0x216473(0x17b)](['payMpayPid',_0x216473(0x190),_0x216473(0x19d)]),_0x4e09f6={};_0x4e09f6[_0x216473(0x15d)]=0x2,_0x4e09f6[_0x216473(0x123)]=_0x5bf504;const {data:{code:_0x150f09,msg:_0x332357,data:_0x1928ab}}=await axios_1[_0x216473(0x1c4)][_0x216473(0x1d4)](_0x16413b,{'params':_0x4e09f6});if(_0x150f09!=0x1)throw new common_1[(_0x216473(0x164))](_0x332357,common_1[_0x216473(0x11b)]['BAD_REQUEST']);return _0x1928ab;}async[_0x2da662(0x17f)](_0x44b81a){const _0x7b02c4=_0x2da662;common_1[_0x7b02c4(0x166)][_0x7b02c4(0x16e)]('微信支付通知params:\x20',_0x44b81a);const {payWeChatAppId:_0x5a2113,payWeChatMchId:_0xaf7051,payWeChatSecret:_0x11a5d7,payWeChatPublicKey:_0xfb541c,payWeChatPrivateKey:_0x55380f}=await this[_0x7b02c4(0x141)][_0x7b02c4(0x17b)]([_0x7b02c4(0x1eb),'payWeChatMchId','payWeChatSecret',_0x7b02c4(0x1b2),'payWeChatPrivateKey']),_0x5d0a22=new this[(_0x7b02c4(0x162))]({'appid':_0x5a2113,'mchid':_0xaf7051,'publicKey':_0xfb541c,'privateKey':_0x55380f});try{if(_0x44b81a[_0x7b02c4(0x196)]=='TRANSACTION.SUCCESS'){const {ciphertext:_0x310898,associated_data:_0x1e6be3,nonce:_0x1efe5f}=_0x44b81a['resource'],_0x293d2b=_0x5d0a22[_0x7b02c4(0x1cc)](_0x310898,_0x1e6be3,_0x1efe5f,_0x11a5d7),_0x30fc32=await this[_0x7b02c4(0x1a4)][_0x7b02c4(0x132)]({'where':{'orderId':_0x293d2b[_0x7b02c4(0x1e0)],'status':0x0}});if(!_0x30fc32)return _0x7b02c4(0x1e3);const _0x2fdfac=_0x293d2b['trade_state']==_0x7b02c4(0x167)?0x1:0x2,_0x50644f=await this[_0x7b02c4(0x1a4)]['update']({'orderId':_0x293d2b[_0x7b02c4(0x1e0)]},{'status':_0x2fdfac,'paydAt':new Date()});_0x2fdfac===0x1&&await this[_0x7b02c4(0x16a)][_0x7b02c4(0x1bf)](_0x30fc32);if(_0x50644f[_0x7b02c4(0x122)]!=0x1)return _0x7b02c4(0x1e3);}return _0x7b02c4(0x145);}catch(_0x5887a2){return common_1[_0x7b02c4(0x166)]['log'](_0x7b02c4(0x1ae),_0x5887a2),common_1[_0x7b02c4(0x166)]['log'](_0x7b02c4(0x181),_0x5887a2),_0x7b02c4(0x1e3);}}async[_0x2da662(0x1e9)](_0x3034e4,_0x55bd55,_0x310c5c=_0x2da662(0x161)){const _0x40c6f4=_0x2da662;var _0x7a8210,_0xfac2c9,_0x3ed87e,_0x3e64c4,_0x2ea72b,_0x1f661f,_0x37570c;common_1[_0x40c6f4(0x166)][_0x40c6f4(0x16e)](_0x40c6f4(0x146),_0x310c5c);const _0x4ffda9=await this[_0x40c6f4(0x1a4)][_0x40c6f4(0x132)]({'where':{'userId':_0x3034e4,'orderId':_0x55bd55}});if(!_0x4ffda9)throw new common_1[(_0x40c6f4(0x164))](_0x40c6f4(0x17c),common_1[_0x40c6f4(0x11b)][_0x40c6f4(0x1b9)]);const _0x14ca2c=await this[_0x40c6f4(0x1bb)][_0x40c6f4(0x132)]({'where':{'id':_0x4ffda9[_0x40c6f4(0x1e7)]}});if(!_0x14ca2c)throw new common_1[(_0x40c6f4(0x164))]('套餐不存在!',common_1['HttpStatus'][_0x40c6f4(0x1b9)]);const {payWeChatAppId:_0x5bcc51,payWeChatMchId:_0x35f836,payWeChatPublicKey:_0xad8a6c,payWeChatPrivateKey:_0x402174,payWeChatNotifyUrl:_0x12defb}=await this[_0x40c6f4(0x141)]['getConfigs'](['payWeChatAppId','payWeChatMchId',_0x40c6f4(0x1b2),_0x40c6f4(0x1df),'payWeChatNotifyUrl']),_0x24c5c4=new this['WxPay']({'appid':_0x5bcc51,'mchid':_0x35f836,'publicKey':_0xad8a6c,'privateKey':_0x402174}),_0x32578a={'appid':_0x5bcc51,'mchid':_0x35f836,'description':_0x14ca2c[_0x40c6f4(0x19a)],'out_trade_no':_0x55bd55,'notify_url':_0x12defb,'amount':{'total':Math[_0x40c6f4(0x19f)](_0x4ffda9['total']*0x64)}};common_1['Logger'][_0x40c6f4(0x16e)](_0x40c6f4(0x18d),_0x32578a);if(_0x310c5c==_0x40c6f4(0x1c8)){common_1[_0x40c6f4(0x166)]['log'](_0x40c6f4(0x1d8)+_0x3034e4+_0x40c6f4(0x148)+_0x55bd55);const _0x3afd14=await this[_0x40c6f4(0x168)][_0x40c6f4(0x15e)](_0x3034e4);common_1[_0x40c6f4(0x166)]['log'](_0x40c6f4(0x1b8)+_0x3afd14),_0x32578a['payer']={'openid':_0x3afd14},common_1[_0x40c6f4(0x166)]['log']('[WeChat\x20Pay\x20JSAPI]\x20发送支付请求参数:\x20',JSON[_0x40c6f4(0x1a8)](_0x32578a,null,0x2));try{const _0x105ee4=await _0x24c5c4['transactions_jsapi'](_0x32578a),_0x247d4f=_0x105ee4['data']?_0x105ee4[_0x40c6f4(0x1bc)]:_0x105ee4;return common_1[_0x40c6f4(0x166)][_0x40c6f4(0x16e)](_0x40c6f4(0x152),JSON[_0x40c6f4(0x1a8)](_0x247d4f,null,0x2)),{'status':_0x105ee4['status']||_0x40c6f4(0x1b5),'appId':_0x247d4f[_0x40c6f4(0x125)]||((_0x7a8210=_0x247d4f['data'])===null||_0x7a8210===void 0x0?void 0x0:_0x7a8210['appId']),'timeStamp':_0x247d4f['timeStamp']||((_0xfac2c9=_0x247d4f[_0x40c6f4(0x1bc)])===null||_0xfac2c9===void 0x0?void 0x0:_0xfac2c9['timeStamp']),'nonceStr':_0x247d4f[_0x40c6f4(0x153)]||((_0x3ed87e=_0x247d4f[_0x40c6f4(0x1bc)])===null||_0x3ed87e===void 0x0?void 0x0:_0x3ed87e[_0x40c6f4(0x153)]),'package':_0x247d4f[_0x40c6f4(0x183)]||((_0x3e64c4=_0x247d4f[_0x40c6f4(0x1bc)])===null||_0x3e64c4===void 0x0?void 0x0:_0x3e64c4['package']),'signType':_0x247d4f[_0x40c6f4(0x131)]||((_0x2ea72b=_0x247d4f[_0x40c6f4(0x1bc)])===null||_0x2ea72b===void 0x0?void 0x0:_0x2ea72b[_0x40c6f4(0x131)]),'paySign':_0x247d4f[_0x40c6f4(0x18a)]||((_0x1f661f=_0x247d4f[_0x40c6f4(0x1bc)])===null||_0x1f661f===void 0x0?void 0x0:_0x1f661f[_0x40c6f4(0x18a)])};}catch(_0x9921e0){console[_0x40c6f4(0x147)](_0x40c6f4(0x182)+_0x9921e0['message'],_0x9921e0),console['error'](_0x40c6f4(0x1a3),_0x9921e0);throw new common_1['HttpException'](_0x40c6f4(0x1d9),common_1['HttpStatus'][_0x40c6f4(0x1b9)]);}}if(_0x310c5c==_0x40c6f4(0x161)){common_1['Logger'][_0x40c6f4(0x16e)](_0x40c6f4(0x174)+_0x55bd55+',\x20用户ID:\x20'+_0x3034e4);try{const _0x2b6984=await _0x24c5c4['transactions_native'](_0x32578a);common_1[_0x40c6f4(0x166)][_0x40c6f4(0x16e)](_0x40c6f4(0x19b),JSON['stringify'](_0x2b6984,null,0x2));let _0x5820d2=_0x2b6984[_0x40c6f4(0x1e4)]||((_0x37570c=_0x2b6984['data'])===null||_0x37570c===void 0x0?void 0x0:_0x37570c[_0x40c6f4(0x1e4)]);return!_0x5820d2?console[_0x40c6f4(0x147)]('微信Native支付请求成功，但未返回code_url，响应数据:\x20',JSON[_0x40c6f4(0x1a8)](_0x2b6984,null,0x2)):common_1[_0x40c6f4(0x166)][_0x40c6f4(0x16e)](_0x40c6f4(0x13c)+_0x5820d2),{'url_qrcode':_0x5820d2,'isRedirect':![]};}catch(_0x57be60){console['error'](_0x40c6f4(0x1ad)+_0x57be60['message'],_0x57be60),console[_0x40c6f4(0x147)](_0x40c6f4(0x177),_0x57be60);throw new common_1[(_0x40c6f4(0x164))](_0x40c6f4(0x1ca),common_1[_0x40c6f4(0x11b)][_0x40c6f4(0x1b9)]);}}else{console['warn'](_0x40c6f4(0x11f)+_0x310c5c);throw new common_1[(_0x40c6f4(0x164))](_0x40c6f4(0x1b6),common_1[_0x40c6f4(0x11b)][_0x40c6f4(0x1b9)]);}}async['queryWeChat'](_0x16e8e2){const _0x1787f2=_0x2da662,{payWeChatAppId:_0x336d58,payWeChatMchId:_0x41b6e5,payWeChatPublicKey:_0x182e91,payWeChatPrivateKey:_0x4f45da,payWeChatNotifyUrl:_0x360012}=await this['globalConfigService'][_0x1787f2(0x17b)]([_0x1787f2(0x1eb),_0x1787f2(0x197),_0x1787f2(0x1b2),_0x1787f2(0x1df)]),_0x3e02d8=new this[(_0x1787f2(0x162))]({'appid':_0x336d58,'mchid':_0x41b6e5,'publicKey':_0x182e91,'privateKey':_0x4f45da}),_0x54c649=await _0x3e02d8[_0x1787f2(0x126)]({'out_trade_no':_0x16e8e2});return _0x54c649;}[_0x2da662(0x1b0)](_0x2503ce,_0x312b3d){const _0x4b4e36=_0x2da662,_0xa07d2a=Object['keys'](_0x2503ce)['sort']()[_0x4b4e36(0x140)](_0x25397f=>_0x25397f+'='+_0x2503ce[_0x25397f])['join']('&')+_0x312b3d;return crypto[_0x4b4e36(0x1d6)](_0x4b4e36(0x171))[_0x4b4e36(0x1c5)](_0xa07d2a)[_0x4b4e36(0x17e)](_0x4b4e36(0x124));}['ltzfSign'](_0x43f58d,_0x35b44f){const _0x8b09be=_0x2da662,_0x257a11=Object[_0x8b09be(0x156)](_0x43f58d);_0x257a11[_0x8b09be(0x16b)]();const _0x1a84cd=[];_0x257a11[_0x8b09be(0x140)](_0x1e316a=>{_0x1a84cd['push'](_0x1e316a+'='+_0x43f58d[_0x1e316a]);}),_0x1a84cd[_0x8b09be(0x185)](_0x8b09be(0x193)+_0x35b44f);const _0x34ac2e=_0x1a84cd['join']('&');return crypto[_0x8b09be(0x1d6)](_0x8b09be(0x171))['update'](_0x34ac2e)['digest'](_0x8b09be(0x124))[_0x8b09be(0x155)]();}async[_0x2da662(0x129)](_0x567c9a,_0x41162d,_0xe11d14=_0x2da662(0x1ea)){const _0x46af82=_0x2da662,_0x14617d=await this['orderEntity'][_0x46af82(0x132)]({'where':{'userId':_0x567c9a,'orderId':_0x41162d}});if(!_0x14617d)throw new common_1[(_0x46af82(0x164))](_0x46af82(0x17c),common_1[_0x46af82(0x11b)][_0x46af82(0x1b9)]);const _0x452495=await this[_0x46af82(0x1bb)]['findOne']({'where':{'id':_0x14617d[_0x46af82(0x1e7)]}});if(!_0x452495)throw new common_1[(_0x46af82(0x164))](_0x46af82(0x12e),common_1[_0x46af82(0x11b)][_0x46af82(0x1b9)]);const {payLtzfMchId:_0x2f402f,payLtzfSecret:_0x117e0e,payLtzfNotifyUrl:_0x5b6370,payLtzfReturnUrl:_0x2cb48a}=await this[_0x46af82(0x141)][_0x46af82(0x17b)]([_0x46af82(0x160),_0x46af82(0x149),_0x46af82(0x16d),_0x46af82(0x14d)]),_0xf844dd={};_0xf844dd['mch_id']=_0x2f402f,_0xf844dd['timestamp']=(Date[_0x46af82(0x11a)]()/0x3e8)[_0x46af82(0x169)](0x0),_0xf844dd[_0x46af82(0x1e0)]=_0x41162d,_0xf844dd['body']=_0x452495['name'],_0xf844dd[_0x46af82(0x1de)]=_0x14617d[_0x46af82(0x134)],_0xf844dd['notify_url']=_0x5b6370,_0xf844dd['sign']=this[_0x46af82(0x175)](_0xf844dd,_0x117e0e),_0xf844dd[_0x46af82(0x16f)]=_0x46af82(0x1a5),_0xf844dd[_0x46af82(0x19e)]=_0x2cb48a;const _0x4d1855=Object[_0x46af82(0x156)](_0xf844dd)[_0x46af82(0x140)](_0x104e41=>encodeURIComponent(_0x104e41)+'='+encodeURIComponent(_0xf844dd[_0x104e41]))[_0x46af82(0x195)]('&'),_0x5acfbf={'headers':{'Content-Type':_0x46af82(0x12d)}},_0x3a892d=await axios_1[_0x46af82(0x1c4)][_0x46af82(0x133)]('https://api.ltzf.cn/api/wxpay/jsapi_convenient',_0x4d1855,_0x5acfbf),{code:_0x4968f7,data:_0x5127f1,msg:_0x2809ac}=_0x3a892d['data'];if(_0x4968f7!=0x0)throw new common_1['HttpException'](_0x2809ac,common_1[_0x46af82(0x11b)][_0x46af82(0x1b9)]);const _0x70b548=_0x5127f1['QRcode_url'],_0x3d8b3c=_0x5127f1[_0x46af82(0x1b7)];return{'url_qrcode':_0x70b548,'url':_0x3d8b3c};}async['queryLtzf'](_0x1719cb){const _0x38c9a2=_0x2da662,{payLtzfMchId:_0x31ddf3,payLtzfSecret:_0x2cc47f}=await this[_0x38c9a2(0x141)][_0x38c9a2(0x17b)]([_0x38c9a2(0x160),_0x38c9a2(0x149)]),_0x1ae2a8={};_0x1ae2a8[_0x38c9a2(0x1ac)]=_0x31ddf3,_0x1ae2a8[_0x38c9a2(0x1bd)]=(Date['now']()/0x3e8)[_0x38c9a2(0x169)](0x0),_0x1ae2a8[_0x38c9a2(0x1e0)]=_0x1719cb,_0x1ae2a8[_0x38c9a2(0x1b0)]=this[_0x38c9a2(0x175)](_0x1ae2a8,_0x2cc47f);const _0x5e391a=Object['keys'](_0x1ae2a8)[_0x38c9a2(0x140)](_0x1d5ec6=>encodeURIComponent(_0x1d5ec6)+'='+encodeURIComponent(_0x1ae2a8[_0x1d5ec6]))[_0x38c9a2(0x195)]('&'),_0x35a302={'headers':{'Content-Type':'application/x-www-form-urlencoded'}},{data:{code:_0x1fe6eb,msg:_0x7f0be9,data:_0x446260}}=await axios_1[_0x38c9a2(0x1c4)][_0x38c9a2(0x133)](_0x38c9a2(0x137),_0x5e391a,_0x35a302);if(_0x1fe6eb!=0x0)throw new common_1[(_0x38c9a2(0x164))](_0x7f0be9+JSON[_0x38c9a2(0x1a8)](_0x1ae2a8),common_1[_0x38c9a2(0x11b)][_0x38c9a2(0x1b9)]);return _0x446260;}async[_0x2da662(0x1cd)](_0x20eba1){const _0x463448=_0x2da662,_0xed6b99=await this[_0x463448(0x141)][_0x463448(0x17b)](['payLtzfSecret']),_0x1d96ba=_0x20eba1[_0x463448(0x1b0)];delete _0x20eba1[_0x463448(0x1b0)],delete _0x20eba1[_0x463448(0x150)],delete _0x20eba1['trade_type'],delete _0x20eba1['success_time'],delete _0x20eba1[_0x463448(0x16f)],delete _0x20eba1[_0x463448(0x1e6)];if(this['ltzfSign'](_0x20eba1,_0xed6b99)!=_0x1d96ba)return'FAIL';const _0xd9cb7=await this['orderEntity']['findOne']({'where':{'orderId':_0x20eba1[_0x463448(0x1e0)],'status':0x0}});if(!_0xd9cb7)return'FAIL';await this['userBalanceService'][_0x463448(0x1bf)](_0xd9cb7);const _0x45142b=await this[_0x463448(0x1a4)][_0x463448(0x1c5)]({'orderId':_0x20eba1[_0x463448(0x1e0)]},{'status':0x1,'paydAt':new Date()});if(_0x45142b['affected']!=0x1)return'FAIL';return'SUCCESS';}};PayService=__decorate([(0x0,common_1[_0x2da662(0x13b)])(),__param(0x0,(0x0,typeorm_1[_0x2da662(0x1d0)])(cramiPackage_entity_1[_0x2da662(0x192)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(order_entity_1[_0x2da662(0x1b4)])),__metadata('design:paramtypes',[typeorm_2[_0x2da662(0x198)],typeorm_2[_0x2da662(0x198)],userBalance_service_1[_0x2da662(0x138)],globalConfig_service_1[_0x2da662(0x1c3)],user_service_1[_0x2da662(0x1b1)]])],PayService),exports[_0x2da662(0x1cf)]=PayService;function _0x4cc0(){const _0x1a9126=['__decorate','payHupiGatewayUrl','payMpaySecret','5CsKKGr','CramiPackageEntity','key=','payMpay','join','event_type','payWeChatMchId','Repository','1791fIGanl','name','微信Native支付响应数据:\x20','length','payMpayApiQueryUrl','return_url','round','wechatpay-node-v3','epay','clientip','[WeChat\x20Pay\x20JSAPI]\x20完整的错误对象：','orderEntity','ltzf','payEpayPid','hupi','stringify','../globalConfig/globalConfig.service','order','../order/order.entity','mch_id','微信Native支付过程中发生错误，错误信息:\x20','error:\x20','739998vVtbuJ','sign','UserService','payWeChatPublicKey','支付请求失败!','OrderEntity','unknown','unsupported\x20pay\x20type','order_url','[WeChat\x20Pay\x20JSAPI]\x20用户OpenID:\x20','BAD_REQUEST','act','cramiPackageEntity','data','timestamp','625734JcjFth','addBalanceToOrder','payEpayReturnUrl','校验签名通过','trade_order_id','GlobalConfigService','default','update','payHupiAppId','3BPelED','jsapi','1.1','微信Native支付失败','1586HOajlw','decipher_gcm','notifyLtzf','axios','PayService','InjectRepository','__metadata','alipay','queryMpay','get','46648XDflWP','createHash','notify_url','[WeChat\x20Pay\x20JSAPI]\x20开始JSAPI支付流程，用户ID:\x20','JSAPI支付失败','payMpayApiPayUrl','../user/user.service','9GBVglE','createRandomNonceStr','total_fee','payWeChatPrivateKey','out_trade_no','https://api.xunhupay.com/payment/do.html','8MnMbYF','failed','code_url','appid','openid','goodsId','getOwnPropertyDescriptor','payWeChat','wxpay','payWeChatAppId','192.168.1.100','now','HttpStatus','version','../userBalance/userBalance.service','__esModule','支付请求使用了不支持的支付类型:\x20','pay','hash','affected','order_no','hex','appId','query','264KMcDzo','MD5','payLtzf','out_trade_order','TRADE_SUCCESS','defineProperty','application/x-www-form-urlencoded','套餐不存在!','epay\x20--->\x20res:\x20','queryEpay','signType','findOne','post','total','money','https://api.xunhupay.com/payment/query.html','https://api.ltzf.cn/api/wxpay/get_pay_order','UserBalanceService','payHupiSecret','resource','Injectable','微信Native支付请求成功，code_url:\x20','校验签名','1612430RoVCyL','queryHupi','map','globalConfigService','payMpayNotifyUrl','__param','status:\x20','success','payType:\x20','error',',\x20订单ID:\x20','payLtzfSecret','metadata','payEpaySecret','sign_type','payLtzfReturnUrl','payEpayNotifyUrl','function','pay_channel','importDynamic','[WeChat\x20Pay\x20JSAPI]\x20支付请求成功，返回结果:\x20','nonceStr','payPlatform','toUpperCase','keys','mpay','payHupi','payHupiNotifyUrl','payEpay','onModuleInit','toString','type','getOpenIdByUserId','12gIhYSc','payLtzfMchId','native','WxPay','payMpayPid','HttpException','time','Logger','SUCCESS','userService','toFixed','userBalanceService','sort','key','payLtzfNotifyUrl','log','attach','本次支付类型:\x20','md5','36526VcuCoZ','../../common/utils','开始进行微信Native支付流程，订单ID:\x20','ltzfSign','object','完整的错误对象：','trade_status','notifyEpay','pid','getConfigs','订单不存在!','payEpayApiPayUrl','digest','notifyWeChat','crypto','支付通知验证失败:\x20','[WeChat\x20Pay\x20JSAPI]\x20支付请求过程中发生错误:\x20','package','notify','push','980815BmrfXS','@nestjs/typeorm','decorate','includes','paySign','notifyHupi','@nestjs/common','wechat-pay:\x20'];_0x4cc0=function(){return _0x1a9126;};return _0x4cc0();}