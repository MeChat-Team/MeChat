'use strict';const _0x59ff84=_0x1277;(function(_0x3aa1d8,_0x15f82f){const _0x16ed98=_0x1277,_0x2aa2e6=_0x3aa1d8();while(!![]){try{const _0x5df657=-parseInt(_0x16ed98(0x219))/0x1+parseInt(_0x16ed98(0x21b))/0x2+-parseInt(_0x16ed98(0x208))/0x3+parseInt(_0x16ed98(0x24a))/0x4+-parseInt(_0x16ed98(0x1ba))/0x5+-parseInt(_0x16ed98(0x20d))/0x6*(parseInt(_0x16ed98(0x1a4))/0x7)+-parseInt(_0x16ed98(0x23b))/0x8*(-parseInt(_0x16ed98(0x1fe))/0x9);if(_0x5df657===_0x15f82f)break;else _0x2aa2e6['push'](_0x2aa2e6['shift']());}catch(_0x45809c){_0x2aa2e6['push'](_0x2aa2e6['shift']());}}}(_0x56de,0x3a747));var __decorate=this&&this[_0x59ff84(0x1ab)]||function(_0x53998b,_0xc8b61,_0x47c16c,_0x41b9cb){const _0xc79b6d=_0x59ff84;var _0x2ac665=arguments['length'],_0x141c6b=_0x2ac665<0x3?_0xc8b61:_0x41b9cb===null?_0x41b9cb=Object[_0xc79b6d(0x253)](_0xc8b61,_0x47c16c):_0x41b9cb,_0x5326cf;if(typeof Reflect===_0xc79b6d(0x245)&&typeof Reflect[_0xc79b6d(0x21e)]===_0xc79b6d(0x1de))_0x141c6b=Reflect[_0xc79b6d(0x21e)](_0x53998b,_0xc8b61,_0x47c16c,_0x41b9cb);else{for(var _0x37f8b8=_0x53998b[_0xc79b6d(0x216)]-0x1;_0x37f8b8>=0x0;_0x37f8b8--)if(_0x5326cf=_0x53998b[_0x37f8b8])_0x141c6b=(_0x2ac665<0x3?_0x5326cf(_0x141c6b):_0x2ac665>0x3?_0x5326cf(_0xc8b61,_0x47c16c,_0x141c6b):_0x5326cf(_0xc8b61,_0x47c16c))||_0x141c6b;}return _0x2ac665>0x3&&_0x141c6b&&Object[_0xc79b6d(0x1d4)](_0xc8b61,_0x47c16c,_0x141c6b),_0x141c6b;},__metadata=this&&this[_0x59ff84(0x1fc)]||function(_0x42a6e2,_0x15fda2){const _0x5a8ea2=_0x59ff84;if(typeof Reflect==='object'&&typeof Reflect[_0x5a8ea2(0x20a)]===_0x5a8ea2(0x1de))return Reflect[_0x5a8ea2(0x20a)](_0x42a6e2,_0x15fda2);},__param=this&&this[_0x59ff84(0x224)]||function(_0x4feead,_0x1f42bc){return function(_0x1cef99,_0x505123){_0x1f42bc(_0x1cef99,_0x505123,_0x4feead);};};function _0x56de(){const _0x429ac5=[',\x20订单ID:\x20','getOwnPropertyDescriptor','message','1.1','https://api.xunhupay.com/payment/query.html','queryLtzf','../userBalance/userBalance.service','queryMpay','TRANSACTION.SUCCESS','校验签名通过','payMpayPid','timeStamp','@nestjs/typeorm','jsapi','md5','payLtzfReturnUrl','get','payEpayApiQueryUrl','createRandomNonceStr','微信Native支付失败','payMpayReturnUrl','../crami/cramiPackage.entity','ltzf','sort','JSAPI支付失败','微信Native支付请求成功，但未返回code_url，响应数据:\x20','payEpayNotifyUrl','queryWeChat','resource','[WeChat\x20Pay\x20JSAPI]\x20支付请求成功，返回结果:\x20','UserService','sign_type','epay','query','InjectRepository','pid','payLtzfSecret','https://api.xunhupay.com/payment/do.html','notify_url','805hgUxOZ','out_trade_no','支付请求失败!','wechat','userService','hex','post','__decorate','onModuleInit','error','userBalanceService','payHupiNotifyUrl','订单不存在!','error:\x20','payHupiAppId','微信Native支付响应数据:\x20','name','cramiPackageEntity','pay_channel','[WeChat\x20Pay\x20JSAPI]\x20用户OpenID:\x20','[WeChat\x20Pay\x20JSAPI]\x20发送支付请求参数:\x20','decipher_gcm','2069975jXbIUh','mpay','stringify','transactions_native','payMpaySecret','epay\x20--->\x20res:\x20','goodsId','trade_order_id','payMpayApiPayUrl','join','notifyLtzf','device','payPlatform','payer','globalConfigService','warn','getConfigs','payHupi','paySign','FAIL','hupi','payEpay','design:paramtypes','package','money','findOne','defineProperty','套餐不存在!','HttpStatus','type','body','payEpayPid','now','完整的错误对象：','total','sign','function','OrderEntity','Logger','Injectable','WxPay','act','trade_state','application/x-www-form-urlencoded','ltzfSign','nonceStr','transactions_jsapi','key=','payEpayApiPayUrl','appId','CramiPackageEntity','@nestjs/common','log','payType:\x20','MD5','校验签名','notifyEpay','payLtzfNotifyUrl','order_url','status','order','PayService','getOpenIdByUserId','toString','native','payMpayApiQueryUrl','__metadata','failed','6520401nOZNGQ','mch_id','../globalConfig/globalConfig.service','pay','keys','本次支付类型:\x20','payWeChatPublicKey','payHupiSecret','alipay','wxpay','111357mHkWby','trade_type','metadata','default','success','5244GIGIfm','unsupported\x20pay\x20type','payEpayReturnUrl','code_url','payWeChat','data','payWeChatMchId','return_url','toUpperCase','length','nonce_str','notifyMpay','449386sTgKBz','支付通知验证失败:\x20','555714WCXhKr','../../common/utils','hash','decorate','payWeChatSecret','payMpay','[WeChat\x20Pay\x20JSAPI]\x20开始JSAPI支付流程，用户ID:\x20','status:\x20','../user/user.service','__param','param','event_type','微信Native支付请求成功，code_url:\x20','GlobalConfigService','affected','queryHupi','payWeChatNotifyUrl','digest','toFixed','payEpaySecret','payWeChatPrivateKey','[WeChat\x20Pay\x20JSAPI]\x20支付请求过程中发生错误:\x20','HttpException','https://api.ltzf.cn/api/wxpay/jsapi_convenient','clientip','signType','payHupiReturnUrl','version','success_time','payWeChatAppId','payLtzfMchId','attach','8HYczHE','typeorm','orderEntity','timestamp','addBalanceToOrder','time','push','BAD_REQUEST','../order/order.entity','TRADE_SUCCESS','object','payHupiGatewayUrl','update','map','notifyHupi','952380ydQhlU','payMpayNotifyUrl','SUCCESS','title','payLtzf','appid','trade_status','includes'];_0x56de=function(){return _0x429ac5;};return _0x56de();}Object[_0x59ff84(0x1d4)](exports,'__esModule',{'value':!![]}),exports['PayService']=void 0x0;function _0x1277(_0x59aef0,_0x1fdded){const _0x56dedb=_0x56de();return _0x1277=function(_0x1277da,_0x506821){_0x1277da=_0x1277da-0x1a3;let _0x32f1ea=_0x56dedb[_0x1277da];return _0x32f1ea;},_0x1277(_0x59aef0,_0x1fdded);}const utils_1=require(_0x59ff84(0x21c)),common_1=require(_0x59ff84(0x1ed)),typeorm_1=require(_0x59ff84(0x25e)),axios_1=require('axios'),crypto=require('crypto'),typeorm_2=require(_0x59ff84(0x23c)),cramiPackage_entity_1=require(_0x59ff84(0x267)),globalConfig_service_1=require(_0x59ff84(0x200)),order_entity_1=require(_0x59ff84(0x243)),user_service_1=require(_0x59ff84(0x223)),userBalance_service_1=require(_0x59ff84(0x258));let PayService=class PayService{constructor(_0x904c32,_0x90117c,_0x354890,_0x3f265b,_0x368a14){const _0x7a2a9b=_0x59ff84;this[_0x7a2a9b(0x1b5)]=_0x904c32,this['orderEntity']=_0x90117c,this[_0x7a2a9b(0x1ae)]=_0x354890,this[_0x7a2a9b(0x1c8)]=_0x3f265b,this[_0x7a2a9b(0x1a8)]=_0x368a14;}async[_0x59ff84(0x1ac)](){const _0x2224e1=_0x59ff84,_0x2282d3=await(0x0,utils_1['importDynamic'])('wechatpay-node-v3');this['WxPay']=(_0x2282d3===null||_0x2282d3===void 0x0?void 0x0:_0x2282d3[_0x2224e1(0x20b)])?_0x2282d3[_0x2224e1(0x20b)]:_0x2282d3;}async['notify'](_0x2bbdab){const _0x352a3f=_0x59ff84;if(_0x2bbdab[_0x352a3f(0x225)]==_0x352a3f(0x272))return this[_0x352a3f(0x1f2)](_0x2bbdab);if(_0x2bbdab[_0x352a3f(0x23a)]==_0x352a3f(0x1ce))return this[_0x352a3f(0x249)](_0x2bbdab);if(_0x2bbdab[_0x352a3f(0x23a)]==_0x352a3f(0x268))return this[_0x352a3f(0x1c4)](_0x2bbdab);if(typeof _0x2bbdab[_0x352a3f(0x26e)]==_0x352a3f(0x245))return this['notifyWeChat'](_0x2bbdab);return this[_0x352a3f(0x218)](_0x2bbdab);}async[_0x59ff84(0x201)](_0x2a53ec,_0x4df4c9,_0x3eccbf=_0x59ff84(0x207)){const _0x329766=_0x59ff84,_0x337de7=await this[_0x329766(0x23d)]['findOne']({'where':{'userId':_0x2a53ec,'orderId':_0x4df4c9}});if(!_0x337de7)throw new common_1[(_0x329766(0x231))](_0x329766(0x1b0),common_1[_0x329766(0x1d6)][_0x329766(0x242)]);const _0x31ea17=await this[_0x329766(0x1b5)][_0x329766(0x1d3)]({'where':{'id':_0x337de7[_0x329766(0x1c0)]}});if(!_0x31ea17)throw new common_1['HttpException']('套餐不存在!',common_1['HttpStatus'][_0x329766(0x242)]);common_1[_0x329766(0x1e0)][_0x329766(0x1ee)](_0x329766(0x203),_0x337de7[_0x329766(0x1c6)]);try{if(_0x337de7[_0x329766(0x1c6)]==_0x329766(0x1a7))return this[_0x329766(0x211)](_0x2a53ec,_0x4df4c9,_0x3eccbf);if(_0x337de7[_0x329766(0x1c6)]=='epay')return this['payEpay'](_0x2a53ec,_0x4df4c9,_0x3eccbf);if(_0x337de7[_0x329766(0x1c6)]==_0x329766(0x1bb))return this[_0x329766(0x220)](_0x2a53ec,_0x4df4c9,_0x3eccbf);if(_0x337de7[_0x329766(0x1c6)]==_0x329766(0x1ce))return this[_0x329766(0x1cb)](_0x2a53ec,_0x4df4c9,_0x3eccbf);if(_0x337de7['payPlatform']=='ltzf')return this[_0x329766(0x24e)](_0x2a53ec,_0x4df4c9,_0x3eccbf);}catch(_0x1b2369){common_1['Logger'][_0x329766(0x1ee)]('支付请求失败:\x20',_0x1b2369);throw new common_1[(_0x329766(0x231))](_0x329766(0x1a6),common_1[_0x329766(0x1d6)][_0x329766(0x242)]);}}async[_0x59ff84(0x273)](_0x5dddb8){const _0x46be6e=_0x59ff84,_0x2f9500=await this['orderEntity'][_0x46be6e(0x1d3)]({'where':{'orderId':_0x5dddb8}});if(!_0x2f9500)throw new common_1[(_0x46be6e(0x231))](_0x46be6e(0x1b0),common_1['HttpStatus']['BAD_REQUEST']);return _0x2f9500;}async['notifyHupi'](_0x407d51){const _0x4e31c1=_0x59ff84,_0x47e962=await this[_0x4e31c1(0x1c8)][_0x4e31c1(0x1ca)](['payHupiSecret']),_0x4e4373=_0x407d51['hash'];delete _0x407d51[_0x4e31c1(0x21d)];if(this[_0x4e31c1(0x1dd)](_0x407d51,_0x47e962)!=_0x4e4373)return _0x4e31c1(0x1fd);const _0x46d5ae=await this[_0x4e31c1(0x23d)][_0x4e31c1(0x1d3)]({'where':{'orderId':_0x407d51['trade_order_id'],'status':0x0}});if(!_0x46d5ae)return _0x4e31c1(0x1fd);await this[_0x4e31c1(0x1ae)][_0x4e31c1(0x23f)](_0x46d5ae);const _0x74ea65=await this[_0x4e31c1(0x23d)][_0x4e31c1(0x247)]({'orderId':_0x407d51[_0x4e31c1(0x1c1)]},{'status':0x1,'paydAt':new Date()});if(_0x74ea65['affected']!=0x1)return _0x4e31c1(0x1fd);return _0x4e31c1(0x20c);}async[_0x59ff84(0x1cb)](_0x35b026,_0x4bfe54,_0x138d1e='wxpay'){const _0x31e8be=_0x59ff84,_0x42cd54=await this[_0x31e8be(0x23d)][_0x31e8be(0x1d3)]({'where':{'userId':_0x35b026,'orderId':_0x4bfe54}});if(!_0x42cd54)throw new common_1[(_0x31e8be(0x231))](_0x31e8be(0x1b0),common_1[_0x31e8be(0x1d6)][_0x31e8be(0x242)]);const _0x32f8f2=await this[_0x31e8be(0x1b5)]['findOne']({'where':{'id':_0x42cd54[_0x31e8be(0x1c0)]}});if(!_0x32f8f2)throw new common_1['HttpException']('套餐不存在!',common_1[_0x31e8be(0x1d6)][_0x31e8be(0x242)]);const {payHupiAppId:_0x1336cf,payHupiSecret:_0x42888c,payHupiNotifyUrl:_0x32905e,payHupiReturnUrl:_0x272950,payHupiGatewayUrl:_0x5a5ed3}=await this[_0x31e8be(0x1c8)][_0x31e8be(0x1ca)](['payHupiAppId',_0x31e8be(0x205),_0x31e8be(0x1af),_0x31e8be(0x235),_0x31e8be(0x246)]),_0xf2128e={};_0xf2128e[_0x31e8be(0x236)]=_0x31e8be(0x255),_0xf2128e[_0x31e8be(0x24f)]=_0x1336cf,_0xf2128e[_0x31e8be(0x240)]=(Date[_0x31e8be(0x1da)]()/0x3e8)[_0x31e8be(0x22d)](0x0),_0xf2128e[_0x31e8be(0x217)]=(0x0,utils_1[_0x31e8be(0x264)])(0x20),_0xf2128e['trade_order_id']=_0x4bfe54,_0xf2128e[_0x31e8be(0x24d)]=_0x32f8f2[_0x31e8be(0x1b4)],_0xf2128e['total_fee']=_0x42cd54[_0x31e8be(0x1dc)],_0xf2128e[_0x31e8be(0x1a3)]=_0x32905e,_0xf2128e[_0x31e8be(0x214)]=_0x272950,_0xf2128e['attach']='hupi',_0xf2128e[_0x31e8be(0x21d)]=this[_0x31e8be(0x1dd)](_0xf2128e,_0x42888c);const {data:{errcode:_0x4f4a27,errmsg:_0xf8338a,url_qrcode:_0xc62c74,url:_0x17deaa}}=await axios_1[_0x31e8be(0x20b)]['post'](_0x5a5ed3||_0x31e8be(0x277),_0xf2128e);if(_0x4f4a27!=0x0)throw new common_1[(_0x31e8be(0x231))](_0xf8338a,common_1[_0x31e8be(0x1d6)]['BAD_REQUEST']);return{'url_qrcode':_0xc62c74,'url':_0x17deaa};}async[_0x59ff84(0x22a)](_0x110908){const _0x7c2d75=_0x59ff84,{payHupiAppId:_0x345331,payHupiSecret:_0x46eb94}=await this[_0x7c2d75(0x1c8)]['getConfigs']([_0x7c2d75(0x1b2),_0x7c2d75(0x205)]),_0x1904f={};_0x1904f[_0x7c2d75(0x236)]=_0x7c2d75(0x255),_0x1904f[_0x7c2d75(0x24f)]=_0x345331,_0x1904f['time']=(Date[_0x7c2d75(0x1da)]()/0x3e8)[_0x7c2d75(0x22d)](0x0),_0x1904f[_0x7c2d75(0x217)]=(0x0,utils_1[_0x7c2d75(0x264)])(0x20),_0x1904f['out_trade_order']=_0x110908,_0x1904f[_0x7c2d75(0x21d)]=this[_0x7c2d75(0x1dd)](_0x1904f,_0x46eb94);const {data:{errcode:_0x4bad67,errmsg:_0x261365,data:_0x54c4a1}}=await axios_1['default'][_0x7c2d75(0x1aa)](_0x7c2d75(0x256),_0x1904f);if(_0x4bad67!=0x0)throw new common_1[(_0x7c2d75(0x231))](_0x261365,common_1['HttpStatus'][_0x7c2d75(0x242)]);return _0x54c4a1;}async['notifyEpay'](_0x37a428){const _0x33cd42=_0x59ff84,_0x29b460=_0x37a428[_0x33cd42(0x1dd)];delete _0x37a428[_0x33cd42(0x1dd)],delete _0x37a428[_0x33cd42(0x271)];const _0x34ff15=await this[_0x33cd42(0x1c8)][_0x33cd42(0x1ca)](['payEpaySecret']);if(this['sign'](_0x37a428,_0x34ff15)!=_0x29b460)return _0x33cd42(0x1fd);common_1[_0x33cd42(0x1e0)][_0x33cd42(0x1ee)](_0x33cd42(0x25b));const _0x4dc19e=await this['orderEntity'][_0x33cd42(0x1d3)]({'where':{'orderId':_0x37a428[_0x33cd42(0x1a5)],'status':0x0}});if(!_0x4dc19e)return'failed';const _0x4548ee=_0x37a428[_0x33cd42(0x250)]==_0x33cd42(0x244)?0x1:0x2,_0x48aaf3=await this[_0x33cd42(0x23d)][_0x33cd42(0x247)]({'orderId':_0x37a428['out_trade_no']},{'status':_0x4548ee,'paydAt':new Date()});_0x4548ee===0x1&&await this[_0x33cd42(0x1ae)][_0x33cd42(0x23f)](_0x4dc19e);if(_0x48aaf3[_0x33cd42(0x229)]!=0x1)return'failed';return _0x33cd42(0x20c);}async[_0x59ff84(0x1cf)](_0x899e40,_0x1be15e,_0xa7ed55=_0x59ff84(0x206)){const _0x5a0196=_0x59ff84,_0x5ab807=await this[_0x5a0196(0x23d)][_0x5a0196(0x1d3)]({'where':{'userId':_0x899e40,'orderId':_0x1be15e}});if(!_0x5ab807)throw new common_1['HttpException'](_0x5a0196(0x1b0),common_1[_0x5a0196(0x1d6)][_0x5a0196(0x242)]);const _0x21a0c3=await this[_0x5a0196(0x1b5)][_0x5a0196(0x1d3)]({'where':{'id':_0x5ab807[_0x5a0196(0x1c0)]}});if(!_0x21a0c3)throw new common_1[(_0x5a0196(0x231))]('套餐不存在!',common_1[_0x5a0196(0x1d6)][_0x5a0196(0x242)]);const {payEpayPid:_0x28517b,payEpaySecret:_0x5df1d5,payEpayNotifyUrl:_0x55f3f3,payEpayReturnUrl:_0x499d75,payEpayApiPayUrl:_0x29f7ee}=await this[_0x5a0196(0x1c8)][_0x5a0196(0x1ca)](['payEpayPid',_0x5a0196(0x22e),_0x5a0196(0x26c),_0x5a0196(0x20f),_0x5a0196(0x1ea)]);let _0x28363d;_0x28517b[_0x5a0196(0x216)]<=0x10?_0x28363d=Number(_0x28517b):_0x28363d=BigInt(_0x28517b);const _0x3e0255={};_0x3e0255['pid']=_0x28363d,_0x3e0255[_0x5a0196(0x1d7)]=_0xa7ed55,_0x3e0255['out_trade_no']=_0x1be15e,_0x3e0255[_0x5a0196(0x1b4)]=_0x21a0c3[_0x5a0196(0x1b4)],_0x3e0255['money']=_0x5ab807['total'],_0x3e0255[_0x5a0196(0x233)]='192.168.1.100',_0x3e0255[_0x5a0196(0x1c5)]='pc',_0x3e0255[_0x5a0196(0x1a3)]=_0x55f3f3,_0x3e0255[_0x5a0196(0x214)]=_0x499d75,_0x3e0255[_0x5a0196(0x225)]=_0x5a0196(0x272),_0x3e0255[_0x5a0196(0x1dd)]=this[_0x5a0196(0x1dd)](_0x3e0255,_0x5df1d5),_0x3e0255[_0x5a0196(0x271)]=_0x5a0196(0x1f0);const _0x3f1b0c=new URLSearchParams(_0x3e0255)[_0x5a0196(0x1f9)](),_0x2fa277=_0x29f7ee+'?'+_0x3f1b0c;if(_0x29f7ee[_0x5a0196(0x251)]('submit.php'))return{'url_qrcode':null,'redirectUrl':_0x2fa277,'channel':_0xa7ed55,'isRedirect':!![]};else{const _0x3d7bb6={'headers':{'Content-Type':'application/x-www-form-urlencoded'}},_0x4cb6b8=await axios_1['default']['post'](_0x29f7ee,_0x3e0255,_0x3d7bb6);common_1[_0x5a0196(0x1e0)][_0x5a0196(0x1ee)](_0x5a0196(0x1bf),_0x4cb6b8[_0x5a0196(0x212)]);const {data:{code:_0x5ace59,msg:_0x150a70,qrcode:_0x1e7968}}=_0x4cb6b8;if(_0x5ace59!=0x1)throw new common_1[(_0x5a0196(0x231))](_0x150a70,common_1[_0x5a0196(0x1d6)][_0x5a0196(0x242)]);return{'url_qrcode':_0x1e7968,'redirectUrl':null,'channel':_0xa7ed55,'isRedirect':![]};}}async['queryEpay'](_0x1ee427){const _0x260338=_0x59ff84,{payEpayPid:_0x359bb5,payEpaySecret:_0x57669e,payEpayApiQueryUrl:_0x472324}=await this[_0x260338(0x1c8)][_0x260338(0x1ca)]([_0x260338(0x1d9),'payEpaySecret',_0x260338(0x263)]),_0x34ba5e={};_0x34ba5e[_0x260338(0x1e3)]=_0x260338(0x1f6),_0x34ba5e[_0x260338(0x1a5)]=_0x1ee427,_0x34ba5e[_0x260338(0x275)]=_0x359bb5,_0x34ba5e['key']=_0x57669e;const {data:{code:_0x41ef0c,msg:_0x5e515e,data:_0x5bd2fb}}=await axios_1[_0x260338(0x20b)][_0x260338(0x262)](_0x472324,{'params':_0x34ba5e});if(_0x41ef0c!=0x1)throw new common_1[(_0x260338(0x231))](_0x5e515e,common_1[_0x260338(0x1d6)][_0x260338(0x242)]);return _0x5bd2fb;}async[_0x59ff84(0x218)](_0x21fd30){const _0x1d140d=_0x59ff84,_0x1ff900=_0x21fd30[_0x1d140d(0x1dd)];delete _0x21fd30[_0x1d140d(0x1dd)],delete _0x21fd30[_0x1d140d(0x271)];const _0x15d33a=await this[_0x1d140d(0x1c8)][_0x1d140d(0x1ca)]([_0x1d140d(0x1be)]);common_1[_0x1d140d(0x1e0)][_0x1d140d(0x1ee)](_0x1d140d(0x1f1));if(this['sign'](_0x21fd30,_0x15d33a)!=_0x1ff900)return _0x1d140d(0x1fd);common_1[_0x1d140d(0x1e0)][_0x1d140d(0x1ee)](_0x1d140d(0x25b));const _0xb5cba0=await this[_0x1d140d(0x23d)][_0x1d140d(0x1d3)]({'where':{'orderId':_0x21fd30[_0x1d140d(0x1a5)],'status':0x0}});if(!_0xb5cba0)return _0x1d140d(0x1fd);const _0x439e06=_0x21fd30[_0x1d140d(0x250)]=='TRADE_SUCCESS'?0x1:0x2;common_1[_0x1d140d(0x1e0)][_0x1d140d(0x1ee)](_0x1d140d(0x222),_0x439e06);const _0x5afb72=await this[_0x1d140d(0x23d)][_0x1d140d(0x247)]({'orderId':_0x21fd30[_0x1d140d(0x1a5)]},{'status':_0x439e06,'paydAt':new Date()});_0x439e06===0x1&&await this[_0x1d140d(0x1ae)][_0x1d140d(0x23f)](_0xb5cba0);if(_0x5afb72['affected']!=0x1)return _0x1d140d(0x1fd);return _0x1d140d(0x20c);}async[_0x59ff84(0x220)](_0x411c7d,_0x1b63e9,_0x120f66=_0x59ff84(0x207)){const _0x1855ad=_0x59ff84,_0x12af20=await this[_0x1855ad(0x23d)][_0x1855ad(0x1d3)]({'where':{'userId':_0x411c7d,'orderId':_0x1b63e9}});if(!_0x12af20)throw new common_1['HttpException'](_0x1855ad(0x1b0),common_1[_0x1855ad(0x1d6)][_0x1855ad(0x242)]);const _0x3445a9=await this['cramiPackageEntity'][_0x1855ad(0x1d3)]({'where':{'id':_0x12af20[_0x1855ad(0x1c0)]}});if(!_0x3445a9)throw new common_1[(_0x1855ad(0x231))](_0x1855ad(0x1d5),common_1[_0x1855ad(0x1d6)]['BAD_REQUEST']);const {payMpayPid:_0x5d677d,payMpaySecret:_0x4e5dec,payMpayNotifyUrl:_0x16c82d,payMpayReturnUrl:_0x47f011,payMpayApiPayUrl:_0x3cc60a}=await this[_0x1855ad(0x1c8)][_0x1855ad(0x1ca)]([_0x1855ad(0x25c),_0x1855ad(0x1be),_0x1855ad(0x24b),_0x1855ad(0x266),_0x1855ad(0x1c2)]),_0x5de0ce={};_0x5de0ce[_0x1855ad(0x275)]=Number(_0x5d677d),_0x5de0ce[_0x1855ad(0x1d7)]=_0x120f66,_0x5de0ce[_0x1855ad(0x1a5)]=_0x1b63e9,_0x5de0ce[_0x1855ad(0x1b4)]=_0x3445a9[_0x1855ad(0x1b4)],_0x5de0ce[_0x1855ad(0x1d2)]=_0x12af20[_0x1855ad(0x1dc)],_0x5de0ce[_0x1855ad(0x1a3)]=_0x16c82d,_0x5de0ce['return_url']=_0x47f011,_0x5de0ce['sign']=this[_0x1855ad(0x1dd)](_0x5de0ce,_0x4e5dec),_0x5de0ce[_0x1855ad(0x271)]=_0x1855ad(0x1f0);const _0x28b70c=new URLSearchParams(_0x5de0ce)['toString'](),_0x41e4f6=_0x3cc60a+'?'+_0x28b70c;return{'url_qrcode':null,'redirectUrl':_0x41e4f6,'channel':_0x120f66,'isRedirect':!![]};const _0x54f786=await axios_1[_0x1855ad(0x20b)][_0x1855ad(0x262)](_0x3cc60a,{'params':_0x5de0ce});}async[_0x59ff84(0x259)](_0xc9f77e){const _0x433ccc=_0x59ff84,{payMpayApiQueryUrl:_0x3a2c41}=await this['globalConfigService'][_0x433ccc(0x1ca)](['payMpayPid',_0x433ccc(0x1be),_0x433ccc(0x1fb)]),_0x1f9be8={};_0x1f9be8['type']=0x2,_0x1f9be8['order_no']=_0xc9f77e;const {data:{code:_0x5721ac,msg:_0x1cacc8,data:_0x796151}}=await axios_1[_0x433ccc(0x20b)][_0x433ccc(0x262)](_0x3a2c41,{'params':_0x1f9be8});if(_0x5721ac!=0x1)throw new common_1[(_0x433ccc(0x231))](_0x1cacc8,common_1[_0x433ccc(0x1d6)]['BAD_REQUEST']);return _0x796151;}async['notifyWeChat'](_0x5afb51){const _0xf035c3=_0x59ff84;common_1[_0xf035c3(0x1e0)]['log']('微信支付通知params:\x20',_0x5afb51);const {payWeChatAppId:_0x920b5f,payWeChatMchId:_0x4cfa03,payWeChatSecret:_0x2fb86b,payWeChatPublicKey:_0x3fc620,payWeChatPrivateKey:_0x1511b3}=await this['globalConfigService'][_0xf035c3(0x1ca)]([_0xf035c3(0x238),_0xf035c3(0x213),_0xf035c3(0x21f),'payWeChatPublicKey',_0xf035c3(0x22f)]),_0x24c581=new this[(_0xf035c3(0x1e2))]({'appid':_0x920b5f,'mchid':_0x4cfa03,'publicKey':_0x3fc620,'privateKey':_0x1511b3});try{if(_0x5afb51[_0xf035c3(0x226)]==_0xf035c3(0x25a)){const {ciphertext:_0x46e07e,associated_data:_0x2bfd61,nonce:_0x3f91bc}=_0x5afb51[_0xf035c3(0x26e)],_0x4e09f1=_0x24c581[_0xf035c3(0x1b9)](_0x46e07e,_0x2bfd61,_0x3f91bc,_0x2fb86b),_0x222a90=await this['orderEntity']['findOne']({'where':{'orderId':_0x4e09f1[_0xf035c3(0x1a5)],'status':0x0}});if(!_0x222a90)return _0xf035c3(0x1fd);const _0x2c45ce=_0x4e09f1[_0xf035c3(0x1e4)]==_0xf035c3(0x24c)?0x1:0x2,_0x1c6e3d=await this[_0xf035c3(0x23d)]['update']({'orderId':_0x4e09f1[_0xf035c3(0x1a5)]},{'status':_0x2c45ce,'paydAt':new Date()});_0x2c45ce===0x1&&await this[_0xf035c3(0x1ae)][_0xf035c3(0x23f)](_0x222a90);if(_0x1c6e3d['affected']!=0x1)return _0xf035c3(0x1fd);}return _0xf035c3(0x20c);}catch(_0x61a4a7){return common_1[_0xf035c3(0x1e0)][_0xf035c3(0x1ee)](_0xf035c3(0x1b1),_0x61a4a7),common_1[_0xf035c3(0x1e0)][_0xf035c3(0x1ee)](_0xf035c3(0x21a),_0x61a4a7),_0xf035c3(0x1fd);}}async['payWeChat'](_0x464155,_0x3186f8,_0x2a8c9d='native'){const _0x57e474=_0x59ff84;var _0x32b61c,_0x50ec86,_0x371185,_0x4b71c4,_0x293a59,_0x226a1e,_0x538806;common_1[_0x57e474(0x1e0)][_0x57e474(0x1ee)](_0x57e474(0x1ef),_0x2a8c9d);const _0x11c773=await this[_0x57e474(0x23d)][_0x57e474(0x1d3)]({'where':{'userId':_0x464155,'orderId':_0x3186f8}});if(!_0x11c773)throw new common_1[(_0x57e474(0x231))](_0x57e474(0x1b0),common_1['HttpStatus']['BAD_REQUEST']);const _0x5233e0=await this['cramiPackageEntity'][_0x57e474(0x1d3)]({'where':{'id':_0x11c773[_0x57e474(0x1c0)]}});if(!_0x5233e0)throw new common_1['HttpException'](_0x57e474(0x1d5),common_1[_0x57e474(0x1d6)][_0x57e474(0x242)]);const {payWeChatAppId:_0x79ac15,payWeChatMchId:_0x1f21e1,payWeChatPublicKey:_0x2fd001,payWeChatPrivateKey:_0x121a6d,payWeChatNotifyUrl:_0x388f15}=await this[_0x57e474(0x1c8)][_0x57e474(0x1ca)]([_0x57e474(0x238),_0x57e474(0x213),_0x57e474(0x204),'payWeChatPrivateKey',_0x57e474(0x22b)]),_0x264761=new this[(_0x57e474(0x1e2))]({'appid':_0x79ac15,'mchid':_0x1f21e1,'publicKey':_0x2fd001,'privateKey':_0x121a6d}),_0x1e8020={'appid':_0x79ac15,'mchid':_0x1f21e1,'description':_0x5233e0[_0x57e474(0x1b4)],'out_trade_no':_0x3186f8,'notify_url':_0x388f15,'amount':{'total':Math['round'](_0x11c773['total']*0x64)}};common_1[_0x57e474(0x1e0)][_0x57e474(0x1ee)]('wechat-pay:\x20',_0x1e8020);if(_0x2a8c9d==_0x57e474(0x25f)){common_1[_0x57e474(0x1e0)]['log'](_0x57e474(0x221)+_0x464155+_0x57e474(0x252)+_0x3186f8);const _0x41387e=await this[_0x57e474(0x1a8)][_0x57e474(0x1f8)](_0x464155);common_1[_0x57e474(0x1e0)][_0x57e474(0x1ee)](_0x57e474(0x1b7)+_0x41387e),_0x1e8020[_0x57e474(0x1c7)]={'openid':_0x41387e},common_1[_0x57e474(0x1e0)]['log'](_0x57e474(0x1b8),JSON[_0x57e474(0x1bc)](_0x1e8020,null,0x2));try{const _0x3b5ddd=await _0x264761[_0x57e474(0x1e8)](_0x1e8020),_0x2b02b6=_0x3b5ddd[_0x57e474(0x212)]?_0x3b5ddd['data']:_0x3b5ddd;return common_1[_0x57e474(0x1e0)][_0x57e474(0x1ee)](_0x57e474(0x26f),JSON[_0x57e474(0x1bc)](_0x2b02b6,null,0x2)),{'status':_0x3b5ddd[_0x57e474(0x1f5)]||'unknown','appId':_0x2b02b6[_0x57e474(0x1eb)]||((_0x32b61c=_0x2b02b6[_0x57e474(0x212)])===null||_0x32b61c===void 0x0?void 0x0:_0x32b61c[_0x57e474(0x1eb)]),'timeStamp':_0x2b02b6[_0x57e474(0x25d)]||((_0x50ec86=_0x2b02b6[_0x57e474(0x212)])===null||_0x50ec86===void 0x0?void 0x0:_0x50ec86['timeStamp']),'nonceStr':_0x2b02b6[_0x57e474(0x1e7)]||((_0x371185=_0x2b02b6[_0x57e474(0x212)])===null||_0x371185===void 0x0?void 0x0:_0x371185[_0x57e474(0x1e7)]),'package':_0x2b02b6['package']||((_0x4b71c4=_0x2b02b6[_0x57e474(0x212)])===null||_0x4b71c4===void 0x0?void 0x0:_0x4b71c4[_0x57e474(0x1d1)]),'signType':_0x2b02b6[_0x57e474(0x234)]||((_0x293a59=_0x2b02b6['data'])===null||_0x293a59===void 0x0?void 0x0:_0x293a59[_0x57e474(0x234)]),'paySign':_0x2b02b6[_0x57e474(0x1cc)]||((_0x226a1e=_0x2b02b6[_0x57e474(0x212)])===null||_0x226a1e===void 0x0?void 0x0:_0x226a1e[_0x57e474(0x1cc)])};}catch(_0x1ce6d1){console[_0x57e474(0x1ad)](_0x57e474(0x230)+_0x1ce6d1[_0x57e474(0x254)],_0x1ce6d1),console[_0x57e474(0x1ad)]('[WeChat\x20Pay\x20JSAPI]\x20完整的错误对象：',_0x1ce6d1);throw new common_1[(_0x57e474(0x231))](_0x57e474(0x26a),common_1[_0x57e474(0x1d6)][_0x57e474(0x242)]);}}if(_0x2a8c9d==_0x57e474(0x1fa)){common_1[_0x57e474(0x1e0)][_0x57e474(0x1ee)]('开始进行微信Native支付流程，订单ID:\x20'+_0x3186f8+',\x20用户ID:\x20'+_0x464155);try{const _0x483240=await _0x264761[_0x57e474(0x1bd)](_0x1e8020);common_1[_0x57e474(0x1e0)]['log'](_0x57e474(0x1b3),JSON[_0x57e474(0x1bc)](_0x483240,null,0x2));let _0x2a9863=_0x483240[_0x57e474(0x210)]||((_0x538806=_0x483240[_0x57e474(0x212)])===null||_0x538806===void 0x0?void 0x0:_0x538806['code_url']);return!_0x2a9863?console[_0x57e474(0x1ad)](_0x57e474(0x26b),JSON[_0x57e474(0x1bc)](_0x483240,null,0x2)):common_1['Logger'][_0x57e474(0x1ee)](_0x57e474(0x227)+_0x2a9863),{'url_qrcode':_0x2a9863,'isRedirect':![]};}catch(_0x3f994d){console['error']('微信Native支付过程中发生错误，错误信息:\x20'+_0x3f994d[_0x57e474(0x254)],_0x3f994d),console[_0x57e474(0x1ad)](_0x57e474(0x1db),_0x3f994d);throw new common_1[(_0x57e474(0x231))](_0x57e474(0x265),common_1[_0x57e474(0x1d6)]['BAD_REQUEST']);}}else{console[_0x57e474(0x1c9)]('支付请求使用了不支持的支付类型:\x20'+_0x2a8c9d);throw new common_1[(_0x57e474(0x231))](_0x57e474(0x20e),common_1[_0x57e474(0x1d6)][_0x57e474(0x242)]);}}async[_0x59ff84(0x26d)](_0x7317d9){const _0x8b4351=_0x59ff84,{payWeChatAppId:_0x4a9a75,payWeChatMchId:_0x59edde,payWeChatPublicKey:_0x22066f,payWeChatPrivateKey:_0xa13fb7,payWeChatNotifyUrl:_0x672a88}=await this['globalConfigService'][_0x8b4351(0x1ca)](['payWeChatAppId',_0x8b4351(0x213),_0x8b4351(0x204),_0x8b4351(0x22f)]),_0x214cbb=new this[(_0x8b4351(0x1e2))]({'appid':_0x4a9a75,'mchid':_0x59edde,'publicKey':_0x22066f,'privateKey':_0xa13fb7}),_0x323e49=await _0x214cbb[_0x8b4351(0x273)]({'out_trade_no':_0x7317d9});return _0x323e49;}['sign'](_0x21b097,_0x5019c0){const _0x1c466e=_0x59ff84,_0xc70c6d=Object[_0x1c466e(0x202)](_0x21b097)[_0x1c466e(0x269)]()[_0x1c466e(0x248)](_0x2258fe=>_0x2258fe+'='+_0x21b097[_0x2258fe])['join']('&')+_0x5019c0;return crypto['createHash']('md5')[_0x1c466e(0x247)](_0xc70c6d)[_0x1c466e(0x22c)](_0x1c466e(0x1a9));}['ltzfSign'](_0x403e6a,_0x80e2b9){const _0xd454f3=_0x59ff84,_0x498672=Object['keys'](_0x403e6a);_0x498672['sort']();const _0x1e5214=[];_0x498672[_0xd454f3(0x248)](_0x2f8772=>{const _0x12dc6b=_0xd454f3;_0x1e5214[_0x12dc6b(0x241)](_0x2f8772+'='+_0x403e6a[_0x2f8772]);}),_0x1e5214['push'](_0xd454f3(0x1e9)+_0x80e2b9);const _0x5ae41b=_0x1e5214['join']('&');return crypto['createHash'](_0xd454f3(0x260))[_0xd454f3(0x247)](_0x5ae41b)[_0xd454f3(0x22c)](_0xd454f3(0x1a9))[_0xd454f3(0x215)]();}async[_0x59ff84(0x24e)](_0x47a387,_0x49957a,_0x295ba3='wxpay'){const _0x1a300d=_0x59ff84,_0x5dc841=await this[_0x1a300d(0x23d)][_0x1a300d(0x1d3)]({'where':{'userId':_0x47a387,'orderId':_0x49957a}});if(!_0x5dc841)throw new common_1['HttpException']('订单不存在!',common_1['HttpStatus']['BAD_REQUEST']);const _0x4b36c9=await this[_0x1a300d(0x1b5)][_0x1a300d(0x1d3)]({'where':{'id':_0x5dc841[_0x1a300d(0x1c0)]}});if(!_0x4b36c9)throw new common_1[(_0x1a300d(0x231))](_0x1a300d(0x1d5),common_1[_0x1a300d(0x1d6)][_0x1a300d(0x242)]);const {payLtzfMchId:_0x4fa00,payLtzfSecret:_0x3763e8,payLtzfNotifyUrl:_0x35a6d0,payLtzfReturnUrl:_0x376928}=await this[_0x1a300d(0x1c8)][_0x1a300d(0x1ca)](['payLtzfMchId',_0x1a300d(0x276),_0x1a300d(0x1f3),_0x1a300d(0x261)]),_0x5ae2ce={};_0x5ae2ce['mch_id']=_0x4fa00,_0x5ae2ce[_0x1a300d(0x23e)]=(Date[_0x1a300d(0x1da)]()/0x3e8)['toFixed'](0x0),_0x5ae2ce[_0x1a300d(0x1a5)]=_0x49957a,_0x5ae2ce[_0x1a300d(0x1d8)]=_0x4b36c9[_0x1a300d(0x1b4)],_0x5ae2ce['total_fee']=_0x5dc841[_0x1a300d(0x1dc)],_0x5ae2ce['notify_url']=_0x35a6d0,_0x5ae2ce['sign']=this['ltzfSign'](_0x5ae2ce,_0x3763e8),_0x5ae2ce[_0x1a300d(0x23a)]=_0x1a300d(0x268),_0x5ae2ce[_0x1a300d(0x214)]=_0x376928;const _0xd9283=Object[_0x1a300d(0x202)](_0x5ae2ce)[_0x1a300d(0x248)](_0x3cb360=>encodeURIComponent(_0x3cb360)+'='+encodeURIComponent(_0x5ae2ce[_0x3cb360]))['join']('&'),_0x358ae9={'headers':{'Content-Type':_0x1a300d(0x1e5)}},_0x2f5d50=await axios_1['default'][_0x1a300d(0x1aa)](_0x1a300d(0x232),_0xd9283,_0x358ae9),{code:_0x52cac0,data:_0xa8fa9,msg:_0x2bd021}=_0x2f5d50['data'];if(_0x52cac0!=0x0)throw new common_1[(_0x1a300d(0x231))](_0x2bd021,common_1['HttpStatus'][_0x1a300d(0x242)]);const _0x39aa19=_0xa8fa9['QRcode_url'],_0x3da22d=_0xa8fa9[_0x1a300d(0x1f4)];return{'url_qrcode':_0x39aa19,'url':_0x3da22d};}async[_0x59ff84(0x257)](_0x315245){const _0x1014d3=_0x59ff84,{payLtzfMchId:_0x19928f,payLtzfSecret:_0x34c978}=await this[_0x1014d3(0x1c8)]['getConfigs']([_0x1014d3(0x239),_0x1014d3(0x276)]),_0x355963={};_0x355963[_0x1014d3(0x1ff)]=_0x19928f,_0x355963[_0x1014d3(0x23e)]=(Date[_0x1014d3(0x1da)]()/0x3e8)['toFixed'](0x0),_0x355963['out_trade_no']=_0x315245,_0x355963[_0x1014d3(0x1dd)]=this['ltzfSign'](_0x355963,_0x34c978);const _0xcbe872=Object['keys'](_0x355963)[_0x1014d3(0x248)](_0x36f305=>encodeURIComponent(_0x36f305)+'='+encodeURIComponent(_0x355963[_0x36f305]))[_0x1014d3(0x1c3)]('&'),_0x106674={'headers':{'Content-Type':'application/x-www-form-urlencoded'}},{data:{code:_0x3e60de,msg:_0x2b7057,data:_0x1f9b49}}=await axios_1[_0x1014d3(0x20b)][_0x1014d3(0x1aa)]('https://api.ltzf.cn/api/wxpay/get_pay_order',_0xcbe872,_0x106674);if(_0x3e60de!=0x0)throw new common_1[(_0x1014d3(0x231))](_0x2b7057+JSON[_0x1014d3(0x1bc)](_0x355963),common_1[_0x1014d3(0x1d6)][_0x1014d3(0x242)]);return _0x1f9b49;}async['notifyLtzf'](_0x221845){const _0x16e982=_0x59ff84,_0x302764=await this[_0x16e982(0x1c8)][_0x16e982(0x1ca)](['payLtzfSecret']),_0x4b3ace=_0x221845[_0x16e982(0x1dd)];delete _0x221845[_0x16e982(0x1dd)],delete _0x221845[_0x16e982(0x1b6)],delete _0x221845[_0x16e982(0x209)],delete _0x221845[_0x16e982(0x237)],delete _0x221845[_0x16e982(0x23a)],delete _0x221845['openid'];if(this[_0x16e982(0x1e6)](_0x221845,_0x302764)!=_0x4b3ace)return'FAIL';const _0xb00e8b=await this[_0x16e982(0x23d)][_0x16e982(0x1d3)]({'where':{'orderId':_0x221845['out_trade_no'],'status':0x0}});if(!_0xb00e8b)return'FAIL';await this[_0x16e982(0x1ae)][_0x16e982(0x23f)](_0xb00e8b);const _0x3db2c0=await this[_0x16e982(0x23d)]['update']({'orderId':_0x221845['out_trade_no']},{'status':0x1,'paydAt':new Date()});if(_0x3db2c0['affected']!=0x1)return _0x16e982(0x1cd);return _0x16e982(0x24c);}};PayService=__decorate([(0x0,common_1[_0x59ff84(0x1e1)])(),__param(0x0,(0x0,typeorm_1[_0x59ff84(0x274)])(cramiPackage_entity_1[_0x59ff84(0x1ec)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(order_entity_1[_0x59ff84(0x1df)])),__metadata(_0x59ff84(0x1d0),[typeorm_2['Repository'],typeorm_2['Repository'],userBalance_service_1['UserBalanceService'],globalConfig_service_1[_0x59ff84(0x228)],user_service_1[_0x59ff84(0x270)]])],PayService),exports[_0x59ff84(0x1f7)]=PayService;