'use strict';const _0x4c8dce=_0x5be5;(function(_0x1f397c,_0x74780b){const _0x2f4a9d=_0x5be5,_0x233487=_0x1f397c();while(!![]){try{const _0x129aa8=-parseInt(_0x2f4a9d(0x21b))/0x1*(-parseInt(_0x2f4a9d(0x15e))/0x2)+parseInt(_0x2f4a9d(0x1cd))/0x3+parseInt(_0x2f4a9d(0x20b))/0x4+parseInt(_0x2f4a9d(0x1c5))/0x5+-parseInt(_0x2f4a9d(0x1f4))/0x6*(-parseInt(_0x2f4a9d(0x186))/0x7)+-parseInt(_0x2f4a9d(0x1de))/0x8+-parseInt(_0x2f4a9d(0x1d1))/0x9;if(_0x129aa8===_0x74780b)break;else _0x233487['push'](_0x233487['shift']());}catch(_0x2014dc){_0x233487['push'](_0x233487['shift']());}}}(_0x24aa,0x7e9fb));var __decorate=this&&this[_0x4c8dce(0x202)]||function(_0x517ca7,_0x74dd85,_0x3482b3,_0x3ad73e){const _0x51e83b=_0x4c8dce;var _0x50a277=arguments[_0x51e83b(0x16e)],_0xe902ca=_0x50a277<0x3?_0x74dd85:_0x3ad73e===null?_0x3ad73e=Object[_0x51e83b(0x1e9)](_0x74dd85,_0x3482b3):_0x3ad73e,_0x37a95c;if(typeof Reflect===_0x51e83b(0x21e)&&typeof Reflect['decorate']==='function')_0xe902ca=Reflect[_0x51e83b(0x1ca)](_0x517ca7,_0x74dd85,_0x3482b3,_0x3ad73e);else{for(var _0x347328=_0x517ca7[_0x51e83b(0x16e)]-0x1;_0x347328>=0x0;_0x347328--)if(_0x37a95c=_0x517ca7[_0x347328])_0xe902ca=(_0x50a277<0x3?_0x37a95c(_0xe902ca):_0x50a277>0x3?_0x37a95c(_0x74dd85,_0x3482b3,_0xe902ca):_0x37a95c(_0x74dd85,_0x3482b3))||_0xe902ca;}return _0x50a277>0x3&&_0xe902ca&&Object['defineProperty'](_0x74dd85,_0x3482b3,_0xe902ca),_0xe902ca;},__metadata=this&&this[_0x4c8dce(0x17c)]||function(_0x57a8ee,_0x2a4834){const _0x2f9108=_0x4c8dce;if(typeof Reflect==='object'&&typeof Reflect[_0x2f9108(0x1ff)]===_0x2f9108(0x1db))return Reflect['metadata'](_0x57a8ee,_0x2a4834);},__param=this&&this['__param']||function(_0x535ba5,_0x587342){return function(_0x748ee8,_0x2579f0){_0x587342(_0x748ee8,_0x2579f0,_0x535ba5);};};Object[_0x4c8dce(0x1f9)](exports,_0x4c8dce(0x1ae),{'value':!![]}),exports['PayService']=void 0x0;const utils_1=require(_0x4c8dce(0x198)),common_1=require(_0x4c8dce(0x1e2)),typeorm_1=require(_0x4c8dce(0x1e3)),axios_1=require('axios'),crypto=require('crypto'),typeorm_2=require(_0x4c8dce(0x21f)),cramiPackage_entity_1=require(_0x4c8dce(0x1ac)),globalConfig_service_1=require('../globalConfig/globalConfig.service'),order_entity_1=require(_0x4c8dce(0x1cb)),user_service_1=require(_0x4c8dce(0x1ba)),userBalance_service_1=require(_0x4c8dce(0x177));let PayService=class PayService{constructor(_0x476061,_0x1369b9,_0x3ad594,_0x5e9387,_0x2eb33a){const _0x5054a=_0x4c8dce;this[_0x5054a(0x1ee)]=_0x476061,this[_0x5054a(0x21c)]=_0x1369b9,this[_0x5054a(0x1a8)]=_0x3ad594,this[_0x5054a(0x1d4)]=_0x5e9387,this['userService']=_0x2eb33a;}async[_0x4c8dce(0x1ed)](){const _0x38b31f=_0x4c8dce,_0x20902b=await(0x0,utils_1[_0x38b31f(0x19a)])(_0x38b31f(0x1d3));this[_0x38b31f(0x1be)]=(_0x20902b===null||_0x20902b===void 0x0?void 0x0:_0x20902b[_0x38b31f(0x172)])?_0x20902b[_0x38b31f(0x172)]:_0x20902b;}async[_0x4c8dce(0x16f)](_0xc65b46){const _0x501c8c=_0x4c8dce;if(_0xc65b46[_0x501c8c(0x1e0)]==_0x501c8c(0x15c))return this[_0x501c8c(0x20a)](_0xc65b46);if(_0xc65b46[_0x501c8c(0x17d)]==_0x501c8c(0x1ab))return this[_0x501c8c(0x1ec)](_0xc65b46);if(_0xc65b46['attach']==_0x501c8c(0x1f1))return this[_0x501c8c(0x1d6)](_0xc65b46);if(typeof _0xc65b46[_0x501c8c(0x188)]==_0x501c8c(0x21e))return this[_0x501c8c(0x209)](_0xc65b46);return this[_0x501c8c(0x1b4)](_0xc65b46);}async['pay'](_0xf49ca7,_0x14b58e,_0x4941fe=_0x4c8dce(0x1c2)){const _0x16eaf3=_0x4c8dce,_0x12e9ee=await this['orderEntity']['findOne']({'where':{'userId':_0xf49ca7,'orderId':_0x14b58e}});if(!_0x12e9ee)throw new common_1['HttpException'](_0x16eaf3(0x184),common_1[_0x16eaf3(0x1c8)][_0x16eaf3(0x200)]);const _0x292afa=await this[_0x16eaf3(0x1ee)]['findOne']({'where':{'id':_0x12e9ee[_0x16eaf3(0x222)]}});if(!_0x292afa)throw new common_1[(_0x16eaf3(0x1f0))]('套餐不存在!',common_1[_0x16eaf3(0x1c8)]['BAD_REQUEST']);common_1['Logger']['log'](_0x16eaf3(0x1a2),_0x12e9ee[_0x16eaf3(0x1a4)]);try{if(_0x12e9ee[_0x16eaf3(0x1a4)]==_0x16eaf3(0x1e5))return this['payWeChat'](_0xf49ca7,_0x14b58e,_0x4941fe);if(_0x12e9ee[_0x16eaf3(0x1a4)]=='epay')return this[_0x16eaf3(0x182)](_0xf49ca7,_0x14b58e,_0x4941fe);if(_0x12e9ee['payPlatform']==_0x16eaf3(0x1a5))return this['payMpay'](_0xf49ca7,_0x14b58e,_0x4941fe);if(_0x12e9ee['payPlatform']==_0x16eaf3(0x1ab))return this['payHupi'](_0xf49ca7,_0x14b58e,_0x4941fe);if(_0x12e9ee[_0x16eaf3(0x1a4)]==_0x16eaf3(0x1f1))return this[_0x16eaf3(0x1bd)](_0xf49ca7,_0x14b58e,_0x4941fe);}catch(_0x6536b8){common_1[_0x16eaf3(0x21a)][_0x16eaf3(0x1f5)](_0x16eaf3(0x1a6),_0x6536b8);throw new common_1[(_0x16eaf3(0x1f0))](_0x16eaf3(0x167),common_1[_0x16eaf3(0x1c8)]['BAD_REQUEST']);}}async['query'](_0x3ae4a0){const _0xac5625=_0x4c8dce,_0x1c0e7d=await this[_0xac5625(0x21c)]['findOne']({'where':{'orderId':_0x3ae4a0}});if(!_0x1c0e7d)throw new common_1[(_0xac5625(0x1f0))](_0xac5625(0x184),common_1[_0xac5625(0x1c8)][_0xac5625(0x200)]);return _0x1c0e7d;}async[_0x4c8dce(0x1ec)](_0x481b8a){const _0x1ebab0=_0x4c8dce,_0x2494bc=await this[_0x1ebab0(0x1d4)]['getConfigs'](['payHupiSecret']),_0x11de78=_0x481b8a[_0x1ebab0(0x176)];delete _0x481b8a['hash'];if(this[_0x1ebab0(0x169)](_0x481b8a,_0x2494bc)!=_0x11de78)return _0x1ebab0(0x189);const _0x561cb6=await this[_0x1ebab0(0x21c)]['findOne']({'where':{'orderId':_0x481b8a[_0x1ebab0(0x210)],'status':0x0}});if(!_0x561cb6)return _0x1ebab0(0x189);await this[_0x1ebab0(0x1a8)][_0x1ebab0(0x1dc)](_0x561cb6);const _0xba2e01=await this[_0x1ebab0(0x21c)][_0x1ebab0(0x228)]({'orderId':_0x481b8a[_0x1ebab0(0x210)]},{'status':0x1,'paydAt':new Date()});if(_0xba2e01['affected']!=0x1)return _0x1ebab0(0x189);return _0x1ebab0(0x1b9);}async[_0x4c8dce(0x1e6)](_0x5c208c,_0x2e9ca9,_0x31d50e=_0x4c8dce(0x1c2)){const _0x29b149=_0x4c8dce,_0x1d1160=await this[_0x29b149(0x21c)][_0x29b149(0x221)]({'where':{'userId':_0x5c208c,'orderId':_0x2e9ca9}});if(!_0x1d1160)throw new common_1[(_0x29b149(0x1f0))](_0x29b149(0x184),common_1[_0x29b149(0x1c8)]['BAD_REQUEST']);const _0x4f1859=await this['cramiPackageEntity'][_0x29b149(0x221)]({'where':{'id':_0x1d1160['goodsId']}});if(!_0x4f1859)throw new common_1[(_0x29b149(0x1f0))](_0x29b149(0x219),common_1[_0x29b149(0x1c8)][_0x29b149(0x200)]);const {payHupiAppId:_0x179c56,payHupiSecret:_0x4c6674,payHupiNotifyUrl:_0x5286ec,payHupiReturnUrl:_0x3b3b54,payHupiGatewayUrl:_0x8a19d4}=await this['globalConfigService']['getConfigs']([_0x29b149(0x17a),_0x29b149(0x1e7),'payHupiNotifyUrl','payHupiReturnUrl','payHupiGatewayUrl']),_0x2990fe={};_0x2990fe[_0x29b149(0x1dd)]=_0x29b149(0x1b6),_0x2990fe[_0x29b149(0x1c0)]=_0x179c56,_0x2990fe[_0x29b149(0x196)]=(Date[_0x29b149(0x1e4)]()/0x3e8)['toFixed'](0x0),_0x2990fe[_0x29b149(0x1f8)]=(0x0,utils_1[_0x29b149(0x163)])(0x20),_0x2990fe['trade_order_id']=_0x2e9ca9,_0x2990fe[_0x29b149(0x19c)]=_0x4f1859['name'],_0x2990fe[_0x29b149(0x1bc)]=_0x1d1160[_0x29b149(0x1b7)],_0x2990fe['notify_url']=_0x5286ec,_0x2990fe[_0x29b149(0x229)]=_0x3b3b54,_0x2990fe[_0x29b149(0x17d)]=_0x29b149(0x1ab),_0x2990fe[_0x29b149(0x176)]=this[_0x29b149(0x169)](_0x2990fe,_0x4c6674);const {data:{errcode:_0x2aeeed,errmsg:_0x3b7856,url_qrcode:_0x2a1e29,url:_0x1d5908}}=await axios_1[_0x29b149(0x172)][_0x29b149(0x226)](_0x8a19d4||_0x29b149(0x170),_0x2990fe);if(_0x2aeeed!=0x0)throw new common_1[(_0x29b149(0x1f0))](_0x3b7856,common_1['HttpStatus']['BAD_REQUEST']);return{'url_qrcode':_0x2a1e29,'url':_0x1d5908};}async['queryHupi'](_0x33f795){const _0x12ff18=_0x4c8dce,{payHupiAppId:_0x250f82,payHupiSecret:_0x2ab35d}=await this['globalConfigService']['getConfigs']([_0x12ff18(0x17a),_0x12ff18(0x1e7)]),_0x50fea8={};_0x50fea8[_0x12ff18(0x1dd)]=_0x12ff18(0x1b6),_0x50fea8[_0x12ff18(0x1c0)]=_0x250f82,_0x50fea8[_0x12ff18(0x196)]=(Date[_0x12ff18(0x1e4)]()/0x3e8)[_0x12ff18(0x216)](0x0),_0x50fea8[_0x12ff18(0x1f8)]=(0x0,utils_1[_0x12ff18(0x163)])(0x20),_0x50fea8[_0x12ff18(0x193)]=_0x33f795,_0x50fea8[_0x12ff18(0x176)]=this[_0x12ff18(0x169)](_0x50fea8,_0x2ab35d);const {data:{errcode:_0x5a3bde,errmsg:_0x38c3d0,data:_0x40ea97}}=await axios_1[_0x12ff18(0x172)][_0x12ff18(0x226)]('https://api.xunhupay.com/payment/query.html',_0x50fea8);if(_0x5a3bde!=0x0)throw new common_1[(_0x12ff18(0x1f0))](_0x38c3d0,common_1[_0x12ff18(0x1c8)][_0x12ff18(0x200)]);return _0x40ea97;}async[_0x4c8dce(0x20a)](_0x1792bc){const _0x4cc549=_0x4c8dce,_0x8bad9c=_0x1792bc[_0x4cc549(0x169)];delete _0x1792bc['sign'],delete _0x1792bc[_0x4cc549(0x208)];const _0x14710f=await this['globalConfigService']['getConfigs']([_0x4cc549(0x1af)]);if(this[_0x4cc549(0x169)](_0x1792bc,_0x14710f)!=_0x8bad9c)return _0x4cc549(0x189);common_1[_0x4cc549(0x21a)][_0x4cc549(0x1f5)](_0x4cc549(0x1d0));const _0x4d400f=await this[_0x4cc549(0x21c)][_0x4cc549(0x221)]({'where':{'orderId':_0x1792bc[_0x4cc549(0x192)],'status':0x0}});if(!_0x4d400f)return'failed';const _0x1c204d=_0x1792bc[_0x4cc549(0x213)]==_0x4cc549(0x225)?0x1:0x2,_0x3afb6c=await this[_0x4cc549(0x21c)][_0x4cc549(0x228)]({'orderId':_0x1792bc[_0x4cc549(0x192)]},{'status':_0x1c204d,'paydAt':new Date()});_0x1c204d===0x1&&await this[_0x4cc549(0x1a8)][_0x4cc549(0x1dc)](_0x4d400f);if(_0x3afb6c[_0x4cc549(0x1b3)]!=0x1)return _0x4cc549(0x189);return'success';}async['payEpay'](_0x6a27d3,_0x43cd43,_0x33f2ea='alipay'){const _0x4588a4=_0x4c8dce,_0x403ddb=await this[_0x4588a4(0x21c)]['findOne']({'where':{'userId':_0x6a27d3,'orderId':_0x43cd43}});if(!_0x403ddb)throw new common_1[(_0x4588a4(0x1f0))](_0x4588a4(0x184),common_1[_0x4588a4(0x1c8)][_0x4588a4(0x200)]);const _0x3f3d19=await this[_0x4588a4(0x1ee)][_0x4588a4(0x221)]({'where':{'id':_0x403ddb['goodsId']}});if(!_0x3f3d19)throw new common_1['HttpException'](_0x4588a4(0x219),common_1[_0x4588a4(0x1c8)][_0x4588a4(0x200)]);const {payEpayPid:_0x1f0ca2,payEpaySecret:_0x530991,payEpayNotifyUrl:_0x11372c,payEpayReturnUrl:_0x25b6b9,payEpayApiPayUrl:_0x929f55}=await this[_0x4588a4(0x1d4)]['getConfigs']([_0x4588a4(0x217),_0x4588a4(0x1af),'payEpayNotifyUrl',_0x4588a4(0x1b8),_0x4588a4(0x215)]);let _0x567771;_0x1f0ca2[_0x4588a4(0x16e)]<=0x10?_0x567771=Number(_0x1f0ca2):_0x567771=BigInt(_0x1f0ca2);const _0x4c24d5={};_0x4c24d5['pid']=_0x567771,_0x4c24d5[_0x4588a4(0x1df)]=_0x33f2ea,_0x4c24d5[_0x4588a4(0x192)]=_0x43cd43,_0x4c24d5['name']=_0x3f3d19[_0x4588a4(0x1f2)],_0x4c24d5[_0x4588a4(0x1cc)]=_0x403ddb[_0x4588a4(0x1b7)],_0x4c24d5[_0x4588a4(0x20f)]=_0x4588a4(0x1eb),_0x4c24d5[_0x4588a4(0x185)]='pc',_0x4c24d5[_0x4588a4(0x1b0)]=_0x11372c,_0x4c24d5[_0x4588a4(0x229)]=_0x25b6b9,_0x4c24d5[_0x4588a4(0x1e0)]=_0x4588a4(0x15c),_0x4c24d5['sign']=this['sign'](_0x4c24d5,_0x530991),_0x4c24d5[_0x4588a4(0x208)]=_0x4588a4(0x1e1);const _0xabc222=new URLSearchParams(_0x4c24d5)[_0x4588a4(0x168)](),_0x7ee4b9=_0x929f55+'?'+_0xabc222;if(_0x929f55[_0x4588a4(0x1b5)](_0x4588a4(0x171)))return{'url_qrcode':null,'redirectUrl':_0x7ee4b9,'channel':_0x33f2ea,'isRedirect':!![]};else{const _0xa6e641={'headers':{'Content-Type':_0x4588a4(0x20d)}},_0x575876=await axios_1['default'][_0x4588a4(0x226)](_0x929f55,_0x4c24d5,_0xa6e641);common_1['Logger'][_0x4588a4(0x1f5)](_0x4588a4(0x1a3),_0x575876[_0x4588a4(0x1c9)]);const {data:{code:_0x4ec89c,msg:_0x3cb805,qrcode:_0x56252b}}=_0x575876;if(_0x4ec89c!=0x1)throw new common_1[(_0x4588a4(0x1f0))](_0x3cb805,common_1['HttpStatus'][_0x4588a4(0x200)]);return{'url_qrcode':_0x56252b,'redirectUrl':null,'channel':_0x33f2ea,'isRedirect':![]};}}async[_0x4c8dce(0x19f)](_0x57e6f6){const _0x43992e=_0x4c8dce,{payEpayPid:_0x23aa89,payEpaySecret:_0x4cb693,payEpayApiQueryUrl:_0x94b14f}=await this[_0x43992e(0x1d4)][_0x43992e(0x175)]([_0x43992e(0x217),'payEpaySecret','payEpayApiQueryUrl']),_0x4dfa83={};_0x4dfa83[_0x43992e(0x212)]=_0x43992e(0x205),_0x4dfa83[_0x43992e(0x192)]=_0x57e6f6,_0x4dfa83['pid']=_0x23aa89,_0x4dfa83['key']=_0x4cb693;const {data:{code:_0x2459c8,msg:_0x538eee,data:_0x2ecec2}}=await axios_1[_0x43992e(0x172)]['get'](_0x94b14f,{'params':_0x4dfa83});if(_0x2459c8!=0x1)throw new common_1['HttpException'](_0x538eee,common_1[_0x43992e(0x1c8)][_0x43992e(0x200)]);return _0x2ecec2;}async['notifyMpay'](_0x43857a){const _0x4636ea=_0x4c8dce,_0x1b3216=_0x43857a[_0x4636ea(0x169)];delete _0x43857a[_0x4636ea(0x169)],delete _0x43857a[_0x4636ea(0x208)];const _0x5423fb=await this['globalConfigService'][_0x4636ea(0x175)](['payMpaySecret']);common_1[_0x4636ea(0x21a)][_0x4636ea(0x1f5)](_0x4636ea(0x1d9));if(this['sign'](_0x43857a,_0x5423fb)!=_0x1b3216)return _0x4636ea(0x189);common_1[_0x4636ea(0x21a)][_0x4636ea(0x1f5)](_0x4636ea(0x1d0));const _0xc3bd0=await this[_0x4636ea(0x21c)][_0x4636ea(0x221)]({'where':{'orderId':_0x43857a[_0x4636ea(0x192)],'status':0x0}});if(!_0xc3bd0)return _0x4636ea(0x189);const _0x4ae424=_0x43857a[_0x4636ea(0x213)]=='TRADE_SUCCESS'?0x1:0x2;common_1[_0x4636ea(0x21a)][_0x4636ea(0x1f5)](_0x4636ea(0x166),_0x4ae424);const _0xc91bea=await this[_0x4636ea(0x21c)][_0x4636ea(0x228)]({'orderId':_0x43857a[_0x4636ea(0x192)]},{'status':_0x4ae424,'paydAt':new Date()});_0x4ae424===0x1&&await this[_0x4636ea(0x1a8)][_0x4636ea(0x1dc)](_0xc3bd0);if(_0xc91bea['affected']!=0x1)return _0x4636ea(0x189);return'success';}async['payMpay'](_0x2ac777,_0x483bac,_0x395623=_0x4c8dce(0x1c2)){const _0x19dc75=_0x4c8dce,_0x2cc5a0=await this['orderEntity'][_0x19dc75(0x221)]({'where':{'userId':_0x2ac777,'orderId':_0x483bac}});if(!_0x2cc5a0)throw new common_1[(_0x19dc75(0x1f0))](_0x19dc75(0x184),common_1['HttpStatus'][_0x19dc75(0x200)]);const _0x19478b=await this[_0x19dc75(0x1ee)]['findOne']({'where':{'id':_0x2cc5a0[_0x19dc75(0x222)]}});if(!_0x19478b)throw new common_1['HttpException'](_0x19dc75(0x219),common_1[_0x19dc75(0x1c8)][_0x19dc75(0x200)]);const {payMpayPid:_0x47b341,payMpaySecret:_0x5e8f0d,payMpayNotifyUrl:_0x3bf450,payMpayReturnUrl:_0x59d460,payMpayApiPayUrl:_0xa54995}=await this[_0x19dc75(0x1d4)][_0x19dc75(0x175)]([_0x19dc75(0x1a9),_0x19dc75(0x199),_0x19dc75(0x18e),_0x19dc75(0x1d8),_0x19dc75(0x180)]),_0x8d30c8={};_0x8d30c8[_0x19dc75(0x160)]=Number(_0x47b341),_0x8d30c8['type']=_0x395623,_0x8d30c8['out_trade_no']=_0x483bac,_0x8d30c8[_0x19dc75(0x1f2)]=_0x19478b[_0x19dc75(0x1f2)],_0x8d30c8[_0x19dc75(0x1cc)]=_0x2cc5a0['total'],_0x8d30c8[_0x19dc75(0x1b0)]=_0x3bf450,_0x8d30c8[_0x19dc75(0x229)]=_0x59d460,_0x8d30c8[_0x19dc75(0x169)]=this['sign'](_0x8d30c8,_0x5e8f0d),_0x8d30c8['sign_type']='MD5';const _0x45d367=new URLSearchParams(_0x8d30c8)[_0x19dc75(0x168)](),_0x2adaa7=_0xa54995+'?'+_0x45d367;return{'url_qrcode':null,'redirectUrl':_0x2adaa7,'channel':_0x395623,'isRedirect':!![]};const _0x477e40=await axios_1[_0x19dc75(0x172)][_0x19dc75(0x1a1)](_0xa54995,{'params':_0x8d30c8});}async[_0x4c8dce(0x22a)](_0x558e3d){const _0x5a47a1=_0x4c8dce,{payMpayApiQueryUrl:_0x9ff34}=await this[_0x5a47a1(0x1d4)]['getConfigs']([_0x5a47a1(0x1a9),_0x5a47a1(0x199),'payMpayApiQueryUrl']),_0x169336={};_0x169336[_0x5a47a1(0x1df)]=0x2,_0x169336[_0x5a47a1(0x16d)]=_0x558e3d;const {data:{code:_0x5f1aac,msg:_0x2adbbe,data:_0x291d78}}=await axios_1['default'][_0x5a47a1(0x1a1)](_0x9ff34,{'params':_0x169336});if(_0x5f1aac!=0x1)throw new common_1['HttpException'](_0x2adbbe,common_1['HttpStatus'][_0x5a47a1(0x200)]);return _0x291d78;}async[_0x4c8dce(0x209)](_0x5bd3c8){const _0x3c300f=_0x4c8dce;common_1[_0x3c300f(0x21a)][_0x3c300f(0x1f5)](_0x3c300f(0x22b),_0x5bd3c8);const {payWeChatAppId:_0x44cf1f,payWeChatMchId:_0x53d662,payWeChatSecret:_0x2d891a,payWeChatPublicKey:_0x434e85,payWeChatPrivateKey:_0x4855a3}=await this[_0x3c300f(0x1d4)][_0x3c300f(0x175)]([_0x3c300f(0x1fa),'payWeChatMchId',_0x3c300f(0x1c7),_0x3c300f(0x1ce),_0x3c300f(0x164)]),_0x53fee6=new this[(_0x3c300f(0x1be))]({'appid':_0x44cf1f,'mchid':_0x53d662,'publicKey':_0x434e85,'privateKey':_0x4855a3});try{if(_0x5bd3c8[_0x3c300f(0x21d)]==_0x3c300f(0x19e)){const {ciphertext:_0x4cd9b2,associated_data:_0x6cf361,nonce:_0x1e26f8}=_0x5bd3c8['resource'],_0x439bf3=_0x53fee6[_0x3c300f(0x18a)](_0x4cd9b2,_0x6cf361,_0x1e26f8,_0x2d891a),_0x506bf8=await this[_0x3c300f(0x21c)][_0x3c300f(0x221)]({'where':{'orderId':_0x439bf3['out_trade_no'],'status':0x0}});if(!_0x506bf8)return _0x3c300f(0x189);const _0x35a49c=_0x439bf3['trade_state']==_0x3c300f(0x179)?0x1:0x2,_0x13c19e=await this['orderEntity'][_0x3c300f(0x228)]({'orderId':_0x439bf3['out_trade_no']},{'status':_0x35a49c,'paydAt':new Date()});_0x35a49c===0x1&&await this['userBalanceService']['addBalanceToOrder'](_0x506bf8);if(_0x13c19e[_0x3c300f(0x1b3)]!=0x1)return _0x3c300f(0x189);}return _0x3c300f(0x1b9);}catch(_0x457eb3){return common_1[_0x3c300f(0x21a)]['log'](_0x3c300f(0x17e),_0x457eb3),common_1['Logger']['log']('支付通知验证失败:\x20',_0x457eb3),_0x3c300f(0x189);}}async[_0x4c8dce(0x16a)](_0x5f4984,_0x52e91d,_0x3a56fc=_0x4c8dce(0x1d5)){const _0x33515b=_0x4c8dce;var _0x49e582,_0x379087,_0x2e20ed,_0x420887,_0x4339e8,_0x15c80c,_0x757f58;common_1[_0x33515b(0x21a)][_0x33515b(0x1f5)](_0x33515b(0x16c),_0x3a56fc);const _0x3758eb=await this['orderEntity'][_0x33515b(0x221)]({'where':{'userId':_0x5f4984,'orderId':_0x52e91d}});if(!_0x3758eb)throw new common_1['HttpException'](_0x33515b(0x184),common_1['HttpStatus'][_0x33515b(0x200)]);const _0x17fa0b=await this[_0x33515b(0x1ee)][_0x33515b(0x221)]({'where':{'id':_0x3758eb[_0x33515b(0x222)]}});if(!_0x17fa0b)throw new common_1[(_0x33515b(0x1f0))](_0x33515b(0x219),common_1[_0x33515b(0x1c8)][_0x33515b(0x200)]);const {payWeChatAppId:_0x21f6fb,payWeChatMchId:_0x573d04,payWeChatPublicKey:_0x4665db,payWeChatPrivateKey:_0x17822b,payWeChatNotifyUrl:_0x1ee5b5}=await this[_0x33515b(0x1d4)]['getConfigs']([_0x33515b(0x1fa),_0x33515b(0x195),_0x33515b(0x1ce),_0x33515b(0x164),_0x33515b(0x1f7)]),_0x19b615=new this[(_0x33515b(0x1be))]({'appid':_0x21f6fb,'mchid':_0x573d04,'publicKey':_0x4665db,'privateKey':_0x17822b}),_0x1ec95f={'appid':_0x21f6fb,'mchid':_0x573d04,'description':_0x17fa0b[_0x33515b(0x1f2)],'out_trade_no':_0x52e91d,'notify_url':_0x1ee5b5,'amount':{'total':Math['round'](_0x3758eb[_0x33515b(0x1b7)]*0x64)}};common_1[_0x33515b(0x21a)][_0x33515b(0x1f5)](_0x33515b(0x19b),_0x1ec95f);if(_0x3a56fc==_0x33515b(0x17b)){common_1[_0x33515b(0x21a)][_0x33515b(0x1f5)](_0x33515b(0x16b)+_0x5f4984+_0x33515b(0x18c)+_0x52e91d);const _0x131b32=await this['userService'][_0x33515b(0x165)](_0x5f4984);common_1[_0x33515b(0x21a)][_0x33515b(0x1f5)](_0x33515b(0x220)+_0x131b32),_0x1ec95f[_0x33515b(0x1fd)]={'openid':_0x131b32},common_1['Logger'][_0x33515b(0x1f5)](_0x33515b(0x18b),JSON[_0x33515b(0x20c)](_0x1ec95f,null,0x2));try{const _0x298c49=await _0x19b615[_0x33515b(0x206)](_0x1ec95f),_0x450e03=_0x298c49['data']?_0x298c49[_0x33515b(0x1c9)]:_0x298c49;return common_1[_0x33515b(0x21a)][_0x33515b(0x1f5)](_0x33515b(0x15d),JSON[_0x33515b(0x20c)](_0x450e03,null,0x2)),{'status':_0x298c49[_0x33515b(0x204)]||_0x33515b(0x190),'appId':_0x450e03[_0x33515b(0x15f)]||((_0x49e582=_0x450e03[_0x33515b(0x1c9)])===null||_0x49e582===void 0x0?void 0x0:_0x49e582[_0x33515b(0x15f)]),'timeStamp':_0x450e03[_0x33515b(0x218)]||((_0x379087=_0x450e03[_0x33515b(0x1c9)])===null||_0x379087===void 0x0?void 0x0:_0x379087[_0x33515b(0x218)]),'nonceStr':_0x450e03['nonceStr']||((_0x2e20ed=_0x450e03[_0x33515b(0x1c9)])===null||_0x2e20ed===void 0x0?void 0x0:_0x2e20ed[_0x33515b(0x1fe)]),'package':_0x450e03[_0x33515b(0x162)]||((_0x420887=_0x450e03[_0x33515b(0x1c9)])===null||_0x420887===void 0x0?void 0x0:_0x420887['package']),'signType':_0x450e03[_0x33515b(0x1c3)]||((_0x4339e8=_0x450e03[_0x33515b(0x1c9)])===null||_0x4339e8===void 0x0?void 0x0:_0x4339e8[_0x33515b(0x1c3)]),'paySign':_0x450e03['paySign']||((_0x15c80c=_0x450e03['data'])===null||_0x15c80c===void 0x0?void 0x0:_0x15c80c['paySign'])};}catch(_0x198e59){console[_0x33515b(0x1b2)]('[WeChat\x20Pay\x20JSAPI]\x20支付请求过程中发生错误:\x20'+_0x198e59[_0x33515b(0x1b1)],_0x198e59),console[_0x33515b(0x1b2)](_0x33515b(0x173),_0x198e59);throw new common_1[(_0x33515b(0x1f0))](_0x33515b(0x201),common_1[_0x33515b(0x1c8)]['BAD_REQUEST']);}}if(_0x3a56fc==_0x33515b(0x1d5)){common_1['Logger'][_0x33515b(0x1f5)](_0x33515b(0x1ef)+_0x52e91d+_0x33515b(0x20e)+_0x5f4984);try{const _0x58e513=await _0x19b615[_0x33515b(0x211)](_0x1ec95f);common_1[_0x33515b(0x21a)][_0x33515b(0x1f5)]('微信Native支付响应数据:\x20',JSON[_0x33515b(0x20c)](_0x58e513,null,0x2));let _0x37bd10=_0x58e513[_0x33515b(0x1a7)]||((_0x757f58=_0x58e513[_0x33515b(0x1c9)])===null||_0x757f58===void 0x0?void 0x0:_0x757f58[_0x33515b(0x1a7)]);return!_0x37bd10?console[_0x33515b(0x1b2)](_0x33515b(0x227),JSON['stringify'](_0x58e513,null,0x2)):common_1[_0x33515b(0x21a)][_0x33515b(0x1f5)]('微信Native支付请求成功，code_url:\x20'+_0x37bd10),{'url_qrcode':_0x37bd10,'isRedirect':![]};}catch(_0x5299c2){console[_0x33515b(0x1b2)]('微信Native支付过程中发生错误，错误信息:\x20'+_0x5299c2[_0x33515b(0x1b1)],_0x5299c2),console['error']('完整的错误对象：',_0x5299c2);throw new common_1[(_0x33515b(0x1f0))]('微信Native支付失败',common_1[_0x33515b(0x1c8)][_0x33515b(0x200)]);}}else{console['warn']('支付请求使用了不支持的支付类型:\x20'+_0x3a56fc);throw new common_1[(_0x33515b(0x1f0))](_0x33515b(0x1ea),common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x4c8dce(0x174)](_0x15ae35){const _0x8028ba=_0x4c8dce,{payWeChatAppId:_0x36c122,payWeChatMchId:_0x4b31ed,payWeChatPublicKey:_0xd65ce3,payWeChatPrivateKey:_0x5c69ef,payWeChatNotifyUrl:_0x2efc55}=await this[_0x8028ba(0x1d4)][_0x8028ba(0x175)]([_0x8028ba(0x1fa),'payWeChatMchId','payWeChatPublicKey',_0x8028ba(0x164)]),_0x1bce8f=new this['WxPay']({'appid':_0x36c122,'mchid':_0x4b31ed,'publicKey':_0xd65ce3,'privateKey':_0x5c69ef}),_0x140d85=await _0x1bce8f[_0x8028ba(0x194)]({'out_trade_no':_0x15ae35});return _0x140d85;}[_0x4c8dce(0x169)](_0x3860da,_0x212cbb){const _0x579076=_0x4c8dce,_0x54f500=Object['keys'](_0x3860da)[_0x579076(0x1c4)]()[_0x579076(0x1fc)](_0x528f6c=>_0x528f6c+'='+_0x3860da[_0x528f6c])[_0x579076(0x191)]('&')+_0x212cbb;return crypto[_0x579076(0x223)](_0x579076(0x187))[_0x579076(0x228)](_0x54f500)[_0x579076(0x1d7)](_0x579076(0x19d));}[_0x4c8dce(0x1c1)](_0x322dd9,_0x590b6d){const _0x3d9054=_0x4c8dce,_0x4603c4=Object['keys'](_0x322dd9);_0x4603c4['sort']();const _0x5f518c=[];_0x4603c4['map'](_0x2eb804=>{const _0x2ea5d3=_0x5be5;_0x5f518c[_0x2ea5d3(0x161)](_0x2eb804+'='+_0x322dd9[_0x2eb804]);}),_0x5f518c['push'](_0x3d9054(0x1bb)+_0x590b6d);const _0x455ce8=_0x5f518c[_0x3d9054(0x191)]('&');return crypto['createHash']('md5')['update'](_0x455ce8)['digest']('hex')['toUpperCase']();}async[_0x4c8dce(0x1bd)](_0x50e37b,_0x2b7b9c,_0x431f2d='wxpay'){const _0x5eb4fb=_0x4c8dce,_0x2343ab=await this[_0x5eb4fb(0x21c)][_0x5eb4fb(0x221)]({'where':{'userId':_0x50e37b,'orderId':_0x2b7b9c}});if(!_0x2343ab)throw new common_1['HttpException']('订单不存在!',common_1['HttpStatus']['BAD_REQUEST']);const _0x192bb5=await this[_0x5eb4fb(0x1ee)]['findOne']({'where':{'id':_0x2343ab[_0x5eb4fb(0x222)]}});if(!_0x192bb5)throw new common_1[(_0x5eb4fb(0x1f0))](_0x5eb4fb(0x219),common_1['HttpStatus'][_0x5eb4fb(0x200)]);const {payLtzfMchId:_0x1237f8,payLtzfSecret:_0x4c0748,payLtzfNotifyUrl:_0x5095b3,payLtzfReturnUrl:_0x34dba4}=await this['globalConfigService'][_0x5eb4fb(0x175)]([_0x5eb4fb(0x1da),_0x5eb4fb(0x197),_0x5eb4fb(0x183),_0x5eb4fb(0x203)]),_0x4dfbca={};_0x4dfbca[_0x5eb4fb(0x18f)]=_0x1237f8,_0x4dfbca['timestamp']=(Date[_0x5eb4fb(0x1e4)]()/0x3e8)[_0x5eb4fb(0x216)](0x0),_0x4dfbca[_0x5eb4fb(0x192)]=_0x2b7b9c,_0x4dfbca['body']=_0x192bb5[_0x5eb4fb(0x1f2)],_0x4dfbca[_0x5eb4fb(0x1bc)]=_0x2343ab[_0x5eb4fb(0x1b7)],_0x4dfbca[_0x5eb4fb(0x1b0)]=_0x5095b3,_0x4dfbca[_0x5eb4fb(0x169)]=this[_0x5eb4fb(0x1c1)](_0x4dfbca,_0x4c0748),_0x4dfbca[_0x5eb4fb(0x17d)]=_0x5eb4fb(0x1f1),_0x4dfbca[_0x5eb4fb(0x229)]=_0x34dba4;const _0x52f1f0=Object['keys'](_0x4dfbca)[_0x5eb4fb(0x1fc)](_0x25b0bf=>encodeURIComponent(_0x25b0bf)+'='+encodeURIComponent(_0x4dfbca[_0x25b0bf]))['join']('&'),_0x568615={'headers':{'Content-Type':_0x5eb4fb(0x20d)}},_0x1c8ef6=await axios_1[_0x5eb4fb(0x172)][_0x5eb4fb(0x226)](_0x5eb4fb(0x207),_0x52f1f0,_0x568615),{code:_0x387fc6,data:_0x31c926,msg:_0x5b131c}=_0x1c8ef6[_0x5eb4fb(0x1c9)];if(_0x387fc6!=0x0)throw new common_1[(_0x5eb4fb(0x1f0))](_0x5b131c,common_1[_0x5eb4fb(0x1c8)][_0x5eb4fb(0x200)]);const _0xc92668=_0x31c926[_0x5eb4fb(0x1a0)],_0x3448f7=_0x31c926[_0x5eb4fb(0x1ad)];return{'url_qrcode':_0xc92668,'url':_0x3448f7};}async[_0x4c8dce(0x1e8)](_0x2b94c0){const _0x2a6198=_0x4c8dce,{payLtzfMchId:_0x53b628,payLtzfSecret:_0x3a1cc0}=await this[_0x2a6198(0x1d4)]['getConfigs']([_0x2a6198(0x1da),_0x2a6198(0x197)]),_0x12378a={};_0x12378a['mch_id']=_0x53b628,_0x12378a[_0x2a6198(0x1aa)]=(Date[_0x2a6198(0x1e4)]()/0x3e8)[_0x2a6198(0x216)](0x0),_0x12378a[_0x2a6198(0x192)]=_0x2b94c0,_0x12378a['sign']=this[_0x2a6198(0x1c1)](_0x12378a,_0x3a1cc0);const _0x66e69c=Object['keys'](_0x12378a)[_0x2a6198(0x1fc)](_0x312270=>encodeURIComponent(_0x312270)+'='+encodeURIComponent(_0x12378a[_0x312270]))[_0x2a6198(0x191)]('&'),_0x331298={'headers':{'Content-Type':_0x2a6198(0x20d)}},{data:{code:_0x2bb938,msg:_0x28c6d1,data:_0x41d57d}}=await axios_1['default'][_0x2a6198(0x226)](_0x2a6198(0x18d),_0x66e69c,_0x331298);if(_0x2bb938!=0x0)throw new common_1[(_0x2a6198(0x1f0))](_0x28c6d1+JSON[_0x2a6198(0x20c)](_0x12378a),common_1[_0x2a6198(0x1c8)][_0x2a6198(0x200)]);return _0x41d57d;}async[_0x4c8dce(0x1d6)](_0x97a239){const _0x49c2d6=_0x4c8dce,_0x509c9f=await this[_0x49c2d6(0x1d4)][_0x49c2d6(0x175)]([_0x49c2d6(0x197)]),_0x211cea=_0x97a239[_0x49c2d6(0x169)];delete _0x97a239[_0x49c2d6(0x169)],delete _0x97a239[_0x49c2d6(0x1c6)],delete _0x97a239[_0x49c2d6(0x1fb)],delete _0x97a239['success_time'],delete _0x97a239['attach'],delete _0x97a239[_0x49c2d6(0x1bf)];if(this[_0x49c2d6(0x1c1)](_0x97a239,_0x509c9f)!=_0x211cea)return _0x49c2d6(0x1f3);const _0x268b66=await this[_0x49c2d6(0x21c)][_0x49c2d6(0x221)]({'where':{'orderId':_0x97a239['out_trade_no'],'status':0x0}});if(!_0x268b66)return _0x49c2d6(0x1f3);await this[_0x49c2d6(0x1a8)][_0x49c2d6(0x1dc)](_0x268b66);const _0x2815f3=await this['orderEntity'][_0x49c2d6(0x228)]({'orderId':_0x97a239[_0x49c2d6(0x192)]},{'status':0x1,'paydAt':new Date()});if(_0x2815f3[_0x49c2d6(0x1b3)]!=0x1)return _0x49c2d6(0x1f3);return'SUCCESS';}};function _0x5be5(_0x43283d,_0x5525a5){const _0x24aa78=_0x24aa();return _0x5be5=function(_0x5be511,_0x15eba0){_0x5be511=_0x5be511-0x15c;let _0x4d7435=_0x24aa78[_0x5be511];return _0x4d7435;},_0x5be5(_0x43283d,_0x5525a5);}PayService=__decorate([(0x0,common_1[_0x4c8dce(0x224)])(),__param(0x0,(0x0,typeorm_1[_0x4c8dce(0x178)])(cramiPackage_entity_1[_0x4c8dce(0x214)])),__param(0x1,(0x0,typeorm_1[_0x4c8dce(0x178)])(order_entity_1['OrderEntity'])),__metadata(_0x4c8dce(0x1cf),[typeorm_2['Repository'],typeorm_2[_0x4c8dce(0x181)],userBalance_service_1[_0x4c8dce(0x17f)],globalConfig_service_1[_0x4c8dce(0x1d2)],user_service_1[_0x4c8dce(0x1f6)]])],PayService),exports['PayService']=PayService;function _0x24aa(){const _0x3ebc54=['[WeChat\x20Pay\x20JSAPI]\x20用户OpenID:\x20','findOne','goodsId','createHash','Injectable','TRADE_SUCCESS','post','微信Native支付请求成功，但未返回code_url，响应数据:\x20','update','return_url','queryMpay','微信支付通知params:\x20','epay','[WeChat\x20Pay\x20JSAPI]\x20支付请求成功，返回结果:\x20','3134CjBixX','appId','pid','push','package','createRandomNonceStr','payWeChatPrivateKey','getOpenIdByUserId','status:\x20','支付请求失败!','toString','sign','payWeChat','[WeChat\x20Pay\x20JSAPI]\x20开始JSAPI支付流程，用户ID:\x20','payType:\x20','order_no','length','notify','https://api.xunhupay.com/payment/do.html','submit.php','default','[WeChat\x20Pay\x20JSAPI]\x20完整的错误对象：','queryWeChat','getConfigs','hash','../userBalance/userBalance.service','InjectRepository','SUCCESS','payHupiAppId','jsapi','__metadata','attach','error:\x20','UserBalanceService','payMpayApiPayUrl','Repository','payEpay','payLtzfNotifyUrl','订单不存在!','device','350jeuShq','md5','resource','failed','decipher_gcm','[WeChat\x20Pay\x20JSAPI]\x20发送支付请求参数:\x20',',\x20订单ID:\x20','https://api.ltzf.cn/api/wxpay/get_pay_order','payMpayNotifyUrl','mch_id','unknown','join','out_trade_no','out_trade_order','query','payWeChatMchId','time','payLtzfSecret','../../common/utils','payMpaySecret','importDynamic','wechat-pay:\x20','title','hex','TRANSACTION.SUCCESS','queryEpay','QRcode_url','get','本次支付类型:\x20','epay\x20--->\x20res:\x20','payPlatform','mpay','支付请求失败:\x20','code_url','userBalanceService','payMpayPid','timestamp','hupi','../crami/cramiPackage.entity','order_url','__esModule','payEpaySecret','notify_url','message','error','affected','notifyMpay','includes','1.1','total','payEpayReturnUrl','success','../user/user.service','key=','total_fee','payLtzf','WxPay','openid','appid','ltzfSign','wxpay','signType','sort','800050FnQBKi','pay_channel','payWeChatSecret','HttpStatus','data','decorate','../order/order.entity','money','384216UTIOJP','payWeChatPublicKey','design:paramtypes','校验签名通过','10289916MIKFoK','GlobalConfigService','wechatpay-node-v3','globalConfigService','native','notifyLtzf','digest','payMpayReturnUrl','校验签名','payLtzfMchId','function','addBalanceToOrder','version','4665480rStJvV','type','param','MD5','@nestjs/common','@nestjs/typeorm','now','wechat','payHupi','payHupiSecret','queryLtzf','getOwnPropertyDescriptor','unsupported\x20pay\x20type','192.168.1.100','notifyHupi','onModuleInit','cramiPackageEntity','开始进行微信Native支付流程，订单ID:\x20','HttpException','ltzf','name','FAIL','121566PprVjt','log','UserService','payWeChatNotifyUrl','nonce_str','defineProperty','payWeChatAppId','trade_type','map','payer','nonceStr','metadata','BAD_REQUEST','JSAPI支付失败','__decorate','payLtzfReturnUrl','status','order','transactions_jsapi','https://api.ltzf.cn/api/wxpay/jsapi_convenient','sign_type','notifyWeChat','notifyEpay','3456444COUqkp','stringify','application/x-www-form-urlencoded',',\x20用户ID:\x20','clientip','trade_order_id','transactions_native','act','trade_status','CramiPackageEntity','payEpayApiPayUrl','toFixed','payEpayPid','timeStamp','套餐不存在!','Logger','51WhAuos','orderEntity','event_type','object','typeorm'];_0x24aa=function(){return _0x3ebc54;};return _0x24aa();}