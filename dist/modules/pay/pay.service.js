'use strict';function _0xe3ca(){const _0x7451da=['pid','error:\x20',',\x20订单ID:\x20','208ghRJxr','key','payType:\x20','default','getConfigs','SUCCESS','notifyEpay','trade_state','log','key=','notifyWeChat','支付请求使用了不支持的支付类型:\x20','payWeChatPublicKey','order_url','BAD_REQUEST','hupi','join','epay\x20--->\x20res:\x20','resource','application/x-www-form-urlencoded','237376GGqDiP','userService','notifyLtzf','importDynamic','微信Native支付响应数据:\x20','status','__param','return_url','本次支付类型:\x20','now','ltzf','money','1.1','校验签名','payWeChat','attach','success','payPlatform','TRANSACTION.SUCCESS','design:paramtypes','notify_url','Repository','submit.php','data','payEpayReturnUrl','2474458XAMIgn','套餐不存在!','payMpayApiQueryUrl','48204wvEUZo','6qRVRNI','onModuleInit','openid','wechat-pay:\x20','trade_order_id','sort','signType','HttpStatus','decorate','alipay','payWeChatAppId','queryMpay','[WeChat\x20Pay\x20JSAPI]\x20支付请求过程中发生错误:\x20','trade_type','https://api.ltzf.cn/api/wxpay/jsapi_convenient','payMpayNotifyUrl','object','payWeChatPrivateKey','../crami/cramiPackage.entity','defineProperty','sign_type','toUpperCase','notifyHupi','../../common/utils','https://api.xunhupay.com/payment/do.html','md5','time','transactions_native','getOpenIdByUserId','payer','nonce_str','warn','out_trade_order','timeStamp','sign','userBalanceService','length','digest','payLtzf','push','1077464yfSCKA','notify','query','globalConfigService','get','success_time','[WeChat\x20Pay\x20JSAPI]\x20发送支付请求参数:\x20','error','WxPay','UserService','payMpaySecret','typeorm','payHupiSecret','round','开始进行微信Native支付流程，订单ID:\x20','payHupiAppId','function','addBalanceToOrder','package','update','payMpayPid','act','payHupi','total_fee','@nestjs/typeorm','createRandomNonceStr','unknown','goodsId','status:\x20','payWeChatNotifyUrl','notifyMpay','trade_status','支付通知验证失败:\x20','name','微信Native支付请求成功，code_url:\x20','unsupported\x20pay\x20type','mpay','queryEpay','237376QlFkjG','map','post','out_trade_no','code_url','QRcode_url','stringify','../user/user.service','hex','timestamp','https://api.xunhupay.com/payment/query.html','payEpayPid','../order/order.entity','orderEntity','192.168.1.100','__metadata','includes','[WeChat\x20Pay\x20JSAPI]\x20完整的错误对象：','param','toFixed','body','toString','nonceStr','payEpayApiPayUrl','title','GlobalConfigService','payWeChatMchId','cramiPackageEntity','TRADE_SUCCESS','failed','订单不存在!','pay','微信Native支付失败','payEpaySecret','支付请求失败!','order','PayService','payLtzfReturnUrl','InjectRepository','affected','paySign','HttpException','version','total','createHash','payEpayApiQueryUrl','微信支付通知params:\x20','payLtzfMchId','appId','wxpay','payMpay','UserBalanceService','787212pPVfrC','Logger','FAIL','keys','hash','MD5','appid','../globalConfig/globalConfig.service','transactions_jsapi','906460dAmtsH','payEpay','findOne','校验签名通过','pay_channel','ltzfSign','payLtzfSecret','mch_id','event_type','type','epay','__esModule','CramiPackageEntity'];_0xe3ca=function(){return _0x7451da;};return _0xe3ca();}const _0x1f62fc=_0x580c;function _0x580c(_0x35cb15,_0xb223bf){const _0xe3cac8=_0xe3ca();return _0x580c=function(_0x580c95,_0xc678e8){_0x580c95=_0x580c95-0x1df;let _0x294d79=_0xe3cac8[_0x580c95];return _0x294d79;},_0x580c(_0x35cb15,_0xb223bf);}(function(_0x46ef39,_0x3f9478){const _0x59cf96=_0x580c,_0x3738c1=_0x46ef39();while(!![]){try{const _0x16de49=-parseInt(_0x59cf96(0x1f0))/0x1+parseInt(_0x59cf96(0x251))/0x2+parseInt(_0x59cf96(0x224))/0x3+-parseInt(_0x59cf96(0x296))/0x4+-parseInt(_0x59cf96(0x22d))/0x5+parseInt(_0x59cf96(0x26e))/0x6*(parseInt(_0x59cf96(0x26a))/0x7)+-parseInt(_0x59cf96(0x23d))/0x8*(-parseInt(_0x59cf96(0x26d))/0x9);if(_0x16de49===_0x3f9478)break;else _0x3738c1['push'](_0x3738c1['shift']());}catch(_0x3e4804){_0x3738c1['push'](_0x3738c1['shift']());}}}(_0xe3ca,0x2d5d0));var __decorate=this&&this['__decorate']||function(_0x2bcde2,_0x59a33a,_0x14819f,_0x53a05c){const _0x2344b9=_0x580c;var _0x3e24a6=arguments['length'],_0x29dd08=_0x3e24a6<0x3?_0x59a33a:_0x53a05c===null?_0x53a05c=Object['getOwnPropertyDescriptor'](_0x59a33a,_0x14819f):_0x53a05c,_0x171be1;if(typeof Reflect==='object'&&typeof Reflect[_0x2344b9(0x276)]===_0x2344b9(0x2a6))_0x29dd08=Reflect['decorate'](_0x2bcde2,_0x59a33a,_0x14819f,_0x53a05c);else{for(var _0xb1e1f5=_0x2bcde2['length']-0x1;_0xb1e1f5>=0x0;_0xb1e1f5--)if(_0x171be1=_0x2bcde2[_0xb1e1f5])_0x29dd08=(_0x3e24a6<0x3?_0x171be1(_0x29dd08):_0x3e24a6>0x3?_0x171be1(_0x59a33a,_0x14819f,_0x29dd08):_0x171be1(_0x59a33a,_0x14819f))||_0x29dd08;}return _0x3e24a6>0x3&&_0x29dd08&&Object[_0x2344b9(0x281)](_0x59a33a,_0x14819f,_0x29dd08),_0x29dd08;},__metadata=this&&this[_0x1f62fc(0x1ff)]||function(_0x3eb629,_0x1adf5d){const _0x1bb8d7=_0x1f62fc;if(typeof Reflect===_0x1bb8d7(0x27e)&&typeof Reflect['metadata']==='function')return Reflect['metadata'](_0x3eb629,_0x1adf5d);},__param=this&&this[_0x1f62fc(0x257)]||function(_0x53eb76,_0x44e82d){return function(_0x2e94c5,_0x3aca7d){_0x44e82d(_0x2e94c5,_0x3aca7d,_0x53eb76);};};Object[_0x1f62fc(0x281)](exports,_0x1f62fc(0x238),{'value':!![]}),exports[_0x1f62fc(0x214)]=void 0x0;const utils_1=require(_0x1f62fc(0x285)),common_1=require('@nestjs/common'),typeorm_1=require(_0x1f62fc(0x1e2)),axios_1=require('axios'),crypto=require('crypto'),typeorm_2=require(_0x1f62fc(0x2a1)),cramiPackage_entity_1=require(_0x1f62fc(0x280)),globalConfig_service_1=require(_0x1f62fc(0x22b)),order_entity_1=require(_0x1f62fc(0x1fc)),user_service_1=require(_0x1f62fc(0x1f7)),userBalance_service_1=require('../userBalance/userBalance.service');let PayService=class PayService{constructor(_0x44201f,_0x1b401b,_0x3381dc,_0x566112,_0x26614d){const _0x425fd1=_0x1f62fc;this[_0x425fd1(0x20b)]=_0x44201f,this['orderEntity']=_0x1b401b,this[_0x425fd1(0x291)]=_0x3381dc,this[_0x425fd1(0x299)]=_0x566112,this[_0x425fd1(0x252)]=_0x26614d;}async[_0x1f62fc(0x26f)](){const _0x4bdcf7=_0x1f62fc,_0x1b02e2=await(0x0,utils_1[_0x4bdcf7(0x254)])('wechatpay-node-v3');this[_0x4bdcf7(0x29e)]=(_0x1b02e2===null||_0x1b02e2===void 0x0?void 0x0:_0x1b02e2[_0x4bdcf7(0x240)])?_0x1b02e2[_0x4bdcf7(0x240)]:_0x1b02e2;}async[_0x1f62fc(0x297)](_0x368a04){const _0x4c2d50=_0x1f62fc;if(_0x368a04[_0x4c2d50(0x202)]==_0x4c2d50(0x237))return this[_0x4c2d50(0x243)](_0x368a04);if(_0x368a04[_0x4c2d50(0x260)]==_0x4c2d50(0x24c))return this[_0x4c2d50(0x284)](_0x368a04);if(_0x368a04[_0x4c2d50(0x260)]==_0x4c2d50(0x25b))return this[_0x4c2d50(0x253)](_0x368a04);if(typeof _0x368a04[_0x4c2d50(0x24f)]=='object')return this[_0x4c2d50(0x247)](_0x368a04);return this[_0x4c2d50(0x1e8)](_0x368a04);}async[_0x1f62fc(0x20f)](_0x6d5f69,_0xec6235,_0x428fcc=_0x1f62fc(0x221)){const _0x20fbe4=_0x1f62fc,_0x2d624c=await this[_0x20fbe4(0x1fd)][_0x20fbe4(0x22f)]({'where':{'userId':_0x6d5f69,'orderId':_0xec6235}});if(!_0x2d624c)throw new common_1['HttpException'](_0x20fbe4(0x20e),common_1[_0x20fbe4(0x275)][_0x20fbe4(0x24b)]);const _0x2418f9=await this[_0x20fbe4(0x20b)]['findOne']({'where':{'id':_0x2d624c[_0x20fbe4(0x1e5)]}});if(!_0x2418f9)throw new common_1[(_0x20fbe4(0x219))](_0x20fbe4(0x26b),common_1[_0x20fbe4(0x275)][_0x20fbe4(0x24b)]);common_1['Logger'][_0x20fbe4(0x245)](_0x20fbe4(0x259),_0x2d624c['payPlatform']);try{if(_0x2d624c[_0x20fbe4(0x262)]=='wechat')return this['payWeChat'](_0x6d5f69,_0xec6235,_0x428fcc);if(_0x2d624c[_0x20fbe4(0x262)]==_0x20fbe4(0x237))return this[_0x20fbe4(0x22e)](_0x6d5f69,_0xec6235,_0x428fcc);if(_0x2d624c['payPlatform']==_0x20fbe4(0x1ee))return this[_0x20fbe4(0x222)](_0x6d5f69,_0xec6235,_0x428fcc);if(_0x2d624c[_0x20fbe4(0x262)]==_0x20fbe4(0x24c))return this['payHupi'](_0x6d5f69,_0xec6235,_0x428fcc);if(_0x2d624c[_0x20fbe4(0x262)]==_0x20fbe4(0x25b))return this[_0x20fbe4(0x294)](_0x6d5f69,_0xec6235,_0x428fcc);}catch(_0x1f9d4c){common_1[_0x20fbe4(0x225)]['log']('支付请求失败:\x20',_0x1f9d4c);throw new common_1[(_0x20fbe4(0x219))](_0x20fbe4(0x212),common_1['HttpStatus'][_0x20fbe4(0x24b)]);}}async['query'](_0x120bf8){const _0x4d8b92=_0x1f62fc,_0x363acf=await this[_0x4d8b92(0x1fd)][_0x4d8b92(0x22f)]({'where':{'orderId':_0x120bf8}});if(!_0x363acf)throw new common_1[(_0x4d8b92(0x219))](_0x4d8b92(0x20e),common_1['HttpStatus'][_0x4d8b92(0x24b)]);return _0x363acf;}async[_0x1f62fc(0x284)](_0x1ccf55){const _0x3356b9=_0x1f62fc,_0x3a155f=await this[_0x3356b9(0x299)]['getConfigs']([_0x3356b9(0x2a2)]),_0x1ef07e=_0x1ccf55['hash'];delete _0x1ccf55['hash'];if(this[_0x3356b9(0x290)](_0x1ccf55,_0x3a155f)!=_0x1ef07e)return _0x3356b9(0x20d);const _0x23d816=await this[_0x3356b9(0x1fd)][_0x3356b9(0x22f)]({'where':{'orderId':_0x1ccf55[_0x3356b9(0x272)],'status':0x0}});if(!_0x23d816)return _0x3356b9(0x20d);await this['userBalanceService'][_0x3356b9(0x2a7)](_0x23d816);const _0x1d923b=await this[_0x3356b9(0x1fd)][_0x3356b9(0x2a9)]({'orderId':_0x1ccf55[_0x3356b9(0x272)]},{'status':0x1,'paydAt':new Date()});if(_0x1d923b['affected']!=0x1)return _0x3356b9(0x20d);return'success';}async[_0x1f62fc(0x1e0)](_0x1c2c02,_0x113526,_0x36c795=_0x1f62fc(0x221)){const _0x4d917d=_0x1f62fc,_0x3568a2=await this[_0x4d917d(0x1fd)]['findOne']({'where':{'userId':_0x1c2c02,'orderId':_0x113526}});if(!_0x3568a2)throw new common_1[(_0x4d917d(0x219))](_0x4d917d(0x20e),common_1['HttpStatus'][_0x4d917d(0x24b)]);const _0x4edd5e=await this[_0x4d917d(0x20b)]['findOne']({'where':{'id':_0x3568a2[_0x4d917d(0x1e5)]}});if(!_0x4edd5e)throw new common_1[(_0x4d917d(0x219))]('套餐不存在!',common_1[_0x4d917d(0x275)][_0x4d917d(0x24b)]);const {payHupiAppId:_0x3367fd,payHupiSecret:_0x10f145,payHupiNotifyUrl:_0x30917e,payHupiReturnUrl:_0x18b555,payHupiGatewayUrl:_0x5e8fce}=await this[_0x4d917d(0x299)][_0x4d917d(0x241)]([_0x4d917d(0x2a5),_0x4d917d(0x2a2),'payHupiNotifyUrl','payHupiReturnUrl','payHupiGatewayUrl']),_0x4d20d7={};_0x4d20d7[_0x4d917d(0x21a)]=_0x4d917d(0x25d),_0x4d20d7[_0x4d917d(0x22a)]=_0x3367fd,_0x4d20d7[_0x4d917d(0x288)]=(Date[_0x4d917d(0x25a)]()/0x3e8)[_0x4d917d(0x203)](0x0),_0x4d20d7[_0x4d917d(0x28c)]=(0x0,utils_1['createRandomNonceStr'])(0x20),_0x4d20d7[_0x4d917d(0x272)]=_0x113526,_0x4d20d7[_0x4d917d(0x208)]=_0x4edd5e[_0x4d917d(0x1eb)],_0x4d20d7[_0x4d917d(0x1e1)]=_0x3568a2[_0x4d917d(0x21b)],_0x4d20d7[_0x4d917d(0x265)]=_0x30917e,_0x4d20d7[_0x4d917d(0x258)]=_0x18b555,_0x4d20d7[_0x4d917d(0x260)]='hupi',_0x4d20d7[_0x4d917d(0x228)]=this[_0x4d917d(0x290)](_0x4d20d7,_0x10f145);const {data:{errcode:_0xdeb8d7,errmsg:_0x162396,url_qrcode:_0x1a5530,url:_0x1b6ddd}}=await axios_1[_0x4d917d(0x240)][_0x4d917d(0x1f2)](_0x5e8fce||_0x4d917d(0x286),_0x4d20d7);if(_0xdeb8d7!=0x0)throw new common_1[(_0x4d917d(0x219))](_0x162396,common_1[_0x4d917d(0x275)][_0x4d917d(0x24b)]);return{'url_qrcode':_0x1a5530,'url':_0x1b6ddd};}async['queryHupi'](_0x3ca2fb){const _0x50ee3c=_0x1f62fc,{payHupiAppId:_0x260421,payHupiSecret:_0x5c1369}=await this[_0x50ee3c(0x299)][_0x50ee3c(0x241)](['payHupiAppId',_0x50ee3c(0x2a2)]),_0x25dfa4={};_0x25dfa4[_0x50ee3c(0x21a)]=_0x50ee3c(0x25d),_0x25dfa4[_0x50ee3c(0x22a)]=_0x260421,_0x25dfa4[_0x50ee3c(0x288)]=(Date[_0x50ee3c(0x25a)]()/0x3e8)[_0x50ee3c(0x203)](0x0),_0x25dfa4[_0x50ee3c(0x28c)]=(0x0,utils_1[_0x50ee3c(0x1e3)])(0x20),_0x25dfa4[_0x50ee3c(0x28e)]=_0x3ca2fb,_0x25dfa4[_0x50ee3c(0x228)]=this[_0x50ee3c(0x290)](_0x25dfa4,_0x5c1369);const {data:{errcode:_0x3147e3,errmsg:_0x36f8a5,data:_0x11d624}}=await axios_1[_0x50ee3c(0x240)][_0x50ee3c(0x1f2)](_0x50ee3c(0x1fa),_0x25dfa4);if(_0x3147e3!=0x0)throw new common_1[(_0x50ee3c(0x219))](_0x36f8a5,common_1[_0x50ee3c(0x275)][_0x50ee3c(0x24b)]);return _0x11d624;}async[_0x1f62fc(0x243)](_0x165e2a){const _0x4a742f=_0x1f62fc,_0x563db2=_0x165e2a['sign'];delete _0x165e2a[_0x4a742f(0x290)],delete _0x165e2a[_0x4a742f(0x282)];const _0x49e3a5=await this['globalConfigService'][_0x4a742f(0x241)]([_0x4a742f(0x211)]);if(this['sign'](_0x165e2a,_0x49e3a5)!=_0x563db2)return _0x4a742f(0x20d);common_1[_0x4a742f(0x225)][_0x4a742f(0x245)](_0x4a742f(0x230));const _0x51d499=await this[_0x4a742f(0x1fd)][_0x4a742f(0x22f)]({'where':{'orderId':_0x165e2a['out_trade_no'],'status':0x0}});if(!_0x51d499)return _0x4a742f(0x20d);const _0x45a5db=_0x165e2a[_0x4a742f(0x1e9)]=='TRADE_SUCCESS'?0x1:0x2,_0x54485e=await this[_0x4a742f(0x1fd)][_0x4a742f(0x2a9)]({'orderId':_0x165e2a[_0x4a742f(0x1f3)]},{'status':_0x45a5db,'paydAt':new Date()});_0x45a5db===0x1&&await this[_0x4a742f(0x291)][_0x4a742f(0x2a7)](_0x51d499);if(_0x54485e['affected']!=0x1)return _0x4a742f(0x20d);return'success';}async[_0x1f62fc(0x22e)](_0x3c33c4,_0x383958,_0x5ccfa8=_0x1f62fc(0x277)){const _0x120f88=_0x1f62fc,_0x472a16=await this[_0x120f88(0x1fd)][_0x120f88(0x22f)]({'where':{'userId':_0x3c33c4,'orderId':_0x383958}});if(!_0x472a16)throw new common_1[(_0x120f88(0x219))](_0x120f88(0x20e),common_1[_0x120f88(0x275)]['BAD_REQUEST']);const _0x36195f=await this[_0x120f88(0x20b)][_0x120f88(0x22f)]({'where':{'id':_0x472a16[_0x120f88(0x1e5)]}});if(!_0x36195f)throw new common_1['HttpException'](_0x120f88(0x26b),common_1[_0x120f88(0x275)]['BAD_REQUEST']);const {payEpayPid:_0x47f4d9,payEpaySecret:_0x370761,payEpayNotifyUrl:_0x3f27be,payEpayReturnUrl:_0x144fdb,payEpayApiPayUrl:_0x4545ce}=await this['globalConfigService'][_0x120f88(0x241)]([_0x120f88(0x1fb),_0x120f88(0x211),'payEpayNotifyUrl',_0x120f88(0x269),_0x120f88(0x207)]);let _0x358947;_0x47f4d9[_0x120f88(0x292)]<=0x10?_0x358947=Number(_0x47f4d9):_0x358947=BigInt(_0x47f4d9);const _0xf145ad={};_0xf145ad[_0x120f88(0x23a)]=_0x358947,_0xf145ad['type']=_0x5ccfa8,_0xf145ad[_0x120f88(0x1f3)]=_0x383958,_0xf145ad[_0x120f88(0x1eb)]=_0x36195f[_0x120f88(0x1eb)],_0xf145ad[_0x120f88(0x25c)]=_0x472a16[_0x120f88(0x21b)],_0xf145ad['clientip']=_0x120f88(0x1fe),_0xf145ad['device']='pc',_0xf145ad[_0x120f88(0x265)]=_0x3f27be,_0xf145ad[_0x120f88(0x258)]=_0x144fdb,_0xf145ad[_0x120f88(0x202)]=_0x120f88(0x237),_0xf145ad[_0x120f88(0x290)]=this[_0x120f88(0x290)](_0xf145ad,_0x370761),_0xf145ad[_0x120f88(0x282)]=_0x120f88(0x229);const _0x13b1dc=new URLSearchParams(_0xf145ad)['toString'](),_0x1767d0=_0x4545ce+'?'+_0x13b1dc;if(_0x4545ce[_0x120f88(0x200)](_0x120f88(0x267)))return{'url_qrcode':null,'redirectUrl':_0x1767d0,'channel':_0x5ccfa8,'isRedirect':!![]};else{const _0x58fa72={'headers':{'Content-Type':_0x120f88(0x250)}},_0x4d0943=await axios_1[_0x120f88(0x240)][_0x120f88(0x1f2)](_0x4545ce,_0xf145ad,_0x58fa72);common_1['Logger'][_0x120f88(0x245)](_0x120f88(0x24e),_0x4d0943[_0x120f88(0x268)]);const {data:{code:_0x487f92,msg:_0x29821b,qrcode:_0x41f22c}}=_0x4d0943;if(_0x487f92!=0x1)throw new common_1[(_0x120f88(0x219))](_0x29821b,common_1['HttpStatus'][_0x120f88(0x24b)]);return{'url_qrcode':_0x41f22c,'redirectUrl':null,'channel':_0x5ccfa8,'isRedirect':![]};}}async[_0x1f62fc(0x1ef)](_0x1192f9){const _0x359ef8=_0x1f62fc,{payEpayPid:_0x2a79a5,payEpaySecret:_0x1c5e1a,payEpayApiQueryUrl:_0x50bb44}=await this[_0x359ef8(0x299)][_0x359ef8(0x241)]([_0x359ef8(0x1fb),'payEpaySecret',_0x359ef8(0x21d)]),_0x2ff200={};_0x2ff200[_0x359ef8(0x1df)]=_0x359ef8(0x213),_0x2ff200['out_trade_no']=_0x1192f9,_0x2ff200[_0x359ef8(0x23a)]=_0x2a79a5,_0x2ff200[_0x359ef8(0x23e)]=_0x1c5e1a;const {data:{code:_0x12f420,msg:_0x341d99,data:_0x592320}}=await axios_1[_0x359ef8(0x240)][_0x359ef8(0x29a)](_0x50bb44,{'params':_0x2ff200});if(_0x12f420!=0x1)throw new common_1[(_0x359ef8(0x219))](_0x341d99,common_1['HttpStatus']['BAD_REQUEST']);return _0x592320;}async[_0x1f62fc(0x1e8)](_0x484fe9){const _0x4a4fe1=_0x1f62fc,_0x2de5cc=_0x484fe9[_0x4a4fe1(0x290)];delete _0x484fe9['sign'],delete _0x484fe9[_0x4a4fe1(0x282)];const _0x304ea3=await this['globalConfigService']['getConfigs']([_0x4a4fe1(0x2a0)]);common_1[_0x4a4fe1(0x225)]['log'](_0x4a4fe1(0x25e));if(this[_0x4a4fe1(0x290)](_0x484fe9,_0x304ea3)!=_0x2de5cc)return'failed';common_1[_0x4a4fe1(0x225)][_0x4a4fe1(0x245)](_0x4a4fe1(0x230));const _0x1a3099=await this['orderEntity'][_0x4a4fe1(0x22f)]({'where':{'orderId':_0x484fe9[_0x4a4fe1(0x1f3)],'status':0x0}});if(!_0x1a3099)return _0x4a4fe1(0x20d);const _0x45bcb3=_0x484fe9[_0x4a4fe1(0x1e9)]==_0x4a4fe1(0x20c)?0x1:0x2;common_1[_0x4a4fe1(0x225)][_0x4a4fe1(0x245)](_0x4a4fe1(0x1e6),_0x45bcb3);const _0xc06828=await this[_0x4a4fe1(0x1fd)]['update']({'orderId':_0x484fe9[_0x4a4fe1(0x1f3)]},{'status':_0x45bcb3,'paydAt':new Date()});_0x45bcb3===0x1&&await this[_0x4a4fe1(0x291)][_0x4a4fe1(0x2a7)](_0x1a3099);if(_0xc06828['affected']!=0x1)return'failed';return _0x4a4fe1(0x261);}async[_0x1f62fc(0x222)](_0x40688c,_0x54b28f,_0x4cbd27=_0x1f62fc(0x221)){const _0x5bb4f3=_0x1f62fc,_0x47a10f=await this[_0x5bb4f3(0x1fd)][_0x5bb4f3(0x22f)]({'where':{'userId':_0x40688c,'orderId':_0x54b28f}});if(!_0x47a10f)throw new common_1[(_0x5bb4f3(0x219))](_0x5bb4f3(0x20e),common_1[_0x5bb4f3(0x275)][_0x5bb4f3(0x24b)]);const _0x4defb7=await this[_0x5bb4f3(0x20b)]['findOne']({'where':{'id':_0x47a10f['goodsId']}});if(!_0x4defb7)throw new common_1[(_0x5bb4f3(0x219))](_0x5bb4f3(0x26b),common_1['HttpStatus'][_0x5bb4f3(0x24b)]);const {payMpayPid:_0x303bfd,payMpaySecret:_0x3998e5,payMpayNotifyUrl:_0x3abe76,payMpayReturnUrl:_0x897572,payMpayApiPayUrl:_0x4bfbdd}=await this[_0x5bb4f3(0x299)]['getConfigs'](['payMpayPid','payMpaySecret',_0x5bb4f3(0x27d),'payMpayReturnUrl','payMpayApiPayUrl']),_0x1b5b28={};_0x1b5b28[_0x5bb4f3(0x23a)]=Number(_0x303bfd),_0x1b5b28[_0x5bb4f3(0x236)]=_0x4cbd27,_0x1b5b28['out_trade_no']=_0x54b28f,_0x1b5b28[_0x5bb4f3(0x1eb)]=_0x4defb7['name'],_0x1b5b28['money']=_0x47a10f[_0x5bb4f3(0x21b)],_0x1b5b28[_0x5bb4f3(0x265)]=_0x3abe76,_0x1b5b28[_0x5bb4f3(0x258)]=_0x897572,_0x1b5b28[_0x5bb4f3(0x290)]=this[_0x5bb4f3(0x290)](_0x1b5b28,_0x3998e5),_0x1b5b28['sign_type']=_0x5bb4f3(0x229);const _0x941770=new URLSearchParams(_0x1b5b28)[_0x5bb4f3(0x205)](),_0x17cfde=_0x4bfbdd+'?'+_0x941770;return{'url_qrcode':null,'redirectUrl':_0x17cfde,'channel':_0x4cbd27,'isRedirect':!![]};const _0x44a8ca=await axios_1[_0x5bb4f3(0x240)][_0x5bb4f3(0x29a)](_0x4bfbdd,{'params':_0x1b5b28});}async[_0x1f62fc(0x279)](_0x5b135f){const _0x45ae72=_0x1f62fc,{payMpayApiQueryUrl:_0x15bc42}=await this['globalConfigService'][_0x45ae72(0x241)]([_0x45ae72(0x2aa),'payMpaySecret',_0x45ae72(0x26c)]),_0x2c05b4={};_0x2c05b4[_0x45ae72(0x236)]=0x2,_0x2c05b4['order_no']=_0x5b135f;const {data:{code:_0x545eae,msg:_0x30864e,data:_0xbcc4c9}}=await axios_1['default'][_0x45ae72(0x29a)](_0x15bc42,{'params':_0x2c05b4});if(_0x545eae!=0x1)throw new common_1[(_0x45ae72(0x219))](_0x30864e,common_1[_0x45ae72(0x275)]['BAD_REQUEST']);return _0xbcc4c9;}async[_0x1f62fc(0x247)](_0x220e68){const _0x1cd6e0=_0x1f62fc;common_1[_0x1cd6e0(0x225)][_0x1cd6e0(0x245)](_0x1cd6e0(0x21e),_0x220e68);const {payWeChatAppId:_0x11ffee,payWeChatMchId:_0x2fd049,payWeChatSecret:_0x5d85c5,payWeChatPublicKey:_0x11697d,payWeChatPrivateKey:_0x2ece24}=await this['globalConfigService'][_0x1cd6e0(0x241)]([_0x1cd6e0(0x278),_0x1cd6e0(0x20a),'payWeChatSecret',_0x1cd6e0(0x249),_0x1cd6e0(0x27f)]),_0xe1f0f3=new this['WxPay']({'appid':_0x11ffee,'mchid':_0x2fd049,'publicKey':_0x11697d,'privateKey':_0x2ece24});try{if(_0x220e68[_0x1cd6e0(0x235)]==_0x1cd6e0(0x263)){const {ciphertext:_0x5bc090,associated_data:_0x3e5261,nonce:_0x190143}=_0x220e68[_0x1cd6e0(0x24f)],_0x5bf24b=_0xe1f0f3['decipher_gcm'](_0x5bc090,_0x3e5261,_0x190143,_0x5d85c5),_0xe3235e=await this['orderEntity'][_0x1cd6e0(0x22f)]({'where':{'orderId':_0x5bf24b['out_trade_no'],'status':0x0}});if(!_0xe3235e)return _0x1cd6e0(0x20d);const _0x4d513e=_0x5bf24b[_0x1cd6e0(0x244)]==_0x1cd6e0(0x242)?0x1:0x2,_0x22aa6c=await this[_0x1cd6e0(0x1fd)][_0x1cd6e0(0x2a9)]({'orderId':_0x5bf24b[_0x1cd6e0(0x1f3)]},{'status':_0x4d513e,'paydAt':new Date()});_0x4d513e===0x1&&await this['userBalanceService'][_0x1cd6e0(0x2a7)](_0xe3235e);if(_0x22aa6c[_0x1cd6e0(0x217)]!=0x1)return _0x1cd6e0(0x20d);}return _0x1cd6e0(0x261);}catch(_0x1d7e4d){return common_1['Logger'][_0x1cd6e0(0x245)](_0x1cd6e0(0x23b),_0x1d7e4d),common_1['Logger'][_0x1cd6e0(0x245)](_0x1cd6e0(0x1ea),_0x1d7e4d),_0x1cd6e0(0x20d);}}async[_0x1f62fc(0x25f)](_0x4e5b40,_0x6cb374,_0x32d365='native'){const _0x519e86=_0x1f62fc;var _0x545261,_0x49c301,_0x4d0bb8,_0x38c90b,_0x2de66f,_0x2c8745,_0xb17a1a;common_1['Logger'][_0x519e86(0x245)](_0x519e86(0x23f),_0x32d365);const _0x33fad6=await this[_0x519e86(0x1fd)][_0x519e86(0x22f)]({'where':{'userId':_0x4e5b40,'orderId':_0x6cb374}});if(!_0x33fad6)throw new common_1[(_0x519e86(0x219))](_0x519e86(0x20e),common_1[_0x519e86(0x275)]['BAD_REQUEST']);const _0x172b14=await this['cramiPackageEntity'][_0x519e86(0x22f)]({'where':{'id':_0x33fad6[_0x519e86(0x1e5)]}});if(!_0x172b14)throw new common_1['HttpException'](_0x519e86(0x26b),common_1[_0x519e86(0x275)]['BAD_REQUEST']);const {payWeChatAppId:_0x5104a3,payWeChatMchId:_0x57ae3b,payWeChatPublicKey:_0x218858,payWeChatPrivateKey:_0x1d247b,payWeChatNotifyUrl:_0x4ba53e}=await this[_0x519e86(0x299)][_0x519e86(0x241)]([_0x519e86(0x278),_0x519e86(0x20a),_0x519e86(0x249),_0x519e86(0x27f),_0x519e86(0x1e7)]),_0x36f4b3=new this[(_0x519e86(0x29e))]({'appid':_0x5104a3,'mchid':_0x57ae3b,'publicKey':_0x218858,'privateKey':_0x1d247b}),_0x7dae10={'appid':_0x5104a3,'mchid':_0x57ae3b,'description':_0x172b14[_0x519e86(0x1eb)],'out_trade_no':_0x6cb374,'notify_url':_0x4ba53e,'amount':{'total':Math[_0x519e86(0x2a3)](_0x33fad6['total']*0x64)}};common_1[_0x519e86(0x225)][_0x519e86(0x245)](_0x519e86(0x271),_0x7dae10);if(_0x32d365=='jsapi'){common_1[_0x519e86(0x225)]['log']('[WeChat\x20Pay\x20JSAPI]\x20开始JSAPI支付流程，用户ID:\x20'+_0x4e5b40+_0x519e86(0x23c)+_0x6cb374);const _0x45a423=await this['userService'][_0x519e86(0x28a)](_0x4e5b40);common_1['Logger']['log']('[WeChat\x20Pay\x20JSAPI]\x20用户OpenID:\x20'+_0x45a423),_0x7dae10[_0x519e86(0x28b)]={'openid':_0x45a423},common_1['Logger'][_0x519e86(0x245)](_0x519e86(0x29c),JSON[_0x519e86(0x1f6)](_0x7dae10,null,0x2));try{const _0x156c4a=await _0x36f4b3[_0x519e86(0x22c)](_0x7dae10),_0xe54344=_0x156c4a[_0x519e86(0x268)]?_0x156c4a[_0x519e86(0x268)]:_0x156c4a;return common_1[_0x519e86(0x225)]['log']('[WeChat\x20Pay\x20JSAPI]\x20支付请求成功，返回结果:\x20',JSON[_0x519e86(0x1f6)](_0xe54344,null,0x2)),{'status':_0x156c4a[_0x519e86(0x256)]||_0x519e86(0x1e4),'appId':_0xe54344[_0x519e86(0x220)]||((_0x545261=_0xe54344[_0x519e86(0x268)])===null||_0x545261===void 0x0?void 0x0:_0x545261[_0x519e86(0x220)]),'timeStamp':_0xe54344[_0x519e86(0x28f)]||((_0x49c301=_0xe54344['data'])===null||_0x49c301===void 0x0?void 0x0:_0x49c301['timeStamp']),'nonceStr':_0xe54344[_0x519e86(0x206)]||((_0x4d0bb8=_0xe54344[_0x519e86(0x268)])===null||_0x4d0bb8===void 0x0?void 0x0:_0x4d0bb8[_0x519e86(0x206)]),'package':_0xe54344[_0x519e86(0x2a8)]||((_0x38c90b=_0xe54344[_0x519e86(0x268)])===null||_0x38c90b===void 0x0?void 0x0:_0x38c90b[_0x519e86(0x2a8)]),'signType':_0xe54344[_0x519e86(0x274)]||((_0x2de66f=_0xe54344[_0x519e86(0x268)])===null||_0x2de66f===void 0x0?void 0x0:_0x2de66f['signType']),'paySign':_0xe54344[_0x519e86(0x218)]||((_0x2c8745=_0xe54344[_0x519e86(0x268)])===null||_0x2c8745===void 0x0?void 0x0:_0x2c8745[_0x519e86(0x218)])};}catch(_0x45a37f){console[_0x519e86(0x29d)](_0x519e86(0x27a)+_0x45a37f['message'],_0x45a37f),console[_0x519e86(0x29d)](_0x519e86(0x201),_0x45a37f);throw new common_1[(_0x519e86(0x219))]('JSAPI支付失败',common_1[_0x519e86(0x275)][_0x519e86(0x24b)]);}}if(_0x32d365=='native'){common_1['Logger'][_0x519e86(0x245)](_0x519e86(0x2a4)+_0x6cb374+',\x20用户ID:\x20'+_0x4e5b40);try{const _0x508f24=await _0x36f4b3[_0x519e86(0x289)](_0x7dae10);common_1[_0x519e86(0x225)][_0x519e86(0x245)](_0x519e86(0x255),JSON[_0x519e86(0x1f6)](_0x508f24,null,0x2));let _0x50a91e=_0x508f24[_0x519e86(0x1f4)]||((_0xb17a1a=_0x508f24[_0x519e86(0x268)])===null||_0xb17a1a===void 0x0?void 0x0:_0xb17a1a[_0x519e86(0x1f4)]);return!_0x50a91e?console[_0x519e86(0x29d)]('微信Native支付请求成功，但未返回code_url，响应数据:\x20',JSON[_0x519e86(0x1f6)](_0x508f24,null,0x2)):common_1[_0x519e86(0x225)][_0x519e86(0x245)](_0x519e86(0x1ec)+_0x50a91e),{'url_qrcode':_0x50a91e,'isRedirect':![]};}catch(_0x476588){console[_0x519e86(0x29d)]('微信Native支付过程中发生错误，错误信息:\x20'+_0x476588['message'],_0x476588),console['error']('完整的错误对象：',_0x476588);throw new common_1[(_0x519e86(0x219))](_0x519e86(0x210),common_1[_0x519e86(0x275)][_0x519e86(0x24b)]);}}else{console[_0x519e86(0x28d)](_0x519e86(0x248)+_0x32d365);throw new common_1[(_0x519e86(0x219))](_0x519e86(0x1ed),common_1['HttpStatus'][_0x519e86(0x24b)]);}}async['queryWeChat'](_0x1c3668){const _0x548053=_0x1f62fc,{payWeChatAppId:_0x52c77f,payWeChatMchId:_0x110f6a,payWeChatPublicKey:_0x47dcd0,payWeChatPrivateKey:_0x2bb4e5,payWeChatNotifyUrl:_0x59f156}=await this[_0x548053(0x299)][_0x548053(0x241)]([_0x548053(0x278),_0x548053(0x20a),_0x548053(0x249),_0x548053(0x27f)]),_0x310ba2=new this[(_0x548053(0x29e))]({'appid':_0x52c77f,'mchid':_0x110f6a,'publicKey':_0x47dcd0,'privateKey':_0x2bb4e5}),_0x3dc562=await _0x310ba2[_0x548053(0x298)]({'out_trade_no':_0x1c3668});return _0x3dc562;}['sign'](_0x2230e7,_0xaf617c){const _0x10ad67=_0x1f62fc,_0x3d19b8=Object['keys'](_0x2230e7)['sort']()[_0x10ad67(0x1f1)](_0x51c341=>_0x51c341+'='+_0x2230e7[_0x51c341])[_0x10ad67(0x24d)]('&')+_0xaf617c;return crypto['createHash'](_0x10ad67(0x287))['update'](_0x3d19b8)[_0x10ad67(0x293)](_0x10ad67(0x1f8));}[_0x1f62fc(0x232)](_0x77acf5,_0x483603){const _0x17eadc=_0x1f62fc,_0x5eb7a9=Object['keys'](_0x77acf5);_0x5eb7a9[_0x17eadc(0x273)]();const _0x5e9e55=[];_0x5eb7a9[_0x17eadc(0x1f1)](_0x1c19ab=>{const _0x51f613=_0x17eadc;_0x5e9e55[_0x51f613(0x295)](_0x1c19ab+'='+_0x77acf5[_0x1c19ab]);}),_0x5e9e55[_0x17eadc(0x295)](_0x17eadc(0x246)+_0x483603);const _0x375447=_0x5e9e55[_0x17eadc(0x24d)]('&');return crypto[_0x17eadc(0x21c)](_0x17eadc(0x287))[_0x17eadc(0x2a9)](_0x375447)[_0x17eadc(0x293)](_0x17eadc(0x1f8))[_0x17eadc(0x283)]();}async[_0x1f62fc(0x294)](_0x36b89a,_0x158667,_0x184e17=_0x1f62fc(0x221)){const _0x128cd4=_0x1f62fc,_0x519005=await this[_0x128cd4(0x1fd)]['findOne']({'where':{'userId':_0x36b89a,'orderId':_0x158667}});if(!_0x519005)throw new common_1['HttpException'](_0x128cd4(0x20e),common_1['HttpStatus']['BAD_REQUEST']);const _0x63e743=await this[_0x128cd4(0x20b)]['findOne']({'where':{'id':_0x519005[_0x128cd4(0x1e5)]}});if(!_0x63e743)throw new common_1[(_0x128cd4(0x219))](_0x128cd4(0x26b),common_1['HttpStatus'][_0x128cd4(0x24b)]);const {payLtzfMchId:_0x4eb859,payLtzfSecret:_0x408645,payLtzfNotifyUrl:_0x550e1d,payLtzfReturnUrl:_0x2bde01}=await this[_0x128cd4(0x299)][_0x128cd4(0x241)]([_0x128cd4(0x21f),_0x128cd4(0x233),'payLtzfNotifyUrl',_0x128cd4(0x215)]),_0xbd9b26={};_0xbd9b26['mch_id']=_0x4eb859,_0xbd9b26[_0x128cd4(0x1f9)]=(Date['now']()/0x3e8)[_0x128cd4(0x203)](0x0),_0xbd9b26[_0x128cd4(0x1f3)]=_0x158667,_0xbd9b26[_0x128cd4(0x204)]=_0x63e743[_0x128cd4(0x1eb)],_0xbd9b26[_0x128cd4(0x1e1)]=_0x519005[_0x128cd4(0x21b)],_0xbd9b26[_0x128cd4(0x265)]=_0x550e1d,_0xbd9b26['sign']=this[_0x128cd4(0x232)](_0xbd9b26,_0x408645),_0xbd9b26[_0x128cd4(0x260)]='ltzf',_0xbd9b26['return_url']=_0x2bde01;const _0x1fdbb1=Object[_0x128cd4(0x227)](_0xbd9b26)['map'](_0x54366d=>encodeURIComponent(_0x54366d)+'='+encodeURIComponent(_0xbd9b26[_0x54366d]))['join']('&'),_0x7550f0={'headers':{'Content-Type':_0x128cd4(0x250)}},_0x2aee66=await axios_1['default'][_0x128cd4(0x1f2)](_0x128cd4(0x27c),_0x1fdbb1,_0x7550f0),{code:_0x548aa2,data:_0x9c812d,msg:_0x2b34de}=_0x2aee66[_0x128cd4(0x268)];if(_0x548aa2!=0x0)throw new common_1[(_0x128cd4(0x219))](_0x2b34de,common_1['HttpStatus'][_0x128cd4(0x24b)]);const _0x46f649=_0x9c812d[_0x128cd4(0x1f5)],_0x3e5fe2=_0x9c812d[_0x128cd4(0x24a)];return{'url_qrcode':_0x46f649,'url':_0x3e5fe2};}async['queryLtzf'](_0xc4038c){const _0x4d763=_0x1f62fc,{payLtzfMchId:_0x4ec4c2,payLtzfSecret:_0x29938d}=await this[_0x4d763(0x299)][_0x4d763(0x241)](['payLtzfMchId','payLtzfSecret']),_0x534578={};_0x534578[_0x4d763(0x234)]=_0x4ec4c2,_0x534578['timestamp']=(Date[_0x4d763(0x25a)]()/0x3e8)[_0x4d763(0x203)](0x0),_0x534578['out_trade_no']=_0xc4038c,_0x534578[_0x4d763(0x290)]=this['ltzfSign'](_0x534578,_0x29938d);const _0x1c2b22=Object[_0x4d763(0x227)](_0x534578)[_0x4d763(0x1f1)](_0xdaa50e=>encodeURIComponent(_0xdaa50e)+'='+encodeURIComponent(_0x534578[_0xdaa50e]))[_0x4d763(0x24d)]('&'),_0x474a98={'headers':{'Content-Type':_0x4d763(0x250)}},{data:{code:_0x268f8d,msg:_0x5764a6,data:_0x2b1631}}=await axios_1['default'][_0x4d763(0x1f2)]('https://api.ltzf.cn/api/wxpay/get_pay_order',_0x1c2b22,_0x474a98);if(_0x268f8d!=0x0)throw new common_1['HttpException'](_0x5764a6+JSON['stringify'](_0x534578),common_1[_0x4d763(0x275)][_0x4d763(0x24b)]);return _0x2b1631;}async['notifyLtzf'](_0x41bb30){const _0x1a6a54=_0x1f62fc,_0x2e3a20=await this['globalConfigService'][_0x1a6a54(0x241)]([_0x1a6a54(0x233)]),_0x1411e5=_0x41bb30['sign'];delete _0x41bb30[_0x1a6a54(0x290)],delete _0x41bb30[_0x1a6a54(0x231)],delete _0x41bb30[_0x1a6a54(0x27b)],delete _0x41bb30[_0x1a6a54(0x29b)],delete _0x41bb30['attach'],delete _0x41bb30[_0x1a6a54(0x270)];if(this[_0x1a6a54(0x232)](_0x41bb30,_0x2e3a20)!=_0x1411e5)return'FAIL';const _0x193dc4=await this[_0x1a6a54(0x1fd)]['findOne']({'where':{'orderId':_0x41bb30['out_trade_no'],'status':0x0}});if(!_0x193dc4)return _0x1a6a54(0x226);await this['userBalanceService'][_0x1a6a54(0x2a7)](_0x193dc4);const _0x2a07df=await this['orderEntity'][_0x1a6a54(0x2a9)]({'orderId':_0x41bb30[_0x1a6a54(0x1f3)]},{'status':0x1,'paydAt':new Date()});if(_0x2a07df[_0x1a6a54(0x217)]!=0x1)return _0x1a6a54(0x226);return'SUCCESS';}};PayService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x1f62fc(0x216)])(cramiPackage_entity_1[_0x1f62fc(0x239)])),__param(0x1,(0x0,typeorm_1[_0x1f62fc(0x216)])(order_entity_1['OrderEntity'])),__metadata(_0x1f62fc(0x264),[typeorm_2[_0x1f62fc(0x266)],typeorm_2[_0x1f62fc(0x266)],userBalance_service_1[_0x1f62fc(0x223)],globalConfig_service_1[_0x1f62fc(0x209)],user_service_1[_0x1f62fc(0x29f)]])],PayService),exports[_0x1f62fc(0x214)]=PayService;