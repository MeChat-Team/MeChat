'use strict';const _0x3caa8b=_0x1a45;(function(_0x97aeba,_0x329dfd){const _0x5b7902=_0x1a45,_0x13f2b6=_0x97aeba();while(!![]){try{const _0x6b1106=parseInt(_0x5b7902(0x211))/0x1+parseInt(_0x5b7902(0x1b2))/0x2*(parseInt(_0x5b7902(0x1ba))/0x3)+parseInt(_0x5b7902(0x18e))/0x4*(parseInt(_0x5b7902(0x1e4))/0x5)+parseInt(_0x5b7902(0x20d))/0x6*(-parseInt(_0x5b7902(0x193))/0x7)+parseInt(_0x5b7902(0x230))/0x8+-parseInt(_0x5b7902(0x18a))/0x9*(parseInt(_0x5b7902(0x1a0))/0xa)+-parseInt(_0x5b7902(0x205))/0xb;if(_0x6b1106===_0x329dfd)break;else _0x13f2b6['push'](_0x13f2b6['shift']());}catch(_0x5464f1){_0x13f2b6['push'](_0x13f2b6['shift']());}}}(_0x1bfa,0xf0772));var __decorate=this&&this[_0x3caa8b(0x224)]||function(_0xe5b440,_0x4498aa,_0x486e00,_0x141c5a){const _0x37c7bf=_0x3caa8b;var _0x3e8c6d=arguments[_0x37c7bf(0x1ce)],_0x50c7f6=_0x3e8c6d<0x3?_0x4498aa:_0x141c5a===null?_0x141c5a=Object[_0x37c7bf(0x19e)](_0x4498aa,_0x486e00):_0x141c5a,_0x3834d5;if(typeof Reflect==='object'&&typeof Reflect['decorate']===_0x37c7bf(0x1f8))_0x50c7f6=Reflect['decorate'](_0xe5b440,_0x4498aa,_0x486e00,_0x141c5a);else{for(var _0x1fc919=_0xe5b440[_0x37c7bf(0x1ce)]-0x1;_0x1fc919>=0x0;_0x1fc919--)if(_0x3834d5=_0xe5b440[_0x1fc919])_0x50c7f6=(_0x3e8c6d<0x3?_0x3834d5(_0x50c7f6):_0x3e8c6d>0x3?_0x3834d5(_0x4498aa,_0x486e00,_0x50c7f6):_0x3834d5(_0x4498aa,_0x486e00))||_0x50c7f6;}return _0x3e8c6d>0x3&&_0x50c7f6&&Object['defineProperty'](_0x4498aa,_0x486e00,_0x50c7f6),_0x50c7f6;},__metadata=this&&this['__metadata']||function(_0x1baf76,_0x52d010){const _0x33e8ba=_0x3caa8b;if(typeof Reflect==='object'&&typeof Reflect['metadata']===_0x33e8ba(0x1f8))return Reflect[_0x33e8ba(0x1a2)](_0x1baf76,_0x52d010);},__param=this&&this[_0x3caa8b(0x21f)]||function(_0x27f0a9,_0x3bb4b3){return function(_0x270d5d,_0x11e986){_0x3bb4b3(_0x270d5d,_0x11e986,_0x27f0a9);};};Object['defineProperty'](exports,_0x3caa8b(0x170),{'value':!![]}),exports['PayService']=void 0x0;function _0x1a45(_0x892cf6,_0x28d3df){const _0x1bfabd=_0x1bfa();return _0x1a45=function(_0x1a450a,_0x3d6803){_0x1a450a=_0x1a450a-0x16e;let _0x11520d=_0x1bfabd[_0x1a450a];return _0x11520d;},_0x1a45(_0x892cf6,_0x28d3df);}function _0x1bfa(){const _0x28379d=['map','sign_type','total_fee','queryWeChat','userBalanceService','warn','payHupiReturnUrl','21dZbjwt','微信Native支付过程中发生错误，错误信息:\x20','payMpay','notify','MD5','payHupi','onModuleInit','支付通知验证失败:\x20','Logger','payEpayApiPayUrl','payType:\x20','appId','payWeChatAppId','payWeChatNotifyUrl','payWeChatPrivateKey','round','findOne','trade_status','get','error','length','QRcode_url','payHupiNotifyUrl','body','https://api.ltzf.cn/api/wxpay/jsapi_convenient','订单不存在!','https://api.ltzf.cn/api/wxpay/get_pay_order','notifyWeChat','event_type','queryLtzf','money','md5','stringify','pay_channel','signType','https://api.xunhupay.com/payment/do.html','createHash','微信Native支付失败','Injectable','toUpperCase','axios','payMpayNotifyUrl','671215qTWcTH','../../common/utils','appid','192.168.1.100','decipher_gcm','typeorm','affected','BAD_REQUEST','InjectRepository','addBalanceToOrder','WxPay','1.1','SUCCESS','includes','version','../globalConfig/globalConfig.service','payMpayPid','wechat','[WeChat\x20Pay\x20JSAPI]\x20完整的错误对象：','支付请求使用了不支持的支付类型:\x20','function','payLtzf','package','payHupiSecret','notifyEpay','payWeChatPublicKey','hupi','payer','cramiPackageEntity','[WeChat\x20Pay\x20JSAPI]\x20开始JSAPI支付流程，用户ID:\x20','hash','wxpay','FAIL','33051370ZaKtOu','../user/user.service','本次支付类型:\x20','openid','error:\x20','paySign','notifyMpay','message','6AhXVsy','ltzf','timeStamp','submit.php','833181rRprjU','success','orderEntity','epay','design:paramtypes','query','transactions_native','title','data','keys','default','code_url','开始进行微信Native支付流程，订单ID:\x20','JSAPI支付失败','__param','payHupiGatewayUrl','支付请求失败!','校验签名',',\x20订单ID:\x20','__decorate','queryHupi','trade_state','object','epay\x20--->\x20res:\x20','clientip','out_trade_order','goodsId','Repository','getConfigs','toFixed','../order/order.entity','15591000IBVXSx','mpay','payHupiAppId','payEpayApiQueryUrl','payLtzfSecret','../crami/cramiPackage.entity','payMpayReturnUrl','wechat-pay:\x20','order_no','hex','notifyLtzf','status:\x20','userService','https://api.xunhupay.com/payment/query.html','套餐不存在!','微信Native支付请求成功，但未返回code_url，响应数据:\x20','nonce_str','__esModule','unknown','update','payLtzfMchId','ltzfSign','微信Native支付响应数据:\x20','pid','application/x-www-form-urlencoded','PayService','payPlatform','微信Native支付请求成功，code_url:\x20','@nestjs/common','payEpayPid','payEpayReturnUrl','HttpException','pay','payWeChatMchId','sign','crypto','nonceStr','resource','total','globalConfigService','校验签名通过','payEpaySecret','type','9kJZUYQ','notify_url','toString','failed','52dlJYEE',',\x20用户ID:\x20','jsapi','return_url','payEpay','7845677QfYGoG','../userBalance/userBalance.service','param','push','name','timestamp','trade_order_id','out_trade_no','native','UserBalanceService','order','getOwnPropertyDescriptor','payLtzfNotifyUrl','8636810AzLuKv','TRADE_SUCCESS','metadata','digest','UserService','time','attach','join','支付请求失败:\x20','TRANSACTION.SUCCESS','HttpStatus','now','log','createRandomNonceStr','sort','post','payWeChat','queryMpay','413398KAbEtS'];_0x1bfa=function(){return _0x28379d;};return _0x1bfa();}const utils_1=require(_0x3caa8b(0x1e5)),common_1=require(_0x3caa8b(0x17b)),typeorm_1=require('@nestjs/typeorm'),axios_1=require(_0x3caa8b(0x1e2)),crypto=require(_0x3caa8b(0x182)),typeorm_2=require(_0x3caa8b(0x1e9)),cramiPackage_entity_1=require(_0x3caa8b(0x235)),globalConfig_service_1=require(_0x3caa8b(0x1f3)),order_entity_1=require(_0x3caa8b(0x22f)),user_service_1=require(_0x3caa8b(0x206)),userBalance_service_1=require(_0x3caa8b(0x194));let PayService=class PayService{constructor(_0x6643eb,_0xd482cb,_0xfa0d2e,_0x4f1f77,_0xc13ff6){const _0x465a1b=_0x3caa8b;this[_0x465a1b(0x200)]=_0x6643eb,this[_0x465a1b(0x213)]=_0xd482cb,this[_0x465a1b(0x1b7)]=_0xfa0d2e,this[_0x465a1b(0x186)]=_0x4f1f77,this[_0x465a1b(0x23c)]=_0xc13ff6;}async[_0x3caa8b(0x1c0)](){const _0x22655c=_0x3caa8b,_0x229f6f=await(0x0,utils_1['importDynamic'])('wechatpay-node-v3');this[_0x22655c(0x1ee)]=(_0x229f6f===null||_0x229f6f===void 0x0?void 0x0:_0x229f6f[_0x22655c(0x21b)])?_0x229f6f[_0x22655c(0x21b)]:_0x229f6f;}async[_0x3caa8b(0x1bd)](_0x44375f){const _0x52b7b5=_0x3caa8b;if(_0x44375f[_0x52b7b5(0x195)]==_0x52b7b5(0x214))return this[_0x52b7b5(0x1fc)](_0x44375f);if(_0x44375f['attach']==_0x52b7b5(0x1fe))return this['notifyHupi'](_0x44375f);if(_0x44375f[_0x52b7b5(0x1a6)]=='ltzf')return this['notifyLtzf'](_0x44375f);if(typeof _0x44375f[_0x52b7b5(0x184)]==_0x52b7b5(0x227))return this[_0x52b7b5(0x1d5)](_0x44375f);return this[_0x52b7b5(0x20b)](_0x44375f);}async[_0x3caa8b(0x17f)](_0x44b2c6,_0x24ce95,_0x26dea8=_0x3caa8b(0x203)){const _0x2de4f1=_0x3caa8b,_0x4e5b85=await this['orderEntity'][_0x2de4f1(0x1ca)]({'where':{'userId':_0x44b2c6,'orderId':_0x24ce95}});if(!_0x4e5b85)throw new common_1[(_0x2de4f1(0x17e))](_0x2de4f1(0x1d3),common_1['HttpStatus']['BAD_REQUEST']);const _0x56ed64=await this[_0x2de4f1(0x200)][_0x2de4f1(0x1ca)]({'where':{'id':_0x4e5b85[_0x2de4f1(0x22b)]}});if(!_0x56ed64)throw new common_1[(_0x2de4f1(0x17e))]('套餐不存在!',common_1[_0x2de4f1(0x1aa)][_0x2de4f1(0x1eb)]);common_1['Logger'][_0x2de4f1(0x1ac)](_0x2de4f1(0x207),_0x4e5b85[_0x2de4f1(0x179)]);try{if(_0x4e5b85[_0x2de4f1(0x179)]==_0x2de4f1(0x1f5))return this[_0x2de4f1(0x1b0)](_0x44b2c6,_0x24ce95,_0x26dea8);if(_0x4e5b85[_0x2de4f1(0x179)]=='epay')return this[_0x2de4f1(0x192)](_0x44b2c6,_0x24ce95,_0x26dea8);if(_0x4e5b85[_0x2de4f1(0x179)]==_0x2de4f1(0x231))return this[_0x2de4f1(0x1bc)](_0x44b2c6,_0x24ce95,_0x26dea8);if(_0x4e5b85[_0x2de4f1(0x179)]==_0x2de4f1(0x1fe))return this['payHupi'](_0x44b2c6,_0x24ce95,_0x26dea8);if(_0x4e5b85[_0x2de4f1(0x179)]=='ltzf')return this[_0x2de4f1(0x1f9)](_0x44b2c6,_0x24ce95,_0x26dea8);}catch(_0x23545d){common_1['Logger']['log'](_0x2de4f1(0x1a8),_0x23545d);throw new common_1['HttpException'](_0x2de4f1(0x221),common_1[_0x2de4f1(0x1aa)][_0x2de4f1(0x1eb)]);}}async['query'](_0x447b83){const _0x45b590=_0x3caa8b,_0x31419f=await this[_0x45b590(0x213)][_0x45b590(0x1ca)]({'where':{'orderId':_0x447b83}});if(!_0x31419f)throw new common_1[(_0x45b590(0x17e))](_0x45b590(0x1d3),common_1[_0x45b590(0x1aa)][_0x45b590(0x1eb)]);return _0x31419f;}async['notifyHupi'](_0x40d20a){const _0x5070a8=_0x3caa8b,_0x3a290e=await this[_0x5070a8(0x186)]['getConfigs']([_0x5070a8(0x1fb)]),_0x1c00aa=_0x40d20a[_0x5070a8(0x202)];delete _0x40d20a[_0x5070a8(0x202)];if(this[_0x5070a8(0x181)](_0x40d20a,_0x3a290e)!=_0x1c00aa)return _0x5070a8(0x18d);const _0x8c9074=await this[_0x5070a8(0x213)][_0x5070a8(0x1ca)]({'where':{'orderId':_0x40d20a[_0x5070a8(0x199)],'status':0x0}});if(!_0x8c9074)return'failed';await this[_0x5070a8(0x1b7)]['addBalanceToOrder'](_0x8c9074);const _0x213ac2=await this[_0x5070a8(0x213)]['update']({'orderId':_0x40d20a[_0x5070a8(0x199)]},{'status':0x1,'paydAt':new Date()});if(_0x213ac2[_0x5070a8(0x1ea)]!=0x1)return _0x5070a8(0x18d);return _0x5070a8(0x212);}async[_0x3caa8b(0x1bf)](_0x13c2e4,_0x5033b3,_0x522aa1=_0x3caa8b(0x203)){const _0x137299=_0x3caa8b,_0x1b656b=await this[_0x137299(0x213)][_0x137299(0x1ca)]({'where':{'userId':_0x13c2e4,'orderId':_0x5033b3}});if(!_0x1b656b)throw new common_1[(_0x137299(0x17e))](_0x137299(0x1d3),common_1[_0x137299(0x1aa)]['BAD_REQUEST']);const _0x1ed1b9=await this[_0x137299(0x200)][_0x137299(0x1ca)]({'where':{'id':_0x1b656b[_0x137299(0x22b)]}});if(!_0x1ed1b9)throw new common_1[(_0x137299(0x17e))](_0x137299(0x23e),common_1[_0x137299(0x1aa)][_0x137299(0x1eb)]);const {payHupiAppId:_0x1ffc71,payHupiSecret:_0x5aa2b7,payHupiNotifyUrl:_0xb18286,payHupiReturnUrl:_0x6f3782,payHupiGatewayUrl:_0x304d3d}=await this[_0x137299(0x186)]['getConfigs']([_0x137299(0x232),_0x137299(0x1fb),_0x137299(0x1d0),_0x137299(0x1b9),_0x137299(0x220)]),_0x8ae6f0={};_0x8ae6f0[_0x137299(0x1f2)]=_0x137299(0x1ef),_0x8ae6f0[_0x137299(0x1e6)]=_0x1ffc71,_0x8ae6f0[_0x137299(0x1a5)]=(Date['now']()/0x3e8)[_0x137299(0x22e)](0x0),_0x8ae6f0['nonce_str']=(0x0,utils_1[_0x137299(0x1ad)])(0x20),_0x8ae6f0[_0x137299(0x199)]=_0x5033b3,_0x8ae6f0[_0x137299(0x218)]=_0x1ed1b9['name'],_0x8ae6f0[_0x137299(0x1b5)]=_0x1b656b[_0x137299(0x185)],_0x8ae6f0[_0x137299(0x18b)]=_0xb18286,_0x8ae6f0[_0x137299(0x191)]=_0x6f3782,_0x8ae6f0[_0x137299(0x1a6)]=_0x137299(0x1fe),_0x8ae6f0['hash']=this[_0x137299(0x181)](_0x8ae6f0,_0x5aa2b7);const {data:{errcode:_0x117937,errmsg:_0x3f9c8c,url_qrcode:_0x4d7889,url:_0x37f4a0}}=await axios_1[_0x137299(0x21b)][_0x137299(0x1af)](_0x304d3d||_0x137299(0x1dd),_0x8ae6f0);if(_0x117937!=0x0)throw new common_1[(_0x137299(0x17e))](_0x3f9c8c,common_1[_0x137299(0x1aa)]['BAD_REQUEST']);return{'url_qrcode':_0x4d7889,'url':_0x37f4a0};}async[_0x3caa8b(0x225)](_0x569c46){const _0x214fe3=_0x3caa8b,{payHupiAppId:_0x19a3f4,payHupiSecret:_0x22d814}=await this['globalConfigService'][_0x214fe3(0x22d)]([_0x214fe3(0x232),_0x214fe3(0x1fb)]),_0x239e1f={};_0x239e1f[_0x214fe3(0x1f2)]=_0x214fe3(0x1ef),_0x239e1f[_0x214fe3(0x1e6)]=_0x19a3f4,_0x239e1f[_0x214fe3(0x1a5)]=(Date[_0x214fe3(0x1ab)]()/0x3e8)[_0x214fe3(0x22e)](0x0),_0x239e1f[_0x214fe3(0x16f)]=(0x0,utils_1[_0x214fe3(0x1ad)])(0x20),_0x239e1f[_0x214fe3(0x22a)]=_0x569c46,_0x239e1f[_0x214fe3(0x202)]=this['sign'](_0x239e1f,_0x22d814);const {data:{errcode:_0x3495f5,errmsg:_0x4588fc,data:_0x3b49d3}}=await axios_1[_0x214fe3(0x21b)]['post'](_0x214fe3(0x23d),_0x239e1f);if(_0x3495f5!=0x0)throw new common_1[(_0x214fe3(0x17e))](_0x4588fc,common_1[_0x214fe3(0x1aa)][_0x214fe3(0x1eb)]);return _0x3b49d3;}async[_0x3caa8b(0x1fc)](_0x9118eb){const _0x3d38f9=_0x3caa8b,_0x368048=_0x9118eb[_0x3d38f9(0x181)];delete _0x9118eb['sign'],delete _0x9118eb[_0x3d38f9(0x1b4)];const _0x132a09=await this[_0x3d38f9(0x186)]['getConfigs']([_0x3d38f9(0x188)]);if(this[_0x3d38f9(0x181)](_0x9118eb,_0x132a09)!=_0x368048)return'failed';common_1[_0x3d38f9(0x1c2)][_0x3d38f9(0x1ac)](_0x3d38f9(0x187));const _0x535466=await this[_0x3d38f9(0x213)]['findOne']({'where':{'orderId':_0x9118eb[_0x3d38f9(0x19a)],'status':0x0}});if(!_0x535466)return _0x3d38f9(0x18d);const _0x124766=_0x9118eb[_0x3d38f9(0x1cb)]==_0x3d38f9(0x1a1)?0x1:0x2,_0x5864d0=await this[_0x3d38f9(0x213)]['update']({'orderId':_0x9118eb['out_trade_no']},{'status':_0x124766,'paydAt':new Date()});_0x124766===0x1&&await this[_0x3d38f9(0x1b7)]['addBalanceToOrder'](_0x535466);if(_0x5864d0['affected']!=0x1)return'failed';return _0x3d38f9(0x212);}async[_0x3caa8b(0x192)](_0x3c55c9,_0x2c6b15,_0x186c8f='alipay'){const _0x2ad176=_0x3caa8b,_0x1daec1=await this[_0x2ad176(0x213)][_0x2ad176(0x1ca)]({'where':{'userId':_0x3c55c9,'orderId':_0x2c6b15}});if(!_0x1daec1)throw new common_1['HttpException'](_0x2ad176(0x1d3),common_1[_0x2ad176(0x1aa)][_0x2ad176(0x1eb)]);const _0xee1c4d=await this[_0x2ad176(0x200)][_0x2ad176(0x1ca)]({'where':{'id':_0x1daec1[_0x2ad176(0x22b)]}});if(!_0xee1c4d)throw new common_1[(_0x2ad176(0x17e))](_0x2ad176(0x23e),common_1[_0x2ad176(0x1aa)][_0x2ad176(0x1eb)]);const {payEpayPid:_0xf70acd,payEpaySecret:_0x58d867,payEpayNotifyUrl:_0xa12565,payEpayReturnUrl:_0x40908e,payEpayApiPayUrl:_0x2bbc5c}=await this[_0x2ad176(0x186)][_0x2ad176(0x22d)]([_0x2ad176(0x17c),_0x2ad176(0x188),'payEpayNotifyUrl',_0x2ad176(0x17d),_0x2ad176(0x1c3)]);let _0x10fae1;_0xf70acd[_0x2ad176(0x1ce)]<=0x10?_0x10fae1=Number(_0xf70acd):_0x10fae1=BigInt(_0xf70acd);const _0x1089cc={};_0x1089cc[_0x2ad176(0x176)]=_0x10fae1,_0x1089cc[_0x2ad176(0x189)]=_0x186c8f,_0x1089cc[_0x2ad176(0x19a)]=_0x2c6b15,_0x1089cc[_0x2ad176(0x197)]=_0xee1c4d[_0x2ad176(0x197)],_0x1089cc[_0x2ad176(0x1d8)]=_0x1daec1['total'],_0x1089cc[_0x2ad176(0x229)]=_0x2ad176(0x1e7),_0x1089cc['device']='pc',_0x1089cc[_0x2ad176(0x18b)]=_0xa12565,_0x1089cc['return_url']=_0x40908e,_0x1089cc['param']=_0x2ad176(0x214),_0x1089cc['sign']=this['sign'](_0x1089cc,_0x58d867),_0x1089cc['sign_type']=_0x2ad176(0x1be);const _0x5993c7=new URLSearchParams(_0x1089cc)['toString'](),_0x1a2f1d=_0x2bbc5c+'?'+_0x5993c7;if(_0x2bbc5c[_0x2ad176(0x1f1)](_0x2ad176(0x210)))return{'url_qrcode':null,'redirectUrl':_0x1a2f1d,'channel':_0x186c8f,'isRedirect':!![]};else{const _0x1864d1={'headers':{'Content-Type':'application/x-www-form-urlencoded'}},_0x1f8c8a=await axios_1[_0x2ad176(0x21b)][_0x2ad176(0x1af)](_0x2bbc5c,_0x1089cc,_0x1864d1);common_1[_0x2ad176(0x1c2)]['log'](_0x2ad176(0x228),_0x1f8c8a['data']);const {data:{code:_0x1297ed,msg:_0x2530c2,qrcode:_0x150932}}=_0x1f8c8a;if(_0x1297ed!=0x1)throw new common_1[(_0x2ad176(0x17e))](_0x2530c2,common_1[_0x2ad176(0x1aa)][_0x2ad176(0x1eb)]);return{'url_qrcode':_0x150932,'redirectUrl':null,'channel':_0x186c8f,'isRedirect':![]};}}async['queryEpay'](_0x20d305){const _0xb627a2=_0x3caa8b,{payEpayPid:_0x29b0ec,payEpaySecret:_0xe03929,payEpayApiQueryUrl:_0xfb226f}=await this[_0xb627a2(0x186)][_0xb627a2(0x22d)]([_0xb627a2(0x17c),'payEpaySecret',_0xb627a2(0x233)]),_0x313f8a={};_0x313f8a['act']=_0xb627a2(0x19d),_0x313f8a[_0xb627a2(0x19a)]=_0x20d305,_0x313f8a[_0xb627a2(0x176)]=_0x29b0ec,_0x313f8a['key']=_0xe03929;const {data:{code:_0x1e31db,msg:_0x14bd2c,data:_0x487efc}}=await axios_1[_0xb627a2(0x21b)][_0xb627a2(0x1cc)](_0xfb226f,{'params':_0x313f8a});if(_0x1e31db!=0x1)throw new common_1[(_0xb627a2(0x17e))](_0x14bd2c,common_1[_0xb627a2(0x1aa)][_0xb627a2(0x1eb)]);return _0x487efc;}async[_0x3caa8b(0x20b)](_0x1e0c51){const _0x2539a0=_0x3caa8b,_0x26cd86=_0x1e0c51[_0x2539a0(0x181)];delete _0x1e0c51[_0x2539a0(0x181)],delete _0x1e0c51[_0x2539a0(0x1b4)];const _0x2cc8d2=await this[_0x2539a0(0x186)][_0x2539a0(0x22d)](['payMpaySecret']);common_1[_0x2539a0(0x1c2)][_0x2539a0(0x1ac)](_0x2539a0(0x222));if(this[_0x2539a0(0x181)](_0x1e0c51,_0x2cc8d2)!=_0x26cd86)return'failed';common_1[_0x2539a0(0x1c2)][_0x2539a0(0x1ac)]('校验签名通过');const _0x270ad7=await this[_0x2539a0(0x213)][_0x2539a0(0x1ca)]({'where':{'orderId':_0x1e0c51[_0x2539a0(0x19a)],'status':0x0}});if(!_0x270ad7)return _0x2539a0(0x18d);const _0x3a4d14=_0x1e0c51['trade_status']==_0x2539a0(0x1a1)?0x1:0x2;common_1[_0x2539a0(0x1c2)][_0x2539a0(0x1ac)](_0x2539a0(0x23b),_0x3a4d14);const _0x571cb3=await this[_0x2539a0(0x213)][_0x2539a0(0x172)]({'orderId':_0x1e0c51[_0x2539a0(0x19a)]},{'status':_0x3a4d14,'paydAt':new Date()});_0x3a4d14===0x1&&await this[_0x2539a0(0x1b7)][_0x2539a0(0x1ed)](_0x270ad7);if(_0x571cb3[_0x2539a0(0x1ea)]!=0x1)return _0x2539a0(0x18d);return'success';}async[_0x3caa8b(0x1bc)](_0x1b71a4,_0x38838b,_0x1d1e50=_0x3caa8b(0x203)){const _0x2167d9=_0x3caa8b,_0x59cc75=await this['orderEntity'][_0x2167d9(0x1ca)]({'where':{'userId':_0x1b71a4,'orderId':_0x38838b}});if(!_0x59cc75)throw new common_1[(_0x2167d9(0x17e))](_0x2167d9(0x1d3),common_1[_0x2167d9(0x1aa)][_0x2167d9(0x1eb)]);const _0x4c32d4=await this[_0x2167d9(0x200)][_0x2167d9(0x1ca)]({'where':{'id':_0x59cc75[_0x2167d9(0x22b)]}});if(!_0x4c32d4)throw new common_1['HttpException'](_0x2167d9(0x23e),common_1[_0x2167d9(0x1aa)][_0x2167d9(0x1eb)]);const {payMpayPid:_0x21e061,payMpaySecret:_0x3ba94c,payMpayNotifyUrl:_0x188e09,payMpayReturnUrl:_0x41065b,payMpayApiPayUrl:_0x469579}=await this['globalConfigService'][_0x2167d9(0x22d)](['payMpayPid','payMpaySecret',_0x2167d9(0x1e3),_0x2167d9(0x236),'payMpayApiPayUrl']),_0x222171={};_0x222171[_0x2167d9(0x176)]=Number(_0x21e061),_0x222171[_0x2167d9(0x189)]=_0x1d1e50,_0x222171['out_trade_no']=_0x38838b,_0x222171[_0x2167d9(0x197)]=_0x4c32d4[_0x2167d9(0x197)],_0x222171[_0x2167d9(0x1d8)]=_0x59cc75[_0x2167d9(0x185)],_0x222171[_0x2167d9(0x18b)]=_0x188e09,_0x222171[_0x2167d9(0x191)]=_0x41065b,_0x222171[_0x2167d9(0x181)]=this[_0x2167d9(0x181)](_0x222171,_0x3ba94c),_0x222171[_0x2167d9(0x1b4)]=_0x2167d9(0x1be);const _0x4b2808=new URLSearchParams(_0x222171)[_0x2167d9(0x18c)](),_0x7e00e2=_0x469579+'?'+_0x4b2808;return{'url_qrcode':null,'redirectUrl':_0x7e00e2,'channel':_0x1d1e50,'isRedirect':!![]};const _0x38ea27=await axios_1[_0x2167d9(0x21b)][_0x2167d9(0x1cc)](_0x469579,{'params':_0x222171});}async[_0x3caa8b(0x1b1)](_0x396379){const _0x4388ce=_0x3caa8b,{payMpayApiQueryUrl:_0x1ef3bc}=await this[_0x4388ce(0x186)]['getConfigs']([_0x4388ce(0x1f4),'payMpaySecret','payMpayApiQueryUrl']),_0x21481e={};_0x21481e[_0x4388ce(0x189)]=0x2,_0x21481e[_0x4388ce(0x238)]=_0x396379;const {data:{code:_0x28130b,msg:_0x40ee58,data:_0x689b06}}=await axios_1[_0x4388ce(0x21b)][_0x4388ce(0x1cc)](_0x1ef3bc,{'params':_0x21481e});if(_0x28130b!=0x1)throw new common_1[(_0x4388ce(0x17e))](_0x40ee58,common_1[_0x4388ce(0x1aa)][_0x4388ce(0x1eb)]);return _0x689b06;}async[_0x3caa8b(0x1d5)](_0x2f54b6){const _0x30448f=_0x3caa8b;common_1['Logger'][_0x30448f(0x1ac)]('微信支付通知params:\x20',_0x2f54b6);const {payWeChatAppId:_0x4dee4b,payWeChatMchId:_0x51ccfa,payWeChatSecret:_0x28cd16,payWeChatPublicKey:_0x396066,payWeChatPrivateKey:_0x43fc67}=await this[_0x30448f(0x186)]['getConfigs'](['payWeChatAppId',_0x30448f(0x180),'payWeChatSecret',_0x30448f(0x1fd),_0x30448f(0x1c8)]),_0x4248c9=new this[(_0x30448f(0x1ee))]({'appid':_0x4dee4b,'mchid':_0x51ccfa,'publicKey':_0x396066,'privateKey':_0x43fc67});try{if(_0x2f54b6[_0x30448f(0x1d6)]==_0x30448f(0x1a9)){const {ciphertext:_0xd98e25,associated_data:_0x156348,nonce:_0x54e4e6}=_0x2f54b6[_0x30448f(0x184)],_0x34ac72=_0x4248c9[_0x30448f(0x1e8)](_0xd98e25,_0x156348,_0x54e4e6,_0x28cd16),_0x318ab7=await this[_0x30448f(0x213)][_0x30448f(0x1ca)]({'where':{'orderId':_0x34ac72[_0x30448f(0x19a)],'status':0x0}});if(!_0x318ab7)return'failed';const _0x1a7b92=_0x34ac72[_0x30448f(0x226)]=='SUCCESS'?0x1:0x2,_0x4cdee9=await this['orderEntity']['update']({'orderId':_0x34ac72['out_trade_no']},{'status':_0x1a7b92,'paydAt':new Date()});_0x1a7b92===0x1&&await this[_0x30448f(0x1b7)]['addBalanceToOrder'](_0x318ab7);if(_0x4cdee9[_0x30448f(0x1ea)]!=0x1)return _0x30448f(0x18d);}return'success';}catch(_0x3b51c9){return common_1[_0x30448f(0x1c2)][_0x30448f(0x1ac)](_0x30448f(0x209),_0x3b51c9),common_1[_0x30448f(0x1c2)][_0x30448f(0x1ac)](_0x30448f(0x1c1),_0x3b51c9),_0x30448f(0x18d);}}async['payWeChat'](_0x2aeb7e,_0x9c1b46,_0x1bb09b=_0x3caa8b(0x19b)){const _0xa960a2=_0x3caa8b;var _0x50f8c2,_0x37e83a,_0x97d5dd,_0x5b4bd3,_0x229ef5,_0x2b062b,_0x5114ed;common_1[_0xa960a2(0x1c2)]['log'](_0xa960a2(0x1c4),_0x1bb09b);const _0x23a0fc=await this[_0xa960a2(0x213)][_0xa960a2(0x1ca)]({'where':{'userId':_0x2aeb7e,'orderId':_0x9c1b46}});if(!_0x23a0fc)throw new common_1[(_0xa960a2(0x17e))](_0xa960a2(0x1d3),common_1[_0xa960a2(0x1aa)][_0xa960a2(0x1eb)]);const _0x180bca=await this[_0xa960a2(0x200)]['findOne']({'where':{'id':_0x23a0fc[_0xa960a2(0x22b)]}});if(!_0x180bca)throw new common_1['HttpException'](_0xa960a2(0x23e),common_1[_0xa960a2(0x1aa)]['BAD_REQUEST']);const {payWeChatAppId:_0xf1dc3d,payWeChatMchId:_0x3521eb,payWeChatPublicKey:_0x41bf5f,payWeChatPrivateKey:_0x55305d,payWeChatNotifyUrl:_0x1176f2}=await this[_0xa960a2(0x186)][_0xa960a2(0x22d)]([_0xa960a2(0x1c6),_0xa960a2(0x180),_0xa960a2(0x1fd),_0xa960a2(0x1c8),_0xa960a2(0x1c7)]),_0x5d65b7=new this[(_0xa960a2(0x1ee))]({'appid':_0xf1dc3d,'mchid':_0x3521eb,'publicKey':_0x41bf5f,'privateKey':_0x55305d}),_0x4a3545={'appid':_0xf1dc3d,'mchid':_0x3521eb,'description':_0x180bca[_0xa960a2(0x197)],'out_trade_no':_0x9c1b46,'notify_url':_0x1176f2,'amount':{'total':Math[_0xa960a2(0x1c9)](_0x23a0fc[_0xa960a2(0x185)]*0x64)}};common_1[_0xa960a2(0x1c2)]['log'](_0xa960a2(0x237),_0x4a3545);if(_0x1bb09b==_0xa960a2(0x190)){common_1[_0xa960a2(0x1c2)][_0xa960a2(0x1ac)](_0xa960a2(0x201)+_0x2aeb7e+_0xa960a2(0x223)+_0x9c1b46);const _0x5d1c61=await this[_0xa960a2(0x23c)]['getOpenIdByUserId'](_0x2aeb7e);common_1[_0xa960a2(0x1c2)][_0xa960a2(0x1ac)]('[WeChat\x20Pay\x20JSAPI]\x20用户OpenID:\x20'+_0x5d1c61),_0x4a3545[_0xa960a2(0x1ff)]={'openid':_0x5d1c61},common_1[_0xa960a2(0x1c2)][_0xa960a2(0x1ac)]('[WeChat\x20Pay\x20JSAPI]\x20发送支付请求参数:\x20',JSON[_0xa960a2(0x1da)](_0x4a3545,null,0x2));try{const _0x4f8d67=await _0x5d65b7['transactions_jsapi'](_0x4a3545),_0x8888e5=_0x4f8d67[_0xa960a2(0x219)]?_0x4f8d67[_0xa960a2(0x219)]:_0x4f8d67;return common_1[_0xa960a2(0x1c2)][_0xa960a2(0x1ac)]('[WeChat\x20Pay\x20JSAPI]\x20支付请求成功，返回结果:\x20',JSON[_0xa960a2(0x1da)](_0x8888e5,null,0x2)),{'status':_0x4f8d67['status']||_0xa960a2(0x171),'appId':_0x8888e5[_0xa960a2(0x1c5)]||((_0x50f8c2=_0x8888e5['data'])===null||_0x50f8c2===void 0x0?void 0x0:_0x50f8c2['appId']),'timeStamp':_0x8888e5[_0xa960a2(0x20f)]||((_0x37e83a=_0x8888e5[_0xa960a2(0x219)])===null||_0x37e83a===void 0x0?void 0x0:_0x37e83a[_0xa960a2(0x20f)]),'nonceStr':_0x8888e5[_0xa960a2(0x183)]||((_0x97d5dd=_0x8888e5[_0xa960a2(0x219)])===null||_0x97d5dd===void 0x0?void 0x0:_0x97d5dd['nonceStr']),'package':_0x8888e5[_0xa960a2(0x1fa)]||((_0x5b4bd3=_0x8888e5[_0xa960a2(0x219)])===null||_0x5b4bd3===void 0x0?void 0x0:_0x5b4bd3[_0xa960a2(0x1fa)]),'signType':_0x8888e5[_0xa960a2(0x1dc)]||((_0x229ef5=_0x8888e5[_0xa960a2(0x219)])===null||_0x229ef5===void 0x0?void 0x0:_0x229ef5[_0xa960a2(0x1dc)]),'paySign':_0x8888e5[_0xa960a2(0x20a)]||((_0x2b062b=_0x8888e5[_0xa960a2(0x219)])===null||_0x2b062b===void 0x0?void 0x0:_0x2b062b[_0xa960a2(0x20a)])};}catch(_0x31f16a){console[_0xa960a2(0x1cd)]('[WeChat\x20Pay\x20JSAPI]\x20支付请求过程中发生错误:\x20'+_0x31f16a['message'],_0x31f16a),console[_0xa960a2(0x1cd)](_0xa960a2(0x1f6),_0x31f16a);throw new common_1[(_0xa960a2(0x17e))](_0xa960a2(0x21e),common_1[_0xa960a2(0x1aa)][_0xa960a2(0x1eb)]);}}if(_0x1bb09b==_0xa960a2(0x19b)){common_1['Logger']['log'](_0xa960a2(0x21d)+_0x9c1b46+_0xa960a2(0x18f)+_0x2aeb7e);try{const _0x32253d=await _0x5d65b7[_0xa960a2(0x217)](_0x4a3545);common_1[_0xa960a2(0x1c2)]['log'](_0xa960a2(0x175),JSON[_0xa960a2(0x1da)](_0x32253d,null,0x2));let _0x364507=_0x32253d['code_url']||((_0x5114ed=_0x32253d['data'])===null||_0x5114ed===void 0x0?void 0x0:_0x5114ed[_0xa960a2(0x21c)]);return!_0x364507?console[_0xa960a2(0x1cd)](_0xa960a2(0x16e),JSON[_0xa960a2(0x1da)](_0x32253d,null,0x2)):common_1[_0xa960a2(0x1c2)][_0xa960a2(0x1ac)](_0xa960a2(0x17a)+_0x364507),{'url_qrcode':_0x364507,'isRedirect':![]};}catch(_0x2d31b3){console[_0xa960a2(0x1cd)](_0xa960a2(0x1bb)+_0x2d31b3[_0xa960a2(0x20c)],_0x2d31b3),console['error']('完整的错误对象：',_0x2d31b3);throw new common_1[(_0xa960a2(0x17e))](_0xa960a2(0x1df),common_1['HttpStatus'][_0xa960a2(0x1eb)]);}}else{console[_0xa960a2(0x1b8)](_0xa960a2(0x1f7)+_0x1bb09b);throw new common_1['HttpException']('unsupported\x20pay\x20type',common_1[_0xa960a2(0x1aa)][_0xa960a2(0x1eb)]);}}async[_0x3caa8b(0x1b6)](_0x19f7b4){const _0x1e35ca=_0x3caa8b,{payWeChatAppId:_0x556955,payWeChatMchId:_0x590ca8,payWeChatPublicKey:_0x1eef9d,payWeChatPrivateKey:_0x361df9,payWeChatNotifyUrl:_0x493a41}=await this[_0x1e35ca(0x186)][_0x1e35ca(0x22d)](['payWeChatAppId','payWeChatMchId',_0x1e35ca(0x1fd),_0x1e35ca(0x1c8)]),_0x414112=new this[(_0x1e35ca(0x1ee))]({'appid':_0x556955,'mchid':_0x590ca8,'publicKey':_0x1eef9d,'privateKey':_0x361df9}),_0x46151a=await _0x414112[_0x1e35ca(0x216)]({'out_trade_no':_0x19f7b4});return _0x46151a;}[_0x3caa8b(0x181)](_0x5eae7b,_0x7add83){const _0x14f81c=_0x3caa8b,_0x4659ab=Object[_0x14f81c(0x21a)](_0x5eae7b)[_0x14f81c(0x1ae)]()[_0x14f81c(0x1b3)](_0x9dc275=>_0x9dc275+'='+_0x5eae7b[_0x9dc275])['join']('&')+_0x7add83;return crypto[_0x14f81c(0x1de)](_0x14f81c(0x1d9))[_0x14f81c(0x172)](_0x4659ab)[_0x14f81c(0x1a3)](_0x14f81c(0x239));}[_0x3caa8b(0x174)](_0x82e6d,_0x396d89){const _0x32c011=_0x3caa8b,_0x59de3b=Object[_0x32c011(0x21a)](_0x82e6d);_0x59de3b[_0x32c011(0x1ae)]();const _0x4586e6=[];_0x59de3b[_0x32c011(0x1b3)](_0x2def81=>{const _0x305281=_0x32c011;_0x4586e6[_0x305281(0x196)](_0x2def81+'='+_0x82e6d[_0x2def81]);}),_0x4586e6[_0x32c011(0x196)]('key='+_0x396d89);const _0x5deb18=_0x4586e6[_0x32c011(0x1a7)]('&');return crypto['createHash'](_0x32c011(0x1d9))[_0x32c011(0x172)](_0x5deb18)['digest'](_0x32c011(0x239))[_0x32c011(0x1e1)]();}async[_0x3caa8b(0x1f9)](_0x4ed1f4,_0x4371d7,_0xf92f9a='wxpay'){const _0x390d82=_0x3caa8b,_0x384538=await this['orderEntity'][_0x390d82(0x1ca)]({'where':{'userId':_0x4ed1f4,'orderId':_0x4371d7}});if(!_0x384538)throw new common_1['HttpException'](_0x390d82(0x1d3),common_1[_0x390d82(0x1aa)]['BAD_REQUEST']);const _0x4b1a27=await this[_0x390d82(0x200)][_0x390d82(0x1ca)]({'where':{'id':_0x384538[_0x390d82(0x22b)]}});if(!_0x4b1a27)throw new common_1['HttpException'](_0x390d82(0x23e),common_1[_0x390d82(0x1aa)][_0x390d82(0x1eb)]);const {payLtzfMchId:_0x961868,payLtzfSecret:_0x5010b0,payLtzfNotifyUrl:_0xd48b4c,payLtzfReturnUrl:_0x5a853f}=await this['globalConfigService'][_0x390d82(0x22d)]([_0x390d82(0x173),_0x390d82(0x234),_0x390d82(0x19f),'payLtzfReturnUrl']),_0x469e44={};_0x469e44['mch_id']=_0x961868,_0x469e44[_0x390d82(0x198)]=(Date[_0x390d82(0x1ab)]()/0x3e8)[_0x390d82(0x22e)](0x0),_0x469e44[_0x390d82(0x19a)]=_0x4371d7,_0x469e44[_0x390d82(0x1d1)]=_0x4b1a27[_0x390d82(0x197)],_0x469e44[_0x390d82(0x1b5)]=_0x384538[_0x390d82(0x185)],_0x469e44[_0x390d82(0x18b)]=_0xd48b4c,_0x469e44['sign']=this[_0x390d82(0x174)](_0x469e44,_0x5010b0),_0x469e44[_0x390d82(0x1a6)]=_0x390d82(0x20e),_0x469e44['return_url']=_0x5a853f;const _0x14c259=Object[_0x390d82(0x21a)](_0x469e44)[_0x390d82(0x1b3)](_0x279305=>encodeURIComponent(_0x279305)+'='+encodeURIComponent(_0x469e44[_0x279305]))['join']('&'),_0x4f4660={'headers':{'Content-Type':_0x390d82(0x177)}},_0x308e14=await axios_1[_0x390d82(0x21b)][_0x390d82(0x1af)](_0x390d82(0x1d2),_0x14c259,_0x4f4660),{code:_0x11ed98,data:_0x452ebc,msg:_0xe0f1d7}=_0x308e14[_0x390d82(0x219)];if(_0x11ed98!=0x0)throw new common_1[(_0x390d82(0x17e))](_0xe0f1d7,common_1[_0x390d82(0x1aa)][_0x390d82(0x1eb)]);const _0x583ad2=_0x452ebc[_0x390d82(0x1cf)],_0xe7847=_0x452ebc['order_url'];return{'url_qrcode':_0x583ad2,'url':_0xe7847};}async[_0x3caa8b(0x1d7)](_0x513b4d){const _0x343ea8=_0x3caa8b,{payLtzfMchId:_0x434f8b,payLtzfSecret:_0x28d79c}=await this[_0x343ea8(0x186)][_0x343ea8(0x22d)]([_0x343ea8(0x173),_0x343ea8(0x234)]),_0x23352a={};_0x23352a['mch_id']=_0x434f8b,_0x23352a[_0x343ea8(0x198)]=(Date[_0x343ea8(0x1ab)]()/0x3e8)['toFixed'](0x0),_0x23352a[_0x343ea8(0x19a)]=_0x513b4d,_0x23352a[_0x343ea8(0x181)]=this['ltzfSign'](_0x23352a,_0x28d79c);const _0x42a1e3=Object[_0x343ea8(0x21a)](_0x23352a)[_0x343ea8(0x1b3)](_0x1c8b67=>encodeURIComponent(_0x1c8b67)+'='+encodeURIComponent(_0x23352a[_0x1c8b67]))['join']('&'),_0x40ae4e={'headers':{'Content-Type':_0x343ea8(0x177)}},{data:{code:_0x304eb8,msg:_0xd27d06,data:_0x3b5a8c}}=await axios_1['default'][_0x343ea8(0x1af)](_0x343ea8(0x1d4),_0x42a1e3,_0x40ae4e);if(_0x304eb8!=0x0)throw new common_1[(_0x343ea8(0x17e))](_0xd27d06+JSON[_0x343ea8(0x1da)](_0x23352a),common_1[_0x343ea8(0x1aa)][_0x343ea8(0x1eb)]);return _0x3b5a8c;}async[_0x3caa8b(0x23a)](_0x345d2f){const _0xb4eafe=_0x3caa8b,_0x5a40b8=await this[_0xb4eafe(0x186)][_0xb4eafe(0x22d)](['payLtzfSecret']),_0xf78113=_0x345d2f[_0xb4eafe(0x181)];delete _0x345d2f[_0xb4eafe(0x181)],delete _0x345d2f[_0xb4eafe(0x1db)],delete _0x345d2f['trade_type'],delete _0x345d2f['success_time'],delete _0x345d2f[_0xb4eafe(0x1a6)],delete _0x345d2f[_0xb4eafe(0x208)];if(this[_0xb4eafe(0x174)](_0x345d2f,_0x5a40b8)!=_0xf78113)return _0xb4eafe(0x204);const _0x484994=await this[_0xb4eafe(0x213)][_0xb4eafe(0x1ca)]({'where':{'orderId':_0x345d2f['out_trade_no'],'status':0x0}});if(!_0x484994)return _0xb4eafe(0x204);await this[_0xb4eafe(0x1b7)][_0xb4eafe(0x1ed)](_0x484994);const _0x50e8e6=await this[_0xb4eafe(0x213)][_0xb4eafe(0x172)]({'orderId':_0x345d2f[_0xb4eafe(0x19a)]},{'status':0x1,'paydAt':new Date()});if(_0x50e8e6['affected']!=0x1)return'FAIL';return _0xb4eafe(0x1f0);}};PayService=__decorate([(0x0,common_1[_0x3caa8b(0x1e0)])(),__param(0x0,(0x0,typeorm_1[_0x3caa8b(0x1ec)])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x1,(0x0,typeorm_1[_0x3caa8b(0x1ec)])(order_entity_1['OrderEntity'])),__metadata(_0x3caa8b(0x215),[typeorm_2[_0x3caa8b(0x22c)],typeorm_2[_0x3caa8b(0x22c)],userBalance_service_1[_0x3caa8b(0x19c)],globalConfig_service_1['GlobalConfigService'],user_service_1[_0x3caa8b(0x1a4)]])],PayService),exports[_0x3caa8b(0x178)]=PayService;