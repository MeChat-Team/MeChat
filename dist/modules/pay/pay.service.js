'use strict';const _0x5be7b3=_0x38d5;(function(_0x55695a,_0x3127b9){const _0x5cf18a=_0x38d5,_0x2cbfac=_0x55695a();while(!![]){try{const _0x9aabaa=parseInt(_0x5cf18a(0x15d))/0x1+parseInt(_0x5cf18a(0x1a6))/0x2*(parseInt(_0x5cf18a(0x198))/0x3)+-parseInt(_0x5cf18a(0x185))/0x4+-parseInt(_0x5cf18a(0x20b))/0x5*(-parseInt(_0x5cf18a(0x1bf))/0x6)+parseInt(_0x5cf18a(0x191))/0x7+-parseInt(_0x5cf18a(0x177))/0x8+parseInt(_0x5cf18a(0x215))/0x9*(parseInt(_0x5cf18a(0x1b5))/0xa);if(_0x9aabaa===_0x3127b9)break;else _0x2cbfac['push'](_0x2cbfac['shift']());}catch(_0x123215){_0x2cbfac['push'](_0x2cbfac['shift']());}}}(_0x4625,0x46ed7));var __decorate=this&&this[_0x5be7b3(0x189)]||function(_0x132e1d,_0x18ca74,_0x580444,_0xf0182e){const _0x236094=_0x5be7b3;var _0x2d2b85=arguments[_0x236094(0x188)],_0x36c051=_0x2d2b85<0x3?_0x18ca74:_0xf0182e===null?_0xf0182e=Object[_0x236094(0x169)](_0x18ca74,_0x580444):_0xf0182e,_0x2fc07f;if(typeof Reflect===_0x236094(0x19c)&&typeof Reflect[_0x236094(0x1c5)]==='function')_0x36c051=Reflect[_0x236094(0x1c5)](_0x132e1d,_0x18ca74,_0x580444,_0xf0182e);else{for(var _0x3f400a=_0x132e1d[_0x236094(0x188)]-0x1;_0x3f400a>=0x0;_0x3f400a--)if(_0x2fc07f=_0x132e1d[_0x3f400a])_0x36c051=(_0x2d2b85<0x3?_0x2fc07f(_0x36c051):_0x2d2b85>0x3?_0x2fc07f(_0x18ca74,_0x580444,_0x36c051):_0x2fc07f(_0x18ca74,_0x580444))||_0x36c051;}return _0x2d2b85>0x3&&_0x36c051&&Object['defineProperty'](_0x18ca74,_0x580444,_0x36c051),_0x36c051;},__metadata=this&&this['__metadata']||function(_0x5b8f10,_0x2c4973){const _0x42277c=_0x5be7b3;if(typeof Reflect==='object'&&typeof Reflect[_0x42277c(0x218)]===_0x42277c(0x18c))return Reflect[_0x42277c(0x218)](_0x5b8f10,_0x2c4973);},__param=this&&this['__param']||function(_0x46886f,_0x912498){return function(_0x570959,_0xf745b6){_0x912498(_0x570959,_0xf745b6,_0x46886f);};};function _0x38d5(_0x41a65f,_0x2381a8){const _0x462557=_0x4625();return _0x38d5=function(_0x38d5f6,_0x2c7ed9){_0x38d5f6=_0x38d5f6-0x152;let _0x9f9c4d=_0x462557[_0x38d5f6];return _0x9f9c4d;},_0x38d5(_0x41a65f,_0x2381a8);}Object['defineProperty'](exports,_0x5be7b3(0x213),{'value':!![]}),exports['PayService']=void 0x0;const utils_1=require(_0x5be7b3(0x1e1)),common_1=require('@nestjs/common'),typeorm_1=require('@nestjs/typeorm'),axios_1=require(_0x5be7b3(0x1ab)),crypto=require(_0x5be7b3(0x19a)),typeorm_2=require(_0x5be7b3(0x157)),cramiPackage_entity_1=require(_0x5be7b3(0x181)),globalConfig_service_1=require(_0x5be7b3(0x199)),order_entity_1=require(_0x5be7b3(0x1b4)),user_service_1=require(_0x5be7b3(0x20e)),userBalance_service_1=require(_0x5be7b3(0x194));let PayService=class PayService{constructor(_0x10a158,_0x435f8c,_0x28bab6,_0x6a5f9e,_0x246d21){const _0x50c7b7=_0x5be7b3;this['cramiPackageEntity']=_0x10a158,this[_0x50c7b7(0x170)]=_0x435f8c,this[_0x50c7b7(0x1a8)]=_0x28bab6,this[_0x50c7b7(0x1f3)]=_0x6a5f9e,this[_0x50c7b7(0x171)]=_0x246d21;}async['onModuleInit'](){const _0x175aca=_0x5be7b3,_0x133a40=await(0x0,utils_1[_0x175aca(0x15e)])(_0x175aca(0x201));this['WxPay']=(_0x133a40===null||_0x133a40===void 0x0?void 0x0:_0x133a40[_0x175aca(0x16e)])?_0x133a40[_0x175aca(0x16e)]:_0x133a40;}async[_0x5be7b3(0x161)](_0xaf270a){const _0x491374=_0x5be7b3;if(_0xaf270a[_0x491374(0x209)]==_0x491374(0x166))return this[_0x491374(0x18d)](_0xaf270a);if(_0xaf270a[_0x491374(0x1f9)]=='hupi')return this[_0x491374(0x19b)](_0xaf270a);if(_0xaf270a[_0x491374(0x1f9)]==_0x491374(0x1ae))return this['notifyLtzf'](_0xaf270a);if(typeof _0xaf270a[_0x491374(0x163)]==_0x491374(0x19c))return this[_0x491374(0x17e)](_0xaf270a);return this[_0x491374(0x16b)](_0xaf270a);}async['pay'](_0x722ebd,_0x2d5d9c,_0x4017fd=_0x5be7b3(0x21f)){const _0x2f5016=_0x5be7b3,_0x1b06c9=await this['orderEntity'][_0x2f5016(0x1ac)]({'where':{'userId':_0x722ebd,'orderId':_0x2d5d9c}});if(!_0x1b06c9)throw new common_1[(_0x2f5016(0x1bb))](_0x2f5016(0x1f4),common_1['HttpStatus']['BAD_REQUEST']);const _0xb5c837=await this[_0x2f5016(0x1b8)][_0x2f5016(0x1ac)]({'where':{'id':_0x1b06c9[_0x2f5016(0x1e9)]}});if(!_0xb5c837)throw new common_1[(_0x2f5016(0x1bb))](_0x2f5016(0x1d0),common_1['HttpStatus'][_0x2f5016(0x206)]);common_1[_0x2f5016(0x1c6)][_0x2f5016(0x1c3)](_0x2f5016(0x19d),_0x1b06c9[_0x2f5016(0x21c)]);try{if(_0x1b06c9[_0x2f5016(0x21c)]==_0x2f5016(0x1af))return this[_0x2f5016(0x1a3)](_0x722ebd,_0x2d5d9c,_0x4017fd);if(_0x1b06c9[_0x2f5016(0x21c)]==_0x2f5016(0x166))return this[_0x2f5016(0x207)](_0x722ebd,_0x2d5d9c,_0x4017fd);if(_0x1b06c9[_0x2f5016(0x21c)]==_0x2f5016(0x1a7))return this[_0x2f5016(0x1fd)](_0x722ebd,_0x2d5d9c,_0x4017fd);if(_0x1b06c9[_0x2f5016(0x21c)]==_0x2f5016(0x1a2))return this[_0x2f5016(0x154)](_0x722ebd,_0x2d5d9c,_0x4017fd);if(_0x1b06c9['payPlatform']=='ltzf')return this[_0x2f5016(0x18b)](_0x722ebd,_0x2d5d9c,_0x4017fd);}catch(_0x18543e){common_1[_0x2f5016(0x1c6)][_0x2f5016(0x1c3)]('支付请求失败:\x20',_0x18543e);throw new common_1[(_0x2f5016(0x1bb))](_0x2f5016(0x1fb),common_1[_0x2f5016(0x20d)][_0x2f5016(0x206)]);}}async[_0x5be7b3(0x18a)](_0x13904d){const _0xc7c86=_0x5be7b3,_0x5d0549=await this[_0xc7c86(0x170)]['findOne']({'where':{'orderId':_0x13904d}});if(!_0x5d0549)throw new common_1[(_0xc7c86(0x1bb))](_0xc7c86(0x1f4),common_1[_0xc7c86(0x20d)][_0xc7c86(0x206)]);return _0x5d0549;}async[_0x5be7b3(0x19b)](_0x119ec9){const _0x1fdc4a=_0x5be7b3,_0x304957=await this[_0x1fdc4a(0x1f3)][_0x1fdc4a(0x153)]([_0x1fdc4a(0x17b)]),_0x132291=_0x119ec9[_0x1fdc4a(0x1d3)];delete _0x119ec9['hash'];if(this[_0x1fdc4a(0x17c)](_0x119ec9,_0x304957)!=_0x132291)return'failed';const _0xe1cf7e=await this[_0x1fdc4a(0x170)][_0x1fdc4a(0x1ac)]({'where':{'orderId':_0x119ec9['trade_order_id'],'status':0x0}});if(!_0xe1cf7e)return _0x1fdc4a(0x1ec);await this[_0x1fdc4a(0x1a8)][_0x1fdc4a(0x1b2)](_0xe1cf7e);const _0x114bca=await this[_0x1fdc4a(0x170)]['update']({'orderId':_0x119ec9['trade_order_id']},{'status':0x1,'paydAt':new Date()});if(_0x114bca[_0x1fdc4a(0x1e5)]!=0x1)return _0x1fdc4a(0x1ec);return _0x1fdc4a(0x1bc);}async['payHupi'](_0x126d60,_0x1d07a5,_0x59dc40='wxpay'){const _0x4c2e3e=_0x5be7b3,_0x3151c8=await this[_0x4c2e3e(0x170)][_0x4c2e3e(0x1ac)]({'where':{'userId':_0x126d60,'orderId':_0x1d07a5}});if(!_0x3151c8)throw new common_1[(_0x4c2e3e(0x1bb))](_0x4c2e3e(0x1f4),common_1[_0x4c2e3e(0x20d)]['BAD_REQUEST']);const _0x3b4161=await this[_0x4c2e3e(0x1b8)][_0x4c2e3e(0x1ac)]({'where':{'id':_0x3151c8[_0x4c2e3e(0x1e9)]}});if(!_0x3b4161)throw new common_1[(_0x4c2e3e(0x1bb))](_0x4c2e3e(0x1d0),common_1['HttpStatus'][_0x4c2e3e(0x206)]);const {payHupiAppId:_0x214b6a,payHupiSecret:_0x3b8997,payHupiNotifyUrl:_0x532a56,payHupiReturnUrl:_0x3839c1,payHupiGatewayUrl:_0x3f1eb7}=await this[_0x4c2e3e(0x1f3)][_0x4c2e3e(0x153)]([_0x4c2e3e(0x187),'payHupiSecret',_0x4c2e3e(0x1f8),_0x4c2e3e(0x156),'payHupiGatewayUrl']),_0x4ea21f={};_0x4ea21f[_0x4c2e3e(0x200)]=_0x4c2e3e(0x205),_0x4ea21f[_0x4c2e3e(0x162)]=_0x214b6a,_0x4ea21f[_0x4c2e3e(0x1b7)]=(Date[_0x4c2e3e(0x168)]()/0x3e8)[_0x4c2e3e(0x183)](0x0),_0x4ea21f[_0x4c2e3e(0x217)]=(0x0,utils_1[_0x4c2e3e(0x20a)])(0x20),_0x4ea21f[_0x4c2e3e(0x1b3)]=_0x1d07a5,_0x4ea21f[_0x4c2e3e(0x16f)]=_0x3b4161[_0x4c2e3e(0x1fa)],_0x4ea21f[_0x4c2e3e(0x1e4)]=_0x3151c8[_0x4c2e3e(0x182)],_0x4ea21f[_0x4c2e3e(0x18e)]=_0x532a56,_0x4ea21f['return_url']=_0x3839c1,_0x4ea21f[_0x4c2e3e(0x1f9)]=_0x4c2e3e(0x1a2),_0x4ea21f[_0x4c2e3e(0x1d3)]=this['sign'](_0x4ea21f,_0x3b8997);const {data:{errcode:_0x44a546,errmsg:_0x43ad6e,url_qrcode:_0x3c000f,url:_0x21dec3}}=await axios_1[_0x4c2e3e(0x16e)]['post'](_0x3f1eb7||_0x4c2e3e(0x15c),_0x4ea21f);if(_0x44a546!=0x0)throw new common_1['HttpException'](_0x43ad6e,common_1[_0x4c2e3e(0x20d)][_0x4c2e3e(0x206)]);return{'url_qrcode':_0x3c000f,'url':_0x21dec3};}async[_0x5be7b3(0x1e8)](_0x111b4){const _0x4b308f=_0x5be7b3,{payHupiAppId:_0x1b531b,payHupiSecret:_0x432502}=await this[_0x4b308f(0x1f3)][_0x4b308f(0x153)]([_0x4b308f(0x187),'payHupiSecret']),_0x23032c={};_0x23032c['version']='1.1',_0x23032c[_0x4b308f(0x162)]=_0x1b531b,_0x23032c[_0x4b308f(0x1b7)]=(Date[_0x4b308f(0x168)]()/0x3e8)['toFixed'](0x0),_0x23032c['nonce_str']=(0x0,utils_1[_0x4b308f(0x20a)])(0x20),_0x23032c['out_trade_order']=_0x111b4,_0x23032c[_0x4b308f(0x1d3)]=this[_0x4b308f(0x17c)](_0x23032c,_0x432502);const {data:{errcode:_0x89040f,errmsg:_0x39316c,data:_0x1e9add}}=await axios_1[_0x4b308f(0x16e)][_0x4b308f(0x19e)](_0x4b308f(0x1c0),_0x23032c);if(_0x89040f!=0x0)throw new common_1[(_0x4b308f(0x1bb))](_0x39316c,common_1[_0x4b308f(0x20d)]['BAD_REQUEST']);return _0x1e9add;}async[_0x5be7b3(0x18d)](_0x5a2b91){const _0x54d83a=_0x5be7b3,_0x2102c7=_0x5a2b91[_0x54d83a(0x17c)];delete _0x5a2b91['sign'],delete _0x5a2b91[_0x54d83a(0x164)];const _0x1ff7b5=await this[_0x54d83a(0x1f3)][_0x54d83a(0x153)]([_0x54d83a(0x17f)]);if(this[_0x54d83a(0x17c)](_0x5a2b91,_0x1ff7b5)!=_0x2102c7)return _0x54d83a(0x1ec);common_1[_0x54d83a(0x1c6)]['log'](_0x54d83a(0x186));const _0x7ea27b=await this['orderEntity'][_0x54d83a(0x1ac)]({'where':{'orderId':_0x5a2b91['out_trade_no'],'status':0x0}});if(!_0x7ea27b)return _0x54d83a(0x1ec);const _0x334485=_0x5a2b91[_0x54d83a(0x210)]==_0x54d83a(0x1a5)?0x1:0x2,_0x1bc0fe=await this[_0x54d83a(0x170)][_0x54d83a(0x179)]({'orderId':_0x5a2b91['out_trade_no']},{'status':_0x334485,'paydAt':new Date()});_0x334485===0x1&&await this[_0x54d83a(0x1a8)][_0x54d83a(0x1b2)](_0x7ea27b);if(_0x1bc0fe['affected']!=0x1)return'failed';return _0x54d83a(0x1bc);}async[_0x5be7b3(0x207)](_0x4155c8,_0x4d8b5d,_0x2eb404=_0x5be7b3(0x184)){const _0x328af8=_0x5be7b3,_0x35b801=await this[_0x328af8(0x170)][_0x328af8(0x1ac)]({'where':{'userId':_0x4155c8,'orderId':_0x4d8b5d}});if(!_0x35b801)throw new common_1[(_0x328af8(0x1bb))](_0x328af8(0x1f4),common_1['HttpStatus'][_0x328af8(0x206)]);const _0x557f80=await this['cramiPackageEntity'][_0x328af8(0x1ac)]({'where':{'id':_0x35b801['goodsId']}});if(!_0x557f80)throw new common_1[(_0x328af8(0x1bb))]('套餐不存在!',common_1[_0x328af8(0x20d)][_0x328af8(0x206)]);const {payEpayPid:_0x5ca48a,payEpaySecret:_0x2e063a,payEpayNotifyUrl:_0x566bc8,payEpayReturnUrl:_0x30dfa0,payEpayApiPayUrl:_0x39e4bf}=await this['globalConfigService'][_0x328af8(0x153)]([_0x328af8(0x1d5),_0x328af8(0x17f),_0x328af8(0x176),'payEpayReturnUrl',_0x328af8(0x16c)]);let _0x4c1531;_0x5ca48a[_0x328af8(0x188)]<=0x10?_0x4c1531=Number(_0x5ca48a):_0x4c1531=BigInt(_0x5ca48a);const _0x5de3d9={};_0x5de3d9[_0x328af8(0x1e2)]=_0x4c1531,_0x5de3d9[_0x328af8(0x216)]=_0x2eb404,_0x5de3d9['out_trade_no']=_0x4d8b5d,_0x5de3d9[_0x328af8(0x1fa)]=_0x557f80[_0x328af8(0x1fa)],_0x5de3d9[_0x328af8(0x1d7)]=_0x35b801['total'],_0x5de3d9[_0x328af8(0x1db)]=_0x328af8(0x1eb),_0x5de3d9['device']='pc',_0x5de3d9['notify_url']=_0x566bc8,_0x5de3d9[_0x328af8(0x180)]=_0x30dfa0,_0x5de3d9['param']='epay',_0x5de3d9[_0x328af8(0x17c)]=this['sign'](_0x5de3d9,_0x2e063a),_0x5de3d9[_0x328af8(0x164)]=_0x328af8(0x196);const _0x4864c1=new URLSearchParams(_0x5de3d9)[_0x328af8(0x1d6)](),_0x536504=_0x39e4bf+'?'+_0x4864c1;if(_0x39e4bf[_0x328af8(0x159)](_0x328af8(0x1ff)))return{'url_qrcode':null,'redirectUrl':_0x536504,'channel':_0x2eb404,'isRedirect':!![]};else{const _0x500f7e={'headers':{'Content-Type':'application/x-www-form-urlencoded'}},_0x27729a=await axios_1['default'][_0x328af8(0x19e)](_0x39e4bf,_0x5de3d9,_0x500f7e);common_1[_0x328af8(0x1c6)]['log']('epay\x20--->\x20res:\x20',_0x27729a[_0x328af8(0x1d1)]);const {data:{code:_0x3f2511,msg:_0x47b835,qrcode:_0x261edc}}=_0x27729a;if(_0x3f2511!=0x1)throw new common_1[(_0x328af8(0x1bb))](_0x47b835,common_1[_0x328af8(0x20d)][_0x328af8(0x206)]);return{'url_qrcode':_0x261edc,'redirectUrl':null,'channel':_0x2eb404,'isRedirect':![]};}}async[_0x5be7b3(0x160)](_0x205225){const _0x55fac2=_0x5be7b3,{payEpayPid:_0x55a703,payEpaySecret:_0x428cf0,payEpayApiQueryUrl:_0x523348}=await this['globalConfigService'][_0x55fac2(0x153)](['payEpayPid',_0x55fac2(0x17f),_0x55fac2(0x195)]),_0x3ba281={};_0x3ba281['act']='order',_0x3ba281[_0x55fac2(0x1c7)]=_0x205225,_0x3ba281[_0x55fac2(0x1e2)]=_0x55a703,_0x3ba281[_0x55fac2(0x1cb)]=_0x428cf0;const {data:{code:_0x54f52f,msg:_0xa9e724,data:_0xd23a47}}=await axios_1[_0x55fac2(0x16e)][_0x55fac2(0x1e7)](_0x523348,{'params':_0x3ba281});if(_0x54f52f!=0x1)throw new common_1[(_0x55fac2(0x1bb))](_0xa9e724,common_1[_0x55fac2(0x20d)][_0x55fac2(0x206)]);return _0xd23a47;}async['notifyMpay'](_0x1f8afa){const _0x5cf7ec=_0x5be7b3,_0x275048=_0x1f8afa[_0x5cf7ec(0x17c)];delete _0x1f8afa[_0x5cf7ec(0x17c)],delete _0x1f8afa['sign_type'];const _0x576309=await this['globalConfigService'][_0x5cf7ec(0x153)](['payMpaySecret']);common_1[_0x5cf7ec(0x1c6)][_0x5cf7ec(0x1c3)](_0x5cf7ec(0x1da));if(this[_0x5cf7ec(0x17c)](_0x1f8afa,_0x576309)!=_0x275048)return _0x5cf7ec(0x1ec);common_1[_0x5cf7ec(0x1c6)][_0x5cf7ec(0x1c3)]('校验签名通过');const _0x338c78=await this['orderEntity'][_0x5cf7ec(0x1ac)]({'where':{'orderId':_0x1f8afa[_0x5cf7ec(0x1c7)],'status':0x0}});if(!_0x338c78)return _0x5cf7ec(0x1ec);const _0x35cc45=_0x1f8afa['trade_status']=='TRADE_SUCCESS'?0x1:0x2;common_1[_0x5cf7ec(0x1c6)][_0x5cf7ec(0x1c3)](_0x5cf7ec(0x1f2),_0x35cc45);const _0x2d867c=await this[_0x5cf7ec(0x170)]['update']({'orderId':_0x1f8afa[_0x5cf7ec(0x1c7)]},{'status':_0x35cc45,'paydAt':new Date()});_0x35cc45===0x1&&await this[_0x5cf7ec(0x1a8)][_0x5cf7ec(0x1b2)](_0x338c78);if(_0x2d867c[_0x5cf7ec(0x1e5)]!=0x1)return _0x5cf7ec(0x1ec);return _0x5cf7ec(0x1bc);}async[_0x5be7b3(0x1fd)](_0x47aa5a,_0x302a10,_0x3569fb=_0x5be7b3(0x21f)){const _0x335b33=_0x5be7b3,_0x21f7b5=await this['orderEntity'][_0x335b33(0x1ac)]({'where':{'userId':_0x47aa5a,'orderId':_0x302a10}});if(!_0x21f7b5)throw new common_1[(_0x335b33(0x1bb))](_0x335b33(0x1f4),common_1['HttpStatus']['BAD_REQUEST']);const _0x5e7f79=await this[_0x335b33(0x1b8)]['findOne']({'where':{'id':_0x21f7b5[_0x335b33(0x1e9)]}});if(!_0x5e7f79)throw new common_1['HttpException'](_0x335b33(0x1d0),common_1[_0x335b33(0x20d)]['BAD_REQUEST']);const {payMpayPid:_0x277c8c,payMpaySecret:_0x734fc2,payMpayNotifyUrl:_0x276931,payMpayReturnUrl:_0x28081a,payMpayApiPayUrl:_0x366a0f}=await this[_0x335b33(0x1f3)][_0x335b33(0x153)]([_0x335b33(0x1f6),_0x335b33(0x1b0),_0x335b33(0x1be),'payMpayReturnUrl','payMpayApiPayUrl']),_0x24e284={};_0x24e284[_0x335b33(0x1e2)]=Number(_0x277c8c),_0x24e284[_0x335b33(0x216)]=_0x3569fb,_0x24e284[_0x335b33(0x1c7)]=_0x302a10,_0x24e284[_0x335b33(0x1fa)]=_0x5e7f79[_0x335b33(0x1fa)],_0x24e284[_0x335b33(0x1d7)]=_0x21f7b5[_0x335b33(0x182)],_0x24e284[_0x335b33(0x18e)]=_0x276931,_0x24e284['return_url']=_0x28081a,_0x24e284[_0x335b33(0x17c)]=this['sign'](_0x24e284,_0x734fc2),_0x24e284[_0x335b33(0x164)]=_0x335b33(0x196);const _0x811f55=new URLSearchParams(_0x24e284)['toString'](),_0x42418f=_0x366a0f+'?'+_0x811f55;return{'url_qrcode':null,'redirectUrl':_0x42418f,'channel':_0x3569fb,'isRedirect':!![]};const _0x484cdf=await axios_1[_0x335b33(0x16e)][_0x335b33(0x1e7)](_0x366a0f,{'params':_0x24e284});}async[_0x5be7b3(0x158)](_0x4a3676){const _0x4eef54=_0x5be7b3,{payMpayApiQueryUrl:_0x26fc04}=await this['globalConfigService'][_0x4eef54(0x153)]([_0x4eef54(0x1f6),'payMpaySecret',_0x4eef54(0x202)]),_0x2e3d6d={};_0x2e3d6d[_0x4eef54(0x216)]=0x2,_0x2e3d6d[_0x4eef54(0x21a)]=_0x4a3676;const {data:{code:_0xa1cb7e,msg:_0x104d5e,data:_0x5c2db1}}=await axios_1[_0x4eef54(0x16e)][_0x4eef54(0x1e7)](_0x26fc04,{'params':_0x2e3d6d});if(_0xa1cb7e!=0x1)throw new common_1[(_0x4eef54(0x1bb))](_0x104d5e,common_1[_0x4eef54(0x20d)]['BAD_REQUEST']);return _0x5c2db1;}async['notifyWeChat'](_0x285387){const _0x5f3b5d=_0x5be7b3;common_1[_0x5f3b5d(0x1c6)][_0x5f3b5d(0x1c3)]('微信支付通知params:\x20',_0x285387);const {payWeChatAppId:_0x14f81a,payWeChatMchId:_0x326ae4,payWeChatSecret:_0x4addf7,payWeChatPublicKey:_0x46c8c9,payWeChatPrivateKey:_0x5862b7}=await this[_0x5f3b5d(0x1f3)][_0x5f3b5d(0x153)](['payWeChatAppId',_0x5f3b5d(0x193),_0x5f3b5d(0x1c8),_0x5f3b5d(0x1b6),_0x5f3b5d(0x190)]),_0x200d4b=new this[(_0x5f3b5d(0x20f))]({'appid':_0x14f81a,'mchid':_0x326ae4,'publicKey':_0x46c8c9,'privateKey':_0x5862b7});try{if(_0x285387[_0x5f3b5d(0x1cf)]=='TRANSACTION.SUCCESS'){const {ciphertext:_0x2de14e,associated_data:_0x317aad,nonce:_0x5ca2e5}=_0x285387[_0x5f3b5d(0x163)],_0x58f642=_0x200d4b[_0x5f3b5d(0x219)](_0x2de14e,_0x317aad,_0x5ca2e5,_0x4addf7),_0x1b42df=await this[_0x5f3b5d(0x170)][_0x5f3b5d(0x1ac)]({'where':{'orderId':_0x58f642[_0x5f3b5d(0x1c7)],'status':0x0}});if(!_0x1b42df)return _0x5f3b5d(0x1ec);const _0x5af2f9=_0x58f642['trade_state']=='SUCCESS'?0x1:0x2,_0x284558=await this[_0x5f3b5d(0x170)][_0x5f3b5d(0x179)]({'orderId':_0x58f642[_0x5f3b5d(0x1c7)]},{'status':_0x5af2f9,'paydAt':new Date()});_0x5af2f9===0x1&&await this[_0x5f3b5d(0x1a8)][_0x5f3b5d(0x1b2)](_0x1b42df);if(_0x284558[_0x5f3b5d(0x1e5)]!=0x1)return _0x5f3b5d(0x1ec);}return _0x5f3b5d(0x1bc);}catch(_0x5d5233){return common_1['Logger']['log']('error:\x20',_0x5d5233),common_1[_0x5f3b5d(0x1c6)][_0x5f3b5d(0x1c3)]('支付通知验证失败:\x20',_0x5d5233),_0x5f3b5d(0x1ec);}}async['payWeChat'](_0x2bcf6d,_0x52da14,_0x277edb=_0x5be7b3(0x165)){const _0x388a81=_0x5be7b3;var _0x2777e8,_0x4fa858,_0x51645f,_0xd16cd4,_0x5d445d,_0x62734b,_0x599a5b;common_1['Logger']['log'](_0x388a81(0x16a),_0x277edb);const _0x2db462=await this[_0x388a81(0x170)][_0x388a81(0x1ac)]({'where':{'userId':_0x2bcf6d,'orderId':_0x52da14}});if(!_0x2db462)throw new common_1[(_0x388a81(0x1bb))](_0x388a81(0x1f4),common_1[_0x388a81(0x20d)][_0x388a81(0x206)]);const _0x10f140=await this['cramiPackageEntity'][_0x388a81(0x1ac)]({'where':{'id':_0x2db462[_0x388a81(0x1e9)]}});if(!_0x10f140)throw new common_1[(_0x388a81(0x1bb))]('套餐不存在!',common_1['HttpStatus'][_0x388a81(0x206)]);const {payWeChatAppId:_0xbcbe73,payWeChatMchId:_0x49108e,payWeChatPublicKey:_0x1c3809,payWeChatPrivateKey:_0x267993,payWeChatNotifyUrl:_0x2ee6f1}=await this[_0x388a81(0x1f3)][_0x388a81(0x153)]([_0x388a81(0x1ce),_0x388a81(0x193),'payWeChatPublicKey',_0x388a81(0x190),_0x388a81(0x1cc)]),_0xe4444e=new this[(_0x388a81(0x20f))]({'appid':_0xbcbe73,'mchid':_0x49108e,'publicKey':_0x1c3809,'privateKey':_0x267993}),_0x2fb596={'appid':_0xbcbe73,'mchid':_0x49108e,'description':_0x10f140[_0x388a81(0x1fa)],'out_trade_no':_0x52da14,'notify_url':_0x2ee6f1,'amount':{'total':Math['round'](_0x2db462[_0x388a81(0x182)]*0x64)}};common_1['Logger'][_0x388a81(0x1c3)]('wechat-pay:\x20',_0x2fb596);if(_0x277edb=='jsapi'){common_1[_0x388a81(0x1c6)][_0x388a81(0x1c3)](_0x388a81(0x1f7)+_0x2bcf6d+',\x20订单ID:\x20'+_0x52da14);const _0x5f6f3a=await this['userService'][_0x388a81(0x18f)](_0x2bcf6d);common_1[_0x388a81(0x1c6)][_0x388a81(0x1c3)](_0x388a81(0x1d2)+_0x5f6f3a),_0x2fb596[_0x388a81(0x15f)]={'openid':_0x5f6f3a},common_1[_0x388a81(0x1c6)][_0x388a81(0x1c3)]('[WeChat\x20Pay\x20JSAPI]\x20发送支付请求参数:\x20',JSON[_0x388a81(0x174)](_0x2fb596,null,0x2));try{const _0x4894b2=await _0xe4444e[_0x388a81(0x221)](_0x2fb596),_0x2e8e11=_0x4894b2[_0x388a81(0x1d1)]?_0x4894b2[_0x388a81(0x1d1)]:_0x4894b2;return common_1[_0x388a81(0x1c6)][_0x388a81(0x1c3)](_0x388a81(0x1ba),JSON[_0x388a81(0x174)](_0x2e8e11,null,0x2)),{'status':_0x4894b2['status']||_0x388a81(0x1cd),'appId':_0x2e8e11[_0x388a81(0x1c1)]||((_0x2777e8=_0x2e8e11[_0x388a81(0x1d1)])===null||_0x2777e8===void 0x0?void 0x0:_0x2777e8[_0x388a81(0x1c1)]),'timeStamp':_0x2e8e11[_0x388a81(0x1f1)]||((_0x4fa858=_0x2e8e11[_0x388a81(0x1d1)])===null||_0x4fa858===void 0x0?void 0x0:_0x4fa858['timeStamp']),'nonceStr':_0x2e8e11[_0x388a81(0x203)]||((_0x51645f=_0x2e8e11[_0x388a81(0x1d1)])===null||_0x51645f===void 0x0?void 0x0:_0x51645f['nonceStr']),'package':_0x2e8e11['package']||((_0xd16cd4=_0x2e8e11[_0x388a81(0x1d1)])===null||_0xd16cd4===void 0x0?void 0x0:_0xd16cd4['package']),'signType':_0x2e8e11[_0x388a81(0x1a9)]||((_0x5d445d=_0x2e8e11[_0x388a81(0x1d1)])===null||_0x5d445d===void 0x0?void 0x0:_0x5d445d[_0x388a81(0x1a9)]),'paySign':_0x2e8e11[_0x388a81(0x204)]||((_0x62734b=_0x2e8e11['data'])===null||_0x62734b===void 0x0?void 0x0:_0x62734b[_0x388a81(0x204)])};}catch(_0x710bda){console['error'](_0x388a81(0x21e)+_0x710bda[_0x388a81(0x211)],_0x710bda),console[_0x388a81(0x1bd)]('[WeChat\x20Pay\x20JSAPI]\x20完整的错误对象：',_0x710bda);throw new common_1['HttpException'](_0x388a81(0x178),common_1[_0x388a81(0x20d)][_0x388a81(0x206)]);}}if(_0x277edb==_0x388a81(0x165)){common_1[_0x388a81(0x1c6)]['log'](_0x388a81(0x1ef)+_0x52da14+_0x388a81(0x1e0)+_0x2bcf6d);try{const _0x164483=await _0xe4444e[_0x388a81(0x15b)](_0x2fb596);common_1[_0x388a81(0x1c6)][_0x388a81(0x1c3)](_0x388a81(0x1c2),JSON['stringify'](_0x164483,null,0x2));let _0x34befc=_0x164483['code_url']||((_0x599a5b=_0x164483[_0x388a81(0x1d1)])===null||_0x599a5b===void 0x0?void 0x0:_0x599a5b[_0x388a81(0x1d8)]);return!_0x34befc?console[_0x388a81(0x1bd)](_0x388a81(0x1ca),JSON[_0x388a81(0x174)](_0x164483,null,0x2)):common_1[_0x388a81(0x1c6)][_0x388a81(0x1c3)](_0x388a81(0x17d)+_0x34befc),{'url_qrcode':_0x34befc,'isRedirect':![]};}catch(_0x1e8b1c){console['error'](_0x388a81(0x173)+_0x1e8b1c[_0x388a81(0x211)],_0x1e8b1c),console[_0x388a81(0x1bd)](_0x388a81(0x222),_0x1e8b1c);throw new common_1[(_0x388a81(0x1bb))]('微信Native支付失败',common_1['HttpStatus'][_0x388a81(0x206)]);}}else{console[_0x388a81(0x1dd)](_0x388a81(0x1ad)+_0x277edb);throw new common_1['HttpException'](_0x388a81(0x1ee),common_1[_0x388a81(0x20d)]['BAD_REQUEST']);}}async[_0x5be7b3(0x1a0)](_0x250f40){const _0x5569df=_0x5be7b3,{payWeChatAppId:_0x58f339,payWeChatMchId:_0x1ab98c,payWeChatPublicKey:_0x3ee1bd,payWeChatPrivateKey:_0xbca06b,payWeChatNotifyUrl:_0x4722f4}=await this[_0x5569df(0x1f3)][_0x5569df(0x153)]([_0x5569df(0x1ce),_0x5569df(0x193),'payWeChatPublicKey',_0x5569df(0x190)]),_0x49e41f=new this[(_0x5569df(0x20f))]({'appid':_0x58f339,'mchid':_0x1ab98c,'publicKey':_0x3ee1bd,'privateKey':_0xbca06b}),_0x4ec211=await _0x49e41f['query']({'out_trade_no':_0x250f40});return _0x4ec211;}[_0x5be7b3(0x17c)](_0x371784,_0x25ce13){const _0x520f55=_0x5be7b3,_0x16026b=Object['keys'](_0x371784)[_0x520f55(0x1aa)]()[_0x520f55(0x175)](_0x5d9a86=>_0x5d9a86+'='+_0x371784[_0x5d9a86])[_0x520f55(0x1fc)]('&')+_0x25ce13;return crypto[_0x520f55(0x20c)](_0x520f55(0x220))[_0x520f55(0x179)](_0x16026b)[_0x520f55(0x21b)](_0x520f55(0x1c9));}[_0x5be7b3(0x1c4)](_0x3cd29c,_0xc77bb0){const _0x8880c5=_0x5be7b3,_0x320e55=Object[_0x8880c5(0x1fe)](_0x3cd29c);_0x320e55[_0x8880c5(0x1aa)]();const _0x12c1e9=[];_0x320e55[_0x8880c5(0x175)](_0x245aa0=>{const _0x23a8ab=_0x8880c5;_0x12c1e9[_0x23a8ab(0x1df)](_0x245aa0+'='+_0x3cd29c[_0x245aa0]);}),_0x12c1e9[_0x8880c5(0x1df)](_0x8880c5(0x1e3)+_0xc77bb0);const _0x53fc30=_0x12c1e9[_0x8880c5(0x1fc)]('&');return crypto['createHash']('md5')[_0x8880c5(0x179)](_0x53fc30)[_0x8880c5(0x21b)]('hex')['toUpperCase']();}async['payLtzf'](_0x4afb42,_0x5edff5,_0x18ccff='wxpay'){const _0x12bc14=_0x5be7b3,_0x24587f=await this[_0x12bc14(0x170)][_0x12bc14(0x1ac)]({'where':{'userId':_0x4afb42,'orderId':_0x5edff5}});if(!_0x24587f)throw new common_1[(_0x12bc14(0x1bb))]('订单不存在!',common_1[_0x12bc14(0x20d)]['BAD_REQUEST']);const _0x5c82c7=await this['cramiPackageEntity'][_0x12bc14(0x1ac)]({'where':{'id':_0x24587f[_0x12bc14(0x1e9)]}});if(!_0x5c82c7)throw new common_1[(_0x12bc14(0x1bb))]('套餐不存在!',common_1['HttpStatus'][_0x12bc14(0x206)]);const {payLtzfMchId:_0x49f493,payLtzfSecret:_0xee5178,payLtzfNotifyUrl:_0x5ad076,payLtzfReturnUrl:_0x3a2739}=await this[_0x12bc14(0x1f3)][_0x12bc14(0x153)]([_0x12bc14(0x1d4),_0x12bc14(0x152),_0x12bc14(0x1f5),_0x12bc14(0x15a)]),_0x79be2f={};_0x79be2f[_0x12bc14(0x1ed)]=_0x49f493,_0x79be2f[_0x12bc14(0x197)]=(Date[_0x12bc14(0x168)]()/0x3e8)[_0x12bc14(0x183)](0x0),_0x79be2f[_0x12bc14(0x1c7)]=_0x5edff5,_0x79be2f[_0x12bc14(0x1f0)]=_0x5c82c7[_0x12bc14(0x1fa)],_0x79be2f[_0x12bc14(0x1e4)]=_0x24587f[_0x12bc14(0x182)],_0x79be2f[_0x12bc14(0x18e)]=_0x5ad076,_0x79be2f['sign']=this[_0x12bc14(0x1c4)](_0x79be2f,_0xee5178),_0x79be2f['attach']='ltzf',_0x79be2f[_0x12bc14(0x180)]=_0x3a2739;const _0x5134f6=Object[_0x12bc14(0x1fe)](_0x79be2f)[_0x12bc14(0x175)](_0x3691ad=>encodeURIComponent(_0x3691ad)+'='+encodeURIComponent(_0x79be2f[_0x3691ad]))['join']('&'),_0x57188c={'headers':{'Content-Type':_0x12bc14(0x1dc)}},_0x57825b=await axios_1['default'][_0x12bc14(0x19e)](_0x12bc14(0x1b1),_0x5134f6,_0x57188c),{code:_0xc11a49,data:_0x1a566f,msg:_0x26d635}=_0x57825b[_0x12bc14(0x1d1)];if(_0xc11a49!=0x0)throw new common_1['HttpException'](_0x26d635,common_1[_0x12bc14(0x20d)]['BAD_REQUEST']);const _0x2410dd=_0x1a566f[_0x12bc14(0x1de)],_0x581352=_0x1a566f[_0x12bc14(0x212)];return{'url_qrcode':_0x2410dd,'url':_0x581352};}async[_0x5be7b3(0x17a)](_0x2552d3){const _0xd902dd=_0x5be7b3,{payLtzfMchId:_0x5e149f,payLtzfSecret:_0x40efce}=await this['globalConfigService'][_0xd902dd(0x153)]([_0xd902dd(0x1d4),_0xd902dd(0x152)]),_0x5cdb88={};_0x5cdb88[_0xd902dd(0x1ed)]=_0x5e149f,_0x5cdb88[_0xd902dd(0x197)]=(Date[_0xd902dd(0x168)]()/0x3e8)[_0xd902dd(0x183)](0x0),_0x5cdb88[_0xd902dd(0x1c7)]=_0x2552d3,_0x5cdb88['sign']=this[_0xd902dd(0x1c4)](_0x5cdb88,_0x40efce);const _0x370011=Object[_0xd902dd(0x1fe)](_0x5cdb88)['map'](_0x2571cc=>encodeURIComponent(_0x2571cc)+'='+encodeURIComponent(_0x5cdb88[_0x2571cc]))['join']('&'),_0x1a2fd5={'headers':{'Content-Type':_0xd902dd(0x1dc)}},{data:{code:_0x30db81,msg:_0x154500,data:_0x2dea3f}}=await axios_1[_0xd902dd(0x16e)]['post'](_0xd902dd(0x155),_0x370011,_0x1a2fd5);if(_0x30db81!=0x0)throw new common_1[(_0xd902dd(0x1bb))](_0x154500+JSON['stringify'](_0x5cdb88),common_1[_0xd902dd(0x20d)][_0xd902dd(0x206)]);return _0x2dea3f;}async['notifyLtzf'](_0x20a7c0){const _0x1174d6=_0x5be7b3,_0x11c8e6=await this['globalConfigService']['getConfigs']([_0x1174d6(0x152)]),_0x20a449=_0x20a7c0[_0x1174d6(0x17c)];delete _0x20a7c0['sign'],delete _0x20a7c0[_0x1174d6(0x192)],delete _0x20a7c0['trade_type'],delete _0x20a7c0[_0x1174d6(0x1a1)],delete _0x20a7c0[_0x1174d6(0x1f9)],delete _0x20a7c0[_0x1174d6(0x1ea)];if(this[_0x1174d6(0x1c4)](_0x20a7c0,_0x11c8e6)!=_0x20a449)return'FAIL';const _0x5826d9=await this['orderEntity'][_0x1174d6(0x1ac)]({'where':{'orderId':_0x20a7c0[_0x1174d6(0x1c7)],'status':0x0}});if(!_0x5826d9)return _0x1174d6(0x214);await this[_0x1174d6(0x1a8)]['addBalanceToOrder'](_0x5826d9);const _0x11a528=await this['orderEntity'][_0x1174d6(0x179)]({'orderId':_0x20a7c0[_0x1174d6(0x1c7)]},{'status':0x1,'paydAt':new Date()});if(_0x11a528['affected']!=0x1)return _0x1174d6(0x214);return _0x1174d6(0x1b9);}};PayService=__decorate([(0x0,common_1[_0x5be7b3(0x208)])(),__param(0x0,(0x0,typeorm_1[_0x5be7b3(0x1a4)])(cramiPackage_entity_1[_0x5be7b3(0x19f)])),__param(0x1,(0x0,typeorm_1[_0x5be7b3(0x1a4)])(order_entity_1[_0x5be7b3(0x1d9)])),__metadata('design:paramtypes',[typeorm_2[_0x5be7b3(0x1e6)],typeorm_2[_0x5be7b3(0x1e6)],userBalance_service_1[_0x5be7b3(0x21d)],globalConfig_service_1[_0x5be7b3(0x16d)],user_service_1[_0x5be7b3(0x172)]])],PayService),exports[_0x5be7b3(0x167)]=PayService;function _0x4625(){const _0x472522=['userService','UserService','微信Native支付过程中发生错误，错误信息:\x20','stringify','map','payEpayNotifyUrl','3281712gBWxwf','JSAPI支付失败','update','queryLtzf','payHupiSecret','sign','微信Native支付请求成功，code_url:\x20','notifyWeChat','payEpaySecret','return_url','../crami/cramiPackage.entity','total','toFixed','alipay','745700jPjEuy','校验签名通过','payHupiAppId','length','__decorate','query','payLtzf','function','notifyEpay','notify_url','getOpenIdByUserId','payWeChatPrivateKey','797664dJgaQx','pay_channel','payWeChatMchId','../userBalance/userBalance.service','payEpayApiQueryUrl','MD5','timestamp','810ZKKbgj','../globalConfig/globalConfig.service','crypto','notifyHupi','object','本次支付类型:\x20','post','CramiPackageEntity','queryWeChat','success_time','hupi','payWeChat','InjectRepository','TRADE_SUCCESS','2396ixAIVY','mpay','userBalanceService','signType','sort','axios','findOne','支付请求使用了不支持的支付类型:\x20','ltzf','wechat','payMpaySecret','https://api.ltzf.cn/api/wxpay/jsapi_convenient','addBalanceToOrder','trade_order_id','../order/order.entity','1530qSqNvp','payWeChatPublicKey','time','cramiPackageEntity','SUCCESS','[WeChat\x20Pay\x20JSAPI]\x20支付请求成功，返回结果:\x20','HttpException','success','error','payMpayNotifyUrl','6QIqIAV','https://api.xunhupay.com/payment/query.html','appId','微信Native支付响应数据:\x20','log','ltzfSign','decorate','Logger','out_trade_no','payWeChatSecret','hex','微信Native支付请求成功，但未返回code_url，响应数据:\x20','key','payWeChatNotifyUrl','unknown','payWeChatAppId','event_type','套餐不存在!','data','[WeChat\x20Pay\x20JSAPI]\x20用户OpenID:\x20','hash','payLtzfMchId','payEpayPid','toString','money','code_url','OrderEntity','校验签名','clientip','application/x-www-form-urlencoded','warn','QRcode_url','push',',\x20用户ID:\x20','../../common/utils','pid','key=','total_fee','affected','Repository','get','queryHupi','goodsId','openid','192.168.1.100','failed','mch_id','unsupported\x20pay\x20type','开始进行微信Native支付流程，订单ID:\x20','body','timeStamp','status:\x20','globalConfigService','订单不存在!','payLtzfNotifyUrl','payMpayPid','[WeChat\x20Pay\x20JSAPI]\x20开始JSAPI支付流程，用户ID:\x20','payHupiNotifyUrl','attach','name','支付请求失败!','join','payMpay','keys','submit.php','version','wechatpay-node-v3','payMpayApiQueryUrl','nonceStr','paySign','1.1','BAD_REQUEST','payEpay','Injectable','param','createRandomNonceStr','762495niHHKU','createHash','HttpStatus','../user/user.service','WxPay','trade_status','message','order_url','__esModule','FAIL','11547yAfUIH','type','nonce_str','metadata','decipher_gcm','order_no','digest','payPlatform','UserBalanceService','[WeChat\x20Pay\x20JSAPI]\x20支付请求过程中发生错误:\x20','wxpay','md5','transactions_jsapi','完整的错误对象：','payLtzfSecret','getConfigs','payHupi','https://api.ltzf.cn/api/wxpay/get_pay_order','payHupiReturnUrl','typeorm','queryMpay','includes','payLtzfReturnUrl','transactions_native','https://api.xunhupay.com/payment/do.html','100948hJkwyg','importDynamic','payer','queryEpay','notify','appid','resource','sign_type','native','epay','PayService','now','getOwnPropertyDescriptor','payType:\x20','notifyMpay','payEpayApiPayUrl','GlobalConfigService','default','title','orderEntity'];_0x4625=function(){return _0x472522;};return _0x4625();}