'use strict';const _0x53ef7c=_0x51cb;(function(_0x136947,_0x5788d0){const _0x328da4=_0x51cb,_0x3ff2d7=_0x136947();while(!![]){try{const _0x2c76f5=-parseInt(_0x328da4(0x1ed))/0x1+parseInt(_0x328da4(0x1a9))/0x2*(parseInt(_0x328da4(0x181))/0x3)+parseInt(_0x328da4(0x1ca))/0x4+parseInt(_0x328da4(0x198))/0x5+-parseInt(_0x328da4(0x222))/0x6*(parseInt(_0x328da4(0x162))/0x7)+parseInt(_0x328da4(0x1b2))/0x8+parseInt(_0x328da4(0x1f2))/0x9*(-parseInt(_0x328da4(0x163))/0xa);if(_0x2c76f5===_0x5788d0)break;else _0x3ff2d7['push'](_0x3ff2d7['shift']());}catch(_0x1d7ade){_0x3ff2d7['push'](_0x3ff2d7['shift']());}}}(_0x4fa6,0x8c4ee));function _0x51cb(_0x589711,_0x5be989){const _0x4fa6fa=_0x4fa6();return _0x51cb=function(_0x51cbda,_0x3e1d75){_0x51cbda=_0x51cbda-0x154;let _0x35b744=_0x4fa6fa[_0x51cbda];return _0x35b744;},_0x51cb(_0x589711,_0x5be989);}var __decorate=this&&this[_0x53ef7c(0x206)]||function(_0x3f5ac6,_0x3a6433,_0x32554a,_0x4d9afe){const _0x3b6505=_0x53ef7c;var _0x3e57b1=arguments[_0x3b6505(0x1ff)],_0x1387cf=_0x3e57b1<0x3?_0x3a6433:_0x4d9afe===null?_0x4d9afe=Object[_0x3b6505(0x1d7)](_0x3a6433,_0x32554a):_0x4d9afe,_0xa58cd8;if(typeof Reflect===_0x3b6505(0x21f)&&typeof Reflect[_0x3b6505(0x1f5)]===_0x3b6505(0x166))_0x1387cf=Reflect[_0x3b6505(0x1f5)](_0x3f5ac6,_0x3a6433,_0x32554a,_0x4d9afe);else{for(var _0x2e7f4e=_0x3f5ac6['length']-0x1;_0x2e7f4e>=0x0;_0x2e7f4e--)if(_0xa58cd8=_0x3f5ac6[_0x2e7f4e])_0x1387cf=(_0x3e57b1<0x3?_0xa58cd8(_0x1387cf):_0x3e57b1>0x3?_0xa58cd8(_0x3a6433,_0x32554a,_0x1387cf):_0xa58cd8(_0x3a6433,_0x32554a))||_0x1387cf;}return _0x3e57b1>0x3&&_0x1387cf&&Object[_0x3b6505(0x1ad)](_0x3a6433,_0x32554a,_0x1387cf),_0x1387cf;},__metadata=this&&this['__metadata']||function(_0x114ccd,_0x472978){const _0x50d95e=_0x53ef7c;if(typeof Reflect===_0x50d95e(0x21f)&&typeof Reflect[_0x50d95e(0x15e)]==='function')return Reflect[_0x50d95e(0x15e)](_0x114ccd,_0x472978);},__param=this&&this[_0x53ef7c(0x1ea)]||function(_0x5662ff,_0x528a0b){return function(_0x328278,_0x44216b){_0x528a0b(_0x328278,_0x44216b,_0x5662ff);};};function _0x4fa6(){const _0x5a4856=['metadata','https://api.ltzf.cn/api/wxpay/get_pay_order','payMpayReturnUrl','Logger','959KUlcKf','17571860SYSeTZ','pay_channel','success_time','function','hash','HttpException','GlobalConfigService','payMpaySecret','error:\x20','../order/order.entity','[WeChat\x20Pay\x20JSAPI]\x20发送支付请求参数:\x20','globalConfigService','JSAPI支付失败','支付通知验证失败:\x20','支付请求使用了不支持的支付类型:\x20','payLtzfSecret','payWeChatAppId','1.1','InjectRepository','queryEpay','attach','payMpay','native','digest','cramiPackageEntity','payMpayPid','SUCCESS','wxpay',',\x20订单ID:\x20','nonce_str','3JfmWBL','event_type','success','payer','notify_url','TRADE_SUCCESS','warn','https://api.ltzf.cn/api/wxpay/jsapi_convenient','https://api.xunhupay.com/payment/query.html','name','device','data','transactions_jsapi','sign','mch_id','[WeChat\x20Pay\x20JSAPI]\x20支付请求成功，返回结果:\x20','trade_order_id','支付请求失败:\x20','OrderEntity','payHupiGatewayUrl','payLtzfMchId','订单不存在!','校验签名','5608185YrIWXO','status','开始进行微信Native支付流程，订单ID:\x20','BAD_REQUEST','out_trade_no','sign_type','QRcode_url','notifyWeChat','微信Native支付请求成功，但未返回code_url，响应数据:\x20','套餐不存在!','order_no','userBalanceService','payWeChat','post','application/x-www-form-urlencoded','includes','pid','1888822EZPaYJ','payEpayReturnUrl','PayService','query','defineProperty','notifyEpay','TRANSACTION.SUCCESS','ltzfSign','axios','6436528UYrpnY','payPlatform','payHupiSecret','payEpayPid','../userBalance/userBalance.service','order','payHupiNotifyUrl','update','version','addBalanceToOrder','trade_status','notifyHupi','payMpayApiQueryUrl','wechat-pay:\x20','orderEntity','wechatpay-node-v3','total','crypto','nonceStr','微信Native支付失败','total_fee','get','transactions_native',',\x20用户ID:\x20','4515476uziSBz','goodsId','trade_state','title','hupi','createRandomNonceStr','signType','微信Native支付过程中发生错误，错误信息:\x20','完整的错误对象：','order_url','importDynamic','typeorm','timeStamp','getOwnPropertyDescriptor','userService','stringify','key=','findOne','paySign','payWeChatPublicKey','Repository','now','map','trade_type','submit.php','md5','error','unknown','hex','payWeChatSecret','MD5','FAIL','__param','queryMpay','jsapi','1104114zNLPfa','getConfigs','return_url','code_url','mpay','9rRQoLA','payEpayNotifyUrl','round','decorate','微信Native支付请求成功，code_url:\x20','time','HttpStatus','push','payEpayApiQueryUrl','message','payEpayApiPayUrl','resource','default','length','epay\x20--->\x20res:\x20','WxPay','failed','payWeChatMchId','toString','notifyMpay','__decorate','onModuleInit','payLtzf','openid','payWeChatPrivateKey','ltzf','payMpayNotifyUrl','payHupiAppId','[WeChat\x20Pay\x20JSAPI]\x20用户OpenID:\x20','type','out_trade_order','appId','status:\x20','UserBalanceService','toFixed','[WeChat\x20Pay\x20JSAPI]\x20开始JSAPI支付流程，用户ID:\x20','log','queryLtzf','../../common/utils','微信Native支付响应数据:\x20','design:paramtypes','join','本次支付类型:\x20','epay','校验签名通过','object','payHupi','payType:\x20','24678DohwYB','sort','notifyLtzf','package','affected','act','money','payEpaySecret','payLtzfNotifyUrl','payEpay','notify','keys'];_0x4fa6=function(){return _0x5a4856;};return _0x4fa6();}Object[_0x53ef7c(0x1ad)](exports,'__esModule',{'value':!![]}),exports[_0x53ef7c(0x1ab)]=void 0x0;const utils_1=require(_0x53ef7c(0x218)),common_1=require('@nestjs/common'),typeorm_1=require('@nestjs/typeorm'),axios_1=require(_0x53ef7c(0x1b1)),crypto=require(_0x53ef7c(0x1c3)),typeorm_2=require(_0x53ef7c(0x1d5)),cramiPackage_entity_1=require('../crami/cramiPackage.entity'),globalConfig_service_1=require('../globalConfig/globalConfig.service'),order_entity_1=require(_0x53ef7c(0x16c)),user_service_1=require('../user/user.service'),userBalance_service_1=require(_0x53ef7c(0x1b6));let PayService=class PayService{constructor(_0x311add,_0x1cd674,_0xad2ef3,_0x405137,_0x38e304){const _0x234b80=_0x53ef7c;this[_0x234b80(0x17b)]=_0x311add,this[_0x234b80(0x1c0)]=_0x1cd674,this[_0x234b80(0x1a3)]=_0xad2ef3,this['globalConfigService']=_0x405137,this[_0x234b80(0x1d8)]=_0x38e304;}async[_0x53ef7c(0x207)](){const _0x34c602=_0x53ef7c,_0x26e041=await(0x0,utils_1[_0x34c602(0x1d4)])(_0x34c602(0x1c1));this[_0x34c602(0x201)]=(_0x26e041===null||_0x26e041===void 0x0?void 0x0:_0x26e041[_0x34c602(0x1fe)])?_0x26e041[_0x34c602(0x1fe)]:_0x26e041;}async[_0x53ef7c(0x15c)](_0x131866){const _0x492eca=_0x53ef7c;if(_0x131866['param']==_0x492eca(0x21d))return this[_0x492eca(0x1ae)](_0x131866);if(_0x131866[_0x492eca(0x177)]==_0x492eca(0x1ce))return this[_0x492eca(0x1bd)](_0x131866);if(_0x131866[_0x492eca(0x177)]==_0x492eca(0x20b))return this[_0x492eca(0x154)](_0x131866);if(typeof _0x131866['resource']==_0x492eca(0x21f))return this[_0x492eca(0x19f)](_0x131866);return this[_0x492eca(0x205)](_0x131866);}async['pay'](_0x18c8fd,_0xe07c69,_0x451f10=_0x53ef7c(0x17e)){const _0x28f4b8=_0x53ef7c,_0x22d90c=await this[_0x28f4b8(0x1c0)][_0x28f4b8(0x1db)]({'where':{'userId':_0x18c8fd,'orderId':_0xe07c69}});if(!_0x22d90c)throw new common_1[(_0x28f4b8(0x168))](_0x28f4b8(0x196),common_1[_0x28f4b8(0x1f8)]['BAD_REQUEST']);const _0x449364=await this[_0x28f4b8(0x17b)][_0x28f4b8(0x1db)]({'where':{'id':_0x22d90c['goodsId']}});if(!_0x449364)throw new common_1[(_0x28f4b8(0x168))](_0x28f4b8(0x1a1),common_1['HttpStatus'][_0x28f4b8(0x19b)]);common_1[_0x28f4b8(0x161)][_0x28f4b8(0x216)](_0x28f4b8(0x21c),_0x22d90c[_0x28f4b8(0x1b3)]);try{if(_0x22d90c[_0x28f4b8(0x1b3)]=='wechat')return this[_0x28f4b8(0x1a4)](_0x18c8fd,_0xe07c69,_0x451f10);if(_0x22d90c[_0x28f4b8(0x1b3)]==_0x28f4b8(0x21d))return this['payEpay'](_0x18c8fd,_0xe07c69,_0x451f10);if(_0x22d90c[_0x28f4b8(0x1b3)]==_0x28f4b8(0x1f1))return this[_0x28f4b8(0x178)](_0x18c8fd,_0xe07c69,_0x451f10);if(_0x22d90c[_0x28f4b8(0x1b3)]==_0x28f4b8(0x1ce))return this['payHupi'](_0x18c8fd,_0xe07c69,_0x451f10);if(_0x22d90c[_0x28f4b8(0x1b3)]==_0x28f4b8(0x20b))return this[_0x28f4b8(0x208)](_0x18c8fd,_0xe07c69,_0x451f10);}catch(_0x3b1bb6){common_1[_0x28f4b8(0x161)]['log'](_0x28f4b8(0x192),_0x3b1bb6);throw new common_1['HttpException']('支付请求失败!',common_1['HttpStatus'][_0x28f4b8(0x19b)]);}}async[_0x53ef7c(0x1ac)](_0x4211ea){const _0x17d267=_0x53ef7c,_0x366587=await this[_0x17d267(0x1c0)][_0x17d267(0x1db)]({'where':{'orderId':_0x4211ea}});if(!_0x366587)throw new common_1['HttpException']('订单不存在!',common_1['HttpStatus'][_0x17d267(0x19b)]);return _0x366587;}async[_0x53ef7c(0x1bd)](_0xed5fe0){const _0x11a76a=_0x53ef7c,_0x90acbd=await this[_0x11a76a(0x16e)]['getConfigs']([_0x11a76a(0x1b4)]),_0x3b2428=_0xed5fe0[_0x11a76a(0x167)];delete _0xed5fe0[_0x11a76a(0x167)];if(this[_0x11a76a(0x18e)](_0xed5fe0,_0x90acbd)!=_0x3b2428)return _0x11a76a(0x202);const _0x555f09=await this['orderEntity'][_0x11a76a(0x1db)]({'where':{'orderId':_0xed5fe0[_0x11a76a(0x191)],'status':0x0}});if(!_0x555f09)return _0x11a76a(0x202);await this[_0x11a76a(0x1a3)][_0x11a76a(0x1bb)](_0x555f09);const _0xb7fdcf=await this[_0x11a76a(0x1c0)][_0x11a76a(0x1b9)]({'orderId':_0xed5fe0[_0x11a76a(0x191)]},{'status':0x1,'paydAt':new Date()});if(_0xb7fdcf[_0x11a76a(0x156)]!=0x1)return _0x11a76a(0x202);return _0x11a76a(0x183);}async[_0x53ef7c(0x220)](_0x157e20,_0x280d46,_0x37637a=_0x53ef7c(0x17e)){const _0x5358be=_0x53ef7c,_0x37617f=await this['orderEntity']['findOne']({'where':{'userId':_0x157e20,'orderId':_0x280d46}});if(!_0x37617f)throw new common_1[(_0x5358be(0x168))]('订单不存在!',common_1['HttpStatus']['BAD_REQUEST']);const _0x25f1ac=await this['cramiPackageEntity']['findOne']({'where':{'id':_0x37617f['goodsId']}});if(!_0x25f1ac)throw new common_1['HttpException'](_0x5358be(0x1a1),common_1[_0x5358be(0x1f8)][_0x5358be(0x19b)]);const {payHupiAppId:_0x39af70,payHupiSecret:_0x34b386,payHupiNotifyUrl:_0x5a4de4,payHupiReturnUrl:_0x12dd55,payHupiGatewayUrl:_0x562dde}=await this[_0x5358be(0x16e)]['getConfigs']([_0x5358be(0x20d),_0x5358be(0x1b4),_0x5358be(0x1b8),'payHupiReturnUrl',_0x5358be(0x194)]),_0x15ec9d={};_0x15ec9d[_0x5358be(0x1ba)]='1.1',_0x15ec9d['appid']=_0x39af70,_0x15ec9d[_0x5358be(0x1f7)]=(Date[_0x5358be(0x1df)]()/0x3e8)[_0x5358be(0x214)](0x0),_0x15ec9d[_0x5358be(0x180)]=(0x0,utils_1[_0x5358be(0x1cf)])(0x20),_0x15ec9d[_0x5358be(0x191)]=_0x280d46,_0x15ec9d[_0x5358be(0x1cd)]=_0x25f1ac[_0x5358be(0x18a)],_0x15ec9d[_0x5358be(0x1c6)]=_0x37617f[_0x5358be(0x1c2)],_0x15ec9d['notify_url']=_0x5a4de4,_0x15ec9d[_0x5358be(0x1ef)]=_0x12dd55,_0x15ec9d[_0x5358be(0x177)]=_0x5358be(0x1ce),_0x15ec9d[_0x5358be(0x167)]=this[_0x5358be(0x18e)](_0x15ec9d,_0x34b386);const {data:{errcode:_0x74a406,errmsg:_0x381794,url_qrcode:_0xbee5cf,url:_0x58f4d8}}=await axios_1[_0x5358be(0x1fe)][_0x5358be(0x1a5)](_0x562dde||'https://api.xunhupay.com/payment/do.html',_0x15ec9d);if(_0x74a406!=0x0)throw new common_1[(_0x5358be(0x168))](_0x381794,common_1[_0x5358be(0x1f8)]['BAD_REQUEST']);return{'url_qrcode':_0xbee5cf,'url':_0x58f4d8};}async['queryHupi'](_0x2d4844){const _0x4a9390=_0x53ef7c,{payHupiAppId:_0x588c7e,payHupiSecret:_0x57abf3}=await this['globalConfigService'][_0x4a9390(0x1ee)]([_0x4a9390(0x20d),_0x4a9390(0x1b4)]),_0x458750={};_0x458750[_0x4a9390(0x1ba)]=_0x4a9390(0x174),_0x458750['appid']=_0x588c7e,_0x458750['time']=(Date[_0x4a9390(0x1df)]()/0x3e8)[_0x4a9390(0x214)](0x0),_0x458750[_0x4a9390(0x180)]=(0x0,utils_1[_0x4a9390(0x1cf)])(0x20),_0x458750[_0x4a9390(0x210)]=_0x2d4844,_0x458750[_0x4a9390(0x167)]=this[_0x4a9390(0x18e)](_0x458750,_0x57abf3);const {data:{errcode:_0x5b1add,errmsg:_0x4d2158,data:_0x478f49}}=await axios_1[_0x4a9390(0x1fe)][_0x4a9390(0x1a5)](_0x4a9390(0x189),_0x458750);if(_0x5b1add!=0x0)throw new common_1[(_0x4a9390(0x168))](_0x4d2158,common_1[_0x4a9390(0x1f8)][_0x4a9390(0x19b)]);return _0x478f49;}async[_0x53ef7c(0x1ae)](_0x5d431c){const _0x41bc51=_0x53ef7c,_0x5550de=_0x5d431c['sign'];delete _0x5d431c['sign'],delete _0x5d431c[_0x41bc51(0x19d)];const _0x32ebcc=await this['globalConfigService'][_0x41bc51(0x1ee)]([_0x41bc51(0x159)]);if(this['sign'](_0x5d431c,_0x32ebcc)!=_0x5550de)return'failed';common_1[_0x41bc51(0x161)][_0x41bc51(0x216)]('校验签名通过');const _0x2892ca=await this[_0x41bc51(0x1c0)][_0x41bc51(0x1db)]({'where':{'orderId':_0x5d431c['out_trade_no'],'status':0x0}});if(!_0x2892ca)return _0x41bc51(0x202);const _0x2b95a3=_0x5d431c[_0x41bc51(0x1bc)]==_0x41bc51(0x186)?0x1:0x2,_0x8eeaa0=await this[_0x41bc51(0x1c0)][_0x41bc51(0x1b9)]({'orderId':_0x5d431c['out_trade_no']},{'status':_0x2b95a3,'paydAt':new Date()});_0x2b95a3===0x1&&await this[_0x41bc51(0x1a3)][_0x41bc51(0x1bb)](_0x2892ca);if(_0x8eeaa0['affected']!=0x1)return'failed';return _0x41bc51(0x183);}async[_0x53ef7c(0x15b)](_0xaddb68,_0x2215e9,_0x39318a='alipay'){const _0x45592a=_0x53ef7c,_0x44101c=await this['orderEntity'][_0x45592a(0x1db)]({'where':{'userId':_0xaddb68,'orderId':_0x2215e9}});if(!_0x44101c)throw new common_1[(_0x45592a(0x168))](_0x45592a(0x196),common_1[_0x45592a(0x1f8)][_0x45592a(0x19b)]);const _0x5eb53d=await this['cramiPackageEntity'][_0x45592a(0x1db)]({'where':{'id':_0x44101c['goodsId']}});if(!_0x5eb53d)throw new common_1[(_0x45592a(0x168))](_0x45592a(0x1a1),common_1[_0x45592a(0x1f8)][_0x45592a(0x19b)]);const {payEpayPid:_0x58c1ea,payEpaySecret:_0x2a28a2,payEpayNotifyUrl:_0x42623b,payEpayReturnUrl:_0x1a792b,payEpayApiPayUrl:_0x4ff42a}=await this['globalConfigService'][_0x45592a(0x1ee)]([_0x45592a(0x1b5),_0x45592a(0x159),_0x45592a(0x1f3),_0x45592a(0x1aa),_0x45592a(0x1fc)]);let _0x4911df;_0x58c1ea[_0x45592a(0x1ff)]<=0x10?_0x4911df=Number(_0x58c1ea):_0x4911df=BigInt(_0x58c1ea);const _0x1d4b52={};_0x1d4b52[_0x45592a(0x1a8)]=_0x4911df,_0x1d4b52[_0x45592a(0x20f)]=_0x39318a,_0x1d4b52[_0x45592a(0x19c)]=_0x2215e9,_0x1d4b52['name']=_0x5eb53d[_0x45592a(0x18a)],_0x1d4b52[_0x45592a(0x158)]=_0x44101c[_0x45592a(0x1c2)],_0x1d4b52['clientip']='192.168.1.100',_0x1d4b52[_0x45592a(0x18b)]='pc',_0x1d4b52['notify_url']=_0x42623b,_0x1d4b52[_0x45592a(0x1ef)]=_0x1a792b,_0x1d4b52['param']=_0x45592a(0x21d),_0x1d4b52[_0x45592a(0x18e)]=this[_0x45592a(0x18e)](_0x1d4b52,_0x2a28a2),_0x1d4b52['sign_type']=_0x45592a(0x1e8);const _0x55c5f0=new URLSearchParams(_0x1d4b52)[_0x45592a(0x204)](),_0x58c871=_0x4ff42a+'?'+_0x55c5f0;if(_0x4ff42a[_0x45592a(0x1a7)](_0x45592a(0x1e2)))return{'url_qrcode':null,'redirectUrl':_0x58c871,'channel':_0x39318a,'isRedirect':!![]};else{const _0xed03dc={'headers':{'Content-Type':_0x45592a(0x1a6)}},_0x119454=await axios_1[_0x45592a(0x1fe)][_0x45592a(0x1a5)](_0x4ff42a,_0x1d4b52,_0xed03dc);common_1[_0x45592a(0x161)][_0x45592a(0x216)](_0x45592a(0x200),_0x119454[_0x45592a(0x18c)]);const {data:{code:_0x22c565,msg:_0x3c8c82,qrcode:_0x48cfd7}}=_0x119454;if(_0x22c565!=0x1)throw new common_1[(_0x45592a(0x168))](_0x3c8c82,common_1[_0x45592a(0x1f8)][_0x45592a(0x19b)]);return{'url_qrcode':_0x48cfd7,'redirectUrl':null,'channel':_0x39318a,'isRedirect':![]};}}async[_0x53ef7c(0x176)](_0x26eede){const _0x40ee9d=_0x53ef7c,{payEpayPid:_0xcefcfd,payEpaySecret:_0x18e3d2,payEpayApiQueryUrl:_0x51cc9d}=await this[_0x40ee9d(0x16e)][_0x40ee9d(0x1ee)](['payEpayPid','payEpaySecret',_0x40ee9d(0x1fa)]),_0x5d7abb={};_0x5d7abb[_0x40ee9d(0x157)]=_0x40ee9d(0x1b7),_0x5d7abb[_0x40ee9d(0x19c)]=_0x26eede,_0x5d7abb[_0x40ee9d(0x1a8)]=_0xcefcfd,_0x5d7abb['key']=_0x18e3d2;const {data:{code:_0x32e8bc,msg:_0x47f007,data:_0x4e3c4c}}=await axios_1[_0x40ee9d(0x1fe)]['get'](_0x51cc9d,{'params':_0x5d7abb});if(_0x32e8bc!=0x1)throw new common_1[(_0x40ee9d(0x168))](_0x47f007,common_1['HttpStatus'][_0x40ee9d(0x19b)]);return _0x4e3c4c;}async[_0x53ef7c(0x205)](_0x318ec3){const _0x3e302f=_0x53ef7c,_0x4d0ee3=_0x318ec3[_0x3e302f(0x18e)];delete _0x318ec3[_0x3e302f(0x18e)],delete _0x318ec3['sign_type'];const _0x3eea3f=await this[_0x3e302f(0x16e)]['getConfigs']([_0x3e302f(0x16a)]);common_1[_0x3e302f(0x161)][_0x3e302f(0x216)](_0x3e302f(0x197));if(this[_0x3e302f(0x18e)](_0x318ec3,_0x3eea3f)!=_0x4d0ee3)return _0x3e302f(0x202);common_1['Logger'][_0x3e302f(0x216)](_0x3e302f(0x21e));const _0x52d67d=await this['orderEntity']['findOne']({'where':{'orderId':_0x318ec3[_0x3e302f(0x19c)],'status':0x0}});if(!_0x52d67d)return'failed';const _0x421cae=_0x318ec3[_0x3e302f(0x1bc)]==_0x3e302f(0x186)?0x1:0x2;common_1[_0x3e302f(0x161)][_0x3e302f(0x216)](_0x3e302f(0x212),_0x421cae);const _0x111d2e=await this[_0x3e302f(0x1c0)][_0x3e302f(0x1b9)]({'orderId':_0x318ec3[_0x3e302f(0x19c)]},{'status':_0x421cae,'paydAt':new Date()});_0x421cae===0x1&&await this['userBalanceService']['addBalanceToOrder'](_0x52d67d);if(_0x111d2e['affected']!=0x1)return _0x3e302f(0x202);return'success';}async[_0x53ef7c(0x178)](_0x5c009d,_0x1be141,_0x103b9f='wxpay'){const _0x3405c2=_0x53ef7c,_0x98b5b5=await this[_0x3405c2(0x1c0)][_0x3405c2(0x1db)]({'where':{'userId':_0x5c009d,'orderId':_0x1be141}});if(!_0x98b5b5)throw new common_1[(_0x3405c2(0x168))](_0x3405c2(0x196),common_1[_0x3405c2(0x1f8)][_0x3405c2(0x19b)]);const _0x40f153=await this['cramiPackageEntity'][_0x3405c2(0x1db)]({'where':{'id':_0x98b5b5['goodsId']}});if(!_0x40f153)throw new common_1[(_0x3405c2(0x168))]('套餐不存在!',common_1[_0x3405c2(0x1f8)][_0x3405c2(0x19b)]);const {payMpayPid:_0x1ae4f7,payMpaySecret:_0xf0f25d,payMpayNotifyUrl:_0xbcffe7,payMpayReturnUrl:_0x4fc1b7,payMpayApiPayUrl:_0x570ce3}=await this[_0x3405c2(0x16e)][_0x3405c2(0x1ee)](['payMpayPid','payMpaySecret',_0x3405c2(0x20c),_0x3405c2(0x160),'payMpayApiPayUrl']),_0x2b8d8d={};_0x2b8d8d[_0x3405c2(0x1a8)]=Number(_0x1ae4f7),_0x2b8d8d['type']=_0x103b9f,_0x2b8d8d[_0x3405c2(0x19c)]=_0x1be141,_0x2b8d8d[_0x3405c2(0x18a)]=_0x40f153[_0x3405c2(0x18a)],_0x2b8d8d[_0x3405c2(0x158)]=_0x98b5b5[_0x3405c2(0x1c2)],_0x2b8d8d['notify_url']=_0xbcffe7,_0x2b8d8d[_0x3405c2(0x1ef)]=_0x4fc1b7,_0x2b8d8d['sign']=this[_0x3405c2(0x18e)](_0x2b8d8d,_0xf0f25d),_0x2b8d8d[_0x3405c2(0x19d)]=_0x3405c2(0x1e8);const _0x22287d=new URLSearchParams(_0x2b8d8d)[_0x3405c2(0x204)](),_0x59b00b=_0x570ce3+'?'+_0x22287d;return{'url_qrcode':null,'redirectUrl':_0x59b00b,'channel':_0x103b9f,'isRedirect':!![]};const _0x468e11=await axios_1[_0x3405c2(0x1fe)][_0x3405c2(0x1c7)](_0x570ce3,{'params':_0x2b8d8d});}async[_0x53ef7c(0x1eb)](_0x87e320){const _0x3e0bc7=_0x53ef7c,{payMpayApiQueryUrl:_0x584fc0}=await this['globalConfigService'][_0x3e0bc7(0x1ee)]([_0x3e0bc7(0x17c),_0x3e0bc7(0x16a),_0x3e0bc7(0x1be)]),_0xd9e52a={};_0xd9e52a[_0x3e0bc7(0x20f)]=0x2,_0xd9e52a[_0x3e0bc7(0x1a2)]=_0x87e320;const {data:{code:_0x52a0f8,msg:_0x560420,data:_0x56024c}}=await axios_1['default'][_0x3e0bc7(0x1c7)](_0x584fc0,{'params':_0xd9e52a});if(_0x52a0f8!=0x1)throw new common_1[(_0x3e0bc7(0x168))](_0x560420,common_1[_0x3e0bc7(0x1f8)][_0x3e0bc7(0x19b)]);return _0x56024c;}async['notifyWeChat'](_0x33667d){const _0x429689=_0x53ef7c;common_1[_0x429689(0x161)][_0x429689(0x216)]('微信支付通知params:\x20',_0x33667d);const {payWeChatAppId:_0x4ae4b9,payWeChatMchId:_0x289c3d,payWeChatSecret:_0x26cb24,payWeChatPublicKey:_0x274858,payWeChatPrivateKey:_0x4fe8a6}=await this[_0x429689(0x16e)][_0x429689(0x1ee)]([_0x429689(0x173),_0x429689(0x203),_0x429689(0x1e7),_0x429689(0x1dd),_0x429689(0x20a)]),_0x375b69=new this['WxPay']({'appid':_0x4ae4b9,'mchid':_0x289c3d,'publicKey':_0x274858,'privateKey':_0x4fe8a6});try{if(_0x33667d[_0x429689(0x182)]==_0x429689(0x1af)){const {ciphertext:_0x52cce1,associated_data:_0x38d58a,nonce:_0x48087e}=_0x33667d[_0x429689(0x1fd)],_0x406806=_0x375b69['decipher_gcm'](_0x52cce1,_0x38d58a,_0x48087e,_0x26cb24),_0x1bd8a4=await this[_0x429689(0x1c0)][_0x429689(0x1db)]({'where':{'orderId':_0x406806[_0x429689(0x19c)],'status':0x0}});if(!_0x1bd8a4)return'failed';const _0xda14c2=_0x406806[_0x429689(0x1cc)]==_0x429689(0x17d)?0x1:0x2,_0x26dd7e=await this[_0x429689(0x1c0)]['update']({'orderId':_0x406806[_0x429689(0x19c)]},{'status':_0xda14c2,'paydAt':new Date()});_0xda14c2===0x1&&await this['userBalanceService']['addBalanceToOrder'](_0x1bd8a4);if(_0x26dd7e['affected']!=0x1)return _0x429689(0x202);}return _0x429689(0x183);}catch(_0x3367c7){return common_1[_0x429689(0x161)]['log'](_0x429689(0x16b),_0x3367c7),common_1[_0x429689(0x161)]['log'](_0x429689(0x170),_0x3367c7),_0x429689(0x202);}}async['payWeChat'](_0x94ee8f,_0x496bb8,_0x24038f='native'){const _0x4fc475=_0x53ef7c;var _0x2aa87c,_0x4ce828,_0x470e27,_0x5d7b1a,_0x4a1274,_0x2246df,_0x2e5a95;common_1[_0x4fc475(0x161)][_0x4fc475(0x216)](_0x4fc475(0x221),_0x24038f);const _0x3dfc41=await this[_0x4fc475(0x1c0)]['findOne']({'where':{'userId':_0x94ee8f,'orderId':_0x496bb8}});if(!_0x3dfc41)throw new common_1[(_0x4fc475(0x168))](_0x4fc475(0x196),common_1[_0x4fc475(0x1f8)][_0x4fc475(0x19b)]);const _0x2194a0=await this[_0x4fc475(0x17b)]['findOne']({'where':{'id':_0x3dfc41[_0x4fc475(0x1cb)]}});if(!_0x2194a0)throw new common_1['HttpException']('套餐不存在!',common_1[_0x4fc475(0x1f8)][_0x4fc475(0x19b)]);const {payWeChatAppId:_0x1652a3,payWeChatMchId:_0x39d461,payWeChatPublicKey:_0x1efebf,payWeChatPrivateKey:_0x6119c0,payWeChatNotifyUrl:_0x768178}=await this[_0x4fc475(0x16e)][_0x4fc475(0x1ee)]([_0x4fc475(0x173),_0x4fc475(0x203),'payWeChatPublicKey','payWeChatPrivateKey','payWeChatNotifyUrl']),_0x41d566=new this[(_0x4fc475(0x201))]({'appid':_0x1652a3,'mchid':_0x39d461,'publicKey':_0x1efebf,'privateKey':_0x6119c0}),_0x3eb38e={'appid':_0x1652a3,'mchid':_0x39d461,'description':_0x2194a0[_0x4fc475(0x18a)],'out_trade_no':_0x496bb8,'notify_url':_0x768178,'amount':{'total':Math[_0x4fc475(0x1f4)](_0x3dfc41['total']*0x64)}};common_1[_0x4fc475(0x161)][_0x4fc475(0x216)](_0x4fc475(0x1bf),_0x3eb38e);if(_0x24038f==_0x4fc475(0x1ec)){common_1[_0x4fc475(0x161)][_0x4fc475(0x216)](_0x4fc475(0x215)+_0x94ee8f+_0x4fc475(0x17f)+_0x496bb8);const _0x476d76=await this[_0x4fc475(0x1d8)]['getOpenIdByUserId'](_0x94ee8f);common_1[_0x4fc475(0x161)]['log'](_0x4fc475(0x20e)+_0x476d76),_0x3eb38e[_0x4fc475(0x184)]={'openid':_0x476d76},common_1[_0x4fc475(0x161)][_0x4fc475(0x216)](_0x4fc475(0x16d),JSON[_0x4fc475(0x1d9)](_0x3eb38e,null,0x2));try{const _0x245a8a=await _0x41d566[_0x4fc475(0x18d)](_0x3eb38e),_0x4159af=_0x245a8a[_0x4fc475(0x18c)]?_0x245a8a[_0x4fc475(0x18c)]:_0x245a8a;return common_1['Logger']['log'](_0x4fc475(0x190),JSON[_0x4fc475(0x1d9)](_0x4159af,null,0x2)),{'status':_0x245a8a[_0x4fc475(0x199)]||_0x4fc475(0x1e5),'appId':_0x4159af[_0x4fc475(0x211)]||((_0x2aa87c=_0x4159af[_0x4fc475(0x18c)])===null||_0x2aa87c===void 0x0?void 0x0:_0x2aa87c['appId']),'timeStamp':_0x4159af[_0x4fc475(0x1d6)]||((_0x4ce828=_0x4159af[_0x4fc475(0x18c)])===null||_0x4ce828===void 0x0?void 0x0:_0x4ce828['timeStamp']),'nonceStr':_0x4159af[_0x4fc475(0x1c4)]||((_0x470e27=_0x4159af[_0x4fc475(0x18c)])===null||_0x470e27===void 0x0?void 0x0:_0x470e27[_0x4fc475(0x1c4)]),'package':_0x4159af[_0x4fc475(0x155)]||((_0x5d7b1a=_0x4159af[_0x4fc475(0x18c)])===null||_0x5d7b1a===void 0x0?void 0x0:_0x5d7b1a[_0x4fc475(0x155)]),'signType':_0x4159af['signType']||((_0x4a1274=_0x4159af[_0x4fc475(0x18c)])===null||_0x4a1274===void 0x0?void 0x0:_0x4a1274[_0x4fc475(0x1d0)]),'paySign':_0x4159af[_0x4fc475(0x1dc)]||((_0x2246df=_0x4159af[_0x4fc475(0x18c)])===null||_0x2246df===void 0x0?void 0x0:_0x2246df['paySign'])};}catch(_0xbe28c4){console[_0x4fc475(0x1e4)]('[WeChat\x20Pay\x20JSAPI]\x20支付请求过程中发生错误:\x20'+_0xbe28c4[_0x4fc475(0x1fb)],_0xbe28c4),console[_0x4fc475(0x1e4)]('[WeChat\x20Pay\x20JSAPI]\x20完整的错误对象：',_0xbe28c4);throw new common_1[(_0x4fc475(0x168))](_0x4fc475(0x16f),common_1[_0x4fc475(0x1f8)][_0x4fc475(0x19b)]);}}if(_0x24038f==_0x4fc475(0x179)){common_1[_0x4fc475(0x161)][_0x4fc475(0x216)](_0x4fc475(0x19a)+_0x496bb8+_0x4fc475(0x1c9)+_0x94ee8f);try{const _0x11e52e=await _0x41d566[_0x4fc475(0x1c8)](_0x3eb38e);common_1[_0x4fc475(0x161)][_0x4fc475(0x216)](_0x4fc475(0x219),JSON[_0x4fc475(0x1d9)](_0x11e52e,null,0x2));let _0x1e8344=_0x11e52e[_0x4fc475(0x1f0)]||((_0x2e5a95=_0x11e52e[_0x4fc475(0x18c)])===null||_0x2e5a95===void 0x0?void 0x0:_0x2e5a95[_0x4fc475(0x1f0)]);return!_0x1e8344?console[_0x4fc475(0x1e4)](_0x4fc475(0x1a0),JSON[_0x4fc475(0x1d9)](_0x11e52e,null,0x2)):common_1[_0x4fc475(0x161)][_0x4fc475(0x216)](_0x4fc475(0x1f6)+_0x1e8344),{'url_qrcode':_0x1e8344,'isRedirect':![]};}catch(_0x5b859a){console[_0x4fc475(0x1e4)](_0x4fc475(0x1d1)+_0x5b859a[_0x4fc475(0x1fb)],_0x5b859a),console[_0x4fc475(0x1e4)](_0x4fc475(0x1d2),_0x5b859a);throw new common_1['HttpException'](_0x4fc475(0x1c5),common_1['HttpStatus'][_0x4fc475(0x19b)]);}}else{console[_0x4fc475(0x187)](_0x4fc475(0x171)+_0x24038f);throw new common_1[(_0x4fc475(0x168))]('unsupported\x20pay\x20type',common_1['HttpStatus']['BAD_REQUEST']);}}async['queryWeChat'](_0xb2b913){const _0x6c8cd8=_0x53ef7c,{payWeChatAppId:_0x21915e,payWeChatMchId:_0x51d837,payWeChatPublicKey:_0x30d1c2,payWeChatPrivateKey:_0x58711e,payWeChatNotifyUrl:_0x4cdffa}=await this[_0x6c8cd8(0x16e)]['getConfigs']([_0x6c8cd8(0x173),_0x6c8cd8(0x203),_0x6c8cd8(0x1dd),'payWeChatPrivateKey']),_0x2cfede=new this[(_0x6c8cd8(0x201))]({'appid':_0x21915e,'mchid':_0x51d837,'publicKey':_0x30d1c2,'privateKey':_0x58711e}),_0x3a71c4=await _0x2cfede[_0x6c8cd8(0x1ac)]({'out_trade_no':_0xb2b913});return _0x3a71c4;}[_0x53ef7c(0x18e)](_0x3a98a2,_0x10ad8b){const _0x585901=_0x53ef7c,_0x4a769d=Object[_0x585901(0x15d)](_0x3a98a2)[_0x585901(0x223)]()[_0x585901(0x1e0)](_0x4f4b29=>_0x4f4b29+'='+_0x3a98a2[_0x4f4b29])[_0x585901(0x21b)]('&')+_0x10ad8b;return crypto['createHash']('md5')[_0x585901(0x1b9)](_0x4a769d)['digest']('hex');}[_0x53ef7c(0x1b0)](_0x4be56f,_0x41e6f7){const _0x39f761=_0x53ef7c,_0x3e31a8=Object[_0x39f761(0x15d)](_0x4be56f);_0x3e31a8[_0x39f761(0x223)]();const _0x1b13e0=[];_0x3e31a8['map'](_0xdb487c=>{const _0x4a2743=_0x39f761;_0x1b13e0[_0x4a2743(0x1f9)](_0xdb487c+'='+_0x4be56f[_0xdb487c]);}),_0x1b13e0[_0x39f761(0x1f9)](_0x39f761(0x1da)+_0x41e6f7);const _0xfd5ca0=_0x1b13e0['join']('&');return crypto['createHash'](_0x39f761(0x1e3))[_0x39f761(0x1b9)](_0xfd5ca0)[_0x39f761(0x17a)](_0x39f761(0x1e6))['toUpperCase']();}async['payLtzf'](_0x39c702,_0x265646,_0x1d552b=_0x53ef7c(0x17e)){const _0x1bbfef=_0x53ef7c,_0x5e58c2=await this['orderEntity']['findOne']({'where':{'userId':_0x39c702,'orderId':_0x265646}});if(!_0x5e58c2)throw new common_1[(_0x1bbfef(0x168))](_0x1bbfef(0x196),common_1[_0x1bbfef(0x1f8)][_0x1bbfef(0x19b)]);const _0x571375=await this[_0x1bbfef(0x17b)]['findOne']({'where':{'id':_0x5e58c2[_0x1bbfef(0x1cb)]}});if(!_0x571375)throw new common_1[(_0x1bbfef(0x168))](_0x1bbfef(0x1a1),common_1[_0x1bbfef(0x1f8)][_0x1bbfef(0x19b)]);const {payLtzfMchId:_0x17cd10,payLtzfSecret:_0x1744ac,payLtzfNotifyUrl:_0x1a9ab0,payLtzfReturnUrl:_0x4add48}=await this[_0x1bbfef(0x16e)][_0x1bbfef(0x1ee)]([_0x1bbfef(0x195),_0x1bbfef(0x172),_0x1bbfef(0x15a),'payLtzfReturnUrl']),_0x2f31e0={};_0x2f31e0[_0x1bbfef(0x18f)]=_0x17cd10,_0x2f31e0['timestamp']=(Date[_0x1bbfef(0x1df)]()/0x3e8)[_0x1bbfef(0x214)](0x0),_0x2f31e0[_0x1bbfef(0x19c)]=_0x265646,_0x2f31e0['body']=_0x571375[_0x1bbfef(0x18a)],_0x2f31e0[_0x1bbfef(0x1c6)]=_0x5e58c2['total'],_0x2f31e0[_0x1bbfef(0x185)]=_0x1a9ab0,_0x2f31e0[_0x1bbfef(0x18e)]=this[_0x1bbfef(0x1b0)](_0x2f31e0,_0x1744ac),_0x2f31e0[_0x1bbfef(0x177)]=_0x1bbfef(0x20b),_0x2f31e0[_0x1bbfef(0x1ef)]=_0x4add48;const _0x36804a=Object[_0x1bbfef(0x15d)](_0x2f31e0)[_0x1bbfef(0x1e0)](_0x1424f0=>encodeURIComponent(_0x1424f0)+'='+encodeURIComponent(_0x2f31e0[_0x1424f0]))['join']('&'),_0x48307d={'headers':{'Content-Type':_0x1bbfef(0x1a6)}},_0x564a43=await axios_1['default'][_0x1bbfef(0x1a5)](_0x1bbfef(0x188),_0x36804a,_0x48307d),{code:_0x2a16b8,data:_0x5b9dee,msg:_0x190e8c}=_0x564a43[_0x1bbfef(0x18c)];if(_0x2a16b8!=0x0)throw new common_1['HttpException'](_0x190e8c,common_1[_0x1bbfef(0x1f8)][_0x1bbfef(0x19b)]);const _0x5cb0e5=_0x5b9dee[_0x1bbfef(0x19e)],_0x223a3a=_0x5b9dee[_0x1bbfef(0x1d3)];return{'url_qrcode':_0x5cb0e5,'url':_0x223a3a};}async[_0x53ef7c(0x217)](_0x42d206){const _0x1d508f=_0x53ef7c,{payLtzfMchId:_0x236355,payLtzfSecret:_0x5b42de}=await this[_0x1d508f(0x16e)][_0x1d508f(0x1ee)]([_0x1d508f(0x195),'payLtzfSecret']),_0x873cbc={};_0x873cbc[_0x1d508f(0x18f)]=_0x236355,_0x873cbc['timestamp']=(Date['now']()/0x3e8)[_0x1d508f(0x214)](0x0),_0x873cbc[_0x1d508f(0x19c)]=_0x42d206,_0x873cbc[_0x1d508f(0x18e)]=this['ltzfSign'](_0x873cbc,_0x5b42de);const _0x57c974=Object[_0x1d508f(0x15d)](_0x873cbc)[_0x1d508f(0x1e0)](_0xc58965=>encodeURIComponent(_0xc58965)+'='+encodeURIComponent(_0x873cbc[_0xc58965]))[_0x1d508f(0x21b)]('&'),_0x3c33c2={'headers':{'Content-Type':_0x1d508f(0x1a6)}},{data:{code:_0x41386e,msg:_0x3245bc,data:_0x217d3c}}=await axios_1[_0x1d508f(0x1fe)][_0x1d508f(0x1a5)](_0x1d508f(0x15f),_0x57c974,_0x3c33c2);if(_0x41386e!=0x0)throw new common_1[(_0x1d508f(0x168))](_0x3245bc+JSON[_0x1d508f(0x1d9)](_0x873cbc),common_1[_0x1d508f(0x1f8)][_0x1d508f(0x19b)]);return _0x217d3c;}async['notifyLtzf'](_0x176d7c){const _0x1c79f4=_0x53ef7c,_0x3b451c=await this[_0x1c79f4(0x16e)][_0x1c79f4(0x1ee)](['payLtzfSecret']),_0x4a0c26=_0x176d7c['sign'];delete _0x176d7c[_0x1c79f4(0x18e)],delete _0x176d7c[_0x1c79f4(0x164)],delete _0x176d7c[_0x1c79f4(0x1e1)],delete _0x176d7c[_0x1c79f4(0x165)],delete _0x176d7c['attach'],delete _0x176d7c[_0x1c79f4(0x209)];if(this['ltzfSign'](_0x176d7c,_0x3b451c)!=_0x4a0c26)return _0x1c79f4(0x1e9);const _0x27bff2=await this['orderEntity']['findOne']({'where':{'orderId':_0x176d7c[_0x1c79f4(0x19c)],'status':0x0}});if(!_0x27bff2)return _0x1c79f4(0x1e9);await this[_0x1c79f4(0x1a3)][_0x1c79f4(0x1bb)](_0x27bff2);const _0x22c341=await this[_0x1c79f4(0x1c0)][_0x1c79f4(0x1b9)]({'orderId':_0x176d7c[_0x1c79f4(0x19c)]},{'status':0x1,'paydAt':new Date()});if(_0x22c341[_0x1c79f4(0x156)]!=0x1)return'FAIL';return _0x1c79f4(0x17d);}};PayService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x53ef7c(0x175)])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(order_entity_1[_0x53ef7c(0x193)])),__metadata(_0x53ef7c(0x21a),[typeorm_2[_0x53ef7c(0x1de)],typeorm_2[_0x53ef7c(0x1de)],userBalance_service_1[_0x53ef7c(0x213)],globalConfig_service_1[_0x53ef7c(0x169)],user_service_1['UserService']])],PayService),exports[_0x53ef7c(0x1ab)]=PayService;