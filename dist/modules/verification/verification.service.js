'use strict';const _0x16664d=_0x3cec;(function(_0x2e44e5,_0x501a95){const _0x264029=_0x3cec,_0x361f6c=_0x2e44e5();while(!![]){try{const _0x2e9132=-parseInt(_0x264029(0xba))/0x1+parseInt(_0x264029(0xbf))/0x2+-parseInt(_0x264029(0xcb))/0x3+-parseInt(_0x264029(0xef))/0x4+parseInt(_0x264029(0xb2))/0x5*(-parseInt(_0x264029(0xf1))/0x6)+-parseInt(_0x264029(0xc3))/0x7+parseInt(_0x264029(0xf7))/0x8;if(_0x2e9132===_0x501a95)break;else _0x361f6c['push'](_0x361f6c['shift']());}catch(_0x1ea3e6){_0x361f6c['push'](_0x361f6c['shift']());}}}(_0x2e87,0xf2c2d));var __decorate=this&&this[_0x16664d(0xcc)]||function(_0x5b8ecb,_0x25732,_0x3887bd,_0x4fd8ad){const _0x2c784f=_0x16664d;var _0x1a6cbc=arguments[_0x2c784f(0xf5)],_0x5840c4=_0x1a6cbc<0x3?_0x25732:_0x4fd8ad===null?_0x4fd8ad=Object[_0x2c784f(0xd2)](_0x25732,_0x3887bd):_0x4fd8ad,_0x12375a;if(typeof Reflect==='object'&&typeof Reflect[_0x2c784f(0xe8)]===_0x2c784f(0xbb))_0x5840c4=Reflect['decorate'](_0x5b8ecb,_0x25732,_0x3887bd,_0x4fd8ad);else{for(var _0x35609d=_0x5b8ecb[_0x2c784f(0xf5)]-0x1;_0x35609d>=0x0;_0x35609d--)if(_0x12375a=_0x5b8ecb[_0x35609d])_0x5840c4=(_0x1a6cbc<0x3?_0x12375a(_0x5840c4):_0x1a6cbc>0x3?_0x12375a(_0x25732,_0x3887bd,_0x5840c4):_0x12375a(_0x25732,_0x3887bd))||_0x5840c4;}return _0x1a6cbc>0x3&&_0x5840c4&&Object[_0x2c784f(0xb6)](_0x25732,_0x3887bd,_0x5840c4),_0x5840c4;},__metadata=this&&this[_0x16664d(0xf9)]||function(_0x2a93f9,_0x19ce76){const _0x5a8f51=_0x16664d;if(typeof Reflect==='object'&&typeof Reflect[_0x5a8f51(0xf6)]==='function')return Reflect[_0x5a8f51(0xf6)](_0x2a93f9,_0x19ce76);},__param=this&&this['__param']||function(_0x3e1d21,_0x31c81d){return function(_0x1d04dc,_0x35a602){_0x31c81d(_0x1d04dc,_0x35a602,_0x3e1d21);};};Object[_0x16664d(0xb6)](exports,_0x16664d(0xe6),{'value':!![]}),exports[_0x16664d(0xad)]=void 0x0;const utils_1=require(_0x16664d(0xd7)),globalConfig_service_1=require('../globalConfig/globalConfig.service'),common_1=require(_0x16664d(0xc2)),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require('typeorm'),redisCache_service_1=require('../redisCache/redisCache.service'),status_constant_1=require(_0x16664d(0xe9)),verification_constant_1=require(_0x16664d(0x101)),verifycation_entity_1=require(_0x16664d(0xd9)),Core=require(_0x16664d(0xce)),axios_1=require(_0x16664d(0xc9)),nodemailer=require(_0x16664d(0xe4));let VerificationService=class VerificationService{constructor(_0x37a2fd,_0x96b086,_0x2581d6){const _0x1c6c73=_0x16664d;this['verifycationEntity']=_0x37a2fd,this[_0x1c6c73(0xfc)]=_0x96b086,this['redisCacheService']=_0x2581d6;}[_0x16664d(0xd1)](_0x2a3866){const _0x20dd85=_0x16664d;switch(_0x2a3866){case verification_constant_1['VerificationEnum']['ThirdPartyAuth']:return 0x3c;case verification_constant_1[_0x20dd85(0x100)]['Registration']:case verification_constant_1[_0x20dd85(0x100)][_0x20dd85(0xb3)]:return 0x5*0x3c;case verification_constant_1[_0x20dd85(0x100)][_0x20dd85(0xb8)]:return 0x1e*0x3c;default:return 0x5*0x3c;}}async['createVerification'](_0x2087f8,_0xb43400,_0x17bd93){const _0x45e1e4=_0x16664d,_0x157ba2=await this[_0x45e1e4(0xee)][_0x45e1e4(0xb9)]({'where':{'userId':_0x2087f8['id'],'type':_0xb43400},'order':{'createdAt':_0x45e1e4(0xf3)}});if(_0x157ba2&&_0x157ba2['createdAt']['getTime']()+0x1*0x3c*0x3e8>Date[_0x45e1e4(0xc4)]()){const _0x517c77=Math[_0x45e1e4(0xaf)]((_0x157ba2[_0x45e1e4(0xe5)]['getTime']()+0x1*0x3c*0x3e8-Date['now']())/0x3e8);throw new common_1[(_0x45e1e4(0xd0))](_0x517c77+_0x45e1e4(0xe3),common_1['HttpStatus'][_0x45e1e4(0xda)]);}const _0x1918f9=(0x0,utils_1[_0x45e1e4(0xd3)])(),_0x358a2b=new Date(Date['now']()+(_0x17bd93||this[_0x45e1e4(0xd1)](_0xb43400))*0x3e8),{id:_0xbe7efd,email:_0x166a52}=_0x2087f8,_0x23271b={'userId':_0xbe7efd,'type':_0xb43400,'code':_0x1918f9,'expiresAt':_0x358a2b,'email':_0x166a52};return await this['verifycationEntity'][_0x45e1e4(0xcf)](_0x23271b);}async[_0x16664d(0xdb)]({code:_0x1aa746,id:_0x3d4acd},_0x125c13){const _0x56884a=_0x16664d,_0x3332dd=await this[_0x56884a(0xee)][_0x56884a(0xb9)]({'where':{'id':_0x3d4acd,'type':_0x125c13},'order':{'createdAt':_0x56884a(0xf3)}});if(!_0x3332dd)throw new common_1[(_0x56884a(0xd0))]('验证码不存在',common_1[_0x56884a(0xb7)][_0x56884a(0xda)]);if(_0x3332dd[_0x56884a(0xd6)]===status_constant_1['VerificationUseStatusEnum'][_0x56884a(0xe7)])throw new common_1[(_0x56884a(0xd0))]('当前验证码已被使用！',common_1[_0x56884a(0xb7)][_0x56884a(0xda)]);else _0x3332dd['used']=status_constant_1['VerificationUseStatusEnum']['USED'],await this['verifycationEntity'][_0x56884a(0xc1)]({'id':_0x3d4acd},_0x3332dd);if(Number(_0x3332dd['code'])!==Number(_0x1aa746))throw new common_1[(_0x56884a(0xd0))](_0x56884a(0xd4),common_1[_0x56884a(0xb7)][_0x56884a(0xda)]);if(_0x3332dd['expiresAt']<new Date())throw new common_1['HttpException'](_0x56884a(0xf4),common_1['HttpStatus']['BAD_REQUEST']);return _0x3332dd;}async['sendPhoneCode'](_0x168b2b){const _0x5dddea=_0x16664d;var _0x333b72;const {accessKeyId:_0x21c441,accessKeySecret:_0x361d41,SignName:_0x29d06e,TemplateCode:_0x30c5c8}=await this[_0x5dddea(0xfc)]['getPhoneVerifyConfig']();console['log'](_0x5dddea(0xe0),_0x168b2b);const {phone:_0x58aca2,code:_0x3babb5}=_0x168b2b;if(!_0x58aca2||!_0x3babb5)throw new common_1[(_0x5dddea(0xd0))](_0x5dddea(0xf8),common_1[_0x5dddea(0xb7)][_0x5dddea(0xda)]);const _0x4de782=new Core({'accessKeyId':_0x21c441,'accessKeySecret':_0x361d41,'endpoint':_0x5dddea(0xd8),'apiVersion':_0x5dddea(0xc8)}),_0x33a6d5={'PhoneNumbers':_0x58aca2,'SignName':_0x29d06e,'TemplateCode':_0x30c5c8,'TemplateParam':JSON[_0x5dddea(0xbd)]({'code':_0x3babb5})},_0xb41168={'method':_0x5dddea(0xcd),'formatParams':![]};try{const _0x34b68d=await _0x4de782['request'](_0x5dddea(0xdf),_0x33a6d5,_0xb41168);if(_0x34b68d[_0x5dddea(0xbc)]==='OK')return!![];else throw new common_1[(_0x5dddea(0xd0))](_0x34b68d[_0x5dddea(0xed)]||_0x5dddea(0xea),common_1[_0x5dddea(0xb7)]['BAD_REQUEST']);}catch(_0x42695b){throw new common_1[(_0x5dddea(0xd0))](((_0x333b72=_0x42695b===null||_0x42695b===void 0x0?void 0x0:_0x42695b[_0x5dddea(0xeb)])===null||_0x333b72===void 0x0?void 0x0:_0x333b72['Message'])||_0x5dddea(0xea),common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x16664d(0xb4)](_0x261add){const _0x1dddc9=_0x16664d,{email:_0x25ec9c,code:_0x4e42dd}=_0x261add;if(!_0x25ec9c||!_0x4e42dd)throw new common_1[(_0x1dddc9(0xd0))]('缺少必要参数！',common_1['HttpStatus'][_0x1dddc9(0xda)]);const {emailHost:_0x42a10e,emailPort:_0x218348,emailUser:_0x34a45f,emailPass:_0x40b484}=await this[_0x1dddc9(0xfc)][_0x1dddc9(0xdc)](),_0xe2a47f=nodemailer[_0x1dddc9(0xff)]({'host':_0x42a10e,'port':_0x218348,'secure':!![],'auth':{'user':_0x34a45f,'pass':_0x40b484}});try{return await _0xe2a47f[_0x1dddc9(0xae)]({'from':_0x34a45f,'to':_0x25ec9c,'subject':'验证码','text':_0x1dddc9(0xfe)+_0x4e42dd+'，30分钟内有效。','html':_0x1dddc9(0xc0)+_0x4e42dd+'</strong></p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>此验证码30分钟内有效。</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>如果这不是您的操作，请忽略此邮件。</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20'}),!![];}catch(_0x23ea43){throw new common_1[(_0x1dddc9(0xd0))]((_0x23ea43===null||_0x23ea43===void 0x0?void 0x0:_0x23ea43[_0x1dddc9(0xc6)])||_0x1dddc9(0xea),common_1[_0x1dddc9(0xb7)][_0x1dddc9(0xda)]);}}async[_0x16664d(0xbe)](_0x1b615d){const _0x8fb8f9=_0x16664d,_0x5aa8eb=await this[_0x8fb8f9(0xfc)]['getConfigs'](['appCode']),{name:_0x10144c,idCard:_0x1cbbf7}=_0x1b615d;if(!_0x10144c||!_0x1cbbf7)throw new common_1[(_0x8fb8f9(0xd0))](_0x8fb8f9(0xb0),common_1['HttpStatus'][_0x8fb8f9(0xda)]);common_1[_0x8fb8f9(0xfa)]['debug'](_0x8fb8f9(0x102)+_0x10144c+',\x20'+_0x1cbbf7);const _0x4f0c48='https://eid.shumaidata.com/eid/check',_0x19c4ed={'Authorization':'APPCODE\x20'+_0x5aa8eb,'Content-Type':_0x8fb8f9(0xb5)},_0x2cdb74=new URLSearchParams({'name':_0x10144c,'idcard':_0x1cbbf7});try{const _0x11d75b=await axios_1[_0x8fb8f9(0xb1)][_0x8fb8f9(0xe1)](_0x4f0c48,_0x2cdb74,{'headers':_0x19c4ed}),_0x414003=JSON['stringify'](_0x11d75b[_0x8fb8f9(0xeb)]);common_1[_0x8fb8f9(0xfa)]['debug'](_0x8fb8f9(0xc5)+_0x414003);switch(_0x11d75b[_0x8fb8f9(0xeb)][_0x8fb8f9(0xd5)][_0x8fb8f9(0xe2)]){case'1':return!![];case'2':common_1[_0x8fb8f9(0xfa)]['log']('验证不一致',_0x8fb8f9(0xad));case'3':common_1[_0x8fb8f9(0xfa)][_0x8fb8f9(0xc7)](_0x8fb8f9(0xfd),'VerificationService');default:common_1[_0x8fb8f9(0xfa)][_0x8fb8f9(0xc7)](_0x8fb8f9(0xf0),'VerificationService');}return![];}catch(_0x27f34b){return common_1[_0x8fb8f9(0xfa)][_0x8fb8f9(0xdd)]('Error:\x20'+_0x27f34b[_0x8fb8f9(0xc6)],_0x27f34b[_0x8fb8f9(0xca)],'Verification'),![];}}};function _0x2e87(){const _0x5f5648=['5000658BTHDSc','design:paramtypes','DESC','验证码已过期','length','metadata','57490424KvltWu','确实必要参数错误！','__metadata','Logger','RedisCacheService','globalConfigService','实名认证异常','您的验证码是：','createTransport','VerificationEnum','./../../common/constants/verification.constant','Received\x20identityInfo:\x20','VerificationService','sendMail','ceil','缺少必要参数！','default','5WuxZbJ','PasswordReset','sendEmailCode','application/x-www-form-urlencoded','defineProperty','HttpStatus','ChangeEmail','findOne','1671232cKCaeF','function','Code','stringify','verifyIdentity','1556880lsTwvc','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h1>验证码</h1>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>您的验证码是：<strong>','update','@nestjs/common','10509933lhpYPx','now','Received\x20response:\x20','message','log','2017-05-25','axios','stack','4513293Pxsqnh','__decorate','POST','@alicloud/pop-core','save','HttpException','getExpirationTime','getOwnPropertyDescriptor','createRandomCode','验证码错误','result','used','../../common/utils','https://dysmsapi.aliyuncs.com','./verifycation.entity','BAD_REQUEST','verifyCode','getEmailConfig','error','Repository','SendSms','Received\x20messageInfo:','post','res','S内不得重新发送','nodemailer','createdAt','__esModule','USED','decorate','./../../common/constants/status.constant','验证码发送失败！','data','VerifycationEntity','Message','verifycationEntity','5839476GrKZKV','未知的认证结果'];_0x2e87=function(){return _0x5f5648;};return _0x2e87();}function _0x3cec(_0x1c3ffe,_0x27830c){const _0x2e875d=_0x2e87();return _0x3cec=function(_0x3cec76,_0x5969d6){_0x3cec76=_0x3cec76-0xad;let _0x50e3c2=_0x2e875d[_0x3cec76];return _0x50e3c2;},_0x3cec(_0x1c3ffe,_0x27830c);}VerificationService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(verifycation_entity_1[_0x16664d(0xec)])),__metadata(_0x16664d(0xf2),[typeorm_2[_0x16664d(0xde)],globalConfig_service_1['GlobalConfigService'],redisCache_service_1[_0x16664d(0xfb)]])],VerificationService),exports[_0x16664d(0xad)]=VerificationService;