'use strict';function _0x50d4(_0x3b1e60,_0x157f2e){const _0xaefa65=_0xaefa();return _0x50d4=function(_0x50d4ff,_0x1059d9){_0x50d4ff=_0x50d4ff-0x8b;let _0x42b698=_0xaefa65[_0x50d4ff];return _0x42b698;},_0x50d4(_0x3b1e60,_0x157f2e);}const _0x3d8bd6=_0x50d4;function _0xaefa(){const _0x476e7b=['SendSms','log','./../../common/constants/verification.constant','4598816ZlFKGZ','axios','VerificationService','HttpException','__param','object','appCode','metadata','createVerification','@nestjs/typeorm','res','59238wBRUBY','7182cBQWhG','VerificationUseStatusEnum','./verifycation.entity','9553152LvxkVM','318sPRUXR','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h1>验证码</h1>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>您的验证码是：<strong>','Logger','verifycationEntity','getConfigs','getExpirationTime','function','sendEmailCode','您的验证码是：','未知的认证结果','@nestjs/common','https://dysmsapi.aliyuncs.com','缺少必要参数！','__esModule','data','S内不得重新发送','error','design:paramtypes','request','当前验证码已被使用！','sendPhoneCode','verifyCode','102454mkrOcZ','ThirdPartyAuth','ChangeEmail','now','nodemailer','BAD_REQUEST','VerifycationEntity','验证码发送失败！','getTime','save','createdAt','__decorate','getOwnPropertyDescriptor','decorate','验证码错误','createRandomCode','Error:\x20','./../../common/constants/status.constant','USED','post','Registration','RedisCacheService','Verification','@alicloud/pop-core','../../common/utils','验证码不存在','</strong></p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>此验证码30分钟内有效。</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>如果这不是您的操作，请忽略此邮件。</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20','27755pLFMUM','HttpStatus','VerificationEnum','typeorm','验证码已过期','Message','1304tWBgCj','defineProperty','InjectRepository','7560nOyEMW','debug','used','确实必要参数错误！','stack','Injectable','8482510kckQxJ','getPhoneVerifyConfig','message','update','length','application/x-www-form-urlencoded','Code','Received\x20identityInfo:\x20','code','Repository','getEmailConfig','，30分钟内有效。','验证码','findOne','stringify','globalConfigService'];_0xaefa=function(){return _0x476e7b;};return _0xaefa();}(function(_0x274e0f,_0x5f1023){const _0x159140=_0x50d4,_0x22e821=_0x274e0f();while(!![]){try{const _0x2ce65f=parseInt(_0x159140(0xeb))/0x1+parseInt(_0x159140(0xd1))/0x2*(-parseInt(_0x159140(0xd5))/0x3)+-parseInt(_0x159140(0xc5))/0x4+-parseInt(_0x159140(0xb2))/0x5+-parseInt(_0x159140(0xd4))/0x6+-parseInt(_0x159140(0xa3))/0x7*(-parseInt(_0x159140(0xa9))/0x8)+-parseInt(_0x159140(0xd0))/0x9*(-parseInt(_0x159140(0xac))/0xa);if(_0x2ce65f===_0x5f1023)break;else _0x22e821['push'](_0x22e821['shift']());}catch(_0x254d42){_0x22e821['push'](_0x22e821['shift']());}}}(_0xaefa,0xdd1e1));var __decorate=this&&this[_0x3d8bd6(0x93)]||function(_0x14d6fa,_0xe0ddaf,_0x43d657,_0x6b1cd5){const _0x590258=_0x3d8bd6;var _0x460a28=arguments[_0x590258(0xb6)],_0x3d40b1=_0x460a28<0x3?_0xe0ddaf:_0x6b1cd5===null?_0x6b1cd5=Object[_0x590258(0x94)](_0xe0ddaf,_0x43d657):_0x6b1cd5,_0x12fcb6;if(typeof Reflect===_0x590258(0xca)&&typeof Reflect[_0x590258(0x95)]===_0x590258(0xdb))_0x3d40b1=Reflect['decorate'](_0x14d6fa,_0xe0ddaf,_0x43d657,_0x6b1cd5);else{for(var _0x37e25c=_0x14d6fa[_0x590258(0xb6)]-0x1;_0x37e25c>=0x0;_0x37e25c--)if(_0x12fcb6=_0x14d6fa[_0x37e25c])_0x3d40b1=(_0x460a28<0x3?_0x12fcb6(_0x3d40b1):_0x460a28>0x3?_0x12fcb6(_0xe0ddaf,_0x43d657,_0x3d40b1):_0x12fcb6(_0xe0ddaf,_0x43d657))||_0x3d40b1;}return _0x460a28>0x3&&_0x3d40b1&&Object[_0x590258(0xaa)](_0xe0ddaf,_0x43d657,_0x3d40b1),_0x3d40b1;},__metadata=this&&this['__metadata']||function(_0x57391f,_0x5855c8){const _0x2f6c01=_0x3d8bd6;if(typeof Reflect===_0x2f6c01(0xca)&&typeof Reflect[_0x2f6c01(0xcc)]===_0x2f6c01(0xdb))return Reflect[_0x2f6c01(0xcc)](_0x57391f,_0x5855c8);},__param=this&&this[_0x3d8bd6(0xc9)]||function(_0x16befb,_0x393ed2){return function(_0x17fcf3,_0x1ddbf1){_0x393ed2(_0x17fcf3,_0x1ddbf1,_0x16befb);};};Object[_0x3d8bd6(0xaa)](exports,_0x3d8bd6(0xe2),{'value':!![]}),exports[_0x3d8bd6(0xc7)]=void 0x0;const utils_1=require(_0x3d8bd6(0xa0)),globalConfig_service_1=require('../globalConfig/globalConfig.service'),common_1=require(_0x3d8bd6(0xdf)),typeorm_1=require(_0x3d8bd6(0xce)),typeorm_2=require(_0x3d8bd6(0xa6)),redisCache_service_1=require('../redisCache/redisCache.service'),status_constant_1=require(_0x3d8bd6(0x99)),verification_constant_1=require(_0x3d8bd6(0xc4)),verifycation_entity_1=require(_0x3d8bd6(0xd3)),Core=require(_0x3d8bd6(0x9f)),axios_1=require(_0x3d8bd6(0xc6)),nodemailer=require(_0x3d8bd6(0x8c));let VerificationService=class VerificationService{constructor(_0x262c9d,_0x468495,_0x504989){const _0x4a00f2=_0x3d8bd6;this[_0x4a00f2(0xd8)]=_0x262c9d,this['globalConfigService']=_0x468495,this['redisCacheService']=_0x504989;}[_0x3d8bd6(0xda)](_0x15bc3d){const _0x452b5c=_0x3d8bd6;switch(_0x15bc3d){case verification_constant_1['VerificationEnum'][_0x452b5c(0xec)]:return 0x3c;case verification_constant_1[_0x452b5c(0xa5)][_0x452b5c(0x9c)]:case verification_constant_1[_0x452b5c(0xa5)]['PasswordReset']:return 0x5*0x3c;case verification_constant_1['VerificationEnum'][_0x452b5c(0xed)]:return 0x1e*0x3c;default:return 0x5*0x3c;}}async[_0x3d8bd6(0xcd)](_0xf08f3,_0x6e79b,_0x4d9a1a){const _0x535aef=_0x3d8bd6,_0x1f3cf5=await this['verifycationEntity']['findOne']({'where':{'userId':_0xf08f3['id'],'type':_0x6e79b},'order':{'createdAt':'DESC'}});if(_0x1f3cf5&&_0x1f3cf5[_0x535aef(0x92)]['getTime']()+0x1*0x3c*0x3e8>Date['now']()){const _0x24dbd6=Math['ceil']((_0x1f3cf5[_0x535aef(0x92)][_0x535aef(0x90)]()+0x1*0x3c*0x3e8-Date['now']())/0x3e8);throw new common_1[(_0x535aef(0xc8))](_0x24dbd6+_0x535aef(0xe4),common_1[_0x535aef(0xa4)]['BAD_REQUEST']);}const _0x4a62b3=(0x0,utils_1[_0x535aef(0x97)])(),_0x35def6=new Date(Date[_0x535aef(0x8b)]()+(_0x4d9a1a||this[_0x535aef(0xda)](_0x6e79b))*0x3e8),{id:_0x1d8b73,email:_0xc2a426}=_0xf08f3,_0x376dda={'userId':_0x1d8b73,'type':_0x6e79b,'code':_0x4a62b3,'expiresAt':_0x35def6,'email':_0xc2a426};return await this[_0x535aef(0xd8)][_0x535aef(0x91)](_0x376dda);}async[_0x3d8bd6(0xea)]({code:_0x2ebcbf,id:_0x3521e8},_0x99e08b){const _0x36bebe=_0x3d8bd6,_0x4c6d32=await this['verifycationEntity'][_0x36bebe(0xbf)]({'where':{'id':_0x3521e8,'type':_0x99e08b},'order':{'createdAt':'DESC'}});if(!_0x4c6d32)throw new common_1[(_0x36bebe(0xc8))](_0x36bebe(0xa1),common_1[_0x36bebe(0xa4)][_0x36bebe(0x8d)]);if(_0x4c6d32['used']===status_constant_1[_0x36bebe(0xd2)][_0x36bebe(0x9a)])throw new common_1[(_0x36bebe(0xc8))](_0x36bebe(0xe8),common_1[_0x36bebe(0xa4)][_0x36bebe(0x8d)]);else _0x4c6d32[_0x36bebe(0xae)]=status_constant_1[_0x36bebe(0xd2)][_0x36bebe(0x9a)],await this['verifycationEntity'][_0x36bebe(0xb5)]({'id':_0x3521e8},_0x4c6d32);if(Number(_0x4c6d32[_0x36bebe(0xba)])!==Number(_0x2ebcbf))throw new common_1[(_0x36bebe(0xc8))](_0x36bebe(0x96),common_1[_0x36bebe(0xa4)][_0x36bebe(0x8d)]);if(_0x4c6d32['expiresAt']<new Date())throw new common_1[(_0x36bebe(0xc8))](_0x36bebe(0xa7),common_1[_0x36bebe(0xa4)][_0x36bebe(0x8d)]);return _0x4c6d32;}async[_0x3d8bd6(0xe9)](_0x4771f4){const _0x49d740=_0x3d8bd6;var _0x2f20ac;const {accessKeyId:_0x2469ba,accessKeySecret:_0xcbf6f5,SignName:_0x4aeca0,TemplateCode:_0x321964}=await this[_0x49d740(0xc1)][_0x49d740(0xb3)]();console['log']('Received\x20messageInfo:',_0x4771f4);const {phone:_0x24cdc4,code:_0x348a86}=_0x4771f4;if(!_0x24cdc4||!_0x348a86)throw new common_1[(_0x49d740(0xc8))](_0x49d740(0xaf),common_1[_0x49d740(0xa4)][_0x49d740(0x8d)]);const _0x23e714=new Core({'accessKeyId':_0x2469ba,'accessKeySecret':_0xcbf6f5,'endpoint':_0x49d740(0xe0),'apiVersion':'2017-05-25'}),_0x3d3caa={'PhoneNumbers':_0x24cdc4,'SignName':_0x4aeca0,'TemplateCode':_0x321964,'TemplateParam':JSON[_0x49d740(0xc0)]({'code':_0x348a86})},_0x1ee82a={'method':'POST','formatParams':![]};try{const _0xb9ae23=await _0x23e714[_0x49d740(0xe7)](_0x49d740(0xc2),_0x3d3caa,_0x1ee82a);if(_0xb9ae23[_0x49d740(0xb8)]==='OK')return!![];else throw new common_1[(_0x49d740(0xc8))](_0xb9ae23['Message']||_0x49d740(0x8f),common_1[_0x49d740(0xa4)][_0x49d740(0x8d)]);}catch(_0xa1d24d){throw new common_1[(_0x49d740(0xc8))](((_0x2f20ac=_0xa1d24d===null||_0xa1d24d===void 0x0?void 0x0:_0xa1d24d[_0x49d740(0xe3)])===null||_0x2f20ac===void 0x0?void 0x0:_0x2f20ac[_0x49d740(0xa8)])||_0x49d740(0x8f),common_1[_0x49d740(0xa4)][_0x49d740(0x8d)]);}}async[_0x3d8bd6(0xdc)](_0x208b6f){const _0x5a979f=_0x3d8bd6,{email:_0x313b8e,code:_0x362f4d}=_0x208b6f;if(!_0x313b8e||!_0x362f4d)throw new common_1[(_0x5a979f(0xc8))](_0x5a979f(0xe1),common_1['HttpStatus'][_0x5a979f(0x8d)]);const {emailHost:_0x2f7442,emailPort:_0x3545ec,emailUser:_0x159143,emailPass:_0x20a672}=await this[_0x5a979f(0xc1)][_0x5a979f(0xbc)](),_0x2489fc=nodemailer['createTransport']({'host':_0x2f7442,'port':_0x3545ec,'secure':!![],'auth':{'user':_0x159143,'pass':_0x20a672}});try{return await _0x2489fc['sendMail']({'from':_0x159143,'to':_0x313b8e,'subject':_0x5a979f(0xbe),'text':_0x5a979f(0xdd)+_0x362f4d+_0x5a979f(0xbd),'html':_0x5a979f(0xd6)+_0x362f4d+_0x5a979f(0xa2)}),!![];}catch(_0x475a67){throw new common_1[(_0x5a979f(0xc8))]((_0x475a67===null||_0x475a67===void 0x0?void 0x0:_0x475a67[_0x5a979f(0xb4)])||'验证码发送失败！',common_1['HttpStatus'][_0x5a979f(0x8d)]);}}async['verifyIdentity'](_0x3f41a2){const _0x35944f=_0x3d8bd6,_0x577e2a=await this['globalConfigService'][_0x35944f(0xd9)]([_0x35944f(0xcb)]),{name:_0x571b98,idCard:_0x3aa9cb}=_0x3f41a2;if(!_0x571b98||!_0x3aa9cb)throw new common_1[(_0x35944f(0xc8))](_0x35944f(0xe1),common_1[_0x35944f(0xa4)][_0x35944f(0x8d)]);common_1[_0x35944f(0xd7)][_0x35944f(0xad)](_0x35944f(0xb9)+_0x571b98+',\x20'+_0x3aa9cb);const _0x307bd1='https://eid.shumaidata.com/eid/check',_0x10e9f4={'Authorization':'APPCODE\x20'+_0x577e2a,'Content-Type':_0x35944f(0xb7)},_0x2d09ec=new URLSearchParams({'name':_0x571b98,'idcard':_0x3aa9cb});try{const _0x445f6a=await axios_1['default'][_0x35944f(0x9b)](_0x307bd1,_0x2d09ec,{'headers':_0x10e9f4}),_0x1950b8=JSON['stringify'](_0x445f6a['data']);common_1[_0x35944f(0xd7)]['debug']('Received\x20response:\x20'+_0x1950b8);switch(_0x445f6a['data']['result'][_0x35944f(0xcf)]){case'1':return!![];case'2':common_1[_0x35944f(0xd7)][_0x35944f(0xc3)]('验证不一致','VerificationService');case'3':common_1[_0x35944f(0xd7)][_0x35944f(0xc3)]('实名认证异常','VerificationService');default:common_1[_0x35944f(0xd7)][_0x35944f(0xc3)](_0x35944f(0xde),_0x35944f(0xc7));}return![];}catch(_0x556b57){return common_1[_0x35944f(0xd7)][_0x35944f(0xe5)](_0x35944f(0x98)+_0x556b57['message'],_0x556b57[_0x35944f(0xb0)],_0x35944f(0x9e)),![];}}};VerificationService=__decorate([(0x0,common_1[_0x3d8bd6(0xb1)])(),__param(0x0,(0x0,typeorm_1[_0x3d8bd6(0xab)])(verifycation_entity_1[_0x3d8bd6(0x8e)])),__metadata(_0x3d8bd6(0xe6),[typeorm_2[_0x3d8bd6(0xbb)],globalConfig_service_1['GlobalConfigService'],redisCache_service_1[_0x3d8bd6(0x9d)]])],VerificationService),exports[_0x3d8bd6(0xc7)]=VerificationService;