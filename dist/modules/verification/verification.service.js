'use strict';const _0x16ce1d=_0x2a39;(function(_0x452173,_0x33cc4e){const _0x2156a6=_0x2a39,_0x39c213=_0x452173();while(!![]){try{const _0x567364=parseInt(_0x2156a6(0xdb))/0x1*(parseInt(_0x2156a6(0xe2))/0x2)+parseInt(_0x2156a6(0x12d))/0x3+parseInt(_0x2156a6(0xe4))/0x4*(parseInt(_0x2156a6(0xd6))/0x5)+-parseInt(_0x2156a6(0x118))/0x6+parseInt(_0x2156a6(0xe8))/0x7*(-parseInt(_0x2156a6(0x109))/0x8)+-parseInt(_0x2156a6(0xfa))/0x9*(-parseInt(_0x2156a6(0x11f))/0xa)+parseInt(_0x2156a6(0xd8))/0xb;if(_0x567364===_0x33cc4e)break;else _0x39c213['push'](_0x39c213['shift']());}catch(_0x5ded26){_0x39c213['push'](_0x39c213['shift']());}}}(_0x1913,0x6bec9));var __decorate=this&&this['__decorate']||function(_0x1a6c37,_0x3986da,_0x11d56d,_0x2d9055){const _0x366b0b=_0x2a39;var _0x526e1=arguments[_0x366b0b(0x11b)],_0x3efbc3=_0x526e1<0x3?_0x3986da:_0x2d9055===null?_0x2d9055=Object[_0x366b0b(0x121)](_0x3986da,_0x11d56d):_0x2d9055,_0x361116;if(typeof Reflect===_0x366b0b(0x129)&&typeof Reflect[_0x366b0b(0x11d)]===_0x366b0b(0x102))_0x3efbc3=Reflect[_0x366b0b(0x11d)](_0x1a6c37,_0x3986da,_0x11d56d,_0x2d9055);else{for(var _0x4a134e=_0x1a6c37[_0x366b0b(0x11b)]-0x1;_0x4a134e>=0x0;_0x4a134e--)if(_0x361116=_0x1a6c37[_0x4a134e])_0x3efbc3=(_0x526e1<0x3?_0x361116(_0x3efbc3):_0x526e1>0x3?_0x361116(_0x3986da,_0x11d56d,_0x3efbc3):_0x361116(_0x3986da,_0x11d56d))||_0x3efbc3;}return _0x526e1>0x3&&_0x3efbc3&&Object[_0x366b0b(0x116)](_0x3986da,_0x11d56d,_0x3efbc3),_0x3efbc3;},__metadata=this&&this[_0x16ce1d(0x100)]||function(_0x3b0efc,_0x1877ac){const _0x2ce0ea=_0x16ce1d;if(typeof Reflect===_0x2ce0ea(0x129)&&typeof Reflect['metadata']==='function')return Reflect[_0x2ce0ea(0x117)](_0x3b0efc,_0x1877ac);},__param=this&&this[_0x16ce1d(0x136)]||function(_0xe9590d,_0xccd94b){return function(_0x47267d,_0x5683ea){_0xccd94b(_0x47267d,_0x5683ea,_0xe9590d);};};function _0x1913(){const _0x4ca0c0=['decorate','未知的认证结果','102260Zmpcbo','verifyIdentity','getOwnPropertyDescriptor','VerificationEnum','InjectRepository','ceil','typeorm','post','确实必要参数错误！','expiresAt','object','message','验证码不存在','findOne','842403uJqJhB','RedisCacheService','验证码发送失败！','getExpirationTime','./../../common/constants/status.constant','../../common/utils','Message','Registration','verifyCode','__param','code','sendMail','VerificationUseStatusEnum','当前验证码已被使用！','HttpException','ThirdPartyAuth','USED','error','验证不一致','getTime','5UPFYDJ','POST','3379695ynvhVS','BAD_REQUEST','VerificationService','219LCCggp','Logger','result','DESC','./../../common/constants/verification.constant','验证码错误','globalConfigService','346zABzMa','ChangeEmail','532364qEYReg','data','appCode','PasswordReset','227927kLraCf','您的验证码是：','axios','Verification','VerifycationEntity','sendPhoneCode','../redisCache/redisCache.service','@nestjs/typeorm','getConfigs','Repository','APPCODE\x20','design:paramtypes','__esModule','update','Received\x20identityInfo:\x20','https://eid.shumaidata.com/eid/check','HttpStatus','debug','702lEyXKC','createdAt','verifycationEntity','2017-05-25','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h1>验证码</h1>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>您的验证码是：<strong>','application/x-www-form-urlencoded','__metadata','验证码已过期','function','../globalConfig/globalConfig.service','Injectable','Code','GlobalConfigService','stringify','@nestjs/common','112dbgraK','缺少必要参数！','stack','log','createRandomCode','实名认证异常','Received\x20response:\x20','request','验证码','sendEmailCode','getEmailConfig','getPhoneVerifyConfig','used','defineProperty','metadata','3952446VYDmNB','default','@alicloud/pop-core','length','now'];_0x1913=function(){return _0x4ca0c0;};return _0x1913();}function _0x2a39(_0x2a5330,_0x3bb1ca){const _0x19133c=_0x1913();return _0x2a39=function(_0x2a3910,_0x24becd){_0x2a3910=_0x2a3910-0xd3;let _0x3d010e=_0x19133c[_0x2a3910];return _0x3d010e;},_0x2a39(_0x2a5330,_0x3bb1ca);}Object['defineProperty'](exports,_0x16ce1d(0xf4),{'value':!![]}),exports[_0x16ce1d(0xda)]=void 0x0;const utils_1=require(_0x16ce1d(0x132)),globalConfig_service_1=require(_0x16ce1d(0x103)),common_1=require(_0x16ce1d(0x108)),typeorm_1=require(_0x16ce1d(0xef)),typeorm_2=require(_0x16ce1d(0x125)),redisCache_service_1=require(_0x16ce1d(0xee)),status_constant_1=require(_0x16ce1d(0x131)),verification_constant_1=require(_0x16ce1d(0xdf)),verifycation_entity_1=require('./verifycation.entity'),Core=require(_0x16ce1d(0x11a)),axios_1=require(_0x16ce1d(0xea)),nodemailer=require('nodemailer');let VerificationService=class VerificationService{constructor(_0x8c80c7,_0x35617c,_0x824563){const _0x2de6bb=_0x16ce1d;this['verifycationEntity']=_0x8c80c7,this[_0x2de6bb(0xe1)]=_0x35617c,this['redisCacheService']=_0x824563;}[_0x16ce1d(0x130)](_0x5bc8f1){const _0x367b29=_0x16ce1d;switch(_0x5bc8f1){case verification_constant_1[_0x367b29(0x122)][_0x367b29(0x13c)]:return 0x3c;case verification_constant_1['VerificationEnum'][_0x367b29(0x134)]:case verification_constant_1[_0x367b29(0x122)][_0x367b29(0xe7)]:return 0x5*0x3c;case verification_constant_1['VerificationEnum'][_0x367b29(0xe3)]:return 0x1e*0x3c;default:return 0x5*0x3c;}}async['createVerification'](_0x2f9a19,_0xe2b7e5,_0x3ec4fe){const _0x3f9b42=_0x16ce1d,_0x2ec433=await this['verifycationEntity'][_0x3f9b42(0x12c)]({'where':{'userId':_0x2f9a19['id'],'type':_0xe2b7e5},'order':{'createdAt':_0x3f9b42(0xde)}});if(_0x2ec433&&_0x2ec433[_0x3f9b42(0xfb)]['getTime']()+0x1*0x3c*0x3e8>Date['now']()){const _0x2e1d23=Math[_0x3f9b42(0x124)]((_0x2ec433[_0x3f9b42(0xfb)][_0x3f9b42(0xd5)]()+0x1*0x3c*0x3e8-Date[_0x3f9b42(0x11c)]())/0x3e8);throw new common_1[(_0x3f9b42(0x13b))](_0x2e1d23+'S内不得重新发送',common_1[_0x3f9b42(0xf8)][_0x3f9b42(0xd9)]);}const _0x4690f7=(0x0,utils_1[_0x3f9b42(0x10d)])(),_0x2053df=new Date(Date['now']()+(_0x3ec4fe||this[_0x3f9b42(0x130)](_0xe2b7e5))*0x3e8),{id:_0x51c614,email:_0xef7e43}=_0x2f9a19,_0x2ea16e={'userId':_0x51c614,'type':_0xe2b7e5,'code':_0x4690f7,'expiresAt':_0x2053df,'email':_0xef7e43};return await this[_0x3f9b42(0xfc)]['save'](_0x2ea16e);}async[_0x16ce1d(0x135)]({code:_0x2633fc,id:_0x21a882},_0x25108b){const _0x3172cd=_0x16ce1d,_0xdf94e4=await this[_0x3172cd(0xfc)][_0x3172cd(0x12c)]({'where':{'id':_0x21a882,'type':_0x25108b},'order':{'createdAt':_0x3172cd(0xde)}});if(!_0xdf94e4)throw new common_1['HttpException'](_0x3172cd(0x12b),common_1[_0x3172cd(0xf8)][_0x3172cd(0xd9)]);if(_0xdf94e4[_0x3172cd(0x115)]===status_constant_1['VerificationUseStatusEnum'][_0x3172cd(0x13d)])throw new common_1[(_0x3172cd(0x13b))](_0x3172cd(0x13a),common_1['HttpStatus'][_0x3172cd(0xd9)]);else _0xdf94e4['used']=status_constant_1[_0x3172cd(0x139)]['USED'],await this[_0x3172cd(0xfc)][_0x3172cd(0xf5)]({'id':_0x21a882},_0xdf94e4);if(Number(_0xdf94e4[_0x3172cd(0x137)])!==Number(_0x2633fc))throw new common_1['HttpException'](_0x3172cd(0xe0),common_1['HttpStatus']['BAD_REQUEST']);if(_0xdf94e4[_0x3172cd(0x128)]<new Date())throw new common_1[(_0x3172cd(0x13b))](_0x3172cd(0x101),common_1['HttpStatus'][_0x3172cd(0xd9)]);return _0xdf94e4;}async[_0x16ce1d(0xed)](_0x2da7e9){const _0x53e139=_0x16ce1d;var _0x2f09c1;const {accessKeyId:_0x12438b,accessKeySecret:_0x47e40a,SignName:_0x292841,TemplateCode:_0x33b842}=await this[_0x53e139(0xe1)][_0x53e139(0x114)]();console['log']('Received\x20messageInfo:',_0x2da7e9);const {phone:_0x2d1ab9,code:_0x4c8b8f}=_0x2da7e9;if(!_0x2d1ab9||!_0x4c8b8f)throw new common_1[(_0x53e139(0x13b))](_0x53e139(0x127),common_1[_0x53e139(0xf8)][_0x53e139(0xd9)]);const _0x317381=new Core({'accessKeyId':_0x12438b,'accessKeySecret':_0x47e40a,'endpoint':'https://dysmsapi.aliyuncs.com','apiVersion':_0x53e139(0xfd)}),_0x1bb4d3={'PhoneNumbers':_0x2d1ab9,'SignName':_0x292841,'TemplateCode':_0x33b842,'TemplateParam':JSON[_0x53e139(0x107)]({'code':_0x4c8b8f})},_0xb30eb0={'method':_0x53e139(0xd7),'formatParams':![]};try{const _0x47c2c2=await _0x317381[_0x53e139(0x110)]('SendSms',_0x1bb4d3,_0xb30eb0);if(_0x47c2c2[_0x53e139(0x105)]==='OK')return!![];else throw new common_1[(_0x53e139(0x13b))](_0x47c2c2[_0x53e139(0x133)]||'验证码发送失败！',common_1[_0x53e139(0xf8)]['BAD_REQUEST']);}catch(_0x110e21){throw new common_1['HttpException'](((_0x2f09c1=_0x110e21===null||_0x110e21===void 0x0?void 0x0:_0x110e21['data'])===null||_0x2f09c1===void 0x0?void 0x0:_0x2f09c1[_0x53e139(0x133)])||_0x53e139(0x12f),common_1[_0x53e139(0xf8)][_0x53e139(0xd9)]);}}async[_0x16ce1d(0x112)](_0x162491){const _0x5f4229=_0x16ce1d,{email:_0x51280b,code:_0x57c350}=_0x162491;if(!_0x51280b||!_0x57c350)throw new common_1[(_0x5f4229(0x13b))](_0x5f4229(0x10a),common_1[_0x5f4229(0xf8)]['BAD_REQUEST']);const {emailHost:_0x45fa34,emailPort:_0x1e7a2c,emailUser:_0x4997e6,emailPass:_0x37972a}=await this[_0x5f4229(0xe1)][_0x5f4229(0x113)](),_0x4deed2=nodemailer['createTransport']({'host':_0x45fa34,'port':_0x1e7a2c,'secure':!![],'auth':{'user':_0x4997e6,'pass':_0x37972a}});try{return await _0x4deed2[_0x5f4229(0x138)]({'from':_0x4997e6,'to':_0x51280b,'subject':_0x5f4229(0x111),'text':_0x5f4229(0xe9)+_0x57c350+'，30分钟内有效。','html':_0x5f4229(0xfe)+_0x57c350+'</strong></p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>此验证码30分钟内有效。</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>如果这不是您的操作，请忽略此邮件。</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20'}),!![];}catch(_0x1b8767){throw new common_1[(_0x5f4229(0x13b))]((_0x1b8767===null||_0x1b8767===void 0x0?void 0x0:_0x1b8767[_0x5f4229(0x12a)])||_0x5f4229(0x12f),common_1['HttpStatus'][_0x5f4229(0xd9)]);}}async[_0x16ce1d(0x120)](_0x301e68){const _0x2ee251=_0x16ce1d,_0x460acd=await this[_0x2ee251(0xe1)][_0x2ee251(0xf0)]([_0x2ee251(0xe6)]),{name:_0x3c71c1,idCard:_0x54f16b}=_0x301e68;if(!_0x3c71c1||!_0x54f16b)throw new common_1[(_0x2ee251(0x13b))](_0x2ee251(0x10a),common_1[_0x2ee251(0xf8)]['BAD_REQUEST']);common_1[_0x2ee251(0xdc)][_0x2ee251(0xf9)](_0x2ee251(0xf6)+_0x3c71c1+',\x20'+_0x54f16b);const _0x2c295c=_0x2ee251(0xf7),_0x34a150={'Authorization':_0x2ee251(0xf2)+_0x460acd,'Content-Type':_0x2ee251(0xff)},_0x554996=new URLSearchParams({'name':_0x3c71c1,'idcard':_0x54f16b});try{const _0x24856f=await axios_1[_0x2ee251(0x119)][_0x2ee251(0x126)](_0x2c295c,_0x554996,{'headers':_0x34a150}),_0x4f380c=JSON[_0x2ee251(0x107)](_0x24856f[_0x2ee251(0xe5)]);common_1[_0x2ee251(0xdc)][_0x2ee251(0xf9)](_0x2ee251(0x10f)+_0x4f380c);switch(_0x24856f['data'][_0x2ee251(0xdd)]['res']){case'1':return!![];case'2':common_1[_0x2ee251(0xdc)]['log'](_0x2ee251(0xd4),_0x2ee251(0xda));case'3':common_1['Logger'][_0x2ee251(0x10c)](_0x2ee251(0x10e),_0x2ee251(0xda));default:common_1[_0x2ee251(0xdc)][_0x2ee251(0x10c)](_0x2ee251(0x11e),'VerificationService');}return![];}catch(_0x20ecde){return common_1[_0x2ee251(0xdc)][_0x2ee251(0xd3)]('Error:\x20'+_0x20ecde[_0x2ee251(0x12a)],_0x20ecde[_0x2ee251(0x10b)],_0x2ee251(0xeb)),![];}}};VerificationService=__decorate([(0x0,common_1[_0x16ce1d(0x104)])(),__param(0x0,(0x0,typeorm_1[_0x16ce1d(0x123)])(verifycation_entity_1[_0x16ce1d(0xec)])),__metadata(_0x16ce1d(0xf3),[typeorm_2[_0x16ce1d(0xf1)],globalConfig_service_1[_0x16ce1d(0x106)],redisCache_service_1[_0x16ce1d(0x12e)]])],VerificationService),exports[_0x16ce1d(0xda)]=VerificationService;