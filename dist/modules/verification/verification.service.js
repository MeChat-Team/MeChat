'use strict';function _0x1447(){const _0x1c9b13=['156QBllie','Received\x20response:\x20','S内不得重新发送','expiresAt','488870hZEsTk','verifycationEntity','verifyCode','2qbkBqC','VerificationUseStatusEnum','defineProperty','USED','function','Code','debug','InjectRepository','stack','Repository','DESC','./../../common/constants/status.constant','./../../common/constants/verification.constant','__esModule','GlobalConfigService','__param','VerificationService','https://dysmsapi.aliyuncs.com','axios','application/x-www-form-urlencoded','Injectable','decorate','message','../../common/utils','BAD_REQUEST','now','Registration','../redisCache/redisCache.service','Logger','findOne','Error:\x20','sendPhoneCode','Received\x20messageInfo:','verifyIdentity','getPhoneVerifyConfig','request','未知的认证结果','sendMail','save','@alicloud/pop-core','验证码不存在','ThirdPartyAuth','HttpException','typeorm','POST','@nestjs/common','4qVZcZF','593937GDcHHs','getExpirationTime','20tihAAq','276RtVwAo','stringify','当前验证码已被使用！','1793816hPnUiJ','update','getEmailConfig','https://eid.shumaidata.com/eid/check','globalConfigService','确实必要参数错误！','log','redisCacheService','createdAt','metadata','createRandomCode','ChangeEmail','ceil','RedisCacheService','实名认证异常','339279mdFlMp','HttpStatus','VerificationEnum','Received\x20identityInfo:\x20','length','验证码已过期','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h1>验证码</h1>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>您的验证码是：<strong>','getTime','23191bofMAy','PasswordReset','</strong></p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>此验证码30分钟内有效。</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>如果这不是您的操作，请忽略此邮件。</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20','缺少必要参数！','createVerification','object','used','VerifycationEntity','data','验证码','getOwnPropertyDescriptor','您的验证码是：','Message','验证码发送失败！','891845VzErZT','496441GCTypa','error'];_0x1447=function(){return _0x1c9b13;};return _0x1447();}const _0x3f0d44=_0x323b;(function(_0x2656d1,_0x1e3f01){const _0x499ada=_0x323b,_0x56fa87=_0x2656d1();while(!![]){try{const _0xc4232f=-parseInt(_0x499ada(0x20f))/0x1+-parseInt(_0x499ada(0x212))/0x2*(-parseInt(_0x499ada(0x1f2))/0x3)+-parseInt(_0x499ada(0x1dc))/0x4*(-parseInt(_0x499ada(0x208))/0x5)+parseInt(_0x499ada(0x1e0))/0x6*(-parseInt(_0x499ada(0x1fa))/0x7)+parseInt(_0x499ada(0x1e3))/0x8+parseInt(_0x499ada(0x1dd))/0x9*(-parseInt(_0x499ada(0x1df))/0xa)+parseInt(_0x499ada(0x209))/0xb*(parseInt(_0x499ada(0x20b))/0xc);if(_0xc4232f===_0x1e3f01)break;else _0x56fa87['push'](_0x56fa87['shift']());}catch(_0x52062b){_0x56fa87['push'](_0x56fa87['shift']());}}}(_0x1447,0x505b2));function _0x323b(_0x5ca9de,_0x2a0149){const _0x144745=_0x1447();return _0x323b=function(_0x323bde,_0x27db74){_0x323bde=_0x323bde-0x1b2;let _0x18e511=_0x144745[_0x323bde];return _0x18e511;},_0x323b(_0x5ca9de,_0x2a0149);}var __decorate=this&&this['__decorate']||function(_0x23f9ef,_0x1f0353,_0x44f010,_0x270c08){const _0x19b9a2=_0x323b;var _0x52b80c=arguments[_0x19b9a2(0x1f6)],_0x244ff8=_0x52b80c<0x3?_0x1f0353:_0x270c08===null?_0x270c08=Object[_0x19b9a2(0x204)](_0x1f0353,_0x44f010):_0x270c08,_0x4d7de2;if(typeof Reflect===_0x19b9a2(0x1ff)&&typeof Reflect['decorate']==='function')_0x244ff8=Reflect[_0x19b9a2(0x1c3)](_0x23f9ef,_0x1f0353,_0x44f010,_0x270c08);else{for(var _0xbf3f85=_0x23f9ef[_0x19b9a2(0x1f6)]-0x1;_0xbf3f85>=0x0;_0xbf3f85--)if(_0x4d7de2=_0x23f9ef[_0xbf3f85])_0x244ff8=(_0x52b80c<0x3?_0x4d7de2(_0x244ff8):_0x52b80c>0x3?_0x4d7de2(_0x1f0353,_0x44f010,_0x244ff8):_0x4d7de2(_0x1f0353,_0x44f010))||_0x244ff8;}return _0x52b80c>0x3&&_0x244ff8&&Object[_0x19b9a2(0x214)](_0x1f0353,_0x44f010,_0x244ff8),_0x244ff8;},__metadata=this&&this['__metadata']||function(_0x3ed22d,_0x2d24bc){const _0x1c54dd=_0x323b;if(typeof Reflect==='object'&&typeof Reflect['metadata']===_0x1c54dd(0x1b2))return Reflect[_0x1c54dd(0x1ec)](_0x3ed22d,_0x2d24bc);},__param=this&&this[_0x3f0d44(0x1bd)]||function(_0x4245e2,_0x2b7d33){return function(_0x4666e6,_0x133a1f){_0x2b7d33(_0x4666e6,_0x133a1f,_0x4245e2);};};Object[_0x3f0d44(0x214)](exports,_0x3f0d44(0x1bb),{'value':!![]}),exports[_0x3f0d44(0x1be)]=void 0x0;const utils_1=require(_0x3f0d44(0x1c5)),globalConfig_service_1=require('../globalConfig/globalConfig.service'),common_1=require(_0x3f0d44(0x1db)),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0x3f0d44(0x1d9)),redisCache_service_1=require(_0x3f0d44(0x1c9)),status_constant_1=require(_0x3f0d44(0x1b9)),verification_constant_1=require(_0x3f0d44(0x1ba)),verifycation_entity_1=require('./verifycation.entity'),Core=require(_0x3f0d44(0x1d5)),axios_1=require(_0x3f0d44(0x1c0)),nodemailer=require('nodemailer');let VerificationService=class VerificationService{constructor(_0x413bd6,_0x435938,_0x403492){const _0xd61033=_0x3f0d44;this[_0xd61033(0x210)]=_0x413bd6,this['globalConfigService']=_0x435938,this[_0xd61033(0x1ea)]=_0x403492;}['getExpirationTime'](_0xdbc65c){const _0x2f216b=_0x3f0d44;switch(_0xdbc65c){case verification_constant_1['VerificationEnum'][_0x2f216b(0x1d7)]:return 0x3c;case verification_constant_1[_0x2f216b(0x1f4)][_0x2f216b(0x1c8)]:case verification_constant_1[_0x2f216b(0x1f4)][_0x2f216b(0x1fb)]:return 0x5*0x3c;case verification_constant_1['VerificationEnum'][_0x2f216b(0x1ee)]:return 0x1e*0x3c;default:return 0x5*0x3c;}}async[_0x3f0d44(0x1fe)](_0x492e1d,_0x37173f,_0x7c2476){const _0x50c03c=_0x3f0d44,_0xbf9a1c=await this['verifycationEntity'][_0x50c03c(0x1cb)]({'where':{'userId':_0x492e1d['id'],'type':_0x37173f},'order':{'createdAt':_0x50c03c(0x1b8)}});if(_0xbf9a1c&&_0xbf9a1c[_0x50c03c(0x1eb)][_0x50c03c(0x1f9)]()+0x1*0x3c*0x3e8>Date[_0x50c03c(0x1c7)]()){const _0x190904=Math[_0x50c03c(0x1ef)]((_0xbf9a1c[_0x50c03c(0x1eb)][_0x50c03c(0x1f9)]()+0x1*0x3c*0x3e8-Date['now']())/0x3e8);throw new common_1[(_0x50c03c(0x1d8))](_0x190904+_0x50c03c(0x20d),common_1[_0x50c03c(0x1f3)][_0x50c03c(0x1c6)]);}const _0x25054f=(0x0,utils_1[_0x50c03c(0x1ed)])(),_0x576fd2=new Date(Date[_0x50c03c(0x1c7)]()+(_0x7c2476||this[_0x50c03c(0x1de)](_0x37173f))*0x3e8),{id:_0x3adab4,email:_0x4e3c6c}=_0x492e1d,_0x5ee207={'userId':_0x3adab4,'type':_0x37173f,'code':_0x25054f,'expiresAt':_0x576fd2,'email':_0x4e3c6c};return await this[_0x50c03c(0x210)][_0x50c03c(0x1d4)](_0x5ee207);}async[_0x3f0d44(0x211)]({code:_0x2c68bd,id:_0x4a51ee},_0x46af44){const _0x236d6d=_0x3f0d44,_0x2cfe2b=await this[_0x236d6d(0x210)][_0x236d6d(0x1cb)]({'where':{'id':_0x4a51ee,'type':_0x46af44},'order':{'createdAt':_0x236d6d(0x1b8)}});if(!_0x2cfe2b)throw new common_1[(_0x236d6d(0x1d8))](_0x236d6d(0x1d6),common_1[_0x236d6d(0x1f3)]['BAD_REQUEST']);if(_0x2cfe2b[_0x236d6d(0x200)]===status_constant_1[_0x236d6d(0x213)][_0x236d6d(0x215)])throw new common_1['HttpException'](_0x236d6d(0x1e2),common_1[_0x236d6d(0x1f3)][_0x236d6d(0x1c6)]);else _0x2cfe2b[_0x236d6d(0x200)]=status_constant_1[_0x236d6d(0x213)]['USED'],await this['verifycationEntity'][_0x236d6d(0x1e4)]({'id':_0x4a51ee},_0x2cfe2b);if(Number(_0x2cfe2b['code'])!==Number(_0x2c68bd))throw new common_1[(_0x236d6d(0x1d8))]('验证码错误',common_1[_0x236d6d(0x1f3)][_0x236d6d(0x1c6)]);if(_0x2cfe2b[_0x236d6d(0x20e)]<new Date())throw new common_1[(_0x236d6d(0x1d8))](_0x236d6d(0x1f7),common_1[_0x236d6d(0x1f3)][_0x236d6d(0x1c6)]);return _0x2cfe2b;}async[_0x3f0d44(0x1cd)](_0x479c09){const _0x2b92f8=_0x3f0d44;var _0x5d24eb;const {accessKeyId:_0x5029bd,accessKeySecret:_0x2a57db,SignName:_0x560600,TemplateCode:_0x4b6145}=await this['globalConfigService'][_0x2b92f8(0x1d0)]();console[_0x2b92f8(0x1e9)](_0x2b92f8(0x1ce),_0x479c09);const {phone:_0x326d29,code:_0x501ddc}=_0x479c09;if(!_0x326d29||!_0x501ddc)throw new common_1['HttpException'](_0x2b92f8(0x1e8),common_1[_0x2b92f8(0x1f3)]['BAD_REQUEST']);const _0x2532b1=new Core({'accessKeyId':_0x5029bd,'accessKeySecret':_0x2a57db,'endpoint':_0x2b92f8(0x1bf),'apiVersion':'2017-05-25'}),_0x234eab={'PhoneNumbers':_0x326d29,'SignName':_0x560600,'TemplateCode':_0x4b6145,'TemplateParam':JSON[_0x2b92f8(0x1e1)]({'code':_0x501ddc})},_0x1fa76f={'method':_0x2b92f8(0x1da),'formatParams':![]};try{const _0x118d0d=await _0x2532b1[_0x2b92f8(0x1d1)]('SendSms',_0x234eab,_0x1fa76f);if(_0x118d0d[_0x2b92f8(0x1b3)]==='OK')return!![];else throw new common_1[(_0x2b92f8(0x1d8))](_0x118d0d[_0x2b92f8(0x206)]||_0x2b92f8(0x207),common_1[_0x2b92f8(0x1f3)][_0x2b92f8(0x1c6)]);}catch(_0x51bc2d){throw new common_1[(_0x2b92f8(0x1d8))](((_0x5d24eb=_0x51bc2d===null||_0x51bc2d===void 0x0?void 0x0:_0x51bc2d[_0x2b92f8(0x202)])===null||_0x5d24eb===void 0x0?void 0x0:_0x5d24eb[_0x2b92f8(0x206)])||_0x2b92f8(0x207),common_1[_0x2b92f8(0x1f3)][_0x2b92f8(0x1c6)]);}}async['sendEmailCode'](_0x1ecc29){const _0x477bf3=_0x3f0d44,{email:_0x35f0cd,code:_0x5a614d}=_0x1ecc29;if(!_0x35f0cd||!_0x5a614d)throw new common_1['HttpException'](_0x477bf3(0x1fd),common_1[_0x477bf3(0x1f3)][_0x477bf3(0x1c6)]);const {emailHost:_0x1e7914,emailPort:_0x277c22,emailUser:_0x5f4b00,emailPass:_0xf0b13b}=await this[_0x477bf3(0x1e7)][_0x477bf3(0x1e5)](),_0x708edc=nodemailer['createTransport']({'host':_0x1e7914,'port':_0x277c22,'secure':!![],'auth':{'user':_0x5f4b00,'pass':_0xf0b13b}});try{return await _0x708edc[_0x477bf3(0x1d3)]({'from':_0x5f4b00,'to':_0x35f0cd,'subject':_0x477bf3(0x203),'text':_0x477bf3(0x205)+_0x5a614d+'，30分钟内有效。','html':_0x477bf3(0x1f8)+_0x5a614d+_0x477bf3(0x1fc)}),!![];}catch(_0x4afd91){throw new common_1['HttpException']((_0x4afd91===null||_0x4afd91===void 0x0?void 0x0:_0x4afd91['message'])||'验证码发送失败！',common_1[_0x477bf3(0x1f3)]['BAD_REQUEST']);}}async[_0x3f0d44(0x1cf)](_0x291376){const _0x2ca2b3=_0x3f0d44,_0xd11fc=await this['globalConfigService']['getConfigs'](['appCode']),{name:_0x203451,idCard:_0x228ff8}=_0x291376;if(!_0x203451||!_0x228ff8)throw new common_1['HttpException'](_0x2ca2b3(0x1fd),common_1[_0x2ca2b3(0x1f3)][_0x2ca2b3(0x1c6)]);common_1['Logger']['debug'](_0x2ca2b3(0x1f5)+_0x203451+',\x20'+_0x228ff8);const _0x4c0704=_0x2ca2b3(0x1e6),_0x82f58a={'Authorization':'APPCODE\x20'+_0xd11fc,'Content-Type':_0x2ca2b3(0x1c1)},_0x2f9b55=new URLSearchParams({'name':_0x203451,'idcard':_0x228ff8});try{const _0x1a2cdf=await axios_1['default']['post'](_0x4c0704,_0x2f9b55,{'headers':_0x82f58a}),_0x2823e9=JSON['stringify'](_0x1a2cdf[_0x2ca2b3(0x202)]);common_1[_0x2ca2b3(0x1ca)][_0x2ca2b3(0x1b4)](_0x2ca2b3(0x20c)+_0x2823e9);switch(_0x1a2cdf[_0x2ca2b3(0x202)]['result']['res']){case'1':return!![];case'2':common_1[_0x2ca2b3(0x1ca)][_0x2ca2b3(0x1e9)]('验证不一致',_0x2ca2b3(0x1be));case'3':common_1[_0x2ca2b3(0x1ca)][_0x2ca2b3(0x1e9)](_0x2ca2b3(0x1f1),'VerificationService');default:common_1[_0x2ca2b3(0x1ca)][_0x2ca2b3(0x1e9)](_0x2ca2b3(0x1d2),_0x2ca2b3(0x1be));}return![];}catch(_0x100839){return common_1[_0x2ca2b3(0x1ca)][_0x2ca2b3(0x20a)](_0x2ca2b3(0x1cc)+_0x100839[_0x2ca2b3(0x1c4)],_0x100839[_0x2ca2b3(0x1b6)],'Verification'),![];}}};VerificationService=__decorate([(0x0,common_1[_0x3f0d44(0x1c2)])(),__param(0x0,(0x0,typeorm_1[_0x3f0d44(0x1b5)])(verifycation_entity_1[_0x3f0d44(0x201)])),__metadata('design:paramtypes',[typeorm_2[_0x3f0d44(0x1b7)],globalConfig_service_1[_0x3f0d44(0x1bc)],redisCache_service_1[_0x3f0d44(0x1f0)]])],VerificationService),exports['VerificationService']=VerificationService;