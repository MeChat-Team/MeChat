'use strict';const _0xaedf1c=_0x134d;(function(_0x289a65,_0x6717d7){const _0x99139b=_0x134d,_0x4c4890=_0x289a65();while(!![]){try{const _0x26ede9=-parseInt(_0x99139b(0x1c9))/0x1+-parseInt(_0x99139b(0x19e))/0x2*(-parseInt(_0x99139b(0x1af))/0x3)+parseInt(_0x99139b(0x188))/0x4+-parseInt(_0x99139b(0x172))/0x5*(parseInt(_0x99139b(0x1c1))/0x6)+parseInt(_0x99139b(0x180))/0x7*(-parseInt(_0x99139b(0x1cc))/0x8)+parseInt(_0x99139b(0x1b9))/0x9*(-parseInt(_0x99139b(0x1a2))/0xa)+parseInt(_0x99139b(0x17e))/0xb;if(_0x26ede9===_0x6717d7)break;else _0x4c4890['push'](_0x4c4890['shift']());}catch(_0x1cb056){_0x4c4890['push'](_0x4c4890['shift']());}}}(_0x6af6,0xb6159));function _0x134d(_0x4bc708,_0x20ea42){const _0x6af647=_0x6af6();return _0x134d=function(_0x134d84,_0x59750e){_0x134d84=_0x134d84-0x16b;let _0x3e3e34=_0x6af647[_0x134d84];return _0x3e3e34;},_0x134d(_0x4bc708,_0x20ea42);}var __decorate=this&&this[_0xaedf1c(0x1b0)]||function(_0x34f181,_0x7e7896,_0x2f82e2,_0x37d166){const _0x1ae02b=_0xaedf1c;var _0x44bb48=arguments[_0x1ae02b(0x173)],_0x588fd6=_0x44bb48<0x3?_0x7e7896:_0x37d166===null?_0x37d166=Object[_0x1ae02b(0x16c)](_0x7e7896,_0x2f82e2):_0x37d166,_0x2ece02;if(typeof Reflect===_0x1ae02b(0x183)&&typeof Reflect['decorate']===_0x1ae02b(0x16e))_0x588fd6=Reflect[_0x1ae02b(0x1d1)](_0x34f181,_0x7e7896,_0x2f82e2,_0x37d166);else{for(var _0x2196a7=_0x34f181[_0x1ae02b(0x173)]-0x1;_0x2196a7>=0x0;_0x2196a7--)if(_0x2ece02=_0x34f181[_0x2196a7])_0x588fd6=(_0x44bb48<0x3?_0x2ece02(_0x588fd6):_0x44bb48>0x3?_0x2ece02(_0x7e7896,_0x2f82e2,_0x588fd6):_0x2ece02(_0x7e7896,_0x2f82e2))||_0x588fd6;}return _0x44bb48>0x3&&_0x588fd6&&Object[_0x1ae02b(0x1c5)](_0x7e7896,_0x2f82e2,_0x588fd6),_0x588fd6;},__metadata=this&&this['__metadata']||function(_0x5475b8,_0x1fbf23){const _0x50d470=_0xaedf1c;if(typeof Reflect==='object'&&typeof Reflect[_0x50d470(0x1b8)]===_0x50d470(0x16e))return Reflect[_0x50d470(0x1b8)](_0x5475b8,_0x1fbf23);},__param=this&&this[_0xaedf1c(0x16d)]||function(_0x4d1ca8,_0x481851){return function(_0x5d13d4,_0x412082){_0x481851(_0x5d13d4,_0x412082,_0x4d1ca8);};};Object[_0xaedf1c(0x1c5)](exports,'__esModule',{'value':!![]}),exports[_0xaedf1c(0x18f)]=void 0x0;const utils_1=require(_0xaedf1c(0x182)),globalConfig_service_1=require(_0xaedf1c(0x1c0)),common_1=require(_0xaedf1c(0x1a6)),typeorm_1=require(_0xaedf1c(0x19f)),typeorm_2=require(_0xaedf1c(0x1c4)),redisCache_service_1=require(_0xaedf1c(0x19c)),status_constant_1=require(_0xaedf1c(0x1c8)),verification_constant_1=require('./../../common/constants/verification.constant'),verifycation_entity_1=require(_0xaedf1c(0x181)),Core=require(_0xaedf1c(0x1bc)),axios_1=require(_0xaedf1c(0x185)),nodemailer=require('nodemailer');function _0x6af6(){const _0x368ce1=['APPCODE\x20','@alicloud/pop-core','message','createdAt','design:paramtypes','../globalConfig/globalConfig.service','6OIqEfj','redisCacheService','Received\x20response:\x20','typeorm','defineProperty','globalConfigService','post','./../../common/constants/status.constant','143847lNkMQy','Received\x20identityInfo:\x20','POST','1941584nENHMF','SendSms','GlobalConfigService','Logger','验证码不存在','decorate','Error:\x20','save','2017-05-25','sendPhoneCode','used','getOwnPropertyDescriptor','__param','function','RedisCacheService','</strong></p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>此验证码30分钟内有效。</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>如果这不是您的操作，请忽略此邮件。</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20','ThirdPartyAuth','6933055PMFRJG','length','appCode','验证码','VerificationEnum','未知的认证结果','https://eid.shumaidata.com/eid/check','default','确实必要参数错误！','HttpStatus','验证码错误','createVerification','46372843kfpvxB','application/x-www-form-urlencoded','42KUTulO','./verifycation.entity','../../common/utils','object','您的验证码是：','axios','getConfigs','ceil','1230828ilDkFY','，30分钟内有效。','update','https://dysmsapi.aliyuncs.com','Injectable','log','findOne','VerificationService','getEmailConfig','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h1>验证码</h1>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>您的验证码是：<strong>','request','createRandomCode','BAD_REQUEST','InjectRepository','debug','verifycationEntity','getTime','res','data','验证码发送失败！','../redisCache/redisCache.service','验证不一致','124EDqiwl','@nestjs/typeorm','sendMail','Code','10ysGwUJ','verifyIdentity','stack','stringify','@nestjs/common','HttpException','VerificationUseStatusEnum','Message','Verification','缺少必要参数！','getExpirationTime','ChangeEmail','error','31272YFocUR','__decorate','sendEmailCode','实名认证异常','verifyCode','USED','now','createTransport','当前验证码已被使用！','metadata','12935205StnZry','DESC'];_0x6af6=function(){return _0x368ce1;};return _0x6af6();}let VerificationService=class VerificationService{constructor(_0x3d24e3,_0x41d07a,_0x1f0272){const _0x146ec3=_0xaedf1c;this[_0x146ec3(0x197)]=_0x3d24e3,this[_0x146ec3(0x1c6)]=_0x41d07a,this[_0x146ec3(0x1c2)]=_0x1f0272;}[_0xaedf1c(0x1ac)](_0x3c0e9f){const _0x5cff3e=_0xaedf1c;switch(_0x3c0e9f){case verification_constant_1['VerificationEnum'][_0x5cff3e(0x171)]:return 0x3c;case verification_constant_1['VerificationEnum']['Registration']:case verification_constant_1[_0x5cff3e(0x176)]['PasswordReset']:return 0x5*0x3c;case verification_constant_1['VerificationEnum'][_0x5cff3e(0x1ad)]:return 0x1e*0x3c;default:return 0x5*0x3c;}}async[_0xaedf1c(0x17d)](_0x48d9e4,_0x591ab5,_0x219964){const _0x517f43=_0xaedf1c,_0x473cef=await this[_0x517f43(0x197)][_0x517f43(0x18e)]({'where':{'userId':_0x48d9e4['id'],'type':_0x591ab5},'order':{'createdAt':_0x517f43(0x1ba)}});if(_0x473cef&&_0x473cef[_0x517f43(0x1be)][_0x517f43(0x198)]()+0x1*0x3c*0x3e8>Date['now']()){const _0x55b4ba=Math[_0x517f43(0x187)]((_0x473cef['createdAt']['getTime']()+0x1*0x3c*0x3e8-Date[_0x517f43(0x1b5)]())/0x3e8);throw new common_1[(_0x517f43(0x1a7))](_0x55b4ba+'S内不得重新发送',common_1[_0x517f43(0x17b)]['BAD_REQUEST']);}const _0x4d8b71=(0x0,utils_1[_0x517f43(0x193)])(),_0x497a53=new Date(Date[_0x517f43(0x1b5)]()+(_0x219964||this[_0x517f43(0x1ac)](_0x591ab5))*0x3e8),{id:_0x47b5a1,email:_0x54c1fe}=_0x48d9e4,_0x336250={'userId':_0x47b5a1,'type':_0x591ab5,'code':_0x4d8b71,'expiresAt':_0x497a53,'email':_0x54c1fe};return await this[_0x517f43(0x197)][_0x517f43(0x1d3)](_0x336250);}async[_0xaedf1c(0x1b3)]({code:_0x185751,id:_0x445938},_0x41c2ae){const _0x390b45=_0xaedf1c,_0x13b1be=await this[_0x390b45(0x197)][_0x390b45(0x18e)]({'where':{'id':_0x445938,'type':_0x41c2ae},'order':{'createdAt':'DESC'}});if(!_0x13b1be)throw new common_1[(_0x390b45(0x1a7))](_0x390b45(0x1d0),common_1[_0x390b45(0x17b)]['BAD_REQUEST']);if(_0x13b1be[_0x390b45(0x16b)]===status_constant_1[_0x390b45(0x1a8)][_0x390b45(0x1b4)])throw new common_1[(_0x390b45(0x1a7))](_0x390b45(0x1b7),common_1['HttpStatus'][_0x390b45(0x194)]);else _0x13b1be[_0x390b45(0x16b)]=status_constant_1['VerificationUseStatusEnum'][_0x390b45(0x1b4)],await this['verifycationEntity'][_0x390b45(0x18a)]({'id':_0x445938},_0x13b1be);if(Number(_0x13b1be['code'])!==Number(_0x185751))throw new common_1[(_0x390b45(0x1a7))](_0x390b45(0x17c),common_1[_0x390b45(0x17b)][_0x390b45(0x194)]);if(_0x13b1be['expiresAt']<new Date())throw new common_1[(_0x390b45(0x1a7))]('验证码已过期',common_1[_0x390b45(0x17b)][_0x390b45(0x194)]);return _0x13b1be;}async[_0xaedf1c(0x1d5)](_0x3c321f){const _0x1fcb23=_0xaedf1c;var _0x4c2717;const {accessKeyId:_0x190ef8,accessKeySecret:_0x43f637,SignName:_0x1509cd,TemplateCode:_0x452436}=await this[_0x1fcb23(0x1c6)]['getPhoneVerifyConfig']();console[_0x1fcb23(0x18d)]('Received\x20messageInfo:',_0x3c321f);const {phone:_0x43ddfc,code:_0x13cc62}=_0x3c321f;if(!_0x43ddfc||!_0x13cc62)throw new common_1[(_0x1fcb23(0x1a7))](_0x1fcb23(0x17a),common_1['HttpStatus'][_0x1fcb23(0x194)]);const _0x43591b=new Core({'accessKeyId':_0x190ef8,'accessKeySecret':_0x43f637,'endpoint':_0x1fcb23(0x18b),'apiVersion':_0x1fcb23(0x1d4)}),_0x1e6e40={'PhoneNumbers':_0x43ddfc,'SignName':_0x1509cd,'TemplateCode':_0x452436,'TemplateParam':JSON[_0x1fcb23(0x1a5)]({'code':_0x13cc62})},_0x729961={'method':_0x1fcb23(0x1cb),'formatParams':![]};try{const _0x3edbec=await _0x43591b[_0x1fcb23(0x192)](_0x1fcb23(0x1cd),_0x1e6e40,_0x729961);if(_0x3edbec[_0x1fcb23(0x1a1)]==='OK')return!![];else throw new common_1['HttpException'](_0x3edbec['Message']||'验证码发送失败！',common_1[_0x1fcb23(0x17b)][_0x1fcb23(0x194)]);}catch(_0x2e7311){throw new common_1[(_0x1fcb23(0x1a7))](((_0x4c2717=_0x2e7311===null||_0x2e7311===void 0x0?void 0x0:_0x2e7311[_0x1fcb23(0x19a)])===null||_0x4c2717===void 0x0?void 0x0:_0x4c2717[_0x1fcb23(0x1a9)])||_0x1fcb23(0x19b),common_1[_0x1fcb23(0x17b)][_0x1fcb23(0x194)]);}}async[_0xaedf1c(0x1b1)](_0x17cf9f){const _0x3aaf6c=_0xaedf1c,{email:_0x3a9682,code:_0x1b426b}=_0x17cf9f;if(!_0x3a9682||!_0x1b426b)throw new common_1[(_0x3aaf6c(0x1a7))]('缺少必要参数！',common_1[_0x3aaf6c(0x17b)][_0x3aaf6c(0x194)]);const {emailHost:_0xa35289,emailPort:_0x463235,emailUser:_0x36c24f,emailPass:_0x33c910}=await this['globalConfigService'][_0x3aaf6c(0x190)](),_0xa9d012=nodemailer[_0x3aaf6c(0x1b6)]({'host':_0xa35289,'port':_0x463235,'secure':!![],'auth':{'user':_0x36c24f,'pass':_0x33c910}});try{return await _0xa9d012[_0x3aaf6c(0x1a0)]({'from':_0x36c24f,'to':_0x3a9682,'subject':_0x3aaf6c(0x175),'text':_0x3aaf6c(0x184)+_0x1b426b+_0x3aaf6c(0x189),'html':_0x3aaf6c(0x191)+_0x1b426b+_0x3aaf6c(0x170)}),!![];}catch(_0x5673bb){throw new common_1['HttpException']((_0x5673bb===null||_0x5673bb===void 0x0?void 0x0:_0x5673bb[_0x3aaf6c(0x1bd)])||_0x3aaf6c(0x19b),common_1[_0x3aaf6c(0x17b)][_0x3aaf6c(0x194)]);}}async[_0xaedf1c(0x1a3)](_0x349fe7){const _0x40af38=_0xaedf1c,_0x1dad70=await this[_0x40af38(0x1c6)][_0x40af38(0x186)]([_0x40af38(0x174)]),{name:_0x2dca45,idCard:_0x354aad}=_0x349fe7;if(!_0x2dca45||!_0x354aad)throw new common_1[(_0x40af38(0x1a7))](_0x40af38(0x1ab),common_1[_0x40af38(0x17b)][_0x40af38(0x194)]);common_1['Logger'][_0x40af38(0x196)](_0x40af38(0x1ca)+_0x2dca45+',\x20'+_0x354aad);const _0x4b8681=_0x40af38(0x178),_0x357379={'Authorization':_0x40af38(0x1bb)+_0x1dad70,'Content-Type':_0x40af38(0x17f)},_0x49e533=new URLSearchParams({'name':_0x2dca45,'idcard':_0x354aad});try{const _0x51c82a=await axios_1[_0x40af38(0x179)][_0x40af38(0x1c7)](_0x4b8681,_0x49e533,{'headers':_0x357379}),_0x16107f=JSON[_0x40af38(0x1a5)](_0x51c82a['data']);common_1['Logger'][_0x40af38(0x196)](_0x40af38(0x1c3)+_0x16107f);switch(_0x51c82a[_0x40af38(0x19a)]['result'][_0x40af38(0x199)]){case'1':return!![];case'2':common_1['Logger'][_0x40af38(0x18d)](_0x40af38(0x19d),_0x40af38(0x18f));case'3':common_1['Logger'][_0x40af38(0x18d)](_0x40af38(0x1b2),_0x40af38(0x18f));default:common_1['Logger'][_0x40af38(0x18d)](_0x40af38(0x177),_0x40af38(0x18f));}return![];}catch(_0x5393f3){return common_1[_0x40af38(0x1cf)][_0x40af38(0x1ae)](_0x40af38(0x1d2)+_0x5393f3['message'],_0x5393f3[_0x40af38(0x1a4)],_0x40af38(0x1aa)),![];}}};VerificationService=__decorate([(0x0,common_1[_0xaedf1c(0x18c)])(),__param(0x0,(0x0,typeorm_1[_0xaedf1c(0x195)])(verifycation_entity_1['VerifycationEntity'])),__metadata(_0xaedf1c(0x1bf),[typeorm_2['Repository'],globalConfig_service_1[_0xaedf1c(0x1ce)],redisCache_service_1[_0xaedf1c(0x16f)]])],VerificationService),exports[_0xaedf1c(0x18f)]=VerificationService;