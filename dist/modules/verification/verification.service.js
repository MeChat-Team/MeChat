'use strict';const _0x1a74ee=_0x46a6;(function(_0xa8acae,_0x2837b3){const _0x1e1195=_0x46a6,_0x3df5cf=_0xa8acae();while(!![]){try{const _0x4d8940=-parseInt(_0x1e1195(0x21c))/0x1+parseInt(_0x1e1195(0x1da))/0x2*(-parseInt(_0x1e1195(0x20d))/0x3)+-parseInt(_0x1e1195(0x22b))/0x4*(parseInt(_0x1e1195(0x1fb))/0x5)+parseInt(_0x1e1195(0x209))/0x6*(parseInt(_0x1e1195(0x1ec))/0x7)+parseInt(_0x1e1195(0x236))/0x8+parseInt(_0x1e1195(0x20e))/0x9*(-parseInt(_0x1e1195(0x1f2))/0xa)+parseInt(_0x1e1195(0x214))/0xb*(parseInt(_0x1e1195(0x1df))/0xc);if(_0x4d8940===_0x2837b3)break;else _0x3df5cf['push'](_0x3df5cf['shift']());}catch(_0x5d017f){_0x3df5cf['push'](_0x3df5cf['shift']());}}}(_0x5733,0x70074));function _0x46a6(_0x559844,_0x476c25){const _0x5733d2=_0x5733();return _0x46a6=function(_0x46a6cd,_0xc87a64){_0x46a6cd=_0x46a6cd-0x1d4;let _0x1c103c=_0x5733d2[_0x46a6cd];return _0x1c103c;},_0x46a6(_0x559844,_0x476c25);}function _0x5733(){const _0x2f4b49=['实名认证异常','765940XGQIoj','验证码发送失败！','https://eid.shumaidata.com/eid/check','sendMail','typeorm','ceil','expiresAt','now','USED','确实必要参数错误！','__esModule','sendPhoneCode','../redisCache/redisCache.service','@alicloud/pop-core','BAD_REQUEST','69216jVtLfu','log','request','used','Registration','redisCacheService','getTime','defineProperty','VerificationEnum','GlobalConfigService','createTransport','6382552VPkdBR','POST','Logger','getExpirationTime','验证不一致','res','VerifycationEntity','SendSms','findOne','__param','512290TCgNGm','function','getConfigs','2017-05-25','nodemailer','54564ZbnCRJ','message','./../../common/constants/verification.constant','ThirdPartyAuth','@nestjs/typeorm','VerificationService','Message','verifyCode','debug','save','../../common/utils','appCode','DESC','21bcBDvk','getEmailConfig','createRandomCode','ChangeEmail','Verification','__decorate','3080830xulMHs','APPCODE\x20','verifyIdentity','VerificationUseStatusEnum','Injectable','decorate','HttpException','验证码已过期','PasswordReset','10pjQvEC','post','sendEmailCode','getOwnPropertyDescriptor','./../../common/constants/status.constant','axios','当前验证码已被使用！','Received\x20messageInfo:','../globalConfig/globalConfig.service','@nestjs/common','length','object','HttpStatus','S内不得重新发送','321564HJmjkF','Received\x20response:\x20','./verifycation.entity','getPhoneVerifyConfig','3erAHme','18EBmtxA','stringify','，30分钟内有效。','验证码不存在','globalConfigService','未知的认证结果','2838ftbTxV','https://dysmsapi.aliyuncs.com','验证码错误','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h1>验证码</h1>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>您的验证码是：<strong>','verifycationEntity','Code','验证码'];_0x5733=function(){return _0x2f4b49;};return _0x5733();}var __decorate=this&&this[_0x1a74ee(0x1f1)]||function(_0x53efe2,_0x354cdb,_0x2bb5ef,_0x311cf0){const _0x56a57f=_0x1a74ee;var _0x2ce08d=arguments['length'],_0x4114fe=_0x2ce08d<0x3?_0x354cdb:_0x311cf0===null?_0x311cf0=Object[_0x56a57f(0x1fe)](_0x354cdb,_0x2bb5ef):_0x311cf0,_0x302966;if(typeof Reflect===_0x56a57f(0x206)&&typeof Reflect[_0x56a57f(0x1f7)]===_0x56a57f(0x1db))_0x4114fe=Reflect[_0x56a57f(0x1f7)](_0x53efe2,_0x354cdb,_0x2bb5ef,_0x311cf0);else{for(var _0x46ec91=_0x53efe2[_0x56a57f(0x205)]-0x1;_0x46ec91>=0x0;_0x46ec91--)if(_0x302966=_0x53efe2[_0x46ec91])_0x4114fe=(_0x2ce08d<0x3?_0x302966(_0x4114fe):_0x2ce08d>0x3?_0x302966(_0x354cdb,_0x2bb5ef,_0x4114fe):_0x302966(_0x354cdb,_0x2bb5ef))||_0x4114fe;}return _0x2ce08d>0x3&&_0x4114fe&&Object[_0x56a57f(0x232)](_0x354cdb,_0x2bb5ef,_0x4114fe),_0x4114fe;},__metadata=this&&this['__metadata']||function(_0xba23ce,_0x3a1414){const _0x567778=_0x1a74ee;if(typeof Reflect===_0x567778(0x206)&&typeof Reflect['metadata']===_0x567778(0x1db))return Reflect['metadata'](_0xba23ce,_0x3a1414);},__param=this&&this[_0x1a74ee(0x1d9)]||function(_0x53133a,_0x96e440){return function(_0x555961,_0x8e42f7){_0x96e440(_0x555961,_0x8e42f7,_0x53133a);};};Object['defineProperty'](exports,_0x1a74ee(0x226),{'value':!![]}),exports[_0x1a74ee(0x1e4)]=void 0x0;const utils_1=require(_0x1a74ee(0x1e9)),globalConfig_service_1=require(_0x1a74ee(0x203)),common_1=require(_0x1a74ee(0x204)),typeorm_1=require(_0x1a74ee(0x1e3)),typeorm_2=require(_0x1a74ee(0x220)),redisCache_service_1=require(_0x1a74ee(0x228)),status_constant_1=require(_0x1a74ee(0x1ff)),verification_constant_1=require(_0x1a74ee(0x1e1)),verifycation_entity_1=require(_0x1a74ee(0x20b)),Core=require(_0x1a74ee(0x229)),axios_1=require(_0x1a74ee(0x200)),nodemailer=require(_0x1a74ee(0x1de));let VerificationService=class VerificationService{constructor(_0xa87a24,_0x49fa4b,_0x32ea15){const _0x50b6a3=_0x1a74ee;this[_0x50b6a3(0x218)]=_0xa87a24,this['globalConfigService']=_0x49fa4b,this[_0x50b6a3(0x230)]=_0x32ea15;}[_0x1a74ee(0x239)](_0x53d070){const _0x3df258=_0x1a74ee;switch(_0x53d070){case verification_constant_1[_0x3df258(0x233)][_0x3df258(0x1e2)]:return 0x3c;case verification_constant_1['VerificationEnum'][_0x3df258(0x22f)]:case verification_constant_1[_0x3df258(0x233)][_0x3df258(0x1fa)]:return 0x5*0x3c;case verification_constant_1[_0x3df258(0x233)][_0x3df258(0x1ef)]:return 0x1e*0x3c;default:return 0x5*0x3c;}}async['createVerification'](_0x47a707,_0x3c63e5,_0x1b875f){const _0x5034bb=_0x1a74ee,_0xafe35e=await this[_0x5034bb(0x218)][_0x5034bb(0x1d8)]({'where':{'userId':_0x47a707['id'],'type':_0x3c63e5},'order':{'createdAt':'DESC'}});if(_0xafe35e&&_0xafe35e['createdAt'][_0x5034bb(0x231)]()+0x1*0x3c*0x3e8>Date['now']()){const _0x1cf411=Math[_0x5034bb(0x221)]((_0xafe35e['createdAt'][_0x5034bb(0x231)]()+0x1*0x3c*0x3e8-Date['now']())/0x3e8);throw new common_1[(_0x5034bb(0x1f8))](_0x1cf411+_0x5034bb(0x208),common_1[_0x5034bb(0x207)][_0x5034bb(0x22a)]);}const _0xb718c9=(0x0,utils_1[_0x5034bb(0x1ee)])(),_0x17a7ce=new Date(Date[_0x5034bb(0x223)]()+(_0x1b875f||this['getExpirationTime'](_0x3c63e5))*0x3e8),{id:_0x127bad,email:_0x54b1f4}=_0x47a707,_0x46d2cf={'userId':_0x127bad,'type':_0x3c63e5,'code':_0xb718c9,'expiresAt':_0x17a7ce,'email':_0x54b1f4};return await this[_0x5034bb(0x218)][_0x5034bb(0x1e8)](_0x46d2cf);}async[_0x1a74ee(0x1e6)]({code:_0x4ef8c0,id:_0x174a13},_0x45b5ca){const _0x44c246=_0x1a74ee,_0x3a8bd1=await this[_0x44c246(0x218)][_0x44c246(0x1d8)]({'where':{'id':_0x174a13,'type':_0x45b5ca},'order':{'createdAt':_0x44c246(0x1eb)}});if(!_0x3a8bd1)throw new common_1[(_0x44c246(0x1f8))](_0x44c246(0x211),common_1['HttpStatus']['BAD_REQUEST']);if(_0x3a8bd1[_0x44c246(0x22e)]===status_constant_1[_0x44c246(0x1f5)][_0x44c246(0x224)])throw new common_1['HttpException'](_0x44c246(0x201),common_1[_0x44c246(0x207)][_0x44c246(0x22a)]);else _0x3a8bd1[_0x44c246(0x22e)]=status_constant_1[_0x44c246(0x1f5)][_0x44c246(0x224)],await this[_0x44c246(0x218)]['update']({'id':_0x174a13},_0x3a8bd1);if(Number(_0x3a8bd1['code'])!==Number(_0x4ef8c0))throw new common_1[(_0x44c246(0x1f8))](_0x44c246(0x216),common_1[_0x44c246(0x207)][_0x44c246(0x22a)]);if(_0x3a8bd1[_0x44c246(0x222)]<new Date())throw new common_1[(_0x44c246(0x1f8))](_0x44c246(0x1f9),common_1[_0x44c246(0x207)][_0x44c246(0x22a)]);return _0x3a8bd1;}async[_0x1a74ee(0x227)](_0x45e9f8){const _0x110c52=_0x1a74ee;var _0x18c240;const {accessKeyId:_0xad284b,accessKeySecret:_0x581ef0,SignName:_0x5418a6,TemplateCode:_0x431209}=await this['globalConfigService'][_0x110c52(0x20c)]();console['log'](_0x110c52(0x202),_0x45e9f8);const {phone:_0x424d0a,code:_0x16bfaf}=_0x45e9f8;if(!_0x424d0a||!_0x16bfaf)throw new common_1[(_0x110c52(0x1f8))](_0x110c52(0x225),common_1[_0x110c52(0x207)][_0x110c52(0x22a)]);const _0x15231d=new Core({'accessKeyId':_0xad284b,'accessKeySecret':_0x581ef0,'endpoint':_0x110c52(0x215),'apiVersion':_0x110c52(0x1dd)}),_0x21aff6={'PhoneNumbers':_0x424d0a,'SignName':_0x5418a6,'TemplateCode':_0x431209,'TemplateParam':JSON[_0x110c52(0x20f)]({'code':_0x16bfaf})},_0x5f09ac={'method':_0x110c52(0x237),'formatParams':![]};try{const _0xf9f7b5=await _0x15231d[_0x110c52(0x22d)](_0x110c52(0x1d7),_0x21aff6,_0x5f09ac);if(_0xf9f7b5[_0x110c52(0x219)]==='OK')return!![];else throw new common_1['HttpException'](_0xf9f7b5[_0x110c52(0x1e5)]||'验证码发送失败！',common_1[_0x110c52(0x207)][_0x110c52(0x22a)]);}catch(_0x306512){throw new common_1[(_0x110c52(0x1f8))](((_0x18c240=_0x306512===null||_0x306512===void 0x0?void 0x0:_0x306512['data'])===null||_0x18c240===void 0x0?void 0x0:_0x18c240[_0x110c52(0x1e5)])||_0x110c52(0x21d),common_1[_0x110c52(0x207)][_0x110c52(0x22a)]);}}async[_0x1a74ee(0x1fd)](_0x5563a9){const _0x5a7a01=_0x1a74ee,{email:_0x4c2bef,code:_0xae3aee}=_0x5563a9;if(!_0x4c2bef||!_0xae3aee)throw new common_1['HttpException']('缺少必要参数！',common_1[_0x5a7a01(0x207)][_0x5a7a01(0x22a)]);const {emailHost:_0x2dca27,emailPort:_0x31c98e,emailUser:_0xae74a2,emailPass:_0x24eeb6}=await this[_0x5a7a01(0x212)][_0x5a7a01(0x1ed)](),_0x4542cf=nodemailer[_0x5a7a01(0x235)]({'host':_0x2dca27,'port':_0x31c98e,'secure':!![],'auth':{'user':_0xae74a2,'pass':_0x24eeb6}});try{return await _0x4542cf[_0x5a7a01(0x21f)]({'from':_0xae74a2,'to':_0x4c2bef,'subject':_0x5a7a01(0x21a),'text':'您的验证码是：'+_0xae3aee+_0x5a7a01(0x210),'html':_0x5a7a01(0x217)+_0xae3aee+'</strong></p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>此验证码30分钟内有效。</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>如果这不是您的操作，请忽略此邮件。</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20'}),!![];}catch(_0x5af14e){throw new common_1['HttpException']((_0x5af14e===null||_0x5af14e===void 0x0?void 0x0:_0x5af14e[_0x5a7a01(0x1e0)])||_0x5a7a01(0x21d),common_1['HttpStatus'][_0x5a7a01(0x22a)]);}}async[_0x1a74ee(0x1f4)](_0x15fe2b){const _0x502144=_0x1a74ee,_0xf1e43c=await this[_0x502144(0x212)][_0x502144(0x1dc)]([_0x502144(0x1ea)]),{name:_0x48a508,idCard:_0x3c4923}=_0x15fe2b;if(!_0x48a508||!_0x3c4923)throw new common_1['HttpException']('缺少必要参数！',common_1[_0x502144(0x207)][_0x502144(0x22a)]);common_1[_0x502144(0x238)][_0x502144(0x1e7)]('Received\x20identityInfo:\x20'+_0x48a508+',\x20'+_0x3c4923);const _0x459c25=_0x502144(0x21e),_0x1a1f66={'Authorization':_0x502144(0x1f3)+_0xf1e43c,'Content-Type':'application/x-www-form-urlencoded'},_0x3cd8c2=new URLSearchParams({'name':_0x48a508,'idcard':_0x3c4923});try{const _0x42e63c=await axios_1['default'][_0x502144(0x1fc)](_0x459c25,_0x3cd8c2,{'headers':_0x1a1f66}),_0x4aefd8=JSON[_0x502144(0x20f)](_0x42e63c['data']);common_1[_0x502144(0x238)]['debug'](_0x502144(0x20a)+_0x4aefd8);switch(_0x42e63c['data']['result'][_0x502144(0x1d5)]){case'1':return!![];case'2':common_1['Logger'][_0x502144(0x22c)](_0x502144(0x1d4),'VerificationService');case'3':common_1[_0x502144(0x238)][_0x502144(0x22c)](_0x502144(0x21b),_0x502144(0x1e4));default:common_1[_0x502144(0x238)][_0x502144(0x22c)](_0x502144(0x213),_0x502144(0x1e4));}return![];}catch(_0x3fdc74){return common_1[_0x502144(0x238)]['error']('Error:\x20'+_0x3fdc74['message'],_0x3fdc74['stack'],_0x502144(0x1f0)),![];}}};VerificationService=__decorate([(0x0,common_1[_0x1a74ee(0x1f6)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(verifycation_entity_1[_0x1a74ee(0x1d6)])),__metadata('design:paramtypes',[typeorm_2['Repository'],globalConfig_service_1[_0x1a74ee(0x234)],redisCache_service_1['RedisCacheService']])],VerificationService),exports[_0x1a74ee(0x1e4)]=VerificationService;