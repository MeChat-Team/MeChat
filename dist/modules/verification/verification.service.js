'use strict';const _0x34c18a=_0xe4dc;(function(_0x3134c2,_0x3267d3){const _0x114de7=_0xe4dc,_0x31983c=_0x3134c2();while(!![]){try{const _0x2fa998=-parseInt(_0x114de7(0x1ab))/0x1*(-parseInt(_0x114de7(0x194))/0x2)+-parseInt(_0x114de7(0x1ae))/0x3*(parseInt(_0x114de7(0x1c7))/0x4)+parseInt(_0x114de7(0x1b7))/0x5+-parseInt(_0x114de7(0x189))/0x6+-parseInt(_0x114de7(0x193))/0x7+-parseInt(_0x114de7(0x1c3))/0x8*(-parseInt(_0x114de7(0x1bc))/0x9)+parseInt(_0x114de7(0x19e))/0xa*(-parseInt(_0x114de7(0x1a9))/0xb);if(_0x2fa998===_0x3267d3)break;else _0x31983c['push'](_0x31983c['shift']());}catch(_0x5d49ac){_0x31983c['push'](_0x31983c['shift']());}}}(_0x4394,0xc579d));var __decorate=this&&this[_0x34c18a(0x18f)]||function(_0x3cd5e5,_0x47cd10,_0x25c4ad,_0x5bc03e){const _0x30e855=_0x34c18a;var _0x8ce7e1=arguments[_0x30e855(0x1a0)],_0x21bcdc=_0x8ce7e1<0x3?_0x47cd10:_0x5bc03e===null?_0x5bc03e=Object[_0x30e855(0x182)](_0x47cd10,_0x25c4ad):_0x5bc03e,_0x24094f;if(typeof Reflect===_0x30e855(0x1a7)&&typeof Reflect[_0x30e855(0x181)]===_0x30e855(0x1d1))_0x21bcdc=Reflect[_0x30e855(0x181)](_0x3cd5e5,_0x47cd10,_0x25c4ad,_0x5bc03e);else{for(var _0x170efa=_0x3cd5e5['length']-0x1;_0x170efa>=0x0;_0x170efa--)if(_0x24094f=_0x3cd5e5[_0x170efa])_0x21bcdc=(_0x8ce7e1<0x3?_0x24094f(_0x21bcdc):_0x8ce7e1>0x3?_0x24094f(_0x47cd10,_0x25c4ad,_0x21bcdc):_0x24094f(_0x47cd10,_0x25c4ad))||_0x21bcdc;}return _0x8ce7e1>0x3&&_0x21bcdc&&Object[_0x30e855(0x198)](_0x47cd10,_0x25c4ad,_0x21bcdc),_0x21bcdc;},__metadata=this&&this['__metadata']||function(_0x21f2b4,_0x588134){const _0x36be22=_0x34c18a;if(typeof Reflect===_0x36be22(0x1a7)&&typeof Reflect[_0x36be22(0x17d)]===_0x36be22(0x1d1))return Reflect['metadata'](_0x21f2b4,_0x588134);},__param=this&&this[_0x34c18a(0x1a5)]||function(_0x4f1231,_0x3d8dc8){return function(_0x4c9a60,_0x4ab539){_0x3d8dc8(_0x4c9a60,_0x4ab539,_0x4f1231);};};function _0x4394(){const _0x28b776=['HttpStatus','defineProperty','Code','验证码不存在','HttpException','Logger','getTime','110oqrpoi','createdAt','length','stringify','../../common/utils','createRandomCode','log','__param','POST','object','InjectRepository','1623523YrjJdi','res','762IhTkrf','DESC','验证码已过期','3mEqqJl','default','Received\x20identityInfo:\x20','../redisCache/redisCache.service','缺少必要参数！','design:paramtypes','验证码发送失败！','code','Error:\x20','5288340cKFSHG','createVerification','debug','APPCODE\x20','getConfigs','27IdiVIN','@alicloud/pop-core','验证不一致','__esModule','../globalConfig/globalConfig.service','used','typeorm','3195032oyMOpJ','data','verifyCode','Injectable','439384VkrPWj','https://eid.shumaidata.com/eid/check','确实必要参数错误！','verifyIdentity','2017-05-25','./verifycation.entity','getPhoneVerifyConfig','VerifycationEntity','ceil','未知的认证结果','function','USED','save','globalConfigService','post','VerificationUseStatusEnum','GlobalConfigService','Verification','Received\x20response:\x20','metadata','@nestjs/typeorm','S内不得重新发送','now','decorate','getOwnPropertyDescriptor','update','message','RedisCacheService','SendSms','application/x-www-form-urlencoded','./../../common/constants/status.constant','1039644ybnXNv','Received\x20messageInfo:','verifycationEntity','axios','findOne','@nestjs/common','__decorate','result','VerificationService','Message','4740435tRwWkO','2984EWIOfL','request','BAD_REQUEST'];_0x4394=function(){return _0x28b776;};return _0x4394();}Object['defineProperty'](exports,_0x34c18a(0x1bf),{'value':!![]}),exports[_0x34c18a(0x191)]=void 0x0;const utils_1=require(_0x34c18a(0x1a2)),globalConfig_service_1=require(_0x34c18a(0x1c0)),common_1=require(_0x34c18a(0x18e)),typeorm_1=require(_0x34c18a(0x17e)),typeorm_2=require(_0x34c18a(0x1c2)),redisCache_service_1=require(_0x34c18a(0x1b1)),status_constant_1=require(_0x34c18a(0x188)),verifycation_entity_1=require(_0x34c18a(0x1cc)),Core=require(_0x34c18a(0x1bd)),axios_1=require(_0x34c18a(0x18c));function _0xe4dc(_0x34629c,_0x3aff98){const _0x4394e8=_0x4394();return _0xe4dc=function(_0xe4dc28,_0x103c0c){_0xe4dc28=_0xe4dc28-0x17c;let _0x377dca=_0x4394e8[_0xe4dc28];return _0x377dca;},_0xe4dc(_0x34629c,_0x3aff98);}let VerificationService=class VerificationService{constructor(_0xcd3239,_0x3c77fb,_0x32650e){const _0x77330d=_0x34c18a;this[_0x77330d(0x18b)]=_0xcd3239,this['globalConfigService']=_0x3c77fb,this['redisCacheService']=_0x32650e;}async[_0x34c18a(0x1b8)](_0x4a2c55,_0x1456a1,_0x1f475a=0x1e*0x3c){const _0x65b820=_0x34c18a,_0x493e55=await this[_0x65b820(0x18b)][_0x65b820(0x18d)]({'where':{'userId':_0x4a2c55['id'],'type':_0x1456a1},'order':{'createdAt':_0x65b820(0x1ac)}});if(_0x493e55&&_0x493e55[_0x65b820(0x19f)]['getTime']()+0x1*0x3c*0x3e8>Date[_0x65b820(0x180)]()){const _0x3a83eb=Math[_0x65b820(0x1cf)]((_0x493e55[_0x65b820(0x19f)][_0x65b820(0x19d)]()+0x1*0x3c*0x3e8-Date[_0x65b820(0x180)]())/0x3e8);throw new common_1['HttpException'](_0x3a83eb+_0x65b820(0x17f),common_1['HttpStatus'][_0x65b820(0x196)]);}const _0x11279b=(0x0,utils_1[_0x65b820(0x1a3)])(),_0x46bb54=new Date(Date['now']()+_0x1f475a*0x3e8),{id:_0x298eaf,email:_0x4ea49a}=_0x4a2c55,_0x5c3a59={'userId':_0x298eaf,'type':_0x1456a1,'code':_0x11279b,'expiresAt':_0x46bb54,'email':_0x4ea49a};return await this[_0x65b820(0x18b)][_0x65b820(0x1d3)](_0x5c3a59);}async[_0x34c18a(0x1c5)]({code:_0x3fe9b7,id:_0xa8280a},_0x1e4b87){const _0x2ee4a1=_0x34c18a,_0x152784=await this['verifycationEntity'][_0x2ee4a1(0x18d)]({'where':{'id':_0xa8280a,'type':_0x1e4b87},'order':{'createdAt':'DESC'}});if(!_0x152784)throw new common_1[(_0x2ee4a1(0x19b))](_0x2ee4a1(0x19a),common_1[_0x2ee4a1(0x197)][_0x2ee4a1(0x196)]);if(_0x152784['used']===status_constant_1[_0x2ee4a1(0x1d6)][_0x2ee4a1(0x1d2)])throw new common_1['HttpException']('当前验证码已被使用！',common_1[_0x2ee4a1(0x197)]['BAD_REQUEST']);else _0x152784[_0x2ee4a1(0x1c1)]=status_constant_1[_0x2ee4a1(0x1d6)]['USED'],await this[_0x2ee4a1(0x18b)][_0x2ee4a1(0x183)]({'id':_0xa8280a},_0x152784);if(Number(_0x152784[_0x2ee4a1(0x1b5)])!==Number(_0x3fe9b7))throw new common_1['HttpException']('验证码错误',common_1[_0x2ee4a1(0x197)][_0x2ee4a1(0x196)]);if(_0x152784['expiresAt']<new Date())throw new common_1['HttpException'](_0x2ee4a1(0x1ad),common_1['HttpStatus'][_0x2ee4a1(0x196)]);return _0x152784;}async['sendPhoneCode'](_0x5848c6){const _0x13fc0d=_0x34c18a;var _0x3e4edd;const {accessKeyId:_0x5e174e,accessKeySecret:_0x419e68,SignName:_0x5531e7,TemplateCode:_0x597b4b}=await this[_0x13fc0d(0x1d4)][_0x13fc0d(0x1cd)]();console[_0x13fc0d(0x1a4)](_0x13fc0d(0x18a),_0x5848c6);const {phone:_0x211f1c,code:_0x556c49}=_0x5848c6;if(!_0x211f1c||!_0x556c49)throw new common_1[(_0x13fc0d(0x19b))](_0x13fc0d(0x1c9),common_1['HttpStatus'][_0x13fc0d(0x196)]);const _0x82a9c5=new Core({'accessKeyId':_0x5e174e,'accessKeySecret':_0x419e68,'endpoint':'https://dysmsapi.aliyuncs.com','apiVersion':_0x13fc0d(0x1cb)}),_0x363c7a={'PhoneNumbers':_0x211f1c,'SignName':_0x5531e7,'TemplateCode':_0x597b4b,'TemplateParam':JSON[_0x13fc0d(0x1a1)]({'code':_0x556c49})},_0x454a0d={'method':_0x13fc0d(0x1a6),'formatParams':![]};try{const _0x4b705e=await _0x82a9c5[_0x13fc0d(0x195)](_0x13fc0d(0x186),_0x363c7a,_0x454a0d);if(_0x4b705e[_0x13fc0d(0x199)]==='OK')return!![];else throw new common_1[(_0x13fc0d(0x19b))](_0x4b705e[_0x13fc0d(0x192)]||_0x13fc0d(0x1b4),common_1[_0x13fc0d(0x197)][_0x13fc0d(0x196)]);}catch(_0x35b354){throw new common_1[(_0x13fc0d(0x19b))](((_0x3e4edd=_0x35b354===null||_0x35b354===void 0x0?void 0x0:_0x35b354['data'])===null||_0x3e4edd===void 0x0?void 0x0:_0x3e4edd[_0x13fc0d(0x192)])||'验证码发送失败！',common_1[_0x13fc0d(0x197)]['BAD_REQUEST']);}}async[_0x34c18a(0x1ca)](_0x5ecf62){const _0x167eaf=_0x34c18a,_0x3cf9ed=await this[_0x167eaf(0x1d4)][_0x167eaf(0x1bb)](['appCode']),{name:_0x2e1078,idCard:_0x238a5a}=_0x5ecf62;if(!_0x2e1078||!_0x238a5a)throw new common_1[(_0x167eaf(0x19b))](_0x167eaf(0x1b2),common_1[_0x167eaf(0x197)][_0x167eaf(0x196)]);common_1[_0x167eaf(0x19c)]['debug'](_0x167eaf(0x1b0)+_0x2e1078+',\x20'+_0x238a5a);const _0x498100=_0x167eaf(0x1c8),_0x3ef7a4={'Authorization':_0x167eaf(0x1ba)+_0x3cf9ed,'Content-Type':_0x167eaf(0x187)},_0x23cb75=new URLSearchParams({'name':_0x2e1078,'idcard':_0x238a5a});try{const _0x203498=await axios_1[_0x167eaf(0x1af)][_0x167eaf(0x1d5)](_0x498100,_0x23cb75,{'headers':_0x3ef7a4}),_0x3f4d04=JSON['stringify'](_0x203498[_0x167eaf(0x1c4)]);common_1[_0x167eaf(0x19c)][_0x167eaf(0x1b9)](_0x167eaf(0x17c)+_0x3f4d04);switch(_0x203498['data'][_0x167eaf(0x190)][_0x167eaf(0x1aa)]){case'1':return!![];case'2':common_1['Logger']['log'](_0x167eaf(0x1be),_0x167eaf(0x191));case'3':common_1[_0x167eaf(0x19c)]['log']('实名认证异常',_0x167eaf(0x191));default:common_1[_0x167eaf(0x19c)]['log'](_0x167eaf(0x1d0),'VerificationService');}return![];}catch(_0x535db7){return common_1[_0x167eaf(0x19c)]['error'](_0x167eaf(0x1b6)+_0x535db7[_0x167eaf(0x184)],_0x535db7['stack'],_0x167eaf(0x1d8)),![];}}};VerificationService=__decorate([(0x0,common_1[_0x34c18a(0x1c6)])(),__param(0x0,(0x0,typeorm_1[_0x34c18a(0x1a8)])(verifycation_entity_1[_0x34c18a(0x1ce)])),__metadata(_0x34c18a(0x1b3),[typeorm_2['Repository'],globalConfig_service_1[_0x34c18a(0x1d7)],redisCache_service_1[_0x34c18a(0x185)]])],VerificationService),exports[_0x34c18a(0x191)]=VerificationService;