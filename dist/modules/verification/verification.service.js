'use strict';const _0x24ae6f=_0x2135;(function(_0x163447,_0x1fbf5b){const _0x38adea=_0x2135,_0xed1657=_0x163447();while(!![]){try{const _0x2860f9=-parseInt(_0x38adea(0x17b))/0x1+parseInt(_0x38adea(0x154))/0x2*(-parseInt(_0x38adea(0x149))/0x3)+parseInt(_0x38adea(0x122))/0x4+-parseInt(_0x38adea(0x15d))/0x5+-parseInt(_0x38adea(0x15b))/0x6*(-parseInt(_0x38adea(0x14d))/0x7)+-parseInt(_0x38adea(0x13c))/0x8*(parseInt(_0x38adea(0x16a))/0x9)+parseInt(_0x38adea(0x137))/0xa;if(_0x2860f9===_0x1fbf5b)break;else _0xed1657['push'](_0xed1657['shift']());}catch(_0x3cc765){_0xed1657['push'](_0xed1657['shift']());}}}(_0x5472,0x892f3));function _0x2135(_0xa46109,_0x577261){const _0x54722e=_0x5472();return _0x2135=function(_0x2135a2,_0x44de8f){_0x2135a2=_0x2135a2-0x11b;let _0x374193=_0x54722e[_0x2135a2];return _0x374193;},_0x2135(_0xa46109,_0x577261);}var __decorate=this&&this[_0x24ae6f(0x16d)]||function(_0x21e374,_0x42c68b,_0x17026f,_0x28a222){const _0x3af3b5=_0x24ae6f;var _0xb5e08d=arguments[_0x3af3b5(0x12c)],_0x29b8b7=_0xb5e08d<0x3?_0x42c68b:_0x28a222===null?_0x28a222=Object['getOwnPropertyDescriptor'](_0x42c68b,_0x17026f):_0x28a222,_0x5a49e9;if(typeof Reflect===_0x3af3b5(0x180)&&typeof Reflect[_0x3af3b5(0x157)]===_0x3af3b5(0x172))_0x29b8b7=Reflect[_0x3af3b5(0x157)](_0x21e374,_0x42c68b,_0x17026f,_0x28a222);else{for(var _0x23e406=_0x21e374[_0x3af3b5(0x12c)]-0x1;_0x23e406>=0x0;_0x23e406--)if(_0x5a49e9=_0x21e374[_0x23e406])_0x29b8b7=(_0xb5e08d<0x3?_0x5a49e9(_0x29b8b7):_0xb5e08d>0x3?_0x5a49e9(_0x42c68b,_0x17026f,_0x29b8b7):_0x5a49e9(_0x42c68b,_0x17026f))||_0x29b8b7;}return _0xb5e08d>0x3&&_0x29b8b7&&Object['defineProperty'](_0x42c68b,_0x17026f,_0x29b8b7),_0x29b8b7;},__metadata=this&&this[_0x24ae6f(0x176)]||function(_0x45220d,_0x3a186f){const _0x37b15f=_0x24ae6f;if(typeof Reflect===_0x37b15f(0x180)&&typeof Reflect[_0x37b15f(0x120)]==='function')return Reflect[_0x37b15f(0x120)](_0x45220d,_0x3a186f);},__param=this&&this[_0x24ae6f(0x173)]||function(_0x335282,_0x1f3176){return function(_0x5a9dd4,_0x7ba5a0){_0x1f3176(_0x5a9dd4,_0x7ba5a0,_0x335282);};};Object['defineProperty'](exports,_0x24ae6f(0x14b),{'value':!![]}),exports['VerificationService']=void 0x0;function _0x5472(){const _0x5221fe=['./verifycation.entity','findOne','验证码发送失败！','createTransport','getConfigs','ChangeEmail','sendMail','637017jAJVij','@nestjs/typeorm','__esModule','expiresAt','329JzPVak','res','verifyCode','USED','验证码已过期','https://eid.shumaidata.com/eid/check','验证码','4obVbOB','Logger','../globalConfig/globalConfig.service','decorate','request','InjectRepository','createdAt','76344PmyUiq','getPhoneVerifyConfig','2844705PryaAv','VerificationEnum','save','verifyIdentity','Error:\x20','axios','sendPhoneCode','Repository','./../../common/constants/verification.constant','../redisCache/redisCache.service','2017-05-25','VerificationUseStatusEnum','now','648JjmBUg','Registration','ThirdPartyAuth','__decorate','HttpException','stack','appCode','BAD_REQUEST','function','__param','Received\x20messageInfo:','Received\x20identityInfo:\x20','__metadata','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h1>验证码</h1>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>您的验证码是：<strong>','DESC','VerificationService','HttpStatus','293571yIBXpj','getEmailConfig','SendSms','Received\x20response:\x20','globalConfigService','object','，30分钟内有效。','确实必要参数错误！','GlobalConfigService','Injectable','createRandomCode','metadata','S内不得重新发送','1837984yaTlne','缺少必要参数！','Message','https://dysmsapi.aliyuncs.com','default','验证码不存在','update','stringify','验证码错误','验证不一致','length','未知的认证结果','error','APPCODE\x20','您的验证码是：','debug','getExpirationTime','getTime','verifycationEntity','../../common/utils','redisCacheService','8606210RZroai','data','result','log','VerifycationEntity','7672LhXYwT','实名认证异常','message','当前验证码已被使用！','application/x-www-form-urlencoded','nodemailer'];_0x5472=function(){return _0x5221fe;};return _0x5472();}const utils_1=require(_0x24ae6f(0x135)),globalConfig_service_1=require(_0x24ae6f(0x156)),common_1=require('@nestjs/common'),typeorm_1=require(_0x24ae6f(0x14a)),typeorm_2=require('typeorm'),redisCache_service_1=require(_0x24ae6f(0x166)),status_constant_1=require('./../../common/constants/status.constant'),verification_constant_1=require(_0x24ae6f(0x165)),verifycation_entity_1=require(_0x24ae6f(0x142)),Core=require('@alicloud/pop-core'),axios_1=require(_0x24ae6f(0x162)),nodemailer=require(_0x24ae6f(0x141));let VerificationService=class VerificationService{constructor(_0x3020b9,_0x45b0a9,_0x3be756){const _0x3f8263=_0x24ae6f;this[_0x3f8263(0x134)]=_0x3020b9,this['globalConfigService']=_0x45b0a9,this[_0x3f8263(0x136)]=_0x3be756;}[_0x24ae6f(0x132)](_0x37b92a){const _0x5a0eb2=_0x24ae6f;switch(_0x37b92a){case verification_constant_1[_0x5a0eb2(0x15e)][_0x5a0eb2(0x16c)]:return 0x3c;case verification_constant_1['VerificationEnum'][_0x5a0eb2(0x16b)]:case verification_constant_1[_0x5a0eb2(0x15e)]['PasswordReset']:return 0x5*0x3c;case verification_constant_1[_0x5a0eb2(0x15e)][_0x5a0eb2(0x147)]:return 0x1e*0x3c;default:return 0x5*0x3c;}}async['createVerification'](_0x483019,_0x150fe0,_0x383418){const _0x2c38b5=_0x24ae6f,_0x1ab238=await this['verifycationEntity'][_0x2c38b5(0x143)]({'where':{'userId':_0x483019['id'],'type':_0x150fe0},'order':{'createdAt':_0x2c38b5(0x178)}});if(_0x1ab238&&_0x1ab238[_0x2c38b5(0x15a)][_0x2c38b5(0x133)]()+0x1*0x3c*0x3e8>Date['now']()){const _0x33f6d4=Math['ceil']((_0x1ab238[_0x2c38b5(0x15a)][_0x2c38b5(0x133)]()+0x1*0x3c*0x3e8-Date['now']())/0x3e8);throw new common_1[(_0x2c38b5(0x16e))](_0x33f6d4+_0x2c38b5(0x121),common_1['HttpStatus'][_0x2c38b5(0x171)]);}const _0x2fa2e6=(0x0,utils_1[_0x2c38b5(0x11f)])(),_0x895bf0=new Date(Date[_0x2c38b5(0x169)]()+(_0x383418||this[_0x2c38b5(0x132)](_0x150fe0))*0x3e8),{id:_0x5e0e31,email:_0x56a975}=_0x483019,_0x5b3820={'userId':_0x5e0e31,'type':_0x150fe0,'code':_0x2fa2e6,'expiresAt':_0x895bf0,'email':_0x56a975};return await this[_0x2c38b5(0x134)][_0x2c38b5(0x15f)](_0x5b3820);}async[_0x24ae6f(0x14f)]({code:_0x10e071,id:_0x3455b6},_0x5ba40f){const _0xc9ca4f=_0x24ae6f,_0x4f3128=await this[_0xc9ca4f(0x134)]['findOne']({'where':{'id':_0x3455b6,'type':_0x5ba40f},'order':{'createdAt':_0xc9ca4f(0x178)}});if(!_0x4f3128)throw new common_1['HttpException'](_0xc9ca4f(0x127),common_1[_0xc9ca4f(0x17a)][_0xc9ca4f(0x171)]);if(_0x4f3128['used']===status_constant_1[_0xc9ca4f(0x168)][_0xc9ca4f(0x150)])throw new common_1[(_0xc9ca4f(0x16e))](_0xc9ca4f(0x13f),common_1[_0xc9ca4f(0x17a)][_0xc9ca4f(0x171)]);else _0x4f3128['used']=status_constant_1[_0xc9ca4f(0x168)][_0xc9ca4f(0x150)],await this[_0xc9ca4f(0x134)][_0xc9ca4f(0x128)]({'id':_0x3455b6},_0x4f3128);if(Number(_0x4f3128['code'])!==Number(_0x10e071))throw new common_1[(_0xc9ca4f(0x16e))](_0xc9ca4f(0x12a),common_1[_0xc9ca4f(0x17a)][_0xc9ca4f(0x171)]);if(_0x4f3128[_0xc9ca4f(0x14c)]<new Date())throw new common_1['HttpException'](_0xc9ca4f(0x151),common_1[_0xc9ca4f(0x17a)][_0xc9ca4f(0x171)]);return _0x4f3128;}async[_0x24ae6f(0x163)](_0x3eda3f){const _0x39f695=_0x24ae6f;var _0x4c3570;const {accessKeyId:_0x3ab948,accessKeySecret:_0x599a86,SignName:_0x3baf7a,TemplateCode:_0x631f5b}=await this[_0x39f695(0x17f)][_0x39f695(0x15c)]();console[_0x39f695(0x13a)](_0x39f695(0x174),_0x3eda3f);const {phone:_0x1acf48,code:_0x2021b5}=_0x3eda3f;if(!_0x1acf48||!_0x2021b5)throw new common_1['HttpException'](_0x39f695(0x11c),common_1[_0x39f695(0x17a)][_0x39f695(0x171)]);const _0x442ebf=new Core({'accessKeyId':_0x3ab948,'accessKeySecret':_0x599a86,'endpoint':_0x39f695(0x125),'apiVersion':_0x39f695(0x167)}),_0x300c87={'PhoneNumbers':_0x1acf48,'SignName':_0x3baf7a,'TemplateCode':_0x631f5b,'TemplateParam':JSON['stringify']({'code':_0x2021b5})},_0xd56053={'method':'POST','formatParams':![]};try{const _0x4911f3=await _0x442ebf[_0x39f695(0x158)](_0x39f695(0x17d),_0x300c87,_0xd56053);if(_0x4911f3['Code']==='OK')return!![];else throw new common_1[(_0x39f695(0x16e))](_0x4911f3[_0x39f695(0x124)]||'验证码发送失败！',common_1['HttpStatus'][_0x39f695(0x171)]);}catch(_0x239b6c){throw new common_1['HttpException'](((_0x4c3570=_0x239b6c===null||_0x239b6c===void 0x0?void 0x0:_0x239b6c[_0x39f695(0x138)])===null||_0x4c3570===void 0x0?void 0x0:_0x4c3570[_0x39f695(0x124)])||_0x39f695(0x144),common_1[_0x39f695(0x17a)]['BAD_REQUEST']);}}async['sendEmailCode'](_0xc52a31){const _0x10d457=_0x24ae6f,{email:_0x3f0271,code:_0x334ab9}=_0xc52a31;if(!_0x3f0271||!_0x334ab9)throw new common_1[(_0x10d457(0x16e))](_0x10d457(0x123),common_1[_0x10d457(0x17a)][_0x10d457(0x171)]);const {emailHost:_0x395dfc,emailPort:_0x3f8d10,emailUser:_0x2eb253,emailPass:_0x7961db}=await this[_0x10d457(0x17f)][_0x10d457(0x17c)](),_0x80c32c=nodemailer[_0x10d457(0x145)]({'host':_0x395dfc,'port':_0x3f8d10,'secure':!![],'auth':{'user':_0x2eb253,'pass':_0x7961db}});try{return await _0x80c32c[_0x10d457(0x148)]({'from':_0x2eb253,'to':_0x3f0271,'subject':_0x10d457(0x153),'text':_0x10d457(0x130)+_0x334ab9+_0x10d457(0x11b),'html':_0x10d457(0x177)+_0x334ab9+'</strong></p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>此验证码30分钟内有效。</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>如果这不是您的操作，请忽略此邮件。</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20'}),!![];}catch(_0x437f13){throw new common_1['HttpException']((_0x437f13===null||_0x437f13===void 0x0?void 0x0:_0x437f13[_0x10d457(0x13e)])||_0x10d457(0x144),common_1[_0x10d457(0x17a)][_0x10d457(0x171)]);}}async[_0x24ae6f(0x160)](_0x5441db){const _0x29dbac=_0x24ae6f,_0x3376f2=await this['globalConfigService'][_0x29dbac(0x146)]([_0x29dbac(0x170)]),{name:_0x2e54a2,idCard:_0x422510}=_0x5441db;if(!_0x2e54a2||!_0x422510)throw new common_1['HttpException']('缺少必要参数！',common_1[_0x29dbac(0x17a)][_0x29dbac(0x171)]);common_1[_0x29dbac(0x155)][_0x29dbac(0x131)](_0x29dbac(0x175)+_0x2e54a2+',\x20'+_0x422510);const _0x18ae06=_0x29dbac(0x152),_0x42c188={'Authorization':_0x29dbac(0x12f)+_0x3376f2,'Content-Type':_0x29dbac(0x140)},_0x37603f=new URLSearchParams({'name':_0x2e54a2,'idcard':_0x422510});try{const _0x4f6d96=await axios_1[_0x29dbac(0x126)]['post'](_0x18ae06,_0x37603f,{'headers':_0x42c188}),_0x58bd47=JSON[_0x29dbac(0x129)](_0x4f6d96[_0x29dbac(0x138)]);common_1['Logger'][_0x29dbac(0x131)](_0x29dbac(0x17e)+_0x58bd47);switch(_0x4f6d96[_0x29dbac(0x138)][_0x29dbac(0x139)][_0x29dbac(0x14e)]){case'1':return!![];case'2':common_1['Logger']['log'](_0x29dbac(0x12b),'VerificationService');case'3':common_1[_0x29dbac(0x155)][_0x29dbac(0x13a)](_0x29dbac(0x13d),_0x29dbac(0x179));default:common_1['Logger']['log'](_0x29dbac(0x12d),_0x29dbac(0x179));}return![];}catch(_0x15d389){return common_1[_0x29dbac(0x155)][_0x29dbac(0x12e)](_0x29dbac(0x161)+_0x15d389['message'],_0x15d389[_0x29dbac(0x16f)],'Verification'),![];}}};VerificationService=__decorate([(0x0,common_1[_0x24ae6f(0x11e)])(),__param(0x0,(0x0,typeorm_1[_0x24ae6f(0x159)])(verifycation_entity_1[_0x24ae6f(0x13b)])),__metadata('design:paramtypes',[typeorm_2[_0x24ae6f(0x164)],globalConfig_service_1[_0x24ae6f(0x11d)],redisCache_service_1['RedisCacheService']])],VerificationService),exports[_0x24ae6f(0x179)]=VerificationService;