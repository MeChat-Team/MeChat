'use strict';const _0x2711aa=_0x3aeb;(function(_0x5bb939,_0x2ebcc5){const _0x2de0cc=_0x3aeb,_0x4fb6ef=_0x5bb939();while(!![]){try{const _0x2f4538=-parseInt(_0x2de0cc(0x155))/0x1*(-parseInt(_0x2de0cc(0x143))/0x2)+-parseInt(_0x2de0cc(0x168))/0x3*(parseInt(_0x2de0cc(0x14a))/0x4)+-parseInt(_0x2de0cc(0x163))/0x5*(parseInt(_0x2de0cc(0x172))/0x6)+parseInt(_0x2de0cc(0x140))/0x7+-parseInt(_0x2de0cc(0x13d))/0x8*(-parseInt(_0x2de0cc(0x156))/0x9)+-parseInt(_0x2de0cc(0x11e))/0xa+parseInt(_0x2de0cc(0x15d))/0xb;if(_0x2f4538===_0x2ebcc5)break;else _0x4fb6ef['push'](_0x4fb6ef['shift']());}catch(_0x143107){_0x4fb6ef['push'](_0x4fb6ef['shift']());}}}(_0xd545,0x3ca5a));function _0xd545(){const _0x245cc4=['getConfigs','未知的认证结果','used','createTransport','18945wNZUqZ','9YxKVwe','../redisCache/redisCache.service','decorate','Error:\x20','验证码错误','stringify','createdAt','5567650MotBVD','VerificationEnum','verifycationEntity','S内不得重新发送','sendMail','getEmailConfig','550675XJrlIq','Logger','findOne','USED','RedisCacheService','57QkwJrW','metadata','ThirdPartyAuth','@nestjs/common','Received\x20response:\x20','VerificationUseStatusEnum','globalConfigService','./../../common/constants/verification.constant','nodemailer','getExpirationTime','6aRKQLn','function','../../common/utils','now','typeorm','Registration','createVerification','DESC','./../../common/constants/status.constant','data','1572120lMyEgt','当前验证码已被使用！','验证不一致','design:paramtypes','APPCODE\x20','appCode','@alicloud/pop-core','__metadata','getTime','expiresAt','ChangeEmail','VerifycationEntity','object','message','BAD_REQUEST','redisCacheService','__decorate','axios','length','https://eid.shumaidata.com/eid/check','Received\x20messageInfo:','createRandomCode','code','__esModule','</strong></p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>此验证码30分钟内有效。</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>如果这不是您的操作，请忽略此邮件。</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20','defineProperty','request','验证码发送失败！','Verification','default','HttpStatus','539080QSaeAj','SendSms','log','1059905lFzjSb','https://dysmsapi.aliyuncs.com','您的验证码是：','16xIOnSc','PasswordReset','Message','application/x-www-form-urlencoded','缺少必要参数！','HttpException','验证码不存在','75948SPFfdp','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h1>验证码</h1>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>您的验证码是：<strong>','debug','POST','InjectRepository','VerificationService','result'];_0xd545=function(){return _0x245cc4;};return _0xd545();}var __decorate=this&&this[_0x2711aa(0x12e)]||function(_0x55dc05,_0xd97f8d,_0x4eb37d,_0x3ec10c){const _0x15da31=_0x2711aa;var _0x4328ff=arguments[_0x15da31(0x130)],_0x1dd291=_0x4328ff<0x3?_0xd97f8d:_0x3ec10c===null?_0x3ec10c=Object['getOwnPropertyDescriptor'](_0xd97f8d,_0x4eb37d):_0x3ec10c,_0x43da58;if(typeof Reflect===_0x15da31(0x12a)&&typeof Reflect['decorate']===_0x15da31(0x115))_0x1dd291=Reflect[_0x15da31(0x158)](_0x55dc05,_0xd97f8d,_0x4eb37d,_0x3ec10c);else{for(var _0x31685b=_0x55dc05[_0x15da31(0x130)]-0x1;_0x31685b>=0x0;_0x31685b--)if(_0x43da58=_0x55dc05[_0x31685b])_0x1dd291=(_0x4328ff<0x3?_0x43da58(_0x1dd291):_0x4328ff>0x3?_0x43da58(_0xd97f8d,_0x4eb37d,_0x1dd291):_0x43da58(_0xd97f8d,_0x4eb37d))||_0x1dd291;}return _0x4328ff>0x3&&_0x1dd291&&Object['defineProperty'](_0xd97f8d,_0x4eb37d,_0x1dd291),_0x1dd291;},__metadata=this&&this[_0x2711aa(0x125)]||function(_0xf46023,_0x35cc49){const _0x35d11c=_0x2711aa;if(typeof Reflect==='object'&&typeof Reflect[_0x35d11c(0x169)]===_0x35d11c(0x115))return Reflect['metadata'](_0xf46023,_0x35cc49);},__param=this&&this['__param']||function(_0x29bb96,_0x3fc4b7){return function(_0x4e3917,_0x4fe6ae){_0x3fc4b7(_0x4e3917,_0x4fe6ae,_0x29bb96);};};Object[_0x2711aa(0x137)](exports,_0x2711aa(0x135),{'value':!![]}),exports['VerificationService']=void 0x0;const utils_1=require(_0x2711aa(0x116)),globalConfig_service_1=require('../globalConfig/globalConfig.service'),common_1=require(_0x2711aa(0x16b)),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0x2711aa(0x118)),redisCache_service_1=require(_0x2711aa(0x157)),status_constant_1=require(_0x2711aa(0x11c)),verification_constant_1=require(_0x2711aa(0x16f)),verifycation_entity_1=require('./verifycation.entity'),Core=require(_0x2711aa(0x124)),axios_1=require(_0x2711aa(0x12f)),nodemailer=require(_0x2711aa(0x170));let VerificationService=class VerificationService{constructor(_0x2a5514,_0x265991,_0x5b46cd){const _0x514686=_0x2711aa;this[_0x514686(0x15f)]=_0x2a5514,this[_0x514686(0x16e)]=_0x265991,this[_0x514686(0x12d)]=_0x5b46cd;}[_0x2711aa(0x171)](_0xab6be0){const _0x1ebb95=_0x2711aa;switch(_0xab6be0){case verification_constant_1['VerificationEnum'][_0x1ebb95(0x16a)]:return 0x3c;case verification_constant_1[_0x1ebb95(0x15e)][_0x1ebb95(0x119)]:case verification_constant_1[_0x1ebb95(0x15e)][_0x1ebb95(0x144)]:return 0x5*0x3c;case verification_constant_1[_0x1ebb95(0x15e)][_0x1ebb95(0x128)]:return 0x1e*0x3c;default:return 0x5*0x3c;}}async[_0x2711aa(0x11a)](_0x2368fd,_0x2a70e1,_0x5ee38d){const _0x2855d3=_0x2711aa,_0x4e75f6=await this[_0x2855d3(0x15f)][_0x2855d3(0x165)]({'where':{'userId':_0x2368fd['id'],'type':_0x2a70e1},'order':{'createdAt':_0x2855d3(0x11b)}});if(_0x4e75f6&&_0x4e75f6['createdAt'][_0x2855d3(0x126)]()+0x1*0x3c*0x3e8>Date[_0x2855d3(0x117)]()){const _0x4a89f1=Math['ceil']((_0x4e75f6[_0x2855d3(0x15c)][_0x2855d3(0x126)]()+0x1*0x3c*0x3e8-Date[_0x2855d3(0x117)]())/0x3e8);throw new common_1[(_0x2855d3(0x148))](_0x4a89f1+_0x2855d3(0x160),common_1[_0x2855d3(0x13c)][_0x2855d3(0x12c)]);}const _0x18db02=(0x0,utils_1[_0x2855d3(0x133)])(),_0x5e8686=new Date(Date[_0x2855d3(0x117)]()+(_0x5ee38d||this[_0x2855d3(0x171)](_0x2a70e1))*0x3e8),{id:_0x18ac17,email:_0x27e2e1}=_0x2368fd,_0x452c98={'userId':_0x18ac17,'type':_0x2a70e1,'code':_0x18db02,'expiresAt':_0x5e8686,'email':_0x27e2e1};return await this[_0x2855d3(0x15f)]['save'](_0x452c98);}async['verifyCode']({code:_0x4a8ea6,id:_0x4cdb3c},_0x51c004){const _0x2e6b03=_0x2711aa,_0x21756d=await this[_0x2e6b03(0x15f)][_0x2e6b03(0x165)]({'where':{'id':_0x4cdb3c,'type':_0x51c004},'order':{'createdAt':_0x2e6b03(0x11b)}});if(!_0x21756d)throw new common_1[(_0x2e6b03(0x148))](_0x2e6b03(0x149),common_1[_0x2e6b03(0x13c)][_0x2e6b03(0x12c)]);if(_0x21756d[_0x2e6b03(0x153)]===status_constant_1[_0x2e6b03(0x16d)]['USED'])throw new common_1[(_0x2e6b03(0x148))](_0x2e6b03(0x11f),common_1[_0x2e6b03(0x13c)][_0x2e6b03(0x12c)]);else _0x21756d[_0x2e6b03(0x153)]=status_constant_1[_0x2e6b03(0x16d)][_0x2e6b03(0x166)],await this[_0x2e6b03(0x15f)]['update']({'id':_0x4cdb3c},_0x21756d);if(Number(_0x21756d[_0x2e6b03(0x134)])!==Number(_0x4a8ea6))throw new common_1['HttpException'](_0x2e6b03(0x15a),common_1[_0x2e6b03(0x13c)][_0x2e6b03(0x12c)]);if(_0x21756d[_0x2e6b03(0x127)]<new Date())throw new common_1['HttpException']('验证码已过期',common_1['HttpStatus'][_0x2e6b03(0x12c)]);return _0x21756d;}async['sendPhoneCode'](_0x2b70f1){const _0x2ba194=_0x2711aa;var _0x1263af;const {accessKeyId:_0x35ccc1,accessKeySecret:_0x473fbd,SignName:_0x1c2e63,TemplateCode:_0x2df219}=await this['globalConfigService']['getPhoneVerifyConfig']();console[_0x2ba194(0x13f)](_0x2ba194(0x132),_0x2b70f1);const {phone:_0x9e4eac,code:_0x559be7}=_0x2b70f1;if(!_0x9e4eac||!_0x559be7)throw new common_1[(_0x2ba194(0x148))]('确实必要参数错误！',common_1['HttpStatus'][_0x2ba194(0x12c)]);const _0x1db3eb=new Core({'accessKeyId':_0x35ccc1,'accessKeySecret':_0x473fbd,'endpoint':_0x2ba194(0x141),'apiVersion':'2017-05-25'}),_0x46820d={'PhoneNumbers':_0x9e4eac,'SignName':_0x1c2e63,'TemplateCode':_0x2df219,'TemplateParam':JSON[_0x2ba194(0x15b)]({'code':_0x559be7})},_0x5ad649={'method':_0x2ba194(0x14d),'formatParams':![]};try{const _0x1d8635=await _0x1db3eb[_0x2ba194(0x138)](_0x2ba194(0x13e),_0x46820d,_0x5ad649);if(_0x1d8635['Code']==='OK')return!![];else throw new common_1['HttpException'](_0x1d8635[_0x2ba194(0x145)]||'验证码发送失败！',common_1[_0x2ba194(0x13c)]['BAD_REQUEST']);}catch(_0x417a9c){throw new common_1['HttpException'](((_0x1263af=_0x417a9c===null||_0x417a9c===void 0x0?void 0x0:_0x417a9c[_0x2ba194(0x11d)])===null||_0x1263af===void 0x0?void 0x0:_0x1263af[_0x2ba194(0x145)])||'验证码发送失败！',common_1['HttpStatus']['BAD_REQUEST']);}}async['sendEmailCode'](_0x51e4c3){const _0x4bd280=_0x2711aa,{email:_0x11d3f8,code:_0x270588}=_0x51e4c3;if(!_0x11d3f8||!_0x270588)throw new common_1['HttpException'](_0x4bd280(0x147),common_1['HttpStatus'][_0x4bd280(0x12c)]);const {emailHost:_0x30ceb7,emailPort:_0x2cf78f,emailUser:_0x28b7f0,emailPass:_0x178519}=await this[_0x4bd280(0x16e)][_0x4bd280(0x162)](),_0x21c10f=nodemailer[_0x4bd280(0x154)]({'host':_0x30ceb7,'port':_0x2cf78f,'secure':!![],'auth':{'user':_0x28b7f0,'pass':_0x178519}});try{return await _0x21c10f[_0x4bd280(0x161)]({'from':_0x28b7f0,'to':_0x11d3f8,'subject':'验证码','text':_0x4bd280(0x142)+_0x270588+'，30分钟内有效。','html':_0x4bd280(0x14b)+_0x270588+_0x4bd280(0x136)}),!![];}catch(_0x54dc99){throw new common_1[(_0x4bd280(0x148))]((_0x54dc99===null||_0x54dc99===void 0x0?void 0x0:_0x54dc99[_0x4bd280(0x12b)])||_0x4bd280(0x139),common_1[_0x4bd280(0x13c)][_0x4bd280(0x12c)]);}}async['verifyIdentity'](_0x27d598){const _0x184a6c=_0x2711aa,_0x2c20e3=await this['globalConfigService'][_0x184a6c(0x151)]([_0x184a6c(0x123)]),{name:_0x47b2d5,idCard:_0x5a8d9a}=_0x27d598;if(!_0x47b2d5||!_0x5a8d9a)throw new common_1[(_0x184a6c(0x148))](_0x184a6c(0x147),common_1[_0x184a6c(0x13c)][_0x184a6c(0x12c)]);common_1[_0x184a6c(0x164)]['debug']('Received\x20identityInfo:\x20'+_0x47b2d5+',\x20'+_0x5a8d9a);const _0x48ddc3=_0x184a6c(0x131),_0x37776b={'Authorization':_0x184a6c(0x122)+_0x2c20e3,'Content-Type':_0x184a6c(0x146)},_0x12ee2e=new URLSearchParams({'name':_0x47b2d5,'idcard':_0x5a8d9a});try{const _0x27ca95=await axios_1[_0x184a6c(0x13b)]['post'](_0x48ddc3,_0x12ee2e,{'headers':_0x37776b}),_0x2ea5eb=JSON[_0x184a6c(0x15b)](_0x27ca95['data']);common_1[_0x184a6c(0x164)][_0x184a6c(0x14c)](_0x184a6c(0x16c)+_0x2ea5eb);switch(_0x27ca95[_0x184a6c(0x11d)][_0x184a6c(0x150)]['res']){case'1':return!![];case'2':common_1['Logger'][_0x184a6c(0x13f)](_0x184a6c(0x120),_0x184a6c(0x14f));case'3':common_1['Logger'][_0x184a6c(0x13f)]('实名认证异常','VerificationService');default:common_1['Logger'][_0x184a6c(0x13f)](_0x184a6c(0x152),_0x184a6c(0x14f));}return![];}catch(_0x271efa){return common_1[_0x184a6c(0x164)]['error'](_0x184a6c(0x159)+_0x271efa['message'],_0x271efa['stack'],_0x184a6c(0x13a)),![];}}};function _0x3aeb(_0x4efac0,_0x45e94d){const _0xd545da=_0xd545();return _0x3aeb=function(_0x3aebdc,_0x5e69ea){_0x3aebdc=_0x3aebdc-0x115;let _0x36bb4d=_0xd545da[_0x3aebdc];return _0x36bb4d;},_0x3aeb(_0x4efac0,_0x45e94d);}VerificationService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x2711aa(0x14e)])(verifycation_entity_1[_0x2711aa(0x129)])),__metadata(_0x2711aa(0x121),[typeorm_2['Repository'],globalConfig_service_1['GlobalConfigService'],redisCache_service_1[_0x2711aa(0x167)]])],VerificationService),exports['VerificationService']=VerificationService;