'use strict';const _0x3d5953=_0x17cd;(function(_0x5f1dfb,_0x9e2c8a){const _0x238613=_0x17cd,_0x5b69d8=_0x5f1dfb();while(!![]){try{const _0x3c3146=parseInt(_0x238613(0x176))/0x1*(parseInt(_0x238613(0x1a8))/0x2)+parseInt(_0x238613(0x1a7))/0x3*(-parseInt(_0x238613(0x168))/0x4)+-parseInt(_0x238613(0x192))/0x5*(parseInt(_0x238613(0x187))/0x6)+-parseInt(_0x238613(0x1cb))/0x7*(parseInt(_0x238613(0x1c6))/0x8)+parseInt(_0x238613(0x1bf))/0x9*(-parseInt(_0x238613(0x16a))/0xa)+-parseInt(_0x238613(0x1a5))/0xb+parseInt(_0x238613(0x189))/0xc;if(_0x3c3146===_0x9e2c8a)break;else _0x5b69d8['push'](_0x5b69d8['shift']());}catch(_0x59fe77){_0x5b69d8['push'](_0x5b69d8['shift']());}}}(_0x5ae4,0x9f90a));function _0x17cd(_0x23f265,_0x3e1b7c){const _0x5ae49d=_0x5ae4();return _0x17cd=function(_0x17cd15,_0x3e0c83){_0x17cd15=_0x17cd15-0x167;let _0x3abfdb=_0x5ae49d[_0x17cd15];return _0x3abfdb;},_0x17cd(_0x23f265,_0x3e1b7c);}function _0x5ae4(){const _0xd499df=['res','107979SQdMUa','14892RuZEbQ','Received\x20messageInfo:','./../../common/constants/status.constant','function','default','debug','未知的认证结果','globalConfigService','Message','getExpirationTime','VerifycationEntity','application/x-www-form-urlencoded','USED','VerificationEnum','createTransport','../redisCache/redisCache.service','getOwnPropertyDescriptor','verifycationEntity','InjectRepository','decorate','ceil','./../../common/constants/verification.constant','当前验证码已被使用！','1863981XipkFF','post','__esModule','https://dysmsapi.aliyuncs.com','metadata','__decorate','Verification','8uCvJSE','log','update','getConfigs','验证码错误','4277602cdwepp','PasswordReset','length','findOne','SendSms','100lmKREX','RedisCacheService','60oriNhf','sendMail','GlobalConfigService','design:paramtypes','createRandomCode','ChangeEmail','验证码','../../common/utils','POST','nodemailer','Injectable','BAD_REQUEST','27NzAxkZ','Logger','appCode','../globalConfig/globalConfig.service','Repository','HttpException','data','VerificationService','stringify','S内不得重新发送','https://eid.shumaidata.com/eid/check','getTime','createdAt','Received\x20identityInfo:\x20','验证码不存在','@alicloud/pop-core','验证码发送失败！','61398ehNMld','ThirdPartyAuth','55388820TxZTfv','save','stack','</strong></p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>此验证码30分钟内有效。</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>如果这不是您的操作，请忽略此邮件。</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20','sendPhoneCode','APPCODE\x20','VerificationUseStatusEnum','HttpStatus','Registration','365CfPpQd','used','axios','getEmailConfig','验证码已过期','Received\x20response:\x20','Code','error','defineProperty','message','sendEmailCode','verifyCode','@nestjs/common','result','缺少必要参数！','now','验证不一致','object','code','7288875WhRZtZ'];_0x5ae4=function(){return _0xd499df;};return _0x5ae4();}var __decorate=this&&this[_0x3d5953(0x1c4)]||function(_0x1968d9,_0x3dcf1e,_0x2fbe74,_0x484a83){const _0x314381=_0x3d5953;var _0x2e9b77=arguments[_0x314381(0x1cd)],_0x505419=_0x2e9b77<0x3?_0x3dcf1e:_0x484a83===null?_0x484a83=Object[_0x314381(0x1b8)](_0x3dcf1e,_0x2fbe74):_0x484a83,_0x12f9e4;if(typeof Reflect===_0x314381(0x1a3)&&typeof Reflect[_0x314381(0x1bb)]==='function')_0x505419=Reflect[_0x314381(0x1bb)](_0x1968d9,_0x3dcf1e,_0x2fbe74,_0x484a83);else{for(var _0x5049db=_0x1968d9[_0x314381(0x1cd)]-0x1;_0x5049db>=0x0;_0x5049db--)if(_0x12f9e4=_0x1968d9[_0x5049db])_0x505419=(_0x2e9b77<0x3?_0x12f9e4(_0x505419):_0x2e9b77>0x3?_0x12f9e4(_0x3dcf1e,_0x2fbe74,_0x505419):_0x12f9e4(_0x3dcf1e,_0x2fbe74))||_0x505419;}return _0x2e9b77>0x3&&_0x505419&&Object[_0x314381(0x19a)](_0x3dcf1e,_0x2fbe74,_0x505419),_0x505419;},__metadata=this&&this['__metadata']||function(_0x3a65a3,_0x18537){const _0x40c55c=_0x3d5953;if(typeof Reflect===_0x40c55c(0x1a3)&&typeof Reflect[_0x40c55c(0x1c3)]===_0x40c55c(0x1ab))return Reflect['metadata'](_0x3a65a3,_0x18537);},__param=this&&this['__param']||function(_0x464d22,_0xee115e){return function(_0x2913ee,_0x4e38e9){_0xee115e(_0x2913ee,_0x4e38e9,_0x464d22);};};Object[_0x3d5953(0x19a)](exports,_0x3d5953(0x1c1),{'value':!![]}),exports[_0x3d5953(0x17d)]=void 0x0;const utils_1=require(_0x3d5953(0x171)),globalConfig_service_1=require(_0x3d5953(0x179)),common_1=require(_0x3d5953(0x19e)),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require('typeorm'),redisCache_service_1=require(_0x3d5953(0x1b7)),status_constant_1=require(_0x3d5953(0x1aa)),verification_constant_1=require(_0x3d5953(0x1bd)),verifycation_entity_1=require('./verifycation.entity'),Core=require(_0x3d5953(0x185)),axios_1=require(_0x3d5953(0x194)),nodemailer=require(_0x3d5953(0x173));let VerificationService=class VerificationService{constructor(_0x29d288,_0x22ea5f,_0x5b8cbf){const _0x29ba1f=_0x3d5953;this['verifycationEntity']=_0x29d288,this[_0x29ba1f(0x1af)]=_0x22ea5f,this['redisCacheService']=_0x5b8cbf;}['getExpirationTime'](_0x2ba824){const _0x312fe8=_0x3d5953;switch(_0x2ba824){case verification_constant_1[_0x312fe8(0x1b5)][_0x312fe8(0x188)]:return 0x3c;case verification_constant_1[_0x312fe8(0x1b5)][_0x312fe8(0x191)]:case verification_constant_1[_0x312fe8(0x1b5)][_0x312fe8(0x1cc)]:return 0x5*0x3c;case verification_constant_1[_0x312fe8(0x1b5)][_0x312fe8(0x16f)]:return 0x1e*0x3c;default:return 0x5*0x3c;}}async['createVerification'](_0x3c599c,_0x13cad3,_0xd79f0){const _0xd3c158=_0x3d5953,_0x1ff839=await this[_0xd3c158(0x1b9)][_0xd3c158(0x1ce)]({'where':{'userId':_0x3c599c['id'],'type':_0x13cad3},'order':{'createdAt':'DESC'}});if(_0x1ff839&&_0x1ff839[_0xd3c158(0x182)][_0xd3c158(0x181)]()+0x1*0x3c*0x3e8>Date[_0xd3c158(0x1a1)]()){const _0x3ee5f5=Math[_0xd3c158(0x1bc)]((_0x1ff839[_0xd3c158(0x182)][_0xd3c158(0x181)]()+0x1*0x3c*0x3e8-Date[_0xd3c158(0x1a1)]())/0x3e8);throw new common_1['HttpException'](_0x3ee5f5+_0xd3c158(0x17f),common_1['HttpStatus'][_0xd3c158(0x175)]);}const _0x47f24c=(0x0,utils_1[_0xd3c158(0x16e)])(),_0xcf420f=new Date(Date[_0xd3c158(0x1a1)]()+(_0xd79f0||this[_0xd3c158(0x1b1)](_0x13cad3))*0x3e8),{id:_0x3d4925,email:_0x37752a}=_0x3c599c,_0x25680f={'userId':_0x3d4925,'type':_0x13cad3,'code':_0x47f24c,'expiresAt':_0xcf420f,'email':_0x37752a};return await this[_0xd3c158(0x1b9)][_0xd3c158(0x18a)](_0x25680f);}async[_0x3d5953(0x19d)]({code:_0x364f94,id:_0x28022b},_0xa95960){const _0x209b68=_0x3d5953,_0x46a36e=await this[_0x209b68(0x1b9)]['findOne']({'where':{'id':_0x28022b,'type':_0xa95960},'order':{'createdAt':'DESC'}});if(!_0x46a36e)throw new common_1[(_0x209b68(0x17b))](_0x209b68(0x184),common_1[_0x209b68(0x190)][_0x209b68(0x175)]);if(_0x46a36e['used']===status_constant_1[_0x209b68(0x18f)][_0x209b68(0x1b4)])throw new common_1[(_0x209b68(0x17b))](_0x209b68(0x1be),common_1[_0x209b68(0x190)][_0x209b68(0x175)]);else _0x46a36e[_0x209b68(0x193)]=status_constant_1[_0x209b68(0x18f)]['USED'],await this[_0x209b68(0x1b9)][_0x209b68(0x1c8)]({'id':_0x28022b},_0x46a36e);if(Number(_0x46a36e[_0x209b68(0x1a4)])!==Number(_0x364f94))throw new common_1['HttpException'](_0x209b68(0x1ca),common_1[_0x209b68(0x190)]['BAD_REQUEST']);if(_0x46a36e['expiresAt']<new Date())throw new common_1['HttpException'](_0x209b68(0x196),common_1[_0x209b68(0x190)][_0x209b68(0x175)]);return _0x46a36e;}async[_0x3d5953(0x18d)](_0x188b35){const _0x2cb990=_0x3d5953;var _0x3fd90a;const {accessKeyId:_0x6ed6d3,accessKeySecret:_0x44b634,SignName:_0x434d4d,TemplateCode:_0x2e132d}=await this[_0x2cb990(0x1af)]['getPhoneVerifyConfig']();console[_0x2cb990(0x1c7)](_0x2cb990(0x1a9),_0x188b35);const {phone:_0x5b32bf,code:_0x37bbe5}=_0x188b35;if(!_0x5b32bf||!_0x37bbe5)throw new common_1[(_0x2cb990(0x17b))]('确实必要参数错误！',common_1[_0x2cb990(0x190)]['BAD_REQUEST']);const _0x94f55c=new Core({'accessKeyId':_0x6ed6d3,'accessKeySecret':_0x44b634,'endpoint':_0x2cb990(0x1c2),'apiVersion':'2017-05-25'}),_0x5e127e={'PhoneNumbers':_0x5b32bf,'SignName':_0x434d4d,'TemplateCode':_0x2e132d,'TemplateParam':JSON[_0x2cb990(0x17e)]({'code':_0x37bbe5})},_0x3452ce={'method':_0x2cb990(0x172),'formatParams':![]};try{const _0x90c44=await _0x94f55c['request'](_0x2cb990(0x167),_0x5e127e,_0x3452ce);if(_0x90c44[_0x2cb990(0x198)]==='OK')return!![];else throw new common_1[(_0x2cb990(0x17b))](_0x90c44[_0x2cb990(0x1b0)]||_0x2cb990(0x186),common_1['HttpStatus'][_0x2cb990(0x175)]);}catch(_0x42fa4d){throw new common_1[(_0x2cb990(0x17b))](((_0x3fd90a=_0x42fa4d===null||_0x42fa4d===void 0x0?void 0x0:_0x42fa4d[_0x2cb990(0x17c)])===null||_0x3fd90a===void 0x0?void 0x0:_0x3fd90a[_0x2cb990(0x1b0)])||'验证码发送失败！',common_1[_0x2cb990(0x190)][_0x2cb990(0x175)]);}}async[_0x3d5953(0x19c)](_0x587e01){const _0x478309=_0x3d5953,{email:_0x2af5df,code:_0x134ce6}=_0x587e01;if(!_0x2af5df||!_0x134ce6)throw new common_1['HttpException'](_0x478309(0x1a0),common_1[_0x478309(0x190)][_0x478309(0x175)]);const {emailHost:_0x3759de,emailPort:_0x26cf45,emailUser:_0x17aaf0,emailPass:_0x3a63aa}=await this[_0x478309(0x1af)][_0x478309(0x195)](),_0x22219f=nodemailer[_0x478309(0x1b6)]({'host':_0x3759de,'port':_0x26cf45,'secure':!![],'auth':{'user':_0x17aaf0,'pass':_0x3a63aa}});try{return await _0x22219f[_0x478309(0x16b)]({'from':_0x17aaf0,'to':_0x2af5df,'subject':_0x478309(0x170),'text':'您的验证码是：'+_0x134ce6+'，30分钟内有效。','html':'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h1>验证码</h1>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>您的验证码是：<strong>'+_0x134ce6+_0x478309(0x18c)}),!![];}catch(_0x262e99){throw new common_1['HttpException']((_0x262e99===null||_0x262e99===void 0x0?void 0x0:_0x262e99[_0x478309(0x19b)])||'验证码发送失败！',common_1['HttpStatus'][_0x478309(0x175)]);}}async['verifyIdentity'](_0x11945e){const _0x57687e=_0x3d5953,_0x2fd4fe=await this[_0x57687e(0x1af)][_0x57687e(0x1c9)]([_0x57687e(0x178)]),{name:_0x4bc03f,idCard:_0x2099ae}=_0x11945e;if(!_0x4bc03f||!_0x2099ae)throw new common_1[(_0x57687e(0x17b))](_0x57687e(0x1a0),common_1[_0x57687e(0x190)]['BAD_REQUEST']);common_1[_0x57687e(0x177)][_0x57687e(0x1ad)](_0x57687e(0x183)+_0x4bc03f+',\x20'+_0x2099ae);const _0x53228c=_0x57687e(0x180),_0x34253d={'Authorization':_0x57687e(0x18e)+_0x2fd4fe,'Content-Type':_0x57687e(0x1b3)},_0x4d4281=new URLSearchParams({'name':_0x4bc03f,'idcard':_0x2099ae});try{const _0x356657=await axios_1[_0x57687e(0x1ac)][_0x57687e(0x1c0)](_0x53228c,_0x4d4281,{'headers':_0x34253d}),_0x53b95b=JSON['stringify'](_0x356657['data']);common_1[_0x57687e(0x177)][_0x57687e(0x1ad)](_0x57687e(0x197)+_0x53b95b);switch(_0x356657[_0x57687e(0x17c)][_0x57687e(0x19f)][_0x57687e(0x1a6)]){case'1':return!![];case'2':common_1[_0x57687e(0x177)][_0x57687e(0x1c7)](_0x57687e(0x1a2),_0x57687e(0x17d));case'3':common_1[_0x57687e(0x177)][_0x57687e(0x1c7)]('实名认证异常','VerificationService');default:common_1[_0x57687e(0x177)][_0x57687e(0x1c7)](_0x57687e(0x1ae),_0x57687e(0x17d));}return![];}catch(_0x41d9ab){return common_1[_0x57687e(0x177)][_0x57687e(0x199)]('Error:\x20'+_0x41d9ab[_0x57687e(0x19b)],_0x41d9ab[_0x57687e(0x18b)],_0x57687e(0x1c5)),![];}}};VerificationService=__decorate([(0x0,common_1[_0x3d5953(0x174)])(),__param(0x0,(0x0,typeorm_1[_0x3d5953(0x1ba)])(verifycation_entity_1[_0x3d5953(0x1b2)])),__metadata(_0x3d5953(0x16d),[typeorm_2[_0x3d5953(0x17a)],globalConfig_service_1[_0x3d5953(0x16c)],redisCache_service_1[_0x3d5953(0x169)]])],VerificationService),exports[_0x3d5953(0x17d)]=VerificationService;