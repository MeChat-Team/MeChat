'use strict';const _0x2c0b65=_0x1747;(function(_0x35c3a9,_0x4143d0){const _0x394537=_0x1747,_0x3b627f=_0x35c3a9();while(!![]){try{const _0x58f657=-parseInt(_0x394537(0xe8))/0x1+parseInt(_0x394537(0xe9))/0x2*(parseInt(_0x394537(0xfd))/0x3)+parseInt(_0x394537(0x125))/0x4+-parseInt(_0x394537(0x12c))/0x5+-parseInt(_0x394537(0xe6))/0x6*(-parseInt(_0x394537(0xf6))/0x7)+-parseInt(_0x394537(0xe1))/0x8*(parseInt(_0x394537(0xfe))/0x9)+parseInt(_0x394537(0xde))/0xa;if(_0x58f657===_0x4143d0)break;else _0x3b627f['push'](_0x3b627f['shift']());}catch(_0x619b2c){_0x3b627f['push'](_0x3b627f['shift']());}}}(_0x3947,0x22404));function _0x3947(){const _0x190e7e=['__param','now','code','redisCacheService','__decorate','@nestjs/typeorm','3638870hdtWEF','HttpException','https://eid.shumaidata.com/eid/check','8EXzJay','../redisCache/redisCache.service','data','expiresAt','application/x-www-form-urlencoded','862674KHaqxT','InjectRepository','156240NAqrhM','7806IrDFSd','Message','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h1>验证码</h1>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>您的验证码是：<strong>','metadata','stack','未知的认证结果','VerifycationEntity','update','HttpStatus','您的验证码是：','__metadata','getTime','save','7kweSnF','@nestjs/common','验证不一致','缺少必要参数！','post','Repository','object','51HyZXhU','1280187xCljpk','S内不得重新发送','，30分钟内有效。','defineProperty','verifycationEntity','Error:\x20','验证码','design:paramtypes','request','axios','stringify','RedisCacheService','USED','sendMail','createRandomCode','function','验证码发送失败！','2017-05-25','log','PasswordReset','./../../common/constants/status.constant','verifyCode','length','res','Logger','getOwnPropertyDescriptor','getPhoneVerifyConfig','VerificationService','typeorm','VerificationEnum','appCode','sendPhoneCode','verifyIdentity','createdAt','Verification','./verifycation.entity','decorate','ceil','Injectable','152976bJfvWw','message','debug','VerificationUseStatusEnum','BAD_REQUEST','Received\x20messageInfo:','result','867430tmXUNI','</strong></p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>此验证码30分钟内有效。</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>如果这不是您的操作，请忽略此邮件。</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20','__esModule','Received\x20response:\x20','当前验证码已被使用！','../globalConfig/globalConfig.service','findOne','GlobalConfigService','getConfigs','globalConfigService','createTransport','used','DESC','sendEmailCode','createVerification','default','APPCODE\x20'];_0x3947=function(){return _0x190e7e;};return _0x3947();}var __decorate=this&&this[_0x2c0b65(0xdc)]||function(_0x200d14,_0x3d280f,_0x4478ff,_0x34c620){const _0x1ada50=_0x2c0b65;var _0x3b6b04=arguments['length'],_0x5999b5=_0x3b6b04<0x3?_0x3d280f:_0x34c620===null?_0x34c620=Object[_0x1ada50(0x117)](_0x3d280f,_0x4478ff):_0x34c620,_0x1450c5;if(typeof Reflect===_0x1ada50(0xfc)&&typeof Reflect[_0x1ada50(0x122)]===_0x1ada50(0x10d))_0x5999b5=Reflect[_0x1ada50(0x122)](_0x200d14,_0x3d280f,_0x4478ff,_0x34c620);else{for(var _0x120209=_0x200d14[_0x1ada50(0x114)]-0x1;_0x120209>=0x0;_0x120209--)if(_0x1450c5=_0x200d14[_0x120209])_0x5999b5=(_0x3b6b04<0x3?_0x1450c5(_0x5999b5):_0x3b6b04>0x3?_0x1450c5(_0x3d280f,_0x4478ff,_0x5999b5):_0x1450c5(_0x3d280f,_0x4478ff))||_0x5999b5;}return _0x3b6b04>0x3&&_0x5999b5&&Object['defineProperty'](_0x3d280f,_0x4478ff,_0x5999b5),_0x5999b5;},__metadata=this&&this[_0x2c0b65(0xf3)]||function(_0x577247,_0x5b32b7){const _0x458cba=_0x2c0b65;if(typeof Reflect===_0x458cba(0xfc)&&typeof Reflect[_0x458cba(0xec)]===_0x458cba(0x10d))return Reflect[_0x458cba(0xec)](_0x577247,_0x5b32b7);},__param=this&&this[_0x2c0b65(0xd8)]||function(_0xcbffdf,_0x1821fb){return function(_0x3a18cf,_0x54a336){_0x1821fb(_0x3a18cf,_0x54a336,_0xcbffdf);};};Object[_0x2c0b65(0x101)](exports,_0x2c0b65(0x12e),{'value':!![]}),exports[_0x2c0b65(0x119)]=void 0x0;const utils_1=require('../../common/utils'),globalConfig_service_1=require(_0x2c0b65(0x131)),common_1=require(_0x2c0b65(0xf7)),typeorm_1=require(_0x2c0b65(0xdd)),typeorm_2=require(_0x2c0b65(0x11a)),redisCache_service_1=require(_0x2c0b65(0xe2)),status_constant_1=require(_0x2c0b65(0x112)),verification_constant_1=require('./../../common/constants/verification.constant'),verifycation_entity_1=require(_0x2c0b65(0x121)),Core=require('@alicloud/pop-core'),axios_1=require(_0x2c0b65(0x107)),nodemailer=require('nodemailer');let VerificationService=class VerificationService{constructor(_0x4a0754,_0x432bf3,_0x2ae3f8){const _0x3462d3=_0x2c0b65;this[_0x3462d3(0x102)]=_0x4a0754,this[_0x3462d3(0x135)]=_0x432bf3,this[_0x3462d3(0xdb)]=_0x2ae3f8;}['getExpirationTime'](_0xf4cf89){const _0x3e2e1b=_0x2c0b65;switch(_0xf4cf89){case verification_constant_1['VerificationEnum']['ThirdPartyAuth']:return 0x3c;case verification_constant_1['VerificationEnum']['Registration']:case verification_constant_1['VerificationEnum'][_0x3e2e1b(0x111)]:return 0x5*0x3c;case verification_constant_1[_0x3e2e1b(0x11b)]['ChangeEmail']:return 0x1e*0x3c;default:return 0x5*0x3c;}}async[_0x2c0b65(0x13a)](_0x1ec1e4,_0x33489b,_0x28f578){const _0x59329d=_0x2c0b65,_0x2ca763=await this[_0x59329d(0x102)][_0x59329d(0x132)]({'where':{'userId':_0x1ec1e4['id'],'type':_0x33489b},'order':{'createdAt':_0x59329d(0x138)}});if(_0x2ca763&&_0x2ca763[_0x59329d(0x11f)][_0x59329d(0xf4)]()+0x1*0x3c*0x3e8>Date[_0x59329d(0xd9)]()){const _0x4cf237=Math[_0x59329d(0x123)]((_0x2ca763['createdAt'][_0x59329d(0xf4)]()+0x1*0x3c*0x3e8-Date[_0x59329d(0xd9)]())/0x3e8);throw new common_1['HttpException'](_0x4cf237+_0x59329d(0xff),common_1[_0x59329d(0xf1)][_0x59329d(0x129)]);}const _0x22d6f0=(0x0,utils_1[_0x59329d(0x10c)])(),_0x36039c=new Date(Date[_0x59329d(0xd9)]()+(_0x28f578||this['getExpirationTime'](_0x33489b))*0x3e8),{id:_0x57fb8a,email:_0x51132e}=_0x1ec1e4,_0x349e10={'userId':_0x57fb8a,'type':_0x33489b,'code':_0x22d6f0,'expiresAt':_0x36039c,'email':_0x51132e};return await this[_0x59329d(0x102)][_0x59329d(0xf5)](_0x349e10);}async[_0x2c0b65(0x113)]({code:_0x37a66e,id:_0x293bd6},_0x355082){const _0x11f0dc=_0x2c0b65,_0x1d0940=await this[_0x11f0dc(0x102)]['findOne']({'where':{'id':_0x293bd6,'type':_0x355082},'order':{'createdAt':_0x11f0dc(0x138)}});if(!_0x1d0940)throw new common_1[(_0x11f0dc(0xdf))]('验证码不存在',common_1['HttpStatus']['BAD_REQUEST']);if(_0x1d0940['used']===status_constant_1[_0x11f0dc(0x128)][_0x11f0dc(0x10a)])throw new common_1[(_0x11f0dc(0xdf))](_0x11f0dc(0x130),common_1[_0x11f0dc(0xf1)][_0x11f0dc(0x129)]);else _0x1d0940[_0x11f0dc(0x137)]=status_constant_1[_0x11f0dc(0x128)][_0x11f0dc(0x10a)],await this[_0x11f0dc(0x102)][_0x11f0dc(0xf0)]({'id':_0x293bd6},_0x1d0940);if(Number(_0x1d0940[_0x11f0dc(0xda)])!==Number(_0x37a66e))throw new common_1[(_0x11f0dc(0xdf))]('验证码错误',common_1[_0x11f0dc(0xf1)]['BAD_REQUEST']);if(_0x1d0940[_0x11f0dc(0xe4)]<new Date())throw new common_1['HttpException']('验证码已过期',common_1[_0x11f0dc(0xf1)][_0x11f0dc(0x129)]);return _0x1d0940;}async[_0x2c0b65(0x11d)](_0x417718){const _0x19dbfb=_0x2c0b65;var _0x50060f;const {accessKeyId:_0x4819de,accessKeySecret:_0x23c0a9,SignName:_0x31ccac,TemplateCode:_0x8dbca1}=await this[_0x19dbfb(0x135)][_0x19dbfb(0x118)]();console[_0x19dbfb(0x110)](_0x19dbfb(0x12a),_0x417718);const {phone:_0x262b06,code:_0x1efc56}=_0x417718;if(!_0x262b06||!_0x1efc56)throw new common_1[(_0x19dbfb(0xdf))]('确实必要参数错误！',common_1[_0x19dbfb(0xf1)][_0x19dbfb(0x129)]);const _0x4bde15=new Core({'accessKeyId':_0x4819de,'accessKeySecret':_0x23c0a9,'endpoint':'https://dysmsapi.aliyuncs.com','apiVersion':_0x19dbfb(0x10f)}),_0x3c5abd={'PhoneNumbers':_0x262b06,'SignName':_0x31ccac,'TemplateCode':_0x8dbca1,'TemplateParam':JSON[_0x19dbfb(0x108)]({'code':_0x1efc56})},_0x1f2cca={'method':'POST','formatParams':![]};try{const _0x5a79cc=await _0x4bde15[_0x19dbfb(0x106)]('SendSms',_0x3c5abd,_0x1f2cca);if(_0x5a79cc['Code']==='OK')return!![];else throw new common_1[(_0x19dbfb(0xdf))](_0x5a79cc[_0x19dbfb(0xea)]||'验证码发送失败！',common_1[_0x19dbfb(0xf1)]['BAD_REQUEST']);}catch(_0x159a8e){throw new common_1[(_0x19dbfb(0xdf))](((_0x50060f=_0x159a8e===null||_0x159a8e===void 0x0?void 0x0:_0x159a8e[_0x19dbfb(0xe3)])===null||_0x50060f===void 0x0?void 0x0:_0x50060f['Message'])||'验证码发送失败！',common_1[_0x19dbfb(0xf1)][_0x19dbfb(0x129)]);}}async[_0x2c0b65(0x139)](_0x189afe){const _0x42348b=_0x2c0b65,{email:_0x596d11,code:_0x529aef}=_0x189afe;if(!_0x596d11||!_0x529aef)throw new common_1[(_0x42348b(0xdf))](_0x42348b(0xf9),common_1['HttpStatus'][_0x42348b(0x129)]);const {emailHost:_0x83b96,emailPort:_0x2e18aa,emailUser:_0x417faa,emailPass:_0x57d7d9}=await this[_0x42348b(0x135)]['getEmailConfig'](),_0xc8f3fe=nodemailer[_0x42348b(0x136)]({'host':_0x83b96,'port':_0x2e18aa,'secure':!![],'auth':{'user':_0x417faa,'pass':_0x57d7d9}});try{return await _0xc8f3fe[_0x42348b(0x10b)]({'from':_0x417faa,'to':_0x596d11,'subject':_0x42348b(0x104),'text':_0x42348b(0xf2)+_0x529aef+_0x42348b(0x100),'html':_0x42348b(0xeb)+_0x529aef+_0x42348b(0x12d)}),!![];}catch(_0x14fdaf){throw new common_1['HttpException']((_0x14fdaf===null||_0x14fdaf===void 0x0?void 0x0:_0x14fdaf[_0x42348b(0x126)])||_0x42348b(0x10e),common_1[_0x42348b(0xf1)]['BAD_REQUEST']);}}async[_0x2c0b65(0x11e)](_0x426678){const _0x547934=_0x2c0b65,_0x41a040=await this[_0x547934(0x135)][_0x547934(0x134)]([_0x547934(0x11c)]),{name:_0x31fe25,idCard:_0x1ee425}=_0x426678;if(!_0x31fe25||!_0x1ee425)throw new common_1[(_0x547934(0xdf))](_0x547934(0xf9),common_1[_0x547934(0xf1)][_0x547934(0x129)]);common_1[_0x547934(0x116)]['debug']('Received\x20identityInfo:\x20'+_0x31fe25+',\x20'+_0x1ee425);const _0x566689=_0x547934(0xe0),_0x59367f={'Authorization':_0x547934(0xd7)+_0x41a040,'Content-Type':_0x547934(0xe5)},_0x1939d3=new URLSearchParams({'name':_0x31fe25,'idcard':_0x1ee425});try{const _0x5e0b30=await axios_1[_0x547934(0xd6)][_0x547934(0xfa)](_0x566689,_0x1939d3,{'headers':_0x59367f}),_0x3b3108=JSON['stringify'](_0x5e0b30[_0x547934(0xe3)]);common_1[_0x547934(0x116)][_0x547934(0x127)](_0x547934(0x12f)+_0x3b3108);switch(_0x5e0b30[_0x547934(0xe3)][_0x547934(0x12b)][_0x547934(0x115)]){case'1':return!![];case'2':common_1[_0x547934(0x116)][_0x547934(0x110)](_0x547934(0xf8),_0x547934(0x119));case'3':common_1['Logger'][_0x547934(0x110)]('实名认证异常',_0x547934(0x119));default:common_1['Logger'][_0x547934(0x110)](_0x547934(0xee),_0x547934(0x119));}return![];}catch(_0x5ea5a0){return common_1['Logger']['error'](_0x547934(0x103)+_0x5ea5a0[_0x547934(0x126)],_0x5ea5a0[_0x547934(0xed)],_0x547934(0x120)),![];}}};function _0x1747(_0x33a84d,_0x9f39ac){const _0x39478b=_0x3947();return _0x1747=function(_0x1747ae,_0x450eb5){_0x1747ae=_0x1747ae-0xd6;let _0x2009d7=_0x39478b[_0x1747ae];return _0x2009d7;},_0x1747(_0x33a84d,_0x9f39ac);}VerificationService=__decorate([(0x0,common_1[_0x2c0b65(0x124)])(),__param(0x0,(0x0,typeorm_1[_0x2c0b65(0xe7)])(verifycation_entity_1[_0x2c0b65(0xef)])),__metadata(_0x2c0b65(0x105),[typeorm_2[_0x2c0b65(0xfb)],globalConfig_service_1[_0x2c0b65(0x133)],redisCache_service_1[_0x2c0b65(0x109)]])],VerificationService),exports[_0x2c0b65(0x119)]=VerificationService;