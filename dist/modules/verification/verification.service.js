'use strict';function _0x1de5(_0x4cbf99,_0x34c72d){const _0x35572c=_0x3557();return _0x1de5=function(_0x1de598,_0x1c815f){_0x1de598=_0x1de598-0x1c8;let _0x228b46=_0x35572c[_0x1de598];return _0x228b46;},_0x1de5(_0x4cbf99,_0x34c72d);}const _0x5c962e=_0x1de5;(function(_0x4153d7,_0x1b7c5c){const _0x11f0d7=_0x1de5,_0x3c5b0d=_0x4153d7();while(!![]){try{const _0x1b9374=-parseInt(_0x11f0d7(0x200))/0x1*(parseInt(_0x11f0d7(0x22b))/0x2)+-parseInt(_0x11f0d7(0x1f2))/0x3+parseInt(_0x11f0d7(0x22a))/0x4+-parseInt(_0x11f0d7(0x1e2))/0x5*(parseInt(_0x11f0d7(0x1f0))/0x6)+-parseInt(_0x11f0d7(0x207))/0x7*(parseInt(_0x11f0d7(0x208))/0x8)+-parseInt(_0x11f0d7(0x1cf))/0x9+parseInt(_0x11f0d7(0x20e))/0xa;if(_0x1b9374===_0x1b7c5c)break;else _0x3c5b0d['push'](_0x3c5b0d['shift']());}catch(_0xacacb2){_0x3c5b0d['push'](_0x3c5b0d['shift']());}}}(_0x3557,0xe8f2c));var __decorate=this&&this[_0x5c962e(0x1f9)]||function(_0x5594fa,_0x2ec008,_0x28bcf9,_0x4f2d07){const _0x2985f1=_0x5c962e;var _0x3bee35=arguments[_0x2985f1(0x1e4)],_0x29e41b=_0x3bee35<0x3?_0x2ec008:_0x4f2d07===null?_0x4f2d07=Object[_0x2985f1(0x1db)](_0x2ec008,_0x28bcf9):_0x4f2d07,_0x3c9122;if(typeof Reflect===_0x2985f1(0x1c9)&&typeof Reflect[_0x2985f1(0x1ec)]===_0x2985f1(0x20f))_0x29e41b=Reflect['decorate'](_0x5594fa,_0x2ec008,_0x28bcf9,_0x4f2d07);else{for(var _0x7f49ce=_0x5594fa['length']-0x1;_0x7f49ce>=0x0;_0x7f49ce--)if(_0x3c9122=_0x5594fa[_0x7f49ce])_0x29e41b=(_0x3bee35<0x3?_0x3c9122(_0x29e41b):_0x3bee35>0x3?_0x3c9122(_0x2ec008,_0x28bcf9,_0x29e41b):_0x3c9122(_0x2ec008,_0x28bcf9))||_0x29e41b;}return _0x3bee35>0x3&&_0x29e41b&&Object['defineProperty'](_0x2ec008,_0x28bcf9,_0x29e41b),_0x29e41b;},__metadata=this&&this[_0x5c962e(0x1f8)]||function(_0x49bc56,_0x2e8f4b){const _0x2a3e0c=_0x5c962e;if(typeof Reflect===_0x2a3e0c(0x1c9)&&typeof Reflect[_0x2a3e0c(0x210)]===_0x2a3e0c(0x20f))return Reflect[_0x2a3e0c(0x210)](_0x49bc56,_0x2e8f4b);},__param=this&&this[_0x5c962e(0x1f5)]||function(_0x4ab86e,_0x4e0159){return function(_0x4e8da2,_0x22f6c9){_0x4e0159(_0x4e8da2,_0x22f6c9,_0x4ab86e);};};function _0x3557(){const _0x47ed2b=['verifyIdentity','USED','2017-05-25','15khoUOw','@nestjs/common','length','./../../common/constants/status.constant','code','当前验证码已被使用！','./verifycation.entity','HttpStatus','验证码已过期','globalConfigService','decorate','RedisCacheService','redisCacheService','stringify','2376318zmBcIR','Received\x20messageInfo:','2896800irwGUg','save','缺少必要参数！','__param','APPCODE\x20','message','__metadata','__decorate','./../../common/constants/verification.constant','verifycationEntity','sendEmailCode','VerificationService','../redisCache/redisCache.service','debug','4229YadWbT','ThirdPartyAuth','InjectRepository','sendMail','appCode','验证码发送失败！','VerificationEnum','2523815hmpNOo','8iCakyo','Injectable','post','defineProperty','VerificationUseStatusEnum','createdAt','54487020rNPtoz','function','metadata','DESC','res','https://dysmsapi.aliyuncs.com','createTransport','ChangeEmail','error','default','POST','nodemailer','log','Message','__esModule','验证码错误','Received\x20response:\x20','确实必要参数错误！','used','getExpirationTime','</strong></p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>此验证码30分钟内有效。</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>如果这不是您的操作，请忽略此邮件。</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20','HttpException','VerifycationEntity','Repository','SendSms','createRandomCode','BAD_REQUEST','createVerification','1878592bKmLVo','526SCbRLX','typeorm','object','update','PasswordReset','验证不一致','verifyCode','ceil','12038967YUqFUK','Error:\x20','data','Logger','Verification','../globalConfig/globalConfig.service','Registration','getTime','验证码','findOne','now','Received\x20identityInfo:\x20','getOwnPropertyDescriptor','https://eid.shumaidata.com/eid/check','验证码不存在','getConfigs'];_0x3557=function(){return _0x47ed2b;};return _0x3557();}Object[_0x5c962e(0x20b)](exports,_0x5c962e(0x21c),{'value':!![]}),exports[_0x5c962e(0x1fd)]=void 0x0;const utils_1=require('../../common/utils'),globalConfig_service_1=require(_0x5c962e(0x1d4)),common_1=require(_0x5c962e(0x1e3)),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0x5c962e(0x1c8)),redisCache_service_1=require(_0x5c962e(0x1fe)),status_constant_1=require(_0x5c962e(0x1e5)),verification_constant_1=require(_0x5c962e(0x1fa)),verifycation_entity_1=require(_0x5c962e(0x1e8)),Core=require('@alicloud/pop-core'),axios_1=require('axios'),nodemailer=require(_0x5c962e(0x219));let VerificationService=class VerificationService{constructor(_0x5e80ba,_0x4ace47,_0x23a8a4){const _0x13b5e4=_0x5c962e;this[_0x13b5e4(0x1fb)]=_0x5e80ba,this['globalConfigService']=_0x4ace47,this[_0x13b5e4(0x1ee)]=_0x23a8a4;}[_0x5c962e(0x221)](_0x35f607){const _0xc4de8d=_0x5c962e;switch(_0x35f607){case verification_constant_1[_0xc4de8d(0x206)][_0xc4de8d(0x201)]:return 0x3c;case verification_constant_1['VerificationEnum'][_0xc4de8d(0x1d5)]:case verification_constant_1[_0xc4de8d(0x206)][_0xc4de8d(0x1cb)]:return 0x5*0x3c;case verification_constant_1[_0xc4de8d(0x206)][_0xc4de8d(0x215)]:return 0x1e*0x3c;default:return 0x5*0x3c;}}async[_0x5c962e(0x229)](_0x339492,_0x157565,_0x1c2396){const _0x40468f=_0x5c962e,_0x5bc09a=await this[_0x40468f(0x1fb)][_0x40468f(0x1d8)]({'where':{'userId':_0x339492['id'],'type':_0x157565},'order':{'createdAt':_0x40468f(0x211)}});if(_0x5bc09a&&_0x5bc09a[_0x40468f(0x20d)][_0x40468f(0x1d6)]()+0x1*0x3c*0x3e8>Date['now']()){const _0x265944=Math[_0x40468f(0x1ce)]((_0x5bc09a[_0x40468f(0x20d)][_0x40468f(0x1d6)]()+0x1*0x3c*0x3e8-Date[_0x40468f(0x1d9)]())/0x3e8);throw new common_1[(_0x40468f(0x223))](_0x265944+'S内不得重新发送',common_1[_0x40468f(0x1e9)][_0x40468f(0x228)]);}const _0x42649f=(0x0,utils_1[_0x40468f(0x227)])(),_0xb03d47=new Date(Date[_0x40468f(0x1d9)]()+(_0x1c2396||this[_0x40468f(0x221)](_0x157565))*0x3e8),{id:_0x195645,email:_0x2dd891}=_0x339492,_0x35c85f={'userId':_0x195645,'type':_0x157565,'code':_0x42649f,'expiresAt':_0xb03d47,'email':_0x2dd891};return await this[_0x40468f(0x1fb)][_0x40468f(0x1f3)](_0x35c85f);}async[_0x5c962e(0x1cd)]({code:_0x42fce5,id:_0xf2b508},_0x1d32eb){const _0x1f361f=_0x5c962e,_0x39762e=await this[_0x1f361f(0x1fb)][_0x1f361f(0x1d8)]({'where':{'id':_0xf2b508,'type':_0x1d32eb},'order':{'createdAt':_0x1f361f(0x211)}});if(!_0x39762e)throw new common_1[(_0x1f361f(0x223))](_0x1f361f(0x1dd),common_1['HttpStatus'][_0x1f361f(0x228)]);if(_0x39762e[_0x1f361f(0x220)]===status_constant_1[_0x1f361f(0x20c)][_0x1f361f(0x1e0)])throw new common_1[(_0x1f361f(0x223))](_0x1f361f(0x1e7),common_1[_0x1f361f(0x1e9)]['BAD_REQUEST']);else _0x39762e[_0x1f361f(0x220)]=status_constant_1[_0x1f361f(0x20c)]['USED'],await this['verifycationEntity'][_0x1f361f(0x1ca)]({'id':_0xf2b508},_0x39762e);if(Number(_0x39762e[_0x1f361f(0x1e6)])!==Number(_0x42fce5))throw new common_1[(_0x1f361f(0x223))](_0x1f361f(0x21d),common_1[_0x1f361f(0x1e9)][_0x1f361f(0x228)]);if(_0x39762e['expiresAt']<new Date())throw new common_1[(_0x1f361f(0x223))](_0x1f361f(0x1ea),common_1[_0x1f361f(0x1e9)]['BAD_REQUEST']);return _0x39762e;}async['sendPhoneCode'](_0x2ced40){const _0x591771=_0x5c962e;var _0xb62890;const {accessKeyId:_0x2edfac,accessKeySecret:_0x14e2b3,SignName:_0x2b4524,TemplateCode:_0x19a2b3}=await this['globalConfigService']['getPhoneVerifyConfig']();console['log'](_0x591771(0x1f1),_0x2ced40);const {phone:_0x3ba9a3,code:_0x2d15ef}=_0x2ced40;if(!_0x3ba9a3||!_0x2d15ef)throw new common_1[(_0x591771(0x223))](_0x591771(0x21f),common_1[_0x591771(0x1e9)][_0x591771(0x228)]);const _0x455bca=new Core({'accessKeyId':_0x2edfac,'accessKeySecret':_0x14e2b3,'endpoint':_0x591771(0x213),'apiVersion':_0x591771(0x1e1)}),_0x27a5fb={'PhoneNumbers':_0x3ba9a3,'SignName':_0x2b4524,'TemplateCode':_0x19a2b3,'TemplateParam':JSON[_0x591771(0x1ef)]({'code':_0x2d15ef})},_0x30fbc5={'method':_0x591771(0x218),'formatParams':![]};try{const _0x324183=await _0x455bca['request'](_0x591771(0x226),_0x27a5fb,_0x30fbc5);if(_0x324183['Code']==='OK')return!![];else throw new common_1[(_0x591771(0x223))](_0x324183[_0x591771(0x21b)]||_0x591771(0x205),common_1[_0x591771(0x1e9)][_0x591771(0x228)]);}catch(_0x190491){throw new common_1['HttpException'](((_0xb62890=_0x190491===null||_0x190491===void 0x0?void 0x0:_0x190491[_0x591771(0x1d1)])===null||_0xb62890===void 0x0?void 0x0:_0xb62890[_0x591771(0x21b)])||_0x591771(0x205),common_1[_0x591771(0x1e9)][_0x591771(0x228)]);}}async[_0x5c962e(0x1fc)](_0x2b5826){const _0x2019ea=_0x5c962e,{email:_0x232893,code:_0x5735f2}=_0x2b5826;if(!_0x232893||!_0x5735f2)throw new common_1['HttpException'](_0x2019ea(0x1f4),common_1[_0x2019ea(0x1e9)][_0x2019ea(0x228)]);const {emailHost:_0x4ebeed,emailPort:_0xcbbbfa,emailUser:_0x4b3b98,emailPass:_0x453abd}=await this['globalConfigService']['getEmailConfig'](),_0x49b77b=nodemailer[_0x2019ea(0x214)]({'host':_0x4ebeed,'port':_0xcbbbfa,'secure':!![],'auth':{'user':_0x4b3b98,'pass':_0x453abd}});try{return await _0x49b77b[_0x2019ea(0x203)]({'from':_0x4b3b98,'to':_0x232893,'subject':_0x2019ea(0x1d7),'text':'您的验证码是：'+_0x5735f2+'，30分钟内有效。','html':'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h1>验证码</h1>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>您的验证码是：<strong>'+_0x5735f2+_0x2019ea(0x222)}),!![];}catch(_0x49e11c){throw new common_1[(_0x2019ea(0x223))]((_0x49e11c===null||_0x49e11c===void 0x0?void 0x0:_0x49e11c['message'])||_0x2019ea(0x205),common_1[_0x2019ea(0x1e9)]['BAD_REQUEST']);}}async[_0x5c962e(0x1df)](_0x20bd9a){const _0x1eca2a=_0x5c962e,_0x3ba606=await this[_0x1eca2a(0x1eb)][_0x1eca2a(0x1de)]([_0x1eca2a(0x204)]),{name:_0x55755e,idCard:_0x43e34d}=_0x20bd9a;if(!_0x55755e||!_0x43e34d)throw new common_1[(_0x1eca2a(0x223))]('缺少必要参数！',common_1[_0x1eca2a(0x1e9)]['BAD_REQUEST']);common_1['Logger'][_0x1eca2a(0x1ff)](_0x1eca2a(0x1da)+_0x55755e+',\x20'+_0x43e34d);const _0x5f54e2=_0x1eca2a(0x1dc),_0x14d86d={'Authorization':_0x1eca2a(0x1f6)+_0x3ba606,'Content-Type':'application/x-www-form-urlencoded'},_0x503216=new URLSearchParams({'name':_0x55755e,'idcard':_0x43e34d});try{const _0x35c5b6=await axios_1[_0x1eca2a(0x217)][_0x1eca2a(0x20a)](_0x5f54e2,_0x503216,{'headers':_0x14d86d}),_0x3ad588=JSON[_0x1eca2a(0x1ef)](_0x35c5b6[_0x1eca2a(0x1d1)]);common_1['Logger']['debug'](_0x1eca2a(0x21e)+_0x3ad588);switch(_0x35c5b6[_0x1eca2a(0x1d1)]['result'][_0x1eca2a(0x212)]){case'1':return!![];case'2':common_1[_0x1eca2a(0x1d2)][_0x1eca2a(0x21a)](_0x1eca2a(0x1cc),_0x1eca2a(0x1fd));case'3':common_1[_0x1eca2a(0x1d2)][_0x1eca2a(0x21a)]('实名认证异常',_0x1eca2a(0x1fd));default:common_1[_0x1eca2a(0x1d2)][_0x1eca2a(0x21a)]('未知的认证结果',_0x1eca2a(0x1fd));}return![];}catch(_0x4f9568){return common_1['Logger'][_0x1eca2a(0x216)](_0x1eca2a(0x1d0)+_0x4f9568[_0x1eca2a(0x1f7)],_0x4f9568['stack'],_0x1eca2a(0x1d3)),![];}}};VerificationService=__decorate([(0x0,common_1[_0x5c962e(0x209)])(),__param(0x0,(0x0,typeorm_1[_0x5c962e(0x202)])(verifycation_entity_1[_0x5c962e(0x224)])),__metadata('design:paramtypes',[typeorm_2[_0x5c962e(0x225)],globalConfig_service_1['GlobalConfigService'],redisCache_service_1[_0x5c962e(0x1ed)]])],VerificationService),exports['VerificationService']=VerificationService;