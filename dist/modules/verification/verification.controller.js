'use strict';const _0x51c532=_0x3f82;function _0x55e9(){const _0x887620=['defineProperty','生成一个用于第三方应用认证的验证码，需要JWT认证。验证码默认1分钟后过期。','function','./dto/verifyCode.dto','../globalConfig/globalConfig.service','design:type','globalConfigService','用户ID','user','sendEmailCode','decorate','验证码生成成功','验证码','是否已使用，0未使用，1已使用','ApiTags','ApiResponse','发送失败，可能是因为发送太频繁或参数错误','./verification.service','@nestjs/swagger','jwt','验证码ID','boolean','__param','third-party/verify','../../common/constants/verification.constant','thirdPartyAuthExpir','发送邮箱验证码（换绑邮箱），验证码30分钟内有效。同一邮箱1分钟内只能发送一次。','email','string','code','714DVOAni','send-email','发送邮箱验证码','UserService','4637745MSAeoA','1540719oAsjbB','@nestjs/common','sendSmsCode','3726264bWNcbL','../user/user.service','number','ChangeEmail','date-time','错误信息','getConfigs','VerificationController','BAD_REQUEST','getOwnPropertyDescriptor','assign','createVerification','Req','AuthGuard','@nestjs/passport','length','177334mLsINO','验证码验证成功','验证码发送成功','ThirdPartyAuth','prototype','verification','不支持的验证码类型','HttpStatus','design:paramtypes','1HAlUeL','357305UMeiHI','Post','userService','12957wxfGvI','design:returntype','__metadata','2087668CMsJOY','ApiBearerAuth','UNAUTHORIZED','UseGuards','VerificationService','验证结果消息','HttpException','verificationService','VerificationEnum','验证码无效或已过期','Controller','third-party/generate','Body','generateThirdPartyCode','JWT认证失败','GlobalConfigService','验证第三方应用认证码','object','verifyThirdPartyCode','生成第三方应用认证验证码','verifyCode','ApiOperation'];_0x55e9=function(){return _0x887620;};return _0x55e9();}(function(_0x53182f,_0x1b4347){const _0x3bd828=_0x3f82,_0x3ebfac=_0x53182f();while(!![]){try{const _0x3b3b80=-parseInt(_0x3bd828(0x156))/0x1*(-parseInt(_0x3bd828(0x14d))/0x2)+-parseInt(_0x3bd828(0x196))/0x3+parseInt(_0x3bd828(0x15d))/0x4+-parseInt(_0x3bd828(0x157))/0x5+-parseInt(_0x3bd828(0x191))/0x6*(-parseInt(_0x3bd828(0x15a))/0x7)+-parseInt(_0x3bd828(0x199))/0x8+parseInt(_0x3bd828(0x195))/0x9;if(_0x3b3b80===_0x1b4347)break;else _0x3ebfac['push'](_0x3ebfac['shift']());}catch(_0x423e03){_0x3ebfac['push'](_0x3ebfac['shift']());}}}(_0x55e9,0x481ad));var __decorate=this&&this['__decorate']||function(_0x56e17f,_0x42f10e,_0xbe0e1b,_0x29ecdf){const _0x3e3fe5=_0x3f82;var _0x15071b=arguments[_0x3e3fe5(0x14c)],_0x50ef3d=_0x15071b<0x3?_0x42f10e:_0x29ecdf===null?_0x29ecdf=Object[_0x3e3fe5(0x146)](_0x42f10e,_0xbe0e1b):_0x29ecdf,_0x85c316;if(typeof Reflect==='object'&&typeof Reflect[_0x3e3fe5(0x17d)]===_0x3e3fe5(0x175))_0x50ef3d=Reflect[_0x3e3fe5(0x17d)](_0x56e17f,_0x42f10e,_0xbe0e1b,_0x29ecdf);else{for(var _0x178268=_0x56e17f[_0x3e3fe5(0x14c)]-0x1;_0x178268>=0x0;_0x178268--)if(_0x85c316=_0x56e17f[_0x178268])_0x50ef3d=(_0x15071b<0x3?_0x85c316(_0x50ef3d):_0x15071b>0x3?_0x85c316(_0x42f10e,_0xbe0e1b,_0x50ef3d):_0x85c316(_0x42f10e,_0xbe0e1b))||_0x50ef3d;}return _0x15071b>0x3&&_0x50ef3d&&Object[_0x3e3fe5(0x173)](_0x42f10e,_0xbe0e1b,_0x50ef3d),_0x50ef3d;},__metadata=this&&this[_0x51c532(0x15c)]||function(_0x1d7360,_0x1c8f63){const _0x489ecf=_0x51c532;if(typeof Reflect==='object'&&typeof Reflect['metadata']===_0x489ecf(0x175))return Reflect['metadata'](_0x1d7360,_0x1c8f63);},__param=this&&this[_0x51c532(0x189)]||function(_0x3d6e65,_0x3e43d3){return function(_0x7c19e7,_0x4fad2c){_0x3e43d3(_0x7c19e7,_0x4fad2c,_0x3d6e65);};};Object[_0x51c532(0x173)](exports,'__esModule',{'value':!![]}),exports['VerificationController']=void 0x0;function _0x3f82(_0x45233a,_0x1e2d0f){const _0x55e9c7=_0x55e9();return _0x3f82=function(_0x3f82eb,_0x96d110){_0x3f82eb=_0x3f82eb-0x143;let _0x53ee06=_0x55e9c7[_0x3f82eb];return _0x53ee06;},_0x3f82(_0x45233a,_0x1e2d0f);}const common_1=require(_0x51c532(0x197)),swagger_1=require(_0x51c532(0x185)),verification_service_1=require(_0x51c532(0x184)),verification_constant_1=require(_0x51c532(0x18b)),passport_1=require(_0x51c532(0x14b)),user_service_1=require(_0x51c532(0x19a)),verifyCode_dto_1=require(_0x51c532(0x176)),globalConfig_service_1=require(_0x51c532(0x177)),common_2=require(_0x51c532(0x197));let VerificationController=class VerificationController{constructor(_0x48583c,_0x169eda,_0x1a94f9){const _0x2065f7=_0x51c532;this[_0x2065f7(0x164)]=_0x48583c,this[_0x2065f7(0x159)]=_0x169eda,this[_0x2065f7(0x179)]=_0x1a94f9;}async[_0x51c532(0x16a)](_0x204c69){const _0xecd5e0=_0x51c532,_0x4ffefa=_0x204c69[_0xecd5e0(0x17b)]['id'],_0x53b647=await this[_0xecd5e0(0x159)]['getUserById'](_0x4ffefa),_0x4addf4=await this[_0xecd5e0(0x179)][_0xecd5e0(0x143)]([_0xecd5e0(0x18c)]),_0x508d46=_0x4addf4[_0xecd5e0(0x18c)]?Number(_0x4addf4[_0xecd5e0(0x18c)]):0x3c;return await this[_0xecd5e0(0x164)][_0xecd5e0(0x148)](_0x53b647,verification_constant_1[_0xecd5e0(0x165)]['ThirdPartyAuth'],_0x508d46);}async['verifyThirdPartyCode'](_0x10992e){const _0x104ebb=_0x51c532,_0x2a4ab7={'id':_0x10992e['id'],'code':Number(_0x10992e[_0x104ebb(0x190)])};return await this[_0x104ebb(0x164)][_0x104ebb(0x171)](_0x2a4ab7,verification_constant_1[_0x104ebb(0x165)][_0x104ebb(0x150)]);}async[_0x51c532(0x198)](_0x1309be){const _0x2e0782=_0x51c532,{phone:_0x4bcc17,type:_0x4329c8}=_0x1309be;if(_0x4329c8!==verification_constant_1[_0x2e0782(0x165)]['Registration']&&_0x4329c8!==verification_constant_1[_0x2e0782(0x165)]['PasswordReset'])throw new common_2[(_0x2e0782(0x163))](_0x2e0782(0x153),common_1['HttpStatus'][_0x2e0782(0x145)]);const _0x115a9d={'id':0x0,'email':'','phone':_0x4bcc17},_0x268344=await this[_0x2e0782(0x164)][_0x2e0782(0x148)](_0x115a9d,_0x4329c8);return await this[_0x2e0782(0x164)]['sendPhoneCode']({'phone':_0x4bcc17,'code':_0x268344[_0x2e0782(0x190)]});}async[_0x51c532(0x17c)](_0x39e30c,_0x42fe23){const _0x3bab7d=_0x51c532,_0x4c848c=_0x42fe23['user']['id'],_0x40e594=await this[_0x3bab7d(0x159)]['getUserById'](_0x4c848c),_0x16bfbc=await this[_0x3bab7d(0x164)][_0x3bab7d(0x148)](Object['assign'](Object[_0x3bab7d(0x147)]({},_0x40e594),{'email':_0x39e30c['email']}),verification_constant_1['VerificationEnum'][_0x3bab7d(0x19c)]);return await this[_0x3bab7d(0x164)][_0x3bab7d(0x17c)]({'email':_0x39e30c[_0x3bab7d(0x18e)],'code':_0x16bfbc[_0x3bab7d(0x190)]});}};__decorate([(0x0,common_1['Post'])(_0x51c532(0x168)),(0x0,common_1[_0x51c532(0x160)])((0x0,passport_1[_0x51c532(0x14a)])(_0x51c532(0x186))),(0x0,swagger_1[_0x51c532(0x15e)])(),(0x0,swagger_1['ApiOperation'])({'summary':_0x51c532(0x170),'description':_0x51c532(0x174)}),(0x0,swagger_1[_0x51c532(0x182)])({'status':common_1[_0x51c532(0x154)]['OK'],'description':_0x51c532(0x17e),'schema':{'type':_0x51c532(0x16e),'properties':{'id':{'type':_0x51c532(0x19b),'description':_0x51c532(0x187)},'code':{'type':_0x51c532(0x19b),'description':_0x51c532(0x17f)},'userId':{'type':'number','description':_0x51c532(0x17a)},'type':{'type':_0x51c532(0x19b),'description':'验证码类型'},'expiresAt':{'type':_0x51c532(0x18f),'format':_0x51c532(0x19d),'description':'过期时间'},'used':{'type':_0x51c532(0x19b),'description':_0x51c532(0x180)}}}}),(0x0,swagger_1[_0x51c532(0x182)])({'status':common_1[_0x51c532(0x154)][_0x51c532(0x15f)],'description':_0x51c532(0x16b)}),__param(0x0,(0x0,common_1[_0x51c532(0x149)])()),__metadata(_0x51c532(0x178),Function),__metadata(_0x51c532(0x155),[Object]),__metadata(_0x51c532(0x15b),Promise)],VerificationController[_0x51c532(0x151)],_0x51c532(0x16a),null),__decorate([(0x0,common_1[_0x51c532(0x158)])(_0x51c532(0x18a)),(0x0,swagger_1[_0x51c532(0x172)])({'summary':_0x51c532(0x16d),'description':'验证用户提供的第三方应用认证码是否有效'}),(0x0,swagger_1['ApiBody'])({'type':verifyCode_dto_1['VerifyCodeDto']}),(0x0,swagger_1[_0x51c532(0x182)])({'status':common_1['HttpStatus']['OK'],'description':_0x51c532(0x14e),'schema':{'type':_0x51c532(0x16e),'properties':{'success':{'type':_0x51c532(0x188),'description':'验证是否成功'},'message':{'type':_0x51c532(0x18f),'description':_0x51c532(0x162)}}}}),(0x0,swagger_1[_0x51c532(0x182)])({'status':common_1[_0x51c532(0x154)][_0x51c532(0x145)],'description':_0x51c532(0x166),'schema':{'type':_0x51c532(0x16e),'properties':{'message':{'type':_0x51c532(0x18f),'description':_0x51c532(0x19e)},'error':{'type':_0x51c532(0x18f),'description':'错误类型'},'statusCode':{'type':'number','description':'状态码'}}}}),__param(0x0,(0x0,common_1[_0x51c532(0x169)])()),__metadata(_0x51c532(0x178),Function),__metadata('design:paramtypes',[verifyCode_dto_1['VerifyCodeDto']]),__metadata(_0x51c532(0x15b),Promise)],VerificationController[_0x51c532(0x151)],_0x51c532(0x16f),null),__decorate([(0x0,common_1['Post'])('send-sms'),(0x0,swagger_1[_0x51c532(0x172)])({'summary':'发送短信验证码','description':'发送短信验证码（注册或重置密码），验证码5分钟内有效。同一手机号1分钟内只能发送一次。'}),(0x0,swagger_1['ApiResponse'])({'status':common_1[_0x51c532(0x154)]['OK'],'description':'验证码发送成功','type':Boolean}),(0x0,swagger_1[_0x51c532(0x182)])({'status':common_1[_0x51c532(0x154)][_0x51c532(0x145)],'description':_0x51c532(0x183)}),__param(0x0,(0x0,common_1[_0x51c532(0x169)])()),__metadata('design:type',Function),__metadata(_0x51c532(0x155),[Object]),__metadata(_0x51c532(0x15b),Promise)],VerificationController[_0x51c532(0x151)],_0x51c532(0x198),null),__decorate([(0x0,common_1[_0x51c532(0x158)])(_0x51c532(0x192)),(0x0,swagger_1[_0x51c532(0x172)])({'summary':_0x51c532(0x193),'description':_0x51c532(0x18d)}),(0x0,swagger_1['ApiResponse'])({'status':common_1[_0x51c532(0x154)]['OK'],'description':_0x51c532(0x14f),'type':Boolean}),(0x0,swagger_1[_0x51c532(0x182)])({'status':common_1[_0x51c532(0x154)][_0x51c532(0x145)],'description':'发送失败，可能是因为发送太频繁或参数错误'}),(0x0,common_1[_0x51c532(0x160)])((0x0,passport_1[_0x51c532(0x14a)])('jwt')),(0x0,swagger_1[_0x51c532(0x15e)])(),__param(0x0,(0x0,common_1[_0x51c532(0x169)])()),__param(0x1,(0x0,common_1[_0x51c532(0x149)])()),__metadata(_0x51c532(0x178),Function),__metadata(_0x51c532(0x155),[Object,Object]),__metadata(_0x51c532(0x15b),Promise)],VerificationController['prototype'],_0x51c532(0x17c),null),VerificationController=__decorate([(0x0,swagger_1[_0x51c532(0x181)])(_0x51c532(0x17f)),(0x0,common_1[_0x51c532(0x167)])(_0x51c532(0x152)),__metadata(_0x51c532(0x155),[verification_service_1[_0x51c532(0x161)],user_service_1[_0x51c532(0x194)],globalConfig_service_1[_0x51c532(0x16c)]])],VerificationController),exports[_0x51c532(0x144)]=VerificationController;