'use strict';const _0x237701=_0xd5a3;(function(_0x35f83e,_0x88528f){const _0xf8818=_0xd5a3,_0xa627c4=_0x35f83e();while(!![]){try{const _0x9803f2=parseInt(_0xf8818(0x131))/0x1*(parseInt(_0xf8818(0x15a))/0x2)+-parseInt(_0xf8818(0x138))/0x3+parseInt(_0xf8818(0x13e))/0x4+-parseInt(_0xf8818(0x16a))/0x5*(-parseInt(_0xf8818(0x15d))/0x6)+-parseInt(_0xf8818(0x162))/0x7+parseInt(_0xf8818(0x149))/0x8*(parseInt(_0xf8818(0x177))/0x9)+-parseInt(_0xf8818(0x135))/0xa*(parseInt(_0xf8818(0x158))/0xb);if(_0x9803f2===_0x88528f)break;else _0xa627c4['push'](_0xa627c4['shift']());}catch(_0xc35af6){_0xa627c4['push'](_0xa627c4['shift']());}}}(_0x2a86,0x43116));function _0xd5a3(_0x3e8e52,_0x323abe){const _0x2a86a9=_0x2a86();return _0xd5a3=function(_0xd5a3f1,_0x590e78){_0xd5a3f1=_0xd5a3f1-0x131;let _0x58ad7e=_0x2a86a9[_0xd5a3f1];return _0x58ad7e;},_0xd5a3(_0x3e8e52,_0x323abe);}var __decorate=this&&this[_0x237701(0x15b)]||function(_0x2fbc0d,_0x1d3d6e,_0x5bea6d,_0x1e985a){const _0x49e252=_0x237701;var _0x57e039=arguments[_0x49e252(0x167)],_0x54d99b=_0x57e039<0x3?_0x1d3d6e:_0x1e985a===null?_0x1e985a=Object[_0x49e252(0x148)](_0x1d3d6e,_0x5bea6d):_0x1e985a,_0x58666d;if(typeof Reflect===_0x49e252(0x134)&&typeof Reflect[_0x49e252(0x136)]===_0x49e252(0x163))_0x54d99b=Reflect[_0x49e252(0x136)](_0x2fbc0d,_0x1d3d6e,_0x5bea6d,_0x1e985a);else{for(var _0x23b1b0=_0x2fbc0d[_0x49e252(0x167)]-0x1;_0x23b1b0>=0x0;_0x23b1b0--)if(_0x58666d=_0x2fbc0d[_0x23b1b0])_0x54d99b=(_0x57e039<0x3?_0x58666d(_0x54d99b):_0x57e039>0x3?_0x58666d(_0x1d3d6e,_0x5bea6d,_0x54d99b):_0x58666d(_0x1d3d6e,_0x5bea6d))||_0x54d99b;}return _0x57e039>0x3&&_0x54d99b&&Object[_0x49e252(0x144)](_0x1d3d6e,_0x5bea6d,_0x54d99b),_0x54d99b;},__metadata=this&&this[_0x237701(0x16d)]||function(_0x44d1f0,_0x213674){const _0x19835b=_0x237701;if(typeof Reflect===_0x19835b(0x134)&&typeof Reflect[_0x19835b(0x152)]===_0x19835b(0x163))return Reflect[_0x19835b(0x152)](_0x44d1f0,_0x213674);},__param=this&&this[_0x237701(0x13b)]||function(_0x1a5c1d,_0x38712e){return function(_0x14bae8,_0x2533ae){_0x38712e(_0x14bae8,_0x2533ae,_0x1a5c1d);};};function _0x2a86(){const _0x4de7da=['HttpException','3487vSMNsP','debug','8RXtXYz','__decorate','getRawMany','6RAmaff','getSignatureGiftConfig','BAD_REQUEST','Sign\x20in\x20successful.','今日已签到、改天再来吧!.','2161705toRbBG','function','./../globalConfig/globalConfig.service','RechargeType','getDate','length','signin','YYYY-MM-DD','1434905lIULYH','saveRecordRechargeLog','SIGN_IN','__metadata','SigninService','addBalanceToUser','sign','signinEntity','day','typeorm','setDate','startOf','signInDate','396wEBpUW','design:paramtypes','InjectRepository','HttpStatus','log','update','95698GTHUGc','SigninEntity','format','object','10670wszuSc','decorate','@nestjs/typeorm','197316pBHsmQ','signin.signInTime\x20<=\x20:lastDay','昨天没签到、今天重置天数！','__param','getSigninLog','signin.signInDate\x20as\x20signInDate,\x20signin.isSigned\x20as\x20isSigned','1086780NtvELj','globalConfigService','save','push','endOf','andWhere','defineProperty','./../userBalance/userBalance.service','userBalanceService','昨天签到了、今天是连续签到！','getOwnPropertyDescriptor','8376BNeWie','error:\x20','select','default','userEntity','Repository','./signIn.entity','find','findOne','metadata','YYYY-MM-DD\x20HH:mm:ss','Logger','month','signin.signInTime\x20>=\x20:firstDay'];_0x2a86=function(){return _0x4de7da;};return _0x2a86();}Object[_0x237701(0x144)](exports,'__esModule',{'value':!![]}),exports['SigninService']=void 0x0;const globalConfig_service_1=require(_0x237701(0x164)),userBalance_service_1=require(_0x237701(0x145)),common_1=require('@nestjs/common'),signIn_entity_1=require(_0x237701(0x14f)),typeorm_1=require(_0x237701(0x137)),typeorm_2=require(_0x237701(0x173)),date_1=require('../../common/utils/date'),user_entity_1=require('../user/user.entity'),balance_constant_1=require('../../common/constants/balance.constant');let SigninService=class SigninService{constructor(_0xa2a79,_0x1bf024,_0x175acb,_0x4267c4){const _0x4c39a5=_0x237701;this['signinEntity']=_0xa2a79,this[_0x4c39a5(0x14d)]=_0x1bf024,this[_0x4c39a5(0x146)]=_0x175acb,this[_0x4c39a5(0x13f)]=_0x4267c4;}async[_0x237701(0x170)](_0x371c58){const _0x23529e=_0x237701,{id:_0x4629f2}=_0x371c58['user'],_0xac8b5d=(0x0,date_1[_0x23529e(0x14c)])(new Date())[_0x23529e(0x133)](_0x23529e(0x169)),_0x49fd16=await this['signinEntity'][_0x23529e(0x151)]({'where':{'userId':_0x4629f2,'signInDate':_0xac8b5d}});if(_0x49fd16)throw new common_1['HttpException'](_0x23529e(0x161),common_1[_0x23529e(0x17a)][_0x23529e(0x15f)]);const {model3Count:_0x12f815,model4Count:_0x2ece84,drawMjCount:_0x3975f8}=await this[_0x23529e(0x13f)][_0x23529e(0x15e)]();await this[_0x23529e(0x171)][_0x23529e(0x140)]({'userId':_0x4629f2,'signInTime':new Date(),'signInDate':_0xac8b5d,'isSigned':!![]}),await this[_0x23529e(0x146)][_0x23529e(0x16f)](_0x4629f2,{'model3Count':_0x12f815,'model4Count':_0x2ece84,'drawMjCount':_0x3975f8}),await this[_0x23529e(0x146)][_0x23529e(0x16b)]({'userId':_0x4629f2,'rechargeType':balance_constant_1[_0x23529e(0x165)][_0x23529e(0x16c)],'model3Count':_0x12f815,'model4Count':_0x2ece84,'drawMjCount':_0x3975f8});const _0x5710c5=(0x0,date_1[_0x23529e(0x14c)])(new Date())['subtract'](0x1,_0x23529e(0x172))[_0x23529e(0x133)](_0x23529e(0x169)),_0x3a870d=await this[_0x23529e(0x171)][_0x23529e(0x151)]({'where':{'userId':_0x4629f2,'signInDate':_0x5710c5}});if(_0x3a870d){common_1[_0x23529e(0x154)][_0x23529e(0x159)]('用户'+_0x4629f2+_0x23529e(0x147),'SigninService');const _0x36395f=await this[_0x23529e(0x14d)][_0x23529e(0x151)]({'where':{'id':_0x4629f2}});if(!_0x36395f)throw new common_1[(_0x23529e(0x157))]('用户不存在',common_1[_0x23529e(0x17a)][_0x23529e(0x15f)]);const {consecutiveDays:consecutiveDays=0x0}=_0x36395f;await this['userEntity']['update']({'id':_0x4629f2},{'consecutiveDays':consecutiveDays+0x1});}else common_1[_0x23529e(0x154)][_0x23529e(0x159)]('用户'+_0x4629f2+_0x23529e(0x13a),_0x23529e(0x16e)),await this[_0x23529e(0x14d)][_0x23529e(0x17c)]({'id':_0x4629f2},{'consecutiveDays':0x1});return _0x23529e(0x160);}async[_0x237701(0x13c)](_0x2d1ec3){const _0x53ac98=_0x237701;try{const {id:_0x678a99}=_0x2d1ec3['user'],_0x18764a=(0x0,date_1[_0x53ac98(0x14c)])()[_0x53ac98(0x175)](_0x53ac98(0x155))[_0x53ac98(0x133)](_0x53ac98(0x153)),_0x3ded26=(0x0,date_1[_0x53ac98(0x14c)])()[_0x53ac98(0x142)](_0x53ac98(0x155))[_0x53ac98(0x133)](_0x53ac98(0x153)),_0x4e3caa=this['signinEntity']['createQueryBuilder'](_0x53ac98(0x168)),_0x3c897c=await _0x4e3caa[_0x53ac98(0x14b)](_0x53ac98(0x13d))[_0x53ac98(0x143)]('signin.userId\x20=\x20:userId',{'userId':_0x2d1ec3['user']['id']})[_0x53ac98(0x143)](_0x53ac98(0x156),{'firstDay':_0x18764a})[_0x53ac98(0x143)](_0x53ac98(0x139),{'lastDay':_0x3ded26})[_0x53ac98(0x15c)](),_0x42b248=new Date(_0x18764a),_0x19e449=new Date(_0x3ded26),_0x36ff23=[],_0x35ea26=new Date(_0x42b248);while(_0x35ea26<=_0x19e449){_0x36ff23['push']((0x0,date_1['default'])(new Date(_0x35ea26))[_0x53ac98(0x133)]('YYYY-MM-DD')),_0x35ea26[_0x53ac98(0x174)](_0x35ea26[_0x53ac98(0x166)]()+0x1);}const _0x36e809=[];for(const _0x196a9d of _0x36ff23){const _0x302bb0=_0x3c897c[_0x53ac98(0x150)](_0x53fc10=>_0x53fc10[_0x53ac98(0x176)]===_0x196a9d);!_0x302bb0?_0x36e809[_0x53ac98(0x141)]({'signInDate':_0x196a9d,'isSigned':![]}):(_0x302bb0['isSigned']=!![],_0x36e809[_0x53ac98(0x141)](_0x302bb0));}return _0x36e809;}catch(_0x5aca05){console[_0x53ac98(0x17b)](_0x53ac98(0x14a),_0x5aca05);throw new common_1['HttpException']('获取签到数据失败！',common_1[_0x53ac98(0x17a)][_0x53ac98(0x15f)]);}}};SigninService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(signIn_entity_1[_0x237701(0x132)])),__param(0x1,(0x0,typeorm_1[_0x237701(0x179)])(user_entity_1['UserEntity'])),__metadata(_0x237701(0x178),[typeorm_2['Repository'],typeorm_2[_0x237701(0x14e)],userBalance_service_1['UserBalanceService'],globalConfig_service_1['GlobalConfigService']])],SigninService),exports[_0x237701(0x16e)]=SigninService;