'use strict';const _0x38b17c=_0x4784;function _0x1f16(){const _0x3fc3b6=['获取签到数据失败！','setDate','771849KGmzHp','select','findOne','@nestjs/common','SigninService','YYYY-MM-DD\x20HH:mm:ss','3045308WTlFzc','234842njNmBl','sign','typeorm','debug','signin.signInTime\x20<=\x20:lastDay','Repository','getRawMany','32nvOSTM','HttpException','userBalanceService','16126150jYBWzH','Injectable','push','update','./../userBalance/userBalance.service','../../common/utils/date','getSigninLog','14YMogRp','Sign\x20in\x20successful.','BAD_REQUEST','format','isSigned','signin','30405024eZNzxq','UserEntity','11dxYhos','signinEntity','find','getSignatureGiftConfig','YYYY-MM-DD','UserBalanceService','__param','globalConfigService','../../common/constants/balance.constant','SIGN_IN','metadata','昨天签到了、今天是连续签到！','log','53045NfkGnt','getOwnPropertyDescriptor','user','endOf','default','object','今日已签到、改天再来吧!.','length','HttpStatus','./../globalConfig/globalConfig.service','userEntity','昨天没签到、今天重置天数！','month','2373102pegKkJ','function','284OXTMmU','InjectRepository','addBalanceToUser','6bkqvYm','@nestjs/typeorm','save','signInDate','saveRecordRechargeLog','__esModule','defineProperty','signin.signInTime\x20>=\x20:firstDay','signin.signInDate\x20as\x20signInDate,\x20signin.isSigned\x20as\x20isSigned','Logger','SigninEntity'];_0x1f16=function(){return _0x3fc3b6;};return _0x1f16();}(function(_0x4403be,_0x56a1c7){const _0x442681=_0x4784,_0x55f0d5=_0x4403be();while(!![]){try{const _0x32d9a5=parseInt(_0x442681(0x1dd))/0x1*(parseInt(_0x442681(0x1ee))/0x2)+-parseInt(_0x442681(0x222))/0x3+parseInt(_0x442681(0x212))/0x4*(-parseInt(_0x442681(0x203))/0x5)+-parseInt(_0x442681(0x215))/0x6*(-parseInt(_0x442681(0x1dc))/0x7)+parseInt(_0x442681(0x1e4))/0x8*(-parseInt(_0x442681(0x210))/0x9)+-parseInt(_0x442681(0x1e7))/0xa+-parseInt(_0x442681(0x1f6))/0xb*(-parseInt(_0x442681(0x1f4))/0xc);if(_0x32d9a5===_0x56a1c7)break;else _0x55f0d5['push'](_0x55f0d5['shift']());}catch(_0x4440e7){_0x55f0d5['push'](_0x55f0d5['shift']());}}}(_0x1f16,0xe43b9));var __decorate=this&&this['__decorate']||function(_0x489484,_0x44eca2,_0x1fd624,_0x12c9b8){const _0x3510e7=_0x4784;var _0x1057ea=arguments[_0x3510e7(0x20a)],_0x407073=_0x1057ea<0x3?_0x44eca2:_0x12c9b8===null?_0x12c9b8=Object[_0x3510e7(0x204)](_0x44eca2,_0x1fd624):_0x12c9b8,_0x1563b3;if(typeof Reflect===_0x3510e7(0x208)&&typeof Reflect['decorate']===_0x3510e7(0x211))_0x407073=Reflect['decorate'](_0x489484,_0x44eca2,_0x1fd624,_0x12c9b8);else{for(var _0x2a3153=_0x489484[_0x3510e7(0x20a)]-0x1;_0x2a3153>=0x0;_0x2a3153--)if(_0x1563b3=_0x489484[_0x2a3153])_0x407073=(_0x1057ea<0x3?_0x1563b3(_0x407073):_0x1057ea>0x3?_0x1563b3(_0x44eca2,_0x1fd624,_0x407073):_0x1563b3(_0x44eca2,_0x1fd624))||_0x407073;}return _0x1057ea>0x3&&_0x407073&&Object[_0x3510e7(0x21b)](_0x44eca2,_0x1fd624,_0x407073),_0x407073;},__metadata=this&&this['__metadata']||function(_0x4b725b,_0xf520da){const _0x58d78b=_0x4784;if(typeof Reflect===_0x58d78b(0x208)&&typeof Reflect[_0x58d78b(0x200)]===_0x58d78b(0x211))return Reflect[_0x58d78b(0x200)](_0x4b725b,_0xf520da);},__param=this&&this[_0x38b17c(0x1fc)]||function(_0x3315d8,_0x41b240){return function(_0x33f898,_0x5b87df){_0x41b240(_0x33f898,_0x5b87df,_0x3315d8);};};Object[_0x38b17c(0x21b)](exports,_0x38b17c(0x21a),{'value':!![]}),exports['SigninService']=void 0x0;const globalConfig_service_1=require(_0x38b17c(0x20c)),userBalance_service_1=require(_0x38b17c(0x1eb)),common_1=require(_0x38b17c(0x225)),signIn_entity_1=require('./signIn.entity'),typeorm_1=require(_0x38b17c(0x216)),typeorm_2=require(_0x38b17c(0x1df)),date_1=require(_0x38b17c(0x1ec)),user_entity_1=require('../user/user.entity'),balance_constant_1=require(_0x38b17c(0x1fe));function _0x4784(_0x6dd514,_0x1336fd){const _0x1f1641=_0x1f16();return _0x4784=function(_0x4784b9,_0x41b154){_0x4784b9=_0x4784b9-0x1db;let _0x2e8384=_0x1f1641[_0x4784b9];return _0x2e8384;},_0x4784(_0x6dd514,_0x1336fd);}let SigninService=class SigninService{constructor(_0x213b31,_0x68f208,_0x8c8c78,_0x22f8b7){const _0x1d7e70=_0x38b17c;this[_0x1d7e70(0x1f7)]=_0x213b31,this[_0x1d7e70(0x20d)]=_0x68f208,this[_0x1d7e70(0x1e6)]=_0x8c8c78,this[_0x1d7e70(0x1fd)]=_0x22f8b7;}async[_0x38b17c(0x1de)](_0x94fe1a){const _0x32155f=_0x38b17c,{id:_0x364630}=_0x94fe1a[_0x32155f(0x205)],_0x201488=(0x0,date_1[_0x32155f(0x207)])(new Date())['format'](_0x32155f(0x1fa)),_0x30a49d=await this[_0x32155f(0x1f7)]['findOne']({'where':{'userId':_0x364630,'signInDate':_0x201488}});if(_0x30a49d)throw new common_1[(_0x32155f(0x1e5))](_0x32155f(0x209),common_1[_0x32155f(0x20b)][_0x32155f(0x1f0)]);const {model3Count:_0x41804f,model4Count:_0x2d7ca2,drawMjCount:_0x2b775b}=await this[_0x32155f(0x1fd)][_0x32155f(0x1f9)]();await this[_0x32155f(0x1f7)][_0x32155f(0x217)]({'userId':_0x364630,'signInTime':new Date(),'signInDate':_0x201488,'isSigned':!![]}),await this[_0x32155f(0x1e6)][_0x32155f(0x214)](_0x364630,{'model3Count':_0x41804f,'model4Count':_0x2d7ca2,'drawMjCount':_0x2b775b}),await this[_0x32155f(0x1e6)][_0x32155f(0x219)]({'userId':_0x364630,'rechargeType':balance_constant_1['RechargeType'][_0x32155f(0x1ff)],'model3Count':_0x41804f,'model4Count':_0x2d7ca2,'drawMjCount':_0x2b775b});const _0x4af65d=(0x0,date_1[_0x32155f(0x207)])(new Date())['subtract'](0x1,'day')[_0x32155f(0x1f1)](_0x32155f(0x1fa)),_0x3eca77=await this[_0x32155f(0x1f7)][_0x32155f(0x224)]({'where':{'userId':_0x364630,'signInDate':_0x4af65d}});if(_0x3eca77){common_1[_0x32155f(0x21e)][_0x32155f(0x1e0)]('用户'+_0x364630+_0x32155f(0x201),_0x32155f(0x226));const _0x46d539=await this[_0x32155f(0x20d)][_0x32155f(0x224)]({'where':{'id':_0x364630}});if(!_0x46d539)throw new common_1['HttpException']('用户不存在',common_1[_0x32155f(0x20b)][_0x32155f(0x1f0)]);const {consecutiveDays:consecutiveDays=0x0}=_0x46d539;await this[_0x32155f(0x20d)][_0x32155f(0x1ea)]({'id':_0x364630},{'consecutiveDays':consecutiveDays+0x1});}else common_1[_0x32155f(0x21e)][_0x32155f(0x1e0)]('用户'+_0x364630+_0x32155f(0x20e),'SigninService'),await this[_0x32155f(0x20d)][_0x32155f(0x1ea)]({'id':_0x364630},{'consecutiveDays':0x1});return _0x32155f(0x1ef);}async[_0x38b17c(0x1ed)](_0x29d474){const _0x1da373=_0x38b17c;try{const {id:_0x14f6f8}=_0x29d474[_0x1da373(0x205)],_0xaf45a1=(0x0,date_1[_0x1da373(0x207)])()['startOf']('month')['format'](_0x1da373(0x1db)),_0x4182fd=(0x0,date_1['default'])()[_0x1da373(0x206)](_0x1da373(0x20f))[_0x1da373(0x1f1)](_0x1da373(0x1db)),_0x499056=this[_0x1da373(0x1f7)]['createQueryBuilder'](_0x1da373(0x1f3)),_0x27386b=await _0x499056[_0x1da373(0x223)](_0x1da373(0x21d))['andWhere']('signin.userId\x20=\x20:userId',{'userId':_0x29d474[_0x1da373(0x205)]['id']})['andWhere'](_0x1da373(0x21c),{'firstDay':_0xaf45a1})['andWhere'](_0x1da373(0x1e1),{'lastDay':_0x4182fd})[_0x1da373(0x1e3)](),_0x1a65bc=new Date(_0xaf45a1),_0x97fb26=new Date(_0x4182fd),_0x1f429d=[],_0x1bd140=new Date(_0x1a65bc);while(_0x1bd140<=_0x97fb26){_0x1f429d[_0x1da373(0x1e9)]((0x0,date_1[_0x1da373(0x207)])(new Date(_0x1bd140))['format'](_0x1da373(0x1fa))),_0x1bd140[_0x1da373(0x221)](_0x1bd140['getDate']()+0x1);}const _0xa9b3fe=[];for(const _0x317384 of _0x1f429d){const _0x39fa1f=_0x27386b[_0x1da373(0x1f8)](_0xb5ff7b=>_0xb5ff7b[_0x1da373(0x218)]===_0x317384);!_0x39fa1f?_0xa9b3fe[_0x1da373(0x1e9)]({'signInDate':_0x317384,'isSigned':![]}):(_0x39fa1f[_0x1da373(0x1f2)]=!![],_0xa9b3fe[_0x1da373(0x1e9)](_0x39fa1f));}return _0xa9b3fe;}catch(_0x3ab313){console[_0x1da373(0x202)]('error:\x20',_0x3ab313);throw new common_1['HttpException'](_0x1da373(0x220),common_1[_0x1da373(0x20b)]['BAD_REQUEST']);}}};SigninService=__decorate([(0x0,common_1[_0x38b17c(0x1e8)])(),__param(0x0,(0x0,typeorm_1[_0x38b17c(0x213)])(signIn_entity_1[_0x38b17c(0x21f)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x38b17c(0x1f5)])),__metadata('design:paramtypes',[typeorm_2[_0x38b17c(0x1e2)],typeorm_2[_0x38b17c(0x1e2)],userBalance_service_1[_0x38b17c(0x1fb)],globalConfig_service_1['GlobalConfigService']])],SigninService),exports['SigninService']=SigninService;