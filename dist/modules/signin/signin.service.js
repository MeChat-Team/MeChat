'use strict';const _0x1418e5=_0x16cd;(function(_0x3f6385,_0x3add0a){const _0x21648d=_0x16cd,_0x2933cd=_0x3f6385();while(!![]){try{const _0x1d82ee=-parseInt(_0x21648d(0x162))/0x1+-parseInt(_0x21648d(0x16a))/0x2+parseInt(_0x21648d(0x151))/0x3*(parseInt(_0x21648d(0x156))/0x4)+parseInt(_0x21648d(0x14c))/0x5*(-parseInt(_0x21648d(0x183))/0x6)+-parseInt(_0x21648d(0x180))/0x7+parseInt(_0x21648d(0x179))/0x8+parseInt(_0x21648d(0x17e))/0x9;if(_0x1d82ee===_0x3add0a)break;else _0x2933cd['push'](_0x2933cd['shift']());}catch(_0x4d00a9){_0x2933cd['push'](_0x2933cd['shift']());}}}(_0x12ec,0xc701e));var __decorate=this&&this[_0x1418e5(0x16d)]||function(_0xba728d,_0x21f8f9,_0x2e3b4a,_0x4fdc09){const _0x40b7cb=_0x1418e5;var _0x26bb9a=arguments['length'],_0x50d19d=_0x26bb9a<0x3?_0x21f8f9:_0x4fdc09===null?_0x4fdc09=Object[_0x40b7cb(0x172)](_0x21f8f9,_0x2e3b4a):_0x4fdc09,_0x2ba82f;if(typeof Reflect===_0x40b7cb(0x170)&&typeof Reflect['decorate']==='function')_0x50d19d=Reflect[_0x40b7cb(0x158)](_0xba728d,_0x21f8f9,_0x2e3b4a,_0x4fdc09);else{for(var _0x119017=_0xba728d[_0x40b7cb(0x166)]-0x1;_0x119017>=0x0;_0x119017--)if(_0x2ba82f=_0xba728d[_0x119017])_0x50d19d=(_0x26bb9a<0x3?_0x2ba82f(_0x50d19d):_0x26bb9a>0x3?_0x2ba82f(_0x21f8f9,_0x2e3b4a,_0x50d19d):_0x2ba82f(_0x21f8f9,_0x2e3b4a))||_0x50d19d;}return _0x26bb9a>0x3&&_0x50d19d&&Object[_0x40b7cb(0x169)](_0x21f8f9,_0x2e3b4a,_0x50d19d),_0x50d19d;},__metadata=this&&this[_0x1418e5(0x15b)]||function(_0x103c48,_0x5d87e4){const _0x12e021=_0x1418e5;if(typeof Reflect===_0x12e021(0x170)&&typeof Reflect[_0x12e021(0x16e)]===_0x12e021(0x143))return Reflect[_0x12e021(0x16e)](_0x103c48,_0x5d87e4);},__param=this&&this[_0x1418e5(0x146)]||function(_0x24b067,_0x22631d){return function(_0x342727,_0x473d60){_0x22631d(_0x342727,_0x473d60,_0x24b067);};};Object[_0x1418e5(0x169)](exports,_0x1418e5(0x173),{'value':!![]}),exports[_0x1418e5(0x14e)]=void 0x0;const globalConfig_service_1=require('./../globalConfig/globalConfig.service'),userBalance_service_1=require(_0x1418e5(0x171)),common_1=require(_0x1418e5(0x176)),signIn_entity_1=require(_0x1418e5(0x17c)),typeorm_1=require(_0x1418e5(0x154)),typeorm_2=require('typeorm'),date_1=require(_0x1418e5(0x161)),user_entity_1=require(_0x1418e5(0x167)),balance_constant_1=require('../../common/constants/balance.constant');function _0x16cd(_0x2a3336,_0x584d96){const _0x12ec50=_0x12ec();return _0x16cd=function(_0x16cdd3,_0x28f2be){_0x16cdd3=_0x16cdd3-0x142;let _0x251ff9=_0x12ec50[_0x16cdd3];return _0x251ff9;},_0x16cd(_0x2a3336,_0x584d96);}let SigninService=class SigninService{constructor(_0x26fe49,_0x473dd5,_0x368084,_0x5aca47){const _0x579432=_0x1418e5;this['signinEntity']=_0x26fe49,this['userEntity']=_0x473dd5,this['userBalanceService']=_0x368084,this[_0x579432(0x15f)]=_0x5aca47;}async[_0x1418e5(0x16c)](_0x131789){const _0x1e582c=_0x1418e5,{id:_0x223c31}=_0x131789['user'],_0x3d32c3=(0x0,date_1[_0x1e582c(0x163)])(new Date())[_0x1e582c(0x17d)]('YYYY-MM-DD'),_0x52602b=await this[_0x1e582c(0x155)][_0x1e582c(0x186)]({'where':{'userId':_0x223c31,'signInDate':_0x3d32c3}});if(_0x52602b)throw new common_1[(_0x1e582c(0x144))](_0x1e582c(0x184),common_1[_0x1e582c(0x17f)][_0x1e582c(0x153)]);const {model3Count:_0x84951a,model4Count:_0x3f53e4,drawMjCount:_0x12baab}=await this[_0x1e582c(0x15f)][_0x1e582c(0x159)]();await this['signinEntity'][_0x1e582c(0x178)]({'userId':_0x223c31,'signInTime':new Date(),'signInDate':_0x3d32c3,'isSigned':!![]}),await this['userBalanceService']['addBalanceToUser'](_0x223c31,{'model3Count':_0x84951a,'model4Count':_0x3f53e4,'drawMjCount':_0x12baab}),await this[_0x1e582c(0x16f)]['saveRecordRechargeLog']({'userId':_0x223c31,'rechargeType':balance_constant_1[_0x1e582c(0x15d)][_0x1e582c(0x145)],'model3Count':_0x84951a,'model4Count':_0x3f53e4,'drawMjCount':_0x12baab});const _0x16a734=(0x0,date_1[_0x1e582c(0x163)])(new Date())[_0x1e582c(0x148)](0x1,_0x1e582c(0x14a))[_0x1e582c(0x17d)](_0x1e582c(0x15c)),_0x1cd2e9=await this['signinEntity'][_0x1e582c(0x186)]({'where':{'userId':_0x223c31,'signInDate':_0x16a734}});if(_0x1cd2e9){common_1[_0x1e582c(0x152)][_0x1e582c(0x15a)]('用户'+_0x223c31+_0x1e582c(0x168),_0x1e582c(0x14e));const _0xa1c2b1=await this[_0x1e582c(0x182)][_0x1e582c(0x186)]({'where':{'id':_0x223c31}});if(!_0xa1c2b1)throw new common_1[(_0x1e582c(0x144))](_0x1e582c(0x14f),common_1[_0x1e582c(0x17f)][_0x1e582c(0x153)]);const {consecutiveDays:consecutiveDays=0x0}=_0xa1c2b1;await this[_0x1e582c(0x182)][_0x1e582c(0x15e)]({'id':_0x223c31},{'consecutiveDays':consecutiveDays+0x1});}else common_1[_0x1e582c(0x152)][_0x1e582c(0x15a)]('用户'+_0x223c31+_0x1e582c(0x175),_0x1e582c(0x14e)),await this['userEntity'][_0x1e582c(0x15e)]({'id':_0x223c31},{'consecutiveDays':0x1});return'Sign\x20in\x20successful.';}async[_0x1418e5(0x16b)](_0x4fd361){const _0x48bde1=_0x1418e5;try{const {id:_0x3e226d}=_0x4fd361[_0x48bde1(0x165)],_0x373d0f=(0x0,date_1[_0x48bde1(0x163)])()[_0x48bde1(0x157)](_0x48bde1(0x14b))[_0x48bde1(0x17d)](_0x48bde1(0x17a)),_0x4bcc6c=(0x0,date_1[_0x48bde1(0x163)])()[_0x48bde1(0x189)](_0x48bde1(0x14b))['format'](_0x48bde1(0x17a)),_0x4b1110=this[_0x48bde1(0x155)][_0x48bde1(0x160)](_0x48bde1(0x181)),_0x9e2b55=await _0x4b1110['select'](_0x48bde1(0x150))[_0x48bde1(0x188)]('signin.userId\x20=\x20:userId',{'userId':_0x4fd361[_0x48bde1(0x165)]['id']})[_0x48bde1(0x188)]('signin.signInTime\x20>=\x20:firstDay',{'firstDay':_0x373d0f})['andWhere']('signin.signInTime\x20<=\x20:lastDay',{'lastDay':_0x4bcc6c})[_0x48bde1(0x177)](),_0x14beff=new Date(_0x373d0f),_0x4cc70f=new Date(_0x4bcc6c),_0x7ad1c6=[],_0x270f63=new Date(_0x14beff);while(_0x270f63<=_0x4cc70f){_0x7ad1c6['push']((0x0,date_1['default'])(new Date(_0x270f63))[_0x48bde1(0x17d)](_0x48bde1(0x15c))),_0x270f63['setDate'](_0x270f63['getDate']()+0x1);}const _0x4193e4=[];for(const _0xddebe8 of _0x7ad1c6){const _0xeb1fa9=_0x9e2b55['find'](_0x3da306=>_0x3da306[_0x48bde1(0x187)]===_0xddebe8);!_0xeb1fa9?_0x4193e4['push']({'signInDate':_0xddebe8,'isSigned':![]}):(_0xeb1fa9[_0x48bde1(0x185)]=!![],_0x4193e4[_0x48bde1(0x17b)](_0xeb1fa9));}return _0x4193e4;}catch(_0x296f8e){console[_0x48bde1(0x149)]('error:\x20',_0x296f8e);throw new common_1['HttpException']('获取签到数据失败！',common_1['HttpStatus'][_0x48bde1(0x153)]);}}};SigninService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(signIn_entity_1[_0x1418e5(0x147)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x1418e5(0x174)])),__metadata(_0x1418e5(0x142),[typeorm_2[_0x1418e5(0x14d)],typeorm_2[_0x1418e5(0x14d)],userBalance_service_1['UserBalanceService'],globalConfig_service_1[_0x1418e5(0x164)]])],SigninService),exports['SigninService']=SigninService;function _0x12ec(){const _0x32dce1=['save','1160624HNWHFI','YYYY-MM-DD\x20HH:mm:ss','push','./signIn.entity','format','28066437zLQRLW','HttpStatus','9008524pChPhb','signin','userEntity','42mzlWTR','今日已签到、改天再来吧!.','isSigned','findOne','signInDate','andWhere','endOf','design:paramtypes','function','HttpException','SIGN_IN','__param','SigninEntity','subtract','log','day','month','994095MoLHos','Repository','SigninService','用户不存在','signin.signInDate\x20as\x20signInDate,\x20signin.isSigned\x20as\x20isSigned','573hpzaPP','Logger','BAD_REQUEST','@nestjs/typeorm','signinEntity','26408hEVgpT','startOf','decorate','getSignatureGiftConfig','debug','__metadata','YYYY-MM-DD','RechargeType','update','globalConfigService','createQueryBuilder','../../common/utils/date','482062lsQDfE','default','GlobalConfigService','user','length','../user/user.entity','昨天签到了、今天是连续签到！','defineProperty','1097384kqstHu','getSigninLog','sign','__decorate','metadata','userBalanceService','object','./../userBalance/userBalance.service','getOwnPropertyDescriptor','__esModule','UserEntity','昨天没签到、今天重置天数！','@nestjs/common','getRawMany'];_0x12ec=function(){return _0x32dce1;};return _0x12ec();}