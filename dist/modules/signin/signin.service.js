'use strict';const _0x243a01=_0x1ebd;(function(_0x1a3c81,_0x2d6821){const _0x434558=_0x1ebd,_0x9adf9d=_0x1a3c81();while(!![]){try{const _0x31c19d=parseInt(_0x434558(0xac))/0x1+parseInt(_0x434558(0x99))/0x2+-parseInt(_0x434558(0xc2))/0x3*(parseInt(_0x434558(0xab))/0x4)+-parseInt(_0x434558(0xb7))/0x5*(parseInt(_0x434558(0xd3))/0x6)+-parseInt(_0x434558(0xc1))/0x7+-parseInt(_0x434558(0xb4))/0x8+parseInt(_0x434558(0x90))/0x9*(parseInt(_0x434558(0x96))/0xa);if(_0x31c19d===_0x2d6821)break;else _0x9adf9d['push'](_0x9adf9d['shift']());}catch(_0x4b5a42){_0x9adf9d['push'](_0x9adf9d['shift']());}}}(_0x5191,0x74b6c));var __decorate=this&&this[_0x243a01(0x9f)]||function(_0xec50ff,_0x9217a8,_0x3a20e2,_0x202e17){const _0x1d28f4=_0x243a01;var _0x43325f=arguments[_0x1d28f4(0xc3)],_0xdf51e8=_0x43325f<0x3?_0x9217a8:_0x202e17===null?_0x202e17=Object['getOwnPropertyDescriptor'](_0x9217a8,_0x3a20e2):_0x202e17,_0x45ed32;if(typeof Reflect===_0x1d28f4(0xc0)&&typeof Reflect[_0x1d28f4(0xaf)]===_0x1d28f4(0xa3))_0xdf51e8=Reflect[_0x1d28f4(0xaf)](_0xec50ff,_0x9217a8,_0x3a20e2,_0x202e17);else{for(var _0x3e71a5=_0xec50ff['length']-0x1;_0x3e71a5>=0x0;_0x3e71a5--)if(_0x45ed32=_0xec50ff[_0x3e71a5])_0xdf51e8=(_0x43325f<0x3?_0x45ed32(_0xdf51e8):_0x43325f>0x3?_0x45ed32(_0x9217a8,_0x3a20e2,_0xdf51e8):_0x45ed32(_0x9217a8,_0x3a20e2))||_0xdf51e8;}return _0x43325f>0x3&&_0xdf51e8&&Object[_0x1d28f4(0x93)](_0x9217a8,_0x3a20e2,_0xdf51e8),_0xdf51e8;},__metadata=this&&this[_0x243a01(0xc4)]||function(_0x46bd64,_0x129d54){const _0x5b37aa=_0x243a01;if(typeof Reflect===_0x5b37aa(0xc0)&&typeof Reflect[_0x5b37aa(0xae)]===_0x5b37aa(0xa3))return Reflect[_0x5b37aa(0xae)](_0x46bd64,_0x129d54);},__param=this&&this[_0x243a01(0x95)]||function(_0x337341,_0x26fac8){return function(_0x1b9c37,_0x41f7c8){_0x26fac8(_0x1b9c37,_0x41f7c8,_0x337341);};};function _0x5191(){const _0x5106a8=['../../common/constants/balance.constant','getSigninLog','userBalanceService','object','4743879LpibAV','14208dTBcbT','length','__metadata','saveRecordRechargeLog','RechargeType','debug','log','signin.signInDate\x20as\x20signInDate,\x20signin.isSigned\x20as\x20isSigned','@nestjs/common','SigninEntity','getSignatureGiftConfig','push','signin.signInTime\x20<=\x20:lastDay','Logger','signin.userId\x20=\x20:userId','UserEntity','globalConfigService','1866cZdBnW','YYYY-MM-DD\x20HH:mm:ss','HttpStatus','andWhere','81QvZoKT','userEntity','Repository','defineProperty','用户不存在','__param','1441530nLfZre','@nestjs/typeorm','SigninService','871224KyuRwi','UserBalanceService','BAD_REQUEST','typeorm','setDate','user','__decorate','format','sign','GlobalConfigService','function','error:\x20','addBalanceToUser','Sign\x20in\x20successful.','endOf','HttpException','signInDate','signinEntity','484gLLFht','738678jopone','昨天签到了、今天是连续签到！','metadata','decorate','SIGN_IN','default','__esModule','../../common/utils/date','4900360tcCoyR','Injectable','update','2095VEiBvQ','findOne','YYYY-MM-DD','startOf','今日已签到、改天再来吧!.','isSigned'];_0x5191=function(){return _0x5106a8;};return _0x5191();}Object[_0x243a01(0x93)](exports,_0x243a01(0xb2),{'value':!![]}),exports[_0x243a01(0x98)]=void 0x0;function _0x1ebd(_0x34d76c,_0x247e4b){const _0x519131=_0x5191();return _0x1ebd=function(_0x1ebd48,_0x194c67){_0x1ebd48=_0x1ebd48-0x8e;let _0x4d2f29=_0x519131[_0x1ebd48];return _0x4d2f29;},_0x1ebd(_0x34d76c,_0x247e4b);}const globalConfig_service_1=require('./../globalConfig/globalConfig.service'),userBalance_service_1=require('./../userBalance/userBalance.service'),common_1=require(_0x243a01(0xca)),signIn_entity_1=require('./signIn.entity'),typeorm_1=require(_0x243a01(0x97)),typeorm_2=require(_0x243a01(0x9c)),date_1=require(_0x243a01(0xb3)),user_entity_1=require('../user/user.entity'),balance_constant_1=require(_0x243a01(0xbd));let SigninService=class SigninService{constructor(_0x5a1722,_0x561d10,_0x11cc1a,_0x5d07fe){const _0x28de66=_0x243a01;this[_0x28de66(0xaa)]=_0x5a1722,this[_0x28de66(0x91)]=_0x561d10,this[_0x28de66(0xbf)]=_0x11cc1a,this[_0x28de66(0xd2)]=_0x5d07fe;}async[_0x243a01(0xa1)](_0xad0830){const _0x332d61=_0x243a01,{id:_0x5a9085}=_0xad0830['user'],_0x1ffa33=(0x0,date_1[_0x332d61(0xb1)])(new Date())[_0x332d61(0xa0)](_0x332d61(0xb9)),_0x3bb825=await this[_0x332d61(0xaa)][_0x332d61(0xb8)]({'where':{'userId':_0x5a9085,'signInDate':_0x1ffa33}});if(_0x3bb825)throw new common_1[(_0x332d61(0xa8))](_0x332d61(0xbb),common_1['HttpStatus'][_0x332d61(0x9b)]);const {model3Count:_0x515d57,model4Count:_0x4891d9,drawMjCount:_0x19ba6f}=await this['globalConfigService'][_0x332d61(0xcc)]();await this[_0x332d61(0xaa)]['save']({'userId':_0x5a9085,'signInTime':new Date(),'signInDate':_0x1ffa33,'isSigned':!![]}),await this[_0x332d61(0xbf)][_0x332d61(0xa5)](_0x5a9085,{'model3Count':_0x515d57,'model4Count':_0x4891d9,'drawMjCount':_0x19ba6f}),await this['userBalanceService'][_0x332d61(0xc5)]({'userId':_0x5a9085,'rechargeType':balance_constant_1[_0x332d61(0xc6)][_0x332d61(0xb0)],'model3Count':_0x515d57,'model4Count':_0x4891d9,'drawMjCount':_0x19ba6f});const _0x1c9f42=(0x0,date_1[_0x332d61(0xb1)])(new Date())['subtract'](0x1,'day')[_0x332d61(0xa0)](_0x332d61(0xb9)),_0x3ca3fc=await this[_0x332d61(0xaa)][_0x332d61(0xb8)]({'where':{'userId':_0x5a9085,'signInDate':_0x1c9f42}});if(_0x3ca3fc){common_1['Logger'][_0x332d61(0xc7)]('用户'+_0x5a9085+_0x332d61(0xad),'SigninService');const _0xd888e1=await this[_0x332d61(0x91)][_0x332d61(0xb8)]({'where':{'id':_0x5a9085}});if(!_0xd888e1)throw new common_1[(_0x332d61(0xa8))](_0x332d61(0x94),common_1[_0x332d61(0x8e)]['BAD_REQUEST']);const {consecutiveDays:consecutiveDays=0x0}=_0xd888e1;await this[_0x332d61(0x91)][_0x332d61(0xb6)]({'id':_0x5a9085},{'consecutiveDays':consecutiveDays+0x1});}else common_1[_0x332d61(0xcf)][_0x332d61(0xc7)]('用户'+_0x5a9085+'昨天没签到、今天重置天数！',_0x332d61(0x98)),await this[_0x332d61(0x91)][_0x332d61(0xb6)]({'id':_0x5a9085},{'consecutiveDays':0x1});return _0x332d61(0xa6);}async[_0x243a01(0xbe)](_0x534d86){const _0x2e2da8=_0x243a01;try{const {id:_0x31debe}=_0x534d86[_0x2e2da8(0x9e)],_0x297609=(0x0,date_1['default'])()[_0x2e2da8(0xba)]('month')[_0x2e2da8(0xa0)](_0x2e2da8(0xd4)),_0x423d24=(0x0,date_1[_0x2e2da8(0xb1)])()[_0x2e2da8(0xa7)]('month')['format'](_0x2e2da8(0xd4)),_0x24386e=this[_0x2e2da8(0xaa)]['createQueryBuilder']('signin'),_0x7676ec=await _0x24386e['select'](_0x2e2da8(0xc9))['andWhere'](_0x2e2da8(0xd0),{'userId':_0x534d86[_0x2e2da8(0x9e)]['id']})[_0x2e2da8(0x8f)]('signin.signInTime\x20>=\x20:firstDay',{'firstDay':_0x297609})[_0x2e2da8(0x8f)](_0x2e2da8(0xce),{'lastDay':_0x423d24})['getRawMany'](),_0x51c73c=new Date(_0x297609),_0x13f1b0=new Date(_0x423d24),_0x975637=[],_0x13eb5b=new Date(_0x51c73c);while(_0x13eb5b<=_0x13f1b0){_0x975637[_0x2e2da8(0xcd)]((0x0,date_1[_0x2e2da8(0xb1)])(new Date(_0x13eb5b))[_0x2e2da8(0xa0)](_0x2e2da8(0xb9))),_0x13eb5b[_0x2e2da8(0x9d)](_0x13eb5b['getDate']()+0x1);}const _0x1fcb57=[];for(const _0x1c823f of _0x975637){const _0x58c17d=_0x7676ec['find'](_0x2e4288=>_0x2e4288[_0x2e2da8(0xa9)]===_0x1c823f);!_0x58c17d?_0x1fcb57[_0x2e2da8(0xcd)]({'signInDate':_0x1c823f,'isSigned':![]}):(_0x58c17d[_0x2e2da8(0xbc)]=!![],_0x1fcb57[_0x2e2da8(0xcd)](_0x58c17d));}return _0x1fcb57;}catch(_0x268eaa){console[_0x2e2da8(0xc8)](_0x2e2da8(0xa4),_0x268eaa);throw new common_1[(_0x2e2da8(0xa8))]('获取签到数据失败！',common_1['HttpStatus'][_0x2e2da8(0x9b)]);}}};SigninService=__decorate([(0x0,common_1[_0x243a01(0xb5)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(signIn_entity_1[_0x243a01(0xcb)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x243a01(0xd1)])),__metadata('design:paramtypes',[typeorm_2['Repository'],typeorm_2[_0x243a01(0x92)],userBalance_service_1[_0x243a01(0x9a)],globalConfig_service_1[_0x243a01(0xa2)]])],SigninService),exports[_0x243a01(0x98)]=SigninService;