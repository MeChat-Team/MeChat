'use strict';const _0x410df3=_0x56b1;(function(_0x252418,_0x3ad950){const _0x4e641a=_0x56b1,_0x16d310=_0x252418();while(!![]){try{const _0x5bf4f9=-parseInt(_0x4e641a(0xae))/0x1*(-parseInt(_0x4e641a(0xa8))/0x2)+-parseInt(_0x4e641a(0xb1))/0x3*(-parseInt(_0x4e641a(0xb5))/0x4)+parseInt(_0x4e641a(0x96))/0x5*(-parseInt(_0x4e641a(0xa0))/0x6)+parseInt(_0x4e641a(0xad))/0x7*(parseInt(_0x4e641a(0x93))/0x8)+parseInt(_0x4e641a(0xb3))/0x9+parseInt(_0x4e641a(0xd2))/0xa*(parseInt(_0x4e641a(0xbc))/0xb)+-parseInt(_0x4e641a(0xbd))/0xc;if(_0x5bf4f9===_0x3ad950)break;else _0x16d310['push'](_0x16d310['shift']());}catch(_0x3d3cfa){_0x16d310['push'](_0x16d310['shift']());}}}(_0x3153,0xa1803));var __decorate=this&&this['__decorate']||function(_0x43c87b,_0x234ca5,_0xb89367,_0x1c506c){const _0x1b0291=_0x56b1;var _0x50f006=arguments['length'],_0x3b3f73=_0x50f006<0x3?_0x234ca5:_0x1c506c===null?_0x1c506c=Object[_0x1b0291(0x8b)](_0x234ca5,_0xb89367):_0x1c506c,_0x120e98;if(typeof Reflect===_0x1b0291(0x95)&&typeof Reflect[_0x1b0291(0xc9)]===_0x1b0291(0xcd))_0x3b3f73=Reflect[_0x1b0291(0xc9)](_0x43c87b,_0x234ca5,_0xb89367,_0x1c506c);else{for(var _0x4edf98=_0x43c87b[_0x1b0291(0xa6)]-0x1;_0x4edf98>=0x0;_0x4edf98--)if(_0x120e98=_0x43c87b[_0x4edf98])_0x3b3f73=(_0x50f006<0x3?_0x120e98(_0x3b3f73):_0x50f006>0x3?_0x120e98(_0x234ca5,_0xb89367,_0x3b3f73):_0x120e98(_0x234ca5,_0xb89367))||_0x3b3f73;}return _0x50f006>0x3&&_0x3b3f73&&Object[_0x1b0291(0xa3)](_0x234ca5,_0xb89367,_0x3b3f73),_0x3b3f73;},__metadata=this&&this['__metadata']||function(_0x597d6e,_0x3bddee){const _0x16cd03=_0x56b1;if(typeof Reflect===_0x16cd03(0x95)&&typeof Reflect[_0x16cd03(0xc4)]==='function')return Reflect[_0x16cd03(0xc4)](_0x597d6e,_0x3bddee);},__param=this&&this[_0x410df3(0xc8)]||function(_0x4e8e6c,_0x1f0da0){return function(_0x238793,_0x5b73fc){_0x1f0da0(_0x238793,_0x5b73fc,_0x4e8e6c);};};Object[_0x410df3(0xa3)](exports,_0x410df3(0xc1),{'value':!![]}),exports[_0x410df3(0xcc)]=void 0x0;const globalConfig_service_1=require('./../globalConfig/globalConfig.service'),userBalance_service_1=require(_0x410df3(0xce)),common_1=require(_0x410df3(0x92)),signIn_entity_1=require(_0x410df3(0x89)),typeorm_1=require(_0x410df3(0xb8)),typeorm_2=require('typeorm'),date_1=require(_0x410df3(0x9d)),user_entity_1=require(_0x410df3(0xb9)),balance_constant_1=require('../../common/constants/balance.constant');function _0x56b1(_0x4e4673,_0x5cb007){const _0x3153bf=_0x3153();return _0x56b1=function(_0x56b1bc,_0x477d84){_0x56b1bc=_0x56b1bc-0x89;let _0x1c63af=_0x3153bf[_0x56b1bc];return _0x1c63af;},_0x56b1(_0x4e4673,_0x5cb007);}let SigninService=class SigninService{constructor(_0x2bcf5e,_0x52a233,_0x95a0c9,_0x3e3de4){const _0x33126d=_0x410df3;this[_0x33126d(0xa7)]=_0x2bcf5e,this[_0x33126d(0x8c)]=_0x52a233,this[_0x33126d(0x94)]=_0x95a0c9,this[_0x33126d(0xd0)]=_0x3e3de4;}async[_0x410df3(0x9c)](_0x426cbc){const _0x23863d=_0x410df3,{id:_0x51792b}=_0x426cbc[_0x23863d(0xcf)],_0x53410e=(0x0,date_1['default'])(new Date())['format'](_0x23863d(0xa1)),_0x18941e=await this['signinEntity'][_0x23863d(0xd8)]({'where':{'userId':_0x51792b,'signInDate':_0x53410e}});if(_0x18941e)throw new common_1[(_0x23863d(0xd5))](_0x23863d(0x9a),common_1[_0x23863d(0x9e)]['BAD_REQUEST']);const {model3Count:_0x9c81b3,model4Count:_0x45d012,drawMjCount:_0x436e2f}=await this[_0x23863d(0xd0)][_0x23863d(0xc0)]();await this[_0x23863d(0xa7)]['save']({'userId':_0x51792b,'signInTime':new Date(),'signInDate':_0x53410e,'isSigned':!![]}),await this[_0x23863d(0x94)][_0x23863d(0xaf)](_0x51792b,{'model3Count':_0x9c81b3,'model4Count':_0x45d012,'drawMjCount':_0x436e2f}),await this['userBalanceService'][_0x23863d(0xc3)]({'userId':_0x51792b,'rechargeType':balance_constant_1[_0x23863d(0xcb)]['SIGN_IN'],'model3Count':_0x9c81b3,'model4Count':_0x45d012,'drawMjCount':_0x436e2f});const _0x5bacd3=(0x0,date_1[_0x23863d(0xa2)])(new Date())[_0x23863d(0xaa)](0x1,_0x23863d(0xbb))['format'](_0x23863d(0xa1)),_0x556654=await this[_0x23863d(0xa7)][_0x23863d(0xd8)]({'where':{'userId':_0x51792b,'signInDate':_0x5bacd3}});if(_0x556654){common_1[_0x23863d(0xbf)][_0x23863d(0xb2)]('用户'+_0x51792b+_0x23863d(0xd4),_0x23863d(0xcc));const _0x4e90ac=await this[_0x23863d(0x8c)]['findOne']({'where':{'id':_0x51792b}});if(!_0x4e90ac)throw new common_1[(_0x23863d(0xd5))](_0x23863d(0xb0),common_1[_0x23863d(0x9e)]['BAD_REQUEST']);const {consecutiveDays:consecutiveDays=0x0}=_0x4e90ac;await this[_0x23863d(0x8c)][_0x23863d(0xab)]({'id':_0x51792b},{'consecutiveDays':consecutiveDays+0x1});}else common_1['Logger']['debug']('用户'+_0x51792b+'昨天没签到、今天重置天数！','SigninService'),await this[_0x23863d(0x8c)]['update']({'id':_0x51792b},{'consecutiveDays':0x1});return'Sign\x20in\x20successful.';}async[_0x410df3(0x9f)](_0x1468b6){const _0x3bbc54=_0x410df3;try{const {id:_0x26eba5}=_0x1468b6['user'],_0x53f4dc=(0x0,date_1[_0x3bbc54(0xa2)])()[_0x3bbc54(0xc2)]('month')[_0x3bbc54(0x97)](_0x3bbc54(0xd1)),_0xc31711=(0x0,date_1[_0x3bbc54(0xa2)])()[_0x3bbc54(0xa4)]('month')['format'](_0x3bbc54(0xd1)),_0x3b9393=this[_0x3bbc54(0xa7)][_0x3bbc54(0xc6)](_0x3bbc54(0x8a)),_0x44016e=await _0x3b9393[_0x3bbc54(0xd3)](_0x3bbc54(0xbe))[_0x3bbc54(0x8f)](_0x3bbc54(0xd6),{'userId':_0x1468b6['user']['id']})[_0x3bbc54(0x8f)](_0x3bbc54(0x90),{'firstDay':_0x53f4dc})[_0x3bbc54(0x8f)](_0x3bbc54(0xd9),{'lastDay':_0xc31711})[_0x3bbc54(0xa9)](),_0x58c957=new Date(_0x53f4dc),_0x537b8b=new Date(_0xc31711),_0x3ee687=[],_0x1e55d2=new Date(_0x58c957);while(_0x1e55d2<=_0x537b8b){_0x3ee687[_0x3bbc54(0x98)]((0x0,date_1[_0x3bbc54(0xa2)])(new Date(_0x1e55d2))[_0x3bbc54(0x97)](_0x3bbc54(0xa1))),_0x1e55d2[_0x3bbc54(0xa5)](_0x1e55d2[_0x3bbc54(0xb7)]()+0x1);}const _0x1ad0b2=[];for(const _0x12a1aa of _0x3ee687){const _0x2cc2ac=_0x44016e[_0x3bbc54(0xca)](_0x25bb99=>_0x25bb99[_0x3bbc54(0xd7)]===_0x12a1aa);!_0x2cc2ac?_0x1ad0b2['push']({'signInDate':_0x12a1aa,'isSigned':![]}):(_0x2cc2ac[_0x3bbc54(0xc7)]=!![],_0x1ad0b2[_0x3bbc54(0x98)](_0x2cc2ac));}return _0x1ad0b2;}catch(_0x2c53a7){console[_0x3bbc54(0xb6)](_0x3bbc54(0x8d),_0x2c53a7);throw new common_1[(_0x3bbc54(0xd5))]('获取签到数据失败！',common_1['HttpStatus'][_0x3bbc54(0xb4)]);}}};SigninService=__decorate([(0x0,common_1[_0x410df3(0x9b)])(),__param(0x0,(0x0,typeorm_1[_0x410df3(0xac)])(signIn_entity_1[_0x410df3(0x8e)])),__param(0x1,(0x0,typeorm_1[_0x410df3(0xac)])(user_entity_1[_0x410df3(0xba)])),__metadata(_0x410df3(0xc5),[typeorm_2[_0x410df3(0x91)],typeorm_2['Repository'],userBalance_service_1['UserBalanceService'],globalConfig_service_1[_0x410df3(0x99)]])],SigninService),exports['SigninService']=SigninService;function _0x3153(){const _0x22a275=['andWhere','signin.signInTime\x20>=\x20:firstDay','Repository','@nestjs/common','2772904eRTkps','userBalanceService','object','18485NLZxNM','format','push','GlobalConfigService','今日已签到、改天再来吧!.','Injectable','sign','../../common/utils/date','HttpStatus','getSigninLog','1668iOckQi','YYYY-MM-DD','default','defineProperty','endOf','setDate','length','signinEntity','2qEBNTQ','getRawMany','subtract','update','InjectRepository','7WOyywN','799967FHlynQ','addBalanceToUser','用户不存在','9MdkmMt','debug','9570105MAzTyX','BAD_REQUEST','1672604XmuFqt','log','getDate','@nestjs/typeorm','../user/user.entity','UserEntity','day','462wMgIJQ','26527236DpLuTV','signin.signInDate\x20as\x20signInDate,\x20signin.isSigned\x20as\x20isSigned','Logger','getSignatureGiftConfig','__esModule','startOf','saveRecordRechargeLog','metadata','design:paramtypes','createQueryBuilder','isSigned','__param','decorate','find','RechargeType','SigninService','function','./../userBalance/userBalance.service','user','globalConfigService','YYYY-MM-DD\x20HH:mm:ss','103690CFsGyC','select','昨天签到了、今天是连续签到！','HttpException','signin.userId\x20=\x20:userId','signInDate','findOne','signin.signInTime\x20<=\x20:lastDay','./signIn.entity','signin','getOwnPropertyDescriptor','userEntity','error:\x20','SigninEntity'];_0x3153=function(){return _0x22a275;};return _0x3153();}