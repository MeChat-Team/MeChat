'use strict';const _0x58c6f7=_0x2973;(function(_0x5a4c63,_0xc223e1){const _0x5ee01a=_0x2973,_0x95e2fc=_0x5a4c63();while(!![]){try{const _0x221054=parseInt(_0x5ee01a(0x140))/0x1*(parseInt(_0x5ee01a(0x13e))/0x2)+parseInt(_0x5ee01a(0x149))/0x3+-parseInt(_0x5ee01a(0x13f))/0x4*(parseInt(_0x5ee01a(0x144))/0x5)+-parseInt(_0x5ee01a(0x15b))/0x6*(-parseInt(_0x5ee01a(0x177))/0x7)+parseInt(_0x5ee01a(0x184))/0x8*(parseInt(_0x5ee01a(0x167))/0x9)+parseInt(_0x5ee01a(0x170))/0xa+-parseInt(_0x5ee01a(0x14e))/0xb*(parseInt(_0x5ee01a(0x163))/0xc);if(_0x221054===_0xc223e1)break;else _0x95e2fc['push'](_0x95e2fc['shift']());}catch(_0x295cd5){_0x95e2fc['push'](_0x95e2fc['shift']());}}}(_0x2fd0,0x1a943));var __decorate=this&&this[_0x58c6f7(0x178)]||function(_0x53dd9f,_0x109513,_0x44e221,_0x468a14){const _0x4f42c4=_0x58c6f7;var _0x5f5459=arguments[_0x4f42c4(0x14c)],_0x493c48=_0x5f5459<0x3?_0x109513:_0x468a14===null?_0x468a14=Object[_0x4f42c4(0x17b)](_0x109513,_0x44e221):_0x468a14,_0x263e54;if(typeof Reflect===_0x4f42c4(0x146)&&typeof Reflect[_0x4f42c4(0x162)]===_0x4f42c4(0x153))_0x493c48=Reflect['decorate'](_0x53dd9f,_0x109513,_0x44e221,_0x468a14);else{for(var _0xb5aa30=_0x53dd9f['length']-0x1;_0xb5aa30>=0x0;_0xb5aa30--)if(_0x263e54=_0x53dd9f[_0xb5aa30])_0x493c48=(_0x5f5459<0x3?_0x263e54(_0x493c48):_0x5f5459>0x3?_0x263e54(_0x109513,_0x44e221,_0x493c48):_0x263e54(_0x109513,_0x44e221))||_0x493c48;}return _0x5f5459>0x3&&_0x493c48&&Object[_0x4f42c4(0x17f)](_0x109513,_0x44e221,_0x493c48),_0x493c48;},__metadata=this&&this['__metadata']||function(_0x4e0b0d,_0x3d75ae){const _0x3da4b1=_0x58c6f7;if(typeof Reflect===_0x3da4b1(0x146)&&typeof Reflect['metadata']===_0x3da4b1(0x153))return Reflect[_0x3da4b1(0x175)](_0x4e0b0d,_0x3d75ae);},__param=this&&this[_0x58c6f7(0x142)]||function(_0x225de1,_0x4d8943){return function(_0x36c416,_0x669af2){_0x4d8943(_0x36c416,_0x669af2,_0x225de1);};};function _0x2973(_0x4d5c5b,_0x10b533){const _0x2fd00f=_0x2fd0();return _0x2973=function(_0x2973ee,_0x561e34){_0x2973ee=_0x2973ee-0x13a;let _0x2c4381=_0x2fd00f[_0x2973ee];return _0x2c4381;},_0x2973(_0x4d5c5b,_0x10b533);}Object[_0x58c6f7(0x17f)](exports,_0x58c6f7(0x160),{'value':!![]}),exports[_0x58c6f7(0x169)]=void 0x0;const globalConfig_service_1=require('./../globalConfig/globalConfig.service'),userBalance_service_1=require('./../userBalance/userBalance.service'),common_1=require('@nestjs/common'),signIn_entity_1=require(_0x58c6f7(0x16c)),typeorm_1=require(_0x58c6f7(0x156)),typeorm_2=require(_0x58c6f7(0x154)),date_1=require(_0x58c6f7(0x14d)),user_entity_1=require(_0x58c6f7(0x187)),balance_constant_1=require(_0x58c6f7(0x143));let SigninService=class SigninService{constructor(_0x3849ee,_0x42b7fe,_0x3c34f1,_0x5306a3){const _0x5c4819=_0x58c6f7;this[_0x5c4819(0x13d)]=_0x3849ee,this[_0x5c4819(0x172)]=_0x42b7fe,this[_0x5c4819(0x183)]=_0x3c34f1,this[_0x5c4819(0x15d)]=_0x5306a3;}async[_0x58c6f7(0x145)](_0x2044fc){const _0x3d174b=_0x58c6f7,{id:_0x7df29e}=_0x2044fc[_0x3d174b(0x16d)],_0x263866=(0x0,date_1[_0x3d174b(0x150)])(new Date())[_0x3d174b(0x13c)](_0x3d174b(0x16f)),_0x2a6044=await this['signinEntity'][_0x3d174b(0x14a)]({'where':{'userId':_0x7df29e,'signInDate':_0x263866}});if(_0x2a6044)throw new common_1['HttpException'](_0x3d174b(0x148),common_1[_0x3d174b(0x173)]['BAD_REQUEST']);const {model3Count:_0x23eac3,model4Count:_0xd51b85,drawMjCount:_0x37b8fe}=await this[_0x3d174b(0x15d)]['getSignatureGiftConfig']();await this['signinEntity'][_0x3d174b(0x17c)]({'userId':_0x7df29e,'signInTime':new Date(),'signInDate':_0x263866,'isSigned':!![]}),await this['userBalanceService']['addBalanceToUser'](_0x7df29e,{'model3Count':_0x23eac3,'model4Count':_0xd51b85,'drawMjCount':_0x37b8fe}),await this[_0x3d174b(0x183)][_0x3d174b(0x185)]({'userId':_0x7df29e,'rechargeType':balance_constant_1[_0x3d174b(0x141)][_0x3d174b(0x15c)],'model3Count':_0x23eac3,'model4Count':_0xd51b85,'drawMjCount':_0x37b8fe});const _0x318cfd=(0x0,date_1[_0x3d174b(0x150)])(new Date())[_0x3d174b(0x161)](0x1,_0x3d174b(0x168))['format']('YYYY-MM-DD'),_0xd81edd=await this[_0x3d174b(0x13d)][_0x3d174b(0x14a)]({'where':{'userId':_0x7df29e,'signInDate':_0x318cfd}});if(_0xd81edd){common_1['Logger'][_0x3d174b(0x181)]('用户'+_0x7df29e+_0x3d174b(0x174),'SigninService');const _0x3c6246=await this[_0x3d174b(0x172)][_0x3d174b(0x14a)]({'where':{'id':_0x7df29e}});if(!_0x3c6246)throw new common_1[(_0x3d174b(0x152))](_0x3d174b(0x147),common_1[_0x3d174b(0x173)][_0x3d174b(0x14b)]);const {consecutiveDays:consecutiveDays=0x0}=_0x3c6246;await this[_0x3d174b(0x172)][_0x3d174b(0x15a)]({'id':_0x7df29e},{'consecutiveDays':consecutiveDays+0x1});}else common_1[_0x3d174b(0x158)][_0x3d174b(0x181)]('用户'+_0x7df29e+'昨天没签到、今天重置天数！',_0x3d174b(0x169)),await this[_0x3d174b(0x172)][_0x3d174b(0x15a)]({'id':_0x7df29e},{'consecutiveDays':0x1});return _0x3d174b(0x166);}async[_0x58c6f7(0x171)](_0x1b700e){const _0x57b37a=_0x58c6f7;try{const {id:_0x3f1e42}=_0x1b700e['user'],_0x442f79=(0x0,date_1[_0x57b37a(0x150)])()['startOf'](_0x57b37a(0x151))['format'](_0x57b37a(0x157)),_0x2dabed=(0x0,date_1['default'])()[_0x57b37a(0x16b)](_0x57b37a(0x151))[_0x57b37a(0x13c)](_0x57b37a(0x157)),_0x429753=this[_0x57b37a(0x13d)]['createQueryBuilder'](_0x57b37a(0x17e)),_0x379b0f=await _0x429753[_0x57b37a(0x13b)](_0x57b37a(0x13a))['andWhere']('signin.userId\x20=\x20:userId',{'userId':_0x1b700e[_0x57b37a(0x16d)]['id']})[_0x57b37a(0x159)](_0x57b37a(0x155),{'firstDay':_0x442f79})[_0x57b37a(0x159)](_0x57b37a(0x17a),{'lastDay':_0x2dabed})[_0x57b37a(0x182)](),_0x548d39=new Date(_0x442f79),_0x3599f1=new Date(_0x2dabed),_0x21315f=[],_0xd44536=new Date(_0x548d39);while(_0xd44536<=_0x3599f1){_0x21315f[_0x57b37a(0x180)]((0x0,date_1['default'])(new Date(_0xd44536))[_0x57b37a(0x13c)]('YYYY-MM-DD')),_0xd44536[_0x57b37a(0x16a)](_0xd44536[_0x57b37a(0x165)]()+0x1);}const _0x365faa=[];for(const _0x284a31 of _0x21315f){const _0x2f9462=_0x379b0f['find'](_0x406793=>_0x406793['signInDate']===_0x284a31);!_0x2f9462?_0x365faa[_0x57b37a(0x180)]({'signInDate':_0x284a31,'isSigned':![]}):(_0x2f9462[_0x57b37a(0x179)]=!![],_0x365faa[_0x57b37a(0x180)](_0x2f9462));}return _0x365faa;}catch(_0x46d8d5){console[_0x57b37a(0x15e)](_0x57b37a(0x17d),_0x46d8d5);throw new common_1[(_0x57b37a(0x152))](_0x57b37a(0x176),common_1[_0x57b37a(0x173)]['BAD_REQUEST']);}}};function _0x2fd0(){const _0x4dcc98=['__esModule','subtract','decorate','132ITxsDS','UserBalanceService','getDate','Sign\x20in\x20successful.','63DKpBeB','day','SigninService','setDate','endOf','./signIn.entity','user','Repository','YYYY-MM-DD','1754840pcBFAi','getSigninLog','userEntity','HttpStatus','昨天签到了、今天是连续签到！','metadata','获取签到数据失败！','422023LnIuas','__decorate','isSigned','signin.signInTime\x20<=\x20:lastDay','getOwnPropertyDescriptor','save','error:\x20','signin','defineProperty','push','debug','getRawMany','userBalanceService','17968SaozjS','saveRecordRechargeLog','UserEntity','../user/user.entity','signin.signInDate\x20as\x20signInDate,\x20signin.isSigned\x20as\x20isSigned','select','format','signinEntity','420814IZWutQ','4oUpHoq','1ZMOdwj','RechargeType','__param','../../common/constants/balance.constant','448165eOcOTe','sign','object','用户不存在','今日已签到、改天再来吧!.','78255KDQbrS','findOne','BAD_REQUEST','length','../../common/utils/date','289487hlVuKY','SigninEntity','default','month','HttpException','function','typeorm','signin.signInTime\x20>=\x20:firstDay','@nestjs/typeorm','YYYY-MM-DD\x20HH:mm:ss','Logger','andWhere','update','6iurvPE','SIGN_IN','globalConfigService','log','InjectRepository'];_0x2fd0=function(){return _0x4dcc98;};return _0x2fd0();}SigninService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x58c6f7(0x15f)])(signIn_entity_1[_0x58c6f7(0x14f)])),__param(0x1,(0x0,typeorm_1[_0x58c6f7(0x15f)])(user_entity_1[_0x58c6f7(0x186)])),__metadata('design:paramtypes',[typeorm_2[_0x58c6f7(0x16e)],typeorm_2[_0x58c6f7(0x16e)],userBalance_service_1[_0x58c6f7(0x164)],globalConfig_service_1['GlobalConfigService']])],SigninService),exports[_0x58c6f7(0x169)]=SigninService;