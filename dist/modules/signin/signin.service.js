'use strict';function _0x3fc2(){const _0xf530a7=['__esModule','__decorate','getDate','userEntity','createQueryBuilder','Injectable','昨天签到了、今天是连续签到！','YYYY-MM-DD','104935mHtuMD','1312590WukTlM','Repository','SIGN_IN','default','__param','defineProperty','function','signInDate','signin.signInTime\x20>=\x20:firstDay','Logger','debug','736371zTHNSG','@nestjs/typeorm','findOne','6932hmtWnW','andWhere','GlobalConfigService','object','signinEntity','Sign\x20in\x20successful.','YYYY-MM-DD\x20HH:mm:ss','@nestjs/common','month','isSigned','用户不存在','signin.signInDate\x20as\x20signInDate,\x20signin.isSigned\x20as\x20isSigned','../user/user.entity','4ykQERi','./signIn.entity','HttpException','14Qsgfiv','昨天没签到、今天重置天数！','getRawMany','decorate','../../common/constants/balance.constant','../../common/utils/date','typeorm','globalConfigService','signin.userId\x20=\x20:userId','signin.signInTime\x20<=\x20:lastDay','setDate','InjectRepository','BAD_REQUEST','day','startOf','update','RechargeType','__metadata','40RyARXl','metadata','3590985xjHEfr','format','push','userBalanceService','10097329vJoSkY','user','SigninEntity','HttpStatus','getSignatureGiftConfig','4945592hUpmMi','find','signin','saveRecordRechargeLog','UserBalanceService','design:paramtypes','addBalanceToUser','1377DQLkSq','今日已签到、改天再来吧!.','./../userBalance/userBalance.service','log','getOwnPropertyDescriptor','save','SigninService'];_0x3fc2=function(){return _0xf530a7;};return _0x3fc2();}const _0x5c637b=_0xc198;function _0xc198(_0x12676a,_0x2dfaa7){const _0x3fc24f=_0x3fc2();return _0xc198=function(_0xc19879,_0x3cf93c){_0xc19879=_0xc19879-0xf6;let _0x53511b=_0x3fc24f[_0xc19879];return _0x53511b;},_0xc198(_0x12676a,_0x2dfaa7);}(function(_0x5e1492,_0x267912){const _0x4eb59d=_0xc198,_0x3b3dcf=_0x5e1492();while(!![]){try{const _0x36a9de=-parseInt(_0x4eb59d(0x106))/0x1+-parseInt(_0x4eb59d(0x115))/0x2*(-parseInt(_0x4eb59d(0xf7))/0x3)+parseInt(_0x4eb59d(0x122))/0x4*(-parseInt(_0x4eb59d(0x139))/0x5)+-parseInt(_0x4eb59d(0x107))/0x6*(parseInt(_0x4eb59d(0x125))/0x7)+-parseInt(_0x4eb59d(0x142))/0x8+-parseInt(_0x4eb59d(0x112))/0x9*(-parseInt(_0x4eb59d(0x137))/0xa)+parseInt(_0x4eb59d(0x13d))/0xb;if(_0x36a9de===_0x267912)break;else _0x3b3dcf['push'](_0x3b3dcf['shift']());}catch(_0x1ffbec){_0x3b3dcf['push'](_0x3b3dcf['shift']());}}}(_0x3fc2,0xe9b40));var __decorate=this&&this[_0x5c637b(0xff)]||function(_0x103375,_0x55049b,_0x3c1205,_0x1a6b72){const _0x46706f=_0x5c637b;var _0x4515ed=arguments['length'],_0x2d15d9=_0x4515ed<0x3?_0x55049b:_0x1a6b72===null?_0x1a6b72=Object[_0x46706f(0xfb)](_0x55049b,_0x3c1205):_0x1a6b72,_0x526dc6;if(typeof Reflect===_0x46706f(0x118)&&typeof Reflect[_0x46706f(0x128)]===_0x46706f(0x10d))_0x2d15d9=Reflect[_0x46706f(0x128)](_0x103375,_0x55049b,_0x3c1205,_0x1a6b72);else{for(var _0x57e468=_0x103375['length']-0x1;_0x57e468>=0x0;_0x57e468--)if(_0x526dc6=_0x103375[_0x57e468])_0x2d15d9=(_0x4515ed<0x3?_0x526dc6(_0x2d15d9):_0x4515ed>0x3?_0x526dc6(_0x55049b,_0x3c1205,_0x2d15d9):_0x526dc6(_0x55049b,_0x3c1205))||_0x2d15d9;}return _0x4515ed>0x3&&_0x2d15d9&&Object['defineProperty'](_0x55049b,_0x3c1205,_0x2d15d9),_0x2d15d9;},__metadata=this&&this[_0x5c637b(0x136)]||function(_0x846d05,_0x2c8e95){const _0x4f5d17=_0x5c637b;if(typeof Reflect==='object'&&typeof Reflect[_0x4f5d17(0x138)]==='function')return Reflect[_0x4f5d17(0x138)](_0x846d05,_0x2c8e95);},__param=this&&this[_0x5c637b(0x10b)]||function(_0x54ab01,_0x2b8344){return function(_0x447256,_0x266e1b){_0x2b8344(_0x447256,_0x266e1b,_0x54ab01);};};Object[_0x5c637b(0x10c)](exports,_0x5c637b(0xfe),{'value':!![]}),exports['SigninService']=void 0x0;const globalConfig_service_1=require('./../globalConfig/globalConfig.service'),userBalance_service_1=require(_0x5c637b(0xf9)),common_1=require(_0x5c637b(0x11c)),signIn_entity_1=require(_0x5c637b(0x123)),typeorm_1=require(_0x5c637b(0x113)),typeorm_2=require(_0x5c637b(0x12b)),date_1=require(_0x5c637b(0x12a)),user_entity_1=require(_0x5c637b(0x121)),balance_constant_1=require(_0x5c637b(0x129));let SigninService=class SigninService{constructor(_0xa9c623,_0x4d6c77,_0x4c16b8,_0x5e9b14){const _0x3e5f81=_0x5c637b;this[_0x3e5f81(0x119)]=_0xa9c623,this[_0x3e5f81(0x101)]=_0x4d6c77,this[_0x3e5f81(0x13c)]=_0x4c16b8,this['globalConfigService']=_0x5e9b14;}async['sign'](_0x3fc843){const _0x5f1a29=_0x5c637b,{id:_0x4e69c8}=_0x3fc843[_0x5f1a29(0x13e)],_0x4e58bd=(0x0,date_1[_0x5f1a29(0x10a)])(new Date())['format'](_0x5f1a29(0x105)),_0x35e25e=await this['signinEntity']['findOne']({'where':{'userId':_0x4e69c8,'signInDate':_0x4e58bd}});if(_0x35e25e)throw new common_1['HttpException'](_0x5f1a29(0xf8),common_1[_0x5f1a29(0x140)][_0x5f1a29(0x131)]);const {model3Count:_0x4c7775,model4Count:_0x4d87ea,drawMjCount:_0x550947}=await this[_0x5f1a29(0x12c)][_0x5f1a29(0x141)]();await this[_0x5f1a29(0x119)][_0x5f1a29(0xfc)]({'userId':_0x4e69c8,'signInTime':new Date(),'signInDate':_0x4e58bd,'isSigned':!![]}),await this[_0x5f1a29(0x13c)][_0x5f1a29(0xf6)](_0x4e69c8,{'model3Count':_0x4c7775,'model4Count':_0x4d87ea,'drawMjCount':_0x550947}),await this[_0x5f1a29(0x13c)][_0x5f1a29(0x145)]({'userId':_0x4e69c8,'rechargeType':balance_constant_1[_0x5f1a29(0x135)][_0x5f1a29(0x109)],'model3Count':_0x4c7775,'model4Count':_0x4d87ea,'drawMjCount':_0x550947});const _0xe061d=(0x0,date_1[_0x5f1a29(0x10a)])(new Date())['subtract'](0x1,_0x5f1a29(0x132))[_0x5f1a29(0x13a)](_0x5f1a29(0x105)),_0x57bfd0=await this['signinEntity'][_0x5f1a29(0x114)]({'where':{'userId':_0x4e69c8,'signInDate':_0xe061d}});if(_0x57bfd0){common_1[_0x5f1a29(0x110)][_0x5f1a29(0x111)]('用户'+_0x4e69c8+_0x5f1a29(0x104),_0x5f1a29(0xfd));const _0x35c442=await this[_0x5f1a29(0x101)][_0x5f1a29(0x114)]({'where':{'id':_0x4e69c8}});if(!_0x35c442)throw new common_1[(_0x5f1a29(0x124))](_0x5f1a29(0x11f),common_1['HttpStatus'][_0x5f1a29(0x131)]);const {consecutiveDays:consecutiveDays=0x0}=_0x35c442;await this[_0x5f1a29(0x101)][_0x5f1a29(0x134)]({'id':_0x4e69c8},{'consecutiveDays':consecutiveDays+0x1});}else common_1[_0x5f1a29(0x110)][_0x5f1a29(0x111)]('用户'+_0x4e69c8+_0x5f1a29(0x126),'SigninService'),await this['userEntity']['update']({'id':_0x4e69c8},{'consecutiveDays':0x1});return _0x5f1a29(0x11a);}async['getSigninLog'](_0x5810f3){const _0xad8af3=_0x5c637b;try{const {id:_0x2abce2}=_0x5810f3['user'],_0x524f8e=(0x0,date_1[_0xad8af3(0x10a)])()[_0xad8af3(0x133)](_0xad8af3(0x11d))[_0xad8af3(0x13a)](_0xad8af3(0x11b)),_0x5c69a1=(0x0,date_1[_0xad8af3(0x10a)])()['endOf'](_0xad8af3(0x11d))[_0xad8af3(0x13a)]('YYYY-MM-DD\x20HH:mm:ss'),_0x5f40ff=this[_0xad8af3(0x119)][_0xad8af3(0x102)](_0xad8af3(0x144)),_0x544418=await _0x5f40ff['select'](_0xad8af3(0x120))[_0xad8af3(0x116)](_0xad8af3(0x12d),{'userId':_0x5810f3[_0xad8af3(0x13e)]['id']})[_0xad8af3(0x116)](_0xad8af3(0x10f),{'firstDay':_0x524f8e})['andWhere'](_0xad8af3(0x12e),{'lastDay':_0x5c69a1})[_0xad8af3(0x127)](),_0xcbd059=new Date(_0x524f8e),_0xcab3ba=new Date(_0x5c69a1),_0x57e420=[],_0x34c2a4=new Date(_0xcbd059);while(_0x34c2a4<=_0xcab3ba){_0x57e420[_0xad8af3(0x13b)]((0x0,date_1['default'])(new Date(_0x34c2a4))[_0xad8af3(0x13a)]('YYYY-MM-DD')),_0x34c2a4[_0xad8af3(0x12f)](_0x34c2a4[_0xad8af3(0x100)]()+0x1);}const _0x430593=[];for(const _0x5a8198 of _0x57e420){const _0x2d7dce=_0x544418[_0xad8af3(0x143)](_0xa9bd17=>_0xa9bd17[_0xad8af3(0x10e)]===_0x5a8198);!_0x2d7dce?_0x430593[_0xad8af3(0x13b)]({'signInDate':_0x5a8198,'isSigned':![]}):(_0x2d7dce[_0xad8af3(0x11e)]=!![],_0x430593[_0xad8af3(0x13b)](_0x2d7dce));}return _0x430593;}catch(_0x5bae9e){console[_0xad8af3(0xfa)]('error:\x20',_0x5bae9e);throw new common_1[(_0xad8af3(0x124))]('获取签到数据失败！',common_1[_0xad8af3(0x140)][_0xad8af3(0x131)]);}}};SigninService=__decorate([(0x0,common_1[_0x5c637b(0x103)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(signIn_entity_1[_0x5c637b(0x13f)])),__param(0x1,(0x0,typeorm_1[_0x5c637b(0x130)])(user_entity_1['UserEntity'])),__metadata(_0x5c637b(0x147),[typeorm_2[_0x5c637b(0x108)],typeorm_2[_0x5c637b(0x108)],userBalance_service_1[_0x5c637b(0x146)],globalConfig_service_1[_0x5c637b(0x117)]])],SigninService),exports[_0x5c637b(0xfd)]=SigninService;