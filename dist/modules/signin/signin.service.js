'use strict';const _0x1a5b5f=_0x5ac5;(function(_0x49f378,_0x553ceb){const _0x1cb89f=_0x5ac5,_0x3c2213=_0x49f378();while(!![]){try{const _0x3fd04a=parseInt(_0x1cb89f(0x159))/0x1*(parseInt(_0x1cb89f(0x15e))/0x2)+-parseInt(_0x1cb89f(0x16f))/0x3*(parseInt(_0x1cb89f(0x139))/0x4)+-parseInt(_0x1cb89f(0x15b))/0x5*(-parseInt(_0x1cb89f(0x144))/0x6)+parseInt(_0x1cb89f(0x177))/0x7*(-parseInt(_0x1cb89f(0x148))/0x8)+-parseInt(_0x1cb89f(0x165))/0x9+parseInt(_0x1cb89f(0x142))/0xa*(parseInt(_0x1cb89f(0x150))/0xb)+-parseInt(_0x1cb89f(0x14c))/0xc*(-parseInt(_0x1cb89f(0x164))/0xd);if(_0x3fd04a===_0x553ceb)break;else _0x3c2213['push'](_0x3c2213['shift']());}catch(_0x24ec68){_0x3c2213['push'](_0x3c2213['shift']());}}}(_0x5b4f,0x25dbb));function _0x5ac5(_0x5b500b,_0x5eecb8){const _0x5b4f8f=_0x5b4f();return _0x5ac5=function(_0x5ac56d,_0x5d7701){_0x5ac56d=_0x5ac56d-0x131;let _0x39f105=_0x5b4f8f[_0x5ac56d];return _0x39f105;},_0x5ac5(_0x5b500b,_0x5eecb8);}var __decorate=this&&this[_0x1a5b5f(0x162)]||function(_0x22bffe,_0x186e9c,_0x5a89a5,_0x46faa9){const _0x3e6c8b=_0x1a5b5f;var _0x317c1f=arguments[_0x3e6c8b(0x14d)],_0x2b6627=_0x317c1f<0x3?_0x186e9c:_0x46faa9===null?_0x46faa9=Object[_0x3e6c8b(0x17f)](_0x186e9c,_0x5a89a5):_0x46faa9,_0x44744c;if(typeof Reflect===_0x3e6c8b(0x13c)&&typeof Reflect[_0x3e6c8b(0x14b)]===_0x3e6c8b(0x157))_0x2b6627=Reflect[_0x3e6c8b(0x14b)](_0x22bffe,_0x186e9c,_0x5a89a5,_0x46faa9);else{for(var _0x23d76b=_0x22bffe['length']-0x1;_0x23d76b>=0x0;_0x23d76b--)if(_0x44744c=_0x22bffe[_0x23d76b])_0x2b6627=(_0x317c1f<0x3?_0x44744c(_0x2b6627):_0x317c1f>0x3?_0x44744c(_0x186e9c,_0x5a89a5,_0x2b6627):_0x44744c(_0x186e9c,_0x5a89a5))||_0x2b6627;}return _0x317c1f>0x3&&_0x2b6627&&Object['defineProperty'](_0x186e9c,_0x5a89a5,_0x2b6627),_0x2b6627;},__metadata=this&&this[_0x1a5b5f(0x15f)]||function(_0x2def51,_0x4649e5){const _0x40d2fd=_0x1a5b5f;if(typeof Reflect===_0x40d2fd(0x13c)&&typeof Reflect[_0x40d2fd(0x134)]===_0x40d2fd(0x157))return Reflect[_0x40d2fd(0x134)](_0x2def51,_0x4649e5);},__param=this&&this[_0x1a5b5f(0x13f)]||function(_0x325430,_0x455f02){return function(_0x27bc43,_0x1be012){_0x455f02(_0x27bc43,_0x1be012,_0x325430);};};Object[_0x1a5b5f(0x13a)](exports,'__esModule',{'value':!![]}),exports[_0x1a5b5f(0x137)]=void 0x0;const globalConfig_service_1=require(_0x1a5b5f(0x138)),userBalance_service_1=require(_0x1a5b5f(0x147)),common_1=require(_0x1a5b5f(0x176)),signIn_entity_1=require(_0x1a5b5f(0x154)),typeorm_1=require(_0x1a5b5f(0x16c)),typeorm_2=require('typeorm'),date_1=require(_0x1a5b5f(0x14f)),user_entity_1=require(_0x1a5b5f(0x143)),balance_constant_1=require(_0x1a5b5f(0x155));let SigninService=class SigninService{constructor(_0x1080dd,_0x45fcd0,_0x58176b,_0x7e8283){const _0x513d83=_0x1a5b5f;this['signinEntity']=_0x1080dd,this[_0x513d83(0x156)]=_0x45fcd0,this[_0x513d83(0x158)]=_0x58176b,this[_0x513d83(0x15c)]=_0x7e8283;}async[_0x1a5b5f(0x141)](_0x3abeaf){const _0x312efc=_0x1a5b5f,{id:_0x2b95ec}=_0x3abeaf[_0x312efc(0x167)],_0x12972c=(0x0,date_1[_0x312efc(0x140)])(new Date())['format'](_0x312efc(0x135)),_0x2e2486=await this[_0x312efc(0x180)][_0x312efc(0x151)]({'where':{'userId':_0x2b95ec,'signInDate':_0x12972c}});if(_0x2e2486)throw new common_1['HttpException'](_0x312efc(0x173),common_1[_0x312efc(0x170)]['BAD_REQUEST']);const {model3Count:_0xd1c95f,model4Count:_0xf316c5,drawMjCount:_0x46ffd0}=await this[_0x312efc(0x15c)][_0x312efc(0x16b)]();await this['signinEntity'][_0x312efc(0x16e)]({'userId':_0x2b95ec,'signInTime':new Date(),'signInDate':_0x12972c,'isSigned':!![]}),await this[_0x312efc(0x158)][_0x312efc(0x17d)](_0x2b95ec,{'model3Count':_0xd1c95f,'model4Count':_0xf316c5,'drawMjCount':_0x46ffd0}),await this[_0x312efc(0x158)]['saveRecordRechargeLog']({'userId':_0x2b95ec,'rechargeType':balance_constant_1[_0x312efc(0x136)][_0x312efc(0x132)],'model3Count':_0xd1c95f,'model4Count':_0xf316c5,'drawMjCount':_0x46ffd0});const _0x1f7944=(0x0,date_1[_0x312efc(0x140)])(new Date())[_0x312efc(0x174)](0x1,_0x312efc(0x13d))[_0x312efc(0x175)](_0x312efc(0x135)),_0x3af5b3=await this[_0x312efc(0x180)][_0x312efc(0x151)]({'where':{'userId':_0x2b95ec,'signInDate':_0x1f7944}});if(_0x3af5b3){common_1[_0x312efc(0x168)][_0x312efc(0x17a)]('用户'+_0x2b95ec+_0x312efc(0x160),'SigninService');const _0x155930=await this[_0x312efc(0x156)][_0x312efc(0x151)]({'where':{'id':_0x2b95ec}});if(!_0x155930)throw new common_1[(_0x312efc(0x163))](_0x312efc(0x17e),common_1[_0x312efc(0x170)][_0x312efc(0x16a)]);const {consecutiveDays:consecutiveDays=0x0}=_0x155930;await this[_0x312efc(0x156)][_0x312efc(0x17c)]({'id':_0x2b95ec},{'consecutiveDays':consecutiveDays+0x1});}else common_1[_0x312efc(0x168)]['debug']('用户'+_0x2b95ec+_0x312efc(0x13b),'SigninService'),await this[_0x312efc(0x156)][_0x312efc(0x17c)]({'id':_0x2b95ec},{'consecutiveDays':0x1});return _0x312efc(0x14a);}async[_0x1a5b5f(0x152)](_0x5577b8){const _0x242672=_0x1a5b5f;try{const {id:_0x342cab}=_0x5577b8[_0x242672(0x167)],_0x3e4996=(0x0,date_1[_0x242672(0x140)])()['startOf'](_0x242672(0x13e))['format']('YYYY-MM-DD\x20HH:mm:ss'),_0x154223=(0x0,date_1['default'])()['endOf'](_0x242672(0x13e))['format']('YYYY-MM-DD\x20HH:mm:ss'),_0x160cd6=this['signinEntity'][_0x242672(0x133)]('signin'),_0x5b379b=await _0x160cd6[_0x242672(0x178)](_0x242672(0x16d))[_0x242672(0x14e)]('signin.userId\x20=\x20:userId',{'userId':_0x5577b8[_0x242672(0x167)]['id']})[_0x242672(0x14e)](_0x242672(0x179),{'firstDay':_0x3e4996})[_0x242672(0x14e)](_0x242672(0x181),{'lastDay':_0x154223})[_0x242672(0x169)](),_0x172348=new Date(_0x3e4996),_0x14dd57=new Date(_0x154223),_0x571cc5=[],_0xacfb40=new Date(_0x172348);while(_0xacfb40<=_0x14dd57){_0x571cc5[_0x242672(0x146)]((0x0,date_1[_0x242672(0x140)])(new Date(_0xacfb40))[_0x242672(0x175)](_0x242672(0x135))),_0xacfb40[_0x242672(0x131)](_0xacfb40[_0x242672(0x161)]()+0x1);}const _0x409788=[];for(const _0x2d83e6 of _0x571cc5){const _0x42c261=_0x5b379b[_0x242672(0x15d)](_0x123c53=>_0x123c53[_0x242672(0x153)]===_0x2d83e6);!_0x42c261?_0x409788[_0x242672(0x146)]({'signInDate':_0x2d83e6,'isSigned':![]}):(_0x42c261['isSigned']=!![],_0x409788['push'](_0x42c261));}return _0x409788;}catch(_0x5b63af){console['log'](_0x242672(0x15a),_0x5b63af);throw new common_1[(_0x242672(0x163))]('获取签到数据失败！',common_1['HttpStatus']['BAD_REQUEST']);}}};function _0x5b4f(){const _0x575ff4=['RechargeType','SigninService','./../globalConfig/globalConfig.service','575464iQMEZE','defineProperty','昨天没签到、今天重置天数！','object','day','month','__param','default','sign','180GVNknK','../user/user.entity','16098yKOouk','Repository','push','./../userBalance/userBalance.service','98656SnmXsk','InjectRepository','Sign\x20in\x20successful.','decorate','5052gwqQkO','length','andWhere','../../common/utils/date','39677FUplzu','findOne','getSigninLog','signInDate','./signIn.entity','../../common/constants/balance.constant','userEntity','function','userBalanceService','36263ATIYDN','error:\x20','185dloevl','globalConfigService','find','6AlPMcj','__metadata','昨天签到了、今天是连续签到！','getDate','__decorate','HttpException','4771AKmaZf','380124BlJTSV','SigninEntity','user','Logger','getRawMany','BAD_REQUEST','getSignatureGiftConfig','@nestjs/typeorm','signin.signInDate\x20as\x20signInDate,\x20signin.isSigned\x20as\x20isSigned','save','3QPqHaN','HttpStatus','UserBalanceService','GlobalConfigService','今日已签到、改天再来吧!.','subtract','format','@nestjs/common','49epNcXc','select','signin.signInTime\x20>=\x20:firstDay','debug','UserEntity','update','addBalanceToUser','用户不存在','getOwnPropertyDescriptor','signinEntity','signin.signInTime\x20<=\x20:lastDay','setDate','SIGN_IN','createQueryBuilder','metadata','YYYY-MM-DD'];_0x5b4f=function(){return _0x575ff4;};return _0x5b4f();}SigninService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x1a5b5f(0x149)])(signIn_entity_1[_0x1a5b5f(0x166)])),__param(0x1,(0x0,typeorm_1[_0x1a5b5f(0x149)])(user_entity_1[_0x1a5b5f(0x17b)])),__metadata('design:paramtypes',[typeorm_2[_0x1a5b5f(0x145)],typeorm_2[_0x1a5b5f(0x145)],userBalance_service_1[_0x1a5b5f(0x171)],globalConfig_service_1[_0x1a5b5f(0x172)]])],SigninService),exports[_0x1a5b5f(0x137)]=SigninService;