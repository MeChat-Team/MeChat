'use strict';const _0x1a6740=_0x391a;function _0x391a(_0x14e175,_0x5b74fb){const _0x1936b4=_0x1936();return _0x391a=function(_0x391a55,_0x3f2ea4){_0x391a55=_0x391a55-0x1c7;let _0xb8bf0d=_0x1936b4[_0x391a55];return _0xb8bf0d;},_0x391a(_0x14e175,_0x5b74fb);}(function(_0x5af016,_0x4cc417){const _0x3378c4=_0x391a,_0x392695=_0x5af016();while(!![]){try{const _0x1fc0c9=parseInt(_0x3378c4(0x221))/0x1+parseInt(_0x3378c4(0x1cd))/0x2*(-parseInt(_0x3378c4(0x21d))/0x3)+parseInt(_0x3378c4(0x1d2))/0x4+parseInt(_0x3378c4(0x211))/0x5*(-parseInt(_0x3378c4(0x1e0))/0x6)+parseInt(_0x3378c4(0x228))/0x7*(-parseInt(_0x3378c4(0x248))/0x8)+parseInt(_0x3378c4(0x1e9))/0x9*(parseInt(_0x3378c4(0x209))/0xa)+parseInt(_0x3378c4(0x26a))/0xb*(parseInt(_0x3378c4(0x1ea))/0xc);if(_0x1fc0c9===_0x4cc417)break;else _0x392695['push'](_0x392695['shift']());}catch(_0x793e11){_0x392695['push'](_0x392695['shift']());}}}(_0x1936,0xd7a1e));var __decorate=this&&this[_0x1a6740(0x219)]||function(_0x515d22,_0x418cac,_0x3df18a,_0x14e695){const _0x415650=_0x1a6740;var _0x50fb6d=arguments[_0x415650(0x24a)],_0x38dd4d=_0x50fb6d<0x3?_0x418cac:_0x14e695===null?_0x14e695=Object[_0x415650(0x1f8)](_0x418cac,_0x3df18a):_0x14e695,_0x185b84;if(typeof Reflect===_0x415650(0x1f4)&&typeof Reflect['decorate']===_0x415650(0x235))_0x38dd4d=Reflect[_0x415650(0x24e)](_0x515d22,_0x418cac,_0x3df18a,_0x14e695);else{for(var _0x38befe=_0x515d22['length']-0x1;_0x38befe>=0x0;_0x38befe--)if(_0x185b84=_0x515d22[_0x38befe])_0x38dd4d=(_0x50fb6d<0x3?_0x185b84(_0x38dd4d):_0x50fb6d>0x3?_0x185b84(_0x418cac,_0x3df18a,_0x38dd4d):_0x185b84(_0x418cac,_0x3df18a))||_0x38dd4d;}return _0x50fb6d>0x3&&_0x38dd4d&&Object[_0x415650(0x246)](_0x418cac,_0x3df18a,_0x38dd4d),_0x38dd4d;},__metadata=this&&this[_0x1a6740(0x233)]||function(_0xdacdcb,_0x2efe1a){const _0x544b13=_0x1a6740;if(typeof Reflect===_0x544b13(0x1f4)&&typeof Reflect[_0x544b13(0x1f3)]===_0x544b13(0x235))return Reflect[_0x544b13(0x1f3)](_0xdacdcb,_0x2efe1a);},__param=this&&this[_0x1a6740(0x22e)]||function(_0x4bed17,_0x542e5c){return function(_0x2f2fd2,_0x533f5b){_0x542e5c(_0x2f2fd2,_0x533f5b,_0x4bed17);};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports['UserBalanceService']=void 0x0;function _0x1936(){const _0x159e9c=['username','count','balanceEntity','请完成实名认证','headers','add','hideString','packageId','createBaseUserBalance','PAYMENT_REQUIRED','9438nMuRnC','积分不足，继续体验服务，请按需选购套餐！','充值失败','查询用户账户信息失败！','缺失当前用户账户记录！','accountLogEntity','phone','chatGroupEntity','充值的工单信息:','7245297KjMWyH','20479176vOBDZD','status','YYYY-MM-DD','visitorMJNum','LessThan','今日体验额度使用完毕，请注册使用完整服务！','useModel4Token','RechargeType','@nestjs/typeorm','metadata','object','replace','days','useDrawMjToken','getOwnPropertyDescriptor','affected','firstRegisterSendRank','visitorModel4Num','YYYY-MM-DD\x20HH:mm:ss','useModel4Count','缺失当前套餐ID、充值失败！','../../common/utils','../user/user.entity','drawMjCount','memberModel4Count','sumDrawMjCount','globalConfigService','format','../../common/utils/date','weight','getVisitorCount','20hBDEjd','registerSendStatus','AccountLogEntity','addBalanceToUser','GlobalConfigService','expirationTime','user','HttpStatus','4265ihQwEV','find','goodsId','非法操作、当前充值套餐暂不存在！','userEntity','请完成手机号绑定','memberModel3Count','ChatLogEntity','__decorate','BAD_REQUEST','day','saveRecordRechargeLog','15eAsZcs','ConfigEntity','../chatGroup/chatGroup.entity','Count','445693QieASH','mjDraw','findAndCount','fingerprintLogEntity','./accountLog.entity','./balance.entity','updatedAt','758751fcFEyh','InjectRepository','isInteger','./userBalance.entity','chatLogEntity','avatar','__param','注册赠送失败,请联系管理员！','firstRregisterSendDrawMjCount','../../common/constants/balance.constant','formatCreateOrUpdateDate','__metadata','validateBalance','function','REG_GIFT','BalanceEntity','UserEntity','ChatGroupEntity','default','openIdentity','firstRregisterSendModel4Count','identityVerificationMessageCount','getMonth','memberDrawMjCount','inheritVisitorData','Token','realName','log','super','idCard','defineProperty','createRandomUid','104vqrHux','userBalanceEntity','length','visitor','FingerprintLogEntity','design:paramtypes','decorate','configEntity','getConfigs','sumModel4Count','phoneValidationMessageCount','./fingerprint.entity','getFullYear','update','queryUserBalance','model4Count','error:\x20','model3Count','当前用户无需创建账户信息！','isUpdatedToday','expireDateCn','deductFromBalance','../globalConfig/config.entity','HttpException','../chatLog/chatLog.entity','Repository','refundMjBalance','查询用户账户失败！','forEach','max','SCAN_PAY','registerSendModel4Count','useModel3Token','firstRegisterSendStatus','11SweTxl','addBalanceToNewUser','findOne','cramiPackageEntity','email','useModel3Count','reduce','103912vaoKSp','用户充值失败！','registerSendDrawMjCount','save','userId','526124yrxERj','configKey','queryUserBalanceByIds','firstRregisterSendModel3Count'];_0x1936=function(){return _0x159e9c;};return _0x1936();}const balance_constant_1=require(_0x1a6740(0x231)),utils_1=require(_0x1a6740(0x1ff)),common_1=require('@nestjs/common'),typeorm_1=require(_0x1a6740(0x1f2)),typeorm_2=require('typeorm'),cramiPackage_entity_1=require('../crami/cramiPackage.entity'),config_entity_1=require(_0x1a6740(0x25e)),globalConfig_service_1=require('./../globalConfig/globalConfig.service'),accountLog_entity_1=require(_0x1a6740(0x225)),balance_entity_1=require(_0x1a6740(0x226)),userBalance_entity_1=require(_0x1a6740(0x22b)),date_1=require(_0x1a6740(0x206)),chatGroup_entity_1=require(_0x1a6740(0x21f)),chatLog_entity_1=require(_0x1a6740(0x260)),user_entity_1=require(_0x1a6740(0x200)),fingerprint_entity_1=require(_0x1a6740(0x253));let UserBalanceService=class UserBalanceService{constructor(_0x471a18,_0x1b02bf,_0x14c78d,_0x269afa,_0x522123,_0x249dcf,_0x367ddf,_0x241bcd,_0x26b258,_0x260f2e){const _0x1b64b6=_0x1a6740;this[_0x1b64b6(0x1d8)]=_0x471a18,this[_0x1b64b6(0x249)]=_0x1b02bf,this[_0x1b64b6(0x1e5)]=_0x14c78d,this[_0x1b64b6(0x1c9)]=_0x269afa,this['configEntity']=_0x522123,this[_0x1b64b6(0x215)]=_0x249dcf,this[_0x1b64b6(0x224)]=_0x367ddf,this['chatGroupEntity']=_0x241bcd,this[_0x1b64b6(0x22c)]=_0x26b258,this[_0x1b64b6(0x204)]=_0x260f2e;}async[_0x1a6740(0x1c7)](_0x441ca0){const _0x1421cf=_0x1a6740;try{const _0x4c5a92=await this[_0x1421cf(0x24f)][_0x1421cf(0x212)]({'where':{'configKey':(0x0,typeorm_2['In'])(['registerSendStatus','registerSendModel3Count',_0x1421cf(0x267),'registerSendDrawMjCount',_0x1421cf(0x269),'firstRegisterSendRank',_0x1421cf(0x1d5),_0x1421cf(0x23c),_0x1421cf(0x230)])}}),_0x4f12be=_0x4c5a92[_0x1421cf(0x1cc)]((_0x324f32,_0x41640a)=>{const _0x59e597=_0x1421cf,_0x482bef=Number(_0x41640a['configVal']),_0x487e80=Number[_0x59e597(0x22a)](_0x482bef)&&_0x482bef>0x0?_0x482bef:0x0;return _0x324f32[_0x41640a[_0x59e597(0x1d3)]]=_0x487e80,_0x324f32;},{});let _0x381545=0x0,_0x51ca9f=0x0,_0x3ef28f=0x0;_0x4f12be[_0x1421cf(0x20a)]===0x1&&(_0x381545=_0x381545+_0x4f12be['registerSendModel3Count'],_0x51ca9f=_0x51ca9f+_0x4f12be[_0x1421cf(0x267)],_0x3ef28f=_0x3ef28f+_0x4f12be[_0x1421cf(0x1cf)]),_0x4f12be[_0x1421cf(0x20a)]===0x1&&_0x4f12be[_0x1421cf(0x269)]===0x1&&_0x441ca0<=_0x4f12be[_0x1421cf(0x1fa)]&&(_0x381545=_0x381545+_0x4f12be[_0x1421cf(0x1d5)],_0x51ca9f=_0x51ca9f+_0x4f12be[_0x1421cf(0x23c)],_0x3ef28f=_0x3ef28f+_0x4f12be[_0x1421cf(0x230)]),await this[_0x1421cf(0x21c)]({'userId':_0x441ca0,'rechargeType':balance_constant_1['RechargeType'][_0x1421cf(0x236)],'model3Count':_0x381545,'drawMjCount':_0x3ef28f,'model4Count':_0x51ca9f}),await this[_0x1421cf(0x249)][_0x1421cf(0x1d0)]({'userId':_0x441ca0,'model3Count':_0x381545,'model4Count':_0x51ca9f,'drawMjCount':_0x3ef28f,'useTokens':0x0});}catch(_0x2a0c37){console[_0x1421cf(0x243)](_0x1421cf(0x258),_0x2a0c37);throw new common_1[(_0x1421cf(0x25f))](_0x1421cf(0x22f),common_1[_0x1421cf(0x210)]['BAD_REQUEST']);}}async[_0x1a6740(0x234)](_0x29db50,_0x11ecf4,_0x24c685){const _0x130fbc=_0x1a6740,{id:_0x63dde1,role:_0x5061b9}=_0x29db50['user'];let _0x307913=await this[_0x130fbc(0x249)][_0x130fbc(0x1c8)]({'where':{'userId':_0x63dde1}});!_0x307913&&(_0x307913=await this['createBaseUserBalance'](_0x63dde1));if(_0x5061b9===_0x130fbc(0x24b))return this['validateVisitorBalance'](_0x29db50,_0x11ecf4,_0x24c685);const _0x21fa6a=_0x11ecf4===0x1?_0x130fbc(0x217):_0x11ecf4===0x2?_0x130fbc(0x202):_0x11ecf4===0x3?_0x130fbc(0x23f):null,_0x1cefbc=_0x11ecf4===0x1?_0x130fbc(0x259):_0x11ecf4===0x2?_0x130fbc(0x257):_0x11ecf4===0x3?'drawMjCount':null;if(_0x307913[_0x130fbc(0x1dd)]&&_0x307913[_0x21fa6a]+_0x307913[_0x1cefbc]<_0x24c685){if(_0x307913[_0x1cefbc]<_0x24c685)throw new common_1['HttpException']('积分不足，继续体验服务，请按需选购套餐！',common_1[_0x130fbc(0x210)][_0x130fbc(0x1df)]);}if(!_0x307913[_0x130fbc(0x1dd)]&&_0x307913[_0x1cefbc]<_0x24c685)throw new common_1[(_0x130fbc(0x25f))](_0x130fbc(0x1e1),common_1[_0x130fbc(0x210)][_0x130fbc(0x1df)]);return _0x307913;}async['validateVisitorBalance'](_0x31e31b,_0xeabe0d,_0x21585a){const _0x17fec8=_0x1a6740,{id:_0x214335}=_0x31e31b[_0x17fec8(0x20f)],_0x59b7e3=_0xeabe0d===0x1?_0x17fec8(0x259):_0xeabe0d===0x2?'model4Count':_0xeabe0d===0x3?'drawMjCount':null,_0x4d5c0d=new Date(),_0xe09d02=await this[_0x17fec8(0x224)][_0x17fec8(0x1c8)]({'where':{'fingerprint':_0x214335}}),{visitorModel3Num:_0x2efb64,visitorModel4Num:_0x84fcbb,visitorMJNum:_0xfded14}=await this[_0x17fec8(0x204)]['getConfigs'](['visitorModel3Num',_0x17fec8(0x1fb),_0x17fec8(0x1ed)]),_0xb1b593={'model3Count':_0x2efb64?Number(_0x2efb64):0x0,'model4Count':_0x84fcbb?Number(_0x84fcbb):0x0,'drawMjCount':_0xfded14?Number(_0xfded14):0x0};if(!_0xe09d02){let _0xb86e56={'fingerprint':_0x214335,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0};_0xb86e56[_0x59b7e3]=_0xb86e56[_0x59b7e3]+_0x21585a;if(_0xb86e56[_0x59b7e3]>_0xb1b593[_0x59b7e3])throw new common_1['HttpException'](_0x17fec8(0x1ef),common_1[_0x17fec8(0x210)][_0x17fec8(0x1df)]);else return await this[_0x17fec8(0x224)][_0x17fec8(0x1d0)](_0xb86e56),!![];}else{const {model3Count:_0x2d669a,model4Count:_0x23a76a,drawMjCount:_0x5a1811}=_0xe09d02;let _0x401789={'model3Count':_0x2d669a,'model4Count':_0x23a76a,'drawMjCount':_0x5a1811};const _0x13de70=Number(new Date(_0xe09d02[_0x17fec8(0x227)])),_0x43cd2c=this[_0x17fec8(0x25b)](_0x13de70);_0x43cd2c?_0x401789[_0x59b7e3]=_0x401789[_0x59b7e3]+_0x21585a:(_0x401789={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x401789[_0x59b7e3]=_0x401789[_0x59b7e3]+_0x21585a);if(_0x401789[_0x59b7e3]>_0xb1b593[_0x59b7e3])throw new common_1[(_0x17fec8(0x25f))](_0x17fec8(0x1ef),common_1[_0x17fec8(0x210)][_0x17fec8(0x1df)]);else return await this['fingerprintLogEntity'][_0x17fec8(0x255)]({'fingerprint':_0x214335},_0x401789),!![];}}[_0x1a6740(0x25b)](_0x26341c){const _0x4b80b0=_0x1a6740,_0x15e0be=new Date(),_0x53c13c=new Date(_0x15e0be[_0x4b80b0(0x254)](),_0x15e0be[_0x4b80b0(0x23e)](),_0x15e0be['getDate']());return _0x26341c>=_0x53c13c;}async[_0x1a6740(0x25d)](_0x2004f1,_0x3477be,_0x2cbcd3,_0x6cdc47=0x0){const _0x319e21=_0x1a6740,_0x4c5e40=await this['userBalanceEntity']['findOne']({'where':{'userId':_0x2004f1}});if(!_0x4c5e40)throw new common_1[(_0x319e21(0x25f))](_0x319e21(0x1e4),common_1[_0x319e21(0x210)][_0x319e21(0x21a)]);const _0xd9a68e={0x1:{'member':_0x319e21(0x217),'nonMember':_0x319e21(0x259),'token':_0x319e21(0x268)},0x2:{'member':_0x319e21(0x202),'nonMember':_0x319e21(0x257),'token':_0x319e21(0x1f0)},0x3:{'member':'memberDrawMjCount','nonMember':_0x319e21(0x201),'token':_0x319e21(0x1f7)}},{member:_0xb97408,nonMember:_0xca0b01,token:_0x53beb5}=_0xd9a68e[_0x3477be];let _0x3dceac=_0x2cbcd3,_0x557487=Math['max'](_0x4c5e40[_0xb97408]-_0x3dceac,0x0);_0x3dceac-=_0x4c5e40[_0xb97408]-_0x557487;let _0x2b4f5e=_0x4c5e40[_0xca0b01];_0x3dceac>0x0&&(_0x2b4f5e=Math[_0x319e21(0x265)](_0x4c5e40[_0xca0b01]-_0x3dceac,0x0),_0x3dceac-=_0x4c5e40[_0xca0b01]-_0x2b4f5e);const _0x4db208={[_0xb97408]:_0x557487,[_0xca0b01]:_0x2b4f5e,[_0x53beb5]:(_0x4c5e40[_0x53beb5]||0x0)+_0x6cdc47};(_0x53beb5===_0x319e21(0x268)||_0x53beb5===_0x319e21(0x1f0))&&(_0x4db208[_0x53beb5[_0x319e21(0x1f5)](_0x319e21(0x241),_0x319e21(0x220))]=(_0x4c5e40[_0x53beb5[_0x319e21(0x1f5)](_0x319e21(0x241),_0x319e21(0x220))]||0x0)+_0x2cbcd3);const _0x23696f=await this[_0x319e21(0x249)]['update']({'userId':_0x2004f1},_0x4db208);if(_0x23696f[_0x319e21(0x1f9)]===0x0)throw new common_1['HttpException']('消费余额失败！',common_1[_0x319e21(0x210)][_0x319e21(0x21a)]);}async[_0x1a6740(0x256)](_0x11687b){const _0x29e23f=_0x1a6740;try{const _0x243cae=await this[_0x29e23f(0x249)][_0x29e23f(0x1c8)]({'where':{'userId':_0x11687b},'select':['packageId','model3Count','model4Count',_0x29e23f(0x201),_0x29e23f(0x217),_0x29e23f(0x202),_0x29e23f(0x23f),_0x29e23f(0x1cb),_0x29e23f(0x1fd),_0x29e23f(0x268),_0x29e23f(0x1f0),_0x29e23f(0x1f7),_0x29e23f(0x20e)]});if(!_0x243cae){const _0x31fb6f=await this[_0x29e23f(0x1de)](_0x11687b);if(_0x31fb6f)return await this[_0x29e23f(0x256)](_0x11687b);else throw new common_1[(_0x29e23f(0x25f))]('查询当前用户余额失败！',common_1[_0x29e23f(0x210)][_0x29e23f(0x21a)]);}return _0x243cae['sumModel3Count']=_0x243cae[_0x29e23f(0x1dd)]?_0x243cae['model3Count']+_0x243cae[_0x29e23f(0x217)]:_0x243cae['model3Count'],_0x243cae[_0x29e23f(0x251)]=_0x243cae[_0x29e23f(0x1dd)]?_0x243cae[_0x29e23f(0x257)]+_0x243cae[_0x29e23f(0x202)]:_0x243cae[_0x29e23f(0x257)],_0x243cae[_0x29e23f(0x203)]=_0x243cae[_0x29e23f(0x1dd)]?_0x243cae['drawMjCount']+_0x243cae[_0x29e23f(0x23f)]:_0x243cae[_0x29e23f(0x201)],_0x243cae[_0x29e23f(0x20e)]=_0x243cae[_0x29e23f(0x20e)]?(0x0,date_1['formatDate'])(_0x243cae['expirationTime'],_0x29e23f(0x1ec)):null,_0x243cae;}catch(_0x23f8ef){console[_0x29e23f(0x243)](_0x29e23f(0x258),_0x23f8ef);}}async['saveRecordRechargeLog'](_0x1dcd73){const _0x555d9f=_0x1a6740,{userId:_0x1b2fd7,rechargeType:_0x48ad1a,model3Count:_0xf9dc97,model4Count:_0x287cc1,drawMjCount:_0x221145,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x1dcd73;if(!_0x1b2fd7)throw new common_1['HttpException']('当前用户不存在,记录充值日志异常',common_1['HttpStatus']['BAD_REQUEST']);const _0x5652ac=(0x0,utils_1[_0x555d9f(0x247)])();return await this[_0x555d9f(0x1e5)][_0x555d9f(0x1d0)]({'userId':_0x1b2fd7,'rechargeType':_0x48ad1a,'model3Count':_0xf9dc97,'model4Count':_0x287cc1,'drawMjCount':_0x221145,'days':days,'extent':extent,'uid':_0x5652ac,'pkgName':pkgName});}async[_0x1a6740(0x1de)](_0x17f567,_0x1f1f67={}){const _0x47b6ad=_0x1a6740,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x1f1f67,_0x4fcc3c=await this[_0x47b6ad(0x249)][_0x47b6ad(0x1c8)]({'where':{'userId':_0x17f567}});if(_0x4fcc3c)throw new common_1[(_0x47b6ad(0x25f))](_0x47b6ad(0x25a),common_1[_0x47b6ad(0x210)][_0x47b6ad(0x21a)]);return await this[_0x47b6ad(0x249)][_0x47b6ad(0x1d0)]({'userId':_0x17f567,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async['addBalanceToUser'](_0x449b7d,_0x17e115,_0x2f1884=-0x1){const _0x1f002a=_0x1a6740;try{const _0xa23fa6=await this['userBalanceEntity']['findOne']({'where':{'userId':_0x449b7d}})||await this[_0x1f002a(0x1de)](_0x449b7d);if(!_0xa23fa6)throw new common_1[(_0x1f002a(0x25f))](_0x1f002a(0x1e3),common_1[_0x1f002a(0x210)][_0x1f002a(0x21a)]);const {model3Count:_0x3e3c7b,model4Count:_0x2a8939,drawMjCount:_0x311f2f,memberModel3Count:_0x17d59c,memberModel4Count:_0x5f2370,memberDrawMjCount:_0x34a791}=_0xa23fa6;let _0x893a={};if(_0x2f1884>0x0){const {packageId:_0xc03fc7}=_0x17e115;if(!_0xc03fc7)throw new common_1[(_0x1f002a(0x25f))](_0x1f002a(0x1fe),common_1[_0x1f002a(0x210)][_0x1f002a(0x21a)]);const _0x231cce=await this['cramiPackageEntity'][_0x1f002a(0x1c8)]({'where':{'id':_0xc03fc7}});if(!_0x231cce)throw new common_1[(_0x1f002a(0x25f))]('当前套餐不存在！',common_1[_0x1f002a(0x210)][_0x1f002a(0x21a)]);const {weight:_0x48bc43}=_0x231cce;if(!_0xa23fa6['packageId'])_0x893a={'memberModel3Count':_0x17d59c+_0x17e115[_0x1f002a(0x259)],'memberModel4Count':_0x5f2370+_0x17e115['model4Count'],'memberDrawMjCount':_0x34a791+_0x17e115[_0x1f002a(0x201)],'expirationTime':(0x0,date_1[_0x1f002a(0x23a)])()[_0x1f002a(0x1db)](_0x2f1884>0x0?_0x2f1884:0x0,'day')[_0x1f002a(0x205)](_0x1f002a(0x1fc)),'packageId':_0xc03fc7};else{const _0x165440=await this['cramiPackageEntity'][_0x1f002a(0x1c8)]({'where':{'id':_0xa23fa6[_0x1f002a(0x1dd)]}});_0x48bc43>=_0x165440[_0x1f002a(0x207)]&&(_0x893a={'memberModel3Count':_0x17d59c+_0x17e115[_0x1f002a(0x259)],'memberModel4Count':_0x5f2370+_0x17e115[_0x1f002a(0x257)],'memberDrawMjCount':_0x34a791+_0x17e115['drawMjCount'],'expirationTime':(0x0,date_1['default'])(_0xa23fa6[_0x1f002a(0x20e)])[_0x1f002a(0x1db)](_0x2f1884>0x0?_0x2f1884:0x0,_0x1f002a(0x21b))[_0x1f002a(0x205)]('YYYY-MM-DD\x20HH:mm:ss'),'packageId':_0xc03fc7}),_0x48bc43<_0x165440[_0x1f002a(0x207)]&&(_0x893a={'memberModel3Count':_0x17d59c+_0x17e115[_0x1f002a(0x259)],'memberModel4Count':_0x5f2370+_0x17e115['model4Count'],'memberDrawMjCount':_0x34a791+_0x17e115[_0x1f002a(0x201)]});}}_0x2f1884<=0x0&&(_0x893a={'model3Count':_0x3e3c7b+_0x17e115[_0x1f002a(0x259)],'model4Count':_0x2a8939+_0x17e115[_0x1f002a(0x257)],'drawMjCount':_0x311f2f+_0x17e115[_0x1f002a(0x201)]});const _0x5dca2e=await this[_0x1f002a(0x249)]['update']({'userId':_0x449b7d},_0x893a);if(_0x5dca2e[_0x1f002a(0x1f9)]===0x0)throw new common_1['HttpException'](_0x449b7d+_0x1f002a(0x1e2),common_1[_0x1f002a(0x210)][_0x1f002a(0x21a)]);}catch(_0x642a0a){console[_0x1f002a(0x243)]('error:\x20',_0x642a0a);throw new common_1[(_0x1f002a(0x25f))](_0x1f002a(0x1ce),common_1[_0x1f002a(0x210)]['BAD_REQUEST']);}}async['addBalanceToOrder'](_0x223fce){const _0x4a06d7=_0x1a6740;console[_0x4a06d7(0x243)](_0x4a06d7(0x1e8),_0x223fce);try{const {userId:_0x5b1851,goodsId:_0x187579}=_0x223fce,_0x20ba23=await this['cramiPackageEntity'][_0x4a06d7(0x1c8)]({'where':{'id':_0x223fce[_0x4a06d7(0x213)],'status':0x1}});if(!_0x20ba23)throw new common_1[(_0x4a06d7(0x25f))](_0x4a06d7(0x214),common_1[_0x4a06d7(0x210)][_0x4a06d7(0x21a)]);const {model3Count:_0x3412f9,model4Count:_0x2b265c,drawMjCount:_0x17857d,days:_0x34dfeb,name:_0x5ab5b0}=_0x20ba23,_0x16d771={'model3Count':_0x3412f9,'model4Count':_0x2b265c,'drawMjCount':_0x17857d,'days':_0x34dfeb,'packageId':_0x223fce['goodsId']};await this[_0x4a06d7(0x20c)](_0x5b1851,_0x16d771,_0x34dfeb),await this[_0x4a06d7(0x21c)]({'userId':_0x5b1851,'rechargeType':balance_constant_1[_0x4a06d7(0x1f1)][_0x4a06d7(0x266)],'model3Count':_0x3412f9,'model4Count':_0x2b265c,'drawMjCount':_0x17857d,'pkgName':_0x5ab5b0,'days':_0x34dfeb});}catch(_0x3c016a){console[_0x4a06d7(0x243)](_0x4a06d7(0x258),_0x3c016a);throw new common_1['HttpException']('充值失败！',common_1[_0x4a06d7(0x210)][_0x4a06d7(0x21a)]);}}async['getRechargeLog'](_0x2b1c8b,_0x5863a8){const _0x2fd767=_0x1a6740,{page:page=0x1,size:size=0x14}=_0x5863a8,{id:_0x1bbf67}=_0x2b1c8b['user'],[_0x4f7318,_0x3c261a]=await this[_0x2fd767(0x1e5)][_0x2fd767(0x223)]({'where':{'userId':_0x1bbf67},'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size});return _0x4f7318[_0x2fd767(0x264)](_0x2578e9=>{const _0x5ac5fa=_0x2fd767;_0x2578e9[_0x5ac5fa(0x25c)]=_0x2578e9['days']>0x0?_0x2578e9[_0x5ac5fa(0x1f6)]+'天':'永久';}),{'rows':(0x0,date_1[_0x2fd767(0x232)])(_0x4f7318),'count':_0x3c261a};}async['getAccountLog'](_0x40bf34,_0xc96ac0){const _0x5a1ba1=_0x1a6740;try{const {page:page=0x1,size:size=0xa,userId:_0x5453e7,rechargeType:_0x3a8921,packageId:_0x7b1757}=_0xc96ac0,{role:_0x3e8f2e}=_0x40bf34['user'],_0x3fda09={};_0x3a8921&&(_0x3fda09['rechargeType']=_0x3a8921),_0x3fda09[_0x5a1ba1(0x1d1)]=_0x5453e7||(0x0,typeorm_2[_0x5a1ba1(0x1ee)])(0x186a0),_0x7b1757&&(_0x3fda09[_0x5a1ba1(0x1dd)]={'$like':'%'+_0x7b1757+'%'});const [_0x2c0f05,_0x2befc9]=await this[_0x5a1ba1(0x1e5)][_0x5a1ba1(0x223)]({'where':_0x3fda09,'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size}),_0x27db55=_0x2c0f05['map'](_0x4b375d=>_0x4b375d['userId']),_0x2d79de=await this[_0x5a1ba1(0x215)][_0x5a1ba1(0x212)]({'where':{'id':(0x0,typeorm_2['In'])(_0x27db55)}});return _0x2c0f05[_0x5a1ba1(0x264)](_0x54d0ca=>{const _0x2813ce=_0x5a1ba1,_0x254cc4=_0x2d79de[_0x2813ce(0x212)](_0x3b61a6=>_0x3b61a6['id']===_0x54d0ca[_0x2813ce(0x1d1)]);_0x54d0ca[_0x2813ce(0x1d6)]=_0x254cc4===null||_0x254cc4===void 0x0?void 0x0:_0x254cc4[_0x2813ce(0x1d6)],_0x54d0ca[_0x2813ce(0x1ca)]=_0x254cc4===null||_0x254cc4===void 0x0?void 0x0:_0x254cc4[_0x2813ce(0x1ca)],_0x54d0ca[_0x2813ce(0x1e6)]=_0x254cc4===null||_0x254cc4===void 0x0?void 0x0:_0x254cc4[_0x2813ce(0x1e6)],_0x54d0ca[_0x2813ce(0x1eb)]=_0x254cc4===null||_0x254cc4===void 0x0?void 0x0:_0x254cc4[_0x2813ce(0x1eb)],_0x54d0ca[_0x2813ce(0x22d)]=_0x254cc4===null||_0x254cc4===void 0x0?void 0x0:_0x254cc4[_0x2813ce(0x22d)];}),_0x3e8f2e!==_0x5a1ba1(0x244)&&_0x2c0f05[_0x5a1ba1(0x264)](_0x4ce281=>{const _0x9a7b19=_0x5a1ba1;_0x4ce281[_0x9a7b19(0x1ca)]=_0x4ce281[_0x9a7b19(0x1ca)]?(0x0,utils_1[_0x9a7b19(0x1dc)])(_0x4ce281['email']):'',_0x4ce281[_0x9a7b19(0x1e6)]=_0x4ce281[_0x9a7b19(0x1e6)]?(0x0,utils_1[_0x9a7b19(0x1dc)])(_0x4ce281[_0x9a7b19(0x1e6)]):'';}),{'rows':_0x2c0f05,'count':_0x2befc9};}catch(_0xd3a136){console[_0x5a1ba1(0x243)](_0x5a1ba1(0x258),_0xd3a136);throw new common_1[(_0x5a1ba1(0x25f))](_0x5a1ba1(0x263),common_1[_0x5a1ba1(0x210)][_0x5a1ba1(0x21a)]);}}async[_0x1a6740(0x1d4)](_0x3bb532){return await this['userBalanceEntity']['find']({'where':{'userId':(0x0,typeorm_2['In'])(_0x3bb532)}});}async[_0x1a6740(0x262)](_0x3923ee,_0x38211a){const _0x48660b=_0x1a6740;return await this[_0x48660b(0x25d)](_0x3923ee,_0x48660b(0x222),-_0x38211a);}async[_0x1a6740(0x240)](_0x4433a7){const _0x1ace99=_0x1a6740,{fingerprint:_0x4f16df}=_0x4433a7[_0x1ace99(0x1da)],{id:_0x29a9b5}=_0x4433a7['user'];return await this[_0x1ace99(0x22c)]['update']({'userId':Number(_0x4f16df)},{'userId':_0x29a9b5}),await this['chatGroupEntity'][_0x1ace99(0x255)]({'userId':Number(_0x4f16df)},{'userId':_0x29a9b5}),0x1;}async[_0x1a6740(0x208)](_0x2aef77){const _0x1076ac=_0x1a6740,{fingerprint:_0x42d107}=_0x2aef77[_0x1076ac(0x1da)],_0x500918=await this[_0x1076ac(0x22c)][_0x1076ac(0x1d7)]({'where':{'userId':_0x42d107}}),_0x971941=await this[_0x1076ac(0x1e7)][_0x1076ac(0x1d7)]({'where':{'userId':_0x42d107}});return _0x500918||_0x971941||0x0;}async['checkUserCertification'](_0x242114){const _0x3b1eb7=_0x1a6740,_0x117093=await this[_0x3b1eb7(0x215)][_0x3b1eb7(0x1c8)]({'where':{'id':_0x242114}}),_0x135a25=await this[_0x3b1eb7(0x249)]['findOne']({'where':{'userId':_0x242114}});if(!_0x117093||!_0x135a25)return;const {phoneValidationMessageCount:_0x5bd13b,identityVerificationMessageCount:_0x38c8ad,openIdentity:_0x41de59,openPhoneValidation:_0x2a5e3e}=await this[_0x3b1eb7(0x204)][_0x3b1eb7(0x250)]([_0x3b1eb7(0x252),_0x3b1eb7(0x23d),_0x3b1eb7(0x23b),'openPhoneValidation']),_0x5b5fae=Number(_0x5bd13b),_0xdcd18=Number(_0x38c8ad),_0x1eb8d6=Number(_0x135a25[_0x3b1eb7(0x1cb)])||0x0,_0x42547=Number(_0x135a25['useModel4Count'])||0x0,_0x125e56=_0x1eb8d6+_0x42547;if(_0x2a5e3e==='1'&&_0x125e56>=_0x5b5fae&&!_0x117093[_0x3b1eb7(0x1e6)])throw new common_1['HttpException'](_0x3b1eb7(0x216),common_1[_0x3b1eb7(0x210)]['BAD_REQUEST']);if(_0x41de59==='1'&&_0x125e56>=_0xdcd18&&(!_0x117093[_0x3b1eb7(0x242)]||!_0x117093[_0x3b1eb7(0x245)]))throw new common_1[(_0x3b1eb7(0x25f))](_0x3b1eb7(0x1d9),common_1[_0x3b1eb7(0x210)]['BAD_REQUEST']);}};UserBalanceService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x1a6740(0x229)])(balance_entity_1[_0x1a6740(0x237)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(userBalance_entity_1['UserBalanceEntity'])),__param(0x2,(0x0,typeorm_1[_0x1a6740(0x229)])(accountLog_entity_1[_0x1a6740(0x20b)])),__param(0x3,(0x0,typeorm_1['InjectRepository'])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x4,(0x0,typeorm_1[_0x1a6740(0x229)])(config_entity_1[_0x1a6740(0x21e)])),__param(0x5,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x1a6740(0x238)])),__param(0x6,(0x0,typeorm_1[_0x1a6740(0x229)])(fingerprint_entity_1[_0x1a6740(0x24c)])),__param(0x7,(0x0,typeorm_1[_0x1a6740(0x229)])(chatGroup_entity_1[_0x1a6740(0x239)])),__param(0x8,(0x0,typeorm_1[_0x1a6740(0x229)])(chatLog_entity_1[_0x1a6740(0x218)])),__metadata(_0x1a6740(0x24d),[typeorm_2[_0x1a6740(0x261)],typeorm_2[_0x1a6740(0x261)],typeorm_2['Repository'],typeorm_2[_0x1a6740(0x261)],typeorm_2[_0x1a6740(0x261)],typeorm_2[_0x1a6740(0x261)],typeorm_2[_0x1a6740(0x261)],typeorm_2[_0x1a6740(0x261)],typeorm_2[_0x1a6740(0x261)],globalConfig_service_1[_0x1a6740(0x20d)]])],UserBalanceService),exports['UserBalanceService']=UserBalanceService;