'use strict';const _0x3afc7e=_0x3e44;(function(_0x311446,_0x4b3ee5){const _0x247716=_0x3e44,_0x1f35b0=_0x311446();while(!![]){try{const _0x2b4667=-parseInt(_0x247716(0x83))/0x1*(parseInt(_0x247716(0xd3))/0x2)+-parseInt(_0x247716(0xbf))/0x3*(parseInt(_0x247716(0xa9))/0x4)+parseInt(_0x247716(0xf5))/0x5*(parseInt(_0x247716(0x108))/0x6)+-parseInt(_0x247716(0x74))/0x7*(parseInt(_0x247716(0x98))/0x8)+-parseInt(_0x247716(0xf1))/0x9+parseInt(_0x247716(0xcc))/0xa+parseInt(_0x247716(0xff))/0xb*(parseInt(_0x247716(0x82))/0xc);if(_0x2b4667===_0x4b3ee5)break;else _0x1f35b0['push'](_0x1f35b0['shift']());}catch(_0x2d6e36){_0x1f35b0['push'](_0x1f35b0['shift']());}}}(_0x4858,0x880c7));var __decorate=this&&this[_0x3afc7e(0x8b)]||function(_0x5da8c9,_0x274c31,_0x1d290a,_0x26cc7b){const _0x556065=_0x3afc7e;var _0x337db4=arguments['length'],_0x39bfcc=_0x337db4<0x3?_0x274c31:_0x26cc7b===null?_0x26cc7b=Object['getOwnPropertyDescriptor'](_0x274c31,_0x1d290a):_0x26cc7b,_0x3dd8c7;if(typeof Reflect==='object'&&typeof Reflect[_0x556065(0x9e)]===_0x556065(0xd2))_0x39bfcc=Reflect[_0x556065(0x9e)](_0x5da8c9,_0x274c31,_0x1d290a,_0x26cc7b);else{for(var _0x4aada8=_0x5da8c9[_0x556065(0xfd)]-0x1;_0x4aada8>=0x0;_0x4aada8--)if(_0x3dd8c7=_0x5da8c9[_0x4aada8])_0x39bfcc=(_0x337db4<0x3?_0x3dd8c7(_0x39bfcc):_0x337db4>0x3?_0x3dd8c7(_0x274c31,_0x1d290a,_0x39bfcc):_0x3dd8c7(_0x274c31,_0x1d290a))||_0x39bfcc;}return _0x337db4>0x3&&_0x39bfcc&&Object[_0x556065(0x10a)](_0x274c31,_0x1d290a,_0x39bfcc),_0x39bfcc;},__metadata=this&&this[_0x3afc7e(0x7a)]||function(_0x2afc47,_0x4bd010){const _0x539792=_0x3afc7e;if(typeof Reflect===_0x539792(0xe4)&&typeof Reflect[_0x539792(0xea)]==='function')return Reflect[_0x539792(0xea)](_0x2afc47,_0x4bd010);},__param=this&&this[_0x3afc7e(0xab)]||function(_0x30c171,_0x59dba8){return function(_0x54ccd8,_0x1201be){_0x59dba8(_0x54ccd8,_0x1201be,_0x30c171);};};Object[_0x3afc7e(0x10a)](exports,_0x3afc7e(0xbb),{'value':!![]}),exports['UserBalanceService']=void 0x0;const balance_constant_1=require('../../common/constants/balance.constant'),utils_1=require(_0x3afc7e(0xd9)),common_1=require('@nestjs/common'),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require('typeorm'),cramiPackage_entity_1=require(_0x3afc7e(0xd0)),config_entity_1=require(_0x3afc7e(0x10e)),globalConfig_service_1=require('./../globalConfig/globalConfig.service'),accountLog_entity_1=require(_0x3afc7e(0x89)),balance_entity_1=require('./balance.entity'),userBalance_entity_1=require(_0x3afc7e(0xf7)),date_1=require(_0x3afc7e(0x6e)),chatGroup_entity_1=require(_0x3afc7e(0x107)),chatLog_entity_1=require(_0x3afc7e(0xa2)),user_entity_1=require(_0x3afc7e(0xe8)),fingerprint_entity_1=require(_0x3afc7e(0xc8));function _0x3e44(_0x377fc2,_0x3c666b){const _0x48585b=_0x4858();return _0x3e44=function(_0x3e44a6,_0x2739d8){_0x3e44a6=_0x3e44a6-0x6c;let _0x26d39c=_0x48585b[_0x3e44a6];return _0x26d39c;},_0x3e44(_0x377fc2,_0x3c666b);}let UserBalanceService=class UserBalanceService{constructor(_0x31aec9,_0x3d0a3d,_0x1fd905,_0x2951e1,_0x46c92d,_0x2f8060,_0x183a44,_0x77aa30,_0x431e8b,_0x4f78ea){const _0x1ba48b=_0x3afc7e;this[_0x1ba48b(0xf8)]=_0x31aec9,this[_0x1ba48b(0xeb)]=_0x3d0a3d,this[_0x1ba48b(0xc3)]=_0x1fd905,this[_0x1ba48b(0xdc)]=_0x2951e1,this['configEntity']=_0x46c92d,this[_0x1ba48b(0xef)]=_0x2f8060,this[_0x1ba48b(0x76)]=_0x183a44,this[_0x1ba48b(0xd4)]=_0x77aa30,this[_0x1ba48b(0xf0)]=_0x431e8b,this[_0x1ba48b(0xaa)]=_0x4f78ea;}async[_0x3afc7e(0x105)](_0x186809){const _0x47dae7=_0x3afc7e;try{const _0x15dd55=await this[_0x47dae7(0xd8)][_0x47dae7(0xdf)]({'where':{'configKey':(0x0,typeorm_2['In'])(['registerSendStatus',_0x47dae7(0xed),_0x47dae7(0x77),_0x47dae7(0x102),_0x47dae7(0x7f),'firstRegisterSendRank','firstRregisterSendModel3Count',_0x47dae7(0x7e),_0x47dae7(0xb5)])}}),_0x398493=_0x15dd55[_0x47dae7(0xa5)]((_0xfe5e54,_0x4eae13)=>{const _0x1ec640=_0x47dae7,_0x14531f=Number(_0x4eae13[_0x1ec640(0xe7)]),_0x5a3bf7=Number['isInteger'](_0x14531f)&&_0x14531f>0x0?_0x14531f:0x0;return _0xfe5e54[_0x4eae13[_0x1ec640(0x109)]]=_0x5a3bf7,_0xfe5e54;},{});let _0x53ce69=0x0,_0x21f5ea=0x0,_0x2e9504=0x0;_0x398493[_0x47dae7(0x8e)]===0x1&&(_0x53ce69=_0x53ce69+_0x398493[_0x47dae7(0xed)],_0x21f5ea=_0x21f5ea+_0x398493[_0x47dae7(0x77)],_0x2e9504=_0x2e9504+_0x398493[_0x47dae7(0x102)]),_0x398493[_0x47dae7(0x8e)]===0x1&&_0x398493['firstRegisterSendStatus']===0x1&&_0x186809<=_0x398493['firstRegisterSendRank']&&(_0x53ce69=_0x53ce69+_0x398493[_0x47dae7(0xa6)],_0x21f5ea=_0x21f5ea+_0x398493['firstRregisterSendModel4Count'],_0x2e9504=_0x2e9504+_0x398493[_0x47dae7(0xb5)]),await this['saveRecordRechargeLog']({'userId':_0x186809,'rechargeType':balance_constant_1['RechargeType'][_0x47dae7(0xbd)],'model3Count':_0x53ce69,'drawMjCount':_0x2e9504,'model4Count':_0x21f5ea}),await this[_0x47dae7(0xeb)][_0x47dae7(0xc1)]({'userId':_0x186809,'model3Count':_0x53ce69,'model4Count':_0x21f5ea,'drawMjCount':_0x2e9504,'useTokens':0x0});}catch(_0x1bca51){console[_0x47dae7(0x10d)](_0x47dae7(0xae),_0x1bca51);throw new common_1[(_0x47dae7(0xfc))](_0x47dae7(0x10c),common_1[_0x47dae7(0x8c)]['BAD_REQUEST']);}}async[_0x3afc7e(0x95)](_0x5505b6,_0x349f90,_0xceddc5){const _0x42b9b2=_0x3afc7e,{id:_0x28ff08,role:_0x1a48e4}=_0x5505b6[_0x42b9b2(0x79)];let _0x507707=await this[_0x42b9b2(0xeb)]['findOne']({'where':{'userId':_0x28ff08}});!_0x507707&&(_0x507707=await this[_0x42b9b2(0x71)](_0x28ff08));if(_0x1a48e4===_0x42b9b2(0x84))return this[_0x42b9b2(0x10b)](_0x5505b6,_0x349f90,_0xceddc5);const _0x2ea287=_0x349f90===0x1?_0x42b9b2(0xb3):_0x349f90===0x2?_0x42b9b2(0xa0):_0x349f90===0x3?_0x42b9b2(0xb8):null,_0x4ce3a7=_0x349f90===0x1?_0x42b9b2(0x9a):_0x349f90===0x2?_0x42b9b2(0x87):_0x349f90===0x3?'drawMjCount':null;if(_0x507707[_0x42b9b2(0x10f)]&&_0x507707[_0x2ea287]+_0x507707[_0x4ce3a7]<_0xceddc5){if(_0x507707[_0x4ce3a7]<_0xceddc5)throw new common_1['HttpException']('积分不足，继续体验服务，请按需选购套餐！',common_1[_0x42b9b2(0x8c)][_0x42b9b2(0x104)]);}if(!_0x507707[_0x42b9b2(0x10f)]&&_0x507707[_0x4ce3a7]<_0xceddc5)throw new common_1['HttpException']('积分不足，继续体验服务，请按需选购套餐！',common_1[_0x42b9b2(0x8c)]['PAYMENT_REQUIRED']);return _0x507707;}async['validateVisitorBalance'](_0x4a5ea1,_0xd3062d,_0x5ab049){const _0x3d4d64=_0x3afc7e,{id:_0x35843f}=_0x4a5ea1[_0x3d4d64(0x79)],_0x20318f=_0xd3062d===0x1?_0x3d4d64(0x9a):_0xd3062d===0x2?_0x3d4d64(0x87):_0xd3062d===0x3?_0x3d4d64(0xf9):null,_0x50bbb0=new Date(),_0x13975f=await this[_0x3d4d64(0x76)][_0x3d4d64(0x9c)]({'where':{'fingerprint':_0x35843f}}),{visitorModel3Num:_0xb3be30,visitorModel4Num:_0xe9cf96,visitorMJNum:_0x32f2dc}=await this[_0x3d4d64(0xaa)]['getConfigs']([_0x3d4d64(0xc2),_0x3d4d64(0xbc),_0x3d4d64(0xe5)]),_0x3b5ec8={'model3Count':_0xb3be30?Number(_0xb3be30):0x0,'model4Count':_0xe9cf96?Number(_0xe9cf96):0x0,'drawMjCount':_0x32f2dc?Number(_0x32f2dc):0x0};if(!_0x13975f){let _0x1054cd={'fingerprint':_0x35843f,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0};_0x1054cd[_0x20318f]=_0x1054cd[_0x20318f]+_0x5ab049;if(_0x1054cd[_0x20318f]>_0x3b5ec8[_0x20318f])throw new common_1[(_0x3d4d64(0xfc))]('今日体验额度使用完毕，请注册使用完整服务！',common_1[_0x3d4d64(0x8c)][_0x3d4d64(0x104)]);else return await this[_0x3d4d64(0x76)][_0x3d4d64(0xc1)](_0x1054cd),!![];}else{const {model3Count:_0x2e8641,model4Count:_0x47bae0,drawMjCount:_0x38e0b6}=_0x13975f;let _0x43ec7a={'model3Count':_0x2e8641,'model4Count':_0x47bae0,'drawMjCount':_0x38e0b6};const _0x132847=Number(new Date(_0x13975f[_0x3d4d64(0xa3)])),_0x564230=this[_0x3d4d64(0xb0)](_0x132847);_0x564230?_0x43ec7a[_0x20318f]=_0x43ec7a[_0x20318f]+_0x5ab049:(_0x43ec7a={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x43ec7a[_0x20318f]=_0x43ec7a[_0x20318f]+_0x5ab049);if(_0x43ec7a[_0x20318f]>_0x3b5ec8[_0x20318f])throw new common_1['HttpException']('今日体验额度使用完毕，请注册使用完整服务！',common_1[_0x3d4d64(0x8c)][_0x3d4d64(0x104)]);else return await this['fingerprintLogEntity'][_0x3d4d64(0xb6)]({'fingerprint':_0x35843f},_0x43ec7a),!![];}}['isUpdatedToday'](_0x8a03f9){const _0x5c3c1a=_0x3afc7e,_0x472a8a=new Date(),_0x1fed8d=new Date(_0x472a8a[_0x5c3c1a(0x92)](),_0x472a8a[_0x5c3c1a(0xd6)](),_0x472a8a[_0x5c3c1a(0x73)]());return _0x8a03f9>=_0x1fed8d;}async[_0x3afc7e(0xcf)](_0x4552dd,_0x1a7683,_0x56b037,_0x34613e=0x0){const _0x30aa8b=_0x3afc7e,_0x4952f6=await this['userBalanceEntity'][_0x30aa8b(0x9c)]({'where':{'userId':_0x4552dd}});if(!_0x4952f6)throw new common_1[(_0x30aa8b(0xfc))]('缺失当前用户账户记录！',common_1['HttpStatus'][_0x30aa8b(0xb9)]);const _0x396a07={0x1:{'member':'memberModel3Count','nonMember':'model3Count','token':_0x30aa8b(0x7c)},0x2:{'member':_0x30aa8b(0xa0),'nonMember':'model4Count','token':'useModel4Token'},0x3:{'member':_0x30aa8b(0xb8),'nonMember':_0x30aa8b(0xf9),'token':_0x30aa8b(0xc5)}},{member:_0x472505,nonMember:_0xf410cb,token:_0x202d9f}=_0x396a07[_0x1a7683];let _0x153d32=_0x56b037,_0x52a8b3=Math[_0x30aa8b(0x91)](_0x4952f6[_0x472505]-_0x153d32,0x0);_0x153d32-=_0x4952f6[_0x472505]-_0x52a8b3;let _0x4fb619=_0x4952f6[_0xf410cb];_0x153d32>0x0&&(_0x4fb619=Math[_0x30aa8b(0x91)](_0x4952f6[_0xf410cb]-_0x153d32,0x0),_0x153d32-=_0x4952f6[_0xf410cb]-_0x4fb619);const _0xfc64f4={[_0x472505]:_0x52a8b3,[_0xf410cb]:_0x4fb619,[_0x202d9f]:(_0x4952f6[_0x202d9f]||0x0)+_0x34613e};(_0x202d9f===_0x30aa8b(0x7c)||_0x202d9f===_0x30aa8b(0xdb))&&(_0xfc64f4[_0x202d9f[_0x30aa8b(0x96)](_0x30aa8b(0xd1),_0x30aa8b(0x7d))]=(_0x4952f6[_0x202d9f['replace'](_0x30aa8b(0xd1),_0x30aa8b(0x7d))]||0x0)+_0x56b037);const _0x3844f2=await this[_0x30aa8b(0xeb)]['update']({'userId':_0x4552dd},_0xfc64f4);if(_0x3844f2[_0x30aa8b(0xb4)]===0x0)throw new common_1[(_0x30aa8b(0xfc))]('消费余额失败！',common_1[_0x30aa8b(0x8c)][_0x30aa8b(0xb9)]);}async['queryUserBalance'](_0x225fdd){const _0x5b87e2=_0x3afc7e;try{const _0x46ca93=await this[_0x5b87e2(0xeb)][_0x5b87e2(0x9c)]({'where':{'userId':_0x225fdd},'select':[_0x5b87e2(0x10f),_0x5b87e2(0x9a),'model4Count',_0x5b87e2(0xf9),_0x5b87e2(0xb3),'memberModel4Count',_0x5b87e2(0xb8),_0x5b87e2(0x72),'useModel4Count',_0x5b87e2(0x7c),_0x5b87e2(0xdb),_0x5b87e2(0xc5),_0x5b87e2(0x81)]});if(!_0x46ca93){const _0x1d5ac1=await this[_0x5b87e2(0x71)](_0x225fdd);if(_0x1d5ac1)return await this['queryUserBalance'](_0x225fdd);else throw new common_1[(_0x5b87e2(0xfc))]('查询当前用户余额失败！',common_1[_0x5b87e2(0x8c)]['BAD_REQUEST']);}return _0x46ca93[_0x5b87e2(0x7b)]=_0x46ca93[_0x5b87e2(0x10f)]?_0x46ca93[_0x5b87e2(0x9a)]+_0x46ca93[_0x5b87e2(0xb3)]:_0x46ca93[_0x5b87e2(0x9a)],_0x46ca93[_0x5b87e2(0xfb)]=_0x46ca93[_0x5b87e2(0x10f)]?_0x46ca93[_0x5b87e2(0x87)]+_0x46ca93[_0x5b87e2(0xa0)]:_0x46ca93[_0x5b87e2(0x87)],_0x46ca93[_0x5b87e2(0x9b)]=_0x46ca93['packageId']?_0x46ca93[_0x5b87e2(0xf9)]+_0x46ca93[_0x5b87e2(0xb8)]:_0x46ca93[_0x5b87e2(0xf9)],_0x46ca93[_0x5b87e2(0x81)]=_0x46ca93[_0x5b87e2(0x81)]?(0x0,date_1[_0x5b87e2(0xb2)])(_0x46ca93[_0x5b87e2(0x81)],_0x5b87e2(0xe3)):null,_0x46ca93;}catch(_0x34da60){console[_0x5b87e2(0x10d)](_0x5b87e2(0xae),_0x34da60);}}async[_0x3afc7e(0x85)](_0x2c3f23){const _0x1051d5=_0x3afc7e,{userId:_0x11293d,rechargeType:_0x31c8da,model3Count:_0x21e645,model4Count:_0x5aca5e,drawMjCount:_0x42e9e0,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x2c3f23;if(!_0x11293d)throw new common_1[(_0x1051d5(0xfc))](_0x1051d5(0xfe),common_1[_0x1051d5(0x8c)][_0x1051d5(0xb9)]);const _0x4d83fa=(0x0,utils_1['createRandomUid'])();return await this[_0x1051d5(0xc3)][_0x1051d5(0xc1)]({'userId':_0x11293d,'rechargeType':_0x31c8da,'model3Count':_0x21e645,'model4Count':_0x5aca5e,'drawMjCount':_0x42e9e0,'days':days,'extent':extent,'uid':_0x4d83fa,'pkgName':pkgName});}async[_0x3afc7e(0x71)](_0x1270fa,_0x22cb28={}){const _0x10630f=_0x3afc7e,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x22cb28,_0x48931b=await this['userBalanceEntity'][_0x10630f(0x9c)]({'where':{'userId':_0x1270fa}});if(_0x48931b)throw new common_1[(_0x10630f(0xfc))](_0x10630f(0xac),common_1[_0x10630f(0x8c)][_0x10630f(0xb9)]);return await this[_0x10630f(0xeb)]['save']({'userId':_0x1270fa,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async[_0x3afc7e(0x8d)](_0x2ccae2,_0x3f191d,_0x1e2291=-0x1){const _0x2026a5=_0x3afc7e;try{const _0x34fd24=await this[_0x2026a5(0xeb)][_0x2026a5(0x9c)]({'where':{'userId':_0x2ccae2}})||await this['createBaseUserBalance'](_0x2ccae2);if(!_0x34fd24)throw new common_1[(_0x2026a5(0xfc))](_0x2026a5(0x90),common_1[_0x2026a5(0x8c)][_0x2026a5(0xb9)]);const {model3Count:_0x1cd457,model4Count:_0x545a0c,drawMjCount:_0x1df786,memberModel3Count:_0x1726dc,memberModel4Count:_0x3834c3,memberDrawMjCount:_0xfc8dfb}=_0x34fd24;let _0x53a7e2={};if(_0x1e2291>0x0){const {packageId:_0x422391}=_0x3f191d;if(!_0x422391)throw new common_1[(_0x2026a5(0xfc))]('缺失当前套餐ID、充值失败！',common_1[_0x2026a5(0x8c)]['BAD_REQUEST']);const _0x4100d6=await this[_0x2026a5(0xdc)][_0x2026a5(0x9c)]({'where':{'id':_0x422391}});if(!_0x4100d6)throw new common_1[(_0x2026a5(0xfc))](_0x2026a5(0xee),common_1[_0x2026a5(0x8c)][_0x2026a5(0xb9)]);const {weight:_0x1b96ce}=_0x4100d6;if(!_0x34fd24[_0x2026a5(0x10f)])_0x53a7e2={'memberModel3Count':_0x1726dc+_0x3f191d[_0x2026a5(0x9a)],'memberModel4Count':_0x3834c3+_0x3f191d[_0x2026a5(0x87)],'memberDrawMjCount':_0xfc8dfb+_0x3f191d['drawMjCount'],'expirationTime':(0x0,date_1[_0x2026a5(0xf3)])()['add'](_0x1e2291>0x0?_0x1e2291:0x0,_0x2026a5(0xd7))[_0x2026a5(0xca)]('YYYY-MM-DD\x20HH:mm:ss'),'packageId':_0x422391};else{const _0x2b72f3=await this['cramiPackageEntity'][_0x2026a5(0x9c)]({'where':{'id':_0x34fd24['packageId']}});_0x1b96ce>=_0x2b72f3[_0x2026a5(0x70)]&&(_0x53a7e2={'memberModel3Count':_0x1726dc+_0x3f191d[_0x2026a5(0x9a)],'memberModel4Count':_0x3834c3+_0x3f191d[_0x2026a5(0x87)],'memberDrawMjCount':_0xfc8dfb+_0x3f191d[_0x2026a5(0xf9)],'expirationTime':(0x0,date_1['default'])(_0x34fd24[_0x2026a5(0x81)])[_0x2026a5(0xa1)](_0x1e2291>0x0?_0x1e2291:0x0,_0x2026a5(0xd7))[_0x2026a5(0xca)]('YYYY-MM-DD\x20HH:mm:ss'),'packageId':_0x422391}),_0x1b96ce<_0x2b72f3[_0x2026a5(0x70)]&&(_0x53a7e2={'memberModel3Count':_0x1726dc+_0x3f191d[_0x2026a5(0x9a)],'memberModel4Count':_0x3834c3+_0x3f191d[_0x2026a5(0x87)],'memberDrawMjCount':_0xfc8dfb+_0x3f191d[_0x2026a5(0xf9)]});}}_0x1e2291<=0x0&&(_0x53a7e2={'model3Count':_0x1cd457+_0x3f191d[_0x2026a5(0x9a)],'model4Count':_0x545a0c+_0x3f191d[_0x2026a5(0x87)],'drawMjCount':_0x1df786+_0x3f191d[_0x2026a5(0xf9)]});const _0x314157=await this[_0x2026a5(0xeb)]['update']({'userId':_0x2ccae2},_0x53a7e2);if(_0x314157[_0x2026a5(0xb4)]===0x0)throw new common_1[(_0x2026a5(0xfc))](_0x2ccae2+_0x2026a5(0xd5),common_1[_0x2026a5(0x8c)]['BAD_REQUEST']);}catch(_0x3c42ee){console[_0x2026a5(0x10d)]('error:\x20',_0x3c42ee);throw new common_1[(_0x2026a5(0xfc))](_0x2026a5(0x8f),common_1[_0x2026a5(0x8c)][_0x2026a5(0xb9)]);}}async['addBalanceToOrder'](_0x3259ba){const _0x4b924f=_0x3afc7e;console['log']('充值的工单信息:',_0x3259ba);try{const {userId:_0x4d1a34,goodsId:_0x411210}=_0x3259ba,_0x257a2c=await this[_0x4b924f(0xdc)][_0x4b924f(0x9c)]({'where':{'id':_0x3259ba[_0x4b924f(0xe9)],'status':0x1}});if(!_0x257a2c)throw new common_1['HttpException'](_0x4b924f(0xcb),common_1[_0x4b924f(0x8c)][_0x4b924f(0xb9)]);const {model3Count:_0x23bba9,model4Count:_0x2e2749,drawMjCount:_0x27617d,days:_0x508c89,name:_0xb59af5}=_0x257a2c,_0x8b89dd={'model3Count':_0x23bba9,'model4Count':_0x2e2749,'drawMjCount':_0x27617d,'days':_0x508c89,'packageId':_0x3259ba[_0x4b924f(0xe9)]};await this[_0x4b924f(0x8d)](_0x4d1a34,_0x8b89dd,_0x508c89),await this[_0x4b924f(0x85)]({'userId':_0x4d1a34,'rechargeType':balance_constant_1['RechargeType'][_0x4b924f(0x97)],'model3Count':_0x23bba9,'model4Count':_0x2e2749,'drawMjCount':_0x27617d,'pkgName':_0xb59af5,'days':_0x508c89});}catch(_0x4bfecb){console[_0x4b924f(0x10d)](_0x4b924f(0xae),_0x4bfecb);throw new common_1['HttpException'](_0x4b924f(0xe6),common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x3afc7e(0x9f)](_0x4b31a1,_0x2ed6cc){const _0x202f9c=_0x3afc7e,{page:page=0x1,size:size=0x14}=_0x2ed6cc,{id:_0x492c51}=_0x4b31a1[_0x202f9c(0x79)],[_0x218009,_0x55bf6b]=await this['accountLogEntity'][_0x202f9c(0x78)]({'where':{'userId':_0x492c51},'order':{'id':_0x202f9c(0xf4)},'skip':(page-0x1)*size,'take':size});return _0x218009[_0x202f9c(0xc9)](_0x4d9eeb=>{const _0x135d8b=_0x202f9c;_0x4d9eeb[_0x135d8b(0x86)]=_0x4d9eeb[_0x135d8b(0xc7)]>0x0?_0x4d9eeb[_0x135d8b(0xc7)]+'天':'永久';}),{'rows':(0x0,date_1[_0x202f9c(0xf6)])(_0x218009),'count':_0x55bf6b};}async[_0x3afc7e(0xf2)](_0x160f3a,_0x59a6b0){const _0xc3b558=_0x3afc7e;try{const {page:page=0x1,size:size=0xa,userId:_0xcd9b51,rechargeType:_0x325890,packageId:_0x59cfab}=_0x59a6b0,{role:_0x2896a0}=_0x160f3a[_0xc3b558(0x79)],_0x1be753={};_0x325890&&(_0x1be753[_0xc3b558(0x93)]=_0x325890),_0x1be753[_0xc3b558(0xc6)]=_0xcd9b51||(0x0,typeorm_2['LessThan'])(0x186a0),_0x59cfab&&(_0x1be753['packageId']={'$like':'%'+_0x59cfab+'%'});const [_0xabe6dd,_0x55fa3f]=await this['accountLogEntity'][_0xc3b558(0x78)]({'where':_0x1be753,'order':{'id':_0xc3b558(0xf4)},'skip':(page-0x1)*size,'take':size}),_0x452adc=_0xabe6dd['map'](_0x506c54=>_0x506c54[_0xc3b558(0xc6)]),_0xa2f90b=await this[_0xc3b558(0xef)][_0xc3b558(0xdf)]({'where':{'id':(0x0,typeorm_2['In'])(_0x452adc)}});return _0xabe6dd[_0xc3b558(0xc9)](_0x1d4103=>{const _0x387ec8=_0xc3b558,_0x190554=_0xa2f90b[_0x387ec8(0xdf)](_0x2542c4=>_0x2542c4['id']===_0x1d4103[_0x387ec8(0xc6)]);_0x1d4103[_0x387ec8(0xb7)]=_0x190554===null||_0x190554===void 0x0?void 0x0:_0x190554[_0x387ec8(0xb7)],_0x1d4103[_0x387ec8(0xa8)]=_0x190554===null||_0x190554===void 0x0?void 0x0:_0x190554[_0x387ec8(0xa8)],_0x1d4103['phone']=_0x190554===null||_0x190554===void 0x0?void 0x0:_0x190554[_0x387ec8(0xaf)],_0x1d4103[_0x387ec8(0xa7)]=_0x190554===null||_0x190554===void 0x0?void 0x0:_0x190554[_0x387ec8(0xa7)],_0x1d4103[_0x387ec8(0xc0)]=_0x190554===null||_0x190554===void 0x0?void 0x0:_0x190554[_0x387ec8(0xc0)];}),_0x2896a0!==_0xc3b558(0x88)&&_0xabe6dd[_0xc3b558(0xc9)](_0x532b4c=>{const _0x4a57fd=_0xc3b558;_0x532b4c['email']=_0x532b4c['email']?(0x0,utils_1['hideString'])(_0x532b4c[_0x4a57fd(0xa8)]):'',_0x532b4c[_0x4a57fd(0xaf)]=_0x532b4c[_0x4a57fd(0xaf)]?(0x0,utils_1[_0x4a57fd(0xda)])(_0x532b4c['phone']):'';}),{'rows':_0xabe6dd,'count':_0x55fa3f};}catch(_0x4f26a6){console[_0xc3b558(0x10d)]('error:\x20',_0x4f26a6);throw new common_1[(_0xc3b558(0xfc))](_0xc3b558(0x9d),common_1[_0xc3b558(0x8c)][_0xc3b558(0xb9)]);}}async[_0x3afc7e(0x103)](_0x1620a1){const _0x164769=_0x3afc7e;return await this['userBalanceEntity'][_0x164769(0xdf)]({'where':{'userId':(0x0,typeorm_2['In'])(_0x1620a1)}});}async['refundMjBalance'](_0x4da59e,_0x1a20c8){const _0x4533bd=_0x3afc7e;return await this[_0x4533bd(0xcf)](_0x4da59e,_0x4533bd(0x6c),-_0x1a20c8);}async[_0x3afc7e(0xec)](_0x337a63){const _0x1f4648=_0x3afc7e,{fingerprint:_0x3929a8}=_0x337a63[_0x1f4648(0xde)],{id:_0x1d02fb}=_0x337a63['user'];return await this[_0x1f4648(0xf0)]['update']({'userId':Number(_0x3929a8)},{'userId':_0x1d02fb}),await this['chatGroupEntity'][_0x1f4648(0xb6)]({'userId':Number(_0x3929a8)},{'userId':_0x1d02fb}),0x1;}async[_0x3afc7e(0xe2)](_0x48dcd5){const _0x2e0990=_0x3afc7e,{fingerprint:_0x1344e2}=_0x48dcd5[_0x2e0990(0xde)],_0xb12975=await this[_0x2e0990(0xf0)]['count']({'where':{'userId':_0x1344e2}}),_0x33fca8=await this[_0x2e0990(0xd4)][_0x2e0990(0xa4)]({'where':{'userId':_0x1344e2}});return _0xb12975||_0x33fca8||0x0;}async[_0x3afc7e(0xe1)](_0x58c3e5){const _0x5d51d5=_0x3afc7e,_0x119780=await this[_0x5d51d5(0xef)][_0x5d51d5(0x9c)]({'where':{'id':_0x58c3e5}}),_0x4c4de3=await this[_0x5d51d5(0xeb)][_0x5d51d5(0x9c)]({'where':{'userId':_0x58c3e5}});if(!_0x119780||!_0x4c4de3)return;const {phoneValidationMessageCount:_0x35a6fc,identityVerificationMessageCount:_0x265e8f,openIdentity:_0x196351,openPhoneValidation:_0x2748bc}=await this['globalConfigService'][_0x5d51d5(0x75)]([_0x5d51d5(0xdd),_0x5d51d5(0x99),'openIdentity',_0x5d51d5(0x6d)]),_0xb817cc=Number(_0x35a6fc),_0xe889e=Number(_0x265e8f),_0x41cb90=Number(_0x4c4de3[_0x5d51d5(0x72)])||0x0,_0x446684=Number(_0x4c4de3[_0x5d51d5(0x6f)])||0x0,_0x58d418=_0x41cb90+_0x446684;if(_0x2748bc==='1'&&_0x58d418>=_0xb817cc&&!_0x119780['phone'])throw new common_1[(_0x5d51d5(0xfc))](_0x5d51d5(0x100),common_1[_0x5d51d5(0x8c)]['BAD_REQUEST']);if(_0x196351==='1'&&_0x58d418>=_0xe889e&&(!_0x119780[_0x5d51d5(0xc4)]||!_0x119780[_0x5d51d5(0xce)]))throw new common_1[(_0x5d51d5(0xfc))](_0x5d51d5(0x94),common_1['HttpStatus']['BAD_REQUEST']);}};function _0x4858(){const _0x155e7c=['queryUserBalanceByIds','PAYMENT_REQUIRED','addBalanceToNewUser','InjectRepository','../chatGroup/chatGroup.entity','137076HcyqZF','configKey','defineProperty','validateVisitorBalance','注册赠送失败,请联系管理员！','log','../globalConfig/config.entity','packageId','mjDraw','openPhoneValidation','../../common/utils/date','useModel4Count','weight','createBaseUserBalance','useModel3Count','getDate','524573EXReUn','getConfigs','fingerprintLogEntity','registerSendModel4Count','findAndCount','user','__metadata','sumModel3Count','useModel3Token','Count','firstRregisterSendModel4Count','firstRegisterSendStatus','Repository','expirationTime','37447644zIoUBK','1NrkqCl','visitor','saveRecordRechargeLog','expireDateCn','model4Count','super','./accountLog.entity','ConfigEntity','__decorate','HttpStatus','addBalanceToUser','registerSendStatus','用户充值失败！','查询用户账户信息失败！','max','getFullYear','rechargeType','请完成实名认证','validateBalance','replace','SCAN_PAY','112qSbADQ','identityVerificationMessageCount','model3Count','sumDrawMjCount','findOne','查询用户账户失败！','decorate','getRechargeLog','memberModel4Count','add','../chatLog/chatLog.entity','updatedAt','count','reduce','firstRregisterSendModel3Count','status','email','20004uzcBIc','globalConfigService','__param','当前用户无需创建账户信息！','ChatGroupEntity','error:\x20','phone','isUpdatedToday','BalanceEntity','formatDate','memberModel3Count','affected','firstRregisterSendDrawMjCount','update','username','memberDrawMjCount','BAD_REQUEST','CramiPackageEntity','__esModule','visitorModel4Num','REG_GIFT','ChatLogEntity','531omRuLc','avatar','save','visitorModel3Num','accountLogEntity','realName','useDrawMjToken','userId','days','./fingerprint.entity','forEach','format','非法操作、当前充值套餐暂不存在！','3874400hvPQEp','UserEntity','idCard','deductFromBalance','../crami/cramiPackage.entity','Token','function','2038958VmemNw','chatGroupEntity','充值失败','getMonth','day','configEntity','../../common/utils','hideString','useModel4Token','cramiPackageEntity','phoneValidationMessageCount','headers','find','design:paramtypes','checkUserCertification','getVisitorCount','YYYY-MM-DD','object','visitorMJNum','充值失败！','configVal','../user/user.entity','goodsId','metadata','userBalanceEntity','inheritVisitorData','registerSendModel3Count','当前套餐不存在！','userEntity','chatLogEntity','9020196GAuBBN','getAccountLog','default','DESC','220dmtzrh','formatCreateOrUpdateDate','./userBalance.entity','balanceEntity','drawMjCount','Injectable','sumModel4Count','HttpException','length','当前用户不存在,记录充值日志异常','11XDUnze','请完成手机号绑定','UserBalanceEntity','registerSendDrawMjCount'];_0x4858=function(){return _0x155e7c;};return _0x4858();}UserBalanceService=__decorate([(0x0,common_1[_0x3afc7e(0xfa)])(),__param(0x0,(0x0,typeorm_1[_0x3afc7e(0x106)])(balance_entity_1[_0x3afc7e(0xb1)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(userBalance_entity_1[_0x3afc7e(0x101)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(accountLog_entity_1['AccountLogEntity'])),__param(0x3,(0x0,typeorm_1[_0x3afc7e(0x106)])(cramiPackage_entity_1[_0x3afc7e(0xba)])),__param(0x4,(0x0,typeorm_1[_0x3afc7e(0x106)])(config_entity_1[_0x3afc7e(0x8a)])),__param(0x5,(0x0,typeorm_1[_0x3afc7e(0x106)])(user_entity_1[_0x3afc7e(0xcd)])),__param(0x6,(0x0,typeorm_1[_0x3afc7e(0x106)])(fingerprint_entity_1['FingerprintLogEntity'])),__param(0x7,(0x0,typeorm_1[_0x3afc7e(0x106)])(chatGroup_entity_1[_0x3afc7e(0xad)])),__param(0x8,(0x0,typeorm_1[_0x3afc7e(0x106)])(chatLog_entity_1[_0x3afc7e(0xbe)])),__metadata(_0x3afc7e(0xe0),[typeorm_2[_0x3afc7e(0x80)],typeorm_2['Repository'],typeorm_2[_0x3afc7e(0x80)],typeorm_2[_0x3afc7e(0x80)],typeorm_2['Repository'],typeorm_2[_0x3afc7e(0x80)],typeorm_2[_0x3afc7e(0x80)],typeorm_2['Repository'],typeorm_2['Repository'],globalConfig_service_1['GlobalConfigService']])],UserBalanceService),exports['UserBalanceService']=UserBalanceService;