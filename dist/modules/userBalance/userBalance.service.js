'use strict';const _0x4bab2a=_0x1403;(function(_0x230f85,_0x5174be){const _0x5c7d2d=_0x1403,_0x25dd37=_0x230f85();while(!![]){try{const _0x1b7dfb=-parseInt(_0x5c7d2d(0x11e))/0x1+parseInt(_0x5c7d2d(0xdf))/0x2+parseInt(_0x5c7d2d(0x103))/0x3*(parseInt(_0x5c7d2d(0xfb))/0x4)+-parseInt(_0x5c7d2d(0xc8))/0x5+-parseInt(_0x5c7d2d(0xcb))/0x6+parseInt(_0x5c7d2d(0xe0))/0x7*(parseInt(_0x5c7d2d(0x148))/0x8)+parseInt(_0x5c7d2d(0xf2))/0x9;if(_0x1b7dfb===_0x5174be)break;else _0x25dd37['push'](_0x25dd37['shift']());}catch(_0x3595e0){_0x25dd37['push'](_0x25dd37['shift']());}}}(_0x1d5e,0xa0316));function _0x1403(_0x3f9b54,_0xd0af45){const _0x1d5e22=_0x1d5e();return _0x1403=function(_0x1403d8,_0x622951){_0x1403d8=_0x1403d8-0xab;let _0x49cd13=_0x1d5e22[_0x1403d8];return _0x49cd13;},_0x1403(_0x3f9b54,_0xd0af45);}var __decorate=this&&this['__decorate']||function(_0x170ff9,_0x4f647e,_0x5d9c73,_0x7314b){const _0x20b56a=_0x1403;var _0x4e14dc=arguments[_0x20b56a(0xaf)],_0x347941=_0x4e14dc<0x3?_0x4f647e:_0x7314b===null?_0x7314b=Object[_0x20b56a(0x13b)](_0x4f647e,_0x5d9c73):_0x7314b,_0x24615c;if(typeof Reflect===_0x20b56a(0xba)&&typeof Reflect[_0x20b56a(0xb9)]===_0x20b56a(0xc7))_0x347941=Reflect[_0x20b56a(0xb9)](_0x170ff9,_0x4f647e,_0x5d9c73,_0x7314b);else{for(var _0x3ff17d=_0x170ff9[_0x20b56a(0xaf)]-0x1;_0x3ff17d>=0x0;_0x3ff17d--)if(_0x24615c=_0x170ff9[_0x3ff17d])_0x347941=(_0x4e14dc<0x3?_0x24615c(_0x347941):_0x4e14dc>0x3?_0x24615c(_0x4f647e,_0x5d9c73,_0x347941):_0x24615c(_0x4f647e,_0x5d9c73))||_0x347941;}return _0x4e14dc>0x3&&_0x347941&&Object[_0x20b56a(0xb2)](_0x4f647e,_0x5d9c73,_0x347941),_0x347941;},__metadata=this&&this[_0x4bab2a(0x14a)]||function(_0x5924b7,_0x1bcb58){const _0x19e3d7=_0x4bab2a;if(typeof Reflect===_0x19e3d7(0xba)&&typeof Reflect[_0x19e3d7(0xbb)]==='function')return Reflect[_0x19e3d7(0xbb)](_0x5924b7,_0x1bcb58);},__param=this&&this[_0x4bab2a(0xca)]||function(_0x1cb228,_0x793f3){return function(_0xc2e271,_0x48a10c){_0x793f3(_0xc2e271,_0x48a10c,_0x1cb228);};};function _0x1d5e(){const _0x155e2a=['configVal','firstRregisterSendModel3Count','find','count','save','CramiPackageEntity','4744836rtOgek','@nestjs/typeorm','注册赠送失败,请联系管理员！','packageId','Token','积分不足，继续体验服务，请按需选购套餐！','REG_GIFT','useModel4Token','log','8aFVceu','../../common/constants/balance.constant','getAccountLog','HttpException','visitorMJNum','YYYY-MM-DD\x20HH:mm:ss','user','UserBalanceEntity','1963434encTEr','super','sumDrawMjCount','reduce','useModel3Count','addBalanceToNewUser','../chatLog/chatLog.entity','memberModel4Count','Count','registerSendModel3Count','fingerprintLogEntity','affected','isUpdatedToday','forEach','email','userId','充值失败！','replace','firstRegisterSendRank','HttpStatus','Injectable','Repository','./fingerprint.entity','./accountLog.entity','model3Count','visitor','LessThan','1076369eHwGfL','findAndCount','__esModule','configEntity','configKey','weight','hideString','openIdentity','firstRregisterSendDrawMjCount','goodsId','缺失当前用户账户记录！','avatar','saveRecordRechargeLog','userEntity','day','validateVisitorBalance','getConfigs','../crami/cramiPackage.entity','sumModel3Count','BalanceEntity','inheritVisitorData','useDrawMjToken','headers','validateBalance','SCAN_PAY','getDate','memberModel3Count','days','queryUserBalance','getOwnPropertyDescriptor','firstRegisterSendStatus','phoneValidationMessageCount','identityVerificationMessageCount','PAYMENT_REQUIRED','drawMjCount','globalConfigService','queryUserBalanceByIds','refundMjBalance','当前套餐不存在！','updatedAt','DESC','getVisitorCount','72304BAbLev','当前用户无需创建账户信息！','__metadata','addBalanceToOrder','update','getMonth','expireDateCn','length','typeorm','rechargeType','defineProperty','map','expirationTime','chatGroupEntity','cramiPackageEntity','ChatLogEntity','BAD_REQUEST','decorate','object','metadata','createRandomUid','createBaseUserBalance','status','phone','FingerprintLogEntity','今日体验额度使用完毕，请注册使用完整服务！','design:paramtypes','GlobalConfigService','isInteger','registerSendStatus','请完成实名认证','function','3787300KREinm','max','__param','6301680yckLWB','addBalanceToUser','add','visitorModel4Num','AccountLogEntity','model4Count','充值失败','useModel3Token','缺失当前套餐ID、充值失败！','error:\x20','firstRregisterSendModel4Count','UserBalanceService','当前用户不存在,记录充值日志异常','balanceEntity','accountLogEntity','RechargeType','chatLogEntity','registerSendModel4Count','memberDrawMjCount','registerSendDrawMjCount','1365610ZWfcac','791nHPdkv','findOne','deductFromBalance','checkUserCertification','userBalanceEntity','../chatGroup/chatGroup.entity','useModel4Count','InjectRepository','sumModel4Count','ConfigEntity','@nestjs/common','format'];_0x1d5e=function(){return _0x155e2a;};return _0x1d5e();}Object[_0x4bab2a(0xb2)](exports,_0x4bab2a(0x120),{'value':!![]}),exports[_0x4bab2a(0xd6)]=void 0x0;const balance_constant_1=require(_0x4bab2a(0xfc)),utils_1=require('../../common/utils'),common_1=require(_0x4bab2a(0xea)),typeorm_1=require(_0x4bab2a(0xf3)),typeorm_2=require(_0x4bab2a(0xb0)),cramiPackage_entity_1=require(_0x4bab2a(0x12f)),config_entity_1=require('../globalConfig/config.entity'),globalConfig_service_1=require('./../globalConfig/globalConfig.service'),accountLog_entity_1=require(_0x4bab2a(0x11a)),balance_entity_1=require('./balance.entity'),userBalance_entity_1=require('./userBalance.entity'),date_1=require('../../common/utils/date'),chatGroup_entity_1=require(_0x4bab2a(0xe5)),chatLog_entity_1=require(_0x4bab2a(0x109)),user_entity_1=require('../user/user.entity'),fingerprint_entity_1=require(_0x4bab2a(0x119));let UserBalanceService=class UserBalanceService{constructor(_0x3747b2,_0x11bff6,_0x882836,_0xc98ad6,_0x12cb83,_0x1c18f3,_0x4be92b,_0x4664bd,_0x40a912,_0x15b7af){const _0x3ea5b2=_0x4bab2a;this[_0x3ea5b2(0xd8)]=_0x3747b2,this[_0x3ea5b2(0xe4)]=_0x11bff6,this[_0x3ea5b2(0xd9)]=_0x882836,this['cramiPackageEntity']=_0xc98ad6,this[_0x3ea5b2(0x121)]=_0x12cb83,this[_0x3ea5b2(0x12b)]=_0x1c18f3,this[_0x3ea5b2(0x10d)]=_0x4be92b,this[_0x3ea5b2(0xb5)]=_0x4664bd,this[_0x3ea5b2(0xdb)]=_0x40a912,this[_0x3ea5b2(0x141)]=_0x15b7af;}async[_0x4bab2a(0x108)](_0x2f1985){const _0xe91182=_0x4bab2a;try{const _0x4f4cdb=await this[_0xe91182(0x121)][_0xe91182(0xee)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0xe91182(0xc5),_0xe91182(0x10c),_0xe91182(0xdc),_0xe91182(0xde),_0xe91182(0x13c),_0xe91182(0x115),_0xe91182(0xed),_0xe91182(0xd5),_0xe91182(0x126)])}}),_0x189fa0=_0x4f4cdb[_0xe91182(0x106)]((_0x3b8edd,_0x47d419)=>{const _0x5e3c3d=_0xe91182,_0x14db9f=Number(_0x47d419[_0x5e3c3d(0xec)]),_0x32905b=Number[_0x5e3c3d(0xc4)](_0x14db9f)&&_0x14db9f>0x0?_0x14db9f:0x0;return _0x3b8edd[_0x47d419[_0x5e3c3d(0x122)]]=_0x32905b,_0x3b8edd;},{});let _0x29bdb4=0x0,_0x52188d=0x0,_0x40180e=0x0;_0x189fa0[_0xe91182(0xc5)]===0x1&&(_0x29bdb4=_0x29bdb4+_0x189fa0[_0xe91182(0x10c)],_0x52188d=_0x52188d+_0x189fa0[_0xe91182(0xdc)],_0x40180e=_0x40180e+_0x189fa0['registerSendDrawMjCount']),_0x189fa0['registerSendStatus']===0x1&&_0x189fa0[_0xe91182(0x13c)]===0x1&&_0x2f1985<=_0x189fa0[_0xe91182(0x115)]&&(_0x29bdb4=_0x29bdb4+_0x189fa0[_0xe91182(0xed)],_0x52188d=_0x52188d+_0x189fa0[_0xe91182(0xd5)],_0x40180e=_0x40180e+_0x189fa0[_0xe91182(0x126)]),await this[_0xe91182(0x12a)]({'userId':_0x2f1985,'rechargeType':balance_constant_1[_0xe91182(0xda)][_0xe91182(0xf8)],'model3Count':_0x29bdb4,'drawMjCount':_0x40180e,'model4Count':_0x52188d}),await this['userBalanceEntity']['save']({'userId':_0x2f1985,'model3Count':_0x29bdb4,'model4Count':_0x52188d,'drawMjCount':_0x40180e,'useTokens':0x0});}catch(_0x49325c){console[_0xe91182(0xfa)](_0xe91182(0xd4),_0x49325c);throw new common_1[(_0xe91182(0xfe))](_0xe91182(0xf4),common_1[_0xe91182(0x116)]['BAD_REQUEST']);}}async[_0x4bab2a(0x135)](_0x2a3743,_0x4c383a,_0x375bbd){const _0x579dea=_0x4bab2a,{id:_0x9a7a20,role:_0x5bd819}=_0x2a3743[_0x579dea(0x101)];let _0x377c9d=await this[_0x579dea(0xe4)][_0x579dea(0xe1)]({'where':{'userId':_0x9a7a20}});!_0x377c9d&&(_0x377c9d=await this['createBaseUserBalance'](_0x9a7a20));if(_0x5bd819===_0x579dea(0x11c))return this['validateVisitorBalance'](_0x2a3743,_0x4c383a,_0x375bbd);const _0x109717=_0x4c383a===0x1?'memberModel3Count':_0x4c383a===0x2?_0x579dea(0x10a):_0x4c383a===0x3?_0x579dea(0xdd):null,_0x210c15=_0x4c383a===0x1?_0x579dea(0x11b):_0x4c383a===0x2?_0x579dea(0xd0):_0x4c383a===0x3?_0x579dea(0x140):null;if(_0x377c9d['packageId']&&_0x377c9d[_0x109717]+_0x377c9d[_0x210c15]<_0x375bbd){if(_0x377c9d[_0x210c15]<_0x375bbd)throw new common_1[(_0x579dea(0xfe))](_0x579dea(0xf7),common_1[_0x579dea(0x116)][_0x579dea(0x13f)]);}if(!_0x377c9d[_0x579dea(0xf5)]&&_0x377c9d[_0x210c15]<_0x375bbd)throw new common_1[(_0x579dea(0xfe))](_0x579dea(0xf7),common_1[_0x579dea(0x116)][_0x579dea(0x13f)]);return _0x377c9d;}async[_0x4bab2a(0x12d)](_0x10baf8,_0x8bceff,_0x4dc61a){const _0xaff879=_0x4bab2a,{id:_0x547515}=_0x10baf8['user'],_0x2ef6d4=_0x8bceff===0x1?'model3Count':_0x8bceff===0x2?_0xaff879(0xd0):_0x8bceff===0x3?_0xaff879(0x140):null,_0x54c155=new Date(),_0x4ba611=await this[_0xaff879(0x10d)][_0xaff879(0xe1)]({'where':{'fingerprint':_0x547515}}),{visitorModel3Num:_0x36dee8,visitorModel4Num:_0x230107,visitorMJNum:_0x36dc70}=await this[_0xaff879(0x141)][_0xaff879(0x12e)](['visitorModel3Num',_0xaff879(0xce),_0xaff879(0xff)]),_0x46f94d={'model3Count':_0x36dee8?Number(_0x36dee8):0x0,'model4Count':_0x230107?Number(_0x230107):0x0,'drawMjCount':_0x36dc70?Number(_0x36dc70):0x0};if(!_0x4ba611){let _0x19bce6={'fingerprint':_0x547515,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0};_0x19bce6[_0x2ef6d4]=_0x19bce6[_0x2ef6d4]+_0x4dc61a;if(_0x19bce6[_0x2ef6d4]>_0x46f94d[_0x2ef6d4])throw new common_1[(_0xaff879(0xfe))](_0xaff879(0xc1),common_1[_0xaff879(0x116)][_0xaff879(0x13f)]);else return await this[_0xaff879(0x10d)][_0xaff879(0xf0)](_0x19bce6),!![];}else{const {model3Count:_0x1ff72e,model4Count:_0x2a19e1,drawMjCount:_0x5bea85}=_0x4ba611;let _0x2ec69a={'model3Count':_0x1ff72e,'model4Count':_0x2a19e1,'drawMjCount':_0x5bea85};const _0x584fc8=Number(new Date(_0x4ba611[_0xaff879(0x145)])),_0x51004f=this['isUpdatedToday'](_0x584fc8);_0x51004f?_0x2ec69a[_0x2ef6d4]=_0x2ec69a[_0x2ef6d4]+_0x4dc61a:(_0x2ec69a={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x2ec69a[_0x2ef6d4]=_0x2ec69a[_0x2ef6d4]+_0x4dc61a);if(_0x2ec69a[_0x2ef6d4]>_0x46f94d[_0x2ef6d4])throw new common_1[(_0xaff879(0xfe))]('今日体验额度使用完毕，请注册使用完整服务！',common_1[_0xaff879(0x116)][_0xaff879(0x13f)]);else return await this['fingerprintLogEntity'][_0xaff879(0xac)]({'fingerprint':_0x547515},_0x2ec69a),!![];}}[_0x4bab2a(0x10f)](_0x490fc4){const _0x5c42b0=_0x4bab2a,_0x5b6bea=new Date(),_0x1cddca=new Date(_0x5b6bea['getFullYear'](),_0x5b6bea[_0x5c42b0(0xad)](),_0x5b6bea[_0x5c42b0(0x137)]());return _0x490fc4>=_0x1cddca;}async[_0x4bab2a(0xe2)](_0x240c35,_0x579103,_0x1644ab,_0x4959cf=0x0){const _0x48acdd=_0x4bab2a,_0x24a517=await this[_0x48acdd(0xe4)][_0x48acdd(0xe1)]({'where':{'userId':_0x240c35}});if(!_0x24a517)throw new common_1[(_0x48acdd(0xfe))](_0x48acdd(0x128),common_1[_0x48acdd(0x116)]['BAD_REQUEST']);const _0x10b07d={0x1:{'member':_0x48acdd(0x138),'nonMember':_0x48acdd(0x11b),'token':_0x48acdd(0xd2)},0x2:{'member':_0x48acdd(0x10a),'nonMember':_0x48acdd(0xd0),'token':_0x48acdd(0xf9)},0x3:{'member':'memberDrawMjCount','nonMember':'drawMjCount','token':_0x48acdd(0x133)}},{member:_0x2829eb,nonMember:_0x3c1599,token:_0x19ba64}=_0x10b07d[_0x579103];let _0x26b64d=_0x1644ab,_0x53fb0a=Math['max'](_0x24a517[_0x2829eb]-_0x26b64d,0x0);_0x26b64d-=_0x24a517[_0x2829eb]-_0x53fb0a;let _0x50fb34=_0x24a517[_0x3c1599];_0x26b64d>0x0&&(_0x50fb34=Math[_0x48acdd(0xc9)](_0x24a517[_0x3c1599]-_0x26b64d,0x0),_0x26b64d-=_0x24a517[_0x3c1599]-_0x50fb34);const _0x5e2dab={[_0x2829eb]:_0x53fb0a,[_0x3c1599]:_0x50fb34,[_0x19ba64]:(_0x24a517[_0x19ba64]||0x0)+_0x4959cf};(_0x19ba64===_0x48acdd(0xd2)||_0x19ba64===_0x48acdd(0xf9))&&(_0x5e2dab[_0x19ba64[_0x48acdd(0x114)]('Token',_0x48acdd(0x10b))]=(_0x24a517[_0x19ba64['replace'](_0x48acdd(0xf6),_0x48acdd(0x10b))]||0x0)+_0x1644ab);const _0x229faf=await this[_0x48acdd(0xe4)][_0x48acdd(0xac)]({'userId':_0x240c35},_0x5e2dab);if(_0x229faf[_0x48acdd(0x10e)]===0x0)throw new common_1[(_0x48acdd(0xfe))]('消费余额失败！',common_1[_0x48acdd(0x116)]['BAD_REQUEST']);}async[_0x4bab2a(0x13a)](_0x6af9cb){const _0x46e080=_0x4bab2a;try{const _0x461e6d=await this[_0x46e080(0xe4)][_0x46e080(0xe1)]({'where':{'userId':_0x6af9cb},'select':['packageId',_0x46e080(0x11b),'model4Count','drawMjCount','memberModel3Count',_0x46e080(0x10a),_0x46e080(0xdd),_0x46e080(0x107),_0x46e080(0xe6),_0x46e080(0xd2),'useModel4Token','useDrawMjToken',_0x46e080(0xb4)]});if(!_0x461e6d){const _0x3b1726=await this[_0x46e080(0xbd)](_0x6af9cb);if(_0x3b1726)return await this[_0x46e080(0x13a)](_0x6af9cb);else throw new common_1['HttpException']('查询当前用户余额失败！',common_1[_0x46e080(0x116)][_0x46e080(0xb8)]);}return _0x461e6d[_0x46e080(0x130)]=_0x461e6d[_0x46e080(0xf5)]?_0x461e6d['model3Count']+_0x461e6d['memberModel3Count']:_0x461e6d[_0x46e080(0x11b)],_0x461e6d[_0x46e080(0xe8)]=_0x461e6d[_0x46e080(0xf5)]?_0x461e6d['model4Count']+_0x461e6d[_0x46e080(0x10a)]:_0x461e6d[_0x46e080(0xd0)],_0x461e6d[_0x46e080(0x105)]=_0x461e6d[_0x46e080(0xf5)]?_0x461e6d[_0x46e080(0x140)]+_0x461e6d[_0x46e080(0xdd)]:_0x461e6d[_0x46e080(0x140)],_0x461e6d[_0x46e080(0xb4)]=_0x461e6d['expirationTime']?(0x0,date_1['formatDate'])(_0x461e6d['expirationTime'],'YYYY-MM-DD'):null,_0x461e6d;}catch(_0x2d690a){console[_0x46e080(0xfa)](_0x46e080(0xd4),_0x2d690a);}}async[_0x4bab2a(0x12a)](_0x5505b5){const _0x50b89b=_0x4bab2a,{userId:_0x2c9631,rechargeType:_0x17238c,model3Count:_0x381aed,model4Count:_0x3df7df,drawMjCount:_0x631e38,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x5505b5;if(!_0x2c9631)throw new common_1[(_0x50b89b(0xfe))](_0x50b89b(0xd7),common_1[_0x50b89b(0x116)]['BAD_REQUEST']);const _0x58d9a2=(0x0,utils_1[_0x50b89b(0xbc)])();return await this[_0x50b89b(0xd9)][_0x50b89b(0xf0)]({'userId':_0x2c9631,'rechargeType':_0x17238c,'model3Count':_0x381aed,'model4Count':_0x3df7df,'drawMjCount':_0x631e38,'days':days,'extent':extent,'uid':_0x58d9a2,'pkgName':pkgName});}async['createBaseUserBalance'](_0x75fefc,_0x4f8db4={}){const _0x1e750f=_0x4bab2a,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x4f8db4,_0x174246=await this[_0x1e750f(0xe4)][_0x1e750f(0xe1)]({'where':{'userId':_0x75fefc}});if(_0x174246)throw new common_1[(_0x1e750f(0xfe))](_0x1e750f(0x149),common_1['HttpStatus'][_0x1e750f(0xb8)]);return await this['userBalanceEntity'][_0x1e750f(0xf0)]({'userId':_0x75fefc,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async[_0x4bab2a(0xcc)](_0x408fd9,_0x462e41,_0x372d7b=-0x1){const _0x237273=_0x4bab2a;try{const _0x4bdfa3=await this[_0x237273(0xe4)][_0x237273(0xe1)]({'where':{'userId':_0x408fd9}})||await this[_0x237273(0xbd)](_0x408fd9);if(!_0x4bdfa3)throw new common_1['HttpException']('查询用户账户信息失败！',common_1[_0x237273(0x116)][_0x237273(0xb8)]);const {model3Count:_0x1e36e4,model4Count:_0x5d45ca,drawMjCount:_0x8d9958,memberModel3Count:_0x3e3cf2,memberModel4Count:_0x59cdc3,memberDrawMjCount:_0xa95642}=_0x4bdfa3;let _0x1bd6a0={};if(_0x372d7b>0x0){const {packageId:_0x36fd73}=_0x462e41;if(!_0x36fd73)throw new common_1['HttpException'](_0x237273(0xd3),common_1[_0x237273(0x116)][_0x237273(0xb8)]);const _0x3f3ea9=await this['cramiPackageEntity']['findOne']({'where':{'id':_0x36fd73}});if(!_0x3f3ea9)throw new common_1[(_0x237273(0xfe))](_0x237273(0x144),common_1['HttpStatus']['BAD_REQUEST']);const {weight:_0x3288d5}=_0x3f3ea9;if(!_0x4bdfa3[_0x237273(0xf5)])_0x1bd6a0={'memberModel3Count':_0x3e3cf2+_0x462e41[_0x237273(0x11b)],'memberModel4Count':_0x59cdc3+_0x462e41[_0x237273(0xd0)],'memberDrawMjCount':_0xa95642+_0x462e41[_0x237273(0x140)],'expirationTime':(0x0,date_1['default'])()[_0x237273(0xcd)](_0x372d7b>0x0?_0x372d7b:0x0,_0x237273(0x12c))[_0x237273(0xeb)](_0x237273(0x100)),'packageId':_0x36fd73};else{const _0x44aafc=await this[_0x237273(0xb6)][_0x237273(0xe1)]({'where':{'id':_0x4bdfa3[_0x237273(0xf5)]}});_0x3288d5>=_0x44aafc[_0x237273(0x123)]&&(_0x1bd6a0={'memberModel3Count':_0x3e3cf2+_0x462e41[_0x237273(0x11b)],'memberModel4Count':_0x59cdc3+_0x462e41[_0x237273(0xd0)],'memberDrawMjCount':_0xa95642+_0x462e41['drawMjCount'],'expirationTime':(0x0,date_1['default'])(_0x4bdfa3[_0x237273(0xb4)])[_0x237273(0xcd)](_0x372d7b>0x0?_0x372d7b:0x0,_0x237273(0x12c))[_0x237273(0xeb)]('YYYY-MM-DD\x20HH:mm:ss'),'packageId':_0x36fd73}),_0x3288d5<_0x44aafc[_0x237273(0x123)]&&(_0x1bd6a0={'memberModel3Count':_0x3e3cf2+_0x462e41[_0x237273(0x11b)],'memberModel4Count':_0x59cdc3+_0x462e41[_0x237273(0xd0)],'memberDrawMjCount':_0xa95642+_0x462e41[_0x237273(0x140)]});}}_0x372d7b<=0x0&&(_0x1bd6a0={'model3Count':_0x1e36e4+_0x462e41[_0x237273(0x11b)],'model4Count':_0x5d45ca+_0x462e41[_0x237273(0xd0)],'drawMjCount':_0x8d9958+_0x462e41['drawMjCount']});const _0x4e7f4b=await this['userBalanceEntity'][_0x237273(0xac)]({'userId':_0x408fd9},_0x1bd6a0);if(_0x4e7f4b[_0x237273(0x10e)]===0x0)throw new common_1[(_0x237273(0xfe))](_0x408fd9+_0x237273(0xd1),common_1[_0x237273(0x116)]['BAD_REQUEST']);}catch(_0xfea1d5){console[_0x237273(0xfa)](_0x237273(0xd4),_0xfea1d5);throw new common_1[(_0x237273(0xfe))]('用户充值失败！',common_1[_0x237273(0x116)][_0x237273(0xb8)]);}}async[_0x4bab2a(0xab)](_0x987f1c){const _0xb7e5e6=_0x4bab2a;console[_0xb7e5e6(0xfa)]('充值的工单信息:',_0x987f1c);try{const {userId:_0x4e26de,goodsId:_0x393d20}=_0x987f1c,_0x437f6f=await this['cramiPackageEntity'][_0xb7e5e6(0xe1)]({'where':{'id':_0x987f1c[_0xb7e5e6(0x127)],'status':0x1}});if(!_0x437f6f)throw new common_1[(_0xb7e5e6(0xfe))]('非法操作、当前充值套餐暂不存在！',common_1[_0xb7e5e6(0x116)][_0xb7e5e6(0xb8)]);const {model3Count:_0x554067,model4Count:_0x5c93a8,drawMjCount:_0x364ccb,days:_0x19ef20,name:_0x3c0b6f}=_0x437f6f,_0x3edd67={'model3Count':_0x554067,'model4Count':_0x5c93a8,'drawMjCount':_0x364ccb,'days':_0x19ef20,'packageId':_0x987f1c[_0xb7e5e6(0x127)]};await this['addBalanceToUser'](_0x4e26de,_0x3edd67,_0x19ef20),await this[_0xb7e5e6(0x12a)]({'userId':_0x4e26de,'rechargeType':balance_constant_1[_0xb7e5e6(0xda)][_0xb7e5e6(0x136)],'model3Count':_0x554067,'model4Count':_0x5c93a8,'drawMjCount':_0x364ccb,'pkgName':_0x3c0b6f,'days':_0x19ef20});}catch(_0xe40d8){console[_0xb7e5e6(0xfa)]('error:\x20',_0xe40d8);throw new common_1[(_0xb7e5e6(0xfe))](_0xb7e5e6(0x113),common_1[_0xb7e5e6(0x116)][_0xb7e5e6(0xb8)]);}}async['getRechargeLog'](_0x4dc171,_0x5b43c1){const _0x2f8e9c=_0x4bab2a,{page:page=0x1,size:size=0x14}=_0x5b43c1,{id:_0xa53988}=_0x4dc171['user'],[_0x1da635,_0x5de556]=await this[_0x2f8e9c(0xd9)][_0x2f8e9c(0x11f)]({'where':{'userId':_0xa53988},'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size});return _0x1da635[_0x2f8e9c(0x110)](_0x3d3c51=>{const _0x4ade3d=_0x2f8e9c;_0x3d3c51[_0x4ade3d(0xae)]=_0x3d3c51[_0x4ade3d(0x139)]>0x0?_0x3d3c51['days']+'天':'永久';}),{'rows':(0x0,date_1['formatCreateOrUpdateDate'])(_0x1da635),'count':_0x5de556};}async[_0x4bab2a(0xfd)](_0x35b07a,_0x2787a2){const _0x280a98=_0x4bab2a;try{const {page:page=0x1,size:size=0xa,userId:_0x19ee92,rechargeType:_0x1e19cf,packageId:_0x19fbf6}=_0x2787a2,{role:_0x2a29d4}=_0x35b07a['user'],_0x4ad3e0={};_0x1e19cf&&(_0x4ad3e0[_0x280a98(0xb1)]=_0x1e19cf),_0x4ad3e0['userId']=_0x19ee92||(0x0,typeorm_2[_0x280a98(0x11d)])(0x186a0),_0x19fbf6&&(_0x4ad3e0[_0x280a98(0xf5)]={'$like':'%'+_0x19fbf6+'%'});const [_0x2e8427,_0x539ea8]=await this[_0x280a98(0xd9)][_0x280a98(0x11f)]({'where':_0x4ad3e0,'order':{'id':_0x280a98(0x146)},'skip':(page-0x1)*size,'take':size}),_0x16fe93=_0x2e8427[_0x280a98(0xb3)](_0x41c4d7=>_0x41c4d7[_0x280a98(0x112)]),_0x33a581=await this[_0x280a98(0x12b)][_0x280a98(0xee)]({'where':{'id':(0x0,typeorm_2['In'])(_0x16fe93)}});return _0x2e8427['forEach'](_0x53c702=>{const _0x2294df=_0x280a98,_0x3c7a36=_0x33a581[_0x2294df(0xee)](_0x3f1b16=>_0x3f1b16['id']===_0x53c702['userId']);_0x53c702['username']=_0x3c7a36===null||_0x3c7a36===void 0x0?void 0x0:_0x3c7a36['username'],_0x53c702[_0x2294df(0x111)]=_0x3c7a36===null||_0x3c7a36===void 0x0?void 0x0:_0x3c7a36[_0x2294df(0x111)],_0x53c702[_0x2294df(0xbf)]=_0x3c7a36===null||_0x3c7a36===void 0x0?void 0x0:_0x3c7a36[_0x2294df(0xbf)],_0x53c702[_0x2294df(0xbe)]=_0x3c7a36===null||_0x3c7a36===void 0x0?void 0x0:_0x3c7a36['status'],_0x53c702[_0x2294df(0x129)]=_0x3c7a36===null||_0x3c7a36===void 0x0?void 0x0:_0x3c7a36[_0x2294df(0x129)];}),_0x2a29d4!==_0x280a98(0x104)&&_0x2e8427[_0x280a98(0x110)](_0x30a701=>{const _0x570c7f=_0x280a98;_0x30a701['email']=_0x30a701[_0x570c7f(0x111)]?(0x0,utils_1[_0x570c7f(0x124)])(_0x30a701[_0x570c7f(0x111)]):'',_0x30a701[_0x570c7f(0xbf)]=_0x30a701[_0x570c7f(0xbf)]?(0x0,utils_1[_0x570c7f(0x124)])(_0x30a701[_0x570c7f(0xbf)]):'';}),{'rows':_0x2e8427,'count':_0x539ea8};}catch(_0x445cd5){console[_0x280a98(0xfa)](_0x280a98(0xd4),_0x445cd5);throw new common_1[(_0x280a98(0xfe))]('查询用户账户失败！',common_1[_0x280a98(0x116)][_0x280a98(0xb8)]);}}async[_0x4bab2a(0x142)](_0xb35bd2){const _0x3efd26=_0x4bab2a;return await this[_0x3efd26(0xe4)][_0x3efd26(0xee)]({'where':{'userId':(0x0,typeorm_2['In'])(_0xb35bd2)}});}async[_0x4bab2a(0x143)](_0x41a933,_0x5eaba3){const _0x325504=_0x4bab2a;return await this[_0x325504(0xe2)](_0x41a933,'mjDraw',-_0x5eaba3);}async[_0x4bab2a(0x132)](_0x11aa9d){const _0x4d6866=_0x4bab2a,{fingerprint:_0x45b415}=_0x11aa9d['headers'],{id:_0x2dc141}=_0x11aa9d[_0x4d6866(0x101)];return await this[_0x4d6866(0xdb)][_0x4d6866(0xac)]({'userId':Number(_0x45b415)},{'userId':_0x2dc141}),await this['chatGroupEntity'][_0x4d6866(0xac)]({'userId':Number(_0x45b415)},{'userId':_0x2dc141}),0x1;}async[_0x4bab2a(0x147)](_0x37aa05){const _0x5a0104=_0x4bab2a,{fingerprint:_0x350a45}=_0x37aa05[_0x5a0104(0x134)],_0x9c9a72=await this[_0x5a0104(0xdb)][_0x5a0104(0xef)]({'where':{'userId':_0x350a45}}),_0x2bd485=await this[_0x5a0104(0xb5)][_0x5a0104(0xef)]({'where':{'userId':_0x350a45}});return _0x9c9a72||_0x2bd485||0x0;}async[_0x4bab2a(0xe3)](_0x438811){const _0x34575d=_0x4bab2a,_0x8129bf=await this[_0x34575d(0x12b)][_0x34575d(0xe1)]({'where':{'id':_0x438811}}),_0x1be2bf=await this[_0x34575d(0xe4)][_0x34575d(0xe1)]({'where':{'userId':_0x438811}});if(!_0x8129bf||!_0x1be2bf)return;const {phoneValidationMessageCount:_0xa6d44c,identityVerificationMessageCount:_0x3d473d,openIdentity:_0x3c0634,openPhoneValidation:_0x5753a6}=await this['globalConfigService']['getConfigs']([_0x34575d(0x13d),_0x34575d(0x13e),_0x34575d(0x125),'openPhoneValidation']),_0x482354=Number(_0xa6d44c),_0x497e8c=Number(_0x3d473d),_0x377b4d=Number(_0x1be2bf[_0x34575d(0x107)])||0x0,_0x27c4cc=Number(_0x1be2bf['useModel4Count'])||0x0,_0x47de8c=_0x377b4d+_0x27c4cc;if(_0x5753a6==='1'&&_0x47de8c>=_0x482354&&!_0x8129bf[_0x34575d(0xbf)])throw new common_1[(_0x34575d(0xfe))]('请完成手机号绑定',common_1[_0x34575d(0x116)][_0x34575d(0xb8)]);if(_0x3c0634==='1'&&_0x47de8c>=_0x497e8c&&(!_0x8129bf['realName']||!_0x8129bf['idCard']))throw new common_1[(_0x34575d(0xfe))](_0x34575d(0xc6),common_1[_0x34575d(0x116)][_0x34575d(0xb8)]);}};UserBalanceService=__decorate([(0x0,common_1[_0x4bab2a(0x117)])(),__param(0x0,(0x0,typeorm_1[_0x4bab2a(0xe7)])(balance_entity_1[_0x4bab2a(0x131)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(userBalance_entity_1[_0x4bab2a(0x102)])),__param(0x2,(0x0,typeorm_1[_0x4bab2a(0xe7)])(accountLog_entity_1[_0x4bab2a(0xcf)])),__param(0x3,(0x0,typeorm_1[_0x4bab2a(0xe7)])(cramiPackage_entity_1[_0x4bab2a(0xf1)])),__param(0x4,(0x0,typeorm_1[_0x4bab2a(0xe7)])(config_entity_1[_0x4bab2a(0xe9)])),__param(0x5,(0x0,typeorm_1[_0x4bab2a(0xe7)])(user_entity_1['UserEntity'])),__param(0x6,(0x0,typeorm_1['InjectRepository'])(fingerprint_entity_1[_0x4bab2a(0xc0)])),__param(0x7,(0x0,typeorm_1[_0x4bab2a(0xe7)])(chatGroup_entity_1['ChatGroupEntity'])),__param(0x8,(0x0,typeorm_1[_0x4bab2a(0xe7)])(chatLog_entity_1[_0x4bab2a(0xb7)])),__metadata(_0x4bab2a(0xc2),[typeorm_2[_0x4bab2a(0x118)],typeorm_2['Repository'],typeorm_2[_0x4bab2a(0x118)],typeorm_2[_0x4bab2a(0x118)],typeorm_2[_0x4bab2a(0x118)],typeorm_2[_0x4bab2a(0x118)],typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2[_0x4bab2a(0x118)],globalConfig_service_1[_0x4bab2a(0xc3)]])],UserBalanceService),exports[_0x4bab2a(0xd6)]=UserBalanceService;