'use strict';const _0x2382e1=_0x13b3;(function(_0x3c3ed8,_0x2fd29e){const _0x1978ca=_0x13b3,_0x5a4496=_0x3c3ed8();while(!![]){try{const _0x3acc12=-parseInt(_0x1978ca(0x1c5))/0x1*(parseInt(_0x1978ca(0x1c9))/0x2)+-parseInt(_0x1978ca(0x181))/0x3+parseInt(_0x1978ca(0x19b))/0x4*(-parseInt(_0x1978ca(0x177))/0x5)+-parseInt(_0x1978ca(0x18e))/0x6+parseInt(_0x1978ca(0x186))/0x7+-parseInt(_0x1978ca(0x1e5))/0x8+parseInt(_0x1978ca(0x1dd))/0x9*(parseInt(_0x1978ca(0x1ce))/0xa);if(_0x3acc12===_0x2fd29e)break;else _0x5a4496['push'](_0x5a4496['shift']());}catch(_0x554916){_0x5a4496['push'](_0x5a4496['shift']());}}}(_0x2027,0x7d5e4));var __decorate=this&&this[_0x2382e1(0x189)]||function(_0x587bb9,_0xc802e7,_0x2fa5d0,_0x10459a){const _0x298851=_0x2382e1;var _0x34dff3=arguments[_0x298851(0x1b2)],_0x331026=_0x34dff3<0x3?_0xc802e7:_0x10459a===null?_0x10459a=Object[_0x298851(0x1b7)](_0xc802e7,_0x2fa5d0):_0x10459a,_0x2b1279;if(typeof Reflect===_0x298851(0x16f)&&typeof Reflect[_0x298851(0x1d9)]===_0x298851(0x1d7))_0x331026=Reflect['decorate'](_0x587bb9,_0xc802e7,_0x2fa5d0,_0x10459a);else{for(var _0x4662d3=_0x587bb9[_0x298851(0x1b2)]-0x1;_0x4662d3>=0x0;_0x4662d3--)if(_0x2b1279=_0x587bb9[_0x4662d3])_0x331026=(_0x34dff3<0x3?_0x2b1279(_0x331026):_0x34dff3>0x3?_0x2b1279(_0xc802e7,_0x2fa5d0,_0x331026):_0x2b1279(_0xc802e7,_0x2fa5d0))||_0x331026;}return _0x34dff3>0x3&&_0x331026&&Object[_0x298851(0x170)](_0xc802e7,_0x2fa5d0,_0x331026),_0x331026;},__metadata=this&&this[_0x2382e1(0x1db)]||function(_0x53c70a,_0x3b877d){const _0x416b55=_0x2382e1;if(typeof Reflect===_0x416b55(0x16f)&&typeof Reflect[_0x416b55(0x1b6)]==='function')return Reflect[_0x416b55(0x1b6)](_0x53c70a,_0x3b877d);},__param=this&&this[_0x2382e1(0x1f0)]||function(_0x43a6e1,_0x222e77){return function(_0x281617,_0x65e6b3){_0x222e77(_0x281617,_0x65e6b3,_0x43a6e1);};};Object[_0x2382e1(0x170)](exports,_0x2382e1(0x167),{'value':!![]}),exports[_0x2382e1(0x1cd)]=void 0x0;const balance_constant_1=require('../../common/constants/balance.constant'),utils_1=require(_0x2382e1(0x1ee)),common_1=require(_0x2382e1(0x199)),typeorm_1=require(_0x2382e1(0x1af)),typeorm_2=require('typeorm'),cramiPackage_entity_1=require(_0x2382e1(0x1b4)),config_entity_1=require(_0x2382e1(0x1ae)),globalConfig_service_1=require(_0x2382e1(0x165)),accountLog_entity_1=require('./accountLog.entity'),balance_entity_1=require(_0x2382e1(0x17c)),userBalance_entity_1=require('./userBalance.entity'),date_1=require(_0x2382e1(0x172)),chatGroup_entity_1=require(_0x2382e1(0x16a)),chatLog_entity_1=require('../chatLog/chatLog.entity'),user_entity_1=require(_0x2382e1(0x1ad)),fingerprint_entity_1=require(_0x2382e1(0x1e4));function _0x2027(){const _0x47779f=['mjDraw','../../common/utils','expirationTime','__param','SCAN_PAY','log','cramiPackageEntity','YYYY-MM-DD\x20HH:mm:ss','firstRregisterSendDrawMjCount','day','days','消费余额失败！','REG_GIFT','当前用户无需创建账户信息！','visitorMJNum','./../globalConfig/globalConfig.service','Injectable','__esModule','getRechargeLog','find','../chatGroup/chatGroup.entity','email','count','checkUserCertification','weight','object','defineProperty','model3Count','../../common/utils/date','isUpdatedToday','drawMjCount','ConfigEntity','isInteger','8815VpowGm','memberModel3Count','saveRecordRechargeLog','用户充值失败！','registerSendStatus','./balance.entity','headers','default','status','getVisitorCount','237099vFvkvj','realName','memberDrawMjCount','validateVisitorBalance','save','4966955ggsfuC','super','注册赠送失败,请联系管理员！','__decorate','HttpException','userBalanceEntity','BalanceEntity','InjectRepository','130302Xnsuub','useModel4Token','forEach','请完成手机号绑定','max','phoneValidationMessageCount','HttpStatus','chatLogEntity','getConfigs','GlobalConfigService','deductFromBalance','@nestjs/common','Token','1084fNwnym','非法操作、当前充值套餐暂不存在！','openPhoneValidation','当前用户不存在,记录充值日志异常','fingerprintLogEntity','积分不足，继续体验服务，请按需选购套餐！','getAccountLog','今日体验额度使用完毕，请注册使用完整服务！','configEntity','goodsId','configKey','userEntity','globalConfigService','inheritVisitorData','balanceEntity','add','addBalanceToUser','identityVerificationMessageCount','../user/user.entity','../globalConfig/config.entity','@nestjs/typeorm','DESC','firstRegisterSendStatus','length','缺失当前套餐ID、充值失败！','../crami/cramiPackage.entity','packageId','metadata','getOwnPropertyDescriptor','registerSendModel3Count','addBalanceToOrder','model4Count','update','请完成实名认证','hideString','replace','memberModel4Count','expireDateCn','idCard','error:\x20','affected','firstRegisterSendRank','234211Zywnnc','chatGroupEntity','queryUserBalance','UserBalanceEntity','4ncWLSo','findAndCount','Repository','PAYMENT_REQUIRED','UserBalanceService','181180RWzoCG','map','BAD_REQUEST','useModel4Count','useModel3Count','registerSendModel4Count','RechargeType','YYYY-MM-DD','user','function','useModel3Token','decorate','useDrawMjToken','__metadata','firstRregisterSendModel4Count','549UDkTUB','ChatGroupEntity','Count','accountLogEntity','avatar','查询用户账户失败！','缺失当前用户账户记录！','./fingerprint.entity','2034480ntgJpz','userId','createBaseUserBalance','findOne','visitor','充值失败','phone','CramiPackageEntity'];_0x2027=function(){return _0x47779f;};return _0x2027();}let UserBalanceService=class UserBalanceService{constructor(_0x18e85c,_0x576b85,_0x8fdcf2,_0x4e83fb,_0x3abacc,_0x298924,_0x3c75ec,_0x3d7185,_0x385f15,_0x16af52){const _0x57d59c=_0x2382e1;this[_0x57d59c(0x1a9)]=_0x18e85c,this[_0x57d59c(0x18b)]=_0x576b85,this[_0x57d59c(0x1e0)]=_0x8fdcf2,this['cramiPackageEntity']=_0x4e83fb,this[_0x57d59c(0x1a3)]=_0x3abacc,this[_0x57d59c(0x1a6)]=_0x298924,this[_0x57d59c(0x19f)]=_0x3c75ec,this[_0x57d59c(0x1c6)]=_0x3d7185,this[_0x57d59c(0x195)]=_0x385f15,this['globalConfigService']=_0x16af52;}async['addBalanceToNewUser'](_0x3c7467){const _0x31ba5b=_0x2382e1;try{const _0xcc36eb=await this[_0x31ba5b(0x1a3)][_0x31ba5b(0x169)]({'where':{'configKey':(0x0,typeorm_2['In'])(['registerSendStatus',_0x31ba5b(0x1b8),_0x31ba5b(0x1d3),'registerSendDrawMjCount','firstRegisterSendStatus',_0x31ba5b(0x1c4),'firstRregisterSendModel3Count',_0x31ba5b(0x1dc),_0x31ba5b(0x15e)])}}),_0x1933e4=_0xcc36eb['reduce']((_0x10aae7,_0x459bed)=>{const _0x14ba5f=_0x31ba5b,_0x48b77a=Number(_0x459bed['configVal']),_0x12d229=Number[_0x14ba5f(0x176)](_0x48b77a)&&_0x48b77a>0x0?_0x48b77a:0x0;return _0x10aae7[_0x459bed[_0x14ba5f(0x1a5)]]=_0x12d229,_0x10aae7;},{});let _0x1d3d65=0x0,_0x5a66b3=0x0,_0x5d13d6=0x0;_0x1933e4['registerSendStatus']===0x1&&(_0x1d3d65=_0x1d3d65+_0x1933e4[_0x31ba5b(0x1b8)],_0x5a66b3=_0x5a66b3+_0x1933e4[_0x31ba5b(0x1d3)],_0x5d13d6=_0x5d13d6+_0x1933e4['registerSendDrawMjCount']),_0x1933e4[_0x31ba5b(0x17b)]===0x1&&_0x1933e4[_0x31ba5b(0x1b1)]===0x1&&_0x3c7467<=_0x1933e4['firstRegisterSendRank']&&(_0x1d3d65=_0x1d3d65+_0x1933e4['firstRregisterSendModel3Count'],_0x5a66b3=_0x5a66b3+_0x1933e4['firstRregisterSendModel4Count'],_0x5d13d6=_0x5d13d6+_0x1933e4['firstRregisterSendDrawMjCount']),await this[_0x31ba5b(0x179)]({'userId':_0x3c7467,'rechargeType':balance_constant_1[_0x31ba5b(0x1d4)][_0x31ba5b(0x162)],'model3Count':_0x1d3d65,'drawMjCount':_0x5d13d6,'model4Count':_0x5a66b3}),await this['userBalanceEntity'][_0x31ba5b(0x185)]({'userId':_0x3c7467,'model3Count':_0x1d3d65,'model4Count':_0x5a66b3,'drawMjCount':_0x5d13d6,'useTokens':0x0});}catch(_0x2fdb70){console[_0x31ba5b(0x1f2)](_0x31ba5b(0x1c2),_0x2fdb70);throw new common_1['HttpException'](_0x31ba5b(0x188),common_1['HttpStatus']['BAD_REQUEST']);}}async['validateBalance'](_0x439d20,_0x73d349,_0x3d756c){const _0x43da01=_0x2382e1,{id:_0x2681e2,role:_0x3686ae}=_0x439d20['user'];let _0x5b0c80=await this[_0x43da01(0x18b)][_0x43da01(0x1e8)]({'where':{'userId':_0x2681e2}});!_0x5b0c80&&(_0x5b0c80=await this[_0x43da01(0x1e7)](_0x2681e2));if(_0x3686ae===_0x43da01(0x1e9))return this[_0x43da01(0x184)](_0x439d20,_0x73d349,_0x3d756c);const _0x428588=_0x73d349===0x1?_0x43da01(0x178):_0x73d349===0x2?_0x43da01(0x1bf):_0x73d349===0x3?'memberDrawMjCount':null,_0x2d7a2f=_0x73d349===0x1?'model3Count':_0x73d349===0x2?_0x43da01(0x1ba):_0x73d349===0x3?_0x43da01(0x174):null;if(_0x5b0c80['packageId']&&_0x5b0c80[_0x428588]+_0x5b0c80[_0x2d7a2f]<_0x3d756c){if(_0x5b0c80[_0x2d7a2f]<_0x3d756c)throw new common_1[(_0x43da01(0x18a))](_0x43da01(0x1a0),common_1[_0x43da01(0x194)][_0x43da01(0x1cc)]);}if(!_0x5b0c80[_0x43da01(0x1b5)]&&_0x5b0c80[_0x2d7a2f]<_0x3d756c)throw new common_1[(_0x43da01(0x18a))]('积分不足，继续体验服务，请按需选购套餐！',common_1[_0x43da01(0x194)][_0x43da01(0x1cc)]);return _0x5b0c80;}async[_0x2382e1(0x184)](_0x31148d,_0x5df84c,_0x13ede8){const _0xa68351=_0x2382e1,{id:_0x19e9f3}=_0x31148d[_0xa68351(0x1d6)],_0x4c9472=_0x5df84c===0x1?'model3Count':_0x5df84c===0x2?_0xa68351(0x1ba):_0x5df84c===0x3?_0xa68351(0x174):null,_0x281176=new Date(),_0x1cbc02=await this[_0xa68351(0x19f)][_0xa68351(0x1e8)]({'where':{'fingerprint':_0x19e9f3}}),{visitorModel3Num:_0x2bbaa2,visitorModel4Num:_0x20bf50,visitorMJNum:_0xbfacc1}=await this[_0xa68351(0x1a7)]['getConfigs'](['visitorModel3Num','visitorModel4Num',_0xa68351(0x164)]),_0x3ef68c={'model3Count':_0x2bbaa2?Number(_0x2bbaa2):0x0,'model4Count':_0x20bf50?Number(_0x20bf50):0x0,'drawMjCount':_0xbfacc1?Number(_0xbfacc1):0x0};if(!_0x1cbc02){let _0x3a7059={'fingerprint':_0x19e9f3,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0};_0x3a7059[_0x4c9472]=_0x3a7059[_0x4c9472]+_0x13ede8;if(_0x3a7059[_0x4c9472]>_0x3ef68c[_0x4c9472])throw new common_1[(_0xa68351(0x18a))]('今日体验额度使用完毕，请注册使用完整服务！',common_1[_0xa68351(0x194)][_0xa68351(0x1cc)]);else return await this[_0xa68351(0x19f)][_0xa68351(0x185)](_0x3a7059),!![];}else{const {model3Count:_0x396750,model4Count:_0xddcfb7,drawMjCount:_0x5e2851}=_0x1cbc02;let _0x51d8fa={'model3Count':_0x396750,'model4Count':_0xddcfb7,'drawMjCount':_0x5e2851};const _0x1b6d65=Number(new Date(_0x1cbc02['updatedAt'])),_0x2b0ac0=this[_0xa68351(0x173)](_0x1b6d65);_0x2b0ac0?_0x51d8fa[_0x4c9472]=_0x51d8fa[_0x4c9472]+_0x13ede8:(_0x51d8fa={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x51d8fa[_0x4c9472]=_0x51d8fa[_0x4c9472]+_0x13ede8);if(_0x51d8fa[_0x4c9472]>_0x3ef68c[_0x4c9472])throw new common_1[(_0xa68351(0x18a))](_0xa68351(0x1a2),common_1[_0xa68351(0x194)][_0xa68351(0x1cc)]);else return await this[_0xa68351(0x19f)][_0xa68351(0x1bb)]({'fingerprint':_0x19e9f3},_0x51d8fa),!![];}}[_0x2382e1(0x173)](_0x548100){const _0x4b6934=new Date(),_0x4f0695=new Date(_0x4b6934['getFullYear'](),_0x4b6934['getMonth'](),_0x4b6934['getDate']());return _0x548100>=_0x4f0695;}async[_0x2382e1(0x198)](_0x5a19c0,_0x481891,_0x50bdbe,_0x4afdcf=0x0){const _0x3b7276=_0x2382e1,_0x46cd57=await this[_0x3b7276(0x18b)]['findOne']({'where':{'userId':_0x5a19c0}});if(!_0x46cd57)throw new common_1['HttpException'](_0x3b7276(0x1e3),common_1[_0x3b7276(0x194)][_0x3b7276(0x1d0)]);const _0x1e60d3={0x1:{'member':'memberModel3Count','nonMember':_0x3b7276(0x171),'token':_0x3b7276(0x1d8)},0x2:{'member':_0x3b7276(0x1bf),'nonMember':_0x3b7276(0x1ba),'token':_0x3b7276(0x18f)},0x3:{'member':_0x3b7276(0x183),'nonMember':_0x3b7276(0x174),'token':'useDrawMjToken'}},{member:_0x2da55f,nonMember:_0x2cdcb3,token:_0x196ce7}=_0x1e60d3[_0x481891];let _0x17937e=_0x50bdbe,_0x2f976d=Math[_0x3b7276(0x192)](_0x46cd57[_0x2da55f]-_0x17937e,0x0);_0x17937e-=_0x46cd57[_0x2da55f]-_0x2f976d;let _0x25990c=_0x46cd57[_0x2cdcb3];_0x17937e>0x0&&(_0x25990c=Math[_0x3b7276(0x192)](_0x46cd57[_0x2cdcb3]-_0x17937e,0x0),_0x17937e-=_0x46cd57[_0x2cdcb3]-_0x25990c);const _0x4a72b7={[_0x2da55f]:_0x2f976d,[_0x2cdcb3]:_0x25990c,[_0x196ce7]:(_0x46cd57[_0x196ce7]||0x0)+_0x4afdcf};(_0x196ce7===_0x3b7276(0x1d8)||_0x196ce7===_0x3b7276(0x18f))&&(_0x4a72b7[_0x196ce7[_0x3b7276(0x1be)]('Token',_0x3b7276(0x1df))]=(_0x46cd57[_0x196ce7[_0x3b7276(0x1be)](_0x3b7276(0x19a),_0x3b7276(0x1df))]||0x0)+_0x50bdbe);const _0x7d7eaa=await this[_0x3b7276(0x18b)][_0x3b7276(0x1bb)]({'userId':_0x5a19c0},_0x4a72b7);if(_0x7d7eaa[_0x3b7276(0x1c3)]===0x0)throw new common_1['HttpException'](_0x3b7276(0x161),common_1['HttpStatus'][_0x3b7276(0x1d0)]);}async['queryUserBalance'](_0x16a8d1){const _0x22c3ef=_0x2382e1;try{const _0x5399eb=await this[_0x22c3ef(0x18b)][_0x22c3ef(0x1e8)]({'where':{'userId':_0x16a8d1},'select':[_0x22c3ef(0x1b5),_0x22c3ef(0x171),'model4Count','drawMjCount',_0x22c3ef(0x178),_0x22c3ef(0x1bf),_0x22c3ef(0x183),_0x22c3ef(0x1d2),_0x22c3ef(0x1d1),_0x22c3ef(0x1d8),_0x22c3ef(0x18f),_0x22c3ef(0x1da),_0x22c3ef(0x1ef)]});if(!_0x5399eb){const _0x222156=await this['createBaseUserBalance'](_0x16a8d1);if(_0x222156)return await this[_0x22c3ef(0x1c7)](_0x16a8d1);else throw new common_1[(_0x22c3ef(0x18a))]('查询当前用户余额失败！',common_1[_0x22c3ef(0x194)][_0x22c3ef(0x1d0)]);}return _0x5399eb['sumModel3Count']=_0x5399eb[_0x22c3ef(0x1b5)]?_0x5399eb[_0x22c3ef(0x171)]+_0x5399eb[_0x22c3ef(0x178)]:_0x5399eb[_0x22c3ef(0x171)],_0x5399eb['sumModel4Count']=_0x5399eb[_0x22c3ef(0x1b5)]?_0x5399eb[_0x22c3ef(0x1ba)]+_0x5399eb[_0x22c3ef(0x1bf)]:_0x5399eb[_0x22c3ef(0x1ba)],_0x5399eb['sumDrawMjCount']=_0x5399eb['packageId']?_0x5399eb[_0x22c3ef(0x174)]+_0x5399eb['memberDrawMjCount']:_0x5399eb[_0x22c3ef(0x174)],_0x5399eb[_0x22c3ef(0x1ef)]=_0x5399eb['expirationTime']?(0x0,date_1['formatDate'])(_0x5399eb['expirationTime'],_0x22c3ef(0x1d5)):null,_0x5399eb;}catch(_0x17fbb4){console['log'](_0x22c3ef(0x1c2),_0x17fbb4);}}async['saveRecordRechargeLog'](_0x4758f9){const _0x2011d0=_0x2382e1,{userId:_0x2fab1e,rechargeType:_0x38b435,model3Count:_0x47b2cc,model4Count:_0x375a99,drawMjCount:_0x1555e8,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x4758f9;if(!_0x2fab1e)throw new common_1[(_0x2011d0(0x18a))](_0x2011d0(0x19e),common_1[_0x2011d0(0x194)][_0x2011d0(0x1d0)]);const _0x125999=(0x0,utils_1['createRandomUid'])();return await this[_0x2011d0(0x1e0)][_0x2011d0(0x185)]({'userId':_0x2fab1e,'rechargeType':_0x38b435,'model3Count':_0x47b2cc,'model4Count':_0x375a99,'drawMjCount':_0x1555e8,'days':days,'extent':extent,'uid':_0x125999,'pkgName':pkgName});}async[_0x2382e1(0x1e7)](_0x5192ae,_0x3113b8={}){const _0x41c2df=_0x2382e1,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x3113b8,_0x2fa8cc=await this['userBalanceEntity'][_0x41c2df(0x1e8)]({'where':{'userId':_0x5192ae}});if(_0x2fa8cc)throw new common_1['HttpException'](_0x41c2df(0x163),common_1['HttpStatus'][_0x41c2df(0x1d0)]);return await this[_0x41c2df(0x18b)][_0x41c2df(0x185)]({'userId':_0x5192ae,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async[_0x2382e1(0x1ab)](_0x20d5c3,_0x21b111,_0x3a4faa=-0x1){const _0x31fda7=_0x2382e1;try{const _0x3a01ed=await this['userBalanceEntity'][_0x31fda7(0x1e8)]({'where':{'userId':_0x20d5c3}})||await this[_0x31fda7(0x1e7)](_0x20d5c3);if(!_0x3a01ed)throw new common_1[(_0x31fda7(0x18a))]('查询用户账户信息失败！',common_1['HttpStatus'][_0x31fda7(0x1d0)]);const {model3Count:_0x15e0a4,model4Count:_0x412ae4,drawMjCount:_0x1249ef,memberModel3Count:_0x41245e,memberModel4Count:_0x5efa49,memberDrawMjCount:_0x1f350f}=_0x3a01ed;let _0x4d0562={};if(_0x3a4faa>0x0){const {packageId:_0x2d16ce}=_0x21b111;if(!_0x2d16ce)throw new common_1[(_0x31fda7(0x18a))](_0x31fda7(0x1b3),common_1[_0x31fda7(0x194)][_0x31fda7(0x1d0)]);const _0x4f6ae5=await this['cramiPackageEntity'][_0x31fda7(0x1e8)]({'where':{'id':_0x2d16ce}});if(!_0x4f6ae5)throw new common_1['HttpException']('当前套餐不存在！',common_1[_0x31fda7(0x194)][_0x31fda7(0x1d0)]);const {weight:_0x4b2123}=_0x4f6ae5;if(!_0x3a01ed[_0x31fda7(0x1b5)])_0x4d0562={'memberModel3Count':_0x41245e+_0x21b111[_0x31fda7(0x171)],'memberModel4Count':_0x5efa49+_0x21b111['model4Count'],'memberDrawMjCount':_0x1f350f+_0x21b111[_0x31fda7(0x174)],'expirationTime':(0x0,date_1[_0x31fda7(0x17e)])()[_0x31fda7(0x1aa)](_0x3a4faa>0x0?_0x3a4faa:0x0,_0x31fda7(0x15f))['format'](_0x31fda7(0x1f4)),'packageId':_0x2d16ce};else{const _0x4379c5=await this[_0x31fda7(0x1f3)]['findOne']({'where':{'id':_0x3a01ed[_0x31fda7(0x1b5)]}});_0x4b2123>=_0x4379c5[_0x31fda7(0x16e)]&&(_0x4d0562={'memberModel3Count':_0x41245e+_0x21b111[_0x31fda7(0x171)],'memberModel4Count':_0x5efa49+_0x21b111[_0x31fda7(0x1ba)],'memberDrawMjCount':_0x1f350f+_0x21b111[_0x31fda7(0x174)],'expirationTime':(0x0,date_1[_0x31fda7(0x17e)])(_0x3a01ed[_0x31fda7(0x1ef)])['add'](_0x3a4faa>0x0?_0x3a4faa:0x0,_0x31fda7(0x15f))['format'](_0x31fda7(0x1f4)),'packageId':_0x2d16ce}),_0x4b2123<_0x4379c5[_0x31fda7(0x16e)]&&(_0x4d0562={'memberModel3Count':_0x41245e+_0x21b111[_0x31fda7(0x171)],'memberModel4Count':_0x5efa49+_0x21b111['model4Count'],'memberDrawMjCount':_0x1f350f+_0x21b111[_0x31fda7(0x174)]});}}_0x3a4faa<=0x0&&(_0x4d0562={'model3Count':_0x15e0a4+_0x21b111['model3Count'],'model4Count':_0x412ae4+_0x21b111[_0x31fda7(0x1ba)],'drawMjCount':_0x1249ef+_0x21b111[_0x31fda7(0x174)]});const _0x401a4a=await this[_0x31fda7(0x18b)][_0x31fda7(0x1bb)]({'userId':_0x20d5c3},_0x4d0562);if(_0x401a4a['affected']===0x0)throw new common_1['HttpException'](_0x20d5c3+_0x31fda7(0x1ea),common_1[_0x31fda7(0x194)][_0x31fda7(0x1d0)]);}catch(_0x4a669e){console['log']('error:\x20',_0x4a669e);throw new common_1['HttpException'](_0x31fda7(0x17a),common_1[_0x31fda7(0x194)][_0x31fda7(0x1d0)]);}}async[_0x2382e1(0x1b9)](_0x1a59f7){const _0x4684e3=_0x2382e1;console['log']('充值的工单信息:',_0x1a59f7);try{const {userId:_0x7f6851,goodsId:_0x15e5c8}=_0x1a59f7,_0x2f4de3=await this[_0x4684e3(0x1f3)][_0x4684e3(0x1e8)]({'where':{'id':_0x1a59f7['goodsId'],'status':0x1}});if(!_0x2f4de3)throw new common_1['HttpException'](_0x4684e3(0x19c),common_1[_0x4684e3(0x194)][_0x4684e3(0x1d0)]);const {model3Count:_0x33dc26,model4Count:_0x46bf1d,drawMjCount:_0x14267e,days:_0x2daa23,name:_0x5db9a1}=_0x2f4de3,_0x58b291={'model3Count':_0x33dc26,'model4Count':_0x46bf1d,'drawMjCount':_0x14267e,'days':_0x2daa23,'packageId':_0x1a59f7[_0x4684e3(0x1a4)]};await this[_0x4684e3(0x1ab)](_0x7f6851,_0x58b291,_0x2daa23),await this['saveRecordRechargeLog']({'userId':_0x7f6851,'rechargeType':balance_constant_1['RechargeType'][_0x4684e3(0x1f1)],'model3Count':_0x33dc26,'model4Count':_0x46bf1d,'drawMjCount':_0x14267e,'pkgName':_0x5db9a1,'days':_0x2daa23});}catch(_0x597134){console[_0x4684e3(0x1f2)](_0x4684e3(0x1c2),_0x597134);throw new common_1[(_0x4684e3(0x18a))]('充值失败！',common_1[_0x4684e3(0x194)][_0x4684e3(0x1d0)]);}}async[_0x2382e1(0x168)](_0x1d028a,_0x45b83e){const _0x5ce071=_0x2382e1,{page:page=0x1,size:size=0x14}=_0x45b83e,{id:_0x192c50}=_0x1d028a['user'],[_0x48724f,_0x2caad0]=await this['accountLogEntity'][_0x5ce071(0x1ca)]({'where':{'userId':_0x192c50},'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size});return _0x48724f['forEach'](_0x3ab2bb=>{const _0x2bcad1=_0x5ce071;_0x3ab2bb[_0x2bcad1(0x1c0)]=_0x3ab2bb[_0x2bcad1(0x160)]>0x0?_0x3ab2bb[_0x2bcad1(0x160)]+'天':'永久';}),{'rows':(0x0,date_1['formatCreateOrUpdateDate'])(_0x48724f),'count':_0x2caad0};}async[_0x2382e1(0x1a1)](_0x4132c2,_0x15d1d4){const _0x53097c=_0x2382e1;try{const {page:page=0x1,size:size=0xa,userId:_0x4588df,rechargeType:_0x29edce,packageId:_0x5039b3}=_0x15d1d4,{role:_0x4a8397}=_0x4132c2['user'],_0x58315f={};_0x29edce&&(_0x58315f['rechargeType']=_0x29edce),_0x58315f[_0x53097c(0x1e6)]=_0x4588df||(0x0,typeorm_2['LessThan'])(0x186a0),_0x5039b3&&(_0x58315f[_0x53097c(0x1b5)]={'$like':'%'+_0x5039b3+'%'});const [_0x22dfb6,_0x250962]=await this[_0x53097c(0x1e0)]['findAndCount']({'where':_0x58315f,'order':{'id':_0x53097c(0x1b0)},'skip':(page-0x1)*size,'take':size}),_0x476b53=_0x22dfb6[_0x53097c(0x1cf)](_0x45f981=>_0x45f981[_0x53097c(0x1e6)]),_0x29c794=await this[_0x53097c(0x1a6)][_0x53097c(0x169)]({'where':{'id':(0x0,typeorm_2['In'])(_0x476b53)}});return _0x22dfb6['forEach'](_0x4565ba=>{const _0x4bda69=_0x53097c,_0xfab15e=_0x29c794['find'](_0x592211=>_0x592211['id']===_0x4565ba[_0x4bda69(0x1e6)]);_0x4565ba['username']=_0xfab15e===null||_0xfab15e===void 0x0?void 0x0:_0xfab15e['username'],_0x4565ba[_0x4bda69(0x16b)]=_0xfab15e===null||_0xfab15e===void 0x0?void 0x0:_0xfab15e['email'],_0x4565ba[_0x4bda69(0x1eb)]=_0xfab15e===null||_0xfab15e===void 0x0?void 0x0:_0xfab15e['phone'],_0x4565ba[_0x4bda69(0x17f)]=_0xfab15e===null||_0xfab15e===void 0x0?void 0x0:_0xfab15e[_0x4bda69(0x17f)],_0x4565ba['avatar']=_0xfab15e===null||_0xfab15e===void 0x0?void 0x0:_0xfab15e[_0x4bda69(0x1e1)];}),_0x4a8397!==_0x53097c(0x187)&&_0x22dfb6[_0x53097c(0x190)](_0x226db1=>{const _0x1cc602=_0x53097c;_0x226db1[_0x1cc602(0x16b)]=_0x226db1[_0x1cc602(0x16b)]?(0x0,utils_1[_0x1cc602(0x1bd)])(_0x226db1['email']):'',_0x226db1[_0x1cc602(0x1eb)]=_0x226db1['phone']?(0x0,utils_1[_0x1cc602(0x1bd)])(_0x226db1[_0x1cc602(0x1eb)]):'';}),{'rows':_0x22dfb6,'count':_0x250962};}catch(_0x351c8a){console['log'](_0x53097c(0x1c2),_0x351c8a);throw new common_1[(_0x53097c(0x18a))](_0x53097c(0x1e2),common_1['HttpStatus'][_0x53097c(0x1d0)]);}}async['queryUserBalanceByIds'](_0x1ed89c){const _0x73b235=_0x2382e1;return await this[_0x73b235(0x18b)][_0x73b235(0x169)]({'where':{'userId':(0x0,typeorm_2['In'])(_0x1ed89c)}});}async['refundMjBalance'](_0x25fd68,_0x5d937a){const _0x5bbd69=_0x2382e1;return await this[_0x5bbd69(0x198)](_0x25fd68,_0x5bbd69(0x1ed),-_0x5d937a);}async[_0x2382e1(0x1a8)](_0x2d8fb8){const _0x5e9560=_0x2382e1,{fingerprint:_0x1d2224}=_0x2d8fb8[_0x5e9560(0x17d)],{id:_0x423fed}=_0x2d8fb8[_0x5e9560(0x1d6)];return await this['chatLogEntity'][_0x5e9560(0x1bb)]({'userId':Number(_0x1d2224)},{'userId':_0x423fed}),await this['chatGroupEntity']['update']({'userId':Number(_0x1d2224)},{'userId':_0x423fed}),0x1;}async[_0x2382e1(0x180)](_0x2c5de5){const _0x265c7f=_0x2382e1,{fingerprint:_0x321a7c}=_0x2c5de5[_0x265c7f(0x17d)],_0x461708=await this[_0x265c7f(0x195)][_0x265c7f(0x16c)]({'where':{'userId':_0x321a7c}}),_0x59d173=await this['chatGroupEntity'][_0x265c7f(0x16c)]({'where':{'userId':_0x321a7c}});return _0x461708||_0x59d173||0x0;}async[_0x2382e1(0x16d)](_0x2c0c53){const _0x11b1df=_0x2382e1,_0x54dee0=await this['userEntity']['findOne']({'where':{'id':_0x2c0c53}}),_0x5a8c5f=await this['userBalanceEntity']['findOne']({'where':{'userId':_0x2c0c53}});if(!_0x54dee0||!_0x5a8c5f)return;const {phoneValidationMessageCount:_0x33d1fe,identityVerificationMessageCount:_0x2c2312,openIdentity:_0x1eb4a0,openPhoneValidation:_0x6176e3}=await this[_0x11b1df(0x1a7)][_0x11b1df(0x196)]([_0x11b1df(0x193),_0x11b1df(0x1ac),'openIdentity',_0x11b1df(0x19d)]),_0x332b5a=Number(_0x33d1fe),_0x4ea2b4=Number(_0x2c2312),_0x187a7c=Number(_0x5a8c5f['useModel3Count'])||0x0,_0x4d4975=Number(_0x5a8c5f[_0x11b1df(0x1d1)])||0x0,_0x4bd38f=_0x187a7c+_0x4d4975;if(_0x6176e3==='1'&&_0x4bd38f>=_0x332b5a&&!_0x54dee0[_0x11b1df(0x1eb)])throw new common_1[(_0x11b1df(0x18a))](_0x11b1df(0x191),common_1[_0x11b1df(0x194)][_0x11b1df(0x1d0)]);if(_0x1eb4a0==='1'&&_0x4bd38f>=_0x4ea2b4&&(!_0x54dee0[_0x11b1df(0x182)]||!_0x54dee0[_0x11b1df(0x1c1)]))throw new common_1[(_0x11b1df(0x18a))](_0x11b1df(0x1bc),common_1[_0x11b1df(0x194)]['BAD_REQUEST']);}};function _0x13b3(_0x3239f2,_0x388cb4){const _0x2027bd=_0x2027();return _0x13b3=function(_0x13b3d7,_0x114bfa){_0x13b3d7=_0x13b3d7-0x15e;let _0xd5561c=_0x2027bd[_0x13b3d7];return _0xd5561c;},_0x13b3(_0x3239f2,_0x388cb4);}UserBalanceService=__decorate([(0x0,common_1[_0x2382e1(0x166)])(),__param(0x0,(0x0,typeorm_1[_0x2382e1(0x18d)])(balance_entity_1[_0x2382e1(0x18c)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(userBalance_entity_1[_0x2382e1(0x1c8)])),__param(0x2,(0x0,typeorm_1[_0x2382e1(0x18d)])(accountLog_entity_1['AccountLogEntity'])),__param(0x3,(0x0,typeorm_1[_0x2382e1(0x18d)])(cramiPackage_entity_1[_0x2382e1(0x1ec)])),__param(0x4,(0x0,typeorm_1[_0x2382e1(0x18d)])(config_entity_1[_0x2382e1(0x175)])),__param(0x5,(0x0,typeorm_1[_0x2382e1(0x18d)])(user_entity_1['UserEntity'])),__param(0x6,(0x0,typeorm_1[_0x2382e1(0x18d)])(fingerprint_entity_1['FingerprintLogEntity'])),__param(0x7,(0x0,typeorm_1['InjectRepository'])(chatGroup_entity_1[_0x2382e1(0x1de)])),__param(0x8,(0x0,typeorm_1['InjectRepository'])(chatLog_entity_1['ChatLogEntity'])),__metadata('design:paramtypes',[typeorm_2[_0x2382e1(0x1cb)],typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2[_0x2382e1(0x1cb)],typeorm_2[_0x2382e1(0x1cb)],typeorm_2['Repository'],typeorm_2[_0x2382e1(0x1cb)],typeorm_2[_0x2382e1(0x1cb)],typeorm_2['Repository'],globalConfig_service_1[_0x2382e1(0x197)]])],UserBalanceService),exports['UserBalanceService']=UserBalanceService;