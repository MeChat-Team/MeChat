'use strict';const _0x426ea7=_0x2fb9;function _0x354a(){const _0x226ef3=['days','firstRegisterSendStatus','visitorModel4Num','inheritVisitorData','getVisitorCount','当前套餐不存在！','InjectRepository','请完成实名认证','AccountLogEntity','../user/user.entity','Repository','createRandomUid','userId','CramiPackageEntity','查询用户账户信息失败！','__param','ConfigEntity','今日体验额度使用完毕，请注册使用完整服务！','weight','651uxqJPa','ChatGroupEntity','addBalanceToUser','../../common/constants/balance.constant','userEntity','formatDate','phone','refundMjBalance','user','openIdentity','packageId','replace','sumModel4Count','avatar','goodsId','@nestjs/typeorm','formatCreateOrUpdateDate','BalanceEntity','useModel4Count','affected','balanceEntity','userBalanceEntity','__metadata','add','Token','queryUserBalance','63qrmnwK','充值失败','firstRregisterSendModel4Count','充值的工单信息:','registerSendModel3Count','memberModel4Count','积分不足，继续体验服务，请按需选购套餐！','REG_GIFT','realName','SCAN_PAY','getDate','getFullYear','isInteger','33568WomNEk','fingerprintLogEntity','expireDateCn','rechargeType','sumDrawMjCount','email','./userBalance.entity','openPhoneValidation','memberModel3Count','Count','defineProperty','5618820zCKdYq','useDrawMjToken','createBaseUserBalance','sumModel3Count','当前用户无需创建账户信息！','useModel4Token','model4Count','forEach','design:paramtypes','../../common/utils/date','deductFromBalance','缺失当前套餐ID、充值失败！','4235016dZdLcf','chatLogEntity','validateVisitorBalance','visitorModel3Num','checkUserCertification','phoneValidationMessageCount','__decorate','map','visitor','PAYMENT_REQUIRED','2795254WcwQfc','isUpdatedToday','default','drawMjCount','registerSendStatus','metadata','RechargeType','注册赠送失败,请联系管理员！','registerSendDrawMjCount','expirationTime','6336110EFIypP','reduce','log','accountLogEntity','saveRecordRechargeLog','./accountLog.entity','update','max','chatGroupEntity','super','非法操作、当前充值套餐暂不存在！','YYYY-MM-DD','UserBalanceEntity','DESC','configKey','identityVerificationMessageCount','useModel3Count','configEntity','../../common/utils','BAD_REQUEST','registerSendModel4Count','174886OuGcYZ','function','HttpException','format','day','hideString','cramiPackageEntity','idCard','error:\x20','updatedAt','decorate','object','findOne','GlobalConfigService','save','firstRregisterSendDrawMjCount','model3Count','./fingerprint.entity','firstRregisterSendModel3Count','status','YYYY-MM-DD\x20HH:mm:ss','configVal','25316DnYrEA','addBalanceToNewUser','count','1771mYCgJf','globalConfigService','HttpStatus','firstRegisterSendRank','headers','memberDrawMjCount','find','typeorm','@nestjs/common','getMonth'];_0x354a=function(){return _0x226ef3;};return _0x354a();}function _0x2fb9(_0x56a35a,_0x470e2d){const _0x354a2f=_0x354a();return _0x2fb9=function(_0x2fb992,_0x3b29d0){_0x2fb992=_0x2fb992-0x7d;let _0x39cef2=_0x354a2f[_0x2fb992];return _0x39cef2;},_0x2fb9(_0x56a35a,_0x470e2d);}(function(_0x5928d1,_0x5b5ba4){const _0xdfab7a=_0x2fb9,_0x210515=_0x5928d1();while(!![]){try{const _0x124b8f=-parseInt(_0xdfab7a(0xb6))/0x1+-parseInt(_0xdfab7a(0x97))/0x2+-parseInt(_0xdfab7a(0xec))/0x3*(parseInt(_0xdfab7a(0xcc))/0x4)+parseInt(_0xdfab7a(0x81))/0x5+-parseInt(_0xdfab7a(0x8d))/0x6+-parseInt(_0xdfab7a(0xcf))/0x7*(parseInt(_0xdfab7a(0x113))/0x8)+-parseInt(_0xdfab7a(0x106))/0x9*(-parseInt(_0xdfab7a(0xa1))/0xa);if(_0x124b8f===_0x5b5ba4)break;else _0x210515['push'](_0x210515['shift']());}catch(_0x2d57e2){_0x210515['push'](_0x210515['shift']());}}}(_0x354a,0xce78f));var __decorate=this&&this[_0x426ea7(0x93)]||function(_0x589f04,_0x2eb645,_0x3a0112,_0x2b13c4){const _0x1e30f1=_0x426ea7;var _0x45e90b=arguments['length'],_0x456060=_0x45e90b<0x3?_0x2eb645:_0x2b13c4===null?_0x2b13c4=Object['getOwnPropertyDescriptor'](_0x2eb645,_0x3a0112):_0x2b13c4,_0x3e8456;if(typeof Reflect==='object'&&typeof Reflect[_0x1e30f1(0xc0)]===_0x1e30f1(0xb7))_0x456060=Reflect['decorate'](_0x589f04,_0x2eb645,_0x3a0112,_0x2b13c4);else{for(var _0xf0a10f=_0x589f04['length']-0x1;_0xf0a10f>=0x0;_0xf0a10f--)if(_0x3e8456=_0x589f04[_0xf0a10f])_0x456060=(_0x45e90b<0x3?_0x3e8456(_0x456060):_0x45e90b>0x3?_0x3e8456(_0x2eb645,_0x3a0112,_0x456060):_0x3e8456(_0x2eb645,_0x3a0112))||_0x456060;}return _0x45e90b>0x3&&_0x456060&&Object[_0x1e30f1(0x80)](_0x2eb645,_0x3a0112,_0x456060),_0x456060;},__metadata=this&&this[_0x426ea7(0x102)]||function(_0x3794ea,_0x21eb91){const _0x213d3e=_0x426ea7;if(typeof Reflect===_0x213d3e(0xc1)&&typeof Reflect[_0x213d3e(0x9c)]===_0x213d3e(0xb7))return Reflect[_0x213d3e(0x9c)](_0x3794ea,_0x21eb91);},__param=this&&this[_0x426ea7(0xe8)]||function(_0x5be588,_0x35b4dd){return function(_0x5be73e,_0x182b21){_0x35b4dd(_0x5be73e,_0x182b21,_0x5be588);};};Object[_0x426ea7(0x80)](exports,'__esModule',{'value':!![]}),exports['UserBalanceService']=void 0x0;const balance_constant_1=require(_0x426ea7(0xef)),utils_1=require(_0x426ea7(0xb3)),common_1=require(_0x426ea7(0xd7)),typeorm_1=require(_0x426ea7(0xfb)),typeorm_2=require(_0x426ea7(0xd6)),cramiPackage_entity_1=require('../crami/cramiPackage.entity'),config_entity_1=require('../globalConfig/config.entity'),globalConfig_service_1=require('./../globalConfig/globalConfig.service'),accountLog_entity_1=require(_0x426ea7(0xa6)),balance_entity_1=require('./balance.entity'),userBalance_entity_1=require(_0x426ea7(0x119)),date_1=require(_0x426ea7(0x8a)),chatGroup_entity_1=require('../chatGroup/chatGroup.entity'),chatLog_entity_1=require('../chatLog/chatLog.entity'),user_entity_1=require(_0x426ea7(0xe2)),fingerprint_entity_1=require(_0x426ea7(0xc7));let UserBalanceService=class UserBalanceService{constructor(_0x5b99cd,_0x2b7321,_0x37f0dd,_0x4286af,_0xd7cc3d,_0x1b298b,_0xc38553,_0x52cd15,_0x55d8c2,_0x40f3e8){const _0xb2c794=_0x426ea7;this[_0xb2c794(0x100)]=_0x5b99cd,this[_0xb2c794(0x101)]=_0x2b7321,this[_0xb2c794(0xa4)]=_0x37f0dd,this[_0xb2c794(0xbc)]=_0x4286af,this[_0xb2c794(0xb2)]=_0xd7cc3d,this[_0xb2c794(0xf0)]=_0x1b298b,this[_0xb2c794(0x114)]=_0xc38553,this[_0xb2c794(0xa9)]=_0x52cd15,this['chatLogEntity']=_0x55d8c2,this[_0xb2c794(0xd0)]=_0x40f3e8;}async[_0x426ea7(0xcd)](_0x4eb26d){const _0x5bedcb=_0x426ea7;try{const _0x2d46c3=await this[_0x5bedcb(0xb2)][_0x5bedcb(0xd5)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x5bedcb(0x9b),'registerSendModel3Count','registerSendModel4Count',_0x5bedcb(0x9f),_0x5bedcb(0xda),_0x5bedcb(0xd2),_0x5bedcb(0xc8),'firstRregisterSendModel4Count','firstRregisterSendDrawMjCount'])}}),_0x2bdde4=_0x2d46c3[_0x5bedcb(0xa2)]((_0x287660,_0x26e825)=>{const _0x48d407=_0x5bedcb,_0x18021d=Number(_0x26e825[_0x48d407(0xcb)]),_0xf5bc0f=Number[_0x48d407(0x112)](_0x18021d)&&_0x18021d>0x0?_0x18021d:0x0;return _0x287660[_0x26e825[_0x48d407(0xaf)]]=_0xf5bc0f,_0x287660;},{});let _0x2d6904=0x0,_0x125389=0x0,_0x4f05b2=0x0;_0x2bdde4[_0x5bedcb(0x9b)]===0x1&&(_0x2d6904=_0x2d6904+_0x2bdde4[_0x5bedcb(0x10a)],_0x125389=_0x125389+_0x2bdde4[_0x5bedcb(0xb5)],_0x4f05b2=_0x4f05b2+_0x2bdde4['registerSendDrawMjCount']),_0x2bdde4[_0x5bedcb(0x9b)]===0x1&&_0x2bdde4[_0x5bedcb(0xda)]===0x1&&_0x4eb26d<=_0x2bdde4[_0x5bedcb(0xd2)]&&(_0x2d6904=_0x2d6904+_0x2bdde4[_0x5bedcb(0xc8)],_0x125389=_0x125389+_0x2bdde4[_0x5bedcb(0x108)],_0x4f05b2=_0x4f05b2+_0x2bdde4[_0x5bedcb(0xc5)]),await this[_0x5bedcb(0xa5)]({'userId':_0x4eb26d,'rechargeType':balance_constant_1['RechargeType'][_0x5bedcb(0x10d)],'model3Count':_0x2d6904,'drawMjCount':_0x4f05b2,'model4Count':_0x125389}),await this[_0x5bedcb(0x101)][_0x5bedcb(0xc4)]({'userId':_0x4eb26d,'model3Count':_0x2d6904,'model4Count':_0x125389,'drawMjCount':_0x4f05b2,'useTokens':0x0});}catch(_0x1b189e){console[_0x5bedcb(0xa3)](_0x5bedcb(0xbe),_0x1b189e);throw new common_1['HttpException'](_0x5bedcb(0x9e),common_1['HttpStatus'][_0x5bedcb(0xb4)]);}}async['validateBalance'](_0x316248,_0x5874d4,_0xbf1018){const _0x8c710a=_0x426ea7,{id:_0x1c5bcf,role:_0x4e8f8b}=_0x316248['user'];let _0x1ea738=await this[_0x8c710a(0x101)][_0x8c710a(0xc2)]({'where':{'userId':_0x1c5bcf}});!_0x1ea738&&(_0x1ea738=await this['createBaseUserBalance'](_0x1c5bcf));if(_0x4e8f8b===_0x8c710a(0x95))return this[_0x8c710a(0x8f)](_0x316248,_0x5874d4,_0xbf1018);const _0x3e6bf1=_0x5874d4===0x1?_0x8c710a(0x7e):_0x5874d4===0x2?_0x8c710a(0x10b):_0x5874d4===0x3?_0x8c710a(0xd4):null,_0x5f5a59=_0x5874d4===0x1?_0x8c710a(0xc6):_0x5874d4===0x2?_0x8c710a(0x87):_0x5874d4===0x3?_0x8c710a(0x9a):null;if(_0x1ea738[_0x8c710a(0xf6)]&&_0x1ea738[_0x3e6bf1]+_0x1ea738[_0x5f5a59]<_0xbf1018){if(_0x1ea738[_0x5f5a59]<_0xbf1018)throw new common_1[(_0x8c710a(0xb8))](_0x8c710a(0x10c),common_1['HttpStatus'][_0x8c710a(0x96)]);}if(!_0x1ea738['packageId']&&_0x1ea738[_0x5f5a59]<_0xbf1018)throw new common_1[(_0x8c710a(0xb8))](_0x8c710a(0x10c),common_1['HttpStatus'][_0x8c710a(0x96)]);return _0x1ea738;}async[_0x426ea7(0x8f)](_0x201cd5,_0x3fd5ba,_0xc06d5d){const _0xb25f7b=_0x426ea7,{id:_0x4edc2d}=_0x201cd5[_0xb25f7b(0xf4)],_0x22ea85=_0x3fd5ba===0x1?_0xb25f7b(0xc6):_0x3fd5ba===0x2?'model4Count':_0x3fd5ba===0x3?_0xb25f7b(0x9a):null,_0x4a3f9e=new Date(),_0x5055da=await this[_0xb25f7b(0x114)][_0xb25f7b(0xc2)]({'where':{'fingerprint':_0x4edc2d}}),{visitorModel3Num:_0x57a6c8,visitorModel4Num:_0x50b402,visitorMJNum:_0x22e453}=await this[_0xb25f7b(0xd0)]['getConfigs']([_0xb25f7b(0x90),_0xb25f7b(0xdb),'visitorMJNum']),_0x5661f4={'model3Count':_0x57a6c8?Number(_0x57a6c8):0x0,'model4Count':_0x50b402?Number(_0x50b402):0x0,'drawMjCount':_0x22e453?Number(_0x22e453):0x0};if(!_0x5055da){let _0x196f9e={'fingerprint':_0x4edc2d,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0};_0x196f9e[_0x22ea85]=_0x196f9e[_0x22ea85]+_0xc06d5d;if(_0x196f9e[_0x22ea85]>_0x5661f4[_0x22ea85])throw new common_1[(_0xb25f7b(0xb8))](_0xb25f7b(0xea),common_1[_0xb25f7b(0xd1)][_0xb25f7b(0x96)]);else return await this[_0xb25f7b(0x114)][_0xb25f7b(0xc4)](_0x196f9e),!![];}else{const {model3Count:_0x3f31bb,model4Count:_0x2186b7,drawMjCount:_0x247847}=_0x5055da;let _0x31ff8a={'model3Count':_0x3f31bb,'model4Count':_0x2186b7,'drawMjCount':_0x247847};const _0x3b4ea3=Number(new Date(_0x5055da[_0xb25f7b(0xbf)])),_0x126d3c=this[_0xb25f7b(0x98)](_0x3b4ea3);_0x126d3c?_0x31ff8a[_0x22ea85]=_0x31ff8a[_0x22ea85]+_0xc06d5d:(_0x31ff8a={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x31ff8a[_0x22ea85]=_0x31ff8a[_0x22ea85]+_0xc06d5d);if(_0x31ff8a[_0x22ea85]>_0x5661f4[_0x22ea85])throw new common_1['HttpException']('今日体验额度使用完毕，请注册使用完整服务！',common_1[_0xb25f7b(0xd1)][_0xb25f7b(0x96)]);else return await this[_0xb25f7b(0x114)][_0xb25f7b(0xa7)]({'fingerprint':_0x4edc2d},_0x31ff8a),!![];}}[_0x426ea7(0x98)](_0x5cef2c){const _0x21d045=_0x426ea7,_0x1b96b9=new Date(),_0x5db106=new Date(_0x1b96b9[_0x21d045(0x111)](),_0x1b96b9[_0x21d045(0xd8)](),_0x1b96b9[_0x21d045(0x110)]());return _0x5cef2c>=_0x5db106;}async[_0x426ea7(0x8b)](_0x322319,_0x253ef6,_0x4c2376,_0x2218e0=0x0){const _0x510091=_0x426ea7,_0x49e7c0=await this[_0x510091(0x101)][_0x510091(0xc2)]({'where':{'userId':_0x322319}});if(!_0x49e7c0)throw new common_1['HttpException']('缺失当前用户账户记录！',common_1[_0x510091(0xd1)][_0x510091(0xb4)]);const _0x1dc9cf={0x1:{'member':'memberModel3Count','nonMember':_0x510091(0xc6),'token':'useModel3Token'},0x2:{'member':_0x510091(0x10b),'nonMember':'model4Count','token':_0x510091(0x86)},0x3:{'member':'memberDrawMjCount','nonMember':_0x510091(0x9a),'token':_0x510091(0x82)}},{member:_0x24dc38,nonMember:_0x873ff2,token:_0x1125d0}=_0x1dc9cf[_0x253ef6];let _0x50f893=_0x4c2376,_0x261007=Math[_0x510091(0xa8)](_0x49e7c0[_0x24dc38]-_0x50f893,0x0);_0x50f893-=_0x49e7c0[_0x24dc38]-_0x261007;let _0x23aacb=_0x49e7c0[_0x873ff2];_0x50f893>0x0&&(_0x23aacb=Math[_0x510091(0xa8)](_0x49e7c0[_0x873ff2]-_0x50f893,0x0),_0x50f893-=_0x49e7c0[_0x873ff2]-_0x23aacb);const _0x21f5df={[_0x24dc38]:_0x261007,[_0x873ff2]:_0x23aacb,[_0x1125d0]:(_0x49e7c0[_0x1125d0]||0x0)+_0x2218e0};(_0x1125d0==='useModel3Token'||_0x1125d0===_0x510091(0x86))&&(_0x21f5df[_0x1125d0[_0x510091(0xf7)](_0x510091(0x104),_0x510091(0x7f))]=(_0x49e7c0[_0x1125d0[_0x510091(0xf7)](_0x510091(0x104),_0x510091(0x7f))]||0x0)+_0x4c2376);const _0x4cc7cc=await this[_0x510091(0x101)]['update']({'userId':_0x322319},_0x21f5df);if(_0x4cc7cc[_0x510091(0xff)]===0x0)throw new common_1['HttpException']('消费余额失败！',common_1[_0x510091(0xd1)][_0x510091(0xb4)]);}async[_0x426ea7(0x105)](_0x2fe283){const _0x4ae7ff=_0x426ea7;try{const _0x328e5e=await this[_0x4ae7ff(0x101)]['findOne']({'where':{'userId':_0x2fe283},'select':['packageId',_0x4ae7ff(0xc6),'model4Count',_0x4ae7ff(0x9a),_0x4ae7ff(0x7e),_0x4ae7ff(0x10b),_0x4ae7ff(0xd4),_0x4ae7ff(0xb1),_0x4ae7ff(0xfe),'useModel3Token',_0x4ae7ff(0x86),'useDrawMjToken','expirationTime']});if(!_0x328e5e){const _0x3824ac=await this[_0x4ae7ff(0x83)](_0x2fe283);if(_0x3824ac)return await this[_0x4ae7ff(0x105)](_0x2fe283);else throw new common_1[(_0x4ae7ff(0xb8))]('查询当前用户余额失败！',common_1[_0x4ae7ff(0xd1)][_0x4ae7ff(0xb4)]);}return _0x328e5e[_0x4ae7ff(0x84)]=_0x328e5e[_0x4ae7ff(0xf6)]?_0x328e5e[_0x4ae7ff(0xc6)]+_0x328e5e[_0x4ae7ff(0x7e)]:_0x328e5e[_0x4ae7ff(0xc6)],_0x328e5e[_0x4ae7ff(0xf8)]=_0x328e5e[_0x4ae7ff(0xf6)]?_0x328e5e[_0x4ae7ff(0x87)]+_0x328e5e[_0x4ae7ff(0x10b)]:_0x328e5e['model4Count'],_0x328e5e[_0x4ae7ff(0x117)]=_0x328e5e[_0x4ae7ff(0xf6)]?_0x328e5e[_0x4ae7ff(0x9a)]+_0x328e5e[_0x4ae7ff(0xd4)]:_0x328e5e[_0x4ae7ff(0x9a)],_0x328e5e[_0x4ae7ff(0xa0)]=_0x328e5e[_0x4ae7ff(0xa0)]?(0x0,date_1[_0x4ae7ff(0xf1)])(_0x328e5e[_0x4ae7ff(0xa0)],_0x4ae7ff(0xac)):null,_0x328e5e;}catch(_0x5f51f3){console[_0x4ae7ff(0xa3)]('error:\x20',_0x5f51f3);}}async[_0x426ea7(0xa5)](_0x487126){const _0x7f3c3a=_0x426ea7,{userId:_0x129852,rechargeType:_0x231dc3,model3Count:_0xf8a92c,model4Count:_0x34fe2a,drawMjCount:_0xd3c45c,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x487126;if(!_0x129852)throw new common_1[(_0x7f3c3a(0xb8))]('当前用户不存在,记录充值日志异常',common_1[_0x7f3c3a(0xd1)][_0x7f3c3a(0xb4)]);const _0x4932f4=(0x0,utils_1[_0x7f3c3a(0xe4)])();return await this[_0x7f3c3a(0xa4)][_0x7f3c3a(0xc4)]({'userId':_0x129852,'rechargeType':_0x231dc3,'model3Count':_0xf8a92c,'model4Count':_0x34fe2a,'drawMjCount':_0xd3c45c,'days':days,'extent':extent,'uid':_0x4932f4,'pkgName':pkgName});}async['createBaseUserBalance'](_0x432463,_0xba1de3={}){const _0x4e3396=_0x426ea7,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0xba1de3,_0x4ea89f=await this[_0x4e3396(0x101)]['findOne']({'where':{'userId':_0x432463}});if(_0x4ea89f)throw new common_1[(_0x4e3396(0xb8))](_0x4e3396(0x85),common_1[_0x4e3396(0xd1)][_0x4e3396(0xb4)]);return await this[_0x4e3396(0x101)][_0x4e3396(0xc4)]({'userId':_0x432463,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async['addBalanceToUser'](_0x1c1470,_0x84bde,_0x50964c=-0x1){const _0x4d4679=_0x426ea7;try{const _0x210944=await this[_0x4d4679(0x101)][_0x4d4679(0xc2)]({'where':{'userId':_0x1c1470}})||await this[_0x4d4679(0x83)](_0x1c1470);if(!_0x210944)throw new common_1[(_0x4d4679(0xb8))](_0x4d4679(0xe7),common_1['HttpStatus'][_0x4d4679(0xb4)]);const {model3Count:_0x26013d,model4Count:_0x1ba64e,drawMjCount:_0x1515f5,memberModel3Count:_0x3eeb33,memberModel4Count:_0x4ef88a,memberDrawMjCount:_0x159e7b}=_0x210944;let _0x325039={};if(_0x50964c>0x0){const {packageId:_0xc55faf}=_0x84bde;if(!_0xc55faf)throw new common_1['HttpException'](_0x4d4679(0x8c),common_1[_0x4d4679(0xd1)][_0x4d4679(0xb4)]);const _0x2c69f1=await this[_0x4d4679(0xbc)][_0x4d4679(0xc2)]({'where':{'id':_0xc55faf}});if(!_0x2c69f1)throw new common_1[(_0x4d4679(0xb8))](_0x4d4679(0xde),common_1[_0x4d4679(0xd1)]['BAD_REQUEST']);const {weight:_0x133b54}=_0x2c69f1;if(!_0x210944[_0x4d4679(0xf6)])_0x325039={'memberModel3Count':_0x3eeb33+_0x84bde['model3Count'],'memberModel4Count':_0x4ef88a+_0x84bde[_0x4d4679(0x87)],'memberDrawMjCount':_0x159e7b+_0x84bde['drawMjCount'],'expirationTime':(0x0,date_1['default'])()[_0x4d4679(0x103)](_0x50964c>0x0?_0x50964c:0x0,_0x4d4679(0xba))[_0x4d4679(0xb9)](_0x4d4679(0xca)),'packageId':_0xc55faf};else{const _0x23ddb2=await this[_0x4d4679(0xbc)]['findOne']({'where':{'id':_0x210944['packageId']}});_0x133b54>=_0x23ddb2[_0x4d4679(0xeb)]&&(_0x325039={'memberModel3Count':_0x3eeb33+_0x84bde[_0x4d4679(0xc6)],'memberModel4Count':_0x4ef88a+_0x84bde[_0x4d4679(0x87)],'memberDrawMjCount':_0x159e7b+_0x84bde[_0x4d4679(0x9a)],'expirationTime':(0x0,date_1[_0x4d4679(0x99)])(_0x210944[_0x4d4679(0xa0)])['add'](_0x50964c>0x0?_0x50964c:0x0,_0x4d4679(0xba))['format']('YYYY-MM-DD\x20HH:mm:ss'),'packageId':_0xc55faf}),_0x133b54<_0x23ddb2[_0x4d4679(0xeb)]&&(_0x325039={'memberModel3Count':_0x3eeb33+_0x84bde[_0x4d4679(0xc6)],'memberModel4Count':_0x4ef88a+_0x84bde[_0x4d4679(0x87)],'memberDrawMjCount':_0x159e7b+_0x84bde[_0x4d4679(0x9a)]});}}_0x50964c<=0x0&&(_0x325039={'model3Count':_0x26013d+_0x84bde[_0x4d4679(0xc6)],'model4Count':_0x1ba64e+_0x84bde[_0x4d4679(0x87)],'drawMjCount':_0x1515f5+_0x84bde[_0x4d4679(0x9a)]});const _0x5c6e80=await this[_0x4d4679(0x101)][_0x4d4679(0xa7)]({'userId':_0x1c1470},_0x325039);if(_0x5c6e80[_0x4d4679(0xff)]===0x0)throw new common_1[(_0x4d4679(0xb8))](_0x1c1470+_0x4d4679(0x107),common_1[_0x4d4679(0xd1)][_0x4d4679(0xb4)]);}catch(_0x8779bb){console[_0x4d4679(0xa3)](_0x4d4679(0xbe),_0x8779bb);throw new common_1[(_0x4d4679(0xb8))]('用户充值失败！',common_1[_0x4d4679(0xd1)][_0x4d4679(0xb4)]);}}async['addBalanceToOrder'](_0x22ec29){const _0x1ce980=_0x426ea7;console['log'](_0x1ce980(0x109),_0x22ec29);try{const {userId:_0x13efc8,goodsId:_0x22c657}=_0x22ec29,_0x456fa3=await this[_0x1ce980(0xbc)]['findOne']({'where':{'id':_0x22ec29[_0x1ce980(0xfa)],'status':0x1}});if(!_0x456fa3)throw new common_1[(_0x1ce980(0xb8))](_0x1ce980(0xab),common_1[_0x1ce980(0xd1)]['BAD_REQUEST']);const {model3Count:_0x2f43eb,model4Count:_0x477124,drawMjCount:_0x285c02,days:_0x4fd70c,name:_0x3acb53}=_0x456fa3,_0x37a93c={'model3Count':_0x2f43eb,'model4Count':_0x477124,'drawMjCount':_0x285c02,'days':_0x4fd70c,'packageId':_0x22ec29['goodsId']};await this[_0x1ce980(0xee)](_0x13efc8,_0x37a93c,_0x4fd70c),await this['saveRecordRechargeLog']({'userId':_0x13efc8,'rechargeType':balance_constant_1[_0x1ce980(0x9d)][_0x1ce980(0x10f)],'model3Count':_0x2f43eb,'model4Count':_0x477124,'drawMjCount':_0x285c02,'pkgName':_0x3acb53,'days':_0x4fd70c});}catch(_0x422bc5){console[_0x1ce980(0xa3)]('error:\x20',_0x422bc5);throw new common_1['HttpException']('充值失败！',common_1['HttpStatus'][_0x1ce980(0xb4)]);}}async['getRechargeLog'](_0x5f0b74,_0x432202){const _0x1ec021=_0x426ea7,{page:page=0x1,size:size=0x14}=_0x432202,{id:_0x394742}=_0x5f0b74[_0x1ec021(0xf4)],[_0x108370,_0x958bab]=await this[_0x1ec021(0xa4)]['findAndCount']({'where':{'userId':_0x394742},'order':{'id':_0x1ec021(0xae)},'skip':(page-0x1)*size,'take':size});return _0x108370[_0x1ec021(0x88)](_0x4773f8=>{const _0x444389=_0x1ec021;_0x4773f8[_0x444389(0x115)]=_0x4773f8[_0x444389(0xd9)]>0x0?_0x4773f8[_0x444389(0xd9)]+'天':'永久';}),{'rows':(0x0,date_1[_0x1ec021(0xfc)])(_0x108370),'count':_0x958bab};}async['getAccountLog'](_0x2e43d2,_0x268b23){const _0x157522=_0x426ea7;try{const {page:page=0x1,size:size=0xa,userId:_0x10da5b,rechargeType:_0x346bd8,packageId:_0x3f2ccf}=_0x268b23,{role:_0x57bde4}=_0x2e43d2[_0x157522(0xf4)],_0x4554f7={};_0x346bd8&&(_0x4554f7[_0x157522(0x116)]=_0x346bd8),_0x4554f7[_0x157522(0xe5)]=_0x10da5b||(0x0,typeorm_2['LessThan'])(0x186a0),_0x3f2ccf&&(_0x4554f7[_0x157522(0xf6)]={'$like':'%'+_0x3f2ccf+'%'});const [_0x474456,_0x550286]=await this[_0x157522(0xa4)]['findAndCount']({'where':_0x4554f7,'order':{'id':_0x157522(0xae)},'skip':(page-0x1)*size,'take':size}),_0x5b5c99=_0x474456[_0x157522(0x94)](_0x4b2bfb=>_0x4b2bfb[_0x157522(0xe5)]),_0x12cc8d=await this[_0x157522(0xf0)][_0x157522(0xd5)]({'where':{'id':(0x0,typeorm_2['In'])(_0x5b5c99)}});return _0x474456[_0x157522(0x88)](_0xe85129=>{const _0x5be91c=_0x157522,_0x2363c2=_0x12cc8d[_0x5be91c(0xd5)](_0x12fe25=>_0x12fe25['id']===_0xe85129[_0x5be91c(0xe5)]);_0xe85129['username']=_0x2363c2===null||_0x2363c2===void 0x0?void 0x0:_0x2363c2['username'],_0xe85129[_0x5be91c(0x118)]=_0x2363c2===null||_0x2363c2===void 0x0?void 0x0:_0x2363c2['email'],_0xe85129[_0x5be91c(0xf2)]=_0x2363c2===null||_0x2363c2===void 0x0?void 0x0:_0x2363c2[_0x5be91c(0xf2)],_0xe85129[_0x5be91c(0xc9)]=_0x2363c2===null||_0x2363c2===void 0x0?void 0x0:_0x2363c2['status'],_0xe85129[_0x5be91c(0xf9)]=_0x2363c2===null||_0x2363c2===void 0x0?void 0x0:_0x2363c2[_0x5be91c(0xf9)];}),_0x57bde4!==_0x157522(0xaa)&&_0x474456['forEach'](_0xc359b9=>{const _0x12071e=_0x157522;_0xc359b9[_0x12071e(0x118)]=_0xc359b9[_0x12071e(0x118)]?(0x0,utils_1[_0x12071e(0xbb)])(_0xc359b9[_0x12071e(0x118)]):'',_0xc359b9[_0x12071e(0xf2)]=_0xc359b9['phone']?(0x0,utils_1[_0x12071e(0xbb)])(_0xc359b9[_0x12071e(0xf2)]):'';}),{'rows':_0x474456,'count':_0x550286};}catch(_0x2c3c4f){console[_0x157522(0xa3)](_0x157522(0xbe),_0x2c3c4f);throw new common_1[(_0x157522(0xb8))]('查询用户账户失败！',common_1[_0x157522(0xd1)]['BAD_REQUEST']);}}async['queryUserBalanceByIds'](_0x5be5f4){const _0x2054e4=_0x426ea7;return await this[_0x2054e4(0x101)]['find']({'where':{'userId':(0x0,typeorm_2['In'])(_0x5be5f4)}});}async[_0x426ea7(0xf3)](_0x26ad30,_0x11a1c6){const _0x341167=_0x426ea7;return await this[_0x341167(0x8b)](_0x26ad30,'mjDraw',-_0x11a1c6);}async[_0x426ea7(0xdc)](_0x220cbe){const _0x2153fc=_0x426ea7,{fingerprint:_0x32b187}=_0x220cbe['headers'],{id:_0xd683ec}=_0x220cbe['user'];return await this['chatLogEntity']['update']({'userId':Number(_0x32b187)},{'userId':_0xd683ec}),await this[_0x2153fc(0xa9)][_0x2153fc(0xa7)]({'userId':Number(_0x32b187)},{'userId':_0xd683ec}),0x1;}async[_0x426ea7(0xdd)](_0x1288dc){const _0x3a85d5=_0x426ea7,{fingerprint:_0x462603}=_0x1288dc[_0x3a85d5(0xd3)],_0x17995d=await this[_0x3a85d5(0x8e)][_0x3a85d5(0xce)]({'where':{'userId':_0x462603}}),_0x11d22f=await this[_0x3a85d5(0xa9)]['count']({'where':{'userId':_0x462603}});return _0x17995d||_0x11d22f||0x0;}async[_0x426ea7(0x91)](_0x10d9cf){const _0x4e9479=_0x426ea7,_0xeb81ba=await this[_0x4e9479(0xf0)]['findOne']({'where':{'id':_0x10d9cf}}),_0x51cbe5=await this[_0x4e9479(0x101)]['findOne']({'where':{'userId':_0x10d9cf}});if(!_0xeb81ba||!_0x51cbe5)return;const {phoneValidationMessageCount:_0x4b3a81,identityVerificationMessageCount:_0xc4f485,openIdentity:_0x212194,openPhoneValidation:_0x3d1752}=await this[_0x4e9479(0xd0)]['getConfigs']([_0x4e9479(0x92),_0x4e9479(0xb0),_0x4e9479(0xf5),_0x4e9479(0x7d)]),_0x3682d8=Number(_0x4b3a81),_0x202ec3=Number(_0xc4f485),_0x517339=Number(_0x51cbe5[_0x4e9479(0xb1)])||0x0,_0x4dc8ce=Number(_0x51cbe5[_0x4e9479(0xfe)])||0x0,_0xb47081=_0x517339+_0x4dc8ce;if(_0x3d1752==='1'&&_0xb47081>=_0x3682d8&&!_0xeb81ba[_0x4e9479(0xf2)])throw new common_1[(_0x4e9479(0xb8))]('请完成手机号绑定',common_1[_0x4e9479(0xd1)][_0x4e9479(0xb4)]);if(_0x212194==='1'&&_0xb47081>=_0x202ec3&&(!_0xeb81ba[_0x4e9479(0x10e)]||!_0xeb81ba[_0x4e9479(0xbd)]))throw new common_1[(_0x4e9479(0xb8))](_0x4e9479(0xe0),common_1[_0x4e9479(0xd1)][_0x4e9479(0xb4)]);}};UserBalanceService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x426ea7(0xdf)])(balance_entity_1[_0x426ea7(0xfd)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(userBalance_entity_1[_0x426ea7(0xad)])),__param(0x2,(0x0,typeorm_1[_0x426ea7(0xdf)])(accountLog_entity_1[_0x426ea7(0xe1)])),__param(0x3,(0x0,typeorm_1[_0x426ea7(0xdf)])(cramiPackage_entity_1[_0x426ea7(0xe6)])),__param(0x4,(0x0,typeorm_1['InjectRepository'])(config_entity_1[_0x426ea7(0xe9)])),__param(0x5,(0x0,typeorm_1[_0x426ea7(0xdf)])(user_entity_1['UserEntity'])),__param(0x6,(0x0,typeorm_1[_0x426ea7(0xdf)])(fingerprint_entity_1['FingerprintLogEntity'])),__param(0x7,(0x0,typeorm_1['InjectRepository'])(chatGroup_entity_1[_0x426ea7(0xed)])),__param(0x8,(0x0,typeorm_1[_0x426ea7(0xdf)])(chatLog_entity_1['ChatLogEntity'])),__metadata(_0x426ea7(0x89),[typeorm_2[_0x426ea7(0xe3)],typeorm_2['Repository'],typeorm_2[_0x426ea7(0xe3)],typeorm_2[_0x426ea7(0xe3)],typeorm_2[_0x426ea7(0xe3)],typeorm_2[_0x426ea7(0xe3)],typeorm_2[_0x426ea7(0xe3)],typeorm_2[_0x426ea7(0xe3)],typeorm_2[_0x426ea7(0xe3)],globalConfig_service_1[_0x426ea7(0xc3)]])],UserBalanceService),exports['UserBalanceService']=UserBalanceService;