'use strict';const _0x3013af=_0x8efb;(function(_0x4ad1b7,_0x3fe8af){const _0x4b74b4=_0x8efb,_0x4f9369=_0x4ad1b7();while(!![]){try{const _0x39db95=parseInt(_0x4b74b4(0xcf))/0x1+-parseInt(_0x4b74b4(0xb5))/0x2*(parseInt(_0x4b74b4(0x100))/0x3)+parseInt(_0x4b74b4(0x104))/0x4+-parseInt(_0x4b74b4(0x109))/0x5*(parseInt(_0x4b74b4(0xe8))/0x6)+parseInt(_0x4b74b4(0x13a))/0x7+-parseInt(_0x4b74b4(0x144))/0x8*(parseInt(_0x4b74b4(0xa6))/0x9)+parseInt(_0x4b74b4(0x11f))/0xa*(parseInt(_0x4b74b4(0xe5))/0xb);if(_0x39db95===_0x3fe8af)break;else _0x4f9369['push'](_0x4f9369['shift']());}catch(_0x379f8b){_0x4f9369['push'](_0x4f9369['shift']());}}}(_0x4af8,0x94f99));function _0x8efb(_0x244b08,_0x1222c6){const _0x4af8a0=_0x4af8();return _0x8efb=function(_0x8efb98,_0x232844){_0x8efb98=_0x8efb98-0xa5;let _0x1c3874=_0x4af8a0[_0x8efb98];return _0x1c3874;},_0x8efb(_0x244b08,_0x1222c6);}var __decorate=this&&this[_0x3013af(0xc3)]||function(_0x29cbd1,_0x3b8098,_0x5bf909,_0x31487f){const _0x632f17=_0x3013af;var _0x5005f6=arguments[_0x632f17(0x11e)],_0x95e20=_0x5005f6<0x3?_0x3b8098:_0x31487f===null?_0x31487f=Object[_0x632f17(0x117)](_0x3b8098,_0x5bf909):_0x31487f,_0x355047;if(typeof Reflect===_0x632f17(0xf2)&&typeof Reflect[_0x632f17(0x132)]===_0x632f17(0x116))_0x95e20=Reflect[_0x632f17(0x132)](_0x29cbd1,_0x3b8098,_0x5bf909,_0x31487f);else{for(var _0xd29eeb=_0x29cbd1['length']-0x1;_0xd29eeb>=0x0;_0xd29eeb--)if(_0x355047=_0x29cbd1[_0xd29eeb])_0x95e20=(_0x5005f6<0x3?_0x355047(_0x95e20):_0x5005f6>0x3?_0x355047(_0x3b8098,_0x5bf909,_0x95e20):_0x355047(_0x3b8098,_0x5bf909))||_0x95e20;}return _0x5005f6>0x3&&_0x95e20&&Object[_0x632f17(0xa8)](_0x3b8098,_0x5bf909,_0x95e20),_0x95e20;},__metadata=this&&this[_0x3013af(0x10e)]||function(_0x2ac4b9,_0x5ccd1e){const _0x58ae93=_0x3013af;if(typeof Reflect===_0x58ae93(0xf2)&&typeof Reflect[_0x58ae93(0x13f)]==='function')return Reflect[_0x58ae93(0x13f)](_0x2ac4b9,_0x5ccd1e);},__param=this&&this['__param']||function(_0x327eda,_0x301b28){return function(_0x207bd4,_0x2bfec7){_0x301b28(_0x207bd4,_0x2bfec7,_0x327eda);};};Object['defineProperty'](exports,_0x3013af(0xba),{'value':!![]}),exports['UserBalanceService']=void 0x0;const balance_constant_1=require(_0x3013af(0xdf)),utils_1=require(_0x3013af(0xcd)),common_1=require(_0x3013af(0x148)),typeorm_1=require(_0x3013af(0xda)),typeorm_2=require('typeorm'),cramiPackage_entity_1=require('../crami/cramiPackage.entity'),config_entity_1=require(_0x3013af(0xe3)),globalConfig_service_1=require(_0x3013af(0x142)),accountLog_entity_1=require(_0x3013af(0x10d)),balance_entity_1=require(_0x3013af(0xb3)),userBalance_entity_1=require('./userBalance.entity'),date_1=require('../../common/utils/date'),chatGroup_entity_1=require(_0x3013af(0x13e)),chatLog_entity_1=require(_0x3013af(0xed)),user_entity_1=require('../user/user.entity'),fingerprint_entity_1=require(_0x3013af(0x146));let UserBalanceService=class UserBalanceService{constructor(_0x27ac75,_0x9ae416,_0x4d11e6,_0x356870,_0x513487,_0x46d920,_0xcb46c5,_0x419de5,_0x5c7fb7,_0x1cd6af){const _0x444d46=_0x3013af;this[_0x444d46(0xd9)]=_0x27ac75,this[_0x444d46(0xe1)]=_0x9ae416,this['accountLogEntity']=_0x4d11e6,this[_0x444d46(0xf3)]=_0x356870,this[_0x444d46(0xf7)]=_0x513487,this[_0x444d46(0xae)]=_0x46d920,this[_0x444d46(0x139)]=_0xcb46c5,this[_0x444d46(0x111)]=_0x419de5,this[_0x444d46(0x119)]=_0x5c7fb7,this[_0x444d46(0xb9)]=_0x1cd6af;}async[_0x3013af(0xf8)](_0x1b7750){const _0x1d8447=_0x3013af;try{const _0x4c5b9a=await this['configEntity'][_0x1d8447(0xf4)]({'where':{'configKey':(0x0,typeorm_2['In'])(['registerSendStatus',_0x1d8447(0x11b),_0x1d8447(0x110),_0x1d8447(0xee),'firstRegisterSendStatus',_0x1d8447(0xbb),'firstRregisterSendModel3Count',_0x1d8447(0x147),_0x1d8447(0x11a)])}}),_0x31550c=_0x4c5b9a[_0x1d8447(0xad)]((_0x25dbee,_0x18bb47)=>{const _0x575547=_0x1d8447,_0x17ef06=Number(_0x18bb47[_0x575547(0xe9)]),_0x1aaa1f=Number[_0x575547(0xf9)](_0x17ef06)&&_0x17ef06>0x0?_0x17ef06:0x0;return _0x25dbee[_0x18bb47[_0x575547(0xaf)]]=_0x1aaa1f,_0x25dbee;},{});let _0x4c9179=0x0,_0x1bbac1=0x0,_0x332f45=0x0;_0x31550c[_0x1d8447(0xd6)]===0x1&&(_0x4c9179=_0x4c9179+_0x31550c[_0x1d8447(0x11b)],_0x1bbac1=_0x1bbac1+_0x31550c[_0x1d8447(0x110)],_0x332f45=_0x332f45+_0x31550c[_0x1d8447(0xee)]),_0x31550c[_0x1d8447(0xd6)]===0x1&&_0x31550c[_0x1d8447(0xd0)]===0x1&&_0x1b7750<=_0x31550c[_0x1d8447(0xbb)]&&(_0x4c9179=_0x4c9179+_0x31550c[_0x1d8447(0xfa)],_0x1bbac1=_0x1bbac1+_0x31550c[_0x1d8447(0x147)],_0x332f45=_0x332f45+_0x31550c[_0x1d8447(0x11a)]),await this[_0x1d8447(0x10f)]({'userId':_0x1b7750,'rechargeType':balance_constant_1[_0x1d8447(0x12c)][_0x1d8447(0x107)],'model3Count':_0x4c9179,'drawMjCount':_0x332f45,'model4Count':_0x1bbac1}),await this[_0x1d8447(0xe1)]['save']({'userId':_0x1b7750,'model3Count':_0x4c9179,'model4Count':_0x1bbac1,'drawMjCount':_0x332f45,'useTokens':0x0});}catch(_0x20e56f){console[_0x1d8447(0x12a)](_0x1d8447(0x124),_0x20e56f);throw new common_1['HttpException']('注册赠送失败,请联系管理员！',common_1['HttpStatus'][_0x1d8447(0xaa)]);}}async[_0x3013af(0xf1)](_0x402690,_0x4915ee,_0x38ce48){const _0x18943d=_0x3013af,{id:_0x5ca9d1,role:_0x27b9ee}=_0x402690[_0x18943d(0xd1)];let _0x4f7dd6=await this[_0x18943d(0xe1)]['findOne']({'where':{'userId':_0x5ca9d1}});!_0x4f7dd6&&(_0x4f7dd6=await this[_0x18943d(0xc4)](_0x5ca9d1));if(_0x27b9ee==='visitor')return this[_0x18943d(0xb4)](_0x402690,_0x4915ee,_0x38ce48);const _0x40b136=_0x4915ee===0x1?_0x18943d(0x129):_0x4915ee===0x2?_0x18943d(0xbd):_0x4915ee===0x3?_0x18943d(0xd7):null,_0x2b6da4=_0x4915ee===0x1?_0x18943d(0x125):_0x4915ee===0x2?'model4Count':_0x4915ee===0x3?_0x18943d(0xb2):null;if(_0x4f7dd6[_0x18943d(0xfb)]&&_0x4f7dd6[_0x40b136]+_0x4f7dd6[_0x2b6da4]<_0x38ce48){if(_0x4f7dd6[_0x2b6da4]<_0x38ce48)throw new common_1[(_0x18943d(0xa9))](_0x18943d(0xd2),common_1[_0x18943d(0xce)]['PAYMENT_REQUIRED']);}if(!_0x4f7dd6['packageId']&&_0x4f7dd6[_0x2b6da4]<_0x38ce48)throw new common_1[(_0x18943d(0xa9))]('积分不足，继续体验服务，请按需选购套餐！',common_1['HttpStatus'][_0x18943d(0xec)]);return _0x4f7dd6;}async[_0x3013af(0xb4)](_0x5d6084,_0x3028e4,_0x506b5d){const _0x57bcf1=_0x3013af,{id:_0x2dfd4f}=_0x5d6084[_0x57bcf1(0xd1)],_0x49fac8=_0x3028e4===0x1?_0x57bcf1(0x125):_0x3028e4===0x2?_0x57bcf1(0x105):_0x3028e4===0x3?_0x57bcf1(0xb2):null,_0x376e3f=new Date(),_0x511372=await this['fingerprintLogEntity'][_0x57bcf1(0x103)]({'where':{'fingerprint':_0x2dfd4f}}),{visitorModel3Num:_0x45caa6,visitorModel4Num:_0x1efa98,visitorMJNum:_0x4716dc}=await this['globalConfigService'][_0x57bcf1(0x12b)]([_0x57bcf1(0xd8),'visitorModel4Num',_0x57bcf1(0x128)]),_0x5e293b={'model3Count':_0x45caa6?Number(_0x45caa6):0x0,'model4Count':_0x1efa98?Number(_0x1efa98):0x0,'drawMjCount':_0x4716dc?Number(_0x4716dc):0x0};if(!_0x511372){let _0x588d86={'fingerprint':_0x2dfd4f,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0};_0x588d86[_0x49fac8]=_0x588d86[_0x49fac8]+_0x506b5d;if(_0x588d86[_0x49fac8]>_0x5e293b[_0x49fac8])throw new common_1[(_0x57bcf1(0xa9))](_0x57bcf1(0xc0),common_1[_0x57bcf1(0xce)][_0x57bcf1(0xec)]);else return await this[_0x57bcf1(0x139)]['save'](_0x588d86),!![];}else{const {model3Count:_0x48e9cd,model4Count:_0x50ff76,drawMjCount:_0x479fbb}=_0x511372;let _0x54669b={'model3Count':_0x48e9cd,'model4Count':_0x50ff76,'drawMjCount':_0x479fbb};const _0x129ae1=Number(new Date(_0x511372[_0x57bcf1(0xfd)])),_0x52eaa4=this['isUpdatedToday'](_0x129ae1);_0x52eaa4?_0x54669b[_0x49fac8]=_0x54669b[_0x49fac8]+_0x506b5d:(_0x54669b={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x54669b[_0x49fac8]=_0x54669b[_0x49fac8]+_0x506b5d);if(_0x54669b[_0x49fac8]>_0x5e293b[_0x49fac8])throw new common_1['HttpException'](_0x57bcf1(0xc0),common_1[_0x57bcf1(0xce)]['PAYMENT_REQUIRED']);else return await this[_0x57bcf1(0x139)][_0x57bcf1(0xa5)]({'fingerprint':_0x2dfd4f},_0x54669b),!![];}}['isUpdatedToday'](_0x4348f5){const _0x2ddbeb=_0x3013af,_0x312e74=new Date(),_0xafbd88=new Date(_0x312e74[_0x2ddbeb(0x141)](),_0x312e74['getMonth'](),_0x312e74[_0x2ddbeb(0xd3)]());return _0x4348f5>=_0xafbd88;}async[_0x3013af(0x114)](_0x1ab20b,_0x4bf47d,_0xf8a7ea,_0x3aa253=0x0){const _0x3445b=_0x3013af,_0x4db85d=await this[_0x3445b(0xe1)][_0x3445b(0x103)]({'where':{'userId':_0x1ab20b}});if(!_0x4db85d)throw new common_1[(_0x3445b(0xa9))](_0x3445b(0x11c),common_1[_0x3445b(0xce)]['BAD_REQUEST']);const _0x4e4442={0x1:{'member':_0x3445b(0x129),'nonMember':_0x3445b(0x125),'token':_0x3445b(0x12e)},0x2:{'member':_0x3445b(0xbd),'nonMember':_0x3445b(0x105),'token':_0x3445b(0xeb)},0x3:{'member':'memberDrawMjCount','nonMember':'drawMjCount','token':_0x3445b(0x138)}},{member:_0x5c4736,nonMember:_0x152abe,token:_0x43c2f4}=_0x4e4442[_0x4bf47d];let _0x1b79d3=_0xf8a7ea,_0x2699ee=Math['max'](_0x4db85d[_0x5c4736]-_0x1b79d3,0x0);_0x1b79d3-=_0x4db85d[_0x5c4736]-_0x2699ee;let _0x5791c0=_0x4db85d[_0x152abe];_0x1b79d3>0x0&&(_0x5791c0=Math['max'](_0x4db85d[_0x152abe]-_0x1b79d3,0x0),_0x1b79d3-=_0x4db85d[_0x152abe]-_0x5791c0);const _0x1e2946={[_0x5c4736]:_0x2699ee,[_0x152abe]:_0x5791c0,[_0x43c2f4]:(_0x4db85d[_0x43c2f4]||0x0)+_0x3aa253};(_0x43c2f4===_0x3445b(0x12e)||_0x43c2f4===_0x3445b(0xeb))&&(_0x1e2946[_0x43c2f4['replace'](_0x3445b(0x127),_0x3445b(0xac))]=(_0x4db85d[_0x43c2f4[_0x3445b(0x145)](_0x3445b(0x127),'Count')]||0x0)+_0xf8a7ea);const _0x2bbdac=await this[_0x3445b(0xe1)][_0x3445b(0xa5)]({'userId':_0x1ab20b},_0x1e2946);if(_0x2bbdac['affected']===0x0)throw new common_1[(_0x3445b(0xa9))](_0x3445b(0xd5),common_1[_0x3445b(0xce)]['BAD_REQUEST']);}async[_0x3013af(0xc8)](_0x3af8c7){const _0x529920=_0x3013af;try{const _0x34a7a9=await this['userBalanceEntity'][_0x529920(0x103)]({'where':{'userId':_0x3af8c7},'select':[_0x529920(0xfb),_0x529920(0x125),_0x529920(0x105),'drawMjCount','memberModel3Count',_0x529920(0xbd),'memberDrawMjCount','useModel3Count',_0x529920(0xf0),_0x529920(0x12e),_0x529920(0xeb),_0x529920(0x138),_0x529920(0x115)]});if(!_0x34a7a9){const _0x38a70c=await this['createBaseUserBalance'](_0x3af8c7);if(_0x38a70c)return await this[_0x529920(0xc8)](_0x3af8c7);else throw new common_1[(_0x529920(0xa9))]('查询当前用户余额失败！',common_1[_0x529920(0xce)][_0x529920(0xaa)]);}return _0x34a7a9[_0x529920(0xdc)]=_0x34a7a9['packageId']?_0x34a7a9['model3Count']+_0x34a7a9['memberModel3Count']:_0x34a7a9[_0x529920(0x125)],_0x34a7a9[_0x529920(0x136)]=_0x34a7a9[_0x529920(0xfb)]?_0x34a7a9[_0x529920(0x105)]+_0x34a7a9[_0x529920(0xbd)]:_0x34a7a9[_0x529920(0x105)],_0x34a7a9['sumDrawMjCount']=_0x34a7a9['packageId']?_0x34a7a9[_0x529920(0xb2)]+_0x34a7a9['memberDrawMjCount']:_0x34a7a9['drawMjCount'],_0x34a7a9[_0x529920(0x115)]=_0x34a7a9[_0x529920(0x115)]?(0x0,date_1['formatDate'])(_0x34a7a9['expirationTime'],_0x529920(0x133)):null,_0x34a7a9;}catch(_0x4a32d4){console['log'](_0x529920(0x124),_0x4a32d4);}}async['saveRecordRechargeLog'](_0x55e4e1){const _0x13fa4d=_0x3013af,{userId:_0x270007,rechargeType:_0x2246d5,model3Count:_0x426d6d,model4Count:_0x1c65b7,drawMjCount:_0x539b01,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x55e4e1;if(!_0x270007)throw new common_1['HttpException']('当前用户不存在,记录充值日志异常',common_1[_0x13fa4d(0xce)][_0x13fa4d(0xaa)]);const _0x541443=(0x0,utils_1[_0x13fa4d(0xff)])();return await this[_0x13fa4d(0xe4)]['save']({'userId':_0x270007,'rechargeType':_0x2246d5,'model3Count':_0x426d6d,'model4Count':_0x1c65b7,'drawMjCount':_0x539b01,'days':days,'extent':extent,'uid':_0x541443,'pkgName':pkgName});}async[_0x3013af(0xc4)](_0x36d899,_0x4070c1={}){const _0x40d74c=_0x3013af,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x4070c1,_0x766bb6=await this['userBalanceEntity'][_0x40d74c(0x103)]({'where':{'userId':_0x36d899}});if(_0x766bb6)throw new common_1[(_0x40d74c(0xa9))](_0x40d74c(0x13c),common_1[_0x40d74c(0xce)][_0x40d74c(0xaa)]);return await this[_0x40d74c(0xe1)][_0x40d74c(0x12f)]({'userId':_0x36d899,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async[_0x3013af(0xc9)](_0x1e2696,_0x5c7e26,_0x261ca6=-0x1){const _0x371c48=_0x3013af;try{const _0x113fa5=await this[_0x371c48(0xe1)][_0x371c48(0x103)]({'where':{'userId':_0x1e2696}})||await this[_0x371c48(0xc4)](_0x1e2696);if(!_0x113fa5)throw new common_1[(_0x371c48(0xa9))](_0x371c48(0xb0),common_1['HttpStatus'][_0x371c48(0xaa)]);const {model3Count:_0x502c61,model4Count:_0x4fb130,drawMjCount:_0x4ecf57,memberModel3Count:_0x331d90,memberModel4Count:_0x1f3d99,memberDrawMjCount:_0x5cb4be}=_0x113fa5;let _0x1becef={};if(_0x261ca6>0x0){const {packageId:_0x4ee1e7}=_0x5c7e26;if(!_0x4ee1e7)throw new common_1[(_0x371c48(0xa9))]('缺失当前套餐ID、充值失败！',common_1[_0x371c48(0xce)][_0x371c48(0xaa)]);const _0x38d2f1=await this[_0x371c48(0xf3)][_0x371c48(0x103)]({'where':{'id':_0x4ee1e7}});if(!_0x38d2f1)throw new common_1[(_0x371c48(0xa9))](_0x371c48(0x108),common_1[_0x371c48(0xce)][_0x371c48(0xaa)]);const {weight:_0x5eca33}=_0x38d2f1;if(!_0x113fa5[_0x371c48(0xfb)])_0x1becef={'memberModel3Count':_0x331d90+_0x5c7e26['model3Count'],'memberModel4Count':_0x1f3d99+_0x5c7e26['model4Count'],'memberDrawMjCount':_0x5cb4be+_0x5c7e26['drawMjCount'],'expirationTime':(0x0,date_1[_0x371c48(0x130)])()[_0x371c48(0xd4)](_0x261ca6>0x0?_0x261ca6:0x0,_0x371c48(0x10a))[_0x371c48(0xc6)](_0x371c48(0xe2)),'packageId':_0x4ee1e7};else{const _0x434466=await this[_0x371c48(0xf3)]['findOne']({'where':{'id':_0x113fa5[_0x371c48(0xfb)]}});_0x5eca33>=_0x434466[_0x371c48(0x122)]&&(_0x1becef={'memberModel3Count':_0x331d90+_0x5c7e26[_0x371c48(0x125)],'memberModel4Count':_0x1f3d99+_0x5c7e26[_0x371c48(0x105)],'memberDrawMjCount':_0x5cb4be+_0x5c7e26['drawMjCount'],'expirationTime':(0x0,date_1['default'])(_0x113fa5[_0x371c48(0x115)])[_0x371c48(0xd4)](_0x261ca6>0x0?_0x261ca6:0x0,'day')[_0x371c48(0xc6)](_0x371c48(0xe2)),'packageId':_0x4ee1e7}),_0x5eca33<_0x434466[_0x371c48(0x122)]&&(_0x1becef={'memberModel3Count':_0x331d90+_0x5c7e26[_0x371c48(0x125)],'memberModel4Count':_0x1f3d99+_0x5c7e26[_0x371c48(0x105)],'memberDrawMjCount':_0x5cb4be+_0x5c7e26['drawMjCount']});}}_0x261ca6<=0x0&&(_0x1becef={'model3Count':_0x502c61+_0x5c7e26[_0x371c48(0x125)],'model4Count':_0x4fb130+_0x5c7e26[_0x371c48(0x105)],'drawMjCount':_0x4ecf57+_0x5c7e26[_0x371c48(0xb2)]});const _0xbe81ed=await this[_0x371c48(0xe1)][_0x371c48(0xa5)]({'userId':_0x1e2696},_0x1becef);if(_0xbe81ed[_0x371c48(0xbf)]===0x0)throw new common_1[(_0x371c48(0xa9))](_0x1e2696+_0x371c48(0xdd),common_1[_0x371c48(0xce)]['BAD_REQUEST']);}catch(_0x311acd){console[_0x371c48(0x12a)]('error:\x20',_0x311acd);throw new common_1[(_0x371c48(0xa9))](_0x371c48(0xbc),common_1['HttpStatus'][_0x371c48(0xaa)]);}}async['addBalanceToOrder'](_0x1ed9b2){const _0x5e45c0=_0x3013af;console[_0x5e45c0(0x12a)](_0x5e45c0(0x11d),_0x1ed9b2);try{const {userId:_0x5d6ef2,goodsId:_0xc4f1c9}=_0x1ed9b2,_0xe24ca2=await this[_0x5e45c0(0xf3)][_0x5e45c0(0x103)]({'where':{'id':_0x1ed9b2[_0x5e45c0(0xbe)],'status':0x1}});if(!_0xe24ca2)throw new common_1['HttpException'](_0x5e45c0(0xf6),common_1[_0x5e45c0(0xce)][_0x5e45c0(0xaa)]);const {model3Count:_0x17cc79,model4Count:_0x3b4afe,drawMjCount:_0x36a688,days:_0x1728b9,name:_0x30f108}=_0xe24ca2,_0x58dda7={'model3Count':_0x17cc79,'model4Count':_0x3b4afe,'drawMjCount':_0x36a688,'days':_0x1728b9,'packageId':_0x1ed9b2[_0x5e45c0(0xbe)]};await this['addBalanceToUser'](_0x5d6ef2,_0x58dda7,_0x1728b9),await this[_0x5e45c0(0x10f)]({'userId':_0x5d6ef2,'rechargeType':balance_constant_1[_0x5e45c0(0x12c)][_0x5e45c0(0x140)],'model3Count':_0x17cc79,'model4Count':_0x3b4afe,'drawMjCount':_0x36a688,'pkgName':_0x30f108,'days':_0x1728b9});}catch(_0xef89b4){console[_0x5e45c0(0x12a)](_0x5e45c0(0x124),_0xef89b4);throw new common_1[(_0x5e45c0(0xa9))]('充值失败！',common_1[_0x5e45c0(0xce)][_0x5e45c0(0xaa)]);}}async[_0x3013af(0x131)](_0x5b8c30,_0x392ccc){const _0x9050e8=_0x3013af,{page:page=0x1,size:size=0x14}=_0x392ccc,{id:_0x4c7f01}=_0x5b8c30[_0x9050e8(0xd1)],[_0x22309b,_0x25570e]=await this[_0x9050e8(0xe4)]['findAndCount']({'where':{'userId':_0x4c7f01},'order':{'id':_0x9050e8(0xcb)},'skip':(page-0x1)*size,'take':size});return _0x22309b[_0x9050e8(0x113)](_0xbdab30=>{const _0x4ca9a5=_0x9050e8;_0xbdab30[_0x4ca9a5(0xcc)]=_0xbdab30[_0x4ca9a5(0x120)]>0x0?_0xbdab30[_0x4ca9a5(0x120)]+'天':'永久';}),{'rows':(0x0,date_1[_0x9050e8(0xea)])(_0x22309b),'count':_0x25570e};}async[_0x3013af(0x143)](_0x26b050,_0x35fdb0){const _0x583e30=_0x3013af;try{const {page:page=0x1,size:size=0xa,userId:_0x5e396a,rechargeType:_0x2ed609,packageId:_0x20d230}=_0x35fdb0,{role:_0x19d85d}=_0x26b050[_0x583e30(0xd1)],_0x59cd1b={};_0x2ed609&&(_0x59cd1b[_0x583e30(0x10c)]=_0x2ed609),_0x59cd1b['userId']=_0x5e396a||(0x0,typeorm_2[_0x583e30(0xc2)])(0x186a0),_0x20d230&&(_0x59cd1b[_0x583e30(0xfb)]={'$like':'%'+_0x20d230+'%'});const [_0x3f0449,_0x1f3721]=await this['accountLogEntity'][_0x583e30(0xb7)]({'where':_0x59cd1b,'order':{'id':_0x583e30(0xcb)},'skip':(page-0x1)*size,'take':size}),_0x645131=_0x3f0449[_0x583e30(0xe6)](_0x19aef8=>_0x19aef8[_0x583e30(0x121)]),_0x3046c6=await this[_0x583e30(0xae)][_0x583e30(0xf4)]({'where':{'id':(0x0,typeorm_2['In'])(_0x645131)}});return _0x3f0449[_0x583e30(0x113)](_0x2e7e6b=>{const _0x14ba0d=_0x583e30,_0x3eeec3=_0x3046c6[_0x14ba0d(0xf4)](_0x4c5188=>_0x4c5188['id']===_0x2e7e6b[_0x14ba0d(0x121)]);_0x2e7e6b[_0x14ba0d(0x118)]=_0x3eeec3===null||_0x3eeec3===void 0x0?void 0x0:_0x3eeec3[_0x14ba0d(0x118)],_0x2e7e6b['email']=_0x3eeec3===null||_0x3eeec3===void 0x0?void 0x0:_0x3eeec3[_0x14ba0d(0x13b)],_0x2e7e6b[_0x14ba0d(0x135)]=_0x3eeec3===null||_0x3eeec3===void 0x0?void 0x0:_0x3eeec3['phone'],_0x2e7e6b[_0x14ba0d(0xc7)]=_0x3eeec3===null||_0x3eeec3===void 0x0?void 0x0:_0x3eeec3['status'],_0x2e7e6b[_0x14ba0d(0x137)]=_0x3eeec3===null||_0x3eeec3===void 0x0?void 0x0:_0x3eeec3[_0x14ba0d(0x137)];}),_0x19d85d!=='super'&&_0x3f0449[_0x583e30(0x113)](_0x3c169c=>{const _0x6ca51=_0x583e30;_0x3c169c['email']=_0x3c169c[_0x6ca51(0x13b)]?(0x0,utils_1['hideString'])(_0x3c169c['email']):'',_0x3c169c[_0x6ca51(0x135)]=_0x3c169c['phone']?(0x0,utils_1[_0x6ca51(0x112)])(_0x3c169c['phone']):'';}),{'rows':_0x3f0449,'count':_0x1f3721};}catch(_0xae8fa8){console[_0x583e30(0x12a)](_0x583e30(0x124),_0xae8fa8);throw new common_1['HttpException']('查询用户账户失败！',common_1[_0x583e30(0xce)][_0x583e30(0xaa)]);}}async['queryUserBalanceByIds'](_0x3ea521){const _0x593654=_0x3013af;return await this[_0x593654(0xe1)]['find']({'where':{'userId':(0x0,typeorm_2['In'])(_0x3ea521)}});}async['refundMjBalance'](_0x26cbd6,_0x269ac0){const _0x273edf=_0x3013af;return await this['deductFromBalance'](_0x26cbd6,_0x273edf(0xb6),-_0x269ac0);}async[_0x3013af(0xb1)](_0x145d9d){const _0x24e2f4=_0x3013af,{fingerprint:_0x2d515c}=_0x145d9d[_0x24e2f4(0xdb)],{id:_0x36f3d4}=_0x145d9d[_0x24e2f4(0xd1)];return await this[_0x24e2f4(0x119)]['update']({'userId':Number(_0x2d515c)},{'userId':_0x36f3d4}),await this['chatGroupEntity']['update']({'userId':Number(_0x2d515c)},{'userId':_0x36f3d4}),0x1;}async[_0x3013af(0xc5)](_0x20193d){const _0x1ceb31=_0x3013af,{fingerprint:_0x55dc63}=_0x20193d['headers'],_0x26c5d2=await this['chatLogEntity'][_0x1ceb31(0x101)]({'where':{'userId':_0x55dc63}}),_0x381a6d=await this[_0x1ceb31(0x111)][_0x1ceb31(0x101)]({'where':{'userId':_0x55dc63}});return _0x26c5d2||_0x381a6d||0x0;}async[_0x3013af(0x149)](_0x185b4f){const _0x4f9233=_0x3013af,_0xf1dcc7=await this[_0x4f9233(0xae)][_0x4f9233(0x103)]({'where':{'id':_0x185b4f}}),_0x4304f8=await this[_0x4f9233(0xe1)][_0x4f9233(0x103)]({'where':{'userId':_0x185b4f}});if(!_0xf1dcc7||!_0x4304f8)return;const {phoneValidationMessageCount:_0x2bb7b7,identityVerificationMessageCount:_0x5ef56a,openIdentity:_0x5d0e89,openPhoneValidation:_0xbc870f}=await this[_0x4f9233(0xb9)][_0x4f9233(0x12b)](['phoneValidationMessageCount',_0x4f9233(0xe0),_0x4f9233(0x102),_0x4f9233(0x123)]),_0x445608=Number(_0x2bb7b7),_0x5dfd18=Number(_0x5ef56a),_0x5372c8=Number(_0x4304f8[_0x4f9233(0xde)])||0x0,_0x4039b0=Number(_0x4304f8['useModel4Count'])||0x0,_0x343c0a=_0x5372c8+_0x4039b0;if(_0xbc870f==='1'&&_0x343c0a>=_0x445608&&!_0xf1dcc7[_0x4f9233(0x135)])throw new common_1['HttpException']('请完成手机号绑定',common_1[_0x4f9233(0xce)]['BAD_REQUEST']);if(_0x5d0e89==='1'&&_0x343c0a>=_0x5dfd18&&(!_0xf1dcc7[_0x4f9233(0xca)]||!_0xf1dcc7[_0x4f9233(0xa7)]))throw new common_1['HttpException']('请完成实名认证',common_1[_0x4f9233(0xce)][_0x4f9233(0xaa)]);}};UserBalanceService=__decorate([(0x0,common_1[_0x3013af(0xc1)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(balance_entity_1[_0x3013af(0xab)])),__param(0x1,(0x0,typeorm_1[_0x3013af(0x10b)])(userBalance_entity_1[_0x3013af(0xf5)])),__param(0x2,(0x0,typeorm_1[_0x3013af(0x10b)])(accountLog_entity_1[_0x3013af(0x106)])),__param(0x3,(0x0,typeorm_1[_0x3013af(0x10b)])(cramiPackage_entity_1[_0x3013af(0xb8)])),__param(0x4,(0x0,typeorm_1['InjectRepository'])(config_entity_1[_0x3013af(0xfc)])),__param(0x5,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x3013af(0xfe)])),__param(0x6,(0x0,typeorm_1[_0x3013af(0x10b)])(fingerprint_entity_1[_0x3013af(0xef)])),__param(0x7,(0x0,typeorm_1[_0x3013af(0x10b)])(chatGroup_entity_1[_0x3013af(0x12d)])),__param(0x8,(0x0,typeorm_1[_0x3013af(0x10b)])(chatLog_entity_1[_0x3013af(0x13d)])),__metadata(_0x3013af(0x126),[typeorm_2[_0x3013af(0xe7)],typeorm_2[_0x3013af(0xe7)],typeorm_2[_0x3013af(0xe7)],typeorm_2[_0x3013af(0xe7)],typeorm_2[_0x3013af(0xe7)],typeorm_2[_0x3013af(0xe7)],typeorm_2['Repository'],typeorm_2[_0x3013af(0xe7)],typeorm_2[_0x3013af(0xe7)],globalConfig_service_1[_0x3013af(0x134)]])],UserBalanceService),exports['UserBalanceService']=UserBalanceService;function _0x4af8(){const _0x4ac97d=['InjectRepository','rechargeType','./accountLog.entity','__metadata','saveRecordRechargeLog','registerSendModel4Count','chatGroupEntity','hideString','forEach','deductFromBalance','expirationTime','function','getOwnPropertyDescriptor','username','chatLogEntity','firstRregisterSendDrawMjCount','registerSendModel3Count','缺失当前用户账户记录！','充值的工单信息:','length','162530roYTYD','days','userId','weight','openPhoneValidation','error:\x20','model3Count','design:paramtypes','Token','visitorMJNum','memberModel3Count','log','getConfigs','RechargeType','ChatGroupEntity','useModel3Token','save','default','getRechargeLog','decorate','YYYY-MM-DD','GlobalConfigService','phone','sumModel4Count','avatar','useDrawMjToken','fingerprintLogEntity','6823089KqjNNE','email','当前用户无需创建账户信息！','ChatLogEntity','../chatGroup/chatGroup.entity','metadata','SCAN_PAY','getFullYear','./../globalConfig/globalConfig.service','getAccountLog','110768Ggwzho','replace','./fingerprint.entity','firstRregisterSendModel4Count','@nestjs/common','checkUserCertification','update','441LoulfJ','idCard','defineProperty','HttpException','BAD_REQUEST','BalanceEntity','Count','reduce','userEntity','configKey','查询用户账户信息失败！','inheritVisitorData','drawMjCount','./balance.entity','validateVisitorBalance','4NZAzKH','mjDraw','findAndCount','CramiPackageEntity','globalConfigService','__esModule','firstRegisterSendRank','用户充值失败！','memberModel4Count','goodsId','affected','今日体验额度使用完毕，请注册使用完整服务！','Injectable','LessThan','__decorate','createBaseUserBalance','getVisitorCount','format','status','queryUserBalance','addBalanceToUser','realName','DESC','expireDateCn','../../common/utils','HttpStatus','1168162muNGqb','firstRegisterSendStatus','user','积分不足，继续体验服务，请按需选购套餐！','getDate','add','消费余额失败！','registerSendStatus','memberDrawMjCount','visitorModel3Num','balanceEntity','@nestjs/typeorm','headers','sumModel3Count','充值失败','useModel3Count','../../common/constants/balance.constant','identityVerificationMessageCount','userBalanceEntity','YYYY-MM-DD\x20HH:mm:ss','../globalConfig/config.entity','accountLogEntity','22GFCwum','map','Repository','5756892YLadwl','configVal','formatCreateOrUpdateDate','useModel4Token','PAYMENT_REQUIRED','../chatLog/chatLog.entity','registerSendDrawMjCount','FingerprintLogEntity','useModel4Count','validateBalance','object','cramiPackageEntity','find','UserBalanceEntity','非法操作、当前充值套餐暂不存在！','configEntity','addBalanceToNewUser','isInteger','firstRregisterSendModel3Count','packageId','ConfigEntity','updatedAt','UserEntity','createRandomUid','729570dyQTlu','count','openIdentity','findOne','2236488LLpOxo','model4Count','AccountLogEntity','REG_GIFT','当前套餐不存在！','5ISgvqg','day'];_0x4af8=function(){return _0x4ac97d;};return _0x4af8();}