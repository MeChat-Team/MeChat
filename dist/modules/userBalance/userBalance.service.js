'use strict';function _0x194e(_0x23f0e6,_0x305e74){const _0x1c3f3d=_0x1c3f();return _0x194e=function(_0x194ecd,_0x5b7777){_0x194ecd=_0x194ecd-0x161;let _0x3d3457=_0x1c3f3d[_0x194ecd];return _0x3d3457;},_0x194e(_0x23f0e6,_0x305e74);}const _0x2b6a89=_0x194e;(function(_0x11ba49,_0x320b4a){const _0x55061a=_0x194e,_0x202583=_0x11ba49();while(!![]){try{const _0x3abff1=parseInt(_0x55061a(0x1ab))/0x1+-parseInt(_0x55061a(0x1c8))/0x2*(-parseInt(_0x55061a(0x1cb))/0x3)+-parseInt(_0x55061a(0x1b8))/0x4+parseInt(_0x55061a(0x18a))/0x5+-parseInt(_0x55061a(0x1a7))/0x6+-parseInt(_0x55061a(0x1be))/0x7*(-parseInt(_0x55061a(0x1e6))/0x8)+parseInt(_0x55061a(0x1fb))/0x9;if(_0x3abff1===_0x320b4a)break;else _0x202583['push'](_0x202583['shift']());}catch(_0x3339dd){_0x202583['push'](_0x202583['shift']());}}}(_0x1c3f,0x3fda9));var __decorate=this&&this[_0x2b6a89(0x1cc)]||function(_0x1463a6,_0x1bbef9,_0x426cee,_0x18135d){const _0x480100=_0x2b6a89;var _0x17ecde=arguments['length'],_0xb8473d=_0x17ecde<0x3?_0x1bbef9:_0x18135d===null?_0x18135d=Object[_0x480100(0x16c)](_0x1bbef9,_0x426cee):_0x18135d,_0x399bee;if(typeof Reflect===_0x480100(0x178)&&typeof Reflect[_0x480100(0x1e0)]===_0x480100(0x1c6))_0xb8473d=Reflect['decorate'](_0x1463a6,_0x1bbef9,_0x426cee,_0x18135d);else{for(var _0x21ac0d=_0x1463a6['length']-0x1;_0x21ac0d>=0x0;_0x21ac0d--)if(_0x399bee=_0x1463a6[_0x21ac0d])_0xb8473d=(_0x17ecde<0x3?_0x399bee(_0xb8473d):_0x17ecde>0x3?_0x399bee(_0x1bbef9,_0x426cee,_0xb8473d):_0x399bee(_0x1bbef9,_0x426cee))||_0xb8473d;}return _0x17ecde>0x3&&_0xb8473d&&Object['defineProperty'](_0x1bbef9,_0x426cee,_0xb8473d),_0xb8473d;},__metadata=this&&this['__metadata']||function(_0x305458,_0x156926){const _0x37da64=_0x2b6a89;if(typeof Reflect===_0x37da64(0x178)&&typeof Reflect[_0x37da64(0x1e1)]===_0x37da64(0x1c6))return Reflect[_0x37da64(0x1e1)](_0x305458,_0x156926);},__param=this&&this['__param']||function(_0x420240,_0x2bcc39){return function(_0x4010d9,_0x49dcef){_0x2bcc39(_0x4010d9,_0x49dcef,_0x420240);};};function _0x1c3f(){const _0x402596=['useModel3Token','count','avatar','查询用户账户信息失败！','getOwnPropertyDescriptor','firstRregisterSendModel4Count','DESC','getConfigs','ChatLogEntity','./userBalance.entity','当前用户无需创建账户信息！','../crami/cramiPackage.entity','useDrawMjToken','max','inheritVisitorData','Token','object','./balance.entity','checkUserCertification','update','当前套餐不存在！','realName','visitorModel3Num','status','find','ConfigEntity','queryUserBalance','YYYY-MM-DD','visitorMJNum','当前用户不存在,记录充值日志异常','expireDateCn','drawMjCount','InjectRepository','充值的工单信息:','1231940PGVaOv','hideString','userBalanceEntity','user','./accountLog.entity','registerSendDrawMjCount','accountLogEntity','formatCreateOrUpdateDate','reduce','BAD_REQUEST','packageId','memberModel3Count','firstRegisterSendStatus','请完成手机号绑定','useModel3Count','phone','userEntity','globalConfigService','day','消费余额失败！','openIdentity','getVisitorCount','super','Count','registerSendStatus','validateBalance','log','非法操作、当前充值套餐暂不存在！','model4Count','2966118zcyLhP','../../common/utils','configKey','configEntity','8159EimScn','replace','format','deductFromBalance','userId','用户充值失败！','registerSendModel3Count','__esModule','rechargeType','Repository','save','email','firstRegisterSendRank','404432toQvZi','identityVerificationMessageCount','chatLogEntity','Injectable','YYYY-MM-DD\x20HH:mm:ss','cramiPackageEntity','367633NylJgw','affected','addBalanceToNewUser','expirationTime','BalanceEntity','getDate','../../common/constants/balance.constant','validateVisitorBalance','function','useModel4Token','2AcPQFs','PAYMENT_REQUIRED','firstRregisterSendDrawMjCount','649527icAdRb','__decorate','缺失当前套餐ID、充值失败！','typeorm','注册赠送失败,请联系管理员！','weight','findOne','chatGroupEntity','useModel4Count','memberModel4Count','headers','createRandomUid','SCAN_PAY','sumModel4Count','visitorModel4Num','ChatGroupEntity','fingerprintLogEntity','default','积分不足，继续体验服务，请按需选购套餐！','createBaseUserBalance','UserBalanceService','decorate','metadata','memberDrawMjCount','../../common/utils/date','map','error:\x20','48yNfLCV','username','GlobalConfigService','sumDrawMjCount','days','goodsId','add','查询用户账户失败！','AccountLogEntity','queryUserBalanceByIds','design:paramtypes','addBalanceToUser','今日体验额度使用完毕，请注册使用完整服务！','firstRregisterSendModel3Count','isUpdatedToday','FingerprintLogEntity','UserEntity','../chatLog/chatLog.entity','findAndCount','../user/user.entity','RechargeType','637524gVaykv','formatDate','openPhoneValidation','getRechargeLog','forEach','HttpStatus','HttpException','请完成实名认证','balanceEntity','model3Count','getMonth'];_0x1c3f=function(){return _0x402596;};return _0x1c3f();}Object['defineProperty'](exports,_0x2b6a89(0x1b2),{'value':!![]}),exports['UserBalanceService']=void 0x0;const balance_constant_1=require(_0x2b6a89(0x1c4)),utils_1=require(_0x2b6a89(0x1a8)),common_1=require('@nestjs/common'),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0x2b6a89(0x1ce)),cramiPackage_entity_1=require(_0x2b6a89(0x173)),config_entity_1=require('../globalConfig/config.entity'),globalConfig_service_1=require('./../globalConfig/globalConfig.service'),accountLog_entity_1=require(_0x2b6a89(0x18e)),balance_entity_1=require(_0x2b6a89(0x179)),userBalance_entity_1=require(_0x2b6a89(0x171)),date_1=require(_0x2b6a89(0x1e3)),chatGroup_entity_1=require('../chatGroup/chatGroup.entity'),chatLog_entity_1=require(_0x2b6a89(0x1f7)),user_entity_1=require(_0x2b6a89(0x1f9)),fingerprint_entity_1=require('./fingerprint.entity');let UserBalanceService=class UserBalanceService{constructor(_0x4dc1d5,_0x39bce0,_0xc12bce,_0x51d932,_0x4156f7,_0x37e85e,_0x4b87b2,_0x255372,_0x335e1a,_0x4634e3){const _0x2a4aa9=_0x2b6a89;this[_0x2a4aa9(0x165)]=_0x4dc1d5,this[_0x2a4aa9(0x18c)]=_0x39bce0,this['accountLogEntity']=_0xc12bce,this[_0x2a4aa9(0x1bd)]=_0x51d932,this[_0x2a4aa9(0x1aa)]=_0x4156f7,this[_0x2a4aa9(0x19a)]=_0x37e85e,this['fingerprintLogEntity']=_0x4b87b2,this[_0x2a4aa9(0x1d2)]=_0x255372,this['chatLogEntity']=_0x335e1a,this[_0x2a4aa9(0x19b)]=_0x4634e3;}async[_0x2b6a89(0x1c0)](_0x10a292){const _0x38f6fe=_0x2b6a89;try{const _0x3eb2b5=await this[_0x38f6fe(0x1aa)][_0x38f6fe(0x180)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x38f6fe(0x1a2),_0x38f6fe(0x1b1),'registerSendModel4Count','registerSendDrawMjCount',_0x38f6fe(0x196),_0x38f6fe(0x1b7),_0x38f6fe(0x1f3),_0x38f6fe(0x16d),_0x38f6fe(0x1ca)])}}),_0x3df3a2=_0x3eb2b5[_0x38f6fe(0x192)]((_0x2a0daa,_0x3227ba)=>{const _0x3de920=_0x38f6fe,_0x6e1d4b=Number(_0x3227ba['configVal']),_0x420505=Number['isInteger'](_0x6e1d4b)&&_0x6e1d4b>0x0?_0x6e1d4b:0x0;return _0x2a0daa[_0x3227ba[_0x3de920(0x1a9)]]=_0x420505,_0x2a0daa;},{});let _0x17c0fc=0x0,_0x5a2ff4=0x0,_0x40368e=0x0;_0x3df3a2[_0x38f6fe(0x1a2)]===0x1&&(_0x17c0fc=_0x17c0fc+_0x3df3a2[_0x38f6fe(0x1b1)],_0x5a2ff4=_0x5a2ff4+_0x3df3a2['registerSendModel4Count'],_0x40368e=_0x40368e+_0x3df3a2[_0x38f6fe(0x18f)]),_0x3df3a2[_0x38f6fe(0x1a2)]===0x1&&_0x3df3a2[_0x38f6fe(0x196)]===0x1&&_0x10a292<=_0x3df3a2[_0x38f6fe(0x1b7)]&&(_0x17c0fc=_0x17c0fc+_0x3df3a2[_0x38f6fe(0x1f3)],_0x5a2ff4=_0x5a2ff4+_0x3df3a2['firstRregisterSendModel4Count'],_0x40368e=_0x40368e+_0x3df3a2[_0x38f6fe(0x1ca)]),await this['saveRecordRechargeLog']({'userId':_0x10a292,'rechargeType':balance_constant_1[_0x38f6fe(0x1fa)]['REG_GIFT'],'model3Count':_0x17c0fc,'drawMjCount':_0x40368e,'model4Count':_0x5a2ff4}),await this[_0x38f6fe(0x18c)]['save']({'userId':_0x10a292,'model3Count':_0x17c0fc,'model4Count':_0x5a2ff4,'drawMjCount':_0x40368e,'useTokens':0x0});}catch(_0x28907e){console[_0x38f6fe(0x1a4)](_0x38f6fe(0x1e5),_0x28907e);throw new common_1[(_0x38f6fe(0x163))](_0x38f6fe(0x1cf),common_1[_0x38f6fe(0x162)][_0x38f6fe(0x193)]);}}async[_0x2b6a89(0x1a3)](_0x3fa44e,_0x37bc48,_0x5e8e8a){const _0x515914=_0x2b6a89,{id:_0x279e8,role:_0x1324e3}=_0x3fa44e['user'];let _0x3e902c=await this[_0x515914(0x18c)]['findOne']({'where':{'userId':_0x279e8}});!_0x3e902c&&(_0x3e902c=await this[_0x515914(0x1de)](_0x279e8));if(_0x1324e3==='visitor')return this[_0x515914(0x1c5)](_0x3fa44e,_0x37bc48,_0x5e8e8a);const _0x32613e=_0x37bc48===0x1?'memberModel3Count':_0x37bc48===0x2?_0x515914(0x1d4):_0x37bc48===0x3?'memberDrawMjCount':null,_0x2be3dd=_0x37bc48===0x1?'model3Count':_0x37bc48===0x2?_0x515914(0x1a6):_0x37bc48===0x3?_0x515914(0x187):null;if(_0x3e902c['packageId']&&_0x3e902c[_0x32613e]+_0x3e902c[_0x2be3dd]<_0x5e8e8a){if(_0x3e902c[_0x2be3dd]<_0x5e8e8a)throw new common_1['HttpException'](_0x515914(0x1dd),common_1['HttpStatus'][_0x515914(0x1c9)]);}if(!_0x3e902c['packageId']&&_0x3e902c[_0x2be3dd]<_0x5e8e8a)throw new common_1[(_0x515914(0x163))](_0x515914(0x1dd),common_1['HttpStatus']['PAYMENT_REQUIRED']);return _0x3e902c;}async[_0x2b6a89(0x1c5)](_0x5c22c5,_0x192b69,_0x1d55be){const _0x26eefc=_0x2b6a89,{id:_0x1832b0}=_0x5c22c5[_0x26eefc(0x18d)],_0x2fffc9=_0x192b69===0x1?_0x26eefc(0x166):_0x192b69===0x2?'model4Count':_0x192b69===0x3?_0x26eefc(0x187):null,_0x37f0a5=new Date(),_0x18236f=await this[_0x26eefc(0x1db)]['findOne']({'where':{'fingerprint':_0x1832b0}}),{visitorModel3Num:_0x13f967,visitorModel4Num:_0x32098f,visitorMJNum:_0x58878b}=await this[_0x26eefc(0x19b)][_0x26eefc(0x16f)]([_0x26eefc(0x17e),_0x26eefc(0x1d9),_0x26eefc(0x184)]),_0x2b55ac={'model3Count':_0x13f967?Number(_0x13f967):0x0,'model4Count':_0x32098f?Number(_0x32098f):0x0,'drawMjCount':_0x58878b?Number(_0x58878b):0x0};if(!_0x18236f){let _0x526ab4={'fingerprint':_0x1832b0,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0};_0x526ab4[_0x2fffc9]=_0x526ab4[_0x2fffc9]+_0x1d55be;if(_0x526ab4[_0x2fffc9]>_0x2b55ac[_0x2fffc9])throw new common_1[(_0x26eefc(0x163))](_0x26eefc(0x1f2),common_1[_0x26eefc(0x162)][_0x26eefc(0x1c9)]);else return await this[_0x26eefc(0x1db)][_0x26eefc(0x1b5)](_0x526ab4),!![];}else{const {model3Count:_0x5f3ed5,model4Count:_0x4c995a,drawMjCount:_0x5941a1}=_0x18236f;let _0x8ddf38={'model3Count':_0x5f3ed5,'model4Count':_0x4c995a,'drawMjCount':_0x5941a1};const _0x1ae7fa=Number(new Date(_0x18236f['updatedAt'])),_0x18416f=this[_0x26eefc(0x1f4)](_0x1ae7fa);_0x18416f?_0x8ddf38[_0x2fffc9]=_0x8ddf38[_0x2fffc9]+_0x1d55be:(_0x8ddf38={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x8ddf38[_0x2fffc9]=_0x8ddf38[_0x2fffc9]+_0x1d55be);if(_0x8ddf38[_0x2fffc9]>_0x2b55ac[_0x2fffc9])throw new common_1['HttpException'](_0x26eefc(0x1f2),common_1[_0x26eefc(0x162)][_0x26eefc(0x1c9)]);else return await this[_0x26eefc(0x1db)]['update']({'fingerprint':_0x1832b0},_0x8ddf38),!![];}}[_0x2b6a89(0x1f4)](_0x127790){const _0x462efc=_0x2b6a89,_0x20cb48=new Date(),_0x52ea5e=new Date(_0x20cb48['getFullYear'](),_0x20cb48[_0x462efc(0x167)](),_0x20cb48[_0x462efc(0x1c3)]());return _0x127790>=_0x52ea5e;}async['deductFromBalance'](_0x3b6255,_0x217945,_0x174841,_0x5001fb=0x0){const _0x68f885=_0x2b6a89,_0x84620e=await this['userBalanceEntity']['findOne']({'where':{'userId':_0x3b6255}});if(!_0x84620e)throw new common_1[(_0x68f885(0x163))]('缺失当前用户账户记录！',common_1[_0x68f885(0x162)][_0x68f885(0x193)]);const _0x2e7d09={0x1:{'member':_0x68f885(0x195),'nonMember':'model3Count','token':_0x68f885(0x168)},0x2:{'member':_0x68f885(0x1d4),'nonMember':_0x68f885(0x1a6),'token':'useModel4Token'},0x3:{'member':'memberDrawMjCount','nonMember':_0x68f885(0x187),'token':_0x68f885(0x174)}},{member:_0x496f12,nonMember:_0x906d2,token:_0x25c3fe}=_0x2e7d09[_0x217945];let _0x37bb46=_0x174841,_0x52340b=Math[_0x68f885(0x175)](_0x84620e[_0x496f12]-_0x37bb46,0x0);_0x37bb46-=_0x84620e[_0x496f12]-_0x52340b;let _0x21ea6d=_0x84620e[_0x906d2];_0x37bb46>0x0&&(_0x21ea6d=Math[_0x68f885(0x175)](_0x84620e[_0x906d2]-_0x37bb46,0x0),_0x37bb46-=_0x84620e[_0x906d2]-_0x21ea6d);const _0x7dae37={[_0x496f12]:_0x52340b,[_0x906d2]:_0x21ea6d,[_0x25c3fe]:(_0x84620e[_0x25c3fe]||0x0)+_0x5001fb};(_0x25c3fe===_0x68f885(0x168)||_0x25c3fe===_0x68f885(0x1c7))&&(_0x7dae37[_0x25c3fe[_0x68f885(0x1ac)](_0x68f885(0x177),_0x68f885(0x1a1))]=(_0x84620e[_0x25c3fe[_0x68f885(0x1ac)](_0x68f885(0x177),_0x68f885(0x1a1))]||0x0)+_0x174841);const _0xda1bea=await this[_0x68f885(0x18c)][_0x68f885(0x17b)]({'userId':_0x3b6255},_0x7dae37);if(_0xda1bea['affected']===0x0)throw new common_1['HttpException'](_0x68f885(0x19d),common_1[_0x68f885(0x162)][_0x68f885(0x193)]);}async['queryUserBalance'](_0x27d2ce){const _0x397ebf=_0x2b6a89;try{const _0x22122b=await this[_0x397ebf(0x18c)]['findOne']({'where':{'userId':_0x27d2ce},'select':[_0x397ebf(0x194),_0x397ebf(0x166),_0x397ebf(0x1a6),_0x397ebf(0x187),_0x397ebf(0x195),_0x397ebf(0x1d4),_0x397ebf(0x1e2),_0x397ebf(0x198),'useModel4Count','useModel3Token',_0x397ebf(0x1c7),_0x397ebf(0x174),_0x397ebf(0x1c1)]});if(!_0x22122b){const _0x166e57=await this['createBaseUserBalance'](_0x27d2ce);if(_0x166e57)return await this[_0x397ebf(0x182)](_0x27d2ce);else throw new common_1[(_0x397ebf(0x163))]('查询当前用户余额失败！',common_1['HttpStatus']['BAD_REQUEST']);}return _0x22122b['sumModel3Count']=_0x22122b['packageId']?_0x22122b['model3Count']+_0x22122b[_0x397ebf(0x195)]:_0x22122b[_0x397ebf(0x166)],_0x22122b[_0x397ebf(0x1d8)]=_0x22122b['packageId']?_0x22122b['model4Count']+_0x22122b[_0x397ebf(0x1d4)]:_0x22122b[_0x397ebf(0x1a6)],_0x22122b[_0x397ebf(0x1e9)]=_0x22122b[_0x397ebf(0x194)]?_0x22122b[_0x397ebf(0x187)]+_0x22122b[_0x397ebf(0x1e2)]:_0x22122b[_0x397ebf(0x187)],_0x22122b[_0x397ebf(0x1c1)]=_0x22122b[_0x397ebf(0x1c1)]?(0x0,date_1[_0x397ebf(0x1fc)])(_0x22122b[_0x397ebf(0x1c1)],_0x397ebf(0x183)):null,_0x22122b;}catch(_0x38028f){console[_0x397ebf(0x1a4)](_0x397ebf(0x1e5),_0x38028f);}}async['saveRecordRechargeLog'](_0x126f83){const _0xfd0877=_0x2b6a89,{userId:_0x403270,rechargeType:_0x236132,model3Count:_0x141721,model4Count:_0x531cd3,drawMjCount:_0x300d49,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x126f83;if(!_0x403270)throw new common_1[(_0xfd0877(0x163))](_0xfd0877(0x185),common_1[_0xfd0877(0x162)]['BAD_REQUEST']);const _0x3da4cd=(0x0,utils_1[_0xfd0877(0x1d6)])();return await this[_0xfd0877(0x190)][_0xfd0877(0x1b5)]({'userId':_0x403270,'rechargeType':_0x236132,'model3Count':_0x141721,'model4Count':_0x531cd3,'drawMjCount':_0x300d49,'days':days,'extent':extent,'uid':_0x3da4cd,'pkgName':pkgName});}async[_0x2b6a89(0x1de)](_0x2a9d8d,_0x2bdd78={}){const _0x1277d4=_0x2b6a89,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x2bdd78,_0x2539de=await this[_0x1277d4(0x18c)]['findOne']({'where':{'userId':_0x2a9d8d}});if(_0x2539de)throw new common_1[(_0x1277d4(0x163))](_0x1277d4(0x172),common_1['HttpStatus']['BAD_REQUEST']);return await this['userBalanceEntity'][_0x1277d4(0x1b5)]({'userId':_0x2a9d8d,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async[_0x2b6a89(0x1f1)](_0x3c08ca,_0x191f8a,_0x23ffa7=-0x1){const _0x3c4d45=_0x2b6a89;try{const _0x763b06=await this[_0x3c4d45(0x18c)][_0x3c4d45(0x1d1)]({'where':{'userId':_0x3c08ca}})||await this[_0x3c4d45(0x1de)](_0x3c08ca);if(!_0x763b06)throw new common_1[(_0x3c4d45(0x163))](_0x3c4d45(0x16b),common_1[_0x3c4d45(0x162)]['BAD_REQUEST']);const {model3Count:_0x5d8921,model4Count:_0x58c402,drawMjCount:_0x5bdfcc,memberModel3Count:_0x18da05,memberModel4Count:_0x48cea7,memberDrawMjCount:_0x4241e4}=_0x763b06;let _0x461b8f={};if(_0x23ffa7>0x0){const {packageId:_0x1d37c9}=_0x191f8a;if(!_0x1d37c9)throw new common_1['HttpException'](_0x3c4d45(0x1cd),common_1[_0x3c4d45(0x162)][_0x3c4d45(0x193)]);const _0x12d822=await this[_0x3c4d45(0x1bd)][_0x3c4d45(0x1d1)]({'where':{'id':_0x1d37c9}});if(!_0x12d822)throw new common_1[(_0x3c4d45(0x163))](_0x3c4d45(0x17c),common_1[_0x3c4d45(0x162)]['BAD_REQUEST']);const {weight:_0x127b0a}=_0x12d822;if(!_0x763b06[_0x3c4d45(0x194)])_0x461b8f={'memberModel3Count':_0x18da05+_0x191f8a[_0x3c4d45(0x166)],'memberModel4Count':_0x48cea7+_0x191f8a[_0x3c4d45(0x1a6)],'memberDrawMjCount':_0x4241e4+_0x191f8a[_0x3c4d45(0x187)],'expirationTime':(0x0,date_1[_0x3c4d45(0x1dc)])()[_0x3c4d45(0x1ec)](_0x23ffa7>0x0?_0x23ffa7:0x0,'day')[_0x3c4d45(0x1ad)]('YYYY-MM-DD\x20HH:mm:ss'),'packageId':_0x1d37c9};else{const _0x4f3d0c=await this[_0x3c4d45(0x1bd)]['findOne']({'where':{'id':_0x763b06[_0x3c4d45(0x194)]}});_0x127b0a>=_0x4f3d0c['weight']&&(_0x461b8f={'memberModel3Count':_0x18da05+_0x191f8a['model3Count'],'memberModel4Count':_0x48cea7+_0x191f8a[_0x3c4d45(0x1a6)],'memberDrawMjCount':_0x4241e4+_0x191f8a[_0x3c4d45(0x187)],'expirationTime':(0x0,date_1[_0x3c4d45(0x1dc)])(_0x763b06[_0x3c4d45(0x1c1)])[_0x3c4d45(0x1ec)](_0x23ffa7>0x0?_0x23ffa7:0x0,_0x3c4d45(0x19c))[_0x3c4d45(0x1ad)](_0x3c4d45(0x1bc)),'packageId':_0x1d37c9}),_0x127b0a<_0x4f3d0c[_0x3c4d45(0x1d0)]&&(_0x461b8f={'memberModel3Count':_0x18da05+_0x191f8a[_0x3c4d45(0x166)],'memberModel4Count':_0x48cea7+_0x191f8a['model4Count'],'memberDrawMjCount':_0x4241e4+_0x191f8a[_0x3c4d45(0x187)]});}}_0x23ffa7<=0x0&&(_0x461b8f={'model3Count':_0x5d8921+_0x191f8a['model3Count'],'model4Count':_0x58c402+_0x191f8a['model4Count'],'drawMjCount':_0x5bdfcc+_0x191f8a[_0x3c4d45(0x187)]});const _0x5e78b3=await this[_0x3c4d45(0x18c)][_0x3c4d45(0x17b)]({'userId':_0x3c08ca},_0x461b8f);if(_0x5e78b3[_0x3c4d45(0x1bf)]===0x0)throw new common_1[(_0x3c4d45(0x163))](_0x3c08ca+'充值失败',common_1[_0x3c4d45(0x162)][_0x3c4d45(0x193)]);}catch(_0x45aa8d){console[_0x3c4d45(0x1a4)](_0x3c4d45(0x1e5),_0x45aa8d);throw new common_1[(_0x3c4d45(0x163))](_0x3c4d45(0x1b0),common_1[_0x3c4d45(0x162)][_0x3c4d45(0x193)]);}}async['addBalanceToOrder'](_0x3146f8){const _0x12ad06=_0x2b6a89;console[_0x12ad06(0x1a4)](_0x12ad06(0x189),_0x3146f8);try{const {userId:_0x1563b4,goodsId:_0x769d14}=_0x3146f8,_0x5023e8=await this[_0x12ad06(0x1bd)][_0x12ad06(0x1d1)]({'where':{'id':_0x3146f8[_0x12ad06(0x1eb)],'status':0x1}});if(!_0x5023e8)throw new common_1[(_0x12ad06(0x163))](_0x12ad06(0x1a5),common_1['HttpStatus'][_0x12ad06(0x193)]);const {model3Count:_0x2e929a,model4Count:_0x339f21,drawMjCount:_0x5c428,days:_0x2ffcb6,name:_0x507df1}=_0x5023e8,_0x1e0569={'model3Count':_0x2e929a,'model4Count':_0x339f21,'drawMjCount':_0x5c428,'days':_0x2ffcb6,'packageId':_0x3146f8[_0x12ad06(0x1eb)]};await this[_0x12ad06(0x1f1)](_0x1563b4,_0x1e0569,_0x2ffcb6),await this['saveRecordRechargeLog']({'userId':_0x1563b4,'rechargeType':balance_constant_1['RechargeType'][_0x12ad06(0x1d7)],'model3Count':_0x2e929a,'model4Count':_0x339f21,'drawMjCount':_0x5c428,'pkgName':_0x507df1,'days':_0x2ffcb6});}catch(_0x54e378){console[_0x12ad06(0x1a4)](_0x12ad06(0x1e5),_0x54e378);throw new common_1[(_0x12ad06(0x163))]('充值失败！',common_1['HttpStatus'][_0x12ad06(0x193)]);}}async[_0x2b6a89(0x1fe)](_0x1d4086,_0xc23e08){const _0x2e6400=_0x2b6a89,{page:page=0x1,size:size=0x14}=_0xc23e08,{id:_0x33b6c0}=_0x1d4086[_0x2e6400(0x18d)],[_0x5336ff,_0x2e0175]=await this[_0x2e6400(0x190)][_0x2e6400(0x1f8)]({'where':{'userId':_0x33b6c0},'order':{'id':_0x2e6400(0x16e)},'skip':(page-0x1)*size,'take':size});return _0x5336ff[_0x2e6400(0x161)](_0x51dd66=>{const _0x113f25=_0x2e6400;_0x51dd66[_0x113f25(0x186)]=_0x51dd66[_0x113f25(0x1ea)]>0x0?_0x51dd66[_0x113f25(0x1ea)]+'天':'永久';}),{'rows':(0x0,date_1[_0x2e6400(0x191)])(_0x5336ff),'count':_0x2e0175};}async['getAccountLog'](_0x4da259,_0x4347b5){const _0x410507=_0x2b6a89;try{const {page:page=0x1,size:size=0xa,userId:_0x21ef7b,rechargeType:_0x444b0f,packageId:_0x2558c2}=_0x4347b5,{role:_0x3354b2}=_0x4da259[_0x410507(0x18d)],_0x4cfbe8={};_0x444b0f&&(_0x4cfbe8[_0x410507(0x1b3)]=_0x444b0f),_0x4cfbe8[_0x410507(0x1af)]=_0x21ef7b||(0x0,typeorm_2['LessThan'])(0x186a0),_0x2558c2&&(_0x4cfbe8['packageId']={'$like':'%'+_0x2558c2+'%'});const [_0x5f46ed,_0x3f676b]=await this[_0x410507(0x190)][_0x410507(0x1f8)]({'where':_0x4cfbe8,'order':{'id':_0x410507(0x16e)},'skip':(page-0x1)*size,'take':size}),_0xcfa613=_0x5f46ed[_0x410507(0x1e4)](_0x12e89b=>_0x12e89b[_0x410507(0x1af)]),_0xe2c687=await this[_0x410507(0x19a)][_0x410507(0x180)]({'where':{'id':(0x0,typeorm_2['In'])(_0xcfa613)}});return _0x5f46ed[_0x410507(0x161)](_0xe5b029=>{const _0x129b87=_0x410507,_0x53ae2e=_0xe2c687['find'](_0x5d9e58=>_0x5d9e58['id']===_0xe5b029[_0x129b87(0x1af)]);_0xe5b029['username']=_0x53ae2e===null||_0x53ae2e===void 0x0?void 0x0:_0x53ae2e[_0x129b87(0x1e7)],_0xe5b029[_0x129b87(0x1b6)]=_0x53ae2e===null||_0x53ae2e===void 0x0?void 0x0:_0x53ae2e['email'],_0xe5b029['phone']=_0x53ae2e===null||_0x53ae2e===void 0x0?void 0x0:_0x53ae2e[_0x129b87(0x199)],_0xe5b029['status']=_0x53ae2e===null||_0x53ae2e===void 0x0?void 0x0:_0x53ae2e[_0x129b87(0x17f)],_0xe5b029[_0x129b87(0x16a)]=_0x53ae2e===null||_0x53ae2e===void 0x0?void 0x0:_0x53ae2e[_0x129b87(0x16a)];}),_0x3354b2!==_0x410507(0x1a0)&&_0x5f46ed[_0x410507(0x161)](_0x201c5e=>{const _0x2e2d7d=_0x410507;_0x201c5e[_0x2e2d7d(0x1b6)]=_0x201c5e[_0x2e2d7d(0x1b6)]?(0x0,utils_1[_0x2e2d7d(0x18b)])(_0x201c5e[_0x2e2d7d(0x1b6)]):'',_0x201c5e[_0x2e2d7d(0x199)]=_0x201c5e['phone']?(0x0,utils_1[_0x2e2d7d(0x18b)])(_0x201c5e['phone']):'';}),{'rows':_0x5f46ed,'count':_0x3f676b};}catch(_0xf8a306){console[_0x410507(0x1a4)](_0x410507(0x1e5),_0xf8a306);throw new common_1[(_0x410507(0x163))](_0x410507(0x1ed),common_1[_0x410507(0x162)][_0x410507(0x193)]);}}async[_0x2b6a89(0x1ef)](_0x39c318){const _0x50d210=_0x2b6a89;return await this['userBalanceEntity'][_0x50d210(0x180)]({'where':{'userId':(0x0,typeorm_2['In'])(_0x39c318)}});}async['refundMjBalance'](_0x566b87,_0x397c01){const _0x17329d=_0x2b6a89;return await this[_0x17329d(0x1ae)](_0x566b87,'mjDraw',-_0x397c01);}async[_0x2b6a89(0x176)](_0x1514bf){const _0x583535=_0x2b6a89,{fingerprint:_0x13076d}=_0x1514bf[_0x583535(0x1d5)],{id:_0x2b0551}=_0x1514bf[_0x583535(0x18d)];return await this[_0x583535(0x1ba)][_0x583535(0x17b)]({'userId':Number(_0x13076d)},{'userId':_0x2b0551}),await this[_0x583535(0x1d2)][_0x583535(0x17b)]({'userId':Number(_0x13076d)},{'userId':_0x2b0551}),0x1;}async[_0x2b6a89(0x19f)](_0x262e25){const _0x10e5e1=_0x2b6a89,{fingerprint:_0x5c824d}=_0x262e25['headers'],_0x486ac0=await this['chatLogEntity'][_0x10e5e1(0x169)]({'where':{'userId':_0x5c824d}}),_0x678386=await this[_0x10e5e1(0x1d2)][_0x10e5e1(0x169)]({'where':{'userId':_0x5c824d}});return _0x486ac0||_0x678386||0x0;}async[_0x2b6a89(0x17a)](_0x1dc3d1){const _0x38c6bc=_0x2b6a89,_0x500e4f=await this[_0x38c6bc(0x19a)][_0x38c6bc(0x1d1)]({'where':{'id':_0x1dc3d1}}),_0x459ea2=await this[_0x38c6bc(0x18c)][_0x38c6bc(0x1d1)]({'where':{'userId':_0x1dc3d1}});if(!_0x500e4f||!_0x459ea2)return;const {phoneValidationMessageCount:_0x5e39d7,identityVerificationMessageCount:_0x19f3fa,openIdentity:_0x411771,openPhoneValidation:_0x4fd859}=await this[_0x38c6bc(0x19b)][_0x38c6bc(0x16f)](['phoneValidationMessageCount',_0x38c6bc(0x1b9),_0x38c6bc(0x19e),_0x38c6bc(0x1fd)]),_0x45eab6=Number(_0x5e39d7),_0x38b369=Number(_0x19f3fa),_0x211a3e=Number(_0x459ea2[_0x38c6bc(0x198)])||0x0,_0x23d4b7=Number(_0x459ea2[_0x38c6bc(0x1d3)])||0x0,_0x8c10=_0x211a3e+_0x23d4b7;if(_0x4fd859==='1'&&_0x8c10>=_0x45eab6&&!_0x500e4f['phone'])throw new common_1[(_0x38c6bc(0x163))](_0x38c6bc(0x197),common_1[_0x38c6bc(0x162)][_0x38c6bc(0x193)]);if(_0x411771==='1'&&_0x8c10>=_0x38b369&&(!_0x500e4f[_0x38c6bc(0x17d)]||!_0x500e4f['idCard']))throw new common_1['HttpException'](_0x38c6bc(0x164),common_1[_0x38c6bc(0x162)][_0x38c6bc(0x193)]);}};UserBalanceService=__decorate([(0x0,common_1[_0x2b6a89(0x1bb)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(balance_entity_1[_0x2b6a89(0x1c2)])),__param(0x1,(0x0,typeorm_1[_0x2b6a89(0x188)])(userBalance_entity_1['UserBalanceEntity'])),__param(0x2,(0x0,typeorm_1[_0x2b6a89(0x188)])(accountLog_entity_1[_0x2b6a89(0x1ee)])),__param(0x3,(0x0,typeorm_1[_0x2b6a89(0x188)])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x4,(0x0,typeorm_1[_0x2b6a89(0x188)])(config_entity_1[_0x2b6a89(0x181)])),__param(0x5,(0x0,typeorm_1[_0x2b6a89(0x188)])(user_entity_1[_0x2b6a89(0x1f6)])),__param(0x6,(0x0,typeorm_1[_0x2b6a89(0x188)])(fingerprint_entity_1[_0x2b6a89(0x1f5)])),__param(0x7,(0x0,typeorm_1[_0x2b6a89(0x188)])(chatGroup_entity_1[_0x2b6a89(0x1da)])),__param(0x8,(0x0,typeorm_1[_0x2b6a89(0x188)])(chatLog_entity_1[_0x2b6a89(0x170)])),__metadata(_0x2b6a89(0x1f0),[typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2[_0x2b6a89(0x1b4)],typeorm_2[_0x2b6a89(0x1b4)],typeorm_2[_0x2b6a89(0x1b4)],typeorm_2['Repository'],typeorm_2[_0x2b6a89(0x1b4)],typeorm_2[_0x2b6a89(0x1b4)],typeorm_2[_0x2b6a89(0x1b4)],globalConfig_service_1[_0x2b6a89(0x1e8)]])],UserBalanceService),exports[_0x2b6a89(0x1df)]=UserBalanceService;