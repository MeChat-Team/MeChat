'use strict';function _0x578c(_0x23ed4f,_0x4d8060){const _0x3483e1=_0x3483();return _0x578c=function(_0x578c8d,_0x39bf41){_0x578c8d=_0x578c8d-0xc5;let _0xa2c173=_0x3483e1[_0x578c8d];return _0xa2c173;},_0x578c(_0x23ed4f,_0x4d8060);}const _0x5cf19c=_0x578c;(function(_0xdade1d,_0x47c616){const _0x4b81db=_0x578c,_0x2be737=_0xdade1d();while(!![]){try{const _0x5acc7d=parseInt(_0x4b81db(0x14a))/0x1*(parseInt(_0x4b81db(0x125))/0x2)+-parseInt(_0x4b81db(0xf9))/0x3+-parseInt(_0x4b81db(0x153))/0x4*(parseInt(_0x4b81db(0xc7))/0x5)+-parseInt(_0x4b81db(0xe8))/0x6*(parseInt(_0x4b81db(0x127))/0x7)+parseInt(_0x4b81db(0x14d))/0x8*(-parseInt(_0x4b81db(0xf2))/0x9)+-parseInt(_0x4b81db(0xd0))/0xa*(parseInt(_0x4b81db(0x121))/0xb)+parseInt(_0x4b81db(0x104))/0xc;if(_0x5acc7d===_0x47c616)break;else _0x2be737['push'](_0x2be737['shift']());}catch(_0x342279){_0x2be737['push'](_0x2be737['shift']());}}}(_0x3483,0xf03c8));var __decorate=this&&this[_0x5cf19c(0xfa)]||function(_0x3395f5,_0x444fbb,_0x43ed27,_0x40e982){const _0xf95ebc=_0x5cf19c;var _0x46d9b0=arguments[_0xf95ebc(0x142)],_0x4a3704=_0x46d9b0<0x3?_0x444fbb:_0x40e982===null?_0x40e982=Object[_0xf95ebc(0xff)](_0x444fbb,_0x43ed27):_0x40e982,_0x5452b2;if(typeof Reflect==='object'&&typeof Reflect['decorate']==='function')_0x4a3704=Reflect[_0xf95ebc(0xde)](_0x3395f5,_0x444fbb,_0x43ed27,_0x40e982);else{for(var _0x2885ec=_0x3395f5['length']-0x1;_0x2885ec>=0x0;_0x2885ec--)if(_0x5452b2=_0x3395f5[_0x2885ec])_0x4a3704=(_0x46d9b0<0x3?_0x5452b2(_0x4a3704):_0x46d9b0>0x3?_0x5452b2(_0x444fbb,_0x43ed27,_0x4a3704):_0x5452b2(_0x444fbb,_0x43ed27))||_0x4a3704;}return _0x46d9b0>0x3&&_0x4a3704&&Object['defineProperty'](_0x444fbb,_0x43ed27,_0x4a3704),_0x4a3704;},__metadata=this&&this[_0x5cf19c(0xd1)]||function(_0x157f3c,_0xacfd3e){const _0x20d019=_0x5cf19c;if(typeof Reflect===_0x20d019(0xc9)&&typeof Reflect[_0x20d019(0x100)]===_0x20d019(0xd7))return Reflect[_0x20d019(0x100)](_0x157f3c,_0xacfd3e);},__param=this&&this[_0x5cf19c(0xce)]||function(_0x4833a3,_0x384b39){return function(_0x4f1097,_0x3b01e6){_0x384b39(_0x4f1097,_0x3b01e6,_0x4833a3);};};Object[_0x5cf19c(0x12b)](exports,'__esModule',{'value':!![]}),exports['UserBalanceService']=void 0x0;const balance_constant_1=require(_0x5cf19c(0x11b)),utils_1=require('../../common/utils'),common_1=require(_0x5cf19c(0xfd)),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0x5cf19c(0x10b)),cramiPackage_entity_1=require(_0x5cf19c(0x14b)),config_entity_1=require(_0x5cf19c(0x136)),globalConfig_service_1=require(_0x5cf19c(0x146)),accountLog_entity_1=require(_0x5cf19c(0xe7)),balance_entity_1=require('./balance.entity'),userBalance_entity_1=require('./userBalance.entity'),date_1=require('../../common/utils/date'),chatGroup_entity_1=require(_0x5cf19c(0xdc)),chatLog_entity_1=require(_0x5cf19c(0x101)),user_entity_1=require('../user/user.entity'),fingerprint_entity_1=require(_0x5cf19c(0x123));let UserBalanceService=class UserBalanceService{constructor(_0xc0a2eb,_0x558f46,_0xd61249,_0x2a3201,_0x5e6896,_0x17dad8,_0x207be5,_0x3cc55e,_0x33731c,_0x15e83b){const _0xbbef64=_0x5cf19c;this[_0xbbef64(0xcd)]=_0xc0a2eb,this[_0xbbef64(0xe3)]=_0x558f46,this[_0xbbef64(0x144)]=_0xd61249,this[_0xbbef64(0xe2)]=_0x2a3201,this['configEntity']=_0x5e6896,this['userEntity']=_0x17dad8,this[_0xbbef64(0xf6)]=_0x207be5,this[_0xbbef64(0x160)]=_0x3cc55e,this[_0xbbef64(0x133)]=_0x33731c,this['globalConfigService']=_0x15e83b;}async[_0x5cf19c(0xf1)](_0x43cfe9){const _0x14e000=_0x5cf19c;try{const _0x2ecc1b=await this[_0x14e000(0xd4)][_0x14e000(0xd2)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x14e000(0x151),_0x14e000(0xca),_0x14e000(0x139),_0x14e000(0x149),'firstRegisterSendStatus','firstRegisterSendRank',_0x14e000(0xef),_0x14e000(0xfb),'firstRregisterSendDrawMjCount'])}}),_0x659c30=_0x2ecc1b[_0x14e000(0xfc)]((_0x150037,_0x2d5a2e)=>{const _0x237453=_0x14e000,_0x2a95a0=Number(_0x2d5a2e[_0x237453(0x157)]),_0xd51dbf=Number[_0x237453(0x165)](_0x2a95a0)&&_0x2a95a0>0x0?_0x2a95a0:0x0;return _0x150037[_0x2d5a2e[_0x237453(0x11d)]]=_0xd51dbf,_0x150037;},{});let _0x1fa17e=0x0,_0x610086=0x0,_0x1dfb9d=0x0;_0x659c30[_0x14e000(0x151)]===0x1&&(_0x1fa17e=_0x1fa17e+_0x659c30[_0x14e000(0xca)],_0x610086=_0x610086+_0x659c30[_0x14e000(0x139)],_0x1dfb9d=_0x1dfb9d+_0x659c30[_0x14e000(0x149)]),_0x659c30['registerSendStatus']===0x1&&_0x659c30[_0x14e000(0xf5)]===0x1&&_0x43cfe9<=_0x659c30[_0x14e000(0xeb)]&&(_0x1fa17e=_0x1fa17e+_0x659c30['firstRregisterSendModel3Count'],_0x610086=_0x610086+_0x659c30[_0x14e000(0xfb)],_0x1dfb9d=_0x1dfb9d+_0x659c30['firstRregisterSendDrawMjCount']),await this[_0x14e000(0xc6)]({'userId':_0x43cfe9,'rechargeType':balance_constant_1[_0x14e000(0xf8)][_0x14e000(0x14c)],'model3Count':_0x1fa17e,'drawMjCount':_0x1dfb9d,'model4Count':_0x610086}),await this['userBalanceEntity']['save']({'userId':_0x43cfe9,'model3Count':_0x1fa17e,'model4Count':_0x610086,'drawMjCount':_0x1dfb9d,'useTokens':0x0});}catch(_0x52de2c){console['log']('error:\x20',_0x52de2c);throw new common_1[(_0x14e000(0x118))](_0x14e000(0x12e),common_1[_0x14e000(0x155)][_0x14e000(0xd8)]);}}async['validateBalance'](_0x20d082,_0x155ee3,_0x143bb1){const _0xa33ecc=_0x5cf19c,{id:_0xd49516,role:_0x343217}=_0x20d082[_0xa33ecc(0x15b)];let _0x3176e7=await this[_0xa33ecc(0xe3)]['findOne']({'where':{'userId':_0xd49516}});!_0x3176e7&&(_0x3176e7=await this[_0xa33ecc(0x113)](_0xd49516));if(_0x343217===_0xa33ecc(0xe0))return this[_0xa33ecc(0x116)](_0x20d082,_0x155ee3,_0x143bb1);const _0x4dd43a=_0x155ee3===0x1?_0xa33ecc(0xd3):_0x155ee3===0x2?_0xa33ecc(0x11f):_0x155ee3===0x3?'memberDrawMjCount':null,_0x114812=_0x155ee3===0x1?_0xa33ecc(0xee):_0x155ee3===0x2?_0xa33ecc(0x13a):_0x155ee3===0x3?_0xa33ecc(0x138):null;if(_0x3176e7[_0xa33ecc(0xd5)]&&_0x3176e7[_0x4dd43a]+_0x3176e7[_0x114812]<_0x143bb1){if(_0x3176e7[_0x114812]<_0x143bb1)throw new common_1[(_0xa33ecc(0x118))](_0xa33ecc(0xdd),common_1[_0xa33ecc(0x155)]['PAYMENT_REQUIRED']);}if(!_0x3176e7[_0xa33ecc(0xd5)]&&_0x3176e7[_0x114812]<_0x143bb1)throw new common_1[(_0xa33ecc(0x118))](_0xa33ecc(0xdd),common_1[_0xa33ecc(0x155)][_0xa33ecc(0x112)]);return _0x3176e7;}async[_0x5cf19c(0x116)](_0x188782,_0xed6b78,_0x4db715){const _0x198d07=_0x5cf19c,{id:_0x2b5fe9}=_0x188782['user'],_0x4e4e13=_0xed6b78===0x1?_0x198d07(0xee):_0xed6b78===0x2?'model4Count':_0xed6b78===0x3?'drawMjCount':null,_0x498309=new Date(),_0x2377fb=await this['fingerprintLogEntity'][_0x198d07(0x120)]({'where':{'fingerprint':_0x2b5fe9}}),{visitorModel3Num:_0x229ec2,visitorModel4Num:_0x3e34e6,visitorMJNum:_0x212c9b}=await this[_0x198d07(0xf4)]['getConfigs']([_0x198d07(0xe9),_0x198d07(0x15e),_0x198d07(0x134)]),_0x4a5460={'model3Count':_0x229ec2?Number(_0x229ec2):0x0,'model4Count':_0x3e34e6?Number(_0x3e34e6):0x0,'drawMjCount':_0x212c9b?Number(_0x212c9b):0x0};if(!_0x2377fb){let _0x40577c={'fingerprint':_0x2b5fe9,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0};_0x40577c[_0x4e4e13]=_0x40577c[_0x4e4e13]+_0x4db715;if(_0x40577c[_0x4e4e13]>_0x4a5460[_0x4e4e13])throw new common_1[(_0x198d07(0x118))](_0x198d07(0x130),common_1['HttpStatus'][_0x198d07(0x112)]);else return await this[_0x198d07(0xf6)][_0x198d07(0x108)](_0x40577c),!![];}else{const {model3Count:_0x4b5558,model4Count:_0x3df1e7,drawMjCount:_0x14e61b}=_0x2377fb;let _0x41a1b={'model3Count':_0x4b5558,'model4Count':_0x3df1e7,'drawMjCount':_0x14e61b};const _0x3b855c=Number(new Date(_0x2377fb['updatedAt'])),_0x16be29=this[_0x198d07(0xdf)](_0x3b855c);_0x16be29?_0x41a1b[_0x4e4e13]=_0x41a1b[_0x4e4e13]+_0x4db715:(_0x41a1b={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x41a1b[_0x4e4e13]=_0x41a1b[_0x4e4e13]+_0x4db715);if(_0x41a1b[_0x4e4e13]>_0x4a5460[_0x4e4e13])throw new common_1[(_0x198d07(0x118))]('今日体验额度使用完毕，请注册使用完整服务！',common_1[_0x198d07(0x155)][_0x198d07(0x112)]);else return await this[_0x198d07(0xf6)][_0x198d07(0x15c)]({'fingerprint':_0x2b5fe9},_0x41a1b),!![];}}[_0x5cf19c(0xdf)](_0x2c9362){const _0x2fa3b9=_0x5cf19c,_0xb4a698=new Date(),_0x3b2a58=new Date(_0xb4a698['getFullYear'](),_0xb4a698[_0x2fa3b9(0xc8)](),_0xb4a698[_0x2fa3b9(0x10f)]());return _0x2c9362>=_0x3b2a58;}async[_0x5cf19c(0x12f)](_0x38b1f4,_0x1b436d,_0x432a6f,_0x2fed82=0x0){const _0x36a577=_0x5cf19c,_0x1faa66=await this[_0x36a577(0xe3)][_0x36a577(0x120)]({'where':{'userId':_0x38b1f4}});if(!_0x1faa66)throw new common_1[(_0x36a577(0x118))](_0x36a577(0xd6),common_1[_0x36a577(0x155)]['BAD_REQUEST']);const _0x103073={0x1:{'member':_0x36a577(0xd3),'nonMember':_0x36a577(0xee),'token':_0x36a577(0xc5)},0x2:{'member':_0x36a577(0x11f),'nonMember':_0x36a577(0x13a),'token':'useModel4Token'},0x3:{'member':'memberDrawMjCount','nonMember':_0x36a577(0x138),'token':_0x36a577(0xe6)}},{member:_0x3263aa,nonMember:_0x52ec61,token:_0x5497a4}=_0x103073[_0x1b436d];let _0x3b5db5=_0x432a6f,_0x2ed532=Math[_0x36a577(0x150)](_0x1faa66[_0x3263aa]-_0x3b5db5,0x0);_0x3b5db5-=_0x1faa66[_0x3263aa]-_0x2ed532;let _0xe07a1b=_0x1faa66[_0x52ec61];_0x3b5db5>0x0&&(_0xe07a1b=Math[_0x36a577(0x150)](_0x1faa66[_0x52ec61]-_0x3b5db5,0x0),_0x3b5db5-=_0x1faa66[_0x52ec61]-_0xe07a1b);const _0x388048={[_0x3263aa]:_0x2ed532,[_0x52ec61]:_0xe07a1b,[_0x5497a4]:(_0x1faa66[_0x5497a4]||0x0)+_0x2fed82};(_0x5497a4===_0x36a577(0xc5)||_0x5497a4==='useModel4Token')&&(_0x388048[_0x5497a4[_0x36a577(0x105)](_0x36a577(0x158),'Count')]=(_0x1faa66[_0x5497a4[_0x36a577(0x105)](_0x36a577(0x158),_0x36a577(0x147))]||0x0)+_0x432a6f);const _0x18c47c=await this[_0x36a577(0xe3)][_0x36a577(0x15c)]({'userId':_0x38b1f4},_0x388048);if(_0x18c47c[_0x36a577(0xda)]===0x0)throw new common_1['HttpException']('消费余额失败！',common_1[_0x36a577(0x155)]['BAD_REQUEST']);}async[_0x5cf19c(0x114)](_0x4cdd26){const _0x55d359=_0x5cf19c;try{const _0x18551e=await this[_0x55d359(0xe3)][_0x55d359(0x120)]({'where':{'userId':_0x4cdd26},'select':[_0x55d359(0xd5),_0x55d359(0xee),'model4Count',_0x55d359(0x138),_0x55d359(0xd3),'memberModel4Count',_0x55d359(0xea),_0x55d359(0xf3),_0x55d359(0x13e),_0x55d359(0xc5),_0x55d359(0x115),'useDrawMjToken','expirationTime']});if(!_0x18551e){const _0xf5dd04=await this['createBaseUserBalance'](_0x4cdd26);if(_0xf5dd04)return await this[_0x55d359(0x114)](_0x4cdd26);else throw new common_1[(_0x55d359(0x118))](_0x55d359(0xf0),common_1[_0x55d359(0x155)][_0x55d359(0xd8)]);}return _0x18551e[_0x55d359(0x167)]=_0x18551e['packageId']?_0x18551e[_0x55d359(0xee)]+_0x18551e[_0x55d359(0xd3)]:_0x18551e[_0x55d359(0xee)],_0x18551e['sumModel4Count']=_0x18551e['packageId']?_0x18551e['model4Count']+_0x18551e[_0x55d359(0x11f)]:_0x18551e[_0x55d359(0x13a)],_0x18551e[_0x55d359(0x148)]=_0x18551e['packageId']?_0x18551e[_0x55d359(0x138)]+_0x18551e[_0x55d359(0xea)]:_0x18551e[_0x55d359(0x138)],_0x18551e[_0x55d359(0x10e)]=_0x18551e[_0x55d359(0x10e)]?(0x0,date_1[_0x55d359(0xe5)])(_0x18551e[_0x55d359(0x10e)],_0x55d359(0x122)):null,_0x18551e;}catch(_0xdbba9c){console[_0x55d359(0x162)](_0x55d359(0xed),_0xdbba9c);}}async[_0x5cf19c(0xc6)](_0x3c849b){const _0x3c3861=_0x5cf19c,{userId:_0x344187,rechargeType:_0x95c3eb,model3Count:_0x4327e2,model4Count:_0x9a7774,drawMjCount:_0x4b31c5,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x3c849b;if(!_0x344187)throw new common_1[(_0x3c3861(0x118))](_0x3c3861(0x111),common_1[_0x3c3861(0x155)]['BAD_REQUEST']);const _0x47e7c9=(0x0,utils_1['createRandomUid'])();return await this['accountLogEntity'][_0x3c3861(0x108)]({'userId':_0x344187,'rechargeType':_0x95c3eb,'model3Count':_0x4327e2,'model4Count':_0x9a7774,'drawMjCount':_0x4b31c5,'days':days,'extent':extent,'uid':_0x47e7c9,'pkgName':pkgName});}async[_0x5cf19c(0x113)](_0x32aac8,_0x510b9c={}){const _0x103909=_0x5cf19c,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x510b9c,_0x16162b=await this[_0x103909(0xe3)]['findOne']({'where':{'userId':_0x32aac8}});if(_0x16162b)throw new common_1[(_0x103909(0x118))]('当前用户无需创建账户信息！',common_1[_0x103909(0x155)]['BAD_REQUEST']);return await this[_0x103909(0xe3)][_0x103909(0x108)]({'userId':_0x32aac8,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async[_0x5cf19c(0x135)](_0x36763d,_0x27101e,_0x26f9e8=-0x1){const _0x50e594=_0x5cf19c;try{const _0x11b2d2=await this[_0x50e594(0xe3)][_0x50e594(0x120)]({'where':{'userId':_0x36763d}})||await this[_0x50e594(0x113)](_0x36763d);if(!_0x11b2d2)throw new common_1['HttpException'](_0x50e594(0x14f),common_1[_0x50e594(0x155)][_0x50e594(0xd8)]);const {model3Count:_0x6ab9c,model4Count:_0x50adf9,drawMjCount:_0x25eb74,memberModel3Count:_0xcad3c3,memberModel4Count:_0x2dc5c1,memberDrawMjCount:_0x40e9e5}=_0x11b2d2;let _0x3d7a4d={};if(_0x26f9e8>0x0){const {packageId:_0x167c43}=_0x27101e;if(!_0x167c43)throw new common_1['HttpException'](_0x50e594(0x126),common_1['HttpStatus'][_0x50e594(0xd8)]);const _0xc20f57=await this[_0x50e594(0xe2)][_0x50e594(0x120)]({'where':{'id':_0x167c43}});if(!_0xc20f57)throw new common_1[(_0x50e594(0x118))](_0x50e594(0xd9),common_1[_0x50e594(0x155)][_0x50e594(0xd8)]);const {weight:_0x26cf7e}=_0xc20f57;if(!_0x11b2d2['packageId'])_0x3d7a4d={'memberModel3Count':_0xcad3c3+_0x27101e['model3Count'],'memberModel4Count':_0x2dc5c1+_0x27101e['model4Count'],'memberDrawMjCount':_0x40e9e5+_0x27101e['drawMjCount'],'expirationTime':(0x0,date_1[_0x50e594(0xdb)])()['add'](_0x26f9e8>0x0?_0x26f9e8:0x0,_0x50e594(0x13d))[_0x50e594(0x12a)]('YYYY-MM-DD\x20HH:mm:ss'),'packageId':_0x167c43};else{const _0x2a1fda=await this[_0x50e594(0xe2)][_0x50e594(0x120)]({'where':{'id':_0x11b2d2[_0x50e594(0xd5)]}});_0x26cf7e>=_0x2a1fda['weight']&&(_0x3d7a4d={'memberModel3Count':_0xcad3c3+_0x27101e[_0x50e594(0xee)],'memberModel4Count':_0x2dc5c1+_0x27101e[_0x50e594(0x13a)],'memberDrawMjCount':_0x40e9e5+_0x27101e[_0x50e594(0x138)],'expirationTime':(0x0,date_1['default'])(_0x11b2d2['expirationTime'])[_0x50e594(0x124)](_0x26f9e8>0x0?_0x26f9e8:0x0,'day')[_0x50e594(0x12a)](_0x50e594(0x128)),'packageId':_0x167c43}),_0x26cf7e<_0x2a1fda[_0x50e594(0x132)]&&(_0x3d7a4d={'memberModel3Count':_0xcad3c3+_0x27101e[_0x50e594(0xee)],'memberModel4Count':_0x2dc5c1+_0x27101e['model4Count'],'memberDrawMjCount':_0x40e9e5+_0x27101e[_0x50e594(0x138)]});}}_0x26f9e8<=0x0&&(_0x3d7a4d={'model3Count':_0x6ab9c+_0x27101e['model3Count'],'model4Count':_0x50adf9+_0x27101e[_0x50e594(0x13a)],'drawMjCount':_0x25eb74+_0x27101e['drawMjCount']});const _0x5df9af=await this[_0x50e594(0xe3)][_0x50e594(0x15c)]({'userId':_0x36763d},_0x3d7a4d);if(_0x5df9af['affected']===0x0)throw new common_1[(_0x50e594(0x118))](_0x36763d+_0x50e594(0x159),common_1[_0x50e594(0x155)][_0x50e594(0xd8)]);}catch(_0x2b4492){console[_0x50e594(0x162)](_0x50e594(0xed),_0x2b4492);throw new common_1[(_0x50e594(0x118))](_0x50e594(0xcf),common_1[_0x50e594(0x155)][_0x50e594(0xd8)]);}}async['addBalanceToOrder'](_0x45eb02){const _0x2f79cf=_0x5cf19c;console[_0x2f79cf(0x162)](_0x2f79cf(0x109),_0x45eb02);try{const {userId:_0x1ef6d3,goodsId:_0x392030}=_0x45eb02,_0x497bfb=await this[_0x2f79cf(0xe2)][_0x2f79cf(0x120)]({'where':{'id':_0x45eb02[_0x2f79cf(0x10a)],'status':0x1}});if(!_0x497bfb)throw new common_1['HttpException'](_0x2f79cf(0x131),common_1[_0x2f79cf(0x155)][_0x2f79cf(0xd8)]);const {model3Count:_0x597944,model4Count:_0x57c6bb,drawMjCount:_0x1c911a,days:_0x708235,name:_0x2bbc5c}=_0x497bfb,_0x295cc3={'model3Count':_0x597944,'model4Count':_0x57c6bb,'drawMjCount':_0x1c911a,'days':_0x708235,'packageId':_0x45eb02[_0x2f79cf(0x10a)]};await this['addBalanceToUser'](_0x1ef6d3,_0x295cc3,_0x708235),await this['saveRecordRechargeLog']({'userId':_0x1ef6d3,'rechargeType':balance_constant_1['RechargeType']['SCAN_PAY'],'model3Count':_0x597944,'model4Count':_0x57c6bb,'drawMjCount':_0x1c911a,'pkgName':_0x2bbc5c,'days':_0x708235});}catch(_0x1e9bb7){console[_0x2f79cf(0x162)](_0x2f79cf(0xed),_0x1e9bb7);throw new common_1[(_0x2f79cf(0x118))]('充值失败！',common_1[_0x2f79cf(0x155)][_0x2f79cf(0xd8)]);}}async[_0x5cf19c(0x107)](_0x2edfb4,_0x2c00d4){const _0x30e056=_0x5cf19c,{page:page=0x1,size:size=0x14}=_0x2c00d4,{id:_0x41a269}=_0x2edfb4[_0x30e056(0x15b)],[_0x17203b,_0x472fc3]=await this[_0x30e056(0x144)]['findAndCount']({'where':{'userId':_0x41a269},'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size});return _0x17203b[_0x30e056(0xcb)](_0x415847=>{const _0x3de229=_0x30e056;_0x415847['expireDateCn']=_0x415847[_0x3de229(0x10d)]>0x0?_0x415847['days']+'天':'永久';}),{'rows':(0x0,date_1[_0x30e056(0xec)])(_0x17203b),'count':_0x472fc3};}async[_0x5cf19c(0x10c)](_0x2f2a29,_0x5a6263){const _0x38b279=_0x5cf19c;try{const {page:page=0x1,size:size=0xa,userId:_0x456a5d,rechargeType:_0xe55eb3,packageId:_0x2b4ce5}=_0x5a6263,{role:_0x3f56dd}=_0x2f2a29['user'],_0x3d99ce={};_0xe55eb3&&(_0x3d99ce[_0x38b279(0x14e)]=_0xe55eb3),_0x3d99ce['userId']=_0x456a5d||(0x0,typeorm_2['LessThan'])(0x186a0),_0x2b4ce5&&(_0x3d99ce[_0x38b279(0xd5)]={'$like':'%'+_0x2b4ce5+'%'});const [_0x2a8392,_0x4718a9]=await this[_0x38b279(0x144)][_0x38b279(0x143)]({'where':_0x3d99ce,'order':{'id':_0x38b279(0x152)},'skip':(page-0x1)*size,'take':size}),_0x21c48c=_0x2a8392['map'](_0x5af3f5=>_0x5af3f5['userId']),_0x33776c=await this[_0x38b279(0x12d)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x21c48c)}});return _0x2a8392[_0x38b279(0xcb)](_0x53458a=>{const _0x47deef=_0x38b279,_0x13d39a=_0x33776c[_0x47deef(0xd2)](_0x5c3c37=>_0x5c3c37['id']===_0x53458a[_0x47deef(0xe1)]);_0x53458a['username']=_0x13d39a===null||_0x13d39a===void 0x0?void 0x0:_0x13d39a[_0x47deef(0x15f)],_0x53458a[_0x47deef(0x141)]=_0x13d39a===null||_0x13d39a===void 0x0?void 0x0:_0x13d39a['email'],_0x53458a[_0x47deef(0x110)]=_0x13d39a===null||_0x13d39a===void 0x0?void 0x0:_0x13d39a['phone'],_0x53458a[_0x47deef(0xf7)]=_0x13d39a===null||_0x13d39a===void 0x0?void 0x0:_0x13d39a['status'],_0x53458a[_0x47deef(0x163)]=_0x13d39a===null||_0x13d39a===void 0x0?void 0x0:_0x13d39a[_0x47deef(0x163)];}),_0x3f56dd!=='super'&&_0x2a8392[_0x38b279(0xcb)](_0x7864e5=>{const _0x1b6673=_0x38b279;_0x7864e5['email']=_0x7864e5[_0x1b6673(0x141)]?(0x0,utils_1[_0x1b6673(0x154)])(_0x7864e5[_0x1b6673(0x141)]):'',_0x7864e5[_0x1b6673(0x110)]=_0x7864e5[_0x1b6673(0x110)]?(0x0,utils_1[_0x1b6673(0x154)])(_0x7864e5[_0x1b6673(0x110)]):'';}),{'rows':_0x2a8392,'count':_0x4718a9};}catch(_0x57bb98){console[_0x38b279(0x162)]('error:\x20',_0x57bb98);throw new common_1[(_0x38b279(0x118))](_0x38b279(0x140),common_1[_0x38b279(0x155)][_0x38b279(0xd8)]);}}async[_0x5cf19c(0x11e)](_0x154835){const _0x3092c7=_0x5cf19c;return await this['userBalanceEntity'][_0x3092c7(0xd2)]({'where':{'userId':(0x0,typeorm_2['In'])(_0x154835)}});}async[_0x5cf19c(0x156)](_0x212b37,_0x125a3f){const _0x3d608c=_0x5cf19c;return await this[_0x3d608c(0x12f)](_0x212b37,_0x3d608c(0x13b),-_0x125a3f);}async[_0x5cf19c(0x11c)](_0x2ef60d){const _0x45ac20=_0x5cf19c,{fingerprint:_0x381074}=_0x2ef60d[_0x45ac20(0xe4)],{id:_0x25bde3}=_0x2ef60d['user'];return await this[_0x45ac20(0x133)][_0x45ac20(0x15c)]({'userId':Number(_0x381074)},{'userId':_0x25bde3}),await this['chatGroupEntity']['update']({'userId':Number(_0x381074)},{'userId':_0x25bde3}),0x1;}async['getVisitorCount'](_0x4b9fcd){const _0x3971d6=_0x5cf19c,{fingerprint:_0x2eecdc}=_0x4b9fcd[_0x3971d6(0xe4)],_0x34dd0c=await this[_0x3971d6(0x133)][_0x3971d6(0x15a)]({'where':{'userId':_0x2eecdc}}),_0x20182b=await this[_0x3971d6(0x160)][_0x3971d6(0x15a)]({'where':{'userId':_0x2eecdc}});return _0x34dd0c||_0x20182b||0x0;}async['checkUserCertification'](_0x149321){const _0x4a55fe=_0x5cf19c,_0x53929f=await this['userEntity'][_0x4a55fe(0x120)]({'where':{'id':_0x149321}}),_0x46cef0=await this['userBalanceEntity'][_0x4a55fe(0x120)]({'where':{'userId':_0x149321}});if(!_0x53929f||!_0x46cef0)return;const {phoneValidationMessageCount:_0x5e05ed,identityVerificationMessageCount:_0x52863f,openIdentity:_0x75ab8e,openPhoneValidation:_0x37a6a5}=await this[_0x4a55fe(0xf4)][_0x4a55fe(0x119)]([_0x4a55fe(0x169),'identityVerificationMessageCount',_0x4a55fe(0x106),_0x4a55fe(0x161)]),_0x2b6e2a=Number(_0x5e05ed),_0x148ab3=Number(_0x52863f),_0x8c9e2b=Number(_0x46cef0[_0x4a55fe(0xf3)])||0x0,_0x1f3a93=Number(_0x46cef0['useModel4Count'])||0x0,_0xe6132e=_0x8c9e2b+_0x1f3a93;if(_0x37a6a5==='1'&&_0xe6132e>=_0x2b6e2a&&!_0x53929f[_0x4a55fe(0x110)])throw new common_1[(_0x4a55fe(0x118))](_0x4a55fe(0x137),common_1['HttpStatus'][_0x4a55fe(0xd8)]);if(_0x75ab8e==='1'&&_0xe6132e>=_0x148ab3&&(!_0x53929f[_0x4a55fe(0x117)]||!_0x53929f[_0x4a55fe(0x166)]))throw new common_1[(_0x4a55fe(0x118))](_0x4a55fe(0x129),common_1[_0x4a55fe(0x155)][_0x4a55fe(0xd8)]);}};function _0x3483(){const _0xb42052=['请完成手机号绑定','drawMjCount','registerSendModel4Count','model4Count','mjDraw','Injectable','day','useModel4Count','Repository','查询用户账户失败！','email','length','findAndCount','accountLogEntity','UserBalanceService','./../globalConfig/globalConfig.service','Count','sumDrawMjCount','registerSendDrawMjCount','20bYycQq','../crami/cramiPackage.entity','REG_GIFT','744uQLMeS','rechargeType','查询用户账户信息失败！','max','registerSendStatus','DESC','394276KprlIw','hideString','HttpStatus','refundMjBalance','configVal','Token','充值失败','count','user','update','AccountLogEntity','visitorModel4Num','username','chatGroupEntity','openPhoneValidation','log','avatar','BalanceEntity','isInteger','idCard','sumModel3Count','InjectRepository','phoneValidationMessageCount','useModel3Token','saveRecordRechargeLog','50SFCQha','getMonth','object','registerSendModel3Count','forEach','ConfigEntity','balanceEntity','__param','用户充值失败！','50DoQkDB','__metadata','find','memberModel3Count','configEntity','packageId','缺失当前用户账户记录！','function','BAD_REQUEST','当前套餐不存在！','affected','default','../chatGroup/chatGroup.entity','积分不足，继续体验服务，请按需选购套餐！','decorate','isUpdatedToday','visitor','userId','cramiPackageEntity','userBalanceEntity','headers','formatDate','useDrawMjToken','./accountLog.entity','6BEoaWo','visitorModel3Num','memberDrawMjCount','firstRegisterSendRank','formatCreateOrUpdateDate','error:\x20','model3Count','firstRregisterSendModel3Count','查询当前用户余额失败！','addBalanceToNewUser','138843DKMqTZ','useModel3Count','globalConfigService','firstRegisterSendStatus','fingerprintLogEntity','status','RechargeType','4519017GxnUFH','__decorate','firstRregisterSendModel4Count','reduce','@nestjs/common','FingerprintLogEntity','getOwnPropertyDescriptor','metadata','../chatLog/chatLog.entity','UserEntity','design:paramtypes','98452212PFsbdr','replace','openIdentity','getRechargeLog','save','充值的工单信息:','goodsId','typeorm','getAccountLog','days','expirationTime','getDate','phone','当前用户不存在,记录充值日志异常','PAYMENT_REQUIRED','createBaseUserBalance','queryUserBalance','useModel4Token','validateVisitorBalance','realName','HttpException','getConfigs','UserBalanceEntity','../../common/constants/balance.constant','inheritVisitorData','configKey','queryUserBalanceByIds','memberModel4Count','findOne','3783428uDPBwC','YYYY-MM-DD','./fingerprint.entity','add','17642yBFuiM','缺失当前套餐ID、充值失败！','12251981jJzLnO','YYYY-MM-DD\x20HH:mm:ss','请完成实名认证','format','defineProperty','ChatGroupEntity','userEntity','注册赠送失败,请联系管理员！','deductFromBalance','今日体验额度使用完毕，请注册使用完整服务！','非法操作、当前充值套餐暂不存在！','weight','chatLogEntity','visitorMJNum','addBalanceToUser','../globalConfig/config.entity'];_0x3483=function(){return _0xb42052;};return _0x3483();}UserBalanceService=__decorate([(0x0,common_1[_0x5cf19c(0x13c)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(balance_entity_1[_0x5cf19c(0x164)])),__param(0x1,(0x0,typeorm_1[_0x5cf19c(0x168)])(userBalance_entity_1[_0x5cf19c(0x11a)])),__param(0x2,(0x0,typeorm_1[_0x5cf19c(0x168)])(accountLog_entity_1[_0x5cf19c(0x15d)])),__param(0x3,(0x0,typeorm_1[_0x5cf19c(0x168)])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x4,(0x0,typeorm_1[_0x5cf19c(0x168)])(config_entity_1[_0x5cf19c(0xcc)])),__param(0x5,(0x0,typeorm_1[_0x5cf19c(0x168)])(user_entity_1[_0x5cf19c(0x102)])),__param(0x6,(0x0,typeorm_1[_0x5cf19c(0x168)])(fingerprint_entity_1[_0x5cf19c(0xfe)])),__param(0x7,(0x0,typeorm_1[_0x5cf19c(0x168)])(chatGroup_entity_1[_0x5cf19c(0x12c)])),__param(0x8,(0x0,typeorm_1['InjectRepository'])(chatLog_entity_1['ChatLogEntity'])),__metadata(_0x5cf19c(0x103),[typeorm_2[_0x5cf19c(0x13f)],typeorm_2[_0x5cf19c(0x13f)],typeorm_2[_0x5cf19c(0x13f)],typeorm_2[_0x5cf19c(0x13f)],typeorm_2[_0x5cf19c(0x13f)],typeorm_2[_0x5cf19c(0x13f)],typeorm_2[_0x5cf19c(0x13f)],typeorm_2[_0x5cf19c(0x13f)],typeorm_2[_0x5cf19c(0x13f)],globalConfig_service_1['GlobalConfigService']])],UserBalanceService),exports[_0x5cf19c(0x145)]=UserBalanceService;