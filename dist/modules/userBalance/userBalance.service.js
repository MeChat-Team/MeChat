'use strict';const _0x2bc73c=_0x4b7a;(function(_0x2271fe,_0x18200c){const _0x5f58b1=_0x4b7a,_0x5d0d00=_0x2271fe();while(!![]){try{const _0x2611b9=parseInt(_0x5f58b1(0xec))/0x1*(parseInt(_0x5f58b1(0x119))/0x2)+-parseInt(_0x5f58b1(0x11a))/0x3+parseInt(_0x5f58b1(0xda))/0x4*(parseInt(_0x5f58b1(0x138))/0x5)+parseInt(_0x5f58b1(0x113))/0x6+-parseInt(_0x5f58b1(0x122))/0x7*(parseInt(_0x5f58b1(0xc3))/0x8)+parseInt(_0x5f58b1(0xc2))/0x9+-parseInt(_0x5f58b1(0xfc))/0xa;if(_0x2611b9===_0x18200c)break;else _0x5d0d00['push'](_0x5d0d00['shift']());}catch(_0x141241){_0x5d0d00['push'](_0x5d0d00['shift']());}}}(_0x4218,0xa7620));var __decorate=this&&this[_0x2bc73c(0x125)]||function(_0x1e7989,_0x5058f4,_0x27b564,_0x11a260){const _0x872a9=_0x2bc73c;var _0xfde733=arguments[_0x872a9(0x10f)],_0x40eba0=_0xfde733<0x3?_0x5058f4:_0x11a260===null?_0x11a260=Object[_0x872a9(0x11b)](_0x5058f4,_0x27b564):_0x11a260,_0x439321;if(typeof Reflect==='object'&&typeof Reflect[_0x872a9(0xcd)]===_0x872a9(0xb8))_0x40eba0=Reflect[_0x872a9(0xcd)](_0x1e7989,_0x5058f4,_0x27b564,_0x11a260);else{for(var _0x26432b=_0x1e7989[_0x872a9(0x10f)]-0x1;_0x26432b>=0x0;_0x26432b--)if(_0x439321=_0x1e7989[_0x26432b])_0x40eba0=(_0xfde733<0x3?_0x439321(_0x40eba0):_0xfde733>0x3?_0x439321(_0x5058f4,_0x27b564,_0x40eba0):_0x439321(_0x5058f4,_0x27b564))||_0x40eba0;}return _0xfde733>0x3&&_0x40eba0&&Object[_0x872a9(0xb3)](_0x5058f4,_0x27b564,_0x40eba0),_0x40eba0;},__metadata=this&&this[_0x2bc73c(0xbc)]||function(_0x4e31e4,_0x38b153){const _0x2a7368=_0x2bc73c;if(typeof Reflect===_0x2a7368(0xf9)&&typeof Reflect[_0x2a7368(0x12f)]==='function')return Reflect[_0x2a7368(0x12f)](_0x4e31e4,_0x38b153);},__param=this&&this[_0x2bc73c(0x10b)]||function(_0xefacb7,_0x41e5e6){return function(_0x52ed68,_0x2e4ece){_0x41e5e6(_0x52ed68,_0x2e4ece,_0xefacb7);};};function _0x4218(){const _0x31f0ba=['__metadata','getDate','default','headers','YYYY-MM-DD\x20HH:mm:ss','reduce','6480540WcgEMV','5744NbylHl','count','消费余额失败！','registerSendModel4Count','积分不足，继续体验服务，请按需选购套餐！','Token','ChatLogEntity','cramiPackageEntity','getAccountLog','drawMjCount','decorate','HttpException','Injectable','checkUserCertification','ConfigEntity','identityVerificationMessageCount','useDrawMjToken','avatar','openPhoneValidation','firstRregisterSendModel4Count','queryUserBalance','addBalanceToOrder','save','3738328zuXhwx','hideString','useModel4Count','goodsId','max','status','userBalanceEntity','forEach','update','balanceEntity','firstRegisterSendRank','configEntity','FingerprintLogEntity','weight','addBalanceToUser','../user/user.entity','BalanceEntity','当前用户无需创建账户信息！','1RggitL','今日体验额度使用完毕，请注册使用完整服务！','sumModel3Count','./fingerprint.entity','GlobalConfigService','useModel3Count','查询当前用户余额失败！','userId','formatDate','memberDrawMjCount','InjectRepository','查询用户账户失败！','day','object','用户充值失败！','../crami/cramiPackage.entity','20012500jdduxL','YYYY-MM-DD','HttpStatus','UserEntity','registerSendStatus','注册赠送失败,请联系管理员！','getVisitorCount','createBaseUserBalance','充值失败','isInteger','getMonth','memberModel3Count','Repository','缺失当前用户账户记录！','SCAN_PAY','__param','memberModel4Count','AccountLogEntity','accountLogEntity','length','typeorm','findOne','getFullYear','7485870NUDExX','model3Count','../../common/utils','userEntity','find','validateVisitorBalance','797110aBrVDp','1256088jiVtCG','getOwnPropertyDescriptor','../chatLog/chatLog.entity','packageId','查询用户账户信息失败！','ChatGroupEntity','visitorModel4Num','缺失当前套餐ID、充值失败！','1904BfHEOt','days','affected','__decorate','@nestjs/typeorm','realName','createRandomUid','UserBalanceService','visitor','phone','useModel4Token','非法操作、当前充值套餐暂不存在！','user','metadata','openIdentity','registerSendModel3Count','chatGroupEntity','visitorModel3Num','error:\x20','RechargeType','expirationTime','../../common/utils/date','5VlilxE','./balance.entity','getConfigs','formatCreateOrUpdateDate','model4Count','email','../globalConfig/config.entity','add','fingerprintLogEntity','sumModel4Count','请完成实名认证','chatLogEntity','firstRregisterSendDrawMjCount','../../common/constants/balance.constant','isUpdatedToday','UserBalanceEntity','DESC','useModel3Token','REG_GIFT','queryUserBalanceByIds','format','replace','PAYMENT_REQUIRED','CramiPackageEntity','expireDateCn','username','getRechargeLog','BAD_REQUEST','firstRegisterSendStatus','log','defineProperty','./../globalConfig/globalConfig.service','globalConfigService','请完成手机号绑定','当前套餐不存在！','function','deductFromBalance','addBalanceToNewUser','LessThan'];_0x4218=function(){return _0x31f0ba;};return _0x4218();}function _0x4b7a(_0x665c8b,_0x2ae22){const _0x4218d1=_0x4218();return _0x4b7a=function(_0x4b7ab6,_0x442bec){_0x4b7ab6=_0x4b7ab6-0xa2;let _0x1708c2=_0x4218d1[_0x4b7ab6];return _0x1708c2;},_0x4b7a(_0x665c8b,_0x2ae22);}Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[_0x2bc73c(0x129)]=void 0x0;const balance_constant_1=require(_0x2bc73c(0xa2)),utils_1=require(_0x2bc73c(0x115)),common_1=require('@nestjs/common'),typeorm_1=require(_0x2bc73c(0x126)),typeorm_2=require(_0x2bc73c(0x110)),cramiPackage_entity_1=require(_0x2bc73c(0xfb)),config_entity_1=require(_0x2bc73c(0x13e)),globalConfig_service_1=require(_0x2bc73c(0xb4)),accountLog_entity_1=require('./accountLog.entity'),balance_entity_1=require(_0x2bc73c(0x139)),userBalance_entity_1=require('./userBalance.entity'),date_1=require(_0x2bc73c(0x137)),chatGroup_entity_1=require('../chatGroup/chatGroup.entity'),chatLog_entity_1=require(_0x2bc73c(0x11c)),user_entity_1=require(_0x2bc73c(0xe9)),fingerprint_entity_1=require(_0x2bc73c(0xef));let UserBalanceService=class UserBalanceService{constructor(_0x5ef01f,_0x301f95,_0x519320,_0x419c76,_0x532491,_0x40ed50,_0x22b8a8,_0x142b75,_0xeb0b36,_0x187a23){const _0x5079aa=_0x2bc73c;this[_0x5079aa(0xe3)]=_0x5ef01f,this[_0x5079aa(0xe0)]=_0x301f95,this['accountLogEntity']=_0x519320,this[_0x5079aa(0xca)]=_0x419c76,this[_0x5079aa(0xe5)]=_0x532491,this[_0x5079aa(0x116)]=_0x40ed50,this[_0x5079aa(0x140)]=_0x22b8a8,this[_0x5079aa(0x132)]=_0x142b75,this[_0x5079aa(0x143)]=_0xeb0b36,this[_0x5079aa(0xb5)]=_0x187a23;}async[_0x2bc73c(0xba)](_0x20cbf3){const _0x519ead=_0x2bc73c;try{const _0x37bc8b=await this['configEntity']['find']({'where':{'configKey':(0x0,typeorm_2['In'])([_0x519ead(0x100),_0x519ead(0x131),'registerSendModel4Count','registerSendDrawMjCount',_0x519ead(0xb1),_0x519ead(0xe4),'firstRregisterSendModel3Count',_0x519ead(0xd6),_0x519ead(0x144)])}}),_0x5477a3=_0x37bc8b[_0x519ead(0xc1)]((_0x539c8c,_0x333b0e)=>{const _0x2f9e3e=_0x519ead,_0x35356e=Number(_0x333b0e['configVal']),_0xfe0c28=Number[_0x2f9e3e(0x105)](_0x35356e)&&_0x35356e>0x0?_0x35356e:0x0;return _0x539c8c[_0x333b0e['configKey']]=_0xfe0c28,_0x539c8c;},{});let _0x2daae8=0x0,_0x13d915=0x0,_0x540e88=0x0;_0x5477a3[_0x519ead(0x100)]===0x1&&(_0x2daae8=_0x2daae8+_0x5477a3[_0x519ead(0x131)],_0x13d915=_0x13d915+_0x5477a3[_0x519ead(0xc6)],_0x540e88=_0x540e88+_0x5477a3['registerSendDrawMjCount']),_0x5477a3['registerSendStatus']===0x1&&_0x5477a3[_0x519ead(0xb1)]===0x1&&_0x20cbf3<=_0x5477a3[_0x519ead(0xe4)]&&(_0x2daae8=_0x2daae8+_0x5477a3['firstRregisterSendModel3Count'],_0x13d915=_0x13d915+_0x5477a3[_0x519ead(0xd6)],_0x540e88=_0x540e88+_0x5477a3[_0x519ead(0x144)]),await this['saveRecordRechargeLog']({'userId':_0x20cbf3,'rechargeType':balance_constant_1[_0x519ead(0x135)][_0x519ead(0xa7)],'model3Count':_0x2daae8,'drawMjCount':_0x540e88,'model4Count':_0x13d915}),await this[_0x519ead(0xe0)][_0x519ead(0xd9)]({'userId':_0x20cbf3,'model3Count':_0x2daae8,'model4Count':_0x13d915,'drawMjCount':_0x540e88,'useTokens':0x0});}catch(_0x2ea936){console[_0x519ead(0xb2)](_0x519ead(0x134),_0x2ea936);throw new common_1[(_0x519ead(0xce))](_0x519ead(0x101),common_1[_0x519ead(0xfe)]['BAD_REQUEST']);}}async['validateBalance'](_0x420ac5,_0xeb8f3d,_0x20eea3){const _0x332de2=_0x2bc73c,{id:_0x5ce667,role:_0x12b16a}=_0x420ac5[_0x332de2(0x12e)];let _0x3ffb38=await this[_0x332de2(0xe0)][_0x332de2(0x111)]({'where':{'userId':_0x5ce667}});!_0x3ffb38&&(_0x3ffb38=await this[_0x332de2(0x103)](_0x5ce667));if(_0x12b16a===_0x332de2(0x12a))return this['validateVisitorBalance'](_0x420ac5,_0xeb8f3d,_0x20eea3);const _0x1da44b=_0xeb8f3d===0x1?_0x332de2(0x107):_0xeb8f3d===0x2?_0x332de2(0x10c):_0xeb8f3d===0x3?'memberDrawMjCount':null,_0x5501ee=_0xeb8f3d===0x1?_0x332de2(0x114):_0xeb8f3d===0x2?_0x332de2(0x13c):_0xeb8f3d===0x3?_0x332de2(0xcc):null;if(_0x3ffb38[_0x332de2(0x11d)]&&_0x3ffb38[_0x1da44b]+_0x3ffb38[_0x5501ee]<_0x20eea3){if(_0x3ffb38[_0x5501ee]<_0x20eea3)throw new common_1[(_0x332de2(0xce))](_0x332de2(0xc7),common_1['HttpStatus'][_0x332de2(0xab)]);}if(!_0x3ffb38[_0x332de2(0x11d)]&&_0x3ffb38[_0x5501ee]<_0x20eea3)throw new common_1[(_0x332de2(0xce))]('积分不足，继续体验服务，请按需选购套餐！',common_1['HttpStatus'][_0x332de2(0xab)]);return _0x3ffb38;}async[_0x2bc73c(0x118)](_0x7ce90a,_0x3b9046,_0x587073){const _0x3d69d0=_0x2bc73c,{id:_0x57055f}=_0x7ce90a[_0x3d69d0(0x12e)],_0x1898e5=_0x3b9046===0x1?_0x3d69d0(0x114):_0x3b9046===0x2?'model4Count':_0x3b9046===0x3?_0x3d69d0(0xcc):null,_0x2fa518=new Date(),_0x24bd5e=await this['fingerprintLogEntity'][_0x3d69d0(0x111)]({'where':{'fingerprint':_0x57055f}}),{visitorModel3Num:_0x4ad19d,visitorModel4Num:_0x361004,visitorMJNum:_0x45cc99}=await this[_0x3d69d0(0xb5)][_0x3d69d0(0x13a)]([_0x3d69d0(0x133),_0x3d69d0(0x120),'visitorMJNum']),_0x3dad05={'model3Count':_0x4ad19d?Number(_0x4ad19d):0x0,'model4Count':_0x361004?Number(_0x361004):0x0,'drawMjCount':_0x45cc99?Number(_0x45cc99):0x0};if(!_0x24bd5e){let _0x5b5701={'fingerprint':_0x57055f,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0};_0x5b5701[_0x1898e5]=_0x5b5701[_0x1898e5]+_0x587073;if(_0x5b5701[_0x1898e5]>_0x3dad05[_0x1898e5])throw new common_1[(_0x3d69d0(0xce))](_0x3d69d0(0xed),common_1[_0x3d69d0(0xfe)][_0x3d69d0(0xab)]);else return await this[_0x3d69d0(0x140)][_0x3d69d0(0xd9)](_0x5b5701),!![];}else{const {model3Count:_0x2bb82a,model4Count:_0x181783,drawMjCount:_0x12a18d}=_0x24bd5e;let _0x34747e={'model3Count':_0x2bb82a,'model4Count':_0x181783,'drawMjCount':_0x12a18d};const _0x167d26=Number(new Date(_0x24bd5e['updatedAt'])),_0x3d4a24=this[_0x3d69d0(0xa3)](_0x167d26);_0x3d4a24?_0x34747e[_0x1898e5]=_0x34747e[_0x1898e5]+_0x587073:(_0x34747e={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x34747e[_0x1898e5]=_0x34747e[_0x1898e5]+_0x587073);if(_0x34747e[_0x1898e5]>_0x3dad05[_0x1898e5])throw new common_1[(_0x3d69d0(0xce))]('今日体验额度使用完毕，请注册使用完整服务！',common_1[_0x3d69d0(0xfe)][_0x3d69d0(0xab)]);else return await this[_0x3d69d0(0x140)]['update']({'fingerprint':_0x57055f},_0x34747e),!![];}}['isUpdatedToday'](_0x524b73){const _0x1d049c=_0x2bc73c,_0x2953c2=new Date(),_0x33328f=new Date(_0x2953c2[_0x1d049c(0x112)](),_0x2953c2[_0x1d049c(0x106)](),_0x2953c2[_0x1d049c(0xbd)]());return _0x524b73>=_0x33328f;}async[_0x2bc73c(0xb9)](_0xc157b5,_0x283a01,_0xe89779,_0x1dc18c=0x0){const _0x4f109a=_0x2bc73c,_0x33aa8b=await this[_0x4f109a(0xe0)][_0x4f109a(0x111)]({'where':{'userId':_0xc157b5}});if(!_0x33aa8b)throw new common_1[(_0x4f109a(0xce))](_0x4f109a(0x109),common_1[_0x4f109a(0xfe)]['BAD_REQUEST']);const _0x4e0fb1={0x1:{'member':_0x4f109a(0x107),'nonMember':_0x4f109a(0x114),'token':_0x4f109a(0xa6)},0x2:{'member':'memberModel4Count','nonMember':'model4Count','token':_0x4f109a(0x12c)},0x3:{'member':_0x4f109a(0xf5),'nonMember':_0x4f109a(0xcc),'token':_0x4f109a(0xd3)}},{member:_0x22d0e7,nonMember:_0x37974c,token:_0x3fbc9c}=_0x4e0fb1[_0x283a01];let _0x6a0702=_0xe89779,_0x503934=Math[_0x4f109a(0xde)](_0x33aa8b[_0x22d0e7]-_0x6a0702,0x0);_0x6a0702-=_0x33aa8b[_0x22d0e7]-_0x503934;let _0x39fb6a=_0x33aa8b[_0x37974c];_0x6a0702>0x0&&(_0x39fb6a=Math[_0x4f109a(0xde)](_0x33aa8b[_0x37974c]-_0x6a0702,0x0),_0x6a0702-=_0x33aa8b[_0x37974c]-_0x39fb6a);const _0x36c05e={[_0x22d0e7]:_0x503934,[_0x37974c]:_0x39fb6a,[_0x3fbc9c]:(_0x33aa8b[_0x3fbc9c]||0x0)+_0x1dc18c};(_0x3fbc9c===_0x4f109a(0xa6)||_0x3fbc9c==='useModel4Token')&&(_0x36c05e[_0x3fbc9c[_0x4f109a(0xaa)](_0x4f109a(0xc8),'Count')]=(_0x33aa8b[_0x3fbc9c[_0x4f109a(0xaa)](_0x4f109a(0xc8),'Count')]||0x0)+_0xe89779);const _0x49dcf7=await this[_0x4f109a(0xe0)][_0x4f109a(0xe2)]({'userId':_0xc157b5},_0x36c05e);if(_0x49dcf7[_0x4f109a(0x124)]===0x0)throw new common_1[(_0x4f109a(0xce))](_0x4f109a(0xc5),common_1[_0x4f109a(0xfe)]['BAD_REQUEST']);}async['queryUserBalance'](_0x1f544c){const _0x4f6617=_0x2bc73c;try{const _0x5e8fd8=await this[_0x4f6617(0xe0)][_0x4f6617(0x111)]({'where':{'userId':_0x1f544c},'select':[_0x4f6617(0x11d),_0x4f6617(0x114),'model4Count',_0x4f6617(0xcc),_0x4f6617(0x107),_0x4f6617(0x10c),_0x4f6617(0xf5),'useModel3Count',_0x4f6617(0xdc),_0x4f6617(0xa6),_0x4f6617(0x12c),_0x4f6617(0xd3),_0x4f6617(0x136)]});if(!_0x5e8fd8){const _0x72e03=await this[_0x4f6617(0x103)](_0x1f544c);if(_0x72e03)return await this[_0x4f6617(0xd7)](_0x1f544c);else throw new common_1[(_0x4f6617(0xce))](_0x4f6617(0xf2),common_1['HttpStatus'][_0x4f6617(0xb0)]);}return _0x5e8fd8[_0x4f6617(0xee)]=_0x5e8fd8['packageId']?_0x5e8fd8[_0x4f6617(0x114)]+_0x5e8fd8[_0x4f6617(0x107)]:_0x5e8fd8[_0x4f6617(0x114)],_0x5e8fd8[_0x4f6617(0x141)]=_0x5e8fd8[_0x4f6617(0x11d)]?_0x5e8fd8[_0x4f6617(0x13c)]+_0x5e8fd8[_0x4f6617(0x10c)]:_0x5e8fd8[_0x4f6617(0x13c)],_0x5e8fd8['sumDrawMjCount']=_0x5e8fd8['packageId']?_0x5e8fd8[_0x4f6617(0xcc)]+_0x5e8fd8[_0x4f6617(0xf5)]:_0x5e8fd8[_0x4f6617(0xcc)],_0x5e8fd8[_0x4f6617(0x136)]=_0x5e8fd8['expirationTime']?(0x0,date_1[_0x4f6617(0xf4)])(_0x5e8fd8[_0x4f6617(0x136)],_0x4f6617(0xfd)):null,_0x5e8fd8;}catch(_0x91f71e){console['log']('error:\x20',_0x91f71e);}}async['saveRecordRechargeLog'](_0x57160f){const _0x2cd364=_0x2bc73c,{userId:_0x32347b,rechargeType:_0xd5aba5,model3Count:_0x2d69fe,model4Count:_0x56b258,drawMjCount:_0x1fcd6d,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x57160f;if(!_0x32347b)throw new common_1[(_0x2cd364(0xce))]('当前用户不存在,记录充值日志异常',common_1[_0x2cd364(0xfe)][_0x2cd364(0xb0)]);const _0x55c03d=(0x0,utils_1[_0x2cd364(0x128)])();return await this[_0x2cd364(0x10e)]['save']({'userId':_0x32347b,'rechargeType':_0xd5aba5,'model3Count':_0x2d69fe,'model4Count':_0x56b258,'drawMjCount':_0x1fcd6d,'days':days,'extent':extent,'uid':_0x55c03d,'pkgName':pkgName});}async['createBaseUserBalance'](_0x1dafc1,_0x227d2f={}){const _0x3d9d66=_0x2bc73c,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x227d2f,_0x4955ee=await this[_0x3d9d66(0xe0)][_0x3d9d66(0x111)]({'where':{'userId':_0x1dafc1}});if(_0x4955ee)throw new common_1[(_0x3d9d66(0xce))](_0x3d9d66(0xeb),common_1[_0x3d9d66(0xfe)][_0x3d9d66(0xb0)]);return await this[_0x3d9d66(0xe0)][_0x3d9d66(0xd9)]({'userId':_0x1dafc1,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async[_0x2bc73c(0xe8)](_0x2404b6,_0x4d4f4c,_0x44933d=-0x1){const _0x3b5ba6=_0x2bc73c;try{const _0x5321cf=await this[_0x3b5ba6(0xe0)][_0x3b5ba6(0x111)]({'where':{'userId':_0x2404b6}})||await this[_0x3b5ba6(0x103)](_0x2404b6);if(!_0x5321cf)throw new common_1[(_0x3b5ba6(0xce))](_0x3b5ba6(0x11e),common_1[_0x3b5ba6(0xfe)][_0x3b5ba6(0xb0)]);const {model3Count:_0x2553fc,model4Count:_0x5d52d9,drawMjCount:_0x57389a,memberModel3Count:_0xcd8054,memberModel4Count:_0x2250ac,memberDrawMjCount:_0x32fe1e}=_0x5321cf;let _0x42848e={};if(_0x44933d>0x0){const {packageId:_0x150608}=_0x4d4f4c;if(!_0x150608)throw new common_1['HttpException'](_0x3b5ba6(0x121),common_1['HttpStatus'][_0x3b5ba6(0xb0)]);const _0x18ae33=await this[_0x3b5ba6(0xca)][_0x3b5ba6(0x111)]({'where':{'id':_0x150608}});if(!_0x18ae33)throw new common_1[(_0x3b5ba6(0xce))](_0x3b5ba6(0xb7),common_1[_0x3b5ba6(0xfe)][_0x3b5ba6(0xb0)]);const {weight:_0x4ec7e8}=_0x18ae33;if(!_0x5321cf[_0x3b5ba6(0x11d)])_0x42848e={'memberModel3Count':_0xcd8054+_0x4d4f4c[_0x3b5ba6(0x114)],'memberModel4Count':_0x2250ac+_0x4d4f4c[_0x3b5ba6(0x13c)],'memberDrawMjCount':_0x32fe1e+_0x4d4f4c['drawMjCount'],'expirationTime':(0x0,date_1[_0x3b5ba6(0xbe)])()[_0x3b5ba6(0x13f)](_0x44933d>0x0?_0x44933d:0x0,_0x3b5ba6(0xf8))[_0x3b5ba6(0xa9)](_0x3b5ba6(0xc0)),'packageId':_0x150608};else{const _0xf979f=await this[_0x3b5ba6(0xca)]['findOne']({'where':{'id':_0x5321cf[_0x3b5ba6(0x11d)]}});_0x4ec7e8>=_0xf979f[_0x3b5ba6(0xe7)]&&(_0x42848e={'memberModel3Count':_0xcd8054+_0x4d4f4c['model3Count'],'memberModel4Count':_0x2250ac+_0x4d4f4c['model4Count'],'memberDrawMjCount':_0x32fe1e+_0x4d4f4c[_0x3b5ba6(0xcc)],'expirationTime':(0x0,date_1[_0x3b5ba6(0xbe)])(_0x5321cf[_0x3b5ba6(0x136)])[_0x3b5ba6(0x13f)](_0x44933d>0x0?_0x44933d:0x0,_0x3b5ba6(0xf8))[_0x3b5ba6(0xa9)]('YYYY-MM-DD\x20HH:mm:ss'),'packageId':_0x150608}),_0x4ec7e8<_0xf979f[_0x3b5ba6(0xe7)]&&(_0x42848e={'memberModel3Count':_0xcd8054+_0x4d4f4c[_0x3b5ba6(0x114)],'memberModel4Count':_0x2250ac+_0x4d4f4c[_0x3b5ba6(0x13c)],'memberDrawMjCount':_0x32fe1e+_0x4d4f4c[_0x3b5ba6(0xcc)]});}}_0x44933d<=0x0&&(_0x42848e={'model3Count':_0x2553fc+_0x4d4f4c[_0x3b5ba6(0x114)],'model4Count':_0x5d52d9+_0x4d4f4c[_0x3b5ba6(0x13c)],'drawMjCount':_0x57389a+_0x4d4f4c[_0x3b5ba6(0xcc)]});const _0x5ed9a7=await this[_0x3b5ba6(0xe0)]['update']({'userId':_0x2404b6},_0x42848e);if(_0x5ed9a7[_0x3b5ba6(0x124)]===0x0)throw new common_1[(_0x3b5ba6(0xce))](_0x2404b6+_0x3b5ba6(0x104),common_1['HttpStatus'][_0x3b5ba6(0xb0)]);}catch(_0x324c4c){console[_0x3b5ba6(0xb2)](_0x3b5ba6(0x134),_0x324c4c);throw new common_1[(_0x3b5ba6(0xce))](_0x3b5ba6(0xfa),common_1[_0x3b5ba6(0xfe)]['BAD_REQUEST']);}}async[_0x2bc73c(0xd8)](_0x526888){const _0x44a70f=_0x2bc73c;console['log']('充值的工单信息:',_0x526888);try{const {userId:_0x1ea0ee,goodsId:_0x3fd146}=_0x526888,_0x50575f=await this['cramiPackageEntity']['findOne']({'where':{'id':_0x526888[_0x44a70f(0xdd)],'status':0x1}});if(!_0x50575f)throw new common_1['HttpException'](_0x44a70f(0x12d),common_1[_0x44a70f(0xfe)][_0x44a70f(0xb0)]);const {model3Count:_0x2a0f58,model4Count:_0x1dcdcc,drawMjCount:_0x314ebc,days:_0x5892dd,name:_0x76fa39}=_0x50575f,_0x1d8c8a={'model3Count':_0x2a0f58,'model4Count':_0x1dcdcc,'drawMjCount':_0x314ebc,'days':_0x5892dd,'packageId':_0x526888['goodsId']};await this['addBalanceToUser'](_0x1ea0ee,_0x1d8c8a,_0x5892dd),await this['saveRecordRechargeLog']({'userId':_0x1ea0ee,'rechargeType':balance_constant_1[_0x44a70f(0x135)][_0x44a70f(0x10a)],'model3Count':_0x2a0f58,'model4Count':_0x1dcdcc,'drawMjCount':_0x314ebc,'pkgName':_0x76fa39,'days':_0x5892dd});}catch(_0x189102){console[_0x44a70f(0xb2)]('error:\x20',_0x189102);throw new common_1['HttpException']('充值失败！',common_1[_0x44a70f(0xfe)][_0x44a70f(0xb0)]);}}async[_0x2bc73c(0xaf)](_0x351542,_0x5a56a7){const _0x3137fc=_0x2bc73c,{page:page=0x1,size:size=0x14}=_0x5a56a7,{id:_0x5a2777}=_0x351542[_0x3137fc(0x12e)],[_0x24ac42,_0x8d8043]=await this['accountLogEntity']['findAndCount']({'where':{'userId':_0x5a2777},'order':{'id':_0x3137fc(0xa5)},'skip':(page-0x1)*size,'take':size});return _0x24ac42[_0x3137fc(0xe1)](_0x644cf=>{const _0x3dab07=_0x3137fc;_0x644cf[_0x3dab07(0xad)]=_0x644cf[_0x3dab07(0x123)]>0x0?_0x644cf[_0x3dab07(0x123)]+'天':'永久';}),{'rows':(0x0,date_1[_0x3137fc(0x13b)])(_0x24ac42),'count':_0x8d8043};}async[_0x2bc73c(0xcb)](_0x1f9d61,_0x3e3e2d){const _0x1d99ad=_0x2bc73c;try{const {page:page=0x1,size:size=0xa,userId:_0x18420a,rechargeType:_0x1eed11,packageId:_0x370f84}=_0x3e3e2d,{role:_0x1e5aaf}=_0x1f9d61['user'],_0x122fd6={};_0x1eed11&&(_0x122fd6['rechargeType']=_0x1eed11),_0x122fd6[_0x1d99ad(0xf3)]=_0x18420a||(0x0,typeorm_2[_0x1d99ad(0xbb)])(0x186a0),_0x370f84&&(_0x122fd6[_0x1d99ad(0x11d)]={'$like':'%'+_0x370f84+'%'});const [_0x9babde,_0x4d7673]=await this[_0x1d99ad(0x10e)]['findAndCount']({'where':_0x122fd6,'order':{'id':_0x1d99ad(0xa5)},'skip':(page-0x1)*size,'take':size}),_0x77f8ad=_0x9babde['map'](_0x163d2a=>_0x163d2a['userId']),_0x3adeef=await this['userEntity'][_0x1d99ad(0x117)]({'where':{'id':(0x0,typeorm_2['In'])(_0x77f8ad)}});return _0x9babde['forEach'](_0x5e8045=>{const _0x2c30bf=_0x1d99ad,_0x2eda6e=_0x3adeef[_0x2c30bf(0x117)](_0x1af6b4=>_0x1af6b4['id']===_0x5e8045[_0x2c30bf(0xf3)]);_0x5e8045[_0x2c30bf(0xae)]=_0x2eda6e===null||_0x2eda6e===void 0x0?void 0x0:_0x2eda6e['username'],_0x5e8045['email']=_0x2eda6e===null||_0x2eda6e===void 0x0?void 0x0:_0x2eda6e['email'],_0x5e8045['phone']=_0x2eda6e===null||_0x2eda6e===void 0x0?void 0x0:_0x2eda6e[_0x2c30bf(0x12b)],_0x5e8045[_0x2c30bf(0xdf)]=_0x2eda6e===null||_0x2eda6e===void 0x0?void 0x0:_0x2eda6e['status'],_0x5e8045[_0x2c30bf(0xd4)]=_0x2eda6e===null||_0x2eda6e===void 0x0?void 0x0:_0x2eda6e[_0x2c30bf(0xd4)];}),_0x1e5aaf!=='super'&&_0x9babde['forEach'](_0xc4e2aa=>{const _0xe684ab=_0x1d99ad;_0xc4e2aa[_0xe684ab(0x13d)]=_0xc4e2aa[_0xe684ab(0x13d)]?(0x0,utils_1['hideString'])(_0xc4e2aa['email']):'',_0xc4e2aa[_0xe684ab(0x12b)]=_0xc4e2aa[_0xe684ab(0x12b)]?(0x0,utils_1[_0xe684ab(0xdb)])(_0xc4e2aa[_0xe684ab(0x12b)]):'';}),{'rows':_0x9babde,'count':_0x4d7673};}catch(_0x2acb83){console[_0x1d99ad(0xb2)]('error:\x20',_0x2acb83);throw new common_1['HttpException'](_0x1d99ad(0xf7),common_1[_0x1d99ad(0xfe)][_0x1d99ad(0xb0)]);}}async[_0x2bc73c(0xa8)](_0x23ceea){const _0x312d5d=_0x2bc73c;return await this[_0x312d5d(0xe0)][_0x312d5d(0x117)]({'where':{'userId':(0x0,typeorm_2['In'])(_0x23ceea)}});}async['refundMjBalance'](_0x376ffb,_0x1bcfb3){const _0xd8b679=_0x2bc73c;return await this[_0xd8b679(0xb9)](_0x376ffb,'mjDraw',-_0x1bcfb3);}async['inheritVisitorData'](_0x2892df){const _0x24f670=_0x2bc73c,{fingerprint:_0xe82d23}=_0x2892df[_0x24f670(0xbf)],{id:_0x2db298}=_0x2892df[_0x24f670(0x12e)];return await this[_0x24f670(0x143)]['update']({'userId':Number(_0xe82d23)},{'userId':_0x2db298}),await this[_0x24f670(0x132)][_0x24f670(0xe2)]({'userId':Number(_0xe82d23)},{'userId':_0x2db298}),0x1;}async[_0x2bc73c(0x102)](_0x17d69d){const _0x31c8ba=_0x2bc73c,{fingerprint:_0x516475}=_0x17d69d['headers'],_0x570a88=await this[_0x31c8ba(0x143)][_0x31c8ba(0xc4)]({'where':{'userId':_0x516475}}),_0x57a820=await this[_0x31c8ba(0x132)]['count']({'where':{'userId':_0x516475}});return _0x570a88||_0x57a820||0x0;}async[_0x2bc73c(0xd0)](_0x2bd3c8){const _0x429705=_0x2bc73c,_0x2f2f9d=await this[_0x429705(0x116)]['findOne']({'where':{'id':_0x2bd3c8}}),_0x531188=await this[_0x429705(0xe0)]['findOne']({'where':{'userId':_0x2bd3c8}});if(!_0x2f2f9d||!_0x531188)return;const {phoneValidationMessageCount:_0x19eea3,identityVerificationMessageCount:_0x11664d,openIdentity:_0x45c779,openPhoneValidation:_0x2344a3}=await this['globalConfigService'][_0x429705(0x13a)](['phoneValidationMessageCount',_0x429705(0xd2),_0x429705(0x130),_0x429705(0xd5)]),_0x28c082=Number(_0x19eea3),_0x25e982=Number(_0x11664d),_0x49dfc8=Number(_0x531188[_0x429705(0xf1)])||0x0,_0x5c7e77=Number(_0x531188[_0x429705(0xdc)])||0x0,_0x3f8a22=_0x49dfc8+_0x5c7e77;if(_0x2344a3==='1'&&_0x3f8a22>=_0x28c082&&!_0x2f2f9d[_0x429705(0x12b)])throw new common_1['HttpException'](_0x429705(0xb6),common_1['HttpStatus'][_0x429705(0xb0)]);if(_0x45c779==='1'&&_0x3f8a22>=_0x25e982&&(!_0x2f2f9d[_0x429705(0x127)]||!_0x2f2f9d['idCard']))throw new common_1[(_0x429705(0xce))](_0x429705(0x142),common_1[_0x429705(0xfe)][_0x429705(0xb0)]);}};UserBalanceService=__decorate([(0x0,common_1[_0x2bc73c(0xcf)])(),__param(0x0,(0x0,typeorm_1[_0x2bc73c(0xf6)])(balance_entity_1[_0x2bc73c(0xea)])),__param(0x1,(0x0,typeorm_1[_0x2bc73c(0xf6)])(userBalance_entity_1[_0x2bc73c(0xa4)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(accountLog_entity_1[_0x2bc73c(0x10d)])),__param(0x3,(0x0,typeorm_1[_0x2bc73c(0xf6)])(cramiPackage_entity_1[_0x2bc73c(0xac)])),__param(0x4,(0x0,typeorm_1[_0x2bc73c(0xf6)])(config_entity_1[_0x2bc73c(0xd1)])),__param(0x5,(0x0,typeorm_1[_0x2bc73c(0xf6)])(user_entity_1[_0x2bc73c(0xff)])),__param(0x6,(0x0,typeorm_1['InjectRepository'])(fingerprint_entity_1[_0x2bc73c(0xe6)])),__param(0x7,(0x0,typeorm_1[_0x2bc73c(0xf6)])(chatGroup_entity_1[_0x2bc73c(0x11f)])),__param(0x8,(0x0,typeorm_1[_0x2bc73c(0xf6)])(chatLog_entity_1[_0x2bc73c(0xc9)])),__metadata('design:paramtypes',[typeorm_2['Repository'],typeorm_2[_0x2bc73c(0x108)],typeorm_2[_0x2bc73c(0x108)],typeorm_2[_0x2bc73c(0x108)],typeorm_2['Repository'],typeorm_2[_0x2bc73c(0x108)],typeorm_2[_0x2bc73c(0x108)],typeorm_2[_0x2bc73c(0x108)],typeorm_2[_0x2bc73c(0x108)],globalConfig_service_1[_0x2bc73c(0xf0)]])],UserBalanceService),exports['UserBalanceService']=UserBalanceService;