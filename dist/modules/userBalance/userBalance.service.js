'use strict';const _0x108620=_0x549c;function _0x5434(){const _0x4949bc=['design:paramtypes','visitorModel3Num','firstRegisterSendStatus','userId','ConfigEntity','user','12clgTsC','HttpException','registerSendStatus','useModel3Count','registerSendModel4Count','../user/user.entity','908299qnjFxu','map','days','sumModel3Count','model3Count','configEntity','./fingerprint.entity','./accountLog.entity','useModel3Token','addBalanceToUser','typeorm','请完成手机号绑定','update','./userBalance.entity','drawMjCount','__esModule','error:\x20','__decorate','Count','RechargeType','hideString','FingerprintLogEntity','6175568HJuNzx','getMonth','../chatLog/chatLog.entity','findOne','add','firstRregisterSendModel3Count','save','status','registerSendDrawMjCount','expirationTime','1056984zrnZFt','reduce','1696698zGnYpI','visitorModel4Num','firstRregisterSendModel4Count','@nestjs/common','../globalConfig/config.entity','createBaseUserBalance','缺失当前套餐ID、充值失败！','当前用户不存在,记录充值日志异常','../../common/utils','@nestjs/typeorm','queryUserBalance','BAD_REQUEST','当前套餐不存在！','firstRregisterSendDrawMjCount','formatDate','rechargeType','validateVisitorBalance','identityVerificationMessageCount','headers','useDrawMjToken','model4Count','isUpdatedToday','email','memberDrawMjCount','./balance.entity','mjDraw','visitor','configVal','packageId','configKey','metadata','../../common/utils/date','../../common/constants/balance.constant','super','memberModel3Count','globalConfigService','SCAN_PAY','decorate','userBalanceEntity','GlobalConfigService','积分不足，继续体验服务，请按需选购套餐！','UserBalanceService','queryUserBalanceByIds','ChatGroupEntity','BalanceEntity','今日体验额度使用完毕，请注册使用完整服务！','defineProperty','function','Repository','default','log','useModel4Count','2168324dRjXfY','count','saveRecordRechargeLog','expireDateCn','chatLogEntity','用户充值失败！','format','forEach','phone','Token','replace','getConfigs','getRechargeLog','useModel4Token','addBalanceToNewUser','InjectRepository','userEntity','../crami/cramiPackage.entity','YYYY-MM-DD','length','DESC','3450365OulVTH','ChatLogEntity','openIdentity','缺失当前用户账户记录！','object','HttpStatus','LessThan','registerSendModel3Count','UserBalanceEntity','cramiPackageEntity','max','AccountLogEntity','accountLogEntity','查询用户账户失败！','formatCreateOrUpdateDate','createRandomUid','balanceEntity','weight','chatGroupEntity','充值失败！','firstRegisterSendRank','fingerprintLogEntity','getOwnPropertyDescriptor','27694593MiLhmq','Injectable','affected','updatedAt','addBalanceToOrder','2VmpoQk','getFullYear','find','请完成实名认证','充值失败','YYYY-MM-DD\x20HH:mm:ss','__param','inheritVisitorData','查询用户账户信息失败！','PAYMENT_REQUIRED','memberModel4Count','checkUserCertification','isInteger','goodsId','./../globalConfig/globalConfig.service','realName'];_0x5434=function(){return _0x4949bc;};return _0x5434();}(function(_0x4275df,_0x538975){const _0x328e24=_0x549c,_0x39fd7b=_0x4275df();while(!![]){try{const _0x15b04c=-parseInt(_0x328e24(0x162))/0x1+-parseInt(_0x328e24(0x1c9))/0x2*(parseInt(_0x328e24(0x164))/0x3)+-parseInt(_0x328e24(0x198))/0x4+-parseInt(_0x328e24(0x1ad))/0x5+-parseInt(_0x328e24(0x13c))/0x6*(parseInt(_0x328e24(0x142))/0x7)+parseInt(_0x328e24(0x158))/0x8+parseInt(_0x328e24(0x1c4))/0x9;if(_0x15b04c===_0x538975)break;else _0x39fd7b['push'](_0x39fd7b['shift']());}catch(_0x822af){_0x39fd7b['push'](_0x39fd7b['shift']());}}}(_0x5434,0xb36b9));var __decorate=this&&this[_0x108620(0x153)]||function(_0x23208d,_0x55c79b,_0x2e9b05,_0x42c813){const _0x1041a5=_0x108620;var _0x627c62=arguments[_0x1041a5(0x1ab)],_0x655129=_0x627c62<0x3?_0x55c79b:_0x42c813===null?_0x42c813=Object[_0x1041a5(0x1c3)](_0x55c79b,_0x2e9b05):_0x42c813,_0x175ace;if(typeof Reflect==='object'&&typeof Reflect[_0x1041a5(0x189)]===_0x1041a5(0x193))_0x655129=Reflect[_0x1041a5(0x189)](_0x23208d,_0x55c79b,_0x2e9b05,_0x42c813);else{for(var _0x38660f=_0x23208d[_0x1041a5(0x1ab)]-0x1;_0x38660f>=0x0;_0x38660f--)if(_0x175ace=_0x23208d[_0x38660f])_0x655129=(_0x627c62<0x3?_0x175ace(_0x655129):_0x627c62>0x3?_0x175ace(_0x55c79b,_0x2e9b05,_0x655129):_0x175ace(_0x55c79b,_0x2e9b05))||_0x655129;}return _0x627c62>0x3&&_0x655129&&Object[_0x1041a5(0x192)](_0x55c79b,_0x2e9b05,_0x655129),_0x655129;},__metadata=this&&this['__metadata']||function(_0x37ac80,_0x1bfa58){const _0xb60323=_0x108620;if(typeof Reflect===_0xb60323(0x1b1)&&typeof Reflect[_0xb60323(0x182)]==='function')return Reflect[_0xb60323(0x182)](_0x37ac80,_0x1bfa58);},__param=this&&this[_0x108620(0x12c)]||function(_0x3fc668,_0x83b7bb){return function(_0x226167,_0x1b8e25){_0x83b7bb(_0x226167,_0x1b8e25,_0x3fc668);};};Object[_0x108620(0x192)](exports,_0x108620(0x151),{'value':!![]}),exports[_0x108620(0x18d)]=void 0x0;function _0x549c(_0x22fcf2,_0x7e0333){const _0x5434ed=_0x5434();return _0x549c=function(_0x549c32,_0x1104e7){_0x549c32=_0x549c32-0x12a;let _0x41f841=_0x5434ed[_0x549c32];return _0x41f841;},_0x549c(_0x22fcf2,_0x7e0333);}const balance_constant_1=require(_0x108620(0x184)),utils_1=require(_0x108620(0x16c)),common_1=require(_0x108620(0x167)),typeorm_1=require(_0x108620(0x16d)),typeorm_2=require(_0x108620(0x14c)),cramiPackage_entity_1=require(_0x108620(0x1a9)),config_entity_1=require(_0x108620(0x168)),globalConfig_service_1=require(_0x108620(0x134)),accountLog_entity_1=require(_0x108620(0x149)),balance_entity_1=require(_0x108620(0x17c)),userBalance_entity_1=require(_0x108620(0x14f)),date_1=require(_0x108620(0x183)),chatGroup_entity_1=require('../chatGroup/chatGroup.entity'),chatLog_entity_1=require(_0x108620(0x15a)),user_entity_1=require(_0x108620(0x141)),fingerprint_entity_1=require(_0x108620(0x148));let UserBalanceService=class UserBalanceService{constructor(_0x528b0b,_0x3a2f3e,_0x430212,_0x3ae7ad,_0x1433ac,_0x4ce215,_0x38c0ed,_0x44576e,_0x1ffef5,_0x567fe4){const _0x66c3af=_0x108620;this[_0x66c3af(0x1bd)]=_0x528b0b,this[_0x66c3af(0x18a)]=_0x3a2f3e,this[_0x66c3af(0x1b9)]=_0x430212,this['cramiPackageEntity']=_0x3ae7ad,this[_0x66c3af(0x147)]=_0x1433ac,this[_0x66c3af(0x1a8)]=_0x4ce215,this['fingerprintLogEntity']=_0x38c0ed,this[_0x66c3af(0x1bf)]=_0x44576e,this[_0x66c3af(0x19c)]=_0x1ffef5,this[_0x66c3af(0x187)]=_0x567fe4;}async[_0x108620(0x1a6)](_0x1b97f0){const _0x2d221c=_0x108620;try{const _0x2c46ac=await this[_0x2d221c(0x147)][_0x2d221c(0x1cb)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x2d221c(0x13e),_0x2d221c(0x1b4),_0x2d221c(0x140),'registerSendDrawMjCount',_0x2d221c(0x138),_0x2d221c(0x1c1),'firstRregisterSendModel3Count',_0x2d221c(0x166),_0x2d221c(0x171)])}}),_0x2ea803=_0x2c46ac[_0x2d221c(0x163)]((_0xd546ae,_0x3315e1)=>{const _0x1238a4=_0x2d221c,_0x2cf16d=Number(_0x3315e1[_0x1238a4(0x17f)]),_0x382ae7=Number[_0x1238a4(0x132)](_0x2cf16d)&&_0x2cf16d>0x0?_0x2cf16d:0x0;return _0xd546ae[_0x3315e1[_0x1238a4(0x181)]]=_0x382ae7,_0xd546ae;},{});let _0x88a20c=0x0,_0x38dd40=0x0,_0x3b30ac=0x0;_0x2ea803[_0x2d221c(0x13e)]===0x1&&(_0x88a20c=_0x88a20c+_0x2ea803[_0x2d221c(0x1b4)],_0x38dd40=_0x38dd40+_0x2ea803['registerSendModel4Count'],_0x3b30ac=_0x3b30ac+_0x2ea803[_0x2d221c(0x160)]),_0x2ea803[_0x2d221c(0x13e)]===0x1&&_0x2ea803[_0x2d221c(0x138)]===0x1&&_0x1b97f0<=_0x2ea803['firstRegisterSendRank']&&(_0x88a20c=_0x88a20c+_0x2ea803[_0x2d221c(0x15d)],_0x38dd40=_0x38dd40+_0x2ea803[_0x2d221c(0x166)],_0x3b30ac=_0x3b30ac+_0x2ea803[_0x2d221c(0x171)]),await this['saveRecordRechargeLog']({'userId':_0x1b97f0,'rechargeType':balance_constant_1[_0x2d221c(0x155)]['REG_GIFT'],'model3Count':_0x88a20c,'drawMjCount':_0x3b30ac,'model4Count':_0x38dd40}),await this[_0x2d221c(0x18a)][_0x2d221c(0x15e)]({'userId':_0x1b97f0,'model3Count':_0x88a20c,'model4Count':_0x38dd40,'drawMjCount':_0x3b30ac,'useTokens':0x0});}catch(_0x29f436){console[_0x2d221c(0x196)](_0x2d221c(0x152),_0x29f436);throw new common_1[(_0x2d221c(0x13d))]('注册赠送失败,请联系管理员！',common_1['HttpStatus'][_0x2d221c(0x16f)]);}}async['validateBalance'](_0xb6d3eb,_0x17d97b,_0x4127b7){const _0x467d8e=_0x108620,{id:_0x394819,role:_0xb069b4}=_0xb6d3eb['user'];let _0x3ed0f1=await this['userBalanceEntity']['findOne']({'where':{'userId':_0x394819}});!_0x3ed0f1&&(_0x3ed0f1=await this['createBaseUserBalance'](_0x394819));if(_0xb069b4===_0x467d8e(0x17e))return this[_0x467d8e(0x174)](_0xb6d3eb,_0x17d97b,_0x4127b7);const _0x4529f7=_0x17d97b===0x1?_0x467d8e(0x186):_0x17d97b===0x2?_0x467d8e(0x130):_0x17d97b===0x3?_0x467d8e(0x17b):null,_0x45a8f0=_0x17d97b===0x1?_0x467d8e(0x146):_0x17d97b===0x2?_0x467d8e(0x178):_0x17d97b===0x3?_0x467d8e(0x150):null;if(_0x3ed0f1['packageId']&&_0x3ed0f1[_0x4529f7]+_0x3ed0f1[_0x45a8f0]<_0x4127b7){if(_0x3ed0f1[_0x45a8f0]<_0x4127b7)throw new common_1[(_0x467d8e(0x13d))](_0x467d8e(0x18c),common_1[_0x467d8e(0x1b2)][_0x467d8e(0x12f)]);}if(!_0x3ed0f1[_0x467d8e(0x180)]&&_0x3ed0f1[_0x45a8f0]<_0x4127b7)throw new common_1[(_0x467d8e(0x13d))](_0x467d8e(0x18c),common_1[_0x467d8e(0x1b2)]['PAYMENT_REQUIRED']);return _0x3ed0f1;}async[_0x108620(0x174)](_0x3bceaf,_0x39320b,_0x3e060d){const _0x33980a=_0x108620,{id:_0x14d163}=_0x3bceaf['user'],_0x2226f5=_0x39320b===0x1?_0x33980a(0x146):_0x39320b===0x2?'model4Count':_0x39320b===0x3?'drawMjCount':null,_0x28eab4=new Date(),_0x1a4f8f=await this['fingerprintLogEntity']['findOne']({'where':{'fingerprint':_0x14d163}}),{visitorModel3Num:_0x2ef8e3,visitorModel4Num:_0x532a77,visitorMJNum:_0x145f71}=await this[_0x33980a(0x187)][_0x33980a(0x1a3)]([_0x33980a(0x137),_0x33980a(0x165),'visitorMJNum']),_0x3c3b4b={'model3Count':_0x2ef8e3?Number(_0x2ef8e3):0x0,'model4Count':_0x532a77?Number(_0x532a77):0x0,'drawMjCount':_0x145f71?Number(_0x145f71):0x0};if(!_0x1a4f8f){let _0x55631f={'fingerprint':_0x14d163,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0};_0x55631f[_0x2226f5]=_0x55631f[_0x2226f5]+_0x3e060d;if(_0x55631f[_0x2226f5]>_0x3c3b4b[_0x2226f5])throw new common_1[(_0x33980a(0x13d))](_0x33980a(0x191),common_1[_0x33980a(0x1b2)][_0x33980a(0x12f)]);else return await this[_0x33980a(0x1c2)][_0x33980a(0x15e)](_0x55631f),!![];}else{const {model3Count:_0x2ceccc,model4Count:_0x109e15,drawMjCount:_0x2e5926}=_0x1a4f8f;let _0x53321e={'model3Count':_0x2ceccc,'model4Count':_0x109e15,'drawMjCount':_0x2e5926};const _0x5f0d4f=Number(new Date(_0x1a4f8f[_0x33980a(0x1c7)])),_0x252033=this['isUpdatedToday'](_0x5f0d4f);_0x252033?_0x53321e[_0x2226f5]=_0x53321e[_0x2226f5]+_0x3e060d:(_0x53321e={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x53321e[_0x2226f5]=_0x53321e[_0x2226f5]+_0x3e060d);if(_0x53321e[_0x2226f5]>_0x3c3b4b[_0x2226f5])throw new common_1[(_0x33980a(0x13d))](_0x33980a(0x191),common_1['HttpStatus'][_0x33980a(0x12f)]);else return await this[_0x33980a(0x1c2)]['update']({'fingerprint':_0x14d163},_0x53321e),!![];}}[_0x108620(0x179)](_0x287794){const _0x113691=_0x108620,_0x42ac82=new Date(),_0x120df6=new Date(_0x42ac82[_0x113691(0x1ca)](),_0x42ac82[_0x113691(0x159)](),_0x42ac82['getDate']());return _0x287794>=_0x120df6;}async['deductFromBalance'](_0x2b0155,_0x17b304,_0x250225,_0x1af9fe=0x0){const _0x566603=_0x108620,_0x4f8509=await this[_0x566603(0x18a)][_0x566603(0x15b)]({'where':{'userId':_0x2b0155}});if(!_0x4f8509)throw new common_1['HttpException'](_0x566603(0x1b0),common_1[_0x566603(0x1b2)]['BAD_REQUEST']);const _0x33d101={0x1:{'member':_0x566603(0x186),'nonMember':_0x566603(0x146),'token':'useModel3Token'},0x2:{'member':_0x566603(0x130),'nonMember':_0x566603(0x178),'token':_0x566603(0x1a5)},0x3:{'member':'memberDrawMjCount','nonMember':_0x566603(0x150),'token':'useDrawMjToken'}},{member:_0x44a0d1,nonMember:_0x5ec4e2,token:_0x2ea5a6}=_0x33d101[_0x17b304];let _0x4888b2=_0x250225,_0x42b3b6=Math[_0x566603(0x1b7)](_0x4f8509[_0x44a0d1]-_0x4888b2,0x0);_0x4888b2-=_0x4f8509[_0x44a0d1]-_0x42b3b6;let _0x369f9c=_0x4f8509[_0x5ec4e2];_0x4888b2>0x0&&(_0x369f9c=Math[_0x566603(0x1b7)](_0x4f8509[_0x5ec4e2]-_0x4888b2,0x0),_0x4888b2-=_0x4f8509[_0x5ec4e2]-_0x369f9c);const _0x2400b3={[_0x44a0d1]:_0x42b3b6,[_0x5ec4e2]:_0x369f9c,[_0x2ea5a6]:(_0x4f8509[_0x2ea5a6]||0x0)+_0x1af9fe};(_0x2ea5a6===_0x566603(0x14a)||_0x2ea5a6===_0x566603(0x1a5))&&(_0x2400b3[_0x2ea5a6[_0x566603(0x1a2)](_0x566603(0x1a1),_0x566603(0x154))]=(_0x4f8509[_0x2ea5a6[_0x566603(0x1a2)](_0x566603(0x1a1),'Count')]||0x0)+_0x250225);const _0x52887f=await this['userBalanceEntity'][_0x566603(0x14e)]({'userId':_0x2b0155},_0x2400b3);if(_0x52887f['affected']===0x0)throw new common_1['HttpException']('消费余额失败！',common_1[_0x566603(0x1b2)][_0x566603(0x16f)]);}async[_0x108620(0x16e)](_0x4d0a32){const _0x285aa1=_0x108620;try{const _0x4adaf6=await this[_0x285aa1(0x18a)][_0x285aa1(0x15b)]({'where':{'userId':_0x4d0a32},'select':[_0x285aa1(0x180),_0x285aa1(0x146),_0x285aa1(0x178),_0x285aa1(0x150),_0x285aa1(0x186),'memberModel4Count',_0x285aa1(0x17b),_0x285aa1(0x13f),_0x285aa1(0x197),'useModel3Token',_0x285aa1(0x1a5),_0x285aa1(0x177),_0x285aa1(0x161)]});if(!_0x4adaf6){const _0x4b4e23=await this['createBaseUserBalance'](_0x4d0a32);if(_0x4b4e23)return await this[_0x285aa1(0x16e)](_0x4d0a32);else throw new common_1['HttpException']('查询当前用户余额失败！',common_1[_0x285aa1(0x1b2)]['BAD_REQUEST']);}return _0x4adaf6[_0x285aa1(0x145)]=_0x4adaf6[_0x285aa1(0x180)]?_0x4adaf6['model3Count']+_0x4adaf6['memberModel3Count']:_0x4adaf6[_0x285aa1(0x146)],_0x4adaf6['sumModel4Count']=_0x4adaf6['packageId']?_0x4adaf6['model4Count']+_0x4adaf6['memberModel4Count']:_0x4adaf6['model4Count'],_0x4adaf6['sumDrawMjCount']=_0x4adaf6[_0x285aa1(0x180)]?_0x4adaf6[_0x285aa1(0x150)]+_0x4adaf6[_0x285aa1(0x17b)]:_0x4adaf6[_0x285aa1(0x150)],_0x4adaf6[_0x285aa1(0x161)]=_0x4adaf6[_0x285aa1(0x161)]?(0x0,date_1[_0x285aa1(0x172)])(_0x4adaf6[_0x285aa1(0x161)],_0x285aa1(0x1aa)):null,_0x4adaf6;}catch(_0x30a2f7){console[_0x285aa1(0x196)](_0x285aa1(0x152),_0x30a2f7);}}async['saveRecordRechargeLog'](_0x325015){const _0x3a7cba=_0x108620,{userId:_0x19ff2c,rechargeType:_0x48bb91,model3Count:_0x329fef,model4Count:_0x280de1,drawMjCount:_0x44a713,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x325015;if(!_0x19ff2c)throw new common_1[(_0x3a7cba(0x13d))](_0x3a7cba(0x16b),common_1[_0x3a7cba(0x1b2)]['BAD_REQUEST']);const _0x479f23=(0x0,utils_1[_0x3a7cba(0x1bc)])();return await this['accountLogEntity'][_0x3a7cba(0x15e)]({'userId':_0x19ff2c,'rechargeType':_0x48bb91,'model3Count':_0x329fef,'model4Count':_0x280de1,'drawMjCount':_0x44a713,'days':days,'extent':extent,'uid':_0x479f23,'pkgName':pkgName});}async[_0x108620(0x169)](_0x2520af,_0x1721d2={}){const _0x103d4f=_0x108620,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x1721d2,_0x16160f=await this[_0x103d4f(0x18a)][_0x103d4f(0x15b)]({'where':{'userId':_0x2520af}});if(_0x16160f)throw new common_1[(_0x103d4f(0x13d))]('当前用户无需创建账户信息！',common_1[_0x103d4f(0x1b2)]['BAD_REQUEST']);return await this[_0x103d4f(0x18a)][_0x103d4f(0x15e)]({'userId':_0x2520af,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async[_0x108620(0x14b)](_0x232bd2,_0x2a6658,_0x6346c5=-0x1){const _0x51fb64=_0x108620;try{const _0x25e477=await this[_0x51fb64(0x18a)][_0x51fb64(0x15b)]({'where':{'userId':_0x232bd2}})||await this[_0x51fb64(0x169)](_0x232bd2);if(!_0x25e477)throw new common_1[(_0x51fb64(0x13d))](_0x51fb64(0x12e),common_1[_0x51fb64(0x1b2)][_0x51fb64(0x16f)]);const {model3Count:_0x1337fc,model4Count:_0x4894a3,drawMjCount:_0x1fb231,memberModel3Count:_0x2174d9,memberModel4Count:_0x161aeb,memberDrawMjCount:_0x4d525c}=_0x25e477;let _0x5898c4={};if(_0x6346c5>0x0){const {packageId:_0x5a9567}=_0x2a6658;if(!_0x5a9567)throw new common_1['HttpException'](_0x51fb64(0x16a),common_1['HttpStatus'][_0x51fb64(0x16f)]);const _0x9f51af=await this[_0x51fb64(0x1b6)][_0x51fb64(0x15b)]({'where':{'id':_0x5a9567}});if(!_0x9f51af)throw new common_1[(_0x51fb64(0x13d))](_0x51fb64(0x170),common_1[_0x51fb64(0x1b2)][_0x51fb64(0x16f)]);const {weight:_0x4202ab}=_0x9f51af;if(!_0x25e477[_0x51fb64(0x180)])_0x5898c4={'memberModel3Count':_0x2174d9+_0x2a6658['model3Count'],'memberModel4Count':_0x161aeb+_0x2a6658[_0x51fb64(0x178)],'memberDrawMjCount':_0x4d525c+_0x2a6658['drawMjCount'],'expirationTime':(0x0,date_1['default'])()[_0x51fb64(0x15c)](_0x6346c5>0x0?_0x6346c5:0x0,'day')[_0x51fb64(0x19e)](_0x51fb64(0x12b)),'packageId':_0x5a9567};else{const _0x5dcc7d=await this[_0x51fb64(0x1b6)][_0x51fb64(0x15b)]({'where':{'id':_0x25e477[_0x51fb64(0x180)]}});_0x4202ab>=_0x5dcc7d['weight']&&(_0x5898c4={'memberModel3Count':_0x2174d9+_0x2a6658[_0x51fb64(0x146)],'memberModel4Count':_0x161aeb+_0x2a6658['model4Count'],'memberDrawMjCount':_0x4d525c+_0x2a6658[_0x51fb64(0x150)],'expirationTime':(0x0,date_1[_0x51fb64(0x195)])(_0x25e477[_0x51fb64(0x161)])[_0x51fb64(0x15c)](_0x6346c5>0x0?_0x6346c5:0x0,'day')['format'](_0x51fb64(0x12b)),'packageId':_0x5a9567}),_0x4202ab<_0x5dcc7d[_0x51fb64(0x1be)]&&(_0x5898c4={'memberModel3Count':_0x2174d9+_0x2a6658['model3Count'],'memberModel4Count':_0x161aeb+_0x2a6658[_0x51fb64(0x178)],'memberDrawMjCount':_0x4d525c+_0x2a6658[_0x51fb64(0x150)]});}}_0x6346c5<=0x0&&(_0x5898c4={'model3Count':_0x1337fc+_0x2a6658[_0x51fb64(0x146)],'model4Count':_0x4894a3+_0x2a6658[_0x51fb64(0x178)],'drawMjCount':_0x1fb231+_0x2a6658[_0x51fb64(0x150)]});const _0x7abebd=await this[_0x51fb64(0x18a)]['update']({'userId':_0x232bd2},_0x5898c4);if(_0x7abebd[_0x51fb64(0x1c6)]===0x0)throw new common_1[(_0x51fb64(0x13d))](_0x232bd2+_0x51fb64(0x12a),common_1[_0x51fb64(0x1b2)][_0x51fb64(0x16f)]);}catch(_0x244ff1){console[_0x51fb64(0x196)](_0x51fb64(0x152),_0x244ff1);throw new common_1['HttpException'](_0x51fb64(0x19d),common_1['HttpStatus'][_0x51fb64(0x16f)]);}}async[_0x108620(0x1c8)](_0x298123){const _0x2eef70=_0x108620;console[_0x2eef70(0x196)]('充值的工单信息:',_0x298123);try{const {userId:_0x568721,goodsId:_0x5af4bc}=_0x298123,_0x3e18f2=await this['cramiPackageEntity'][_0x2eef70(0x15b)]({'where':{'id':_0x298123[_0x2eef70(0x133)],'status':0x1}});if(!_0x3e18f2)throw new common_1['HttpException']('非法操作、当前充值套餐暂不存在！',common_1['HttpStatus'][_0x2eef70(0x16f)]);const {model3Count:_0x15340d,model4Count:_0x82811,drawMjCount:_0x4c0049,days:_0xd0f1d,name:_0x254ef7}=_0x3e18f2,_0x2eb567={'model3Count':_0x15340d,'model4Count':_0x82811,'drawMjCount':_0x4c0049,'days':_0xd0f1d,'packageId':_0x298123['goodsId']};await this[_0x2eef70(0x14b)](_0x568721,_0x2eb567,_0xd0f1d),await this[_0x2eef70(0x19a)]({'userId':_0x568721,'rechargeType':balance_constant_1[_0x2eef70(0x155)][_0x2eef70(0x188)],'model3Count':_0x15340d,'model4Count':_0x82811,'drawMjCount':_0x4c0049,'pkgName':_0x254ef7,'days':_0xd0f1d});}catch(_0x4c4e4e){console[_0x2eef70(0x196)](_0x2eef70(0x152),_0x4c4e4e);throw new common_1[(_0x2eef70(0x13d))](_0x2eef70(0x1c0),common_1[_0x2eef70(0x1b2)]['BAD_REQUEST']);}}async[_0x108620(0x1a4)](_0x40350d,_0x4cbeb8){const _0x1f83c9=_0x108620,{page:page=0x1,size:size=0x14}=_0x4cbeb8,{id:_0x2ccf66}=_0x40350d[_0x1f83c9(0x13b)],[_0x166b73,_0x44d5a4]=await this['accountLogEntity']['findAndCount']({'where':{'userId':_0x2ccf66},'order':{'id':_0x1f83c9(0x1ac)},'skip':(page-0x1)*size,'take':size});return _0x166b73[_0x1f83c9(0x19f)](_0x1add11=>{const _0x3bac41=_0x1f83c9;_0x1add11[_0x3bac41(0x19b)]=_0x1add11['days']>0x0?_0x1add11[_0x3bac41(0x144)]+'天':'永久';}),{'rows':(0x0,date_1[_0x1f83c9(0x1bb)])(_0x166b73),'count':_0x44d5a4};}async['getAccountLog'](_0x3bb3de,_0x2ac614){const _0x1a92c0=_0x108620;try{const {page:page=0x1,size:size=0xa,userId:_0x4ffb33,rechargeType:_0x13b230,packageId:_0x318fae}=_0x2ac614,{role:_0x323d7c}=_0x3bb3de[_0x1a92c0(0x13b)],_0x12146c={};_0x13b230&&(_0x12146c[_0x1a92c0(0x173)]=_0x13b230),_0x12146c['userId']=_0x4ffb33||(0x0,typeorm_2[_0x1a92c0(0x1b3)])(0x186a0),_0x318fae&&(_0x12146c[_0x1a92c0(0x180)]={'$like':'%'+_0x318fae+'%'});const [_0x378ea7,_0x586427]=await this['accountLogEntity']['findAndCount']({'where':_0x12146c,'order':{'id':_0x1a92c0(0x1ac)},'skip':(page-0x1)*size,'take':size}),_0x3eebd0=_0x378ea7[_0x1a92c0(0x143)](_0x14e3d6=>_0x14e3d6[_0x1a92c0(0x139)]),_0x240221=await this[_0x1a92c0(0x1a8)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x3eebd0)}});return _0x378ea7[_0x1a92c0(0x19f)](_0x20d9ac=>{const _0x2a317f=_0x1a92c0,_0x270a2c=_0x240221[_0x2a317f(0x1cb)](_0x4e142c=>_0x4e142c['id']===_0x20d9ac['userId']);_0x20d9ac['username']=_0x270a2c===null||_0x270a2c===void 0x0?void 0x0:_0x270a2c['username'],_0x20d9ac['email']=_0x270a2c===null||_0x270a2c===void 0x0?void 0x0:_0x270a2c[_0x2a317f(0x17a)],_0x20d9ac[_0x2a317f(0x1a0)]=_0x270a2c===null||_0x270a2c===void 0x0?void 0x0:_0x270a2c[_0x2a317f(0x1a0)],_0x20d9ac[_0x2a317f(0x15f)]=_0x270a2c===null||_0x270a2c===void 0x0?void 0x0:_0x270a2c['status'],_0x20d9ac['avatar']=_0x270a2c===null||_0x270a2c===void 0x0?void 0x0:_0x270a2c['avatar'];}),_0x323d7c!==_0x1a92c0(0x185)&&_0x378ea7[_0x1a92c0(0x19f)](_0xf4da53=>{const _0x12007a=_0x1a92c0;_0xf4da53[_0x12007a(0x17a)]=_0xf4da53[_0x12007a(0x17a)]?(0x0,utils_1[_0x12007a(0x156)])(_0xf4da53['email']):'',_0xf4da53[_0x12007a(0x1a0)]=_0xf4da53[_0x12007a(0x1a0)]?(0x0,utils_1[_0x12007a(0x156)])(_0xf4da53[_0x12007a(0x1a0)]):'';}),{'rows':_0x378ea7,'count':_0x586427};}catch(_0x4fadda){console['log'](_0x1a92c0(0x152),_0x4fadda);throw new common_1[(_0x1a92c0(0x13d))](_0x1a92c0(0x1ba),common_1[_0x1a92c0(0x1b2)][_0x1a92c0(0x16f)]);}}async[_0x108620(0x18e)](_0x262691){const _0x193e8e=_0x108620;return await this['userBalanceEntity'][_0x193e8e(0x1cb)]({'where':{'userId':(0x0,typeorm_2['In'])(_0x262691)}});}async['refundMjBalance'](_0x479e03,_0x3e6026){const _0x1858ac=_0x108620;return await this['deductFromBalance'](_0x479e03,_0x1858ac(0x17d),-_0x3e6026);}async[_0x108620(0x12d)](_0x1af915){const _0x4d0215=_0x108620,{fingerprint:_0x31c356}=_0x1af915['headers'],{id:_0x384cb2}=_0x1af915[_0x4d0215(0x13b)];return await this[_0x4d0215(0x19c)][_0x4d0215(0x14e)]({'userId':Number(_0x31c356)},{'userId':_0x384cb2}),await this['chatGroupEntity'][_0x4d0215(0x14e)]({'userId':Number(_0x31c356)},{'userId':_0x384cb2}),0x1;}async['getVisitorCount'](_0x537ee3){const _0x613296=_0x108620,{fingerprint:_0x499791}=_0x537ee3[_0x613296(0x176)],_0x486fe5=await this[_0x613296(0x19c)][_0x613296(0x199)]({'where':{'userId':_0x499791}}),_0x315d6f=await this['chatGroupEntity'][_0x613296(0x199)]({'where':{'userId':_0x499791}});return _0x486fe5||_0x315d6f||0x0;}async[_0x108620(0x131)](_0xe26a29){const _0xef0eee=_0x108620,_0x2918ee=await this[_0xef0eee(0x1a8)][_0xef0eee(0x15b)]({'where':{'id':_0xe26a29}}),_0x23d478=await this['userBalanceEntity'][_0xef0eee(0x15b)]({'where':{'userId':_0xe26a29}});if(!_0x2918ee||!_0x23d478)return;const {phoneValidationMessageCount:_0x34349d,identityVerificationMessageCount:_0x3a5f6b,openIdentity:_0x3c61a5,openPhoneValidation:_0x44d3e6}=await this[_0xef0eee(0x187)][_0xef0eee(0x1a3)](['phoneValidationMessageCount',_0xef0eee(0x175),_0xef0eee(0x1af),'openPhoneValidation']),_0x26e6f6=Number(_0x34349d),_0x4add1b=Number(_0x3a5f6b),_0x5eb0ca=Number(_0x23d478[_0xef0eee(0x13f)])||0x0,_0x46b0ed=Number(_0x23d478[_0xef0eee(0x197)])||0x0,_0x50cc07=_0x5eb0ca+_0x46b0ed;if(_0x44d3e6==='1'&&_0x50cc07>=_0x26e6f6&&!_0x2918ee[_0xef0eee(0x1a0)])throw new common_1[(_0xef0eee(0x13d))](_0xef0eee(0x14d),common_1[_0xef0eee(0x1b2)][_0xef0eee(0x16f)]);if(_0x3c61a5==='1'&&_0x50cc07>=_0x4add1b&&(!_0x2918ee[_0xef0eee(0x135)]||!_0x2918ee['idCard']))throw new common_1[(_0xef0eee(0x13d))](_0xef0eee(0x1cc),common_1['HttpStatus']['BAD_REQUEST']);}};UserBalanceService=__decorate([(0x0,common_1[_0x108620(0x1c5)])(),__param(0x0,(0x0,typeorm_1[_0x108620(0x1a7)])(balance_entity_1[_0x108620(0x190)])),__param(0x1,(0x0,typeorm_1[_0x108620(0x1a7)])(userBalance_entity_1[_0x108620(0x1b5)])),__param(0x2,(0x0,typeorm_1[_0x108620(0x1a7)])(accountLog_entity_1[_0x108620(0x1b8)])),__param(0x3,(0x0,typeorm_1[_0x108620(0x1a7)])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x4,(0x0,typeorm_1[_0x108620(0x1a7)])(config_entity_1[_0x108620(0x13a)])),__param(0x5,(0x0,typeorm_1[_0x108620(0x1a7)])(user_entity_1['UserEntity'])),__param(0x6,(0x0,typeorm_1[_0x108620(0x1a7)])(fingerprint_entity_1[_0x108620(0x157)])),__param(0x7,(0x0,typeorm_1[_0x108620(0x1a7)])(chatGroup_entity_1[_0x108620(0x18f)])),__param(0x8,(0x0,typeorm_1[_0x108620(0x1a7)])(chatLog_entity_1[_0x108620(0x1ae)])),__metadata(_0x108620(0x136),[typeorm_2[_0x108620(0x194)],typeorm_2[_0x108620(0x194)],typeorm_2[_0x108620(0x194)],typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2[_0x108620(0x194)],typeorm_2[_0x108620(0x194)],typeorm_2['Repository'],typeorm_2[_0x108620(0x194)],globalConfig_service_1[_0x108620(0x18b)]])],UserBalanceService),exports[_0x108620(0x18d)]=UserBalanceService;