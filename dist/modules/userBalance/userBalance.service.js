'use strict';const _0x2e4a3a=_0x3d9a;function _0x57b9(){const _0x17aad1=['BAD_REQUEST','deductFromBalance','reduce','function','phone','replace','isInteger','GlobalConfigService','saveRecordRechargeLog','BalanceEntity','day','386qbBgqL','typeorm','当前用户无需创建账户信息！','phoneValidationMessageCount','design:paramtypes','useModel4Token','UserBalanceService','非法操作、当前充值套餐暂不存在！','Token','length','registerSendStatus','YYYY-MM-DD\x20HH:mm:ss','4408992ZzwgAP','Repository','decorate','count','registerSendModel3Count','缺失当前套餐ID、充值失败！','days','accountLogEntity','default','useModel4Count','HttpException','openIdentity','firstRregisterSendDrawMjCount','status','AccountLogEntity','memberDrawMjCount','缺失当前用户账户记录！','firstRregisterSendModel3Count','Count','积分不足，继续体验服务，请按需选购套餐！','expireDateCn','今日体验额度使用完毕，请注册使用完整服务！','validateVisitorBalance','398Gboacn','./userBalance.entity','max','./fingerprint.entity','headers','PAYMENT_REQUIRED','getDate','useModel3Count','查询当前用户余额失败！','../chatGroup/chatGroup.entity','affected','userEntity','UserBalanceEntity','当前用户不存在,记录充值日志异常','useDrawMjToken','firstRegisterSendStatus','userId','model4Count','userBalanceEntity','CramiPackageEntity','goodsId','avatar','username','1286920BGcJYc','formatDate','../chatLog/chatLog.entity','getConfigs','chatLogEntity','configVal','findOne','memberModel4Count','../crami/cramiPackage.entity','sumModel4Count','getAccountLog','sumModel3Count','realName','__esModule','find','充值的工单信息:','RechargeType','318580FKBZjS','SCAN_PAY','queryUserBalanceByIds','refundMjBalance','memberModel3Count','充值失败！','Injectable','configEntity','./accountLog.entity','metadata','__param','@nestjs/common','firstRegisterSendRank','请完成实名认证','addBalanceToUser','checkUserCertification','log','./balance.entity','user','50017OpFtyL','inheritVisitorData','isUpdatedToday','请完成手机号绑定','cramiPackageEntity','45viuacE','useModel3Token','getOwnPropertyDescriptor','42cCgito','createBaseUserBalance','./../globalConfig/globalConfig.service','用户充值失败！','getRechargeLog','findAndCount','save','ChatGroupEntity','__decorate','sumDrawMjCount','queryUserBalance','LessThan','mjDraw','DESC','formatCreateOrUpdateDate','globalConfigService','getFullYear','InjectRepository','68957CrxQok','openPhoneValidation','消费余额失败！','9CWvnUA','forEach','validateBalance','model3Count','HttpStatus','email','expirationTime','addBalanceToOrder','FingerprintLogEntity','configKey','addBalanceToNewUser','410kepByf','注册赠送失败,请联系管理员！','ChatLogEntity','registerSendModel4Count','packageId','balanceEntity','map','充值失败','update','hideString','fingerprintLogEntity','查询用户账户失败！','chatGroupEntity','format','object','registerSendDrawMjCount','36812UFujHw','当前套餐不存在！','identityVerificationMessageCount','drawMjCount'];_0x57b9=function(){return _0x17aad1;};return _0x57b9();}(function(_0x851a67,_0x425a34){const _0x525d0d=_0x3d9a,_0x162871=_0x851a67();while(!![]){try{const _0x5b415f=parseInt(_0x525d0d(0x1d3))/0x1*(-parseInt(_0x525d0d(0x1b0))/0x2)+-parseInt(_0x525d0d(0x213))/0x3*(parseInt(_0x525d0d(0x1a1))/0x4)+-parseInt(_0x525d0d(0x1fb))/0x5+parseInt(_0x525d0d(0x216))/0x6*(parseInt(_0x525d0d(0x228))/0x7)+parseInt(_0x525d0d(0x1ea))/0x8*(parseInt(_0x525d0d(0x22b))/0x9)+parseInt(_0x525d0d(0x191))/0xa*(-parseInt(_0x525d0d(0x20e))/0xb)+parseInt(_0x525d0d(0x1bc))/0xc;if(_0x5b415f===_0x425a34)break;else _0x162871['push'](_0x162871['shift']());}catch(_0x400b40){_0x162871['push'](_0x162871['shift']());}}}(_0x57b9,0x2048c));function _0x3d9a(_0xcb040c,_0x4fd4e9){const _0x57b95b=_0x57b9();return _0x3d9a=function(_0x3d9a58,_0x9bee3d){_0x3d9a58=_0x3d9a58-0x18d;let _0x5112cf=_0x57b95b[_0x3d9a58];return _0x5112cf;},_0x3d9a(_0xcb040c,_0x4fd4e9);}var __decorate=this&&this[_0x2e4a3a(0x21e)]||function(_0x481403,_0x79f1a5,_0x5a014e,_0xe7b2a4){const _0x25cd9c=_0x2e4a3a;var _0x205770=arguments[_0x25cd9c(0x1b9)],_0x541ba4=_0x205770<0x3?_0x79f1a5:_0xe7b2a4===null?_0xe7b2a4=Object[_0x25cd9c(0x215)](_0x79f1a5,_0x5a014e):_0xe7b2a4,_0x4cb645;if(typeof Reflect===_0x25cd9c(0x19f)&&typeof Reflect[_0x25cd9c(0x1be)]===_0x25cd9c(0x1a8))_0x541ba4=Reflect[_0x25cd9c(0x1be)](_0x481403,_0x79f1a5,_0x5a014e,_0xe7b2a4);else{for(var _0x3ac669=_0x481403[_0x25cd9c(0x1b9)]-0x1;_0x3ac669>=0x0;_0x3ac669--)if(_0x4cb645=_0x481403[_0x3ac669])_0x541ba4=(_0x205770<0x3?_0x4cb645(_0x541ba4):_0x205770>0x3?_0x4cb645(_0x79f1a5,_0x5a014e,_0x541ba4):_0x4cb645(_0x79f1a5,_0x5a014e))||_0x541ba4;}return _0x205770>0x3&&_0x541ba4&&Object['defineProperty'](_0x79f1a5,_0x5a014e,_0x541ba4),_0x541ba4;},__metadata=this&&this['__metadata']||function(_0x1c3e26,_0x2e5551){const _0x2d56a1=_0x2e4a3a;if(typeof Reflect===_0x2d56a1(0x19f)&&typeof Reflect[_0x2d56a1(0x204)]===_0x2d56a1(0x1a8))return Reflect[_0x2d56a1(0x204)](_0x1c3e26,_0x2e5551);},__param=this&&this[_0x2e4a3a(0x205)]||function(_0x5cf0e1,_0x202be6){return function(_0x50bb31,_0x5811dd){_0x202be6(_0x50bb31,_0x5811dd,_0x5cf0e1);};};Object['defineProperty'](exports,_0x2e4a3a(0x1f7),{'value':!![]}),exports[_0x2e4a3a(0x1b6)]=void 0x0;const balance_constant_1=require('../../common/constants/balance.constant'),utils_1=require('../../common/utils'),common_1=require(_0x2e4a3a(0x206)),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0x2e4a3a(0x1b1)),cramiPackage_entity_1=require(_0x2e4a3a(0x1f2)),config_entity_1=require('../globalConfig/config.entity'),globalConfig_service_1=require(_0x2e4a3a(0x218)),accountLog_entity_1=require(_0x2e4a3a(0x203)),balance_entity_1=require(_0x2e4a3a(0x20c)),userBalance_entity_1=require(_0x2e4a3a(0x1d4)),date_1=require('../../common/utils/date'),chatGroup_entity_1=require(_0x2e4a3a(0x1dc)),chatLog_entity_1=require(_0x2e4a3a(0x1ec)),user_entity_1=require('../user/user.entity'),fingerprint_entity_1=require(_0x2e4a3a(0x1d6));let UserBalanceService=class UserBalanceService{constructor(_0x2e1fd0,_0x3e00be,_0x3c072a,_0x417d1e,_0x255cdf,_0x393507,_0x29cc69,_0x244c38,_0x2f3dad,_0x15d528){const _0x38c36f=_0x2e4a3a;this[_0x38c36f(0x196)]=_0x2e1fd0,this[_0x38c36f(0x1e5)]=_0x3e00be,this[_0x38c36f(0x1c3)]=_0x3c072a,this['cramiPackageEntity']=_0x417d1e,this[_0x38c36f(0x202)]=_0x255cdf,this[_0x38c36f(0x1de)]=_0x393507,this[_0x38c36f(0x19b)]=_0x29cc69,this[_0x38c36f(0x19d)]=_0x244c38,this[_0x38c36f(0x1ee)]=_0x2f3dad,this['globalConfigService']=_0x15d528;}async[_0x2e4a3a(0x190)](_0x50032f){const _0x40bec9=_0x2e4a3a;try{const _0xdf42b5=await this[_0x40bec9(0x202)][_0x40bec9(0x1f8)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x40bec9(0x1ba),_0x40bec9(0x1c0),_0x40bec9(0x194),_0x40bec9(0x1a0),_0x40bec9(0x1e2),_0x40bec9(0x207),_0x40bec9(0x1cd),'firstRregisterSendModel4Count',_0x40bec9(0x1c8)])}}),_0x25bd20=_0xdf42b5[_0x40bec9(0x1a7)]((_0x4c5e5a,_0x22bb28)=>{const _0x3c243d=_0x40bec9,_0x54d129=Number(_0x22bb28[_0x3c243d(0x1ef)]),_0x6162a7=Number[_0x3c243d(0x1ab)](_0x54d129)&&_0x54d129>0x0?_0x54d129:0x0;return _0x4c5e5a[_0x22bb28[_0x3c243d(0x18f)]]=_0x6162a7,_0x4c5e5a;},{});let _0x11b7e4=0x0,_0x994a6d=0x0,_0x58a0c0=0x0;_0x25bd20['registerSendStatus']===0x1&&(_0x11b7e4=_0x11b7e4+_0x25bd20[_0x40bec9(0x1c0)],_0x994a6d=_0x994a6d+_0x25bd20['registerSendModel4Count'],_0x58a0c0=_0x58a0c0+_0x25bd20[_0x40bec9(0x1a0)]),_0x25bd20['registerSendStatus']===0x1&&_0x25bd20[_0x40bec9(0x1e2)]===0x1&&_0x50032f<=_0x25bd20[_0x40bec9(0x207)]&&(_0x11b7e4=_0x11b7e4+_0x25bd20[_0x40bec9(0x1cd)],_0x994a6d=_0x994a6d+_0x25bd20['firstRregisterSendModel4Count'],_0x58a0c0=_0x58a0c0+_0x25bd20[_0x40bec9(0x1c8)]),await this[_0x40bec9(0x1ad)]({'userId':_0x50032f,'rechargeType':balance_constant_1[_0x40bec9(0x1fa)]['REG_GIFT'],'model3Count':_0x11b7e4,'drawMjCount':_0x58a0c0,'model4Count':_0x994a6d}),await this[_0x40bec9(0x1e5)]['save']({'userId':_0x50032f,'model3Count':_0x11b7e4,'model4Count':_0x994a6d,'drawMjCount':_0x58a0c0,'useTokens':0x0});}catch(_0x4bbcc6){console[_0x40bec9(0x20b)]('error:\x20',_0x4bbcc6);throw new common_1[(_0x40bec9(0x1c6))](_0x40bec9(0x192),common_1[_0x40bec9(0x22f)][_0x40bec9(0x1a5)]);}}async[_0x2e4a3a(0x22d)](_0x352c74,_0x2f0e70,_0x2d0f2b){const _0x1bfff2=_0x2e4a3a,{id:_0x597fd7,role:_0x2bdb67}=_0x352c74[_0x1bfff2(0x20d)];let _0xe6d6dc=await this[_0x1bfff2(0x1e5)][_0x1bfff2(0x1f0)]({'where':{'userId':_0x597fd7}});!_0xe6d6dc&&(_0xe6d6dc=await this[_0x1bfff2(0x217)](_0x597fd7));if(_0x2bdb67==='visitor')return this['validateVisitorBalance'](_0x352c74,_0x2f0e70,_0x2d0f2b);const _0x5f95a8=_0x2f0e70===0x1?_0x1bfff2(0x1ff):_0x2f0e70===0x2?_0x1bfff2(0x1f1):_0x2f0e70===0x3?'memberDrawMjCount':null,_0x443a8d=_0x2f0e70===0x1?_0x1bfff2(0x22e):_0x2f0e70===0x2?_0x1bfff2(0x1e4):_0x2f0e70===0x3?_0x1bfff2(0x1a4):null;if(_0xe6d6dc[_0x1bfff2(0x195)]&&_0xe6d6dc[_0x5f95a8]+_0xe6d6dc[_0x443a8d]<_0x2d0f2b){if(_0xe6d6dc[_0x443a8d]<_0x2d0f2b)throw new common_1[(_0x1bfff2(0x1c6))]('积分不足，继续体验服务，请按需选购套餐！',common_1[_0x1bfff2(0x22f)]['PAYMENT_REQUIRED']);}if(!_0xe6d6dc['packageId']&&_0xe6d6dc[_0x443a8d]<_0x2d0f2b)throw new common_1['HttpException'](_0x1bfff2(0x1cf),common_1['HttpStatus'][_0x1bfff2(0x1d8)]);return _0xe6d6dc;}async[_0x2e4a3a(0x1d2)](_0x5575ec,_0x4e4c37,_0x580b6c){const _0x3c0e16=_0x2e4a3a,{id:_0x3bcc5e}=_0x5575ec['user'],_0x30cfdb=_0x4e4c37===0x1?_0x3c0e16(0x22e):_0x4e4c37===0x2?'model4Count':_0x4e4c37===0x3?_0x3c0e16(0x1a4):null,_0x432340=new Date(),_0x723c4f=await this[_0x3c0e16(0x19b)][_0x3c0e16(0x1f0)]({'where':{'fingerprint':_0x3bcc5e}}),{visitorModel3Num:_0x45d5d4,visitorModel4Num:_0xf282b7,visitorMJNum:_0x4c27b9}=await this[_0x3c0e16(0x225)][_0x3c0e16(0x1ed)](['visitorModel3Num','visitorModel4Num','visitorMJNum']),_0x231dd4={'model3Count':_0x45d5d4?Number(_0x45d5d4):0x0,'model4Count':_0xf282b7?Number(_0xf282b7):0x0,'drawMjCount':_0x4c27b9?Number(_0x4c27b9):0x0};if(!_0x723c4f){let _0x1c129d={'fingerprint':_0x3bcc5e,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0};_0x1c129d[_0x30cfdb]=_0x1c129d[_0x30cfdb]+_0x580b6c;if(_0x1c129d[_0x30cfdb]>_0x231dd4[_0x30cfdb])throw new common_1[(_0x3c0e16(0x1c6))](_0x3c0e16(0x1d1),common_1[_0x3c0e16(0x22f)][_0x3c0e16(0x1d8)]);else return await this[_0x3c0e16(0x19b)]['save'](_0x1c129d),!![];}else{const {model3Count:_0x317587,model4Count:_0x29cf8e,drawMjCount:_0x55b1b7}=_0x723c4f;let _0x52e3fc={'model3Count':_0x317587,'model4Count':_0x29cf8e,'drawMjCount':_0x55b1b7};const _0x586fbe=Number(new Date(_0x723c4f['updatedAt'])),_0x3dadc3=this[_0x3c0e16(0x210)](_0x586fbe);_0x3dadc3?_0x52e3fc[_0x30cfdb]=_0x52e3fc[_0x30cfdb]+_0x580b6c:(_0x52e3fc={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x52e3fc[_0x30cfdb]=_0x52e3fc[_0x30cfdb]+_0x580b6c);if(_0x52e3fc[_0x30cfdb]>_0x231dd4[_0x30cfdb])throw new common_1[(_0x3c0e16(0x1c6))](_0x3c0e16(0x1d1),common_1[_0x3c0e16(0x22f)][_0x3c0e16(0x1d8)]);else return await this[_0x3c0e16(0x19b)][_0x3c0e16(0x199)]({'fingerprint':_0x3bcc5e},_0x52e3fc),!![];}}[_0x2e4a3a(0x210)](_0x31f5e7){const _0x274f3a=_0x2e4a3a,_0x2a1158=new Date(),_0x2ff4f5=new Date(_0x2a1158[_0x274f3a(0x226)](),_0x2a1158['getMonth'](),_0x2a1158[_0x274f3a(0x1d9)]());return _0x31f5e7>=_0x2ff4f5;}async[_0x2e4a3a(0x1a6)](_0x19d9f8,_0x8b1d7e,_0x16efbe,_0x577cbd=0x0){const _0x3edbe0=_0x2e4a3a,_0x31504f=await this['userBalanceEntity'][_0x3edbe0(0x1f0)]({'where':{'userId':_0x19d9f8}});if(!_0x31504f)throw new common_1[(_0x3edbe0(0x1c6))](_0x3edbe0(0x1cc),common_1[_0x3edbe0(0x22f)][_0x3edbe0(0x1a5)]);const _0x27b40c={0x1:{'member':'memberModel3Count','nonMember':'model3Count','token':_0x3edbe0(0x214)},0x2:{'member':_0x3edbe0(0x1f1),'nonMember':_0x3edbe0(0x1e4),'token':_0x3edbe0(0x1b5)},0x3:{'member':_0x3edbe0(0x1cb),'nonMember':'drawMjCount','token':_0x3edbe0(0x1e1)}},{member:_0x31afb8,nonMember:_0x38e1bd,token:_0x5022d2}=_0x27b40c[_0x8b1d7e];let _0x582299=_0x16efbe,_0x57a03b=Math[_0x3edbe0(0x1d5)](_0x31504f[_0x31afb8]-_0x582299,0x0);_0x582299-=_0x31504f[_0x31afb8]-_0x57a03b;let _0x9302a5=_0x31504f[_0x38e1bd];_0x582299>0x0&&(_0x9302a5=Math[_0x3edbe0(0x1d5)](_0x31504f[_0x38e1bd]-_0x582299,0x0),_0x582299-=_0x31504f[_0x38e1bd]-_0x9302a5);const _0x2f883b={[_0x31afb8]:_0x57a03b,[_0x38e1bd]:_0x9302a5,[_0x5022d2]:(_0x31504f[_0x5022d2]||0x0)+_0x577cbd};(_0x5022d2===_0x3edbe0(0x214)||_0x5022d2===_0x3edbe0(0x1b5))&&(_0x2f883b[_0x5022d2['replace'](_0x3edbe0(0x1b8),_0x3edbe0(0x1ce))]=(_0x31504f[_0x5022d2[_0x3edbe0(0x1aa)](_0x3edbe0(0x1b8),'Count')]||0x0)+_0x16efbe);const _0xcb4f87=await this[_0x3edbe0(0x1e5)][_0x3edbe0(0x199)]({'userId':_0x19d9f8},_0x2f883b);if(_0xcb4f87[_0x3edbe0(0x1dd)]===0x0)throw new common_1['HttpException'](_0x3edbe0(0x22a),common_1[_0x3edbe0(0x22f)][_0x3edbe0(0x1a5)]);}async[_0x2e4a3a(0x220)](_0x2c028e){const _0x337421=_0x2e4a3a;try{const _0x29b525=await this['userBalanceEntity'][_0x337421(0x1f0)]({'where':{'userId':_0x2c028e},'select':[_0x337421(0x195),_0x337421(0x22e),'model4Count',_0x337421(0x1a4),'memberModel3Count',_0x337421(0x1f1),_0x337421(0x1cb),_0x337421(0x1da),_0x337421(0x1c5),_0x337421(0x214),_0x337421(0x1b5),_0x337421(0x1e1),_0x337421(0x231)]});if(!_0x29b525){const _0x11208e=await this['createBaseUserBalance'](_0x2c028e);if(_0x11208e)return await this[_0x337421(0x220)](_0x2c028e);else throw new common_1[(_0x337421(0x1c6))](_0x337421(0x1db),common_1[_0x337421(0x22f)][_0x337421(0x1a5)]);}return _0x29b525[_0x337421(0x1f5)]=_0x29b525[_0x337421(0x195)]?_0x29b525['model3Count']+_0x29b525[_0x337421(0x1ff)]:_0x29b525[_0x337421(0x22e)],_0x29b525[_0x337421(0x1f3)]=_0x29b525[_0x337421(0x195)]?_0x29b525[_0x337421(0x1e4)]+_0x29b525[_0x337421(0x1f1)]:_0x29b525[_0x337421(0x1e4)],_0x29b525[_0x337421(0x21f)]=_0x29b525[_0x337421(0x195)]?_0x29b525[_0x337421(0x1a4)]+_0x29b525[_0x337421(0x1cb)]:_0x29b525[_0x337421(0x1a4)],_0x29b525[_0x337421(0x231)]=_0x29b525[_0x337421(0x231)]?(0x0,date_1[_0x337421(0x1eb)])(_0x29b525['expirationTime'],'YYYY-MM-DD'):null,_0x29b525;}catch(_0x3b0815){console[_0x337421(0x20b)]('error:\x20',_0x3b0815);}}async[_0x2e4a3a(0x1ad)](_0x4efd42){const _0x5874da=_0x2e4a3a,{userId:_0x597c16,rechargeType:_0x305471,model3Count:_0x36cf97,model4Count:_0x3ed815,drawMjCount:_0x4e8712,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x4efd42;if(!_0x597c16)throw new common_1[(_0x5874da(0x1c6))](_0x5874da(0x1e0),common_1[_0x5874da(0x22f)]['BAD_REQUEST']);const _0x443411=(0x0,utils_1['createRandomUid'])();return await this['accountLogEntity'][_0x5874da(0x21c)]({'userId':_0x597c16,'rechargeType':_0x305471,'model3Count':_0x36cf97,'model4Count':_0x3ed815,'drawMjCount':_0x4e8712,'days':days,'extent':extent,'uid':_0x443411,'pkgName':pkgName});}async['createBaseUserBalance'](_0x2cf324,_0xcd41c2={}){const _0x45719b=_0x2e4a3a,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0xcd41c2,_0x22f113=await this[_0x45719b(0x1e5)][_0x45719b(0x1f0)]({'where':{'userId':_0x2cf324}});if(_0x22f113)throw new common_1['HttpException'](_0x45719b(0x1b2),common_1['HttpStatus'][_0x45719b(0x1a5)]);return await this[_0x45719b(0x1e5)]['save']({'userId':_0x2cf324,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async['addBalanceToUser'](_0x2da82a,_0x7b3e,_0xb05169=-0x1){const _0x4bf23f=_0x2e4a3a;try{const _0x45fa09=await this[_0x4bf23f(0x1e5)][_0x4bf23f(0x1f0)]({'where':{'userId':_0x2da82a}})||await this[_0x4bf23f(0x217)](_0x2da82a);if(!_0x45fa09)throw new common_1[(_0x4bf23f(0x1c6))]('查询用户账户信息失败！',common_1[_0x4bf23f(0x22f)][_0x4bf23f(0x1a5)]);const {model3Count:_0x32ca35,model4Count:_0x5b4349,drawMjCount:_0xb9101e,memberModel3Count:_0x5b1324,memberModel4Count:_0x40c0e6,memberDrawMjCount:_0x52133c}=_0x45fa09;let _0x174c89={};if(_0xb05169>0x0){const {packageId:_0x6453db}=_0x7b3e;if(!_0x6453db)throw new common_1[(_0x4bf23f(0x1c6))](_0x4bf23f(0x1c1),common_1[_0x4bf23f(0x22f)][_0x4bf23f(0x1a5)]);const _0x4c00f9=await this[_0x4bf23f(0x212)]['findOne']({'where':{'id':_0x6453db}});if(!_0x4c00f9)throw new common_1[(_0x4bf23f(0x1c6))](_0x4bf23f(0x1a2),common_1[_0x4bf23f(0x22f)][_0x4bf23f(0x1a5)]);const {weight:_0x6c2b46}=_0x4c00f9;if(!_0x45fa09['packageId'])_0x174c89={'memberModel3Count':_0x5b1324+_0x7b3e['model3Count'],'memberModel4Count':_0x40c0e6+_0x7b3e[_0x4bf23f(0x1e4)],'memberDrawMjCount':_0x52133c+_0x7b3e[_0x4bf23f(0x1a4)],'expirationTime':(0x0,date_1[_0x4bf23f(0x1c4)])()['add'](_0xb05169>0x0?_0xb05169:0x0,_0x4bf23f(0x1af))[_0x4bf23f(0x19e)](_0x4bf23f(0x1bb)),'packageId':_0x6453db};else{const _0x5a31c8=await this[_0x4bf23f(0x212)][_0x4bf23f(0x1f0)]({'where':{'id':_0x45fa09[_0x4bf23f(0x195)]}});_0x6c2b46>=_0x5a31c8['weight']&&(_0x174c89={'memberModel3Count':_0x5b1324+_0x7b3e[_0x4bf23f(0x22e)],'memberModel4Count':_0x40c0e6+_0x7b3e[_0x4bf23f(0x1e4)],'memberDrawMjCount':_0x52133c+_0x7b3e['drawMjCount'],'expirationTime':(0x0,date_1[_0x4bf23f(0x1c4)])(_0x45fa09[_0x4bf23f(0x231)])['add'](_0xb05169>0x0?_0xb05169:0x0,_0x4bf23f(0x1af))[_0x4bf23f(0x19e)]('YYYY-MM-DD\x20HH:mm:ss'),'packageId':_0x6453db}),_0x6c2b46<_0x5a31c8['weight']&&(_0x174c89={'memberModel3Count':_0x5b1324+_0x7b3e[_0x4bf23f(0x22e)],'memberModel4Count':_0x40c0e6+_0x7b3e[_0x4bf23f(0x1e4)],'memberDrawMjCount':_0x52133c+_0x7b3e['drawMjCount']});}}_0xb05169<=0x0&&(_0x174c89={'model3Count':_0x32ca35+_0x7b3e[_0x4bf23f(0x22e)],'model4Count':_0x5b4349+_0x7b3e[_0x4bf23f(0x1e4)],'drawMjCount':_0xb9101e+_0x7b3e['drawMjCount']});const _0x2b9e42=await this['userBalanceEntity'][_0x4bf23f(0x199)]({'userId':_0x2da82a},_0x174c89);if(_0x2b9e42[_0x4bf23f(0x1dd)]===0x0)throw new common_1['HttpException'](_0x2da82a+_0x4bf23f(0x198),common_1[_0x4bf23f(0x22f)][_0x4bf23f(0x1a5)]);}catch(_0x1948cb){console[_0x4bf23f(0x20b)]('error:\x20',_0x1948cb);throw new common_1[(_0x4bf23f(0x1c6))](_0x4bf23f(0x219),common_1['HttpStatus'][_0x4bf23f(0x1a5)]);}}async[_0x2e4a3a(0x18d)](_0x47966b){const _0x182e9b=_0x2e4a3a;console['log'](_0x182e9b(0x1f9),_0x47966b);try{const {userId:_0x953712,goodsId:_0x327f3a}=_0x47966b,_0x5d42c2=await this[_0x182e9b(0x212)][_0x182e9b(0x1f0)]({'where':{'id':_0x47966b[_0x182e9b(0x1e7)],'status':0x1}});if(!_0x5d42c2)throw new common_1[(_0x182e9b(0x1c6))](_0x182e9b(0x1b7),common_1[_0x182e9b(0x22f)][_0x182e9b(0x1a5)]);const {model3Count:_0x19f31b,model4Count:_0x51eb19,drawMjCount:_0x4d3e1e,days:_0x2874c5,name:_0x4d2367}=_0x5d42c2,_0x4fd163={'model3Count':_0x19f31b,'model4Count':_0x51eb19,'drawMjCount':_0x4d3e1e,'days':_0x2874c5,'packageId':_0x47966b['goodsId']};await this[_0x182e9b(0x209)](_0x953712,_0x4fd163,_0x2874c5),await this[_0x182e9b(0x1ad)]({'userId':_0x953712,'rechargeType':balance_constant_1[_0x182e9b(0x1fa)][_0x182e9b(0x1fc)],'model3Count':_0x19f31b,'model4Count':_0x51eb19,'drawMjCount':_0x4d3e1e,'pkgName':_0x4d2367,'days':_0x2874c5});}catch(_0x434ae8){console[_0x182e9b(0x20b)]('error:\x20',_0x434ae8);throw new common_1['HttpException'](_0x182e9b(0x200),common_1[_0x182e9b(0x22f)][_0x182e9b(0x1a5)]);}}async[_0x2e4a3a(0x21a)](_0x1dd96e,_0x1c5f88){const _0x1e5e10=_0x2e4a3a,{page:page=0x1,size:size=0x14}=_0x1c5f88,{id:_0x2a2567}=_0x1dd96e[_0x1e5e10(0x20d)],[_0x29859a,_0x40c216]=await this['accountLogEntity'][_0x1e5e10(0x21b)]({'where':{'userId':_0x2a2567},'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size});return _0x29859a[_0x1e5e10(0x22c)](_0x579b3a=>{const _0x5a68ab=_0x1e5e10;_0x579b3a[_0x5a68ab(0x1d0)]=_0x579b3a[_0x5a68ab(0x1c2)]>0x0?_0x579b3a[_0x5a68ab(0x1c2)]+'天':'永久';}),{'rows':(0x0,date_1[_0x1e5e10(0x224)])(_0x29859a),'count':_0x40c216};}async[_0x2e4a3a(0x1f4)](_0x263f21,_0x1b1c4f){const _0x57c3f3=_0x2e4a3a;try{const {page:page=0x1,size:size=0xa,userId:_0x4443ca,rechargeType:_0x30f1a1,packageId:_0x242733}=_0x1b1c4f,{role:_0x19c112}=_0x263f21[_0x57c3f3(0x20d)],_0x3ab33={};_0x30f1a1&&(_0x3ab33['rechargeType']=_0x30f1a1),_0x3ab33[_0x57c3f3(0x1e3)]=_0x4443ca||(0x0,typeorm_2[_0x57c3f3(0x221)])(0x186a0),_0x242733&&(_0x3ab33[_0x57c3f3(0x195)]={'$like':'%'+_0x242733+'%'});const [_0x21ac38,_0x1f2e63]=await this[_0x57c3f3(0x1c3)][_0x57c3f3(0x21b)]({'where':_0x3ab33,'order':{'id':_0x57c3f3(0x223)},'skip':(page-0x1)*size,'take':size}),_0x7dc449=_0x21ac38[_0x57c3f3(0x197)](_0x2731ce=>_0x2731ce[_0x57c3f3(0x1e3)]),_0x16c651=await this[_0x57c3f3(0x1de)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x7dc449)}});return _0x21ac38[_0x57c3f3(0x22c)](_0x369f81=>{const _0x571482=_0x57c3f3,_0x303c27=_0x16c651[_0x571482(0x1f8)](_0x13b22a=>_0x13b22a['id']===_0x369f81[_0x571482(0x1e3)]);_0x369f81[_0x571482(0x1e9)]=_0x303c27===null||_0x303c27===void 0x0?void 0x0:_0x303c27[_0x571482(0x1e9)],_0x369f81[_0x571482(0x230)]=_0x303c27===null||_0x303c27===void 0x0?void 0x0:_0x303c27[_0x571482(0x230)],_0x369f81['phone']=_0x303c27===null||_0x303c27===void 0x0?void 0x0:_0x303c27[_0x571482(0x1a9)],_0x369f81[_0x571482(0x1c9)]=_0x303c27===null||_0x303c27===void 0x0?void 0x0:_0x303c27[_0x571482(0x1c9)],_0x369f81['avatar']=_0x303c27===null||_0x303c27===void 0x0?void 0x0:_0x303c27[_0x571482(0x1e8)];}),_0x19c112!=='super'&&_0x21ac38['forEach'](_0x1666b9=>{const _0x4301ce=_0x57c3f3;_0x1666b9['email']=_0x1666b9[_0x4301ce(0x230)]?(0x0,utils_1['hideString'])(_0x1666b9['email']):'',_0x1666b9['phone']=_0x1666b9[_0x4301ce(0x1a9)]?(0x0,utils_1[_0x4301ce(0x19a)])(_0x1666b9[_0x4301ce(0x1a9)]):'';}),{'rows':_0x21ac38,'count':_0x1f2e63};}catch(_0x13d7ac){console[_0x57c3f3(0x20b)]('error:\x20',_0x13d7ac);throw new common_1[(_0x57c3f3(0x1c6))](_0x57c3f3(0x19c),common_1[_0x57c3f3(0x22f)][_0x57c3f3(0x1a5)]);}}async[_0x2e4a3a(0x1fd)](_0x537da7){const _0x50ee2a=_0x2e4a3a;return await this['userBalanceEntity'][_0x50ee2a(0x1f8)]({'where':{'userId':(0x0,typeorm_2['In'])(_0x537da7)}});}async[_0x2e4a3a(0x1fe)](_0x4d8a55,_0x18dd8f){const _0x11571a=_0x2e4a3a;return await this[_0x11571a(0x1a6)](_0x4d8a55,_0x11571a(0x222),-_0x18dd8f);}async[_0x2e4a3a(0x20f)](_0x4517b1){const _0x360b57=_0x2e4a3a,{fingerprint:_0x47179e}=_0x4517b1[_0x360b57(0x1d7)],{id:_0x422003}=_0x4517b1[_0x360b57(0x20d)];return await this[_0x360b57(0x1ee)][_0x360b57(0x199)]({'userId':Number(_0x47179e)},{'userId':_0x422003}),await this['chatGroupEntity']['update']({'userId':Number(_0x47179e)},{'userId':_0x422003}),0x1;}async['getVisitorCount'](_0x41c5be){const _0x28a221=_0x2e4a3a,{fingerprint:_0x14ed31}=_0x41c5be['headers'],_0x5f86e5=await this[_0x28a221(0x1ee)]['count']({'where':{'userId':_0x14ed31}}),_0x22da8d=await this[_0x28a221(0x19d)][_0x28a221(0x1bf)]({'where':{'userId':_0x14ed31}});return _0x5f86e5||_0x22da8d||0x0;}async[_0x2e4a3a(0x20a)](_0x521fd7){const _0x9b993b=_0x2e4a3a,_0x1e90a6=await this[_0x9b993b(0x1de)][_0x9b993b(0x1f0)]({'where':{'id':_0x521fd7}}),_0xe391b2=await this[_0x9b993b(0x1e5)][_0x9b993b(0x1f0)]({'where':{'userId':_0x521fd7}});if(!_0x1e90a6||!_0xe391b2)return;const {phoneValidationMessageCount:_0x146eef,identityVerificationMessageCount:_0x85c03b,openIdentity:_0x10d401,openPhoneValidation:_0x143357}=await this['globalConfigService'][_0x9b993b(0x1ed)]([_0x9b993b(0x1b3),_0x9b993b(0x1a3),_0x9b993b(0x1c7),_0x9b993b(0x229)]),_0x452af1=Number(_0x146eef),_0x3b44bc=Number(_0x85c03b),_0x14a140=Number(_0xe391b2[_0x9b993b(0x1da)])||0x0,_0x36da9a=Number(_0xe391b2[_0x9b993b(0x1c5)])||0x0,_0x476a4c=_0x14a140+_0x36da9a;if(_0x143357==='1'&&_0x476a4c>=_0x452af1&&!_0x1e90a6[_0x9b993b(0x1a9)])throw new common_1['HttpException'](_0x9b993b(0x211),common_1[_0x9b993b(0x22f)][_0x9b993b(0x1a5)]);if(_0x10d401==='1'&&_0x476a4c>=_0x3b44bc&&(!_0x1e90a6[_0x9b993b(0x1f6)]||!_0x1e90a6['idCard']))throw new common_1[(_0x9b993b(0x1c6))](_0x9b993b(0x208),common_1['HttpStatus'][_0x9b993b(0x1a5)]);}};UserBalanceService=__decorate([(0x0,common_1[_0x2e4a3a(0x201)])(),__param(0x0,(0x0,typeorm_1[_0x2e4a3a(0x227)])(balance_entity_1[_0x2e4a3a(0x1ae)])),__param(0x1,(0x0,typeorm_1[_0x2e4a3a(0x227)])(userBalance_entity_1[_0x2e4a3a(0x1df)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(accountLog_entity_1[_0x2e4a3a(0x1ca)])),__param(0x3,(0x0,typeorm_1['InjectRepository'])(cramiPackage_entity_1[_0x2e4a3a(0x1e6)])),__param(0x4,(0x0,typeorm_1['InjectRepository'])(config_entity_1['ConfigEntity'])),__param(0x5,(0x0,typeorm_1[_0x2e4a3a(0x227)])(user_entity_1['UserEntity'])),__param(0x6,(0x0,typeorm_1['InjectRepository'])(fingerprint_entity_1[_0x2e4a3a(0x18e)])),__param(0x7,(0x0,typeorm_1[_0x2e4a3a(0x227)])(chatGroup_entity_1[_0x2e4a3a(0x21d)])),__param(0x8,(0x0,typeorm_1['InjectRepository'])(chatLog_entity_1[_0x2e4a3a(0x193)])),__metadata(_0x2e4a3a(0x1b4),[typeorm_2['Repository'],typeorm_2[_0x2e4a3a(0x1bd)],typeorm_2[_0x2e4a3a(0x1bd)],typeorm_2[_0x2e4a3a(0x1bd)],typeorm_2['Repository'],typeorm_2[_0x2e4a3a(0x1bd)],typeorm_2[_0x2e4a3a(0x1bd)],typeorm_2[_0x2e4a3a(0x1bd)],typeorm_2[_0x2e4a3a(0x1bd)],globalConfig_service_1[_0x2e4a3a(0x1ac)]])],UserBalanceService),exports[_0x2e4a3a(0x1b6)]=UserBalanceService;