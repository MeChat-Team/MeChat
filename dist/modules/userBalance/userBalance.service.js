'use strict';function _0x1eeb(){const _0x44e8f3=['充值的工单信息:','ChatGroupEntity','InjectRepository','积分不足，继续体验服务，请按需选购套餐！','globalConfigService','__param','UserEntity','sumModel3Count','LessThan','mjDraw','log','当前用户不存在,记录充值日志异常','registerSendStatus','getAccountLog','headers','今日体验额度使用完毕，请注册使用完整服务！','Injectable','length','getMonth','reduce','phone','update','updatedAt','default','RechargeType','useModel3Token','validateVisitorBalance','object','createRandomUid','decorate','model3Count','memberDrawMjCount','map','function','phoneValidationMessageCount','visitor','8206674AMMNBt','../../common/utils/date','identityVerificationMessageCount','消费余额失败！','4948512qhqJYX','REG_GIFT','getConfigs','refundMjBalance','__decorate','visitorModel4Num','rechargeType','super','design:paramtypes','username','YYYY-MM-DD\x20HH:mm:ss','./fingerprint.entity','GlobalConfigService','addBalanceToOrder','Count','861852kQDzfI','day','saveRecordRechargeLog','sumModel4Count','充值失败','expirationTime','SCAN_PAY','getDate','1357557ubxyrK','error:\x20','firstRregisterSendDrawMjCount','1194536NQkkcq','./../globalConfig/globalConfig.service','DESC','idCard','UserBalanceService','addBalanceToUser','查询用户账户失败！','缺失当前套餐ID、充值失败！','openPhoneValidation','userEntity','Token','visitorMJNum','firstRegisterSendStatus','../crami/cramiPackage.entity','user','affected','cramiPackageEntity','realName','390300VgnXQx','当前用户无需创建账户信息！','BAD_REQUEST','visitorModel3Num','add','format','email','chatLogEntity','inheritVisitorData','AccountLogEntity','useModel3Count','fingerprintLogEntity','firstRregisterSendModel3Count','请完成实名认证','PAYMENT_REQUIRED','accountLogEntity','__esModule','FingerprintLogEntity','55MwkLCW','useModel4Token','openIdentity','isUpdatedToday','useModel4Count','weight','checkUserCertification','registerSendModel3Count','avatar','HttpException','configEntity','metadata','configVal','formatCreateOrUpdateDate','查询当前用户余额失败！','formatDate','CramiPackageEntity','UserBalanceEntity','hideString','ChatLogEntity','save','status','userId','addBalanceToNewUser','充值失败！','查询用户账户信息失败！','firstRegisterSendRank','max','userBalanceEntity','memberModel4Count','HttpStatus','registerSendDrawMjCount','createBaseUserBalance','findOne','./userBalance.entity','goodsId','drawMjCount','isInteger','find','Repository','balanceEntity','./accountLog.entity','@nestjs/common','queryUserBalanceByIds','chatGroupEntity','count','../../common/utils','configKey','findAndCount','replace','5650144mUkNLr','ConfigEntity','../../common/constants/balance.constant','getOwnPropertyDescriptor','packageId','memberModel3Count','firstRregisterSendModel4Count','defineProperty','validateBalance','days','./balance.entity','useDrawMjToken','model4Count','注册赠送失败,请联系管理员！','../chatLog/chatLog.entity','queryUserBalance','请完成手机号绑定'];_0x1eeb=function(){return _0x44e8f3;};return _0x1eeb();}const _0x33deca=_0x3f9c;(function(_0xe2ac2,_0x25ca14){const _0x2806ac=_0x3f9c,_0x2fc199=_0xe2ac2();while(!![]){try{const _0x319d37=-parseInt(_0x2806ac(0x1b5))/0x1+-parseInt(_0x2806ac(0x1ca))/0x2+parseInt(_0x2806ac(0x19e))/0x3+-parseInt(_0x2806ac(0x1b8))/0x4+parseInt(_0x2806ac(0x133))/0x5*(parseInt(_0x2806ac(0x1ad))/0x6)+-parseInt(_0x2806ac(0x19a))/0x7+parseInt(_0x2806ac(0x165))/0x8;if(_0x319d37===_0x25ca14)break;else _0x2fc199['push'](_0x2fc199['shift']());}catch(_0x215e27){_0x2fc199['push'](_0x2fc199['shift']());}}}(_0x1eeb,0xdeaef));var __decorate=this&&this[_0x33deca(0x1a2)]||function(_0x2d04f9,_0x5e3d9f,_0x1d4f00,_0x25e3de){const _0x1d9cd3=_0x33deca;var _0x17de56=arguments[_0x1d9cd3(0x187)],_0x1a50ea=_0x17de56<0x3?_0x5e3d9f:_0x25e3de===null?_0x25e3de=Object[_0x1d9cd3(0x168)](_0x5e3d9f,_0x1d4f00):_0x25e3de,_0xfca9b;if(typeof Reflect===_0x1d9cd3(0x191)&&typeof Reflect[_0x1d9cd3(0x193)]===_0x1d9cd3(0x197))_0x1a50ea=Reflect[_0x1d9cd3(0x193)](_0x2d04f9,_0x5e3d9f,_0x1d4f00,_0x25e3de);else{for(var _0x25d402=_0x2d04f9[_0x1d9cd3(0x187)]-0x1;_0x25d402>=0x0;_0x25d402--)if(_0xfca9b=_0x2d04f9[_0x25d402])_0x1a50ea=(_0x17de56<0x3?_0xfca9b(_0x1a50ea):_0x17de56>0x3?_0xfca9b(_0x5e3d9f,_0x1d4f00,_0x1a50ea):_0xfca9b(_0x5e3d9f,_0x1d4f00))||_0x1a50ea;}return _0x17de56>0x3&&_0x1a50ea&&Object['defineProperty'](_0x5e3d9f,_0x1d4f00,_0x1a50ea),_0x1a50ea;},__metadata=this&&this['__metadata']||function(_0x1d14dc,_0x3ed71f){const _0x4f5a6b=_0x33deca;if(typeof Reflect===_0x4f5a6b(0x191)&&typeof Reflect['metadata']==='function')return Reflect[_0x4f5a6b(0x13e)](_0x1d14dc,_0x3ed71f);},__param=this&&this[_0x33deca(0x17b)]||function(_0x550705,_0x49c247){return function(_0x36d44b,_0x3ab50a){_0x49c247(_0x36d44b,_0x3ab50a,_0x550705);};};Object[_0x33deca(0x16c)](exports,_0x33deca(0x1da),{'value':!![]}),exports[_0x33deca(0x1bc)]=void 0x0;const balance_constant_1=require(_0x33deca(0x167)),utils_1=require(_0x33deca(0x161)),common_1=require(_0x33deca(0x15d)),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require('typeorm'),cramiPackage_entity_1=require(_0x33deca(0x1c5)),config_entity_1=require('../globalConfig/config.entity'),globalConfig_service_1=require(_0x33deca(0x1b9)),accountLog_entity_1=require(_0x33deca(0x15c)),balance_entity_1=require(_0x33deca(0x16f)),userBalance_entity_1=require(_0x33deca(0x155)),date_1=require(_0x33deca(0x19b)),chatGroup_entity_1=require('../chatGroup/chatGroup.entity'),chatLog_entity_1=require(_0x33deca(0x173)),user_entity_1=require('../user/user.entity'),fingerprint_entity_1=require(_0x33deca(0x1a9));function _0x3f9c(_0x4d8842,_0x571459){const _0x1eeb40=_0x1eeb();return _0x3f9c=function(_0x3f9c84,_0x36a10a){_0x3f9c84=_0x3f9c84-0x133;let _0x3f0a3b=_0x1eeb40[_0x3f9c84];return _0x3f0a3b;},_0x3f9c(_0x4d8842,_0x571459);}let UserBalanceService=class UserBalanceService{constructor(_0xfcbb,_0x401733,_0x3a0dbc,_0x309c28,_0x324f26,_0x3ad327,_0x2ee3e4,_0x9e38ee,_0x5e5f7d,_0x1e2cd3){const _0x3e01fb=_0x33deca;this[_0x3e01fb(0x15b)]=_0xfcbb,this[_0x3e01fb(0x14f)]=_0x401733,this['accountLogEntity']=_0x3a0dbc,this[_0x3e01fb(0x1c8)]=_0x309c28,this[_0x3e01fb(0x13d)]=_0x324f26,this['userEntity']=_0x3ad327,this[_0x3e01fb(0x1d5)]=_0x2ee3e4,this[_0x3e01fb(0x15f)]=_0x9e38ee,this['chatLogEntity']=_0x5e5f7d,this['globalConfigService']=_0x1e2cd3;}async[_0x33deca(0x14a)](_0x14bb5c){const _0x3a1fb8=_0x33deca;try{const _0x4c69e6=await this['configEntity'][_0x3a1fb8(0x159)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x3a1fb8(0x182),'registerSendModel3Count','registerSendModel4Count',_0x3a1fb8(0x152),_0x3a1fb8(0x1c4),_0x3a1fb8(0x14d),_0x3a1fb8(0x1d6),_0x3a1fb8(0x16b),_0x3a1fb8(0x1b7)])}}),_0x1c7a34=_0x4c69e6[_0x3a1fb8(0x189)]((_0xbf204a,_0x288f18)=>{const _0x4635b1=_0x3a1fb8,_0x776f7a=Number(_0x288f18[_0x4635b1(0x13f)]),_0x3acb61=Number[_0x4635b1(0x158)](_0x776f7a)&&_0x776f7a>0x0?_0x776f7a:0x0;return _0xbf204a[_0x288f18[_0x4635b1(0x162)]]=_0x3acb61,_0xbf204a;},{});let _0x2e9c43=0x0,_0x526032=0x0,_0x4bc0cb=0x0;_0x1c7a34[_0x3a1fb8(0x182)]===0x1&&(_0x2e9c43=_0x2e9c43+_0x1c7a34[_0x3a1fb8(0x13a)],_0x526032=_0x526032+_0x1c7a34['registerSendModel4Count'],_0x4bc0cb=_0x4bc0cb+_0x1c7a34[_0x3a1fb8(0x152)]),_0x1c7a34[_0x3a1fb8(0x182)]===0x1&&_0x1c7a34[_0x3a1fb8(0x1c4)]===0x1&&_0x14bb5c<=_0x1c7a34['firstRegisterSendRank']&&(_0x2e9c43=_0x2e9c43+_0x1c7a34[_0x3a1fb8(0x1d6)],_0x526032=_0x526032+_0x1c7a34[_0x3a1fb8(0x16b)],_0x4bc0cb=_0x4bc0cb+_0x1c7a34[_0x3a1fb8(0x1b7)]),await this['saveRecordRechargeLog']({'userId':_0x14bb5c,'rechargeType':balance_constant_1[_0x3a1fb8(0x18e)][_0x3a1fb8(0x19f)],'model3Count':_0x2e9c43,'drawMjCount':_0x4bc0cb,'model4Count':_0x526032}),await this[_0x3a1fb8(0x14f)]['save']({'userId':_0x14bb5c,'model3Count':_0x2e9c43,'model4Count':_0x526032,'drawMjCount':_0x4bc0cb,'useTokens':0x0});}catch(_0x41751b){console[_0x3a1fb8(0x180)](_0x3a1fb8(0x1b6),_0x41751b);throw new common_1[(_0x3a1fb8(0x13c))](_0x3a1fb8(0x172),common_1[_0x3a1fb8(0x151)][_0x3a1fb8(0x1cc)]);}}async[_0x33deca(0x16d)](_0x4e6499,_0x59f3c9,_0x186550){const _0x4e358f=_0x33deca,{id:_0x5d5d45,role:_0x338781}=_0x4e6499[_0x4e358f(0x1c6)];let _0x604cb2=await this[_0x4e358f(0x14f)][_0x4e358f(0x154)]({'where':{'userId':_0x5d5d45}});!_0x604cb2&&(_0x604cb2=await this[_0x4e358f(0x153)](_0x5d5d45));if(_0x338781===_0x4e358f(0x199))return this[_0x4e358f(0x190)](_0x4e6499,_0x59f3c9,_0x186550);const _0x566dc3=_0x59f3c9===0x1?_0x4e358f(0x16a):_0x59f3c9===0x2?'memberModel4Count':_0x59f3c9===0x3?_0x4e358f(0x195):null,_0x11076c=_0x59f3c9===0x1?_0x4e358f(0x194):_0x59f3c9===0x2?'model4Count':_0x59f3c9===0x3?'drawMjCount':null;if(_0x604cb2[_0x4e358f(0x169)]&&_0x604cb2[_0x566dc3]+_0x604cb2[_0x11076c]<_0x186550){if(_0x604cb2[_0x11076c]<_0x186550)throw new common_1[(_0x4e358f(0x13c))](_0x4e358f(0x179),common_1[_0x4e358f(0x151)]['PAYMENT_REQUIRED']);}if(!_0x604cb2[_0x4e358f(0x169)]&&_0x604cb2[_0x11076c]<_0x186550)throw new common_1[(_0x4e358f(0x13c))](_0x4e358f(0x179),common_1[_0x4e358f(0x151)]['PAYMENT_REQUIRED']);return _0x604cb2;}async[_0x33deca(0x190)](_0x4d5764,_0x57061b,_0x48f590){const _0x298376=_0x33deca,{id:_0x5f2e76}=_0x4d5764[_0x298376(0x1c6)],_0x21c405=_0x57061b===0x1?'model3Count':_0x57061b===0x2?_0x298376(0x171):_0x57061b===0x3?_0x298376(0x157):null,_0x2315c8=new Date(),_0x255916=await this[_0x298376(0x1d5)][_0x298376(0x154)]({'where':{'fingerprint':_0x5f2e76}}),{visitorModel3Num:_0x4e3700,visitorModel4Num:_0x5101af,visitorMJNum:_0x476cc5}=await this['globalConfigService'][_0x298376(0x1a0)]([_0x298376(0x1cd),_0x298376(0x1a3),_0x298376(0x1c3)]),_0x2195c1={'model3Count':_0x4e3700?Number(_0x4e3700):0x0,'model4Count':_0x5101af?Number(_0x5101af):0x0,'drawMjCount':_0x476cc5?Number(_0x476cc5):0x0};if(!_0x255916){let _0x376f4d={'fingerprint':_0x5f2e76,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0};_0x376f4d[_0x21c405]=_0x376f4d[_0x21c405]+_0x48f590;if(_0x376f4d[_0x21c405]>_0x2195c1[_0x21c405])throw new common_1[(_0x298376(0x13c))](_0x298376(0x185),common_1['HttpStatus'][_0x298376(0x1d8)]);else return await this[_0x298376(0x1d5)][_0x298376(0x147)](_0x376f4d),!![];}else{const {model3Count:_0x1d89c2,model4Count:_0x436c8c,drawMjCount:_0x930320}=_0x255916;let _0xaa0a9a={'model3Count':_0x1d89c2,'model4Count':_0x436c8c,'drawMjCount':_0x930320};const _0x56c3d8=Number(new Date(_0x255916[_0x298376(0x18c)])),_0x71f329=this['isUpdatedToday'](_0x56c3d8);_0x71f329?_0xaa0a9a[_0x21c405]=_0xaa0a9a[_0x21c405]+_0x48f590:(_0xaa0a9a={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0xaa0a9a[_0x21c405]=_0xaa0a9a[_0x21c405]+_0x48f590);if(_0xaa0a9a[_0x21c405]>_0x2195c1[_0x21c405])throw new common_1[(_0x298376(0x13c))](_0x298376(0x185),common_1[_0x298376(0x151)][_0x298376(0x1d8)]);else return await this[_0x298376(0x1d5)][_0x298376(0x18b)]({'fingerprint':_0x5f2e76},_0xaa0a9a),!![];}}[_0x33deca(0x136)](_0x3612a7){const _0x5188b4=_0x33deca,_0x248d5c=new Date(),_0x3a473c=new Date(_0x248d5c['getFullYear'](),_0x248d5c[_0x5188b4(0x188)](),_0x248d5c[_0x5188b4(0x1b4)]());return _0x3612a7>=_0x3a473c;}async['deductFromBalance'](_0x2eec17,_0x417af7,_0x3b6520,_0xbb8e42=0x0){const _0x9e3668=_0x33deca,_0x1ad7d0=await this[_0x9e3668(0x14f)]['findOne']({'where':{'userId':_0x2eec17}});if(!_0x1ad7d0)throw new common_1[(_0x9e3668(0x13c))]('缺失当前用户账户记录！',common_1[_0x9e3668(0x151)][_0x9e3668(0x1cc)]);const _0x2a4cec={0x1:{'member':_0x9e3668(0x16a),'nonMember':_0x9e3668(0x194),'token':_0x9e3668(0x18f)},0x2:{'member':'memberModel4Count','nonMember':'model4Count','token':_0x9e3668(0x134)},0x3:{'member':_0x9e3668(0x195),'nonMember':_0x9e3668(0x157),'token':_0x9e3668(0x170)}},{member:_0x4e392b,nonMember:_0x3562f3,token:_0x427785}=_0x2a4cec[_0x417af7];let _0x3d73f7=_0x3b6520,_0x38b347=Math[_0x9e3668(0x14e)](_0x1ad7d0[_0x4e392b]-_0x3d73f7,0x0);_0x3d73f7-=_0x1ad7d0[_0x4e392b]-_0x38b347;let _0x573c3a=_0x1ad7d0[_0x3562f3];_0x3d73f7>0x0&&(_0x573c3a=Math[_0x9e3668(0x14e)](_0x1ad7d0[_0x3562f3]-_0x3d73f7,0x0),_0x3d73f7-=_0x1ad7d0[_0x3562f3]-_0x573c3a);const _0x8d1b4a={[_0x4e392b]:_0x38b347,[_0x3562f3]:_0x573c3a,[_0x427785]:(_0x1ad7d0[_0x427785]||0x0)+_0xbb8e42};(_0x427785==='useModel3Token'||_0x427785===_0x9e3668(0x134))&&(_0x8d1b4a[_0x427785[_0x9e3668(0x164)](_0x9e3668(0x1c2),'Count')]=(_0x1ad7d0[_0x427785['replace']('Token',_0x9e3668(0x1ac))]||0x0)+_0x3b6520);const _0x4b1119=await this[_0x9e3668(0x14f)]['update']({'userId':_0x2eec17},_0x8d1b4a);if(_0x4b1119[_0x9e3668(0x1c7)]===0x0)throw new common_1[(_0x9e3668(0x13c))](_0x9e3668(0x19d),common_1['HttpStatus'][_0x9e3668(0x1cc)]);}async['queryUserBalance'](_0x4329dd){const _0x46a6c4=_0x33deca;try{const _0x611f22=await this[_0x46a6c4(0x14f)]['findOne']({'where':{'userId':_0x4329dd},'select':['packageId',_0x46a6c4(0x194),_0x46a6c4(0x171),_0x46a6c4(0x157),'memberModel3Count',_0x46a6c4(0x150),'memberDrawMjCount',_0x46a6c4(0x1d4),_0x46a6c4(0x137),_0x46a6c4(0x18f),_0x46a6c4(0x134),'useDrawMjToken',_0x46a6c4(0x1b2)]});if(!_0x611f22){const _0x45bee0=await this['createBaseUserBalance'](_0x4329dd);if(_0x45bee0)return await this[_0x46a6c4(0x174)](_0x4329dd);else throw new common_1[(_0x46a6c4(0x13c))](_0x46a6c4(0x141),common_1['HttpStatus'][_0x46a6c4(0x1cc)]);}return _0x611f22[_0x46a6c4(0x17d)]=_0x611f22[_0x46a6c4(0x169)]?_0x611f22[_0x46a6c4(0x194)]+_0x611f22[_0x46a6c4(0x16a)]:_0x611f22['model3Count'],_0x611f22[_0x46a6c4(0x1b0)]=_0x611f22['packageId']?_0x611f22[_0x46a6c4(0x171)]+_0x611f22[_0x46a6c4(0x150)]:_0x611f22[_0x46a6c4(0x171)],_0x611f22['sumDrawMjCount']=_0x611f22[_0x46a6c4(0x169)]?_0x611f22['drawMjCount']+_0x611f22['memberDrawMjCount']:_0x611f22[_0x46a6c4(0x157)],_0x611f22[_0x46a6c4(0x1b2)]=_0x611f22[_0x46a6c4(0x1b2)]?(0x0,date_1[_0x46a6c4(0x142)])(_0x611f22[_0x46a6c4(0x1b2)],'YYYY-MM-DD'):null,_0x611f22;}catch(_0x35c998){console['log']('error:\x20',_0x35c998);}}async[_0x33deca(0x1af)](_0x54d591){const _0x15f0cb=_0x33deca,{userId:_0x178a47,rechargeType:_0x2ff66b,model3Count:_0x6ffc2e,model4Count:_0x12da3a,drawMjCount:_0x13a006,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x54d591;if(!_0x178a47)throw new common_1[(_0x15f0cb(0x13c))](_0x15f0cb(0x181),common_1[_0x15f0cb(0x151)]['BAD_REQUEST']);const _0x45276d=(0x0,utils_1[_0x15f0cb(0x192)])();return await this[_0x15f0cb(0x1d9)][_0x15f0cb(0x147)]({'userId':_0x178a47,'rechargeType':_0x2ff66b,'model3Count':_0x6ffc2e,'model4Count':_0x12da3a,'drawMjCount':_0x13a006,'days':days,'extent':extent,'uid':_0x45276d,'pkgName':pkgName});}async['createBaseUserBalance'](_0x2c04ed,_0xcae03c={}){const _0x598ebc=_0x33deca,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0xcae03c,_0x3ef457=await this['userBalanceEntity'][_0x598ebc(0x154)]({'where':{'userId':_0x2c04ed}});if(_0x3ef457)throw new common_1[(_0x598ebc(0x13c))](_0x598ebc(0x1cb),common_1[_0x598ebc(0x151)][_0x598ebc(0x1cc)]);return await this['userBalanceEntity'][_0x598ebc(0x147)]({'userId':_0x2c04ed,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async[_0x33deca(0x1bd)](_0x1f300a,_0x14ab70,_0x1a6439=-0x1){const _0x13e335=_0x33deca;try{const _0x424b5f=await this[_0x13e335(0x14f)][_0x13e335(0x154)]({'where':{'userId':_0x1f300a}})||await this['createBaseUserBalance'](_0x1f300a);if(!_0x424b5f)throw new common_1[(_0x13e335(0x13c))](_0x13e335(0x14c),common_1[_0x13e335(0x151)]['BAD_REQUEST']);const {model3Count:_0x45b5f6,model4Count:_0x13c81f,drawMjCount:_0x51a739,memberModel3Count:_0x18a461,memberModel4Count:_0x52744d,memberDrawMjCount:_0x4d8319}=_0x424b5f;let _0x440134={};if(_0x1a6439>0x0){const {packageId:_0x53f904}=_0x14ab70;if(!_0x53f904)throw new common_1[(_0x13e335(0x13c))](_0x13e335(0x1bf),common_1['HttpStatus'][_0x13e335(0x1cc)]);const _0x111df0=await this[_0x13e335(0x1c8)][_0x13e335(0x154)]({'where':{'id':_0x53f904}});if(!_0x111df0)throw new common_1[(_0x13e335(0x13c))]('当前套餐不存在！',common_1[_0x13e335(0x151)][_0x13e335(0x1cc)]);const {weight:_0x4d7dcd}=_0x111df0;if(!_0x424b5f['packageId'])_0x440134={'memberModel3Count':_0x18a461+_0x14ab70['model3Count'],'memberModel4Count':_0x52744d+_0x14ab70[_0x13e335(0x171)],'memberDrawMjCount':_0x4d8319+_0x14ab70[_0x13e335(0x157)],'expirationTime':(0x0,date_1[_0x13e335(0x18d)])()[_0x13e335(0x1ce)](_0x1a6439>0x0?_0x1a6439:0x0,_0x13e335(0x1ae))[_0x13e335(0x1cf)]('YYYY-MM-DD\x20HH:mm:ss'),'packageId':_0x53f904};else{const _0xc4c69f=await this[_0x13e335(0x1c8)]['findOne']({'where':{'id':_0x424b5f[_0x13e335(0x169)]}});_0x4d7dcd>=_0xc4c69f[_0x13e335(0x138)]&&(_0x440134={'memberModel3Count':_0x18a461+_0x14ab70[_0x13e335(0x194)],'memberModel4Count':_0x52744d+_0x14ab70[_0x13e335(0x171)],'memberDrawMjCount':_0x4d8319+_0x14ab70[_0x13e335(0x157)],'expirationTime':(0x0,date_1[_0x13e335(0x18d)])(_0x424b5f[_0x13e335(0x1b2)])['add'](_0x1a6439>0x0?_0x1a6439:0x0,'day')[_0x13e335(0x1cf)](_0x13e335(0x1a8)),'packageId':_0x53f904}),_0x4d7dcd<_0xc4c69f[_0x13e335(0x138)]&&(_0x440134={'memberModel3Count':_0x18a461+_0x14ab70['model3Count'],'memberModel4Count':_0x52744d+_0x14ab70[_0x13e335(0x171)],'memberDrawMjCount':_0x4d8319+_0x14ab70[_0x13e335(0x157)]});}}_0x1a6439<=0x0&&(_0x440134={'model3Count':_0x45b5f6+_0x14ab70[_0x13e335(0x194)],'model4Count':_0x13c81f+_0x14ab70[_0x13e335(0x171)],'drawMjCount':_0x51a739+_0x14ab70[_0x13e335(0x157)]});const _0x4401f9=await this[_0x13e335(0x14f)][_0x13e335(0x18b)]({'userId':_0x1f300a},_0x440134);if(_0x4401f9['affected']===0x0)throw new common_1[(_0x13e335(0x13c))](_0x1f300a+_0x13e335(0x1b1),common_1[_0x13e335(0x151)][_0x13e335(0x1cc)]);}catch(_0x4205c1){console[_0x13e335(0x180)](_0x13e335(0x1b6),_0x4205c1);throw new common_1[(_0x13e335(0x13c))]('用户充值失败！',common_1[_0x13e335(0x151)][_0x13e335(0x1cc)]);}}async[_0x33deca(0x1ab)](_0x25e296){const _0x1c7ece=_0x33deca;console[_0x1c7ece(0x180)](_0x1c7ece(0x176),_0x25e296);try{const {userId:_0x51d510,goodsId:_0x4419d2}=_0x25e296,_0x424335=await this[_0x1c7ece(0x1c8)][_0x1c7ece(0x154)]({'where':{'id':_0x25e296[_0x1c7ece(0x156)],'status':0x1}});if(!_0x424335)throw new common_1[(_0x1c7ece(0x13c))]('非法操作、当前充值套餐暂不存在！',common_1[_0x1c7ece(0x151)][_0x1c7ece(0x1cc)]);const {model3Count:_0x2b2599,model4Count:_0x3eaf2f,drawMjCount:_0x2cfa0a,days:_0x106adc,name:_0x12a258}=_0x424335,_0x32cc04={'model3Count':_0x2b2599,'model4Count':_0x3eaf2f,'drawMjCount':_0x2cfa0a,'days':_0x106adc,'packageId':_0x25e296[_0x1c7ece(0x156)]};await this[_0x1c7ece(0x1bd)](_0x51d510,_0x32cc04,_0x106adc),await this[_0x1c7ece(0x1af)]({'userId':_0x51d510,'rechargeType':balance_constant_1[_0x1c7ece(0x18e)][_0x1c7ece(0x1b3)],'model3Count':_0x2b2599,'model4Count':_0x3eaf2f,'drawMjCount':_0x2cfa0a,'pkgName':_0x12a258,'days':_0x106adc});}catch(_0x4bb7fe){console[_0x1c7ece(0x180)](_0x1c7ece(0x1b6),_0x4bb7fe);throw new common_1['HttpException'](_0x1c7ece(0x14b),common_1[_0x1c7ece(0x151)][_0x1c7ece(0x1cc)]);}}async['getRechargeLog'](_0x215dee,_0x19729c){const _0x436c81=_0x33deca,{page:page=0x1,size:size=0x14}=_0x19729c,{id:_0x46c11a}=_0x215dee[_0x436c81(0x1c6)],[_0xf63a63,_0x526bc1]=await this[_0x436c81(0x1d9)][_0x436c81(0x163)]({'where':{'userId':_0x46c11a},'order':{'id':_0x436c81(0x1ba)},'skip':(page-0x1)*size,'take':size});return _0xf63a63['forEach'](_0x543c07=>{const _0x5dbb8e=_0x436c81;_0x543c07['expireDateCn']=_0x543c07[_0x5dbb8e(0x16e)]>0x0?_0x543c07[_0x5dbb8e(0x16e)]+'天':'永久';}),{'rows':(0x0,date_1[_0x436c81(0x140)])(_0xf63a63),'count':_0x526bc1};}async[_0x33deca(0x183)](_0x4de700,_0x24c401){const _0x2f0be4=_0x33deca;try{const {page:page=0x1,size:size=0xa,userId:_0x5e8237,rechargeType:_0x1f6c61,packageId:_0x6275b1}=_0x24c401,{role:_0x5b3105}=_0x4de700[_0x2f0be4(0x1c6)],_0x209939={};_0x1f6c61&&(_0x209939[_0x2f0be4(0x1a4)]=_0x1f6c61),_0x209939[_0x2f0be4(0x149)]=_0x5e8237||(0x0,typeorm_2[_0x2f0be4(0x17e)])(0x186a0),_0x6275b1&&(_0x209939[_0x2f0be4(0x169)]={'$like':'%'+_0x6275b1+'%'});const [_0x1ab06f,_0x416327]=await this['accountLogEntity'][_0x2f0be4(0x163)]({'where':_0x209939,'order':{'id':_0x2f0be4(0x1ba)},'skip':(page-0x1)*size,'take':size}),_0x71b18d=_0x1ab06f[_0x2f0be4(0x196)](_0x58cb41=>_0x58cb41['userId']),_0x7c3d6a=await this[_0x2f0be4(0x1c1)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x71b18d)}});return _0x1ab06f['forEach'](_0x20e966=>{const _0x59ff1c=_0x2f0be4,_0x192757=_0x7c3d6a[_0x59ff1c(0x159)](_0x1c0571=>_0x1c0571['id']===_0x20e966[_0x59ff1c(0x149)]);_0x20e966[_0x59ff1c(0x1a7)]=_0x192757===null||_0x192757===void 0x0?void 0x0:_0x192757[_0x59ff1c(0x1a7)],_0x20e966['email']=_0x192757===null||_0x192757===void 0x0?void 0x0:_0x192757['email'],_0x20e966[_0x59ff1c(0x18a)]=_0x192757===null||_0x192757===void 0x0?void 0x0:_0x192757[_0x59ff1c(0x18a)],_0x20e966[_0x59ff1c(0x148)]=_0x192757===null||_0x192757===void 0x0?void 0x0:_0x192757['status'],_0x20e966[_0x59ff1c(0x13b)]=_0x192757===null||_0x192757===void 0x0?void 0x0:_0x192757[_0x59ff1c(0x13b)];}),_0x5b3105!==_0x2f0be4(0x1a5)&&_0x1ab06f['forEach'](_0x88fee9=>{const _0xe9a353=_0x2f0be4;_0x88fee9[_0xe9a353(0x1d0)]=_0x88fee9[_0xe9a353(0x1d0)]?(0x0,utils_1[_0xe9a353(0x145)])(_0x88fee9[_0xe9a353(0x1d0)]):'',_0x88fee9[_0xe9a353(0x18a)]=_0x88fee9[_0xe9a353(0x18a)]?(0x0,utils_1['hideString'])(_0x88fee9[_0xe9a353(0x18a)]):'';}),{'rows':_0x1ab06f,'count':_0x416327};}catch(_0x567551){console[_0x2f0be4(0x180)]('error:\x20',_0x567551);throw new common_1['HttpException'](_0x2f0be4(0x1be),common_1[_0x2f0be4(0x151)][_0x2f0be4(0x1cc)]);}}async[_0x33deca(0x15e)](_0x298495){const _0x5f4d75=_0x33deca;return await this['userBalanceEntity'][_0x5f4d75(0x159)]({'where':{'userId':(0x0,typeorm_2['In'])(_0x298495)}});}async[_0x33deca(0x1a1)](_0x45e68f,_0x3fab3b){const _0x4c17c8=_0x33deca;return await this['deductFromBalance'](_0x45e68f,_0x4c17c8(0x17f),-_0x3fab3b);}async[_0x33deca(0x1d2)](_0x8b2b78){const _0x21201f=_0x33deca,{fingerprint:_0x2b7924}=_0x8b2b78[_0x21201f(0x184)],{id:_0x5aa3b3}=_0x8b2b78['user'];return await this[_0x21201f(0x1d1)][_0x21201f(0x18b)]({'userId':Number(_0x2b7924)},{'userId':_0x5aa3b3}),await this[_0x21201f(0x15f)]['update']({'userId':Number(_0x2b7924)},{'userId':_0x5aa3b3}),0x1;}async['getVisitorCount'](_0x51f49b){const _0x5bfd42=_0x33deca,{fingerprint:_0x4b745c}=_0x51f49b[_0x5bfd42(0x184)],_0x19510e=await this[_0x5bfd42(0x1d1)][_0x5bfd42(0x160)]({'where':{'userId':_0x4b745c}}),_0xaab75c=await this[_0x5bfd42(0x15f)][_0x5bfd42(0x160)]({'where':{'userId':_0x4b745c}});return _0x19510e||_0xaab75c||0x0;}async[_0x33deca(0x139)](_0x457109){const _0x1cc623=_0x33deca,_0x2634dd=await this[_0x1cc623(0x1c1)][_0x1cc623(0x154)]({'where':{'id':_0x457109}}),_0x88a0f5=await this[_0x1cc623(0x14f)][_0x1cc623(0x154)]({'where':{'userId':_0x457109}});if(!_0x2634dd||!_0x88a0f5)return;const {phoneValidationMessageCount:_0x334980,identityVerificationMessageCount:_0x5b159c,openIdentity:_0x3b2260,openPhoneValidation:_0x5978bf}=await this[_0x1cc623(0x17a)]['getConfigs']([_0x1cc623(0x198),_0x1cc623(0x19c),_0x1cc623(0x135),_0x1cc623(0x1c0)]),_0x35e6e3=Number(_0x334980),_0x1be85c=Number(_0x5b159c),_0x35efcb=Number(_0x88a0f5[_0x1cc623(0x1d4)])||0x0,_0x47f80a=Number(_0x88a0f5[_0x1cc623(0x137)])||0x0,_0x54e282=_0x35efcb+_0x47f80a;if(_0x5978bf==='1'&&_0x54e282>=_0x35e6e3&&!_0x2634dd[_0x1cc623(0x18a)])throw new common_1[(_0x1cc623(0x13c))](_0x1cc623(0x175),common_1[_0x1cc623(0x151)][_0x1cc623(0x1cc)]);if(_0x3b2260==='1'&&_0x54e282>=_0x1be85c&&(!_0x2634dd[_0x1cc623(0x1c9)]||!_0x2634dd[_0x1cc623(0x1bb)]))throw new common_1['HttpException'](_0x1cc623(0x1d7),common_1[_0x1cc623(0x151)][_0x1cc623(0x1cc)]);}};UserBalanceService=__decorate([(0x0,common_1[_0x33deca(0x186)])(),__param(0x0,(0x0,typeorm_1[_0x33deca(0x178)])(balance_entity_1['BalanceEntity'])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(userBalance_entity_1[_0x33deca(0x144)])),__param(0x2,(0x0,typeorm_1[_0x33deca(0x178)])(accountLog_entity_1[_0x33deca(0x1d3)])),__param(0x3,(0x0,typeorm_1[_0x33deca(0x178)])(cramiPackage_entity_1[_0x33deca(0x143)])),__param(0x4,(0x0,typeorm_1['InjectRepository'])(config_entity_1[_0x33deca(0x166)])),__param(0x5,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x33deca(0x17c)])),__param(0x6,(0x0,typeorm_1[_0x33deca(0x178)])(fingerprint_entity_1[_0x33deca(0x1db)])),__param(0x7,(0x0,typeorm_1[_0x33deca(0x178)])(chatGroup_entity_1[_0x33deca(0x177)])),__param(0x8,(0x0,typeorm_1[_0x33deca(0x178)])(chatLog_entity_1[_0x33deca(0x146)])),__metadata(_0x33deca(0x1a6),[typeorm_2[_0x33deca(0x15a)],typeorm_2[_0x33deca(0x15a)],typeorm_2[_0x33deca(0x15a)],typeorm_2[_0x33deca(0x15a)],typeorm_2[_0x33deca(0x15a)],typeorm_2[_0x33deca(0x15a)],typeorm_2[_0x33deca(0x15a)],typeorm_2[_0x33deca(0x15a)],typeorm_2['Repository'],globalConfig_service_1[_0x33deca(0x1aa)]])],UserBalanceService),exports['UserBalanceService']=UserBalanceService;