'use strict';const _0x29f7d9=_0x2bd5;(function(_0x65935d,_0x4972d4){const _0x2963a3=_0x2bd5,_0x24954a=_0x65935d();while(!![]){try{const _0x54d703=-parseInt(_0x2963a3(0xe8))/0x1*(parseInt(_0x2963a3(0xd7))/0x2)+parseInt(_0x2963a3(0x133))/0x3+-parseInt(_0x2963a3(0x10c))/0x4+-parseInt(_0x2963a3(0xea))/0x5+-parseInt(_0x2963a3(0x123))/0x6*(parseInt(_0x2963a3(0xe1))/0x7)+parseInt(_0x2963a3(0xe0))/0x8+parseInt(_0x2963a3(0xc9))/0x9;if(_0x54d703===_0x4972d4)break;else _0x24954a['push'](_0x24954a['shift']());}catch(_0x34617f){_0x24954a['push'](_0x24954a['shift']());}}}(_0x20f8,0xe7872));function _0x2bd5(_0x3d961a,_0x273509){const _0x20f863=_0x20f8();return _0x2bd5=function(_0x2bd510,_0x4dbd1c){_0x2bd510=_0x2bd510-0xb1;let _0x114a89=_0x20f863[_0x2bd510];return _0x114a89;},_0x2bd5(_0x3d961a,_0x273509);}var __decorate=this&&this[_0x29f7d9(0x147)]||function(_0x7e1d53,_0x1902d7,_0x41f7df,_0xcd6cbb){const _0x4ad1df=_0x29f7d9;var _0x831d1b=arguments[_0x4ad1df(0xfc)],_0x3afce0=_0x831d1b<0x3?_0x1902d7:_0xcd6cbb===null?_0xcd6cbb=Object[_0x4ad1df(0xd2)](_0x1902d7,_0x41f7df):_0xcd6cbb,_0x4042d3;if(typeof Reflect===_0x4ad1df(0x111)&&typeof Reflect[_0x4ad1df(0x10f)]==='function')_0x3afce0=Reflect['decorate'](_0x7e1d53,_0x1902d7,_0x41f7df,_0xcd6cbb);else{for(var _0x3ae01c=_0x7e1d53[_0x4ad1df(0xfc)]-0x1;_0x3ae01c>=0x0;_0x3ae01c--)if(_0x4042d3=_0x7e1d53[_0x3ae01c])_0x3afce0=(_0x831d1b<0x3?_0x4042d3(_0x3afce0):_0x831d1b>0x3?_0x4042d3(_0x1902d7,_0x41f7df,_0x3afce0):_0x4042d3(_0x1902d7,_0x41f7df))||_0x3afce0;}return _0x831d1b>0x3&&_0x3afce0&&Object[_0x4ad1df(0x102)](_0x1902d7,_0x41f7df,_0x3afce0),_0x3afce0;},__metadata=this&&this[_0x29f7d9(0xb1)]||function(_0x1961e9,_0x1a6d7e){const _0x460840=_0x29f7d9;if(typeof Reflect==='object'&&typeof Reflect[_0x460840(0xf4)]===_0x460840(0xf8))return Reflect[_0x460840(0xf4)](_0x1961e9,_0x1a6d7e);},__param=this&&this[_0x29f7d9(0x103)]||function(_0x4b0995,_0x55485d){return function(_0x2bd83e,_0x41ecb0){_0x55485d(_0x2bd83e,_0x41ecb0,_0x4b0995);};};function _0x20f8(){const _0x529c29=['AccountLogEntity','realName','replace','fingerprintLogEntity','deductFromBalance','../user/user.entity','firstRregisterSendModel3Count','model4Count','metadata','../chatGroup/chatGroup.entity','registerSendModel3Count','Injectable','function','updatedAt','ConfigEntity','idCard','length','findAndCount','configKey','days','count','BalanceEntity','defineProperty','__param','getAccountLog','REG_GIFT','firstRegisterSendStatus','firstRregisterSendModel4Count','chatGroupEntity','packageId','phone','affected','1711804DWTYJe','firstRegisterSendRank','UserBalanceEntity','decorate','当前用户无需创建账户信息！','object','rechargeType','validateVisitorBalance','ChatLogEntity','查询用户账户信息失败！','refundMjBalance','useModel4Token','day','find','findOne','addBalanceToNewUser','log','注册赠送失败,请联系管理员！','useModel3Token','expireDateCn','非法操作、当前充值套餐暂不存在！','积分不足，继续体验服务，请按需选购套餐！','drawMjCount','60YqoJaH','username','queryUserBalanceByIds','memberModel4Count','getMonth','update','visitorMJNum','../../common/utils','avatar','请完成手机号绑定','Count','当前套餐不存在！','InjectRepository','Token','充值的工单信息:','PAYMENT_REQUIRED','1362630RjUFYa','accountLogEntity','../crami/cramiPackage.entity','../chatLog/chatLog.entity','expirationTime','chatLogEntity','getRechargeLog','充值失败！','registerSendDrawMjCount','./userBalance.entity','validateBalance','reduce','formatDate','createBaseUserBalance','visitorModel4Num','RechargeType','hideString','../../common/utils/date','formatCreateOrUpdateDate','FingerprintLogEntity','__decorate','充值失败','save','YYYY-MM-DD\x20HH:mm:ss','当前用户不存在,记录充值日志异常','HttpException','__metadata','configEntity','userEntity','./balance.entity','email','YYYY-MM-DD','error:\x20','forEach','../globalConfig/config.entity','globalConfigService','DESC','CramiPackageEntity','useModel3Count','registerSendStatus','user','查询用户账户失败！','registerSendModel4Count','add','format','weight','max','ChatGroupEntity','userBalanceEntity','memberModel3Count','28324350UUdxsH','visitorModel3Num','请完成实名认证','getDate','@nestjs/common','memberDrawMjCount','default','saveRecordRechargeLog','@nestjs/typeorm','getOwnPropertyDescriptor','getVisitorCount','今日体验额度使用完毕，请注册使用完整服务！','mjDraw','getConfigs','90198PfMLPZ','queryUserBalance','用户充值失败！','model3Count','isUpdatedToday','sumModel4Count','identityVerificationMessageCount','isInteger','userId','10307296LERpiW','1167047hKLlqT','cramiPackageEntity','BAD_REQUEST','HttpStatus','useModel4Count','headers','Repository','21qadoXW','__esModule','4495970adIeVk','addBalanceToUser'];_0x20f8=function(){return _0x529c29;};return _0x20f8();}Object[_0x29f7d9(0x102)](exports,_0x29f7d9(0xe9),{'value':!![]}),exports['UserBalanceService']=void 0x0;const balance_constant_1=require('../../common/constants/balance.constant'),utils_1=require(_0x29f7d9(0x12a)),common_1=require(_0x29f7d9(0xcd)),typeorm_1=require(_0x29f7d9(0xd1)),typeorm_2=require('typeorm'),cramiPackage_entity_1=require(_0x29f7d9(0x135)),config_entity_1=require(_0x29f7d9(0xb9)),globalConfig_service_1=require('./../globalConfig/globalConfig.service'),accountLog_entity_1=require('./accountLog.entity'),balance_entity_1=require(_0x29f7d9(0xb4)),userBalance_entity_1=require(_0x29f7d9(0x13c)),date_1=require(_0x29f7d9(0x144)),chatGroup_entity_1=require(_0x29f7d9(0xf5)),chatLog_entity_1=require(_0x29f7d9(0x136)),user_entity_1=require(_0x29f7d9(0xf1)),fingerprint_entity_1=require('./fingerprint.entity');let UserBalanceService=class UserBalanceService{constructor(_0x4a4201,_0x35fa8f,_0x4345e4,_0x168832,_0x38335c,_0x4e7897,_0x34b482,_0x52314a,_0xd734cb,_0x4f83a1){const _0x7ce255=_0x29f7d9;this['balanceEntity']=_0x4a4201,this['userBalanceEntity']=_0x35fa8f,this[_0x7ce255(0x134)]=_0x4345e4,this[_0x7ce255(0xe2)]=_0x168832,this[_0x7ce255(0xb2)]=_0x38335c,this[_0x7ce255(0xb3)]=_0x4e7897,this[_0x7ce255(0xef)]=_0x34b482,this[_0x7ce255(0x108)]=_0x52314a,this['chatLogEntity']=_0xd734cb,this['globalConfigService']=_0x4f83a1;}async[_0x29f7d9(0x11b)](_0x4f970b){const _0x513090=_0x29f7d9;try{const _0x472d76=await this[_0x513090(0xb2)][_0x513090(0x119)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x513090(0xbe),_0x513090(0xf6),_0x513090(0xc1),'registerSendDrawMjCount','firstRegisterSendStatus',_0x513090(0x10d),_0x513090(0xf2),_0x513090(0x107),'firstRregisterSendDrawMjCount'])}}),_0x4735a5=_0x472d76[_0x513090(0x13e)]((_0x539839,_0x3da41c)=>{const _0x259853=_0x513090,_0x5b61f5=Number(_0x3da41c['configVal']),_0x21b095=Number[_0x259853(0xde)](_0x5b61f5)&&_0x5b61f5>0x0?_0x5b61f5:0x0;return _0x539839[_0x3da41c[_0x259853(0xfe)]]=_0x21b095,_0x539839;},{});let _0x6c4bc4=0x0,_0x447edb=0x0,_0x118aba=0x0;_0x4735a5[_0x513090(0xbe)]===0x1&&(_0x6c4bc4=_0x6c4bc4+_0x4735a5['registerSendModel3Count'],_0x447edb=_0x447edb+_0x4735a5[_0x513090(0xc1)],_0x118aba=_0x118aba+_0x4735a5[_0x513090(0x13b)]),_0x4735a5[_0x513090(0xbe)]===0x1&&_0x4735a5[_0x513090(0x106)]===0x1&&_0x4f970b<=_0x4735a5[_0x513090(0x10d)]&&(_0x6c4bc4=_0x6c4bc4+_0x4735a5[_0x513090(0xf2)],_0x447edb=_0x447edb+_0x4735a5[_0x513090(0x107)],_0x118aba=_0x118aba+_0x4735a5['firstRregisterSendDrawMjCount']),await this[_0x513090(0xd0)]({'userId':_0x4f970b,'rechargeType':balance_constant_1[_0x513090(0x142)][_0x513090(0x105)],'model3Count':_0x6c4bc4,'drawMjCount':_0x118aba,'model4Count':_0x447edb}),await this['userBalanceEntity']['save']({'userId':_0x4f970b,'model3Count':_0x6c4bc4,'model4Count':_0x447edb,'drawMjCount':_0x118aba,'useTokens':0x0});}catch(_0x333d16){console[_0x513090(0x11c)]('error:\x20',_0x333d16);throw new common_1['HttpException'](_0x513090(0x11d),common_1[_0x513090(0xe4)]['BAD_REQUEST']);}}async[_0x29f7d9(0x13d)](_0x541893,_0x4922e7,_0x35ce89){const _0x3af64b=_0x29f7d9,{id:_0x5e8691,role:_0x26ebb7}=_0x541893[_0x3af64b(0xbf)];let _0x4b639a=await this['userBalanceEntity']['findOne']({'where':{'userId':_0x5e8691}});!_0x4b639a&&(_0x4b639a=await this[_0x3af64b(0x140)](_0x5e8691));if(_0x26ebb7==='visitor')return this[_0x3af64b(0x113)](_0x541893,_0x4922e7,_0x35ce89);const _0x542560=_0x4922e7===0x1?'memberModel3Count':_0x4922e7===0x2?_0x3af64b(0x126):_0x4922e7===0x3?_0x3af64b(0xce):null,_0x11a901=_0x4922e7===0x1?_0x3af64b(0xda):_0x4922e7===0x2?_0x3af64b(0xf3):_0x4922e7===0x3?_0x3af64b(0x122):null;if(_0x4b639a[_0x3af64b(0x109)]&&_0x4b639a[_0x542560]+_0x4b639a[_0x11a901]<_0x35ce89){if(_0x4b639a[_0x11a901]<_0x35ce89)throw new common_1['HttpException'](_0x3af64b(0x121),common_1[_0x3af64b(0xe4)][_0x3af64b(0x132)]);}if(!_0x4b639a[_0x3af64b(0x109)]&&_0x4b639a[_0x11a901]<_0x35ce89)throw new common_1[(_0x3af64b(0x14c))](_0x3af64b(0x121),common_1[_0x3af64b(0xe4)]['PAYMENT_REQUIRED']);return _0x4b639a;}async[_0x29f7d9(0x113)](_0x16ef8d,_0x14f092,_0x27bad3){const _0xf17282=_0x29f7d9,{id:_0x5bcc54}=_0x16ef8d['user'],_0x551875=_0x14f092===0x1?_0xf17282(0xda):_0x14f092===0x2?_0xf17282(0xf3):_0x14f092===0x3?_0xf17282(0x122):null,_0x2728f0=new Date(),_0x3f4826=await this[_0xf17282(0xef)][_0xf17282(0x11a)]({'where':{'fingerprint':_0x5bcc54}}),{visitorModel3Num:_0x1d82b9,visitorModel4Num:_0x30e05a,visitorMJNum:_0xa333de}=await this['globalConfigService'][_0xf17282(0xd6)]([_0xf17282(0xca),_0xf17282(0x141),_0xf17282(0x129)]),_0x27a725={'model3Count':_0x1d82b9?Number(_0x1d82b9):0x0,'model4Count':_0x30e05a?Number(_0x30e05a):0x0,'drawMjCount':_0xa333de?Number(_0xa333de):0x0};if(!_0x3f4826){let _0xccc108={'fingerprint':_0x5bcc54,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0};_0xccc108[_0x551875]=_0xccc108[_0x551875]+_0x27bad3;if(_0xccc108[_0x551875]>_0x27a725[_0x551875])throw new common_1[(_0xf17282(0x14c))]('今日体验额度使用完毕，请注册使用完整服务！',common_1[_0xf17282(0xe4)][_0xf17282(0x132)]);else return await this[_0xf17282(0xef)][_0xf17282(0x149)](_0xccc108),!![];}else{const {model3Count:_0xa26a21,model4Count:_0xfc30d,drawMjCount:_0x1da7d7}=_0x3f4826;let _0x496095={'model3Count':_0xa26a21,'model4Count':_0xfc30d,'drawMjCount':_0x1da7d7};const _0x21595f=Number(new Date(_0x3f4826[_0xf17282(0xf9)])),_0x116d95=this[_0xf17282(0xdb)](_0x21595f);_0x116d95?_0x496095[_0x551875]=_0x496095[_0x551875]+_0x27bad3:(_0x496095={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x496095[_0x551875]=_0x496095[_0x551875]+_0x27bad3);if(_0x496095[_0x551875]>_0x27a725[_0x551875])throw new common_1['HttpException'](_0xf17282(0xd4),common_1[_0xf17282(0xe4)][_0xf17282(0x132)]);else return await this[_0xf17282(0xef)]['update']({'fingerprint':_0x5bcc54},_0x496095),!![];}}[_0x29f7d9(0xdb)](_0x1d60e4){const _0x5e74f0=_0x29f7d9,_0x2b5162=new Date(),_0x5d371b=new Date(_0x2b5162['getFullYear'](),_0x2b5162[_0x5e74f0(0x127)](),_0x2b5162[_0x5e74f0(0xcc)]());return _0x1d60e4>=_0x5d371b;}async[_0x29f7d9(0xf0)](_0x336a6e,_0x267643,_0x370ca3,_0x37c388=0x0){const _0x467343=_0x29f7d9,_0x1de535=await this[_0x467343(0xc7)][_0x467343(0x11a)]({'where':{'userId':_0x336a6e}});if(!_0x1de535)throw new common_1[(_0x467343(0x14c))]('缺失当前用户账户记录！',common_1[_0x467343(0xe4)][_0x467343(0xe3)]);const _0xc6e9d7={0x1:{'member':_0x467343(0xc8),'nonMember':_0x467343(0xda),'token':_0x467343(0x11e)},0x2:{'member':'memberModel4Count','nonMember':_0x467343(0xf3),'token':'useModel4Token'},0x3:{'member':_0x467343(0xce),'nonMember':_0x467343(0x122),'token':'useDrawMjToken'}},{member:_0x553748,nonMember:_0x397619,token:_0xbb315e}=_0xc6e9d7[_0x267643];let _0x4933ff=_0x370ca3,_0x42e3e9=Math[_0x467343(0xc5)](_0x1de535[_0x553748]-_0x4933ff,0x0);_0x4933ff-=_0x1de535[_0x553748]-_0x42e3e9;let _0x85128=_0x1de535[_0x397619];_0x4933ff>0x0&&(_0x85128=Math[_0x467343(0xc5)](_0x1de535[_0x397619]-_0x4933ff,0x0),_0x4933ff-=_0x1de535[_0x397619]-_0x85128);const _0x4b4928={[_0x553748]:_0x42e3e9,[_0x397619]:_0x85128,[_0xbb315e]:(_0x1de535[_0xbb315e]||0x0)+_0x37c388};(_0xbb315e===_0x467343(0x11e)||_0xbb315e===_0x467343(0x117))&&(_0x4b4928[_0xbb315e['replace'](_0x467343(0x130),'Count')]=(_0x1de535[_0xbb315e[_0x467343(0xee)]('Token',_0x467343(0x12d))]||0x0)+_0x370ca3);const _0x5e6bae=await this[_0x467343(0xc7)][_0x467343(0x128)]({'userId':_0x336a6e},_0x4b4928);if(_0x5e6bae[_0x467343(0x10b)]===0x0)throw new common_1[(_0x467343(0x14c))]('消费余额失败！',common_1[_0x467343(0xe4)][_0x467343(0xe3)]);}async['queryUserBalance'](_0x311115){const _0x3b0a32=_0x29f7d9;try{const _0x3e5549=await this[_0x3b0a32(0xc7)]['findOne']({'where':{'userId':_0x311115},'select':[_0x3b0a32(0x109),_0x3b0a32(0xda),_0x3b0a32(0xf3),_0x3b0a32(0x122),'memberModel3Count','memberModel4Count',_0x3b0a32(0xce),_0x3b0a32(0xbd),'useModel4Count',_0x3b0a32(0x11e),_0x3b0a32(0x117),'useDrawMjToken','expirationTime']});if(!_0x3e5549){const _0x4a78c7=await this[_0x3b0a32(0x140)](_0x311115);if(_0x4a78c7)return await this[_0x3b0a32(0xd8)](_0x311115);else throw new common_1['HttpException']('查询当前用户余额失败！',common_1['HttpStatus'][_0x3b0a32(0xe3)]);}return _0x3e5549['sumModel3Count']=_0x3e5549[_0x3b0a32(0x109)]?_0x3e5549[_0x3b0a32(0xda)]+_0x3e5549[_0x3b0a32(0xc8)]:_0x3e5549['model3Count'],_0x3e5549[_0x3b0a32(0xdc)]=_0x3e5549[_0x3b0a32(0x109)]?_0x3e5549['model4Count']+_0x3e5549[_0x3b0a32(0x126)]:_0x3e5549[_0x3b0a32(0xf3)],_0x3e5549['sumDrawMjCount']=_0x3e5549[_0x3b0a32(0x109)]?_0x3e5549['drawMjCount']+_0x3e5549['memberDrawMjCount']:_0x3e5549['drawMjCount'],_0x3e5549[_0x3b0a32(0x137)]=_0x3e5549['expirationTime']?(0x0,date_1[_0x3b0a32(0x13f)])(_0x3e5549['expirationTime'],_0x3b0a32(0xb6)):null,_0x3e5549;}catch(_0x32eadd){console[_0x3b0a32(0x11c)](_0x3b0a32(0xb7),_0x32eadd);}}async['saveRecordRechargeLog'](_0x5eb7a9){const _0x880406=_0x29f7d9,{userId:_0x107b82,rechargeType:_0x5b32c2,model3Count:_0xdb88d3,model4Count:_0x1589f5,drawMjCount:_0x244336,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x5eb7a9;if(!_0x107b82)throw new common_1[(_0x880406(0x14c))](_0x880406(0x14b),common_1[_0x880406(0xe4)]['BAD_REQUEST']);const _0x21fd4e=(0x0,utils_1['createRandomUid'])();return await this['accountLogEntity'][_0x880406(0x149)]({'userId':_0x107b82,'rechargeType':_0x5b32c2,'model3Count':_0xdb88d3,'model4Count':_0x1589f5,'drawMjCount':_0x244336,'days':days,'extent':extent,'uid':_0x21fd4e,'pkgName':pkgName});}async[_0x29f7d9(0x140)](_0x4a0765,_0x28a448={}){const _0x3ff2b0=_0x29f7d9,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x28a448,_0x4e7ec4=await this[_0x3ff2b0(0xc7)][_0x3ff2b0(0x11a)]({'where':{'userId':_0x4a0765}});if(_0x4e7ec4)throw new common_1[(_0x3ff2b0(0x14c))](_0x3ff2b0(0x110),common_1[_0x3ff2b0(0xe4)][_0x3ff2b0(0xe3)]);return await this[_0x3ff2b0(0xc7)][_0x3ff2b0(0x149)]({'userId':_0x4a0765,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async['addBalanceToUser'](_0x568848,_0x55962e,_0x46974d=-0x1){const _0x588fa0=_0x29f7d9;try{const _0xf26a4e=await this[_0x588fa0(0xc7)][_0x588fa0(0x11a)]({'where':{'userId':_0x568848}})||await this['createBaseUserBalance'](_0x568848);if(!_0xf26a4e)throw new common_1[(_0x588fa0(0x14c))](_0x588fa0(0x115),common_1[_0x588fa0(0xe4)][_0x588fa0(0xe3)]);const {model3Count:_0x5088c3,model4Count:_0x2491e2,drawMjCount:_0xdf662d,memberModel3Count:_0x1549df,memberModel4Count:_0x64bade,memberDrawMjCount:_0x14cdc7}=_0xf26a4e;let _0x29bc03={};if(_0x46974d>0x0){const {packageId:_0x1bab25}=_0x55962e;if(!_0x1bab25)throw new common_1['HttpException']('缺失当前套餐ID、充值失败！',common_1[_0x588fa0(0xe4)]['BAD_REQUEST']);const _0x363307=await this[_0x588fa0(0xe2)]['findOne']({'where':{'id':_0x1bab25}});if(!_0x363307)throw new common_1['HttpException'](_0x588fa0(0x12e),common_1[_0x588fa0(0xe4)][_0x588fa0(0xe3)]);const {weight:_0x233211}=_0x363307;if(!_0xf26a4e[_0x588fa0(0x109)])_0x29bc03={'memberModel3Count':_0x1549df+_0x55962e[_0x588fa0(0xda)],'memberModel4Count':_0x64bade+_0x55962e['model4Count'],'memberDrawMjCount':_0x14cdc7+_0x55962e[_0x588fa0(0x122)],'expirationTime':(0x0,date_1[_0x588fa0(0xcf)])()[_0x588fa0(0xc2)](_0x46974d>0x0?_0x46974d:0x0,_0x588fa0(0x118))[_0x588fa0(0xc3)](_0x588fa0(0x14a)),'packageId':_0x1bab25};else{const _0x52ad65=await this['cramiPackageEntity'][_0x588fa0(0x11a)]({'where':{'id':_0xf26a4e[_0x588fa0(0x109)]}});_0x233211>=_0x52ad65[_0x588fa0(0xc4)]&&(_0x29bc03={'memberModel3Count':_0x1549df+_0x55962e[_0x588fa0(0xda)],'memberModel4Count':_0x64bade+_0x55962e[_0x588fa0(0xf3)],'memberDrawMjCount':_0x14cdc7+_0x55962e[_0x588fa0(0x122)],'expirationTime':(0x0,date_1['default'])(_0xf26a4e[_0x588fa0(0x137)])[_0x588fa0(0xc2)](_0x46974d>0x0?_0x46974d:0x0,_0x588fa0(0x118))[_0x588fa0(0xc3)]('YYYY-MM-DD\x20HH:mm:ss'),'packageId':_0x1bab25}),_0x233211<_0x52ad65[_0x588fa0(0xc4)]&&(_0x29bc03={'memberModel3Count':_0x1549df+_0x55962e[_0x588fa0(0xda)],'memberModel4Count':_0x64bade+_0x55962e['model4Count'],'memberDrawMjCount':_0x14cdc7+_0x55962e[_0x588fa0(0x122)]});}}_0x46974d<=0x0&&(_0x29bc03={'model3Count':_0x5088c3+_0x55962e[_0x588fa0(0xda)],'model4Count':_0x2491e2+_0x55962e[_0x588fa0(0xf3)],'drawMjCount':_0xdf662d+_0x55962e[_0x588fa0(0x122)]});const _0x4e0632=await this[_0x588fa0(0xc7)]['update']({'userId':_0x568848},_0x29bc03);if(_0x4e0632[_0x588fa0(0x10b)]===0x0)throw new common_1['HttpException'](_0x568848+_0x588fa0(0x148),common_1['HttpStatus']['BAD_REQUEST']);}catch(_0x5d1606){console[_0x588fa0(0x11c)](_0x588fa0(0xb7),_0x5d1606);throw new common_1[(_0x588fa0(0x14c))](_0x588fa0(0xd9),common_1['HttpStatus']['BAD_REQUEST']);}}async['addBalanceToOrder'](_0x2a3496){const _0x503fb8=_0x29f7d9;console['log'](_0x503fb8(0x131),_0x2a3496);try{const {userId:_0x7d2c1f,goodsId:_0x331983}=_0x2a3496,_0x19dc28=await this[_0x503fb8(0xe2)][_0x503fb8(0x11a)]({'where':{'id':_0x2a3496['goodsId'],'status':0x1}});if(!_0x19dc28)throw new common_1['HttpException'](_0x503fb8(0x120),common_1[_0x503fb8(0xe4)]['BAD_REQUEST']);const {model3Count:_0x104077,model4Count:_0x3e2043,drawMjCount:_0x25b452,days:_0x420b1b,name:_0x3a3617}=_0x19dc28,_0x1593de={'model3Count':_0x104077,'model4Count':_0x3e2043,'drawMjCount':_0x25b452,'days':_0x420b1b,'packageId':_0x2a3496['goodsId']};await this[_0x503fb8(0xeb)](_0x7d2c1f,_0x1593de,_0x420b1b),await this[_0x503fb8(0xd0)]({'userId':_0x7d2c1f,'rechargeType':balance_constant_1[_0x503fb8(0x142)]['SCAN_PAY'],'model3Count':_0x104077,'model4Count':_0x3e2043,'drawMjCount':_0x25b452,'pkgName':_0x3a3617,'days':_0x420b1b});}catch(_0x498f24){console[_0x503fb8(0x11c)](_0x503fb8(0xb7),_0x498f24);throw new common_1['HttpException'](_0x503fb8(0x13a),common_1[_0x503fb8(0xe4)]['BAD_REQUEST']);}}async[_0x29f7d9(0x139)](_0x261621,_0x1b97e7){const _0x4807f8=_0x29f7d9,{page:page=0x1,size:size=0x14}=_0x1b97e7,{id:_0x38308b}=_0x261621[_0x4807f8(0xbf)],[_0x1b221b,_0x576c17]=await this[_0x4807f8(0x134)][_0x4807f8(0xfd)]({'where':{'userId':_0x38308b},'order':{'id':_0x4807f8(0xbb)},'skip':(page-0x1)*size,'take':size});return _0x1b221b[_0x4807f8(0xb8)](_0x1d580d=>{const _0x1d9386=_0x4807f8;_0x1d580d[_0x1d9386(0x11f)]=_0x1d580d['days']>0x0?_0x1d580d[_0x1d9386(0xff)]+'天':'永久';}),{'rows':(0x0,date_1[_0x4807f8(0x145)])(_0x1b221b),'count':_0x576c17};}async[_0x29f7d9(0x104)](_0x48be97,_0x37b8f1){const _0x16af2a=_0x29f7d9;try{const {page:page=0x1,size:size=0xa,userId:_0x26f03e,rechargeType:_0x253f70,packageId:_0x4c5dc9}=_0x37b8f1,{role:_0x47e0e6}=_0x48be97['user'],_0x312f0d={};_0x253f70&&(_0x312f0d[_0x16af2a(0x112)]=_0x253f70),_0x312f0d[_0x16af2a(0xdf)]=_0x26f03e||(0x0,typeorm_2['LessThan'])(0x186a0),_0x4c5dc9&&(_0x312f0d['packageId']={'$like':'%'+_0x4c5dc9+'%'});const [_0x1e4a9c,_0x35a49a]=await this['accountLogEntity'][_0x16af2a(0xfd)]({'where':_0x312f0d,'order':{'id':_0x16af2a(0xbb)},'skip':(page-0x1)*size,'take':size}),_0x35d3c2=_0x1e4a9c['map'](_0x303f6b=>_0x303f6b[_0x16af2a(0xdf)]),_0x3a77b8=await this['userEntity'][_0x16af2a(0x119)]({'where':{'id':(0x0,typeorm_2['In'])(_0x35d3c2)}});return _0x1e4a9c[_0x16af2a(0xb8)](_0x36ab97=>{const _0x440f6c=_0x16af2a,_0x87151a=_0x3a77b8[_0x440f6c(0x119)](_0x3900aa=>_0x3900aa['id']===_0x36ab97[_0x440f6c(0xdf)]);_0x36ab97[_0x440f6c(0x124)]=_0x87151a===null||_0x87151a===void 0x0?void 0x0:_0x87151a['username'],_0x36ab97[_0x440f6c(0xb5)]=_0x87151a===null||_0x87151a===void 0x0?void 0x0:_0x87151a[_0x440f6c(0xb5)],_0x36ab97[_0x440f6c(0x10a)]=_0x87151a===null||_0x87151a===void 0x0?void 0x0:_0x87151a['phone'],_0x36ab97['status']=_0x87151a===null||_0x87151a===void 0x0?void 0x0:_0x87151a['status'],_0x36ab97[_0x440f6c(0x12b)]=_0x87151a===null||_0x87151a===void 0x0?void 0x0:_0x87151a['avatar'];}),_0x47e0e6!=='super'&&_0x1e4a9c[_0x16af2a(0xb8)](_0x424d25=>{const _0x1cedc2=_0x16af2a;_0x424d25[_0x1cedc2(0xb5)]=_0x424d25[_0x1cedc2(0xb5)]?(0x0,utils_1[_0x1cedc2(0x143)])(_0x424d25[_0x1cedc2(0xb5)]):'',_0x424d25[_0x1cedc2(0x10a)]=_0x424d25[_0x1cedc2(0x10a)]?(0x0,utils_1['hideString'])(_0x424d25[_0x1cedc2(0x10a)]):'';}),{'rows':_0x1e4a9c,'count':_0x35a49a};}catch(_0x1a8904){console[_0x16af2a(0x11c)](_0x16af2a(0xb7),_0x1a8904);throw new common_1[(_0x16af2a(0x14c))](_0x16af2a(0xc0),common_1[_0x16af2a(0xe4)][_0x16af2a(0xe3)]);}}async[_0x29f7d9(0x125)](_0x329b07){const _0x582536=_0x29f7d9;return await this['userBalanceEntity'][_0x582536(0x119)]({'where':{'userId':(0x0,typeorm_2['In'])(_0x329b07)}});}async[_0x29f7d9(0x116)](_0x346fee,_0x2d1101){const _0xe0049e=_0x29f7d9;return await this[_0xe0049e(0xf0)](_0x346fee,_0xe0049e(0xd5),-_0x2d1101);}async['inheritVisitorData'](_0x85c278){const _0x236501=_0x29f7d9,{fingerprint:_0x4eca9d}=_0x85c278[_0x236501(0xe6)],{id:_0x1aab3c}=_0x85c278[_0x236501(0xbf)];return await this['chatLogEntity'][_0x236501(0x128)]({'userId':Number(_0x4eca9d)},{'userId':_0x1aab3c}),await this[_0x236501(0x108)][_0x236501(0x128)]({'userId':Number(_0x4eca9d)},{'userId':_0x1aab3c}),0x1;}async[_0x29f7d9(0xd3)](_0x1b407d){const _0x200af0=_0x29f7d9,{fingerprint:_0x2d6cf8}=_0x1b407d[_0x200af0(0xe6)],_0x23dd08=await this[_0x200af0(0x138)][_0x200af0(0x100)]({'where':{'userId':_0x2d6cf8}}),_0x53fae1=await this[_0x200af0(0x108)][_0x200af0(0x100)]({'where':{'userId':_0x2d6cf8}});return _0x23dd08||_0x53fae1||0x0;}async['checkUserCertification'](_0x57a621){const _0x39475a=_0x29f7d9,_0x4904fa=await this[_0x39475a(0xb3)][_0x39475a(0x11a)]({'where':{'id':_0x57a621}}),_0x28dfb0=await this[_0x39475a(0xc7)]['findOne']({'where':{'userId':_0x57a621}});if(!_0x4904fa||!_0x28dfb0)return;const {phoneValidationMessageCount:_0x36b1d3,identityVerificationMessageCount:_0x392bc2,openIdentity:_0x27633b,openPhoneValidation:_0x4d4d37}=await this[_0x39475a(0xba)][_0x39475a(0xd6)](['phoneValidationMessageCount',_0x39475a(0xdd),'openIdentity','openPhoneValidation']),_0x34ff6f=Number(_0x36b1d3),_0x4219f7=Number(_0x392bc2),_0x23b1e1=Number(_0x28dfb0['useModel3Count'])||0x0,_0x233208=Number(_0x28dfb0[_0x39475a(0xe5)])||0x0,_0x167afa=_0x23b1e1+_0x233208;if(_0x4d4d37==='1'&&_0x167afa>=_0x34ff6f&&!_0x4904fa[_0x39475a(0x10a)])throw new common_1[(_0x39475a(0x14c))](_0x39475a(0x12c),common_1[_0x39475a(0xe4)]['BAD_REQUEST']);if(_0x27633b==='1'&&_0x167afa>=_0x4219f7&&(!_0x4904fa[_0x39475a(0xed)]||!_0x4904fa[_0x39475a(0xfb)]))throw new common_1[(_0x39475a(0x14c))](_0x39475a(0xcb),common_1[_0x39475a(0xe4)][_0x39475a(0xe3)]);}};UserBalanceService=__decorate([(0x0,common_1[_0x29f7d9(0xf7)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(balance_entity_1[_0x29f7d9(0x101)])),__param(0x1,(0x0,typeorm_1[_0x29f7d9(0x12f)])(userBalance_entity_1[_0x29f7d9(0x10e)])),__param(0x2,(0x0,typeorm_1[_0x29f7d9(0x12f)])(accountLog_entity_1[_0x29f7d9(0xec)])),__param(0x3,(0x0,typeorm_1[_0x29f7d9(0x12f)])(cramiPackage_entity_1[_0x29f7d9(0xbc)])),__param(0x4,(0x0,typeorm_1['InjectRepository'])(config_entity_1[_0x29f7d9(0xfa)])),__param(0x5,(0x0,typeorm_1[_0x29f7d9(0x12f)])(user_entity_1['UserEntity'])),__param(0x6,(0x0,typeorm_1['InjectRepository'])(fingerprint_entity_1[_0x29f7d9(0x146)])),__param(0x7,(0x0,typeorm_1[_0x29f7d9(0x12f)])(chatGroup_entity_1[_0x29f7d9(0xc6)])),__param(0x8,(0x0,typeorm_1['InjectRepository'])(chatLog_entity_1[_0x29f7d9(0x114)])),__metadata('design:paramtypes',[typeorm_2[_0x29f7d9(0xe7)],typeorm_2[_0x29f7d9(0xe7)],typeorm_2[_0x29f7d9(0xe7)],typeorm_2[_0x29f7d9(0xe7)],typeorm_2[_0x29f7d9(0xe7)],typeorm_2[_0x29f7d9(0xe7)],typeorm_2[_0x29f7d9(0xe7)],typeorm_2[_0x29f7d9(0xe7)],typeorm_2[_0x29f7d9(0xe7)],globalConfig_service_1['GlobalConfigService']])],UserBalanceService),exports['UserBalanceService']=UserBalanceService;