'use strict';const _0x220de9=_0x19e7;(function(_0x1ec4f6,_0x5ebd58){const _0x2f54ec=_0x19e7,_0x22d091=_0x1ec4f6();while(!![]){try{const _0x3ff12b=-parseInt(_0x2f54ec(0x191))/0x1*(parseInt(_0x2f54ec(0x16d))/0x2)+-parseInt(_0x2f54ec(0x1b3))/0x3*(-parseInt(_0x2f54ec(0x1bf))/0x4)+-parseInt(_0x2f54ec(0x1c7))/0x5+-parseInt(_0x2f54ec(0x154))/0x6*(parseInt(_0x2f54ec(0x19f))/0x7)+parseInt(_0x2f54ec(0x188))/0x8*(parseInt(_0x2f54ec(0x168))/0x9)+-parseInt(_0x2f54ec(0x1bc))/0xa*(-parseInt(_0x2f54ec(0x156))/0xb)+parseInt(_0x2f54ec(0x166))/0xc*(parseInt(_0x2f54ec(0x152))/0xd);if(_0x3ff12b===_0x5ebd58)break;else _0x22d091['push'](_0x22d091['shift']());}catch(_0x32ca4d){_0x22d091['push'](_0x22d091['shift']());}}}(_0x337c,0xc0767));function _0x337c(){const _0x12def1=['userId','sumModel3Count','log','addBalanceToNewUser','FingerprintLogEntity','缺失当前套餐ID、充值失败！','__decorate','SCAN_PAY','10CXikbR','GlobalConfigService','积分不足，继续体验服务，请按需选购套餐！','32CLUrQG','HttpException','请完成手机号绑定','消费余额失败！','configVal','用户充值失败！','validateVisitorBalance','expirationTime','1720580rQgygy','getDate','请完成实名认证','registerSendDrawMjCount','default','find','useModel3Token','weight','phoneValidationMessageCount','forEach','count','__param','day','email','design:paramtypes','updatedAt','findOne','../globalConfig/config.entity','chatLogEntity','注册赠送失败,请联系管理员！','headers','map','visitor','isInteger','cramiPackageEntity','metadata','UserBalanceService','model4Count','RechargeType','ChatGroupEntity','getConfigs','model3Count','days','查询用户账户信息失败！','./fingerprint.entity','当前用户无需创建账户信息！','findAndCount','phone','Injectable','firstRegisterSendStatus','drawMjCount','HttpStatus','realName','memberModel3Count','openIdentity','typeorm','user','13zKnfuB','今日体验额度使用完毕，请注册使用完整服务！','6WSuJYL','queryUserBalanceByIds','15590399ihwcdC','format','configEntity','getRechargeLog','firstRregisterSendDrawMjCount','../user/user.entity','update','accountLogEntity','Count','充值失败','globalConfigService','packageId','queryUserBalance','registerSendModel4Count','userBalanceEntity','PAYMENT_REQUIRED','11607252aapYPN','useModel4Count','423NarFfS','InjectRepository','firstRregisterSendModel3Count','reduce','memberModel4Count','314722ZBozQx','DESC','BAD_REQUEST','./balance.entity','addBalanceToUser','../chatLog/chatLog.entity','非法操作、当前充值套餐暂不存在！','fingerprintLogEntity','checkUserCertification','saveRecordRechargeLog','expireDateCn','object','当前用户不存在,记录充值日志异常','visitorModel3Num','add','deductFromBalance','isUpdatedToday','save','AccountLogEntity','function','查询当前用户余额失败！','formatDate','username','replace','ConfigEntity','充值失败！','error:\x20','171672QbTKsK','../../common/constants/balance.constant','createRandomUid','defineProperty','createBaseUserBalance','mjDraw','memberDrawMjCount','查询用户账户失败！','useDrawMjToken','5ugjlrc','identityVerificationMessageCount','goodsId','BalanceEntity','UserBalanceEntity','./accountLog.entity','hideString','../../common/utils','visitorMJNum','useModel4Token','充值的工单信息:','openPhoneValidation','chatGroupEntity','Repository','10816519JBZaoy','getFullYear','getAccountLog','status','useModel3Count','firstRegisterSendRank','rechargeType','userEntity','getVisitorCount','getOwnPropertyDescriptor','ChatLogEntity','decorate','REG_GIFT','inheritVisitorData','length','registerSendStatus','UserEntity','LessThan','sumDrawMjCount','formatCreateOrUpdateDate','26742iPQBrf'];_0x337c=function(){return _0x12def1;};return _0x337c();}var __decorate=this&&this[_0x220de9(0x1ba)]||function(_0x4e5915,_0x593a35,_0x4f2cdc,_0x52b2d2){const _0x2825ab=_0x220de9;var _0x19caa5=arguments[_0x2825ab(0x1ad)],_0x54e672=_0x19caa5<0x3?_0x593a35:_0x52b2d2===null?_0x52b2d2=Object[_0x2825ab(0x1a8)](_0x593a35,_0x4f2cdc):_0x52b2d2,_0x5d13af;if(typeof Reflect===_0x2825ab(0x178)&&typeof Reflect[_0x2825ab(0x1aa)]===_0x2825ab(0x180))_0x54e672=Reflect['decorate'](_0x4e5915,_0x593a35,_0x4f2cdc,_0x52b2d2);else{for(var _0x215a34=_0x4e5915[_0x2825ab(0x1ad)]-0x1;_0x215a34>=0x0;_0x215a34--)if(_0x5d13af=_0x4e5915[_0x215a34])_0x54e672=(_0x19caa5<0x3?_0x5d13af(_0x54e672):_0x19caa5>0x3?_0x5d13af(_0x593a35,_0x4f2cdc,_0x54e672):_0x5d13af(_0x593a35,_0x4f2cdc))||_0x54e672;}return _0x19caa5>0x3&&_0x54e672&&Object[_0x2825ab(0x18b)](_0x593a35,_0x4f2cdc,_0x54e672),_0x54e672;},__metadata=this&&this['__metadata']||function(_0x590cca,_0x38b916){const _0x767bf0=_0x220de9;if(typeof Reflect===_0x767bf0(0x178)&&typeof Reflect[_0x767bf0(0x13c)]===_0x767bf0(0x180))return Reflect[_0x767bf0(0x13c)](_0x590cca,_0x38b916);},__param=this&&this[_0x220de9(0x1d2)]||function(_0x27668e,_0x550675){return function(_0x54a022,_0x1c79bf){_0x550675(_0x54a022,_0x1c79bf,_0x27668e);};};Object[_0x220de9(0x18b)](exports,'__esModule',{'value':!![]}),exports[_0x220de9(0x13d)]=void 0x0;function _0x19e7(_0xa00f48,_0x584321){const _0x337caa=_0x337c();return _0x19e7=function(_0x19e770,_0x370237){_0x19e770=_0x19e770-0x13c;let _0x13eb34=_0x337caa[_0x19e770];return _0x13eb34;},_0x19e7(_0xa00f48,_0x584321);}const balance_constant_1=require(_0x220de9(0x189)),utils_1=require(_0x220de9(0x198)),common_1=require('@nestjs/common'),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0x220de9(0x150)),cramiPackage_entity_1=require('../crami/cramiPackage.entity'),config_entity_1=require(_0x220de9(0x1d8)),globalConfig_service_1=require('./../globalConfig/globalConfig.service'),accountLog_entity_1=require(_0x220de9(0x196)),balance_entity_1=require(_0x220de9(0x170)),userBalance_entity_1=require('./userBalance.entity'),date_1=require('../../common/utils/date'),chatGroup_entity_1=require('../chatGroup/chatGroup.entity'),chatLog_entity_1=require(_0x220de9(0x172)),user_entity_1=require(_0x220de9(0x15b)),fingerprint_entity_1=require(_0x220de9(0x145));let UserBalanceService=class UserBalanceService{constructor(_0x40d42a,_0x38f790,_0x4eba68,_0x3bcf8a,_0x2ad07c,_0x290b85,_0x4c7f6c,_0x652ce1,_0x5ab2f6,_0x5060d2){const _0x1c2e7b=_0x220de9;this['balanceEntity']=_0x40d42a,this['userBalanceEntity']=_0x38f790,this[_0x1c2e7b(0x15d)]=_0x4eba68,this['cramiPackageEntity']=_0x3bcf8a,this[_0x1c2e7b(0x158)]=_0x2ad07c,this[_0x1c2e7b(0x1a6)]=_0x290b85,this[_0x1c2e7b(0x174)]=_0x4c7f6c,this[_0x1c2e7b(0x19d)]=_0x652ce1,this[_0x1c2e7b(0x1d9)]=_0x5ab2f6,this[_0x1c2e7b(0x160)]=_0x5060d2;}async[_0x220de9(0x1b7)](_0x34c647){const _0x6e1a43=_0x220de9;try{const _0x3878c3=await this[_0x6e1a43(0x158)][_0x6e1a43(0x1cc)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x6e1a43(0x1ae),'registerSendModel3Count',_0x6e1a43(0x163),_0x6e1a43(0x1ca),_0x6e1a43(0x14a),_0x6e1a43(0x1a4),_0x6e1a43(0x16a),'firstRregisterSendModel4Count',_0x6e1a43(0x15a)])}}),_0x662d51=_0x3878c3[_0x6e1a43(0x16b)]((_0x120bc3,_0x55807e)=>{const _0x2337f2=_0x6e1a43,_0x41ff57=Number(_0x55807e[_0x2337f2(0x1c3)]),_0x102a1a=Number[_0x2337f2(0x1de)](_0x41ff57)&&_0x41ff57>0x0?_0x41ff57:0x0;return _0x120bc3[_0x55807e['configKey']]=_0x102a1a,_0x120bc3;},{});let _0x29ff09=0x0,_0x3b16e0=0x0,_0x189f99=0x0;_0x662d51[_0x6e1a43(0x1ae)]===0x1&&(_0x29ff09=_0x29ff09+_0x662d51['registerSendModel3Count'],_0x3b16e0=_0x3b16e0+_0x662d51[_0x6e1a43(0x163)],_0x189f99=_0x189f99+_0x662d51[_0x6e1a43(0x1ca)]),_0x662d51[_0x6e1a43(0x1ae)]===0x1&&_0x662d51[_0x6e1a43(0x14a)]===0x1&&_0x34c647<=_0x662d51[_0x6e1a43(0x1a4)]&&(_0x29ff09=_0x29ff09+_0x662d51[_0x6e1a43(0x16a)],_0x3b16e0=_0x3b16e0+_0x662d51['firstRregisterSendModel4Count'],_0x189f99=_0x189f99+_0x662d51['firstRregisterSendDrawMjCount']),await this[_0x6e1a43(0x176)]({'userId':_0x34c647,'rechargeType':balance_constant_1[_0x6e1a43(0x13f)][_0x6e1a43(0x1ab)],'model3Count':_0x29ff09,'drawMjCount':_0x189f99,'model4Count':_0x3b16e0}),await this['userBalanceEntity'][_0x6e1a43(0x17e)]({'userId':_0x34c647,'model3Count':_0x29ff09,'model4Count':_0x3b16e0,'drawMjCount':_0x189f99,'useTokens':0x0});}catch(_0x45e5c6){console[_0x6e1a43(0x1b6)]('error:\x20',_0x45e5c6);throw new common_1[(_0x6e1a43(0x1c0))](_0x6e1a43(0x1da),common_1[_0x6e1a43(0x14c)]['BAD_REQUEST']);}}async['validateBalance'](_0x1ac849,_0x20dde8,_0x29f3af){const _0x4bcc3d=_0x220de9,{id:_0x4ec58c,role:_0x16ff5c}=_0x1ac849['user'];let _0x1dd83d=await this[_0x4bcc3d(0x164)][_0x4bcc3d(0x1d7)]({'where':{'userId':_0x4ec58c}});!_0x1dd83d&&(_0x1dd83d=await this[_0x4bcc3d(0x18c)](_0x4ec58c));if(_0x16ff5c===_0x4bcc3d(0x1dd))return this[_0x4bcc3d(0x1c5)](_0x1ac849,_0x20dde8,_0x29f3af);const _0x2f98e1=_0x20dde8===0x1?_0x4bcc3d(0x14e):_0x20dde8===0x2?_0x4bcc3d(0x16c):_0x20dde8===0x3?_0x4bcc3d(0x18e):null,_0x2206b6=_0x20dde8===0x1?_0x4bcc3d(0x142):_0x20dde8===0x2?_0x4bcc3d(0x13e):_0x20dde8===0x3?'drawMjCount':null;if(_0x1dd83d[_0x4bcc3d(0x161)]&&_0x1dd83d[_0x2f98e1]+_0x1dd83d[_0x2206b6]<_0x29f3af){if(_0x1dd83d[_0x2206b6]<_0x29f3af)throw new common_1[(_0x4bcc3d(0x1c0))](_0x4bcc3d(0x1be),common_1[_0x4bcc3d(0x14c)][_0x4bcc3d(0x165)]);}if(!_0x1dd83d['packageId']&&_0x1dd83d[_0x2206b6]<_0x29f3af)throw new common_1[(_0x4bcc3d(0x1c0))]('积分不足，继续体验服务，请按需选购套餐！',common_1[_0x4bcc3d(0x14c)]['PAYMENT_REQUIRED']);return _0x1dd83d;}async['validateVisitorBalance'](_0x2c77a3,_0x3a85ca,_0x56948a){const _0x48c5df=_0x220de9,{id:_0x3bf017}=_0x2c77a3[_0x48c5df(0x151)],_0x4292b7=_0x3a85ca===0x1?_0x48c5df(0x142):_0x3a85ca===0x2?_0x48c5df(0x13e):_0x3a85ca===0x3?_0x48c5df(0x14b):null,_0x18878a=new Date(),_0x672117=await this[_0x48c5df(0x174)][_0x48c5df(0x1d7)]({'where':{'fingerprint':_0x3bf017}}),{visitorModel3Num:_0x4e9b84,visitorModel4Num:_0x1a9d69,visitorMJNum:_0x3ffae2}=await this[_0x48c5df(0x160)][_0x48c5df(0x141)]([_0x48c5df(0x17a),'visitorModel4Num',_0x48c5df(0x199)]),_0x25e684={'model3Count':_0x4e9b84?Number(_0x4e9b84):0x0,'model4Count':_0x1a9d69?Number(_0x1a9d69):0x0,'drawMjCount':_0x3ffae2?Number(_0x3ffae2):0x0};if(!_0x672117){let _0x278905={'fingerprint':_0x3bf017,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0};_0x278905[_0x4292b7]=_0x278905[_0x4292b7]+_0x56948a;if(_0x278905[_0x4292b7]>_0x25e684[_0x4292b7])throw new common_1[(_0x48c5df(0x1c0))]('今日体验额度使用完毕，请注册使用完整服务！',common_1[_0x48c5df(0x14c)]['PAYMENT_REQUIRED']);else return await this[_0x48c5df(0x174)][_0x48c5df(0x17e)](_0x278905),!![];}else{const {model3Count:_0x213e89,model4Count:_0x2e3b54,drawMjCount:_0x54811c}=_0x672117;let _0x10645e={'model3Count':_0x213e89,'model4Count':_0x2e3b54,'drawMjCount':_0x54811c};const _0x55ac55=Number(new Date(_0x672117[_0x48c5df(0x1d6)])),_0x5c3472=this[_0x48c5df(0x17d)](_0x55ac55);_0x5c3472?_0x10645e[_0x4292b7]=_0x10645e[_0x4292b7]+_0x56948a:(_0x10645e={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x10645e[_0x4292b7]=_0x10645e[_0x4292b7]+_0x56948a);if(_0x10645e[_0x4292b7]>_0x25e684[_0x4292b7])throw new common_1['HttpException'](_0x48c5df(0x153),common_1[_0x48c5df(0x14c)][_0x48c5df(0x165)]);else return await this[_0x48c5df(0x174)][_0x48c5df(0x15c)]({'fingerprint':_0x3bf017},_0x10645e),!![];}}[_0x220de9(0x17d)](_0x4f569b){const _0x28c245=_0x220de9,_0xc08ed2=new Date(),_0x2faa78=new Date(_0xc08ed2[_0x28c245(0x1a0)](),_0xc08ed2['getMonth'](),_0xc08ed2[_0x28c245(0x1c8)]());return _0x4f569b>=_0x2faa78;}async[_0x220de9(0x17c)](_0x316242,_0x1466c1,_0x13de89,_0x456def=0x0){const _0x3cfc56=_0x220de9,_0xcbdd20=await this[_0x3cfc56(0x164)]['findOne']({'where':{'userId':_0x316242}});if(!_0xcbdd20)throw new common_1[(_0x3cfc56(0x1c0))]('缺失当前用户账户记录！',common_1[_0x3cfc56(0x14c)][_0x3cfc56(0x16f)]);const _0x3894d7={0x1:{'member':_0x3cfc56(0x14e),'nonMember':_0x3cfc56(0x142),'token':_0x3cfc56(0x1cd)},0x2:{'member':'memberModel4Count','nonMember':_0x3cfc56(0x13e),'token':'useModel4Token'},0x3:{'member':_0x3cfc56(0x18e),'nonMember':'drawMjCount','token':_0x3cfc56(0x190)}},{member:_0x37dd0c,nonMember:_0x545705,token:_0x40f9b5}=_0x3894d7[_0x1466c1];let _0x117163=_0x13de89,_0x410e9a=Math['max'](_0xcbdd20[_0x37dd0c]-_0x117163,0x0);_0x117163-=_0xcbdd20[_0x37dd0c]-_0x410e9a;let _0x22a1e4=_0xcbdd20[_0x545705];_0x117163>0x0&&(_0x22a1e4=Math['max'](_0xcbdd20[_0x545705]-_0x117163,0x0),_0x117163-=_0xcbdd20[_0x545705]-_0x22a1e4);const _0x16cdbb={[_0x37dd0c]:_0x410e9a,[_0x545705]:_0x22a1e4,[_0x40f9b5]:(_0xcbdd20[_0x40f9b5]||0x0)+_0x456def};(_0x40f9b5===_0x3cfc56(0x1cd)||_0x40f9b5===_0x3cfc56(0x19a))&&(_0x16cdbb[_0x40f9b5[_0x3cfc56(0x184)]('Token','Count')]=(_0xcbdd20[_0x40f9b5[_0x3cfc56(0x184)]('Token',_0x3cfc56(0x15e))]||0x0)+_0x13de89);const _0x25e050=await this[_0x3cfc56(0x164)]['update']({'userId':_0x316242},_0x16cdbb);if(_0x25e050['affected']===0x0)throw new common_1[(_0x3cfc56(0x1c0))](_0x3cfc56(0x1c2),common_1[_0x3cfc56(0x14c)]['BAD_REQUEST']);}async['queryUserBalance'](_0x14c1e8){const _0x5da418=_0x220de9;try{const _0xed81ff=await this[_0x5da418(0x164)]['findOne']({'where':{'userId':_0x14c1e8},'select':['packageId',_0x5da418(0x142),'model4Count',_0x5da418(0x14b),_0x5da418(0x14e),_0x5da418(0x16c),_0x5da418(0x18e),_0x5da418(0x1a3),_0x5da418(0x167),'useModel3Token',_0x5da418(0x19a),'useDrawMjToken',_0x5da418(0x1c6)]});if(!_0xed81ff){const _0x29ae92=await this[_0x5da418(0x18c)](_0x14c1e8);if(_0x29ae92)return await this[_0x5da418(0x162)](_0x14c1e8);else throw new common_1[(_0x5da418(0x1c0))](_0x5da418(0x181),common_1[_0x5da418(0x14c)][_0x5da418(0x16f)]);}return _0xed81ff[_0x5da418(0x1b5)]=_0xed81ff[_0x5da418(0x161)]?_0xed81ff['model3Count']+_0xed81ff[_0x5da418(0x14e)]:_0xed81ff['model3Count'],_0xed81ff['sumModel4Count']=_0xed81ff[_0x5da418(0x161)]?_0xed81ff['model4Count']+_0xed81ff['memberModel4Count']:_0xed81ff[_0x5da418(0x13e)],_0xed81ff[_0x5da418(0x1b1)]=_0xed81ff[_0x5da418(0x161)]?_0xed81ff['drawMjCount']+_0xed81ff[_0x5da418(0x18e)]:_0xed81ff[_0x5da418(0x14b)],_0xed81ff[_0x5da418(0x1c6)]=_0xed81ff['expirationTime']?(0x0,date_1[_0x5da418(0x182)])(_0xed81ff[_0x5da418(0x1c6)],'YYYY-MM-DD'):null,_0xed81ff;}catch(_0x3e8831){console['log'](_0x5da418(0x187),_0x3e8831);}}async['saveRecordRechargeLog'](_0x3fe364){const _0x2b0bba=_0x220de9,{userId:_0x129056,rechargeType:_0x4f9ee9,model3Count:_0xf34e87,model4Count:_0x5b2c14,drawMjCount:_0x1ef99a,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x3fe364;if(!_0x129056)throw new common_1[(_0x2b0bba(0x1c0))](_0x2b0bba(0x179),common_1[_0x2b0bba(0x14c)][_0x2b0bba(0x16f)]);const _0x35836e=(0x0,utils_1[_0x2b0bba(0x18a)])();return await this[_0x2b0bba(0x15d)][_0x2b0bba(0x17e)]({'userId':_0x129056,'rechargeType':_0x4f9ee9,'model3Count':_0xf34e87,'model4Count':_0x5b2c14,'drawMjCount':_0x1ef99a,'days':days,'extent':extent,'uid':_0x35836e,'pkgName':pkgName});}async[_0x220de9(0x18c)](_0x42a1d6,_0x89217f={}){const _0x1d4cee=_0x220de9,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x89217f,_0x5a14e5=await this['userBalanceEntity'][_0x1d4cee(0x1d7)]({'where':{'userId':_0x42a1d6}});if(_0x5a14e5)throw new common_1[(_0x1d4cee(0x1c0))](_0x1d4cee(0x146),common_1[_0x1d4cee(0x14c)]['BAD_REQUEST']);return await this[_0x1d4cee(0x164)][_0x1d4cee(0x17e)]({'userId':_0x42a1d6,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async[_0x220de9(0x171)](_0x8ac18f,_0x3a9de5,_0x4d4605=-0x1){const _0x46119f=_0x220de9;try{const _0xaf0af4=await this[_0x46119f(0x164)]['findOne']({'where':{'userId':_0x8ac18f}})||await this[_0x46119f(0x18c)](_0x8ac18f);if(!_0xaf0af4)throw new common_1[(_0x46119f(0x1c0))](_0x46119f(0x144),common_1[_0x46119f(0x14c)][_0x46119f(0x16f)]);const {model3Count:_0x12d9d1,model4Count:_0x363b72,drawMjCount:_0x41ac2d,memberModel3Count:_0x3c67ef,memberModel4Count:_0x3196c5,memberDrawMjCount:_0xd5b82a}=_0xaf0af4;let _0x23baa3={};if(_0x4d4605>0x0){const {packageId:_0x53b3b6}=_0x3a9de5;if(!_0x53b3b6)throw new common_1['HttpException'](_0x46119f(0x1b9),common_1[_0x46119f(0x14c)][_0x46119f(0x16f)]);const _0x50782f=await this[_0x46119f(0x1df)]['findOne']({'where':{'id':_0x53b3b6}});if(!_0x50782f)throw new common_1[(_0x46119f(0x1c0))]('当前套餐不存在！',common_1[_0x46119f(0x14c)][_0x46119f(0x16f)]);const {weight:_0x123a91}=_0x50782f;if(!_0xaf0af4[_0x46119f(0x161)])_0x23baa3={'memberModel3Count':_0x3c67ef+_0x3a9de5[_0x46119f(0x142)],'memberModel4Count':_0x3196c5+_0x3a9de5[_0x46119f(0x13e)],'memberDrawMjCount':_0xd5b82a+_0x3a9de5[_0x46119f(0x14b)],'expirationTime':(0x0,date_1[_0x46119f(0x1cb)])()[_0x46119f(0x17b)](_0x4d4605>0x0?_0x4d4605:0x0,'day')[_0x46119f(0x157)]('YYYY-MM-DD\x20HH:mm:ss'),'packageId':_0x53b3b6};else{const _0x327eea=await this[_0x46119f(0x1df)][_0x46119f(0x1d7)]({'where':{'id':_0xaf0af4[_0x46119f(0x161)]}});_0x123a91>=_0x327eea[_0x46119f(0x1ce)]&&(_0x23baa3={'memberModel3Count':_0x3c67ef+_0x3a9de5[_0x46119f(0x142)],'memberModel4Count':_0x3196c5+_0x3a9de5[_0x46119f(0x13e)],'memberDrawMjCount':_0xd5b82a+_0x3a9de5[_0x46119f(0x14b)],'expirationTime':(0x0,date_1[_0x46119f(0x1cb)])(_0xaf0af4['expirationTime'])[_0x46119f(0x17b)](_0x4d4605>0x0?_0x4d4605:0x0,_0x46119f(0x1d3))[_0x46119f(0x157)]('YYYY-MM-DD\x20HH:mm:ss'),'packageId':_0x53b3b6}),_0x123a91<_0x327eea[_0x46119f(0x1ce)]&&(_0x23baa3={'memberModel3Count':_0x3c67ef+_0x3a9de5[_0x46119f(0x142)],'memberModel4Count':_0x3196c5+_0x3a9de5[_0x46119f(0x13e)],'memberDrawMjCount':_0xd5b82a+_0x3a9de5[_0x46119f(0x14b)]});}}_0x4d4605<=0x0&&(_0x23baa3={'model3Count':_0x12d9d1+_0x3a9de5[_0x46119f(0x142)],'model4Count':_0x363b72+_0x3a9de5[_0x46119f(0x13e)],'drawMjCount':_0x41ac2d+_0x3a9de5[_0x46119f(0x14b)]});const _0x13f7c1=await this['userBalanceEntity'][_0x46119f(0x15c)]({'userId':_0x8ac18f},_0x23baa3);if(_0x13f7c1['affected']===0x0)throw new common_1[(_0x46119f(0x1c0))](_0x8ac18f+_0x46119f(0x15f),common_1[_0x46119f(0x14c)][_0x46119f(0x16f)]);}catch(_0x18b545){console[_0x46119f(0x1b6)]('error:\x20',_0x18b545);throw new common_1[(_0x46119f(0x1c0))](_0x46119f(0x1c4),common_1[_0x46119f(0x14c)]['BAD_REQUEST']);}}async['addBalanceToOrder'](_0x5197fb){const _0x5d2ebe=_0x220de9;console[_0x5d2ebe(0x1b6)](_0x5d2ebe(0x19b),_0x5197fb);try{const {userId:_0x2924f4,goodsId:_0x11203b}=_0x5197fb,_0x4ea6fe=await this[_0x5d2ebe(0x1df)]['findOne']({'where':{'id':_0x5197fb[_0x5d2ebe(0x193)],'status':0x1}});if(!_0x4ea6fe)throw new common_1[(_0x5d2ebe(0x1c0))](_0x5d2ebe(0x173),common_1[_0x5d2ebe(0x14c)]['BAD_REQUEST']);const {model3Count:_0x2c4967,model4Count:_0x321c0f,drawMjCount:_0x3a0e4b,days:_0x51b78f,name:_0x357cb4}=_0x4ea6fe,_0x14ac31={'model3Count':_0x2c4967,'model4Count':_0x321c0f,'drawMjCount':_0x3a0e4b,'days':_0x51b78f,'packageId':_0x5197fb[_0x5d2ebe(0x193)]};await this[_0x5d2ebe(0x171)](_0x2924f4,_0x14ac31,_0x51b78f),await this[_0x5d2ebe(0x176)]({'userId':_0x2924f4,'rechargeType':balance_constant_1[_0x5d2ebe(0x13f)][_0x5d2ebe(0x1bb)],'model3Count':_0x2c4967,'model4Count':_0x321c0f,'drawMjCount':_0x3a0e4b,'pkgName':_0x357cb4,'days':_0x51b78f});}catch(_0x23839a){console['log'](_0x5d2ebe(0x187),_0x23839a);throw new common_1[(_0x5d2ebe(0x1c0))](_0x5d2ebe(0x186),common_1[_0x5d2ebe(0x14c)][_0x5d2ebe(0x16f)]);}}async[_0x220de9(0x159)](_0x887ed5,_0x5b71ea){const _0x523354=_0x220de9,{page:page=0x1,size:size=0x14}=_0x5b71ea,{id:_0x34ac28}=_0x887ed5['user'],[_0x4756b1,_0x56717c]=await this[_0x523354(0x15d)][_0x523354(0x147)]({'where':{'userId':_0x34ac28},'order':{'id':_0x523354(0x16e)},'skip':(page-0x1)*size,'take':size});return _0x4756b1['forEach'](_0x2a9441=>{const _0x228378=_0x523354;_0x2a9441[_0x228378(0x177)]=_0x2a9441['days']>0x0?_0x2a9441[_0x228378(0x143)]+'天':'永久';}),{'rows':(0x0,date_1[_0x523354(0x1b2)])(_0x4756b1),'count':_0x56717c};}async[_0x220de9(0x1a1)](_0x7b6081,_0x24aaf7){const _0x389a8f=_0x220de9;try{const {page:page=0x1,size:size=0xa,userId:_0x53c2b,rechargeType:_0x4d2161,packageId:_0x5086ea}=_0x24aaf7,{role:_0x45c0c2}=_0x7b6081[_0x389a8f(0x151)],_0x51a763={};_0x4d2161&&(_0x51a763[_0x389a8f(0x1a5)]=_0x4d2161),_0x51a763[_0x389a8f(0x1b4)]=_0x53c2b||(0x0,typeorm_2[_0x389a8f(0x1b0)])(0x186a0),_0x5086ea&&(_0x51a763[_0x389a8f(0x161)]={'$like':'%'+_0x5086ea+'%'});const [_0x1b058d,_0x287669]=await this[_0x389a8f(0x15d)][_0x389a8f(0x147)]({'where':_0x51a763,'order':{'id':_0x389a8f(0x16e)},'skip':(page-0x1)*size,'take':size}),_0x402018=_0x1b058d[_0x389a8f(0x1dc)](_0x400951=>_0x400951[_0x389a8f(0x1b4)]),_0x3f1c58=await this[_0x389a8f(0x1a6)][_0x389a8f(0x1cc)]({'where':{'id':(0x0,typeorm_2['In'])(_0x402018)}});return _0x1b058d['forEach'](_0x16acd4=>{const _0x1707c5=_0x389a8f,_0xec704d=_0x3f1c58[_0x1707c5(0x1cc)](_0x43b7f8=>_0x43b7f8['id']===_0x16acd4[_0x1707c5(0x1b4)]);_0x16acd4[_0x1707c5(0x183)]=_0xec704d===null||_0xec704d===void 0x0?void 0x0:_0xec704d[_0x1707c5(0x183)],_0x16acd4['email']=_0xec704d===null||_0xec704d===void 0x0?void 0x0:_0xec704d[_0x1707c5(0x1d4)],_0x16acd4['phone']=_0xec704d===null||_0xec704d===void 0x0?void 0x0:_0xec704d[_0x1707c5(0x148)],_0x16acd4['status']=_0xec704d===null||_0xec704d===void 0x0?void 0x0:_0xec704d[_0x1707c5(0x1a2)],_0x16acd4['avatar']=_0xec704d===null||_0xec704d===void 0x0?void 0x0:_0xec704d['avatar'];}),_0x45c0c2!=='super'&&_0x1b058d[_0x389a8f(0x1d0)](_0x356014=>{const _0x536fa2=_0x389a8f;_0x356014[_0x536fa2(0x1d4)]=_0x356014[_0x536fa2(0x1d4)]?(0x0,utils_1[_0x536fa2(0x197)])(_0x356014[_0x536fa2(0x1d4)]):'',_0x356014[_0x536fa2(0x148)]=_0x356014['phone']?(0x0,utils_1[_0x536fa2(0x197)])(_0x356014[_0x536fa2(0x148)]):'';}),{'rows':_0x1b058d,'count':_0x287669};}catch(_0x4027d2){console[_0x389a8f(0x1b6)](_0x389a8f(0x187),_0x4027d2);throw new common_1[(_0x389a8f(0x1c0))](_0x389a8f(0x18f),common_1['HttpStatus'][_0x389a8f(0x16f)]);}}async[_0x220de9(0x155)](_0x5e88e2){const _0x21f300=_0x220de9;return await this[_0x21f300(0x164)][_0x21f300(0x1cc)]({'where':{'userId':(0x0,typeorm_2['In'])(_0x5e88e2)}});}async['refundMjBalance'](_0x5895bb,_0x1aed2c){const _0x363d0f=_0x220de9;return await this[_0x363d0f(0x17c)](_0x5895bb,_0x363d0f(0x18d),-_0x1aed2c);}async[_0x220de9(0x1ac)](_0x58242a){const _0x3fdb57=_0x220de9,{fingerprint:_0x38defd}=_0x58242a[_0x3fdb57(0x1db)],{id:_0x562cd7}=_0x58242a[_0x3fdb57(0x151)];return await this[_0x3fdb57(0x1d9)][_0x3fdb57(0x15c)]({'userId':Number(_0x38defd)},{'userId':_0x562cd7}),await this['chatGroupEntity'][_0x3fdb57(0x15c)]({'userId':Number(_0x38defd)},{'userId':_0x562cd7}),0x1;}async[_0x220de9(0x1a7)](_0x454686){const _0x31a0b9=_0x220de9,{fingerprint:_0x1caf50}=_0x454686['headers'],_0x29cb60=await this['chatLogEntity'][_0x31a0b9(0x1d1)]({'where':{'userId':_0x1caf50}}),_0x341d70=await this[_0x31a0b9(0x19d)]['count']({'where':{'userId':_0x1caf50}});return _0x29cb60||_0x341d70||0x0;}async[_0x220de9(0x175)](_0x1dcbf4){const _0x251550=_0x220de9,_0x1a1676=await this[_0x251550(0x1a6)]['findOne']({'where':{'id':_0x1dcbf4}}),_0x243cde=await this[_0x251550(0x164)]['findOne']({'where':{'userId':_0x1dcbf4}});if(!_0x1a1676||!_0x243cde)return;const {phoneValidationMessageCount:_0x2a2f1d,identityVerificationMessageCount:_0x19ece3,openIdentity:_0x232af2,openPhoneValidation:_0x101b75}=await this[_0x251550(0x160)][_0x251550(0x141)]([_0x251550(0x1cf),_0x251550(0x192),_0x251550(0x14f),_0x251550(0x19c)]),_0x20e3ce=Number(_0x2a2f1d),_0x70bb02=Number(_0x19ece3),_0x351947=Number(_0x243cde[_0x251550(0x1a3)])||0x0,_0x5af9a5=Number(_0x243cde[_0x251550(0x167)])||0x0,_0x4758b3=_0x351947+_0x5af9a5;if(_0x101b75==='1'&&_0x4758b3>=_0x20e3ce&&!_0x1a1676[_0x251550(0x148)])throw new common_1[(_0x251550(0x1c0))](_0x251550(0x1c1),common_1[_0x251550(0x14c)][_0x251550(0x16f)]);if(_0x232af2==='1'&&_0x4758b3>=_0x70bb02&&(!_0x1a1676[_0x251550(0x14d)]||!_0x1a1676['idCard']))throw new common_1[(_0x251550(0x1c0))](_0x251550(0x1c9),common_1['HttpStatus'][_0x251550(0x16f)]);}};UserBalanceService=__decorate([(0x0,common_1[_0x220de9(0x149)])(),__param(0x0,(0x0,typeorm_1[_0x220de9(0x169)])(balance_entity_1[_0x220de9(0x194)])),__param(0x1,(0x0,typeorm_1[_0x220de9(0x169)])(userBalance_entity_1[_0x220de9(0x195)])),__param(0x2,(0x0,typeorm_1[_0x220de9(0x169)])(accountLog_entity_1[_0x220de9(0x17f)])),__param(0x3,(0x0,typeorm_1['InjectRepository'])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x4,(0x0,typeorm_1['InjectRepository'])(config_entity_1[_0x220de9(0x185)])),__param(0x5,(0x0,typeorm_1[_0x220de9(0x169)])(user_entity_1[_0x220de9(0x1af)])),__param(0x6,(0x0,typeorm_1['InjectRepository'])(fingerprint_entity_1[_0x220de9(0x1b8)])),__param(0x7,(0x0,typeorm_1[_0x220de9(0x169)])(chatGroup_entity_1[_0x220de9(0x140)])),__param(0x8,(0x0,typeorm_1[_0x220de9(0x169)])(chatLog_entity_1[_0x220de9(0x1a9)])),__metadata(_0x220de9(0x1d5),[typeorm_2['Repository'],typeorm_2[_0x220de9(0x19e)],typeorm_2[_0x220de9(0x19e)],typeorm_2[_0x220de9(0x19e)],typeorm_2[_0x220de9(0x19e)],typeorm_2['Repository'],typeorm_2[_0x220de9(0x19e)],typeorm_2[_0x220de9(0x19e)],typeorm_2[_0x220de9(0x19e)],globalConfig_service_1[_0x220de9(0x1bd)]])],UserBalanceService),exports['UserBalanceService']=UserBalanceService;