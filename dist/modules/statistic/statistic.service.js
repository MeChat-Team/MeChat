'use strict';function _0x1060(){const _0x5caf89=['getCount','user','HttpException','1188jyYYmu','user.createdAt\x20<\x20:tomorrow','getBaiduStatistics','Access\x20token\x20invalid\x20or\x20no\x20longer\x20valid','3055ElPwyn','orderEntity','http://openapi.baidu.com/oauth/2.0/token?grant_type=refresh_token&refresh_token=','66042KetfRC','message','baiduSiteId','15980180jbgyRh','countNewUsersToday','chatLogEntity','getDate','Repository','590215HARmyB','获取新\x20accessToken','__decorate','BAD_REQUEST','60949aifqhk','GlobalConfigService','../../common/utils/date','&metrics=','352TdkHct','countChatsByTimeRange','5666967MaHheA','metadata','chatlog.type\x20=\x20:type','push','axios','refresh_token','&method=','DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','result','baiduToken','overview/getTimeTrendRpt','function','order.createdAt\x20>=\x20:today','ChatType','chatLog.type\x20=\x20:type','where','YYYYMMDD','groupBy','No\x20response\x20data','&client_secret=','&client_id=','countDrawsByTimeRange','length','select','error_code','configEntity','2853024RCmPDA','baiduRefreshToken','NORMAL_CHAT','get','defineProperty','countNewOrdersToday','pv_count,visitor_count,ip_count,bounce_ratio,avg_visit_time','getTime','chatLog.createdAt\x20<\x20:tomorrow','countUsers','countNewDrawsToday','__param','updateAccessTokenInDatabase','../order/order.entity','log','__esModule','date','getBaiduVisit','count','getOwnPropertyDescriptor','getRawMany','stack','chatlog','chatLog.createdAt\x20>=\x20:today','@nestjs/typeorm','HttpStatus','countChats','globalConfigService','value','countNewChatsToday','baiduApiKey','data','orderBy','access_token','countDraws','update','UserEntity','getConfigs','OrderEntity','andWhere','M.DD','../../common/constants/balance.constant','StatisticService','InjectRepository','39PxKDzv','getNewAccessToken','error','user.createdAt\x20>=\x20:today','&site_id=','countOrders','Injectable','createQueryBuilder','chatlog.createdAt\x20>=\x20:startDate','response','获取新\x20accessToken\x20失败','default','chatLog','Logger','setHours','&end_date=','获取百度统计数据失败','ConfigEntity','setDate','__metadata','map','&start_date=','userEntity','object','../chatLog/chatLog.entity','PAINT','baiduSecretKey','decorate','typeorm','Failed\x20to\x20get\x20new\x20access\x20token','design:paramtypes','formatDate'];_0x1060=function(){return _0x5caf89;};return _0x1060();}const _0x54dfb7=_0x58e0;(function(_0x296033,_0x1d0c4f){const _0x9194a5=_0x58e0,_0x2f78fe=_0x296033();while(!![]){try{const _0x43c054=parseInt(_0x9194a5(0x143))/0x1+parseInt(_0x9194a5(0x13b))/0x2*(parseInt(_0x9194a5(0x111))/0x3)+parseInt(_0x9194a5(0x134))/0x4*(parseInt(_0x9194a5(0x138))/0x5)+parseInt(_0x9194a5(0x167))/0x6+-parseInt(_0x9194a5(0x147))/0x7*(parseInt(_0x9194a5(0x14b))/0x8)+parseInt(_0x9194a5(0x14d))/0x9+-parseInt(_0x9194a5(0x13e))/0xa;if(_0x43c054===_0x1d0c4f)break;else _0x2f78fe['push'](_0x2f78fe['shift']());}catch(_0x5b8ead){_0x2f78fe['push'](_0x2f78fe['shift']());}}}(_0x1060,0x4f584));var __decorate=this&&this[_0x54dfb7(0x145)]||function(_0xe740ea,_0x35fec4,_0x37845a,_0x5d623a){const _0x44e772=_0x54dfb7;var _0x111e5d=arguments[_0x44e772(0x163)],_0x1329e8=_0x111e5d<0x3?_0x35fec4:_0x5d623a===null?_0x5d623a=Object[_0x44e772(0xf8)](_0x35fec4,_0x37845a):_0x5d623a,_0x2dcc52;if(typeof Reflect===_0x44e772(0x128)&&typeof Reflect[_0x44e772(0x12c)]===_0x44e772(0x158))_0x1329e8=Reflect[_0x44e772(0x12c)](_0xe740ea,_0x35fec4,_0x37845a,_0x5d623a);else{for(var _0x445ab9=_0xe740ea[_0x44e772(0x163)]-0x1;_0x445ab9>=0x0;_0x445ab9--)if(_0x2dcc52=_0xe740ea[_0x445ab9])_0x1329e8=(_0x111e5d<0x3?_0x2dcc52(_0x1329e8):_0x111e5d>0x3?_0x2dcc52(_0x35fec4,_0x37845a,_0x1329e8):_0x2dcc52(_0x35fec4,_0x37845a))||_0x1329e8;}return _0x111e5d>0x3&&_0x1329e8&&Object['defineProperty'](_0x35fec4,_0x37845a,_0x1329e8),_0x1329e8;},__metadata=this&&this[_0x54dfb7(0x124)]||function(_0xae6110,_0x43729d){const _0x273760=_0x54dfb7;if(typeof Reflect===_0x273760(0x128)&&typeof Reflect[_0x273760(0x14e)]==='function')return Reflect[_0x273760(0x14e)](_0xae6110,_0x43729d);},__param=this&&this[_0x54dfb7(0xf0)]||function(_0x429249,_0x1b6707){return function(_0x2894b2,_0x424fc1){_0x1b6707(_0x2894b2,_0x424fc1,_0x429249);};};Object[_0x54dfb7(0xe9)](exports,_0x54dfb7(0xf4),{'value':!![]}),exports[_0x54dfb7(0x10f)]=void 0x0;const balance_constant_1=require(_0x54dfb7(0x10e)),date_1=require(_0x54dfb7(0x149)),common_1=require('@nestjs/common'),typeorm_1=require(_0x54dfb7(0xfd)),axios_1=require(_0x54dfb7(0x151)),typeorm_2=require(_0x54dfb7(0x12d)),chatLog_entity_1=require(_0x54dfb7(0x129)),config_entity_1=require('../globalConfig/config.entity'),globalConfig_service_1=require('../globalConfig/globalConfig.service'),order_entity_1=require(_0x54dfb7(0xf2)),user_entity_1=require('../user/user.entity');function _0x58e0(_0x27eead,_0x3e820d){const _0x106053=_0x1060();return _0x58e0=function(_0x58e0ec,_0x85b698){_0x58e0ec=_0x58e0ec-0xe7;let _0x5d5229=_0x106053[_0x58e0ec];return _0x5d5229;},_0x58e0(_0x27eead,_0x3e820d);}let StatisticService=class StatisticService{constructor(_0x3e51dd,_0x560a7a,_0xa15794,_0x288535,_0x1255c6){const _0x51cfcf=_0x54dfb7;this[_0x51cfcf(0x127)]=_0x3e51dd,this['chatLogEntity']=_0x560a7a,this[_0x51cfcf(0x166)]=_0xa15794,this[_0x51cfcf(0x139)]=_0x288535,this[_0x51cfcf(0x100)]=_0x1255c6;}async['getBaseStatistic'](){const _0x2dcdc6=_0x54dfb7,_0x359b7e=await this[_0x2dcdc6(0xee)](),_0x5c6110=await this['countNewUsersToday'](),_0x370058=await this['countChats'](),_0x392e33=await this[_0x2dcdc6(0x102)](),_0x1e45a3=await this[_0x2dcdc6(0x107)](),_0x162d66=await this['countNewDrawsToday'](),_0x39771b=await this[_0x2dcdc6(0x116)](),_0x1fdcf1=await this[_0x2dcdc6(0xea)]();return{'userCount':_0x359b7e,'newUserCount':_0x5c6110,'chatCount':_0x370058,'newChatCount':_0x392e33,'drawCount':_0x1e45a3,'newDrawCount':_0x162d66,'orderCount':_0x39771b,'newOrderCount':_0x1fdcf1};}async['getChatStatistic']({days:days=0x7}){const _0x19b143=_0x54dfb7,_0x45292f=await this[_0x19b143(0x14c)](days),_0x307635=await this[_0x19b143(0x162)](days);return{'date':_0x45292f[_0x19b143(0x125)](_0x36c513=>_0x36c513[_0x19b143(0xf5)]),'chat':_0x45292f[_0x19b143(0x125)](_0x51b2eb=>_0x51b2eb[_0x19b143(0x101)]),'draw':_0x307635[_0x19b143(0x125)]((_0x38d0da,_0x342ad5)=>{return _0x38d0da['value'];})};}async[_0x54dfb7(0xf6)]({days:days=0x7}){const _0x1b3c53=await this['getBaiduStatistics'](days);return _0x1b3c53;}async[_0x54dfb7(0xee)](){const _0x4af93d=_0x54dfb7,_0x59f262=await this[_0x4af93d(0x127)][_0x4af93d(0xf7)]();return _0x59f262;}async[_0x54dfb7(0x13f)](){const _0x38914f=_0x54dfb7,_0x1a71ad=new Date();_0x1a71ad['setHours'](0x0,0x0,0x0,0x0);const _0x5a5f01=new Date(_0x1a71ad['getTime']()+0x18*0x3c*0x3c*0x3e8),_0x5254ff=this[_0x38914f(0x127)][_0x38914f(0x118)](_0x38914f(0x132)),_0xeaa574=await _0x5254ff[_0x38914f(0x15c)](_0x38914f(0x114),{'today':_0x1a71ad})['andWhere'](_0x38914f(0x135),{'tomorrow':_0x5a5f01})[_0x38914f(0x131)]();return _0xeaa574;}async[_0x54dfb7(0xff)](){const _0x13bab6=_0x54dfb7,_0x26f629=await this[_0x13bab6(0x140)][_0x13bab6(0xf7)]({'where':{'type':balance_constant_1['ChatType']['NORMAL_CHAT']}});return _0x26f629;}async[_0x54dfb7(0x102)](){const _0x62326c=_0x54dfb7,_0x5ea663=new Date();_0x5ea663[_0x62326c(0x11f)](0x0,0x0,0x0,0x0);const _0x22b5a3=new Date(_0x5ea663['getTime']()+0x18*0x3c*0x3c*0x3e8),_0x4f474e=this[_0x62326c(0x140)][_0x62326c(0x118)](_0x62326c(0x11d)),_0x5bf84a=await _0x4f474e[_0x62326c(0x15c)](_0x62326c(0x15b),{'type':balance_constant_1[_0x62326c(0x15a)][_0x62326c(0xe7)]})[_0x62326c(0x10c)](_0x62326c(0xfc),{'today':_0x5ea663})[_0x62326c(0x10c)]('chatLog.createdAt\x20<\x20:tomorrow',{'tomorrow':_0x22b5a3})[_0x62326c(0x131)]();return _0x5bf84a;}async[_0x54dfb7(0x107)](){const _0x45c5bf=_0x54dfb7,_0x51f101=await this[_0x45c5bf(0x140)]['count']({'where':{'type':balance_constant_1[_0x45c5bf(0x15a)][_0x45c5bf(0x12a)]}});return _0x51f101;}async[_0x54dfb7(0xef)](){const _0x4521b1=_0x54dfb7,_0x1aa4d5=new Date();_0x1aa4d5[_0x4521b1(0x11f)](0x0,0x0,0x0,0x0);const _0x3b99b2=new Date(_0x1aa4d5[_0x4521b1(0xec)]()+0x18*0x3c*0x3c*0x3e8),_0x2cf454=this['chatLogEntity']['createQueryBuilder']('chatLog'),_0x4b0978=await _0x2cf454['where'](_0x4521b1(0x15b),{'type':balance_constant_1[_0x4521b1(0x15a)][_0x4521b1(0x12a)]})[_0x4521b1(0x10c)](_0x4521b1(0xfc),{'today':_0x1aa4d5})[_0x4521b1(0x10c)](_0x4521b1(0xed),{'tomorrow':_0x3b99b2})[_0x4521b1(0x131)]();return _0x4b0978;}async[_0x54dfb7(0x14c)](_0x56eab0){const _0x121588=_0x54dfb7;var _0x5b0bf9,_0x1fb7d9;const _0x49c84b=new Date();_0x49c84b[_0x121588(0x11f)](0x0,0x0,0x0,0x0);const _0x21ed7f=new Date(_0x49c84b[_0x121588(0xec)]()-(_0x56eab0-0x1)*0x18*0x3c*0x3c*0x3e8),_0xd095ef=this['chatLogEntity'][_0x121588(0x118)](_0x121588(0xfb)),_0xa35173=await _0xd095ef[_0x121588(0x164)]('DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count')[_0x121588(0x15c)](_0x121588(0x14f),{'type':balance_constant_1[_0x121588(0x15a)][_0x121588(0xe7)]})[_0x121588(0x10c)](_0x121588(0x119),{'startDate':_0x21ed7f})[_0x121588(0x15e)]('date')[_0x121588(0x105)](_0x121588(0xf5))[_0x121588(0xf9)](),_0x2be211=[],_0x726d0b=_0x21ed7f;for(let _0x406f98=0x0;_0x406f98<_0x56eab0;_0x406f98++){const _0x87a3ac=(0x0,date_1[_0x121588(0x130)])(new Date(_0x726d0b),_0x121588(0x10d)),_0xfeda8c=(_0x1fb7d9=(_0x5b0bf9=_0xa35173['find'](_0x4186bd=>(0x0,date_1[_0x121588(0x130)])(new Date(_0x4186bd[_0x121588(0xf5)]),_0x121588(0x10d))===_0x87a3ac))===null||_0x5b0bf9===void 0x0?void 0x0:_0x5b0bf9['count'])!==null&&_0x1fb7d9!==void 0x0?_0x1fb7d9:0x0;_0xfeda8c>0x0?_0x2be211['push']({'date':_0x87a3ac,'value':Number(_0xfeda8c)}):_0x2be211['push']({'date':_0x87a3ac,'value':0x0}),_0x726d0b[_0x121588(0x123)](_0x726d0b[_0x121588(0x141)]()+0x1);}return _0x2be211;}async[_0x54dfb7(0x162)](_0x597509){const _0x27774a=_0x54dfb7;var _0x518928,_0x4142b2;const _0x3b9a87=new Date();_0x3b9a87[_0x27774a(0x11f)](0x0,0x0,0x0,0x0);const _0x29cb0e=new Date(_0x3b9a87['getTime']()-(_0x597509-0x1)*0x18*0x3c*0x3c*0x3e8),_0xe00711=this[_0x27774a(0x140)][_0x27774a(0x118)](_0x27774a(0xfb)),_0x376d7f=await _0xe00711[_0x27774a(0x164)](_0x27774a(0x154))['where']('chatlog.type\x20=\x20:type',{'type':balance_constant_1['ChatType'][_0x27774a(0x12a)]})[_0x27774a(0x10c)](_0x27774a(0x119),{'startDate':_0x29cb0e})[_0x27774a(0x15e)]('date')[_0x27774a(0x105)]('date')['getRawMany'](),_0x51deb5=[],_0x50abc5=_0x29cb0e;for(let _0x4823b1=0x0;_0x4823b1<_0x597509;_0x4823b1++){const _0x256fc6=(0x0,date_1[_0x27774a(0x130)])(new Date(_0x50abc5),_0x27774a(0x10d)),_0x3974c7=(_0x4142b2=(_0x518928=_0x376d7f['find'](_0xd21988=>(0x0,date_1[_0x27774a(0x130)])(new Date(_0xd21988['date']),_0x27774a(0x10d))===_0x256fc6))===null||_0x518928===void 0x0?void 0x0:_0x518928[_0x27774a(0xf7)])!==null&&_0x4142b2!==void 0x0?_0x4142b2:0x0;_0x3974c7>0x0?_0x51deb5[_0x27774a(0x150)]({'date':_0x256fc6,'value':Number(_0x3974c7)}):_0x51deb5['push']({'date':_0x256fc6,'value':0x0}),_0x50abc5['setDate'](_0x50abc5[_0x27774a(0x141)]()+0x1);}return _0x51deb5;}async[_0x54dfb7(0x112)](_0x5767e6,_0x2fc29c,_0x5f24c4){const _0x5a844b=_0x54dfb7,_0x46524b=_0x5a844b(0x13a)+_0x5f24c4+_0x5a844b(0x161)+_0x5767e6+_0x5a844b(0x160)+_0x2fc29c;common_1[_0x5a844b(0x11e)][_0x5a844b(0xf3)](_0x5a844b(0x144),_0x46524b);try{const _0x5b7398=await axios_1['default'][_0x5a844b(0xe8)](_0x46524b);if(_0x5b7398['status']===0xc8&&_0x5b7398[_0x5a844b(0x104)][_0x5a844b(0x106)])return{'accessToken':_0x5b7398[_0x5a844b(0x104)][_0x5a844b(0x106)],'refreshToken':_0x5b7398[_0x5a844b(0x104)][_0x5a844b(0x152)]};else throw new Error(_0x5a844b(0x12e));}catch(_0x465cdd){common_1[_0x5a844b(0x11e)][_0x5a844b(0x113)](_0x5a844b(0x11b),{'message':_0x465cdd[_0x5a844b(0x13c)],'stack':_0x465cdd[_0x5a844b(0xfa)],'response':_0x465cdd[_0x5a844b(0x11a)]?_0x465cdd[_0x5a844b(0x11a)][_0x5a844b(0x104)]:_0x5a844b(0x15f)});throw new common_1[(_0x5a844b(0x133))]('获取新\x20accessToken\x20失败',common_1[_0x5a844b(0xfe)][_0x5a844b(0x146)]);}}async['updateAccessTokenInDatabase'](_0x53f6c8,_0x5c8e1e,_0x459ab3){const _0x27e2b9=_0x54dfb7;await _0x459ab3[_0x27e2b9(0x108)]({'configKey':'baiduToken'},{'configVal':_0x53f6c8}),await _0x459ab3[_0x27e2b9(0x108)]({'configKey':_0x27e2b9(0x168)},{'configVal':_0x5c8e1e});}async[_0x54dfb7(0x136)](_0x4aa8c2){const _0x41a721=_0x54dfb7,_0x13d2f9=(0x0,date_1[_0x41a721(0x130)])(new Date(),_0x41a721(0x15d)),_0x2449fb=(0x0,date_1['formatDate'])(new Date(Date['now']()-Number(_0x4aa8c2-0x1)*0x18*0x3c*0x3c*0x3e8),_0x41a721(0x15d)),_0x143873=_0x41a721(0xeb),_0x2c9fad=_0x41a721(0x157),{baiduToken:_0x1bd311,baiduSiteId:_0x42f38f,baiduApiKey:_0x4945d8,baiduSecretKey:_0x2cb8f0,baiduRefreshToken:_0x550bd6}=await this['globalConfigService'][_0x41a721(0x10a)]([_0x41a721(0x156),_0x41a721(0x13d),_0x41a721(0x103),_0x41a721(0x12b),_0x41a721(0x168)]);if(!_0x4945d8||!_0x42f38f||!_0x550bd6||!_0x2cb8f0)return[];let _0x57e06f=_0x1bd311,_0x4b2187,_0x4e6406;const _0x1d64f9=async _0x222bdc=>{const _0x33e229=_0x41a721;_0x4e6406='https://openapi.baidu.com/rest/2.0/tongji/report/getData?access_token='+_0x222bdc+_0x33e229(0x115)+_0x42f38f+_0x33e229(0x153)+_0x2c9fad+_0x33e229(0x126)+_0x2449fb+_0x33e229(0x120)+_0x13d2f9+_0x33e229(0x14a)+_0x143873;try{return await axios_1[_0x33e229(0x11c)][_0x33e229(0xe8)](_0x4e6406);}catch(_0x3275d3){return{'data':{'error_code':0x6f,'message':_0x33e229(0x137)}};}};_0x4b2187=await _0x1d64f9(_0x57e06f);if(_0x4b2187['data'][_0x41a721(0x165)]===0x6f||!_0x1bd311){const {accessToken:_0x50a5c6,refreshToken:_0xa78552}=await this[_0x41a721(0x112)](_0x4945d8,_0x2cb8f0,_0x550bd6);_0x57e06f=_0x50a5c6,await this[_0x41a721(0xf1)](_0x57e06f,_0xa78552,this['configEntity']),_0x4b2187=await _0x1d64f9(_0x57e06f);}const {error_code:_0x5dea24,message:_0x28049c}=_0x4b2187[_0x41a721(0x104)];if(_0x5dea24&&_0x5dea24!==0xc8)throw new common_1[(_0x41a721(0x133))](_0x28049c||_0x41a721(0x121),common_1[_0x41a721(0xfe)][_0x41a721(0x146)]);return _0x4b2187[_0x41a721(0x104)][_0x41a721(0x155)];}async['countOrders'](){const _0x3b1505=_0x54dfb7,_0x2bd0c7=await this[_0x3b1505(0x139)][_0x3b1505(0xf7)]();return _0x2bd0c7;}async[_0x54dfb7(0xea)](){const _0x347e7f=_0x54dfb7,_0x313ad9=new Date();_0x313ad9[_0x347e7f(0x11f)](0x0,0x0,0x0,0x0);const _0x189b5e=new Date(_0x313ad9[_0x347e7f(0xec)]()+0x18*0x3c*0x3c*0x3e8),_0x54870b=this[_0x347e7f(0x139)][_0x347e7f(0x118)]('order'),_0x350b06=await _0x54870b['where'](_0x347e7f(0x159),{'today':_0x313ad9})[_0x347e7f(0x10c)]('order.createdAt\x20<\x20:tomorrow',{'tomorrow':_0x189b5e})[_0x347e7f(0x131)]();return _0x350b06;}};StatisticService=__decorate([(0x0,common_1[_0x54dfb7(0x117)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x54dfb7(0x109)])),__param(0x1,(0x0,typeorm_1[_0x54dfb7(0x110)])(chatLog_entity_1['ChatLogEntity'])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(config_entity_1[_0x54dfb7(0x122)])),__param(0x3,(0x0,typeorm_1[_0x54dfb7(0x110)])(order_entity_1[_0x54dfb7(0x10b)])),__metadata(_0x54dfb7(0x12f),[typeorm_2['Repository'],typeorm_2[_0x54dfb7(0x142)],typeorm_2['Repository'],typeorm_2['Repository'],globalConfig_service_1[_0x54dfb7(0x148)]])],StatisticService),exports['StatisticService']=StatisticService;