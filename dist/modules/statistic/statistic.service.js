'use strict';function _0x54cb(_0x4fda39,_0x1ecd90){const _0x4aa358=_0x4aa3();return _0x54cb=function(_0x54cbfd,_0x1df18d){_0x54cbfd=_0x54cbfd-0x95;let _0x12cd5e=_0x4aa358[_0x54cbfd];return _0x12cd5e;},_0x54cb(_0x4fda39,_0x1ecd90);}const _0x3c10f4=_0x54cb;function _0x4aa3(){const _0x607580=['HttpException','911349wVtGgB','error','55pWLpOB','user.createdAt\x20<\x20:tomorrow','InjectRepository','getBaiduStatistics','YYYYMMDD','1648eWhquG','https://openapi.baidu.com/rest/2.0/tongji/report/getData?access_token=','403502NssBhE','baiduSecretKey','baiduToken','updateAccessTokenInDatabase','&client_secret=','ChatType','BAD_REQUEST','userEntity','getRawMany','&start_date=','获取百度统计数据失败','ConfigEntity','getOwnPropertyDescriptor','&client_id=','order','order.createdAt\x20>=\x20:today','orderBy','setDate','HttpStatus','GlobalConfigService','550403JJUkxo','design:paramtypes','access_token','overview/getTimeTrendRpt','&site_id=','@nestjs/common','getNewAccessToken','../order/order.entity','664900VjhJWk','__param','createQueryBuilder','chatLogEntity','获取新\x20accessToken','getBaiduVisit','OrderEntity','@nestjs/typeorm','function','chatlog','decorate','value','object','user','baiduRefreshToken','metadata','error_code','configEntity','ChatLogEntity','6HgQdYr','pv_count,visitor_count,ip_count,bounce_ratio,avg_visit_time','date','baiduSiteId','chatlog.createdAt\x20>=\x20:startDate','1378PHKVzC','StatisticService','&end_date=','where','default','response','countChats','order.createdAt\x20<\x20:tomorrow','baiduApiKey','length','1572vVBjzE','DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','24QtZEuq','chatLog.createdAt\x20<\x20:tomorrow','map','result','Injectable','../../common/constants/balance.constant','countDrawsByTimeRange','11676SIUhjQ','get','Logger','groupBy','countDraws','countOrders','count','Repository','../globalConfig/globalConfig.service','find','&metrics=','countNewUsersToday','select','NORMAL_CHAT','globalConfigService','获取新\x20accessToken\x20失败','message','__metadata','countNewDrawsToday','setHours','countChatsByTimeRange','push','chatLog','refresh_token','../globalConfig/config.entity','orderEntity','getTime','2cKujeD','chatlog.type\x20=\x20:type','update','getDate','PAINT','2678770gEsTzZ','Access\x20token\x20invalid\x20or\x20no\x20longer\x20valid','../chatLog/chatLog.entity','No\x20response\x20data','chatLog.type\x20=\x20:type','andWhere','countUsers','getConfigs','__esModule','../user/user.entity','countNewChatsToday','chatLog.createdAt\x20>=\x20:today','M.DD','formatDate','data','getCount'];_0x4aa3=function(){return _0x607580;};return _0x4aa3();}(function(_0x32b12d,_0x2d9f07){const _0x3b92b0=_0x54cb,_0x20e19f=_0x32b12d();while(!![]){try{const _0x3fc77c=-parseInt(_0x3b92b0(0xb9))/0x1*(-parseInt(_0x3b92b0(0xd8))/0x2)+-parseInt(_0x3b92b0(0x95))/0x3*(parseInt(_0x3b92b0(0xd6))/0x4)+parseInt(_0x3b92b0(0xbe))/0x5*(parseInt(_0x3b92b0(0x107))/0x6)+parseInt(_0x3b92b0(0xec))/0x7*(-parseInt(_0x3b92b0(0x97))/0x8)+parseInt(_0x3b92b0(0xcf))/0x9+parseInt(_0x3b92b0(0xf4))/0xa*(-parseInt(_0x3b92b0(0xd1))/0xb)+-parseInt(_0x3b92b0(0x9e))/0xc*(-parseInt(_0x3b92b0(0x10c))/0xd);if(_0x3fc77c===_0x2d9f07)break;else _0x20e19f['push'](_0x20e19f['shift']());}catch(_0x41189f){_0x20e19f['push'](_0x20e19f['shift']());}}}(_0x4aa3,0x57c06));var __decorate=this&&this['__decorate']||function(_0x1ede1d,_0x3a7677,_0x190596,_0x5442ab){const _0x5c80f8=_0x54cb;var _0x3ad79a=arguments['length'],_0x497aff=_0x3ad79a<0x3?_0x3a7677:_0x5442ab===null?_0x5442ab=Object[_0x5c80f8(0xe4)](_0x3a7677,_0x190596):_0x5442ab,_0x233ca2;if(typeof Reflect==='object'&&typeof Reflect[_0x5c80f8(0xfe)]==='function')_0x497aff=Reflect[_0x5c80f8(0xfe)](_0x1ede1d,_0x3a7677,_0x190596,_0x5442ab);else{for(var _0x19917a=_0x1ede1d[_0x5c80f8(0x115)]-0x1;_0x19917a>=0x0;_0x19917a--)if(_0x233ca2=_0x1ede1d[_0x19917a])_0x497aff=(_0x3ad79a<0x3?_0x233ca2(_0x497aff):_0x3ad79a>0x3?_0x233ca2(_0x3a7677,_0x190596,_0x497aff):_0x233ca2(_0x3a7677,_0x190596))||_0x497aff;}return _0x3ad79a>0x3&&_0x497aff&&Object['defineProperty'](_0x3a7677,_0x190596,_0x497aff),_0x497aff;},__metadata=this&&this[_0x3c10f4(0xaf)]||function(_0x228312,_0x259006){const _0x2d9dce=_0x3c10f4;if(typeof Reflect===_0x2d9dce(0x100)&&typeof Reflect[_0x2d9dce(0x103)]===_0x2d9dce(0xfc))return Reflect[_0x2d9dce(0x103)](_0x228312,_0x259006);},__param=this&&this[_0x3c10f4(0xf5)]||function(_0x396501,_0x3f5708){return function(_0x3551b7,_0xcda03a){_0x3f5708(_0x3551b7,_0xcda03a,_0x396501);};};Object['defineProperty'](exports,_0x3c10f4(0xc6),{'value':!![]}),exports['StatisticService']=void 0x0;const balance_constant_1=require(_0x3c10f4(0x9c)),date_1=require('../../common/utils/date'),common_1=require(_0x3c10f4(0xf1)),typeorm_1=require(_0x3c10f4(0xfb)),axios_1=require('axios'),typeorm_2=require('typeorm'),chatLog_entity_1=require(_0x3c10f4(0xc0)),config_entity_1=require(_0x3c10f4(0xb6)),globalConfig_service_1=require(_0x3c10f4(0xa6)),order_entity_1=require(_0x3c10f4(0xf3)),user_entity_1=require(_0x3c10f4(0xc7));let StatisticService=class StatisticService{constructor(_0x2fd9ed,_0x3543bd,_0x2c8a38,_0x4925fe,_0x3e3d00){const _0x5fbd53=_0x3c10f4;this[_0x5fbd53(0xdf)]=_0x2fd9ed,this['chatLogEntity']=_0x3543bd,this[_0x5fbd53(0x105)]=_0x2c8a38,this[_0x5fbd53(0xb7)]=_0x4925fe,this['globalConfigService']=_0x3e3d00;}async['getBaseStatistic'](){const _0x2c0291=_0x3c10f4,_0x37d991=await this['countUsers'](),_0x121988=await this[_0x2c0291(0xa9)](),_0x13ea75=await this[_0x2c0291(0x112)](),_0x543492=await this[_0x2c0291(0xc8)](),_0x1d94d3=await this[_0x2c0291(0xa2)](),_0x4b5190=await this[_0x2c0291(0xb0)](),_0x1811b3=await this[_0x2c0291(0xa3)](),_0x47c25b=await this['countNewOrdersToday']();return{'userCount':_0x37d991,'newUserCount':_0x121988,'chatCount':_0x13ea75,'newChatCount':_0x543492,'drawCount':_0x1d94d3,'newDrawCount':_0x4b5190,'orderCount':_0x1811b3,'newOrderCount':_0x47c25b};}async['getChatStatistic']({days:days=0x7}){const _0x479b0d=_0x3c10f4,_0x5e809a=await this[_0x479b0d(0xb2)](days),_0x24d247=await this[_0x479b0d(0x9d)](days);return{'date':_0x5e809a['map'](_0x56e9b4=>_0x56e9b4['date']),'chat':_0x5e809a[_0x479b0d(0x99)](_0x4d37fb=>_0x4d37fb[_0x479b0d(0xff)]),'draw':_0x24d247[_0x479b0d(0x99)]((_0x45eb9f,_0x43ac20)=>{const _0x497a25=_0x479b0d;return _0x45eb9f[_0x497a25(0xff)];})};}async[_0x3c10f4(0xf9)]({days:days=0x7}){const _0x390d6c=await this['getBaiduStatistics'](days);return _0x390d6c;}async[_0x3c10f4(0xc4)](){const _0x413793=_0x3c10f4,_0x32a8e7=await this[_0x413793(0xdf)][_0x413793(0xa4)]();return _0x32a8e7;}async[_0x3c10f4(0xa9)](){const _0x2faf6d=_0x3c10f4,_0x52b936=new Date();_0x52b936['setHours'](0x0,0x0,0x0,0x0);const _0x184553=new Date(_0x52b936[_0x2faf6d(0xb8)]()+0x18*0x3c*0x3c*0x3e8),_0x5f5d5=this['userEntity'][_0x2faf6d(0xf6)](_0x2faf6d(0x101)),_0x4f8220=await _0x5f5d5[_0x2faf6d(0x10f)]('user.createdAt\x20>=\x20:today',{'today':_0x52b936})[_0x2faf6d(0xc3)](_0x2faf6d(0xd2),{'tomorrow':_0x184553})[_0x2faf6d(0xcd)]();return _0x4f8220;}async['countChats'](){const _0x2b8581=_0x3c10f4,_0x363722=await this['chatLogEntity']['count']({'where':{'type':balance_constant_1[_0x2b8581(0xdd)]['NORMAL_CHAT']}});return _0x363722;}async[_0x3c10f4(0xc8)](){const _0x4baec3=_0x3c10f4,_0x5ad4a8=new Date();_0x5ad4a8[_0x4baec3(0xb1)](0x0,0x0,0x0,0x0);const _0xf12354=new Date(_0x5ad4a8[_0x4baec3(0xb8)]()+0x18*0x3c*0x3c*0x3e8),_0x42451f=this[_0x4baec3(0xf7)][_0x4baec3(0xf6)](_0x4baec3(0xb4)),_0x34f77a=await _0x42451f[_0x4baec3(0x10f)](_0x4baec3(0xc2),{'type':balance_constant_1[_0x4baec3(0xdd)]['NORMAL_CHAT']})[_0x4baec3(0xc3)](_0x4baec3(0xc9),{'today':_0x5ad4a8})[_0x4baec3(0xc3)](_0x4baec3(0x98),{'tomorrow':_0xf12354})['getCount']();return _0x34f77a;}async[_0x3c10f4(0xa2)](){const _0x26b057=_0x3c10f4,_0x2bdb89=await this[_0x26b057(0xf7)][_0x26b057(0xa4)]({'where':{'type':balance_constant_1[_0x26b057(0xdd)][_0x26b057(0xbd)]}});return _0x2bdb89;}async['countNewDrawsToday'](){const _0x5c621e=_0x3c10f4,_0x3a1bc4=new Date();_0x3a1bc4[_0x5c621e(0xb1)](0x0,0x0,0x0,0x0);const _0x1c4991=new Date(_0x3a1bc4[_0x5c621e(0xb8)]()+0x18*0x3c*0x3c*0x3e8),_0x4013e4=this[_0x5c621e(0xf7)][_0x5c621e(0xf6)](_0x5c621e(0xb4)),_0x3a7986=await _0x4013e4[_0x5c621e(0x10f)](_0x5c621e(0xc2),{'type':balance_constant_1[_0x5c621e(0xdd)][_0x5c621e(0xbd)]})['andWhere'](_0x5c621e(0xc9),{'today':_0x3a1bc4})['andWhere']('chatLog.createdAt\x20<\x20:tomorrow',{'tomorrow':_0x1c4991})[_0x5c621e(0xcd)]();return _0x3a7986;}async['countChatsByTimeRange'](_0x13efda){const _0x3f82ea=_0x3c10f4;var _0x154b58,_0x70be75;const _0x1fa21b=new Date();_0x1fa21b[_0x3f82ea(0xb1)](0x0,0x0,0x0,0x0);const _0x52e4f6=new Date(_0x1fa21b[_0x3f82ea(0xb8)]()-(_0x13efda-0x1)*0x18*0x3c*0x3c*0x3e8),_0x5e1baf=this[_0x3f82ea(0xf7)][_0x3f82ea(0xf6)](_0x3f82ea(0xfd)),_0x1c8ece=await _0x5e1baf[_0x3f82ea(0xaa)](_0x3f82ea(0x96))['where'](_0x3f82ea(0xba),{'type':balance_constant_1[_0x3f82ea(0xdd)][_0x3f82ea(0xab)]})[_0x3f82ea(0xc3)](_0x3f82ea(0x10b),{'startDate':_0x52e4f6})[_0x3f82ea(0xa1)](_0x3f82ea(0x109))[_0x3f82ea(0xe8)](_0x3f82ea(0x109))[_0x3f82ea(0xe0)](),_0x378028=[],_0x197ece=_0x52e4f6;for(let _0x32b9d6=0x0;_0x32b9d6<_0x13efda;_0x32b9d6++){const _0x2f48c3=(0x0,date_1[_0x3f82ea(0xcb)])(new Date(_0x197ece),_0x3f82ea(0xca)),_0x4180ef=(_0x70be75=(_0x154b58=_0x1c8ece[_0x3f82ea(0xa7)](_0x4de630=>(0x0,date_1[_0x3f82ea(0xcb)])(new Date(_0x4de630[_0x3f82ea(0x109)]),_0x3f82ea(0xca))===_0x2f48c3))===null||_0x154b58===void 0x0?void 0x0:_0x154b58[_0x3f82ea(0xa4)])!==null&&_0x70be75!==void 0x0?_0x70be75:0x0;_0x4180ef>0x0?_0x378028['push']({'date':_0x2f48c3,'value':Number(_0x4180ef)}):_0x378028[_0x3f82ea(0xb3)]({'date':_0x2f48c3,'value':0x0}),_0x197ece[_0x3f82ea(0xe9)](_0x197ece[_0x3f82ea(0xbc)]()+0x1);}return _0x378028;}async[_0x3c10f4(0x9d)](_0x25946a){const _0x1c2fa2=_0x3c10f4;var _0x1ec9a2,_0x4e6cf0;const _0xefa320=new Date();_0xefa320['setHours'](0x0,0x0,0x0,0x0);const _0x25545e=new Date(_0xefa320[_0x1c2fa2(0xb8)]()-(_0x25946a-0x1)*0x18*0x3c*0x3c*0x3e8),_0x272598=this['chatLogEntity']['createQueryBuilder'](_0x1c2fa2(0xfd)),_0x420460=await _0x272598[_0x1c2fa2(0xaa)](_0x1c2fa2(0x96))[_0x1c2fa2(0x10f)](_0x1c2fa2(0xba),{'type':balance_constant_1[_0x1c2fa2(0xdd)][_0x1c2fa2(0xbd)]})[_0x1c2fa2(0xc3)](_0x1c2fa2(0x10b),{'startDate':_0x25545e})['groupBy'](_0x1c2fa2(0x109))[_0x1c2fa2(0xe8)]('date')[_0x1c2fa2(0xe0)](),_0x41b61c=[],_0x339301=_0x25545e;for(let _0x8e190b=0x0;_0x8e190b<_0x25946a;_0x8e190b++){const _0x50a816=(0x0,date_1[_0x1c2fa2(0xcb)])(new Date(_0x339301),_0x1c2fa2(0xca)),_0x234b65=(_0x4e6cf0=(_0x1ec9a2=_0x420460[_0x1c2fa2(0xa7)](_0x2c3cd9=>(0x0,date_1[_0x1c2fa2(0xcb)])(new Date(_0x2c3cd9[_0x1c2fa2(0x109)]),_0x1c2fa2(0xca))===_0x50a816))===null||_0x1ec9a2===void 0x0?void 0x0:_0x1ec9a2[_0x1c2fa2(0xa4)])!==null&&_0x4e6cf0!==void 0x0?_0x4e6cf0:0x0;_0x234b65>0x0?_0x41b61c[_0x1c2fa2(0xb3)]({'date':_0x50a816,'value':Number(_0x234b65)}):_0x41b61c['push']({'date':_0x50a816,'value':0x0}),_0x339301['setDate'](_0x339301[_0x1c2fa2(0xbc)]()+0x1);}return _0x41b61c;}async[_0x3c10f4(0xf2)](_0x4c0d9e,_0x58dfaf,_0x2b0025){const _0x156b32=_0x3c10f4,_0x2db400='http://openapi.baidu.com/oauth/2.0/token?grant_type=refresh_token&refresh_token='+_0x2b0025+_0x156b32(0xe5)+_0x4c0d9e+_0x156b32(0xdc)+_0x58dfaf;common_1[_0x156b32(0xa0)]['log'](_0x156b32(0xf8),_0x2db400);try{const _0x3ecb14=await axios_1[_0x156b32(0x110)][_0x156b32(0x9f)](_0x2db400);if(_0x3ecb14['status']===0xc8&&_0x3ecb14[_0x156b32(0xcc)][_0x156b32(0xee)])return{'accessToken':_0x3ecb14[_0x156b32(0xcc)]['access_token'],'refreshToken':_0x3ecb14[_0x156b32(0xcc)][_0x156b32(0xb5)]};else throw new Error('Failed\x20to\x20get\x20new\x20access\x20token');}catch(_0x4ebf16){common_1[_0x156b32(0xa0)][_0x156b32(0xd0)](_0x156b32(0xad),{'message':_0x4ebf16[_0x156b32(0xae)],'stack':_0x4ebf16['stack'],'response':_0x4ebf16[_0x156b32(0x111)]?_0x4ebf16[_0x156b32(0x111)][_0x156b32(0xcc)]:_0x156b32(0xc1)});throw new common_1['HttpException']('获取新\x20accessToken\x20失败',common_1['HttpStatus'][_0x156b32(0xde)]);}}async[_0x3c10f4(0xdb)](_0x522878,_0x2ba987,_0x278c94){const _0x423662=_0x3c10f4;await _0x278c94['update']({'configKey':_0x423662(0xda)},{'configVal':_0x522878}),await _0x278c94[_0x423662(0xbb)]({'configKey':'baiduRefreshToken'},{'configVal':_0x2ba987});}async[_0x3c10f4(0xd4)](_0x484ff2){const _0x19e1f7=_0x3c10f4,_0x434cf8=(0x0,date_1[_0x19e1f7(0xcb)])(new Date(),_0x19e1f7(0xd5)),_0x235391=(0x0,date_1[_0x19e1f7(0xcb)])(new Date(Date['now']()-Number(_0x484ff2-0x1)*0x18*0x3c*0x3c*0x3e8),_0x19e1f7(0xd5)),_0x26b26e=_0x19e1f7(0x108),_0x5b6847=_0x19e1f7(0xef),{baiduToken:_0x5e3dfa,baiduSiteId:_0x2c48be,baiduApiKey:_0x3c9fd2,baiduSecretKey:_0x13ee6c,baiduRefreshToken:_0x400552}=await this[_0x19e1f7(0xac)][_0x19e1f7(0xc5)]([_0x19e1f7(0xda),_0x19e1f7(0x10a),_0x19e1f7(0x114),_0x19e1f7(0xd9),_0x19e1f7(0x102)]);if(!_0x3c9fd2||!_0x2c48be||!_0x400552||!_0x13ee6c)return[];let _0x2a6533=_0x5e3dfa,_0x24f195,_0x38c96e;const _0x32d51c=async _0xac32b4=>{const _0x4772d1=_0x19e1f7;_0x38c96e=_0x4772d1(0xd7)+_0xac32b4+_0x4772d1(0xf0)+_0x2c48be+'&method='+_0x5b6847+_0x4772d1(0xe1)+_0x235391+_0x4772d1(0x10e)+_0x434cf8+_0x4772d1(0xa8)+_0x26b26e;try{return await axios_1[_0x4772d1(0x110)][_0x4772d1(0x9f)](_0x38c96e);}catch(_0x172666){return{'data':{'error_code':0x6f,'message':_0x4772d1(0xbf)}};}};_0x24f195=await _0x32d51c(_0x2a6533);if(_0x24f195['data'][_0x19e1f7(0x104)]===0x6f||!_0x5e3dfa){const {accessToken:_0x580337,refreshToken:_0x38d366}=await this['getNewAccessToken'](_0x3c9fd2,_0x13ee6c,_0x400552);_0x2a6533=_0x580337,await this[_0x19e1f7(0xdb)](_0x2a6533,_0x38d366,this[_0x19e1f7(0x105)]),_0x24f195=await _0x32d51c(_0x2a6533);}const {error_code:_0x2e3ec8,message:_0x1790c9}=_0x24f195[_0x19e1f7(0xcc)];if(_0x2e3ec8&&_0x2e3ec8!==0xc8)throw new common_1[(_0x19e1f7(0xce))](_0x1790c9||_0x19e1f7(0xe2),common_1[_0x19e1f7(0xea)][_0x19e1f7(0xde)]);return _0x24f195[_0x19e1f7(0xcc)][_0x19e1f7(0x9a)];}async[_0x3c10f4(0xa3)](){const _0x3d1dfe=_0x3c10f4,_0x69796e=await this[_0x3d1dfe(0xb7)]['count']();return _0x69796e;}async['countNewOrdersToday'](){const _0x3eebd8=_0x3c10f4,_0x2e4d26=new Date();_0x2e4d26[_0x3eebd8(0xb1)](0x0,0x0,0x0,0x0);const _0x21b50a=new Date(_0x2e4d26['getTime']()+0x18*0x3c*0x3c*0x3e8),_0x41877c=this[_0x3eebd8(0xb7)][_0x3eebd8(0xf6)](_0x3eebd8(0xe6)),_0x52734c=await _0x41877c[_0x3eebd8(0x10f)](_0x3eebd8(0xe7),{'today':_0x2e4d26})[_0x3eebd8(0xc3)](_0x3eebd8(0x113),{'tomorrow':_0x21b50a})['getCount']();return _0x52734c;}};StatisticService=__decorate([(0x0,common_1[_0x3c10f4(0x9b)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(user_entity_1['UserEntity'])),__param(0x1,(0x0,typeorm_1[_0x3c10f4(0xd3)])(chatLog_entity_1[_0x3c10f4(0x106)])),__param(0x2,(0x0,typeorm_1[_0x3c10f4(0xd3)])(config_entity_1[_0x3c10f4(0xe3)])),__param(0x3,(0x0,typeorm_1[_0x3c10f4(0xd3)])(order_entity_1[_0x3c10f4(0xfa)])),__metadata(_0x3c10f4(0xed),[typeorm_2[_0x3c10f4(0xa5)],typeorm_2[_0x3c10f4(0xa5)],typeorm_2[_0x3c10f4(0xa5)],typeorm_2[_0x3c10f4(0xa5)],globalConfig_service_1[_0x3c10f4(0xeb)]])],StatisticService),exports[_0x3c10f4(0x10d)]=StatisticService;