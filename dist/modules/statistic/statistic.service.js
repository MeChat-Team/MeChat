'use strict';function _0x206b(_0x3bf1ac,_0x1526dc){const _0x953eee=_0x953e();return _0x206b=function(_0x206b6c,_0x2c7cfa){_0x206b6c=_0x206b6c-0x7a;let _0x4edaff=_0x953eee[_0x206b6c];return _0x4edaff;},_0x206b(_0x3bf1ac,_0x1526dc);}const _0x4853a7=_0x206b;(function(_0x33bcdb,_0x38ee7b){const _0x265488=_0x206b,_0x384b0f=_0x33bcdb();while(!![]){try{const _0x56938f=-parseInt(_0x265488(0xd8))/0x1+-parseInt(_0x265488(0xe9))/0x2*(parseInt(_0x265488(0xd4))/0x3)+-parseInt(_0x265488(0x7f))/0x4+parseInt(_0x265488(0xaa))/0x5*(-parseInt(_0x265488(0xcd))/0x6)+-parseInt(_0x265488(0x8c))/0x7+parseInt(_0x265488(0x7c))/0x8+parseInt(_0x265488(0x9b))/0x9*(parseInt(_0x265488(0xe1))/0xa);if(_0x56938f===_0x38ee7b)break;else _0x384b0f['push'](_0x384b0f['shift']());}catch(_0x7341c7){_0x384b0f['push'](_0x384b0f['shift']());}}}(_0x953e,0x698d7));var __decorate=this&&this[_0x4853a7(0x93)]||function(_0x2e50bc,_0x3b45da,_0x1ae8e0,_0xf54ce2){const _0x30b060=_0x4853a7;var _0x5ae50f=arguments['length'],_0x4bbdb8=_0x5ae50f<0x3?_0x3b45da:_0xf54ce2===null?_0xf54ce2=Object[_0x30b060(0xb8)](_0x3b45da,_0x1ae8e0):_0xf54ce2,_0x228ed7;if(typeof Reflect==='object'&&typeof Reflect[_0x30b060(0xc3)]==='function')_0x4bbdb8=Reflect['decorate'](_0x2e50bc,_0x3b45da,_0x1ae8e0,_0xf54ce2);else{for(var _0x482102=_0x2e50bc[_0x30b060(0xae)]-0x1;_0x482102>=0x0;_0x482102--)if(_0x228ed7=_0x2e50bc[_0x482102])_0x4bbdb8=(_0x5ae50f<0x3?_0x228ed7(_0x4bbdb8):_0x5ae50f>0x3?_0x228ed7(_0x3b45da,_0x1ae8e0,_0x4bbdb8):_0x228ed7(_0x3b45da,_0x1ae8e0))||_0x4bbdb8;}return _0x5ae50f>0x3&&_0x4bbdb8&&Object[_0x30b060(0x94)](_0x3b45da,_0x1ae8e0,_0x4bbdb8),_0x4bbdb8;},__metadata=this&&this[_0x4853a7(0x9e)]||function(_0x10d328,_0x440a8d){const _0x40cf19=_0x4853a7;if(typeof Reflect==='object'&&typeof Reflect[_0x40cf19(0xe6)]===_0x40cf19(0xca))return Reflect[_0x40cf19(0xe6)](_0x10d328,_0x440a8d);},__param=this&&this[_0x4853a7(0x8f)]||function(_0x483562,_0x18bbf0){return function(_0x46f1a9,_0x6e3f5f){_0x18bbf0(_0x46f1a9,_0x6e3f5f,_0x483562);};};Object[_0x4853a7(0x94)](exports,_0x4853a7(0xeb),{'value':!![]}),exports[_0x4853a7(0xc1)]=void 0x0;function _0x953e(){const _0x42d740=['overview/getTimeTrendRpt','&end_date=','typeorm','map','setHours','user','UserEntity','3299955BOLVlA','countNewChatsToday','orderEntity','where','length','getRawMany','andWhere','orderBy','Failed\x20to\x20get\x20new\x20access\x20token','YYYYMMDD','Injectable','createQueryBuilder','status','chatLog','getOwnPropertyDescriptor','baiduToken','log','&start_date=','countUsers','&method=','baiduApiKey','GlobalConfigService','order.createdAt\x20<\x20:tomorrow','StatisticService','chatlog','decorate','now','getConfigs','getDate','获取新\x20accessToken','order','../order/order.entity','function','HttpException','chatlog.type\x20=\x20:type','6dfNhaL','default','OrderEntity','&site_id=','baiduRefreshToken','&metrics=','getCount','153IXBSDT','find','countOrders','InjectRepository','687885HFQdca','DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','../../common/constants/balance.constant','error_code','chatLogEntity','countNewUsersToday','../globalConfig/config.entity','PAINT','setDate','10zifGAy','globalConfigService','../../common/utils/date','Repository','formatDate','metadata','access_token','refresh_token','17002QaenPK','data','__esModule','date','response','message','updateAccessTokenInDatabase','select','../user/user.entity','4465272poLnUQ','push','user.createdAt\x20<\x20:tomorrow','1294620skpNtz','getTime','getBaiduStatistics','BAD_REQUEST','@nestjs/common','chatLog.createdAt\x20<\x20:tomorrow','Access\x20token\x20invalid\x20or\x20no\x20longer\x20valid','chatlog.createdAt\x20>=\x20:startDate','Logger','获取新\x20accessToken\x20失败','groupBy','getNewAccessToken','configEntity','3500427GfMihd','stack','ChatType','__param','ChatLogEntity','chatLog.type\x20=\x20:type','count','__decorate','defineProperty','../chatLog/chatLog.entity','HttpStatus','error','countDrawsByTimeRange','countDraws','M.DD','22313943FsKUjB','@nestjs/typeorm','update','__metadata','value','axios','NORMAL_CHAT','getBaiduVisit'];_0x953e=function(){return _0x42d740;};return _0x953e();}const balance_constant_1=require(_0x4853a7(0xda)),date_1=require(_0x4853a7(0xe3)),common_1=require(_0x4853a7(0x83)),typeorm_1=require(_0x4853a7(0x9c)),axios_1=require(_0x4853a7(0xa0)),typeorm_2=require(_0x4853a7(0xa5)),chatLog_entity_1=require(_0x4853a7(0x95)),config_entity_1=require(_0x4853a7(0xde)),globalConfig_service_1=require('../globalConfig/globalConfig.service'),order_entity_1=require(_0x4853a7(0xc9)),user_entity_1=require(_0x4853a7(0x7b));let StatisticService=class StatisticService{constructor(_0x2e46df,_0x1734f1,_0x3beaf7,_0x598e4e,_0x484842){const _0x159f7f=_0x4853a7;this['userEntity']=_0x2e46df,this[_0x159f7f(0xdc)]=_0x1734f1,this['configEntity']=_0x3beaf7,this[_0x159f7f(0xac)]=_0x598e4e,this[_0x159f7f(0xe2)]=_0x484842;}async['getBaseStatistic'](){const _0x5be307=_0x4853a7,_0x5d8e56=await this[_0x5be307(0xbc)](),_0x12e685=await this[_0x5be307(0xdd)](),_0x29a02b=await this['countChats'](),_0x1c6edc=await this[_0x5be307(0xab)](),_0x1aa379=await this[_0x5be307(0x99)](),_0x5463c6=await this['countNewDrawsToday'](),_0xf64311=await this[_0x5be307(0xd6)](),_0xbaebcf=await this['countNewOrdersToday']();return{'userCount':_0x5d8e56,'newUserCount':_0x12e685,'chatCount':_0x29a02b,'newChatCount':_0x1c6edc,'drawCount':_0x1aa379,'newDrawCount':_0x5463c6,'orderCount':_0xf64311,'newOrderCount':_0xbaebcf};}async['getChatStatistic']({days:days=0x7}){const _0x2a8911=_0x4853a7,_0x217a5f=await this['countChatsByTimeRange'](days),_0x594b16=await this[_0x2a8911(0x98)](days);return{'date':_0x217a5f[_0x2a8911(0xa6)](_0x39dbfd=>_0x39dbfd[_0x2a8911(0xec)]),'chat':_0x217a5f[_0x2a8911(0xa6)](_0x595104=>_0x595104['value']),'draw':_0x594b16[_0x2a8911(0xa6)]((_0x256c9e,_0x3d101c)=>{const _0x4347aa=_0x2a8911;return _0x256c9e[_0x4347aa(0x9f)];})};}async[_0x4853a7(0xa2)]({days:days=0x7}){const _0x2e89ca=_0x4853a7,_0x25b7ba=await this[_0x2e89ca(0x81)](days);return _0x25b7ba;}async[_0x4853a7(0xbc)](){const _0x349974=_0x4853a7,_0x3c4380=await this['userEntity'][_0x349974(0x92)]();return _0x3c4380;}async[_0x4853a7(0xdd)](){const _0x498463=_0x4853a7,_0xda11a1=new Date();_0xda11a1[_0x498463(0xa7)](0x0,0x0,0x0,0x0);const _0x3796b8=new Date(_0xda11a1['getTime']()+0x18*0x3c*0x3c*0x3e8),_0x16e35d=this['userEntity'][_0x498463(0xb5)](_0x498463(0xa8)),_0x9c064a=await _0x16e35d[_0x498463(0xad)]('user.createdAt\x20>=\x20:today',{'today':_0xda11a1})[_0x498463(0xb0)](_0x498463(0x7e),{'tomorrow':_0x3796b8})[_0x498463(0xd3)]();return _0x9c064a;}async['countChats'](){const _0x2f7026=_0x4853a7,_0x4f8209=await this['chatLogEntity'][_0x2f7026(0x92)]({'where':{'type':balance_constant_1['ChatType'][_0x2f7026(0xa1)]}});return _0x4f8209;}async[_0x4853a7(0xab)](){const _0x822600=_0x4853a7,_0x41215a=new Date();_0x41215a[_0x822600(0xa7)](0x0,0x0,0x0,0x0);const _0x581a2d=new Date(_0x41215a['getTime']()+0x18*0x3c*0x3c*0x3e8),_0x4f1502=this[_0x822600(0xdc)][_0x822600(0xb5)](_0x822600(0xb7)),_0x5cf50d=await _0x4f1502['where']('chatLog.type\x20=\x20:type',{'type':balance_constant_1['ChatType'][_0x822600(0xa1)]})[_0x822600(0xb0)]('chatLog.createdAt\x20>=\x20:today',{'today':_0x41215a})[_0x822600(0xb0)]('chatLog.createdAt\x20<\x20:tomorrow',{'tomorrow':_0x581a2d})[_0x822600(0xd3)]();return _0x5cf50d;}async[_0x4853a7(0x99)](){const _0x425fbf=_0x4853a7,_0x5dbf92=await this[_0x425fbf(0xdc)][_0x425fbf(0x92)]({'where':{'type':balance_constant_1['ChatType'][_0x425fbf(0xdf)]}});return _0x5dbf92;}async['countNewDrawsToday'](){const _0x596f16=_0x4853a7,_0x34d0a2=new Date();_0x34d0a2[_0x596f16(0xa7)](0x0,0x0,0x0,0x0);const _0x5b9d0a=new Date(_0x34d0a2[_0x596f16(0x80)]()+0x18*0x3c*0x3c*0x3e8),_0x3c7df2=this[_0x596f16(0xdc)][_0x596f16(0xb5)](_0x596f16(0xb7)),_0x4a9fb4=await _0x3c7df2[_0x596f16(0xad)](_0x596f16(0x91),{'type':balance_constant_1[_0x596f16(0x8e)]['PAINT']})['andWhere']('chatLog.createdAt\x20>=\x20:today',{'today':_0x34d0a2})['andWhere'](_0x596f16(0x84),{'tomorrow':_0x5b9d0a})['getCount']();return _0x4a9fb4;}async['countChatsByTimeRange'](_0x4795c3){const _0x43f91d=_0x4853a7;var _0x5b4722,_0x44c78b;const _0xcc16b4=new Date();_0xcc16b4[_0x43f91d(0xa7)](0x0,0x0,0x0,0x0);const _0x4cc62a=new Date(_0xcc16b4[_0x43f91d(0x80)]()-(_0x4795c3-0x1)*0x18*0x3c*0x3c*0x3e8),_0x45ff2d=this[_0x43f91d(0xdc)][_0x43f91d(0xb5)](_0x43f91d(0xc2)),_0x51f02=await _0x45ff2d['select'](_0x43f91d(0xd9))[_0x43f91d(0xad)]('chatlog.type\x20=\x20:type',{'type':balance_constant_1[_0x43f91d(0x8e)][_0x43f91d(0xa1)]})[_0x43f91d(0xb0)](_0x43f91d(0x86),{'startDate':_0x4cc62a})[_0x43f91d(0x89)](_0x43f91d(0xec))['orderBy']('date')[_0x43f91d(0xaf)](),_0x412c7b=[],_0x536118=_0x4cc62a;for(let _0x99e078=0x0;_0x99e078<_0x4795c3;_0x99e078++){const _0x22b2ec=(0x0,date_1[_0x43f91d(0xe5)])(new Date(_0x536118),'M.DD'),_0xb3d223=(_0x44c78b=(_0x5b4722=_0x51f02[_0x43f91d(0xd5)](_0x2c5a9c=>(0x0,date_1[_0x43f91d(0xe5)])(new Date(_0x2c5a9c['date']),_0x43f91d(0x9a))===_0x22b2ec))===null||_0x5b4722===void 0x0?void 0x0:_0x5b4722[_0x43f91d(0x92)])!==null&&_0x44c78b!==void 0x0?_0x44c78b:0x0;_0xb3d223>0x0?_0x412c7b[_0x43f91d(0x7d)]({'date':_0x22b2ec,'value':Number(_0xb3d223)}):_0x412c7b[_0x43f91d(0x7d)]({'date':_0x22b2ec,'value':0x0}),_0x536118[_0x43f91d(0xe0)](_0x536118[_0x43f91d(0xc6)]()+0x1);}return _0x412c7b;}async[_0x4853a7(0x98)](_0xb38254){const _0x5ec709=_0x4853a7;var _0x4ffcdc,_0x324a41;const _0x55081d=new Date();_0x55081d['setHours'](0x0,0x0,0x0,0x0);const _0x325938=new Date(_0x55081d[_0x5ec709(0x80)]()-(_0xb38254-0x1)*0x18*0x3c*0x3c*0x3e8),_0x586854=this[_0x5ec709(0xdc)][_0x5ec709(0xb5)](_0x5ec709(0xc2)),_0x34d7b9=await _0x586854[_0x5ec709(0x7a)](_0x5ec709(0xd9))[_0x5ec709(0xad)](_0x5ec709(0xcc),{'type':balance_constant_1['ChatType'][_0x5ec709(0xdf)]})[_0x5ec709(0xb0)](_0x5ec709(0x86),{'startDate':_0x325938})[_0x5ec709(0x89)](_0x5ec709(0xec))[_0x5ec709(0xb1)](_0x5ec709(0xec))['getRawMany'](),_0x29e6d6=[],_0x2dec51=_0x325938;for(let _0x5bc617=0x0;_0x5bc617<_0xb38254;_0x5bc617++){const _0x209b85=(0x0,date_1[_0x5ec709(0xe5)])(new Date(_0x2dec51),_0x5ec709(0x9a)),_0x23076a=(_0x324a41=(_0x4ffcdc=_0x34d7b9[_0x5ec709(0xd5)](_0x1428a5=>(0x0,date_1[_0x5ec709(0xe5)])(new Date(_0x1428a5[_0x5ec709(0xec)]),_0x5ec709(0x9a))===_0x209b85))===null||_0x4ffcdc===void 0x0?void 0x0:_0x4ffcdc[_0x5ec709(0x92)])!==null&&_0x324a41!==void 0x0?_0x324a41:0x0;_0x23076a>0x0?_0x29e6d6[_0x5ec709(0x7d)]({'date':_0x209b85,'value':Number(_0x23076a)}):_0x29e6d6[_0x5ec709(0x7d)]({'date':_0x209b85,'value':0x0}),_0x2dec51[_0x5ec709(0xe0)](_0x2dec51[_0x5ec709(0xc6)]()+0x1);}return _0x29e6d6;}async[_0x4853a7(0x8a)](_0x49129a,_0x23e162,_0xa413f5){const _0x1a6f38=_0x4853a7,_0x3bbe36='http://openapi.baidu.com/oauth/2.0/token?grant_type=refresh_token&refresh_token='+_0xa413f5+'&client_id='+_0x49129a+'&client_secret='+_0x23e162;common_1[_0x1a6f38(0x87)][_0x1a6f38(0xba)](_0x1a6f38(0xc7),_0x3bbe36);try{const _0x4d78cd=await axios_1[_0x1a6f38(0xce)]['get'](_0x3bbe36);if(_0x4d78cd[_0x1a6f38(0xb6)]===0xc8&&_0x4d78cd['data'][_0x1a6f38(0xe7)])return{'accessToken':_0x4d78cd['data'][_0x1a6f38(0xe7)],'refreshToken':_0x4d78cd['data'][_0x1a6f38(0xe8)]};else throw new Error(_0x1a6f38(0xb2));}catch(_0xf75f8d){common_1[_0x1a6f38(0x87)][_0x1a6f38(0x97)](_0x1a6f38(0x88),{'message':_0xf75f8d[_0x1a6f38(0xee)],'stack':_0xf75f8d[_0x1a6f38(0x8d)],'response':_0xf75f8d[_0x1a6f38(0xed)]?_0xf75f8d[_0x1a6f38(0xed)][_0x1a6f38(0xea)]:'No\x20response\x20data'});throw new common_1[(_0x1a6f38(0xcb))](_0x1a6f38(0x88),common_1[_0x1a6f38(0x96)][_0x1a6f38(0x82)]);}}async[_0x4853a7(0xef)](_0x506c08,_0x2bdea6,_0x2feaa6){const _0xfc8977=_0x4853a7;await _0x2feaa6[_0xfc8977(0x9d)]({'configKey':'baiduToken'},{'configVal':_0x506c08}),await _0x2feaa6[_0xfc8977(0x9d)]({'configKey':_0xfc8977(0xd1)},{'configVal':_0x2bdea6});}async['getBaiduStatistics'](_0x133bf9){const _0x58c669=_0x4853a7,_0x3af149=(0x0,date_1[_0x58c669(0xe5)])(new Date(),_0x58c669(0xb3)),_0x593e50=(0x0,date_1[_0x58c669(0xe5)])(new Date(Date[_0x58c669(0xc4)]()-Number(_0x133bf9-0x1)*0x18*0x3c*0x3c*0x3e8),_0x58c669(0xb3)),_0x569a4e='pv_count,visitor_count,ip_count,bounce_ratio,avg_visit_time',_0x3298e6=_0x58c669(0xa3),{baiduToken:_0xc21709,baiduSiteId:_0x2668eb,baiduApiKey:_0x33d7ce,baiduSecretKey:_0x52bd4d,baiduRefreshToken:_0xd3daec}=await this[_0x58c669(0xe2)][_0x58c669(0xc5)]([_0x58c669(0xb9),'baiduSiteId',_0x58c669(0xbe),'baiduSecretKey',_0x58c669(0xd1)]);if(!_0x33d7ce||!_0x2668eb||!_0xd3daec||!_0x52bd4d)return[];let _0x420a20=_0xc21709,_0x54facc,_0x2dcf97;const _0x2bb784=async _0x691fa3=>{const _0x4d0cab=_0x58c669;_0x2dcf97='https://openapi.baidu.com/rest/2.0/tongji/report/getData?access_token='+_0x691fa3+_0x4d0cab(0xd0)+_0x2668eb+_0x4d0cab(0xbd)+_0x3298e6+_0x4d0cab(0xbb)+_0x593e50+_0x4d0cab(0xa4)+_0x3af149+_0x4d0cab(0xd2)+_0x569a4e;try{return await axios_1[_0x4d0cab(0xce)]['get'](_0x2dcf97);}catch(_0x2d2402){return{'data':{'error_code':0x6f,'message':_0x4d0cab(0x85)}};}};_0x54facc=await _0x2bb784(_0x420a20);if(_0x54facc[_0x58c669(0xea)][_0x58c669(0xdb)]===0x6f||!_0xc21709){const {accessToken:_0x36c63c,refreshToken:_0x301993}=await this[_0x58c669(0x8a)](_0x33d7ce,_0x52bd4d,_0xd3daec);_0x420a20=_0x36c63c,await this[_0x58c669(0xef)](_0x420a20,_0x301993,this[_0x58c669(0x8b)]),_0x54facc=await _0x2bb784(_0x420a20);}const {error_code:_0x114006,message:_0x144973}=_0x54facc[_0x58c669(0xea)];if(_0x114006&&_0x114006!==0xc8)throw new common_1['HttpException'](_0x144973||'获取百度统计数据失败',common_1[_0x58c669(0x96)][_0x58c669(0x82)]);return _0x54facc[_0x58c669(0xea)]['result'];}async[_0x4853a7(0xd6)](){const _0x4dc152=_0x4853a7,_0x32ab0e=await this[_0x4dc152(0xac)][_0x4dc152(0x92)]();return _0x32ab0e;}async['countNewOrdersToday'](){const _0xd900a4=_0x4853a7,_0x103dae=new Date();_0x103dae['setHours'](0x0,0x0,0x0,0x0);const _0x58a803=new Date(_0x103dae['getTime']()+0x18*0x3c*0x3c*0x3e8),_0x1fe606=this[_0xd900a4(0xac)][_0xd900a4(0xb5)](_0xd900a4(0xc8)),_0x5c76a=await _0x1fe606[_0xd900a4(0xad)]('order.createdAt\x20>=\x20:today',{'today':_0x103dae})['andWhere'](_0xd900a4(0xc0),{'tomorrow':_0x58a803})['getCount']();return _0x5c76a;}};StatisticService=__decorate([(0x0,common_1[_0x4853a7(0xb4)])(),__param(0x0,(0x0,typeorm_1[_0x4853a7(0xd7)])(user_entity_1[_0x4853a7(0xa9)])),__param(0x1,(0x0,typeorm_1[_0x4853a7(0xd7)])(chatLog_entity_1[_0x4853a7(0x90)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(config_entity_1['ConfigEntity'])),__param(0x3,(0x0,typeorm_1['InjectRepository'])(order_entity_1[_0x4853a7(0xcf)])),__metadata('design:paramtypes',[typeorm_2['Repository'],typeorm_2[_0x4853a7(0xe4)],typeorm_2[_0x4853a7(0xe4)],typeorm_2[_0x4853a7(0xe4)],globalConfig_service_1[_0x4853a7(0xbf)]])],StatisticService),exports['StatisticService']=StatisticService;