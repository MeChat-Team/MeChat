'use strict';const _0x5ae2d3=_0xba8d;(function(_0x52f34d,_0x575eb8){const _0x540bd4=_0xba8d,_0x412b6e=_0x52f34d();while(!![]){try{const _0xa4fd1c=parseInt(_0x540bd4(0x168))/0x1+parseInt(_0x540bd4(0x116))/0x2*(parseInt(_0x540bd4(0x17f))/0x3)+parseInt(_0x540bd4(0x14b))/0x4+-parseInt(_0x540bd4(0x179))/0x5+-parseInt(_0x540bd4(0x169))/0x6*(parseInt(_0x540bd4(0x137))/0x7)+parseInt(_0x540bd4(0x159))/0x8+parseInt(_0x540bd4(0x14d))/0x9*(parseInt(_0x540bd4(0x15b))/0xa);if(_0xa4fd1c===_0x575eb8)break;else _0x412b6e['push'](_0x412b6e['shift']());}catch(_0x480c72){_0x412b6e['push'](_0x412b6e['shift']());}}}(_0x31f4,0x7eeac));var __decorate=this&&this[_0x5ae2d3(0x118)]||function(_0x746d34,_0x3dda9c,_0x516cd7,_0x3b8300){const _0x202339=_0x5ae2d3;var _0x5f472c=arguments[_0x202339(0x135)],_0x401335=_0x5f472c<0x3?_0x3dda9c:_0x3b8300===null?_0x3b8300=Object[_0x202339(0x13e)](_0x3dda9c,_0x516cd7):_0x3b8300,_0x402d73;if(typeof Reflect===_0x202339(0x16b)&&typeof Reflect[_0x202339(0x111)]==='function')_0x401335=Reflect[_0x202339(0x111)](_0x746d34,_0x3dda9c,_0x516cd7,_0x3b8300);else{for(var _0xa89e16=_0x746d34[_0x202339(0x135)]-0x1;_0xa89e16>=0x0;_0xa89e16--)if(_0x402d73=_0x746d34[_0xa89e16])_0x401335=(_0x5f472c<0x3?_0x402d73(_0x401335):_0x5f472c>0x3?_0x402d73(_0x3dda9c,_0x516cd7,_0x401335):_0x402d73(_0x3dda9c,_0x516cd7))||_0x401335;}return _0x5f472c>0x3&&_0x401335&&Object['defineProperty'](_0x3dda9c,_0x516cd7,_0x401335),_0x401335;},__metadata=this&&this['__metadata']||function(_0x24df3a,_0x5b37d0){const _0x1b2691=_0x5ae2d3;if(typeof Reflect===_0x1b2691(0x16b)&&typeof Reflect[_0x1b2691(0x129)]===_0x1b2691(0x166))return Reflect['metadata'](_0x24df3a,_0x5b37d0);},__param=this&&this['__param']||function(_0x57ed98,_0x262546){return function(_0x39ec98,_0xfe4d70){_0x262546(_0x39ec98,_0xfe4d70,_0x57ed98);};};function _0xba8d(_0x5dcb84,_0x10d6cf){const _0x31f414=_0x31f4();return _0xba8d=function(_0xba8df0,_0x44456f){_0xba8df0=_0xba8df0-0x10c;let _0xa2cd00=_0x31f414[_0xba8df0];return _0xa2cd00;},_0xba8d(_0x5dcb84,_0x10d6cf);}Object[_0x5ae2d3(0x181)](exports,_0x5ae2d3(0x11d),{'value':!![]}),exports['StatisticService']=void 0x0;function _0x31f4(){const _0x33244f=['../../common/constants/balance.constant','../globalConfig/globalConfig.service','chatLog','baiduRefreshToken','createQueryBuilder','getBaiduVisit','PAINT','../chatLog/chatLog.entity','refresh_token','getDate','baiduToken','userEntity','find','4323465zILAww','updateAccessTokenInDatabase','select','order.createdAt\x20<\x20:tomorrow','chatLog.type\x20=\x20:type','get','668673OVbtlN','@nestjs/typeorm','defineProperty','value','countUsers','setHours','No\x20response\x20data','&client_secret=','chatlog.createdAt\x20>=\x20:startDate','globalConfigService','getNewAccessToken','Injectable','decorate','NORMAL_CHAT','countOrders','Repository','baiduApiKey','2ZnpCid','user.createdAt\x20<\x20:tomorrow','__decorate','chatlog','InjectRepository','response','typeorm','__esModule','getRawMany','getConfigs','&end_date=','orderBy','user.createdAt\x20>=\x20:today','error','ChatType','default','chatlog.type\x20=\x20:type','groupBy','&client_id=','metadata','HttpException','https://openapi.baidu.com/rest/2.0/tongji/report/getData?access_token=','countNewOrdersToday','chatLogEntity','获取新\x20accessToken\x20失败','chatLog.createdAt\x20>=\x20:today','getChatStatistic','date','baiduSiteId','map','M.DD','length','update','206395LLZLMX','countChats','formatDate','countDrawsByTimeRange','order.createdAt\x20>=\x20:today','../globalConfig/config.entity','DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','getOwnPropertyDescriptor','GlobalConfigService','message','push','HttpStatus','Logger','chatLog.createdAt\x20<\x20:tomorrow','order','OrderEntity','../../common/utils/date','countNewDrawsToday','status','&site_id=','76476neTKzS','configEntity','18mJGLFq','&metrics=','countChatsByTimeRange','baiduSecretKey','setDate','getTime','getCount','countNewChatsToday','获取新\x20accessToken','../order/order.entity','StatisticService','orderEntity','615728QVKBkT','where','1615930XPAXsG','result','count','log','access_token','UserEntity','axios','@nestjs/common','YYYYMMDD','overview/getTimeTrendRpt','andWhere','function','data','771868mILitu','6CBGucE','http://openapi.baidu.com/oauth/2.0/token?grant_type=refresh_token&refresh_token=','object'];_0x31f4=function(){return _0x33244f;};return _0x31f4();}const balance_constant_1=require(_0x5ae2d3(0x16c)),date_1=require(_0x5ae2d3(0x147)),common_1=require(_0x5ae2d3(0x162)),typeorm_1=require(_0x5ae2d3(0x180)),axios_1=require(_0x5ae2d3(0x161)),typeorm_2=require(_0x5ae2d3(0x11c)),chatLog_entity_1=require(_0x5ae2d3(0x173)),config_entity_1=require(_0x5ae2d3(0x13c)),globalConfig_service_1=require(_0x5ae2d3(0x16d)),order_entity_1=require(_0x5ae2d3(0x156)),user_entity_1=require('../user/user.entity');let StatisticService=class StatisticService{constructor(_0x4f2d2b,_0x289cd8,_0x5837c9,_0x36dd16,_0x3fde22){const _0x4fc3b1=_0x5ae2d3;this[_0x4fc3b1(0x177)]=_0x4f2d2b,this[_0x4fc3b1(0x12d)]=_0x289cd8,this[_0x4fc3b1(0x14c)]=_0x5837c9,this[_0x4fc3b1(0x158)]=_0x36dd16,this[_0x4fc3b1(0x10e)]=_0x3fde22;}async['getBaseStatistic'](){const _0x3a751a=_0x5ae2d3,_0x4f31ba=await this[_0x3a751a(0x183)](),_0x5d9844=await this['countNewUsersToday'](),_0x58347a=await this[_0x3a751a(0x138)](),_0x1521cd=await this[_0x3a751a(0x154)](),_0x4d7a99=await this['countDraws'](),_0x5e6397=await this[_0x3a751a(0x148)](),_0x5c57a6=await this[_0x3a751a(0x113)](),_0x576268=await this[_0x3a751a(0x12c)]();return{'userCount':_0x4f31ba,'newUserCount':_0x5d9844,'chatCount':_0x58347a,'newChatCount':_0x1521cd,'drawCount':_0x4d7a99,'newDrawCount':_0x5e6397,'orderCount':_0x5c57a6,'newOrderCount':_0x576268};}async[_0x5ae2d3(0x130)]({days:days=0x7}){const _0x34e533=_0x5ae2d3,_0x396661=await this['countChatsByTimeRange'](days),_0x1810d9=await this[_0x34e533(0x13a)](days);return{'date':_0x396661[_0x34e533(0x133)](_0x5c0ce4=>_0x5c0ce4[_0x34e533(0x131)]),'chat':_0x396661[_0x34e533(0x133)](_0x6e569=>_0x6e569[_0x34e533(0x182)]),'draw':_0x1810d9[_0x34e533(0x133)]((_0xb60c6c,_0x22d450)=>{return _0xb60c6c['value'];})};}async[_0x5ae2d3(0x171)]({days:days=0x7}){const _0x14e14f=await this['getBaiduStatistics'](days);return _0x14e14f;}async[_0x5ae2d3(0x183)](){const _0x2cb742=_0x5ae2d3,_0x219d0b=await this['userEntity'][_0x2cb742(0x15d)]();return _0x219d0b;}async['countNewUsersToday'](){const _0x5e4912=_0x5ae2d3,_0x574409=new Date();_0x574409[_0x5e4912(0x184)](0x0,0x0,0x0,0x0);const _0x267a50=new Date(_0x574409[_0x5e4912(0x152)]()+0x18*0x3c*0x3c*0x3e8),_0x29f7df=this['userEntity'][_0x5e4912(0x170)]('user'),_0x21d3d4=await _0x29f7df[_0x5e4912(0x15a)](_0x5e4912(0x122),{'today':_0x574409})[_0x5e4912(0x165)](_0x5e4912(0x117),{'tomorrow':_0x267a50})[_0x5e4912(0x153)]();return _0x21d3d4;}async[_0x5ae2d3(0x138)](){const _0x2f28bb=_0x5ae2d3,_0x53d04e=await this[_0x2f28bb(0x12d)]['count']({'where':{'type':balance_constant_1[_0x2f28bb(0x124)][_0x2f28bb(0x112)]}});return _0x53d04e;}async['countNewChatsToday'](){const _0x1454c3=_0x5ae2d3,_0x54ea63=new Date();_0x54ea63['setHours'](0x0,0x0,0x0,0x0);const _0x4ef2a1=new Date(_0x54ea63[_0x1454c3(0x152)]()+0x18*0x3c*0x3c*0x3e8),_0x4bdc15=this[_0x1454c3(0x12d)][_0x1454c3(0x170)](_0x1454c3(0x16e)),_0x3365e4=await _0x4bdc15['where'](_0x1454c3(0x17d),{'type':balance_constant_1[_0x1454c3(0x124)][_0x1454c3(0x112)]})[_0x1454c3(0x165)](_0x1454c3(0x12f),{'today':_0x54ea63})[_0x1454c3(0x165)](_0x1454c3(0x144),{'tomorrow':_0x4ef2a1})[_0x1454c3(0x153)]();return _0x3365e4;}async['countDraws'](){const _0x53a06a=_0x5ae2d3,_0x16508d=await this[_0x53a06a(0x12d)][_0x53a06a(0x15d)]({'where':{'type':balance_constant_1['ChatType']['PAINT']}});return _0x16508d;}async[_0x5ae2d3(0x148)](){const _0x35fe11=_0x5ae2d3,_0xa3e8cc=new Date();_0xa3e8cc[_0x35fe11(0x184)](0x0,0x0,0x0,0x0);const _0x2e0c2e=new Date(_0xa3e8cc['getTime']()+0x18*0x3c*0x3c*0x3e8),_0x56c38d=this[_0x35fe11(0x12d)][_0x35fe11(0x170)](_0x35fe11(0x16e)),_0x4e3b67=await _0x56c38d['where']('chatLog.type\x20=\x20:type',{'type':balance_constant_1[_0x35fe11(0x124)][_0x35fe11(0x172)]})[_0x35fe11(0x165)](_0x35fe11(0x12f),{'today':_0xa3e8cc})[_0x35fe11(0x165)]('chatLog.createdAt\x20<\x20:tomorrow',{'tomorrow':_0x2e0c2e})[_0x35fe11(0x153)]();return _0x4e3b67;}async[_0x5ae2d3(0x14f)](_0x5f3ab7){const _0x42ef64=_0x5ae2d3;var _0x117b35,_0x5c1155;const _0xe80cba=new Date();_0xe80cba[_0x42ef64(0x184)](0x0,0x0,0x0,0x0);const _0x9528ce=new Date(_0xe80cba[_0x42ef64(0x152)]()-(_0x5f3ab7-0x1)*0x18*0x3c*0x3c*0x3e8),_0x357147=this[_0x42ef64(0x12d)][_0x42ef64(0x170)](_0x42ef64(0x119)),_0x9460b0=await _0x357147['select'](_0x42ef64(0x13d))['where'](_0x42ef64(0x126),{'type':balance_constant_1[_0x42ef64(0x124)]['NORMAL_CHAT']})['andWhere'](_0x42ef64(0x10d),{'startDate':_0x9528ce})[_0x42ef64(0x127)](_0x42ef64(0x131))[_0x42ef64(0x121)]('date')['getRawMany'](),_0x574d94=[],_0x9ab373=_0x9528ce;for(let _0x3363a5=0x0;_0x3363a5<_0x5f3ab7;_0x3363a5++){const _0x23bf9d=(0x0,date_1[_0x42ef64(0x139)])(new Date(_0x9ab373),_0x42ef64(0x134)),_0x110f8a=(_0x5c1155=(_0x117b35=_0x9460b0['find'](_0x2179e1=>(0x0,date_1[_0x42ef64(0x139)])(new Date(_0x2179e1[_0x42ef64(0x131)]),_0x42ef64(0x134))===_0x23bf9d))===null||_0x117b35===void 0x0?void 0x0:_0x117b35[_0x42ef64(0x15d)])!==null&&_0x5c1155!==void 0x0?_0x5c1155:0x0;_0x110f8a>0x0?_0x574d94['push']({'date':_0x23bf9d,'value':Number(_0x110f8a)}):_0x574d94[_0x42ef64(0x141)]({'date':_0x23bf9d,'value':0x0}),_0x9ab373[_0x42ef64(0x151)](_0x9ab373[_0x42ef64(0x175)]()+0x1);}return _0x574d94;}async[_0x5ae2d3(0x13a)](_0x4b3474){const _0x150fe9=_0x5ae2d3;var _0xdfbaa2,_0x1fc420;const _0x445fcb=new Date();_0x445fcb[_0x150fe9(0x184)](0x0,0x0,0x0,0x0);const _0x2bec54=new Date(_0x445fcb[_0x150fe9(0x152)]()-(_0x4b3474-0x1)*0x18*0x3c*0x3c*0x3e8),_0x17c855=this[_0x150fe9(0x12d)][_0x150fe9(0x170)](_0x150fe9(0x119)),_0x218908=await _0x17c855[_0x150fe9(0x17b)](_0x150fe9(0x13d))[_0x150fe9(0x15a)](_0x150fe9(0x126),{'type':balance_constant_1[_0x150fe9(0x124)]['PAINT']})[_0x150fe9(0x165)](_0x150fe9(0x10d),{'startDate':_0x2bec54})[_0x150fe9(0x127)](_0x150fe9(0x131))['orderBy']('date')[_0x150fe9(0x11e)](),_0x24e63d=[],_0x19f2d2=_0x2bec54;for(let _0x1c4864=0x0;_0x1c4864<_0x4b3474;_0x1c4864++){const _0x31d25b=(0x0,date_1[_0x150fe9(0x139)])(new Date(_0x19f2d2),_0x150fe9(0x134)),_0xf5607a=(_0x1fc420=(_0xdfbaa2=_0x218908[_0x150fe9(0x178)](_0x5ccad4=>(0x0,date_1['formatDate'])(new Date(_0x5ccad4[_0x150fe9(0x131)]),_0x150fe9(0x134))===_0x31d25b))===null||_0xdfbaa2===void 0x0?void 0x0:_0xdfbaa2[_0x150fe9(0x15d)])!==null&&_0x1fc420!==void 0x0?_0x1fc420:0x0;_0xf5607a>0x0?_0x24e63d['push']({'date':_0x31d25b,'value':Number(_0xf5607a)}):_0x24e63d[_0x150fe9(0x141)]({'date':_0x31d25b,'value':0x0}),_0x19f2d2[_0x150fe9(0x151)](_0x19f2d2['getDate']()+0x1);}return _0x24e63d;}async['getNewAccessToken'](_0xcb9ddc,_0x3a779d,_0x58e84d){const _0x55010b=_0x5ae2d3,_0x2462d9=_0x55010b(0x16a)+_0x58e84d+_0x55010b(0x128)+_0xcb9ddc+_0x55010b(0x10c)+_0x3a779d;common_1[_0x55010b(0x143)][_0x55010b(0x15e)](_0x55010b(0x155),_0x2462d9);try{const _0x3cdabb=await axios_1['default']['get'](_0x2462d9);if(_0x3cdabb[_0x55010b(0x149)]===0xc8&&_0x3cdabb[_0x55010b(0x167)][_0x55010b(0x15f)])return{'accessToken':_0x3cdabb[_0x55010b(0x167)][_0x55010b(0x15f)],'refreshToken':_0x3cdabb['data'][_0x55010b(0x174)]};else throw new Error('Failed\x20to\x20get\x20new\x20access\x20token');}catch(_0x2dd630){common_1[_0x55010b(0x143)][_0x55010b(0x123)](_0x55010b(0x12e),{'message':_0x2dd630[_0x55010b(0x140)],'stack':_0x2dd630['stack'],'response':_0x2dd630[_0x55010b(0x11b)]?_0x2dd630[_0x55010b(0x11b)]['data']:_0x55010b(0x185)});throw new common_1[(_0x55010b(0x12a))](_0x55010b(0x12e),common_1[_0x55010b(0x142)]['BAD_REQUEST']);}}async[_0x5ae2d3(0x17a)](_0x27ef5a,_0x6eb856,_0x46e3ca){const _0x85a4c7=_0x5ae2d3;await _0x46e3ca['update']({'configKey':_0x85a4c7(0x176)},{'configVal':_0x27ef5a}),await _0x46e3ca[_0x85a4c7(0x136)]({'configKey':_0x85a4c7(0x16f)},{'configVal':_0x6eb856});}async['getBaiduStatistics'](_0x11c28e){const _0x500a64=_0x5ae2d3,_0x2e4c5c=(0x0,date_1[_0x500a64(0x139)])(new Date(),_0x500a64(0x163)),_0x5848e4=(0x0,date_1[_0x500a64(0x139)])(new Date(Date['now']()-Number(_0x11c28e-0x1)*0x18*0x3c*0x3c*0x3e8),_0x500a64(0x163)),_0x1e6c70='pv_count,visitor_count,ip_count,bounce_ratio,avg_visit_time',_0x3f3006=_0x500a64(0x164),{baiduToken:_0x53a64e,baiduSiteId:_0x5dfecf,baiduApiKey:_0x419735,baiduSecretKey:_0x4b72ea,baiduRefreshToken:_0x44ac54}=await this['globalConfigService'][_0x500a64(0x11f)](['baiduToken',_0x500a64(0x132),_0x500a64(0x115),_0x500a64(0x150),'baiduRefreshToken']);if(!_0x419735||!_0x5dfecf||!_0x44ac54||!_0x4b72ea)return[];let _0x146e98=_0x53a64e,_0x2b1c42,_0x26eb90;const _0x1c0adb=async _0x133613=>{const _0x19acb4=_0x500a64;_0x26eb90=_0x19acb4(0x12b)+_0x133613+_0x19acb4(0x14a)+_0x5dfecf+'&method='+_0x3f3006+'&start_date='+_0x5848e4+_0x19acb4(0x120)+_0x2e4c5c+_0x19acb4(0x14e)+_0x1e6c70;try{return await axios_1[_0x19acb4(0x125)][_0x19acb4(0x17e)](_0x26eb90);}catch(_0xfac39c){return{'data':{'error_code':0x6f,'message':'Access\x20token\x20invalid\x20or\x20no\x20longer\x20valid'}};}};_0x2b1c42=await _0x1c0adb(_0x146e98);if(_0x2b1c42[_0x500a64(0x167)]['error_code']===0x6f||!_0x53a64e){const {accessToken:_0x3baffa,refreshToken:_0x5669dd}=await this[_0x500a64(0x10f)](_0x419735,_0x4b72ea,_0x44ac54);_0x146e98=_0x3baffa,await this[_0x500a64(0x17a)](_0x146e98,_0x5669dd,this[_0x500a64(0x14c)]),_0x2b1c42=await _0x1c0adb(_0x146e98);}const {error_code:_0x2d218b,message:_0x2435bd}=_0x2b1c42['data'];if(_0x2d218b&&_0x2d218b!==0xc8)throw new common_1['HttpException'](_0x2435bd||'获取百度统计数据失败',common_1[_0x500a64(0x142)]['BAD_REQUEST']);return _0x2b1c42[_0x500a64(0x167)][_0x500a64(0x15c)];}async[_0x5ae2d3(0x113)](){const _0x44ef0b=_0x5ae2d3,_0x36b712=await this[_0x44ef0b(0x158)][_0x44ef0b(0x15d)]();return _0x36b712;}async[_0x5ae2d3(0x12c)](){const _0x469d3e=_0x5ae2d3,_0x4ab4df=new Date();_0x4ab4df[_0x469d3e(0x184)](0x0,0x0,0x0,0x0);const _0x376f92=new Date(_0x4ab4df[_0x469d3e(0x152)]()+0x18*0x3c*0x3c*0x3e8),_0x44abeb=this[_0x469d3e(0x158)]['createQueryBuilder'](_0x469d3e(0x145)),_0x4b6cdf=await _0x44abeb[_0x469d3e(0x15a)](_0x469d3e(0x13b),{'today':_0x4ab4df})[_0x469d3e(0x165)](_0x469d3e(0x17c),{'tomorrow':_0x376f92})[_0x469d3e(0x153)]();return _0x4b6cdf;}};StatisticService=__decorate([(0x0,common_1[_0x5ae2d3(0x110)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x5ae2d3(0x160)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(chatLog_entity_1['ChatLogEntity'])),__param(0x2,(0x0,typeorm_1[_0x5ae2d3(0x11a)])(config_entity_1['ConfigEntity'])),__param(0x3,(0x0,typeorm_1['InjectRepository'])(order_entity_1[_0x5ae2d3(0x146)])),__metadata('design:paramtypes',[typeorm_2[_0x5ae2d3(0x114)],typeorm_2[_0x5ae2d3(0x114)],typeorm_2['Repository'],typeorm_2['Repository'],globalConfig_service_1[_0x5ae2d3(0x13f)]])],StatisticService),exports[_0x5ae2d3(0x157)]=StatisticService;