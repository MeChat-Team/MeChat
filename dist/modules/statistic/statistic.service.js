'use strict';function _0x3363(_0x53529b,_0x56d0ed){const _0x4525a1=_0x4525();return _0x3363=function(_0x33638b,_0x4b8705){_0x33638b=_0x33638b-0x12e;let _0x57223f=_0x4525a1[_0x33638b];return _0x57223f;},_0x3363(_0x53529b,_0x56d0ed);}const _0x1e8e23=_0x3363;function _0x4525(){const _0x336cb2=['24FbTkjl','stack','&site_id=','120570PnwwDd','6OFhoWM','ConfigEntity','formatDate','update','baiduApiKey','../globalConfig/globalConfig.service','andWhere','message','get','__metadata','&client_id=','__decorate','getTime','ChatType','log','refresh_token','Logger','2643171LkWGhd','&method=','metadata','2510364HPvtZN','userEntity','__param','user.createdAt\x20<\x20:tomorrow','OrderEntity','&start_date=','../user/user.entity','getNewAccessToken','setDate','10jxNzTs','function','pv_count,visitor_count,ip_count,bounce_ratio,avg_visit_time','getRawMany','Failed\x20to\x20get\x20new\x20access\x20token','user','15598971dccYEI','countDrawsByTimeRange','chatLogEntity','YYYYMMDD','BAD_REQUEST','result','chatLog.createdAt\x20<\x20:tomorrow','&end_date=','getBaiduStatistics','https://openapi.baidu.com/rest/2.0/tongji/report/getData?access_token=','580174jEsgQQ','baiduSecretKey','date','../../common/constants/balance.constant','countNewOrdersToday','chatLog.createdAt\x20>=\x20:today','decorate','select','Repository','object','now','baiduSiteId','updateAccessTokenInDatabase','countDraws','chatlog.createdAt\x20>=\x20:startDate','InjectRepository','default','value','2348570Vpgnrm','chatlog.type\x20=\x20:type','baiduToken','NORMAL_CHAT','chatLog','HttpException','../globalConfig/config.entity','push','StatisticService','design:paramtypes','countUsers','overview/getTimeTrendRpt','globalConfigService','http://openapi.baidu.com/oauth/2.0/token?grant_type=refresh_token&refresh_token=','defineProperty','DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','../chatLog/chatLog.entity','getOwnPropertyDescriptor','chatLog.type\x20=\x20:type','获取新\x20accessToken\x20失败','&metrics=','getCount','length','GlobalConfigService','countOrders','../../common/utils/date','countChatsByTimeRange','createQueryBuilder','configEntity','HttpStatus','countNewDrawsToday','&client_secret=','1191026rygSlj','error','getBaseStatistic','setHours','countChats','baiduRefreshToken','typeorm','getChatStatistic','getConfigs','__esModule','chatlog','M.DD','where','countNewUsersToday','No\x20response\x20data','ChatLogEntity','count','Injectable','response','countNewChatsToday','map','orderEntity','groupBy','axios','access_token','获取新\x20accessToken','data','find'];_0x4525=function(){return _0x336cb2;};return _0x4525();}(function(_0x4d6d67,_0x516214){const _0x4aa8af=_0x3363,_0xf5ba21=_0x4d6d67();while(!![]){try{const _0x51dd38=-parseInt(_0x4aa8af(0x140))/0x1+-parseInt(_0x4aa8af(0x19f))/0x2+parseInt(_0x4aa8af(0x171))/0x3+parseInt(_0x4aa8af(0x174))/0x4+-parseInt(_0x4aa8af(0x15f))/0x5*(parseInt(_0x4aa8af(0x160))/0x6)+-parseInt(_0x4aa8af(0x18d))/0x7*(parseInt(_0x4aa8af(0x15c))/0x8)+parseInt(_0x4aa8af(0x183))/0x9*(parseInt(_0x4aa8af(0x17d))/0xa);if(_0x51dd38===_0x516214)break;else _0xf5ba21['push'](_0xf5ba21['shift']());}catch(_0x24a94c){_0xf5ba21['push'](_0xf5ba21['shift']());}}}(_0x4525,0x93694));var __decorate=this&&this[_0x1e8e23(0x16b)]||function(_0x375f87,_0x3d6d1b,_0x1c3da7,_0x4432da){const _0x3907=_0x1e8e23;var _0x4c41c6=arguments[_0x3907(0x136)],_0x41b90b=_0x4c41c6<0x3?_0x3d6d1b:_0x4432da===null?_0x4432da=Object[_0x3907(0x131)](_0x3d6d1b,_0x1c3da7):_0x4432da,_0x533ac2;if(typeof Reflect===_0x3907(0x196)&&typeof Reflect[_0x3907(0x193)]===_0x3907(0x17e))_0x41b90b=Reflect[_0x3907(0x193)](_0x375f87,_0x3d6d1b,_0x1c3da7,_0x4432da);else{for(var _0x5e5eae=_0x375f87[_0x3907(0x136)]-0x1;_0x5e5eae>=0x0;_0x5e5eae--)if(_0x533ac2=_0x375f87[_0x5e5eae])_0x41b90b=(_0x4c41c6<0x3?_0x533ac2(_0x41b90b):_0x4c41c6>0x3?_0x533ac2(_0x3d6d1b,_0x1c3da7,_0x41b90b):_0x533ac2(_0x3d6d1b,_0x1c3da7))||_0x41b90b;}return _0x4c41c6>0x3&&_0x41b90b&&Object[_0x3907(0x12e)](_0x3d6d1b,_0x1c3da7,_0x41b90b),_0x41b90b;},__metadata=this&&this[_0x1e8e23(0x169)]||function(_0x4deb47,_0x16006a){const _0x2ef33f=_0x1e8e23;if(typeof Reflect===_0x2ef33f(0x196)&&typeof Reflect[_0x2ef33f(0x173)]===_0x2ef33f(0x17e))return Reflect[_0x2ef33f(0x173)](_0x4deb47,_0x16006a);},__param=this&&this[_0x1e8e23(0x176)]||function(_0x5049d3,_0xd9a3aa){return function(_0x7f30e9,_0x4161bf){_0xd9a3aa(_0x7f30e9,_0x4161bf,_0x5049d3);};};Object['defineProperty'](exports,_0x1e8e23(0x149),{'value':!![]}),exports[_0x1e8e23(0x1a7)]=void 0x0;const balance_constant_1=require(_0x1e8e23(0x190)),date_1=require(_0x1e8e23(0x139)),common_1=require('@nestjs/common'),typeorm_1=require('@nestjs/typeorm'),axios_1=require(_0x1e8e23(0x157)),typeorm_2=require(_0x1e8e23(0x146)),chatLog_entity_1=require(_0x1e8e23(0x130)),config_entity_1=require(_0x1e8e23(0x1a5)),globalConfig_service_1=require(_0x1e8e23(0x165)),order_entity_1=require('../order/order.entity'),user_entity_1=require(_0x1e8e23(0x17a));let StatisticService=class StatisticService{constructor(_0x14e0c4,_0x12ad29,_0x1601d8,_0x387cc8,_0x9b9f7a){const _0x295642=_0x1e8e23;this[_0x295642(0x175)]=_0x14e0c4,this['chatLogEntity']=_0x12ad29,this[_0x295642(0x13c)]=_0x1601d8,this[_0x295642(0x155)]=_0x387cc8,this[_0x295642(0x1ab)]=_0x9b9f7a;}async[_0x1e8e23(0x142)](){const _0x5a88c9=_0x1e8e23,_0x5ad13f=await this['countUsers'](),_0x15df61=await this[_0x5a88c9(0x14d)](),_0x107774=await this[_0x5a88c9(0x144)](),_0x3f75a7=await this['countNewChatsToday'](),_0x2f57d8=await this['countDraws'](),_0x369ed4=await this['countNewDrawsToday'](),_0x296c20=await this[_0x5a88c9(0x138)](),_0x508bc9=await this[_0x5a88c9(0x191)]();return{'userCount':_0x5ad13f,'newUserCount':_0x15df61,'chatCount':_0x107774,'newChatCount':_0x3f75a7,'drawCount':_0x2f57d8,'newDrawCount':_0x369ed4,'orderCount':_0x296c20,'newOrderCount':_0x508bc9};}async[_0x1e8e23(0x147)]({days:days=0x7}){const _0x5ca9df=_0x1e8e23,_0x55edf6=await this[_0x5ca9df(0x13a)](days),_0x4b34b8=await this[_0x5ca9df(0x184)](days);return{'date':_0x55edf6[_0x5ca9df(0x154)](_0x44796f=>_0x44796f[_0x5ca9df(0x18f)]),'chat':_0x55edf6[_0x5ca9df(0x154)](_0x5c1b8c=>_0x5c1b8c['value']),'draw':_0x4b34b8['map']((_0x591287,_0xab3206)=>{const _0x150be8=_0x5ca9df;return _0x591287[_0x150be8(0x19e)];})};}async['getBaiduVisit']({days:days=0x7}){const _0x510409=await this['getBaiduStatistics'](days);return _0x510409;}async[_0x1e8e23(0x1a9)](){const _0x796f68=_0x1e8e23,_0x2b5339=await this[_0x796f68(0x175)][_0x796f68(0x150)]();return _0x2b5339;}async[_0x1e8e23(0x14d)](){const _0x1248cc=_0x1e8e23,_0x33370d=new Date();_0x33370d[_0x1248cc(0x143)](0x0,0x0,0x0,0x0);const _0x533034=new Date(_0x33370d[_0x1248cc(0x16c)]()+0x18*0x3c*0x3c*0x3e8),_0x520c9b=this[_0x1248cc(0x175)][_0x1248cc(0x13b)](_0x1248cc(0x182)),_0x3b1990=await _0x520c9b['where']('user.createdAt\x20>=\x20:today',{'today':_0x33370d})[_0x1248cc(0x166)](_0x1248cc(0x177),{'tomorrow':_0x533034})['getCount']();return _0x3b1990;}async[_0x1e8e23(0x144)](){const _0x412020=_0x1e8e23,_0x3e751c=await this[_0x412020(0x185)][_0x412020(0x150)]({'where':{'type':balance_constant_1[_0x412020(0x16d)][_0x412020(0x1a2)]}});return _0x3e751c;}async[_0x1e8e23(0x153)](){const _0x1e4961=_0x1e8e23,_0x2448c2=new Date();_0x2448c2[_0x1e4961(0x143)](0x0,0x0,0x0,0x0);const _0x2ad68a=new Date(_0x2448c2[_0x1e4961(0x16c)]()+0x18*0x3c*0x3c*0x3e8),_0x54a173=this[_0x1e4961(0x185)]['createQueryBuilder']('chatLog'),_0x2d3b08=await _0x54a173[_0x1e4961(0x14c)]('chatLog.type\x20=\x20:type',{'type':balance_constant_1[_0x1e4961(0x16d)][_0x1e4961(0x1a2)]})[_0x1e4961(0x166)](_0x1e4961(0x192),{'today':_0x2448c2})[_0x1e4961(0x166)](_0x1e4961(0x189),{'tomorrow':_0x2ad68a})[_0x1e4961(0x135)]();return _0x2d3b08;}async[_0x1e8e23(0x19a)](){const _0x42ca6e=_0x1e8e23,_0x422729=await this[_0x42ca6e(0x185)][_0x42ca6e(0x150)]({'where':{'type':balance_constant_1[_0x42ca6e(0x16d)]['PAINT']}});return _0x422729;}async[_0x1e8e23(0x13e)](){const _0x327818=_0x1e8e23,_0x4d4f82=new Date();_0x4d4f82[_0x327818(0x143)](0x0,0x0,0x0,0x0);const _0x1b939a=new Date(_0x4d4f82[_0x327818(0x16c)]()+0x18*0x3c*0x3c*0x3e8),_0x4e563c=this[_0x327818(0x185)]['createQueryBuilder'](_0x327818(0x1a3)),_0x7ac324=await _0x4e563c['where'](_0x327818(0x132),{'type':balance_constant_1[_0x327818(0x16d)]['PAINT']})['andWhere'](_0x327818(0x192),{'today':_0x4d4f82})['andWhere'](_0x327818(0x189),{'tomorrow':_0x1b939a})[_0x327818(0x135)]();return _0x7ac324;}async[_0x1e8e23(0x13a)](_0x4d90d5){const _0x28df62=_0x1e8e23;var _0x585f35,_0x1a08d0;const _0x3b58e9=new Date();_0x3b58e9[_0x28df62(0x143)](0x0,0x0,0x0,0x0);const _0x10b2e6=new Date(_0x3b58e9[_0x28df62(0x16c)]()-(_0x4d90d5-0x1)*0x18*0x3c*0x3c*0x3e8),_0x25c48a=this[_0x28df62(0x185)]['createQueryBuilder'](_0x28df62(0x14a)),_0x4e2e84=await _0x25c48a[_0x28df62(0x194)]('DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count')[_0x28df62(0x14c)](_0x28df62(0x1a0),{'type':balance_constant_1[_0x28df62(0x16d)][_0x28df62(0x1a2)]})[_0x28df62(0x166)](_0x28df62(0x19b),{'startDate':_0x10b2e6})[_0x28df62(0x156)](_0x28df62(0x18f))['orderBy']('date')[_0x28df62(0x180)](),_0x3da089=[],_0x14b8b9=_0x10b2e6;for(let _0x2714b2=0x0;_0x2714b2<_0x4d90d5;_0x2714b2++){const _0x385ad0=(0x0,date_1[_0x28df62(0x162)])(new Date(_0x14b8b9),_0x28df62(0x14b)),_0x5f0716=(_0x1a08d0=(_0x585f35=_0x4e2e84[_0x28df62(0x15b)](_0x3373f2=>(0x0,date_1[_0x28df62(0x162)])(new Date(_0x3373f2[_0x28df62(0x18f)]),_0x28df62(0x14b))===_0x385ad0))===null||_0x585f35===void 0x0?void 0x0:_0x585f35[_0x28df62(0x150)])!==null&&_0x1a08d0!==void 0x0?_0x1a08d0:0x0;_0x5f0716>0x0?_0x3da089['push']({'date':_0x385ad0,'value':Number(_0x5f0716)}):_0x3da089[_0x28df62(0x1a6)]({'date':_0x385ad0,'value':0x0}),_0x14b8b9[_0x28df62(0x17c)](_0x14b8b9['getDate']()+0x1);}return _0x3da089;}async[_0x1e8e23(0x184)](_0x38ff8b){const _0x4dc731=_0x1e8e23;var _0x455ed5,_0x1a7507;const _0x1684a4=new Date();_0x1684a4['setHours'](0x0,0x0,0x0,0x0);const _0xf3135b=new Date(_0x1684a4[_0x4dc731(0x16c)]()-(_0x38ff8b-0x1)*0x18*0x3c*0x3c*0x3e8),_0x2bed0f=this[_0x4dc731(0x185)][_0x4dc731(0x13b)](_0x4dc731(0x14a)),_0x445290=await _0x2bed0f['select'](_0x4dc731(0x12f))[_0x4dc731(0x14c)](_0x4dc731(0x1a0),{'type':balance_constant_1['ChatType']['PAINT']})['andWhere'](_0x4dc731(0x19b),{'startDate':_0xf3135b})[_0x4dc731(0x156)](_0x4dc731(0x18f))['orderBy'](_0x4dc731(0x18f))[_0x4dc731(0x180)](),_0x6b315b=[],_0x26c4ca=_0xf3135b;for(let _0x16084c=0x0;_0x16084c<_0x38ff8b;_0x16084c++){const _0x134766=(0x0,date_1[_0x4dc731(0x162)])(new Date(_0x26c4ca),'M.DD'),_0x4d84eb=(_0x1a7507=(_0x455ed5=_0x445290['find'](_0x4e6d01=>(0x0,date_1[_0x4dc731(0x162)])(new Date(_0x4e6d01[_0x4dc731(0x18f)]),'M.DD')===_0x134766))===null||_0x455ed5===void 0x0?void 0x0:_0x455ed5[_0x4dc731(0x150)])!==null&&_0x1a7507!==void 0x0?_0x1a7507:0x0;_0x4d84eb>0x0?_0x6b315b[_0x4dc731(0x1a6)]({'date':_0x134766,'value':Number(_0x4d84eb)}):_0x6b315b['push']({'date':_0x134766,'value':0x0}),_0x26c4ca[_0x4dc731(0x17c)](_0x26c4ca['getDate']()+0x1);}return _0x6b315b;}async[_0x1e8e23(0x17b)](_0x30e153,_0x424ea3,_0x383a13){const _0xdd4ff6=_0x1e8e23,_0x26158a=_0xdd4ff6(0x1ac)+_0x383a13+_0xdd4ff6(0x16a)+_0x30e153+_0xdd4ff6(0x13f)+_0x424ea3;common_1[_0xdd4ff6(0x170)][_0xdd4ff6(0x16e)](_0xdd4ff6(0x159),_0x26158a);try{const _0x1d4458=await axios_1[_0xdd4ff6(0x19d)][_0xdd4ff6(0x168)](_0x26158a);if(_0x1d4458['status']===0xc8&&_0x1d4458['data'][_0xdd4ff6(0x158)])return{'accessToken':_0x1d4458[_0xdd4ff6(0x15a)][_0xdd4ff6(0x158)],'refreshToken':_0x1d4458[_0xdd4ff6(0x15a)][_0xdd4ff6(0x16f)]};else throw new Error(_0xdd4ff6(0x181));}catch(_0x5790ea){common_1[_0xdd4ff6(0x170)][_0xdd4ff6(0x141)]('获取新\x20accessToken\x20失败',{'message':_0x5790ea[_0xdd4ff6(0x167)],'stack':_0x5790ea[_0xdd4ff6(0x15d)],'response':_0x5790ea[_0xdd4ff6(0x152)]?_0x5790ea[_0xdd4ff6(0x152)][_0xdd4ff6(0x15a)]:_0xdd4ff6(0x14e)});throw new common_1[(_0xdd4ff6(0x1a4))](_0xdd4ff6(0x133),common_1[_0xdd4ff6(0x13d)]['BAD_REQUEST']);}}async['updateAccessTokenInDatabase'](_0x25e1e1,_0x10633d,_0x34ad9d){const _0x36054d=_0x1e8e23;await _0x34ad9d[_0x36054d(0x163)]({'configKey':'baiduToken'},{'configVal':_0x25e1e1}),await _0x34ad9d[_0x36054d(0x163)]({'configKey':_0x36054d(0x145)},{'configVal':_0x10633d});}async[_0x1e8e23(0x18b)](_0x235873){const _0x9602db=_0x1e8e23,_0x3a6a0e=(0x0,date_1[_0x9602db(0x162)])(new Date(),_0x9602db(0x186)),_0x5ea5c3=(0x0,date_1['formatDate'])(new Date(Date[_0x9602db(0x197)]()-Number(_0x235873-0x1)*0x18*0x3c*0x3c*0x3e8),_0x9602db(0x186)),_0x38ef58=_0x9602db(0x17f),_0x35ef82=_0x9602db(0x1aa),{baiduToken:_0x31054f,baiduSiteId:_0x2b2722,baiduApiKey:_0x17ac0b,baiduSecretKey:_0x27ee87,baiduRefreshToken:_0x3d4bd3}=await this[_0x9602db(0x1ab)][_0x9602db(0x148)]([_0x9602db(0x1a1),_0x9602db(0x198),_0x9602db(0x164),_0x9602db(0x18e),_0x9602db(0x145)]);if(!_0x17ac0b||!_0x2b2722||!_0x3d4bd3||!_0x27ee87)return[];let _0x55b05d=_0x31054f,_0xc7585d,_0x16300c;const _0x2c1465=async _0x28144a=>{const _0xe26813=_0x9602db;_0x16300c=_0xe26813(0x18c)+_0x28144a+_0xe26813(0x15e)+_0x2b2722+_0xe26813(0x172)+_0x35ef82+_0xe26813(0x179)+_0x5ea5c3+_0xe26813(0x18a)+_0x3a6a0e+_0xe26813(0x134)+_0x38ef58;try{return await axios_1[_0xe26813(0x19d)][_0xe26813(0x168)](_0x16300c);}catch(_0x160a9a){return{'data':{'error_code':0x6f,'message':'Access\x20token\x20invalid\x20or\x20no\x20longer\x20valid'}};}};_0xc7585d=await _0x2c1465(_0x55b05d);if(_0xc7585d[_0x9602db(0x15a)]['error_code']===0x6f||!_0x31054f){const {accessToken:_0xc9b4e3,refreshToken:_0x211edb}=await this[_0x9602db(0x17b)](_0x17ac0b,_0x27ee87,_0x3d4bd3);_0x55b05d=_0xc9b4e3,await this[_0x9602db(0x199)](_0x55b05d,_0x211edb,this[_0x9602db(0x13c)]),_0xc7585d=await _0x2c1465(_0x55b05d);}const {error_code:_0x589892,message:_0x39fb46}=_0xc7585d[_0x9602db(0x15a)];if(_0x589892&&_0x589892!==0xc8)throw new common_1[(_0x9602db(0x1a4))](_0x39fb46||'获取百度统计数据失败',common_1[_0x9602db(0x13d)][_0x9602db(0x187)]);return _0xc7585d[_0x9602db(0x15a)][_0x9602db(0x188)];}async[_0x1e8e23(0x138)](){const _0x443963=await this['orderEntity']['count']();return _0x443963;}async[_0x1e8e23(0x191)](){const _0x543334=_0x1e8e23,_0x1327f8=new Date();_0x1327f8[_0x543334(0x143)](0x0,0x0,0x0,0x0);const _0x3fbfe7=new Date(_0x1327f8[_0x543334(0x16c)]()+0x18*0x3c*0x3c*0x3e8),_0x5256a8=this[_0x543334(0x155)][_0x543334(0x13b)]('order'),_0x8e8943=await _0x5256a8['where']('order.createdAt\x20>=\x20:today',{'today':_0x1327f8})[_0x543334(0x166)]('order.createdAt\x20<\x20:tomorrow',{'tomorrow':_0x3fbfe7})['getCount']();return _0x8e8943;}};StatisticService=__decorate([(0x0,common_1[_0x1e8e23(0x151)])(),__param(0x0,(0x0,typeorm_1[_0x1e8e23(0x19c)])(user_entity_1['UserEntity'])),__param(0x1,(0x0,typeorm_1[_0x1e8e23(0x19c)])(chatLog_entity_1[_0x1e8e23(0x14f)])),__param(0x2,(0x0,typeorm_1[_0x1e8e23(0x19c)])(config_entity_1[_0x1e8e23(0x161)])),__param(0x3,(0x0,typeorm_1[_0x1e8e23(0x19c)])(order_entity_1[_0x1e8e23(0x178)])),__metadata(_0x1e8e23(0x1a8),[typeorm_2[_0x1e8e23(0x195)],typeorm_2[_0x1e8e23(0x195)],typeorm_2['Repository'],typeorm_2[_0x1e8e23(0x195)],globalConfig_service_1[_0x1e8e23(0x137)]])],StatisticService),exports[_0x1e8e23(0x1a7)]=StatisticService;