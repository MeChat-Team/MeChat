'use strict';const _0x33fe81=_0x3629;function _0x5b61(){const _0x5c4f3e=['error_code','message','refresh_token','Repository','getBaiduVisit','setHours','createQueryBuilder','pv_count,visitor_count,ip_count,bounce_ratio,avg_visit_time','@nestjs/typeorm','andWhere','typeorm','response','3498vUmeRW','design:paramtypes','countNewUsersToday','YYYYMMDD','__param','BAD_REQUEST','PAINT','map','InjectRepository','DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','getBaiduStatistics','setDate','getTime','4953411RKPgpP','ChatType','chatLog.type\x20=\x20:type','chatLog.createdAt\x20>=\x20:today','order.createdAt\x20>=\x20:today','defineProperty','log','../../common/utils/date','HttpStatus','chatLog','countUsers','获取百度统计数据失败','globalConfigService','ConfigEntity','40020qZQkoN','stack','user.createdAt\x20<\x20:tomorrow','update','baiduRefreshToken','746627BgNDWf','countDrawsByTimeRange','chatLog.createdAt\x20<\x20:tomorrow','__metadata','length','M.DD','55yGuNwy','63216lpbDEq','countChatsByTimeRange','&client_id=','Logger','push','baiduApiKey','501900ikOHzG','getConfigs','../chatLog/chatLog.entity','where','NORMAL_CHAT','GlobalConfigService','status','result','Failed\x20to\x20get\x20new\x20access\x20token','HttpException','function','../order/order.entity','../globalConfig/config.entity','decorate','value','orderEntity','getCount','__esModule','2JWbtMm','countNewChatsToday','metadata','updateAccessTokenInDatabase','data','获取新\x20accessToken\x20失败','countNewDrawsToday','baiduSecretKey','@nestjs/common','countChats','formatDate','countOrders','baiduToken','orderBy','&start_date=','__decorate','chatlog.createdAt\x20>=\x20:startDate','select','264403DjqjPL','now','439215kyUEHg','http://openapi.baidu.com/oauth/2.0/token?grant_type=refresh_token&refresh_token=','OrderEntity','getNewAccessToken','chatlog','No\x20response\x20data','configEntity','user','chatlog.type\x20=\x20:type','get','userEntity','../../common/constants/balance.constant','overview/getTimeTrendRpt','chatLogEntity','StatisticService','groupBy','order.createdAt\x20<\x20:tomorrow','count','ChatLogEntity','&metrics=','getDate','Injectable','countNewOrdersToday','default','date','object','24ogScEp'];_0x5b61=function(){return _0x5c4f3e;};return _0x5b61();}(function(_0x29790a,_0x4ca73a){const _0x110459=_0x3629,_0x35b981=_0x29790a();while(!![]){try{const _0x3667aa=parseInt(_0x110459(0x15f))/0x1+parseInt(_0x110459(0x14d))/0x2*(parseInt(_0x110459(0x161))/0x3)+parseInt(_0x110459(0x135))/0x4+parseInt(_0x110459(0x134))/0x5*(-parseInt(_0x110459(0x13b))/0x6)+-parseInt(_0x110459(0x12e))/0x7*(-parseInt(_0x110459(0x101))/0x8)+-parseInt(_0x110459(0x11b))/0x9+-parseInt(_0x110459(0x129))/0xa*(-parseInt(_0x110459(0x10e))/0xb);if(_0x3667aa===_0x4ca73a)break;else _0x35b981['push'](_0x35b981['shift']());}catch(_0x4a347f){_0x35b981['push'](_0x35b981['shift']());}}}(_0x5b61,0x85f5e));var __decorate=this&&this[_0x33fe81(0x15c)]||function(_0x3326e6,_0xf2580a,_0x1edd42,_0x3f9f19){const _0x3f8189=_0x33fe81;var _0x3df3c9=arguments[_0x3f8189(0x132)],_0x27eb99=_0x3df3c9<0x3?_0xf2580a:_0x3f9f19===null?_0x3f9f19=Object['getOwnPropertyDescriptor'](_0xf2580a,_0x1edd42):_0x3f9f19,_0x31346d;if(typeof Reflect===_0x3f8189(0x100)&&typeof Reflect[_0x3f8189(0x148)]===_0x3f8189(0x145))_0x27eb99=Reflect['decorate'](_0x3326e6,_0xf2580a,_0x1edd42,_0x3f9f19);else{for(var _0x3fe9a3=_0x3326e6[_0x3f8189(0x132)]-0x1;_0x3fe9a3>=0x0;_0x3fe9a3--)if(_0x31346d=_0x3326e6[_0x3fe9a3])_0x27eb99=(_0x3df3c9<0x3?_0x31346d(_0x27eb99):_0x3df3c9>0x3?_0x31346d(_0xf2580a,_0x1edd42,_0x27eb99):_0x31346d(_0xf2580a,_0x1edd42))||_0x27eb99;}return _0x3df3c9>0x3&&_0x27eb99&&Object[_0x3f8189(0x120)](_0xf2580a,_0x1edd42,_0x27eb99),_0x27eb99;},__metadata=this&&this[_0x33fe81(0x131)]||function(_0x120973,_0x33df60){const _0xeb1c6d=_0x33fe81;if(typeof Reflect===_0xeb1c6d(0x100)&&typeof Reflect['metadata']===_0xeb1c6d(0x145))return Reflect[_0xeb1c6d(0x14f)](_0x120973,_0x33df60);},__param=this&&this[_0x33fe81(0x112)]||function(_0x441bf7,_0xc539cb){return function(_0x30223d,_0x32a54d){_0xc539cb(_0x30223d,_0x32a54d,_0x441bf7);};};Object[_0x33fe81(0x120)](exports,_0x33fe81(0x14c),{'value':!![]}),exports[_0x33fe81(0xf5)]=void 0x0;const balance_constant_1=require(_0x33fe81(0xf2)),date_1=require(_0x33fe81(0x122)),common_1=require(_0x33fe81(0x155)),typeorm_1=require(_0x33fe81(0x10a)),axios_1=require('axios'),typeorm_2=require(_0x33fe81(0x10c)),chatLog_entity_1=require(_0x33fe81(0x13d)),config_entity_1=require(_0x33fe81(0x147)),globalConfig_service_1=require('../globalConfig/globalConfig.service'),order_entity_1=require(_0x33fe81(0x146)),user_entity_1=require('../user/user.entity');let StatisticService=class StatisticService{constructor(_0x2deae8,_0x5ae4e8,_0x440d9f,_0x2a235d,_0x217e90){const _0x536daf=_0x33fe81;this['userEntity']=_0x2deae8,this[_0x536daf(0xf4)]=_0x5ae4e8,this['configEntity']=_0x440d9f,this[_0x536daf(0x14a)]=_0x2a235d,this[_0x536daf(0x127)]=_0x217e90;}async['getBaseStatistic'](){const _0x426cf9=_0x33fe81,_0x4b4051=await this[_0x426cf9(0x125)](),_0x5baae5=await this[_0x426cf9(0x110)](),_0x4c5503=await this[_0x426cf9(0x156)](),_0x222eca=await this[_0x426cf9(0x14e)](),_0x46a7b0=await this['countDraws'](),_0x20d684=await this[_0x426cf9(0x153)](),_0x13ba25=await this['countOrders'](),_0x11e083=await this[_0x426cf9(0xfd)]();return{'userCount':_0x4b4051,'newUserCount':_0x5baae5,'chatCount':_0x4c5503,'newChatCount':_0x222eca,'drawCount':_0x46a7b0,'newDrawCount':_0x20d684,'orderCount':_0x13ba25,'newOrderCount':_0x11e083};}async['getChatStatistic']({days:days=0x7}){const _0xf36c9e=_0x33fe81,_0x5e4df7=await this[_0xf36c9e(0x136)](days),_0x2d5986=await this[_0xf36c9e(0x12f)](days);return{'date':_0x5e4df7[_0xf36c9e(0x115)](_0x44fc22=>_0x44fc22[_0xf36c9e(0xff)]),'chat':_0x5e4df7['map'](_0x234d47=>_0x234d47[_0xf36c9e(0x149)]),'draw':_0x2d5986[_0xf36c9e(0x115)]((_0x74c840,_0x3d57f2)=>{const _0x43f80b=_0xf36c9e;return _0x74c840[_0x43f80b(0x149)];})};}async[_0x33fe81(0x106)]({days:days=0x7}){const _0x28a8fe=_0x33fe81,_0x1ec170=await this[_0x28a8fe(0x118)](days);return _0x1ec170;}async[_0x33fe81(0x125)](){const _0x4cec66=await this['userEntity']['count']();return _0x4cec66;}async[_0x33fe81(0x110)](){const _0x404e31=_0x33fe81,_0x39ec90=new Date();_0x39ec90[_0x404e31(0x107)](0x0,0x0,0x0,0x0);const _0x4ae3db=new Date(_0x39ec90[_0x404e31(0x11a)]()+0x18*0x3c*0x3c*0x3e8),_0x42ff0f=this[_0x404e31(0x16b)][_0x404e31(0x108)](_0x404e31(0x168)),_0x4137ef=await _0x42ff0f[_0x404e31(0x13e)]('user.createdAt\x20>=\x20:today',{'today':_0x39ec90})['andWhere'](_0x404e31(0x12b),{'tomorrow':_0x4ae3db})[_0x404e31(0x14b)]();return _0x4137ef;}async['countChats'](){const _0x4511fd=_0x33fe81,_0x397201=await this[_0x4511fd(0xf4)]['count']({'where':{'type':balance_constant_1[_0x4511fd(0x11c)][_0x4511fd(0x13f)]}});return _0x397201;}async[_0x33fe81(0x14e)](){const _0x3546b9=_0x33fe81,_0x4aef6b=new Date();_0x4aef6b['setHours'](0x0,0x0,0x0,0x0);const _0x8e56=new Date(_0x4aef6b[_0x3546b9(0x11a)]()+0x18*0x3c*0x3c*0x3e8),_0x1c6d16=this[_0x3546b9(0xf4)]['createQueryBuilder'](_0x3546b9(0x124)),_0x4b5d52=await _0x1c6d16[_0x3546b9(0x13e)](_0x3546b9(0x11d),{'type':balance_constant_1[_0x3546b9(0x11c)]['NORMAL_CHAT']})[_0x3546b9(0x10b)](_0x3546b9(0x11e),{'today':_0x4aef6b})['andWhere'](_0x3546b9(0x130),{'tomorrow':_0x8e56})[_0x3546b9(0x14b)]();return _0x4b5d52;}async['countDraws'](){const _0x3431b5=_0x33fe81,_0x13b3b5=await this[_0x3431b5(0xf4)]['count']({'where':{'type':balance_constant_1['ChatType'][_0x3431b5(0x114)]}});return _0x13b3b5;}async[_0x33fe81(0x153)](){const _0x3ab8ad=_0x33fe81,_0x36602d=new Date();_0x36602d[_0x3ab8ad(0x107)](0x0,0x0,0x0,0x0);const _0x1091f0=new Date(_0x36602d[_0x3ab8ad(0x11a)]()+0x18*0x3c*0x3c*0x3e8),_0xdda978=this[_0x3ab8ad(0xf4)]['createQueryBuilder']('chatLog'),_0x48235c=await _0xdda978[_0x3ab8ad(0x13e)](_0x3ab8ad(0x11d),{'type':balance_constant_1[_0x3ab8ad(0x11c)][_0x3ab8ad(0x114)]})[_0x3ab8ad(0x10b)](_0x3ab8ad(0x11e),{'today':_0x36602d})[_0x3ab8ad(0x10b)]('chatLog.createdAt\x20<\x20:tomorrow',{'tomorrow':_0x1091f0})[_0x3ab8ad(0x14b)]();return _0x48235c;}async[_0x33fe81(0x136)](_0x4bf56d){const _0x120cc9=_0x33fe81;var _0x158996,_0x509bad;const _0x4f4586=new Date();_0x4f4586[_0x120cc9(0x107)](0x0,0x0,0x0,0x0);const _0x324fa0=new Date(_0x4f4586[_0x120cc9(0x11a)]()-(_0x4bf56d-0x1)*0x18*0x3c*0x3c*0x3e8),_0x533904=this[_0x120cc9(0xf4)][_0x120cc9(0x108)](_0x120cc9(0x165)),_0x5af0ea=await _0x533904['select'](_0x120cc9(0x117))['where'](_0x120cc9(0x169),{'type':balance_constant_1[_0x120cc9(0x11c)][_0x120cc9(0x13f)]})[_0x120cc9(0x10b)]('chatlog.createdAt\x20>=\x20:startDate',{'startDate':_0x324fa0})[_0x120cc9(0xf6)](_0x120cc9(0xff))[_0x120cc9(0x15a)](_0x120cc9(0xff))['getRawMany'](),_0x31eec2=[],_0x289ec9=_0x324fa0;for(let _0xbfd6d0=0x0;_0xbfd6d0<_0x4bf56d;_0xbfd6d0++){const _0x135c62=(0x0,date_1[_0x120cc9(0x157)])(new Date(_0x289ec9),_0x120cc9(0x133)),_0x253db0=(_0x509bad=(_0x158996=_0x5af0ea['find'](_0x46968e=>(0x0,date_1[_0x120cc9(0x157)])(new Date(_0x46968e[_0x120cc9(0xff)]),'M.DD')===_0x135c62))===null||_0x158996===void 0x0?void 0x0:_0x158996['count'])!==null&&_0x509bad!==void 0x0?_0x509bad:0x0;_0x253db0>0x0?_0x31eec2[_0x120cc9(0x139)]({'date':_0x135c62,'value':Number(_0x253db0)}):_0x31eec2[_0x120cc9(0x139)]({'date':_0x135c62,'value':0x0}),_0x289ec9[_0x120cc9(0x119)](_0x289ec9[_0x120cc9(0xfb)]()+0x1);}return _0x31eec2;}async['countDrawsByTimeRange'](_0x1013e6){const _0x17ab4c=_0x33fe81;var _0x74ca13,_0x100c25;const _0x380045=new Date();_0x380045[_0x17ab4c(0x107)](0x0,0x0,0x0,0x0);const _0x344d77=new Date(_0x380045[_0x17ab4c(0x11a)]()-(_0x1013e6-0x1)*0x18*0x3c*0x3c*0x3e8),_0x5182dc=this[_0x17ab4c(0xf4)][_0x17ab4c(0x108)](_0x17ab4c(0x165)),_0x479d7d=await _0x5182dc[_0x17ab4c(0x15e)](_0x17ab4c(0x117))[_0x17ab4c(0x13e)]('chatlog.type\x20=\x20:type',{'type':balance_constant_1[_0x17ab4c(0x11c)][_0x17ab4c(0x114)]})[_0x17ab4c(0x10b)](_0x17ab4c(0x15d),{'startDate':_0x344d77})[_0x17ab4c(0xf6)](_0x17ab4c(0xff))['orderBy'](_0x17ab4c(0xff))['getRawMany'](),_0x1e67df=[],_0x54238d=_0x344d77;for(let _0x56dc38=0x0;_0x56dc38<_0x1013e6;_0x56dc38++){const _0x571b87=(0x0,date_1[_0x17ab4c(0x157)])(new Date(_0x54238d),_0x17ab4c(0x133)),_0x305c0a=(_0x100c25=(_0x74ca13=_0x479d7d['find'](_0x3d1229=>(0x0,date_1[_0x17ab4c(0x157)])(new Date(_0x3d1229[_0x17ab4c(0xff)]),_0x17ab4c(0x133))===_0x571b87))===null||_0x74ca13===void 0x0?void 0x0:_0x74ca13['count'])!==null&&_0x100c25!==void 0x0?_0x100c25:0x0;_0x305c0a>0x0?_0x1e67df[_0x17ab4c(0x139)]({'date':_0x571b87,'value':Number(_0x305c0a)}):_0x1e67df[_0x17ab4c(0x139)]({'date':_0x571b87,'value':0x0}),_0x54238d[_0x17ab4c(0x119)](_0x54238d[_0x17ab4c(0xfb)]()+0x1);}return _0x1e67df;}async[_0x33fe81(0x164)](_0x591df4,_0x3760d1,_0x2e8098){const _0x2bdcfc=_0x33fe81,_0x383d4f=_0x2bdcfc(0x162)+_0x2e8098+_0x2bdcfc(0x137)+_0x591df4+'&client_secret='+_0x3760d1;common_1[_0x2bdcfc(0x138)][_0x2bdcfc(0x121)]('获取新\x20accessToken',_0x383d4f);try{const _0x3bdcff=await axios_1['default'][_0x2bdcfc(0x16a)](_0x383d4f);if(_0x3bdcff[_0x2bdcfc(0x141)]===0xc8&&_0x3bdcff[_0x2bdcfc(0x151)]['access_token'])return{'accessToken':_0x3bdcff[_0x2bdcfc(0x151)]['access_token'],'refreshToken':_0x3bdcff[_0x2bdcfc(0x151)][_0x2bdcfc(0x104)]};else throw new Error(_0x2bdcfc(0x143));}catch(_0x39b26a){common_1['Logger']['error'](_0x2bdcfc(0x152),{'message':_0x39b26a[_0x2bdcfc(0x103)],'stack':_0x39b26a[_0x2bdcfc(0x12a)],'response':_0x39b26a[_0x2bdcfc(0x10d)]?_0x39b26a[_0x2bdcfc(0x10d)]['data']:_0x2bdcfc(0x166)});throw new common_1[(_0x2bdcfc(0x144))](_0x2bdcfc(0x152),common_1[_0x2bdcfc(0x123)][_0x2bdcfc(0x113)]);}}async[_0x33fe81(0x150)](_0x3ecdbf,_0x33955b,_0x1b3141){const _0x2e8c31=_0x33fe81;await _0x1b3141[_0x2e8c31(0x12c)]({'configKey':_0x2e8c31(0x159)},{'configVal':_0x3ecdbf}),await _0x1b3141[_0x2e8c31(0x12c)]({'configKey':_0x2e8c31(0x12d)},{'configVal':_0x33955b});}async[_0x33fe81(0x118)](_0x592ec6){const _0x4d0ec4=_0x33fe81,_0x2c4055=(0x0,date_1[_0x4d0ec4(0x157)])(new Date(),_0x4d0ec4(0x111)),_0x9d6eb1=(0x0,date_1[_0x4d0ec4(0x157)])(new Date(Date[_0x4d0ec4(0x160)]()-Number(_0x592ec6-0x1)*0x18*0x3c*0x3c*0x3e8),_0x4d0ec4(0x111)),_0x4443e4=_0x4d0ec4(0x109),_0x33d1aa=_0x4d0ec4(0xf3),{baiduToken:_0x1c381a,baiduSiteId:_0x558758,baiduApiKey:_0x4dd1bf,baiduSecretKey:_0x30fe4b,baiduRefreshToken:_0x51e081}=await this[_0x4d0ec4(0x127)][_0x4d0ec4(0x13c)](['baiduToken','baiduSiteId',_0x4d0ec4(0x13a),_0x4d0ec4(0x154),_0x4d0ec4(0x12d)]);if(!_0x4dd1bf||!_0x558758||!_0x51e081||!_0x30fe4b)return[];let _0x232056=_0x1c381a,_0xfe38e2,_0x14de04;const _0x3a28bf=async _0xb96f9b=>{const _0xc486c0=_0x4d0ec4;_0x14de04='https://openapi.baidu.com/rest/2.0/tongji/report/getData?access_token='+_0xb96f9b+'&site_id='+_0x558758+'&method='+_0x33d1aa+_0xc486c0(0x15b)+_0x9d6eb1+'&end_date='+_0x2c4055+_0xc486c0(0xfa)+_0x4443e4;try{return await axios_1[_0xc486c0(0xfe)][_0xc486c0(0x16a)](_0x14de04);}catch(_0x3a7b5f){return{'data':{'error_code':0x6f,'message':'Access\x20token\x20invalid\x20or\x20no\x20longer\x20valid'}};}};_0xfe38e2=await _0x3a28bf(_0x232056);if(_0xfe38e2[_0x4d0ec4(0x151)][_0x4d0ec4(0x102)]===0x6f||!_0x1c381a){const {accessToken:_0x4f1242,refreshToken:_0x48f316}=await this[_0x4d0ec4(0x164)](_0x4dd1bf,_0x30fe4b,_0x51e081);_0x232056=_0x4f1242,await this[_0x4d0ec4(0x150)](_0x232056,_0x48f316,this[_0x4d0ec4(0x167)]),_0xfe38e2=await _0x3a28bf(_0x232056);}const {error_code:_0x32edc7,message:_0x323859}=_0xfe38e2[_0x4d0ec4(0x151)];if(_0x32edc7&&_0x32edc7!==0xc8)throw new common_1[(_0x4d0ec4(0x144))](_0x323859||_0x4d0ec4(0x126),common_1[_0x4d0ec4(0x123)][_0x4d0ec4(0x113)]);return _0xfe38e2[_0x4d0ec4(0x151)][_0x4d0ec4(0x142)];}async[_0x33fe81(0x158)](){const _0x1b0fd2=_0x33fe81,_0xcf257e=await this[_0x1b0fd2(0x14a)][_0x1b0fd2(0xf8)]();return _0xcf257e;}async[_0x33fe81(0xfd)](){const _0x4c8da9=_0x33fe81,_0x33f1f9=new Date();_0x33f1f9['setHours'](0x0,0x0,0x0,0x0);const _0x2f8078=new Date(_0x33f1f9[_0x4c8da9(0x11a)]()+0x18*0x3c*0x3c*0x3e8),_0x44ff39=this[_0x4c8da9(0x14a)][_0x4c8da9(0x108)]('order'),_0xd4fee6=await _0x44ff39[_0x4c8da9(0x13e)](_0x4c8da9(0x11f),{'today':_0x33f1f9})[_0x4c8da9(0x10b)](_0x4c8da9(0xf7),{'tomorrow':_0x2f8078})[_0x4c8da9(0x14b)]();return _0xd4fee6;}};function _0x3629(_0x3422f5,_0x1d1e33){const _0x5b6175=_0x5b61();return _0x3629=function(_0x362986,_0x554c3f){_0x362986=_0x362986-0xf2;let _0x4a762e=_0x5b6175[_0x362986];return _0x4a762e;},_0x3629(_0x3422f5,_0x1d1e33);}StatisticService=__decorate([(0x0,common_1[_0x33fe81(0xfc)])(),__param(0x0,(0x0,typeorm_1[_0x33fe81(0x116)])(user_entity_1['UserEntity'])),__param(0x1,(0x0,typeorm_1[_0x33fe81(0x116)])(chatLog_entity_1[_0x33fe81(0xf9)])),__param(0x2,(0x0,typeorm_1[_0x33fe81(0x116)])(config_entity_1[_0x33fe81(0x128)])),__param(0x3,(0x0,typeorm_1[_0x33fe81(0x116)])(order_entity_1[_0x33fe81(0x163)])),__metadata(_0x33fe81(0x10f),[typeorm_2[_0x33fe81(0x105)],typeorm_2[_0x33fe81(0x105)],typeorm_2[_0x33fe81(0x105)],typeorm_2[_0x33fe81(0x105)],globalConfig_service_1[_0x33fe81(0x140)]])],StatisticService),exports[_0x33fe81(0xf5)]=StatisticService;