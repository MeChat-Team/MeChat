'use strict';function _0x4152(){const _0xfd394a=['getRawMany','user.createdAt\x20<\x20:tomorrow','getBaiduStatistics','chatLogEntity','groupBy','&start_date=','countNewUsersToday','andWhere','BAD_REQUEST','pv_count,visitor_count,ip_count,bounce_ratio,avg_visit_time','@nestjs/common','message','chatLog','2695705bCVTZW','length','push','http://openapi.baidu.com/oauth/2.0/token?grant_type=refresh_token&refresh_token=','StatisticService','../chatLog/chatLog.entity','defineProperty','countOrders','where','&client_secret=','../globalConfig/globalConfig.service','updateAccessTokenInDatabase','formatDate','getTime','getConfigs','chatLog.type\x20=\x20:type','__metadata','2880rXYGKZ','Logger','getCount','ChatType','date','default','now','countChatsByTimeRange','M.DD','function','&end_date=','baiduToken','No\x20response\x20data','stack','&metrics=','countUsers','response','setHours','baiduSecretKey','获取新\x20accessToken\x20失败','Access\x20token\x20invalid\x20or\x20no\x20longer\x20valid','ChatLogEntity','Repository','7175ctMQSs','HttpStatus','orderEntity','../globalConfig/config.entity','DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','555024RqeiOv','countNewDrawsToday','access_token','1625360UswCgd','axios','data','24wRfxQD','获取新\x20accessToken','error_code','error','countDrawsByTimeRange','getDate','Failed\x20to\x20get\x20new\x20access\x20token','getChatStatistic','ConfigEntity','select','result','find','order','7710183dgkhQC','baiduApiKey','countNewChatsToday','&client_id=','overview/getTimeTrendRpt','YYYYMMDD','GlobalConfigService','6wVwuEM','获取百度统计数据失败','&site_id=','__param','typeorm','value','countNewOrdersToday','countDraws','setDate','OrderEntity','chatLog.createdAt\x20<\x20:tomorrow','InjectRepository','createQueryBuilder','map','NORMAL_CHAT','get','configEntity','object','../../common/constants/balance.constant','140buMNQr','order.createdAt\x20>=\x20:today','userEntity','chatlog.createdAt\x20>=\x20:startDate','metadata','globalConfigService','getNewAccessToken','PAINT','order.createdAt\x20<\x20:tomorrow','getBaseStatistic','orderBy','chatLog.createdAt\x20>=\x20:today','HttpException','chatlog.type\x20=\x20:type','design:paramtypes','count','user.createdAt\x20>=\x20:today','chatlog','countChats','baiduRefreshToken','Injectable','608216GGfgdH','baiduSiteId','update','894389NLQGAZ','log','refresh_token'];_0x4152=function(){return _0xfd394a;};return _0x4152();}const _0x15c49d=_0x2499;(function(_0x196411,_0xd101c2){const _0x1fc1d7=_0x2499,_0x5149d8=_0x196411();while(!![]){try{const _0x34203f=parseInt(_0x1fc1d7(0x1f1))/0x1+-parseInt(_0x1fc1d7(0x1ee))/0x2+parseInt(_0x1fc1d7(0x1ac))/0x3*(parseInt(_0x1fc1d7(0x1b2))/0x4)+parseInt(_0x1fc1d7(0x201))/0x5*(parseInt(_0x1fc1d7(0x1c6))/0x6)+parseInt(_0x1fc1d7(0x229))/0x7*(-parseInt(_0x1fc1d7(0x212))/0x8)+parseInt(_0x1fc1d7(0x1bf))/0x9+-parseInt(_0x1fc1d7(0x1d9))/0xa*(parseInt(_0x1fc1d7(0x1af))/0xb);if(_0x34203f===_0xd101c2)break;else _0x5149d8['push'](_0x5149d8['shift']());}catch(_0x17c827){_0x5149d8['push'](_0x5149d8['shift']());}}}(_0x4152,0xa0c55));var __decorate=this&&this['__decorate']||function(_0x4f451f,_0x1e3083,_0x54b118,_0x1e0d33){const _0x4be1ae=_0x2499;var _0x54e7f8=arguments['length'],_0x3dacd6=_0x54e7f8<0x3?_0x1e3083:_0x1e0d33===null?_0x1e0d33=Object['getOwnPropertyDescriptor'](_0x1e3083,_0x54b118):_0x1e0d33,_0x6864c5;if(typeof Reflect===_0x4be1ae(0x1d7)&&typeof Reflect['decorate']==='function')_0x3dacd6=Reflect['decorate'](_0x4f451f,_0x1e3083,_0x54b118,_0x1e0d33);else{for(var _0x2724f8=_0x4f451f[_0x4be1ae(0x202)]-0x1;_0x2724f8>=0x0;_0x2724f8--)if(_0x6864c5=_0x4f451f[_0x2724f8])_0x3dacd6=(_0x54e7f8<0x3?_0x6864c5(_0x3dacd6):_0x54e7f8>0x3?_0x6864c5(_0x1e3083,_0x54b118,_0x3dacd6):_0x6864c5(_0x1e3083,_0x54b118))||_0x3dacd6;}return _0x54e7f8>0x3&&_0x3dacd6&&Object[_0x4be1ae(0x207)](_0x1e3083,_0x54b118,_0x3dacd6),_0x3dacd6;},__metadata=this&&this[_0x15c49d(0x211)]||function(_0x5c4e5c,_0x46790b){const _0x5dcfdb=_0x15c49d;if(typeof Reflect===_0x5dcfdb(0x1d7)&&typeof Reflect[_0x5dcfdb(0x1dd)]===_0x5dcfdb(0x21b))return Reflect[_0x5dcfdb(0x1dd)](_0x5c4e5c,_0x46790b);},__param=this&&this[_0x15c49d(0x1c9)]||function(_0x42da21,_0x44fbd8){return function(_0x376852,_0x8e2a04){_0x44fbd8(_0x376852,_0x8e2a04,_0x42da21);};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports['StatisticService']=void 0x0;const balance_constant_1=require(_0x15c49d(0x1d8)),date_1=require('../../common/utils/date'),common_1=require(_0x15c49d(0x1fe)),typeorm_1=require('@nestjs/typeorm'),axios_1=require(_0x15c49d(0x1b0)),typeorm_2=require(_0x15c49d(0x1ca)),chatLog_entity_1=require(_0x15c49d(0x206)),config_entity_1=require(_0x15c49d(0x1aa)),globalConfig_service_1=require(_0x15c49d(0x20b)),order_entity_1=require('../order/order.entity'),user_entity_1=require('../user/user.entity');function _0x2499(_0x15fc92,_0xa0def5){const _0x415246=_0x4152();return _0x2499=function(_0x249946,_0x37612c){_0x249946=_0x249946-0x1a8;let _0x3d45b3=_0x415246[_0x249946];return _0x3d45b3;},_0x2499(_0x15fc92,_0xa0def5);}let StatisticService=class StatisticService{constructor(_0x43b68e,_0x5c88bc,_0x5e5a3a,_0x5a15d8,_0x199ade){const _0x372d15=_0x15c49d;this['userEntity']=_0x43b68e,this[_0x372d15(0x1f7)]=_0x5c88bc,this[_0x372d15(0x1d6)]=_0x5e5a3a,this['orderEntity']=_0x5a15d8,this[_0x372d15(0x1de)]=_0x199ade;}async[_0x15c49d(0x1e2)](){const _0x109280=_0x15c49d,_0x2a0b61=await this[_0x109280(0x221)](),_0x39b298=await this[_0x109280(0x1fa)](),_0x15a931=await this[_0x109280(0x1eb)](),_0x5ae0b8=await this[_0x109280(0x1c1)](),_0x38a2aa=await this[_0x109280(0x1cd)](),_0x4bd99a=await this['countNewDrawsToday'](),_0x1dca7b=await this['countOrders'](),_0x19f3a1=await this[_0x109280(0x1cc)]();return{'userCount':_0x2a0b61,'newUserCount':_0x39b298,'chatCount':_0x15a931,'newChatCount':_0x5ae0b8,'drawCount':_0x38a2aa,'newDrawCount':_0x4bd99a,'orderCount':_0x1dca7b,'newOrderCount':_0x19f3a1};}async[_0x15c49d(0x1b9)]({days:days=0x7}){const _0x157b82=_0x15c49d,_0x51610b=await this[_0x157b82(0x219)](days),_0x74f03e=await this[_0x157b82(0x1b6)](days);return{'date':_0x51610b[_0x157b82(0x1d3)](_0x23fa03=>_0x23fa03[_0x157b82(0x216)]),'chat':_0x51610b['map'](_0x23bdb0=>_0x23bdb0[_0x157b82(0x1cb)]),'draw':_0x74f03e['map']((_0x47c205,_0x273b87)=>{const _0x162660=_0x157b82;return _0x47c205[_0x162660(0x1cb)];})};}async['getBaiduVisit']({days:days=0x7}){const _0x285f66=await this['getBaiduStatistics'](days);return _0x285f66;}async['countUsers'](){const _0x57b3b9=_0x15c49d,_0x37a016=await this[_0x57b3b9(0x1db)][_0x57b3b9(0x1e8)]();return _0x37a016;}async['countNewUsersToday'](){const _0x3fffb4=_0x15c49d,_0xb235ea=new Date();_0xb235ea[_0x3fffb4(0x223)](0x0,0x0,0x0,0x0);const _0x3d0922=new Date(_0xb235ea[_0x3fffb4(0x20e)]()+0x18*0x3c*0x3c*0x3e8),_0x3ea226=this[_0x3fffb4(0x1db)][_0x3fffb4(0x1d2)]('user'),_0x219c69=await _0x3ea226[_0x3fffb4(0x209)](_0x3fffb4(0x1e9),{'today':_0xb235ea})[_0x3fffb4(0x1fb)](_0x3fffb4(0x1f5),{'tomorrow':_0x3d0922})['getCount']();return _0x219c69;}async['countChats'](){const _0x50da2e=_0x15c49d,_0x533a06=await this['chatLogEntity'][_0x50da2e(0x1e8)]({'where':{'type':balance_constant_1[_0x50da2e(0x215)][_0x50da2e(0x1d4)]}});return _0x533a06;}async[_0x15c49d(0x1c1)](){const _0x53d1e2=_0x15c49d,_0x1b29fe=new Date();_0x1b29fe[_0x53d1e2(0x223)](0x0,0x0,0x0,0x0);const _0x1f7e47=new Date(_0x1b29fe[_0x53d1e2(0x20e)]()+0x18*0x3c*0x3c*0x3e8),_0x4e8c80=this[_0x53d1e2(0x1f7)][_0x53d1e2(0x1d2)](_0x53d1e2(0x200)),_0x4ca9b0=await _0x4e8c80[_0x53d1e2(0x209)]('chatLog.type\x20=\x20:type',{'type':balance_constant_1[_0x53d1e2(0x215)]['NORMAL_CHAT']})[_0x53d1e2(0x1fb)](_0x53d1e2(0x1e4),{'today':_0x1b29fe})['andWhere'](_0x53d1e2(0x1d0),{'tomorrow':_0x1f7e47})[_0x53d1e2(0x214)]();return _0x4ca9b0;}async[_0x15c49d(0x1cd)](){const _0x5af6bc=_0x15c49d,_0x1e2aa3=await this['chatLogEntity'][_0x5af6bc(0x1e8)]({'where':{'type':balance_constant_1[_0x5af6bc(0x215)][_0x5af6bc(0x1e0)]}});return _0x1e2aa3;}async[_0x15c49d(0x1ad)](){const _0x46930f=_0x15c49d,_0x928671=new Date();_0x928671[_0x46930f(0x223)](0x0,0x0,0x0,0x0);const _0x4f9bad=new Date(_0x928671[_0x46930f(0x20e)]()+0x18*0x3c*0x3c*0x3e8),_0x4784fd=this[_0x46930f(0x1f7)][_0x46930f(0x1d2)](_0x46930f(0x200)),_0x1b8487=await _0x4784fd[_0x46930f(0x209)](_0x46930f(0x210),{'type':balance_constant_1['ChatType'][_0x46930f(0x1e0)]})['andWhere'](_0x46930f(0x1e4),{'today':_0x928671})[_0x46930f(0x1fb)](_0x46930f(0x1d0),{'tomorrow':_0x4f9bad})[_0x46930f(0x214)]();return _0x1b8487;}async[_0x15c49d(0x219)](_0x290b19){const _0x66e6ce=_0x15c49d;var _0x2cf25f,_0xed145f;const _0xcc4ff0=new Date();_0xcc4ff0[_0x66e6ce(0x223)](0x0,0x0,0x0,0x0);const _0x5796f5=new Date(_0xcc4ff0['getTime']()-(_0x290b19-0x1)*0x18*0x3c*0x3c*0x3e8),_0x518800=this[_0x66e6ce(0x1f7)][_0x66e6ce(0x1d2)](_0x66e6ce(0x1ea)),_0x44c780=await _0x518800[_0x66e6ce(0x1bb)](_0x66e6ce(0x1ab))[_0x66e6ce(0x209)](_0x66e6ce(0x1e6),{'type':balance_constant_1[_0x66e6ce(0x215)][_0x66e6ce(0x1d4)]})['andWhere']('chatlog.createdAt\x20>=\x20:startDate',{'startDate':_0x5796f5})[_0x66e6ce(0x1f8)](_0x66e6ce(0x216))[_0x66e6ce(0x1e3)](_0x66e6ce(0x216))[_0x66e6ce(0x1f4)](),_0x28e35a=[],_0x2fe4e6=_0x5796f5;for(let _0x55af5d=0x0;_0x55af5d<_0x290b19;_0x55af5d++){const _0x44c90c=(0x0,date_1[_0x66e6ce(0x20d)])(new Date(_0x2fe4e6),'M.DD'),_0x9c4348=(_0xed145f=(_0x2cf25f=_0x44c780[_0x66e6ce(0x1bd)](_0x4a06e7=>(0x0,date_1[_0x66e6ce(0x20d)])(new Date(_0x4a06e7['date']),'M.DD')===_0x44c90c))===null||_0x2cf25f===void 0x0?void 0x0:_0x2cf25f[_0x66e6ce(0x1e8)])!==null&&_0xed145f!==void 0x0?_0xed145f:0x0;_0x9c4348>0x0?_0x28e35a[_0x66e6ce(0x203)]({'date':_0x44c90c,'value':Number(_0x9c4348)}):_0x28e35a[_0x66e6ce(0x203)]({'date':_0x44c90c,'value':0x0}),_0x2fe4e6[_0x66e6ce(0x1ce)](_0x2fe4e6[_0x66e6ce(0x1b7)]()+0x1);}return _0x28e35a;}async[_0x15c49d(0x1b6)](_0x155b06){const _0x49f010=_0x15c49d;var _0x5b108c,_0x2826a4;const _0x160406=new Date();_0x160406[_0x49f010(0x223)](0x0,0x0,0x0,0x0);const _0x13ea17=new Date(_0x160406['getTime']()-(_0x155b06-0x1)*0x18*0x3c*0x3c*0x3e8),_0x2b69d0=this['chatLogEntity'][_0x49f010(0x1d2)](_0x49f010(0x1ea)),_0x16e160=await _0x2b69d0[_0x49f010(0x1bb)](_0x49f010(0x1ab))[_0x49f010(0x209)](_0x49f010(0x1e6),{'type':balance_constant_1[_0x49f010(0x215)][_0x49f010(0x1e0)]})[_0x49f010(0x1fb)](_0x49f010(0x1dc),{'startDate':_0x13ea17})[_0x49f010(0x1f8)](_0x49f010(0x216))[_0x49f010(0x1e3)]('date')[_0x49f010(0x1f4)](),_0x5993b7=[],_0xc40b82=_0x13ea17;for(let _0x8b7a28=0x0;_0x8b7a28<_0x155b06;_0x8b7a28++){const _0x593407=(0x0,date_1[_0x49f010(0x20d)])(new Date(_0xc40b82),_0x49f010(0x21a)),_0x294299=(_0x2826a4=(_0x5b108c=_0x16e160[_0x49f010(0x1bd)](_0x2f045c=>(0x0,date_1[_0x49f010(0x20d)])(new Date(_0x2f045c[_0x49f010(0x216)]),'M.DD')===_0x593407))===null||_0x5b108c===void 0x0?void 0x0:_0x5b108c[_0x49f010(0x1e8)])!==null&&_0x2826a4!==void 0x0?_0x2826a4:0x0;_0x294299>0x0?_0x5993b7[_0x49f010(0x203)]({'date':_0x593407,'value':Number(_0x294299)}):_0x5993b7[_0x49f010(0x203)]({'date':_0x593407,'value':0x0}),_0xc40b82[_0x49f010(0x1ce)](_0xc40b82[_0x49f010(0x1b7)]()+0x1);}return _0x5993b7;}async['getNewAccessToken'](_0x43aa01,_0x123555,_0x303b20){const _0x337d79=_0x15c49d,_0x99b4ac=_0x337d79(0x204)+_0x303b20+_0x337d79(0x1c2)+_0x43aa01+_0x337d79(0x20a)+_0x123555;common_1[_0x337d79(0x213)][_0x337d79(0x1f2)](_0x337d79(0x1b3),_0x99b4ac);try{const _0x54c1ad=await axios_1[_0x337d79(0x217)][_0x337d79(0x1d5)](_0x99b4ac);if(_0x54c1ad['status']===0xc8&&_0x54c1ad[_0x337d79(0x1b1)][_0x337d79(0x1ae)])return{'accessToken':_0x54c1ad['data'][_0x337d79(0x1ae)],'refreshToken':_0x54c1ad[_0x337d79(0x1b1)][_0x337d79(0x1f3)]};else throw new Error(_0x337d79(0x1b8));}catch(_0x7c4c65){common_1['Logger'][_0x337d79(0x1b5)](_0x337d79(0x225),{'message':_0x7c4c65[_0x337d79(0x1ff)],'stack':_0x7c4c65[_0x337d79(0x21f)],'response':_0x7c4c65[_0x337d79(0x222)]?_0x7c4c65[_0x337d79(0x222)][_0x337d79(0x1b1)]:_0x337d79(0x21e)});throw new common_1['HttpException'](_0x337d79(0x225),common_1[_0x337d79(0x1a8)]['BAD_REQUEST']);}}async[_0x15c49d(0x20c)](_0x17c4e3,_0x4c20ff,_0x2c4f8c){const _0x5cb135=_0x15c49d;await _0x2c4f8c[_0x5cb135(0x1f0)]({'configKey':_0x5cb135(0x21d)},{'configVal':_0x17c4e3}),await _0x2c4f8c['update']({'configKey':'baiduRefreshToken'},{'configVal':_0x4c20ff});}async[_0x15c49d(0x1f6)](_0x40fb9f){const _0x59f0cc=_0x15c49d,_0x462072=(0x0,date_1[_0x59f0cc(0x20d)])(new Date(),_0x59f0cc(0x1c4)),_0x24a2f3=(0x0,date_1[_0x59f0cc(0x20d)])(new Date(Date[_0x59f0cc(0x218)]()-Number(_0x40fb9f-0x1)*0x18*0x3c*0x3c*0x3e8),_0x59f0cc(0x1c4)),_0x1a5eb1=_0x59f0cc(0x1fd),_0x328e15=_0x59f0cc(0x1c3),{baiduToken:_0x12033c,baiduSiteId:_0x83ff98,baiduApiKey:_0x1eaed8,baiduSecretKey:_0x2fe5c2,baiduRefreshToken:_0x380651}=await this['globalConfigService'][_0x59f0cc(0x20f)]([_0x59f0cc(0x21d),_0x59f0cc(0x1ef),_0x59f0cc(0x1c0),_0x59f0cc(0x224),_0x59f0cc(0x1ec)]);if(!_0x1eaed8||!_0x83ff98||!_0x380651||!_0x2fe5c2)return[];let _0x4b2c47=_0x12033c,_0x5a0681,_0x2c04e9;const _0x57ea87=async _0x521f85=>{const _0x2b5169=_0x59f0cc;_0x2c04e9='https://openapi.baidu.com/rest/2.0/tongji/report/getData?access_token='+_0x521f85+_0x2b5169(0x1c8)+_0x83ff98+'&method='+_0x328e15+_0x2b5169(0x1f9)+_0x24a2f3+_0x2b5169(0x21c)+_0x462072+_0x2b5169(0x220)+_0x1a5eb1;try{return await axios_1[_0x2b5169(0x217)]['get'](_0x2c04e9);}catch(_0x156a65){return{'data':{'error_code':0x6f,'message':_0x2b5169(0x226)}};}};_0x5a0681=await _0x57ea87(_0x4b2c47);if(_0x5a0681[_0x59f0cc(0x1b1)][_0x59f0cc(0x1b4)]===0x6f||!_0x12033c){const {accessToken:_0x58934b,refreshToken:_0x3765b6}=await this[_0x59f0cc(0x1df)](_0x1eaed8,_0x2fe5c2,_0x380651);_0x4b2c47=_0x58934b,await this[_0x59f0cc(0x20c)](_0x4b2c47,_0x3765b6,this[_0x59f0cc(0x1d6)]),_0x5a0681=await _0x57ea87(_0x4b2c47);}const {error_code:_0x175984,message:_0x276036}=_0x5a0681[_0x59f0cc(0x1b1)];if(_0x175984&&_0x175984!==0xc8)throw new common_1[(_0x59f0cc(0x1e5))](_0x276036||_0x59f0cc(0x1c7),common_1[_0x59f0cc(0x1a8)][_0x59f0cc(0x1fc)]);return _0x5a0681[_0x59f0cc(0x1b1)][_0x59f0cc(0x1bc)];}async[_0x15c49d(0x208)](){const _0x2add2c=_0x15c49d,_0x48155e=await this[_0x2add2c(0x1a9)][_0x2add2c(0x1e8)]();return _0x48155e;}async[_0x15c49d(0x1cc)](){const _0x556035=_0x15c49d,_0x1b57ae=new Date();_0x1b57ae[_0x556035(0x223)](0x0,0x0,0x0,0x0);const _0x590fd3=new Date(_0x1b57ae[_0x556035(0x20e)]()+0x18*0x3c*0x3c*0x3e8),_0x568e08=this[_0x556035(0x1a9)][_0x556035(0x1d2)](_0x556035(0x1be)),_0x146b3c=await _0x568e08[_0x556035(0x209)](_0x556035(0x1da),{'today':_0x1b57ae})[_0x556035(0x1fb)](_0x556035(0x1e1),{'tomorrow':_0x590fd3})['getCount']();return _0x146b3c;}};StatisticService=__decorate([(0x0,common_1[_0x15c49d(0x1ed)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(user_entity_1['UserEntity'])),__param(0x1,(0x0,typeorm_1[_0x15c49d(0x1d1)])(chatLog_entity_1[_0x15c49d(0x227)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(config_entity_1[_0x15c49d(0x1ba)])),__param(0x3,(0x0,typeorm_1['InjectRepository'])(order_entity_1[_0x15c49d(0x1cf)])),__metadata(_0x15c49d(0x1e7),[typeorm_2[_0x15c49d(0x228)],typeorm_2[_0x15c49d(0x228)],typeorm_2['Repository'],typeorm_2['Repository'],globalConfig_service_1[_0x15c49d(0x1c5)]])],StatisticService),exports[_0x15c49d(0x205)]=StatisticService;