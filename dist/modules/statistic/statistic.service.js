'use strict';const _0x3b1fdd=_0x3ee2;(function(_0x5c4917,_0xb68323){const _0xdcfc94=_0x3ee2,_0x1b528d=_0x5c4917();while(!![]){try{const _0x4efe61=parseInt(_0xdcfc94(0xbe))/0x1+-parseInt(_0xdcfc94(0xea))/0x2+parseInt(_0xdcfc94(0xc3))/0x3+-parseInt(_0xdcfc94(0x11a))/0x4*(parseInt(_0xdcfc94(0x108))/0x5)+parseInt(_0xdcfc94(0xd8))/0x6+parseInt(_0xdcfc94(0xb3))/0x7+parseInt(_0xdcfc94(0xb1))/0x8;if(_0x4efe61===_0xb68323)break;else _0x1b528d['push'](_0x1b528d['shift']());}catch(_0x36e907){_0x1b528d['push'](_0x1b528d['shift']());}}}(_0x36a6,0x8f562));var __decorate=this&&this[_0x3b1fdd(0xfa)]||function(_0x3086bd,_0xe3aa23,_0x569750,_0x2c3611){const _0x5af044=_0x3b1fdd;var _0x3119e0=arguments[_0x5af044(0xb2)],_0x320882=_0x3119e0<0x3?_0xe3aa23:_0x2c3611===null?_0x2c3611=Object[_0x5af044(0x116)](_0xe3aa23,_0x569750):_0x2c3611,_0x223712;if(typeof Reflect===_0x5af044(0x10f)&&typeof Reflect['decorate']===_0x5af044(0x105))_0x320882=Reflect[_0x5af044(0xcf)](_0x3086bd,_0xe3aa23,_0x569750,_0x2c3611);else{for(var _0x3b8547=_0x3086bd[_0x5af044(0xb2)]-0x1;_0x3b8547>=0x0;_0x3b8547--)if(_0x223712=_0x3086bd[_0x3b8547])_0x320882=(_0x3119e0<0x3?_0x223712(_0x320882):_0x3119e0>0x3?_0x223712(_0xe3aa23,_0x569750,_0x320882):_0x223712(_0xe3aa23,_0x569750))||_0x320882;}return _0x3119e0>0x3&&_0x320882&&Object[_0x5af044(0xf3)](_0xe3aa23,_0x569750,_0x320882),_0x320882;},__metadata=this&&this[_0x3b1fdd(0x10c)]||function(_0x5a1294,_0x121c1a){const _0x343da7=_0x3b1fdd;if(typeof Reflect===_0x343da7(0x10f)&&typeof Reflect[_0x343da7(0x11d)]==='function')return Reflect[_0x343da7(0x11d)](_0x5a1294,_0x121c1a);},__param=this&&this[_0x3b1fdd(0xe9)]||function(_0x3981b8,_0x569a71){return function(_0x122393,_0x82d8d8){_0x569a71(_0x122393,_0x82d8d8,_0x3981b8);};};Object['defineProperty'](exports,_0x3b1fdd(0xb7),{'value':!![]}),exports[_0x3b1fdd(0xc2)]=void 0x0;const balance_constant_1=require(_0x3b1fdd(0xbc)),date_1=require(_0x3b1fdd(0xe6)),common_1=require(_0x3b1fdd(0x100)),typeorm_1=require(_0x3b1fdd(0xa9)),axios_1=require(_0x3b1fdd(0xec)),typeorm_2=require(_0x3b1fdd(0x10d)),chatLog_entity_1=require(_0x3b1fdd(0xd6)),config_entity_1=require('../globalConfig/config.entity'),globalConfig_service_1=require(_0x3b1fdd(0xdb)),order_entity_1=require(_0x3b1fdd(0xe5)),user_entity_1=require(_0x3b1fdd(0x11f));let StatisticService=class StatisticService{constructor(_0x322bcf,_0x29835a,_0x969faa,_0x31ab72,_0x46546e){const _0x18762c=_0x3b1fdd;this[_0x18762c(0xa6)]=_0x322bcf,this[_0x18762c(0x10e)]=_0x29835a,this[_0x18762c(0x114)]=_0x969faa,this[_0x18762c(0x101)]=_0x31ab72,this[_0x18762c(0xbb)]=_0x46546e;}async['getBaseStatistic'](){const _0xf281bd=_0x3b1fdd,_0x2c39e7=await this[_0xf281bd(0xbd)](),_0x4f82d2=await this['countNewUsersToday'](),_0x1f08b2=await this[_0xf281bd(0xad)](),_0x25eaf7=await this[_0xf281bd(0xfb)](),_0x222057=await this[_0xf281bd(0xe2)](),_0x10aa6c=await this[_0xf281bd(0x10b)](),_0x64a50f=await this['countOrders'](),_0x4fbfed=await this[_0xf281bd(0xb8)]();return{'userCount':_0x2c39e7,'newUserCount':_0x4f82d2,'chatCount':_0x1f08b2,'newChatCount':_0x25eaf7,'drawCount':_0x222057,'newDrawCount':_0x10aa6c,'orderCount':_0x64a50f,'newOrderCount':_0x4fbfed};}async[_0x3b1fdd(0xf7)]({days:days=0x7}){const _0x8fcaf3=_0x3b1fdd,_0x1de13b=await this['countChatsByTimeRange'](days),_0x78001c=await this[_0x8fcaf3(0xff)](days);return{'date':_0x1de13b[_0x8fcaf3(0x121)](_0x3291e5=>_0x3291e5[_0x8fcaf3(0x107)]),'chat':_0x1de13b['map'](_0x42ff42=>_0x42ff42[_0x8fcaf3(0xee)]),'draw':_0x78001c['map']((_0x178a60,_0x14fe20)=>{return _0x178a60['value'];})};}async['getBaiduVisit']({days:days=0x7}){const _0x26d0d5=await this['getBaiduStatistics'](days);return _0x26d0d5;}async[_0x3b1fdd(0xbd)](){const _0x1bb126=_0x3b1fdd,_0xe2d6f8=await this['userEntity'][_0x1bb126(0xaf)]();return _0xe2d6f8;}async[_0x3b1fdd(0xe8)](){const _0x44a3ec=_0x3b1fdd,_0x3c8d9b=new Date();_0x3c8d9b[_0x44a3ec(0x122)](0x0,0x0,0x0,0x0);const _0xdf704d=new Date(_0x3c8d9b[_0x44a3ec(0x120)]()+0x18*0x3c*0x3c*0x3e8),_0x1f33f6=this['userEntity'][_0x44a3ec(0xfd)]('user'),_0x240156=await _0x1f33f6[_0x44a3ec(0xcd)](_0x44a3ec(0xb0),{'today':_0x3c8d9b})[_0x44a3ec(0x102)](_0x44a3ec(0xdc),{'tomorrow':_0xdf704d})[_0x44a3ec(0xeb)]();return _0x240156;}async[_0x3b1fdd(0xad)](){const _0x1b55ca=_0x3b1fdd,_0x300a9a=await this[_0x1b55ca(0x10e)]['count']({'where':{'type':balance_constant_1[_0x1b55ca(0xe4)][_0x1b55ca(0xc0)]}});return _0x300a9a;}async[_0x3b1fdd(0xfb)](){const _0x187258=_0x3b1fdd,_0x477dba=new Date();_0x477dba[_0x187258(0x122)](0x0,0x0,0x0,0x0);const _0xf162bc=new Date(_0x477dba[_0x187258(0x120)]()+0x18*0x3c*0x3c*0x3e8),_0x165356=this[_0x187258(0x10e)][_0x187258(0xfd)](_0x187258(0x11e)),_0x24f408=await _0x165356[_0x187258(0xcd)]('chatLog.type\x20=\x20:type',{'type':balance_constant_1['ChatType'][_0x187258(0xc0)]})[_0x187258(0x102)](_0x187258(0xf1),{'today':_0x477dba})['andWhere']('chatLog.createdAt\x20<\x20:tomorrow',{'tomorrow':_0xf162bc})[_0x187258(0xeb)]();return _0x24f408;}async[_0x3b1fdd(0xe2)](){const _0x4f55cb=_0x3b1fdd,_0x4f241d=await this['chatLogEntity']['count']({'where':{'type':balance_constant_1[_0x4f55cb(0xe4)][_0x4f55cb(0xa8)]}});return _0x4f241d;}async[_0x3b1fdd(0x10b)](){const _0x1838f9=_0x3b1fdd,_0x242326=new Date();_0x242326[_0x1838f9(0x122)](0x0,0x0,0x0,0x0);const _0x4e50c2=new Date(_0x242326['getTime']()+0x18*0x3c*0x3c*0x3e8),_0x217a63=this[_0x1838f9(0x10e)][_0x1838f9(0xfd)](_0x1838f9(0x11e)),_0x1d3c1f=await _0x217a63[_0x1838f9(0xcd)]('chatLog.type\x20=\x20:type',{'type':balance_constant_1[_0x1838f9(0xe4)]['PAINT']})[_0x1838f9(0x102)]('chatLog.createdAt\x20>=\x20:today',{'today':_0x242326})[_0x1838f9(0x102)](_0x1838f9(0x123),{'tomorrow':_0x4e50c2})[_0x1838f9(0xeb)]();return _0x1d3c1f;}async[_0x3b1fdd(0xc1)](_0x53bf90){const _0x1bbdfc=_0x3b1fdd;var _0x1b3764,_0x31ddaa;const _0x1bb1b4=new Date();_0x1bb1b4[_0x1bbdfc(0x122)](0x0,0x0,0x0,0x0);const _0x2447a8=new Date(_0x1bb1b4[_0x1bbdfc(0x120)]()-(_0x53bf90-0x1)*0x18*0x3c*0x3c*0x3e8),_0x465b07=this[_0x1bbdfc(0x10e)][_0x1bbdfc(0xfd)]('chatlog'),_0x3752ef=await _0x465b07[_0x1bbdfc(0xb9)](_0x1bbdfc(0x11b))['where']('chatlog.type\x20=\x20:type',{'type':balance_constant_1[_0x1bbdfc(0xe4)][_0x1bbdfc(0xc0)]})[_0x1bbdfc(0x102)](_0x1bbdfc(0xf0),{'startDate':_0x2447a8})[_0x1bbdfc(0xd0)](_0x1bbdfc(0x107))[_0x1bbdfc(0xb5)]('date')[_0x1bbdfc(0x111)](),_0x10476d=[],_0x8a86a6=_0x2447a8;for(let _0x28fea0=0x0;_0x28fea0<_0x53bf90;_0x28fea0++){const _0x45b98f=(0x0,date_1['formatDate'])(new Date(_0x8a86a6),'M.DD'),_0xb66196=(_0x31ddaa=(_0x1b3764=_0x3752ef['find'](_0x5637cd=>(0x0,date_1['formatDate'])(new Date(_0x5637cd[_0x1bbdfc(0x107)]),_0x1bbdfc(0xe7))===_0x45b98f))===null||_0x1b3764===void 0x0?void 0x0:_0x1b3764[_0x1bbdfc(0xaf)])!==null&&_0x31ddaa!==void 0x0?_0x31ddaa:0x0;_0xb66196>0x0?_0x10476d['push']({'date':_0x45b98f,'value':Number(_0xb66196)}):_0x10476d[_0x1bbdfc(0xd3)]({'date':_0x45b98f,'value':0x0}),_0x8a86a6[_0x1bbdfc(0xc8)](_0x8a86a6[_0x1bbdfc(0xcc)]()+0x1);}return _0x10476d;}async[_0x3b1fdd(0xff)](_0x3a0a5d){const _0x3c6c8e=_0x3b1fdd;var _0x2ecab3,_0x116e8f;const _0x181967=new Date();_0x181967['setHours'](0x0,0x0,0x0,0x0);const _0x3c232d=new Date(_0x181967[_0x3c6c8e(0x120)]()-(_0x3a0a5d-0x1)*0x18*0x3c*0x3c*0x3e8),_0xb22584=this[_0x3c6c8e(0x10e)]['createQueryBuilder'](_0x3c6c8e(0xd1)),_0x4f7736=await _0xb22584['select'](_0x3c6c8e(0x11b))['where'](_0x3c6c8e(0xc4),{'type':balance_constant_1['ChatType']['PAINT']})[_0x3c6c8e(0x102)](_0x3c6c8e(0xf0),{'startDate':_0x3c232d})[_0x3c6c8e(0xd0)](_0x3c6c8e(0x107))[_0x3c6c8e(0xb5)]('date')['getRawMany'](),_0x1b492e=[],_0x1d883c=_0x3c232d;for(let _0x5f29c5=0x0;_0x5f29c5<_0x3a0a5d;_0x5f29c5++){const _0x15c967=(0x0,date_1[_0x3c6c8e(0xba)])(new Date(_0x1d883c),_0x3c6c8e(0xe7)),_0x374732=(_0x116e8f=(_0x2ecab3=_0x4f7736[_0x3c6c8e(0xf4)](_0x425f5a=>(0x0,date_1['formatDate'])(new Date(_0x425f5a[_0x3c6c8e(0x107)]),_0x3c6c8e(0xe7))===_0x15c967))===null||_0x2ecab3===void 0x0?void 0x0:_0x2ecab3[_0x3c6c8e(0xaf)])!==null&&_0x116e8f!==void 0x0?_0x116e8f:0x0;_0x374732>0x0?_0x1b492e[_0x3c6c8e(0xd3)]({'date':_0x15c967,'value':Number(_0x374732)}):_0x1b492e[_0x3c6c8e(0xd3)]({'date':_0x15c967,'value':0x0}),_0x1d883c[_0x3c6c8e(0xc8)](_0x1d883c['getDate']()+0x1);}return _0x1b492e;}async['getNewAccessToken'](_0x51c2f7,_0x2654e6,_0xd7f8fa){const _0x2c12a6=_0x3b1fdd,_0x2c86e2=_0x2c12a6(0xca)+_0xd7f8fa+_0x2c12a6(0xd5)+_0x51c2f7+_0x2c12a6(0xb6)+_0x2654e6;common_1[_0x2c12a6(0xc6)][_0x2c12a6(0xc9)](_0x2c12a6(0xf9),_0x2c86e2);try{const _0x4ad57b=await axios_1[_0x2c12a6(0xe1)][_0x2c12a6(0xce)](_0x2c86e2);if(_0x4ad57b[_0x2c12a6(0xe3)]===0xc8&&_0x4ad57b[_0x2c12a6(0xae)]['access_token'])return{'accessToken':_0x4ad57b[_0x2c12a6(0xae)][_0x2c12a6(0xde)],'refreshToken':_0x4ad57b[_0x2c12a6(0xae)]['refresh_token']};else throw new Error('Failed\x20to\x20get\x20new\x20access\x20token');}catch(_0x57d712){common_1[_0x2c12a6(0xc6)][_0x2c12a6(0xfc)](_0x2c12a6(0xdd),{'message':_0x57d712[_0x2c12a6(0x110)],'stack':_0x57d712[_0x2c12a6(0x11c)],'response':_0x57d712[_0x2c12a6(0xcb)]?_0x57d712[_0x2c12a6(0xcb)]['data']:_0x2c12a6(0xfe)});throw new common_1[(_0x2c12a6(0x115))](_0x2c12a6(0xdd),common_1[_0x2c12a6(0xd9)][_0x2c12a6(0x113)]);}}async['updateAccessTokenInDatabase'](_0x1a0be5,_0x2d6e68,_0x5ef9b9){const _0x183677=_0x3b1fdd;await _0x5ef9b9[_0x183677(0xaa)]({'configKey':'baiduToken'},{'configVal':_0x1a0be5}),await _0x5ef9b9[_0x183677(0xaa)]({'configKey':_0x183677(0xef)},{'configVal':_0x2d6e68});}async['getBaiduStatistics'](_0x187516){const _0x13a176=_0x3b1fdd,_0x1cd7d5=(0x0,date_1[_0x13a176(0xba)])(new Date(),_0x13a176(0xd7)),_0x210364=(0x0,date_1[_0x13a176(0xba)])(new Date(Date[_0x13a176(0x10a)]()-Number(_0x187516-0x1)*0x18*0x3c*0x3c*0x3e8),_0x13a176(0xd7)),_0x4122fc='pv_count,visitor_count,ip_count,bounce_ratio,avg_visit_time',_0x51785d=_0x13a176(0xf6),{baiduToken:_0x2a3829,baiduSiteId:_0x5cf324,baiduApiKey:_0x33181c,baiduSecretKey:_0x240365,baiduRefreshToken:_0x2f5e4a}=await this[_0x13a176(0xbb)][_0x13a176(0xda)](['baiduToken',_0x13a176(0xac),'baiduApiKey',_0x13a176(0x106),_0x13a176(0xef)]);if(!_0x33181c||!_0x5cf324||!_0x2f5e4a||!_0x240365)return[];let _0xd922a2=_0x2a3829,_0x2233fa,_0x1c59cf;const _0x57e491=async _0x32f181=>{const _0x3dd2fd=_0x13a176;_0x1c59cf=_0x3dd2fd(0xc7)+_0x32f181+_0x3dd2fd(0x119)+_0x5cf324+_0x3dd2fd(0xf8)+_0x51785d+_0x3dd2fd(0x118)+_0x210364+_0x3dd2fd(0xab)+_0x1cd7d5+_0x3dd2fd(0x104)+_0x4122fc;try{return await axios_1['default'][_0x3dd2fd(0xce)](_0x1c59cf);}catch(_0x33add8){return{'data':{'error_code':0x6f,'message':_0x3dd2fd(0x117)}};}};_0x2233fa=await _0x57e491(_0xd922a2);if(_0x2233fa['data'][_0x13a176(0xbf)]===0x6f||!_0x2a3829){const {accessToken:_0x3fad87,refreshToken:_0x2e620a}=await this[_0x13a176(0xdf)](_0x33181c,_0x240365,_0x2f5e4a);_0xd922a2=_0x3fad87,await this[_0x13a176(0xd2)](_0xd922a2,_0x2e620a,this[_0x13a176(0x114)]),_0x2233fa=await _0x57e491(_0xd922a2);}const {error_code:_0x20b943,message:_0x17dfca}=_0x2233fa[_0x13a176(0xae)];if(_0x20b943&&_0x20b943!==0xc8)throw new common_1[(_0x13a176(0x115))](_0x17dfca||_0x13a176(0xb4),common_1[_0x13a176(0xd9)][_0x13a176(0x113)]);return _0x2233fa[_0x13a176(0xae)][_0x13a176(0xed)];}async[_0x3b1fdd(0x109)](){const _0x41b239=await this['orderEntity']['count']();return _0x41b239;}async[_0x3b1fdd(0xb8)](){const _0xd61e66=_0x3b1fdd,_0x47a9ef=new Date();_0x47a9ef['setHours'](0x0,0x0,0x0,0x0);const _0x40b881=new Date(_0x47a9ef[_0xd61e66(0x120)]()+0x18*0x3c*0x3c*0x3e8),_0x4578bf=this[_0xd61e66(0x101)][_0xd61e66(0xfd)](_0xd61e66(0x112)),_0xccadb=await _0x4578bf[_0xd61e66(0xcd)]('order.createdAt\x20>=\x20:today',{'today':_0x47a9ef})['andWhere'](_0xd61e66(0xe0),{'tomorrow':_0x40b881})[_0xd61e66(0xeb)]();return _0xccadb;}};StatisticService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x3b1fdd(0xa7)])(user_entity_1['UserEntity'])),__param(0x1,(0x0,typeorm_1[_0x3b1fdd(0xa7)])(chatLog_entity_1['ChatLogEntity'])),__param(0x2,(0x0,typeorm_1[_0x3b1fdd(0xa7)])(config_entity_1[_0x3b1fdd(0xf2)])),__param(0x3,(0x0,typeorm_1[_0x3b1fdd(0xa7)])(order_entity_1[_0x3b1fdd(0xd4)])),__metadata(_0x3b1fdd(0x103),[typeorm_2[_0x3b1fdd(0xf5)],typeorm_2[_0x3b1fdd(0xf5)],typeorm_2[_0x3b1fdd(0xf5)],typeorm_2[_0x3b1fdd(0xf5)],globalConfig_service_1[_0x3b1fdd(0xc5)]])],StatisticService),exports['StatisticService']=StatisticService;function _0x3ee2(_0x260ee1,_0x5edec1){const _0x36a6f5=_0x36a6();return _0x3ee2=function(_0x3ee21e,_0x5032b4){_0x3ee21e=_0x3ee21e-0xa6;let _0x4c9b56=_0x36a6f5[_0x3ee21e];return _0x4c9b56;},_0x3ee2(_0x260ee1,_0x5edec1);}function _0x36a6(){const _0x2532d8=['M.DD','countNewUsersToday','__param','759554clCOQX','getCount','axios','result','value','baiduRefreshToken','chatlog.createdAt\x20>=\x20:startDate','chatLog.createdAt\x20>=\x20:today','ConfigEntity','defineProperty','find','Repository','overview/getTimeTrendRpt','getChatStatistic','&method=','获取新\x20accessToken','__decorate','countNewChatsToday','error','createQueryBuilder','No\x20response\x20data','countDrawsByTimeRange','@nestjs/common','orderEntity','andWhere','design:paramtypes','&metrics=','function','baiduSecretKey','date','60385sLWBuA','countOrders','now','countNewDrawsToday','__metadata','typeorm','chatLogEntity','object','message','getRawMany','order','BAD_REQUEST','configEntity','HttpException','getOwnPropertyDescriptor','Access\x20token\x20invalid\x20or\x20no\x20longer\x20valid','&start_date=','&site_id=','268ELvUeM','DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','stack','metadata','chatLog','../user/user.entity','getTime','map','setHours','chatLog.createdAt\x20<\x20:tomorrow','userEntity','InjectRepository','PAINT','@nestjs/typeorm','update','&end_date=','baiduSiteId','countChats','data','count','user.createdAt\x20>=\x20:today','6504976kFQgqt','length','1032647YqeRne','获取百度统计数据失败','orderBy','&client_secret=','__esModule','countNewOrdersToday','select','formatDate','globalConfigService','../../common/constants/balance.constant','countUsers','91575lWScIv','error_code','NORMAL_CHAT','countChatsByTimeRange','StatisticService','35862MCMNhN','chatlog.type\x20=\x20:type','GlobalConfigService','Logger','https://openapi.baidu.com/rest/2.0/tongji/report/getData?access_token=','setDate','log','http://openapi.baidu.com/oauth/2.0/token?grant_type=refresh_token&refresh_token=','response','getDate','where','get','decorate','groupBy','chatlog','updateAccessTokenInDatabase','push','OrderEntity','&client_id=','../chatLog/chatLog.entity','YYYYMMDD','4271220QwGdjn','HttpStatus','getConfigs','../globalConfig/globalConfig.service','user.createdAt\x20<\x20:tomorrow','获取新\x20accessToken\x20失败','access_token','getNewAccessToken','order.createdAt\x20<\x20:tomorrow','default','countDraws','status','ChatType','../order/order.entity','../../common/utils/date'];_0x36a6=function(){return _0x2532d8;};return _0x36a6();}