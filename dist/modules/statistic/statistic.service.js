'use strict';function _0x4f37(_0x520003,_0x4163e2){const _0x3a1fc1=_0x3a1f();return _0x4f37=function(_0x4f3772,_0x4b1c7a){_0x4f3772=_0x4f3772-0xb5;let _0x1c85e8=_0x3a1fc1[_0x4f3772];return _0x1c85e8;},_0x4f37(_0x520003,_0x4163e2);}function _0x3a1f(){const _0x46f757=['../user/user.entity','defineProperty','default','ChatLogEntity','No\x20response\x20data','order.createdAt\x20>=\x20:today','getNewAccessToken','438258BxWHEM','https://openapi.baidu.com/rest/2.0/tongji/report/getData?access_token=','message','12319439XjXzRW','pv_count,visitor_count,ip_count,bounce_ratio,avg_visit_time','916nQJRSB','object','response','count','&client_id=','@nestjs/typeorm','access_token','../globalConfig/globalConfig.service','get','data','countDraws','616bgUMzo','user.createdAt\x20>=\x20:today','20fTOotj','chatLog.type\x20=\x20:type','chatLog','design:paramtypes','Failed\x20to\x20get\x20new\x20access\x20token','../order/order.entity','获取百度统计数据失败','countDrawsByTimeRange','M.DD','setDate','countNewOrdersToday','__metadata','chatlog.createdAt\x20>=\x20:startDate','value','push','axios','countUsers','chatLogEntity','15078RVcjOg','&site_id=','StatisticService','HttpStatus','__esModule','length','chatlog.type\x20=\x20:type','__param','../globalConfig/config.entity','Injectable','1704ZfrOfv','BAD_REQUEST','1903390zUFZkd','orderBy','&start_date=','http://openapi.baidu.com/oauth/2.0/token?grant_type=refresh_token&refresh_token=','baiduSecretKey','countChats','__decorate','map','chatlog','error_code','&metrics=','setHours','getBaiduVisit','status','baiduApiKey','typeorm','updateAccessTokenInDatabase','function','order','getTime','Access\x20token\x20invalid\x20or\x20no\x20longer\x20valid','&client_secret=','baiduRefreshToken','createQueryBuilder','result','getConfigs','getBaiduStatistics','获取新\x20accessToken\x20失败','orderEntity','chatLog.createdAt\x20<\x20:tomorrow','countNewUsersToday','where','Repository','Logger','ChatType','103095yoUOEa','countChatsByTimeRange','now','decorate','&method=','&end_date=','metadata','ConfigEntity','countNewDrawsToday','getRawMany','date','DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','getChatStatistic','globalConfigService','andWhere','2078896fROvrf','../chatLog/chatLog.entity','countOrders','getCount','baiduSiteId','formatDate','getDate','3570rPVQlr','InjectRepository','userEntity','user.createdAt\x20<\x20:tomorrow','GlobalConfigService','update','configEntity','stack','NORMAL_CHAT','PAINT','HttpException','UserEntity','groupBy','OrderEntity'];_0x3a1f=function(){return _0x46f757;};return _0x3a1f();}const _0x5c8840=_0x4f37;(function(_0x3390fe,_0x5ebb29){const _0x4be6f1=_0x4f37,_0x6dc526=_0x3390fe();while(!![]){try{const _0x15844f=-parseInt(_0x4be6f1(0xd4))/0x1+parseInt(_0x4be6f1(0xb8))/0x2+parseInt(_0x4be6f1(0xbf))/0x3*(-parseInt(_0x4be6f1(0xd9))/0x4)+-parseInt(_0x4be6f1(0x104))/0x5+parseInt(_0x4be6f1(0x102))/0x6*(-parseInt(_0x4be6f1(0xf8))/0x7)+parseInt(_0x4be6f1(0xe4))/0x8*(-parseInt(_0x4be6f1(0x127))/0x9)+parseInt(_0x4be6f1(0xe6))/0xa*(parseInt(_0x4be6f1(0xd7))/0xb);if(_0x15844f===_0x5ebb29)break;else _0x6dc526['push'](_0x6dc526['shift']());}catch(_0x2b5779){_0x6dc526['push'](_0x6dc526['shift']());}}}(_0x3a1f,0xa9771));var __decorate=this&&this[_0x5c8840(0x10a)]||function(_0x4ab03b,_0x2aa3df,_0xdb4bb8,_0x244f1a){const _0x11ffe4=_0x5c8840;var _0x2b4408=arguments[_0x11ffe4(0xfd)],_0x53ff9e=_0x2b4408<0x3?_0x2aa3df:_0x244f1a===null?_0x244f1a=Object['getOwnPropertyDescriptor'](_0x2aa3df,_0xdb4bb8):_0x244f1a,_0x5e8dc9;if(typeof Reflect===_0x11ffe4(0xda)&&typeof Reflect[_0x11ffe4(0x12a)]===_0x11ffe4(0x115))_0x53ff9e=Reflect[_0x11ffe4(0x12a)](_0x4ab03b,_0x2aa3df,_0xdb4bb8,_0x244f1a);else{for(var _0x58b4b3=_0x4ab03b[_0x11ffe4(0xfd)]-0x1;_0x58b4b3>=0x0;_0x58b4b3--)if(_0x5e8dc9=_0x4ab03b[_0x58b4b3])_0x53ff9e=(_0x2b4408<0x3?_0x5e8dc9(_0x53ff9e):_0x2b4408>0x3?_0x5e8dc9(_0x2aa3df,_0xdb4bb8,_0x53ff9e):_0x5e8dc9(_0x2aa3df,_0xdb4bb8))||_0x53ff9e;}return _0x2b4408>0x3&&_0x53ff9e&&Object[_0x11ffe4(0xce)](_0x2aa3df,_0xdb4bb8,_0x53ff9e),_0x53ff9e;},__metadata=this&&this[_0x5c8840(0xf1)]||function(_0x4eb254,_0x2fbe50){const _0x40e2bc=_0x5c8840;if(typeof Reflect===_0x40e2bc(0xda)&&typeof Reflect[_0x40e2bc(0x12d)]===_0x40e2bc(0x115))return Reflect['metadata'](_0x4eb254,_0x2fbe50);},__param=this&&this[_0x5c8840(0xff)]||function(_0x1e85e4,_0x5cd32c){return function(_0x29ca26,_0x328179){_0x5cd32c(_0x29ca26,_0x328179,_0x1e85e4);};};Object[_0x5c8840(0xce)](exports,_0x5c8840(0xfc),{'value':!![]}),exports[_0x5c8840(0xfa)]=void 0x0;const balance_constant_1=require('../../common/constants/balance.constant'),date_1=require('../../common/utils/date'),common_1=require('@nestjs/common'),typeorm_1=require(_0x5c8840(0xde)),axios_1=require(_0x5c8840(0xf5)),typeorm_2=require(_0x5c8840(0x113)),chatLog_entity_1=require(_0x5c8840(0xb9)),config_entity_1=require(_0x5c8840(0x100)),globalConfig_service_1=require(_0x5c8840(0xe0)),order_entity_1=require(_0x5c8840(0xeb)),user_entity_1=require(_0x5c8840(0xcd));let StatisticService=class StatisticService{constructor(_0x17d93b,_0x4fa332,_0x274d72,_0x27091c,_0x44540a){const _0x3a5f80=_0x5c8840;this[_0x3a5f80(0xc1)]=_0x17d93b,this['chatLogEntity']=_0x4fa332,this[_0x3a5f80(0xc5)]=_0x274d72,this[_0x3a5f80(0x120)]=_0x27091c,this['globalConfigService']=_0x44540a;}async['getBaseStatistic'](){const _0x167a9d=_0x5c8840,_0x1e117e=await this[_0x167a9d(0xf6)](),_0x4aaa49=await this[_0x167a9d(0x122)](),_0x49f5a6=await this[_0x167a9d(0x109)](),_0x44765a=await this['countNewChatsToday'](),_0x5a8dd2=await this[_0x167a9d(0xe3)](),_0x569618=await this[_0x167a9d(0x12f)](),_0x40154f=await this[_0x167a9d(0xba)](),_0x344001=await this[_0x167a9d(0xf0)]();return{'userCount':_0x1e117e,'newUserCount':_0x4aaa49,'chatCount':_0x49f5a6,'newChatCount':_0x44765a,'drawCount':_0x5a8dd2,'newDrawCount':_0x569618,'orderCount':_0x40154f,'newOrderCount':_0x344001};}async[_0x5c8840(0xb5)]({days:days=0x7}){const _0x582c77=_0x5c8840,_0x35be90=await this[_0x582c77(0x128)](days),_0x47192a=await this[_0x582c77(0xed)](days);return{'date':_0x35be90['map'](_0x1e9a4a=>_0x1e9a4a[_0x582c77(0x131)]),'chat':_0x35be90[_0x582c77(0x10b)](_0x3791ce=>_0x3791ce[_0x582c77(0xf3)]),'draw':_0x47192a['map']((_0x3b37fe,_0x4ffe44)=>{const _0x120521=_0x582c77;return _0x3b37fe[_0x120521(0xf3)];})};}async[_0x5c8840(0x110)]({days:days=0x7}){const _0x114bd2=_0x5c8840,_0xd22456=await this[_0x114bd2(0x11e)](days);return _0xd22456;}async[_0x5c8840(0xf6)](){const _0x1b0e05=_0x5c8840,_0x2654c3=await this[_0x1b0e05(0xc1)][_0x1b0e05(0xdc)]();return _0x2654c3;}async[_0x5c8840(0x122)](){const _0x5eadf4=_0x5c8840,_0x3a7d15=new Date();_0x3a7d15['setHours'](0x0,0x0,0x0,0x0);const _0x2b3feb=new Date(_0x3a7d15[_0x5eadf4(0x117)]()+0x18*0x3c*0x3c*0x3e8),_0x41484c=this[_0x5eadf4(0xc1)][_0x5eadf4(0x11b)]('user'),_0x5483c2=await _0x41484c['where'](_0x5eadf4(0xe5),{'today':_0x3a7d15})[_0x5eadf4(0xb7)](_0x5eadf4(0xc2),{'tomorrow':_0x2b3feb})['getCount']();return _0x5483c2;}async[_0x5c8840(0x109)](){const _0x327363=_0x5c8840,_0x396314=await this[_0x327363(0xf7)][_0x327363(0xdc)]({'where':{'type':balance_constant_1['ChatType']['NORMAL_CHAT']}});return _0x396314;}async['countNewChatsToday'](){const _0x1ce8b0=_0x5c8840,_0xb916d4=new Date();_0xb916d4[_0x1ce8b0(0x10f)](0x0,0x0,0x0,0x0);const _0x21755c=new Date(_0xb916d4['getTime']()+0x18*0x3c*0x3c*0x3e8),_0x2f6d3f=this[_0x1ce8b0(0xf7)]['createQueryBuilder'](_0x1ce8b0(0xe8)),_0x2cfe77=await _0x2f6d3f[_0x1ce8b0(0x123)](_0x1ce8b0(0xe7),{'type':balance_constant_1[_0x1ce8b0(0x126)][_0x1ce8b0(0xc7)]})[_0x1ce8b0(0xb7)]('chatLog.createdAt\x20>=\x20:today',{'today':_0xb916d4})[_0x1ce8b0(0xb7)](_0x1ce8b0(0x121),{'tomorrow':_0x21755c})['getCount']();return _0x2cfe77;}async[_0x5c8840(0xe3)](){const _0x17c921=_0x5c8840,_0x34edc4=await this[_0x17c921(0xf7)]['count']({'where':{'type':balance_constant_1[_0x17c921(0x126)][_0x17c921(0xc8)]}});return _0x34edc4;}async['countNewDrawsToday'](){const _0x250768=_0x5c8840,_0x5412f7=new Date();_0x5412f7['setHours'](0x0,0x0,0x0,0x0);const _0x50c635=new Date(_0x5412f7['getTime']()+0x18*0x3c*0x3c*0x3e8),_0x3f393e=this['chatLogEntity'][_0x250768(0x11b)]('chatLog'),_0x54fe41=await _0x3f393e[_0x250768(0x123)](_0x250768(0xe7),{'type':balance_constant_1[_0x250768(0x126)][_0x250768(0xc8)]})[_0x250768(0xb7)]('chatLog.createdAt\x20>=\x20:today',{'today':_0x5412f7})['andWhere'](_0x250768(0x121),{'tomorrow':_0x50c635})['getCount']();return _0x54fe41;}async[_0x5c8840(0x128)](_0x3b0650){const _0x33650f=_0x5c8840;var _0x192136,_0x1c1e7d;const _0x2cdb7d=new Date();_0x2cdb7d[_0x33650f(0x10f)](0x0,0x0,0x0,0x0);const _0xc2690e=new Date(_0x2cdb7d['getTime']()-(_0x3b0650-0x1)*0x18*0x3c*0x3c*0x3e8),_0x33b296=this[_0x33650f(0xf7)][_0x33650f(0x11b)](_0x33650f(0x10c)),_0x566d0c=await _0x33b296['select'](_0x33650f(0x132))[_0x33650f(0x123)]('chatlog.type\x20=\x20:type',{'type':balance_constant_1[_0x33650f(0x126)][_0x33650f(0xc7)]})[_0x33650f(0xb7)](_0x33650f(0xf2),{'startDate':_0xc2690e})[_0x33650f(0xcb)](_0x33650f(0x131))[_0x33650f(0x105)]('date')[_0x33650f(0x130)](),_0x597e90=[],_0x52f8bb=_0xc2690e;for(let _0xf68f78=0x0;_0xf68f78<_0x3b0650;_0xf68f78++){const _0x61c3dc=(0x0,date_1[_0x33650f(0xbd)])(new Date(_0x52f8bb),_0x33650f(0xee)),_0x1883a7=(_0x1c1e7d=(_0x192136=_0x566d0c['find'](_0x2a26d6=>(0x0,date_1[_0x33650f(0xbd)])(new Date(_0x2a26d6[_0x33650f(0x131)]),_0x33650f(0xee))===_0x61c3dc))===null||_0x192136===void 0x0?void 0x0:_0x192136[_0x33650f(0xdc)])!==null&&_0x1c1e7d!==void 0x0?_0x1c1e7d:0x0;_0x1883a7>0x0?_0x597e90['push']({'date':_0x61c3dc,'value':Number(_0x1883a7)}):_0x597e90[_0x33650f(0xf4)]({'date':_0x61c3dc,'value':0x0}),_0x52f8bb[_0x33650f(0xef)](_0x52f8bb[_0x33650f(0xbe)]()+0x1);}return _0x597e90;}async[_0x5c8840(0xed)](_0x460533){const _0xdf7ca=_0x5c8840;var _0x1ff351,_0x5790e5;const _0x32a37b=new Date();_0x32a37b[_0xdf7ca(0x10f)](0x0,0x0,0x0,0x0);const _0xaafc47=new Date(_0x32a37b[_0xdf7ca(0x117)]()-(_0x460533-0x1)*0x18*0x3c*0x3c*0x3e8),_0x4518e4=this['chatLogEntity']['createQueryBuilder']('chatlog'),_0x2fca6d=await _0x4518e4['select'](_0xdf7ca(0x132))[_0xdf7ca(0x123)](_0xdf7ca(0xfe),{'type':balance_constant_1[_0xdf7ca(0x126)][_0xdf7ca(0xc8)]})[_0xdf7ca(0xb7)](_0xdf7ca(0xf2),{'startDate':_0xaafc47})['groupBy']('date')['orderBy'](_0xdf7ca(0x131))['getRawMany'](),_0x19e516=[],_0x551167=_0xaafc47;for(let _0x1090f9=0x0;_0x1090f9<_0x460533;_0x1090f9++){const _0x1364f2=(0x0,date_1[_0xdf7ca(0xbd)])(new Date(_0x551167),_0xdf7ca(0xee)),_0x27aef1=(_0x5790e5=(_0x1ff351=_0x2fca6d['find'](_0x1b215b=>(0x0,date_1[_0xdf7ca(0xbd)])(new Date(_0x1b215b[_0xdf7ca(0x131)]),_0xdf7ca(0xee))===_0x1364f2))===null||_0x1ff351===void 0x0?void 0x0:_0x1ff351[_0xdf7ca(0xdc)])!==null&&_0x5790e5!==void 0x0?_0x5790e5:0x0;_0x27aef1>0x0?_0x19e516[_0xdf7ca(0xf4)]({'date':_0x1364f2,'value':Number(_0x27aef1)}):_0x19e516[_0xdf7ca(0xf4)]({'date':_0x1364f2,'value':0x0}),_0x551167[_0xdf7ca(0xef)](_0x551167[_0xdf7ca(0xbe)]()+0x1);}return _0x19e516;}async[_0x5c8840(0xd3)](_0x2e7ed1,_0x19635f,_0x12d01d){const _0x2b1682=_0x5c8840,_0xe8dcd2=_0x2b1682(0x107)+_0x12d01d+_0x2b1682(0xdd)+_0x2e7ed1+_0x2b1682(0x119)+_0x19635f;common_1[_0x2b1682(0x125)]['log']('获取新\x20accessToken',_0xe8dcd2);try{const _0x50ed99=await axios_1['default'][_0x2b1682(0xe1)](_0xe8dcd2);if(_0x50ed99[_0x2b1682(0x111)]===0xc8&&_0x50ed99[_0x2b1682(0xe2)][_0x2b1682(0xdf)])return{'accessToken':_0x50ed99[_0x2b1682(0xe2)]['access_token'],'refreshToken':_0x50ed99[_0x2b1682(0xe2)]['refresh_token']};else throw new Error(_0x2b1682(0xea));}catch(_0x1a4553){common_1[_0x2b1682(0x125)]['error'](_0x2b1682(0x11f),{'message':_0x1a4553[_0x2b1682(0xd6)],'stack':_0x1a4553[_0x2b1682(0xc6)],'response':_0x1a4553['response']?_0x1a4553[_0x2b1682(0xdb)][_0x2b1682(0xe2)]:_0x2b1682(0xd1)});throw new common_1[(_0x2b1682(0xc9))](_0x2b1682(0x11f),common_1['HttpStatus'][_0x2b1682(0x103)]);}}async[_0x5c8840(0x114)](_0x69c8d6,_0x4e5a55,_0x58b3f8){const _0x403932=_0x5c8840;await _0x58b3f8[_0x403932(0xc4)]({'configKey':'baiduToken'},{'configVal':_0x69c8d6}),await _0x58b3f8[_0x403932(0xc4)]({'configKey':_0x403932(0x11a)},{'configVal':_0x4e5a55});}async[_0x5c8840(0x11e)](_0x5b9412){const _0x252941=_0x5c8840,_0x2138bb=(0x0,date_1[_0x252941(0xbd)])(new Date(),'YYYYMMDD'),_0x487574=(0x0,date_1[_0x252941(0xbd)])(new Date(Date[_0x252941(0x129)]()-Number(_0x5b9412-0x1)*0x18*0x3c*0x3c*0x3e8),'YYYYMMDD'),_0x43be6a=_0x252941(0xd8),_0x20cba5='overview/getTimeTrendRpt',{baiduToken:_0x402a3f,baiduSiteId:_0x1c79f9,baiduApiKey:_0x1f6ee9,baiduSecretKey:_0x5cea94,baiduRefreshToken:_0x41bbc1}=await this[_0x252941(0xb6)][_0x252941(0x11d)](['baiduToken',_0x252941(0xbc),_0x252941(0x112),_0x252941(0x108),_0x252941(0x11a)]);if(!_0x1f6ee9||!_0x1c79f9||!_0x41bbc1||!_0x5cea94)return[];let _0x34232a=_0x402a3f,_0xbdddc8,_0x5ea101;const _0x49d419=async _0x53f43d=>{const _0x201b33=_0x252941;_0x5ea101=_0x201b33(0xd5)+_0x53f43d+_0x201b33(0xf9)+_0x1c79f9+_0x201b33(0x12b)+_0x20cba5+_0x201b33(0x106)+_0x487574+_0x201b33(0x12c)+_0x2138bb+_0x201b33(0x10e)+_0x43be6a;try{return await axios_1[_0x201b33(0xcf)][_0x201b33(0xe1)](_0x5ea101);}catch(_0x5e3c90){return{'data':{'error_code':0x6f,'message':_0x201b33(0x118)}};}};_0xbdddc8=await _0x49d419(_0x34232a);if(_0xbdddc8[_0x252941(0xe2)][_0x252941(0x10d)]===0x6f||!_0x402a3f){const {accessToken:_0x5dc1fd,refreshToken:_0x25ddf5}=await this['getNewAccessToken'](_0x1f6ee9,_0x5cea94,_0x41bbc1);_0x34232a=_0x5dc1fd,await this[_0x252941(0x114)](_0x34232a,_0x25ddf5,this['configEntity']),_0xbdddc8=await _0x49d419(_0x34232a);}const {error_code:_0xd096e5,message:_0x374a18}=_0xbdddc8[_0x252941(0xe2)];if(_0xd096e5&&_0xd096e5!==0xc8)throw new common_1['HttpException'](_0x374a18||_0x252941(0xec),common_1[_0x252941(0xfb)][_0x252941(0x103)]);return _0xbdddc8[_0x252941(0xe2)][_0x252941(0x11c)];}async['countOrders'](){const _0x459a6c=_0x5c8840,_0x3d2f96=await this[_0x459a6c(0x120)][_0x459a6c(0xdc)]();return _0x3d2f96;}async[_0x5c8840(0xf0)](){const _0x16a7bc=_0x5c8840,_0x1cc47b=new Date();_0x1cc47b[_0x16a7bc(0x10f)](0x0,0x0,0x0,0x0);const _0x408c7c=new Date(_0x1cc47b['getTime']()+0x18*0x3c*0x3c*0x3e8),_0x5d6800=this[_0x16a7bc(0x120)][_0x16a7bc(0x11b)](_0x16a7bc(0x116)),_0x2dc285=await _0x5d6800[_0x16a7bc(0x123)](_0x16a7bc(0xd2),{'today':_0x1cc47b})[_0x16a7bc(0xb7)]('order.createdAt\x20<\x20:tomorrow',{'tomorrow':_0x408c7c})[_0x16a7bc(0xbb)]();return _0x2dc285;}};StatisticService=__decorate([(0x0,common_1[_0x5c8840(0x101)])(),__param(0x0,(0x0,typeorm_1[_0x5c8840(0xc0)])(user_entity_1[_0x5c8840(0xca)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(chatLog_entity_1[_0x5c8840(0xd0)])),__param(0x2,(0x0,typeorm_1[_0x5c8840(0xc0)])(config_entity_1[_0x5c8840(0x12e)])),__param(0x3,(0x0,typeorm_1['InjectRepository'])(order_entity_1[_0x5c8840(0xcc)])),__metadata(_0x5c8840(0xe9),[typeorm_2[_0x5c8840(0x124)],typeorm_2[_0x5c8840(0x124)],typeorm_2[_0x5c8840(0x124)],typeorm_2[_0x5c8840(0x124)],globalConfig_service_1[_0x5c8840(0xc3)]])],StatisticService),exports['StatisticService']=StatisticService;