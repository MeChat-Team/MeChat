'use strict';const _0x5a0849=_0x2108;(function(_0xacb4f0,_0x226974){const _0x2c121f=_0x2108,_0x2e0f3b=_0xacb4f0();while(!![]){try{const _0x1ce958=parseInt(_0x2c121f(0x1b5))/0x1*(-parseInt(_0x2c121f(0x1e6))/0x2)+-parseInt(_0x2c121f(0x179))/0x3+parseInt(_0x2c121f(0x1e0))/0x4*(-parseInt(_0x2c121f(0x18d))/0x5)+-parseInt(_0x2c121f(0x17a))/0x6+-parseInt(_0x2c121f(0x1a8))/0x7*(-parseInt(_0x2c121f(0x1dc))/0x8)+parseInt(_0x2c121f(0x187))/0x9*(parseInt(_0x2c121f(0x1ac))/0xa)+parseInt(_0x2c121f(0x186))/0xb*(parseInt(_0x2c121f(0x1bb))/0xc);if(_0x1ce958===_0x226974)break;else _0x2e0f3b['push'](_0x2e0f3b['shift']());}catch(_0x26e62e){_0x2e0f3b['push'](_0x2e0f3b['shift']());}}}(_0x5306,0xeb2a0));var __decorate=this&&this[_0x5a0849(0x1be)]||function(_0x5c7e4f,_0xab44f2,_0x350a45,_0x40a348){const _0x2590c1=_0x5a0849;var _0x582e12=arguments[_0x2590c1(0x1b9)],_0x4236aa=_0x582e12<0x3?_0xab44f2:_0x40a348===null?_0x40a348=Object['getOwnPropertyDescriptor'](_0xab44f2,_0x350a45):_0x40a348,_0x46e112;if(typeof Reflect===_0x2590c1(0x1c5)&&typeof Reflect[_0x2590c1(0x1aa)]===_0x2590c1(0x1e1))_0x4236aa=Reflect[_0x2590c1(0x1aa)](_0x5c7e4f,_0xab44f2,_0x350a45,_0x40a348);else{for(var _0x85255e=_0x5c7e4f['length']-0x1;_0x85255e>=0x0;_0x85255e--)if(_0x46e112=_0x5c7e4f[_0x85255e])_0x4236aa=(_0x582e12<0x3?_0x46e112(_0x4236aa):_0x582e12>0x3?_0x46e112(_0xab44f2,_0x350a45,_0x4236aa):_0x46e112(_0xab44f2,_0x350a45))||_0x4236aa;}return _0x582e12>0x3&&_0x4236aa&&Object['defineProperty'](_0xab44f2,_0x350a45,_0x4236aa),_0x4236aa;},__metadata=this&&this[_0x5a0849(0x1c1)]||function(_0x2238f7,_0x27c4b4){const _0x3fcf70=_0x5a0849;if(typeof Reflect===_0x3fcf70(0x1c5)&&typeof Reflect[_0x3fcf70(0x183)]===_0x3fcf70(0x1e1))return Reflect[_0x3fcf70(0x183)](_0x2238f7,_0x27c4b4);},__param=this&&this[_0x5a0849(0x1e4)]||function(_0x38557f,_0xf00423){return function(_0x26a4fb,_0xc504dc){_0xf00423(_0x26a4fb,_0xc504dc,_0x38557f);};};Object[_0x5a0849(0x18f)](exports,_0x5a0849(0x1cf),{'value':!![]}),exports[_0x5a0849(0x1d0)]=void 0x0;function _0x2108(_0x4b33cc,_0x34e879){const _0x530642=_0x5306();return _0x2108=function(_0x210826,_0x3c551e){_0x210826=_0x210826-0x176;let _0x3d04c3=_0x530642[_0x210826];return _0x3d04c3;},_0x2108(_0x4b33cc,_0x34e879);}const balance_constant_1=require(_0x5a0849(0x19f)),date_1=require(_0x5a0849(0x195)),common_1=require(_0x5a0849(0x19d)),typeorm_1=require(_0x5a0849(0x1b6)),axios_1=require(_0x5a0849(0x1e9)),typeorm_2=require(_0x5a0849(0x192)),chatLog_entity_1=require(_0x5a0849(0x1ad)),config_entity_1=require(_0x5a0849(0x1ed)),globalConfig_service_1=require(_0x5a0849(0x17b)),order_entity_1=require(_0x5a0849(0x1d4)),user_entity_1=require(_0x5a0849(0x18a));let StatisticService=class StatisticService{constructor(_0x171db3,_0x56f6f7,_0x5b7748,_0x3026f4,_0x58798a){const _0x41c7f7=_0x5a0849;this[_0x41c7f7(0x1c9)]=_0x171db3,this[_0x41c7f7(0x1a9)]=_0x56f6f7,this[_0x41c7f7(0x1cd)]=_0x5b7748,this[_0x41c7f7(0x19e)]=_0x3026f4,this[_0x41c7f7(0x1bd)]=_0x58798a;}async[_0x5a0849(0x1a4)](){const _0x3948a3=_0x5a0849,_0x21272b=await this[_0x3948a3(0x1a3)](),_0x49bd81=await this[_0x3948a3(0x1d2)](),_0x182533=await this[_0x3948a3(0x1ce)](),_0xaa414c=await this[_0x3948a3(0x1cb)](),_0x16bae9=await this[_0x3948a3(0x1df)](),_0xb824f1=await this[_0x3948a3(0x1c0)](),_0x344447=await this[_0x3948a3(0x1c2)](),_0x402214=await this['countNewOrdersToday']();return{'userCount':_0x21272b,'newUserCount':_0x49bd81,'chatCount':_0x182533,'newChatCount':_0xaa414c,'drawCount':_0x16bae9,'newDrawCount':_0xb824f1,'orderCount':_0x344447,'newOrderCount':_0x402214};}async[_0x5a0849(0x1d5)]({days:days=0x7}){const _0x233fa2=_0x5a0849,_0x37d5cd=await this['countChatsByTimeRange'](days),_0x354187=await this[_0x233fa2(0x1f2)](days);return{'date':_0x37d5cd[_0x233fa2(0x1ca)](_0x36e00f=>_0x36e00f['date']),'chat':_0x37d5cd[_0x233fa2(0x1ca)](_0x220612=>_0x220612['value']),'draw':_0x354187[_0x233fa2(0x1ca)]((_0x1ca860,_0x485033)=>{const _0x351ce6=_0x233fa2;return _0x1ca860[_0x351ce6(0x1e5)];})};}async[_0x5a0849(0x1bc)]({days:days=0x7}){const _0x3ea3e6=await this['getBaiduStatistics'](days);return _0x3ea3e6;}async[_0x5a0849(0x1a3)](){const _0x53c232=_0x5a0849,_0x3cb8e4=await this[_0x53c232(0x1c9)][_0x53c232(0x1a2)]();return _0x3cb8e4;}async['countNewUsersToday'](){const _0x3829de=_0x5a0849,_0x53f1f2=new Date();_0x53f1f2[_0x3829de(0x1b0)](0x0,0x0,0x0,0x0);const _0x45de1a=new Date(_0x53f1f2[_0x3829de(0x1ef)]()+0x18*0x3c*0x3c*0x3e8),_0x3dd5d2=this['userEntity']['createQueryBuilder'](_0x3829de(0x1ab)),_0x30e243=await _0x3dd5d2[_0x3829de(0x1a1)](_0x3829de(0x1ba),{'today':_0x53f1f2})[_0x3829de(0x18b)](_0x3829de(0x1da),{'tomorrow':_0x45de1a})['getCount']();return _0x30e243;}async[_0x5a0849(0x1ce)](){const _0x27a4a7=_0x5a0849,_0x3341f3=await this[_0x27a4a7(0x1a9)][_0x27a4a7(0x1a2)]({'where':{'type':balance_constant_1[_0x27a4a7(0x1d6)][_0x27a4a7(0x1f3)]}});return _0x3341f3;}async['countNewChatsToday'](){const _0x2af3b4=_0x5a0849,_0xfc1aba=new Date();_0xfc1aba[_0x2af3b4(0x1b0)](0x0,0x0,0x0,0x0);const _0x47cca5=new Date(_0xfc1aba[_0x2af3b4(0x1ef)]()+0x18*0x3c*0x3c*0x3e8),_0x21a0b2=this[_0x2af3b4(0x1a9)][_0x2af3b4(0x1d7)](_0x2af3b4(0x19c)),_0x540841=await _0x21a0b2[_0x2af3b4(0x1a1)](_0x2af3b4(0x19b),{'type':balance_constant_1['ChatType'][_0x2af3b4(0x1f3)]})[_0x2af3b4(0x18b)]('chatLog.createdAt\x20>=\x20:today',{'today':_0xfc1aba})[_0x2af3b4(0x18b)]('chatLog.createdAt\x20<\x20:tomorrow',{'tomorrow':_0x47cca5})[_0x2af3b4(0x1e2)]();return _0x540841;}async[_0x5a0849(0x1df)](){const _0x50b6e0=_0x5a0849,_0x4dd78f=await this['chatLogEntity'][_0x50b6e0(0x1a2)]({'where':{'type':balance_constant_1[_0x50b6e0(0x1d6)][_0x50b6e0(0x1ae)]}});return _0x4dd78f;}async[_0x5a0849(0x1c0)](){const _0x13d566=_0x5a0849,_0x51e446=new Date();_0x51e446['setHours'](0x0,0x0,0x0,0x0);const _0x22f93c=new Date(_0x51e446[_0x13d566(0x1ef)]()+0x18*0x3c*0x3c*0x3e8),_0x2b6d06=this['chatLogEntity'][_0x13d566(0x1d7)](_0x13d566(0x19c)),_0x418cca=await _0x2b6d06[_0x13d566(0x1a1)](_0x13d566(0x19b),{'type':balance_constant_1[_0x13d566(0x1d6)][_0x13d566(0x1ae)]})[_0x13d566(0x18b)](_0x13d566(0x189),{'today':_0x51e446})[_0x13d566(0x18b)]('chatLog.createdAt\x20<\x20:tomorrow',{'tomorrow':_0x22f93c})[_0x13d566(0x1e2)]();return _0x418cca;}async['countChatsByTimeRange'](_0x4a166c){const _0x5d444e=_0x5a0849;var _0x1a14b7,_0x5c354b;const _0x1cb61e=new Date();_0x1cb61e[_0x5d444e(0x1b0)](0x0,0x0,0x0,0x0);const _0x172566=new Date(_0x1cb61e[_0x5d444e(0x1ef)]()-(_0x4a166c-0x1)*0x18*0x3c*0x3c*0x3e8),_0x544fb5=this[_0x5d444e(0x1a9)]['createQueryBuilder'](_0x5d444e(0x178)),_0x3f79ee=await _0x544fb5[_0x5d444e(0x198)](_0x5d444e(0x1c8))['where']('chatlog.type\x20=\x20:type',{'type':balance_constant_1[_0x5d444e(0x1d6)][_0x5d444e(0x1f3)]})['andWhere'](_0x5d444e(0x1ee),{'startDate':_0x172566})[_0x5d444e(0x1af)](_0x5d444e(0x1cc))[_0x5d444e(0x1ec)](_0x5d444e(0x1cc))[_0x5d444e(0x1a6)](),_0x49c905=[],_0x5a8a08=_0x172566;for(let _0x231b72=0x0;_0x231b72<_0x4a166c;_0x231b72++){const _0x1753be=(0x0,date_1[_0x5d444e(0x19a)])(new Date(_0x5a8a08),'M.DD'),_0x510cda=(_0x5c354b=(_0x1a14b7=_0x3f79ee['find'](_0x19c173=>(0x0,date_1['formatDate'])(new Date(_0x19c173['date']),_0x5d444e(0x1f1))===_0x1753be))===null||_0x1a14b7===void 0x0?void 0x0:_0x1a14b7[_0x5d444e(0x1a2)])!==null&&_0x5c354b!==void 0x0?_0x5c354b:0x0;_0x510cda>0x0?_0x49c905['push']({'date':_0x1753be,'value':Number(_0x510cda)}):_0x49c905[_0x5d444e(0x1e7)]({'date':_0x1753be,'value':0x0}),_0x5a8a08[_0x5d444e(0x1ea)](_0x5a8a08[_0x5d444e(0x1de)]()+0x1);}return _0x49c905;}async[_0x5a0849(0x1f2)](_0x2a4341){const _0x46dcb5=_0x5a0849;var _0x5d459c,_0x68c5e4;const _0x3c6c8c=new Date();_0x3c6c8c[_0x46dcb5(0x1b0)](0x0,0x0,0x0,0x0);const _0x8276=new Date(_0x3c6c8c['getTime']()-(_0x2a4341-0x1)*0x18*0x3c*0x3c*0x3e8),_0x3cb541=this[_0x46dcb5(0x1a9)][_0x46dcb5(0x1d7)](_0x46dcb5(0x178)),_0x176905=await _0x3cb541[_0x46dcb5(0x198)]('DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count')[_0x46dcb5(0x1a1)](_0x46dcb5(0x1dd),{'type':balance_constant_1['ChatType']['PAINT']})['andWhere']('chatlog.createdAt\x20>=\x20:startDate',{'startDate':_0x8276})[_0x46dcb5(0x1af)](_0x46dcb5(0x1cc))[_0x46dcb5(0x1ec)](_0x46dcb5(0x1cc))[_0x46dcb5(0x1a6)](),_0x114c9b=[],_0x214494=_0x8276;for(let _0x47ed98=0x0;_0x47ed98<_0x2a4341;_0x47ed98++){const _0x57e420=(0x0,date_1[_0x46dcb5(0x19a)])(new Date(_0x214494),'M.DD'),_0x187d1f=(_0x68c5e4=(_0x5d459c=_0x176905['find'](_0x55f970=>(0x0,date_1[_0x46dcb5(0x19a)])(new Date(_0x55f970[_0x46dcb5(0x1cc)]),_0x46dcb5(0x1f1))===_0x57e420))===null||_0x5d459c===void 0x0?void 0x0:_0x5d459c['count'])!==null&&_0x68c5e4!==void 0x0?_0x68c5e4:0x0;_0x187d1f>0x0?_0x114c9b[_0x46dcb5(0x1e7)]({'date':_0x57e420,'value':Number(_0x187d1f)}):_0x114c9b[_0x46dcb5(0x1e7)]({'date':_0x57e420,'value':0x0}),_0x214494[_0x46dcb5(0x1ea)](_0x214494['getDate']()+0x1);}return _0x114c9b;}async[_0x5a0849(0x1d3)](_0x3cce01,_0x5a3a44,_0x24542f){const _0x29b2e6=_0x5a0849,_0x4cd731=_0x29b2e6(0x1b8)+_0x24542f+_0x29b2e6(0x191)+_0x3cce01+_0x29b2e6(0x1b4)+_0x5a3a44;common_1['Logger']['log']('获取新\x20accessToken',_0x4cd731);try{const _0x1b6d82=await axios_1['default'][_0x29b2e6(0x193)](_0x4cd731);if(_0x1b6d82[_0x29b2e6(0x18c)]===0xc8&&_0x1b6d82['data'][_0x29b2e6(0x1c4)])return{'accessToken':_0x1b6d82[_0x29b2e6(0x190)]['access_token'],'refreshToken':_0x1b6d82['data'][_0x29b2e6(0x1c6)]};else throw new Error(_0x29b2e6(0x194));}catch(_0x1d56e6){common_1[_0x29b2e6(0x176)]['error']('获取新\x20accessToken\x20失败',{'message':_0x1d56e6[_0x29b2e6(0x1d8)],'stack':_0x1d56e6[_0x29b2e6(0x1b7)],'response':_0x1d56e6[_0x29b2e6(0x1d1)]?_0x1d56e6[_0x29b2e6(0x1d1)][_0x29b2e6(0x190)]:_0x29b2e6(0x17f)});throw new common_1[(_0x29b2e6(0x17c))](_0x29b2e6(0x17d),common_1[_0x29b2e6(0x199)]['BAD_REQUEST']);}}async['updateAccessTokenInDatabase'](_0x473f90,_0x126da3,_0xd74528){const _0x1c336b=_0x5a0849;await _0xd74528[_0x1c336b(0x184)]({'configKey':'baiduToken'},{'configVal':_0x473f90}),await _0xd74528[_0x1c336b(0x184)]({'configKey':_0x1c336b(0x18e)},{'configVal':_0x126da3});}async[_0x5a0849(0x1f0)](_0x123a36){const _0x343e6e=_0x5a0849,_0x469a41=(0x0,date_1['formatDate'])(new Date(),_0x343e6e(0x1e8)),_0x40c98b=(0x0,date_1['formatDate'])(new Date(Date[_0x343e6e(0x188)]()-Number(_0x123a36-0x1)*0x18*0x3c*0x3c*0x3e8),_0x343e6e(0x1e8)),_0x47e2df=_0x343e6e(0x196),_0x4e2d28=_0x343e6e(0x197),{baiduToken:_0x266b14,baiduSiteId:_0x4eef8e,baiduApiKey:_0xd27d00,baiduSecretKey:_0x58ba67,baiduRefreshToken:_0x4cf100}=await this['globalConfigService']['getConfigs']([_0x343e6e(0x1d9),'baiduSiteId',_0x343e6e(0x1bf),_0x343e6e(0x1a7),_0x343e6e(0x18e)]);if(!_0xd27d00||!_0x4eef8e||!_0x4cf100||!_0x58ba67)return[];let _0x4a28b7=_0x266b14,_0x4a1e9d,_0x3f4ef9;const _0x95a90=async _0x2b5a0d=>{const _0x445001=_0x343e6e;_0x3f4ef9=_0x445001(0x182)+_0x2b5a0d+_0x445001(0x1c7)+_0x4eef8e+'&method='+_0x4e2d28+'&start_date='+_0x40c98b+_0x445001(0x1b1)+_0x469a41+'&metrics='+_0x47e2df;try{return await axios_1['default'][_0x445001(0x193)](_0x3f4ef9);}catch(_0x431cfb){return{'data':{'error_code':0x6f,'message':_0x445001(0x177)}};}};_0x4a1e9d=await _0x95a90(_0x4a28b7);if(_0x4a1e9d['data']['error_code']===0x6f||!_0x266b14){const {accessToken:_0x24b4de,refreshToken:_0x2161d1}=await this[_0x343e6e(0x1d3)](_0xd27d00,_0x58ba67,_0x4cf100);_0x4a28b7=_0x24b4de,await this['updateAccessTokenInDatabase'](_0x4a28b7,_0x2161d1,this[_0x343e6e(0x1cd)]),_0x4a1e9d=await _0x95a90(_0x4a28b7);}const {error_code:_0x2f6cd6,message:_0x45f387}=_0x4a1e9d['data'];if(_0x2f6cd6&&_0x2f6cd6!==0xc8)throw new common_1[(_0x343e6e(0x17c))](_0x45f387||'获取百度统计数据失败',common_1[_0x343e6e(0x199)]['BAD_REQUEST']);return _0x4a1e9d[_0x343e6e(0x190)][_0x343e6e(0x1a5)];}async[_0x5a0849(0x1c2)](){const _0xb71f23=await this['orderEntity']['count']();return _0xb71f23;}async[_0x5a0849(0x1a0)](){const _0x57ec9f=_0x5a0849,_0x4acd1d=new Date();_0x4acd1d[_0x57ec9f(0x1b0)](0x0,0x0,0x0,0x0);const _0x193c74=new Date(_0x4acd1d[_0x57ec9f(0x1ef)]()+0x18*0x3c*0x3c*0x3e8),_0x15ddb4=this[_0x57ec9f(0x19e)]['createQueryBuilder'](_0x57ec9f(0x1b2)),_0x1e4f96=await _0x15ddb4[_0x57ec9f(0x1a1)](_0x57ec9f(0x1e3),{'today':_0x4acd1d})[_0x57ec9f(0x18b)](_0x57ec9f(0x180),{'tomorrow':_0x193c74})[_0x57ec9f(0x1e2)]();return _0x1e4f96;}};StatisticService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x5a0849(0x1b3)])(user_entity_1[_0x5a0849(0x1eb)])),__param(0x1,(0x0,typeorm_1[_0x5a0849(0x1b3)])(chatLog_entity_1[_0x5a0849(0x1c3)])),__param(0x2,(0x0,typeorm_1[_0x5a0849(0x1b3)])(config_entity_1[_0x5a0849(0x17e)])),__param(0x3,(0x0,typeorm_1[_0x5a0849(0x1b3)])(order_entity_1[_0x5a0849(0x1db)])),__metadata(_0x5a0849(0x185),[typeorm_2[_0x5a0849(0x181)],typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2[_0x5a0849(0x181)],globalConfig_service_1['GlobalConfigService']])],StatisticService),exports[_0x5a0849(0x1d0)]=StatisticService;function _0x5306(){const _0x432f40=['orderEntity','../../common/constants/balance.constant','countNewOrdersToday','where','count','countUsers','getBaseStatistic','result','getRawMany','baiduSecretKey','323813OWrGWb','chatLogEntity','decorate','user','5780450dSghHK','../chatLog/chatLog.entity','PAINT','groupBy','setHours','&end_date=','order','InjectRepository','&client_secret=','1MIQvHX','@nestjs/typeorm','stack','http://openapi.baidu.com/oauth/2.0/token?grant_type=refresh_token&refresh_token=','length','user.createdAt\x20>=\x20:today','12uLWZao','getBaiduVisit','globalConfigService','__decorate','baiduApiKey','countNewDrawsToday','__metadata','countOrders','ChatLogEntity','access_token','object','refresh_token','&site_id=','DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','userEntity','map','countNewChatsToday','date','configEntity','countChats','__esModule','StatisticService','response','countNewUsersToday','getNewAccessToken','../order/order.entity','getChatStatistic','ChatType','createQueryBuilder','message','baiduToken','user.createdAt\x20<\x20:tomorrow','OrderEntity','184olSfzb','chatlog.type\x20=\x20:type','getDate','countDraws','26912WhWgqy','function','getCount','order.createdAt\x20>=\x20:today','__param','value','290878pbXlyd','push','YYYYMMDD','axios','setDate','UserEntity','orderBy','../globalConfig/config.entity','chatlog.createdAt\x20>=\x20:startDate','getTime','getBaiduStatistics','M.DD','countDrawsByTimeRange','NORMAL_CHAT','Logger','Access\x20token\x20invalid\x20or\x20no\x20longer\x20valid','chatlog','5233083yoUVCu','8050584LpaGfC','../globalConfig/globalConfig.service','HttpException','获取新\x20accessToken\x20失败','ConfigEntity','No\x20response\x20data','order.createdAt\x20<\x20:tomorrow','Repository','https://openapi.baidu.com/rest/2.0/tongji/report/getData?access_token=','metadata','update','design:paramtypes','33557326KFhMjW','9uLQyAX','now','chatLog.createdAt\x20>=\x20:today','../user/user.entity','andWhere','status','370dsOkIG','baiduRefreshToken','defineProperty','data','&client_id=','typeorm','get','Failed\x20to\x20get\x20new\x20access\x20token','../../common/utils/date','pv_count,visitor_count,ip_count,bounce_ratio,avg_visit_time','overview/getTimeTrendRpt','select','HttpStatus','formatDate','chatLog.type\x20=\x20:type','chatLog','@nestjs/common'];_0x5306=function(){return _0x432f40;};return _0x5306();}