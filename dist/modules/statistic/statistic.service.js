'use strict';const _0x54a7af=_0x2994;function _0x2994(_0xa8ea1,_0x5bc053){const _0x1f0976=_0x1f09();return _0x2994=function(_0x2994fa,_0x5b9277){_0x2994fa=_0x2994fa-0x111;let _0x3d67c9=_0x1f0976[_0x2994fa];return _0x3d67c9;},_0x2994(_0xa8ea1,_0x5bc053);}(function(_0x5e842b,_0x15cc3b){const _0x202f4c=_0x2994,_0x8e1af9=_0x5e842b();while(!![]){try{const _0x52ef71=-parseInt(_0x202f4c(0x150))/0x1+-parseInt(_0x202f4c(0x12e))/0x2*(-parseInt(_0x202f4c(0x135))/0x3)+parseInt(_0x202f4c(0x142))/0x4*(-parseInt(_0x202f4c(0x172))/0x5)+-parseInt(_0x202f4c(0x12f))/0x6*(-parseInt(_0x202f4c(0x12b))/0x7)+parseInt(_0x202f4c(0x141))/0x8*(parseInt(_0x202f4c(0x144))/0x9)+-parseInt(_0x202f4c(0x11d))/0xa+-parseInt(_0x202f4c(0x17f))/0xb;if(_0x52ef71===_0x15cc3b)break;else _0x8e1af9['push'](_0x8e1af9['shift']());}catch(_0x5efbb3){_0x8e1af9['push'](_0x8e1af9['shift']());}}}(_0x1f09,0x39135));var __decorate=this&&this['__decorate']||function(_0x42f0a5,_0x22dc72,_0xbee2e0,_0x346dea){const _0x5229b9=_0x2994;var _0x4f9d7e=arguments[_0x5229b9(0x122)],_0x4eec1c=_0x4f9d7e<0x3?_0x22dc72:_0x346dea===null?_0x346dea=Object[_0x5229b9(0x161)](_0x22dc72,_0xbee2e0):_0x346dea,_0x512f15;if(typeof Reflect===_0x5229b9(0x113)&&typeof Reflect[_0x5229b9(0x176)]===_0x5229b9(0x168))_0x4eec1c=Reflect[_0x5229b9(0x176)](_0x42f0a5,_0x22dc72,_0xbee2e0,_0x346dea);else{for(var _0x51448c=_0x42f0a5[_0x5229b9(0x122)]-0x1;_0x51448c>=0x0;_0x51448c--)if(_0x512f15=_0x42f0a5[_0x51448c])_0x4eec1c=(_0x4f9d7e<0x3?_0x512f15(_0x4eec1c):_0x4f9d7e>0x3?_0x512f15(_0x22dc72,_0xbee2e0,_0x4eec1c):_0x512f15(_0x22dc72,_0xbee2e0))||_0x4eec1c;}return _0x4f9d7e>0x3&&_0x4eec1c&&Object[_0x5229b9(0x13a)](_0x22dc72,_0xbee2e0,_0x4eec1c),_0x4eec1c;},__metadata=this&&this['__metadata']||function(_0x381861,_0x102d1d){const _0x28a960=_0x2994;if(typeof Reflect===_0x28a960(0x113)&&typeof Reflect[_0x28a960(0x12d)]===_0x28a960(0x168))return Reflect[_0x28a960(0x12d)](_0x381861,_0x102d1d);},__param=this&&this['__param']||function(_0x1993a9,_0x4144ec){return function(_0x22910d,_0x552a94){_0x4144ec(_0x22910d,_0x552a94,_0x1993a9);};};function _0x1f09(){const _0x2b0630=['decorate','DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','countDrawsByTimeRange','refresh_token','orderBy','UserEntity','&end_date=','default','chatLog.type\x20=\x20:type','4378264lJwvCf','../globalConfig/config.entity','ChatLogEntity','&metrics=','setHours','order.createdAt\x20>=\x20:today','chatLog.createdAt\x20>=\x20:today','PAINT','../globalConfig/globalConfig.service','getNewAccessToken','../user/user.entity','chatlog.createdAt\x20>=\x20:startDate','response','countDraws','select','M.DD','object','Logger','YYYYMMDD','获取新\x20accessToken\x20失败','andWhere','获取百度统计数据失败','axios','formatDate','chatlog.type\x20=\x20:type','https://openapi.baidu.com/rest/2.0/tongji/report/getData?access_token=','802330hduDjt','countNewOrdersToday','chatLogEntity','../chatLog/chatLog.entity','baiduApiKey','length','push','InjectRepository','updateAccessTokenInDatabase','baiduRefreshToken','@nestjs/common','countNewDrawsToday','__esModule','find','567NeTeqK','countUsers','metadata','8ZVvtjm','34302iFmydG','map','where','&client_id=','getConfigs','baiduToken','257841sIfeck','countOrders','value','status','&client_secret=','defineProperty','HttpException','createQueryBuilder','&site_id=','countChats','update','data','134616rKNFwp','21436aTVrwJ','StatisticService','126RzZegm','pv_count,visitor_count,ip_count,bounce_ratio,avg_visit_time','getBaiduVisit','chatlog','getChatStatistic','user.createdAt\x20<\x20:tomorrow','design:paramtypes','Access\x20token\x20invalid\x20or\x20no\x20longer\x20valid','access_token','user','order','&start_date=','105327ubzszH','baiduSecretKey','Injectable','http://openapi.baidu.com/oauth/2.0/token?grant_type=refresh_token&refresh_token=','Repository','date','setDate','orderEntity','groupBy','OrderEntity','baiduSiteId','countChatsByTimeRange','result','getTime','typeorm','getDate','BAD_REQUEST','getOwnPropertyDescriptor','chatLog','getBaiduStatistics','countNewUsersToday','HttpStatus','getBaseStatistic','count','function','NORMAL_CHAT','get','No\x20response\x20data','userEntity','error','getCount','now','../../common/constants/balance.constant','overview/getTimeTrendRpt','210lYOyCQ','ChatType','chatLog.createdAt\x20<\x20:tomorrow','getRawMany'];_0x1f09=function(){return _0x2b0630;};return _0x1f09();}Object[_0x54a7af(0x13a)](exports,_0x54a7af(0x129),{'value':!![]}),exports[_0x54a7af(0x143)]=void 0x0;const balance_constant_1=require(_0x54a7af(0x170)),date_1=require('../../common/utils/date'),common_1=require(_0x54a7af(0x127)),typeorm_1=require('@nestjs/typeorm'),axios_1=require(_0x54a7af(0x119)),typeorm_2=require(_0x54a7af(0x15e)),chatLog_entity_1=require(_0x54a7af(0x120)),config_entity_1=require(_0x54a7af(0x180)),globalConfig_service_1=require(_0x54a7af(0x187)),order_entity_1=require('../order/order.entity'),user_entity_1=require(_0x54a7af(0x189));let StatisticService=class StatisticService{constructor(_0x40a94e,_0x22d36e,_0x44e723,_0x551ed7,_0x2d01cb){const _0x24bfb2=_0x54a7af;this[_0x24bfb2(0x16c)]=_0x40a94e,this[_0x24bfb2(0x11f)]=_0x22d36e,this['configEntity']=_0x44e723,this[_0x24bfb2(0x157)]=_0x551ed7,this['globalConfigService']=_0x2d01cb;}async[_0x54a7af(0x166)](){const _0x3fe9d2=_0x54a7af,_0x10a841=await this[_0x3fe9d2(0x12c)](),_0x494c3e=await this[_0x3fe9d2(0x164)](),_0x4a5f7d=await this['countChats'](),_0xcaf3c7=await this['countNewChatsToday'](),_0x377db2=await this[_0x3fe9d2(0x18c)](),_0x136966=await this[_0x3fe9d2(0x128)](),_0x55fb70=await this[_0x3fe9d2(0x136)](),_0x2c67e4=await this[_0x3fe9d2(0x11e)]();return{'userCount':_0x10a841,'newUserCount':_0x494c3e,'chatCount':_0x4a5f7d,'newChatCount':_0xcaf3c7,'drawCount':_0x377db2,'newDrawCount':_0x136966,'orderCount':_0x55fb70,'newOrderCount':_0x2c67e4};}async[_0x54a7af(0x148)]({days:days=0x7}){const _0x404eb1=_0x54a7af,_0x124c25=await this['countChatsByTimeRange'](days),_0xd7a509=await this[_0x404eb1(0x178)](days);return{'date':_0x124c25['map'](_0x1c5b66=>_0x1c5b66[_0x404eb1(0x155)]),'chat':_0x124c25[_0x404eb1(0x130)](_0x26e83c=>_0x26e83c[_0x404eb1(0x137)]),'draw':_0xd7a509[_0x404eb1(0x130)]((_0x5d9d9d,_0x28ef92)=>{const _0x1dba53=_0x404eb1;return _0x5d9d9d[_0x1dba53(0x137)];})};}async[_0x54a7af(0x146)]({days:days=0x7}){const _0x290f98=_0x54a7af,_0x335d59=await this[_0x290f98(0x163)](days);return _0x335d59;}async[_0x54a7af(0x12c)](){const _0x465ef0=_0x54a7af,_0x46fa57=await this[_0x465ef0(0x16c)][_0x465ef0(0x167)]();return _0x46fa57;}async[_0x54a7af(0x164)](){const _0x4fa23f=_0x54a7af,_0x2b9653=new Date();_0x2b9653[_0x4fa23f(0x183)](0x0,0x0,0x0,0x0);const _0x3b5fb6=new Date(_0x2b9653[_0x4fa23f(0x15d)]()+0x18*0x3c*0x3c*0x3e8),_0x216275=this['userEntity'][_0x4fa23f(0x13c)](_0x4fa23f(0x14d)),_0x3ff7d9=await _0x216275[_0x4fa23f(0x131)]('user.createdAt\x20>=\x20:today',{'today':_0x2b9653})[_0x4fa23f(0x117)](_0x4fa23f(0x149),{'tomorrow':_0x3b5fb6})['getCount']();return _0x3ff7d9;}async[_0x54a7af(0x13e)](){const _0xb1b5d4=_0x54a7af,_0x31c931=await this[_0xb1b5d4(0x11f)][_0xb1b5d4(0x167)]({'where':{'type':balance_constant_1[_0xb1b5d4(0x173)][_0xb1b5d4(0x169)]}});return _0x31c931;}async['countNewChatsToday'](){const _0x20b99b=_0x54a7af,_0x4ba727=new Date();_0x4ba727[_0x20b99b(0x183)](0x0,0x0,0x0,0x0);const _0x218daf=new Date(_0x4ba727['getTime']()+0x18*0x3c*0x3c*0x3e8),_0x3291d9=this['chatLogEntity'][_0x20b99b(0x13c)](_0x20b99b(0x162)),_0x36ecda=await _0x3291d9[_0x20b99b(0x131)](_0x20b99b(0x17e),{'type':balance_constant_1[_0x20b99b(0x173)][_0x20b99b(0x169)]})[_0x20b99b(0x117)](_0x20b99b(0x185),{'today':_0x4ba727})[_0x20b99b(0x117)]('chatLog.createdAt\x20<\x20:tomorrow',{'tomorrow':_0x218daf})[_0x20b99b(0x16e)]();return _0x36ecda;}async[_0x54a7af(0x18c)](){const _0x3528e4=_0x54a7af,_0x2148eb=await this[_0x3528e4(0x11f)][_0x3528e4(0x167)]({'where':{'type':balance_constant_1[_0x3528e4(0x173)][_0x3528e4(0x186)]}});return _0x2148eb;}async[_0x54a7af(0x128)](){const _0x1f063d=_0x54a7af,_0xbbe7a1=new Date();_0xbbe7a1[_0x1f063d(0x183)](0x0,0x0,0x0,0x0);const _0x5b7714=new Date(_0xbbe7a1[_0x1f063d(0x15d)]()+0x18*0x3c*0x3c*0x3e8),_0x1cd6de=this[_0x1f063d(0x11f)][_0x1f063d(0x13c)](_0x1f063d(0x162)),_0x695db=await _0x1cd6de['where'](_0x1f063d(0x17e),{'type':balance_constant_1['ChatType'][_0x1f063d(0x186)]})[_0x1f063d(0x117)](_0x1f063d(0x185),{'today':_0xbbe7a1})[_0x1f063d(0x117)](_0x1f063d(0x174),{'tomorrow':_0x5b7714})[_0x1f063d(0x16e)]();return _0x695db;}async[_0x54a7af(0x15b)](_0x3e8832){const _0x106336=_0x54a7af;var _0x985dae,_0x3928a1;const _0x1a9b5c=new Date();_0x1a9b5c[_0x106336(0x183)](0x0,0x0,0x0,0x0);const _0x187482=new Date(_0x1a9b5c[_0x106336(0x15d)]()-(_0x3e8832-0x1)*0x18*0x3c*0x3c*0x3e8),_0x2d6530=this[_0x106336(0x11f)][_0x106336(0x13c)]('chatlog'),_0x1eea59=await _0x2d6530['select'](_0x106336(0x177))[_0x106336(0x131)](_0x106336(0x11b),{'type':balance_constant_1[_0x106336(0x173)][_0x106336(0x169)]})[_0x106336(0x117)](_0x106336(0x18a),{'startDate':_0x187482})[_0x106336(0x158)](_0x106336(0x155))[_0x106336(0x17a)]('date')[_0x106336(0x175)](),_0x140fda=[],_0x567fd2=_0x187482;for(let _0x5db82e=0x0;_0x5db82e<_0x3e8832;_0x5db82e++){const _0xe5bdc9=(0x0,date_1[_0x106336(0x11a)])(new Date(_0x567fd2),_0x106336(0x112)),_0x37f503=(_0x3928a1=(_0x985dae=_0x1eea59[_0x106336(0x12a)](_0x217ea5=>(0x0,date_1['formatDate'])(new Date(_0x217ea5[_0x106336(0x155)]),_0x106336(0x112))===_0xe5bdc9))===null||_0x985dae===void 0x0?void 0x0:_0x985dae['count'])!==null&&_0x3928a1!==void 0x0?_0x3928a1:0x0;_0x37f503>0x0?_0x140fda[_0x106336(0x123)]({'date':_0xe5bdc9,'value':Number(_0x37f503)}):_0x140fda[_0x106336(0x123)]({'date':_0xe5bdc9,'value':0x0}),_0x567fd2[_0x106336(0x156)](_0x567fd2[_0x106336(0x15f)]()+0x1);}return _0x140fda;}async[_0x54a7af(0x178)](_0x259310){const _0x7adb6c=_0x54a7af;var _0x8b3de3,_0x30f659;const _0x10b7cf=new Date();_0x10b7cf[_0x7adb6c(0x183)](0x0,0x0,0x0,0x0);const _0x6ae0d4=new Date(_0x10b7cf[_0x7adb6c(0x15d)]()-(_0x259310-0x1)*0x18*0x3c*0x3c*0x3e8),_0x511393=this[_0x7adb6c(0x11f)]['createQueryBuilder'](_0x7adb6c(0x147)),_0x4d97b2=await _0x511393[_0x7adb6c(0x111)](_0x7adb6c(0x177))[_0x7adb6c(0x131)]('chatlog.type\x20=\x20:type',{'type':balance_constant_1[_0x7adb6c(0x173)]['PAINT']})['andWhere'](_0x7adb6c(0x18a),{'startDate':_0x6ae0d4})[_0x7adb6c(0x158)]('date')[_0x7adb6c(0x17a)](_0x7adb6c(0x155))[_0x7adb6c(0x175)](),_0x4e4d09=[],_0x405e77=_0x6ae0d4;for(let _0x56c8ba=0x0;_0x56c8ba<_0x259310;_0x56c8ba++){const _0x1d619b=(0x0,date_1[_0x7adb6c(0x11a)])(new Date(_0x405e77),'M.DD'),_0x4abcf4=(_0x30f659=(_0x8b3de3=_0x4d97b2['find'](_0x5c30b2=>(0x0,date_1[_0x7adb6c(0x11a)])(new Date(_0x5c30b2[_0x7adb6c(0x155)]),_0x7adb6c(0x112))===_0x1d619b))===null||_0x8b3de3===void 0x0?void 0x0:_0x8b3de3[_0x7adb6c(0x167)])!==null&&_0x30f659!==void 0x0?_0x30f659:0x0;_0x4abcf4>0x0?_0x4e4d09[_0x7adb6c(0x123)]({'date':_0x1d619b,'value':Number(_0x4abcf4)}):_0x4e4d09[_0x7adb6c(0x123)]({'date':_0x1d619b,'value':0x0}),_0x405e77[_0x7adb6c(0x156)](_0x405e77[_0x7adb6c(0x15f)]()+0x1);}return _0x4e4d09;}async[_0x54a7af(0x188)](_0x443f76,_0x3c645c,_0x2ec1ed){const _0x1a55c2=_0x54a7af,_0x3ad7a0=_0x1a55c2(0x153)+_0x2ec1ed+_0x1a55c2(0x132)+_0x443f76+_0x1a55c2(0x139)+_0x3c645c;common_1[_0x1a55c2(0x114)]['log']('获取新\x20accessToken',_0x3ad7a0);try{const _0x112b98=await axios_1[_0x1a55c2(0x17d)][_0x1a55c2(0x16a)](_0x3ad7a0);if(_0x112b98[_0x1a55c2(0x138)]===0xc8&&_0x112b98[_0x1a55c2(0x140)][_0x1a55c2(0x14c)])return{'accessToken':_0x112b98[_0x1a55c2(0x140)][_0x1a55c2(0x14c)],'refreshToken':_0x112b98[_0x1a55c2(0x140)][_0x1a55c2(0x179)]};else throw new Error('Failed\x20to\x20get\x20new\x20access\x20token');}catch(_0x52e3fc){common_1['Logger'][_0x1a55c2(0x16d)](_0x1a55c2(0x116),{'message':_0x52e3fc['message'],'stack':_0x52e3fc['stack'],'response':_0x52e3fc[_0x1a55c2(0x18b)]?_0x52e3fc[_0x1a55c2(0x18b)]['data']:_0x1a55c2(0x16b)});throw new common_1[(_0x1a55c2(0x13b))]('获取新\x20accessToken\x20失败',common_1[_0x1a55c2(0x165)][_0x1a55c2(0x160)]);}}async[_0x54a7af(0x125)](_0x2d382d,_0x3540b1,_0x12d492){const _0x4f962b=_0x54a7af;await _0x12d492[_0x4f962b(0x13f)]({'configKey':_0x4f962b(0x134)},{'configVal':_0x2d382d}),await _0x12d492[_0x4f962b(0x13f)]({'configKey':'baiduRefreshToken'},{'configVal':_0x3540b1});}async['getBaiduStatistics'](_0x4b0b16){const _0x29a795=_0x54a7af,_0x4f17a8=(0x0,date_1['formatDate'])(new Date(),_0x29a795(0x115)),_0x2d3585=(0x0,date_1[_0x29a795(0x11a)])(new Date(Date[_0x29a795(0x16f)]()-Number(_0x4b0b16-0x1)*0x18*0x3c*0x3c*0x3e8),_0x29a795(0x115)),_0xcc44f8=_0x29a795(0x145),_0x5a56ce=_0x29a795(0x171),{baiduToken:_0x34402b,baiduSiteId:_0x1040ac,baiduApiKey:_0x18bdbf,baiduSecretKey:_0x213a4b,baiduRefreshToken:_0x15b019}=await this['globalConfigService'][_0x29a795(0x133)]([_0x29a795(0x134),_0x29a795(0x15a),_0x29a795(0x121),_0x29a795(0x151),_0x29a795(0x126)]);if(!_0x18bdbf||!_0x1040ac||!_0x15b019||!_0x213a4b)return[];let _0x32e5d6=_0x34402b,_0x34e797,_0x1eeeb4;const _0x2c9741=async _0x327014=>{const _0x44acb0=_0x29a795;_0x1eeeb4=_0x44acb0(0x11c)+_0x327014+_0x44acb0(0x13d)+_0x1040ac+'&method='+_0x5a56ce+_0x44acb0(0x14f)+_0x2d3585+_0x44acb0(0x17c)+_0x4f17a8+_0x44acb0(0x182)+_0xcc44f8;try{return await axios_1[_0x44acb0(0x17d)][_0x44acb0(0x16a)](_0x1eeeb4);}catch(_0x5e78c5){return{'data':{'error_code':0x6f,'message':_0x44acb0(0x14b)}};}};_0x34e797=await _0x2c9741(_0x32e5d6);if(_0x34e797['data']['error_code']===0x6f||!_0x34402b){const {accessToken:_0x4451bd,refreshToken:_0xa5f856}=await this['getNewAccessToken'](_0x18bdbf,_0x213a4b,_0x15b019);_0x32e5d6=_0x4451bd,await this[_0x29a795(0x125)](_0x32e5d6,_0xa5f856,this['configEntity']),_0x34e797=await _0x2c9741(_0x32e5d6);}const {error_code:_0x4022e7,message:_0x50483}=_0x34e797[_0x29a795(0x140)];if(_0x4022e7&&_0x4022e7!==0xc8)throw new common_1[(_0x29a795(0x13b))](_0x50483||_0x29a795(0x118),common_1[_0x29a795(0x165)][_0x29a795(0x160)]);return _0x34e797[_0x29a795(0x140)][_0x29a795(0x15c)];}async[_0x54a7af(0x136)](){const _0x5bd917=_0x54a7af,_0x585105=await this['orderEntity'][_0x5bd917(0x167)]();return _0x585105;}async['countNewOrdersToday'](){const _0x40d477=_0x54a7af,_0x2d19bb=new Date();_0x2d19bb[_0x40d477(0x183)](0x0,0x0,0x0,0x0);const _0x58e2cc=new Date(_0x2d19bb[_0x40d477(0x15d)]()+0x18*0x3c*0x3c*0x3e8),_0x265b0f=this[_0x40d477(0x157)][_0x40d477(0x13c)](_0x40d477(0x14e)),_0x1e9cd4=await _0x265b0f[_0x40d477(0x131)](_0x40d477(0x184),{'today':_0x2d19bb})['andWhere']('order.createdAt\x20<\x20:tomorrow',{'tomorrow':_0x58e2cc})['getCount']();return _0x1e9cd4;}};StatisticService=__decorate([(0x0,common_1[_0x54a7af(0x152)])(),__param(0x0,(0x0,typeorm_1[_0x54a7af(0x124)])(user_entity_1[_0x54a7af(0x17b)])),__param(0x1,(0x0,typeorm_1[_0x54a7af(0x124)])(chatLog_entity_1[_0x54a7af(0x181)])),__param(0x2,(0x0,typeorm_1[_0x54a7af(0x124)])(config_entity_1['ConfigEntity'])),__param(0x3,(0x0,typeorm_1[_0x54a7af(0x124)])(order_entity_1[_0x54a7af(0x159)])),__metadata(_0x54a7af(0x14a),[typeorm_2[_0x54a7af(0x154)],typeorm_2[_0x54a7af(0x154)],typeorm_2[_0x54a7af(0x154)],typeorm_2[_0x54a7af(0x154)],globalConfig_service_1['GlobalConfigService']])],StatisticService),exports[_0x54a7af(0x143)]=StatisticService;