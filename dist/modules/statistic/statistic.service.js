'use strict';function _0x31f2(){const _0x223c06=['getCount','getTime','GlobalConfigService','countNewOrdersToday','countNewUsersToday','date','BAD_REQUEST','ChatLogEntity','397155HdRLsE','countDraws','function','chatLog.createdAt\x20>=\x20:today','userEntity','log','orderEntity','countChats','getBaiduStatistics','countOrders','获取新\x20accessToken','updateAccessTokenInDatabase','user','chatLog.createdAt\x20<\x20:tomorrow','M.DD','ChatType','result','OrderEntity','countNewChatsToday','@nestjs/typeorm','baiduSecretKey','countUsers','https://openapi.baidu.com/rest/2.0/tongji/report/getData?access_token=','error','1092DhPbKW','getBaiduVisit','NORMAL_CHAT','getBaseStatistic','2131820jZqkZz','HttpException','user.createdAt\x20>=\x20:today','length','response','29952WQWnKZ','push','301feNBjL','message','order.createdAt\x20<\x20:tomorrow','orderBy','default','getOwnPropertyDescriptor','558YivJQL','2180pCiwUk','order','setDate','object','now','overview/getTimeTrendRpt','data','http://openapi.baidu.com/oauth/2.0/token?grant_type=refresh_token&refresh_token=','1251Hgztyt','PAINT','countNewDrawsToday','select','getNewAccessToken','Access\x20token\x20invalid\x20or\x20no\x20longer\x20valid','access_token','../globalConfig/globalConfig.service','map','countChatsByTimeRange','7624SyoyLe','createQueryBuilder','&metrics=','../../common/utils/date','15807AUKEwd','21176AGGnJj','Logger','setHours','InjectRepository','Repository','&client_id=','chatLogEntity','获取百度统计数据失败','globalConfigService','count','get','refresh_token','getChatStatistic','../chatLog/chatLog.entity','where','groupBy','chatLog','No\x20response\x20data','chatlog.type\x20=\x20:type','getRawMany','design:paramtypes','HttpStatus','formatDate','find','chatLog.type\x20=\x20:type','typeorm','../globalConfig/config.entity','getDate','531NhoAQu','metadata','configEntity','error_code','&method=','UserEntity','baiduRefreshToken','YYYYMMDD','ConfigEntity','order.createdAt\x20>=\x20:today','&site_id=','value','axios','defineProperty','StatisticService','获取新\x20accessToken\x20失败','baiduToken','@nestjs/common','../user/user.entity','&client_secret=','__param','__decorate','status','update','baiduSiteId','andWhere'];_0x31f2=function(){return _0x223c06;};return _0x31f2();}const _0x306e10=_0x413b;(function(_0x1f66de,_0x4de916){const _0x4b00bc=_0x413b,_0x15cc0a=_0x1f66de();while(!![]){try{const _0x1e1653=-parseInt(_0x4b00bc(0x88))/0x1*(-parseInt(_0x4b00bc(0xd4))/0x2)+parseInt(_0x4b00bc(0xd3))/0x3*(-parseInt(_0x4b00bc(0xe6))/0x4)+-parseInt(_0x4b00bc(0xaa))/0x5+parseInt(_0x4b00bc(0xcb))/0x6*(-parseInt(_0x4b00bc(0xcd))/0x7)+-parseInt(_0x4b00bc(0xeb))/0x8*(-parseInt(_0x4b00bc(0xdc))/0x9)+parseInt(_0x4b00bc(0xc6))/0xa+parseInt(_0x4b00bc(0xea))/0xb*(-parseInt(_0x4b00bc(0xc2))/0xc);if(_0x1e1653===_0x4de916)break;else _0x15cc0a['push'](_0x15cc0a['shift']());}catch(_0x5ca374){_0x15cc0a['push'](_0x15cc0a['shift']());}}}(_0x31f2,0x5ce77));var __decorate=this&&this[_0x306e10(0x9d)]||function(_0x30bf08,_0x1ffd3b,_0x58fccd,_0x5aa6f8){const _0x6042fd=_0x306e10;var _0x311748=arguments[_0x6042fd(0xc9)],_0x1669cf=_0x311748<0x3?_0x1ffd3b:_0x5aa6f8===null?_0x5aa6f8=Object[_0x6042fd(0xd2)](_0x1ffd3b,_0x58fccd):_0x5aa6f8,_0x57ad3f;if(typeof Reflect===_0x6042fd(0xd7)&&typeof Reflect['decorate']===_0x6042fd(0xac))_0x1669cf=Reflect['decorate'](_0x30bf08,_0x1ffd3b,_0x58fccd,_0x5aa6f8);else{for(var _0x44c935=_0x30bf08[_0x6042fd(0xc9)]-0x1;_0x44c935>=0x0;_0x44c935--)if(_0x57ad3f=_0x30bf08[_0x44c935])_0x1669cf=(_0x311748<0x3?_0x57ad3f(_0x1669cf):_0x311748>0x3?_0x57ad3f(_0x1ffd3b,_0x58fccd,_0x1669cf):_0x57ad3f(_0x1ffd3b,_0x58fccd))||_0x1669cf;}return _0x311748>0x3&&_0x1669cf&&Object[_0x6042fd(0x95)](_0x1ffd3b,_0x58fccd,_0x1669cf),_0x1669cf;},__metadata=this&&this['__metadata']||function(_0x582b4a,_0x352a3b){const _0xcb23d4=_0x306e10;if(typeof Reflect===_0xcb23d4(0xd7)&&typeof Reflect['metadata']===_0xcb23d4(0xac))return Reflect[_0xcb23d4(0x89)](_0x582b4a,_0x352a3b);},__param=this&&this[_0x306e10(0x9c)]||function(_0x15f918,_0x2bef85){return function(_0x46a7fa,_0x5e1a09){_0x2bef85(_0x46a7fa,_0x5e1a09,_0x15f918);};};Object[_0x306e10(0x95)](exports,'__esModule',{'value':!![]}),exports[_0x306e10(0x96)]=void 0x0;function _0x413b(_0x5a3df7,_0x37bd33){const _0x31f2c3=_0x31f2();return _0x413b=function(_0x413b12,_0x5978ce){_0x413b12=_0x413b12-0x76;let _0x33343a=_0x31f2c3[_0x413b12];return _0x33343a;},_0x413b(_0x5a3df7,_0x37bd33);}const balance_constant_1=require('../../common/constants/balance.constant'),date_1=require(_0x306e10(0xe9)),common_1=require(_0x306e10(0x99)),typeorm_1=require(_0x306e10(0xbd)),axios_1=require(_0x306e10(0x94)),typeorm_2=require(_0x306e10(0x85)),chatLog_entity_1=require(_0x306e10(0x79)),config_entity_1=require(_0x306e10(0x86)),globalConfig_service_1=require(_0x306e10(0xe3)),order_entity_1=require('../order/order.entity'),user_entity_1=require(_0x306e10(0x9a));let StatisticService=class StatisticService{constructor(_0x1ca418,_0x5a528e,_0x3b991e,_0x32b942,_0x39a06b){const _0x4fe7f2=_0x306e10;this['userEntity']=_0x1ca418,this[_0x4fe7f2(0xf1)]=_0x5a528e,this[_0x4fe7f2(0x8a)]=_0x3b991e,this[_0x4fe7f2(0xb0)]=_0x32b942,this[_0x4fe7f2(0xf3)]=_0x39a06b;}async[_0x306e10(0xc5)](){const _0x3d9372=_0x306e10,_0xda1a18=await this['countUsers'](),_0x236ccb=await this[_0x3d9372(0xa6)](),_0x4f416f=await this[_0x3d9372(0xb1)](),_0x545266=await this[_0x3d9372(0xbc)](),_0x2f33f8=await this[_0x3d9372(0xab)](),_0x1f90e8=await this[_0x3d9372(0xde)](),_0x2457b3=await this[_0x3d9372(0xb3)](),_0x2ecbe0=await this[_0x3d9372(0xa5)]();return{'userCount':_0xda1a18,'newUserCount':_0x236ccb,'chatCount':_0x4f416f,'newChatCount':_0x545266,'drawCount':_0x2f33f8,'newDrawCount':_0x1f90e8,'orderCount':_0x2457b3,'newOrderCount':_0x2ecbe0};}async[_0x306e10(0x78)]({days:days=0x7}){const _0x163af5=_0x306e10,_0x1e548d=await this[_0x163af5(0xe5)](days),_0x2c3143=await this['countDrawsByTimeRange'](days);return{'date':_0x1e548d[_0x163af5(0xe4)](_0x3de607=>_0x3de607[_0x163af5(0xa7)]),'chat':_0x1e548d[_0x163af5(0xe4)](_0x3d48ba=>_0x3d48ba[_0x163af5(0x93)]),'draw':_0x2c3143[_0x163af5(0xe4)]((_0x4cf199,_0x45cf70)=>{const _0x3c128a=_0x163af5;return _0x4cf199[_0x3c128a(0x93)];})};}async[_0x306e10(0xc3)]({days:days=0x7}){const _0x499aaa=await this['getBaiduStatistics'](days);return _0x499aaa;}async[_0x306e10(0xbf)](){const _0x206174=_0x306e10,_0x3bf368=await this[_0x206174(0xae)][_0x206174(0xf4)]();return _0x3bf368;}async[_0x306e10(0xa6)](){const _0x34e887=_0x306e10,_0x1df9a1=new Date();_0x1df9a1[_0x34e887(0xed)](0x0,0x0,0x0,0x0);const _0x4fb11e=new Date(_0x1df9a1[_0x34e887(0xa3)]()+0x18*0x3c*0x3c*0x3e8),_0x4cbdf7=this[_0x34e887(0xae)][_0x34e887(0xe7)](_0x34e887(0xb6)),_0x2e3e99=await _0x4cbdf7[_0x34e887(0x7a)](_0x34e887(0xc8),{'today':_0x1df9a1})[_0x34e887(0xa1)]('user.createdAt\x20<\x20:tomorrow',{'tomorrow':_0x4fb11e})[_0x34e887(0xa2)]();return _0x2e3e99;}async[_0x306e10(0xb1)](){const _0x3e5dc3=_0x306e10,_0x532031=await this['chatLogEntity'][_0x3e5dc3(0xf4)]({'where':{'type':balance_constant_1[_0x3e5dc3(0xb9)]['NORMAL_CHAT']}});return _0x532031;}async['countNewChatsToday'](){const _0x1a72d5=_0x306e10,_0x33388a=new Date();_0x33388a[_0x1a72d5(0xed)](0x0,0x0,0x0,0x0);const _0x3a0a0a=new Date(_0x33388a[_0x1a72d5(0xa3)]()+0x18*0x3c*0x3c*0x3e8),_0x134747=this[_0x1a72d5(0xf1)][_0x1a72d5(0xe7)](_0x1a72d5(0x7c)),_0x2674f2=await _0x134747[_0x1a72d5(0x7a)]('chatLog.type\x20=\x20:type',{'type':balance_constant_1[_0x1a72d5(0xb9)][_0x1a72d5(0xc4)]})[_0x1a72d5(0xa1)]('chatLog.createdAt\x20>=\x20:today',{'today':_0x33388a})[_0x1a72d5(0xa1)]('chatLog.createdAt\x20<\x20:tomorrow',{'tomorrow':_0x3a0a0a})[_0x1a72d5(0xa2)]();return _0x2674f2;}async[_0x306e10(0xab)](){const _0x1dc31a=_0x306e10,_0x21f860=await this['chatLogEntity'][_0x1dc31a(0xf4)]({'where':{'type':balance_constant_1[_0x1dc31a(0xb9)][_0x1dc31a(0xdd)]}});return _0x21f860;}async[_0x306e10(0xde)](){const _0x529cbf=_0x306e10,_0x367122=new Date();_0x367122[_0x529cbf(0xed)](0x0,0x0,0x0,0x0);const _0x545abe=new Date(_0x367122[_0x529cbf(0xa3)]()+0x18*0x3c*0x3c*0x3e8),_0x5f375d=this['chatLogEntity']['createQueryBuilder'](_0x529cbf(0x7c)),_0x46abe3=await _0x5f375d[_0x529cbf(0x7a)](_0x529cbf(0x84),{'type':balance_constant_1['ChatType'][_0x529cbf(0xdd)]})['andWhere'](_0x529cbf(0xad),{'today':_0x367122})[_0x529cbf(0xa1)](_0x529cbf(0xb7),{'tomorrow':_0x545abe})[_0x529cbf(0xa2)]();return _0x46abe3;}async[_0x306e10(0xe5)](_0xe43c47){const _0xc7cbaa=_0x306e10;var _0x373277,_0x57b788;const _0x38b99b=new Date();_0x38b99b['setHours'](0x0,0x0,0x0,0x0);const _0x3a5382=new Date(_0x38b99b['getTime']()-(_0xe43c47-0x1)*0x18*0x3c*0x3c*0x3e8),_0x1158f3=this['chatLogEntity'][_0xc7cbaa(0xe7)]('chatlog'),_0x32da15=await _0x1158f3[_0xc7cbaa(0xdf)]('DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count')[_0xc7cbaa(0x7a)](_0xc7cbaa(0x7e),{'type':balance_constant_1[_0xc7cbaa(0xb9)][_0xc7cbaa(0xc4)]})[_0xc7cbaa(0xa1)]('chatlog.createdAt\x20>=\x20:startDate',{'startDate':_0x3a5382})['groupBy'](_0xc7cbaa(0xa7))[_0xc7cbaa(0xd0)](_0xc7cbaa(0xa7))['getRawMany'](),_0x215741=[],_0x13593b=_0x3a5382;for(let _0x22329d=0x0;_0x22329d<_0xe43c47;_0x22329d++){const _0xf4b792=(0x0,date_1[_0xc7cbaa(0x82)])(new Date(_0x13593b),_0xc7cbaa(0xb8)),_0x55a2c3=(_0x57b788=(_0x373277=_0x32da15[_0xc7cbaa(0x83)](_0x50d207=>(0x0,date_1[_0xc7cbaa(0x82)])(new Date(_0x50d207[_0xc7cbaa(0xa7)]),'M.DD')===_0xf4b792))===null||_0x373277===void 0x0?void 0x0:_0x373277[_0xc7cbaa(0xf4)])!==null&&_0x57b788!==void 0x0?_0x57b788:0x0;_0x55a2c3>0x0?_0x215741[_0xc7cbaa(0xcc)]({'date':_0xf4b792,'value':Number(_0x55a2c3)}):_0x215741[_0xc7cbaa(0xcc)]({'date':_0xf4b792,'value':0x0}),_0x13593b[_0xc7cbaa(0xd6)](_0x13593b[_0xc7cbaa(0x87)]()+0x1);}return _0x215741;}async['countDrawsByTimeRange'](_0x5b21a9){const _0x8a4fa7=_0x306e10;var _0xa52c58,_0x29b5a2;const _0x56f045=new Date();_0x56f045[_0x8a4fa7(0xed)](0x0,0x0,0x0,0x0);const _0x47d387=new Date(_0x56f045[_0x8a4fa7(0xa3)]()-(_0x5b21a9-0x1)*0x18*0x3c*0x3c*0x3e8),_0x384406=this['chatLogEntity'][_0x8a4fa7(0xe7)]('chatlog'),_0x1c5bdd=await _0x384406[_0x8a4fa7(0xdf)]('DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count')[_0x8a4fa7(0x7a)](_0x8a4fa7(0x7e),{'type':balance_constant_1[_0x8a4fa7(0xb9)]['PAINT']})[_0x8a4fa7(0xa1)]('chatlog.createdAt\x20>=\x20:startDate',{'startDate':_0x47d387})[_0x8a4fa7(0x7b)](_0x8a4fa7(0xa7))[_0x8a4fa7(0xd0)](_0x8a4fa7(0xa7))[_0x8a4fa7(0x7f)](),_0x43b6d4=[],_0x2f3d47=_0x47d387;for(let _0x213eb3=0x0;_0x213eb3<_0x5b21a9;_0x213eb3++){const _0x3dd43b=(0x0,date_1[_0x8a4fa7(0x82)])(new Date(_0x2f3d47),_0x8a4fa7(0xb8)),_0xb343f=(_0x29b5a2=(_0xa52c58=_0x1c5bdd[_0x8a4fa7(0x83)](_0xb0a26f=>(0x0,date_1[_0x8a4fa7(0x82)])(new Date(_0xb0a26f[_0x8a4fa7(0xa7)]),_0x8a4fa7(0xb8))===_0x3dd43b))===null||_0xa52c58===void 0x0?void 0x0:_0xa52c58[_0x8a4fa7(0xf4)])!==null&&_0x29b5a2!==void 0x0?_0x29b5a2:0x0;_0xb343f>0x0?_0x43b6d4[_0x8a4fa7(0xcc)]({'date':_0x3dd43b,'value':Number(_0xb343f)}):_0x43b6d4[_0x8a4fa7(0xcc)]({'date':_0x3dd43b,'value':0x0}),_0x2f3d47[_0x8a4fa7(0xd6)](_0x2f3d47[_0x8a4fa7(0x87)]()+0x1);}return _0x43b6d4;}async[_0x306e10(0xe0)](_0x2ccebf,_0x2056c9,_0x429127){const _0x4ec8c0=_0x306e10,_0xd62e67=_0x4ec8c0(0xdb)+_0x429127+_0x4ec8c0(0xf0)+_0x2ccebf+_0x4ec8c0(0x9b)+_0x2056c9;common_1[_0x4ec8c0(0xec)][_0x4ec8c0(0xaf)](_0x4ec8c0(0xb4),_0xd62e67);try{const _0x57429f=await axios_1[_0x4ec8c0(0xd1)][_0x4ec8c0(0x76)](_0xd62e67);if(_0x57429f[_0x4ec8c0(0x9e)]===0xc8&&_0x57429f['data'][_0x4ec8c0(0xe2)])return{'accessToken':_0x57429f['data'][_0x4ec8c0(0xe2)],'refreshToken':_0x57429f[_0x4ec8c0(0xda)][_0x4ec8c0(0x77)]};else throw new Error('Failed\x20to\x20get\x20new\x20access\x20token');}catch(_0x34e806){common_1[_0x4ec8c0(0xec)][_0x4ec8c0(0xc1)](_0x4ec8c0(0x97),{'message':_0x34e806[_0x4ec8c0(0xce)],'stack':_0x34e806['stack'],'response':_0x34e806[_0x4ec8c0(0xca)]?_0x34e806[_0x4ec8c0(0xca)][_0x4ec8c0(0xda)]:_0x4ec8c0(0x7d)});throw new common_1[(_0x4ec8c0(0xc7))](_0x4ec8c0(0x97),common_1[_0x4ec8c0(0x81)][_0x4ec8c0(0xa8)]);}}async['updateAccessTokenInDatabase'](_0x56e843,_0x370bf6,_0x398d71){const _0x5f4d2a=_0x306e10;await _0x398d71[_0x5f4d2a(0x9f)]({'configKey':'baiduToken'},{'configVal':_0x56e843}),await _0x398d71[_0x5f4d2a(0x9f)]({'configKey':_0x5f4d2a(0x8e)},{'configVal':_0x370bf6});}async[_0x306e10(0xb2)](_0x2e2ec6){const _0x117b8f=_0x306e10,_0x1371f7=(0x0,date_1[_0x117b8f(0x82)])(new Date(),_0x117b8f(0x8f)),_0x2790ed=(0x0,date_1[_0x117b8f(0x82)])(new Date(Date[_0x117b8f(0xd8)]()-Number(_0x2e2ec6-0x1)*0x18*0x3c*0x3c*0x3e8),'YYYYMMDD'),_0x1dd280='pv_count,visitor_count,ip_count,bounce_ratio,avg_visit_time',_0x108347=_0x117b8f(0xd9),{baiduToken:_0x52d577,baiduSiteId:_0x5738b0,baiduApiKey:_0x162c80,baiduSecretKey:_0x20195d,baiduRefreshToken:_0xb73a7}=await this['globalConfigService']['getConfigs']([_0x117b8f(0x98),_0x117b8f(0xa0),'baiduApiKey',_0x117b8f(0xbe),'baiduRefreshToken']);if(!_0x162c80||!_0x5738b0||!_0xb73a7||!_0x20195d)return[];let _0x1f55f1=_0x52d577,_0x1507cd,_0x273a3d;const _0x4adc03=async _0x30397f=>{const _0x5eb9f9=_0x117b8f;_0x273a3d=_0x5eb9f9(0xc0)+_0x30397f+_0x5eb9f9(0x92)+_0x5738b0+_0x5eb9f9(0x8c)+_0x108347+'&start_date='+_0x2790ed+'&end_date='+_0x1371f7+_0x5eb9f9(0xe8)+_0x1dd280;try{return await axios_1['default'][_0x5eb9f9(0x76)](_0x273a3d);}catch(_0x2cb9e6){return{'data':{'error_code':0x6f,'message':_0x5eb9f9(0xe1)}};}};_0x1507cd=await _0x4adc03(_0x1f55f1);if(_0x1507cd[_0x117b8f(0xda)][_0x117b8f(0x8b)]===0x6f||!_0x52d577){const {accessToken:_0x15a0ae,refreshToken:_0x8498f0}=await this['getNewAccessToken'](_0x162c80,_0x20195d,_0xb73a7);_0x1f55f1=_0x15a0ae,await this[_0x117b8f(0xb5)](_0x1f55f1,_0x8498f0,this[_0x117b8f(0x8a)]),_0x1507cd=await _0x4adc03(_0x1f55f1);}const {error_code:_0x10b410,message:_0x1e2e84}=_0x1507cd[_0x117b8f(0xda)];if(_0x10b410&&_0x10b410!==0xc8)throw new common_1[(_0x117b8f(0xc7))](_0x1e2e84||_0x117b8f(0xf2),common_1[_0x117b8f(0x81)]['BAD_REQUEST']);return _0x1507cd[_0x117b8f(0xda)][_0x117b8f(0xba)];}async[_0x306e10(0xb3)](){const _0x379e0a=_0x306e10,_0x5f5a08=await this[_0x379e0a(0xb0)]['count']();return _0x5f5a08;}async[_0x306e10(0xa5)](){const _0x2294d1=_0x306e10,_0x4cd04d=new Date();_0x4cd04d[_0x2294d1(0xed)](0x0,0x0,0x0,0x0);const _0x29bef1=new Date(_0x4cd04d[_0x2294d1(0xa3)]()+0x18*0x3c*0x3c*0x3e8),_0x5be66d=this[_0x2294d1(0xb0)]['createQueryBuilder'](_0x2294d1(0xd5)),_0x17388b=await _0x5be66d[_0x2294d1(0x7a)](_0x2294d1(0x91),{'today':_0x4cd04d})['andWhere'](_0x2294d1(0xcf),{'tomorrow':_0x29bef1})[_0x2294d1(0xa2)]();return _0x17388b;}};StatisticService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x306e10(0xee)])(user_entity_1[_0x306e10(0x8d)])),__param(0x1,(0x0,typeorm_1[_0x306e10(0xee)])(chatLog_entity_1[_0x306e10(0xa9)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(config_entity_1[_0x306e10(0x90)])),__param(0x3,(0x0,typeorm_1['InjectRepository'])(order_entity_1[_0x306e10(0xbb)])),__metadata(_0x306e10(0x80),[typeorm_2['Repository'],typeorm_2[_0x306e10(0xef)],typeorm_2['Repository'],typeorm_2[_0x306e10(0xef)],globalConfig_service_1[_0x306e10(0xa4)]])],StatisticService),exports[_0x306e10(0x96)]=StatisticService;