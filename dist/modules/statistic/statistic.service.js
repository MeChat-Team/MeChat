'use strict';const _0x7daab9=_0x5622;(function(_0x1d5fdc,_0x1adcb2){const _0x4f476a=_0x5622,_0x16d18a=_0x1d5fdc();while(!![]){try{const _0x4a9656=-parseInt(_0x4f476a(0xed))/0x1*(-parseInt(_0x4f476a(0x9e))/0x2)+-parseInt(_0x4f476a(0x9b))/0x3*(-parseInt(_0x4f476a(0xca))/0x4)+-parseInt(_0x4f476a(0x86))/0x5+parseInt(_0x4f476a(0xcf))/0x6+-parseInt(_0x4f476a(0x95))/0x7+parseInt(_0x4f476a(0xcb))/0x8+-parseInt(_0x4f476a(0x9f))/0x9;if(_0x4a9656===_0x1adcb2)break;else _0x16d18a['push'](_0x16d18a['shift']());}catch(_0x2480a8){_0x16d18a['push'](_0x16d18a['shift']());}}}(_0x4946,0x29c29));var __decorate=this&&this['__decorate']||function(_0x55bb2f,_0x54cbd5,_0x274ee9,_0x45580e){const _0x4c74b5=_0x5622;var _0x4337d1=arguments[_0x4c74b5(0xc1)],_0x2bc451=_0x4337d1<0x3?_0x54cbd5:_0x45580e===null?_0x45580e=Object[_0x4c74b5(0x76)](_0x54cbd5,_0x274ee9):_0x45580e,_0x411ff6;if(typeof Reflect===_0x4c74b5(0xe7)&&typeof Reflect['decorate']===_0x4c74b5(0xde))_0x2bc451=Reflect[_0x4c74b5(0xba)](_0x55bb2f,_0x54cbd5,_0x274ee9,_0x45580e);else{for(var _0x11efe1=_0x55bb2f[_0x4c74b5(0xc1)]-0x1;_0x11efe1>=0x0;_0x11efe1--)if(_0x411ff6=_0x55bb2f[_0x11efe1])_0x2bc451=(_0x4337d1<0x3?_0x411ff6(_0x2bc451):_0x4337d1>0x3?_0x411ff6(_0x54cbd5,_0x274ee9,_0x2bc451):_0x411ff6(_0x54cbd5,_0x274ee9))||_0x2bc451;}return _0x4337d1>0x3&&_0x2bc451&&Object[_0x4c74b5(0x93)](_0x54cbd5,_0x274ee9,_0x2bc451),_0x2bc451;},__metadata=this&&this[_0x7daab9(0xdc)]||function(_0x357e5e,_0xd4e8aa){const _0x6999e6=_0x7daab9;if(typeof Reflect==='object'&&typeof Reflect[_0x6999e6(0xb3)]==='function')return Reflect[_0x6999e6(0xb3)](_0x357e5e,_0xd4e8aa);},__param=this&&this[_0x7daab9(0xdf)]||function(_0x1740a2,_0x3c425b){return function(_0x50f763,_0x16e3dd){_0x3c425b(_0x50f763,_0x16e3dd,_0x1740a2);};};Object[_0x7daab9(0x93)](exports,'__esModule',{'value':!![]}),exports[_0x7daab9(0xa4)]=void 0x0;const balance_constant_1=require(_0x7daab9(0x91)),date_1=require(_0x7daab9(0xe1)),common_1=require(_0x7daab9(0xc4)),typeorm_1=require('@nestjs/typeorm'),axios_1=require(_0x7daab9(0xcd)),typeorm_2=require(_0x7daab9(0xd6)),chatLog_entity_1=require('../chatLog/chatLog.entity'),config_entity_1=require(_0x7daab9(0xb5)),globalConfig_service_1=require(_0x7daab9(0xe4)),order_entity_1=require('../order/order.entity'),user_entity_1=require(_0x7daab9(0x7d));let StatisticService=class StatisticService{constructor(_0x416b80,_0xf58930,_0x16ae46,_0x3297d3,_0x4764b2){const _0x4dac70=_0x7daab9;this[_0x4dac70(0x8a)]=_0x416b80,this[_0x4dac70(0xe0)]=_0xf58930,this[_0x4dac70(0xb1)]=_0x16ae46,this[_0x4dac70(0xf0)]=_0x3297d3,this['globalConfigService']=_0x4764b2;}async['getBaseStatistic'](){const _0xc35de4=_0x7daab9,_0x2f874e=await this[_0xc35de4(0xc3)](),_0x3bc8b8=await this[_0xc35de4(0x9a)](),_0x163129=await this[_0xc35de4(0x89)](),_0x7f6792=await this[_0xc35de4(0xb2)](),_0x3d6e0c=await this['countDraws'](),_0x17fa91=await this['countNewDrawsToday'](),_0x15967b=await this[_0xc35de4(0x84)](),_0x218d82=await this['countNewOrdersToday']();return{'userCount':_0x2f874e,'newUserCount':_0x3bc8b8,'chatCount':_0x163129,'newChatCount':_0x7f6792,'drawCount':_0x3d6e0c,'newDrawCount':_0x17fa91,'orderCount':_0x15967b,'newOrderCount':_0x218d82};}async['getChatStatistic']({days:days=0x7}){const _0x5e4332=_0x7daab9,_0x45a1e5=await this[_0x5e4332(0xae)](days),_0x980a00=await this[_0x5e4332(0xbb)](days);return{'date':_0x45a1e5['map'](_0x732774=>_0x732774['date']),'chat':_0x45a1e5[_0x5e4332(0xd3)](_0x47d57e=>_0x47d57e[_0x5e4332(0xe8)]),'draw':_0x980a00[_0x5e4332(0xd3)]((_0x1edd51,_0x4067b5)=>{return _0x1edd51['value'];})};}async[_0x7daab9(0xb8)]({days:days=0x7}){const _0x1d31ea=_0x7daab9,_0x7fb94b=await this[_0x1d31ea(0xb9)](days);return _0x7fb94b;}async['countUsers'](){const _0x34861b=_0x7daab9,_0x4bde74=await this[_0x34861b(0x8a)][_0x34861b(0xa2)]();return _0x4bde74;}async['countNewUsersToday'](){const _0x53d893=_0x7daab9,_0x376983=new Date();_0x376983[_0x53d893(0xe3)](0x0,0x0,0x0,0x0);const _0x3034d6=new Date(_0x376983[_0x53d893(0xea)]()+0x18*0x3c*0x3c*0x3e8),_0x5d6650=this[_0x53d893(0x8a)][_0x53d893(0x97)](_0x53d893(0x87)),_0x1ad897=await _0x5d6650[_0x53d893(0xa7)](_0x53d893(0xe6),{'today':_0x376983})[_0x53d893(0xb4)](_0x53d893(0xbf),{'tomorrow':_0x3034d6})[_0x53d893(0x9d)]();return _0x1ad897;}async[_0x7daab9(0x89)](){const _0x3ec429=_0x7daab9,_0x436308=await this[_0x3ec429(0xe0)][_0x3ec429(0xa2)]({'where':{'type':balance_constant_1[_0x3ec429(0x85)]['NORMAL_CHAT']}});return _0x436308;}async[_0x7daab9(0xb2)](){const _0x5f2d7f=_0x7daab9,_0x4b7b63=new Date();_0x4b7b63[_0x5f2d7f(0xe3)](0x0,0x0,0x0,0x0);const _0x354808=new Date(_0x4b7b63[_0x5f2d7f(0xea)]()+0x18*0x3c*0x3c*0x3e8),_0x338313=this[_0x5f2d7f(0xe0)][_0x5f2d7f(0x97)](_0x5f2d7f(0xa3)),_0x24e85d=await _0x338313[_0x5f2d7f(0xa7)](_0x5f2d7f(0xc0),{'type':balance_constant_1[_0x5f2d7f(0x85)][_0x5f2d7f(0xc8)]})[_0x5f2d7f(0xb4)]('chatLog.createdAt\x20>=\x20:today',{'today':_0x4b7b63})[_0x5f2d7f(0xb4)]('chatLog.createdAt\x20<\x20:tomorrow',{'tomorrow':_0x354808})['getCount']();return _0x24e85d;}async[_0x7daab9(0xec)](){const _0x3d42cb=_0x7daab9,_0x49112c=await this[_0x3d42cb(0xe0)][_0x3d42cb(0xa2)]({'where':{'type':balance_constant_1[_0x3d42cb(0x85)][_0x3d42cb(0xe5)]}});return _0x49112c;}async[_0x7daab9(0xee)](){const _0x17cc3f=_0x7daab9,_0x147bef=new Date();_0x147bef[_0x17cc3f(0xe3)](0x0,0x0,0x0,0x0);const _0x44e4b9=new Date(_0x147bef[_0x17cc3f(0xea)]()+0x18*0x3c*0x3c*0x3e8),_0x25e42b=this['chatLogEntity'][_0x17cc3f(0x97)](_0x17cc3f(0xa3)),_0x448925=await _0x25e42b['where']('chatLog.type\x20=\x20:type',{'type':balance_constant_1[_0x17cc3f(0x85)]['PAINT']})['andWhere'](_0x17cc3f(0xc9),{'today':_0x147bef})[_0x17cc3f(0xb4)]('chatLog.createdAt\x20<\x20:tomorrow',{'tomorrow':_0x44e4b9})[_0x17cc3f(0x9d)]();return _0x448925;}async[_0x7daab9(0xae)](_0x137bcc){const _0x2b86f2=_0x7daab9;var _0x560b4a,_0x4865aa;const _0x178004=new Date();_0x178004[_0x2b86f2(0xe3)](0x0,0x0,0x0,0x0);const _0x9a2d5a=new Date(_0x178004[_0x2b86f2(0xea)]()-(_0x137bcc-0x1)*0x18*0x3c*0x3c*0x3e8),_0x537efc=this[_0x2b86f2(0xe0)][_0x2b86f2(0x97)](_0x2b86f2(0xb0)),_0x353f0b=await _0x537efc[_0x2b86f2(0x80)](_0x2b86f2(0xab))[_0x2b86f2(0xa7)](_0x2b86f2(0x77),{'type':balance_constant_1['ChatType'][_0x2b86f2(0xc8)]})[_0x2b86f2(0xb4)]('chatlog.createdAt\x20>=\x20:startDate',{'startDate':_0x9a2d5a})[_0x2b86f2(0xe9)](_0x2b86f2(0xaf))['orderBy'](_0x2b86f2(0xaf))[_0x2b86f2(0xbe)](),_0x409d92=[],_0xd23802=_0x9a2d5a;for(let _0x5aa58c=0x0;_0x5aa58c<_0x137bcc;_0x5aa58c++){const _0x3bb208=(0x0,date_1[_0x2b86f2(0x94)])(new Date(_0xd23802),_0x2b86f2(0xd2)),_0x535d6f=(_0x4865aa=(_0x560b4a=_0x353f0b['find'](_0x19ba94=>(0x0,date_1[_0x2b86f2(0x94)])(new Date(_0x19ba94[_0x2b86f2(0xaf)]),_0x2b86f2(0xd2))===_0x3bb208))===null||_0x560b4a===void 0x0?void 0x0:_0x560b4a[_0x2b86f2(0xa2)])!==null&&_0x4865aa!==void 0x0?_0x4865aa:0x0;_0x535d6f>0x0?_0x409d92['push']({'date':_0x3bb208,'value':Number(_0x535d6f)}):_0x409d92[_0x2b86f2(0x79)]({'date':_0x3bb208,'value':0x0}),_0xd23802[_0x2b86f2(0x8c)](_0xd23802[_0x2b86f2(0xdb)]()+0x1);}return _0x409d92;}async[_0x7daab9(0xbb)](_0x52c181){const _0x62bfff=_0x7daab9;var _0xd5c26,_0x537293;const _0x2959c7=new Date();_0x2959c7[_0x62bfff(0xe3)](0x0,0x0,0x0,0x0);const _0x267cab=new Date(_0x2959c7[_0x62bfff(0xea)]()-(_0x52c181-0x1)*0x18*0x3c*0x3c*0x3e8),_0x4fbec9=this[_0x62bfff(0xe0)]['createQueryBuilder']('chatlog'),_0x4c5d36=await _0x4fbec9[_0x62bfff(0x80)](_0x62bfff(0xab))[_0x62bfff(0xa7)]('chatlog.type\x20=\x20:type',{'type':balance_constant_1['ChatType']['PAINT']})[_0x62bfff(0xb4)]('chatlog.createdAt\x20>=\x20:startDate',{'startDate':_0x267cab})[_0x62bfff(0xe9)](_0x62bfff(0xaf))['orderBy'](_0x62bfff(0xaf))[_0x62bfff(0xbe)](),_0x344ad0=[],_0x46d51b=_0x267cab;for(let _0x2bd663=0x0;_0x2bd663<_0x52c181;_0x2bd663++){const _0x1acc57=(0x0,date_1[_0x62bfff(0x94)])(new Date(_0x46d51b),_0x62bfff(0xd2)),_0x450c23=(_0x537293=(_0xd5c26=_0x4c5d36[_0x62bfff(0x8d)](_0x29b09c=>(0x0,date_1[_0x62bfff(0x94)])(new Date(_0x29b09c['date']),_0x62bfff(0xd2))===_0x1acc57))===null||_0xd5c26===void 0x0?void 0x0:_0xd5c26[_0x62bfff(0xa2)])!==null&&_0x537293!==void 0x0?_0x537293:0x0;_0x450c23>0x0?_0x344ad0['push']({'date':_0x1acc57,'value':Number(_0x450c23)}):_0x344ad0['push']({'date':_0x1acc57,'value':0x0}),_0x46d51b[_0x62bfff(0x8c)](_0x46d51b[_0x62bfff(0xdb)]()+0x1);}return _0x344ad0;}async[_0x7daab9(0xc2)](_0x5d48b1,_0x3f7ace,_0x597366){const _0x2f7543=_0x7daab9,_0x219f99=_0x2f7543(0x7a)+_0x597366+_0x2f7543(0xd4)+_0x5d48b1+_0x2f7543(0xce)+_0x3f7ace;common_1['Logger'][_0x2f7543(0x78)](_0x2f7543(0xac),_0x219f99);try{const _0x49b856=await axios_1[_0x2f7543(0x7b)][_0x2f7543(0x8f)](_0x219f99);if(_0x49b856[_0x2f7543(0x96)]===0xc8&&_0x49b856[_0x2f7543(0xdd)][_0x2f7543(0xd1)])return{'accessToken':_0x49b856[_0x2f7543(0xdd)][_0x2f7543(0xd1)],'refreshToken':_0x49b856[_0x2f7543(0xdd)][_0x2f7543(0xaa)]};else throw new Error(_0x2f7543(0x8b));}catch(_0x843113){common_1[_0x2f7543(0xb6)][_0x2f7543(0x7f)](_0x2f7543(0x7c),{'message':_0x843113['message'],'stack':_0x843113[_0x2f7543(0xc5)],'response':_0x843113['response']?_0x843113['response'][_0x2f7543(0xdd)]:_0x2f7543(0xa0)});throw new common_1[(_0x2f7543(0x8e))](_0x2f7543(0x7c),common_1[_0x2f7543(0xd8)][_0x2f7543(0xef)]);}}async['updateAccessTokenInDatabase'](_0x3c3736,_0x39853d,_0x301a27){const _0x1b7b14=_0x7daab9;await _0x301a27['update']({'configKey':_0x1b7b14(0xda)},{'configVal':_0x3c3736}),await _0x301a27[_0x1b7b14(0xa9)]({'configKey':_0x1b7b14(0x81)},{'configVal':_0x39853d});}async[_0x7daab9(0xb9)](_0x5d05a2){const _0x27d2eb=_0x7daab9,_0x101365=(0x0,date_1[_0x27d2eb(0x94)])(new Date(),_0x27d2eb(0x98)),_0xdaeec7=(0x0,date_1['formatDate'])(new Date(Date['now']()-Number(_0x5d05a2-0x1)*0x18*0x3c*0x3c*0x3e8),_0x27d2eb(0x98)),_0x539194='pv_count,visitor_count,ip_count,bounce_ratio,avg_visit_time',_0x12455b=_0x27d2eb(0xcc),{baiduToken:_0x559ad6,baiduSiteId:_0x4e10d2,baiduApiKey:_0x5a67f6,baiduSecretKey:_0x23bdc9,baiduRefreshToken:_0x3078b6}=await this[_0x27d2eb(0xb7)][_0x27d2eb(0x83)]([_0x27d2eb(0xda),_0x27d2eb(0x7e),_0x27d2eb(0x99),_0x27d2eb(0xbc),_0x27d2eb(0x81)]);if(!_0x5a67f6||!_0x4e10d2||!_0x3078b6||!_0x23bdc9)return[];let _0x1a0a1f=_0x559ad6,_0x1d1522,_0x5c401e;const _0x46148e=async _0x151aa1=>{const _0x314d73=_0x27d2eb;_0x5c401e=_0x314d73(0xbd)+_0x151aa1+_0x314d73(0x92)+_0x4e10d2+_0x314d73(0xd0)+_0x12455b+'&start_date='+_0xdaeec7+_0x314d73(0x9c)+_0x101365+'&metrics='+_0x539194;try{return await axios_1['default'][_0x314d73(0x8f)](_0x5c401e);}catch(_0x5e69e8){return{'data':{'error_code':0x6f,'message':_0x314d73(0xa6)}};}};_0x1d1522=await _0x46148e(_0x1a0a1f);if(_0x1d1522['data']['error_code']===0x6f||!_0x559ad6){const {accessToken:_0x4f7489,refreshToken:_0x2333bd}=await this[_0x27d2eb(0xc2)](_0x5a67f6,_0x23bdc9,_0x3078b6);_0x1a0a1f=_0x4f7489,await this['updateAccessTokenInDatabase'](_0x1a0a1f,_0x2333bd,this[_0x27d2eb(0xb1)]),_0x1d1522=await _0x46148e(_0x1a0a1f);}const {error_code:_0x2828b1,message:_0x59c62d}=_0x1d1522['data'];if(_0x2828b1&&_0x2828b1!==0xc8)throw new common_1[(_0x27d2eb(0x8e))](_0x59c62d||_0x27d2eb(0xc7),common_1[_0x27d2eb(0xd8)][_0x27d2eb(0xef)]);return _0x1d1522[_0x27d2eb(0xdd)][_0x27d2eb(0xc6)];}async[_0x7daab9(0x84)](){const _0xa7e5e=_0x7daab9,_0xa5767f=await this[_0xa7e5e(0xf0)][_0xa7e5e(0xa2)]();return _0xa5767f;}async[_0x7daab9(0xa1)](){const _0x5050aa=_0x7daab9,_0x5a4cc2=new Date();_0x5a4cc2[_0x5050aa(0xe3)](0x0,0x0,0x0,0x0);const _0x2f0aaf=new Date(_0x5a4cc2[_0x5050aa(0xea)]()+0x18*0x3c*0x3c*0x3e8),_0x44ab62=this['orderEntity'][_0x5050aa(0x97)](_0x5050aa(0x90)),_0x2a75f3=await _0x44ab62['where'](_0x5050aa(0xeb),{'today':_0x5a4cc2})['andWhere'](_0x5050aa(0xd7),{'tomorrow':_0x2f0aaf})['getCount']();return _0x2a75f3;}};StatisticService=__decorate([(0x0,common_1[_0x7daab9(0xa8)])(),__param(0x0,(0x0,typeorm_1[_0x7daab9(0xd9)])(user_entity_1[_0x7daab9(0xe2)])),__param(0x1,(0x0,typeorm_1[_0x7daab9(0xd9)])(chatLog_entity_1[_0x7daab9(0x82)])),__param(0x2,(0x0,typeorm_1[_0x7daab9(0xd9)])(config_entity_1[_0x7daab9(0x88)])),__param(0x3,(0x0,typeorm_1[_0x7daab9(0xd9)])(order_entity_1[_0x7daab9(0xd5)])),__metadata(_0x7daab9(0xa5),[typeorm_2['Repository'],typeorm_2[_0x7daab9(0xad)],typeorm_2['Repository'],typeorm_2['Repository'],globalConfig_service_1['GlobalConfigService']])],StatisticService),exports['StatisticService']=StatisticService;function _0x5622(_0x66f38,_0x22c849){const _0x4946cb=_0x4946();return _0x5622=function(_0x56224b,_0x3cd271){_0x56224b=_0x56224b-0x76;let _0x369d22=_0x4946cb[_0x56224b];return _0x369d22;},_0x5622(_0x66f38,_0x22c849);}function _0x4946(){const _0x31c12b=['find','HttpException','get','order','../../common/constants/balance.constant','&site_id=','defineProperty','formatDate','1816710JfMtME','status','createQueryBuilder','YYYYMMDD','baiduApiKey','countNewUsersToday','3IsGAHF','&end_date=','getCount','70388hbvjeW','169929RfDDeq','No\x20response\x20data','countNewOrdersToday','count','chatLog','StatisticService','design:paramtypes','Access\x20token\x20invalid\x20or\x20no\x20longer\x20valid','where','Injectable','update','refresh_token','DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','获取新\x20accessToken','Repository','countChatsByTimeRange','date','chatlog','configEntity','countNewChatsToday','metadata','andWhere','../globalConfig/config.entity','Logger','globalConfigService','getBaiduVisit','getBaiduStatistics','decorate','countDrawsByTimeRange','baiduSecretKey','https://openapi.baidu.com/rest/2.0/tongji/report/getData?access_token=','getRawMany','user.createdAt\x20<\x20:tomorrow','chatLog.type\x20=\x20:type','length','getNewAccessToken','countUsers','@nestjs/common','stack','result','获取百度统计数据失败','NORMAL_CHAT','chatLog.createdAt\x20>=\x20:today','442700yblkkb','1993928ngFKrs','overview/getTimeTrendRpt','axios','&client_secret=','783342AueLgD','&method=','access_token','M.DD','map','&client_id=','OrderEntity','typeorm','order.createdAt\x20<\x20:tomorrow','HttpStatus','InjectRepository','baiduToken','getDate','__metadata','data','function','__param','chatLogEntity','../../common/utils/date','UserEntity','setHours','../globalConfig/globalConfig.service','PAINT','user.createdAt\x20>=\x20:today','object','value','groupBy','getTime','order.createdAt\x20>=\x20:today','countDraws','3eYDbzJ','countNewDrawsToday','BAD_REQUEST','orderEntity','getOwnPropertyDescriptor','chatlog.type\x20=\x20:type','log','push','http://openapi.baidu.com/oauth/2.0/token?grant_type=refresh_token&refresh_token=','default','获取新\x20accessToken\x20失败','../user/user.entity','baiduSiteId','error','select','baiduRefreshToken','ChatLogEntity','getConfigs','countOrders','ChatType','732975NyyyPt','user','ConfigEntity','countChats','userEntity','Failed\x20to\x20get\x20new\x20access\x20token','setDate'];_0x4946=function(){return _0x31c12b;};return _0x4946();}