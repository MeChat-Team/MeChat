'use strict';const _0x138c57=_0x5056;(function(_0x394e02,_0x50a3f6){const _0x1eca24=_0x5056,_0x3b6704=_0x394e02();while(!![]){try{const _0x3f8583=parseInt(_0x1eca24(0xee))/0x1+-parseInt(_0x1eca24(0x110))/0x2+parseInt(_0x1eca24(0xef))/0x3+parseInt(_0x1eca24(0x10b))/0x4*(parseInt(_0x1eca24(0x12f))/0x5)+parseInt(_0x1eca24(0xfd))/0x6*(parseInt(_0x1eca24(0xeb))/0x7)+parseInt(_0x1eca24(0x11e))/0x8*(-parseInt(_0x1eca24(0x117))/0x9)+-parseInt(_0x1eca24(0xf3))/0xa;if(_0x3f8583===_0x50a3f6)break;else _0x3b6704['push'](_0x3b6704['shift']());}catch(_0x296abd){_0x3b6704['push'](_0x3b6704['shift']());}}}(_0x3d80,0x26b84));var __decorate=this&&this[_0x138c57(0x126)]||function(_0x143444,_0x226c0c,_0xc58634,_0x44dc21){const _0x40f2a8=_0x138c57;var _0x246541=arguments['length'],_0x449d8c=_0x246541<0x3?_0x226c0c:_0x44dc21===null?_0x44dc21=Object[_0x40f2a8(0xe3)](_0x226c0c,_0xc58634):_0x44dc21,_0x2a2153;if(typeof Reflect==='object'&&typeof Reflect[_0x40f2a8(0x118)]===_0x40f2a8(0x10f))_0x449d8c=Reflect[_0x40f2a8(0x118)](_0x143444,_0x226c0c,_0xc58634,_0x44dc21);else{for(var _0x53d6e9=_0x143444[_0x40f2a8(0xf7)]-0x1;_0x53d6e9>=0x0;_0x53d6e9--)if(_0x2a2153=_0x143444[_0x53d6e9])_0x449d8c=(_0x246541<0x3?_0x2a2153(_0x449d8c):_0x246541>0x3?_0x2a2153(_0x226c0c,_0xc58634,_0x449d8c):_0x2a2153(_0x226c0c,_0xc58634))||_0x449d8c;}return _0x246541>0x3&&_0x449d8c&&Object['defineProperty'](_0x226c0c,_0xc58634,_0x449d8c),_0x449d8c;},__metadata=this&&this['__metadata']||function(_0x45a76a,_0x143b62){const _0x4df898=_0x138c57;if(typeof Reflect===_0x4df898(0x124)&&typeof Reflect[_0x4df898(0x128)]===_0x4df898(0x10f))return Reflect[_0x4df898(0x128)](_0x45a76a,_0x143b62);},__param=this&&this[_0x138c57(0xff)]||function(_0x40888c,_0x4a5c54){return function(_0x14efe6,_0xd7a372){_0x4a5c54(_0x14efe6,_0xd7a372,_0x40888c);};};Object['defineProperty'](exports,_0x138c57(0xe8),{'value':!![]}),exports[_0x138c57(0x11f)]=void 0x0;function _0x5056(_0x4e3f61,_0x270662){const _0x3d80cb=_0x3d80();return _0x5056=function(_0x50561c,_0x208460){_0x50561c=_0x50561c-0xe1;let _0xf5e04e=_0x3d80cb[_0x50561c];return _0xf5e04e;},_0x5056(_0x4e3f61,_0x270662);}const user_entity_1=require(_0x138c57(0x11a)),typeorm_1=require(_0x138c57(0x107)),common_1=require('@nestjs/common'),typeorm_2=require('typeorm'),order_entity_1=require(_0x138c57(0xe7)),cramiPackage_entity_1=require(_0x138c57(0x11b)),utils_1=require(_0x138c57(0xea)),pay_service_1=require('../pay/pay.service'),globalConfig_service_1=require(_0x138c57(0x10e));let OrderService=class OrderService{constructor(_0x18b631,_0x37153b,_0x5d435e,_0x314e87,_0x44fb5e){const _0x225771=_0x138c57;this['orderEntity']=_0x18b631,this[_0x225771(0x119)]=_0x37153b,this[_0x225771(0x129)]=_0x5d435e,this[_0x225771(0xe1)]=_0x314e87,this['globalConfigService']=_0x44fb5e;}async[_0x138c57(0x115)](_0x4953d3,_0x3bb70b){const _0x43a9a9=_0x138c57;try{const {goodsId:_0x1dd3bb,count:count=0x1,payType:_0x15d648}=_0x4953d3,{id:_0x43fa66}=_0x3bb70b[_0x43a9a9(0x130)];if(_0x43fa66>0xf4240)throw new common_1[(_0x43a9a9(0xf9))]('请先注册账号后购买商品！',common_1[_0x43a9a9(0x123)][_0x43a9a9(0xe9)]);const _0x26d54c=await this[_0x43a9a9(0x12c)](_0x43fa66,_0x1dd3bb,count,_0x15d648),_0x55a367=await this[_0x43a9a9(0xe1)]['pay'](_0x43fa66,_0x26d54c[_0x43a9a9(0x104)],_0x15d648);return Object[_0x43a9a9(0x120)](Object[_0x43a9a9(0x120)]({},_0x55a367),{'orderId':_0x26d54c[_0x43a9a9(0x104)],'platform':_0x26d54c['payPlatform'],'total':_0x26d54c[_0x43a9a9(0x127)]});}catch(_0x4a479a){if(_0x4a479a[_0x43a9a9(0x12b)]===0x191)throw new common_1[(_0x43a9a9(0xf9))](_0x4a479a[_0x43a9a9(0x103)],common_1[_0x43a9a9(0x123)][_0x43a9a9(0xe9)]);throw new common_1[(_0x43a9a9(0xf9))](_0x4a479a[_0x43a9a9(0x103)]||'购买失败!',common_1['HttpStatus'][_0x43a9a9(0x122)]);}}async['queryByOrderId'](_0x3fdae6,_0x418e66){const _0x3f945b=_0x138c57,{id:_0x1d71e7}=_0x3fdae6[_0x3f945b(0x130)],{orderId:_0x4d83d2}=_0x418e66,_0x76f20d=await this[_0x3f945b(0x105)][_0x3f945b(0x102)]({'where':{'userId':_0x1d71e7,'orderId':_0x4d83d2}});if(!_0x76f20d)throw new common_1[(_0x3f945b(0xf9))](_0x3f945b(0x12a),common_1['HttpStatus'][_0x3f945b(0x122)]);return _0x76f20d;}async[_0x138c57(0x12c)](_0x1977c5,_0xcd4c0d,_0x4d1212,_0x525fea){const _0x1dbb28=_0x138c57,_0xf74ccd=await this[_0x1dbb28(0x10a)][_0x1dbb28(0xfe)](),_0x324150=await this['cramiPackageEntity'][_0x1dbb28(0x102)]({'where':{'id':_0xcd4c0d}});if(!_0x324150)throw new common_1[(_0x1dbb28(0xf9))](_0x1dbb28(0x12e),common_1['HttpStatus'][_0x1dbb28(0x122)]);const _0x46ea72={};_0x46ea72[_0x1dbb28(0x104)]=(0x0,utils_1[_0x1dbb28(0xf0)])(),_0x46ea72[_0x1dbb28(0x11d)]=_0x1977c5,_0x46ea72[_0x1dbb28(0xf4)]=_0xcd4c0d,_0x46ea72[_0x1dbb28(0x106)]=Number(_0x324150[_0x1dbb28(0x106)]),_0x46ea72['count']=_0x4d1212,_0x46ea72[_0x1dbb28(0x127)]=Number(_0x324150[_0x1dbb28(0x106)])*_0x4d1212,_0x46ea72[_0x1dbb28(0xf5)]=_0xf74ccd,_0x46ea72[_0x1dbb28(0xfa)]=_0x525fea;const _0x1ecac8=await this['orderEntity']['save'](_0x46ea72);return console[_0x1dbb28(0xf2)]('order:\x20',_0x1ecac8),_0x1ecac8;}async[_0x138c57(0x111)](_0x13ecf1,_0x3b6d0b,_0x55235f){const _0x1537b5=_0x138c57;return await this[_0x1537b5(0x105)][_0x1537b5(0x10d)]({'where':{'userId':_0x13ecf1},'order':{'id':_0x1537b5(0x116)},'skip':(_0x3b6d0b-0x1)*_0x55235f,'take':_0x55235f});}async[_0x138c57(0x114)](_0x40692f){const _0x523e0a=_0x138c57,{page:_0xc5d9f5,size:_0x1ea4dc,userId:_0xe3650b,platform:_0x1c59e6,status:_0x2147a6}=_0x40692f,_0x33cf29={};if(_0xe3650b)_0x33cf29['userId']=_0xe3650b;if(_0x1c59e6)_0x33cf29[_0x523e0a(0xf5)]=_0x1c59e6;if(_0x2147a6)_0x33cf29[_0x523e0a(0x12b)]=_0x2147a6;const [_0x5d1da3,_0x5d3e49]=await this[_0x523e0a(0x105)][_0x523e0a(0x10d)]({'order':{'id':_0x523e0a(0x116)},'where':_0x33cf29,'skip':(_0xc5d9f5-0x1)*_0x1ea4dc,'take':_0x1ea4dc}),_0x10046a=_0x5d1da3[_0x523e0a(0xe4)](_0x1f8035=>_0x1f8035[_0x523e0a(0x11d)]),_0x2736e1=_0x5d1da3[_0x523e0a(0xe4)](_0x5652b4=>_0x5652b4['goodsId']),_0xd986af=await this[_0x523e0a(0x129)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x10046a)},'select':['id','username','email']}),_0x2200e9=await this['cramiPackageEntity'][_0x523e0a(0x11c)]({'where':{'id':(0x0,typeorm_2['In'])(_0x2736e1)},'select':['id',_0x523e0a(0x108),'coverImg',_0x523e0a(0x10c)]});_0x5d1da3[_0x523e0a(0xed)](_0x577fac=>{const _0x4bc527=_0x523e0a;_0x577fac[_0x4bc527(0x100)]=_0xd986af[_0x4bc527(0x11c)](_0x22b749=>_0x22b749['id']===_0x577fac[_0x4bc527(0x11d)]),_0x577fac[_0x4bc527(0xf6)]=_0x2200e9[_0x4bc527(0x11c)](_0x2b181e=>_0x2b181e['id']===_0x577fac['goodsId']);});const _0x45a897=await this['orderEntity'][_0x523e0a(0x125)](_0x523e0a(0xe6))['where'](_0x523e0a(0x12d),{'status':0x1})[_0x523e0a(0xfb)]('SUM(order.price)',_0x523e0a(0x109))[_0x523e0a(0xec)]();return Object['assign']({'rows':_0x5d1da3,'count':_0x5d3e49},_0x45a897);}async[_0x138c57(0xf8)](_0x29e510){const _0x59c0c1=_0x138c57,{orderId:_0x18ff44}=_0x29e510,_0x5766e8=await this[_0x59c0c1(0x105)][_0x59c0c1(0x102)]({'where':{'orderId':_0x18ff44}});if(!_0x5766e8)throw new common_1[(_0x59c0c1(0xf9))](_0x59c0c1(0x12a),common_1['HttpStatus'][_0x59c0c1(0x122)]);return await this[_0x59c0c1(0x105)]['delete']({'orderId':_0x18ff44});}async[_0x138c57(0x101)](){const _0x3832d4=_0x138c57;return await this['orderEntity'][_0x3832d4(0x113)]({'status':0x0});}};function _0x3d80(){const _0x5ee223=['../../common/utils','49ktEeyS','getRawOne','forEach','295539zsgRrX','561438ZLxWox','createOrderId','design:paramtypes','log','5156590jZROdW','goodsId','payPlatform','goodsInfo','length','deleteOrder','HttpException','channel','select','InjectRepository','100458sBGKII','queryPayType','__param','userInfo','deleteNotPay','findOne','message','orderId','orderEntity','price','@nestjs/typeorm','name','total_price','globalConfigService','859824wnVXWj','des','findAndCount','../globalConfig/globalConfig.service','function','22700exgAco','query','Injectable','delete','queryAllOrder','buy','DESC','621OtsrSK','decorate','cramiPackageEntity','./../user/user.entity','../crami/cramiPackage.entity','find','userId','14984ISNkXS','OrderService','assign','GlobalConfigService','BAD_REQUEST','HttpStatus','object','createQueryBuilder','__decorate','total','metadata','userEntity','订单不存在!','status','create','order.status\x20=\x20:status','套餐不存在!','5uWcUAI','user','payService','Repository','getOwnPropertyDescriptor','map','OrderEntity','order','./order.entity','__esModule','UNAUTHORIZED'];_0x3d80=function(){return _0x5ee223;};return _0x3d80();}OrderService=__decorate([(0x0,common_1[_0x138c57(0x112)])(),__param(0x0,(0x0,typeorm_1[_0x138c57(0xfc)])(order_entity_1[_0x138c57(0xe5)])),__param(0x1,(0x0,typeorm_1[_0x138c57(0xfc)])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x2,(0x0,typeorm_1[_0x138c57(0xfc)])(user_entity_1['UserEntity'])),__metadata(_0x138c57(0xf1),[typeorm_2[_0x138c57(0xe2)],typeorm_2[_0x138c57(0xe2)],typeorm_2[_0x138c57(0xe2)],pay_service_1['PayService'],globalConfig_service_1[_0x138c57(0x121)]])],OrderService),exports[_0x138c57(0x11f)]=OrderService;