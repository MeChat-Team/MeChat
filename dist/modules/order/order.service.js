'use strict';function _0x2a1c(_0x2ddd07,_0x151176){const _0xa869de=_0xa869();return _0x2a1c=function(_0x2a1cb2,_0xa7f7bc){_0x2a1cb2=_0x2a1cb2-0x125;let _0x67304e=_0xa869de[_0x2a1cb2];return _0x67304e;},_0x2a1c(_0x2ddd07,_0x151176);}const _0x239e20=_0x2a1c;(function(_0x231334,_0x18b401){const _0x7937ac=_0x2a1c,_0x400d2b=_0x231334();while(!![]){try{const _0x3b1223=-parseInt(_0x7937ac(0x15d))/0x1*(parseInt(_0x7937ac(0x177))/0x2)+-parseInt(_0x7937ac(0x12a))/0x3*(-parseInt(_0x7937ac(0x174))/0x4)+parseInt(_0x7937ac(0x134))/0x5+parseInt(_0x7937ac(0x136))/0x6*(-parseInt(_0x7937ac(0x172))/0x7)+-parseInt(_0x7937ac(0x144))/0x8+parseInt(_0x7937ac(0x16a))/0x9+parseInt(_0x7937ac(0x135))/0xa;if(_0x3b1223===_0x18b401)break;else _0x400d2b['push'](_0x400d2b['shift']());}catch(_0x114a31){_0x400d2b['push'](_0x400d2b['shift']());}}}(_0xa869,0x305e9));function _0xa869(){const _0x480299=['function','typeorm','@nestjs/common','UNAUTHORIZED','count','buy','@nestjs/typeorm','getRawOne','message','assign','order:\x20','defineProperty','save','user','length','43jynbeE','HttpStatus','HttpException','username','../../common/utils','DESC','__esModule','goodsInfo','goodsId','total','pay','__metadata','createQueryBuilder','3272922fwnsws','InjectRepository','./order.entity','请先注册账号后购买商品！','orderEntity','price','../crami/cramiPackage.entity','create','28jJIiBP','queryAllOrder','12FkxgYx','delete','des','9788Ukmcnm','name','deleteNotPay','status','forEach','购买失败!','deleteOrder','OrderService','319362quZLhZ','find','findAndCount','log','select','queryPayType','userInfo','orderId','BAD_REQUEST','PayService','714650pBpFJl','421730JoJUlU','261852OyoFOl','Repository','Injectable','globalConfigService','userId','getOwnPropertyDescriptor','decorate','__param','metadata','userEntity','./../user/user.entity','payService','order.status\x20=\x20:status','map','2279936uVIRCQ','design:paramtypes','UserEntity','email','findOne','../globalConfig/globalConfig.service','订单不存在!','payPlatform','where','object'];_0xa869=function(){return _0x480299;};return _0xa869();}var __decorate=this&&this['__decorate']||function(_0x5e0d94,_0x5ed2b6,_0x301024,_0x755c43){const _0xabe97c=_0x2a1c;var _0x17826f=arguments[_0xabe97c(0x15c)],_0x1d5313=_0x17826f<0x3?_0x5ed2b6:_0x755c43===null?_0x755c43=Object[_0xabe97c(0x13b)](_0x5ed2b6,_0x301024):_0x755c43,_0x2e98d1;if(typeof Reflect===_0xabe97c(0x14d)&&typeof Reflect[_0xabe97c(0x13c)]===_0xabe97c(0x14e))_0x1d5313=Reflect['decorate'](_0x5e0d94,_0x5ed2b6,_0x301024,_0x755c43);else{for(var _0xd90233=_0x5e0d94['length']-0x1;_0xd90233>=0x0;_0xd90233--)if(_0x2e98d1=_0x5e0d94[_0xd90233])_0x1d5313=(_0x17826f<0x3?_0x2e98d1(_0x1d5313):_0x17826f>0x3?_0x2e98d1(_0x5ed2b6,_0x301024,_0x1d5313):_0x2e98d1(_0x5ed2b6,_0x301024))||_0x1d5313;}return _0x17826f>0x3&&_0x1d5313&&Object[_0xabe97c(0x159)](_0x5ed2b6,_0x301024,_0x1d5313),_0x1d5313;},__metadata=this&&this[_0x239e20(0x168)]||function(_0x1fea6b,_0x28feed){const _0x4b3fbf=_0x239e20;if(typeof Reflect==='object'&&typeof Reflect[_0x4b3fbf(0x13e)]===_0x4b3fbf(0x14e))return Reflect['metadata'](_0x1fea6b,_0x28feed);},__param=this&&this[_0x239e20(0x13d)]||function(_0x51f183,_0x32f42e){return function(_0x493036,_0x59147c){_0x32f42e(_0x493036,_0x59147c,_0x51f183);};};Object['defineProperty'](exports,_0x239e20(0x163),{'value':!![]}),exports['OrderService']=void 0x0;const user_entity_1=require(_0x239e20(0x140)),typeorm_1=require(_0x239e20(0x154)),common_1=require(_0x239e20(0x150)),typeorm_2=require(_0x239e20(0x14f)),order_entity_1=require(_0x239e20(0x16c)),cramiPackage_entity_1=require(_0x239e20(0x170)),utils_1=require(_0x239e20(0x161)),pay_service_1=require('../pay/pay.service'),globalConfig_service_1=require(_0x239e20(0x149));let OrderService=class OrderService{constructor(_0x8d5f02,_0x16ae82,_0x36c0e5,_0x217b55,_0x4a5bc6){const _0x37fdbf=_0x239e20;this[_0x37fdbf(0x16e)]=_0x8d5f02,this['cramiPackageEntity']=_0x16ae82,this[_0x37fdbf(0x13f)]=_0x36c0e5,this[_0x37fdbf(0x141)]=_0x217b55,this[_0x37fdbf(0x139)]=_0x4a5bc6;}async[_0x239e20(0x153)](_0x8b565e,_0x55e587){const _0x21cd9f=_0x239e20;try{const {goodsId:_0x59c528,count:count=0x1,payType:_0x20bb9d}=_0x8b565e,{id:_0x2fa3aa}=_0x55e587['user'];if(_0x2fa3aa>0xf4240)throw new common_1[(_0x21cd9f(0x15f))](_0x21cd9f(0x16d),common_1['HttpStatus']['UNAUTHORIZED']);const _0x9af2ac=await this[_0x21cd9f(0x171)](_0x2fa3aa,_0x59c528,count,_0x20bb9d),_0x7e46a4=await this['payService'][_0x21cd9f(0x167)](_0x2fa3aa,_0x9af2ac['orderId'],_0x20bb9d);return Object[_0x21cd9f(0x157)](Object['assign']({},_0x7e46a4),{'orderId':_0x9af2ac[_0x21cd9f(0x131)],'platform':_0x9af2ac[_0x21cd9f(0x14b)],'total':_0x9af2ac['total']});}catch(_0xe2fe3c){if(_0xe2fe3c[_0x21cd9f(0x125)]===0x191)throw new common_1[(_0x21cd9f(0x15f))](_0xe2fe3c[_0x21cd9f(0x156)],common_1[_0x21cd9f(0x15e)][_0x21cd9f(0x151)]);throw new common_1['HttpException'](_0xe2fe3c[_0x21cd9f(0x156)]||_0x21cd9f(0x127),common_1['HttpStatus']['BAD_REQUEST']);}}async['queryByOrderId'](_0x13c973,_0x4c4e47){const _0x5a5c57=_0x239e20,{id:_0x890029}=_0x13c973[_0x5a5c57(0x15b)],{orderId:_0xe3d72b}=_0x4c4e47,_0x4f0192=await this['orderEntity']['findOne']({'where':{'userId':_0x890029,'orderId':_0xe3d72b}});if(!_0x4f0192)throw new common_1[(_0x5a5c57(0x15f))](_0x5a5c57(0x14a),common_1[_0x5a5c57(0x15e)][_0x5a5c57(0x132)]);return _0x4f0192;}async[_0x239e20(0x171)](_0x34af3e,_0x4f0d0b,_0x45ff8a,_0x2e56ef){const _0x5cc850=_0x239e20,_0x4c6721=await this[_0x5cc850(0x139)][_0x5cc850(0x12f)](),_0x4097e8=await this['cramiPackageEntity'][_0x5cc850(0x148)]({'where':{'id':_0x4f0d0b}});if(!_0x4097e8)throw new common_1[(_0x5cc850(0x15f))]('套餐不存在!',common_1[_0x5cc850(0x15e)][_0x5cc850(0x132)]);const _0x438b2f={};_0x438b2f['orderId']=(0x0,utils_1['createOrderId'])(),_0x438b2f[_0x5cc850(0x13a)]=_0x34af3e,_0x438b2f['goodsId']=_0x4f0d0b,_0x438b2f['price']=Number(_0x4097e8[_0x5cc850(0x16f)]),_0x438b2f[_0x5cc850(0x152)]=_0x45ff8a,_0x438b2f[_0x5cc850(0x166)]=Number(_0x4097e8['price'])*_0x45ff8a,_0x438b2f[_0x5cc850(0x14b)]=_0x4c6721,_0x438b2f['channel']=_0x2e56ef;const _0x22abd9=await this['orderEntity'][_0x5cc850(0x15a)](_0x438b2f);return console[_0x5cc850(0x12d)](_0x5cc850(0x158),_0x22abd9),_0x22abd9;}async['query'](_0x35965e,_0xd6e623,_0x5ac116){const _0x47af55=_0x239e20;return await this[_0x47af55(0x16e)][_0x47af55(0x12c)]({'where':{'userId':_0x35965e},'order':{'id':_0x47af55(0x162)},'skip':(_0xd6e623-0x1)*_0x5ac116,'take':_0x5ac116});}async[_0x239e20(0x173)](_0x3fceee){const _0x5f4245=_0x239e20,{page:_0x22cc06,size:_0x310e86,userId:_0x1e38b6,platform:_0x53986e,status:_0x4c0476}=_0x3fceee,_0x901323={};if(_0x1e38b6)_0x901323['userId']=_0x1e38b6;if(_0x53986e)_0x901323['payPlatform']=_0x53986e;if(_0x4c0476)_0x901323[_0x5f4245(0x125)]=_0x4c0476;const [_0x37d8d5,_0x178e7c]=await this[_0x5f4245(0x16e)][_0x5f4245(0x12c)]({'order':{'id':_0x5f4245(0x162)},'where':_0x901323,'skip':(_0x22cc06-0x1)*_0x310e86,'take':_0x310e86}),_0x4b98a4=_0x37d8d5[_0x5f4245(0x143)](_0x4bb67c=>_0x4bb67c['userId']),_0x401fed=_0x37d8d5['map'](_0x563cba=>_0x563cba[_0x5f4245(0x165)]),_0x21a060=await this[_0x5f4245(0x13f)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x4b98a4)},'select':['id',_0x5f4245(0x160),_0x5f4245(0x147)]}),_0x7d73a1=await this['cramiPackageEntity']['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x401fed)},'select':['id',_0x5f4245(0x178),'coverImg',_0x5f4245(0x176)]});_0x37d8d5[_0x5f4245(0x126)](_0x565c88=>{const _0x1af18a=_0x5f4245;_0x565c88[_0x1af18a(0x130)]=_0x21a060[_0x1af18a(0x12b)](_0x3a93ca=>_0x3a93ca['id']===_0x565c88[_0x1af18a(0x13a)]),_0x565c88[_0x1af18a(0x164)]=_0x7d73a1[_0x1af18a(0x12b)](_0x2eebf0=>_0x2eebf0['id']===_0x565c88[_0x1af18a(0x165)]);});const _0x266c12=await this[_0x5f4245(0x16e)][_0x5f4245(0x169)]('order')[_0x5f4245(0x14c)](_0x5f4245(0x142),{'status':0x1})[_0x5f4245(0x12e)]('SUM(order.price)','total_price')[_0x5f4245(0x155)]();return Object['assign']({'rows':_0x37d8d5,'count':_0x178e7c},_0x266c12);}async[_0x239e20(0x128)](_0x193580){const _0x5d3077=_0x239e20,{orderId:_0x2c6de5}=_0x193580,_0x8de5f1=await this['orderEntity']['findOne']({'where':{'orderId':_0x2c6de5}});if(!_0x8de5f1)throw new common_1['HttpException'](_0x5d3077(0x14a),common_1[_0x5d3077(0x15e)]['BAD_REQUEST']);return await this['orderEntity'][_0x5d3077(0x175)]({'orderId':_0x2c6de5});}async[_0x239e20(0x179)](){const _0xf9d0a6=_0x239e20;return await this[_0xf9d0a6(0x16e)]['delete']({'status':0x0});}};OrderService=__decorate([(0x0,common_1[_0x239e20(0x138)])(),__param(0x0,(0x0,typeorm_1[_0x239e20(0x16b)])(order_entity_1['OrderEntity'])),__param(0x1,(0x0,typeorm_1[_0x239e20(0x16b)])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x2,(0x0,typeorm_1[_0x239e20(0x16b)])(user_entity_1[_0x239e20(0x146)])),__metadata(_0x239e20(0x145),[typeorm_2[_0x239e20(0x137)],typeorm_2[_0x239e20(0x137)],typeorm_2[_0x239e20(0x137)],pay_service_1[_0x239e20(0x133)],globalConfig_service_1['GlobalConfigService']])],OrderService),exports[_0x239e20(0x129)]=OrderService;