'use strict';const _0x54e587=_0x5df9;(function(_0x65ce28,_0x636795){const _0x12d03a=_0x5df9,_0x142ddf=_0x65ce28();while(!![]){try{const _0x4071a6=-parseInt(_0x12d03a(0x184))/0x1*(parseInt(_0x12d03a(0x163))/0x2)+parseInt(_0x12d03a(0x181))/0x3*(parseInt(_0x12d03a(0x159))/0x4)+-parseInt(_0x12d03a(0x144))/0x5+-parseInt(_0x12d03a(0x149))/0x6*(parseInt(_0x12d03a(0x153))/0x7)+parseInt(_0x12d03a(0x15d))/0x8*(-parseInt(_0x12d03a(0x164))/0x9)+-parseInt(_0x12d03a(0x139))/0xa+parseInt(_0x12d03a(0x173))/0xb;if(_0x4071a6===_0x636795)break;else _0x142ddf['push'](_0x142ddf['shift']());}catch(_0x14efd4){_0x142ddf['push'](_0x142ddf['shift']());}}}(_0x541d,0x7b761));function _0x541d(){const _0x201ba1=['queryByOrderId','SUM(order.price)','deleteNotPay','total','order.status\x20=\x20:status','HttpStatus','PayService','assign','metadata','payPlatform','InjectRepository','OrderEntity','订单不存在!','287733vElUFW','delete','goodsInfo','112291lMZlBM','pay','./order.entity','email','orderEntity','__metadata','Repository','GlobalConfigService','status','10044500CPhjbL','OrderService','create','goodsId','log','order','findOne','userId','BAD_REQUEST','deleteOrder','order:\x20','2857435oUahOE','defineProperty','UserEntity','createOrderId','coverImg','4255332XsWyZt','payService','decorate','find','UNAUTHORIZED','function','username','total_price','user','map','7fqdiQI','HttpException','name','findAndCount','select','userEntity','20zTmslV','__decorate','message','buy','8CSQmmG','userInfo','length','price','channel','forEach','14LHDPev','5550957WKhAdt','queryAllOrder','../globalConfig/globalConfig.service','Injectable','cramiPackageEntity','DESC','query','globalConfigService','typeorm','createQueryBuilder','@nestjs/typeorm','../pay/pay.service','请先注册账号后购买商品！','object','orderId','40855221xsOSSw'];_0x541d=function(){return _0x201ba1;};return _0x541d();}function _0x5df9(_0x4e3b35,_0x256ef8){const _0x541dd0=_0x541d();return _0x5df9=function(_0x5df993,_0x4b8982){_0x5df993=_0x5df993-0x137;let _0x56d70b=_0x541dd0[_0x5df993];return _0x56d70b;},_0x5df9(_0x4e3b35,_0x256ef8);}var __decorate=this&&this[_0x54e587(0x15a)]||function(_0x10c4ee,_0x4434c8,_0x5419b4,_0x43ffc6){const _0x7f1b67=_0x54e587;var _0x17fa2f=arguments[_0x7f1b67(0x15f)],_0x439973=_0x17fa2f<0x3?_0x4434c8:_0x43ffc6===null?_0x43ffc6=Object['getOwnPropertyDescriptor'](_0x4434c8,_0x5419b4):_0x43ffc6,_0x4ba8fe;if(typeof Reflect==='object'&&typeof Reflect[_0x7f1b67(0x14b)]===_0x7f1b67(0x14e))_0x439973=Reflect[_0x7f1b67(0x14b)](_0x10c4ee,_0x4434c8,_0x5419b4,_0x43ffc6);else{for(var _0x4bed9d=_0x10c4ee['length']-0x1;_0x4bed9d>=0x0;_0x4bed9d--)if(_0x4ba8fe=_0x10c4ee[_0x4bed9d])_0x439973=(_0x17fa2f<0x3?_0x4ba8fe(_0x439973):_0x17fa2f>0x3?_0x4ba8fe(_0x4434c8,_0x5419b4,_0x439973):_0x4ba8fe(_0x4434c8,_0x5419b4))||_0x439973;}return _0x17fa2f>0x3&&_0x439973&&Object[_0x7f1b67(0x145)](_0x4434c8,_0x5419b4,_0x439973),_0x439973;},__metadata=this&&this[_0x54e587(0x189)]||function(_0x5bea70,_0x2df98c){const _0x2de0d4=_0x54e587;if(typeof Reflect===_0x2de0d4(0x171)&&typeof Reflect[_0x2de0d4(0x17c)]===_0x2de0d4(0x14e))return Reflect[_0x2de0d4(0x17c)](_0x5bea70,_0x2df98c);},__param=this&&this['__param']||function(_0x54d91f,_0x448acf){return function(_0x4cf4f0,_0x5d196e){_0x448acf(_0x4cf4f0,_0x5d196e,_0x54d91f);};};Object[_0x54e587(0x145)](exports,'__esModule',{'value':!![]}),exports[_0x54e587(0x13a)]=void 0x0;const user_entity_1=require('./../user/user.entity'),typeorm_1=require(_0x54e587(0x16e)),common_1=require('@nestjs/common'),typeorm_2=require(_0x54e587(0x16c)),order_entity_1=require(_0x54e587(0x186)),cramiPackage_entity_1=require('../crami/cramiPackage.entity'),utils_1=require('../../common/utils'),pay_service_1=require(_0x54e587(0x16f)),globalConfig_service_1=require(_0x54e587(0x166));let OrderService=class OrderService{constructor(_0x5f59db,_0x5ac027,_0x3b0299,_0x5aa71f,_0x39ed6d){const _0x59d709=_0x54e587;this[_0x59d709(0x188)]=_0x5f59db,this['cramiPackageEntity']=_0x5ac027,this[_0x59d709(0x158)]=_0x3b0299,this[_0x59d709(0x14a)]=_0x5aa71f,this['globalConfigService']=_0x39ed6d;}async[_0x54e587(0x15c)](_0xa46997,_0x4e4d21){const _0x3cbc84=_0x54e587;try{const {goodsId:_0xfed972,count:count=0x1,payType:_0x2233f0}=_0xa46997,{id:_0x87a4ef}=_0x4e4d21[_0x3cbc84(0x151)];if(_0x87a4ef>0xf4240)throw new common_1['HttpException'](_0x3cbc84(0x170),common_1['HttpStatus'][_0x3cbc84(0x14d)]);const _0x36b618=await this[_0x3cbc84(0x13b)](_0x87a4ef,_0xfed972,count,_0x2233f0),_0x78d956=await this[_0x3cbc84(0x14a)][_0x3cbc84(0x185)](_0x87a4ef,_0x36b618[_0x3cbc84(0x172)],_0x2233f0);return Object[_0x3cbc84(0x17b)](Object['assign']({},_0x78d956),{'orderId':_0x36b618[_0x3cbc84(0x172)],'platform':_0x36b618[_0x3cbc84(0x17d)],'total':_0x36b618[_0x3cbc84(0x177)]});}catch(_0x4aafbf){if(_0x4aafbf[_0x3cbc84(0x138)]===0x191)throw new common_1[(_0x3cbc84(0x154))](_0x4aafbf[_0x3cbc84(0x15b)],common_1[_0x3cbc84(0x179)][_0x3cbc84(0x14d)]);throw new common_1[(_0x3cbc84(0x154))](_0x4aafbf['message']||'购买失败!',common_1[_0x3cbc84(0x179)]['BAD_REQUEST']);}}async[_0x54e587(0x174)](_0x2a5b89,_0x20fb22){const _0x42e3e6=_0x54e587,{id:_0x8bac6b}=_0x2a5b89[_0x42e3e6(0x151)],{orderId:_0x4b7639}=_0x20fb22,_0x2751d6=await this['orderEntity'][_0x42e3e6(0x13f)]({'where':{'userId':_0x8bac6b,'orderId':_0x4b7639}});if(!_0x2751d6)throw new common_1[(_0x42e3e6(0x154))]('订单不存在!',common_1[_0x42e3e6(0x179)]['BAD_REQUEST']);return _0x2751d6;}async[_0x54e587(0x13b)](_0x5cbd37,_0x1cf4e5,_0x4d7d87,_0x2a95af){const _0x37830c=_0x54e587,_0x486244=await this[_0x37830c(0x16b)]['queryPayType'](),_0x24e94c=await this[_0x37830c(0x168)][_0x37830c(0x13f)]({'where':{'id':_0x1cf4e5}});if(!_0x24e94c)throw new common_1[(_0x37830c(0x154))]('套餐不存在!',common_1[_0x37830c(0x179)][_0x37830c(0x141)]);const _0x354212={};_0x354212[_0x37830c(0x172)]=(0x0,utils_1[_0x37830c(0x147)])(),_0x354212[_0x37830c(0x140)]=_0x5cbd37,_0x354212[_0x37830c(0x13c)]=_0x1cf4e5,_0x354212[_0x37830c(0x160)]=Number(_0x24e94c['price']),_0x354212['count']=_0x4d7d87,_0x354212[_0x37830c(0x177)]=Number(_0x24e94c['price'])*_0x4d7d87,_0x354212[_0x37830c(0x17d)]=_0x486244,_0x354212[_0x37830c(0x161)]=_0x2a95af;const _0x635ca6=await this[_0x37830c(0x188)]['save'](_0x354212);return console[_0x37830c(0x13d)](_0x37830c(0x143),_0x635ca6),_0x635ca6;}async[_0x54e587(0x16a)](_0x245763,_0x573cba,_0x243752){const _0x31b112=_0x54e587;return await this[_0x31b112(0x188)][_0x31b112(0x156)]({'where':{'userId':_0x245763},'order':{'id':_0x31b112(0x169)},'skip':(_0x573cba-0x1)*_0x243752,'take':_0x243752});}async[_0x54e587(0x165)](_0x39274f){const _0x4bdfb5=_0x54e587,{page:_0x493d14,size:_0x53363c,userId:_0xa52289,platform:_0x4de571,status:_0x1ed7c7}=_0x39274f,_0x565c97={};if(_0xa52289)_0x565c97['userId']=_0xa52289;if(_0x4de571)_0x565c97[_0x4bdfb5(0x17d)]=_0x4de571;if(_0x1ed7c7)_0x565c97['status']=_0x1ed7c7;const [_0x2564de,_0x15f0e5]=await this['orderEntity'][_0x4bdfb5(0x156)]({'order':{'id':_0x4bdfb5(0x169)},'where':_0x565c97,'skip':(_0x493d14-0x1)*_0x53363c,'take':_0x53363c}),_0x406711=_0x2564de[_0x4bdfb5(0x152)](_0x133765=>_0x133765[_0x4bdfb5(0x140)]),_0x50a30e=_0x2564de['map'](_0x48a270=>_0x48a270[_0x4bdfb5(0x13c)]),_0x39ee15=await this[_0x4bdfb5(0x158)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x406711)},'select':['id',_0x4bdfb5(0x14f),_0x4bdfb5(0x187)]}),_0x2407dd=await this[_0x4bdfb5(0x168)][_0x4bdfb5(0x14c)]({'where':{'id':(0x0,typeorm_2['In'])(_0x50a30e)},'select':['id',_0x4bdfb5(0x155),_0x4bdfb5(0x148),'des']});_0x2564de[_0x4bdfb5(0x162)](_0x6db104=>{const _0x4ad734=_0x4bdfb5;_0x6db104[_0x4ad734(0x15e)]=_0x39ee15['find'](_0x45c8d1=>_0x45c8d1['id']===_0x6db104['userId']),_0x6db104[_0x4ad734(0x183)]=_0x2407dd[_0x4ad734(0x14c)](_0x22cf79=>_0x22cf79['id']===_0x6db104[_0x4ad734(0x13c)]);});const _0x1d08a2=await this[_0x4bdfb5(0x188)][_0x4bdfb5(0x16d)](_0x4bdfb5(0x13e))['where'](_0x4bdfb5(0x178),{'status':0x1})[_0x4bdfb5(0x157)](_0x4bdfb5(0x175),_0x4bdfb5(0x150))['getRawOne']();return Object['assign']({'rows':_0x2564de,'count':_0x15f0e5},_0x1d08a2);}async[_0x54e587(0x142)](_0x4b913a){const _0x28f80e=_0x54e587,{orderId:_0x4cb85c}=_0x4b913a,_0x3d1df1=await this['orderEntity'][_0x28f80e(0x13f)]({'where':{'orderId':_0x4cb85c}});if(!_0x3d1df1)throw new common_1[(_0x28f80e(0x154))](_0x28f80e(0x180),common_1[_0x28f80e(0x179)]['BAD_REQUEST']);return await this[_0x28f80e(0x188)]['delete']({'orderId':_0x4cb85c});}async[_0x54e587(0x176)](){const _0x45bd82=_0x54e587;return await this['orderEntity'][_0x45bd82(0x182)]({'status':0x0});}};OrderService=__decorate([(0x0,common_1[_0x54e587(0x167)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(order_entity_1[_0x54e587(0x17f)])),__param(0x1,(0x0,typeorm_1[_0x54e587(0x17e)])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x54e587(0x146)])),__metadata('design:paramtypes',[typeorm_2[_0x54e587(0x18a)],typeorm_2[_0x54e587(0x18a)],typeorm_2[_0x54e587(0x18a)],pay_service_1[_0x54e587(0x17a)],globalConfig_service_1[_0x54e587(0x137)]])],OrderService),exports[_0x54e587(0x13a)]=OrderService;