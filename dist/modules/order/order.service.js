'use strict';function _0x4905(_0x2df66b,_0x4e90fc){const _0x1f5512=_0x1f55();return _0x4905=function(_0x490570,_0x2d479a){_0x490570=_0x490570-0xf3;let _0x37324e=_0x1f5512[_0x490570];return _0x37324e;},_0x4905(_0x2df66b,_0x4e90fc);}const _0x19a3ba=_0x4905;(function(_0x1d43af,_0x247c32){const _0x5e4fce=_0x4905,_0x1419af=_0x1d43af();while(!![]){try{const _0x251354=-parseInt(_0x5e4fce(0x11a))/0x1+-parseInt(_0x5e4fce(0x123))/0x2+-parseInt(_0x5e4fce(0x113))/0x3+-parseInt(_0x5e4fce(0x10c))/0x4+parseInt(_0x5e4fce(0xff))/0x5+-parseInt(_0x5e4fce(0xfa))/0x6+-parseInt(_0x5e4fce(0x139))/0x7*(-parseInt(_0x5e4fce(0x105))/0x8);if(_0x251354===_0x247c32)break;else _0x1419af['push'](_0x1419af['shift']());}catch(_0x38a9cb){_0x1419af['push'](_0x1419af['shift']());}}}(_0x1f55,0x59449));var __decorate=this&&this['__decorate']||function(_0x28e3db,_0x240455,_0x490425,_0x5ded01){const _0x47df87=_0x4905;var _0x19db92=arguments[_0x47df87(0xf5)],_0x41e362=_0x19db92<0x3?_0x240455:_0x5ded01===null?_0x5ded01=Object[_0x47df87(0x115)](_0x240455,_0x490425):_0x5ded01,_0x327f1c;if(typeof Reflect===_0x47df87(0xf7)&&typeof Reflect[_0x47df87(0x108)]===_0x47df87(0xf3))_0x41e362=Reflect[_0x47df87(0x108)](_0x28e3db,_0x240455,_0x490425,_0x5ded01);else{for(var _0x100816=_0x28e3db[_0x47df87(0xf5)]-0x1;_0x100816>=0x0;_0x100816--)if(_0x327f1c=_0x28e3db[_0x100816])_0x41e362=(_0x19db92<0x3?_0x327f1c(_0x41e362):_0x19db92>0x3?_0x327f1c(_0x240455,_0x490425,_0x41e362):_0x327f1c(_0x240455,_0x490425))||_0x41e362;}return _0x19db92>0x3&&_0x41e362&&Object[_0x47df87(0x12c)](_0x240455,_0x490425,_0x41e362),_0x41e362;},__metadata=this&&this[_0x19a3ba(0x124)]||function(_0x5e33f2,_0x1c50aa){const _0x4a2675=_0x19a3ba;if(typeof Reflect==='object'&&typeof Reflect[_0x4a2675(0x146)]==='function')return Reflect[_0x4a2675(0x146)](_0x5e33f2,_0x1c50aa);},__param=this&&this[_0x19a3ba(0xf9)]||function(_0xd0fedb,_0x30d3c0){return function(_0x4def3f,_0x3c7d05){_0x30d3c0(_0x4def3f,_0x3c7d05,_0xd0fedb);};};Object['defineProperty'](exports,_0x19a3ba(0x11c),{'value':!![]}),exports[_0x19a3ba(0x128)]=void 0x0;const user_entity_1=require(_0x19a3ba(0x132)),typeorm_1=require(_0x19a3ba(0x11b)),common_1=require(_0x19a3ba(0x117)),typeorm_2=require('typeorm'),order_entity_1=require('./order.entity'),cramiPackage_entity_1=require('../crami/cramiPackage.entity'),utils_1=require('../../common/utils'),pay_service_1=require(_0x19a3ba(0x109)),globalConfig_service_1=require(_0x19a3ba(0x140));let OrderService=class OrderService{constructor(_0x5468cf,_0x547375,_0x111e2c,_0xf56338,_0x20805c){const _0x43bbb1=_0x19a3ba;this[_0x43bbb1(0x127)]=_0x5468cf,this[_0x43bbb1(0x135)]=_0x547375,this[_0x43bbb1(0x12d)]=_0x111e2c,this[_0x43bbb1(0x11e)]=_0xf56338,this['globalConfigService']=_0x20805c;}async[_0x19a3ba(0xfe)](_0x59742c,_0x348f7b){const _0x338de9=_0x19a3ba;try{const {goodsId:_0x20ab09,count:count=0x1,payType:_0x1cf518}=_0x59742c,{id:_0x5c6129}=_0x348f7b[_0x338de9(0x10e)];if(_0x5c6129>0xf4240)throw new common_1['HttpException'](_0x338de9(0xf6),common_1[_0x338de9(0x133)][_0x338de9(0x111)]);const _0x46128a=await this[_0x338de9(0x102)](_0x5c6129,_0x20ab09,count,_0x1cf518),_0x345961=await this[_0x338de9(0x11e)][_0x338de9(0x126)](_0x5c6129,_0x46128a['orderId'],_0x1cf518);return Object[_0x338de9(0xfd)](Object['assign']({},_0x345961),{'orderId':_0x46128a[_0x338de9(0x122)],'platform':_0x46128a['payPlatform'],'total':_0x46128a[_0x338de9(0x11f)]});}catch(_0x333898){if(_0x333898[_0x338de9(0x12a)]===0x191)throw new common_1[(_0x338de9(0x13e))](_0x333898[_0x338de9(0x107)],common_1[_0x338de9(0x133)][_0x338de9(0x111)]);throw new common_1[(_0x338de9(0x13e))](_0x333898[_0x338de9(0x107)]||_0x338de9(0x10b),common_1[_0x338de9(0x133)][_0x338de9(0x141)]);}}async[_0x19a3ba(0x110)](_0x32f3a5,_0x4217e8){const _0x29caa3=_0x19a3ba,{id:_0x32f825}=_0x32f3a5['user'],{orderId:_0x2119ca}=_0x4217e8,_0x295941=await this[_0x29caa3(0x127)]['findOne']({'where':{'userId':_0x32f825,'orderId':_0x2119ca}});if(!_0x295941)throw new common_1[(_0x29caa3(0x13e))](_0x29caa3(0x138),common_1['HttpStatus']['BAD_REQUEST']);return _0x295941;}async[_0x19a3ba(0x102)](_0x47e3f9,_0xb371d3,_0x4cf7e6,_0x33e782){const _0x21633b=_0x19a3ba,_0x19dd0d=await this[_0x21633b(0x103)][_0x21633b(0x10f)](),_0x1dfd15=await this[_0x21633b(0x135)][_0x21633b(0x12b)]({'where':{'id':_0xb371d3}});if(!_0x1dfd15)throw new common_1['HttpException'](_0x21633b(0x143),common_1[_0x21633b(0x133)][_0x21633b(0x141)]);const _0x16c296={};_0x16c296['orderId']=(0x0,utils_1[_0x21633b(0x106)])(),_0x16c296[_0x21633b(0x142)]=_0x47e3f9,_0x16c296[_0x21633b(0x11d)]=_0xb371d3,_0x16c296['price']=Number(_0x1dfd15['price']),_0x16c296['count']=_0x4cf7e6,_0x16c296[_0x21633b(0x11f)]=Number(_0x1dfd15[_0x21633b(0x100)])*_0x4cf7e6,_0x16c296[_0x21633b(0x134)]=_0x19dd0d,_0x16c296[_0x21633b(0x10a)]=_0x33e782;const _0x48b497=await this['orderEntity'][_0x21633b(0x125)](_0x16c296);return console[_0x21633b(0xf4)](_0x21633b(0x136),_0x48b497),_0x48b497;}async[_0x19a3ba(0x12f)](_0x31dbac,_0x43413f,_0x373b47){const _0x424214=_0x19a3ba;return await this[_0x424214(0x127)]['findAndCount']({'where':{'userId':_0x31dbac},'order':{'id':_0x424214(0x144)},'skip':(_0x43413f-0x1)*_0x373b47,'take':_0x373b47});}async[_0x19a3ba(0xfb)](_0x13b526){const _0x12566d=_0x19a3ba,{page:_0x51164c,size:_0x48f500,userId:_0x1ddd3f,platform:_0x1a92d1,status:_0x1aec9a}=_0x13b526,_0x31b7ae={};if(_0x1ddd3f)_0x31b7ae['userId']=_0x1ddd3f;if(_0x1a92d1)_0x31b7ae[_0x12566d(0x134)]=_0x1a92d1;if(_0x1aec9a)_0x31b7ae[_0x12566d(0x12a)]=_0x1aec9a;const [_0x4ba8f9,_0x57507f]=await this[_0x12566d(0x127)]['findAndCount']({'order':{'id':_0x12566d(0x144)},'where':_0x31b7ae,'skip':(_0x51164c-0x1)*_0x48f500,'take':_0x48f500}),_0x1d4677=_0x4ba8f9[_0x12566d(0x114)](_0x3d0127=>_0x3d0127['userId']),_0x32d4e7=_0x4ba8f9[_0x12566d(0x114)](_0x53b190=>_0x53b190[_0x12566d(0x11d)]),_0x25ba4b=await this[_0x12566d(0x12d)][_0x12566d(0xfc)]({'where':{'id':(0x0,typeorm_2['In'])(_0x1d4677)},'select':['id','username',_0x12566d(0x121)]}),_0x4c9eb3=await this[_0x12566d(0x135)][_0x12566d(0xfc)]({'where':{'id':(0x0,typeorm_2['In'])(_0x32d4e7)},'select':['id','name',_0x12566d(0x13b),_0x12566d(0x104)]});_0x4ba8f9[_0x12566d(0x120)](_0x5a7023=>{const _0x186a53=_0x12566d;_0x5a7023[_0x186a53(0xf8)]=_0x25ba4b['find'](_0x524115=>_0x524115['id']===_0x5a7023['userId']),_0x5a7023[_0x186a53(0x13d)]=_0x4c9eb3[_0x186a53(0xfc)](_0x2f337b=>_0x2f337b['id']===_0x5a7023[_0x186a53(0x11d)]);});const _0x5bcde3=await this[_0x12566d(0x127)][_0x12566d(0x10d)](_0x12566d(0x129))[_0x12566d(0x112)]('order.status\x20=\x20:status',{'status':0x1})[_0x12566d(0x131)]('SUM(order.price)','total_price')[_0x12566d(0x12e)]();return Object[_0x12566d(0xfd)]({'rows':_0x4ba8f9,'count':_0x57507f},_0x5bcde3);}async[_0x19a3ba(0x116)](_0x11a140){const _0x20e291=_0x19a3ba,{orderId:_0x2452dd}=_0x11a140,_0x3c5d8a=await this[_0x20e291(0x127)]['findOne']({'where':{'orderId':_0x2452dd}});if(!_0x3c5d8a)throw new common_1[(_0x20e291(0x13e))]('订单不存在!',common_1[_0x20e291(0x133)][_0x20e291(0x141)]);return await this[_0x20e291(0x127)]['delete']({'orderId':_0x2452dd});}async['deleteNotPay'](){const _0xdcba11=_0x19a3ba;return await this[_0xdcba11(0x127)][_0xdcba11(0x13f)]({'status':0x0});}};OrderService=__decorate([(0x0,common_1[_0x19a3ba(0x101)])(),__param(0x0,(0x0,typeorm_1[_0x19a3ba(0x119)])(order_entity_1[_0x19a3ba(0x145)])),__param(0x1,(0x0,typeorm_1[_0x19a3ba(0x119)])(cramiPackage_entity_1[_0x19a3ba(0x130)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x19a3ba(0x137)])),__metadata('design:paramtypes',[typeorm_2[_0x19a3ba(0x13a)],typeorm_2[_0x19a3ba(0x13a)],typeorm_2[_0x19a3ba(0x13a)],pay_service_1[_0x19a3ba(0x118)],globalConfig_service_1[_0x19a3ba(0x13c)]])],OrderService),exports['OrderService']=OrderService;function _0x1f55(){const _0x28bf1c=['coverImg','GlobalConfigService','goodsInfo','HttpException','delete','../globalConfig/globalConfig.service','BAD_REQUEST','userId','套餐不存在!','DESC','OrderEntity','metadata','function','log','length','请先注册账号后购买商品！','object','userInfo','__param','220110zDYuNQ','queryAllOrder','find','assign','buy','448780iIXMMF','price','Injectable','create','globalConfigService','des','2904LDAQft','createOrderId','message','decorate','../pay/pay.service','channel','购买失败!','1182116jSKxdv','createQueryBuilder','user','queryPayType','queryByOrderId','UNAUTHORIZED','where','1727433busiKD','map','getOwnPropertyDescriptor','deleteOrder','@nestjs/common','PayService','InjectRepository','277960eOSvVb','@nestjs/typeorm','__esModule','goodsId','payService','total','forEach','email','orderId','210402mlzkob','__metadata','save','pay','orderEntity','OrderService','order','status','findOne','defineProperty','userEntity','getRawOne','query','CramiPackageEntity','select','./../user/user.entity','HttpStatus','payPlatform','cramiPackageEntity','order:\x20','UserEntity','订单不存在!','30219JtyhqD','Repository'];_0x1f55=function(){return _0x28bf1c;};return _0x1f55();}