'use strict';const _0x3943cc=_0x3917;(function(_0x3fea48,_0x364274){const _0x4752d1=_0x3917,_0x213d3f=_0x3fea48();while(!![]){try{const _0x1c15e4=parseInt(_0x4752d1(0x1ca))/0x1+-parseInt(_0x4752d1(0x20b))/0x2+-parseInt(_0x4752d1(0x1ef))/0x3*(-parseInt(_0x4752d1(0x1e4))/0x4)+parseInt(_0x4752d1(0x1c7))/0x5*(parseInt(_0x4752d1(0x1d7))/0x6)+parseInt(_0x4752d1(0x1d6))/0x7+-parseInt(_0x4752d1(0x1da))/0x8+parseInt(_0x4752d1(0x207))/0x9*(-parseInt(_0x4752d1(0x1ec))/0xa);if(_0x1c15e4===_0x364274)break;else _0x213d3f['push'](_0x213d3f['shift']());}catch(_0x27881a){_0x213d3f['push'](_0x213d3f['shift']());}}}(_0x1e68,0x5a787));var __decorate=this&&this[_0x3943cc(0x1f8)]||function(_0x5aae78,_0x1edf0c,_0x348770,_0x3eacc5){const _0x5d8a1f=_0x3943cc;var _0x5c6a50=arguments['length'],_0x46485d=_0x5c6a50<0x3?_0x1edf0c:_0x3eacc5===null?_0x3eacc5=Object[_0x5d8a1f(0x1ff)](_0x1edf0c,_0x348770):_0x3eacc5,_0x4bc745;if(typeof Reflect==='object'&&typeof Reflect[_0x5d8a1f(0x1dd)]===_0x5d8a1f(0x1d0))_0x46485d=Reflect[_0x5d8a1f(0x1dd)](_0x5aae78,_0x1edf0c,_0x348770,_0x3eacc5);else{for(var _0x5dc23b=_0x5aae78[_0x5d8a1f(0x219)]-0x1;_0x5dc23b>=0x0;_0x5dc23b--)if(_0x4bc745=_0x5aae78[_0x5dc23b])_0x46485d=(_0x5c6a50<0x3?_0x4bc745(_0x46485d):_0x5c6a50>0x3?_0x4bc745(_0x1edf0c,_0x348770,_0x46485d):_0x4bc745(_0x1edf0c,_0x348770))||_0x46485d;}return _0x5c6a50>0x3&&_0x46485d&&Object[_0x5d8a1f(0x1d9)](_0x1edf0c,_0x348770,_0x46485d),_0x46485d;},__metadata=this&&this[_0x3943cc(0x202)]||function(_0x1946b6,_0x1d2be7){const _0x12b4ea=_0x3943cc;if(typeof Reflect==='object'&&typeof Reflect[_0x12b4ea(0x20d)]===_0x12b4ea(0x1d0))return Reflect['metadata'](_0x1946b6,_0x1d2be7);},__param=this&&this[_0x3943cc(0x1e6)]||function(_0x414d21,_0x3d5c80){return function(_0x245f7d,_0x4c364e){_0x3d5c80(_0x245f7d,_0x4c364e,_0x414d21);};};Object['defineProperty'](exports,_0x3943cc(0x1d3),{'value':!![]}),exports[_0x3943cc(0x1fa)]=void 0x0;const user_entity_1=require('./../user/user.entity'),typeorm_1=require(_0x3943cc(0x1e9)),common_1=require(_0x3943cc(0x1fc)),typeorm_2=require(_0x3943cc(0x1fd)),order_entity_1=require(_0x3943cc(0x1db)),cramiPackage_entity_1=require(_0x3943cc(0x1df)),utils_1=require(_0x3943cc(0x1c3)),pay_service_1=require(_0x3943cc(0x1c9)),globalConfig_service_1=require(_0x3943cc(0x1cf));function _0x1e68(){const _0x380df0=['userEntity','order.status\x20=\x20:status','goodsId','__decorate','assign','OrderService','username','@nestjs/common','typeorm','UserEntity','getOwnPropertyDescriptor','请先注册账号后购买商品！','userId','__metadata','OrderEntity','findAndCount','createOrderId','where','26262xtaOQw','UNAUTHORIZED','pay','save','979892nIXLzQ','user','metadata','status','total','query','订单不存在!','order:\x20','HttpStatus','GlobalConfigService','goodsInfo','InjectRepository','design:paramtypes','PayService','length','../../common/utils','coverImg','Repository','delete','5OoDTlN','find','../pay/pay.service','675143iQZIRn','payPlatform','price','createQueryBuilder','userInfo','../globalConfig/globalConfig.service','function','payService','queryAllOrder','__esModule','forEach','BAD_REQUEST','1526028QhHsTj','2019774xOhFza','orderId','defineProperty','2933144mAWZqb','./order.entity','套餐不存在!','decorate','CramiPackageEntity','../crami/cramiPackage.entity','map','SUM(order.price)','channel','findOne','273244kCxSfK','message','__param','globalConfigService','DESC','@nestjs/typeorm','queryByOrderId','total_price','2350NTvgNQ','getRawOne','orderEntity','30zSXKQZ','deleteOrder','cramiPackageEntity','Injectable','create','HttpException'];_0x1e68=function(){return _0x380df0;};return _0x1e68();}let OrderService=class OrderService{constructor(_0xce7dfc,_0x3346d0,_0x4867b1,_0x435fc0,_0x26b480){const _0x3e2165=_0x3943cc;this[_0x3e2165(0x1ee)]=_0xce7dfc,this[_0x3e2165(0x1f1)]=_0x3346d0,this['userEntity']=_0x4867b1,this[_0x3e2165(0x1d1)]=_0x435fc0,this[_0x3e2165(0x1e7)]=_0x26b480;}async['buy'](_0x23e905,_0x4484be){const _0x1f8774=_0x3943cc;try{const {goodsId:_0x4bcdad,count:count=0x1,payType:_0x456fae}=_0x23e905,{id:_0x472094}=_0x4484be['user'];if(_0x472094>0xf4240)throw new common_1[(_0x1f8774(0x1f4))](_0x1f8774(0x200),common_1[_0x1f8774(0x213)]['UNAUTHORIZED']);const _0x526508=await this[_0x1f8774(0x1f3)](_0x472094,_0x4bcdad,count,_0x456fae),_0x46018a=await this[_0x1f8774(0x1d1)][_0x1f8774(0x209)](_0x472094,_0x526508[_0x1f8774(0x1d8)],_0x456fae);return Object[_0x1f8774(0x1f9)](Object[_0x1f8774(0x1f9)]({},_0x46018a),{'orderId':_0x526508[_0x1f8774(0x1d8)],'platform':_0x526508[_0x1f8774(0x1cb)],'total':_0x526508[_0x1f8774(0x20f)]});}catch(_0x1e16c8){if(_0x1e16c8[_0x1f8774(0x20e)]===0x191)throw new common_1[(_0x1f8774(0x1f4))](_0x1e16c8['message'],common_1[_0x1f8774(0x213)][_0x1f8774(0x208)]);throw new common_1['HttpException'](_0x1e16c8[_0x1f8774(0x1e5)]||'购买失败!',common_1[_0x1f8774(0x213)][_0x1f8774(0x1d5)]);}}async[_0x3943cc(0x1ea)](_0x507d81,_0x288865){const _0x4ba582=_0x3943cc,{id:_0x277de1}=_0x507d81[_0x4ba582(0x20c)],{orderId:_0x4d6d00}=_0x288865,_0x376f93=await this[_0x4ba582(0x1ee)]['findOne']({'where':{'userId':_0x277de1,'orderId':_0x4d6d00}});if(!_0x376f93)throw new common_1[(_0x4ba582(0x1f4))](_0x4ba582(0x211),common_1[_0x4ba582(0x213)][_0x4ba582(0x1d5)]);return _0x376f93;}async[_0x3943cc(0x1f3)](_0x736847,_0x33bf7d,_0x49af2f,_0x11c894){const _0x459d77=_0x3943cc,_0x30cf9d=await this['globalConfigService']['queryPayType'](),_0x4a95b3=await this[_0x459d77(0x1f1)][_0x459d77(0x1e3)]({'where':{'id':_0x33bf7d}});if(!_0x4a95b3)throw new common_1[(_0x459d77(0x1f4))](_0x459d77(0x1dc),common_1[_0x459d77(0x213)][_0x459d77(0x1d5)]);const _0x5be6a7={};_0x5be6a7[_0x459d77(0x1d8)]=(0x0,utils_1[_0x459d77(0x205)])(),_0x5be6a7[_0x459d77(0x201)]=_0x736847,_0x5be6a7[_0x459d77(0x1f7)]=_0x33bf7d,_0x5be6a7[_0x459d77(0x1cc)]=Number(_0x4a95b3['price']),_0x5be6a7['count']=_0x49af2f,_0x5be6a7[_0x459d77(0x20f)]=Number(_0x4a95b3[_0x459d77(0x1cc)])*_0x49af2f,_0x5be6a7[_0x459d77(0x1cb)]=_0x30cf9d,_0x5be6a7[_0x459d77(0x1e2)]=_0x11c894;const _0x577cf5=await this[_0x459d77(0x1ee)][_0x459d77(0x20a)](_0x5be6a7);return console['log'](_0x459d77(0x212),_0x577cf5),_0x577cf5;}async[_0x3943cc(0x210)](_0x13d125,_0x17c015,_0x54a87a){const _0x2614a5=_0x3943cc;return await this['orderEntity'][_0x2614a5(0x204)]({'where':{'userId':_0x13d125},'order':{'id':_0x2614a5(0x1e8)},'skip':(_0x17c015-0x1)*_0x54a87a,'take':_0x54a87a});}async[_0x3943cc(0x1d2)](_0x33149e){const _0xf09373=_0x3943cc,{page:_0x4efe9d,size:_0x4713c3,userId:_0x24abb7,platform:_0x32c4a0,status:_0x141ab9}=_0x33149e,_0x32dbc9={};if(_0x24abb7)_0x32dbc9[_0xf09373(0x201)]=_0x24abb7;if(_0x32c4a0)_0x32dbc9['payPlatform']=_0x32c4a0;if(_0x141ab9)_0x32dbc9[_0xf09373(0x20e)]=_0x141ab9;const [_0x37ddd0,_0x208226]=await this[_0xf09373(0x1ee)]['findAndCount']({'order':{'id':_0xf09373(0x1e8)},'where':_0x32dbc9,'skip':(_0x4efe9d-0x1)*_0x4713c3,'take':_0x4713c3}),_0x1a0ad1=_0x37ddd0['map'](_0x2c69fa=>_0x2c69fa['userId']),_0x4a1868=_0x37ddd0[_0xf09373(0x1e0)](_0x633c6d=>_0x633c6d[_0xf09373(0x1f7)]),_0x55389f=await this[_0xf09373(0x1f5)][_0xf09373(0x1c8)]({'where':{'id':(0x0,typeorm_2['In'])(_0x1a0ad1)},'select':['id',_0xf09373(0x1fb),'email']}),_0xc733ed=await this[_0xf09373(0x1f1)][_0xf09373(0x1c8)]({'where':{'id':(0x0,typeorm_2['In'])(_0x4a1868)},'select':['id','name',_0xf09373(0x1c4),'des']});_0x37ddd0[_0xf09373(0x1d4)](_0x3e7d85=>{const _0x284f2a=_0xf09373;_0x3e7d85[_0x284f2a(0x1ce)]=_0x55389f[_0x284f2a(0x1c8)](_0x2de4ca=>_0x2de4ca['id']===_0x3e7d85[_0x284f2a(0x201)]),_0x3e7d85[_0x284f2a(0x215)]=_0xc733ed[_0x284f2a(0x1c8)](_0x526079=>_0x526079['id']===_0x3e7d85[_0x284f2a(0x1f7)]);});const _0x408dea=await this[_0xf09373(0x1ee)][_0xf09373(0x1cd)]('order')[_0xf09373(0x206)](_0xf09373(0x1f6),{'status':0x1})['select'](_0xf09373(0x1e1),_0xf09373(0x1eb))[_0xf09373(0x1ed)]();return Object['assign']({'rows':_0x37ddd0,'count':_0x208226},_0x408dea);}async[_0x3943cc(0x1f0)](_0x49f5e2){const _0x13d4ef=_0x3943cc,{orderId:_0xf876e5}=_0x49f5e2,_0xeebb5b=await this[_0x13d4ef(0x1ee)]['findOne']({'where':{'orderId':_0xf876e5}});if(!_0xeebb5b)throw new common_1[(_0x13d4ef(0x1f4))]('订单不存在!',common_1[_0x13d4ef(0x213)][_0x13d4ef(0x1d5)]);return await this[_0x13d4ef(0x1ee)][_0x13d4ef(0x1c6)]({'orderId':_0xf876e5});}async['deleteNotPay'](){const _0x381b85=_0x3943cc;return await this[_0x381b85(0x1ee)][_0x381b85(0x1c6)]({'status':0x0});}};function _0x3917(_0x3d913e,_0x343abc){const _0x1e68a2=_0x1e68();return _0x3917=function(_0x391744,_0xf23db9){_0x391744=_0x391744-0x1c3;let _0x2ef77e=_0x1e68a2[_0x391744];return _0x2ef77e;},_0x3917(_0x3d913e,_0x343abc);}OrderService=__decorate([(0x0,common_1[_0x3943cc(0x1f2)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(order_entity_1[_0x3943cc(0x203)])),__param(0x1,(0x0,typeorm_1[_0x3943cc(0x216)])(cramiPackage_entity_1[_0x3943cc(0x1de)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x3943cc(0x1fe)])),__metadata(_0x3943cc(0x217),[typeorm_2['Repository'],typeorm_2[_0x3943cc(0x1c5)],typeorm_2[_0x3943cc(0x1c5)],pay_service_1[_0x3943cc(0x218)],globalConfig_service_1[_0x3943cc(0x214)]])],OrderService),exports[_0x3943cc(0x1fa)]=OrderService;