'use strict';function _0x1560(){const _0x216689=['queryPayType','userEntity','88dUITyR','InjectRepository','user','orderId','save','套餐不存在!','total','log','订单不存在!','defineProperty','des','userId','779005BAfUjo','getOwnPropertyDescriptor','globalConfigService','OrderService','where','payService','forEach','../globalConfig/globalConfig.service','map','findOne','__esModule','PayService','../pay/pay.service','function','create','__decorate','getRawOne','HttpException','cramiPackageEntity','383789aiTjDL','length','findAndCount','UserEntity','BAD_REQUEST','HttpStatus','coverImg','order:\x20','query','18dBJxnR','metadata','decorate','delete','queryAllOrder','8zrYhZo','createQueryBuilder','2222956jHuRht','payPlatform','design:paramtypes','channel','DESC','order.status\x20=\x20:status','107059BwUTeQ','UNAUTHORIZED','status','@nestjs/common','__metadata','goodsInfo','userInfo','911463dvuCnG','find','SUM(order.price)','name','assign','username','CramiPackageEntity','@nestjs/typeorm','../../common/utils','deleteNotPay','total_price','buy','./order.entity','__param','price','4551615gDxrru','OrderEntity','select','goodsId','6796380xkVUoy','object','../crami/cramiPackage.entity','33oFuXIg','Repository','email','orderEntity'];_0x1560=function(){return _0x216689;};return _0x1560();}const _0x54d037=_0x363a;(function(_0x5bad35,_0x30a6b){const _0x35601d=_0x363a,_0x351eed=_0x5bad35();while(!![]){try{const _0x29abb9=parseInt(_0x35601d(0x234))/0x1+-parseInt(_0x35601d(0x22e))/0x2+-parseInt(_0x35601d(0x23b))/0x3*(parseInt(_0x35601d(0x22c))/0x4)+parseInt(_0x35601d(0x20b))/0x5*(parseInt(_0x35601d(0x227))/0x6)+parseInt(_0x35601d(0x21e))/0x7*(parseInt(_0x35601d(0x1ff))/0x8)+-parseInt(_0x35601d(0x1f2))/0x9+parseInt(_0x35601d(0x1f6))/0xa*(parseInt(_0x35601d(0x1f9))/0xb);if(_0x29abb9===_0x30a6b)break;else _0x351eed['push'](_0x351eed['shift']());}catch(_0x14d96a){_0x351eed['push'](_0x351eed['shift']());}}}(_0x1560,0xf2182));var __decorate=this&&this[_0x54d037(0x21a)]||function(_0x2e72a4,_0x3676c5,_0x228601,_0x2914dc){const _0x435338=_0x54d037;var _0x59ed7d=arguments[_0x435338(0x21f)],_0x1d6f6b=_0x59ed7d<0x3?_0x3676c5:_0x2914dc===null?_0x2914dc=Object[_0x435338(0x20c)](_0x3676c5,_0x228601):_0x2914dc,_0x1591a0;if(typeof Reflect===_0x435338(0x1f7)&&typeof Reflect[_0x435338(0x229)]===_0x435338(0x218))_0x1d6f6b=Reflect[_0x435338(0x229)](_0x2e72a4,_0x3676c5,_0x228601,_0x2914dc);else{for(var _0x43f1d9=_0x2e72a4[_0x435338(0x21f)]-0x1;_0x43f1d9>=0x0;_0x43f1d9--)if(_0x1591a0=_0x2e72a4[_0x43f1d9])_0x1d6f6b=(_0x59ed7d<0x3?_0x1591a0(_0x1d6f6b):_0x59ed7d>0x3?_0x1591a0(_0x3676c5,_0x228601,_0x1d6f6b):_0x1591a0(_0x3676c5,_0x228601))||_0x1d6f6b;}return _0x59ed7d>0x3&&_0x1d6f6b&&Object['defineProperty'](_0x3676c5,_0x228601,_0x1d6f6b),_0x1d6f6b;},__metadata=this&&this[_0x54d037(0x238)]||function(_0x2210b1,_0x19e29b){const _0x1ca414=_0x54d037;if(typeof Reflect==='object'&&typeof Reflect[_0x1ca414(0x228)]==='function')return Reflect['metadata'](_0x2210b1,_0x19e29b);},__param=this&&this[_0x54d037(0x1f0)]||function(_0xe6faa6,_0x4f9adf){return function(_0x39a268,_0x110179){_0x4f9adf(_0x39a268,_0x110179,_0xe6faa6);};};Object[_0x54d037(0x208)](exports,_0x54d037(0x215),{'value':!![]}),exports['OrderService']=void 0x0;const user_entity_1=require('./../user/user.entity'),typeorm_1=require(_0x54d037(0x1ea)),common_1=require(_0x54d037(0x237)),typeorm_2=require('typeorm'),order_entity_1=require(_0x54d037(0x1ef)),cramiPackage_entity_1=require(_0x54d037(0x1f8)),utils_1=require(_0x54d037(0x1eb)),pay_service_1=require(_0x54d037(0x217)),globalConfig_service_1=require(_0x54d037(0x212));let OrderService=class OrderService{constructor(_0x36f002,_0x1a1270,_0x1be145,_0x51c761,_0x49fcba){const _0x37d22e=_0x54d037;this[_0x37d22e(0x1fc)]=_0x36f002,this[_0x37d22e(0x21d)]=_0x1a1270,this['userEntity']=_0x1be145,this[_0x37d22e(0x210)]=_0x51c761,this[_0x37d22e(0x20d)]=_0x49fcba;}async[_0x54d037(0x1ee)](_0x57e28a,_0x3c77c3){const _0xb0a95c=_0x54d037;try{const {goodsId:_0x30d746,count:count=0x1,payType:_0x1664fe}=_0x57e28a,{id:_0x3d149b}=_0x3c77c3[_0xb0a95c(0x201)];if(_0x3d149b>0xf4240)throw new common_1[(_0xb0a95c(0x21c))]('请先注册账号后购买商品！',common_1[_0xb0a95c(0x223)][_0xb0a95c(0x235)]);const _0x52eafe=await this[_0xb0a95c(0x219)](_0x3d149b,_0x30d746,count,_0x1664fe),_0x3c4ba2=await this['payService']['pay'](_0x3d149b,_0x52eafe[_0xb0a95c(0x202)],_0x1664fe);return Object['assign'](Object[_0xb0a95c(0x23f)]({},_0x3c4ba2),{'orderId':_0x52eafe[_0xb0a95c(0x202)],'platform':_0x52eafe['payPlatform'],'total':_0x52eafe[_0xb0a95c(0x205)]});}catch(_0x404f83){if(_0x404f83[_0xb0a95c(0x236)]===0x191)throw new common_1[(_0xb0a95c(0x21c))](_0x404f83['message'],common_1[_0xb0a95c(0x223)]['UNAUTHORIZED']);throw new common_1[(_0xb0a95c(0x21c))](_0x404f83['message']||'购买失败!',common_1[_0xb0a95c(0x223)][_0xb0a95c(0x222)]);}}async['queryByOrderId'](_0x17b214,_0x4c94e0){const _0x2bb429=_0x54d037,{id:_0x24d9a1}=_0x17b214['user'],{orderId:_0x37e455}=_0x4c94e0,_0x2960c1=await this[_0x2bb429(0x1fc)][_0x2bb429(0x214)]({'where':{'userId':_0x24d9a1,'orderId':_0x37e455}});if(!_0x2960c1)throw new common_1[(_0x2bb429(0x21c))](_0x2bb429(0x207),common_1[_0x2bb429(0x223)]['BAD_REQUEST']);return _0x2960c1;}async[_0x54d037(0x219)](_0x350ee9,_0x1c66d6,_0x8890b2,_0x59dff9){const _0x545b00=_0x54d037,_0x2ac846=await this[_0x545b00(0x20d)][_0x545b00(0x1fd)](),_0x28b25e=await this[_0x545b00(0x21d)][_0x545b00(0x214)]({'where':{'id':_0x1c66d6}});if(!_0x28b25e)throw new common_1[(_0x545b00(0x21c))](_0x545b00(0x204),common_1[_0x545b00(0x223)][_0x545b00(0x222)]);const _0xe3c5c8={};_0xe3c5c8[_0x545b00(0x202)]=(0x0,utils_1['createOrderId'])(),_0xe3c5c8[_0x545b00(0x20a)]=_0x350ee9,_0xe3c5c8[_0x545b00(0x1f5)]=_0x1c66d6,_0xe3c5c8[_0x545b00(0x1f1)]=Number(_0x28b25e[_0x545b00(0x1f1)]),_0xe3c5c8['count']=_0x8890b2,_0xe3c5c8[_0x545b00(0x205)]=Number(_0x28b25e['price'])*_0x8890b2,_0xe3c5c8[_0x545b00(0x22f)]=_0x2ac846,_0xe3c5c8[_0x545b00(0x231)]=_0x59dff9;const _0x5b26e1=await this['orderEntity'][_0x545b00(0x203)](_0xe3c5c8);return console[_0x545b00(0x206)](_0x545b00(0x225),_0x5b26e1),_0x5b26e1;}async[_0x54d037(0x226)](_0x418b5c,_0x18331c,_0x55d6f1){const _0x3ce6c5=_0x54d037;return await this['orderEntity'][_0x3ce6c5(0x220)]({'where':{'userId':_0x418b5c},'order':{'id':_0x3ce6c5(0x232)},'skip':(_0x18331c-0x1)*_0x55d6f1,'take':_0x55d6f1});}async[_0x54d037(0x22b)](_0x461f66){const _0x18f8c0=_0x54d037,{page:_0x13c5c2,size:_0x24c6cd,userId:_0x379806,platform:_0x447bdb,status:_0x1a43b2}=_0x461f66,_0x3e650f={};if(_0x379806)_0x3e650f[_0x18f8c0(0x20a)]=_0x379806;if(_0x447bdb)_0x3e650f['payPlatform']=_0x447bdb;if(_0x1a43b2)_0x3e650f[_0x18f8c0(0x236)]=_0x1a43b2;const [_0x40c9bc,_0x4f8681]=await this[_0x18f8c0(0x1fc)][_0x18f8c0(0x220)]({'order':{'id':_0x18f8c0(0x232)},'where':_0x3e650f,'skip':(_0x13c5c2-0x1)*_0x24c6cd,'take':_0x24c6cd}),_0x46ec3b=_0x40c9bc[_0x18f8c0(0x213)](_0x257f1a=>_0x257f1a[_0x18f8c0(0x20a)]),_0xc9db7f=_0x40c9bc[_0x18f8c0(0x213)](_0x355e1e=>_0x355e1e[_0x18f8c0(0x1f5)]),_0x476e0c=await this[_0x18f8c0(0x1fe)][_0x18f8c0(0x23c)]({'where':{'id':(0x0,typeorm_2['In'])(_0x46ec3b)},'select':['id',_0x18f8c0(0x240),_0x18f8c0(0x1fb)]}),_0x771fb4=await this[_0x18f8c0(0x21d)][_0x18f8c0(0x23c)]({'where':{'id':(0x0,typeorm_2['In'])(_0xc9db7f)},'select':['id',_0x18f8c0(0x23e),_0x18f8c0(0x224),_0x18f8c0(0x209)]});_0x40c9bc[_0x18f8c0(0x211)](_0x47cd81=>{const _0x40920a=_0x18f8c0;_0x47cd81[_0x40920a(0x23a)]=_0x476e0c[_0x40920a(0x23c)](_0x4d3467=>_0x4d3467['id']===_0x47cd81[_0x40920a(0x20a)]),_0x47cd81[_0x40920a(0x239)]=_0x771fb4[_0x40920a(0x23c)](_0x5e3b82=>_0x5e3b82['id']===_0x47cd81['goodsId']);});const _0x28f39e=await this[_0x18f8c0(0x1fc)][_0x18f8c0(0x22d)]('order')[_0x18f8c0(0x20f)](_0x18f8c0(0x233),{'status':0x1})[_0x18f8c0(0x1f4)](_0x18f8c0(0x23d),_0x18f8c0(0x1ed))[_0x18f8c0(0x21b)]();return Object[_0x18f8c0(0x23f)]({'rows':_0x40c9bc,'count':_0x4f8681},_0x28f39e);}async['deleteOrder'](_0x2ff18f){const _0x2f2433=_0x54d037,{orderId:_0x2ae5b6}=_0x2ff18f,_0x4cbdeb=await this[_0x2f2433(0x1fc)]['findOne']({'where':{'orderId':_0x2ae5b6}});if(!_0x4cbdeb)throw new common_1[(_0x2f2433(0x21c))](_0x2f2433(0x207),common_1[_0x2f2433(0x223)][_0x2f2433(0x222)]);return await this[_0x2f2433(0x1fc)][_0x2f2433(0x22a)]({'orderId':_0x2ae5b6});}async[_0x54d037(0x1ec)](){const _0x33f5b2=_0x54d037;return await this[_0x33f5b2(0x1fc)][_0x33f5b2(0x22a)]({'status':0x0});}};function _0x363a(_0x2c589c,_0x470c80){const _0x156070=_0x1560();return _0x363a=function(_0x363ac7,_0xe524f){_0x363ac7=_0x363ac7-0x1e9;let _0x255aed=_0x156070[_0x363ac7];return _0x255aed;},_0x363a(_0x2c589c,_0x470c80);}OrderService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x54d037(0x200)])(order_entity_1[_0x54d037(0x1f3)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(cramiPackage_entity_1[_0x54d037(0x1e9)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x54d037(0x221)])),__metadata(_0x54d037(0x230),[typeorm_2[_0x54d037(0x1fa)],typeorm_2[_0x54d037(0x1fa)],typeorm_2[_0x54d037(0x1fa)],pay_service_1[_0x54d037(0x216)],globalConfig_service_1['GlobalConfigService']])],OrderService),exports[_0x54d037(0x20e)]=OrderService;