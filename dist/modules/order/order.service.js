'use strict';const _0x54fcc9=_0x562e;function _0x562e(_0xd855c8,_0x245743){const _0xb7fa58=_0xb7fa();return _0x562e=function(_0x562eeb,_0x24e9d4){_0x562eeb=_0x562eeb-0x1b2;let _0x41724=_0xb7fa58[_0x562eeb];return _0x41724;},_0x562e(_0xd855c8,_0x245743);}(function(_0x135469,_0x3cd34a){const _0x4c6d0c=_0x562e,_0x5dc11b=_0x135469();while(!![]){try{const _0x1202e7=-parseInt(_0x4c6d0c(0x1fa))/0x1*(-parseInt(_0x4c6d0c(0x1be))/0x2)+-parseInt(_0x4c6d0c(0x1e0))/0x3+parseInt(_0x4c6d0c(0x1ef))/0x4+parseInt(_0x4c6d0c(0x1e4))/0x5+parseInt(_0x4c6d0c(0x1ff))/0x6+parseInt(_0x4c6d0c(0x1b2))/0x7+-parseInt(_0x4c6d0c(0x1c8))/0x8;if(_0x1202e7===_0x3cd34a)break;else _0x5dc11b['push'](_0x5dc11b['shift']());}catch(_0x4bba80){_0x5dc11b['push'](_0x5dc11b['shift']());}}}(_0xb7fa,0x9bd1d));var __decorate=this&&this[_0x54fcc9(0x1bc)]||function(_0x4a1190,_0x2b4c97,_0x56eb82,_0x4a7f44){const _0x26c2a5=_0x54fcc9;var _0x4da9dd=arguments[_0x26c2a5(0x1eb)],_0xa1f270=_0x4da9dd<0x3?_0x2b4c97:_0x4a7f44===null?_0x4a7f44=Object[_0x26c2a5(0x202)](_0x2b4c97,_0x56eb82):_0x4a7f44,_0x22c51a;if(typeof Reflect==='object'&&typeof Reflect[_0x26c2a5(0x1bb)]===_0x26c2a5(0x1da))_0xa1f270=Reflect['decorate'](_0x4a1190,_0x2b4c97,_0x56eb82,_0x4a7f44);else{for(var _0x1d4fb7=_0x4a1190['length']-0x1;_0x1d4fb7>=0x0;_0x1d4fb7--)if(_0x22c51a=_0x4a1190[_0x1d4fb7])_0xa1f270=(_0x4da9dd<0x3?_0x22c51a(_0xa1f270):_0x4da9dd>0x3?_0x22c51a(_0x2b4c97,_0x56eb82,_0xa1f270):_0x22c51a(_0x2b4c97,_0x56eb82))||_0xa1f270;}return _0x4da9dd>0x3&&_0xa1f270&&Object[_0x26c2a5(0x1df)](_0x2b4c97,_0x56eb82,_0xa1f270),_0xa1f270;},__metadata=this&&this[_0x54fcc9(0x201)]||function(_0x64ed82,_0x400dd4){const _0x2c34c6=_0x54fcc9;if(typeof Reflect===_0x2c34c6(0x1c5)&&typeof Reflect[_0x2c34c6(0x1cb)]===_0x2c34c6(0x1da))return Reflect[_0x2c34c6(0x1cb)](_0x64ed82,_0x400dd4);},__param=this&&this['__param']||function(_0x2d341c,_0x1b9b96){return function(_0x5c6594,_0x11f8c4){_0x1b9b96(_0x5c6594,_0x11f8c4,_0x2d341c);};};function _0xb7fa(){const _0x4ec239=['queryByOrderId','HttpException','metadata','BAD_REQUEST','query','create','DESC','./../user/user.entity','typeorm','order','购买失败!','design:paramtypes','InjectRepository','请先注册账号后购买商品！','save','userId','createOrderId','function','../crami/cramiPackage.entity','deleteOrder','globalConfigService','../pay/pay.service','defineProperty','3760044wBscqi','delete','OrderService','Injectable','4294160qgZUXU','userInfo','userEntity','Repository','HttpStatus','count','username','length','OrderEntity','total_price','payService','2313672zmgoeq','goodsId','订单不存在!','total','@nestjs/typeorm','email','buy','status','__esModule','goodsInfo','price','581287LBZBuA','../../common/utils','cramiPackageEntity','where','@nestjs/common','6065916aTArpx','queryAllOrder','__metadata','getOwnPropertyDescriptor','log','findOne','8354689mPxInE','orderId','des','deleteNotPay','SUM(order.price)','order.status\x20=\x20:status','assign','find','map','decorate','__decorate','CramiPackageEntity','2HTSIal','UserEntity','message','UNAUTHORIZED','findAndCount','name','套餐不存在!','object','orderEntity','queryPayType','18651720wGhISt'];_0xb7fa=function(){return _0x4ec239;};return _0xb7fa();}Object[_0x54fcc9(0x1df)](exports,_0x54fcc9(0x1f7),{'value':!![]}),exports[_0x54fcc9(0x1e2)]=void 0x0;const user_entity_1=require(_0x54fcc9(0x1d0)),typeorm_1=require(_0x54fcc9(0x1f3)),common_1=require(_0x54fcc9(0x1fe)),typeorm_2=require(_0x54fcc9(0x1d1)),order_entity_1=require('./order.entity'),cramiPackage_entity_1=require(_0x54fcc9(0x1db)),utils_1=require(_0x54fcc9(0x1fb)),pay_service_1=require(_0x54fcc9(0x1de)),globalConfig_service_1=require('../globalConfig/globalConfig.service');let OrderService=class OrderService{constructor(_0x361be9,_0x20979b,_0x4a9c59,_0x4a05e4,_0x26ffdc){const _0x214eed=_0x54fcc9;this[_0x214eed(0x1c6)]=_0x361be9,this[_0x214eed(0x1fc)]=_0x20979b,this[_0x214eed(0x1e6)]=_0x4a9c59,this[_0x214eed(0x1ee)]=_0x4a05e4,this[_0x214eed(0x1dd)]=_0x26ffdc;}async[_0x54fcc9(0x1f5)](_0x56f509,_0x280d4b){const _0x272fcc=_0x54fcc9;try{const {goodsId:_0x39f8a4,count:count=0x1,payType:_0x4dea12}=_0x56f509,{id:_0x216162}=_0x280d4b['user'];if(_0x216162>0xf4240)throw new common_1['HttpException'](_0x272fcc(0x1d6),common_1[_0x272fcc(0x1e8)][_0x272fcc(0x1c1)]);const _0x266033=await this[_0x272fcc(0x1ce)](_0x216162,_0x39f8a4,count,_0x4dea12),_0x5d496d=await this[_0x272fcc(0x1ee)]['pay'](_0x216162,_0x266033[_0x272fcc(0x1b3)],_0x4dea12);return Object[_0x272fcc(0x1b8)](Object[_0x272fcc(0x1b8)]({},_0x5d496d),{'orderId':_0x266033[_0x272fcc(0x1b3)],'platform':_0x266033['payPlatform'],'total':_0x266033[_0x272fcc(0x1f2)]});}catch(_0x4855ba){if(_0x4855ba[_0x272fcc(0x1f6)]===0x191)throw new common_1[(_0x272fcc(0x1ca))](_0x4855ba[_0x272fcc(0x1c0)],common_1['HttpStatus']['UNAUTHORIZED']);throw new common_1['HttpException'](_0x4855ba[_0x272fcc(0x1c0)]||_0x272fcc(0x1d3),common_1[_0x272fcc(0x1e8)]['BAD_REQUEST']);}}async[_0x54fcc9(0x1c9)](_0x3e1918,_0x47e750){const _0x4073e3=_0x54fcc9,{id:_0x3ee70f}=_0x3e1918['user'],{orderId:_0x3bed60}=_0x47e750,_0x258a9f=await this['orderEntity']['findOne']({'where':{'userId':_0x3ee70f,'orderId':_0x3bed60}});if(!_0x258a9f)throw new common_1[(_0x4073e3(0x1ca))](_0x4073e3(0x1f1),common_1[_0x4073e3(0x1e8)]['BAD_REQUEST']);return _0x258a9f;}async[_0x54fcc9(0x1ce)](_0x4dbcb6,_0x333303,_0xb74c0d,_0x3fa152){const _0x177ff5=_0x54fcc9,_0x439312=await this['globalConfigService'][_0x177ff5(0x1c7)](),_0x55049f=await this[_0x177ff5(0x1fc)]['findOne']({'where':{'id':_0x333303}});if(!_0x55049f)throw new common_1[(_0x177ff5(0x1ca))](_0x177ff5(0x1c4),common_1[_0x177ff5(0x1e8)]['BAD_REQUEST']);const _0x1a3c7f={};_0x1a3c7f[_0x177ff5(0x1b3)]=(0x0,utils_1[_0x177ff5(0x1d9)])(),_0x1a3c7f[_0x177ff5(0x1d8)]=_0x4dbcb6,_0x1a3c7f[_0x177ff5(0x1f0)]=_0x333303,_0x1a3c7f['price']=Number(_0x55049f[_0x177ff5(0x1f9)]),_0x1a3c7f[_0x177ff5(0x1e9)]=_0xb74c0d,_0x1a3c7f[_0x177ff5(0x1f2)]=Number(_0x55049f[_0x177ff5(0x1f9)])*_0xb74c0d,_0x1a3c7f['payPlatform']=_0x439312,_0x1a3c7f['channel']=_0x3fa152;const _0x26ed66=await this[_0x177ff5(0x1c6)][_0x177ff5(0x1d7)](_0x1a3c7f);return console[_0x177ff5(0x203)]('order:\x20',_0x26ed66),_0x26ed66;}async[_0x54fcc9(0x1cd)](_0x14e696,_0xdbb949,_0x2a6df3){const _0x56b4b7=_0x54fcc9;return await this['orderEntity'][_0x56b4b7(0x1c2)]({'where':{'userId':_0x14e696},'order':{'id':_0x56b4b7(0x1cf)},'skip':(_0xdbb949-0x1)*_0x2a6df3,'take':_0x2a6df3});}async[_0x54fcc9(0x200)](_0x25423a){const _0x3482b6=_0x54fcc9,{page:_0x1c7a34,size:_0xef4ac9,userId:_0x45cf79,platform:_0x97350,status:_0x2b2cd4}=_0x25423a,_0x59c821={};if(_0x45cf79)_0x59c821[_0x3482b6(0x1d8)]=_0x45cf79;if(_0x97350)_0x59c821['payPlatform']=_0x97350;if(_0x2b2cd4)_0x59c821[_0x3482b6(0x1f6)]=_0x2b2cd4;const [_0x4b5552,_0x5935a0]=await this['orderEntity']['findAndCount']({'order':{'id':'DESC'},'where':_0x59c821,'skip':(_0x1c7a34-0x1)*_0xef4ac9,'take':_0xef4ac9}),_0xbac990=_0x4b5552[_0x3482b6(0x1ba)](_0x215de6=>_0x215de6[_0x3482b6(0x1d8)]),_0x30000b=_0x4b5552[_0x3482b6(0x1ba)](_0x3daafd=>_0x3daafd['goodsId']),_0x66c4bf=await this[_0x3482b6(0x1e6)][_0x3482b6(0x1b9)]({'where':{'id':(0x0,typeorm_2['In'])(_0xbac990)},'select':['id',_0x3482b6(0x1ea),_0x3482b6(0x1f4)]}),_0x3b40a1=await this[_0x3482b6(0x1fc)][_0x3482b6(0x1b9)]({'where':{'id':(0x0,typeorm_2['In'])(_0x30000b)},'select':['id',_0x3482b6(0x1c3),'coverImg',_0x3482b6(0x1b4)]});_0x4b5552['forEach'](_0x4c629c=>{const _0x4692fb=_0x3482b6;_0x4c629c[_0x4692fb(0x1e5)]=_0x66c4bf[_0x4692fb(0x1b9)](_0x51bd91=>_0x51bd91['id']===_0x4c629c[_0x4692fb(0x1d8)]),_0x4c629c[_0x4692fb(0x1f8)]=_0x3b40a1[_0x4692fb(0x1b9)](_0x4ec4d5=>_0x4ec4d5['id']===_0x4c629c[_0x4692fb(0x1f0)]);});const _0x1bbb8e=await this['orderEntity']['createQueryBuilder'](_0x3482b6(0x1d2))[_0x3482b6(0x1fd)](_0x3482b6(0x1b7),{'status':0x1})['select'](_0x3482b6(0x1b6),_0x3482b6(0x1ed))['getRawOne']();return Object[_0x3482b6(0x1b8)]({'rows':_0x4b5552,'count':_0x5935a0},_0x1bbb8e);}async[_0x54fcc9(0x1dc)](_0x2ff2e2){const _0x3a0345=_0x54fcc9,{orderId:_0x47e789}=_0x2ff2e2,_0x1f7c2e=await this[_0x3a0345(0x1c6)][_0x3a0345(0x204)]({'where':{'orderId':_0x47e789}});if(!_0x1f7c2e)throw new common_1[(_0x3a0345(0x1ca))](_0x3a0345(0x1f1),common_1[_0x3a0345(0x1e8)][_0x3a0345(0x1cc)]);return await this[_0x3a0345(0x1c6)][_0x3a0345(0x1e1)]({'orderId':_0x47e789});}async[_0x54fcc9(0x1b5)](){const _0x1044cb=_0x54fcc9;return await this[_0x1044cb(0x1c6)][_0x1044cb(0x1e1)]({'status':0x0});}};OrderService=__decorate([(0x0,common_1[_0x54fcc9(0x1e3)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(order_entity_1[_0x54fcc9(0x1ec)])),__param(0x1,(0x0,typeorm_1[_0x54fcc9(0x1d5)])(cramiPackage_entity_1[_0x54fcc9(0x1bd)])),__param(0x2,(0x0,typeorm_1[_0x54fcc9(0x1d5)])(user_entity_1[_0x54fcc9(0x1bf)])),__metadata(_0x54fcc9(0x1d4),[typeorm_2[_0x54fcc9(0x1e7)],typeorm_2[_0x54fcc9(0x1e7)],typeorm_2[_0x54fcc9(0x1e7)],pay_service_1['PayService'],globalConfig_service_1['GlobalConfigService']])],OrderService),exports[_0x54fcc9(0x1e2)]=OrderService;