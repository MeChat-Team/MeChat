'use strict';const _0x233e66=_0xd7be;(function(_0x4e0a03,_0x357dbc){const _0x46a7ad=_0xd7be,_0x4ffc69=_0x4e0a03();while(!![]){try{const _0x402eee=-parseInt(_0x46a7ad(0x210))/0x1+-parseInt(_0x46a7ad(0x20a))/0x2*(parseInt(_0x46a7ad(0x1c3))/0x3)+-parseInt(_0x46a7ad(0x1d6))/0x4*(-parseInt(_0x46a7ad(0x1ba))/0x5)+-parseInt(_0x46a7ad(0x1dc))/0x6*(parseInt(_0x46a7ad(0x1fe))/0x7)+parseInt(_0x46a7ad(0x1c9))/0x8+parseInt(_0x46a7ad(0x1de))/0x9+parseInt(_0x46a7ad(0x1f1))/0xa;if(_0x402eee===_0x357dbc)break;else _0x4ffc69['push'](_0x4ffc69['shift']());}catch(_0x3bb111){_0x4ffc69['push'](_0x4ffc69['shift']());}}}(_0x2b2b,0xa2fca));function _0xd7be(_0x2c365e,_0xaca1fb){const _0x2b2bef=_0x2b2b();return _0xd7be=function(_0xd7bea4,_0x715c79){_0xd7bea4=_0xd7bea4-0x1ba;let _0x494775=_0x2b2bef[_0xd7bea4];return _0x494775;},_0xd7be(_0x2c365e,_0xaca1fb);}var __decorate=this&&this[_0x233e66(0x1ca)]||function(_0x32d5e7,_0x3916b0,_0x58bb36,_0x548e3a){const _0x817360=_0x233e66;var _0x392efc=arguments[_0x817360(0x201)],_0x4ed7b9=_0x392efc<0x3?_0x3916b0:_0x548e3a===null?_0x548e3a=Object[_0x817360(0x1cb)](_0x3916b0,_0x58bb36):_0x548e3a,_0x471b9d;if(typeof Reflect===_0x817360(0x1f8)&&typeof Reflect['decorate']===_0x817360(0x1bc))_0x4ed7b9=Reflect['decorate'](_0x32d5e7,_0x3916b0,_0x58bb36,_0x548e3a);else{for(var _0x319841=_0x32d5e7[_0x817360(0x201)]-0x1;_0x319841>=0x0;_0x319841--)if(_0x471b9d=_0x32d5e7[_0x319841])_0x4ed7b9=(_0x392efc<0x3?_0x471b9d(_0x4ed7b9):_0x392efc>0x3?_0x471b9d(_0x3916b0,_0x58bb36,_0x4ed7b9):_0x471b9d(_0x3916b0,_0x58bb36))||_0x4ed7b9;}return _0x392efc>0x3&&_0x4ed7b9&&Object[_0x817360(0x204)](_0x3916b0,_0x58bb36,_0x4ed7b9),_0x4ed7b9;},__metadata=this&&this['__metadata']||function(_0xb95e5,_0x1c3e59){const _0x5f4766=_0x233e66;if(typeof Reflect===_0x5f4766(0x1f8)&&typeof Reflect[_0x5f4766(0x1f0)]===_0x5f4766(0x1bc))return Reflect[_0x5f4766(0x1f0)](_0xb95e5,_0x1c3e59);},__param=this&&this[_0x233e66(0x1fc)]||function(_0x4b7736,_0x166640){return function(_0x42646c,_0x26a358){_0x166640(_0x42646c,_0x26a358,_0x4b7736);};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[_0x233e66(0x1d7)]=void 0x0;const user_entity_1=require(_0x233e66(0x1bf)),typeorm_1=require(_0x233e66(0x1d0)),common_1=require(_0x233e66(0x213)),typeorm_2=require(_0x233e66(0x1c5)),order_entity_1=require(_0x233e66(0x1ea)),cramiPackage_entity_1=require(_0x233e66(0x1ff)),utils_1=require(_0x233e66(0x1c0)),pay_service_1=require(_0x233e66(0x1cc)),globalConfig_service_1=require(_0x233e66(0x1eb));function _0x2b2b(){const _0x21019e=['订单不存在!','length','getRawOne','user','defineProperty','order','deleteNotPay','HttpStatus','userInfo','payService','2326290zRxcNh','total_price','SUM(order.price)','delete','UserEntity','count','960142xRWtLp','createOrderId','userEntity','@nestjs/common','Injectable','190EHOrBT','map','function','des','price','./../user/user.entity','../../common/utils','GlobalConfigService','status','3XtrkfG','payPlatform','typeorm','pay','create','findOne','7067168hwAZCi','__decorate','getOwnPropertyDescriptor','../pay/pay.service','userId','createQueryBuilder','message','@nestjs/typeorm','Repository','queryAllOrder','username','OrderEntity','forEach','61868hKWPik','OrderService','globalConfigService','DESC','log','购买失败!','18426VfXwuo','InjectRepository','4129704LVWOSL','query','deleteOrder','order.status\x20=\x20:status','buy','goodsId','name','find','orderEntity','PayService','HttpException','where','./order.entity','../globalConfig/globalConfig.service','CramiPackageEntity','orderId','save','email','metadata','10052200ABCXYM','BAD_REQUEST','design:paramtypes','total','assign','cramiPackageEntity','queryPayType','object','queryByOrderId','order:\x20','套餐不存在!','__param','UNAUTHORIZED','329nUDvmU','../crami/cramiPackage.entity'];_0x2b2b=function(){return _0x21019e;};return _0x2b2b();}let OrderService=class OrderService{constructor(_0x779716,_0x353c02,_0x43f317,_0x49bc44,_0xebe4c){const _0x2615fd=_0x233e66;this[_0x2615fd(0x1e6)]=_0x779716,this[_0x2615fd(0x1f6)]=_0x353c02,this[_0x2615fd(0x212)]=_0x43f317,this[_0x2615fd(0x209)]=_0x49bc44,this[_0x2615fd(0x1d8)]=_0xebe4c;}async[_0x233e66(0x1e2)](_0x183362,_0x480bc4){const _0x5adea5=_0x233e66;try{const {goodsId:_0x4a1be0,count:count=0x1,payType:_0x13e035}=_0x183362,{id:_0x149da2}=_0x480bc4[_0x5adea5(0x203)];if(_0x149da2>0xf4240)throw new common_1['HttpException']('请先注册账号后购买商品！',common_1[_0x5adea5(0x207)][_0x5adea5(0x1fd)]);const _0x3b7eb9=await this[_0x5adea5(0x1c7)](_0x149da2,_0x4a1be0,count,_0x13e035),_0x2bda6f=await this['payService'][_0x5adea5(0x1c6)](_0x149da2,_0x3b7eb9['orderId'],_0x13e035);return Object[_0x5adea5(0x1f5)](Object[_0x5adea5(0x1f5)]({},_0x2bda6f),{'orderId':_0x3b7eb9[_0x5adea5(0x1ed)],'platform':_0x3b7eb9[_0x5adea5(0x1c4)],'total':_0x3b7eb9['total']});}catch(_0x440ac6){if(_0x440ac6['status']===0x191)throw new common_1[(_0x5adea5(0x1e8))](_0x440ac6[_0x5adea5(0x1cf)],common_1[_0x5adea5(0x207)][_0x5adea5(0x1fd)]);throw new common_1[(_0x5adea5(0x1e8))](_0x440ac6[_0x5adea5(0x1cf)]||_0x5adea5(0x1db),common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x233e66(0x1f9)](_0x4e532f,_0x16db7c){const _0x3ebebc=_0x233e66,{id:_0x1b18e5}=_0x4e532f[_0x3ebebc(0x203)],{orderId:_0x245159}=_0x16db7c,_0x396ba8=await this[_0x3ebebc(0x1e6)][_0x3ebebc(0x1c8)]({'where':{'userId':_0x1b18e5,'orderId':_0x245159}});if(!_0x396ba8)throw new common_1[(_0x3ebebc(0x1e8))]('订单不存在!',common_1[_0x3ebebc(0x207)][_0x3ebebc(0x1f2)]);return _0x396ba8;}async['create'](_0x5b0daa,_0x226e16,_0x4bcbf4,_0x1003eb){const _0x5f1ba3=_0x233e66,_0x1fd421=await this[_0x5f1ba3(0x1d8)][_0x5f1ba3(0x1f7)](),_0x52e9b1=await this[_0x5f1ba3(0x1f6)][_0x5f1ba3(0x1c8)]({'where':{'id':_0x226e16}});if(!_0x52e9b1)throw new common_1['HttpException'](_0x5f1ba3(0x1fb),common_1[_0x5f1ba3(0x207)][_0x5f1ba3(0x1f2)]);const _0x58d030={};_0x58d030['orderId']=(0x0,utils_1[_0x5f1ba3(0x211)])(),_0x58d030[_0x5f1ba3(0x1cd)]=_0x5b0daa,_0x58d030[_0x5f1ba3(0x1e3)]=_0x226e16,_0x58d030[_0x5f1ba3(0x1be)]=Number(_0x52e9b1[_0x5f1ba3(0x1be)]),_0x58d030[_0x5f1ba3(0x20f)]=_0x4bcbf4,_0x58d030[_0x5f1ba3(0x1f4)]=Number(_0x52e9b1['price'])*_0x4bcbf4,_0x58d030['payPlatform']=_0x1fd421,_0x58d030['channel']=_0x1003eb;const _0x310b69=await this['orderEntity'][_0x5f1ba3(0x1ee)](_0x58d030);return console[_0x5f1ba3(0x1da)](_0x5f1ba3(0x1fa),_0x310b69),_0x310b69;}async[_0x233e66(0x1df)](_0x1decf5,_0x19f26b,_0x165a0a){const _0xe5842c=_0x233e66;return await this[_0xe5842c(0x1e6)]['findAndCount']({'where':{'userId':_0x1decf5},'order':{'id':_0xe5842c(0x1d9)},'skip':(_0x19f26b-0x1)*_0x165a0a,'take':_0x165a0a});}async[_0x233e66(0x1d2)](_0x5c44d9){const _0x534508=_0x233e66,{page:_0x342edf,size:_0x2c6b2a,userId:_0x1f60d9,platform:_0x2516d6,status:_0x39cc46}=_0x5c44d9,_0x1c8524={};if(_0x1f60d9)_0x1c8524['userId']=_0x1f60d9;if(_0x2516d6)_0x1c8524[_0x534508(0x1c4)]=_0x2516d6;if(_0x39cc46)_0x1c8524[_0x534508(0x1c2)]=_0x39cc46;const [_0x336518,_0x5231b1]=await this[_0x534508(0x1e6)]['findAndCount']({'order':{'id':_0x534508(0x1d9)},'where':_0x1c8524,'skip':(_0x342edf-0x1)*_0x2c6b2a,'take':_0x2c6b2a}),_0x5d39e4=_0x336518[_0x534508(0x1bb)](_0x37083e=>_0x37083e[_0x534508(0x1cd)]),_0x1ea50a=_0x336518['map'](_0x26c30e=>_0x26c30e[_0x534508(0x1e3)]),_0x5efea0=await this[_0x534508(0x212)][_0x534508(0x1e5)]({'where':{'id':(0x0,typeorm_2['In'])(_0x5d39e4)},'select':['id',_0x534508(0x1d3),_0x534508(0x1ef)]}),_0x1c5cf0=await this[_0x534508(0x1f6)][_0x534508(0x1e5)]({'where':{'id':(0x0,typeorm_2['In'])(_0x1ea50a)},'select':['id',_0x534508(0x1e4),'coverImg',_0x534508(0x1bd)]});_0x336518[_0x534508(0x1d5)](_0x2337a7=>{const _0x1f27b0=_0x534508;_0x2337a7[_0x1f27b0(0x208)]=_0x5efea0['find'](_0x1dcd4a=>_0x1dcd4a['id']===_0x2337a7['userId']),_0x2337a7['goodsInfo']=_0x1c5cf0[_0x1f27b0(0x1e5)](_0x566489=>_0x566489['id']===_0x2337a7[_0x1f27b0(0x1e3)]);});const _0x25719a=await this[_0x534508(0x1e6)][_0x534508(0x1ce)](_0x534508(0x205))[_0x534508(0x1e9)](_0x534508(0x1e1),{'status':0x1})['select'](_0x534508(0x20c),_0x534508(0x20b))[_0x534508(0x202)]();return Object[_0x534508(0x1f5)]({'rows':_0x336518,'count':_0x5231b1},_0x25719a);}async[_0x233e66(0x1e0)](_0xf73054){const _0x499354=_0x233e66,{orderId:_0x435fc7}=_0xf73054,_0x2ee8a3=await this[_0x499354(0x1e6)][_0x499354(0x1c8)]({'where':{'orderId':_0x435fc7}});if(!_0x2ee8a3)throw new common_1[(_0x499354(0x1e8))](_0x499354(0x200),common_1['HttpStatus'][_0x499354(0x1f2)]);return await this[_0x499354(0x1e6)][_0x499354(0x20d)]({'orderId':_0x435fc7});}async[_0x233e66(0x206)](){const _0x7c1ed3=_0x233e66;return await this[_0x7c1ed3(0x1e6)][_0x7c1ed3(0x20d)]({'status':0x0});}};OrderService=__decorate([(0x0,common_1[_0x233e66(0x214)])(),__param(0x0,(0x0,typeorm_1[_0x233e66(0x1dd)])(order_entity_1[_0x233e66(0x1d4)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(cramiPackage_entity_1[_0x233e66(0x1ec)])),__param(0x2,(0x0,typeorm_1[_0x233e66(0x1dd)])(user_entity_1[_0x233e66(0x20e)])),__metadata(_0x233e66(0x1f3),[typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2[_0x233e66(0x1d1)],pay_service_1[_0x233e66(0x1e7)],globalConfig_service_1[_0x233e66(0x1c1)]])],OrderService),exports[_0x233e66(0x1d7)]=OrderService;