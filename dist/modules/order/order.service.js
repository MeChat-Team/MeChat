'use strict';function _0x2fb5(){const _0x1d4a5a=['metadata','price','createQueryBuilder','defineProperty','queryByOrderId','InjectRepository','select','status','message','BAD_REQUEST','SUM(order.price)','queryPayType','@nestjs/typeorm','购买失败!','email','total','Repository','order.status\x20=\x20:status','username','query','user','225324hZXCTT','find','2351395roqZYz','订单不存在!','object','delete','getRawOne','function','__decorate','goodsId','decorate','UserEntity','goodsInfo','__param','DESC','map','__metadata','cramiPackageEntity','__esModule','GlobalConfigService','getOwnPropertyDescriptor','assign','套餐不存在!','1138FNjaGH','where','../pay/pay.service','1696LLOhwb','name','2178UvPNKd','PayService','55TYjOON','./order.entity','design:paramtypes','./../user/user.entity','forEach','findOne','channel','UNAUTHORIZED','24327vBsOlX','length','des','orderId','userInfo','coverImg','payService','userEntity','../globalConfig/globalConfig.service','typeorm','HttpException','payPlatform','orderEntity','deleteNotPay','1292640ONMDST','@nestjs/common','globalConfigService','1749956owHzTs','userId','CramiPackageEntity','total_price','647626wjNsKb','12sCKoUn','../../common/utils','pay','count','HttpStatus','buy','create','save','OrderService','order:\x20','../crami/cramiPackage.entity'];_0x2fb5=function(){return _0x1d4a5a;};return _0x2fb5();}const _0x1a7d76=_0x16aa;(function(_0x565232,_0x5bf757){const _0x34b957=_0x16aa,_0x5f2f99=_0x565232();while(!![]){try{const _0x401a6f=parseInt(_0x34b957(0x1c9))/0x1+-parseInt(_0x34b957(0x1e0))/0x2*(parseInt(_0x34b957(0x1e5))/0x3)+-parseInt(_0x34b957(0x200))/0x4+-parseInt(_0x34b957(0x1cb))/0x5*(-parseInt(_0x34b957(0x205))/0x6)+parseInt(_0x34b957(0x204))/0x7+-parseInt(_0x34b957(0x1e3))/0x8*(parseInt(_0x34b957(0x1ef))/0x9)+-parseInt(_0x34b957(0x1fd))/0xa*(-parseInt(_0x34b957(0x1e7))/0xb);if(_0x401a6f===_0x5bf757)break;else _0x5f2f99['push'](_0x5f2f99['shift']());}catch(_0x7b9133){_0x5f2f99['push'](_0x5f2f99['shift']());}}}(_0x2fb5,0x7574d));var __decorate=this&&this[_0x1a7d76(0x1d1)]||function(_0x4e52c6,_0x3c691b,_0x1aeb54,_0x55e51e){const _0x15114b=_0x1a7d76;var _0x4723af=arguments['length'],_0x10d34e=_0x4723af<0x3?_0x3c691b:_0x55e51e===null?_0x55e51e=Object[_0x15114b(0x1dd)](_0x3c691b,_0x1aeb54):_0x55e51e,_0xe7f53d;if(typeof Reflect===_0x15114b(0x1cd)&&typeof Reflect[_0x15114b(0x1d3)]===_0x15114b(0x1d0))_0x10d34e=Reflect[_0x15114b(0x1d3)](_0x4e52c6,_0x3c691b,_0x1aeb54,_0x55e51e);else{for(var _0x24051e=_0x4e52c6[_0x15114b(0x1f0)]-0x1;_0x24051e>=0x0;_0x24051e--)if(_0xe7f53d=_0x4e52c6[_0x24051e])_0x10d34e=(_0x4723af<0x3?_0xe7f53d(_0x10d34e):_0x4723af>0x3?_0xe7f53d(_0x3c691b,_0x1aeb54,_0x10d34e):_0xe7f53d(_0x3c691b,_0x1aeb54))||_0x10d34e;}return _0x4723af>0x3&&_0x10d34e&&Object[_0x15114b(0x1b7)](_0x3c691b,_0x1aeb54,_0x10d34e),_0x10d34e;},__metadata=this&&this[_0x1a7d76(0x1d9)]||function(_0x132a50,_0x4b4eeb){const _0x1759c5=_0x1a7d76;if(typeof Reflect==='object'&&typeof Reflect[_0x1759c5(0x1b4)]===_0x1759c5(0x1d0))return Reflect[_0x1759c5(0x1b4)](_0x132a50,_0x4b4eeb);},__param=this&&this[_0x1a7d76(0x1d6)]||function(_0x33cc1d,_0x59200d){return function(_0x136e59,_0x5c47d9){_0x59200d(_0x136e59,_0x5c47d9,_0x33cc1d);};};Object['defineProperty'](exports,_0x1a7d76(0x1db),{'value':!![]}),exports[_0x1a7d76(0x20d)]=void 0x0;const user_entity_1=require(_0x1a7d76(0x1ea)),typeorm_1=require(_0x1a7d76(0x1c0)),common_1=require(_0x1a7d76(0x1fe)),typeorm_2=require(_0x1a7d76(0x1f8)),order_entity_1=require(_0x1a7d76(0x1e8)),cramiPackage_entity_1=require(_0x1a7d76(0x20f)),utils_1=require(_0x1a7d76(0x206)),pay_service_1=require(_0x1a7d76(0x1e2)),globalConfig_service_1=require(_0x1a7d76(0x1f7));function _0x16aa(_0x3a8bdb,_0x7d79c){const _0x2fb552=_0x2fb5();return _0x16aa=function(_0x16aa95,_0x51c5e7){_0x16aa95=_0x16aa95-0x1b4;let _0x165999=_0x2fb552[_0x16aa95];return _0x165999;},_0x16aa(_0x3a8bdb,_0x7d79c);}let OrderService=class OrderService{constructor(_0x538583,_0xe10f34,_0x4e4325,_0x4d71d9,_0x588201){const _0x292ad0=_0x1a7d76;this[_0x292ad0(0x1fb)]=_0x538583,this[_0x292ad0(0x1da)]=_0xe10f34,this[_0x292ad0(0x1f6)]=_0x4e4325,this[_0x292ad0(0x1f5)]=_0x4d71d9,this[_0x292ad0(0x1ff)]=_0x588201;}async[_0x1a7d76(0x20a)](_0x41ce6e,_0x27700e){const _0x28bc63=_0x1a7d76;try{const {goodsId:_0xd9b3e7,count:count=0x1,payType:_0x22df87}=_0x41ce6e,{id:_0x3b7f23}=_0x27700e[_0x28bc63(0x1c8)];if(_0x3b7f23>0xf4240)throw new common_1[(_0x28bc63(0x1f9))]('请先注册账号后购买商品！',common_1[_0x28bc63(0x209)][_0x28bc63(0x1ee)]);const _0x544391=await this['create'](_0x3b7f23,_0xd9b3e7,count,_0x22df87),_0x41b7f0=await this['payService'][_0x28bc63(0x207)](_0x3b7f23,_0x544391[_0x28bc63(0x1f2)],_0x22df87);return Object[_0x28bc63(0x1de)](Object[_0x28bc63(0x1de)]({},_0x41b7f0),{'orderId':_0x544391['orderId'],'platform':_0x544391['payPlatform'],'total':_0x544391[_0x28bc63(0x1c3)]});}catch(_0x4f4faf){if(_0x4f4faf['status']===0x191)throw new common_1[(_0x28bc63(0x1f9))](_0x4f4faf['message'],common_1[_0x28bc63(0x209)]['UNAUTHORIZED']);throw new common_1['HttpException'](_0x4f4faf[_0x28bc63(0x1bc)]||_0x28bc63(0x1c1),common_1['HttpStatus'][_0x28bc63(0x1bd)]);}}async[_0x1a7d76(0x1b8)](_0x4f31fd,_0x3279a1){const _0x190ad6=_0x1a7d76,{id:_0x4beac1}=_0x4f31fd[_0x190ad6(0x1c8)],{orderId:_0x7c63c1}=_0x3279a1,_0x12002d=await this['orderEntity'][_0x190ad6(0x1ec)]({'where':{'userId':_0x4beac1,'orderId':_0x7c63c1}});if(!_0x12002d)throw new common_1[(_0x190ad6(0x1f9))]('订单不存在!',common_1[_0x190ad6(0x209)][_0x190ad6(0x1bd)]);return _0x12002d;}async[_0x1a7d76(0x20b)](_0xee779b,_0x57f7bb,_0x4d9460,_0x52422d){const _0x3d770a=_0x1a7d76,_0x3aab92=await this[_0x3d770a(0x1ff)][_0x3d770a(0x1bf)](),_0x57ab2c=await this['cramiPackageEntity']['findOne']({'where':{'id':_0x57f7bb}});if(!_0x57ab2c)throw new common_1['HttpException'](_0x3d770a(0x1df),common_1['HttpStatus'][_0x3d770a(0x1bd)]);const _0x37d4ea={};_0x37d4ea[_0x3d770a(0x1f2)]=(0x0,utils_1['createOrderId'])(),_0x37d4ea['userId']=_0xee779b,_0x37d4ea[_0x3d770a(0x1d2)]=_0x57f7bb,_0x37d4ea[_0x3d770a(0x1b5)]=Number(_0x57ab2c[_0x3d770a(0x1b5)]),_0x37d4ea[_0x3d770a(0x208)]=_0x4d9460,_0x37d4ea[_0x3d770a(0x1c3)]=Number(_0x57ab2c[_0x3d770a(0x1b5)])*_0x4d9460,_0x37d4ea[_0x3d770a(0x1fa)]=_0x3aab92,_0x37d4ea[_0x3d770a(0x1ed)]=_0x52422d;const _0x35ea43=await this[_0x3d770a(0x1fb)][_0x3d770a(0x20c)](_0x37d4ea);return console['log'](_0x3d770a(0x20e),_0x35ea43),_0x35ea43;}async[_0x1a7d76(0x1c7)](_0x1c0f1d,_0x57577d,_0x21437c){const _0x495ef3=_0x1a7d76;return await this['orderEntity']['findAndCount']({'where':{'userId':_0x1c0f1d},'order':{'id':_0x495ef3(0x1d7)},'skip':(_0x57577d-0x1)*_0x21437c,'take':_0x21437c});}async['queryAllOrder'](_0x36849d){const _0x1394ff=_0x1a7d76,{page:_0x29ecd2,size:_0x386034,userId:_0x2879ff,platform:_0x2419e3,status:_0x24f16e}=_0x36849d,_0x416d12={};if(_0x2879ff)_0x416d12[_0x1394ff(0x201)]=_0x2879ff;if(_0x2419e3)_0x416d12['payPlatform']=_0x2419e3;if(_0x24f16e)_0x416d12[_0x1394ff(0x1bb)]=_0x24f16e;const [_0x365690,_0xdd21ad]=await this[_0x1394ff(0x1fb)]['findAndCount']({'order':{'id':'DESC'},'where':_0x416d12,'skip':(_0x29ecd2-0x1)*_0x386034,'take':_0x386034}),_0x543b6e=_0x365690['map'](_0x2fcf9b=>_0x2fcf9b[_0x1394ff(0x201)]),_0x316a5b=_0x365690[_0x1394ff(0x1d8)](_0x54237c=>_0x54237c['goodsId']),_0x4aaab8=await this['userEntity'][_0x1394ff(0x1ca)]({'where':{'id':(0x0,typeorm_2['In'])(_0x543b6e)},'select':['id',_0x1394ff(0x1c6),_0x1394ff(0x1c2)]}),_0x57bddc=await this[_0x1394ff(0x1da)][_0x1394ff(0x1ca)]({'where':{'id':(0x0,typeorm_2['In'])(_0x316a5b)},'select':['id',_0x1394ff(0x1e4),_0x1394ff(0x1f4),_0x1394ff(0x1f1)]});_0x365690[_0x1394ff(0x1eb)](_0x531540=>{const _0x8a3af7=_0x1394ff;_0x531540[_0x8a3af7(0x1f3)]=_0x4aaab8[_0x8a3af7(0x1ca)](_0xd95e58=>_0xd95e58['id']===_0x531540[_0x8a3af7(0x201)]),_0x531540[_0x8a3af7(0x1d5)]=_0x57bddc[_0x8a3af7(0x1ca)](_0x2fae7a=>_0x2fae7a['id']===_0x531540['goodsId']);});const _0x76ebf6=await this[_0x1394ff(0x1fb)][_0x1394ff(0x1b6)]('order')[_0x1394ff(0x1e1)](_0x1394ff(0x1c5),{'status':0x1})[_0x1394ff(0x1ba)](_0x1394ff(0x1be),_0x1394ff(0x203))[_0x1394ff(0x1cf)]();return Object[_0x1394ff(0x1de)]({'rows':_0x365690,'count':_0xdd21ad},_0x76ebf6);}async['deleteOrder'](_0x429c18){const _0x29a2a4=_0x1a7d76,{orderId:_0x4d26fa}=_0x429c18,_0x346b34=await this['orderEntity']['findOne']({'where':{'orderId':_0x4d26fa}});if(!_0x346b34)throw new common_1[(_0x29a2a4(0x1f9))](_0x29a2a4(0x1cc),common_1[_0x29a2a4(0x209)]['BAD_REQUEST']);return await this[_0x29a2a4(0x1fb)][_0x29a2a4(0x1ce)]({'orderId':_0x4d26fa});}async[_0x1a7d76(0x1fc)](){const _0x38cf9f=_0x1a7d76;return await this[_0x38cf9f(0x1fb)]['delete']({'status':0x0});}};OrderService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(order_entity_1['OrderEntity'])),__param(0x1,(0x0,typeorm_1[_0x1a7d76(0x1b9)])(cramiPackage_entity_1[_0x1a7d76(0x202)])),__param(0x2,(0x0,typeorm_1[_0x1a7d76(0x1b9)])(user_entity_1[_0x1a7d76(0x1d4)])),__metadata(_0x1a7d76(0x1e9),[typeorm_2['Repository'],typeorm_2[_0x1a7d76(0x1c4)],typeorm_2[_0x1a7d76(0x1c4)],pay_service_1[_0x1a7d76(0x1e6)],globalConfig_service_1[_0x1a7d76(0x1dc)]])],OrderService),exports[_0x1a7d76(0x20d)]=OrderService;