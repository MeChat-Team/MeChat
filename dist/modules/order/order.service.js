'use strict';const _0xc534f0=_0x4a06;(function(_0x2bbfd5,_0x39dfb2){const _0x1f0ed0=_0x4a06,_0xed4f01=_0x2bbfd5();while(!![]){try{const _0x3ee041=parseInt(_0x1f0ed0(0x128))/0x1*(-parseInt(_0x1f0ed0(0xe7))/0x2)+parseInt(_0x1f0ed0(0xd1))/0x3+-parseInt(_0x1f0ed0(0xe5))/0x4*(parseInt(_0x1f0ed0(0x11a))/0x5)+parseInt(_0x1f0ed0(0x113))/0x6*(parseInt(_0x1f0ed0(0x101))/0x7)+parseInt(_0x1f0ed0(0x10a))/0x8*(-parseInt(_0x1f0ed0(0xfb))/0x9)+-parseInt(_0x1f0ed0(0xfe))/0xa*(parseInt(_0x1f0ed0(0x104))/0xb)+-parseInt(_0x1f0ed0(0x112))/0xc*(-parseInt(_0x1f0ed0(0x110))/0xd);if(_0x3ee041===_0x39dfb2)break;else _0xed4f01['push'](_0xed4f01['shift']());}catch(_0x17cb8b){_0xed4f01['push'](_0xed4f01['shift']());}}}(_0x1b46,0x4963d));var __decorate=this&&this[_0xc534f0(0x117)]||function(_0x569154,_0x3045e9,_0x39f754,_0xecd408){const _0x3d2220=_0xc534f0;var _0x30a12e=arguments[_0x3d2220(0xda)],_0x23099f=_0x30a12e<0x3?_0x3045e9:_0xecd408===null?_0xecd408=Object[_0x3d2220(0xe8)](_0x3045e9,_0x39f754):_0xecd408,_0x1786d0;if(typeof Reflect===_0x3d2220(0x121)&&typeof Reflect[_0x3d2220(0xf6)]===_0x3d2220(0xe3))_0x23099f=Reflect[_0x3d2220(0xf6)](_0x569154,_0x3045e9,_0x39f754,_0xecd408);else{for(var _0x3051b7=_0x569154['length']-0x1;_0x3051b7>=0x0;_0x3051b7--)if(_0x1786d0=_0x569154[_0x3051b7])_0x23099f=(_0x30a12e<0x3?_0x1786d0(_0x23099f):_0x30a12e>0x3?_0x1786d0(_0x3045e9,_0x39f754,_0x23099f):_0x1786d0(_0x3045e9,_0x39f754))||_0x23099f;}return _0x30a12e>0x3&&_0x23099f&&Object[_0x3d2220(0xfa)](_0x3045e9,_0x39f754,_0x23099f),_0x23099f;},__metadata=this&&this['__metadata']||function(_0x523917,_0x273d52){const _0xc74f43=_0xc534f0;if(typeof Reflect===_0xc74f43(0x121)&&typeof Reflect[_0xc74f43(0x107)]===_0xc74f43(0xe3))return Reflect[_0xc74f43(0x107)](_0x523917,_0x273d52);},__param=this&&this[_0xc534f0(0x10e)]||function(_0x3207a7,_0xaec180){return function(_0x22a33d,_0x5ad9cd){_0xaec180(_0x22a33d,_0x5ad9cd,_0x3207a7);};};function _0x4a06(_0x4cd979,_0x2b4a8e){const _0x1b465f=_0x1b46();return _0x4a06=function(_0x4a061a,_0x133da9){_0x4a061a=_0x4a061a-0xd0;let _0x38e210=_0x1b465f[_0x4a061a];return _0x38e210;},_0x4a06(_0x4cd979,_0x2b4a8e);}Object[_0xc534f0(0xfa)](exports,_0xc534f0(0xdb),{'value':!![]}),exports[_0xc534f0(0xe9)]=void 0x0;const user_entity_1=require('./../user/user.entity'),typeorm_1=require(_0xc534f0(0x123)),common_1=require(_0xc534f0(0xf8)),typeorm_2=require(_0xc534f0(0x10f)),order_entity_1=require(_0xc534f0(0xed)),cramiPackage_entity_1=require(_0xc534f0(0xec)),utils_1=require(_0xc534f0(0xe1)),pay_service_1=require(_0xc534f0(0x10b)),globalConfig_service_1=require('../globalConfig/globalConfig.service');function _0x1b46(){const _0xa82520=['metadata','order:\x20','user','8kWlPNK','../pay/pay.service','coverImg','buy','__param','typeorm','68939LrPVCO','deleteOrder','1308TTAyWv','2436uDNUfS','请先注册账号后购买商品！','Injectable','orderId','__decorate','购买失败!','Repository','230745uChLzF','name','findOne','message','套餐不存在!','cramiPackageEntity','orderEntity','object','PayService','@nestjs/typeorm','HttpStatus','username','goodsId','forEach','1pJCbWW','getRawOne','DESC','1519194ePbHuC','design:paramtypes','total','BAD_REQUEST','globalConfigService','email','payService','where','channel','length','__esModule','findAndCount','price','createQueryBuilder','InjectRepository','userId','../../common/utils','select','function','map','12sgGBPS','create','346342vzxgtH','getOwnPropertyDescriptor','OrderService','assign','log','../crami/cramiPackage.entity','./order.entity','goodsInfo','total_price','queryAllOrder','SUM(order.price)','UserEntity','UNAUTHORIZED','status','queryByOrderId','decorate','deleteNotPay','@nestjs/common','delete','defineProperty','4164687kuVXDF','payPlatform','HttpException','50DbowSN','order','find','5257NCmnUb','des','order.status\x20=\x20:status','691603ZhNCut','save','count'];_0x1b46=function(){return _0xa82520;};return _0x1b46();}let OrderService=class OrderService{constructor(_0x3588b6,_0x1e8045,_0x57a200,_0x483e1c,_0x2b80da){const _0x38b536=_0xc534f0;this[_0x38b536(0x120)]=_0x3588b6,this[_0x38b536(0x11f)]=_0x1e8045,this['userEntity']=_0x57a200,this[_0x38b536(0xd7)]=_0x483e1c,this[_0x38b536(0xd5)]=_0x2b80da;}async[_0xc534f0(0x10d)](_0x343ebd,_0x3bb937){const _0x273eb3=_0xc534f0;try{const {goodsId:_0x7341b1,count:count=0x1,payType:_0x8e11fa}=_0x343ebd,{id:_0x3b46f6}=_0x3bb937[_0x273eb3(0x109)];if(_0x3b46f6>0xf4240)throw new common_1['HttpException'](_0x273eb3(0x114),common_1[_0x273eb3(0x124)][_0x273eb3(0xf3)]);const _0x3936bf=await this['create'](_0x3b46f6,_0x7341b1,count,_0x8e11fa),_0x2c7802=await this[_0x273eb3(0xd7)]['pay'](_0x3b46f6,_0x3936bf['orderId'],_0x8e11fa);return Object[_0x273eb3(0xea)](Object[_0x273eb3(0xea)]({},_0x2c7802),{'orderId':_0x3936bf[_0x273eb3(0x116)],'platform':_0x3936bf[_0x273eb3(0xfc)],'total':_0x3936bf[_0x273eb3(0xd3)]});}catch(_0xd54085){if(_0xd54085[_0x273eb3(0xf4)]===0x191)throw new common_1[(_0x273eb3(0xfd))](_0xd54085[_0x273eb3(0x11d)],common_1[_0x273eb3(0x124)][_0x273eb3(0xf3)]);throw new common_1['HttpException'](_0xd54085[_0x273eb3(0x11d)]||_0x273eb3(0x118),common_1[_0x273eb3(0x124)][_0x273eb3(0xd4)]);}}async[_0xc534f0(0xf5)](_0x415958,_0x310444){const _0x365cf1=_0xc534f0,{id:_0x379171}=_0x415958[_0x365cf1(0x109)],{orderId:_0x173ca2}=_0x310444,_0x13181a=await this['orderEntity'][_0x365cf1(0x11c)]({'where':{'userId':_0x379171,'orderId':_0x173ca2}});if(!_0x13181a)throw new common_1[(_0x365cf1(0xfd))]('订单不存在!',common_1[_0x365cf1(0x124)][_0x365cf1(0xd4)]);return _0x13181a;}async[_0xc534f0(0xe6)](_0x170604,_0x116e7c,_0x2b0e45,_0x2e0ec2){const _0x5e0628=_0xc534f0,_0x163c4e=await this[_0x5e0628(0xd5)]['queryPayType'](),_0x1dca9f=await this['cramiPackageEntity']['findOne']({'where':{'id':_0x116e7c}});if(!_0x1dca9f)throw new common_1['HttpException'](_0x5e0628(0x11e),common_1[_0x5e0628(0x124)][_0x5e0628(0xd4)]);const _0x553aa0={};_0x553aa0['orderId']=(0x0,utils_1['createOrderId'])(),_0x553aa0['userId']=_0x170604,_0x553aa0[_0x5e0628(0x126)]=_0x116e7c,_0x553aa0['price']=Number(_0x1dca9f[_0x5e0628(0xdd)]),_0x553aa0[_0x5e0628(0x106)]=_0x2b0e45,_0x553aa0[_0x5e0628(0xd3)]=Number(_0x1dca9f['price'])*_0x2b0e45,_0x553aa0[_0x5e0628(0xfc)]=_0x163c4e,_0x553aa0[_0x5e0628(0xd9)]=_0x2e0ec2;const _0x510771=await this[_0x5e0628(0x120)][_0x5e0628(0x105)](_0x553aa0);return console[_0x5e0628(0xeb)](_0x5e0628(0x108),_0x510771),_0x510771;}async['query'](_0x54b3ba,_0x1876d3,_0x59b551){const _0x1bb018=_0xc534f0;return await this['orderEntity']['findAndCount']({'where':{'userId':_0x54b3ba},'order':{'id':_0x1bb018(0xd0)},'skip':(_0x1876d3-0x1)*_0x59b551,'take':_0x59b551});}async[_0xc534f0(0xf0)](_0x220a56){const _0xdce7d8=_0xc534f0,{page:_0x2f421c,size:_0x159e89,userId:_0x547bd4,platform:_0x52d6c8,status:_0x3b71bf}=_0x220a56,_0xdd2066={};if(_0x547bd4)_0xdd2066[_0xdce7d8(0xe0)]=_0x547bd4;if(_0x52d6c8)_0xdd2066[_0xdce7d8(0xfc)]=_0x52d6c8;if(_0x3b71bf)_0xdd2066[_0xdce7d8(0xf4)]=_0x3b71bf;const [_0x2f316d,_0x5a3030]=await this['orderEntity'][_0xdce7d8(0xdc)]({'order':{'id':_0xdce7d8(0xd0)},'where':_0xdd2066,'skip':(_0x2f421c-0x1)*_0x159e89,'take':_0x159e89}),_0x550739=_0x2f316d[_0xdce7d8(0xe4)](_0x275cfc=>_0x275cfc[_0xdce7d8(0xe0)]),_0x3773eb=_0x2f316d[_0xdce7d8(0xe4)](_0x47826e=>_0x47826e[_0xdce7d8(0x126)]),_0x1c90cb=await this['userEntity']['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x550739)},'select':['id',_0xdce7d8(0x125),_0xdce7d8(0xd6)]}),_0x4dd88a=await this['cramiPackageEntity'][_0xdce7d8(0x100)]({'where':{'id':(0x0,typeorm_2['In'])(_0x3773eb)},'select':['id',_0xdce7d8(0x11b),_0xdce7d8(0x10c),_0xdce7d8(0x102)]});_0x2f316d[_0xdce7d8(0x127)](_0xc9f12e=>{const _0x5847e5=_0xdce7d8;_0xc9f12e['userInfo']=_0x1c90cb[_0x5847e5(0x100)](_0xfac51f=>_0xfac51f['id']===_0xc9f12e[_0x5847e5(0xe0)]),_0xc9f12e[_0x5847e5(0xee)]=_0x4dd88a[_0x5847e5(0x100)](_0x484526=>_0x484526['id']===_0xc9f12e[_0x5847e5(0x126)]);});const _0x2b7490=await this[_0xdce7d8(0x120)][_0xdce7d8(0xde)](_0xdce7d8(0xff))[_0xdce7d8(0xd8)](_0xdce7d8(0x103),{'status':0x1})[_0xdce7d8(0xe2)](_0xdce7d8(0xf1),_0xdce7d8(0xef))[_0xdce7d8(0x129)]();return Object[_0xdce7d8(0xea)]({'rows':_0x2f316d,'count':_0x5a3030},_0x2b7490);}async[_0xc534f0(0x111)](_0x5eeba4){const _0x4cd713=_0xc534f0,{orderId:_0x1ee86a}=_0x5eeba4,_0xc35edb=await this[_0x4cd713(0x120)][_0x4cd713(0x11c)]({'where':{'orderId':_0x1ee86a}});if(!_0xc35edb)throw new common_1['HttpException']('订单不存在!',common_1[_0x4cd713(0x124)][_0x4cd713(0xd4)]);return await this['orderEntity'][_0x4cd713(0xf9)]({'orderId':_0x1ee86a});}async[_0xc534f0(0xf7)](){const _0x4c3053=_0xc534f0;return await this[_0x4c3053(0x120)][_0x4c3053(0xf9)]({'status':0x0});}};OrderService=__decorate([(0x0,common_1[_0xc534f0(0x115)])(),__param(0x0,(0x0,typeorm_1[_0xc534f0(0xdf)])(order_entity_1['OrderEntity'])),__param(0x1,(0x0,typeorm_1[_0xc534f0(0xdf)])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x2,(0x0,typeorm_1[_0xc534f0(0xdf)])(user_entity_1[_0xc534f0(0xf2)])),__metadata(_0xc534f0(0xd2),[typeorm_2[_0xc534f0(0x119)],typeorm_2['Repository'],typeorm_2['Repository'],pay_service_1[_0xc534f0(0x122)],globalConfig_service_1['GlobalConfigService']])],OrderService),exports[_0xc534f0(0xe9)]=OrderService;