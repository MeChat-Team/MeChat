'use strict';const _0x4e9ef3=_0x5ef9;function _0x5ef9(_0x6faf4b,_0x532662){const _0x3b3f7a=_0x3b3f();return _0x5ef9=function(_0x5ef9f7,_0xe6f909){_0x5ef9f7=_0x5ef9f7-0x1b4;let _0x203bb9=_0x3b3f7a[_0x5ef9f7];return _0x203bb9;},_0x5ef9(_0x6faf4b,_0x532662);}(function(_0x2b5e8d,_0x291f39){const _0x18e0d6=_0x5ef9,_0x3fbaae=_0x2b5e8d();while(!![]){try{const _0x5e3321=parseInt(_0x18e0d6(0x203))/0x1+parseInt(_0x18e0d6(0x1fb))/0x2+parseInt(_0x18e0d6(0x208))/0x3*(-parseInt(_0x18e0d6(0x1f4))/0x4)+parseInt(_0x18e0d6(0x1d8))/0x5+parseInt(_0x18e0d6(0x1f2))/0x6*(parseInt(_0x18e0d6(0x1be))/0x7)+parseInt(_0x18e0d6(0x1ef))/0x8*(parseInt(_0x18e0d6(0x1d3))/0x9)+-parseInt(_0x18e0d6(0x1f9))/0xa*(parseInt(_0x18e0d6(0x1cf))/0xb);if(_0x5e3321===_0x291f39)break;else _0x3fbaae['push'](_0x3fbaae['shift']());}catch(_0xc1eaaa){_0x3fbaae['push'](_0x3fbaae['shift']());}}}(_0x3b3f,0xc5885));function _0x3b3f(){const _0x476652=['query','../crami/cramiPackage.entity','220746HzaRlY','请先注册账号后购买商品！','globalConfigService','HttpException','userInfo','email','create','des','message','@nestjs/common','createQueryBuilder','status','176078zYCqfO','./order.entity','UserEntity','../../common/utils','createOrderId','defineProperty','order:\x20','orderId','forEach','decorate','delete','订单不存在!','__metadata','price','order','CramiPackageEntity','findAndCount','22GtzObE','assign','PayService','total','382221nALsrt','__esModule','../globalConfig/globalConfig.service','buy','InjectRepository','6614470kxylkc','userEntity','where','goodsId','payService','metadata','DESC','select','OrderService','../pay/pay.service','queryAllOrder','queryByOrderId','UNAUTHORIZED','getRawOne','user','find','@nestjs/typeorm','payPlatform','HttpStatus','BAD_REQUEST','orderEntity','pay','Repository','56wtVZCx','findOne','username','72RBqQHD','typeorm','60MgAvvy','套餐不存在!','count','object','getOwnPropertyDescriptor','9206770LAEUWO','length','2518686UTuPzv','goodsInfo','SUM(order.price)','cramiPackageEntity','log','order.status\x20=\x20:status','__param','OrderEntity','572809TszKHs','userId','function'];_0x3b3f=function(){return _0x476652;};return _0x3b3f();}var __decorate=this&&this['__decorate']||function(_0x30b507,_0x2cbf83,_0x3778c0,_0x546186){const _0x3d2132=_0x5ef9;var _0xf3c79a=arguments[_0x3d2132(0x1fa)],_0x3125a0=_0xf3c79a<0x3?_0x2cbf83:_0x546186===null?_0x546186=Object[_0x3d2132(0x1f8)](_0x2cbf83,_0x3778c0):_0x546186,_0x1d612d;if(typeof Reflect===_0x3d2132(0x1f7)&&typeof Reflect[_0x3d2132(0x1c7)]===_0x3d2132(0x205))_0x3125a0=Reflect[_0x3d2132(0x1c7)](_0x30b507,_0x2cbf83,_0x3778c0,_0x546186);else{for(var _0x427fda=_0x30b507[_0x3d2132(0x1fa)]-0x1;_0x427fda>=0x0;_0x427fda--)if(_0x1d612d=_0x30b507[_0x427fda])_0x3125a0=(_0xf3c79a<0x3?_0x1d612d(_0x3125a0):_0xf3c79a>0x3?_0x1d612d(_0x2cbf83,_0x3778c0,_0x3125a0):_0x1d612d(_0x2cbf83,_0x3778c0))||_0x3125a0;}return _0xf3c79a>0x3&&_0x3125a0&&Object[_0x3d2132(0x1c3)](_0x2cbf83,_0x3778c0,_0x3125a0),_0x3125a0;},__metadata=this&&this[_0x4e9ef3(0x1ca)]||function(_0x2b81d9,_0x50b646){const _0x2dad88=_0x4e9ef3;if(typeof Reflect==='object'&&typeof Reflect[_0x2dad88(0x1dd)]===_0x2dad88(0x205))return Reflect[_0x2dad88(0x1dd)](_0x2b81d9,_0x50b646);},__param=this&&this[_0x4e9ef3(0x201)]||function(_0x53e1bc,_0x15264e){return function(_0x23af3c,_0x202fdc){_0x15264e(_0x23af3c,_0x202fdc,_0x53e1bc);};};Object[_0x4e9ef3(0x1c3)](exports,_0x4e9ef3(0x1d4),{'value':!![]}),exports['OrderService']=void 0x0;const user_entity_1=require('./../user/user.entity'),typeorm_1=require(_0x4e9ef3(0x1e8)),common_1=require(_0x4e9ef3(0x1bb)),typeorm_2=require(_0x4e9ef3(0x1f3)),order_entity_1=require(_0x4e9ef3(0x1bf)),cramiPackage_entity_1=require(_0x4e9ef3(0x207)),utils_1=require(_0x4e9ef3(0x1c1)),pay_service_1=require(_0x4e9ef3(0x1e1)),globalConfig_service_1=require(_0x4e9ef3(0x1d5));let OrderService=class OrderService{constructor(_0x133efd,_0x565b99,_0x282e30,_0xb2ba29,_0x1d8bd3){const _0x5e886d=_0x4e9ef3;this[_0x5e886d(0x1ec)]=_0x133efd,this[_0x5e886d(0x1fe)]=_0x565b99,this[_0x5e886d(0x1d9)]=_0x282e30,this[_0x5e886d(0x1dc)]=_0xb2ba29,this[_0x5e886d(0x1b4)]=_0x1d8bd3;}async[_0x4e9ef3(0x1d6)](_0x2fe317,_0x20237f){const _0x4aa2b2=_0x4e9ef3;try{const {goodsId:_0x17c97c,count:count=0x1,payType:_0x2f15c8}=_0x2fe317,{id:_0x3bd2b3}=_0x20237f[_0x4aa2b2(0x1e6)];if(_0x3bd2b3>0xf4240)throw new common_1[(_0x4aa2b2(0x1b5))](_0x4aa2b2(0x209),common_1[_0x4aa2b2(0x1ea)][_0x4aa2b2(0x1e4)]);const _0x366194=await this[_0x4aa2b2(0x1b8)](_0x3bd2b3,_0x17c97c,count,_0x2f15c8),_0xc99398=await this[_0x4aa2b2(0x1dc)][_0x4aa2b2(0x1ed)](_0x3bd2b3,_0x366194[_0x4aa2b2(0x1c5)],_0x2f15c8);return Object[_0x4aa2b2(0x1d0)](Object[_0x4aa2b2(0x1d0)]({},_0xc99398),{'orderId':_0x366194[_0x4aa2b2(0x1c5)],'platform':_0x366194[_0x4aa2b2(0x1e9)],'total':_0x366194[_0x4aa2b2(0x1d2)]});}catch(_0xce2e5a){if(_0xce2e5a['status']===0x191)throw new common_1[(_0x4aa2b2(0x1b5))](_0xce2e5a[_0x4aa2b2(0x1ba)],common_1[_0x4aa2b2(0x1ea)]['UNAUTHORIZED']);throw new common_1[(_0x4aa2b2(0x1b5))](_0xce2e5a['message']||'购买失败!',common_1['HttpStatus'][_0x4aa2b2(0x1eb)]);}}async[_0x4e9ef3(0x1e3)](_0x2aa46d,_0x5f3f4c){const _0x4f8eac=_0x4e9ef3,{id:_0xfe83fc}=_0x2aa46d['user'],{orderId:_0x14c820}=_0x5f3f4c,_0x2b8adf=await this[_0x4f8eac(0x1ec)][_0x4f8eac(0x1f0)]({'where':{'userId':_0xfe83fc,'orderId':_0x14c820}});if(!_0x2b8adf)throw new common_1[(_0x4f8eac(0x1b5))](_0x4f8eac(0x1c9),common_1[_0x4f8eac(0x1ea)]['BAD_REQUEST']);return _0x2b8adf;}async[_0x4e9ef3(0x1b8)](_0x687bed,_0x1648c1,_0x2309fe,_0x161538){const _0x2e5f43=_0x4e9ef3,_0x24acdf=await this['globalConfigService']['queryPayType'](),_0xf2c33e=await this[_0x2e5f43(0x1fe)]['findOne']({'where':{'id':_0x1648c1}});if(!_0xf2c33e)throw new common_1[(_0x2e5f43(0x1b5))](_0x2e5f43(0x1f5),common_1[_0x2e5f43(0x1ea)][_0x2e5f43(0x1eb)]);const _0x8f668f={};_0x8f668f['orderId']=(0x0,utils_1[_0x2e5f43(0x1c2)])(),_0x8f668f['userId']=_0x687bed,_0x8f668f['goodsId']=_0x1648c1,_0x8f668f[_0x2e5f43(0x1cb)]=Number(_0xf2c33e[_0x2e5f43(0x1cb)]),_0x8f668f[_0x2e5f43(0x1f6)]=_0x2309fe,_0x8f668f[_0x2e5f43(0x1d2)]=Number(_0xf2c33e['price'])*_0x2309fe,_0x8f668f[_0x2e5f43(0x1e9)]=_0x24acdf,_0x8f668f['channel']=_0x161538;const _0x217fc6=await this['orderEntity']['save'](_0x8f668f);return console[_0x2e5f43(0x1ff)](_0x2e5f43(0x1c4),_0x217fc6),_0x217fc6;}async[_0x4e9ef3(0x206)](_0x1ad949,_0x40867f,_0x455c4b){const _0x9e698d=_0x4e9ef3;return await this[_0x9e698d(0x1ec)]['findAndCount']({'where':{'userId':_0x1ad949},'order':{'id':'DESC'},'skip':(_0x40867f-0x1)*_0x455c4b,'take':_0x455c4b});}async[_0x4e9ef3(0x1e2)](_0x39c97c){const _0x114514=_0x4e9ef3,{page:_0x1a5664,size:_0x179144,userId:_0x98ae08,platform:_0x1c7a4a,status:_0x1b620f}=_0x39c97c,_0x6b4fa5={};if(_0x98ae08)_0x6b4fa5[_0x114514(0x204)]=_0x98ae08;if(_0x1c7a4a)_0x6b4fa5[_0x114514(0x1e9)]=_0x1c7a4a;if(_0x1b620f)_0x6b4fa5[_0x114514(0x1bd)]=_0x1b620f;const [_0x2249fa,_0x1240df]=await this[_0x114514(0x1ec)][_0x114514(0x1ce)]({'order':{'id':_0x114514(0x1de)},'where':_0x6b4fa5,'skip':(_0x1a5664-0x1)*_0x179144,'take':_0x179144}),_0x4f4bf4=_0x2249fa['map'](_0x412010=>_0x412010['userId']),_0x10fc06=_0x2249fa['map'](_0x4e6e58=>_0x4e6e58[_0x114514(0x1db)]),_0x420e98=await this['userEntity'][_0x114514(0x1e7)]({'where':{'id':(0x0,typeorm_2['In'])(_0x4f4bf4)},'select':['id',_0x114514(0x1f1),_0x114514(0x1b7)]}),_0x2afbd0=await this['cramiPackageEntity']['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x10fc06)},'select':['id','name','coverImg',_0x114514(0x1b9)]});_0x2249fa[_0x114514(0x1c6)](_0x58a251=>{const _0x37d4d0=_0x114514;_0x58a251[_0x37d4d0(0x1b6)]=_0x420e98[_0x37d4d0(0x1e7)](_0x3c5cda=>_0x3c5cda['id']===_0x58a251[_0x37d4d0(0x204)]),_0x58a251[_0x37d4d0(0x1fc)]=_0x2afbd0[_0x37d4d0(0x1e7)](_0x3e4677=>_0x3e4677['id']===_0x58a251[_0x37d4d0(0x1db)]);});const _0x165157=await this[_0x114514(0x1ec)][_0x114514(0x1bc)](_0x114514(0x1cc))[_0x114514(0x1da)](_0x114514(0x200),{'status':0x1})[_0x114514(0x1df)](_0x114514(0x1fd),'total_price')[_0x114514(0x1e5)]();return Object[_0x114514(0x1d0)]({'rows':_0x2249fa,'count':_0x1240df},_0x165157);}async['deleteOrder'](_0x13a841){const _0x578c83=_0x4e9ef3,{orderId:_0xed95f7}=_0x13a841,_0x1ef4db=await this[_0x578c83(0x1ec)][_0x578c83(0x1f0)]({'where':{'orderId':_0xed95f7}});if(!_0x1ef4db)throw new common_1[(_0x578c83(0x1b5))](_0x578c83(0x1c9),common_1['HttpStatus'][_0x578c83(0x1eb)]);return await this['orderEntity'][_0x578c83(0x1c8)]({'orderId':_0xed95f7});}async['deleteNotPay'](){const _0x218801=_0x4e9ef3;return await this[_0x218801(0x1ec)][_0x218801(0x1c8)]({'status':0x0});}};OrderService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(order_entity_1[_0x4e9ef3(0x202)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(cramiPackage_entity_1[_0x4e9ef3(0x1cd)])),__param(0x2,(0x0,typeorm_1[_0x4e9ef3(0x1d7)])(user_entity_1[_0x4e9ef3(0x1c0)])),__metadata('design:paramtypes',[typeorm_2[_0x4e9ef3(0x1ee)],typeorm_2[_0x4e9ef3(0x1ee)],typeorm_2[_0x4e9ef3(0x1ee)],pay_service_1[_0x4e9ef3(0x1d1)],globalConfig_service_1['GlobalConfigService']])],OrderService),exports[_0x4e9ef3(0x1e0)]=OrderService;