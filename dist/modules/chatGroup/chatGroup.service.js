'use strict';const _0x449ffd=_0x3a14;(function(_0x20520f,_0xb9acd6){const _0x379930=_0x3a14,_0x2d1e63=_0x20520f();while(!![]){try{const _0x561381=parseInt(_0x379930(0xbb))/0x1+parseInt(_0x379930(0xf1))/0x2+parseInt(_0x379930(0x114))/0x3+-parseInt(_0x379930(0xc3))/0x4*(parseInt(_0x379930(0xc2))/0x5)+parseInt(_0x379930(0xbc))/0x6+-parseInt(_0x379930(0xc1))/0x7+parseInt(_0x379930(0xcd))/0x8;if(_0x561381===_0xb9acd6)break;else _0x2d1e63['push'](_0x2d1e63['shift']());}catch(_0xfbf9b4){_0x2d1e63['push'](_0x2d1e63['shift']());}}}(_0x1bcd,0x641c8));function _0x1bcd(){const _0x1e0646=['ChatGroupService','getGroupInfoFromId','undefined','非法操作、您在使用一个不存在的应用！','hasOwnProperty','1201204pThJIb','filter','../app/app.entity','PDF\x20解析失败:','from','modelInfo','@nestjs/typeorm','affected','非法操作、您在使用一个未启用的应用！','deductType','AppEntity','metadata','getOwnPropertySymbols','log','handlePdfExtraction','parse','stringify','delAll','default','typeorm','update','map','HttpStatus','Injectable','appId','chatGroupEntity','extractPdfText','user','BAD_REQUEST','删除失败！','coverImg','findOne','getGroupPdfText','assign','getOwnPropertyDescriptor','731247RIKvaT','text','length','354257QtduoU','2101902IsKMQq','HttpException','config','data','应用对话名称不能修改哟！','5497345hjwwYu','15axRMmc','815076OexXvJ','prototype','../models/models.service','keyType','__esModule','isSticky','isFileUpload','pdfTextContent','title','Repository','2062184RpjKqS','arraybuffer','query','updateTime','InjectRepository','includes','__rest','getCurrentModelKeyInfo','object','管理员未配置任何AI模型、请先联系管理员开通聊天模型配置！','PDF\x20解析失败','axios','modelsService','call','function','__metadata','get','PDF\x20读取失败:','ModelsService','appLogo','design:paramtypes','error','pdf-parse','删除成功','getBaseConfig','decorate','__param','gpts','defineProperty','appEntity','find'];_0x1bcd=function(){return _0x1e0646;};return _0x1bcd();}var __decorate=this&&this['__decorate']||function(_0x322ed7,_0x3f67b9,_0x1910ac,_0x654fb5){const _0x2341e0=_0x3a14;var _0x20fb34=arguments[_0x2341e0(0xba)],_0x5d859c=_0x20fb34<0x3?_0x3f67b9:_0x654fb5===null?_0x654fb5=Object[_0x2341e0(0x113)](_0x3f67b9,_0x1910ac):_0x654fb5,_0xc2593a;if(typeof Reflect===_0x2341e0(0xd5)&&typeof Reflect[_0x2341e0(0xe6)]===_0x2341e0(0xdb))_0x5d859c=Reflect[_0x2341e0(0xe6)](_0x322ed7,_0x3f67b9,_0x1910ac,_0x654fb5);else{for(var _0x13fafb=_0x322ed7[_0x2341e0(0xba)]-0x1;_0x13fafb>=0x0;_0x13fafb--)if(_0xc2593a=_0x322ed7[_0x13fafb])_0x5d859c=(_0x20fb34<0x3?_0xc2593a(_0x5d859c):_0x20fb34>0x3?_0xc2593a(_0x3f67b9,_0x1910ac,_0x5d859c):_0xc2593a(_0x3f67b9,_0x1910ac))||_0x5d859c;}return _0x20fb34>0x3&&_0x5d859c&&Object['defineProperty'](_0x3f67b9,_0x1910ac,_0x5d859c),_0x5d859c;},__metadata=this&&this[_0x449ffd(0xdc)]||function(_0x2e478d,_0x4bbebe){const _0x223f9e=_0x449ffd;if(typeof Reflect===_0x223f9e(0xd5)&&typeof Reflect[_0x223f9e(0xfc)]===_0x223f9e(0xdb))return Reflect['metadata'](_0x2e478d,_0x4bbebe);},__param=this&&this[_0x449ffd(0xe7)]||function(_0x5cc39d,_0x14fd69){return function(_0x314f32,_0x4e54eb){_0x14fd69(_0x314f32,_0x4e54eb,_0x5cc39d);};},__rest=this&&this[_0x449ffd(0xd3)]||function(_0x109d08,_0xcccf15){const _0x48af2b=_0x449ffd;var _0x4e4f01={};for(var _0xe5bcfe in _0x109d08)if(Object[_0x48af2b(0xc4)][_0x48af2b(0xf0)]['call'](_0x109d08,_0xe5bcfe)&&_0xcccf15['indexOf'](_0xe5bcfe)<0x0)_0x4e4f01[_0xe5bcfe]=_0x109d08[_0xe5bcfe];if(_0x109d08!=null&&typeof Object[_0x48af2b(0xfd)]===_0x48af2b(0xdb))for(var _0x47b193=0x0,_0xe5bcfe=Object[_0x48af2b(0xfd)](_0x109d08);_0x47b193<_0xe5bcfe[_0x48af2b(0xba)];_0x47b193++){if(_0xcccf15['indexOf'](_0xe5bcfe[_0x47b193])<0x0&&Object[_0x48af2b(0xc4)]['propertyIsEnumerable'][_0x48af2b(0xda)](_0x109d08,_0xe5bcfe[_0x47b193]))_0x4e4f01[_0xe5bcfe[_0x47b193]]=_0x109d08[_0xe5bcfe[_0x47b193]];}return _0x4e4f01;};Object[_0x449ffd(0xe9)](exports,_0x449ffd(0xc7),{'value':!![]}),exports[_0x449ffd(0xec)]=void 0x0;function _0x3a14(_0x5e2e6f,_0x4f0ab8){const _0x1bcdf5=_0x1bcd();return _0x3a14=function(_0x3a147e,_0x4a6921){_0x3a147e=_0x3a147e-0xb9;let _0x57bbdc=_0x1bcdf5[_0x3a147e];return _0x57bbdc;},_0x3a14(_0x5e2e6f,_0x4f0ab8);}const common_1=require('@nestjs/common'),typeorm_1=require(_0x449ffd(0xf7)),axios_1=require(_0x449ffd(0xd8)),pdf=require(_0x449ffd(0xe3)),typeorm_2=require(_0x449ffd(0x104)),app_entity_1=require(_0x449ffd(0xf3)),models_service_1=require(_0x449ffd(0xc5)),chatGroup_entity_1=require('./chatGroup.entity');let ChatGroupService=class ChatGroupService{constructor(_0x1aae28,_0x572b8d,_0x328ee5){const _0x614566=_0x449ffd;this[_0x614566(0x10a)]=_0x1aae28,this['appEntity']=_0x572b8d,this['modelsService']=_0x328ee5;}async['create'](_0x426f37,_0x20c2f1){const _0x115230=_0x449ffd,{id:_0x43c28a}=_0x20c2f1['user'],{appId:_0x3298b2,modelConfig:_0x2846be,params:_0x5d6ee3}=_0x426f37;let _0x1ae5ca=_0x2846be||await this[_0x115230(0xd9)][_0x115230(0xe5)]();if(!_0x1ae5ca)throw new common_1[(_0x115230(0xbd))](_0x115230(0xd6),common_1[_0x115230(0x107)][_0x115230(0x10d)]);_0x1ae5ca=JSON[_0x115230(0x100)](JSON[_0x115230(0x101)](_0x1ae5ca));const _0x229648={'title':'新对话','userId':_0x43c28a,'appId':_0x3298b2,'params':_0x5d6ee3};if(_0x3298b2){const _0x29e810=await this['appEntity']['findOne']({'where':{'id':_0x3298b2}});if(!_0x29e810)throw new common_1[(_0x115230(0xbd))](_0x115230(0xef),common_1['HttpStatus'][_0x115230(0x10d)]);const {status:_0x4bd676,name:_0x37191d,isFixedModel:_0x17fa81,isGPTs:_0x2f860b,appModel:_0x3245b3,coverImg:_0x41cb37}=_0x29e810;Object[_0x115230(0x112)](_0x1ae5ca['modelInfo'],{'isGPTs':_0x2f860b,'isFixedModel':_0x17fa81,'modelAvatar':_0x41cb37,'modelName':_0x37191d});if(_0x2f860b===0x1||_0x17fa81===0x1){const _0x54d5d9=await this[_0x115230(0xd9)][_0x115230(0xd4)](_0x17fa81===0x1?_0x3245b3:_0x115230(0xe8));Object[_0x115230(0x112)](_0x1ae5ca[_0x115230(0xf6)],{'deductType':_0x54d5d9[_0x115230(0xfa)],'deduct':_0x54d5d9['deduct'],'model':_0x3245b3,'isFileUpload':_0x54d5d9[_0x115230(0xc9)]});}if(![0x1,0x3,0x4,0x5][_0x115230(0xd2)](_0x4bd676))throw new common_1[(_0x115230(0xbd))](_0x115230(0xf9),common_1[_0x115230(0x107)]['BAD_REQUEST']);_0x37191d&&(_0x229648[_0x115230(0xcb)]=_0x37191d);}const _0x29b55b=await this[_0x115230(0x10a)]['save'](Object[_0x115230(0x112)](Object[_0x115230(0x112)]({},_0x229648),{'config':JSON['stringify'](_0x1ae5ca)}));return _0x29b55b;}async[_0x449ffd(0xcf)](_0x5ebd19){const _0xa38983=_0x449ffd;try{const {id:_0x14c0ba}=_0x5ebd19[_0xa38983(0x10c)],_0x1babcb={'userId':_0x14c0ba,'isDelete':![]},_0x38430e=await this[_0xa38983(0x10a)]['find']({'where':_0x1babcb,'order':{'isSticky':'DESC','updatedAt':'DESC'}});return _0x38430e;const _0x2f9a1e=_0x38430e[_0xa38983(0xf2)](_0x24da31=>_0x24da31['appId'])[_0xa38983(0x106)](_0x17c304=>_0x17c304[_0xa38983(0x109)]),_0x3cee50=await this[_0xa38983(0xea)][_0xa38983(0xeb)]({'where':{'id':(0x0,typeorm_2['In'])(_0x2f9a1e)}});return _0x38430e[_0xa38983(0x106)](_0x5aa61d=>{const _0x2a8cc3=_0xa38983;var _0x108715;return _0x5aa61d[_0x2a8cc3(0xe0)]=(_0x108715=_0x3cee50[_0x2a8cc3(0xeb)](_0x54b414=>_0x54b414['id']===_0x5aa61d[_0x2a8cc3(0x109)]))===null||_0x108715===void 0x0?void 0x0:_0x108715[_0x2a8cc3(0x10f)],_0x5aa61d;});}catch(_0x5077f4){console[_0xa38983(0xfe)]('error:\x20',_0x5077f4);}}async[_0x449ffd(0x105)](_0x57e19b,_0x6fe067){const _0x4d6c6f=_0x449ffd,{title:_0x1b440e,isSticky:_0x2e29bd,groupId:_0x3d6a6d,config:_0x3ade6b,fileUrl:_0x3898cf}=_0x57e19b,{id:_0x266ee3}=_0x6fe067[_0x4d6c6f(0x10c)],_0x15929e=await this[_0x4d6c6f(0x10a)][_0x4d6c6f(0x110)]({'where':{'id':_0x3d6a6d,'userId':_0x266ee3}});if(!_0x15929e)throw new common_1[(_0x4d6c6f(0xbd))]('请先选择一个对话或者新加一个对话再操作！',common_1['HttpStatus'][_0x4d6c6f(0x10d)]);const {appId:_0x1394db}=_0x15929e;if(_0x1394db&&!_0x1b440e)try{const _0x549f6b=JSON[_0x4d6c6f(0x100)](_0x3ade6b);if(Number(_0x549f6b[_0x4d6c6f(0xc6)])!==0x1)throw new common_1[(_0x4d6c6f(0xbd))](_0x4d6c6f(0xc0),common_1[_0x4d6c6f(0x107)]['BAD_REQUEST']);}catch(_0x20663a){}const _0x4a8a9f={};_0x1b440e&&(_0x4a8a9f[_0x4d6c6f(0xcb)]=_0x1b440e),typeof _0x2e29bd!==_0x4d6c6f(0xee)&&(_0x4a8a9f[_0x4d6c6f(0xc8)]=_0x2e29bd),_0x3ade6b&&(_0x4a8a9f[_0x4d6c6f(0xbe)]=_0x3ade6b),_0x3898cf&&(_0x4a8a9f['fileUrl']=_0x3898cf);const _0x191212=await this[_0x4d6c6f(0x10a)][_0x4d6c6f(0x105)]({'id':_0x3d6a6d},_0x4a8a9f);if(_0x191212[_0x4d6c6f(0xf8)])return _0x3898cf&&this[_0x4d6c6f(0xff)](_0x3898cf,_0x3d6a6d),!![];else throw new common_1[(_0x4d6c6f(0xbd))]('更新对话失败！',common_1[_0x4d6c6f(0x107)][_0x4d6c6f(0x10d)]);}async[_0x449ffd(0xff)](_0x5a3aa3,_0x3201dc){const _0x5e2c1b=_0x449ffd;try{const _0x342118=await this[_0x5e2c1b(0x10b)](_0x5a3aa3);await this['chatGroupEntity'][_0x5e2c1b(0x105)]({'id':_0x3201dc},{'pdfTextContent':_0x342118});}catch(_0x3d0c77){console[_0x5e2c1b(0xe2)](_0x5e2c1b(0xde),_0x3d0c77);}}async['extractPdfText'](_0x556889){const _0x1f2cbd=_0x449ffd;try{const _0x5a0092=await axios_1[_0x1f2cbd(0x103)][_0x1f2cbd(0xdd)](_0x556889,{'responseType':_0x1f2cbd(0xce)}),_0x396de5=Buffer[_0x1f2cbd(0xf5)](_0x5a0092[_0x1f2cbd(0xbf)]),_0x3396ea=await pdf(_0x396de5);return _0x3396ea[_0x1f2cbd(0xb9)];}catch(_0x57c7ba){console[_0x1f2cbd(0xe2)](_0x1f2cbd(0xf4),_0x57c7ba);throw new Error(_0x1f2cbd(0xd7));}}async[_0x449ffd(0xd0)](_0x37d402){const _0x5e9a76=_0x449ffd;await this[_0x5e9a76(0x10a)]['update'](_0x37d402,{'updatedAt':new Date()});}async['del'](_0x23ca41,_0x4bd594){const _0x58c5f8=_0x449ffd,{groupId:_0x39dd0e}=_0x23ca41,{id:_0x55220f}=_0x4bd594['user'],_0x37da5b=await this['chatGroupEntity']['findOne']({'where':{'id':_0x39dd0e,'userId':_0x55220f}});if(!_0x37da5b)throw new common_1['HttpException']('非法操作、您在删除一个非法资源！',common_1[_0x58c5f8(0x107)][_0x58c5f8(0x10d)]);const _0x32171e=await this[_0x58c5f8(0x10a)][_0x58c5f8(0x105)]({'id':_0x39dd0e},{'isDelete':!![]});if(_0x32171e['affected'])return _0x58c5f8(0xe4);else throw new common_1[(_0x58c5f8(0xbd))](_0x58c5f8(0x10e),common_1[_0x58c5f8(0x107)][_0x58c5f8(0x10d)]);}async[_0x449ffd(0x102)](_0x181c6d){const _0x248b71=_0x449ffd,{id:_0x50195b}=_0x181c6d[_0x248b71(0x10c)],_0x11a321=await this['chatGroupEntity'][_0x248b71(0x105)]({'userId':_0x50195b,'isSticky':![],'isDelete':![]},{'isDelete':!![]});if(_0x11a321[_0x248b71(0xf8)])return _0x248b71(0xe4);else throw new common_1[(_0x248b71(0xbd))](_0x248b71(0x10e),common_1[_0x248b71(0x107)][_0x248b71(0x10d)]);}async[_0x449ffd(0xed)](_0x32ae46){const _0x1bef68=_0x449ffd;if(!_0x32ae46)return;const _0x41ea64=await this['chatGroupEntity'][_0x1bef68(0x110)]({'where':{'id':_0x32ae46}});if(_0x41ea64){const {pdfTextContent:_0x5b9fa4}=_0x41ea64,_0x1168d5=__rest(_0x41ea64,['pdfTextContent']);return _0x1168d5;}}async[_0x449ffd(0x111)](_0x3266b0){const _0x4012ff=_0x449ffd,_0x330d37=await this[_0x4012ff(0x10a)][_0x4012ff(0x110)]({'where':{'id':_0x3266b0}});if(_0x330d37)return _0x330d37[_0x4012ff(0xca)];}};ChatGroupService=__decorate([(0x0,common_1[_0x449ffd(0x108)])(),__param(0x0,(0x0,typeorm_1[_0x449ffd(0xd1)])(chatGroup_entity_1['ChatGroupEntity'])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(app_entity_1[_0x449ffd(0xfb)])),__metadata(_0x449ffd(0xe1),[typeorm_2['Repository'],typeorm_2[_0x449ffd(0xcc)],models_service_1[_0x449ffd(0xdf)]])],ChatGroupService),exports[_0x449ffd(0xec)]=ChatGroupService;