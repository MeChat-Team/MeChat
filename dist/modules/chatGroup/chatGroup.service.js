'use strict';const _0x3e7c8d=_0x3503;(function(_0x5ca7cd,_0x25772d){const _0x2fe6b9=_0x3503,_0x40a1ac=_0x5ca7cd();while(!![]){try{const _0x58a880=-parseInt(_0x2fe6b9(0x20b))/0x1*(-parseInt(_0x2fe6b9(0x1be))/0x2)+-parseInt(_0x2fe6b9(0x1f5))/0x3*(-parseInt(_0x2fe6b9(0x1fe))/0x4)+-parseInt(_0x2fe6b9(0x1bc))/0x5+parseInt(_0x2fe6b9(0x1cd))/0x6*(-parseInt(_0x2fe6b9(0x1f9))/0x7)+parseInt(_0x2fe6b9(0x201))/0x8*(-parseInt(_0x2fe6b9(0x1c1))/0x9)+parseInt(_0x2fe6b9(0x1dd))/0xa+parseInt(_0x2fe6b9(0x1b4))/0xb;if(_0x58a880===_0x25772d)break;else _0x40a1ac['push'](_0x40a1ac['shift']());}catch(_0x2d9054){_0x40a1ac['push'](_0x40a1ac['shift']());}}}(_0x45be,0x2ee0f));function _0x3503(_0x3a19f6,_0xe7b5e3){const _0x45be8c=_0x45be();return _0x3503=function(_0x350349,_0x40aacc){_0x350349=_0x350349-0x1a9;let _0xc5931b=_0x45be8c[_0x350349];return _0xc5931b;},_0x3503(_0x3a19f6,_0xe7b5e3);}function _0x45be(){const _0x462872=['indexOf','appEntity','getOwnPropertyDescriptor','Repository','updateTime','__decorate','__rest','BAD_REQUEST','extractPdfText','from','modelInfo','getCurrentModelKeyInfo','filter','deduct','getGroupPdfText','hasOwnProperty','239835DkihJz','update','query','appId','357znFHCN','default','DESC','error','chatGroupEntity','4uoSkgu','PDF\x20读取失败:','../models/models.service','657304WCamKd','object','assign','ModelsService','call','__esModule','undefined','get','非法操作、您在删除一个非法资源！','error:\x20','73019ksVKVc','getGroupInfoFromId','非法操作、您在使用一个未启用的应用！','modelsService','HttpStatus','arraybuffer','appLogo','getBaseConfig','prototype','pdfTextContent','propertyIsEnumerable','affected','2192894HCNPxv','删除失败！','ChatGroupService','非法操作、您在使用一个不存在的应用！','deductType','design:paramtypes','InjectRepository','typeorm','985670RujOlH','gpts','10UDqpnI','__param','delAll','18kObuAL','pdf-parse','handlePdfExtraction','应用对话名称不能修改哟！','@nestjs/typeorm','map','decorate','log','del','defineProperty','./chatGroup.entity','findOne','13116pyLQkP','stringify','function','find','title','删除成功','新对话','ChatGroupEntity','axios','HttpException','metadata','length','isFileUpload','includes','@nestjs/common','更新对话失败！','205670PpZGBF','isSticky','data','user','getOwnPropertySymbols','管理员未配置任何AI模型、请先联系管理员开通聊天模型配置！','parse','config'];_0x45be=function(){return _0x462872;};return _0x45be();}var __decorate=this&&this[_0x3e7c8d(0x1ea)]||function(_0xe61afa,_0x51f54b,_0x2e2cb3,_0x30e64c){const _0xce0d2b=_0x3e7c8d;var _0x3cbdfa=arguments['length'],_0x12d373=_0x3cbdfa<0x3?_0x51f54b:_0x30e64c===null?_0x30e64c=Object[_0xce0d2b(0x1e7)](_0x51f54b,_0x2e2cb3):_0x30e64c,_0x179adf;if(typeof Reflect===_0xce0d2b(0x202)&&typeof Reflect['decorate']===_0xce0d2b(0x1cf))_0x12d373=Reflect[_0xce0d2b(0x1c7)](_0xe61afa,_0x51f54b,_0x2e2cb3,_0x30e64c);else{for(var _0x13378b=_0xe61afa[_0xce0d2b(0x1d8)]-0x1;_0x13378b>=0x0;_0x13378b--)if(_0x179adf=_0xe61afa[_0x13378b])_0x12d373=(_0x3cbdfa<0x3?_0x179adf(_0x12d373):_0x3cbdfa>0x3?_0x179adf(_0x51f54b,_0x2e2cb3,_0x12d373):_0x179adf(_0x51f54b,_0x2e2cb3))||_0x12d373;}return _0x3cbdfa>0x3&&_0x12d373&&Object['defineProperty'](_0x51f54b,_0x2e2cb3,_0x12d373),_0x12d373;},__metadata=this&&this['__metadata']||function(_0x2daeef,_0x24a099){const _0x1408d3=_0x3e7c8d;if(typeof Reflect==='object'&&typeof Reflect[_0x1408d3(0x1d7)]===_0x1408d3(0x1cf))return Reflect[_0x1408d3(0x1d7)](_0x2daeef,_0x24a099);},__param=this&&this[_0x3e7c8d(0x1bf)]||function(_0x354e10,_0x5a9795){return function(_0x27d54b,_0x4ab988){_0x5a9795(_0x27d54b,_0x4ab988,_0x354e10);};},__rest=this&&this[_0x3e7c8d(0x1eb)]||function(_0x205ed2,_0x112992){const _0xaab4=_0x3e7c8d;var _0x22b455={};for(var _0x369010 in _0x205ed2)if(Object[_0xaab4(0x1b0)][_0xaab4(0x1f4)][_0xaab4(0x205)](_0x205ed2,_0x369010)&&_0x112992[_0xaab4(0x1e5)](_0x369010)<0x0)_0x22b455[_0x369010]=_0x205ed2[_0x369010];if(_0x205ed2!=null&&typeof Object[_0xaab4(0x1e1)]===_0xaab4(0x1cf))for(var _0x510c0d=0x0,_0x369010=Object['getOwnPropertySymbols'](_0x205ed2);_0x510c0d<_0x369010['length'];_0x510c0d++){if(_0x112992['indexOf'](_0x369010[_0x510c0d])<0x0&&Object['prototype'][_0xaab4(0x1b2)][_0xaab4(0x205)](_0x205ed2,_0x369010[_0x510c0d]))_0x22b455[_0x369010[_0x510c0d]]=_0x205ed2[_0x369010[_0x510c0d]];}return _0x22b455;};Object[_0x3e7c8d(0x1ca)](exports,_0x3e7c8d(0x206),{'value':!![]}),exports['ChatGroupService']=void 0x0;const common_1=require(_0x3e7c8d(0x1db)),typeorm_1=require(_0x3e7c8d(0x1c5)),axios_1=require(_0x3e7c8d(0x1d5)),pdf=require(_0x3e7c8d(0x1c2)),typeorm_2=require(_0x3e7c8d(0x1bb)),app_entity_1=require('../app/app.entity'),models_service_1=require(_0x3e7c8d(0x200)),chatGroup_entity_1=require(_0x3e7c8d(0x1cb));let ChatGroupService=class ChatGroupService{constructor(_0x24d48b,_0x32ccac,_0x362843){const _0x33077f=_0x3e7c8d;this['chatGroupEntity']=_0x24d48b,this[_0x33077f(0x1e6)]=_0x32ccac,this[_0x33077f(0x1ab)]=_0x362843;}async['create'](_0xb14f12,_0x158ac2){const _0x2638d5=_0x3e7c8d,{id:_0x3ec6e6}=_0x158ac2[_0x2638d5(0x1e0)],{appId:_0x56b79c,modelConfig:_0x5aaf6b,params:_0x262a71}=_0xb14f12;let _0x308f53=_0x5aaf6b||await this[_0x2638d5(0x1ab)][_0x2638d5(0x1af)]();if(!_0x308f53)throw new common_1[(_0x2638d5(0x1d6))](_0x2638d5(0x1e2),common_1[_0x2638d5(0x1ac)][_0x2638d5(0x1ec)]);_0x308f53=JSON[_0x2638d5(0x1e3)](JSON[_0x2638d5(0x1ce)](_0x308f53));const _0x3080d0={'title':_0x2638d5(0x1d3),'userId':_0x3ec6e6,'appId':_0x56b79c,'params':_0x262a71};if(_0x56b79c){const _0xff4156=await this['appEntity']['findOne']({'where':{'id':_0x56b79c}});if(!_0xff4156)throw new common_1['HttpException'](_0x2638d5(0x1b7),common_1[_0x2638d5(0x1ac)][_0x2638d5(0x1ec)]);const {status:_0x119235,name:_0xc3d64c,isFixedModel:_0x456c70,isGPTs:_0x587e61,appModel:_0x2e7e33,coverImg:_0x1f247a}=_0xff4156;Object[_0x2638d5(0x203)](_0x308f53[_0x2638d5(0x1ef)],{'isGPTs':_0x587e61,'isFixedModel':_0x456c70,'modelAvatar':_0x1f247a,'modelName':_0xc3d64c});if(_0x587e61===0x1||_0x456c70===0x1){const _0x124598=await this[_0x2638d5(0x1ab)][_0x2638d5(0x1f0)](_0x456c70===0x1?_0x2e7e33:_0x2638d5(0x1bd));Object['assign'](_0x308f53[_0x2638d5(0x1ef)],{'deductType':_0x124598[_0x2638d5(0x1b8)],'deduct':_0x124598[_0x2638d5(0x1f2)],'model':_0x2e7e33,'isFileUpload':_0x124598[_0x2638d5(0x1d9)]});}if(![0x1,0x3,0x4,0x5][_0x2638d5(0x1da)](_0x119235))throw new common_1[(_0x2638d5(0x1d6))](_0x2638d5(0x1aa),common_1[_0x2638d5(0x1ac)][_0x2638d5(0x1ec)]);_0xc3d64c&&(_0x3080d0[_0x2638d5(0x1d1)]=_0xc3d64c);}const _0x415dae=await this[_0x2638d5(0x1fd)]['save'](Object[_0x2638d5(0x203)](Object['assign']({},_0x3080d0),{'config':JSON[_0x2638d5(0x1ce)](_0x308f53)}));return _0x415dae;}async[_0x3e7c8d(0x1f7)](_0x23673c){const _0x176ba3=_0x3e7c8d;try{const {id:_0x5613a6}=_0x23673c[_0x176ba3(0x1e0)],_0x458469={'userId':_0x5613a6,'isDelete':![]},_0x2662b6=await this[_0x176ba3(0x1fd)][_0x176ba3(0x1d0)]({'where':_0x458469,'order':{'isSticky':_0x176ba3(0x1fb),'updatedAt':_0x176ba3(0x1fb)}});return _0x2662b6;const _0x37e51e=_0x2662b6[_0x176ba3(0x1f1)](_0x5a602c=>_0x5a602c['appId'])[_0x176ba3(0x1c6)](_0x1457b2=>_0x1457b2[_0x176ba3(0x1f8)]),_0x209a12=await this[_0x176ba3(0x1e6)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x37e51e)}});return _0x2662b6[_0x176ba3(0x1c6)](_0xde18ac=>{const _0x2ee53e=_0x176ba3;var _0x23b303;return _0xde18ac[_0x2ee53e(0x1ae)]=(_0x23b303=_0x209a12[_0x2ee53e(0x1d0)](_0x5e25c9=>_0x5e25c9['id']===_0xde18ac['appId']))===null||_0x23b303===void 0x0?void 0x0:_0x23b303['coverImg'],_0xde18ac;});}catch(_0x518f28){console[_0x176ba3(0x1c8)](_0x176ba3(0x20a),_0x518f28);}}async[_0x3e7c8d(0x1f6)](_0x42835a,_0x17ce3b){const _0x41ffe1=_0x3e7c8d,{title:_0x35847a,isSticky:_0x127662,groupId:_0x5711db,config:_0x16b94a,fileUrl:_0xe8a68c}=_0x42835a,{id:_0x272a16}=_0x17ce3b[_0x41ffe1(0x1e0)],_0x4617f3=await this[_0x41ffe1(0x1fd)][_0x41ffe1(0x1cc)]({'where':{'id':_0x5711db,'userId':_0x272a16}});if(!_0x4617f3)throw new common_1[(_0x41ffe1(0x1d6))]('请先选择一个对话或者新加一个对话再操作！',common_1[_0x41ffe1(0x1ac)][_0x41ffe1(0x1ec)]);const {appId:_0x538e8f}=_0x4617f3;if(_0x538e8f&&!_0x35847a)try{const _0x4167fe=JSON['parse'](_0x16b94a);if(Number(_0x4167fe['keyType'])!==0x1)throw new common_1[(_0x41ffe1(0x1d6))](_0x41ffe1(0x1c4),common_1[_0x41ffe1(0x1ac)][_0x41ffe1(0x1ec)]);}catch(_0x25c45c){}const _0x421117={};_0x35847a&&(_0x421117[_0x41ffe1(0x1d1)]=_0x35847a),typeof _0x127662!==_0x41ffe1(0x207)&&(_0x421117[_0x41ffe1(0x1de)]=_0x127662),_0x16b94a&&(_0x421117[_0x41ffe1(0x1e4)]=_0x16b94a),_0xe8a68c&&(_0x421117['fileUrl']=_0xe8a68c);const _0x521a14=await this['chatGroupEntity'][_0x41ffe1(0x1f6)]({'id':_0x5711db},_0x421117);if(_0x521a14[_0x41ffe1(0x1b3)])return _0xe8a68c&&this[_0x41ffe1(0x1c3)](_0xe8a68c,_0x5711db),!![];else throw new common_1[(_0x41ffe1(0x1d6))](_0x41ffe1(0x1dc),common_1['HttpStatus'][_0x41ffe1(0x1ec)]);}async[_0x3e7c8d(0x1c3)](_0x190629,_0xc2d6d8){const _0x144190=_0x3e7c8d;try{const _0x574245=await this[_0x144190(0x1ed)](_0x190629);await this[_0x144190(0x1fd)][_0x144190(0x1f6)]({'id':_0xc2d6d8},{'pdfTextContent':_0x574245});}catch(_0x2015a2){console[_0x144190(0x1fc)](_0x144190(0x1ff),_0x2015a2);}}async[_0x3e7c8d(0x1ed)](_0x3eea1f){const _0x581389=_0x3e7c8d;try{const _0xbf7bbf=await axios_1[_0x581389(0x1fa)][_0x581389(0x208)](_0x3eea1f,{'responseType':_0x581389(0x1ad)}),_0x931915=Buffer[_0x581389(0x1ee)](_0xbf7bbf[_0x581389(0x1df)]),_0x2d73f6=await pdf(_0x931915);return _0x2d73f6['text'];}catch(_0x3061a5){console['error']('PDF\x20解析失败:',_0x3061a5);throw new Error('PDF\x20解析失败');}}async[_0x3e7c8d(0x1e9)](_0x264117){await this['chatGroupEntity']['update'](_0x264117,{'updatedAt':new Date()});}async[_0x3e7c8d(0x1c9)](_0x3ff6e4,_0x414ac6){const _0xf491a7=_0x3e7c8d,{groupId:_0x1867a5}=_0x3ff6e4,{id:_0xc6de7a}=_0x414ac6[_0xf491a7(0x1e0)],_0xcc3c92=await this[_0xf491a7(0x1fd)][_0xf491a7(0x1cc)]({'where':{'id':_0x1867a5,'userId':_0xc6de7a}});if(!_0xcc3c92)throw new common_1[(_0xf491a7(0x1d6))](_0xf491a7(0x209),common_1[_0xf491a7(0x1ac)][_0xf491a7(0x1ec)]);const _0x575e6d=await this[_0xf491a7(0x1fd)][_0xf491a7(0x1f6)]({'id':_0x1867a5},{'isDelete':!![]});if(_0x575e6d['affected'])return _0xf491a7(0x1d2);else throw new common_1['HttpException'](_0xf491a7(0x1b5),common_1[_0xf491a7(0x1ac)][_0xf491a7(0x1ec)]);}async[_0x3e7c8d(0x1c0)](_0x1791a0){const _0x2dda22=_0x3e7c8d,{id:_0x5c4c4f}=_0x1791a0[_0x2dda22(0x1e0)],_0x17c10b=await this[_0x2dda22(0x1fd)][_0x2dda22(0x1f6)]({'userId':_0x5c4c4f,'isSticky':![],'isDelete':![]},{'isDelete':!![]});if(_0x17c10b['affected'])return _0x2dda22(0x1d2);else throw new common_1[(_0x2dda22(0x1d6))](_0x2dda22(0x1b5),common_1['HttpStatus'][_0x2dda22(0x1ec)]);}async[_0x3e7c8d(0x1a9)](_0x1be984){const _0x54ca7f=_0x3e7c8d;if(!_0x1be984)return;const _0x47b95d=await this[_0x54ca7f(0x1fd)][_0x54ca7f(0x1cc)]({'where':{'id':_0x1be984}});if(_0x47b95d){const {pdfTextContent:_0x14c43e}=_0x47b95d,_0x1d3145=__rest(_0x47b95d,[_0x54ca7f(0x1b1)]);return _0x1d3145;}}async[_0x3e7c8d(0x1f3)](_0x4205a4){const _0x30fe08=_0x3e7c8d,_0x2afebd=await this[_0x30fe08(0x1fd)][_0x30fe08(0x1cc)]({'where':{'id':_0x4205a4}});if(_0x2afebd)return _0x2afebd[_0x30fe08(0x1b1)];}};ChatGroupService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x3e7c8d(0x1ba)])(chatGroup_entity_1[_0x3e7c8d(0x1d4)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(app_entity_1['AppEntity'])),__metadata(_0x3e7c8d(0x1b9),[typeorm_2[_0x3e7c8d(0x1e8)],typeorm_2[_0x3e7c8d(0x1e8)],models_service_1[_0x3e7c8d(0x204)]])],ChatGroupService),exports[_0x3e7c8d(0x1b6)]=ChatGroupService;