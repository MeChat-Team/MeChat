'use strict';const _0x75905=_0x4461;(function(_0x1cd774,_0x41bae3){const _0x1915ef=_0x4461,_0x29adcf=_0x1cd774();while(!![]){try{const _0x70067d=-parseInt(_0x1915ef(0x168))/0x1*(-parseInt(_0x1915ef(0x160))/0x2)+parseInt(_0x1915ef(0x166))/0x3+-parseInt(_0x1915ef(0x111))/0x4*(-parseInt(_0x1915ef(0x15b))/0x5)+parseInt(_0x1915ef(0x118))/0x6*(-parseInt(_0x1915ef(0x14b))/0x7)+-parseInt(_0x1915ef(0x15c))/0x8*(parseInt(_0x1915ef(0x169))/0x9)+parseInt(_0x1915ef(0x115))/0xa+-parseInt(_0x1915ef(0x136))/0xb;if(_0x70067d===_0x41bae3)break;else _0x29adcf['push'](_0x29adcf['shift']());}catch(_0x2e1d2f){_0x29adcf['push'](_0x29adcf['shift']());}}}(_0x5197,0x77761));function _0x5197(){const _0x46db15=['新对话','2172852ARdLUo','config','HttpException','filter','3244270ZWswCL','DESC','PDF\x20解析失败','4306266PENlEP','getBaseConfig','typeorm','data','Repository','function','appId','create','删除失败！','更新对话失败！','object','@nestjs/common','affected','isFileUpload','save','error','appLogo','prototype','__esModule','findOne','非法操作、您在使用一个不存在的应用！','非法操作、您在使用一个未启用的应用！','design:paramtypes','应用对话名称不能修改哟！','length','call','decorate','modelInfo','PDF\x20读取失败:','deduct','4786716evEwzN','chatGroupEntity','gpts','@nestjs/typeorm','pdfTextContent','user','title','del','propertyIsEnumerable','default','parse','appEntity','fileUrl','modelsService','update','AppEntity','query','metadata','__param','InjectRepository','map','7IdxMXg','BAD_REQUEST','updateTime','get','__rest','deductType','find','assign','ModelsService','../models/models.service','getGroupPdfText','HttpStatus','非法操作、您在删除一个非法资源！','ChatGroupEntity','stringify','请先选择一个对话或者新加一个对话再操作！','5WcPMLQ','8SWrciz','log','delAll','handlePdfExtraction','1643794VkZszP','indexOf','ChatGroupService','删除成功','getOwnPropertySymbols','from','423075EmDKjH','defineProperty','1MeTnMZ','1695438jINHhG','getCurrentModelKeyInfo','管理员未配置任何AI模型、请先联系管理员开通聊天模型配置！','getOwnPropertyDescriptor'];_0x5197=function(){return _0x46db15;};return _0x5197();}var __decorate=this&&this['__decorate']||function(_0x225ae0,_0xb03372,_0x311ad0,_0xd3470c){const _0x3a9e87=_0x4461;var _0x35db9d=arguments[_0x3a9e87(0x130)],_0x8277d8=_0x35db9d<0x3?_0xb03372:_0xd3470c===null?_0xd3470c=Object[_0x3a9e87(0x16c)](_0xb03372,_0x311ad0):_0xd3470c,_0x498cc0;if(typeof Reflect==='object'&&typeof Reflect[_0x3a9e87(0x132)]==='function')_0x8277d8=Reflect[_0x3a9e87(0x132)](_0x225ae0,_0xb03372,_0x311ad0,_0xd3470c);else{for(var _0x168cdd=_0x225ae0[_0x3a9e87(0x130)]-0x1;_0x168cdd>=0x0;_0x168cdd--)if(_0x498cc0=_0x225ae0[_0x168cdd])_0x8277d8=(_0x35db9d<0x3?_0x498cc0(_0x8277d8):_0x35db9d>0x3?_0x498cc0(_0xb03372,_0x311ad0,_0x8277d8):_0x498cc0(_0xb03372,_0x311ad0))||_0x8277d8;}return _0x35db9d>0x3&&_0x8277d8&&Object[_0x3a9e87(0x167)](_0xb03372,_0x311ad0,_0x8277d8),_0x8277d8;},__metadata=this&&this['__metadata']||function(_0x3350b7,_0x1a4aaa){const _0x4918ca=_0x4461;if(typeof Reflect===_0x4918ca(0x122)&&typeof Reflect[_0x4918ca(0x147)]===_0x4918ca(0x11d))return Reflect[_0x4918ca(0x147)](_0x3350b7,_0x1a4aaa);},__param=this&&this[_0x75905(0x148)]||function(_0xb7e6fb,_0x239954){return function(_0x13a97e,_0x5837a5){_0x239954(_0x13a97e,_0x5837a5,_0xb7e6fb);};},__rest=this&&this[_0x75905(0x14f)]||function(_0x50f423,_0x46969d){const _0x20a611=_0x75905;var _0x42b4ca={};for(var _0x7000a7 in _0x50f423)if(Object[_0x20a611(0x129)]['hasOwnProperty'][_0x20a611(0x131)](_0x50f423,_0x7000a7)&&_0x46969d['indexOf'](_0x7000a7)<0x0)_0x42b4ca[_0x7000a7]=_0x50f423[_0x7000a7];if(_0x50f423!=null&&typeof Object[_0x20a611(0x164)]==='function')for(var _0x49ebc2=0x0,_0x7000a7=Object['getOwnPropertySymbols'](_0x50f423);_0x49ebc2<_0x7000a7[_0x20a611(0x130)];_0x49ebc2++){if(_0x46969d[_0x20a611(0x161)](_0x7000a7[_0x49ebc2])<0x0&&Object[_0x20a611(0x129)][_0x20a611(0x13e)][_0x20a611(0x131)](_0x50f423,_0x7000a7[_0x49ebc2]))_0x42b4ca[_0x7000a7[_0x49ebc2]]=_0x50f423[_0x7000a7[_0x49ebc2]];}return _0x42b4ca;};Object[_0x75905(0x167)](exports,_0x75905(0x12a),{'value':!![]}),exports[_0x75905(0x162)]=void 0x0;const common_1=require(_0x75905(0x123)),typeorm_1=require(_0x75905(0x139)),axios_1=require('axios'),pdf=require('pdf-parse'),typeorm_2=require(_0x75905(0x11a)),app_entity_1=require('../app/app.entity'),models_service_1=require(_0x75905(0x154)),chatGroup_entity_1=require('./chatGroup.entity');function _0x4461(_0xcf98d3,_0x4b3d1e){const _0x519751=_0x5197();return _0x4461=function(_0x446129,_0x15418e){_0x446129=_0x446129-0x110;let _0x429a99=_0x519751[_0x446129];return _0x429a99;},_0x4461(_0xcf98d3,_0x4b3d1e);}let ChatGroupService=class ChatGroupService{constructor(_0x3e65f8,_0x9c23b5,_0x4a677e){const _0xdab732=_0x75905;this[_0xdab732(0x137)]=_0x3e65f8,this[_0xdab732(0x141)]=_0x9c23b5,this[_0xdab732(0x143)]=_0x4a677e;}async[_0x75905(0x11f)](_0x4be6c7,_0x46cb03){const _0x55597f=_0x75905,{id:_0x5ec747}=_0x46cb03['user'],{appId:_0x297834,modelConfig:_0x575aab,params:_0x3df22a}=_0x4be6c7;let _0x5b228d=_0x575aab||await this[_0x55597f(0x143)][_0x55597f(0x119)]();if(!_0x5b228d)throw new common_1[(_0x55597f(0x113))](_0x55597f(0x16b),common_1[_0x55597f(0x156)]['BAD_REQUEST']);_0x5b228d=JSON[_0x55597f(0x140)](JSON['stringify'](_0x5b228d));const _0x2c8440={'title':_0x55597f(0x110),'userId':_0x5ec747,'appId':_0x297834,'params':_0x3df22a};if(_0x297834){const _0x18a206=await this['appEntity'][_0x55597f(0x12b)]({'where':{'id':_0x297834}});if(!_0x18a206)throw new common_1[(_0x55597f(0x113))](_0x55597f(0x12c),common_1[_0x55597f(0x156)][_0x55597f(0x14c)]);const {status:_0x594995,name:_0x7168e3,isFixedModel:_0x46878d,isGPTs:_0x44eae2,appModel:_0x28a467,coverImg:_0x440cc0}=_0x18a206;Object[_0x55597f(0x152)](_0x5b228d['modelInfo'],{'isGPTs':_0x44eae2,'isFixedModel':_0x46878d,'modelAvatar':_0x440cc0,'modelName':_0x7168e3});if(_0x44eae2===0x1||_0x46878d===0x1){const _0x236ade=await this[_0x55597f(0x143)][_0x55597f(0x16a)](_0x46878d===0x1?_0x28a467:_0x55597f(0x138));Object[_0x55597f(0x152)](_0x5b228d[_0x55597f(0x133)],{'deductType':_0x236ade[_0x55597f(0x150)],'deduct':_0x236ade[_0x55597f(0x135)],'model':_0x28a467,'isFileUpload':_0x236ade[_0x55597f(0x125)]});}if(![0x1,0x3,0x4,0x5]['includes'](_0x594995))throw new common_1[(_0x55597f(0x113))](_0x55597f(0x12d),common_1[_0x55597f(0x156)][_0x55597f(0x14c)]);_0x7168e3&&(_0x2c8440[_0x55597f(0x13c)]=_0x7168e3);}const _0x1ce3bd=await this[_0x55597f(0x137)][_0x55597f(0x126)](Object['assign'](Object[_0x55597f(0x152)]({},_0x2c8440),{'config':JSON[_0x55597f(0x159)](_0x5b228d)}));return _0x1ce3bd;}async[_0x75905(0x146)](_0x4bfd09){const _0x40bbfb=_0x75905;try{const {id:_0x56587f}=_0x4bfd09['user'],_0x2c6c5e={'userId':_0x56587f,'isDelete':![]},_0x96fb4=await this[_0x40bbfb(0x137)][_0x40bbfb(0x151)]({'where':_0x2c6c5e,'order':{'isSticky':_0x40bbfb(0x116),'updatedAt':_0x40bbfb(0x116)}});return _0x96fb4;const _0x28cbc2=_0x96fb4[_0x40bbfb(0x114)](_0x5a70b8=>_0x5a70b8[_0x40bbfb(0x11e)])[_0x40bbfb(0x14a)](_0x3d4124=>_0x3d4124[_0x40bbfb(0x11e)]),_0x11bb5f=await this[_0x40bbfb(0x141)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x28cbc2)}});return _0x96fb4['map'](_0x33029e=>{const _0x2b8c0e=_0x40bbfb;var _0x3580b8;return _0x33029e[_0x2b8c0e(0x128)]=(_0x3580b8=_0x11bb5f[_0x2b8c0e(0x151)](_0x378bf7=>_0x378bf7['id']===_0x33029e[_0x2b8c0e(0x11e)]))===null||_0x3580b8===void 0x0?void 0x0:_0x3580b8['coverImg'],_0x33029e;});}catch(_0x5daecc){console[_0x40bbfb(0x15d)]('error:\x20',_0x5daecc);}}async[_0x75905(0x144)](_0x243bc9,_0xf19c14){const _0x40698e=_0x75905,{title:_0x4fdec9,isSticky:_0x396170,groupId:_0x5dd50b,config:_0x1c0c0f,fileUrl:_0x5e36b2}=_0x243bc9,{id:_0x1b4c9d}=_0xf19c14[_0x40698e(0x13b)],_0x5f0502=await this[_0x40698e(0x137)][_0x40698e(0x12b)]({'where':{'id':_0x5dd50b,'userId':_0x1b4c9d}});if(!_0x5f0502)throw new common_1['HttpException'](_0x40698e(0x15a),common_1['HttpStatus'][_0x40698e(0x14c)]);const {appId:_0x53a6e8}=_0x5f0502;if(_0x53a6e8&&!_0x4fdec9)try{const _0x369890=JSON[_0x40698e(0x140)](_0x1c0c0f);if(Number(_0x369890['keyType'])!==0x1)throw new common_1[(_0x40698e(0x113))](_0x40698e(0x12f),common_1[_0x40698e(0x156)]['BAD_REQUEST']);}catch(_0x59e199){}const _0x556a17={};_0x4fdec9&&(_0x556a17[_0x40698e(0x13c)]=_0x4fdec9),typeof _0x396170!=='undefined'&&(_0x556a17['isSticky']=_0x396170),_0x1c0c0f&&(_0x556a17[_0x40698e(0x112)]=_0x1c0c0f),_0x5e36b2&&(_0x556a17[_0x40698e(0x142)]=_0x5e36b2);const _0x57bdba=await this[_0x40698e(0x137)][_0x40698e(0x144)]({'id':_0x5dd50b},_0x556a17);if(_0x57bdba[_0x40698e(0x124)])return _0x5e36b2&&this[_0x40698e(0x15f)](_0x5e36b2,_0x5dd50b),!![];else throw new common_1['HttpException'](_0x40698e(0x121),common_1['HttpStatus'][_0x40698e(0x14c)]);}async['handlePdfExtraction'](_0x5c3970,_0x17f4c9){const _0x2af830=_0x75905;try{const _0x15b572=await this['extractPdfText'](_0x5c3970);await this['chatGroupEntity']['update']({'id':_0x17f4c9},{'pdfTextContent':_0x15b572});}catch(_0x5f5d02){console[_0x2af830(0x127)](_0x2af830(0x134),_0x5f5d02);}}async['extractPdfText'](_0x1be1d1){const _0x18edbd=_0x75905;try{const _0x597b98=await axios_1[_0x18edbd(0x13f)][_0x18edbd(0x14e)](_0x1be1d1,{'responseType':'arraybuffer'}),_0x5afc79=Buffer[_0x18edbd(0x165)](_0x597b98[_0x18edbd(0x11b)]),_0xe1144b=await pdf(_0x5afc79);return _0xe1144b['text'];}catch(_0x4d5593){console[_0x18edbd(0x127)]('PDF\x20解析失败:',_0x4d5593);throw new Error(_0x18edbd(0x117));}}async[_0x75905(0x14d)](_0xf09519){const _0x53bd7f=_0x75905;await this[_0x53bd7f(0x137)]['update'](_0xf09519,{'updatedAt':new Date()});}async[_0x75905(0x13d)](_0x1d292b,_0x47427a){const _0xef5cee=_0x75905,{groupId:_0x3e6ce0}=_0x1d292b,{id:_0x438b09}=_0x47427a[_0xef5cee(0x13b)],_0x45a920=await this['chatGroupEntity']['findOne']({'where':{'id':_0x3e6ce0,'userId':_0x438b09}});if(!_0x45a920)throw new common_1[(_0xef5cee(0x113))](_0xef5cee(0x157),common_1['HttpStatus'][_0xef5cee(0x14c)]);const _0x8c5cd4=await this[_0xef5cee(0x137)][_0xef5cee(0x144)]({'id':_0x3e6ce0},{'isDelete':!![]});if(_0x8c5cd4[_0xef5cee(0x124)])return'删除成功';else throw new common_1[(_0xef5cee(0x113))](_0xef5cee(0x120),common_1[_0xef5cee(0x156)][_0xef5cee(0x14c)]);}async[_0x75905(0x15e)](_0x1e614a){const _0x288032=_0x75905,{id:_0x43e786}=_0x1e614a['user'],_0x14c2d7=await this['chatGroupEntity'][_0x288032(0x144)]({'userId':_0x43e786,'isSticky':![],'isDelete':![]},{'isDelete':!![]});if(_0x14c2d7[_0x288032(0x124)])return _0x288032(0x163);else throw new common_1[(_0x288032(0x113))]('删除失败！',common_1[_0x288032(0x156)][_0x288032(0x14c)]);}async['getGroupInfoFromId'](_0x5bd8db){const _0x2f7ef3=_0x75905;if(!_0x5bd8db)return;const _0x289f61=await this[_0x2f7ef3(0x137)][_0x2f7ef3(0x12b)]({'where':{'id':_0x5bd8db}});if(_0x289f61){const {pdfTextContent:_0x487b0e}=_0x289f61,_0x1e3da9=__rest(_0x289f61,['pdfTextContent']);return _0x1e3da9;}}async[_0x75905(0x155)](_0x379f47){const _0x1b729c=_0x75905,_0x364db7=await this[_0x1b729c(0x137)][_0x1b729c(0x12b)]({'where':{'id':_0x379f47}});if(_0x364db7)return _0x364db7[_0x1b729c(0x13a)];}};ChatGroupService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x75905(0x149)])(chatGroup_entity_1[_0x75905(0x158)])),__param(0x1,(0x0,typeorm_1[_0x75905(0x149)])(app_entity_1[_0x75905(0x145)])),__metadata(_0x75905(0x12e),[typeorm_2[_0x75905(0x11c)],typeorm_2[_0x75905(0x11c)],models_service_1[_0x75905(0x153)]])],ChatGroupService),exports[_0x75905(0x162)]=ChatGroupService;