'use strict';const _0x1f531d=_0x2ab6;(function(_0x49834f,_0x49cb8b){const _0x5ef9ee=_0x2ab6,_0x6af307=_0x49834f();while(!![]){try{const _0x3f54e4=parseInt(_0x5ef9ee(0x1b0))/0x1*(parseInt(_0x5ef9ee(0x1a9))/0x2)+-parseInt(_0x5ef9ee(0x1f1))/0x3*(parseInt(_0x5ef9ee(0x1ee))/0x4)+parseInt(_0x5ef9ee(0x1bf))/0x5*(-parseInt(_0x5ef9ee(0x1d2))/0x6)+parseInt(_0x5ef9ee(0x1dd))/0x7+parseInt(_0x5ef9ee(0x1ed))/0x8*(parseInt(_0x5ef9ee(0x1a7))/0x9)+-parseInt(_0x5ef9ee(0x1b4))/0xa+parseInt(_0x5ef9ee(0x1ea))/0xb*(-parseInt(_0x5ef9ee(0x1bc))/0xc);if(_0x3f54e4===_0x49cb8b)break;else _0x6af307['push'](_0x6af307['shift']());}catch(_0x144c80){_0x6af307['push'](_0x6af307['shift']());}}}(_0x2696,0x6b823));var __decorate=this&&this[_0x1f531d(0x1cb)]||function(_0x1888ad,_0x2251f0,_0x3a912a,_0x47156c){const _0x3dd3fe=_0x1f531d;var _0x3e79ef=arguments[_0x3dd3fe(0x1fc)],_0x5839be=_0x3e79ef<0x3?_0x2251f0:_0x47156c===null?_0x47156c=Object[_0x3dd3fe(0x1fb)](_0x2251f0,_0x3a912a):_0x47156c,_0x5c652a;if(typeof Reflect===_0x3dd3fe(0x1d8)&&typeof Reflect[_0x3dd3fe(0x1f9)]==='function')_0x5839be=Reflect[_0x3dd3fe(0x1f9)](_0x1888ad,_0x2251f0,_0x3a912a,_0x47156c);else{for(var _0x378afd=_0x1888ad[_0x3dd3fe(0x1fc)]-0x1;_0x378afd>=0x0;_0x378afd--)if(_0x5c652a=_0x1888ad[_0x378afd])_0x5839be=(_0x3e79ef<0x3?_0x5c652a(_0x5839be):_0x3e79ef>0x3?_0x5c652a(_0x2251f0,_0x3a912a,_0x5839be):_0x5c652a(_0x2251f0,_0x3a912a))||_0x5839be;}return _0x3e79ef>0x3&&_0x5839be&&Object[_0x3dd3fe(0x205)](_0x2251f0,_0x3a912a,_0x5839be),_0x5839be;},__metadata=this&&this[_0x1f531d(0x1d5)]||function(_0x3738df,_0x426697){const _0x1485cf=_0x1f531d;if(typeof Reflect===_0x1485cf(0x1d8)&&typeof Reflect[_0x1485cf(0x1fa)]===_0x1485cf(0x1c1))return Reflect[_0x1485cf(0x1fa)](_0x3738df,_0x426697);},__param=this&&this['__param']||function(_0x5589aa,_0x10bc26){return function(_0x4967a9,_0x19c369){_0x10bc26(_0x4967a9,_0x19c369,_0x5589aa);};},__rest=this&&this[_0x1f531d(0x1e1)]||function(_0x2187fb,_0x2895d6){const _0x4b3cfd=_0x1f531d;var _0x567cc9={};for(var _0x5542d6 in _0x2187fb)if(Object[_0x4b3cfd(0x1f4)][_0x4b3cfd(0x1e6)][_0x4b3cfd(0x1e4)](_0x2187fb,_0x5542d6)&&_0x2895d6['indexOf'](_0x5542d6)<0x0)_0x567cc9[_0x5542d6]=_0x2187fb[_0x5542d6];if(_0x2187fb!=null&&typeof Object[_0x4b3cfd(0x203)]===_0x4b3cfd(0x1c1))for(var _0x14f93d=0x0,_0x5542d6=Object[_0x4b3cfd(0x203)](_0x2187fb);_0x14f93d<_0x5542d6['length'];_0x14f93d++){if(_0x2895d6[_0x4b3cfd(0x1c3)](_0x5542d6[_0x14f93d])<0x0&&Object['prototype'][_0x4b3cfd(0x201)]['call'](_0x2187fb,_0x5542d6[_0x14f93d]))_0x567cc9[_0x5542d6[_0x14f93d]]=_0x2187fb[_0x5542d6[_0x14f93d]];}return _0x567cc9;};Object[_0x1f531d(0x205)](exports,_0x1f531d(0x1ab),{'value':!![]}),exports[_0x1f531d(0x1e8)]=void 0x0;const common_1=require(_0x1f531d(0x1d9)),typeorm_1=require(_0x1f531d(0x1f5)),axios_1=require('axios'),pdf=require(_0x1f531d(0x1d7)),typeorm_2=require('typeorm'),app_entity_1=require(_0x1f531d(0x1b1)),models_service_1=require(_0x1f531d(0x1f8)),chatGroup_entity_1=require('./chatGroup.entity');function _0x2696(){const _0x5b94a6=['275848TCboEf','../app/app.entity','ChatGroupEntity','PDF\x20读取失败:','6473180TFNwsV','config','HttpStatus','Injectable','非法操作、您在使用一个不存在的应用！','ModelsService','删除失败！','非法操作、您在使用一个未启用的应用！','3176964xZQXrF','map','PDF\x20解析失败:','46845YDmaOn','appId','function','updateTime','indexOf','error','DESC','isFileUpload','gpts','应用对话名称不能修改哟！','PDF\x20解析失败','extractPdfText','__decorate','modelInfo','keyType','modelsService','title','log','design:paramtypes','288ogdBWB','deductType','删除成功','__metadata','coverImg','pdf-parse','object','@nestjs/common','请先选择一个对话或者新加一个对话再操作！','InjectRepository','data','5467126cgRIrO','isSticky','appEntity','非法操作、您在删除一个非法资源！','__rest','新对话','stringify','call','find','hasOwnProperty','BAD_REQUEST','ChatGroupService','save','11pRJvSW','getCurrentModelKeyInfo','update','128048yqYMHK','88rJGADL','from','error:\x20','52179sokuCG','affected','getBaseConfig','prototype','@nestjs/typeorm','Repository','del','../models/models.service','decorate','metadata','getOwnPropertyDescriptor','length','chatGroupEntity','findOne','AppEntity','handlePdfExtraction','propertyIsEnumerable','user','getOwnPropertySymbols','parse','defineProperty','324RmBYzk','HttpException','6OhQevW','appLogo','__esModule','deduct','assign','create','delAll'];_0x2696=function(){return _0x5b94a6;};return _0x2696();}function _0x2ab6(_0x53ee57,_0x2e8ecc){const _0x26960f=_0x2696();return _0x2ab6=function(_0x2ab637,_0x3352fe){_0x2ab637=_0x2ab637-0x1a7;let _0x16ed4d=_0x26960f[_0x2ab637];return _0x16ed4d;},_0x2ab6(_0x53ee57,_0x2e8ecc);}let ChatGroupService=class ChatGroupService{constructor(_0x45df9f,_0x1846af,_0x3e4e81){const _0x26dbd8=_0x1f531d;this[_0x26dbd8(0x1fd)]=_0x45df9f,this[_0x26dbd8(0x1df)]=_0x1846af,this[_0x26dbd8(0x1ce)]=_0x3e4e81;}async[_0x1f531d(0x1ae)](_0x412209,_0x459fee){const _0x1a19a9=_0x1f531d,{id:_0x5ab53c}=_0x459fee[_0x1a19a9(0x202)],{appId:_0x432d29,modelConfig:_0x352a43,params:_0xb0836b}=_0x412209;let _0x1a7ea0=_0x352a43||await this['modelsService'][_0x1a19a9(0x1f3)]();if(!_0x1a7ea0)throw new common_1['HttpException']('管理员未配置任何AI模型、请先联系管理员开通聊天模型配置！',common_1[_0x1a19a9(0x1b6)][_0x1a19a9(0x1e7)]);_0x1a7ea0=JSON['parse'](JSON[_0x1a19a9(0x1e3)](_0x1a7ea0));const _0x129b54={'title':_0x1a19a9(0x1e2),'userId':_0x5ab53c,'appId':_0x432d29,'params':_0xb0836b};if(_0x432d29){const _0x4cf94b=await this['appEntity'][_0x1a19a9(0x1fe)]({'where':{'id':_0x432d29}});if(!_0x4cf94b)throw new common_1['HttpException'](_0x1a19a9(0x1b8),common_1[_0x1a19a9(0x1b6)][_0x1a19a9(0x1e7)]);const {status:_0x154fe6,name:_0x4929af,isFixedModel:_0x5a8f0b,isGPTs:_0x3192ac,appModel:_0x4fd3d0,coverImg:_0xd9b495}=_0x4cf94b;Object[_0x1a19a9(0x1ad)](_0x1a7ea0['modelInfo'],{'isGPTs':_0x3192ac,'isFixedModel':_0x5a8f0b,'modelAvatar':_0xd9b495,'modelName':_0x4929af});if(_0x3192ac===0x1||_0x5a8f0b===0x1){const _0x40b1a7=await this[_0x1a19a9(0x1ce)][_0x1a19a9(0x1eb)](_0x5a8f0b===0x1?_0x4fd3d0:_0x1a19a9(0x1c7));Object[_0x1a19a9(0x1ad)](_0x1a7ea0[_0x1a19a9(0x1cc)],{'deductType':_0x40b1a7[_0x1a19a9(0x1d3)],'deduct':_0x40b1a7[_0x1a19a9(0x1ac)],'model':_0x4fd3d0,'isFileUpload':_0x40b1a7[_0x1a19a9(0x1c6)]});}if(![0x1,0x3,0x4,0x5]['includes'](_0x154fe6))throw new common_1['HttpException'](_0x1a19a9(0x1bb),common_1[_0x1a19a9(0x1b6)][_0x1a19a9(0x1e7)]);_0x4929af&&(_0x129b54[_0x1a19a9(0x1cf)]=_0x4929af);}const _0x19e4d4=await this[_0x1a19a9(0x1fd)][_0x1a19a9(0x1e9)](Object[_0x1a19a9(0x1ad)](Object[_0x1a19a9(0x1ad)]({},_0x129b54),{'config':JSON[_0x1a19a9(0x1e3)](_0x1a7ea0)}));return _0x19e4d4;}async['query'](_0x5eec8){const _0x1ac69d=_0x1f531d;try{const {id:_0xb3fa2d}=_0x5eec8[_0x1ac69d(0x202)],_0x47e069={'userId':_0xb3fa2d,'isDelete':![]},_0x5797c6=await this['chatGroupEntity'][_0x1ac69d(0x1e5)]({'where':_0x47e069,'order':{'isSticky':'DESC','updatedAt':_0x1ac69d(0x1c5)}});return _0x5797c6;const _0x3fa569=_0x5797c6['filter'](_0x27bf91=>_0x27bf91[_0x1ac69d(0x1c0)])[_0x1ac69d(0x1bd)](_0x23658d=>_0x23658d[_0x1ac69d(0x1c0)]),_0x3d2fe3=await this[_0x1ac69d(0x1df)][_0x1ac69d(0x1e5)]({'where':{'id':(0x0,typeorm_2['In'])(_0x3fa569)}});return _0x5797c6[_0x1ac69d(0x1bd)](_0x1ffaae=>{const _0x163387=_0x1ac69d;var _0xbb9821;return _0x1ffaae[_0x163387(0x1aa)]=(_0xbb9821=_0x3d2fe3[_0x163387(0x1e5)](_0xc4cf07=>_0xc4cf07['id']===_0x1ffaae[_0x163387(0x1c0)]))===null||_0xbb9821===void 0x0?void 0x0:_0xbb9821[_0x163387(0x1d6)],_0x1ffaae;});}catch(_0x58a163){console[_0x1ac69d(0x1d0)](_0x1ac69d(0x1f0),_0x58a163);}}async['update'](_0x3f000e,_0x21c5a7){const _0x215b53=_0x1f531d,{title:_0x15b659,isSticky:_0x36c32,groupId:_0x2ef7e1,config:_0x661fed,fileUrl:_0x389189}=_0x3f000e,{id:_0x242f13}=_0x21c5a7[_0x215b53(0x202)],_0x2a1ea9=await this[_0x215b53(0x1fd)][_0x215b53(0x1fe)]({'where':{'id':_0x2ef7e1,'userId':_0x242f13}});if(!_0x2a1ea9)throw new common_1[(_0x215b53(0x1a8))](_0x215b53(0x1da),common_1[_0x215b53(0x1b6)][_0x215b53(0x1e7)]);const {appId:_0xe2b463}=_0x2a1ea9;if(_0xe2b463&&!_0x15b659)try{const _0x42d4f4=JSON[_0x215b53(0x204)](_0x661fed);if(Number(_0x42d4f4[_0x215b53(0x1cd)])!==0x1)throw new common_1[(_0x215b53(0x1a8))](_0x215b53(0x1c8),common_1[_0x215b53(0x1b6)][_0x215b53(0x1e7)]);}catch(_0x240400){}const _0xf83e60={};_0x15b659&&(_0xf83e60[_0x215b53(0x1cf)]=_0x15b659),typeof _0x36c32!=='undefined'&&(_0xf83e60[_0x215b53(0x1de)]=_0x36c32),_0x661fed&&(_0xf83e60[_0x215b53(0x1b5)]=_0x661fed),_0x389189&&(_0xf83e60['fileUrl']=_0x389189);const _0x2e5b7e=await this[_0x215b53(0x1fd)][_0x215b53(0x1ec)]({'id':_0x2ef7e1},_0xf83e60);if(_0x2e5b7e['affected'])return _0x389189&&this[_0x215b53(0x200)](_0x389189,_0x2ef7e1),!![];else throw new common_1[(_0x215b53(0x1a8))]('更新对话失败！',common_1[_0x215b53(0x1b6)]['BAD_REQUEST']);}async[_0x1f531d(0x200)](_0xa7e370,_0x34df37){const _0x37fd7b=_0x1f531d;try{const _0xa62d97=await this[_0x37fd7b(0x1ca)](_0xa7e370);await this[_0x37fd7b(0x1fd)][_0x37fd7b(0x1ec)]({'id':_0x34df37},{'pdfTextContent':_0xa62d97});}catch(_0x213081){console[_0x37fd7b(0x1c4)](_0x37fd7b(0x1b3),_0x213081);}}async[_0x1f531d(0x1ca)](_0xf0fff7){const _0x57314a=_0x1f531d;try{const _0x4239c5=await axios_1['default']['get'](_0xf0fff7,{'responseType':'arraybuffer'}),_0x920a05=Buffer[_0x57314a(0x1ef)](_0x4239c5[_0x57314a(0x1dc)]),_0x113b6f=await pdf(_0x920a05);return _0x113b6f['text'];}catch(_0x5d8c4f){console[_0x57314a(0x1c4)](_0x57314a(0x1be),_0x5d8c4f);throw new Error(_0x57314a(0x1c9));}}async[_0x1f531d(0x1c2)](_0x128ca5){const _0x37c4fd=_0x1f531d;await this['chatGroupEntity'][_0x37c4fd(0x1ec)](_0x128ca5,{'updatedAt':new Date()});}async[_0x1f531d(0x1f7)](_0x59a2ba,_0x33cacc){const _0x29f678=_0x1f531d,{groupId:_0x49eb0d}=_0x59a2ba,{id:_0xb577ce}=_0x33cacc[_0x29f678(0x202)],_0x4bf464=await this['chatGroupEntity'][_0x29f678(0x1fe)]({'where':{'id':_0x49eb0d,'userId':_0xb577ce}});if(!_0x4bf464)throw new common_1[(_0x29f678(0x1a8))](_0x29f678(0x1e0),common_1[_0x29f678(0x1b6)][_0x29f678(0x1e7)]);const _0x4a874f=await this[_0x29f678(0x1fd)][_0x29f678(0x1ec)]({'id':_0x49eb0d},{'isDelete':!![]});if(_0x4a874f[_0x29f678(0x1f2)])return _0x29f678(0x1d4);else throw new common_1['HttpException'](_0x29f678(0x1ba),common_1[_0x29f678(0x1b6)][_0x29f678(0x1e7)]);}async[_0x1f531d(0x1af)](_0x7ed9d7){const _0x470fb9=_0x1f531d,{id:_0x4c6b08}=_0x7ed9d7[_0x470fb9(0x202)],_0x33d82f=await this[_0x470fb9(0x1fd)]['update']({'userId':_0x4c6b08,'isSticky':![],'isDelete':![]},{'isDelete':!![]});if(_0x33d82f[_0x470fb9(0x1f2)])return _0x470fb9(0x1d4);else throw new common_1['HttpException'](_0x470fb9(0x1ba),common_1[_0x470fb9(0x1b6)][_0x470fb9(0x1e7)]);}async['getGroupInfoFromId'](_0x2ebe03){const _0x3e118e=_0x1f531d;if(!_0x2ebe03)return;const _0x471764=await this[_0x3e118e(0x1fd)][_0x3e118e(0x1fe)]({'where':{'id':_0x2ebe03}});if(_0x471764){const {pdfTextContent:_0x28f461}=_0x471764,_0x56a006=__rest(_0x471764,['pdfTextContent']);return _0x56a006;}}async['getGroupPdfText'](_0x11f24a){const _0x1c62f2=_0x1f531d,_0x1981cb=await this['chatGroupEntity'][_0x1c62f2(0x1fe)]({'where':{'id':_0x11f24a}});if(_0x1981cb)return _0x1981cb['pdfTextContent'];}};ChatGroupService=__decorate([(0x0,common_1[_0x1f531d(0x1b7)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(chatGroup_entity_1[_0x1f531d(0x1b2)])),__param(0x1,(0x0,typeorm_1[_0x1f531d(0x1db)])(app_entity_1[_0x1f531d(0x1ff)])),__metadata(_0x1f531d(0x1d1),[typeorm_2[_0x1f531d(0x1f6)],typeorm_2['Repository'],models_service_1[_0x1f531d(0x1b9)]])],ChatGroupService),exports[_0x1f531d(0x1e8)]=ChatGroupService;