'use strict';const _0xba6707=_0x2032;(function(_0x112834,_0x20b791){const _0x3898b4=_0x2032,_0x305506=_0x112834();while(!![]){try{const _0x4277c0=parseInt(_0x3898b4(0x1ef))/0x1+-parseInt(_0x3898b4(0x1af))/0x2*(parseInt(_0x3898b4(0x1e0))/0x3)+parseInt(_0x3898b4(0x1d5))/0x4*(parseInt(_0x3898b4(0x1b4))/0x5)+parseInt(_0x3898b4(0x1f9))/0x6*(-parseInt(_0x3898b4(0x1ac))/0x7)+-parseInt(_0x3898b4(0x202))/0x8+-parseInt(_0x3898b4(0x1cb))/0x9*(parseInt(_0x3898b4(0x1d3))/0xa)+parseInt(_0x3898b4(0x1f2))/0xb;if(_0x4277c0===_0x20b791)break;else _0x305506['push'](_0x305506['shift']());}catch(_0x431ceb){_0x305506['push'](_0x305506['shift']());}}}(_0x4e59,0x3692e));var __decorate=this&&this[_0xba6707(0x1ea)]||function(_0x189151,_0x272582,_0x3666ca,_0xa714a6){const _0x130d97=_0xba6707;var _0x4abcac=arguments[_0x130d97(0x1f0)],_0x4c0596=_0x4abcac<0x3?_0x272582:_0xa714a6===null?_0xa714a6=Object[_0x130d97(0x1aa)](_0x272582,_0x3666ca):_0xa714a6,_0x99908b;if(typeof Reflect===_0x130d97(0x1b9)&&typeof Reflect[_0x130d97(0x1c3)]===_0x130d97(0x1fb))_0x4c0596=Reflect[_0x130d97(0x1c3)](_0x189151,_0x272582,_0x3666ca,_0xa714a6);else{for(var _0x71cc74=_0x189151[_0x130d97(0x1f0)]-0x1;_0x71cc74>=0x0;_0x71cc74--)if(_0x99908b=_0x189151[_0x71cc74])_0x4c0596=(_0x4abcac<0x3?_0x99908b(_0x4c0596):_0x4abcac>0x3?_0x99908b(_0x272582,_0x3666ca,_0x4c0596):_0x99908b(_0x272582,_0x3666ca))||_0x4c0596;}return _0x4abcac>0x3&&_0x4c0596&&Object[_0x130d97(0x208)](_0x272582,_0x3666ca,_0x4c0596),_0x4c0596;},__metadata=this&&this['__metadata']||function(_0x143243,_0x150e7e){const _0x2817fb=_0xba6707;if(typeof Reflect==='object'&&typeof Reflect['metadata']===_0x2817fb(0x1fb))return Reflect[_0x2817fb(0x1e7)](_0x143243,_0x150e7e);},__param=this&&this[_0xba6707(0x1b8)]||function(_0x113785,_0x50d0f5){return function(_0x114152,_0x484bea){_0x50d0f5(_0x114152,_0x484bea,_0x113785);};},__rest=this&&this[_0xba6707(0x1fd)]||function(_0x41728e,_0x27e3b5){const _0x3c7ef3=_0xba6707;var _0x4ee5ef={};for(var _0x4ffd4a in _0x41728e)if(Object['prototype']['hasOwnProperty'][_0x3c7ef3(0x1cd)](_0x41728e,_0x4ffd4a)&&_0x27e3b5[_0x3c7ef3(0x1ce)](_0x4ffd4a)<0x0)_0x4ee5ef[_0x4ffd4a]=_0x41728e[_0x4ffd4a];if(_0x41728e!=null&&typeof Object['getOwnPropertySymbols']===_0x3c7ef3(0x1fb))for(var _0x351528=0x0,_0x4ffd4a=Object['getOwnPropertySymbols'](_0x41728e);_0x351528<_0x4ffd4a[_0x3c7ef3(0x1f0)];_0x351528++){if(_0x27e3b5[_0x3c7ef3(0x1ce)](_0x4ffd4a[_0x351528])<0x0&&Object['prototype'][_0x3c7ef3(0x1c6)]['call'](_0x41728e,_0x4ffd4a[_0x351528]))_0x4ee5ef[_0x4ffd4a[_0x351528]]=_0x41728e[_0x4ffd4a[_0x351528]];}return _0x4ee5ef;};Object['defineProperty'](exports,_0xba6707(0x1f7),{'value':!![]}),exports[_0xba6707(0x1f1)]=void 0x0;const common_1=require(_0xba6707(0x1c9)),typeorm_1=require(_0xba6707(0x1da)),axios_1=require(_0xba6707(0x205)),pdf=require('pdf-parse'),typeorm_2=require(_0xba6707(0x1d9)),app_entity_1=require(_0xba6707(0x1e5)),models_service_1=require('../models/models.service'),chatGroup_entity_1=require(_0xba6707(0x1f6));let ChatGroupService=class ChatGroupService{constructor(_0x27cbf7,_0x2c48bb,_0x528830){const _0x35bd61=_0xba6707;this[_0x35bd61(0x1d0)]=_0x27cbf7,this[_0x35bd61(0x203)]=_0x2c48bb,this['modelsService']=_0x528830;}async[_0xba6707(0x209)](_0x4dd3e0,_0x1e6a0a){const _0x1e2a60=_0xba6707,{id:_0x45ceba}=_0x1e6a0a[_0x1e2a60(0x1e3)],{appId:_0x31b9b3,modelConfig:_0x2af80e,params:_0x54ceb1}=_0x4dd3e0;let _0xc5dad1=_0x2af80e||await this[_0x1e2a60(0x1ad)][_0x1e2a60(0x1e6)]();if(!_0xc5dad1)throw new common_1[(_0x1e2a60(0x1dc))](_0x1e2a60(0x1fa),common_1[_0x1e2a60(0x1c4)][_0x1e2a60(0x1bb)]);_0xc5dad1=JSON['parse'](JSON[_0x1e2a60(0x1cc)](_0xc5dad1));const _0x3ebe6d={'title':_0x1e2a60(0x1c0),'userId':_0x45ceba,'appId':_0x31b9b3,'params':_0x54ceb1};if(_0x31b9b3){const _0x2bbfd2=await this[_0x1e2a60(0x203)][_0x1e2a60(0x1d1)]({'where':{'id':_0x31b9b3}});if(!_0x2bbfd2)throw new common_1['HttpException'](_0x1e2a60(0x1bf),common_1['HttpStatus']['BAD_REQUEST']);const {status:_0x3d1e0a,name:_0x3769b8,isFixedModel:_0x250f4f,isGPTs:_0x4082ff,appModel:_0x34c6be,coverImg:_0x44c930}=_0x2bbfd2;Object[_0x1e2a60(0x1cf)](_0xc5dad1[_0x1e2a60(0x1fc)],{'isGPTs':_0x4082ff,'isFixedModel':_0x250f4f,'modelAvatar':_0x44c930,'modelName':_0x3769b8});if(_0x4082ff===0x1||_0x250f4f===0x1){const _0x447b6a=await this[_0x1e2a60(0x1ad)][_0x1e2a60(0x1e8)](_0x250f4f===0x1?_0x34c6be:'gpts');Object[_0x1e2a60(0x1cf)](_0xc5dad1['modelInfo'],{'deductType':_0x447b6a[_0x1e2a60(0x1d7)],'deduct':_0x447b6a[_0x1e2a60(0x1ab)],'model':_0x34c6be,'isFileUpload':_0x447b6a[_0x1e2a60(0x1ec)]});}if(![0x1,0x3,0x4,0x5]['includes'](_0x3d1e0a))throw new common_1[(_0x1e2a60(0x1dc))](_0x1e2a60(0x1ff),common_1[_0x1e2a60(0x1c4)][_0x1e2a60(0x1bb)]);_0x3769b8&&(_0x3ebe6d[_0x1e2a60(0x1e4)]=_0x3769b8);}const _0x557bba=await this[_0x1e2a60(0x1d0)][_0x1e2a60(0x1c5)](Object[_0x1e2a60(0x1cf)](Object[_0x1e2a60(0x1cf)]({},_0x3ebe6d),{'config':JSON['stringify'](_0xc5dad1)}));return _0x557bba;}async['query'](_0x3eaa74){const _0x315008=_0xba6707;try{const {id:_0xecdb0c}=_0x3eaa74[_0x315008(0x1e3)],_0x2b20a4={'userId':_0xecdb0c,'isDelete':![]},_0x3559fa=await this[_0x315008(0x1d0)][_0x315008(0x206)]({'where':_0x2b20a4,'order':{'isSticky':_0x315008(0x1d4),'updatedAt':_0x315008(0x1d4)}});return _0x3559fa;const _0xe87e6e=_0x3559fa[_0x315008(0x1bc)](_0x1d130a=>_0x1d130a[_0x315008(0x201)])[_0x315008(0x207)](_0x26e07f=>_0x26e07f['appId']),_0x40c0d6=await this['appEntity']['find']({'where':{'id':(0x0,typeorm_2['In'])(_0xe87e6e)}});return _0x3559fa[_0x315008(0x207)](_0x3a8542=>{const _0x3275e6=_0x315008;var _0x25278b;return _0x3a8542[_0x3275e6(0x200)]=(_0x25278b=_0x40c0d6[_0x3275e6(0x206)](_0xc4bdec=>_0xc4bdec['id']===_0x3a8542[_0x3275e6(0x201)]))===null||_0x25278b===void 0x0?void 0x0:_0x25278b['coverImg'],_0x3a8542;});}catch(_0x44e266){console[_0x315008(0x1b2)](_0x315008(0x1db),_0x44e266);}}async[_0xba6707(0x1ca)](_0x1294ec,_0x1baea0){const _0x4c92d5=_0xba6707,{title:_0x2f3f12,isSticky:_0x4cf3c6,groupId:_0x4853e1,config:_0x48e159,fileUrl:_0x2f6419}=_0x1294ec,{id:_0x874e33}=_0x1baea0[_0x4c92d5(0x1e3)],_0xd22fe4=await this[_0x4c92d5(0x1d0)][_0x4c92d5(0x1d1)]({'where':{'id':_0x4853e1,'userId':_0x874e33}});if(!_0xd22fe4)throw new common_1[(_0x4c92d5(0x1dc))](_0x4c92d5(0x1ee),common_1[_0x4c92d5(0x1c4)][_0x4c92d5(0x1bb)]);const {appId:_0x4eabaa}=_0xd22fe4;if(_0x4eabaa&&!_0x2f3f12)try{const _0x4955e3=JSON['parse'](_0x48e159);if(Number(_0x4955e3[_0x4c92d5(0x1b3)])!==0x1)throw new common_1[(_0x4c92d5(0x1dc))](_0x4c92d5(0x1f8),common_1[_0x4c92d5(0x1c4)]['BAD_REQUEST']);}catch(_0x2e8f48){}const _0x4da418={};_0x2f3f12&&(_0x4da418[_0x4c92d5(0x1e4)]=_0x2f3f12),typeof _0x4cf3c6!=='undefined'&&(_0x4da418['isSticky']=_0x4cf3c6),_0x48e159&&(_0x4da418[_0x4c92d5(0x1c7)]=_0x48e159),_0x2f6419&&(_0x4da418['fileUrl']=_0x2f6419);const _0x549f38=await this[_0x4c92d5(0x1d0)][_0x4c92d5(0x1ca)]({'id':_0x4853e1},_0x4da418);if(_0x549f38[_0x4c92d5(0x1ae)])return _0x2f6419&&this[_0x4c92d5(0x1d8)](_0x2f6419,_0x4853e1),!![];else throw new common_1[(_0x4c92d5(0x1dc))](_0x4c92d5(0x1e2),common_1[_0x4c92d5(0x1c4)][_0x4c92d5(0x1bb)]);}async[_0xba6707(0x1d8)](_0x1c6977,_0x77c7dc){const _0x897153=_0xba6707;try{const _0x278fde=await this[_0x897153(0x1b7)](_0x1c6977);await this[_0x897153(0x1d0)]['update']({'id':_0x77c7dc},{'pdfTextContent':_0x278fde});}catch(_0x5691f6){console[_0x897153(0x1d2)](_0x897153(0x1b0),_0x5691f6);}}async['extractPdfText'](_0x4c9884){const _0x278148=_0xba6707;try{const _0x582729=await axios_1[_0x278148(0x1c8)][_0x278148(0x204)](_0x4c9884,{'responseType':_0x278148(0x1f4)}),_0x3c030a=Buffer[_0x278148(0x1b1)](_0x582729[_0x278148(0x1dd)]),_0x194418=await pdf(_0x3c030a);return _0x194418[_0x278148(0x1f3)];}catch(_0x1ab885){console[_0x278148(0x1d2)]('PDF\x20解析失败:',_0x1ab885);throw new Error('PDF\x20解析失败');}}async[_0xba6707(0x1ba)](_0x18dcb6){const _0x1ab835=_0xba6707;await this[_0x1ab835(0x1d0)]['update'](_0x18dcb6,{'updatedAt':new Date()});}async[_0xba6707(0x1bd)](_0x28e5f0,_0xf398da){const _0x3ebf70=_0xba6707,{groupId:_0x2970bc}=_0x28e5f0,{id:_0x3fcae3}=_0xf398da[_0x3ebf70(0x1e3)],_0x122809=await this['chatGroupEntity'][_0x3ebf70(0x1d1)]({'where':{'id':_0x2970bc,'userId':_0x3fcae3}});if(!_0x122809)throw new common_1[(_0x3ebf70(0x1dc))](_0x3ebf70(0x1fe),common_1[_0x3ebf70(0x1c4)][_0x3ebf70(0x1bb)]);const _0x11478d=await this['chatGroupEntity']['update']({'id':_0x2970bc},{'isDelete':!![]});if(_0x11478d[_0x3ebf70(0x1ae)])return _0x3ebf70(0x1c2);else throw new common_1['HttpException'](_0x3ebf70(0x1f5),common_1['HttpStatus'][_0x3ebf70(0x1bb)]);}async[_0xba6707(0x1e1)](_0x5dc14d){const _0x4e56e1=_0xba6707,{id:_0x15d67b}=_0x5dc14d[_0x4e56e1(0x1e3)],_0x2e81c6=await this[_0x4e56e1(0x1d0)][_0x4e56e1(0x1ca)]({'userId':_0x15d67b,'isSticky':![],'isDelete':![]},{'isDelete':!![]});if(_0x2e81c6[_0x4e56e1(0x1ae)])return _0x4e56e1(0x1c2);else throw new common_1[(_0x4e56e1(0x1dc))](_0x4e56e1(0x1f5),common_1['HttpStatus'][_0x4e56e1(0x1bb)]);}async[_0xba6707(0x1be)](_0x300578){const _0x51302f=_0xba6707;if(!_0x300578)return;const _0x482a52=await this[_0x51302f(0x1d0)][_0x51302f(0x1d1)]({'where':{'id':_0x300578}});if(_0x482a52){const {pdfTextContent:_0x55df1c}=_0x482a52,_0x42612d=__rest(_0x482a52,[_0x51302f(0x1ed)]);return _0x42612d;}}async[_0xba6707(0x1e9)](_0x3ddcd2){const _0x403e06=_0xba6707,_0x302969=await this['chatGroupEntity'][_0x403e06(0x1d1)]({'where':{'id':_0x3ddcd2}});if(_0x302969)return _0x302969[_0x403e06(0x1ed)];}};function _0x2032(_0x4ca155,_0x3c209b){const _0x4e59e6=_0x4e59();return _0x2032=function(_0x2032a4,_0x499c74){_0x2032a4=_0x2032a4-0x1aa;let _0x511fc4=_0x4e59e6[_0x2032a4];return _0x511fc4;},_0x2032(_0x4ca155,_0x3c209b);}ChatGroupService=__decorate([(0x0,common_1[_0xba6707(0x1eb)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(chatGroup_entity_1[_0xba6707(0x1b6)])),__param(0x1,(0x0,typeorm_1[_0xba6707(0x1d6)])(app_entity_1[_0xba6707(0x1b5)])),__metadata(_0xba6707(0x1df),[typeorm_2[_0xba6707(0x1de)],typeorm_2[_0xba6707(0x1de)],models_service_1[_0xba6707(0x1c1)]])],ChatGroupService),exports[_0xba6707(0x1f1)]=ChatGroupService;function _0x4e59(){const _0x4bc934=['text','arraybuffer','删除失败！','./chatGroup.entity','__esModule','应用对话名称不能修改哟！','456UXDEuq','管理员未配置任何AI模型、请先联系管理员开通聊天模型配置！','function','modelInfo','__rest','非法操作、您在删除一个非法资源！','非法操作、您在使用一个未启用的应用！','appLogo','appId','871232ljCvwH','appEntity','get','axios','find','map','defineProperty','create','getOwnPropertyDescriptor','deduct','25928tjyqdi','modelsService','affected','15214iDdSHl','PDF\x20读取失败:','from','log','keyType','234335nmIUeH','AppEntity','ChatGroupEntity','extractPdfText','__param','object','updateTime','BAD_REQUEST','filter','del','getGroupInfoFromId','非法操作、您在使用一个不存在的应用！','新对话','ModelsService','删除成功','decorate','HttpStatus','save','propertyIsEnumerable','config','default','@nestjs/common','update','81iCSzhn','stringify','call','indexOf','assign','chatGroupEntity','findOne','error','376590pIRBHX','DESC','4giJtIg','InjectRepository','deductType','handlePdfExtraction','typeorm','@nestjs/typeorm','error:\x20','HttpException','data','Repository','design:paramtypes','153fsckxo','delAll','更新对话失败！','user','title','../app/app.entity','getBaseConfig','metadata','getCurrentModelKeyInfo','getGroupPdfText','__decorate','Injectable','isFileUpload','pdfTextContent','请先选择一个对话或者新加一个对话再操作！','152148KqwBfu','length','ChatGroupService','12559965PvSLBU'];_0x4e59=function(){return _0x4bc934;};return _0x4e59();}