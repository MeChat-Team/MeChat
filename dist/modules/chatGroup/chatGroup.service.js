'use strict';const _0x131dfe=_0x5753;(function(_0x4d4c2f,_0x2f4a1b){const _0x346423=_0x5753,_0x2cf10b=_0x4d4c2f();while(!![]){try{const _0x5ab6aa=-parseInt(_0x346423(0x109))/0x1*(-parseInt(_0x346423(0xc7))/0x2)+-parseInt(_0x346423(0xbf))/0x3+-parseInt(_0x346423(0x105))/0x4+parseInt(_0x346423(0xfa))/0x5*(parseInt(_0x346423(0x10f))/0x6)+-parseInt(_0x346423(0xd7))/0x7+-parseInt(_0x346423(0x10e))/0x8+parseInt(_0x346423(0xc3))/0x9;if(_0x5ab6aa===_0x2f4a1b)break;else _0x2cf10b['push'](_0x2cf10b['shift']());}catch(_0x3d8345){_0x2cf10b['push'](_0x2cf10b['shift']());}}}(_0x4521,0x5f8c4));var __decorate=this&&this[_0x131dfe(0xfd)]||function(_0x2ac7dc,_0x321cd4,_0x67a483,_0x4cda3f){const _0x5cc3b1=_0x131dfe;var _0x3806ab=arguments[_0x5cc3b1(0xcc)],_0x217a57=_0x3806ab<0x3?_0x321cd4:_0x4cda3f===null?_0x4cda3f=Object[_0x5cc3b1(0x10c)](_0x321cd4,_0x67a483):_0x4cda3f,_0x4c75c2;if(typeof Reflect===_0x5cc3b1(0x106)&&typeof Reflect[_0x5cc3b1(0xd0)]===_0x5cc3b1(0xe6))_0x217a57=Reflect[_0x5cc3b1(0xd0)](_0x2ac7dc,_0x321cd4,_0x67a483,_0x4cda3f);else{for(var _0x22ffa5=_0x2ac7dc[_0x5cc3b1(0xcc)]-0x1;_0x22ffa5>=0x0;_0x22ffa5--)if(_0x4c75c2=_0x2ac7dc[_0x22ffa5])_0x217a57=(_0x3806ab<0x3?_0x4c75c2(_0x217a57):_0x3806ab>0x3?_0x4c75c2(_0x321cd4,_0x67a483,_0x217a57):_0x4c75c2(_0x321cd4,_0x67a483))||_0x217a57;}return _0x3806ab>0x3&&_0x217a57&&Object[_0x5cc3b1(0xf9)](_0x321cd4,_0x67a483,_0x217a57),_0x217a57;},__metadata=this&&this['__metadata']||function(_0x5f0e66,_0x36d4ca){const _0x1048da=_0x131dfe;if(typeof Reflect===_0x1048da(0x106)&&typeof Reflect[_0x1048da(0xc6)]==='function')return Reflect['metadata'](_0x5f0e66,_0x36d4ca);},__param=this&&this[_0x131dfe(0x112)]||function(_0x1851e7,_0x2f8e42){return function(_0x197673,_0x2393d5){_0x2f8e42(_0x197673,_0x2393d5,_0x1851e7);};},__rest=this&&this['__rest']||function(_0x37e5f3,_0x524a90){const _0x2a67da=_0x131dfe;var _0x1016d3={};for(var _0x5d1fcd in _0x37e5f3)if(Object[_0x2a67da(0x107)][_0x2a67da(0xda)]['call'](_0x37e5f3,_0x5d1fcd)&&_0x524a90[_0x2a67da(0xe4)](_0x5d1fcd)<0x0)_0x1016d3[_0x5d1fcd]=_0x37e5f3[_0x5d1fcd];if(_0x37e5f3!=null&&typeof Object['getOwnPropertySymbols']===_0x2a67da(0xe6))for(var _0x481b2b=0x0,_0x5d1fcd=Object['getOwnPropertySymbols'](_0x37e5f3);_0x481b2b<_0x5d1fcd['length'];_0x481b2b++){if(_0x524a90[_0x2a67da(0xe4)](_0x5d1fcd[_0x481b2b])<0x0&&Object[_0x2a67da(0x107)]['propertyIsEnumerable'][_0x2a67da(0xdd)](_0x37e5f3,_0x5d1fcd[_0x481b2b]))_0x1016d3[_0x5d1fcd[_0x481b2b]]=_0x37e5f3[_0x5d1fcd[_0x481b2b]];}return _0x1016d3;};Object[_0x131dfe(0xf9)](exports,_0x131dfe(0xd9),{'value':!![]}),exports[_0x131dfe(0xfc)]=void 0x0;const common_1=require(_0x131dfe(0xe1)),typeorm_1=require(_0x131dfe(0x102)),axios_1=require(_0x131dfe(0x10d)),pdf=require(_0x131dfe(0xf3)),typeorm_2=require(_0x131dfe(0xe3)),app_entity_1=require('../app/app.entity'),models_service_1=require('../models/models.service'),chatGroup_entity_1=require(_0x131dfe(0xe7));function _0x5753(_0xba374b,_0x37d3d8){const _0x452140=_0x4521();return _0x5753=function(_0x575314,_0x37c63b){_0x575314=_0x575314-0xbf;let _0x4d7b40=_0x452140[_0x575314];return _0x4d7b40;},_0x5753(_0xba374b,_0x37d3d8);}function _0x4521(){const _0x554fcc=['length','user','modelsService','appEntity','decorate','chatGroupEntity','map','删除失败！','assign','default','更新对话失败！','3205482doTLxU','删除成功','__esModule','hasOwnProperty','error','includes','call','getCurrentModelKeyInfo','pdfTextContent','findOne','@nestjs/common','DESC','typeorm','indexOf','deduct','function','./chatGroup.entity','config','handlePdfExtraction','design:paramtypes','update','BAD_REQUEST','title','affected','undefined','gpts','get','Repository','pdf-parse','from','deductType','管理员未配置任何AI模型、请先联系管理员开通聊天模型配置！','HttpStatus','非法操作、您在删除一个非法资源！','defineProperty','2173075WPIxQo','HttpException','ChatGroupService','__decorate','keyType','getGroupInfoFromId','find','PDF\x20解析失败','@nestjs/typeorm','getGroupPdfText','新对话','2365788UNacSI','object','prototype','filter','1FShOKX','isFileUpload','ChatGroupEntity','getOwnPropertyDescriptor','axios','6214408hOXEjL','6agQErQ','Injectable','AppEntity','__param','parse','InjectRepository','922176EHdxqe','extractPdfText','stringify','appLogo','17877366Fdtrrm','appId','delAll','metadata','207882GYccNY','create','error:\x20','modelInfo','PDF\x20读取失败:'];_0x4521=function(){return _0x554fcc;};return _0x4521();}let ChatGroupService=class ChatGroupService{constructor(_0x5a1a7b,_0x4eddd2,_0x15320a){const _0x429bd2=_0x131dfe;this[_0x429bd2(0xd1)]=_0x5a1a7b,this[_0x429bd2(0xcf)]=_0x4eddd2,this[_0x429bd2(0xce)]=_0x15320a;}async[_0x131dfe(0xc8)](_0x54435f,_0x3d2522){const _0x36c60e=_0x131dfe,{id:_0x393a95}=_0x3d2522[_0x36c60e(0xcd)],{appId:_0x5a3305,modelConfig:_0x42079e,params:_0x3f4f6e}=_0x54435f;let _0x5aa3ae=_0x42079e||await this[_0x36c60e(0xce)]['getBaseConfig']();if(!_0x5aa3ae)throw new common_1[(_0x36c60e(0xfb))](_0x36c60e(0xf6),common_1['HttpStatus'][_0x36c60e(0xec)]);_0x5aa3ae=JSON[_0x36c60e(0x113)](JSON[_0x36c60e(0xc1)](_0x5aa3ae));const _0x50468d={'title':_0x36c60e(0x104),'userId':_0x393a95,'appId':_0x5a3305,'params':_0x3f4f6e};if(_0x5a3305){const _0x9908b3=await this['appEntity'][_0x36c60e(0xe0)]({'where':{'id':_0x5a3305}});if(!_0x9908b3)throw new common_1['HttpException']('非法操作、您在使用一个不存在的应用！',common_1[_0x36c60e(0xf7)][_0x36c60e(0xec)]);const {status:_0x7f2170,name:_0x4f3897,isFixedModel:_0x39f61d,isGPTs:_0x2857f9,appModel:_0x265e33,coverImg:_0x4f231e}=_0x9908b3;Object[_0x36c60e(0xd4)](_0x5aa3ae[_0x36c60e(0xca)],{'isGPTs':_0x2857f9,'isFixedModel':_0x39f61d,'modelAvatar':_0x4f231e,'modelName':_0x4f3897});if(_0x2857f9===0x1||_0x39f61d===0x1){const _0x506cdd=await this['modelsService'][_0x36c60e(0xde)](_0x39f61d===0x1?_0x265e33:_0x36c60e(0xf0));Object[_0x36c60e(0xd4)](_0x5aa3ae[_0x36c60e(0xca)],{'deductType':_0x506cdd[_0x36c60e(0xf5)],'deduct':_0x506cdd[_0x36c60e(0xe5)],'model':_0x265e33,'isFileUpload':_0x506cdd[_0x36c60e(0x10a)]});}if(![0x1,0x3,0x4,0x5][_0x36c60e(0xdc)](_0x7f2170))throw new common_1[(_0x36c60e(0xfb))]('非法操作、您在使用一个未启用的应用！',common_1['HttpStatus'][_0x36c60e(0xec)]);_0x4f3897&&(_0x50468d['title']=_0x4f3897);}const _0x2564a4=await this['chatGroupEntity']['save'](Object['assign'](Object[_0x36c60e(0xd4)]({},_0x50468d),{'config':JSON[_0x36c60e(0xc1)](_0x5aa3ae)}));return _0x2564a4;}async['query'](_0x384c07){const _0x4bada4=_0x131dfe;try{const {id:_0x361f5d}=_0x384c07[_0x4bada4(0xcd)],_0x186497={'userId':_0x361f5d,'isDelete':![]},_0x2a3b96=await this[_0x4bada4(0xd1)][_0x4bada4(0x100)]({'where':_0x186497,'order':{'isSticky':'DESC','updatedAt':_0x4bada4(0xe2)}});return _0x2a3b96;const _0x355631=_0x2a3b96[_0x4bada4(0x108)](_0x45119b=>_0x45119b['appId'])[_0x4bada4(0xd2)](_0x1c2fd3=>_0x1c2fd3['appId']),_0xc6780=await this[_0x4bada4(0xcf)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x355631)}});return _0x2a3b96['map'](_0x3afcb1=>{const _0x5a1113=_0x4bada4;var _0x45d0ee;return _0x3afcb1[_0x5a1113(0xc2)]=(_0x45d0ee=_0xc6780[_0x5a1113(0x100)](_0x1f9c9e=>_0x1f9c9e['id']===_0x3afcb1[_0x5a1113(0xc4)]))===null||_0x45d0ee===void 0x0?void 0x0:_0x45d0ee['coverImg'],_0x3afcb1;});}catch(_0x308060){console['log'](_0x4bada4(0xc9),_0x308060);}}async['update'](_0x35c5e5,_0x24937e){const _0x1e49b3=_0x131dfe,{title:_0x59c32b,isSticky:_0x46ee5a,groupId:_0x258e73,config:_0xf6363e,fileUrl:_0x1b3fdd}=_0x35c5e5,{id:_0x48b03f}=_0x24937e[_0x1e49b3(0xcd)],_0xd64820=await this[_0x1e49b3(0xd1)][_0x1e49b3(0xe0)]({'where':{'id':_0x258e73,'userId':_0x48b03f}});if(!_0xd64820)throw new common_1[(_0x1e49b3(0xfb))]('请先选择一个对话或者新加一个对话再操作！',common_1['HttpStatus'][_0x1e49b3(0xec)]);const {appId:_0x3a0f0c}=_0xd64820;if(_0x3a0f0c&&!_0x59c32b)try{const _0x1a44f8=JSON['parse'](_0xf6363e);if(Number(_0x1a44f8[_0x1e49b3(0xfe)])!==0x1)throw new common_1['HttpException']('应用对话名称不能修改哟！',common_1[_0x1e49b3(0xf7)][_0x1e49b3(0xec)]);}catch(_0x49cc92){}const _0x3f94f1={};_0x59c32b&&(_0x3f94f1[_0x1e49b3(0xed)]=_0x59c32b),typeof _0x46ee5a!==_0x1e49b3(0xef)&&(_0x3f94f1['isSticky']=_0x46ee5a),_0xf6363e&&(_0x3f94f1[_0x1e49b3(0xe8)]=_0xf6363e),_0x1b3fdd&&(_0x3f94f1['fileUrl']=_0x1b3fdd);const _0x3ca2ec=await this[_0x1e49b3(0xd1)][_0x1e49b3(0xeb)]({'id':_0x258e73},_0x3f94f1);if(_0x3ca2ec[_0x1e49b3(0xee)])return _0x1b3fdd&&this[_0x1e49b3(0xe9)](_0x1b3fdd,_0x258e73),!![];else throw new common_1[(_0x1e49b3(0xfb))](_0x1e49b3(0xd6),common_1[_0x1e49b3(0xf7)][_0x1e49b3(0xec)]);}async['handlePdfExtraction'](_0x31a438,_0x489c3c){const _0x4f641f=_0x131dfe;try{const _0x464994=await this[_0x4f641f(0xc0)](_0x31a438);await this[_0x4f641f(0xd1)][_0x4f641f(0xeb)]({'id':_0x489c3c},{'pdfTextContent':_0x464994});}catch(_0x455d27){console[_0x4f641f(0xdb)](_0x4f641f(0xcb),_0x455d27);}}async[_0x131dfe(0xc0)](_0x1575bc){const _0x48a5c2=_0x131dfe;try{const _0x9e15e4=await axios_1[_0x48a5c2(0xd5)][_0x48a5c2(0xf1)](_0x1575bc,{'responseType':'arraybuffer'}),_0x499dec=Buffer[_0x48a5c2(0xf4)](_0x9e15e4['data']),_0x247fce=await pdf(_0x499dec);return _0x247fce['text'];}catch(_0x204e07){console['error']('PDF\x20解析失败:',_0x204e07);throw new Error(_0x48a5c2(0x101));}}async['updateTime'](_0x79bb60){const _0x17958e=_0x131dfe;await this[_0x17958e(0xd1)][_0x17958e(0xeb)](_0x79bb60,{'updatedAt':new Date()});}async['del'](_0x1a754e,_0xbb1256){const _0x2baef0=_0x131dfe,{groupId:_0x2c90a5}=_0x1a754e,{id:_0xf35e05}=_0xbb1256[_0x2baef0(0xcd)],_0x452ef1=await this[_0x2baef0(0xd1)][_0x2baef0(0xe0)]({'where':{'id':_0x2c90a5,'userId':_0xf35e05}});if(!_0x452ef1)throw new common_1[(_0x2baef0(0xfb))](_0x2baef0(0xf8),common_1[_0x2baef0(0xf7)][_0x2baef0(0xec)]);const _0x5de140=await this[_0x2baef0(0xd1)]['update']({'id':_0x2c90a5},{'isDelete':!![]});if(_0x5de140[_0x2baef0(0xee)])return _0x2baef0(0xd8);else throw new common_1[(_0x2baef0(0xfb))](_0x2baef0(0xd3),common_1[_0x2baef0(0xf7)]['BAD_REQUEST']);}async[_0x131dfe(0xc5)](_0x13ee66){const _0x45a79b=_0x131dfe,{id:_0x12b73d}=_0x13ee66[_0x45a79b(0xcd)],_0x2ad085=await this[_0x45a79b(0xd1)][_0x45a79b(0xeb)]({'userId':_0x12b73d,'isSticky':![],'isDelete':![]},{'isDelete':!![]});if(_0x2ad085[_0x45a79b(0xee)])return _0x45a79b(0xd8);else throw new common_1[(_0x45a79b(0xfb))](_0x45a79b(0xd3),common_1['HttpStatus'][_0x45a79b(0xec)]);}async[_0x131dfe(0xff)](_0x3e70c6){const _0x26cae4=_0x131dfe;if(!_0x3e70c6)return;const _0x1a7fd5=await this[_0x26cae4(0xd1)][_0x26cae4(0xe0)]({'where':{'id':_0x3e70c6}});if(_0x1a7fd5){const {pdfTextContent:_0x2eb2c5}=_0x1a7fd5,_0x2ca8db=__rest(_0x1a7fd5,[_0x26cae4(0xdf)]);return _0x2ca8db;}}async[_0x131dfe(0x103)](_0x24a00f){const _0x799eb3=_0x131dfe,_0x4d39c7=await this[_0x799eb3(0xd1)][_0x799eb3(0xe0)]({'where':{'id':_0x24a00f}});if(_0x4d39c7)return _0x4d39c7[_0x799eb3(0xdf)];}};ChatGroupService=__decorate([(0x0,common_1[_0x131dfe(0x110)])(),__param(0x0,(0x0,typeorm_1[_0x131dfe(0x114)])(chatGroup_entity_1[_0x131dfe(0x10b)])),__param(0x1,(0x0,typeorm_1[_0x131dfe(0x114)])(app_entity_1[_0x131dfe(0x111)])),__metadata(_0x131dfe(0xea),[typeorm_2[_0x131dfe(0xf2)],typeorm_2[_0x131dfe(0xf2)],models_service_1['ModelsService']])],ChatGroupService),exports[_0x131dfe(0xfc)]=ChatGroupService;