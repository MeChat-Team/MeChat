'use strict';function _0x371d(){const _0x5a6e6e=['2434232ujRwBP','keyType','__param','map','find','isSticky','length','@nestjs/common','axios','60690sfogog','del','InjectRepository','非法操作、您在使用一个未启用的应用！','arraybuffer','getCurrentModelKeyInfo','log','chatGroupEntity','update','default','getGroupPdfText','__decorate','data','__rest','query','7uqSJTg','findOne','modelInfo','5414nRJWEo','user','1320272WQHbQz','150PnrAYG','metadata','object','9993051NUFmPG','新对话','../models/models.service','pdf-parse','appEntity','delAll','function','应用对话名称不能修改哟！','非法操作、您在使用一个不存在的应用！','DESC','defineProperty','825SJcKHm','modelsService','assign','title','undefined','../app/app.entity','indexOf','affected','请先选择一个对话或者新加一个对话再操作！','prototype','stringify','删除失败！','fileUrl','./chatGroup.entity','__metadata','HttpStatus','非法操作、您在删除一个非法资源！','get','getOwnPropertySymbols','BAD_REQUEST','from','@nestjs/typeorm','更新对话失败！','filter','ModelsService','save','__esModule','isFileUpload','1xuwOEV','ChatGroupService','PDF\x20读取失败:','error:\x20','extractPdfText','HttpException','error','handlePdfExtraction','parse','deduct','text','Injectable','call','coverImg','getOwnPropertyDescriptor','pdfTextContent','appId','updateTime','1783566Zkjybi','typeorm','PDF\x20解析失败:','create','Repository','deductType','config','hasOwnProperty','90642gQymVZ','ChatGroupEntity'];_0x371d=function(){return _0x5a6e6e;};return _0x371d();}const _0x104e12=_0x33b7;(function(_0x4b9e11,_0x2a3dc3){const _0x12160c=_0x33b7,_0x49480c=_0x4b9e11();while(!![]){try{const _0x1555f4=parseInt(_0x12160c(0x131))/0x1*(parseInt(_0x12160c(0x168))/0x2)+parseInt(_0x12160c(0x143))/0x3+parseInt(_0x12160c(0x14d))/0x4+-parseInt(_0x12160c(0x16b))/0x5*(-parseInt(_0x12160c(0x14b))/0x6)+-parseInt(_0x12160c(0x165))/0x7*(parseInt(_0x12160c(0x16a))/0x8)+-parseInt(_0x12160c(0x16e))/0x9+-parseInt(_0x12160c(0x156))/0xa*(-parseInt(_0x12160c(0x179))/0xb);if(_0x1555f4===_0x2a3dc3)break;else _0x49480c['push'](_0x49480c['shift']());}catch(_0x42d6de){_0x49480c['push'](_0x49480c['shift']());}}}(_0x371d,0xccc8f));var __decorate=this&&this[_0x104e12(0x161)]||function(_0x54cf85,_0x337474,_0xc84b76,_0x24b3b7){const _0x4560af=_0x104e12;var _0x5610d4=arguments['length'],_0x4b3a57=_0x5610d4<0x3?_0x337474:_0x24b3b7===null?_0x24b3b7=Object[_0x4560af(0x13f)](_0x337474,_0xc84b76):_0x24b3b7,_0x24e423;if(typeof Reflect===_0x4560af(0x16d)&&typeof Reflect['decorate']===_0x4560af(0x174))_0x4b3a57=Reflect['decorate'](_0x54cf85,_0x337474,_0xc84b76,_0x24b3b7);else{for(var _0xefb5d4=_0x54cf85[_0x4560af(0x153)]-0x1;_0xefb5d4>=0x0;_0xefb5d4--)if(_0x24e423=_0x54cf85[_0xefb5d4])_0x4b3a57=(_0x5610d4<0x3?_0x24e423(_0x4b3a57):_0x5610d4>0x3?_0x24e423(_0x337474,_0xc84b76,_0x4b3a57):_0x24e423(_0x337474,_0xc84b76))||_0x4b3a57;}return _0x5610d4>0x3&&_0x4b3a57&&Object[_0x4560af(0x178)](_0x337474,_0xc84b76,_0x4b3a57),_0x4b3a57;},__metadata=this&&this[_0x104e12(0x187)]||function(_0x25697c,_0x560dd6){const _0x590ba4=_0x104e12;if(typeof Reflect===_0x590ba4(0x16d)&&typeof Reflect[_0x590ba4(0x16c)]==='function')return Reflect['metadata'](_0x25697c,_0x560dd6);},__param=this&&this[_0x104e12(0x14f)]||function(_0x2416ed,_0x2e468c){return function(_0x288acb,_0x557c37){_0x2e468c(_0x288acb,_0x557c37,_0x2416ed);};},__rest=this&&this[_0x104e12(0x163)]||function(_0x237fad,_0x5dc724){const _0xa05680=_0x104e12;var _0x14585e={};for(var _0x5a8652 in _0x237fad)if(Object[_0xa05680(0x182)][_0xa05680(0x14a)][_0xa05680(0x13d)](_0x237fad,_0x5a8652)&&_0x5dc724[_0xa05680(0x17f)](_0x5a8652)<0x0)_0x14585e[_0x5a8652]=_0x237fad[_0x5a8652];if(_0x237fad!=null&&typeof Object[_0xa05680(0x127)]===_0xa05680(0x174))for(var _0x3cce3c=0x0,_0x5a8652=Object[_0xa05680(0x127)](_0x237fad);_0x3cce3c<_0x5a8652[_0xa05680(0x153)];_0x3cce3c++){if(_0x5dc724[_0xa05680(0x17f)](_0x5a8652[_0x3cce3c])<0x0&&Object[_0xa05680(0x182)]['propertyIsEnumerable']['call'](_0x237fad,_0x5a8652[_0x3cce3c]))_0x14585e[_0x5a8652[_0x3cce3c]]=_0x237fad[_0x5a8652[_0x3cce3c]];}return _0x14585e;};Object[_0x104e12(0x178)](exports,_0x104e12(0x12f),{'value':!![]}),exports[_0x104e12(0x132)]=void 0x0;function _0x33b7(_0x221800,_0x5a901d){const _0x371d52=_0x371d();return _0x33b7=function(_0x33b747,_0x123f8b){_0x33b747=_0x33b747-0x124;let _0x3839e5=_0x371d52[_0x33b747];return _0x3839e5;},_0x33b7(_0x221800,_0x5a901d);}const common_1=require(_0x104e12(0x154)),typeorm_1=require(_0x104e12(0x12a)),axios_1=require(_0x104e12(0x155)),pdf=require(_0x104e12(0x171)),typeorm_2=require(_0x104e12(0x144)),app_entity_1=require(_0x104e12(0x17e)),models_service_1=require(_0x104e12(0x170)),chatGroup_entity_1=require(_0x104e12(0x186));let ChatGroupService=class ChatGroupService{constructor(_0x5dec7e,_0x215540,_0x185fad){const _0x1f3208=_0x104e12;this[_0x1f3208(0x15d)]=_0x5dec7e,this[_0x1f3208(0x172)]=_0x215540,this['modelsService']=_0x185fad;}async[_0x104e12(0x146)](_0x2e81ed,_0x35da78){const _0xc10571=_0x104e12,{id:_0x1e0220}=_0x35da78['user'],{appId:_0x5abebb,modelConfig:_0xc5a0f8,params:_0x2f0e01}=_0x2e81ed;let _0x188838=_0xc5a0f8||await this[_0xc10571(0x17a)]['getBaseConfig']();if(!_0x188838)throw new common_1[(_0xc10571(0x136))]('管理员未配置任何AI模型、请先联系管理员开通聊天模型配置！',common_1[_0xc10571(0x124)][_0xc10571(0x128)]);_0x188838=JSON[_0xc10571(0x139)](JSON[_0xc10571(0x183)](_0x188838));const _0x2270e1={'title':_0xc10571(0x16f),'userId':_0x1e0220,'appId':_0x5abebb,'params':_0x2f0e01};if(_0x5abebb){const _0x2ebe2a=await this['appEntity']['findOne']({'where':{'id':_0x5abebb}});if(!_0x2ebe2a)throw new common_1[(_0xc10571(0x136))](_0xc10571(0x176),common_1[_0xc10571(0x124)][_0xc10571(0x128)]);const {status:_0x2e3418,name:_0xd9ba87,isFixedModel:_0x4ab356,isGPTs:_0x53d59a,appModel:_0x12f51e,coverImg:_0x3f53a2}=_0x2ebe2a;Object[_0xc10571(0x17b)](_0x188838[_0xc10571(0x167)],{'isGPTs':_0x53d59a,'isFixedModel':_0x4ab356,'modelAvatar':_0x3f53a2,'modelName':_0xd9ba87});if(_0x53d59a===0x1||_0x4ab356===0x1){const _0x1e3f0c=await this[_0xc10571(0x17a)][_0xc10571(0x15b)](_0x4ab356===0x1?_0x12f51e:'gpts');Object['assign'](_0x188838[_0xc10571(0x167)],{'deductType':_0x1e3f0c[_0xc10571(0x148)],'deduct':_0x1e3f0c[_0xc10571(0x13a)],'model':_0x12f51e,'isFileUpload':_0x1e3f0c[_0xc10571(0x130)]});}if(![0x1,0x3,0x4,0x5]['includes'](_0x2e3418))throw new common_1[(_0xc10571(0x136))](_0xc10571(0x159),common_1[_0xc10571(0x124)][_0xc10571(0x128)]);_0xd9ba87&&(_0x2270e1['title']=_0xd9ba87);}const _0x29ed88=await this[_0xc10571(0x15d)][_0xc10571(0x12e)](Object[_0xc10571(0x17b)](Object[_0xc10571(0x17b)]({},_0x2270e1),{'config':JSON[_0xc10571(0x183)](_0x188838)}));return _0x29ed88;}async[_0x104e12(0x164)](_0x44dc5e){const _0x393ca6=_0x104e12;try{const {id:_0x27030e}=_0x44dc5e['user'],_0x5568f9={'userId':_0x27030e,'isDelete':![]},_0x1e845b=await this[_0x393ca6(0x15d)][_0x393ca6(0x151)]({'where':_0x5568f9,'order':{'isSticky':_0x393ca6(0x177),'updatedAt':_0x393ca6(0x177)}});return _0x1e845b;const _0x20f44c=_0x1e845b[_0x393ca6(0x12c)](_0x29acff=>_0x29acff[_0x393ca6(0x141)])[_0x393ca6(0x150)](_0xbd497a=>_0xbd497a[_0x393ca6(0x141)]),_0x3282ca=await this['appEntity'][_0x393ca6(0x151)]({'where':{'id':(0x0,typeorm_2['In'])(_0x20f44c)}});return _0x1e845b[_0x393ca6(0x150)](_0x5f4484=>{const _0x473116=_0x393ca6;var _0x1564b5;return _0x5f4484['appLogo']=(_0x1564b5=_0x3282ca[_0x473116(0x151)](_0x523a0f=>_0x523a0f['id']===_0x5f4484['appId']))===null||_0x1564b5===void 0x0?void 0x0:_0x1564b5[_0x473116(0x13e)],_0x5f4484;});}catch(_0x34be30){console[_0x393ca6(0x15c)](_0x393ca6(0x134),_0x34be30);}}async['update'](_0x3a5c67,_0x1bb857){const _0x1dcfce=_0x104e12,{title:_0x3b757d,isSticky:_0x7c54e3,groupId:_0x10ad18,config:_0x5a08c3,fileUrl:_0x3e5a8c}=_0x3a5c67,{id:_0xcb8d58}=_0x1bb857[_0x1dcfce(0x169)],_0x1dcf6f=await this[_0x1dcfce(0x15d)]['findOne']({'where':{'id':_0x10ad18,'userId':_0xcb8d58}});if(!_0x1dcf6f)throw new common_1['HttpException'](_0x1dcfce(0x181),common_1['HttpStatus'][_0x1dcfce(0x128)]);const {appId:_0x175593}=_0x1dcf6f;if(_0x175593&&!_0x3b757d)try{const _0x9343a9=JSON[_0x1dcfce(0x139)](_0x5a08c3);if(Number(_0x9343a9[_0x1dcfce(0x14e)])!==0x1)throw new common_1['HttpException'](_0x1dcfce(0x175),common_1[_0x1dcfce(0x124)][_0x1dcfce(0x128)]);}catch(_0x4875d4){}const _0x15358c={};_0x3b757d&&(_0x15358c[_0x1dcfce(0x17c)]=_0x3b757d),typeof _0x7c54e3!==_0x1dcfce(0x17d)&&(_0x15358c[_0x1dcfce(0x152)]=_0x7c54e3),_0x5a08c3&&(_0x15358c[_0x1dcfce(0x149)]=_0x5a08c3),_0x3e5a8c&&(_0x15358c[_0x1dcfce(0x185)]=_0x3e5a8c);const _0x51e05d=await this[_0x1dcfce(0x15d)][_0x1dcfce(0x15e)]({'id':_0x10ad18},_0x15358c);if(_0x51e05d['affected'])return _0x3e5a8c&&this[_0x1dcfce(0x138)](_0x3e5a8c,_0x10ad18),!![];else throw new common_1[(_0x1dcfce(0x136))](_0x1dcfce(0x12b),common_1['HttpStatus'][_0x1dcfce(0x128)]);}async[_0x104e12(0x138)](_0x472412,_0x44f41a){const _0x2e4d99=_0x104e12;try{const _0xe3141a=await this[_0x2e4d99(0x135)](_0x472412);await this[_0x2e4d99(0x15d)]['update']({'id':_0x44f41a},{'pdfTextContent':_0xe3141a});}catch(_0x1ae329){console['error'](_0x2e4d99(0x133),_0x1ae329);}}async['extractPdfText'](_0x2d7d4b){const _0x5ad1bc=_0x104e12;try{const _0x2ba6eb=await axios_1[_0x5ad1bc(0x15f)][_0x5ad1bc(0x126)](_0x2d7d4b,{'responseType':_0x5ad1bc(0x15a)}),_0x386c0e=Buffer[_0x5ad1bc(0x129)](_0x2ba6eb[_0x5ad1bc(0x162)]),_0x56d6a4=await pdf(_0x386c0e);return _0x56d6a4[_0x5ad1bc(0x13b)];}catch(_0x1deffb){console[_0x5ad1bc(0x137)](_0x5ad1bc(0x145),_0x1deffb);throw new Error('PDF\x20解析失败');}}async[_0x104e12(0x142)](_0x12466c){const _0x5eb644=_0x104e12;await this[_0x5eb644(0x15d)]['update'](_0x12466c,{'updatedAt':new Date()});}async[_0x104e12(0x157)](_0x56b87c,_0x1413ca){const _0x1920fa=_0x104e12,{groupId:_0x127569}=_0x56b87c,{id:_0xc19ea6}=_0x1413ca[_0x1920fa(0x169)],_0xea7bdf=await this['chatGroupEntity'][_0x1920fa(0x166)]({'where':{'id':_0x127569,'userId':_0xc19ea6}});if(!_0xea7bdf)throw new common_1['HttpException'](_0x1920fa(0x125),common_1['HttpStatus'][_0x1920fa(0x128)]);const _0x2786b2=await this[_0x1920fa(0x15d)]['update']({'id':_0x127569},{'isDelete':!![]});if(_0x2786b2[_0x1920fa(0x180)])return'删除成功';else throw new common_1[(_0x1920fa(0x136))](_0x1920fa(0x184),common_1[_0x1920fa(0x124)][_0x1920fa(0x128)]);}async[_0x104e12(0x173)](_0x40f273){const _0x26c335=_0x104e12,{id:_0x151d98}=_0x40f273[_0x26c335(0x169)],_0x194b2a=await this[_0x26c335(0x15d)][_0x26c335(0x15e)]({'userId':_0x151d98,'isSticky':![],'isDelete':![]},{'isDelete':!![]});if(_0x194b2a[_0x26c335(0x180)])return'删除成功';else throw new common_1[(_0x26c335(0x136))]('删除失败！',common_1[_0x26c335(0x124)][_0x26c335(0x128)]);}async['getGroupInfoFromId'](_0xfc0ff3){const _0x2041d0=_0x104e12;if(!_0xfc0ff3)return;const _0x2da214=await this[_0x2041d0(0x15d)][_0x2041d0(0x166)]({'where':{'id':_0xfc0ff3}});if(_0x2da214){const {pdfTextContent:_0x12d49c}=_0x2da214,_0x4e1901=__rest(_0x2da214,[_0x2041d0(0x140)]);return _0x4e1901;}}async[_0x104e12(0x160)](_0x17e474){const _0x571c10=_0x104e12,_0x2c6b60=await this[_0x571c10(0x15d)][_0x571c10(0x166)]({'where':{'id':_0x17e474}});if(_0x2c6b60)return _0x2c6b60[_0x571c10(0x140)];}};ChatGroupService=__decorate([(0x0,common_1[_0x104e12(0x13c)])(),__param(0x0,(0x0,typeorm_1[_0x104e12(0x158)])(chatGroup_entity_1[_0x104e12(0x14c)])),__param(0x1,(0x0,typeorm_1[_0x104e12(0x158)])(app_entity_1['AppEntity'])),__metadata('design:paramtypes',[typeorm_2['Repository'],typeorm_2[_0x104e12(0x147)],models_service_1[_0x104e12(0x12d)]])],ChatGroupService),exports[_0x104e12(0x132)]=ChatGroupService;