'use strict';const _0x3f726e=_0x5005;(function(_0xa6a5af,_0x59f08a){const _0x1b4c1a=_0x5005,_0x2e13df=_0xa6a5af();while(!![]){try{const _0x1eecef=parseInt(_0x1b4c1a(0x64))/0x1*(parseInt(_0x1b4c1a(0x82))/0x2)+parseInt(_0x1b4c1a(0x74))/0x3*(parseInt(_0x1b4c1a(0xb4))/0x4)+parseInt(_0x1b4c1a(0x8f))/0x5*(parseInt(_0x1b4c1a(0x72))/0x6)+-parseInt(_0x1b4c1a(0xa1))/0x7*(-parseInt(_0x1b4c1a(0x92))/0x8)+-parseInt(_0x1b4c1a(0xbc))/0x9*(parseInt(_0x1b4c1a(0xa6))/0xa)+-parseInt(_0x1b4c1a(0x80))/0xb+-parseInt(_0x1b4c1a(0x87))/0xc*(parseInt(_0x1b4c1a(0xab))/0xd);if(_0x1eecef===_0x59f08a)break;else _0x2e13df['push'](_0x2e13df['shift']());}catch(_0x5a4b83){_0x2e13df['push'](_0x2e13df['shift']());}}}(_0x1fc5,0xce969));var __decorate=this&&this[_0x3f726e(0xa9)]||function(_0x3e4fac,_0x4233ee,_0x4cddb8,_0x4fd3b5){const _0x11f724=_0x3f726e;var _0x36948b=arguments[_0x11f724(0x77)],_0x2a8b39=_0x36948b<0x3?_0x4233ee:_0x4fd3b5===null?_0x4fd3b5=Object[_0x11f724(0xaf)](_0x4233ee,_0x4cddb8):_0x4fd3b5,_0x2e3b4c;if(typeof Reflect===_0x11f724(0x9e)&&typeof Reflect[_0x11f724(0x98)]==='function')_0x2a8b39=Reflect[_0x11f724(0x98)](_0x3e4fac,_0x4233ee,_0x4cddb8,_0x4fd3b5);else{for(var _0x14d7ba=_0x3e4fac['length']-0x1;_0x14d7ba>=0x0;_0x14d7ba--)if(_0x2e3b4c=_0x3e4fac[_0x14d7ba])_0x2a8b39=(_0x36948b<0x3?_0x2e3b4c(_0x2a8b39):_0x36948b>0x3?_0x2e3b4c(_0x4233ee,_0x4cddb8,_0x2a8b39):_0x2e3b4c(_0x4233ee,_0x4cddb8))||_0x2a8b39;}return _0x36948b>0x3&&_0x2a8b39&&Object[_0x11f724(0xa0)](_0x4233ee,_0x4cddb8,_0x2a8b39),_0x2a8b39;},__metadata=this&&this[_0x3f726e(0xb6)]||function(_0x135452,_0x42f7b5){const _0x161212=_0x3f726e;if(typeof Reflect===_0x161212(0x9e)&&typeof Reflect[_0x161212(0xbd)]==='function')return Reflect['metadata'](_0x135452,_0x42f7b5);},__param=this&&this['__param']||function(_0x1ac250,_0x28973e){return function(_0xe14389,_0x21bbdb){_0x28973e(_0xe14389,_0x21bbdb,_0x1ac250);};},__rest=this&&this['__rest']||function(_0x23c495,_0x1ab3f8){const _0x561bd3=_0x3f726e;var _0x4b961e={};for(var _0xb6edb0 in _0x23c495)if(Object[_0x561bd3(0x7f)][_0x561bd3(0x70)][_0x561bd3(0x7c)](_0x23c495,_0xb6edb0)&&_0x1ab3f8[_0x561bd3(0x86)](_0xb6edb0)<0x0)_0x4b961e[_0xb6edb0]=_0x23c495[_0xb6edb0];if(_0x23c495!=null&&typeof Object[_0x561bd3(0x68)]===_0x561bd3(0x8c))for(var _0x281cac=0x0,_0xb6edb0=Object[_0x561bd3(0x68)](_0x23c495);_0x281cac<_0xb6edb0[_0x561bd3(0x77)];_0x281cac++){if(_0x1ab3f8[_0x561bd3(0x86)](_0xb6edb0[_0x281cac])<0x0&&Object[_0x561bd3(0x7f)][_0x561bd3(0xa7)][_0x561bd3(0x7c)](_0x23c495,_0xb6edb0[_0x281cac]))_0x4b961e[_0xb6edb0[_0x281cac]]=_0x23c495[_0xb6edb0[_0x281cac]];}return _0x4b961e;};Object['defineProperty'](exports,_0x3f726e(0x7d),{'value':!![]}),exports[_0x3f726e(0xba)]=void 0x0;function _0x5005(_0x41dedf,_0x3470f4){const _0x1fc5e5=_0x1fc5();return _0x5005=function(_0x500587,_0x552ccd){_0x500587=_0x500587-0x64;let _0x2f51b3=_0x1fc5e5[_0x500587];return _0x2f51b3;},_0x5005(_0x41dedf,_0x3470f4);}const common_1=require('@nestjs/common'),typeorm_1=require('@nestjs/typeorm'),axios_1=require(_0x3f726e(0x9f)),pdf=require('pdf-parse'),typeorm_2=require(_0x3f726e(0x97)),app_entity_1=require('../app/app.entity'),models_service_1=require(_0x3f726e(0x83)),chatGroup_entity_1=require(_0x3f726e(0x88));let ChatGroupService=class ChatGroupService{constructor(_0x2736cf,_0x4c618b,_0x37e657){const _0x49323c=_0x3f726e;this[_0x49323c(0x6e)]=_0x2736cf,this[_0x49323c(0xa3)]=_0x4c618b,this['modelsService']=_0x37e657;}async[_0x3f726e(0x66)](_0x11890f,_0x1ddd22){const _0x5bd793=_0x3f726e,{id:_0xeba4ff}=_0x1ddd22[_0x5bd793(0x75)],{appId:_0x405214,modelConfig:_0x31f420,params:_0x53781b}=_0x11890f;let _0x19ab0e=_0x31f420||await this[_0x5bd793(0xb9)]['getBaseConfig']();if(!_0x19ab0e)throw new common_1['HttpException'](_0x5bd793(0x7a),common_1[_0x5bd793(0xb2)][_0x5bd793(0xbe)]);_0x19ab0e=JSON[_0x5bd793(0x9c)](JSON[_0x5bd793(0x73)](_0x19ab0e));const _0x2f8a8c={'title':_0x5bd793(0x79),'userId':_0xeba4ff,'appId':_0x405214,'params':_0x53781b};if(_0x405214){const _0x352b1c=await this[_0x5bd793(0xa3)][_0x5bd793(0xaa)]({'where':{'id':_0x405214}});if(!_0x352b1c)throw new common_1['HttpException'](_0x5bd793(0x8d),common_1[_0x5bd793(0xb2)][_0x5bd793(0xbe)]);const {status:_0x4fab67,name:_0x288054,isFixedModel:_0x1a1201,isGPTs:_0x189649,appModel:_0x1ca931,coverImg:_0x398f7b}=_0x352b1c;Object[_0x5bd793(0x78)](_0x19ab0e[_0x5bd793(0xae)],{'isGPTs':_0x189649,'isFixedModel':_0x1a1201,'modelAvatar':_0x398f7b,'modelName':_0x288054});if(_0x189649===0x1||_0x1a1201===0x1){const _0x2393c0=await this[_0x5bd793(0xb9)][_0x5bd793(0x94)](_0x1a1201===0x1?_0x1ca931:_0x5bd793(0x8b));Object['assign'](_0x19ab0e[_0x5bd793(0xae)],{'deductType':_0x2393c0[_0x5bd793(0x96)],'deduct':_0x2393c0[_0x5bd793(0x6c)],'model':_0x1ca931,'isFileUpload':_0x2393c0['isFileUpload']});}if(![0x1,0x3,0x4,0x5]['includes'](_0x4fab67))throw new common_1['HttpException']('非法操作、您在使用一个未启用的应用！',common_1[_0x5bd793(0xb2)][_0x5bd793(0xbe)]);_0x288054&&(_0x2f8a8c['title']=_0x288054);}const _0xd7a7c5=await this['chatGroupEntity'][_0x5bd793(0xa8)](Object[_0x5bd793(0x78)](Object[_0x5bd793(0x78)]({},_0x2f8a8c),{'config':JSON['stringify'](_0x19ab0e)}));return _0xd7a7c5;}async[_0x3f726e(0xb5)](_0x3b9608){const _0x3fe40e=_0x3f726e;try{const {id:_0xbf56b9}=_0x3b9608[_0x3fe40e(0x75)],_0x5d02cf={'userId':_0xbf56b9,'isDelete':![]},_0xb0391a=await this['chatGroupEntity'][_0x3fe40e(0xa2)]({'where':_0x5d02cf,'order':{'isSticky':'DESC','updatedAt':_0x3fe40e(0x90)}});return _0xb0391a;const _0x262b0f=_0xb0391a[_0x3fe40e(0x9b)](_0x288f4f=>_0x288f4f['appId'])['map'](_0x5db952=>_0x5db952[_0x3fe40e(0x91)]),_0x945fb6=await this[_0x3fe40e(0xa3)][_0x3fe40e(0xa2)]({'where':{'id':(0x0,typeorm_2['In'])(_0x262b0f)}});return _0xb0391a[_0x3fe40e(0x89)](_0x225b80=>{const _0x3b8616=_0x3fe40e;var _0x138878;return _0x225b80[_0x3b8616(0x85)]=(_0x138878=_0x945fb6[_0x3b8616(0xa2)](_0x1d1a5d=>_0x1d1a5d['id']===_0x225b80['appId']))===null||_0x138878===void 0x0?void 0x0:_0x138878[_0x3b8616(0x8a)],_0x225b80;});}catch(_0x52970f){console['log'](_0x3fe40e(0x99),_0x52970f);}}async[_0x3f726e(0x71)](_0x2e724f,_0x1d24b4){const _0x511e66=_0x3f726e,{title:_0x185c11,isSticky:_0x200bc9,groupId:_0x505f6c,config:_0x4bcf6d,fileUrl:_0x1155d6}=_0x2e724f,{id:_0x4ac6c8}=_0x1d24b4['user'],_0x29f099=await this['chatGroupEntity'][_0x511e66(0xaa)]({'where':{'id':_0x505f6c,'userId':_0x4ac6c8}});if(!_0x29f099)throw new common_1[(_0x511e66(0xb1))](_0x511e66(0x9a),common_1[_0x511e66(0xb2)][_0x511e66(0xbe)]);const {appId:_0x4d871e}=_0x29f099;if(_0x4d871e&&!_0x185c11)try{const _0x31d55e=JSON[_0x511e66(0x9c)](_0x4bcf6d);if(Number(_0x31d55e[_0x511e66(0xb3)])!==0x1)throw new common_1[(_0x511e66(0xb1))](_0x511e66(0x8e),common_1[_0x511e66(0xb2)]['BAD_REQUEST']);}catch(_0x19aafe){}const _0x338398={};_0x185c11&&(_0x338398['title']=_0x185c11),typeof _0x200bc9!==_0x511e66(0x65)&&(_0x338398[_0x511e66(0xb8)]=_0x200bc9),_0x4bcf6d&&(_0x338398[_0x511e66(0x67)]=_0x4bcf6d),_0x1155d6&&(_0x338398['fileUrl']=_0x1155d6);const _0x3cbb50=await this[_0x511e66(0x6e)][_0x511e66(0x71)]({'id':_0x505f6c},_0x338398);if(_0x3cbb50[_0x511e66(0x6d)])return _0x1155d6&&this[_0x511e66(0x6b)](_0x1155d6,_0x505f6c),!![];else throw new common_1[(_0x511e66(0xb1))](_0x511e66(0xad),common_1[_0x511e66(0xb2)]['BAD_REQUEST']);}async[_0x3f726e(0x6b)](_0x5afcaf,_0x10db8e){const _0x1d4bce=_0x3f726e;try{const _0x438af3=await this[_0x1d4bce(0x95)](_0x5afcaf);await this[_0x1d4bce(0x6e)][_0x1d4bce(0x71)]({'id':_0x10db8e},{'pdfTextContent':_0x438af3});}catch(_0x2a2acd){console[_0x1d4bce(0x69)](_0x1d4bce(0xb0),_0x2a2acd);}}async['extractPdfText'](_0x485397){const _0x1be22c=_0x3f726e;try{const _0x59fd4b=await axios_1['default']['get'](_0x485397,{'responseType':'arraybuffer'}),_0xa8b8f8=Buffer[_0x1be22c(0x81)](_0x59fd4b['data']),_0x3f72b8=await pdf(_0xa8b8f8);return _0x3f72b8[_0x1be22c(0x93)];}catch(_0x379e3e){console['error'](_0x1be22c(0xa4),_0x379e3e);throw new Error('PDF\x20解析失败');}}async[_0x3f726e(0x6f)](_0x4ebf29){await this['chatGroupEntity']['update'](_0x4ebf29,{'updatedAt':new Date()});}async['del'](_0x471c71,_0x90721e){const _0x479499=_0x3f726e,{groupId:_0x51e612}=_0x471c71,{id:_0x16f82f}=_0x90721e['user'],_0x502285=await this[_0x479499(0x6e)][_0x479499(0xaa)]({'where':{'id':_0x51e612,'userId':_0x16f82f}});if(!_0x502285)throw new common_1[(_0x479499(0xb1))]('非法操作、您在删除一个非法资源！',common_1[_0x479499(0xb2)][_0x479499(0xbe)]);const _0x14b955=await this[_0x479499(0x6e)][_0x479499(0x71)]({'id':_0x51e612},{'isDelete':!![]});if(_0x14b955['affected'])return _0x479499(0xa5);else throw new common_1[(_0x479499(0xb1))](_0x479499(0xb7),common_1[_0x479499(0xb2)][_0x479499(0xbe)]);}async[_0x3f726e(0x7b)](_0x21095b){const _0x2f547b=_0x3f726e,{id:_0x3293c0}=_0x21095b[_0x2f547b(0x75)],_0x236469=await this[_0x2f547b(0x6e)][_0x2f547b(0x71)]({'userId':_0x3293c0,'isSticky':![],'isDelete':![]},{'isDelete':!![]});if(_0x236469['affected'])return _0x2f547b(0xa5);else throw new common_1[(_0x2f547b(0xb1))](_0x2f547b(0xb7),common_1[_0x2f547b(0xb2)][_0x2f547b(0xbe)]);}async[_0x3f726e(0x9d)](_0x177063){const _0x5a4240=_0x3f726e;if(!_0x177063)return;const _0x67a23c=await this[_0x5a4240(0x6e)]['findOne']({'where':{'id':_0x177063}});if(_0x67a23c){const {pdfTextContent:_0x56af5d}=_0x67a23c,_0x1b95d7=__rest(_0x67a23c,[_0x5a4240(0x6a)]);return _0x1b95d7;}}async[_0x3f726e(0xac)](_0x5af411){const _0x3ec829=_0x3f726e,_0xaf28a2=await this[_0x3ec829(0x6e)][_0x3ec829(0xaa)]({'where':{'id':_0x5af411}});if(_0xaf28a2)return _0xaf28a2[_0x3ec829(0x6a)];}};function _0x1fc5(){const _0x3a319b=['metadata','BAD_REQUEST','794423jfyyBD','undefined','create','config','getOwnPropertySymbols','error','pdfTextContent','handlePdfExtraction','deduct','affected','chatGroupEntity','updateTime','hasOwnProperty','update','1338xmipKw','stringify','2115VXAxtG','user','design:paramtypes','length','assign','新对话','管理员未配置任何AI模型、请先联系管理员开通聊天模型配置！','delAll','call','__esModule','InjectRepository','prototype','8240045MxHOQZ','from','4GXiauc','../models/models.service','AppEntity','appLogo','indexOf','12XFPcpS','./chatGroup.entity','map','coverImg','gpts','function','非法操作、您在使用一个不存在的应用！','应用对话名称不能修改哟！','35515aOjAeP','DESC','appId','40XYRrfZ','text','getCurrentModelKeyInfo','extractPdfText','deductType','typeorm','decorate','error:\x20','请先选择一个对话或者新加一个对话再操作！','filter','parse','getGroupInfoFromId','object','axios','defineProperty','1816927gmThVk','find','appEntity','PDF\x20解析失败:','删除成功','94530THTNhJ','propertyIsEnumerable','save','__decorate','findOne','54138578BGoGrQ','getGroupPdfText','更新对话失败！','modelInfo','getOwnPropertyDescriptor','PDF\x20读取失败:','HttpException','HttpStatus','keyType','8548TWUVCE','query','__metadata','删除失败！','isSticky','modelsService','ChatGroupService','Repository','207wDplNN'];_0x1fc5=function(){return _0x3a319b;};return _0x1fc5();}ChatGroupService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x3f726e(0x7e)])(chatGroup_entity_1['ChatGroupEntity'])),__param(0x1,(0x0,typeorm_1[_0x3f726e(0x7e)])(app_entity_1[_0x3f726e(0x84)])),__metadata(_0x3f726e(0x76),[typeorm_2[_0x3f726e(0xbb)],typeorm_2['Repository'],models_service_1['ModelsService']])],ChatGroupService),exports[_0x3f726e(0xba)]=ChatGroupService;