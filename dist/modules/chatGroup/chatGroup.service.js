'use strict';const _0x1edd38=_0x5c06;(function(_0x42860e,_0xdb97c9){const _0x10e51d=_0x5c06,_0x18d192=_0x42860e();while(!![]){try{const _0x4e7475=parseInt(_0x10e51d(0x1e3))/0x1*(-parseInt(_0x10e51d(0x1c1))/0x2)+parseInt(_0x10e51d(0x1b7))/0x3*(parseInt(_0x10e51d(0x1b0))/0x4)+parseInt(_0x10e51d(0x1ea))/0x5+-parseInt(_0x10e51d(0x1ae))/0x6*(parseInt(_0x10e51d(0x1cc))/0x7)+-parseInt(_0x10e51d(0x201))/0x8*(parseInt(_0x10e51d(0x1c3))/0x9)+-parseInt(_0x10e51d(0x1ca))/0xa+parseInt(_0x10e51d(0x1bd))/0xb*(parseInt(_0x10e51d(0x1d7))/0xc);if(_0x4e7475===_0xdb97c9)break;else _0x18d192['push'](_0x18d192['shift']());}catch(_0x20d665){_0x18d192['push'](_0x18d192['shift']());}}}(_0x42ed,0x2cacd));var __decorate=this&&this[_0x1edd38(0x1d2)]||function(_0x242d30,_0x539653,_0x15bc69,_0x365649){const _0x4fb55b=_0x1edd38;var _0x414f34=arguments[_0x4fb55b(0x1bf)],_0xdf4380=_0x414f34<0x3?_0x539653:_0x365649===null?_0x365649=Object[_0x4fb55b(0x200)](_0x539653,_0x15bc69):_0x365649,_0x593da6;if(typeof Reflect===_0x4fb55b(0x1fa)&&typeof Reflect[_0x4fb55b(0x1bc)]==='function')_0xdf4380=Reflect[_0x4fb55b(0x1bc)](_0x242d30,_0x539653,_0x15bc69,_0x365649);else{for(var _0x353ac6=_0x242d30['length']-0x1;_0x353ac6>=0x0;_0x353ac6--)if(_0x593da6=_0x242d30[_0x353ac6])_0xdf4380=(_0x414f34<0x3?_0x593da6(_0xdf4380):_0x414f34>0x3?_0x593da6(_0x539653,_0x15bc69,_0xdf4380):_0x593da6(_0x539653,_0x15bc69))||_0xdf4380;}return _0x414f34>0x3&&_0xdf4380&&Object[_0x4fb55b(0x1ee)](_0x539653,_0x15bc69,_0xdf4380),_0xdf4380;},__metadata=this&&this['__metadata']||function(_0x3e96bb,_0x2bf03b){const _0x3e3fc6=_0x1edd38;if(typeof Reflect===_0x3e3fc6(0x1fa)&&typeof Reflect['metadata']===_0x3e3fc6(0x1b8))return Reflect[_0x3e3fc6(0x1f7)](_0x3e96bb,_0x2bf03b);},__param=this&&this[_0x1edd38(0x1f9)]||function(_0x436e63,_0x50cd50){return function(_0x2f8053,_0x41877f){_0x50cd50(_0x2f8053,_0x41877f,_0x436e63);};},__rest=this&&this[_0x1edd38(0x1f3)]||function(_0x9e8115,_0x2fee8f){const _0x1f7133=_0x1edd38;var _0x4f7f3d={};for(var _0x1112ac in _0x9e8115)if(Object[_0x1f7133(0x1d0)]['hasOwnProperty'][_0x1f7133(0x1df)](_0x9e8115,_0x1112ac)&&_0x2fee8f[_0x1f7133(0x1f6)](_0x1112ac)<0x0)_0x4f7f3d[_0x1112ac]=_0x9e8115[_0x1112ac];if(_0x9e8115!=null&&typeof Object[_0x1f7133(0x1d8)]===_0x1f7133(0x1b8))for(var _0x47acca=0x0,_0x1112ac=Object[_0x1f7133(0x1d8)](_0x9e8115);_0x47acca<_0x1112ac['length'];_0x47acca++){if(_0x2fee8f[_0x1f7133(0x1f6)](_0x1112ac[_0x47acca])<0x0&&Object[_0x1f7133(0x1d0)][_0x1f7133(0x1dc)][_0x1f7133(0x1df)](_0x9e8115,_0x1112ac[_0x47acca]))_0x4f7f3d[_0x1112ac[_0x47acca]]=_0x9e8115[_0x1112ac[_0x47acca]];}return _0x4f7f3d;};function _0x5c06(_0x53150b,_0x4f044f){const _0x42ed73=_0x42ed();return _0x5c06=function(_0x5c0652,_0x3103ad){_0x5c0652=_0x5c0652-0x1a5;let _0x3927dd=_0x42ed73[_0x5c0652];return _0x3927dd;},_0x5c06(_0x53150b,_0x4f044f);}Object['defineProperty'](exports,_0x1edd38(0x1f4),{'value':!![]}),exports[_0x1edd38(0x1ad)]=void 0x0;const common_1=require(_0x1edd38(0x1d3)),typeorm_1=require(_0x1edd38(0x1c9)),axios_1=require('axios'),pdf=require('pdf-parse'),typeorm_2=require(_0x1edd38(0x1c8)),app_entity_1=require('../app/app.entity'),models_service_1=require(_0x1edd38(0x1a6)),chatGroup_entity_1=require(_0x1edd38(0x1b2));let ChatGroupService=class ChatGroupService{constructor(_0x2c0565,_0x2df96d,_0x4810a2){const _0x2d937e=_0x1edd38;this['chatGroupEntity']=_0x2c0565,this['appEntity']=_0x2df96d,this[_0x2d937e(0x1a9)]=_0x4810a2;}async[_0x1edd38(0x1fc)](_0xf76048,_0x323b7e){const _0x139270=_0x1edd38,{id:_0x11d0e3}=_0x323b7e['user'],{appId:_0x355baf,modelConfig:_0x2b3826,params:_0x4e5a2f}=_0xf76048;let _0x2dda0a=_0x2b3826||await this[_0x139270(0x1a9)][_0x139270(0x1e8)]();if(!_0x2dda0a)throw new common_1[(_0x139270(0x1ba))](_0x139270(0x1ef),common_1[_0x139270(0x1c2)][_0x139270(0x1ed)]);_0x2dda0a=JSON['parse'](JSON[_0x139270(0x1d9)](_0x2dda0a));const _0x1cc2be={'title':_0x139270(0x1dd),'userId':_0x11d0e3,'appId':_0x355baf,'params':_0x4e5a2f};if(_0x355baf){const _0x487f3d=await this['appEntity'][_0x139270(0x1ce)]({'where':{'id':_0x355baf}});if(!_0x487f3d)throw new common_1[(_0x139270(0x1ba))](_0x139270(0x1f0),common_1[_0x139270(0x1c2)][_0x139270(0x1ed)]);const {status:_0x451bc4,name:_0x476344,isFixedModel:_0x40803a,isGPTs:_0x339b70,appModel:_0x4bb7e9,coverImg:_0x586dba}=_0x487f3d;Object[_0x139270(0x1f8)](_0x2dda0a[_0x139270(0x1e0)],{'isGPTs':_0x339b70,'isFixedModel':_0x40803a,'modelAvatar':_0x586dba,'modelName':_0x476344});if(_0x339b70===0x1||_0x40803a===0x1){const _0x13a56c=await this[_0x139270(0x1a9)][_0x139270(0x1b3)](_0x40803a===0x1?_0x4bb7e9:_0x139270(0x1a5));Object['assign'](_0x2dda0a['modelInfo'],{'deductType':_0x13a56c[_0x139270(0x1c6)],'deduct':_0x13a56c[_0x139270(0x1ec)],'model':_0x4bb7e9,'isFileUpload':_0x13a56c['isFileUpload']});}if(![0x1,0x3,0x4,0x5][_0x139270(0x1bb)](_0x451bc4))throw new common_1[(_0x139270(0x1ba))]('非法操作、您在使用一个未启用的应用！',common_1[_0x139270(0x1c2)][_0x139270(0x1ed)]);_0x476344&&(_0x1cc2be['title']=_0x476344);}const _0x55d8a7=await this[_0x139270(0x1d4)][_0x139270(0x1e9)](Object['assign'](Object['assign']({},_0x1cc2be),{'config':JSON[_0x139270(0x1d9)](_0x2dda0a)}));return _0x55d8a7;}async['query'](_0x243a53){const _0x39cb9a=_0x1edd38;try{const {id:_0xfa8f1c}=_0x243a53[_0x39cb9a(0x1fb)],_0x1c707d={'userId':_0xfa8f1c,'isDelete':![]},_0xb04a17=await this[_0x39cb9a(0x1d4)]['find']({'where':_0x1c707d,'order':{'isSticky':'DESC','updatedAt':'DESC'}});return _0xb04a17;const _0x3676a8=_0xb04a17['filter'](_0x3fe630=>_0x3fe630[_0x39cb9a(0x1cd)])[_0x39cb9a(0x1c4)](_0x11eb61=>_0x11eb61[_0x39cb9a(0x1cd)]),_0x72cb07=await this[_0x39cb9a(0x1e6)][_0x39cb9a(0x203)]({'where':{'id':(0x0,typeorm_2['In'])(_0x3676a8)}});return _0xb04a17[_0x39cb9a(0x1c4)](_0x389bf3=>{const _0x23baa5=_0x39cb9a;var _0x5153dc;return _0x389bf3[_0x23baa5(0x1b4)]=(_0x5153dc=_0x72cb07[_0x23baa5(0x203)](_0x2a2d34=>_0x2a2d34['id']===_0x389bf3[_0x23baa5(0x1cd)]))===null||_0x5153dc===void 0x0?void 0x0:_0x5153dc['coverImg'],_0x389bf3;});}catch(_0x8ef595){console[_0x39cb9a(0x1d6)](_0x39cb9a(0x1fd),_0x8ef595);}}async[_0x1edd38(0x1ac)](_0x2c271e,_0x7dfc9a){const _0x385f69=_0x1edd38,{title:_0x53ee15,isSticky:_0x2c557d,groupId:_0x3a81d1,config:_0x2b2232,fileUrl:_0x4ef6d3}=_0x2c271e,{id:_0x262d9d}=_0x7dfc9a['user'],_0x373d44=await this[_0x385f69(0x1d4)][_0x385f69(0x1ce)]({'where':{'id':_0x3a81d1,'userId':_0x262d9d}});if(!_0x373d44)throw new common_1['HttpException'](_0x385f69(0x1f1),common_1[_0x385f69(0x1c2)][_0x385f69(0x1ed)]);const {appId:_0x3efd6c}=_0x373d44;if(_0x3efd6c&&!_0x53ee15)try{const _0x8f6156=JSON[_0x385f69(0x1e7)](_0x2b2232);if(Number(_0x8f6156['keyType'])!==0x1)throw new common_1[(_0x385f69(0x1ba))]('应用对话名称不能修改哟！',common_1[_0x385f69(0x1c2)]['BAD_REQUEST']);}catch(_0x59a3bf){}const _0x45f2b9={};_0x53ee15&&(_0x45f2b9['title']=_0x53ee15),typeof _0x2c557d!=='undefined'&&(_0x45f2b9[_0x385f69(0x1d1)]=_0x2c557d),_0x2b2232&&(_0x45f2b9[_0x385f69(0x1de)]=_0x2b2232),_0x4ef6d3&&(_0x45f2b9['fileUrl']=_0x4ef6d3);const _0x2577fc=await this[_0x385f69(0x1d4)][_0x385f69(0x1ac)]({'id':_0x3a81d1},_0x45f2b9);if(_0x2577fc[_0x385f69(0x1cf)])return _0x4ef6d3&&this[_0x385f69(0x1f5)](_0x4ef6d3,_0x3a81d1),!![];else throw new common_1[(_0x385f69(0x1ba))](_0x385f69(0x1da),common_1[_0x385f69(0x1c2)]['BAD_REQUEST']);}async['handlePdfExtraction'](_0x70dfa0,_0x54f5bf){const _0x2a161b=_0x1edd38;try{const _0x28690a=await this['extractPdfText'](_0x70dfa0);await this[_0x2a161b(0x1d4)][_0x2a161b(0x1ac)]({'id':_0x54f5bf},{'pdfTextContent':_0x28690a});}catch(_0xb91e7e){console[_0x2a161b(0x1c0)](_0x2a161b(0x1ff),_0xb91e7e);}}async[_0x1edd38(0x1e4)](_0x3e8fd3){const _0x141ee0=_0x1edd38;try{const _0x1dc79d=await axios_1['default'][_0x141ee0(0x1fe)](_0x3e8fd3,{'responseType':_0x141ee0(0x1a7)}),_0x4f3b08=Buffer[_0x141ee0(0x1e5)](_0x1dc79d[_0x141ee0(0x1e2)]),_0x32a672=await pdf(_0x4f3b08);return _0x32a672[_0x141ee0(0x1f2)];}catch(_0x472fbb){console[_0x141ee0(0x1c0)](_0x141ee0(0x1cb),_0x472fbb);throw new Error(_0x141ee0(0x202));}}async[_0x1edd38(0x1af)](_0x475294){const _0x3db359=_0x1edd38;await this['chatGroupEntity'][_0x3db359(0x1ac)](_0x475294,{'updatedAt':new Date()});}async[_0x1edd38(0x1aa)](_0x3c163,_0x4743a4){const _0x48d874=_0x1edd38,{groupId:_0x329656}=_0x3c163,{id:_0x200742}=_0x4743a4[_0x48d874(0x1fb)],_0x4d372e=await this['chatGroupEntity'][_0x48d874(0x1ce)]({'where':{'id':_0x329656,'userId':_0x200742}});if(!_0x4d372e)throw new common_1[(_0x48d874(0x1ba))](_0x48d874(0x1b9),common_1[_0x48d874(0x1c2)]['BAD_REQUEST']);const _0x5467fe=await this[_0x48d874(0x1d4)][_0x48d874(0x1ac)]({'id':_0x329656},{'isDelete':!![]});if(_0x5467fe[_0x48d874(0x1cf)])return _0x48d874(0x1be);else throw new common_1[(_0x48d874(0x1ba))](_0x48d874(0x1b5),common_1[_0x48d874(0x1c2)][_0x48d874(0x1ed)]);}async[_0x1edd38(0x1ab)](_0xbd13ba){const _0x424a07=_0x1edd38,{id:_0xd9ebdf}=_0xbd13ba['user'],_0x5a3cfc=await this[_0x424a07(0x1d4)][_0x424a07(0x1ac)]({'userId':_0xd9ebdf,'isSticky':![],'isDelete':![]},{'isDelete':!![]});if(_0x5a3cfc[_0x424a07(0x1cf)])return _0x424a07(0x1be);else throw new common_1[(_0x424a07(0x1ba))](_0x424a07(0x1b5),common_1[_0x424a07(0x1c2)][_0x424a07(0x1ed)]);}async[_0x1edd38(0x1db)](_0x42283e){const _0x4272de=_0x1edd38;if(!_0x42283e)return;const _0xec8457=await this[_0x4272de(0x1d4)]['findOne']({'where':{'id':_0x42283e}});if(_0xec8457){const {pdfTextContent:_0x4dea17}=_0xec8457,_0x2e3d3a=__rest(_0xec8457,[_0x4272de(0x1a8)]);return _0x2e3d3a;}}async[_0x1edd38(0x1eb)](_0x482d8f){const _0xdb3265=_0x1edd38,_0x213bb3=await this[_0xdb3265(0x1d4)][_0xdb3265(0x1ce)]({'where':{'id':_0x482d8f}});if(_0x213bb3)return _0x213bb3[_0xdb3265(0x1a8)];}};ChatGroupService=__decorate([(0x0,common_1[_0x1edd38(0x1e1)])(),__param(0x0,(0x0,typeorm_1[_0x1edd38(0x1d5)])(chatGroup_entity_1[_0x1edd38(0x1b1)])),__param(0x1,(0x0,typeorm_1[_0x1edd38(0x1d5)])(app_entity_1[_0x1edd38(0x1b6)])),__metadata('design:paramtypes',[typeorm_2[_0x1edd38(0x1c5)],typeorm_2[_0x1edd38(0x1c5)],models_service_1[_0x1edd38(0x1c7)]])],ChatGroupService),exports['ChatGroupService']=ChatGroupService;function _0x42ed(){const _0x1ea6ec=['function','非法操作、您在删除一个非法资源！','HttpException','includes','decorate','11LFgxNk','删除成功','length','error','489598YACASR','HttpStatus','18aUZqvL','map','Repository','deductType','ModelsService','typeorm','@nestjs/typeorm','3518880qawCPF','PDF\x20解析失败:','7sNxDqg','appId','findOne','affected','prototype','isSticky','__decorate','@nestjs/common','chatGroupEntity','InjectRepository','log','9043764QjaaUY','getOwnPropertySymbols','stringify','更新对话失败！','getGroupInfoFromId','propertyIsEnumerable','新对话','config','call','modelInfo','Injectable','data','1aQvlWA','extractPdfText','from','appEntity','parse','getBaseConfig','save','618855pHcfFk','getGroupPdfText','deduct','BAD_REQUEST','defineProperty','管理员未配置任何AI模型、请先联系管理员开通聊天模型配置！','非法操作、您在使用一个不存在的应用！','请先选择一个对话或者新加一个对话再操作！','text','__rest','__esModule','handlePdfExtraction','indexOf','metadata','assign','__param','object','user','create','error:\x20','get','PDF\x20读取失败:','getOwnPropertyDescriptor','189496JFwjsz','PDF\x20解析失败','find','gpts','../models/models.service','arraybuffer','pdfTextContent','modelsService','del','delAll','update','ChatGroupService','927318tEVLSv','updateTime','1340cKvwNd','ChatGroupEntity','./chatGroup.entity','getCurrentModelKeyInfo','appLogo','删除失败！','AppEntity','933waoqNn'];_0x42ed=function(){return _0x1ea6ec;};return _0x42ed();}