'use strict';const _0x25212a=_0x500e;(function(_0x23db66,_0x3f56a6){const _0x44328e=_0x500e,_0x22cc2a=_0x23db66();while(!![]){try{const _0x65360c=parseInt(_0x44328e(0x12a))/0x1+parseInt(_0x44328e(0x108))/0x2+parseInt(_0x44328e(0x10a))/0x3+-parseInt(_0x44328e(0x103))/0x4*(-parseInt(_0x44328e(0x134))/0x5)+-parseInt(_0x44328e(0x149))/0x6*(parseInt(_0x44328e(0x13b))/0x7)+-parseInt(_0x44328e(0x143))/0x8*(parseInt(_0x44328e(0xf7))/0x9)+-parseInt(_0x44328e(0x123))/0xa;if(_0x65360c===_0x3f56a6)break;else _0x22cc2a['push'](_0x22cc2a['shift']());}catch(_0x431dd2){_0x22cc2a['push'](_0x22cc2a['shift']());}}}(_0x1c6f,0x5eaaa));var __decorate=this&&this['__decorate']||function(_0x91d9c4,_0x96eb7f,_0x4b35d1,_0x3c7452){const _0x1fb97c=_0x500e;var _0x590af3=arguments[_0x1fb97c(0xf6)],_0x58fae9=_0x590af3<0x3?_0x96eb7f:_0x3c7452===null?_0x3c7452=Object[_0x1fb97c(0x138)](_0x96eb7f,_0x4b35d1):_0x3c7452,_0x305a65;if(typeof Reflect==='object'&&typeof Reflect['decorate']===_0x1fb97c(0x142))_0x58fae9=Reflect[_0x1fb97c(0x10d)](_0x91d9c4,_0x96eb7f,_0x4b35d1,_0x3c7452);else{for(var _0xcbff2f=_0x91d9c4[_0x1fb97c(0xf6)]-0x1;_0xcbff2f>=0x0;_0xcbff2f--)if(_0x305a65=_0x91d9c4[_0xcbff2f])_0x58fae9=(_0x590af3<0x3?_0x305a65(_0x58fae9):_0x590af3>0x3?_0x305a65(_0x96eb7f,_0x4b35d1,_0x58fae9):_0x305a65(_0x96eb7f,_0x4b35d1))||_0x58fae9;}return _0x590af3>0x3&&_0x58fae9&&Object['defineProperty'](_0x96eb7f,_0x4b35d1,_0x58fae9),_0x58fae9;},__metadata=this&&this[_0x25212a(0x129)]||function(_0x3cdd0a,_0x3dacbc){const _0x60e7a6=_0x25212a;if(typeof Reflect===_0x60e7a6(0x144)&&typeof Reflect[_0x60e7a6(0xf9)]==='function')return Reflect[_0x60e7a6(0xf9)](_0x3cdd0a,_0x3dacbc);},__param=this&&this['__param']||function(_0x570681,_0x38ada9){return function(_0x1ba984,_0x48e9d1){_0x38ada9(_0x1ba984,_0x48e9d1,_0x570681);};},__rest=this&&this['__rest']||function(_0x5c5235,_0x22888b){const _0x30f653=_0x25212a;var _0x430068={};for(var _0x4e751c in _0x5c5235)if(Object[_0x30f653(0xfc)][_0x30f653(0x124)][_0x30f653(0x105)](_0x5c5235,_0x4e751c)&&_0x22888b[_0x30f653(0x10f)](_0x4e751c)<0x0)_0x430068[_0x4e751c]=_0x5c5235[_0x4e751c];if(_0x5c5235!=null&&typeof Object[_0x30f653(0x118)]===_0x30f653(0x142))for(var _0x1af614=0x0,_0x4e751c=Object['getOwnPropertySymbols'](_0x5c5235);_0x1af614<_0x4e751c[_0x30f653(0xf6)];_0x1af614++){if(_0x22888b[_0x30f653(0x10f)](_0x4e751c[_0x1af614])<0x0&&Object[_0x30f653(0xfc)][_0x30f653(0x12e)][_0x30f653(0x105)](_0x5c5235,_0x4e751c[_0x1af614]))_0x430068[_0x4e751c[_0x1af614]]=_0x5c5235[_0x4e751c[_0x1af614]];}return _0x430068;};function _0x1c6f(){const _0x15fe89=['object','../models/models.service','HttpException','ChatGroupService','非法操作、您在使用一个未启用的应用！','443868vGNtJv','PDF\x20解析失败','HttpStatus','删除失败！','modelsService','deductType','length','6545241XZbqvz','getBaseConfig','metadata','chatGroupEntity','isFileUpload','prototype','应用对话名称不能修改哟！','typeorm','appId','@nestjs/typeorm','affected','findOne','4bFhZbq','assign','call','update','deduct','700174TMDDFJ','title','1293564pobXnQ','pdfTextContent','undefined','decorate','stringify','indexOf','./chatGroup.entity','from','arraybuffer','handlePdfExtraction','gpts','user','InjectRepository','appEntity','getOwnPropertySymbols','modelInfo','getCurrentModelKeyInfo','ChatGroupEntity','filter','defineProperty','Injectable','updateTime','@nestjs/common','data','map','1026880wPUKfG','hasOwnProperty','coverImg','BAD_REQUEST','text','ModelsService','__metadata','705279XAmddU','get','Repository','getGroupInfoFromId','propertyIsEnumerable','del','非法操作、您在使用一个不存在的应用！','find','DESC','save','1984695RXzYKv','getGroupPdfText','fileUrl','log','getOwnPropertyDescriptor','PDF\x20解析失败:','更新对话失败！','63geFHBP','删除成功','create','../app/app.entity','PDF\x20读取失败:','extractPdfText','error','function','8qmKufQ'];_0x1c6f=function(){return _0x15fe89;};return _0x1c6f();}Object[_0x25212a(0x11d)](exports,'__esModule',{'value':!![]}),exports[_0x25212a(0x147)]=void 0x0;function _0x500e(_0x4cab6e,_0x1df01d){const _0x1c6f71=_0x1c6f();return _0x500e=function(_0x500e1a,_0x2f2807){_0x500e1a=_0x500e1a-0xf3;let _0x310969=_0x1c6f71[_0x500e1a];return _0x310969;},_0x500e(_0x4cab6e,_0x1df01d);}const common_1=require(_0x25212a(0x120)),typeorm_1=require(_0x25212a(0x100)),axios_1=require('axios'),pdf=require('pdf-parse'),typeorm_2=require(_0x25212a(0xfe)),app_entity_1=require(_0x25212a(0x13e)),models_service_1=require(_0x25212a(0x145)),chatGroup_entity_1=require(_0x25212a(0x110));let ChatGroupService=class ChatGroupService{constructor(_0x4381ab,_0x3a13fb,_0xd02719){const _0x3217a6=_0x25212a;this[_0x3217a6(0xfa)]=_0x4381ab,this['appEntity']=_0x3a13fb,this['modelsService']=_0xd02719;}async[_0x25212a(0x13d)](_0xaa840a,_0x1ff4af){const _0x415c2a=_0x25212a,{id:_0x33da46}=_0x1ff4af[_0x415c2a(0x115)],{appId:_0x2e5eb5,modelConfig:_0x30c5b6,params:_0x2619ac}=_0xaa840a;let _0x5680f9=_0x30c5b6||await this[_0x415c2a(0xf4)][_0x415c2a(0xf8)]();if(!_0x5680f9)throw new common_1[(_0x415c2a(0x146))]('管理员未配置任何AI模型、请先联系管理员开通聊天模型配置！',common_1[_0x415c2a(0x14b)][_0x415c2a(0x126)]);_0x5680f9=JSON['parse'](JSON[_0x415c2a(0x10e)](_0x5680f9));const _0x52b660={'title':'新对话','userId':_0x33da46,'appId':_0x2e5eb5,'params':_0x2619ac};if(_0x2e5eb5){const _0xad16eb=await this[_0x415c2a(0x117)]['findOne']({'where':{'id':_0x2e5eb5}});if(!_0xad16eb)throw new common_1['HttpException'](_0x415c2a(0x130),common_1[_0x415c2a(0x14b)]['BAD_REQUEST']);const {status:_0x4318bf,name:_0x362d9c,isFixedModel:_0x2b4d84,isGPTs:_0x3efa7d,appModel:_0xad1b9c,coverImg:_0x3b3aa3}=_0xad16eb;Object['assign'](_0x5680f9['modelInfo'],{'isGPTs':_0x3efa7d,'isFixedModel':_0x2b4d84,'modelAvatar':_0x3b3aa3,'modelName':_0x362d9c});if(_0x3efa7d===0x1||_0x2b4d84===0x1){const _0x35d0d3=await this[_0x415c2a(0xf4)][_0x415c2a(0x11a)](_0x2b4d84===0x1?_0xad1b9c:_0x415c2a(0x114));Object[_0x415c2a(0x104)](_0x5680f9[_0x415c2a(0x119)],{'deductType':_0x35d0d3[_0x415c2a(0xf5)],'deduct':_0x35d0d3[_0x415c2a(0x107)],'model':_0xad1b9c,'isFileUpload':_0x35d0d3[_0x415c2a(0xfb)]});}if(![0x1,0x3,0x4,0x5]['includes'](_0x4318bf))throw new common_1[(_0x415c2a(0x146))](_0x415c2a(0x148),common_1[_0x415c2a(0x14b)][_0x415c2a(0x126)]);_0x362d9c&&(_0x52b660[_0x415c2a(0x109)]=_0x362d9c);}const _0x46847d=await this[_0x415c2a(0xfa)][_0x415c2a(0x133)](Object['assign'](Object['assign']({},_0x52b660),{'config':JSON[_0x415c2a(0x10e)](_0x5680f9)}));return _0x46847d;}async['query'](_0x998a07){const _0x489e9e=_0x25212a;try{const {id:_0x5f3bf3}=_0x998a07['user'],_0x45e180={'userId':_0x5f3bf3,'isDelete':![]},_0x4edf6d=await this[_0x489e9e(0xfa)]['find']({'where':_0x45e180,'order':{'isSticky':_0x489e9e(0x132),'updatedAt':_0x489e9e(0x132)}});return _0x4edf6d;const _0x509a12=_0x4edf6d[_0x489e9e(0x11c)](_0x402377=>_0x402377[_0x489e9e(0xff)])['map'](_0x40fe48=>_0x40fe48[_0x489e9e(0xff)]),_0x423fdb=await this['appEntity'][_0x489e9e(0x131)]({'where':{'id':(0x0,typeorm_2['In'])(_0x509a12)}});return _0x4edf6d[_0x489e9e(0x122)](_0x2222f2=>{const _0x117883=_0x489e9e;var _0x21595d;return _0x2222f2['appLogo']=(_0x21595d=_0x423fdb[_0x117883(0x131)](_0x197163=>_0x197163['id']===_0x2222f2[_0x117883(0xff)]))===null||_0x21595d===void 0x0?void 0x0:_0x21595d[_0x117883(0x125)],_0x2222f2;});}catch(_0x5b1734){console[_0x489e9e(0x137)]('error:\x20',_0x5b1734);}}async[_0x25212a(0x106)](_0x37be1d,_0x4c5161){const _0x263f0a=_0x25212a,{title:_0xe03a1a,isSticky:_0x4e307f,groupId:_0x137199,config:_0x50ea11,fileUrl:_0x38b2e7}=_0x37be1d,{id:_0x3e878e}=_0x4c5161[_0x263f0a(0x115)],_0x149778=await this[_0x263f0a(0xfa)][_0x263f0a(0x102)]({'where':{'id':_0x137199,'userId':_0x3e878e}});if(!_0x149778)throw new common_1['HttpException']('请先选择一个对话或者新加一个对话再操作！',common_1[_0x263f0a(0x14b)]['BAD_REQUEST']);const {appId:_0xf28432}=_0x149778;if(_0xf28432&&!_0xe03a1a)try{const _0x1ed52d=JSON['parse'](_0x50ea11);if(Number(_0x1ed52d['keyType'])!==0x1)throw new common_1['HttpException'](_0x263f0a(0xfd),common_1[_0x263f0a(0x14b)][_0x263f0a(0x126)]);}catch(_0x3cefad){}const _0x4e2ae5={};_0xe03a1a&&(_0x4e2ae5[_0x263f0a(0x109)]=_0xe03a1a),typeof _0x4e307f!==_0x263f0a(0x10c)&&(_0x4e2ae5['isSticky']=_0x4e307f),_0x50ea11&&(_0x4e2ae5['config']=_0x50ea11),_0x38b2e7&&(_0x4e2ae5[_0x263f0a(0x136)]=_0x38b2e7);const _0x2ad44b=await this[_0x263f0a(0xfa)]['update']({'id':_0x137199},_0x4e2ae5);if(_0x2ad44b[_0x263f0a(0x101)])return _0x38b2e7&&this['handlePdfExtraction'](_0x38b2e7,_0x137199),!![];else throw new common_1[(_0x263f0a(0x146))](_0x263f0a(0x13a),common_1['HttpStatus']['BAD_REQUEST']);}async[_0x25212a(0x113)](_0x115c1b,_0x41c534){const _0xd95aa0=_0x25212a;try{const _0x397e2c=await this[_0xd95aa0(0x140)](_0x115c1b);await this['chatGroupEntity'][_0xd95aa0(0x106)]({'id':_0x41c534},{'pdfTextContent':_0x397e2c});}catch(_0x26cd84){console[_0xd95aa0(0x141)](_0xd95aa0(0x13f),_0x26cd84);}}async['extractPdfText'](_0x1f0494){const _0x4f1563=_0x25212a;try{const _0x1f8279=await axios_1['default'][_0x4f1563(0x12b)](_0x1f0494,{'responseType':_0x4f1563(0x112)}),_0x3c0242=Buffer[_0x4f1563(0x111)](_0x1f8279[_0x4f1563(0x121)]),_0x3549f2=await pdf(_0x3c0242);return _0x3549f2[_0x4f1563(0x127)];}catch(_0x177d8b){console[_0x4f1563(0x141)](_0x4f1563(0x139),_0x177d8b);throw new Error(_0x4f1563(0x14a));}}async[_0x25212a(0x11f)](_0x25eca9){const _0x576d46=_0x25212a;await this[_0x576d46(0xfa)][_0x576d46(0x106)](_0x25eca9,{'updatedAt':new Date()});}async[_0x25212a(0x12f)](_0x10f5bd,_0x5a73fd){const _0x24ec13=_0x25212a,{groupId:_0x3ddedd}=_0x10f5bd,{id:_0x567d4c}=_0x5a73fd[_0x24ec13(0x115)],_0x484548=await this['chatGroupEntity']['findOne']({'where':{'id':_0x3ddedd,'userId':_0x567d4c}});if(!_0x484548)throw new common_1[(_0x24ec13(0x146))]('非法操作、您在删除一个非法资源！',common_1['HttpStatus'][_0x24ec13(0x126)]);const _0x4251c8=await this[_0x24ec13(0xfa)][_0x24ec13(0x106)]({'id':_0x3ddedd},{'isDelete':!![]});if(_0x4251c8[_0x24ec13(0x101)])return _0x24ec13(0x13c);else throw new common_1['HttpException'](_0x24ec13(0xf3),common_1['HttpStatus'][_0x24ec13(0x126)]);}async['delAll'](_0x3d1b99){const _0x24b242=_0x25212a,{id:_0x16203c}=_0x3d1b99[_0x24b242(0x115)],_0x4853e0=await this['chatGroupEntity'][_0x24b242(0x106)]({'userId':_0x16203c,'isSticky':![],'isDelete':![]},{'isDelete':!![]});if(_0x4853e0[_0x24b242(0x101)])return'删除成功';else throw new common_1[(_0x24b242(0x146))](_0x24b242(0xf3),common_1[_0x24b242(0x14b)][_0x24b242(0x126)]);}async[_0x25212a(0x12d)](_0xefcdb3){const _0x714ca2=_0x25212a;if(!_0xefcdb3)return;const _0x1d6a33=await this[_0x714ca2(0xfa)]['findOne']({'where':{'id':_0xefcdb3}});if(_0x1d6a33){const {pdfTextContent:_0x1226c0}=_0x1d6a33,_0x11defd=__rest(_0x1d6a33,['pdfTextContent']);return _0x11defd;}}async[_0x25212a(0x135)](_0x5cf7c0){const _0x102e99=_0x25212a,_0x21b5d4=await this[_0x102e99(0xfa)]['findOne']({'where':{'id':_0x5cf7c0}});if(_0x21b5d4)return _0x21b5d4[_0x102e99(0x10b)];}};ChatGroupService=__decorate([(0x0,common_1[_0x25212a(0x11e)])(),__param(0x0,(0x0,typeorm_1[_0x25212a(0x116)])(chatGroup_entity_1[_0x25212a(0x11b)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(app_entity_1['AppEntity'])),__metadata('design:paramtypes',[typeorm_2[_0x25212a(0x12c)],typeorm_2[_0x25212a(0x12c)],models_service_1[_0x25212a(0x128)]])],ChatGroupService),exports[_0x25212a(0x147)]=ChatGroupService;