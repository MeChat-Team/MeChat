'use strict';const _0x354d09=_0x3a3a;(function(_0x5ca466,_0x2c8192){const _0x1f2901=_0x3a3a,_0x815b08=_0x5ca466();while(!![]){try{const _0x489078=-parseInt(_0x1f2901(0x76))/0x1+parseInt(_0x1f2901(0x9f))/0x2+parseInt(_0x1f2901(0xad))/0x3*(parseInt(_0x1f2901(0xc0))/0x4)+parseInt(_0x1f2901(0x9c))/0x5*(parseInt(_0x1f2901(0xaa))/0x6)+-parseInt(_0x1f2901(0xc4))/0x7+-parseInt(_0x1f2901(0x82))/0x8*(parseInt(_0x1f2901(0x8d))/0x9)+parseInt(_0x1f2901(0xb5))/0xa;if(_0x489078===_0x2c8192)break;else _0x815b08['push'](_0x815b08['shift']());}catch(_0x7275a1){_0x815b08['push'](_0x815b08['shift']());}}}(_0x5f29,0x75df9));function _0x5f29(){const _0x399af7=['title','modelsService','__esModule','@nestjs/typeorm','arraybuffer','HttpStatus','parse','affected','decorate','5848912tJhSVh','findOne','user','isFileUpload','object','getOwnPropertySymbols','InjectRepository','defineProperty','filter','chatGroupEntity','function','9PgrhBI','getBaseConfig','modelInfo','propertyIsEnumerable','getOwnPropertyDescriptor','非法操作、您在删除一个非法资源！','HttpException','data','coverImg','__rest','管理员未配置任何AI模型、请先联系管理员开通聊天模型配置！','./chatGroup.entity','appLogo','__metadata','isSticky','60HBnDMM','indexOf','stringify','911640fBzssU','axios','keyType','del','pdfTextContent','includes','BAD_REQUEST','应用对话名称不能修改哟！','text','ChatGroupService','updateTime','34422nzUNua','删除成功','appEntity','14055VwOZUy','update','AppEntity','config','DESC','metadata','find','Repository','5505650zwUJdN','handlePdfExtraction','map','default','PDF\x20解析失败','assign','pdf-parse','error','appId','非法操作、您在使用一个未启用的应用！','save','796XhcAVz','更新对话失败！','from','extractPdfText','5163424Drvrme','call','请先选择一个对话或者新加一个对话再操作！','create','../models/models.service','55989zIiAuh','hasOwnProperty','length'];_0x5f29=function(){return _0x399af7;};return _0x5f29();}var __decorate=this&&this['__decorate']||function(_0x49d8b9,_0x47f92b,_0x29130a,_0x3f685e){const _0x22e99d=_0x3a3a;var _0x3bead3=arguments['length'],_0x4d5325=_0x3bead3<0x3?_0x47f92b:_0x3f685e===null?_0x3f685e=Object[_0x22e99d(0x91)](_0x47f92b,_0x29130a):_0x3f685e,_0x5a7af3;if(typeof Reflect===_0x22e99d(0x86)&&typeof Reflect[_0x22e99d(0x81)]===_0x22e99d(0x8c))_0x4d5325=Reflect[_0x22e99d(0x81)](_0x49d8b9,_0x47f92b,_0x29130a,_0x3f685e);else{for(var _0x2748a1=_0x49d8b9[_0x22e99d(0x78)]-0x1;_0x2748a1>=0x0;_0x2748a1--)if(_0x5a7af3=_0x49d8b9[_0x2748a1])_0x4d5325=(_0x3bead3<0x3?_0x5a7af3(_0x4d5325):_0x3bead3>0x3?_0x5a7af3(_0x47f92b,_0x29130a,_0x4d5325):_0x5a7af3(_0x47f92b,_0x29130a))||_0x4d5325;}return _0x3bead3>0x3&&_0x4d5325&&Object[_0x22e99d(0x89)](_0x47f92b,_0x29130a,_0x4d5325),_0x4d5325;},__metadata=this&&this[_0x354d09(0x9a)]||function(_0x369153,_0x4aa47c){const _0x207013=_0x354d09;if(typeof Reflect===_0x207013(0x86)&&typeof Reflect[_0x207013(0xb2)]===_0x207013(0x8c))return Reflect['metadata'](_0x369153,_0x4aa47c);},__param=this&&this['__param']||function(_0x4394b3,_0xbb2abf){return function(_0x5359bd,_0x3676d8){_0xbb2abf(_0x5359bd,_0x3676d8,_0x4394b3);};},__rest=this&&this[_0x354d09(0x96)]||function(_0x17baef,_0x4dd6ad){const _0x12ef3f=_0x354d09;var _0x2e9bdd={};for(var _0x3d7527 in _0x17baef)if(Object['prototype'][_0x12ef3f(0x77)][_0x12ef3f(0xc5)](_0x17baef,_0x3d7527)&&_0x4dd6ad[_0x12ef3f(0x9d)](_0x3d7527)<0x0)_0x2e9bdd[_0x3d7527]=_0x17baef[_0x3d7527];if(_0x17baef!=null&&typeof Object['getOwnPropertySymbols']===_0x12ef3f(0x8c))for(var _0x574a33=0x0,_0x3d7527=Object[_0x12ef3f(0x87)](_0x17baef);_0x574a33<_0x3d7527['length'];_0x574a33++){if(_0x4dd6ad[_0x12ef3f(0x9d)](_0x3d7527[_0x574a33])<0x0&&Object['prototype'][_0x12ef3f(0x90)][_0x12ef3f(0xc5)](_0x17baef,_0x3d7527[_0x574a33]))_0x2e9bdd[_0x3d7527[_0x574a33]]=_0x17baef[_0x3d7527[_0x574a33]];}return _0x2e9bdd;};Object['defineProperty'](exports,_0x354d09(0x7b),{'value':!![]}),exports[_0x354d09(0xa8)]=void 0x0;const common_1=require('@nestjs/common'),typeorm_1=require(_0x354d09(0x7c)),axios_1=require(_0x354d09(0xa0)),pdf=require(_0x354d09(0xbb)),typeorm_2=require('typeorm'),app_entity_1=require('../app/app.entity'),models_service_1=require(_0x354d09(0x75)),chatGroup_entity_1=require(_0x354d09(0x98));function _0x3a3a(_0x45379c,_0x1f1a87){const _0x5f29d9=_0x5f29();return _0x3a3a=function(_0x3a3a20,_0x255d4b){_0x3a3a20=_0x3a3a20-0x73;let _0xdd8565=_0x5f29d9[_0x3a3a20];return _0xdd8565;},_0x3a3a(_0x45379c,_0x1f1a87);}let ChatGroupService=class ChatGroupService{constructor(_0x538f37,_0x7c9429,_0x27bf19){const _0x2fae2c=_0x354d09;this[_0x2fae2c(0x8b)]=_0x538f37,this[_0x2fae2c(0xac)]=_0x7c9429,this['modelsService']=_0x27bf19;}async[_0x354d09(0x74)](_0x26fde7,_0x5a204f){const _0x2eb070=_0x354d09,{id:_0x3fdf12}=_0x5a204f[_0x2eb070(0x84)],{appId:_0x4bfe89,modelConfig:_0x547414,params:_0xd7fc37}=_0x26fde7;let _0x1aa933=_0x547414||await this['modelsService'][_0x2eb070(0x8e)]();if(!_0x1aa933)throw new common_1[(_0x2eb070(0x93))](_0x2eb070(0x97),common_1['HttpStatus'][_0x2eb070(0xa5)]);_0x1aa933=JSON[_0x2eb070(0x7f)](JSON[_0x2eb070(0x9e)](_0x1aa933));const _0x537d15={'title':'新对话','userId':_0x3fdf12,'appId':_0x4bfe89,'params':_0xd7fc37};if(_0x4bfe89){const _0x45bdcc=await this[_0x2eb070(0xac)][_0x2eb070(0x83)]({'where':{'id':_0x4bfe89}});if(!_0x45bdcc)throw new common_1['HttpException']('非法操作、您在使用一个不存在的应用！',common_1[_0x2eb070(0x7e)][_0x2eb070(0xa5)]);const {status:_0x1df7df,name:_0x5c03cb,isFixedModel:_0x160806,isGPTs:_0x5fc513,appModel:_0x2065ce,coverImg:_0x2b2e30}=_0x45bdcc;Object[_0x2eb070(0xba)](_0x1aa933[_0x2eb070(0x8f)],{'isGPTs':_0x5fc513,'isFixedModel':_0x160806,'modelAvatar':_0x2b2e30,'modelName':_0x5c03cb});if(_0x5fc513===0x1||_0x160806===0x1){const _0x1407bc=await this[_0x2eb070(0x7a)]['getCurrentModelKeyInfo'](_0x160806===0x1?_0x2065ce:'gpts');Object[_0x2eb070(0xba)](_0x1aa933['modelInfo'],{'deductType':_0x1407bc['deductType'],'deduct':_0x1407bc['deduct'],'model':_0x2065ce,'isFileUpload':_0x1407bc[_0x2eb070(0x85)]});}if(![0x1,0x3,0x4,0x5][_0x2eb070(0xa4)](_0x1df7df))throw new common_1[(_0x2eb070(0x93))](_0x2eb070(0xbe),common_1[_0x2eb070(0x7e)][_0x2eb070(0xa5)]);_0x5c03cb&&(_0x537d15[_0x2eb070(0x79)]=_0x5c03cb);}const _0x4f79a7=await this[_0x2eb070(0x8b)][_0x2eb070(0xbf)](Object[_0x2eb070(0xba)](Object[_0x2eb070(0xba)]({},_0x537d15),{'config':JSON[_0x2eb070(0x9e)](_0x1aa933)}));return _0x4f79a7;}async['query'](_0x347644){const _0x51be53=_0x354d09;try{const {id:_0x496640}=_0x347644[_0x51be53(0x84)],_0x5155f7={'userId':_0x496640,'isDelete':![]},_0x8b8617=await this[_0x51be53(0x8b)][_0x51be53(0xb3)]({'where':_0x5155f7,'order':{'isSticky':_0x51be53(0xb1),'updatedAt':_0x51be53(0xb1)}});return _0x8b8617;const _0x204a3d=_0x8b8617[_0x51be53(0x8a)](_0x2309ab=>_0x2309ab[_0x51be53(0xbd)])[_0x51be53(0xb7)](_0x48f277=>_0x48f277[_0x51be53(0xbd)]),_0x54c06b=await this[_0x51be53(0xac)][_0x51be53(0xb3)]({'where':{'id':(0x0,typeorm_2['In'])(_0x204a3d)}});return _0x8b8617['map'](_0x104be7=>{const _0x41b021=_0x51be53;var _0x59fbde;return _0x104be7[_0x41b021(0x99)]=(_0x59fbde=_0x54c06b[_0x41b021(0xb3)](_0x3e3a90=>_0x3e3a90['id']===_0x104be7['appId']))===null||_0x59fbde===void 0x0?void 0x0:_0x59fbde[_0x41b021(0x95)],_0x104be7;});}catch(_0x5a7c85){console['log']('error:\x20',_0x5a7c85);}}async[_0x354d09(0xae)](_0x501072,_0x204ad7){const _0x280659=_0x354d09,{title:_0x2e8263,isSticky:_0x5e2e17,groupId:_0x1470f5,config:_0x17336d,fileUrl:_0x37e55e}=_0x501072,{id:_0x1089bd}=_0x204ad7[_0x280659(0x84)],_0x5e4574=await this[_0x280659(0x8b)]['findOne']({'where':{'id':_0x1470f5,'userId':_0x1089bd}});if(!_0x5e4574)throw new common_1['HttpException'](_0x280659(0x73),common_1[_0x280659(0x7e)][_0x280659(0xa5)]);const {appId:_0x562d65}=_0x5e4574;if(_0x562d65&&!_0x2e8263)try{const _0x53ab7f=JSON[_0x280659(0x7f)](_0x17336d);if(Number(_0x53ab7f[_0x280659(0xa1)])!==0x1)throw new common_1[(_0x280659(0x93))](_0x280659(0xa6),common_1['HttpStatus'][_0x280659(0xa5)]);}catch(_0x4fc1a4){}const _0x2fe9dc={};_0x2e8263&&(_0x2fe9dc[_0x280659(0x79)]=_0x2e8263),typeof _0x5e2e17!=='undefined'&&(_0x2fe9dc[_0x280659(0x9b)]=_0x5e2e17),_0x17336d&&(_0x2fe9dc[_0x280659(0xb0)]=_0x17336d),_0x37e55e&&(_0x2fe9dc['fileUrl']=_0x37e55e);const _0x38d5f6=await this[_0x280659(0x8b)][_0x280659(0xae)]({'id':_0x1470f5},_0x2fe9dc);if(_0x38d5f6[_0x280659(0x80)])return _0x37e55e&&this[_0x280659(0xb6)](_0x37e55e,_0x1470f5),!![];else throw new common_1[(_0x280659(0x93))](_0x280659(0xc1),common_1['HttpStatus'][_0x280659(0xa5)]);}async[_0x354d09(0xb6)](_0x64fed8,_0x11988a){const _0x34599a=_0x354d09;try{const _0x20269d=await this[_0x34599a(0xc3)](_0x64fed8);await this[_0x34599a(0x8b)]['update']({'id':_0x11988a},{'pdfTextContent':_0x20269d});}catch(_0x3bd58a){console[_0x34599a(0xbc)]('PDF\x20读取失败:',_0x3bd58a);}}async[_0x354d09(0xc3)](_0x17f2a1){const _0x338692=_0x354d09;try{const _0x178f6c=await axios_1[_0x338692(0xb8)]['get'](_0x17f2a1,{'responseType':_0x338692(0x7d)}),_0x44a97d=Buffer[_0x338692(0xc2)](_0x178f6c[_0x338692(0x94)]),_0x3c5c7f=await pdf(_0x44a97d);return _0x3c5c7f[_0x338692(0xa7)];}catch(_0x2379aa){console['error']('PDF\x20解析失败:',_0x2379aa);throw new Error(_0x338692(0xb9));}}async[_0x354d09(0xa9)](_0x2ac7d4){const _0x2dcdc3=_0x354d09;await this[_0x2dcdc3(0x8b)][_0x2dcdc3(0xae)](_0x2ac7d4,{'updatedAt':new Date()});}async[_0x354d09(0xa2)](_0x2b7275,_0x576c0f){const _0x44e72b=_0x354d09,{groupId:_0x2a8264}=_0x2b7275,{id:_0x1ade0d}=_0x576c0f[_0x44e72b(0x84)],_0x483448=await this[_0x44e72b(0x8b)][_0x44e72b(0x83)]({'where':{'id':_0x2a8264,'userId':_0x1ade0d}});if(!_0x483448)throw new common_1[(_0x44e72b(0x93))](_0x44e72b(0x92),common_1['HttpStatus'][_0x44e72b(0xa5)]);const _0x42248b=await this[_0x44e72b(0x8b)][_0x44e72b(0xae)]({'id':_0x2a8264},{'isDelete':!![]});if(_0x42248b['affected'])return _0x44e72b(0xab);else throw new common_1[(_0x44e72b(0x93))]('删除失败！',common_1['HttpStatus'][_0x44e72b(0xa5)]);}async['delAll'](_0x367d3c){const _0x499525=_0x354d09,{id:_0x46c466}=_0x367d3c['user'],_0x43f7ea=await this[_0x499525(0x8b)][_0x499525(0xae)]({'userId':_0x46c466,'isSticky':![],'isDelete':![]},{'isDelete':!![]});if(_0x43f7ea['affected'])return _0x499525(0xab);else throw new common_1[(_0x499525(0x93))]('删除失败！',common_1['HttpStatus']['BAD_REQUEST']);}async['getGroupInfoFromId'](_0x3d24bd){const _0x1a79f8=_0x354d09;if(!_0x3d24bd)return;const _0x308738=await this[_0x1a79f8(0x8b)][_0x1a79f8(0x83)]({'where':{'id':_0x3d24bd}});if(_0x308738){const {pdfTextContent:_0x4ec5d4}=_0x308738,_0x948fb6=__rest(_0x308738,[_0x1a79f8(0xa3)]);return _0x948fb6;}}async['getGroupPdfText'](_0x3d7071){const _0x2d7182=_0x354d09,_0x4c543c=await this[_0x2d7182(0x8b)][_0x2d7182(0x83)]({'where':{'id':_0x3d7071}});if(_0x4c543c)return _0x4c543c['pdfTextContent'];}};ChatGroupService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(chatGroup_entity_1['ChatGroupEntity'])),__param(0x1,(0x0,typeorm_1[_0x354d09(0x88)])(app_entity_1[_0x354d09(0xaf)])),__metadata('design:paramtypes',[typeorm_2[_0x354d09(0xb4)],typeorm_2[_0x354d09(0xb4)],models_service_1['ModelsService']])],ChatGroupService),exports['ChatGroupService']=ChatGroupService;