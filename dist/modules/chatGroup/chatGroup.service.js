'use strict';const _0x161189=_0x33a6;function _0x33a6(_0x5a595f,_0x595c22){const _0x2559f6=_0x2559();return _0x33a6=function(_0x33a686,_0x375cf5){_0x33a686=_0x33a686-0x191;let _0x476687=_0x2559f6[_0x33a686];return _0x476687;},_0x33a6(_0x5a595f,_0x595c22);}(function(_0x4cd6cc,_0x7f2c50){const _0x2f39e5=_0x33a6,_0x5356b8=_0x4cd6cc();while(!![]){try{const _0x5c4db7=-parseInt(_0x2f39e5(0x1a6))/0x1+parseInt(_0x2f39e5(0x1cd))/0x2*(parseInt(_0x2f39e5(0x1c1))/0x3)+-parseInt(_0x2f39e5(0x1e5))/0x4*(parseInt(_0x2f39e5(0x1d1))/0x5)+-parseInt(_0x2f39e5(0x198))/0x6+parseInt(_0x2f39e5(0x1ab))/0x7*(-parseInt(_0x2f39e5(0x1a0))/0x8)+-parseInt(_0x2f39e5(0x1f2))/0x9+-parseInt(_0x2f39e5(0x1e8))/0xa*(-parseInt(_0x2f39e5(0x19a))/0xb);if(_0x5c4db7===_0x7f2c50)break;else _0x5356b8['push'](_0x5356b8['shift']());}catch(_0x25108e){_0x5356b8['push'](_0x5356b8['shift']());}}}(_0x2559,0x5dc3b));function _0x2559(){const _0x445448=['更新对话失败！','isSticky','del','HttpException','3405384nIzGKu','defineProperty','arraybuffer','find','pdf-parse','modelInfo','271217CjUlHI','AppEntity','appId','PDF\x20读取失败:','extractPdfText','7oCWUGV','indexOf','call','ModelsService','includes','handlePdfExtraction','getOwnPropertySymbols','./chatGroup.entity','query','getOwnPropertyDescriptor','undefined','delAll','function','update','pdfTextContent','deductType','coverImg','title','metadata','Repository','chatGroupEntity','log','3321IsQhIB','@nestjs/typeorm','axios','error:\x20','save','删除成功','ChatGroupEntity','getGroupInfoFromId','ChatGroupService','__metadata','length','BAD_REQUEST','954InpUZo','affected','getGroupPdfText','../models/models.service','5LhUIKz','modelsService','HttpStatus','DESC','InjectRepository','__decorate','get','新对话','应用对话名称不能修改哟！','object','getBaseConfig','text','getCurrentModelKeyInfo','error','design:paramtypes','__param','PDF\x20解析失败','assign','data','filter','1034452PuTaKO','appEntity','decorate','16056310otccEq','prototype','findOne','非法操作、您在删除一个非法资源！','config','请先选择一个对话或者新加一个对话再操作！','stringify','deduct','parse','删除失败！','2151756CSwAeO','keyType','../app/app.entity','非法操作、您在使用一个未启用的应用！','user','map','PDF\x20解析失败:','create','Injectable','3330144fTEBuD','@nestjs/common','11munVcK','from'];_0x2559=function(){return _0x445448;};return _0x2559();}var __decorate=this&&this[_0x161189(0x1d6)]||function(_0xd980b6,_0x150a92,_0x2dd851,_0x1114f3){const _0x4cf1e7=_0x161189;var _0x12ea16=arguments[_0x4cf1e7(0x1cb)],_0x542e49=_0x12ea16<0x3?_0x150a92:_0x1114f3===null?_0x1114f3=Object[_0x4cf1e7(0x1b4)](_0x150a92,_0x2dd851):_0x1114f3,_0x58f5d0;if(typeof Reflect===_0x4cf1e7(0x1da)&&typeof Reflect[_0x4cf1e7(0x1e7)]===_0x4cf1e7(0x1b7))_0x542e49=Reflect[_0x4cf1e7(0x1e7)](_0xd980b6,_0x150a92,_0x2dd851,_0x1114f3);else{for(var _0x41abca=_0xd980b6[_0x4cf1e7(0x1cb)]-0x1;_0x41abca>=0x0;_0x41abca--)if(_0x58f5d0=_0xd980b6[_0x41abca])_0x542e49=(_0x12ea16<0x3?_0x58f5d0(_0x542e49):_0x12ea16>0x3?_0x58f5d0(_0x150a92,_0x2dd851,_0x542e49):_0x58f5d0(_0x150a92,_0x2dd851))||_0x542e49;}return _0x12ea16>0x3&&_0x542e49&&Object[_0x4cf1e7(0x1a1)](_0x150a92,_0x2dd851,_0x542e49),_0x542e49;},__metadata=this&&this[_0x161189(0x1ca)]||function(_0x13db7c,_0x2ede83){const _0xd5e066=_0x161189;if(typeof Reflect===_0xd5e066(0x1da)&&typeof Reflect[_0xd5e066(0x1bd)]==='function')return Reflect[_0xd5e066(0x1bd)](_0x13db7c,_0x2ede83);},__param=this&&this[_0x161189(0x1e0)]||function(_0xf339a7,_0xf7f64d){return function(_0x3f41ee,_0x3292ee){_0xf7f64d(_0x3f41ee,_0x3292ee,_0xf339a7);};},__rest=this&&this['__rest']||function(_0x445850,_0x2c926b){const _0x2db461=_0x161189;var _0x47278b={};for(var _0x33007d in _0x445850)if(Object[_0x2db461(0x1e9)]['hasOwnProperty'][_0x2db461(0x1ad)](_0x445850,_0x33007d)&&_0x2c926b[_0x2db461(0x1ac)](_0x33007d)<0x0)_0x47278b[_0x33007d]=_0x445850[_0x33007d];if(_0x445850!=null&&typeof Object[_0x2db461(0x1b1)]===_0x2db461(0x1b7))for(var _0x4d777e=0x0,_0x33007d=Object['getOwnPropertySymbols'](_0x445850);_0x4d777e<_0x33007d['length'];_0x4d777e++){if(_0x2c926b[_0x2db461(0x1ac)](_0x33007d[_0x4d777e])<0x0&&Object[_0x2db461(0x1e9)]['propertyIsEnumerable'][_0x2db461(0x1ad)](_0x445850,_0x33007d[_0x4d777e]))_0x47278b[_0x33007d[_0x4d777e]]=_0x445850[_0x33007d[_0x4d777e]];}return _0x47278b;};Object[_0x161189(0x1a1)](exports,'__esModule',{'value':!![]}),exports[_0x161189(0x1c9)]=void 0x0;const common_1=require(_0x161189(0x199)),typeorm_1=require(_0x161189(0x1c2)),axios_1=require(_0x161189(0x1c3)),pdf=require(_0x161189(0x1a4)),typeorm_2=require('typeorm'),app_entity_1=require(_0x161189(0x191)),models_service_1=require(_0x161189(0x1d0)),chatGroup_entity_1=require(_0x161189(0x1b2));let ChatGroupService=class ChatGroupService{constructor(_0x4cf4a,_0x53cca,_0x494843){const _0x23fe95=_0x161189;this['chatGroupEntity']=_0x4cf4a,this[_0x23fe95(0x1e6)]=_0x53cca,this[_0x23fe95(0x1d2)]=_0x494843;}async[_0x161189(0x196)](_0x2fedd9,_0x2e3155){const _0x481ec8=_0x161189,{id:_0x253dfa}=_0x2e3155[_0x481ec8(0x193)],{appId:_0x27abab,modelConfig:_0x47c058,params:_0x4d85b9}=_0x2fedd9;let _0x11cecd=_0x47c058||await this[_0x481ec8(0x1d2)][_0x481ec8(0x1db)]();if(!_0x11cecd)throw new common_1[(_0x481ec8(0x19f))]('管理员未配置任何AI模型、请先联系管理员开通聊天模型配置！',common_1[_0x481ec8(0x1d3)][_0x481ec8(0x1cc)]);_0x11cecd=JSON[_0x481ec8(0x1f0)](JSON[_0x481ec8(0x1ee)](_0x11cecd));const _0x4ae5de={'title':_0x481ec8(0x1d8),'userId':_0x253dfa,'appId':_0x27abab,'params':_0x4d85b9};if(_0x27abab){const _0x52f382=await this[_0x481ec8(0x1e6)][_0x481ec8(0x1ea)]({'where':{'id':_0x27abab}});if(!_0x52f382)throw new common_1[(_0x481ec8(0x19f))]('非法操作、您在使用一个不存在的应用！',common_1[_0x481ec8(0x1d3)]['BAD_REQUEST']);const {status:_0x4b5c8a,name:_0x42d184,isFixedModel:_0x4fe614,isGPTs:_0x373ac4,appModel:_0x31fef5,coverImg:_0x46cbfa}=_0x52f382;Object[_0x481ec8(0x1e2)](_0x11cecd[_0x481ec8(0x1a5)],{'isGPTs':_0x373ac4,'isFixedModel':_0x4fe614,'modelAvatar':_0x46cbfa,'modelName':_0x42d184});if(_0x373ac4===0x1||_0x4fe614===0x1){const _0x33a29a=await this[_0x481ec8(0x1d2)][_0x481ec8(0x1dd)](_0x4fe614===0x1?_0x31fef5:'gpts');Object[_0x481ec8(0x1e2)](_0x11cecd['modelInfo'],{'deductType':_0x33a29a[_0x481ec8(0x1ba)],'deduct':_0x33a29a[_0x481ec8(0x1ef)],'model':_0x31fef5,'isFileUpload':_0x33a29a['isFileUpload']});}if(![0x1,0x3,0x4,0x5][_0x481ec8(0x1af)](_0x4b5c8a))throw new common_1[(_0x481ec8(0x19f))](_0x481ec8(0x192),common_1[_0x481ec8(0x1d3)][_0x481ec8(0x1cc)]);_0x42d184&&(_0x4ae5de[_0x481ec8(0x1bc)]=_0x42d184);}const _0x39f82f=await this['chatGroupEntity'][_0x481ec8(0x1c5)](Object[_0x481ec8(0x1e2)](Object[_0x481ec8(0x1e2)]({},_0x4ae5de),{'config':JSON[_0x481ec8(0x1ee)](_0x11cecd)}));return _0x39f82f;}async[_0x161189(0x1b3)](_0x260526){const _0x53946b=_0x161189;try{const {id:_0x5f27aa}=_0x260526[_0x53946b(0x193)],_0x3c8597={'userId':_0x5f27aa,'isDelete':![]},_0x1599d8=await this[_0x53946b(0x1bf)][_0x53946b(0x1a3)]({'where':_0x3c8597,'order':{'isSticky':_0x53946b(0x1d4),'updatedAt':_0x53946b(0x1d4)}});return _0x1599d8;const _0x1c8681=_0x1599d8[_0x53946b(0x1e4)](_0x2d700b=>_0x2d700b[_0x53946b(0x1a8)])[_0x53946b(0x194)](_0x58fb92=>_0x58fb92[_0x53946b(0x1a8)]),_0x3b0c14=await this['appEntity'][_0x53946b(0x1a3)]({'where':{'id':(0x0,typeorm_2['In'])(_0x1c8681)}});return _0x1599d8[_0x53946b(0x194)](_0x354036=>{const _0x27c936=_0x53946b;var _0x4c619d;return _0x354036['appLogo']=(_0x4c619d=_0x3b0c14[_0x27c936(0x1a3)](_0x14b0ed=>_0x14b0ed['id']===_0x354036['appId']))===null||_0x4c619d===void 0x0?void 0x0:_0x4c619d[_0x27c936(0x1bb)],_0x354036;});}catch(_0x7d8e37){console[_0x53946b(0x1c0)](_0x53946b(0x1c4),_0x7d8e37);}}async[_0x161189(0x1b8)](_0x363359,_0x599fe8){const _0x535cff=_0x161189,{title:_0x321249,isSticky:_0x3af270,groupId:_0x3f9595,config:_0xdaa04e,fileUrl:_0x44071a}=_0x363359,{id:_0x51896c}=_0x599fe8['user'],_0x3c63a7=await this[_0x535cff(0x1bf)][_0x535cff(0x1ea)]({'where':{'id':_0x3f9595,'userId':_0x51896c}});if(!_0x3c63a7)throw new common_1[(_0x535cff(0x19f))](_0x535cff(0x1ed),common_1['HttpStatus'][_0x535cff(0x1cc)]);const {appId:_0x137726}=_0x3c63a7;if(_0x137726&&!_0x321249)try{const _0x46d5eb=JSON[_0x535cff(0x1f0)](_0xdaa04e);if(Number(_0x46d5eb[_0x535cff(0x1f3)])!==0x1)throw new common_1[(_0x535cff(0x19f))](_0x535cff(0x1d9),common_1['HttpStatus'][_0x535cff(0x1cc)]);}catch(_0x1d27c4){}const _0x5b6c4c={};_0x321249&&(_0x5b6c4c['title']=_0x321249),typeof _0x3af270!==_0x535cff(0x1b5)&&(_0x5b6c4c[_0x535cff(0x19d)]=_0x3af270),_0xdaa04e&&(_0x5b6c4c[_0x535cff(0x1ec)]=_0xdaa04e),_0x44071a&&(_0x5b6c4c['fileUrl']=_0x44071a);const _0x164f8b=await this[_0x535cff(0x1bf)][_0x535cff(0x1b8)]({'id':_0x3f9595},_0x5b6c4c);if(_0x164f8b[_0x535cff(0x1ce)])return _0x44071a&&this[_0x535cff(0x1b0)](_0x44071a,_0x3f9595),!![];else throw new common_1[(_0x535cff(0x19f))](_0x535cff(0x19c),common_1[_0x535cff(0x1d3)][_0x535cff(0x1cc)]);}async[_0x161189(0x1b0)](_0x211366,_0x1ef225){const _0x44cdb9=_0x161189;try{const _0x3bb335=await this['extractPdfText'](_0x211366);await this[_0x44cdb9(0x1bf)][_0x44cdb9(0x1b8)]({'id':_0x1ef225},{'pdfTextContent':_0x3bb335});}catch(_0x193c3f){console['error'](_0x44cdb9(0x1a9),_0x193c3f);}}async[_0x161189(0x1aa)](_0x2129dd){const _0x34960d=_0x161189;try{const _0x449dcf=await axios_1['default'][_0x34960d(0x1d7)](_0x2129dd,{'responseType':_0x34960d(0x1a2)}),_0x364562=Buffer[_0x34960d(0x19b)](_0x449dcf[_0x34960d(0x1e3)]),_0x4bf528=await pdf(_0x364562);return _0x4bf528[_0x34960d(0x1dc)];}catch(_0x595806){console[_0x34960d(0x1de)](_0x34960d(0x195),_0x595806);throw new Error(_0x34960d(0x1e1));}}async['updateTime'](_0x5d5e85){await this['chatGroupEntity']['update'](_0x5d5e85,{'updatedAt':new Date()});}async[_0x161189(0x19e)](_0x581eec,_0x599ef5){const _0x39d386=_0x161189,{groupId:_0x401b0c}=_0x581eec,{id:_0x476806}=_0x599ef5[_0x39d386(0x193)],_0x21ee8d=await this[_0x39d386(0x1bf)]['findOne']({'where':{'id':_0x401b0c,'userId':_0x476806}});if(!_0x21ee8d)throw new common_1[(_0x39d386(0x19f))](_0x39d386(0x1eb),common_1[_0x39d386(0x1d3)][_0x39d386(0x1cc)]);const _0x40d733=await this[_0x39d386(0x1bf)]['update']({'id':_0x401b0c},{'isDelete':!![]});if(_0x40d733[_0x39d386(0x1ce)])return'删除成功';else throw new common_1[(_0x39d386(0x19f))](_0x39d386(0x1f1),common_1[_0x39d386(0x1d3)][_0x39d386(0x1cc)]);}async[_0x161189(0x1b6)](_0x387893){const _0x3ac1c3=_0x161189,{id:_0x511130}=_0x387893['user'],_0x204690=await this[_0x3ac1c3(0x1bf)][_0x3ac1c3(0x1b8)]({'userId':_0x511130,'isSticky':![],'isDelete':![]},{'isDelete':!![]});if(_0x204690[_0x3ac1c3(0x1ce)])return _0x3ac1c3(0x1c6);else throw new common_1[(_0x3ac1c3(0x19f))](_0x3ac1c3(0x1f1),common_1[_0x3ac1c3(0x1d3)][_0x3ac1c3(0x1cc)]);}async[_0x161189(0x1c8)](_0x2e3ebf){const _0x1db1d0=_0x161189;if(!_0x2e3ebf)return;const _0x24b4a9=await this[_0x1db1d0(0x1bf)]['findOne']({'where':{'id':_0x2e3ebf}});if(_0x24b4a9){const {pdfTextContent:_0x18bd6d}=_0x24b4a9,_0x3b3bd9=__rest(_0x24b4a9,['pdfTextContent']);return _0x3b3bd9;}}async[_0x161189(0x1cf)](_0x1bba52){const _0x27a362=_0x161189,_0x5a5af2=await this[_0x27a362(0x1bf)][_0x27a362(0x1ea)]({'where':{'id':_0x1bba52}});if(_0x5a5af2)return _0x5a5af2[_0x27a362(0x1b9)];}};ChatGroupService=__decorate([(0x0,common_1[_0x161189(0x197)])(),__param(0x0,(0x0,typeorm_1[_0x161189(0x1d5)])(chatGroup_entity_1[_0x161189(0x1c7)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(app_entity_1[_0x161189(0x1a7)])),__metadata(_0x161189(0x1df),[typeorm_2[_0x161189(0x1be)],typeorm_2[_0x161189(0x1be)],models_service_1[_0x161189(0x1ae)]])],ChatGroupService),exports[_0x161189(0x1c9)]=ChatGroupService;