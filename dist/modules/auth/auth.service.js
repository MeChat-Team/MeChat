'use strict';const _0x4e89ef=_0x59ba;(function(_0x2fb158,_0x1851b8){const _0x403ed6=_0x59ba,_0x38c66f=_0x2fb158();while(!![]){try{const _0x3af94e=-parseInt(_0x403ed6(0x18c))/0x1*(parseInt(_0x403ed6(0x1b7))/0x2)+parseInt(_0x403ed6(0x154))/0x3+-parseInt(_0x403ed6(0x170))/0x4*(-parseInt(_0x403ed6(0x19c))/0x5)+parseInt(_0x403ed6(0x1bb))/0x6+parseInt(_0x403ed6(0x1a6))/0x7+-parseInt(_0x403ed6(0x183))/0x8*(parseInt(_0x403ed6(0x14d))/0x9)+parseInt(_0x403ed6(0x1a9))/0xa*(-parseInt(_0x403ed6(0x17d))/0xb);if(_0x3af94e===_0x1851b8)break;else _0x38c66f['push'](_0x38c66f['shift']());}catch(_0x53dc02){_0x38c66f['push'](_0x38c66f['shift']());}}}(_0x34f4,0x99db4));var __decorate=this&&this['__decorate']||function(_0x2cdb35,_0x30bea9,_0x573fa4,_0x33b776){const _0x3cdea8=_0x59ba;var _0xb95f42=arguments['length'],_0x1d6dbf=_0xb95f42<0x3?_0x30bea9:_0x33b776===null?_0x33b776=Object['getOwnPropertyDescriptor'](_0x30bea9,_0x573fa4):_0x33b776,_0xd49cbb;if(typeof Reflect==='object'&&typeof Reflect['decorate']===_0x3cdea8(0x175))_0x1d6dbf=Reflect['decorate'](_0x2cdb35,_0x30bea9,_0x573fa4,_0x33b776);else{for(var _0x4db5f2=_0x2cdb35[_0x3cdea8(0x1df)]-0x1;_0x4db5f2>=0x0;_0x4db5f2--)if(_0xd49cbb=_0x2cdb35[_0x4db5f2])_0x1d6dbf=(_0xb95f42<0x3?_0xd49cbb(_0x1d6dbf):_0xb95f42>0x3?_0xd49cbb(_0x30bea9,_0x573fa4,_0x1d6dbf):_0xd49cbb(_0x30bea9,_0x573fa4))||_0x1d6dbf;}return _0xb95f42>0x3&&_0x1d6dbf&&Object[_0x3cdea8(0x168)](_0x30bea9,_0x573fa4,_0x1d6dbf),_0x1d6dbf;},__metadata=this&&this[_0x4e89ef(0x1b3)]||function(_0x16c08a,_0x586b2c){const _0x3572e2=_0x4e89ef;if(typeof Reflect===_0x3572e2(0x156)&&typeof Reflect[_0x3572e2(0x190)]===_0x3572e2(0x175))return Reflect['metadata'](_0x16c08a,_0x586b2c);},__param=this&&this[_0x4e89ef(0x157)]||function(_0x324ae7,_0x404830){return function(_0x5fc187,_0x370eeb){_0x404830(_0x5fc187,_0x370eeb,_0x324ae7);};};Object['defineProperty'](exports,_0x4e89ef(0x1d3),{'value':!![]}),exports[_0x4e89ef(0x1c4)]=void 0x0;const user_constant_1=require(_0x4e89ef(0x14e)),utils_1=require('../../common/utils'),globalConfig_service_1=require(_0x4e89ef(0x192)),common_1=require('@nestjs/common'),jwt_1=require(_0x4e89ef(0x1c0)),typeorm_1=require(_0x4e89ef(0x1e6)),bcrypt=require(_0x4e89ef(0x16e)),os=require('os'),typeorm_2=require('typeorm'),config_entity_1=require(_0x4e89ef(0x1a2)),mailer_service_1=require(_0x4e89ef(0x1a1)),redisCache_service_1=require(_0x4e89ef(0x169)),user_service_1=require(_0x4e89ef(0x17f)),userBalance_service_1=require(_0x4e89ef(0x1a4)),verification_service_1=require(_0x4e89ef(0x19d));function _0x34f4(){const _0x123dbc=['@aiweb.com','get','internal','实名认证结果:\x20','该手机号已注册，请直接登录！','验证码过期:\x20','该邮箱已注册，请直接登录！','defineProperty','../redisCache/redisCache.service','createUser','今日发送验证码次数已达上限，请24小时后再试！','RedisCacheService','用户创建成功，用户ID:\x20','bcryptjs','getClientIp','721984AOpHRY','验证码填写错误，请重新输入！','保存登录IP:\x20','当前手机号已注册，请勿重复注册！','updatePassword','function','GlobalConfigService','开始手机号认证流程','登录失败:\x20用户凭证无效\x20-\x20用户名:\x20','getConfigs','forEach','visitor','注册成功','35585BrMhFr','log','../user/user.service','验证码已过期，请重新发送！','sendCode','address','8SnWRbG','onModuleInit','configEntity','加密用户密码...','updateUserPassword','mailerService','@visitor.com','verificationService',',\x20isEmail:\x20','9459QWlcnN','JWT令牌生成成功\x20-\x20用户ID:\x20','loginWithCaptcha','login','metadata','认证成功','../globalConfig/globalConfig.service','认证失败，请检查相关信息','\x20is\x20taken:\x20','VerificationService','TOO_MANY_REQUESTS','del','sign','开始用户登录流程，用户名:\x20','Logger','loginByOpenId','15RrnLrU','./../verification/verification.service','userBalanceService','createTokenFromFingerprint','验证码错误，请重新输入！','../mailer/mailer.service','../globalConfig/config.entity','username','../userBalance/userBalance.service','验证过程出现错误','849555iSvZpO','当前邮箱已注册，请勿重复注册！','redisCacheService','3670YFQcOZ','UNAUTHORIZED','updateUserPhone','UserService','Retrieved\x20redisCode\x20for\x20','Email\x20','\x20输入的验证码:\x20','sendPhoneCode','ACTIVE','UserStatusErrMsg','__metadata','Contact:\x20','用户凭证验证成功，用户ID:\x20','test','42kmOuYQ','jwtService','verifyUserRegister','error','5837310atQqGT',',\x20isPhone:\x20','noVerifyRegister:\x20',',\x20用户名:\x20','getNamespace','@nestjs/jwt','身份验证错误，请检查实名信息','hashSync','IPv4','AuthService','user','authService','请提供有效的邮箱地址或手机号码。','avatar','set','127.0.0.1','globalConfigService','saveToken',':RATE_LIMIT:','开始实名认证流程',':CODE:','userService','令牌已保存到Redis\x20-\x20用户ID:\x20','savaLoginIp','__esModule','登录失败，用户凭证无效。','该手机号未注册，请先注册！','Repository','status','password','密码修改成功','Checking\x20if\x20username\x20','验证码错误:\x20','networkInterfaces','InjectRepository','ttl','length',',\x20期望的验证码:\x20','saveRealNameInfo','保存新用户到数据库...','身份验证错误，请检查相关信息','family','ipAddress','@nestjs/typeorm','UserStatusEnum','获取默认用户头像...','addBalanceToNewUser','验证码发送成功、请填写验证码完成','verifyPhoneIdentity','请输入验证码','JwtService','2344131OtQxyY','../../common/constants/user.constant','HttpException','HttpStatus','noVerifyRegister','register','userDefautlAvatar','1922403kZUowY','用户名已存在！','object','__param','debug','BAD_REQUEST','ConfigEntity','getIp','\x20-\x20用户ID:\x20','getUserInfo','createRandomCode','verifyUserCredentials','\x20is\x20available:\x20'];_0x34f4=function(){return _0x123dbc;};return _0x34f4();}let AuthService=class AuthService{constructor(_0x21fc5a,_0x5daf24,_0x1d2571,_0x387e6d,_0x3ae0c2,_0x43c202,_0x485d36,_0x51b613){const _0xb990c0=_0x4e89ef;this[_0xb990c0(0x185)]=_0x21fc5a,this[_0xb990c0(0x1d0)]=_0x5daf24,this[_0xb990c0(0x1b8)]=_0x1d2571,this[_0xb990c0(0x188)]=_0x387e6d,this[_0xb990c0(0x18a)]=_0x3ae0c2,this['userBalanceService']=_0x43c202,this[_0xb990c0(0x1a8)]=_0x485d36,this[_0xb990c0(0x1cb)]=_0x51b613;}async[_0x4e89ef(0x184)](){this['getIp']();}async[_0x4e89ef(0x152)](_0x58bcba,_0x1734fc){const _0x542c9f=_0x4e89ef,{password:_0x121469,contact:_0x5eaa92,code:_0x4e352e}=_0x58bcba;let _0x53479d='',_0xe96ebe='';const _0x58a968=/\S+@\S+\.\S+/['test'](_0x5eaa92),_0x2ce471=/^\d{10,}$/[_0x542c9f(0x1b6)](_0x5eaa92);common_1[_0x542c9f(0x19a)][_0x542c9f(0x158)](_0x542c9f(0x1b4)+_0x5eaa92+_0x542c9f(0x18b)+_0x58a968+_0x542c9f(0x1bc)+_0x2ce471);let _0x2a52a4=(0x0,utils_1['createRandomUid'])();while(!![]){const _0x14a69f=await this[_0x542c9f(0x1d0)]['verifyUserRegister']({'username':_0x2a52a4});common_1[_0x542c9f(0x19a)][_0x542c9f(0x158)](_0x542c9f(0x1da)+_0x2a52a4+_0x542c9f(0x194)+_0x14a69f);if(_0x14a69f)break;_0x2a52a4=(0x0,utils_1['createRandomUid'])();}if(_0x58a968){_0x53479d=_0x5eaa92;const _0x3ad05c=await this[_0x542c9f(0x1d0)]['verifyUserRegister']({'username':_0x2a52a4,'email':_0x53479d});common_1[_0x542c9f(0x19a)][_0x542c9f(0x158)](_0x542c9f(0x1ae)+_0x53479d+_0x542c9f(0x160)+_0x3ad05c);if(!_0x3ad05c)throw new common_1[(_0x542c9f(0x14f))](_0x542c9f(0x1a7),common_1[_0x542c9f(0x150)][_0x542c9f(0x159)]);}else{if(_0x2ce471){_0xe96ebe=_0x5eaa92;const _0x2b152c=await this[_0x542c9f(0x1d0)][_0x542c9f(0x1b9)]({'username':_0x2a52a4,'phone':_0xe96ebe});common_1[_0x542c9f(0x19a)][_0x542c9f(0x158)]('Phone\x20'+_0xe96ebe+'\x20is\x20available:\x20'+_0x2b152c);if(!_0x2b152c)throw new common_1[(_0x542c9f(0x14f))](_0x542c9f(0x173),common_1[_0x542c9f(0x150)][_0x542c9f(0x159)]);}else throw new common_1[(_0x542c9f(0x14f))](_0x542c9f(0x1c7),common_1['HttpStatus'][_0x542c9f(0x159)]);}const _0x1afa22=await this['globalConfigService'][_0x542c9f(0x179)]([_0x542c9f(0x151)]);common_1[_0x542c9f(0x19a)][_0x542c9f(0x158)](_0x542c9f(0x1bd)+_0x1afa22);if(_0x1afa22!=='1'){const _0x3e0c10=await this['globalConfigService']['getNamespace'](),_0x55f01b=_0x3e0c10+_0x542c9f(0x1cf)+_0x5eaa92,_0x438fed=await this[_0x542c9f(0x1a8)]['get']({'key':_0x55f01b});common_1[_0x542c9f(0x19a)]['debug'](_0x542c9f(0x1ad)+_0x5eaa92+':\x20'+_0x438fed);if(_0x4e352e==='')throw new common_1['HttpException'](_0x542c9f(0x1ec),common_1[_0x542c9f(0x150)][_0x542c9f(0x159)]);if(!_0x438fed){common_1[_0x542c9f(0x19a)][_0x542c9f(0x17e)]('验证码过期:\x20'+_0x5eaa92,_0x542c9f(0x1c6));throw new common_1[(_0x542c9f(0x14f))](_0x542c9f(0x180),common_1[_0x542c9f(0x150)]['BAD_REQUEST']);}if(_0x4e352e!==_0x438fed){common_1[_0x542c9f(0x19a)][_0x542c9f(0x17e)]('验证码错误:\x20'+_0x5eaa92+_0x542c9f(0x1af)+_0x4e352e+_0x542c9f(0x1e0)+_0x438fed,_0x542c9f(0x1c6));throw new common_1[(_0x542c9f(0x14f))](_0x542c9f(0x171),common_1['HttpStatus'][_0x542c9f(0x159)]);}}let _0x49425d;if(_0x58a968)_0x49425d={'username':_0x2a52a4,'password':_0x121469,'email':_0x5eaa92,'status':user_constant_1[_0x542c9f(0x1e7)][_0x542c9f(0x1b1)]};else{const _0x23e212=(0x0,utils_1['createRandomUid'])()+_0x542c9f(0x161);_0x49425d={'username':_0x2a52a4,'password':_0x121469,'email':_0x23e212,'phone':_0x5eaa92,'status':user_constant_1[_0x542c9f(0x1e7)][_0x542c9f(0x1b1)]};}common_1[_0x542c9f(0x19a)]['debug'](_0x542c9f(0x1e8));const _0xd7efb3=await this[_0x542c9f(0x1cb)]['getConfigs']([_0x542c9f(0x153)]);common_1[_0x542c9f(0x19a)][_0x542c9f(0x158)]('使用默认用户头像:\x20'+_0xd7efb3),_0x49425d[_0x542c9f(0x1c8)]=_0xd7efb3,common_1[_0x542c9f(0x19a)]['debug'](_0x542c9f(0x186));const _0x3dbcc3=bcrypt[_0x542c9f(0x1c2)](_0x121469,0xa);_0x49425d[_0x542c9f(0x1d8)]=_0x3dbcc3,common_1[_0x542c9f(0x19a)][_0x542c9f(0x158)](_0x542c9f(0x1e2));const _0x6c3433=await this[_0x542c9f(0x1d0)][_0x542c9f(0x16a)](_0x49425d);return common_1[_0x542c9f(0x19a)][_0x542c9f(0x158)](_0x542c9f(0x16d)+_0x6c3433['id']),await this[_0x542c9f(0x19e)][_0x542c9f(0x1e9)](_0x6c3433['id']),common_1[_0x542c9f(0x19a)]['debug']('完成新用户余额处理'),{'success':!![],'message':_0x542c9f(0x17c)};}async[_0x4e89ef(0x18f)](_0xc24b3d,_0x554aaf){const _0x448d21=_0x4e89ef;console[_0x448d21(0x17e)](_0x448d21(0x199)+_0xc24b3d[_0x448d21(0x1a3)]);const _0x5a3d10=await this[_0x448d21(0x1d0)][_0x448d21(0x15f)](_0xc24b3d);if(!_0x5a3d10){console[_0x448d21(0x1ba)](_0x448d21(0x178)+_0xc24b3d[_0x448d21(0x1a3)]);throw new common_1['HttpException'](_0x448d21(0x1d4),common_1[_0x448d21(0x150)][_0x448d21(0x1aa)]);}const {username:_0x3c2c41,id:_0x32c440,email:_0x1295b5,role:_0x13b32d,openId:_0xd0d15,client:_0x1259ed,phone:_0x3425da}=_0x5a3d10;console[_0x448d21(0x17e)](_0x448d21(0x1b5)+_0x32c440+_0x448d21(0x1be)+_0x3c2c41);const _0x199fa0=(0x0,utils_1[_0x448d21(0x16f)])(_0x554aaf);await this[_0x448d21(0x1d0)][_0x448d21(0x1d2)](_0x32c440,_0x199fa0),console[_0x448d21(0x17e)](_0x448d21(0x172)+_0x199fa0+_0x448d21(0x15c)+_0x32c440);const _0x1e2f01=await this[_0x448d21(0x1b8)][_0x448d21(0x198)]({'username':_0x3c2c41,'id':_0x32c440,'email':_0x1295b5,'role':_0x13b32d,'openId':_0xd0d15,'client':_0x1259ed,'phone':_0x3425da});return console[_0x448d21(0x17e)](_0x448d21(0x18d)+_0x32c440),await this[_0x448d21(0x1a8)][_0x448d21(0x1cc)](_0x32c440,_0x1e2f01),console[_0x448d21(0x17e)](_0x448d21(0x1d1)+_0x32c440),_0x1e2f01;}async[_0x4e89ef(0x18e)](_0x31922e,_0x204497){const _0x2d73b6=_0x4e89ef,{contact:_0x7eb33e,code:_0xf21daa}=_0x31922e;let _0x14a2e9='',_0xb2171c='';const _0x156231=/\S+@\S+\.\S+/[_0x2d73b6(0x1b6)](_0x7eb33e),_0x5e6ce2=/^\d{10,}$/[_0x2d73b6(0x1b6)](_0x7eb33e);if(_0x156231)_0x14a2e9=_0x7eb33e;else{if(_0x5e6ce2)_0xb2171c=_0x7eb33e;else throw new common_1[(_0x2d73b6(0x14f))](_0x2d73b6(0x1c7),common_1['HttpStatus'][_0x2d73b6(0x159)]);}if(!![]){if(_0x156231){const _0x28a4be=await this[_0x2d73b6(0x1d0)][_0x2d73b6(0x1b9)]({'email':_0x7eb33e});if(_0x28a4be)throw new common_1[(_0x2d73b6(0x14f))]('该邮箱未注册，请先注册！',common_1[_0x2d73b6(0x150)]['BAD_REQUEST']);}else{if(_0x5e6ce2){const _0x1222a2=await this[_0x2d73b6(0x1d0)][_0x2d73b6(0x1b9)]({'phone':_0x7eb33e});if(_0x1222a2)throw new common_1[(_0x2d73b6(0x14f))](_0x2d73b6(0x1d5),common_1['HttpStatus'][_0x2d73b6(0x159)]);}}}else{if(_0x156231){const _0x2a361e=await this[_0x2d73b6(0x1d0)]['verifyUserRegister']({'email':_0x7eb33e});if(!_0x2a361e)throw new common_1[(_0x2d73b6(0x14f))]('该邮箱已注册，请直接登录！',common_1['HttpStatus'][_0x2d73b6(0x159)]);}else{if(_0x5e6ce2){const _0xd23168=await this[_0x2d73b6(0x1d0)][_0x2d73b6(0x1b9)]({'phone':_0x7eb33e});if(!_0xd23168)throw new common_1[(_0x2d73b6(0x14f))](_0x2d73b6(0x165),common_1['HttpStatus'][_0x2d73b6(0x159)]);}}}const _0x187fcc=await this[_0x2d73b6(0x1cb)][_0x2d73b6(0x1bf)](),_0x43e077=_0x187fcc+':CODE:'+_0x7eb33e,_0xe94829=await this[_0x2d73b6(0x1a8)][_0x2d73b6(0x162)]({'key':_0x43e077});if(!_0xe94829){common_1['Logger']['log']('验证码过期:\x20'+_0x7eb33e,_0x2d73b6(0x1c6));throw new common_1[(_0x2d73b6(0x14f))](_0x2d73b6(0x180),common_1[_0x2d73b6(0x150)]['BAD_REQUEST']);}if(_0xe94829!==_0xf21daa){common_1[_0x2d73b6(0x19a)]['log']('验证码错误:\x20'+_0x7eb33e,_0x2d73b6(0x1c6));throw new common_1[(_0x2d73b6(0x14f))](_0x2d73b6(0x1a0),common_1['HttpStatus']['BAD_REQUEST']);}const _0x475673=await this['userService']['getUserByContact']({'email':_0x14a2e9,'phone':_0xb2171c});if(!_0x475673)throw new common_1['HttpException']('用户不存在，请先注册！',common_1[_0x2d73b6(0x150)]['NOT_FOUND']);if(_0x475673['status']!==user_constant_1['UserStatusEnum'][_0x2d73b6(0x1b1)])throw new common_1[(_0x2d73b6(0x14f))](user_constant_1[_0x2d73b6(0x1b2)][_0x475673[_0x2d73b6(0x1d7)]],common_1['HttpStatus'][_0x2d73b6(0x159)]);const {username:_0xe7b7be,id:_0x16baf0,role:_0x3bb2e7,openId:_0x4009fc,client:_0x1172ea}=_0x475673,_0xc7b5fc=(0x0,utils_1['getClientIp'])(_0x204497);await this[_0x2d73b6(0x1d0)][_0x2d73b6(0x1d2)](_0x16baf0,_0xc7b5fc);const _0x1a3cb7=await this['jwtService']['sign']({'username':_0xe7b7be,'id':_0x16baf0,'email':_0x14a2e9,'role':_0x3bb2e7,'openId':_0x4009fc,'client':_0x1172ea,'phone':_0xb2171c});return await this['redisCacheService'][_0x2d73b6(0x1cc)](_0x16baf0,_0x1a3cb7),await this[_0x2d73b6(0x1a8)][_0x2d73b6(0x197)](_0x43e077),_0x1a3cb7;}async[_0x4e89ef(0x19b)](_0x4edd03,_0x5addab){const _0x327089=_0x4e89ef,{status:_0x4e4a4e}=_0x4edd03;if(_0x4e4a4e!==user_constant_1[_0x327089(0x1e7)][_0x327089(0x1b1)])throw new common_1[(_0x327089(0x14f))](user_constant_1[_0x327089(0x1b2)][_0x4e4a4e],common_1[_0x327089(0x150)][_0x327089(0x159)]);const {username:_0x4d967a,id:_0x39219b,email:_0x50d30d,role:_0x5a378d,openId:_0x4749ec,client:_0x35b3df}=_0x4edd03,_0x41b011=(0x0,utils_1['getClientIp'])(_0x5addab);await this['userService'][_0x327089(0x1d2)](_0x39219b,_0x41b011);const _0x418fcf=await this['jwtService'][_0x327089(0x198)]({'username':_0x4d967a,'id':_0x39219b,'email':_0x50d30d,'role':_0x5a378d,'openId':_0x4749ec,'client':_0x35b3df});return await this[_0x327089(0x1a8)][_0x327089(0x1cc)](_0x39219b,_0x418fcf),_0x418fcf;}async['getInfo'](_0x3d5415){const _0x40d79b=_0x4e89ef,{id:_0x4802d6}=_0x3d5415[_0x40d79b(0x1c5)];return await this[_0x40d79b(0x1d0)][_0x40d79b(0x15d)](_0x4802d6);}async[_0x4e89ef(0x174)](_0x165569,_0x760221){const _0x1a0aca=_0x4e89ef,{id:_0x1199b0}=_0x165569[_0x1a0aca(0x1c5)];return this['userService'][_0x1a0aca(0x187)](_0x1199b0,_0x760221[_0x1a0aca(0x1d8)]),_0x1a0aca(0x1d9);}[_0x4e89ef(0x15b)](){const _0x2c8c8c=_0x4e89ef;let _0x1d1902;const _0x12cdb0=os[_0x2c8c8c(0x1dc)]();Object['keys'](_0x12cdb0)[_0x2c8c8c(0x17a)](_0x17f6d2=>{const _0x1d91fc=_0x2c8c8c,_0x377f0c=_0x12cdb0[_0x17f6d2];for(let _0x564fad=0x0;_0x564fad<_0x377f0c[_0x1d91fc(0x1df)];_0x564fad++){const _0x448e02=_0x377f0c[_0x564fad];if(_0x448e02[_0x1d91fc(0x1e4)]===_0x1d91fc(0x1c3)&&_0x448e02[_0x1d91fc(0x182)]!==_0x1d91fc(0x1ca)&&!_0x448e02[_0x1d91fc(0x163)]){_0x1d1902=_0x448e02[_0x1d91fc(0x182)];break;}}}),this[_0x2c8c8c(0x1e5)]=_0x1d1902;}async[_0x4e89ef(0x181)](_0x434a60){const _0x3cb342=_0x4e89ef,{contact:_0x54b63b,isLogin:_0x51bd30}=_0x434a60,_0x1b9d63=(0x0,utils_1[_0x3cb342(0x15e)])(),_0x16929d=/\S+@\S+\.\S+/[_0x3cb342(0x1b6)](_0x54b63b),_0x9db435=/^1\d{10}$/[_0x3cb342(0x1b6)](_0x54b63b);if(!_0x16929d&&!_0x9db435)throw new common_1[(_0x3cb342(0x14f))](_0x3cb342(0x1c7),common_1[_0x3cb342(0x150)][_0x3cb342(0x159)]);if(_0x51bd30){if(_0x16929d){const _0x453518=await this[_0x3cb342(0x1d0)][_0x3cb342(0x1b9)]({'email':_0x54b63b});if(_0x453518)throw new common_1[(_0x3cb342(0x14f))]('该邮箱未注册，请先注册！',common_1['HttpStatus'][_0x3cb342(0x159)]);}else{if(_0x9db435){const _0x498677=await this[_0x3cb342(0x1d0)][_0x3cb342(0x1b9)]({'phone':_0x54b63b});if(_0x498677)throw new common_1[(_0x3cb342(0x14f))](_0x3cb342(0x1d5),common_1[_0x3cb342(0x150)][_0x3cb342(0x159)]);}}}else{if(_0x16929d){const _0x557d92=await this[_0x3cb342(0x1d0)][_0x3cb342(0x1b9)]({'email':_0x54b63b});if(!_0x557d92)throw new common_1[(_0x3cb342(0x14f))](_0x3cb342(0x167),common_1[_0x3cb342(0x150)][_0x3cb342(0x159)]);}else{if(_0x9db435){const _0x2623ad=await this['userService'][_0x3cb342(0x1b9)]({'phone':_0x54b63b});if(!_0x2623ad)throw new common_1[(_0x3cb342(0x14f))](_0x3cb342(0x165),common_1[_0x3cb342(0x150)][_0x3cb342(0x159)]);}}}const _0x580420=await this[_0x3cb342(0x1cb)][_0x3cb342(0x1bf)](),_0xeef2d3=_0x580420+_0x3cb342(0x1cf)+_0x54b63b,_0x4dfeeb=_0x580420+_0x3cb342(0x1cd)+_0x54b63b,_0x44664b=await this[_0x3cb342(0x1a8)][_0x3cb342(0x1de)](_0xeef2d3);if(_0x44664b&&_0x44664b>0x0)throw new common_1['HttpException'](_0x44664b+'秒内不得重复发送验证码！',common_1[_0x3cb342(0x150)][_0x3cb342(0x159)]);const _0x998ce4=await this[_0x3cb342(0x1a8)][_0x3cb342(0x162)]({'key':_0x4dfeeb})||0x0;if(_0x998ce4>=0xa)throw new common_1['HttpException'](_0x3cb342(0x16b),common_1[_0x3cb342(0x150)][_0x3cb342(0x196)]);if(_0x16929d)await this[_0x3cb342(0x188)]['sendMail']({'to':_0x54b63b,'context':{'code':_0x1b9d63}});else{if(_0x9db435){const _0x1e586c={'phone':_0x54b63b,'code':_0x1b9d63};await this[_0x3cb342(0x18a)][_0x3cb342(0x1b0)](_0x1e586c);}}return await this['redisCacheService']['set']({'key':_0xeef2d3,'val':_0x1b9d63},0x5*0x3c),await this[_0x3cb342(0x1a8)][_0x3cb342(0x1c9)]({'key':_0x4dfeeb,'val':Number(_0x998ce4)+0x1},0x18*0x3c*0x3c),await this[_0x3cb342(0x1a8)][_0x3cb342(0x1c9)]({'key':_0xeef2d3,'val':_0x1b9d63},0x3c),_0x3cb342(0x1ea)+(_0x51bd30?'注册':'验证')+'！';}[_0x4e89ef(0x19f)](_0x54d3eb){const _0x139df4=_0x4e89ef,_0xea7f09=this[_0x139df4(0x1b8)][_0x139df4(0x198)]({'username':'游客'+_0x54d3eb,'id':_0x54d3eb,'email':_0x54d3eb+_0x139df4(0x189),'role':_0x139df4(0x17b),'openId':null,'client':null});return _0xea7f09;}async['verifyIdentity'](_0xa601a4,_0x4fe896){const _0x175fe7=_0x4e89ef;common_1[_0x175fe7(0x19a)][_0x175fe7(0x158)](_0x175fe7(0x1ce));const {name:_0x572a6e,idCard:_0x46e91c}=_0x4fe896,{id:_0x4aa536}=_0xa601a4[_0x175fe7(0x1c5)];try{const _0x582036=await this[_0x175fe7(0x18a)]['verifyIdentity'](_0x4fe896);common_1['Logger'][_0x175fe7(0x158)](_0x175fe7(0x164)+_0x582036);if(!_0x582036)throw new common_1[(_0x175fe7(0x14f))](_0x175fe7(0x1c1),common_1[_0x175fe7(0x150)][_0x175fe7(0x159)]);return await this[_0x175fe7(0x1d0)][_0x175fe7(0x1e1)](_0x4aa536,_0x572a6e,_0x46e91c),_0x175fe7(0x191);}catch(_0x8b1ba9){common_1[_0x175fe7(0x19a)][_0x175fe7(0x1ba)](_0x175fe7(0x1a5),_0x8b1ba9);throw new common_1[(_0x175fe7(0x14f))](_0x175fe7(0x193),common_1[_0x175fe7(0x150)][_0x175fe7(0x159)]);}}async[_0x4e89ef(0x1eb)](_0xb74624,_0x5482d0){const _0x578f92=_0x4e89ef;common_1[_0x578f92(0x19a)][_0x578f92(0x158)](_0x578f92(0x177));const {phone:_0x5bb1e7,username:_0x5169fc,password:_0x1d3f56,code:_0x319fe5}=_0x5482d0,{id:_0x27da60}=_0xb74624[_0x578f92(0x1c5)],_0x5274aa=this[_0x578f92(0x1cb)][_0x578f92(0x1bf)](),_0x388e14=_0x5274aa+':CODE:'+_0x5bb1e7,_0x584562=await this[_0x578f92(0x1a8)][_0x578f92(0x162)]({'key':_0x388e14});common_1[_0x578f92(0x19a)][_0x578f92(0x158)](_0x578f92(0x1ad)+_0x5bb1e7+':\x20'+_0x584562);if(_0x319fe5==='')throw new common_1[(_0x578f92(0x14f))](_0x578f92(0x1ec),common_1[_0x578f92(0x150)][_0x578f92(0x159)]);if(!_0x584562){common_1[_0x578f92(0x19a)][_0x578f92(0x17e)](_0x578f92(0x166)+_0x5bb1e7,_0x578f92(0x1c6));throw new common_1[(_0x578f92(0x14f))](_0x578f92(0x180),common_1[_0x578f92(0x150)][_0x578f92(0x159)]);}if(_0x319fe5!==_0x584562){common_1[_0x578f92(0x19a)][_0x578f92(0x17e)](_0x578f92(0x1db)+_0x5bb1e7+'\x20输入的验证码:\x20'+_0x319fe5+_0x578f92(0x1e0)+_0x584562,_0x578f92(0x1c6));throw new common_1[(_0x578f92(0x14f))](_0x578f92(0x171),common_1[_0x578f92(0x150)][_0x578f92(0x159)]);}if(_0x5169fc){const _0xff120e=await this[_0x578f92(0x1d0)]['isUsernameTaken'](_0x5482d0['username'],_0x27da60);if(_0xff120e)throw new common_1[(_0x578f92(0x14f))](_0x578f92(0x155),common_1[_0x578f92(0x150)][_0x578f92(0x159)]);}try{return await this[_0x578f92(0x1d0)][_0x578f92(0x1ab)](_0x27da60,_0x5bb1e7,_0x5169fc,_0x1d3f56),_0x578f92(0x191);}catch(_0xfb52ed){common_1[_0x578f92(0x19a)]['error']('验证过程出现错误',_0xfb52ed);throw new common_1[(_0x578f92(0x14f))](_0x578f92(0x1e3),common_1['HttpStatus'][_0x578f92(0x159)]);}}};function _0x59ba(_0x42f0ea,_0x32f9c6){const _0x34f4bc=_0x34f4();return _0x59ba=function(_0x59baf4,_0x13fd2a){_0x59baf4=_0x59baf4-0x14d;let _0xfde527=_0x34f4bc[_0x59baf4];return _0xfde527;},_0x59ba(_0x42f0ea,_0x32f9c6);}AuthService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x4e89ef(0x1dd)])(config_entity_1[_0x4e89ef(0x15a)])),__metadata('design:paramtypes',[typeorm_2[_0x4e89ef(0x1d6)],user_service_1[_0x4e89ef(0x1ac)],jwt_1[_0x4e89ef(0x1ed)],mailer_service_1['MailerService'],verification_service_1[_0x4e89ef(0x195)],userBalance_service_1['UserBalanceService'],redisCache_service_1[_0x4e89ef(0x16c)],globalConfig_service_1[_0x4e89ef(0x176)]])],AuthService),exports['AuthService']=AuthService;