'use strict';const _0x4fe84b=_0x2ec1;function _0x2ec1(_0x38de53,_0x2be8ba){const _0x58ee1a=_0x58ee();return _0x2ec1=function(_0x2ec143,_0x5afda5){_0x2ec143=_0x2ec143-0xe8;let _0x46f6a2=_0x58ee1a[_0x2ec143];return _0x46f6a2;},_0x2ec1(_0x38de53,_0x2be8ba);}(function(_0xf17ec5,_0x3ba6ab){const _0x2e7faf=_0x2ec1,_0x17ec0a=_0xf17ec5();while(!![]){try{const _0x5b0f2f=parseInt(_0x2e7faf(0x12c))/0x1*(-parseInt(_0x2e7faf(0x176))/0x2)+parseInt(_0x2e7faf(0x137))/0x3*(-parseInt(_0x2e7faf(0x185))/0x4)+-parseInt(_0x2e7faf(0x187))/0x5*(parseInt(_0x2e7faf(0x139))/0x6)+parseInt(_0x2e7faf(0x13f))/0x7*(parseInt(_0x2e7faf(0x14f))/0x8)+-parseInt(_0x2e7faf(0x104))/0x9*(parseInt(_0x2e7faf(0x10f))/0xa)+-parseInt(_0x2e7faf(0x161))/0xb*(-parseInt(_0x2e7faf(0x17e))/0xc)+parseInt(_0x2e7faf(0x160))/0xd*(parseInt(_0x2e7faf(0x14e))/0xe);if(_0x5b0f2f===_0x3ba6ab)break;else _0x17ec0a['push'](_0x17ec0a['shift']());}catch(_0x399898){_0x17ec0a['push'](_0x17ec0a['shift']());}}}(_0x58ee,0xde4cc));var __decorate=this&&this[_0x4fe84b(0xec)]||function(_0x41a08d,_0xc1438b,_0x562216,_0x5aae84){const _0x4a0e29=_0x4fe84b;var _0x5b1d34=arguments[_0x4a0e29(0x14d)],_0x11c5ae=_0x5b1d34<0x3?_0xc1438b:_0x5aae84===null?_0x5aae84=Object[_0x4a0e29(0x184)](_0xc1438b,_0x562216):_0x5aae84,_0x44ba8e;if(typeof Reflect==='object'&&typeof Reflect['decorate']===_0x4a0e29(0x150))_0x11c5ae=Reflect['decorate'](_0x41a08d,_0xc1438b,_0x562216,_0x5aae84);else{for(var _0x266361=_0x41a08d[_0x4a0e29(0x14d)]-0x1;_0x266361>=0x0;_0x266361--)if(_0x44ba8e=_0x41a08d[_0x266361])_0x11c5ae=(_0x5b1d34<0x3?_0x44ba8e(_0x11c5ae):_0x5b1d34>0x3?_0x44ba8e(_0xc1438b,_0x562216,_0x11c5ae):_0x44ba8e(_0xc1438b,_0x562216))||_0x11c5ae;}return _0x5b1d34>0x3&&_0x11c5ae&&Object[_0x4a0e29(0x140)](_0xc1438b,_0x562216,_0x11c5ae),_0x11c5ae;},__metadata=this&&this[_0x4fe84b(0x133)]||function(_0x2fe1a3,_0x211c5f){const _0x1aad56=_0x4fe84b;if(typeof Reflect==='object'&&typeof Reflect[_0x1aad56(0x144)]===_0x1aad56(0x150))return Reflect['metadata'](_0x2fe1a3,_0x211c5f);},__param=this&&this[_0x4fe84b(0x14a)]||function(_0x419446,_0xf111f9){return function(_0x1ee048,_0x44d0e8){_0xf111f9(_0x1ee048,_0x44d0e8,_0x419446);};};Object[_0x4fe84b(0x140)](exports,_0x4fe84b(0xea),{'value':!![]}),exports[_0x4fe84b(0x129)]=void 0x0;function _0x58ee(){const _0x3520a8=['该邮箱未注册，请先注册！',':CODE:','InjectRepository','saveToken','get','debug','userDefautlAvatar','开始实名认证流程','身份验证错误，请检查相关信息','redisCacheService','../../common/constants/user.constant','3027245PromPK','13894100AIjKlI','getConfigs','createRandomUid','实名认证结果:\x20','saveRealNameInfo','登录失败:\x20用户凭证无效\x20-\x20用户名:\x20','userService','status','createTokenFromFingerprint','ACTIVE','令牌已保存到Redis\x20-\x20用户ID:\x20','set','getClientIp','UserStatusEnum','今日发送验证码次数已达上限，请24小时后再试！','mailerService','GlobalConfigService','\x20输入的验证码:\x20','sign','verificationService','用户不存在，请先注册！','1242wSQUiV','\x20is\x20available:\x20','验证码发送成功、请填写验证码完成','verifyIdentity','ConfigEntity','loginByOpenId','验证码错误，请重新输入！',',\x20isPhone:\x20','12eWRWtd','MailerService','ttl','该邮箱已注册，请直接登录！','globalConfigService','noVerifyRegister','getOwnPropertyDescriptor','4388IsZzQm','getIp','1915uPkCfG','getUserInfo','UserService','__esModule','认证失败，请检查相关信息','__decorate','Logger','test','../userBalance/userBalance.service','login','verifyPhoneIdentity','UserStatusErrMsg','保存新用户到数据库...','验证码填写错误，请重新输入！','networkInterfaces','验证码已过期，请重新发送！','addBalanceToNewUser','isUsernameTaken','用户名已存在！','验证码错误:\x20','username','bcryptjs','注册成功','keys','UserBalanceService','\x20is\x20taken:\x20','onModuleInit','./../verification/verification.service','HttpStatus','14589LdFUFV','sendPhoneCode','visitor','IPv4','del','该手机号已注册，请直接登录！',',\x20用户名:\x20','开始手机号认证流程','typeorm','RedisCacheService','savaLoginIp','8790nvsqtI','加密用户密码...','Repository','HttpException','log','../globalConfig/config.entity','updatePassword','该手机号未注册，请先注册！','NOT_FOUND','用户创建成功，用户ID:\x20','user','authService','\x20-\x20用户ID:\x20','VerificationService','保存登录IP:\x20','请输入验证码','../../common/utils','当前手机号已注册，请勿重复注册！','getInfo','../globalConfig/globalConfig.service','ipAddress','@nestjs/jwt','认证成功','当前邮箱已注册，请勿重复注册！','noVerifyRegister:\x20','验证码过期:\x20','AuthService','error','请提供有效的邮箱地址或手机号码。','2122SnZYQm','getNamespace','verifyUserCredentials','验证过程出现错误','Email\x20','Retrieved\x20redisCode\x20for\x20','身份验证错误，请检查实名信息','__metadata','createUser','password',',\x20isEmail:\x20','105pgEgFf','UNAUTHORIZED','4134RostwM','登录失败，用户凭证无效。','JwtService',',\x20期望的验证码:\x20','JWT令牌生成成功\x20-\x20用户ID:\x20','sendCode','34426NsgMLF','defineProperty','Contact:\x20','getUserByContact','avatar','metadata','userBalanceService','@aiweb.com','verifyUserRegister','jwtService','密码修改成功','__param','address','BAD_REQUEST','length','98KZmfyq','1728hLrEvi','function','127.0.0.1','开始用户登录流程，用户名:\x20','configEntity','获取默认用户头像...'];_0x58ee=function(){return _0x3520a8;};return _0x58ee();}const user_constant_1=require(_0x4fe84b(0x15f)),utils_1=require(_0x4fe84b(0x11f)),globalConfig_service_1=require(_0x4fe84b(0x122)),common_1=require('@nestjs/common'),jwt_1=require(_0x4fe84b(0x124)),typeorm_1=require('@nestjs/typeorm'),bcrypt=require(_0x4fe84b(0xfc)),os=require('os'),typeorm_2=require(_0x4fe84b(0x10c)),config_entity_1=require(_0x4fe84b(0x114)),mailer_service_1=require('../mailer/mailer.service'),redisCache_service_1=require('../redisCache/redisCache.service'),user_service_1=require('../user/user.service'),userBalance_service_1=require(_0x4fe84b(0xef)),verification_service_1=require(_0x4fe84b(0x102));let AuthService=class AuthService{constructor(_0x524b7f,_0x172a7a,_0x40bd6e,_0x43515f,_0x549aa9,_0x314d8f,_0x9aa1c6,_0x23b65c){const _0x168d84=_0x4fe84b;this[_0x168d84(0x153)]=_0x524b7f,this[_0x168d84(0x167)]=_0x172a7a,this[_0x168d84(0x148)]=_0x40bd6e,this['mailerService']=_0x43515f,this[_0x168d84(0x174)]=_0x549aa9,this[_0x168d84(0x145)]=_0x314d8f,this[_0x168d84(0x15e)]=_0x9aa1c6,this[_0x168d84(0x182)]=_0x23b65c;}async[_0x4fe84b(0x101)](){const _0x23625e=_0x4fe84b;this[_0x23625e(0x186)]();}async['register'](_0x2dc1b6,_0x5d9492){const _0x2e71cd=_0x4fe84b,{password:_0x20f31a,contact:_0x2c8090,code:_0x171ccd}=_0x2dc1b6;let _0xc4ec0d='',_0x594831='';const _0x46d8ca=/\S+@\S+\.\S+/[_0x2e71cd(0xee)](_0x2c8090),_0x3f071b=/^\d{10,}$/[_0x2e71cd(0xee)](_0x2c8090);common_1[_0x2e71cd(0xed)][_0x2e71cd(0x15a)](_0x2e71cd(0x141)+_0x2c8090+_0x2e71cd(0x136)+_0x46d8ca+_0x2e71cd(0x17d)+_0x3f071b);let _0x38d76f=(0x0,utils_1[_0x2e71cd(0x163)])();while(!![]){const _0x590185=await this[_0x2e71cd(0x167)]['verifyUserRegister']({'username':_0x38d76f});common_1[_0x2e71cd(0xed)][_0x2e71cd(0x15a)]('Checking\x20if\x20username\x20'+_0x38d76f+_0x2e71cd(0x100)+_0x590185);if(_0x590185)break;_0x38d76f=(0x0,utils_1[_0x2e71cd(0x163)])();}if(_0x46d8ca){_0xc4ec0d=_0x2c8090;const _0xe0cfd3=await this[_0x2e71cd(0x167)][_0x2e71cd(0x147)]({'username':_0x38d76f,'email':_0xc4ec0d});common_1[_0x2e71cd(0xed)][_0x2e71cd(0x15a)](_0x2e71cd(0x130)+_0xc4ec0d+_0x2e71cd(0x177)+_0xe0cfd3);if(!_0xe0cfd3)throw new common_1[(_0x2e71cd(0x112))](_0x2e71cd(0x126),common_1[_0x2e71cd(0x103)][_0x2e71cd(0x14c)]);}else{if(_0x3f071b){_0x594831=_0x2c8090;const _0xccdd1e=await this[_0x2e71cd(0x167)]['verifyUserRegister']({'username':_0x38d76f,'phone':_0x594831});common_1[_0x2e71cd(0xed)][_0x2e71cd(0x15a)]('Phone\x20'+_0x594831+_0x2e71cd(0x177)+_0xccdd1e);if(!_0xccdd1e)throw new common_1[(_0x2e71cd(0x112))](_0x2e71cd(0x120),common_1[_0x2e71cd(0x103)]['BAD_REQUEST']);}else throw new common_1[(_0x2e71cd(0x112))](_0x2e71cd(0x12b),common_1[_0x2e71cd(0x103)][_0x2e71cd(0x14c)]);}const _0x1813fd=await this[_0x2e71cd(0x182)][_0x2e71cd(0x162)]([_0x2e71cd(0x183)]);common_1[_0x2e71cd(0xed)][_0x2e71cd(0x15a)](_0x2e71cd(0x127)+_0x1813fd);if(_0x1813fd!=='1'){const _0x5d7428=await this[_0x2e71cd(0x182)][_0x2e71cd(0x12d)](),_0x333982=_0x5d7428+_0x2e71cd(0x156)+_0x2c8090,_0x363795=await this[_0x2e71cd(0x15e)][_0x2e71cd(0x159)]({'key':_0x333982});common_1['Logger']['debug'](_0x2e71cd(0x131)+_0x2c8090+':\x20'+_0x363795);if(_0x171ccd==='')throw new common_1[(_0x2e71cd(0x112))](_0x2e71cd(0x11e),common_1[_0x2e71cd(0x103)][_0x2e71cd(0x14c)]);if(!_0x363795){common_1[_0x2e71cd(0xed)]['log'](_0x2e71cd(0x128)+_0x2c8090,_0x2e71cd(0x11a));throw new common_1[(_0x2e71cd(0x112))](_0x2e71cd(0xf6),common_1[_0x2e71cd(0x103)][_0x2e71cd(0x14c)]);}if(_0x171ccd!==_0x363795){common_1[_0x2e71cd(0xed)][_0x2e71cd(0x113)](_0x2e71cd(0xfa)+_0x2c8090+_0x2e71cd(0x172)+_0x171ccd+_0x2e71cd(0x13c)+_0x363795,_0x2e71cd(0x11a));throw new common_1[(_0x2e71cd(0x112))]('验证码填写错误，请重新输入！',common_1[_0x2e71cd(0x103)][_0x2e71cd(0x14c)]);}}let _0x3affe8;if(_0x46d8ca)_0x3affe8={'username':_0x38d76f,'password':_0x20f31a,'email':_0x2c8090,'status':user_constant_1[_0x2e71cd(0x16e)][_0x2e71cd(0x16a)]};else{const _0x2601b1=(0x0,utils_1[_0x2e71cd(0x163)])()+_0x2e71cd(0x146);_0x3affe8={'username':_0x38d76f,'password':_0x20f31a,'email':_0x2601b1,'phone':_0x2c8090,'status':user_constant_1[_0x2e71cd(0x16e)][_0x2e71cd(0x16a)]};}common_1['Logger'][_0x2e71cd(0x15a)](_0x2e71cd(0x154));const _0x19be72=await this[_0x2e71cd(0x182)][_0x2e71cd(0x162)]([_0x2e71cd(0x15b)]);common_1[_0x2e71cd(0xed)]['debug']('使用默认用户头像:\x20'+_0x19be72),_0x3affe8[_0x2e71cd(0x143)]=_0x19be72,common_1[_0x2e71cd(0xed)][_0x2e71cd(0x15a)](_0x2e71cd(0x110));const _0x41f8b6=bcrypt['hashSync'](_0x20f31a,0xa);_0x3affe8[_0x2e71cd(0x135)]=_0x41f8b6,common_1[_0x2e71cd(0xed)][_0x2e71cd(0x15a)](_0x2e71cd(0xf3));const _0xbb0cb1=await this['userService'][_0x2e71cd(0x134)](_0x3affe8);return common_1[_0x2e71cd(0xed)][_0x2e71cd(0x15a)](_0x2e71cd(0x118)+_0xbb0cb1['id']),await this[_0x2e71cd(0x145)][_0x2e71cd(0xf7)](_0xbb0cb1['id']),common_1[_0x2e71cd(0xed)]['debug']('完成新用户余额处理'),{'success':!![],'message':_0x2e71cd(0xfd)};}async[_0x4fe84b(0xf0)](_0x38f2b5,_0x2e61b3){const _0x152222=_0x4fe84b;console[_0x152222(0x113)](_0x152222(0x152)+_0x38f2b5['username']);const _0x82c485=await this[_0x152222(0x167)][_0x152222(0x12e)](_0x38f2b5);if(!_0x82c485){console[_0x152222(0x12a)](_0x152222(0x166)+_0x38f2b5[_0x152222(0xfb)]);throw new common_1[(_0x152222(0x112))](_0x152222(0x13a),common_1['HttpStatus'][_0x152222(0x138)]);}const {username:_0x21b006,id:_0x5348d9,email:_0x426c0a,role:_0x482fd9,openId:_0x29bd17,client:_0x598379,phone:_0x49bfc7}=_0x82c485;console[_0x152222(0x113)]('用户凭证验证成功，用户ID:\x20'+_0x5348d9+_0x152222(0x10a)+_0x21b006);const _0x4e9191=(0x0,utils_1['getClientIp'])(_0x2e61b3);await this[_0x152222(0x167)]['savaLoginIp'](_0x5348d9,_0x4e9191),console[_0x152222(0x113)](_0x152222(0x11d)+_0x4e9191+_0x152222(0x11b)+_0x5348d9);const _0x14717f=await this[_0x152222(0x148)][_0x152222(0x173)]({'username':_0x21b006,'id':_0x5348d9,'email':_0x426c0a,'role':_0x482fd9,'openId':_0x29bd17,'client':_0x598379,'phone':_0x49bfc7});return console[_0x152222(0x113)](_0x152222(0x13d)+_0x5348d9),await this[_0x152222(0x15e)][_0x152222(0x158)](_0x5348d9,_0x14717f),console['log'](_0x152222(0x16b)+_0x5348d9),_0x14717f;}async['loginWithCaptcha'](_0x4b8443,_0x3f92c4){const _0x228386=_0x4fe84b,{contact:_0x1a719c,code:_0x2c0a4b}=_0x4b8443;let _0x2e0388='',_0x4be63d='';const _0x402533=/\S+@\S+\.\S+/[_0x228386(0xee)](_0x1a719c),_0x1133b7=/^\d{10,}$/['test'](_0x1a719c);if(_0x402533)_0x2e0388=_0x1a719c;else{if(_0x1133b7)_0x4be63d=_0x1a719c;else throw new common_1[(_0x228386(0x112))](_0x228386(0x12b),common_1[_0x228386(0x103)][_0x228386(0x14c)]);}if(!![]){if(_0x402533){const _0x5d3b06=await this[_0x228386(0x167)][_0x228386(0x147)]({'email':_0x1a719c});if(_0x5d3b06)throw new common_1[(_0x228386(0x112))]('该邮箱未注册，请先注册！',common_1[_0x228386(0x103)][_0x228386(0x14c)]);}else{if(_0x1133b7){const _0x58faec=await this[_0x228386(0x167)]['verifyUserRegister']({'phone':_0x1a719c});if(_0x58faec)throw new common_1[(_0x228386(0x112))](_0x228386(0x116),common_1[_0x228386(0x103)][_0x228386(0x14c)]);}}}else{if(_0x402533){const _0x41361f=await this[_0x228386(0x167)][_0x228386(0x147)]({'email':_0x1a719c});if(!_0x41361f)throw new common_1[(_0x228386(0x112))](_0x228386(0x181),common_1[_0x228386(0x103)][_0x228386(0x14c)]);}else{if(_0x1133b7){const _0x398daa=await this[_0x228386(0x167)][_0x228386(0x147)]({'phone':_0x1a719c});if(!_0x398daa)throw new common_1[(_0x228386(0x112))]('该手机号已注册，请直接登录！',common_1[_0x228386(0x103)][_0x228386(0x14c)]);}}}const _0x2be90b=await this[_0x228386(0x182)]['getNamespace'](),_0x288851=_0x2be90b+_0x228386(0x156)+_0x1a719c,_0x595a0e=await this['redisCacheService'][_0x228386(0x159)]({'key':_0x288851});if(!_0x595a0e){common_1[_0x228386(0xed)][_0x228386(0x113)]('验证码过期:\x20'+_0x1a719c,_0x228386(0x11a));throw new common_1[(_0x228386(0x112))](_0x228386(0xf6),common_1[_0x228386(0x103)][_0x228386(0x14c)]);}if(_0x595a0e!==_0x2c0a4b){common_1[_0x228386(0xed)][_0x228386(0x113)](_0x228386(0xfa)+_0x1a719c,'authService');throw new common_1[(_0x228386(0x112))](_0x228386(0x17c),common_1[_0x228386(0x103)]['BAD_REQUEST']);}const _0x56c886=await this[_0x228386(0x167)][_0x228386(0x142)]({'email':_0x2e0388,'phone':_0x4be63d});if(!_0x56c886)throw new common_1[(_0x228386(0x112))](_0x228386(0x175),common_1['HttpStatus'][_0x228386(0x117)]);if(_0x56c886[_0x228386(0x168)]!==user_constant_1[_0x228386(0x16e)][_0x228386(0x16a)])throw new common_1['HttpException'](user_constant_1['UserStatusErrMsg'][_0x56c886[_0x228386(0x168)]],common_1['HttpStatus'][_0x228386(0x14c)]);const {username:_0xb9809f,id:_0x2c6fde,role:_0x2e2566,openId:_0x310732,client:_0x166a57}=_0x56c886,_0x10bba3=(0x0,utils_1[_0x228386(0x16d)])(_0x3f92c4);await this[_0x228386(0x167)][_0x228386(0x10e)](_0x2c6fde,_0x10bba3);const _0x4859a0=await this['jwtService'][_0x228386(0x173)]({'username':_0xb9809f,'id':_0x2c6fde,'email':_0x2e0388,'role':_0x2e2566,'openId':_0x310732,'client':_0x166a57,'phone':_0x4be63d});return await this[_0x228386(0x15e)][_0x228386(0x158)](_0x2c6fde,_0x4859a0),await this[_0x228386(0x15e)][_0x228386(0x108)](_0x288851),_0x4859a0;}async[_0x4fe84b(0x17b)](_0x24bfdb,_0x233a4e){const _0x2cd757=_0x4fe84b,{status:_0x5d03e0}=_0x24bfdb;if(_0x5d03e0!==user_constant_1[_0x2cd757(0x16e)]['ACTIVE'])throw new common_1[(_0x2cd757(0x112))](user_constant_1[_0x2cd757(0xf2)][_0x5d03e0],common_1[_0x2cd757(0x103)]['BAD_REQUEST']);const {username:_0x3e01da,id:_0x44d25d,email:_0xa91252,role:_0x51d2f0,openId:_0x29683f,client:_0x47f62f}=_0x24bfdb,_0x4fd7dd=(0x0,utils_1[_0x2cd757(0x16d)])(_0x233a4e);await this['userService'][_0x2cd757(0x10e)](_0x44d25d,_0x4fd7dd);const _0x55eebe=await this[_0x2cd757(0x148)][_0x2cd757(0x173)]({'username':_0x3e01da,'id':_0x44d25d,'email':_0xa91252,'role':_0x51d2f0,'openId':_0x29683f,'client':_0x47f62f});return await this[_0x2cd757(0x15e)][_0x2cd757(0x158)](_0x44d25d,_0x55eebe),_0x55eebe;}async[_0x4fe84b(0x121)](_0x494086){const _0x202240=_0x4fe84b,{id:_0x5f3f17}=_0x494086[_0x202240(0x119)];return await this[_0x202240(0x167)][_0x202240(0xe8)](_0x5f3f17);}async[_0x4fe84b(0x115)](_0x55140d,_0x229079){const _0x4b9feb=_0x4fe84b,{id:_0x48bd21}=_0x55140d[_0x4b9feb(0x119)];return this[_0x4b9feb(0x167)]['updateUserPassword'](_0x48bd21,_0x229079[_0x4b9feb(0x135)]),_0x4b9feb(0x149);}[_0x4fe84b(0x186)](){const _0x5ac536=_0x4fe84b;let _0x1b4d2e;const _0x469c3e=os[_0x5ac536(0xf5)]();Object[_0x5ac536(0xfe)](_0x469c3e)['forEach'](_0x4552e3=>{const _0x24bc0f=_0x5ac536,_0x26756a=_0x469c3e[_0x4552e3];for(let _0x1729eb=0x0;_0x1729eb<_0x26756a[_0x24bc0f(0x14d)];_0x1729eb++){const _0x272c50=_0x26756a[_0x1729eb];if(_0x272c50['family']===_0x24bc0f(0x107)&&_0x272c50[_0x24bc0f(0x14b)]!==_0x24bc0f(0x151)&&!_0x272c50['internal']){_0x1b4d2e=_0x272c50[_0x24bc0f(0x14b)];break;}}}),this[_0x5ac536(0x123)]=_0x1b4d2e;}async[_0x4fe84b(0x13e)](_0x396a84){const _0x5046ea=_0x4fe84b,{contact:_0x18c227,isLogin:_0x27eb64}=_0x396a84,_0x3ff8c9=(0x0,utils_1['createRandomCode'])(),_0x140e3d=/\S+@\S+\.\S+/['test'](_0x18c227),_0x2f6d70=/^1\d{10}$/[_0x5046ea(0xee)](_0x18c227);if(!_0x140e3d&&!_0x2f6d70)throw new common_1[(_0x5046ea(0x112))](_0x5046ea(0x12b),common_1[_0x5046ea(0x103)][_0x5046ea(0x14c)]);if(_0x27eb64){if(_0x140e3d){const _0x3d29ae=await this[_0x5046ea(0x167)]['verifyUserRegister']({'email':_0x18c227});if(_0x3d29ae)throw new common_1[(_0x5046ea(0x112))](_0x5046ea(0x155),common_1[_0x5046ea(0x103)][_0x5046ea(0x14c)]);}else{if(_0x2f6d70){const _0x22973f=await this['userService'][_0x5046ea(0x147)]({'phone':_0x18c227});if(_0x22973f)throw new common_1['HttpException'](_0x5046ea(0x116),common_1['HttpStatus'][_0x5046ea(0x14c)]);}}}else{if(_0x140e3d){const _0x27c3ce=await this[_0x5046ea(0x167)][_0x5046ea(0x147)]({'email':_0x18c227});if(!_0x27c3ce)throw new common_1[(_0x5046ea(0x112))](_0x5046ea(0x181),common_1[_0x5046ea(0x103)][_0x5046ea(0x14c)]);}else{if(_0x2f6d70){const _0x1f7e73=await this['userService'][_0x5046ea(0x147)]({'phone':_0x18c227});if(!_0x1f7e73)throw new common_1[(_0x5046ea(0x112))](_0x5046ea(0x109),common_1[_0x5046ea(0x103)][_0x5046ea(0x14c)]);}}}const _0x2ffa89=await this[_0x5046ea(0x182)][_0x5046ea(0x12d)](),_0xcafeb6=_0x2ffa89+':CODE:'+_0x18c227,_0x150557=_0x2ffa89+':RATE_LIMIT:'+_0x18c227,_0x287213=await this[_0x5046ea(0x15e)][_0x5046ea(0x180)](_0xcafeb6);if(_0x287213&&_0x287213>0x0)throw new common_1['HttpException'](_0x287213+'秒内不得重复发送验证码！',common_1['HttpStatus'][_0x5046ea(0x14c)]);const _0x2a1ddd=await this[_0x5046ea(0x15e)][_0x5046ea(0x159)]({'key':_0x150557})||0x0;if(_0x2a1ddd>=0xa)throw new common_1['HttpException'](_0x5046ea(0x16f),common_1[_0x5046ea(0x103)]['TOO_MANY_REQUESTS']);if(_0x140e3d)await this[_0x5046ea(0x170)]['sendMail']({'to':_0x18c227,'context':{'code':_0x3ff8c9}});else{if(_0x2f6d70){const _0x1272b9={'phone':_0x18c227,'code':_0x3ff8c9};await this[_0x5046ea(0x174)][_0x5046ea(0x105)](_0x1272b9);}}return await this['redisCacheService']['set']({'key':_0xcafeb6,'val':_0x3ff8c9},0x5*0x3c),await this[_0x5046ea(0x15e)]['set']({'key':_0x150557,'val':Number(_0x2a1ddd)+0x1},0x18*0x3c*0x3c),await this[_0x5046ea(0x15e)][_0x5046ea(0x16c)]({'key':_0xcafeb6,'val':_0x3ff8c9},0x3c),_0x5046ea(0x178)+(_0x27eb64?'注册':'验证')+'！';}[_0x4fe84b(0x169)](_0x304f17){const _0x328bb2=_0x4fe84b,_0x28bb37=this[_0x328bb2(0x148)][_0x328bb2(0x173)]({'username':'游客'+_0x304f17,'id':_0x304f17,'email':_0x304f17+'@visitor.com','role':_0x328bb2(0x106),'openId':null,'client':null});return _0x28bb37;}async[_0x4fe84b(0x179)](_0x32ad5d,_0x5cb09c){const _0x31d422=_0x4fe84b;common_1['Logger'][_0x31d422(0x15a)](_0x31d422(0x15c));const {name:_0x483a6a,idCard:_0x3512e1}=_0x5cb09c,{id:_0xa454d7}=_0x32ad5d[_0x31d422(0x119)];try{const _0x10ffa0=await this['verificationService'][_0x31d422(0x179)](_0x5cb09c);common_1[_0x31d422(0xed)][_0x31d422(0x15a)](_0x31d422(0x164)+_0x10ffa0);if(!_0x10ffa0)throw new common_1[(_0x31d422(0x112))](_0x31d422(0x132),common_1[_0x31d422(0x103)][_0x31d422(0x14c)]);return await this[_0x31d422(0x167)][_0x31d422(0x165)](_0xa454d7,_0x483a6a,_0x3512e1),_0x31d422(0x125);}catch(_0x4b1341){common_1[_0x31d422(0xed)][_0x31d422(0x12a)](_0x31d422(0x12f),_0x4b1341);throw new common_1[(_0x31d422(0x112))](_0x31d422(0xeb),common_1[_0x31d422(0x103)][_0x31d422(0x14c)]);}}async[_0x4fe84b(0xf1)](_0x42219c,_0x16fd99){const _0x301793=_0x4fe84b;common_1['Logger'][_0x301793(0x15a)](_0x301793(0x10b));const {phone:_0x16461f,username:_0x4a1afd,password:_0x24925f,code:_0x4afa3b}=_0x16fd99,{id:_0x4ca30d}=_0x42219c['user'],_0x96e24a=this['globalConfigService'][_0x301793(0x12d)](),_0x38f591=_0x96e24a+_0x301793(0x156)+_0x16461f,_0x2f2165=await this[_0x301793(0x15e)][_0x301793(0x159)]({'key':_0x38f591});common_1[_0x301793(0xed)]['debug'](_0x301793(0x131)+_0x16461f+':\x20'+_0x2f2165);if(_0x4afa3b==='')throw new common_1[(_0x301793(0x112))](_0x301793(0x11e),common_1['HttpStatus']['BAD_REQUEST']);if(!_0x2f2165){common_1[_0x301793(0xed)][_0x301793(0x113)](_0x301793(0x128)+_0x16461f,_0x301793(0x11a));throw new common_1[(_0x301793(0x112))](_0x301793(0xf6),common_1['HttpStatus'][_0x301793(0x14c)]);}if(_0x4afa3b!==_0x2f2165){common_1[_0x301793(0xed)][_0x301793(0x113)]('验证码错误:\x20'+_0x16461f+_0x301793(0x172)+_0x4afa3b+_0x301793(0x13c)+_0x2f2165,_0x301793(0x11a));throw new common_1[(_0x301793(0x112))](_0x301793(0xf4),common_1[_0x301793(0x103)]['BAD_REQUEST']);}if(_0x4a1afd){const _0xb65ab4=await this['userService'][_0x301793(0xf8)](_0x16fd99[_0x301793(0xfb)],_0x4ca30d);if(_0xb65ab4)throw new common_1[(_0x301793(0x112))](_0x301793(0xf9),common_1[_0x301793(0x103)][_0x301793(0x14c)]);}try{return await this[_0x301793(0x167)]['updateUserPhone'](_0x4ca30d,_0x16461f,_0x4a1afd,_0x24925f),'认证成功';}catch(_0x3b605e){common_1[_0x301793(0xed)][_0x301793(0x12a)](_0x301793(0x12f),_0x3b605e);throw new common_1[(_0x301793(0x112))](_0x301793(0x15d),common_1[_0x301793(0x103)]['BAD_REQUEST']);}}};AuthService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x4fe84b(0x157)])(config_entity_1[_0x4fe84b(0x17a)])),__metadata('design:paramtypes',[typeorm_2[_0x4fe84b(0x111)],user_service_1[_0x4fe84b(0xe9)],jwt_1[_0x4fe84b(0x13b)],mailer_service_1[_0x4fe84b(0x17f)],verification_service_1[_0x4fe84b(0x11c)],userBalance_service_1[_0x4fe84b(0xff)],redisCache_service_1[_0x4fe84b(0x10d)],globalConfig_service_1[_0x4fe84b(0x171)]])],AuthService),exports['AuthService']=AuthService;