'use strict';const _0x151065=_0x2f66;(function(_0xe61c37,_0x6dc40d){const _0x8cc60e=_0x2f66,_0xd163bd=_0xe61c37();while(!![]){try{const _0x3c0cc0=parseInt(_0x8cc60e(0x1c0))/0x1*(parseInt(_0x8cc60e(0x206))/0x2)+-parseInt(_0x8cc60e(0x19f))/0x3+parseInt(_0x8cc60e(0x220))/0x4*(parseInt(_0x8cc60e(0x200))/0x5)+parseInt(_0x8cc60e(0x1b2))/0x6*(parseInt(_0x8cc60e(0x205))/0x7)+parseInt(_0x8cc60e(0x1ae))/0x8*(-parseInt(_0x8cc60e(0x22d))/0x9)+parseInt(_0x8cc60e(0x1e6))/0xa*(-parseInt(_0x8cc60e(0x1c1))/0xb)+-parseInt(_0x8cc60e(0x210))/0xc;if(_0x3c0cc0===_0x6dc40d)break;else _0xd163bd['push'](_0xd163bd['shift']());}catch(_0x59601a){_0xd163bd['push'](_0xd163bd['shift']());}}}(_0x488b,0x429f8));function _0x488b(){const _0x1560be=['Logger','createUser','该邮箱未注册，请先注册！','onModuleInit','../userBalance/userBalance.service','获取默认用户头像...','length',',\x20用户名:\x20','verifyIdentity',',\x20期望的验证码:\x20','UserBalanceService','getUserByContact','sendPhoneCode','977240nyAugE','@nestjs/jwt','authService','addBalanceToNewUser','6kkWysm','完成新用户余额处理','认证失败，请检查相关信息','../redisCache/redisCache.service','@nestjs/common','get','test','userDefautlAvatar','JwtService','error','user','log','验证码错误:\x20','avatar','11iVPgJW','5439346hKvCjD','bcryptjs','MailerService','../../common/constants/user.constant','savaLoginIp','saveToken','userService','令牌已保存到Redis\x20-\x20用户ID:\x20','./../verification/verification.service','del','InjectRepository','metadata','@visitor.com','UNAUTHORIZED','HttpException','验证码已过期，请重新发送！','forEach','登录失败:\x20用户凭证无效\x20-\x20用户名:\x20','请提供有效的邮箱地址或手机号码。','今日发送验证码次数已达上限，请24小时后再试！','address','../user/user.service','用户创建成功，用户ID:\x20','sign','createRandomCode','getIp','getNamespace','getInfo','globalConfigService','updateUserPhone','getConfigs','@aiweb.com','保存登录IP:\x20','用户不存在，请先注册！','sendCode','../globalConfig/config.entity','使用默认用户头像:\x20','10FkBySk','updatePassword','redisCacheService','configEntity','ACTIVE','register','\x20-\x20用户ID:\x20','function','AuthService','当前邮箱已注册，请勿重复注册！','UserStatusEnum','验证码填写错误，请重新输入！','127.0.0.1','Contact:\x20','JWT令牌生成成功\x20-\x20用户ID:\x20','hashSync','userBalanceService','Checking\x20if\x20username\x20','networkInterfaces','NOT_FOUND','IPv4','验证过程出现错误','GlobalConfigService','username','RedisCacheService','status','6030hlBWKY','jwtService','加密用户密码...','注册成功','BAD_REQUEST','3011127BkUZBd','93772YUyfjg','__param','saveRealNameInfo','__esModule','debug','开始用户登录流程，用户名:\x20','getOwnPropertyDescriptor','mailerService','认证成功','保存新用户到数据库...','56520bXKBfg','createRandomUid','VerificationService','Retrieved\x20redisCode\x20for\x20','当前手机号已注册，请勿重复注册！','login','该手机号未注册，请先注册！','verificationService','decorate','Email\x20','visitor','该手机号已注册，请直接登录！','UserService','defineProperty','object','isUsernameTaken','700pVmnPm','verifyUserRegister','验证码过期:\x20','该邮箱已注册，请直接登录！','../../common/utils','请输入验证码','UserStatusErrMsg','loginByOpenId','ipAddress','TOO_MANY_REQUESTS','HttpStatus','开始实名认证流程','design:paramtypes','9GZIOWb','createTokenFromFingerprint','noVerifyRegister','updateUserPassword','set','family','typeorm','\x20输入的验证码:\x20','internal','getClientIp','788154JUaBRH',':CODE:'];_0x488b=function(){return _0x1560be;};return _0x488b();}function _0x2f66(_0x3efcb4,_0xca35f1){const _0x488b42=_0x488b();return _0x2f66=function(_0x2f6613,_0x1f440a){_0x2f6613=_0x2f6613-0x19a;let _0x57adfa=_0x488b42[_0x2f6613];return _0x57adfa;},_0x2f66(_0x3efcb4,_0xca35f1);}var __decorate=this&&this['__decorate']||function(_0x4582aa,_0x162a89,_0x47a6e2,_0x6a084c){const _0x493229=_0x2f66;var _0x5281bc=arguments[_0x493229(0x1a7)],_0x3da62c=_0x5281bc<0x3?_0x162a89:_0x6a084c===null?_0x6a084c=Object[_0x493229(0x20c)](_0x162a89,_0x47a6e2):_0x6a084c,_0x7b719c;if(typeof Reflect===_0x493229(0x21e)&&typeof Reflect[_0x493229(0x218)]===_0x493229(0x1ed))_0x3da62c=Reflect[_0x493229(0x218)](_0x4582aa,_0x162a89,_0x47a6e2,_0x6a084c);else{for(var _0x3451c7=_0x4582aa[_0x493229(0x1a7)]-0x1;_0x3451c7>=0x0;_0x3451c7--)if(_0x7b719c=_0x4582aa[_0x3451c7])_0x3da62c=(_0x5281bc<0x3?_0x7b719c(_0x3da62c):_0x5281bc>0x3?_0x7b719c(_0x162a89,_0x47a6e2,_0x3da62c):_0x7b719c(_0x162a89,_0x47a6e2))||_0x3da62c;}return _0x5281bc>0x3&&_0x3da62c&&Object[_0x493229(0x21d)](_0x162a89,_0x47a6e2,_0x3da62c),_0x3da62c;},__metadata=this&&this['__metadata']||function(_0x5d704f,_0x80291b){const _0x1d0459=_0x2f66;if(typeof Reflect===_0x1d0459(0x21e)&&typeof Reflect[_0x1d0459(0x1cc)]===_0x1d0459(0x1ed))return Reflect[_0x1d0459(0x1cc)](_0x5d704f,_0x80291b);},__param=this&&this[_0x151065(0x207)]||function(_0x6b91ba,_0x4af495){return function(_0xf7d082,_0x154d75){_0x4af495(_0xf7d082,_0x154d75,_0x6b91ba);};};Object['defineProperty'](exports,_0x151065(0x209),{'value':!![]}),exports[_0x151065(0x1ee)]=void 0x0;const user_constant_1=require(_0x151065(0x1c4)),utils_1=require(_0x151065(0x224)),globalConfig_service_1=require('../globalConfig/globalConfig.service'),common_1=require(_0x151065(0x1b6)),jwt_1=require(_0x151065(0x1af)),typeorm_1=require('@nestjs/typeorm'),bcrypt=require(_0x151065(0x1c2)),os=require('os'),typeorm_2=require(_0x151065(0x19b)),config_entity_1=require(_0x151065(0x1e4)),mailer_service_1=require('../mailer/mailer.service'),redisCache_service_1=require(_0x151065(0x1b5)),user_service_1=require(_0x151065(0x1d6)),userBalance_service_1=require(_0x151065(0x1a5)),verification_service_1=require(_0x151065(0x1c9));let AuthService=class AuthService{constructor(_0x420940,_0x27342c,_0x4352cd,_0x3df5cb,_0x8b0d94,_0x20a21c,_0x3385d9,_0x4771b3){const _0x2b4ece=_0x151065;this[_0x2b4ece(0x1e9)]=_0x420940,this[_0x2b4ece(0x1c7)]=_0x27342c,this[_0x2b4ece(0x201)]=_0x4352cd,this['mailerService']=_0x3df5cb,this[_0x2b4ece(0x217)]=_0x8b0d94,this[_0x2b4ece(0x1f6)]=_0x20a21c,this[_0x2b4ece(0x1e8)]=_0x3385d9,this[_0x2b4ece(0x1dd)]=_0x4771b3;}async[_0x151065(0x1a4)](){this['getIp']();}async[_0x151065(0x1eb)](_0xfd4916,_0x5754df){const _0x26d5a1=_0x151065,{password:_0x5955a5,contact:_0x408ba0,code:_0x310e9c}=_0xfd4916;let _0x3e32c3='',_0x52d728='';const _0x4fbecc=/\S+@\S+\.\S+/[_0x26d5a1(0x1b8)](_0x408ba0),_0x1d3c3d=/^\d{10,}$/[_0x26d5a1(0x1b8)](_0x408ba0);common_1[_0x26d5a1(0x1a1)]['debug'](_0x26d5a1(0x1f3)+_0x408ba0+',\x20isEmail:\x20'+_0x4fbecc+',\x20isPhone:\x20'+_0x1d3c3d);let _0x122f36=(0x0,utils_1[_0x26d5a1(0x211)])();while(!![]){const _0x36e9ea=await this[_0x26d5a1(0x1c7)][_0x26d5a1(0x221)]({'username':_0x122f36});common_1['Logger'][_0x26d5a1(0x20a)](_0x26d5a1(0x1f7)+_0x122f36+'\x20is\x20taken:\x20'+_0x36e9ea);if(_0x36e9ea)break;_0x122f36=(0x0,utils_1['createRandomUid'])();}if(_0x4fbecc){_0x3e32c3=_0x408ba0;const _0xa56630=await this['userService'][_0x26d5a1(0x221)]({'username':_0x122f36,'email':_0x3e32c3});common_1[_0x26d5a1(0x1a1)]['debug'](_0x26d5a1(0x219)+_0x3e32c3+'\x20is\x20available:\x20'+_0xa56630);if(!_0xa56630)throw new common_1[(_0x26d5a1(0x1cf))](_0x26d5a1(0x1ef),common_1['HttpStatus']['BAD_REQUEST']);}else{if(_0x1d3c3d){_0x52d728=_0x408ba0;const _0x3ba54b=await this[_0x26d5a1(0x1c7)][_0x26d5a1(0x221)]({'username':_0x122f36,'phone':_0x52d728});common_1[_0x26d5a1(0x1a1)][_0x26d5a1(0x20a)]('Phone\x20'+_0x52d728+'\x20is\x20available:\x20'+_0x3ba54b);if(!_0x3ba54b)throw new common_1[(_0x26d5a1(0x1cf))](_0x26d5a1(0x214),common_1[_0x26d5a1(0x22a)][_0x26d5a1(0x204)]);}else throw new common_1['HttpException']('请提供有效的邮箱地址或手机号码。',common_1[_0x26d5a1(0x22a)][_0x26d5a1(0x204)]);}const _0x5476e6=await this[_0x26d5a1(0x1dd)]['getConfigs']([_0x26d5a1(0x22f)]);common_1[_0x26d5a1(0x1a1)]['debug']('noVerifyRegister:\x20'+_0x5476e6);if(_0x5476e6!=='1'){const _0x5effa8=await this[_0x26d5a1(0x1dd)]['getNamespace'](),_0x264402=_0x5effa8+_0x26d5a1(0x1a0)+_0x408ba0,_0xf97f49=await this[_0x26d5a1(0x1e8)][_0x26d5a1(0x1b7)]({'key':_0x264402});common_1[_0x26d5a1(0x1a1)][_0x26d5a1(0x20a)](_0x26d5a1(0x213)+_0x408ba0+':\x20'+_0xf97f49);if(_0x310e9c==='')throw new common_1['HttpException'](_0x26d5a1(0x225),common_1['HttpStatus'][_0x26d5a1(0x204)]);if(!_0xf97f49){common_1['Logger']['log'](_0x26d5a1(0x222)+_0x408ba0,_0x26d5a1(0x1b0));throw new common_1['HttpException']('验证码已过期，请重新发送！',common_1[_0x26d5a1(0x22a)][_0x26d5a1(0x204)]);}if(_0x310e9c!==_0xf97f49){common_1[_0x26d5a1(0x1a1)]['log'](_0x26d5a1(0x1be)+_0x408ba0+_0x26d5a1(0x19c)+_0x310e9c+',\x20期望的验证码:\x20'+_0xf97f49,_0x26d5a1(0x1b0));throw new common_1[(_0x26d5a1(0x1cf))]('验证码填写错误，请重新输入！',common_1[_0x26d5a1(0x22a)][_0x26d5a1(0x204)]);}}let _0x2f2554;if(_0x4fbecc)_0x2f2554={'username':_0x122f36,'password':_0x5955a5,'email':_0x408ba0,'status':user_constant_1[_0x26d5a1(0x1f0)][_0x26d5a1(0x1ea)]};else{const _0x3aab24=(0x0,utils_1['createRandomUid'])()+_0x26d5a1(0x1e0);_0x2f2554={'username':_0x122f36,'password':_0x5955a5,'email':_0x3aab24,'phone':_0x408ba0,'status':user_constant_1[_0x26d5a1(0x1f0)][_0x26d5a1(0x1ea)]};}common_1[_0x26d5a1(0x1a1)][_0x26d5a1(0x20a)](_0x26d5a1(0x1a6));const _0x298bb7=await this[_0x26d5a1(0x1dd)][_0x26d5a1(0x1df)]([_0x26d5a1(0x1b9)]);common_1[_0x26d5a1(0x1a1)][_0x26d5a1(0x20a)](_0x26d5a1(0x1e5)+_0x298bb7),_0x2f2554[_0x26d5a1(0x1bf)]=_0x298bb7,common_1[_0x26d5a1(0x1a1)][_0x26d5a1(0x20a)](_0x26d5a1(0x202));const _0x3d24cc=bcrypt[_0x26d5a1(0x1f5)](_0x5955a5,0xa);_0x2f2554['password']=_0x3d24cc,common_1[_0x26d5a1(0x1a1)][_0x26d5a1(0x20a)](_0x26d5a1(0x20f));const _0x35d855=await this[_0x26d5a1(0x1c7)][_0x26d5a1(0x1a2)](_0x2f2554);return common_1[_0x26d5a1(0x1a1)]['debug'](_0x26d5a1(0x1d7)+_0x35d855['id']),await this['userBalanceService'][_0x26d5a1(0x1b1)](_0x35d855['id']),common_1[_0x26d5a1(0x1a1)]['debug'](_0x26d5a1(0x1b3)),{'success':!![],'message':_0x26d5a1(0x203)};}async[_0x151065(0x215)](_0x5f3473,_0x55738e){const _0x333af7=_0x151065;console[_0x333af7(0x1bd)](_0x333af7(0x20b)+_0x5f3473['username']);const _0xe914f1=await this['userService']['verifyUserCredentials'](_0x5f3473);if(!_0xe914f1){console['error'](_0x333af7(0x1d2)+_0x5f3473[_0x333af7(0x1fd)]);throw new common_1[(_0x333af7(0x1cf))]('登录失败，用户凭证无效。',common_1[_0x333af7(0x22a)][_0x333af7(0x1ce)]);}const {username:_0x372e6c,id:_0x37a2a4,email:_0x2f9a1f,role:_0x2c0926,openId:_0x3df6f2,client:_0x37577d,phone:_0x1658ad}=_0xe914f1;console[_0x333af7(0x1bd)]('用户凭证验证成功，用户ID:\x20'+_0x37a2a4+_0x333af7(0x1a8)+_0x372e6c);const _0x131c67=(0x0,utils_1[_0x333af7(0x19e)])(_0x55738e);await this['userService'][_0x333af7(0x1c5)](_0x37a2a4,_0x131c67),console[_0x333af7(0x1bd)](_0x333af7(0x1e1)+_0x131c67+_0x333af7(0x1ec)+_0x37a2a4);const _0x29ccca=await this['jwtService'][_0x333af7(0x1d8)]({'username':_0x372e6c,'id':_0x37a2a4,'email':_0x2f9a1f,'role':_0x2c0926,'openId':_0x3df6f2,'client':_0x37577d,'phone':_0x1658ad});return console[_0x333af7(0x1bd)](_0x333af7(0x1f4)+_0x37a2a4),await this[_0x333af7(0x1e8)][_0x333af7(0x1c6)](_0x37a2a4,_0x29ccca),console[_0x333af7(0x1bd)](_0x333af7(0x1c8)+_0x37a2a4),_0x29ccca;}async['loginWithCaptcha'](_0x50bda,_0x3bda88){const _0x591ade=_0x151065,{contact:_0x5b26f2,code:_0x33b7e4}=_0x50bda;let _0x18b0b5='',_0x1e219d='';const _0x295bd3=/\S+@\S+\.\S+/[_0x591ade(0x1b8)](_0x5b26f2),_0x30ca01=/^\d{10,}$/['test'](_0x5b26f2);if(_0x295bd3)_0x18b0b5=_0x5b26f2;else{if(_0x30ca01)_0x1e219d=_0x5b26f2;else throw new common_1['HttpException'](_0x591ade(0x1d3),common_1[_0x591ade(0x22a)][_0x591ade(0x204)]);}if(!![]){if(_0x295bd3){const _0x1503c8=await this[_0x591ade(0x1c7)][_0x591ade(0x221)]({'email':_0x5b26f2});if(_0x1503c8)throw new common_1[(_0x591ade(0x1cf))](_0x591ade(0x1a3),common_1[_0x591ade(0x22a)]['BAD_REQUEST']);}else{if(_0x30ca01){const _0xb32c1b=await this[_0x591ade(0x1c7)][_0x591ade(0x221)]({'phone':_0x5b26f2});if(_0xb32c1b)throw new common_1[(_0x591ade(0x1cf))]('该手机号未注册，请先注册！',common_1[_0x591ade(0x22a)][_0x591ade(0x204)]);}}}else{if(_0x295bd3){const _0x5b3bf6=await this[_0x591ade(0x1c7)][_0x591ade(0x221)]({'email':_0x5b26f2});if(!_0x5b3bf6)throw new common_1[(_0x591ade(0x1cf))](_0x591ade(0x223),common_1[_0x591ade(0x22a)]['BAD_REQUEST']);}else{if(_0x30ca01){const _0x22dc3a=await this['userService'][_0x591ade(0x221)]({'phone':_0x5b26f2});if(!_0x22dc3a)throw new common_1[(_0x591ade(0x1cf))](_0x591ade(0x21b),common_1[_0x591ade(0x22a)][_0x591ade(0x204)]);}}}const _0x2fc960=await this[_0x591ade(0x1dd)]['getNamespace'](),_0x1b8b6f=_0x2fc960+_0x591ade(0x1a0)+_0x5b26f2,_0x33e1bc=await this[_0x591ade(0x1e8)][_0x591ade(0x1b7)]({'key':_0x1b8b6f});if(!_0x33e1bc){common_1['Logger'][_0x591ade(0x1bd)]('验证码过期:\x20'+_0x5b26f2,'authService');throw new common_1[(_0x591ade(0x1cf))](_0x591ade(0x1d0),common_1[_0x591ade(0x22a)][_0x591ade(0x204)]);}if(_0x33e1bc!==_0x33b7e4){common_1['Logger'][_0x591ade(0x1bd)]('验证码错误:\x20'+_0x5b26f2,_0x591ade(0x1b0));throw new common_1[(_0x591ade(0x1cf))]('验证码错误，请重新输入！',common_1[_0x591ade(0x22a)][_0x591ade(0x204)]);}const _0x28bd26=await this['userService'][_0x591ade(0x1ac)]({'email':_0x18b0b5,'phone':_0x1e219d});if(!_0x28bd26)throw new common_1['HttpException'](_0x591ade(0x1e2),common_1[_0x591ade(0x22a)][_0x591ade(0x1f9)]);if(_0x28bd26[_0x591ade(0x1ff)]!==user_constant_1['UserStatusEnum'][_0x591ade(0x1ea)])throw new common_1['HttpException'](user_constant_1[_0x591ade(0x226)][_0x28bd26['status']],common_1[_0x591ade(0x22a)][_0x591ade(0x204)]);const {username:_0x4a55c5,id:_0x426b66,role:_0x2efa03,openId:_0x53458a,client:_0xe079fc}=_0x28bd26,_0x15f44a=(0x0,utils_1[_0x591ade(0x19e)])(_0x3bda88);await this[_0x591ade(0x1c7)][_0x591ade(0x1c5)](_0x426b66,_0x15f44a);const _0x91fa10=await this[_0x591ade(0x201)][_0x591ade(0x1d8)]({'username':_0x4a55c5,'id':_0x426b66,'email':_0x18b0b5,'role':_0x2efa03,'openId':_0x53458a,'client':_0xe079fc,'phone':_0x1e219d});return await this[_0x591ade(0x1e8)][_0x591ade(0x1c6)](_0x426b66,_0x91fa10),await this[_0x591ade(0x1e8)][_0x591ade(0x1ca)](_0x1b8b6f),_0x91fa10;}async[_0x151065(0x227)](_0x2adf40,_0x589d1d){const _0x223e68=_0x151065,{status:_0x29902a}=_0x2adf40;if(_0x29902a!==user_constant_1[_0x223e68(0x1f0)][_0x223e68(0x1ea)])throw new common_1[(_0x223e68(0x1cf))](user_constant_1[_0x223e68(0x226)][_0x29902a],common_1['HttpStatus']['BAD_REQUEST']);const {username:_0x2d4e03,id:_0x3dbb71,email:_0x33b96f,role:_0x47b1bc,openId:_0x821a1a,client:_0x46e76a}=_0x2adf40,_0xd3b48d=(0x0,utils_1[_0x223e68(0x19e)])(_0x589d1d);await this[_0x223e68(0x1c7)][_0x223e68(0x1c5)](_0x3dbb71,_0xd3b48d);const _0x55cd1d=await this[_0x223e68(0x201)]['sign']({'username':_0x2d4e03,'id':_0x3dbb71,'email':_0x33b96f,'role':_0x47b1bc,'openId':_0x821a1a,'client':_0x46e76a});return await this['redisCacheService'][_0x223e68(0x1c6)](_0x3dbb71,_0x55cd1d),_0x55cd1d;}async[_0x151065(0x1dc)](_0xb7f1f7){const _0x5a4dbb=_0x151065,{id:_0xca274}=_0xb7f1f7[_0x5a4dbb(0x1bc)];return await this[_0x5a4dbb(0x1c7)]['getUserInfo'](_0xca274);}async[_0x151065(0x1e7)](_0x2150b7,_0x237c44){const _0xbbb4c3=_0x151065,{id:_0x60652f}=_0x2150b7[_0xbbb4c3(0x1bc)];return this[_0xbbb4c3(0x1c7)][_0xbbb4c3(0x230)](_0x60652f,_0x237c44['password']),'密码修改成功';}[_0x151065(0x1da)](){const _0x5b2d50=_0x151065;let _0x135e49;const _0x41ed71=os[_0x5b2d50(0x1f8)]();Object['keys'](_0x41ed71)[_0x5b2d50(0x1d1)](_0x626d70=>{const _0x3a0743=_0x5b2d50,_0x46747b=_0x41ed71[_0x626d70];for(let _0x1fdf38=0x0;_0x1fdf38<_0x46747b['length'];_0x1fdf38++){const _0x54b966=_0x46747b[_0x1fdf38];if(_0x54b966[_0x3a0743(0x19a)]===_0x3a0743(0x1fa)&&_0x54b966[_0x3a0743(0x1d5)]!==_0x3a0743(0x1f2)&&!_0x54b966[_0x3a0743(0x19d)]){_0x135e49=_0x54b966[_0x3a0743(0x1d5)];break;}}}),this[_0x5b2d50(0x228)]=_0x135e49;}async[_0x151065(0x1e3)](_0x4121a9){const _0x154ad0=_0x151065,{contact:_0x6c37e1,isLogin:_0x4109b1}=_0x4121a9,_0x152007=(0x0,utils_1[_0x154ad0(0x1d9)])(),_0x1e9600=/\S+@\S+\.\S+/[_0x154ad0(0x1b8)](_0x6c37e1),_0x1d5449=/^1\d{10}$/[_0x154ad0(0x1b8)](_0x6c37e1);if(!_0x1e9600&&!_0x1d5449)throw new common_1['HttpException']('请提供有效的邮箱地址或手机号码。',common_1[_0x154ad0(0x22a)][_0x154ad0(0x204)]);if(_0x4109b1){if(_0x1e9600){const _0x140916=await this['userService'][_0x154ad0(0x221)]({'email':_0x6c37e1});if(_0x140916)throw new common_1[(_0x154ad0(0x1cf))]('该邮箱未注册，请先注册！',common_1[_0x154ad0(0x22a)][_0x154ad0(0x204)]);}else{if(_0x1d5449){const _0x5213e1=await this[_0x154ad0(0x1c7)][_0x154ad0(0x221)]({'phone':_0x6c37e1});if(_0x5213e1)throw new common_1[(_0x154ad0(0x1cf))](_0x154ad0(0x216),common_1[_0x154ad0(0x22a)][_0x154ad0(0x204)]);}}}else{if(_0x1e9600){const _0x1199fb=await this['userService'][_0x154ad0(0x221)]({'email':_0x6c37e1});if(!_0x1199fb)throw new common_1[(_0x154ad0(0x1cf))](_0x154ad0(0x223),common_1[_0x154ad0(0x22a)][_0x154ad0(0x204)]);}else{if(_0x1d5449){const _0x11bf71=await this[_0x154ad0(0x1c7)][_0x154ad0(0x221)]({'phone':_0x6c37e1});if(!_0x11bf71)throw new common_1[(_0x154ad0(0x1cf))](_0x154ad0(0x21b),common_1['HttpStatus'][_0x154ad0(0x204)]);}}}const _0x35d816=await this[_0x154ad0(0x1dd)][_0x154ad0(0x1db)](),_0x363699=_0x35d816+':CODE:'+_0x6c37e1,_0x2614be=_0x35d816+':RATE_LIMIT:'+_0x6c37e1,_0x430981=await this[_0x154ad0(0x1e8)]['ttl'](_0x363699);if(_0x430981&&_0x430981>0x0)throw new common_1['HttpException'](_0x430981+'秒内不得重复发送验证码！',common_1[_0x154ad0(0x22a)][_0x154ad0(0x204)]);const _0x5a3026=await this[_0x154ad0(0x1e8)][_0x154ad0(0x1b7)]({'key':_0x2614be})||0x0;if(_0x5a3026>=0xa)throw new common_1[(_0x154ad0(0x1cf))](_0x154ad0(0x1d4),common_1['HttpStatus'][_0x154ad0(0x229)]);if(_0x1e9600)await this[_0x154ad0(0x20d)]['sendMail']({'to':_0x6c37e1,'context':{'code':_0x152007}});else{if(_0x1d5449){const _0x4b9382={'phone':_0x6c37e1,'code':_0x152007};await this['verificationService'][_0x154ad0(0x1ad)](_0x4b9382);}}return await this[_0x154ad0(0x1e8)]['set']({'key':_0x363699,'val':_0x152007},0x5*0x3c),await this[_0x154ad0(0x1e8)][_0x154ad0(0x231)]({'key':_0x2614be,'val':Number(_0x5a3026)+0x1},0x18*0x3c*0x3c),await this[_0x154ad0(0x1e8)][_0x154ad0(0x231)]({'key':_0x363699,'val':_0x152007},0x3c),'验证码发送成功、请填写验证码完成'+(_0x4109b1?'注册':'验证')+'！';}[_0x151065(0x22e)](_0x559889){const _0x132f0b=_0x151065,_0x5774af=this[_0x132f0b(0x201)][_0x132f0b(0x1d8)]({'username':'游客'+_0x559889,'id':_0x559889,'email':_0x559889+_0x132f0b(0x1cd),'role':_0x132f0b(0x21a),'openId':null,'client':null});return _0x5774af;}async['verifyIdentity'](_0x5e832b,_0x3abad6){const _0x62d1ad=_0x151065;common_1['Logger'][_0x62d1ad(0x20a)](_0x62d1ad(0x22b));const {name:_0xe91ed3,idCard:_0x3b98d1}=_0x3abad6,{id:_0x4fdb2c}=_0x5e832b['user'];try{const _0x212e41=await this[_0x62d1ad(0x217)][_0x62d1ad(0x1a9)](_0x3abad6);common_1['Logger']['debug']('实名认证结果:\x20'+_0x212e41);if(!_0x212e41)throw new common_1['HttpException']('身份验证错误，请检查实名信息',common_1[_0x62d1ad(0x22a)][_0x62d1ad(0x204)]);return await this[_0x62d1ad(0x1c7)][_0x62d1ad(0x208)](_0x4fdb2c,_0xe91ed3,_0x3b98d1),_0x62d1ad(0x20e);}catch(_0x51c976){common_1[_0x62d1ad(0x1a1)][_0x62d1ad(0x1bb)](_0x62d1ad(0x1fb),_0x51c976);throw new common_1[(_0x62d1ad(0x1cf))](_0x62d1ad(0x1b4),common_1[_0x62d1ad(0x22a)][_0x62d1ad(0x204)]);}}async['verifyPhoneIdentity'](_0x578755,_0x2f3202){const _0x28eb3d=_0x151065;common_1[_0x28eb3d(0x1a1)][_0x28eb3d(0x20a)]('开始手机号认证流程');const {phone:_0x53a71e,username:_0x4084a0,password:_0x42c03c,code:_0x224b45}=_0x2f3202,{id:_0x1deda5}=_0x578755[_0x28eb3d(0x1bc)],_0x2ecacc=this['globalConfigService'][_0x28eb3d(0x1db)](),_0x5a8ecb=_0x2ecacc+_0x28eb3d(0x1a0)+_0x53a71e,_0x81de38=await this[_0x28eb3d(0x1e8)]['get']({'key':_0x5a8ecb});common_1['Logger'][_0x28eb3d(0x20a)](_0x28eb3d(0x213)+_0x53a71e+':\x20'+_0x81de38);if(_0x224b45==='')throw new common_1[(_0x28eb3d(0x1cf))](_0x28eb3d(0x225),common_1[_0x28eb3d(0x22a)][_0x28eb3d(0x204)]);if(!_0x81de38){common_1[_0x28eb3d(0x1a1)][_0x28eb3d(0x1bd)](_0x28eb3d(0x222)+_0x53a71e,_0x28eb3d(0x1b0));throw new common_1[(_0x28eb3d(0x1cf))]('验证码已过期，请重新发送！',common_1[_0x28eb3d(0x22a)][_0x28eb3d(0x204)]);}if(_0x224b45!==_0x81de38){common_1[_0x28eb3d(0x1a1)][_0x28eb3d(0x1bd)](_0x28eb3d(0x1be)+_0x53a71e+'\x20输入的验证码:\x20'+_0x224b45+_0x28eb3d(0x1aa)+_0x81de38,_0x28eb3d(0x1b0));throw new common_1[(_0x28eb3d(0x1cf))](_0x28eb3d(0x1f1),common_1[_0x28eb3d(0x22a)]['BAD_REQUEST']);}if(_0x4084a0){const _0x2c8808=await this[_0x28eb3d(0x1c7)][_0x28eb3d(0x21f)](_0x2f3202[_0x28eb3d(0x1fd)],_0x1deda5);if(_0x2c8808)throw new common_1[(_0x28eb3d(0x1cf))]('用户名已存在！',common_1[_0x28eb3d(0x22a)][_0x28eb3d(0x204)]);}try{return await this['userService'][_0x28eb3d(0x1de)](_0x1deda5,_0x53a71e,_0x4084a0,_0x42c03c),_0x28eb3d(0x20e);}catch(_0x372aa4){common_1[_0x28eb3d(0x1a1)][_0x28eb3d(0x1bb)](_0x28eb3d(0x1fb),_0x372aa4);throw new common_1[(_0x28eb3d(0x1cf))]('身份验证错误，请检查相关信息',common_1[_0x28eb3d(0x22a)]['BAD_REQUEST']);}}};AuthService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x151065(0x1cb)])(config_entity_1['ConfigEntity'])),__metadata(_0x151065(0x22c),[typeorm_2['Repository'],user_service_1[_0x151065(0x21c)],jwt_1[_0x151065(0x1ba)],mailer_service_1[_0x151065(0x1c3)],verification_service_1[_0x151065(0x212)],userBalance_service_1[_0x151065(0x1ab)],redisCache_service_1[_0x151065(0x1fe)],globalConfig_service_1[_0x151065(0x1fc)]])],AuthService),exports['AuthService']=AuthService;