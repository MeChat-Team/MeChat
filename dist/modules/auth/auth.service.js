'use strict';const _0xbce238=_0x4fb0;(function(_0x17daf8,_0x13fc92){const _0x5d61cb=_0x4fb0,_0x3e7331=_0x17daf8();while(!![]){try{const _0x1172b1=-parseInt(_0x5d61cb(0x13f))/0x1+-parseInt(_0x5d61cb(0xeb))/0x2*(-parseInt(_0x5d61cb(0x12a))/0x3)+-parseInt(_0x5d61cb(0x150))/0x4*(parseInt(_0x5d61cb(0x142))/0x5)+-parseInt(_0x5d61cb(0x116))/0x6*(-parseInt(_0x5d61cb(0xbe))/0x7)+parseInt(_0x5d61cb(0xc3))/0x8*(parseInt(_0x5d61cb(0xee))/0x9)+-parseInt(_0x5d61cb(0xec))/0xa*(-parseInt(_0x5d61cb(0xe2))/0xb)+parseInt(_0x5d61cb(0xf3))/0xc*(-parseInt(_0x5d61cb(0x152))/0xd);if(_0x1172b1===_0x13fc92)break;else _0x3e7331['push'](_0x3e7331['shift']());}catch(_0x206b03){_0x3e7331['push'](_0x3e7331['shift']());}}}(_0x2d44,0xa3948));function _0x4fb0(_0xa1c3a0,_0x14aad0){const _0x2d4400=_0x2d44();return _0x4fb0=function(_0x4fb012,_0x4dbdbe){_0x4fb012=_0x4fb012-0xb8;let _0xbf7f7c=_0x2d4400[_0x4fb012];return _0xbf7f7c;},_0x4fb0(_0xa1c3a0,_0x14aad0);}function _0x2d44(){const _0x35a90a=['UserBalanceService','JwtService','getConfigs','verifyUserRegister','redisCacheService','\x20is\x20available:\x20','design:paramtypes','HttpStatus','保存登录IP:\x20','@nestjs/common','__decorate','loginWithCaptcha','function','getIp','internal','验证码错误:\x20','5435472FvBMHS','bcryptjs','forEach','metadata','HttpException','8jhmWRm','请提供有效的邮箱地址或手机号码。','../../common/constants/user.constant','length','mailerService','开始实名认证流程','updateUserPhone','saveRealNameInfo','实名认证结果:\x20','获取默认用户头像...','address','createTokenFromFingerprint','验证码填写错误，请重新输入！','UserStatusEnum',',\x20isPhone:\x20','password','NOT_FOUND','GlobalConfigService','register','getOwnPropertyDescriptor','ConfigEntity','visitor','Retrieved\x20redisCode\x20for\x20','验证码已过期，请重新发送！','验证码发送成功、请填写验证码完成','getClientIp','noVerifyRegister','sign','InjectRepository','sendMail','\x20-\x20用户ID:\x20','41987vJXDgY','@aiweb.com','验证码过期:\x20','isUsernameTaken','\x20输入的验证码:\x20','../globalConfig/config.entity','密码修改成功','log','createUser','30uwQViQ','770PVwsSM','__metadata','7686153ddlIbm','globalConfigService','身份验证错误，请检查相关信息','user','Logger','135516GaiyuH','ipAddress','用户不存在，请先注册！','verifyIdentity','verificationService','object','../redisCache/redisCache.service','error','@nestjs/jwt','status','开始手机号认证流程','AuthService','createRandomCode','jwtService','ttl','savaLoginIp','networkInterfaces','__param','@visitor.com','BAD_REQUEST','注册成功','configEntity','../mailer/mailer.service','Email\x20','认证失败，请检查相关信息',':RATE_LIMIT:','defineProperty','get','UserService','sendCode','getNamespace','saveToken','该手机号已注册，请直接登录！','loginByOpenId','VerificationService','6WBJwch','__esModule','用户名已存在！','../user/user.service','登录失败，用户凭证无效。','验证过程出现错误','UNAUTHORIZED','authService','login','Repository','Contact:\x20','verifyPhoneIdentity','用户凭证验证成功，用户ID:\x20','登录失败:\x20用户凭证无效\x20-\x20用户名:\x20','avatar','verifyUserCredentials','createRandomUid','noVerifyRegister:\x20','该邮箱未注册，请先注册！','JWT令牌生成成功\x20-\x20用户ID:\x20','238806hEfSFR','ACTIVE',':CODE:','请输入验证码','认证成功',',\x20用户名:\x20','Checking\x20if\x20username\x20','decorate','del','身份验证错误，请检查实名信息','RedisCacheService',',\x20isEmail:\x20','test','开始用户登录流程，用户名:\x20','Phone\x20','userService','加密用户密码...','验证码错误，请重新输入！','MailerService','该手机号未注册，请先注册！','hashSync','248468OtqBow','sendPhoneCode','../../common/utils','65ixLSMm','UserStatusErrMsg','getInfo','username','IPv4','debug','127.0.0.1','addBalanceToNewUser','当前邮箱已注册，请勿重复注册！','../globalConfig/globalConfig.service','userBalanceService','\x20is\x20taken:\x20','typeorm',',\x20期望的验证码:\x20','221716SHQLRP','onModuleInit','1703xvfsPz','令牌已保存到Redis\x20-\x20用户ID:\x20','./../verification/verification.service','该邮箱已注册，请直接登录！'];_0x2d44=function(){return _0x35a90a;};return _0x2d44();}var __decorate=this&&this[_0xbce238(0xb8)]||function(_0x1e0eb3,_0xdb1498,_0x31270d,_0x154e61){const _0x59a8bd=_0xbce238;var _0x1d20bf=arguments['length'],_0x3aef92=_0x1d20bf<0x3?_0xdb1498:_0x154e61===null?_0x154e61=Object[_0x59a8bd(0xd6)](_0xdb1498,_0x31270d):_0x154e61,_0xcb34cd;if(typeof Reflect===_0x59a8bd(0xf8)&&typeof Reflect[_0x59a8bd(0x131)]===_0x59a8bd(0xba))_0x3aef92=Reflect['decorate'](_0x1e0eb3,_0xdb1498,_0x31270d,_0x154e61);else{for(var _0x5a813f=_0x1e0eb3[_0x59a8bd(0xc6)]-0x1;_0x5a813f>=0x0;_0x5a813f--)if(_0xcb34cd=_0x1e0eb3[_0x5a813f])_0x3aef92=(_0x1d20bf<0x3?_0xcb34cd(_0x3aef92):_0x1d20bf>0x3?_0xcb34cd(_0xdb1498,_0x31270d,_0x3aef92):_0xcb34cd(_0xdb1498,_0x31270d))||_0x3aef92;}return _0x1d20bf>0x3&&_0x3aef92&&Object[_0x59a8bd(0x10d)](_0xdb1498,_0x31270d,_0x3aef92),_0x3aef92;},__metadata=this&&this[_0xbce238(0xed)]||function(_0x561727,_0x6b1d5a){const _0x289a7c=_0xbce238;if(typeof Reflect===_0x289a7c(0xf8)&&typeof Reflect[_0x289a7c(0xc1)]===_0x289a7c(0xba))return Reflect['metadata'](_0x561727,_0x6b1d5a);},__param=this&&this[_0xbce238(0x104)]||function(_0x58745d,_0x86efd1){return function(_0x25b6ff,_0x381b56){_0x86efd1(_0x25b6ff,_0x381b56,_0x58745d);};};Object[_0xbce238(0x10d)](exports,_0xbce238(0x117),{'value':!![]}),exports[_0xbce238(0xfe)]=void 0x0;const user_constant_1=require(_0xbce238(0xc5)),utils_1=require(_0xbce238(0x141)),globalConfig_service_1=require(_0xbce238(0x14b)),common_1=require(_0xbce238(0x15f)),jwt_1=require(_0xbce238(0xfb)),typeorm_1=require('@nestjs/typeorm'),bcrypt=require(_0xbce238(0xbf)),os=require('os'),typeorm_2=require(_0xbce238(0x14e)),config_entity_1=require(_0xbce238(0xe7)),mailer_service_1=require(_0xbce238(0x109)),redisCache_service_1=require(_0xbce238(0xf9)),user_service_1=require(_0xbce238(0x119)),userBalance_service_1=require('../userBalance/userBalance.service'),verification_service_1=require(_0xbce238(0x154));let AuthService=class AuthService{constructor(_0x4c3c68,_0x49e40d,_0xcca6ba,_0x36df2b,_0x119103,_0x2e2510,_0xa0bdb4,_0x47ef44){const _0x46e69a=_0xbce238;this[_0x46e69a(0x108)]=_0x4c3c68,this[_0x46e69a(0x139)]=_0x49e40d,this[_0x46e69a(0x100)]=_0xcca6ba,this['mailerService']=_0x36df2b,this[_0x46e69a(0xf7)]=_0x119103,this[_0x46e69a(0x14c)]=_0x2e2510,this['redisCacheService']=_0xa0bdb4,this[_0x46e69a(0xef)]=_0x47ef44;}async[_0xbce238(0x151)](){this['getIp']();}async[_0xbce238(0xd5)](_0x16b49b,_0x34c831){const _0x2c99d2=_0xbce238,{password:_0x1c7536,contact:_0x590dca,code:_0x328b22}=_0x16b49b;let _0x50ed6d='',_0x2e5da6='';const _0x4fbfc4=/\S+@\S+\.\S+/[_0x2c99d2(0x136)](_0x590dca),_0x44688b=/^\d{10,}$/['test'](_0x590dca);common_1[_0x2c99d2(0xf2)][_0x2c99d2(0x147)](_0x2c99d2(0x120)+_0x590dca+_0x2c99d2(0x135)+_0x4fbfc4+_0x2c99d2(0xd1)+_0x44688b);let _0x33a4c1=(0x0,utils_1[_0x2c99d2(0x126)])();while(!![]){const _0x388d54=await this['userService'][_0x2c99d2(0x159)]({'username':_0x33a4c1});common_1[_0x2c99d2(0xf2)][_0x2c99d2(0x147)](_0x2c99d2(0x130)+_0x33a4c1+_0x2c99d2(0x14d)+_0x388d54);if(_0x388d54)break;_0x33a4c1=(0x0,utils_1[_0x2c99d2(0x126)])();}if(_0x4fbfc4){_0x50ed6d=_0x590dca;const _0xa76ad7=await this['userService'][_0x2c99d2(0x159)]({'username':_0x33a4c1,'email':_0x50ed6d});common_1[_0x2c99d2(0xf2)][_0x2c99d2(0x147)](_0x2c99d2(0x10a)+_0x50ed6d+_0x2c99d2(0x15b)+_0xa76ad7);if(!_0xa76ad7)throw new common_1[(_0x2c99d2(0xc2))](_0x2c99d2(0x14a),common_1[_0x2c99d2(0x15d)]['BAD_REQUEST']);}else{if(_0x44688b){_0x2e5da6=_0x590dca;const _0x19e311=await this[_0x2c99d2(0x139)][_0x2c99d2(0x159)]({'username':_0x33a4c1,'phone':_0x2e5da6});common_1[_0x2c99d2(0xf2)]['debug'](_0x2c99d2(0x138)+_0x2e5da6+'\x20is\x20available:\x20'+_0x19e311);if(!_0x19e311)throw new common_1[(_0x2c99d2(0xc2))]('当前手机号已注册，请勿重复注册！',common_1[_0x2c99d2(0x15d)][_0x2c99d2(0x106)]);}else throw new common_1['HttpException'](_0x2c99d2(0xc4),common_1[_0x2c99d2(0x15d)]['BAD_REQUEST']);}const _0x53b526=await this[_0x2c99d2(0xef)]['getConfigs']([_0x2c99d2(0xdd)]);common_1[_0x2c99d2(0xf2)][_0x2c99d2(0x147)](_0x2c99d2(0x127)+_0x53b526);if(_0x53b526!=='1'){const _0x479c48=await this['globalConfigService'][_0x2c99d2(0x111)](),_0x2caebf=_0x479c48+_0x2c99d2(0x12c)+_0x590dca,_0x74b58b=await this['redisCacheService'][_0x2c99d2(0x10e)]({'key':_0x2caebf});common_1['Logger']['debug'](_0x2c99d2(0xd9)+_0x590dca+':\x20'+_0x74b58b);if(_0x328b22==='')throw new common_1[(_0x2c99d2(0xc2))](_0x2c99d2(0x12d),common_1['HttpStatus']['BAD_REQUEST']);if(!_0x74b58b){common_1['Logger'][_0x2c99d2(0xe9)]('验证码过期:\x20'+_0x590dca,_0x2c99d2(0x11d));throw new common_1[(_0x2c99d2(0xc2))](_0x2c99d2(0xda),common_1[_0x2c99d2(0x15d)]['BAD_REQUEST']);}if(_0x328b22!==_0x74b58b){common_1[_0x2c99d2(0xf2)][_0x2c99d2(0xe9)]('验证码错误:\x20'+_0x590dca+_0x2c99d2(0xe6)+_0x328b22+',\x20期望的验证码:\x20'+_0x74b58b,_0x2c99d2(0x11d));throw new common_1[(_0x2c99d2(0xc2))](_0x2c99d2(0xcf),common_1[_0x2c99d2(0x15d)]['BAD_REQUEST']);}}let _0x4e7935;if(_0x4fbfc4)_0x4e7935={'username':_0x33a4c1,'password':_0x1c7536,'email':_0x590dca,'status':user_constant_1[_0x2c99d2(0xd0)][_0x2c99d2(0x12b)]};else{const _0x5c6f00=(0x0,utils_1[_0x2c99d2(0x126)])()+_0x2c99d2(0xe3);_0x4e7935={'username':_0x33a4c1,'password':_0x1c7536,'email':_0x5c6f00,'phone':_0x590dca,'status':user_constant_1[_0x2c99d2(0xd0)]['ACTIVE']};}common_1['Logger'][_0x2c99d2(0x147)](_0x2c99d2(0xcc));const _0x133f71=await this[_0x2c99d2(0xef)][_0x2c99d2(0x158)](['userDefautlAvatar']);common_1[_0x2c99d2(0xf2)]['debug']('使用默认用户头像:\x20'+_0x133f71),_0x4e7935[_0x2c99d2(0x124)]=_0x133f71,common_1[_0x2c99d2(0xf2)]['debug'](_0x2c99d2(0x13a));const _0x21a4f7=bcrypt[_0x2c99d2(0x13e)](_0x1c7536,0xa);_0x4e7935[_0x2c99d2(0xd2)]=_0x21a4f7,common_1[_0x2c99d2(0xf2)][_0x2c99d2(0x147)]('保存新用户到数据库...');const _0x3d59c6=await this[_0x2c99d2(0x139)][_0x2c99d2(0xea)](_0x4e7935);return common_1['Logger'][_0x2c99d2(0x147)]('用户创建成功，用户ID:\x20'+_0x3d59c6['id']),await this[_0x2c99d2(0x14c)][_0x2c99d2(0x149)](_0x3d59c6['id']),common_1[_0x2c99d2(0xf2)][_0x2c99d2(0x147)]('完成新用户余额处理'),{'success':!![],'message':_0x2c99d2(0x107)};}async[_0xbce238(0x11e)](_0xfa1ab7,_0x153301){const _0x3bd536=_0xbce238;console[_0x3bd536(0xe9)](_0x3bd536(0x137)+_0xfa1ab7['username']);const _0x311eb2=await this['userService'][_0x3bd536(0x125)](_0xfa1ab7);if(!_0x311eb2){console['error'](_0x3bd536(0x123)+_0xfa1ab7[_0x3bd536(0x145)]);throw new common_1[(_0x3bd536(0xc2))](_0x3bd536(0x11a),common_1[_0x3bd536(0x15d)][_0x3bd536(0x11c)]);}const {username:_0x38eb4a,id:_0x52b932,email:_0x27771a,role:_0x590a1c,openId:_0x2dd0c0,client:_0x7f405d,phone:_0x369cf2}=_0x311eb2;console['log'](_0x3bd536(0x122)+_0x52b932+_0x3bd536(0x12f)+_0x38eb4a);const _0x2bd384=(0x0,utils_1[_0x3bd536(0xdc)])(_0x153301);await this[_0x3bd536(0x139)][_0x3bd536(0x102)](_0x52b932,_0x2bd384),console[_0x3bd536(0xe9)](_0x3bd536(0x15e)+_0x2bd384+_0x3bd536(0xe1)+_0x52b932);const _0xaddba8=await this['jwtService'][_0x3bd536(0xde)]({'username':_0x38eb4a,'id':_0x52b932,'email':_0x27771a,'role':_0x590a1c,'openId':_0x2dd0c0,'client':_0x7f405d,'phone':_0x369cf2});return console['log'](_0x3bd536(0x129)+_0x52b932),await this[_0x3bd536(0x15a)]['saveToken'](_0x52b932,_0xaddba8),console[_0x3bd536(0xe9)](_0x3bd536(0x153)+_0x52b932),_0xaddba8;}async[_0xbce238(0xb9)](_0x5520b7,_0x2212e0){const _0x3e7705=_0xbce238,{contact:_0x25006b,code:_0x5daeed}=_0x5520b7;let _0x1c1053='',_0x298fed='';const _0x516b97=/\S+@\S+\.\S+/[_0x3e7705(0x136)](_0x25006b),_0x433ed7=/^\d{10,}$/[_0x3e7705(0x136)](_0x25006b);if(_0x516b97)_0x1c1053=_0x25006b;else{if(_0x433ed7)_0x298fed=_0x25006b;else throw new common_1[(_0x3e7705(0xc2))](_0x3e7705(0xc4),common_1['HttpStatus']['BAD_REQUEST']);}if(!![]){if(_0x516b97){const _0x24b666=await this['userService']['verifyUserRegister']({'email':_0x25006b});if(_0x24b666)throw new common_1[(_0x3e7705(0xc2))]('该邮箱未注册，请先注册！',common_1[_0x3e7705(0x15d)][_0x3e7705(0x106)]);}else{if(_0x433ed7){const _0x5be1ca=await this[_0x3e7705(0x139)][_0x3e7705(0x159)]({'phone':_0x25006b});if(_0x5be1ca)throw new common_1['HttpException'](_0x3e7705(0x13d),common_1[_0x3e7705(0x15d)][_0x3e7705(0x106)]);}}}else{if(_0x516b97){const _0x2ff54f=await this[_0x3e7705(0x139)][_0x3e7705(0x159)]({'email':_0x25006b});if(!_0x2ff54f)throw new common_1[(_0x3e7705(0xc2))](_0x3e7705(0x155),common_1['HttpStatus'][_0x3e7705(0x106)]);}else{if(_0x433ed7){const _0x467adf=await this['userService'][_0x3e7705(0x159)]({'phone':_0x25006b});if(!_0x467adf)throw new common_1[(_0x3e7705(0xc2))](_0x3e7705(0x113),common_1[_0x3e7705(0x15d)][_0x3e7705(0x106)]);}}}const _0x28789d=await this[_0x3e7705(0xef)][_0x3e7705(0x111)](),_0xb79ce8=_0x28789d+_0x3e7705(0x12c)+_0x25006b,_0x3ed38c=await this[_0x3e7705(0x15a)][_0x3e7705(0x10e)]({'key':_0xb79ce8});if(!_0x3ed38c){common_1['Logger'][_0x3e7705(0xe9)](_0x3e7705(0xe4)+_0x25006b,'authService');throw new common_1[(_0x3e7705(0xc2))]('验证码已过期，请重新发送！',common_1[_0x3e7705(0x15d)]['BAD_REQUEST']);}if(_0x3ed38c!==_0x5daeed){common_1[_0x3e7705(0xf2)][_0x3e7705(0xe9)]('验证码错误:\x20'+_0x25006b,_0x3e7705(0x11d));throw new common_1['HttpException'](_0x3e7705(0x13b),common_1[_0x3e7705(0x15d)]['BAD_REQUEST']);}const _0xb7c049=await this[_0x3e7705(0x139)]['getUserByContact']({'email':_0x1c1053,'phone':_0x298fed});if(!_0xb7c049)throw new common_1[(_0x3e7705(0xc2))](_0x3e7705(0xf5),common_1['HttpStatus'][_0x3e7705(0xd3)]);if(_0xb7c049['status']!==user_constant_1[_0x3e7705(0xd0)]['ACTIVE'])throw new common_1['HttpException'](user_constant_1[_0x3e7705(0x143)][_0xb7c049[_0x3e7705(0xfc)]],common_1[_0x3e7705(0x15d)][_0x3e7705(0x106)]);const {username:_0x2d8308,id:_0x591c2b,role:_0x388dc0,openId:_0x1ed15a,client:_0x3aea0b}=_0xb7c049,_0x5b6dc0=(0x0,utils_1[_0x3e7705(0xdc)])(_0x2212e0);await this[_0x3e7705(0x139)][_0x3e7705(0x102)](_0x591c2b,_0x5b6dc0);const _0x2611c0=await this['jwtService'][_0x3e7705(0xde)]({'username':_0x2d8308,'id':_0x591c2b,'email':_0x1c1053,'role':_0x388dc0,'openId':_0x1ed15a,'client':_0x3aea0b,'phone':_0x298fed});return await this[_0x3e7705(0x15a)][_0x3e7705(0x112)](_0x591c2b,_0x2611c0),await this['redisCacheService'][_0x3e7705(0x132)](_0xb79ce8),_0x2611c0;}async[_0xbce238(0x114)](_0x28890a,_0x53ef71){const _0x22a962=_0xbce238,{status:_0x568731}=_0x28890a;if(_0x568731!==user_constant_1[_0x22a962(0xd0)]['ACTIVE'])throw new common_1[(_0x22a962(0xc2))](user_constant_1[_0x22a962(0x143)][_0x568731],common_1[_0x22a962(0x15d)][_0x22a962(0x106)]);const {username:_0x933344,id:_0xf78eb6,email:_0x1b4fc7,role:_0x21f299,openId:_0x1f25a0,client:_0x130395}=_0x28890a,_0x2426f5=(0x0,utils_1[_0x22a962(0xdc)])(_0x53ef71);await this['userService']['savaLoginIp'](_0xf78eb6,_0x2426f5);const _0x269e5d=await this['jwtService'][_0x22a962(0xde)]({'username':_0x933344,'id':_0xf78eb6,'email':_0x1b4fc7,'role':_0x21f299,'openId':_0x1f25a0,'client':_0x130395});return await this[_0x22a962(0x15a)][_0x22a962(0x112)](_0xf78eb6,_0x269e5d),_0x269e5d;}async[_0xbce238(0x144)](_0xae3c9c){const _0x57f11b=_0xbce238,{id:_0x4f2efe}=_0xae3c9c[_0x57f11b(0xf1)];return await this['userService']['getUserInfo'](_0x4f2efe);}async['updatePassword'](_0xd6b07c,_0x307fae){const _0x4db0bd=_0xbce238,{id:_0x3dab28}=_0xd6b07c['user'];return this[_0x4db0bd(0x139)]['updateUserPassword'](_0x3dab28,_0x307fae['password']),_0x4db0bd(0xe8);}[_0xbce238(0xbb)](){const _0xae6a38=_0xbce238;let _0x4aaff5;const _0x4fabb3=os[_0xae6a38(0x103)]();Object['keys'](_0x4fabb3)[_0xae6a38(0xc0)](_0x236123=>{const _0x6490f8=_0xae6a38,_0x490071=_0x4fabb3[_0x236123];for(let _0x3d5dbc=0x0;_0x3d5dbc<_0x490071[_0x6490f8(0xc6)];_0x3d5dbc++){const _0x85e838=_0x490071[_0x3d5dbc];if(_0x85e838['family']===_0x6490f8(0x146)&&_0x85e838[_0x6490f8(0xcd)]!==_0x6490f8(0x148)&&!_0x85e838[_0x6490f8(0xbc)]){_0x4aaff5=_0x85e838['address'];break;}}}),this[_0xae6a38(0xf4)]=_0x4aaff5;}async[_0xbce238(0x110)](_0x9b4c4){const _0xd0e366=_0xbce238,{contact:_0xb0cae5,isLogin:_0x511c6e}=_0x9b4c4,_0x1583b8=(0x0,utils_1[_0xd0e366(0xff)])(),_0x171706=/\S+@\S+\.\S+/[_0xd0e366(0x136)](_0xb0cae5),_0x41eb0e=/^1\d{10}$/[_0xd0e366(0x136)](_0xb0cae5);if(!_0x171706&&!_0x41eb0e)throw new common_1[(_0xd0e366(0xc2))]('请提供有效的邮箱地址或手机号码。',common_1[_0xd0e366(0x15d)]['BAD_REQUEST']);if(_0x511c6e){if(_0x171706){const _0x227091=await this[_0xd0e366(0x139)][_0xd0e366(0x159)]({'email':_0xb0cae5});if(_0x227091)throw new common_1[(_0xd0e366(0xc2))](_0xd0e366(0x128),common_1[_0xd0e366(0x15d)][_0xd0e366(0x106)]);}else{if(_0x41eb0e){const _0x13bd5b=await this[_0xd0e366(0x139)][_0xd0e366(0x159)]({'phone':_0xb0cae5});if(_0x13bd5b)throw new common_1[(_0xd0e366(0xc2))](_0xd0e366(0x13d),common_1[_0xd0e366(0x15d)][_0xd0e366(0x106)]);}}}else{if(_0x171706){const _0x484be9=await this[_0xd0e366(0x139)]['verifyUserRegister']({'email':_0xb0cae5});if(!_0x484be9)throw new common_1[(_0xd0e366(0xc2))](_0xd0e366(0x155),common_1['HttpStatus'][_0xd0e366(0x106)]);}else{if(_0x41eb0e){const _0x107b63=await this[_0xd0e366(0x139)][_0xd0e366(0x159)]({'phone':_0xb0cae5});if(!_0x107b63)throw new common_1[(_0xd0e366(0xc2))]('该手机号已注册，请直接登录！',common_1[_0xd0e366(0x15d)][_0xd0e366(0x106)]);}}}const _0xa1bb4b=await this[_0xd0e366(0xef)][_0xd0e366(0x111)](),_0x10ce8c=_0xa1bb4b+_0xd0e366(0x12c)+_0xb0cae5,_0x310ec8=_0xa1bb4b+_0xd0e366(0x10c)+_0xb0cae5,_0x464f4f=await this['redisCacheService'][_0xd0e366(0x101)](_0x10ce8c);if(_0x464f4f&&_0x464f4f>0x0)throw new common_1[(_0xd0e366(0xc2))](_0x464f4f+'秒内不得重复发送验证码！',common_1[_0xd0e366(0x15d)][_0xd0e366(0x106)]);const _0x23b246=await this[_0xd0e366(0x15a)][_0xd0e366(0x10e)]({'key':_0x310ec8})||0x0;if(_0x23b246>=0xa)throw new common_1[(_0xd0e366(0xc2))]('今日发送验证码次数已达上限，请24小时后再试！',common_1[_0xd0e366(0x15d)]['TOO_MANY_REQUESTS']);if(_0x171706)await this[_0xd0e366(0xc7)][_0xd0e366(0xe0)]({'to':_0xb0cae5,'context':{'code':_0x1583b8}});else{if(_0x41eb0e){const _0x98a9ed={'phone':_0xb0cae5,'code':_0x1583b8};await this[_0xd0e366(0xf7)][_0xd0e366(0x140)](_0x98a9ed);}}return await this['redisCacheService']['set']({'key':_0x10ce8c,'val':_0x1583b8},0x5*0x3c),await this[_0xd0e366(0x15a)]['set']({'key':_0x310ec8,'val':Number(_0x23b246)+0x1},0x18*0x3c*0x3c),await this['redisCacheService']['set']({'key':_0x10ce8c,'val':_0x1583b8},0x3c),_0xd0e366(0xdb)+(_0x511c6e?'注册':'验证')+'！';}[_0xbce238(0xce)](_0x5c3b32){const _0x5a717d=_0xbce238,_0x53e61c=this[_0x5a717d(0x100)][_0x5a717d(0xde)]({'username':'游客'+_0x5c3b32,'id':_0x5c3b32,'email':_0x5c3b32+_0x5a717d(0x105),'role':_0x5a717d(0xd8),'openId':null,'client':null});return _0x53e61c;}async[_0xbce238(0xf6)](_0x3f5c63,_0xea8e4f){const _0x4717e8=_0xbce238;common_1[_0x4717e8(0xf2)][_0x4717e8(0x147)](_0x4717e8(0xc8));const {name:_0x3217f5,idCard:_0x2a281a}=_0xea8e4f,{id:_0x62c532}=_0x3f5c63[_0x4717e8(0xf1)];try{const _0x5e9acb=await this[_0x4717e8(0xf7)][_0x4717e8(0xf6)](_0xea8e4f);common_1[_0x4717e8(0xf2)][_0x4717e8(0x147)](_0x4717e8(0xcb)+_0x5e9acb);if(!_0x5e9acb)throw new common_1[(_0x4717e8(0xc2))](_0x4717e8(0x133),common_1[_0x4717e8(0x15d)]['BAD_REQUEST']);return await this[_0x4717e8(0x139)][_0x4717e8(0xca)](_0x62c532,_0x3217f5,_0x2a281a),_0x4717e8(0x12e);}catch(_0x586cd5){common_1[_0x4717e8(0xf2)]['error'](_0x4717e8(0x11b),_0x586cd5);throw new common_1[(_0x4717e8(0xc2))](_0x4717e8(0x10b),common_1[_0x4717e8(0x15d)]['BAD_REQUEST']);}}async[_0xbce238(0x121)](_0x1f59e3,_0x37f2bd){const _0x37df51=_0xbce238;common_1[_0x37df51(0xf2)][_0x37df51(0x147)](_0x37df51(0xfd));const {phone:_0x491f58,username:_0x2dfad7,password:_0x4483a9,code:_0x4a9d59}=_0x37f2bd,{id:_0x4c0c02}=_0x1f59e3[_0x37df51(0xf1)],_0x3b867c=this[_0x37df51(0xef)][_0x37df51(0x111)](),_0x515683=_0x3b867c+_0x37df51(0x12c)+_0x491f58,_0x272ba3=await this[_0x37df51(0x15a)]['get']({'key':_0x515683});common_1[_0x37df51(0xf2)]['debug'](_0x37df51(0xd9)+_0x491f58+':\x20'+_0x272ba3);if(_0x4a9d59==='')throw new common_1[(_0x37df51(0xc2))](_0x37df51(0x12d),common_1[_0x37df51(0x15d)][_0x37df51(0x106)]);if(!_0x272ba3){common_1[_0x37df51(0xf2)][_0x37df51(0xe9)]('验证码过期:\x20'+_0x491f58,_0x37df51(0x11d));throw new common_1['HttpException'](_0x37df51(0xda),common_1[_0x37df51(0x15d)][_0x37df51(0x106)]);}if(_0x4a9d59!==_0x272ba3){common_1[_0x37df51(0xf2)][_0x37df51(0xe9)](_0x37df51(0xbd)+_0x491f58+'\x20输入的验证码:\x20'+_0x4a9d59+_0x37df51(0x14f)+_0x272ba3,_0x37df51(0x11d));throw new common_1['HttpException']('验证码填写错误，请重新输入！',common_1[_0x37df51(0x15d)][_0x37df51(0x106)]);}if(_0x2dfad7){const _0x127fcd=await this['userService'][_0x37df51(0xe5)](_0x37f2bd[_0x37df51(0x145)],_0x4c0c02);if(_0x127fcd)throw new common_1[(_0x37df51(0xc2))](_0x37df51(0x118),common_1[_0x37df51(0x15d)]['BAD_REQUEST']);}try{return await this[_0x37df51(0x139)][_0x37df51(0xc9)](_0x4c0c02,_0x491f58,_0x2dfad7,_0x4483a9),_0x37df51(0x12e);}catch(_0x5b141e){common_1[_0x37df51(0xf2)][_0x37df51(0xfa)]('验证过程出现错误',_0x5b141e);throw new common_1['HttpException'](_0x37df51(0xf0),common_1['HttpStatus'][_0x37df51(0x106)]);}}};AuthService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0xbce238(0xdf)])(config_entity_1[_0xbce238(0xd7)])),__metadata(_0xbce238(0x15c),[typeorm_2[_0xbce238(0x11f)],user_service_1[_0xbce238(0x10f)],jwt_1[_0xbce238(0x157)],mailer_service_1[_0xbce238(0x13c)],verification_service_1[_0xbce238(0x115)],userBalance_service_1[_0xbce238(0x156)],redisCache_service_1[_0xbce238(0x134)],globalConfig_service_1[_0xbce238(0xd4)]])],AuthService),exports['AuthService']=AuthService;