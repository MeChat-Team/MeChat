'use strict';const _0xebc8ec=_0x29e4;(function(_0x138b81,_0x276d97){const _0x4f06f2=_0x29e4,_0x4b2c74=_0x138b81();while(!![]){try{const _0x23b001=parseInt(_0x4f06f2(0xe0))/0x1+-parseInt(_0x4f06f2(0x84))/0x2*(-parseInt(_0x4f06f2(0xb7))/0x3)+parseInt(_0x4f06f2(0x94))/0x4+parseInt(_0x4f06f2(0xab))/0x5+-parseInt(_0x4f06f2(0xdf))/0x6+-parseInt(_0x4f06f2(0x9d))/0x7*(-parseInt(_0x4f06f2(0xf9))/0x8)+-parseInt(_0x4f06f2(0x110))/0x9;if(_0x23b001===_0x276d97)break;else _0x4b2c74['push'](_0x4b2c74['shift']());}catch(_0x4ae141){_0x4b2c74['push'](_0x4b2c74['shift']());}}}(_0x4d29,0x7afa2));function _0x29e4(_0x30bb31,_0x373e6c){const _0x4d296b=_0x4d29();return _0x29e4=function(_0x29e41d,_0x4c9750){_0x29e41d=_0x29e41d-0x80;let _0x4e3361=_0x4d296b[_0x29e41d];return _0x4e3361;},_0x29e4(_0x30bb31,_0x373e6c);}function _0x4d29(){const _0x49d20d=[',\x20isEmail:\x20','getOwnPropertyDescriptor','password','set','HttpStatus','__decorate','register','UserStatusErrMsg','status','开始手机号认证流程','typeorm','getUserInfo','Checking\x20if\x20username\x20',',\x20期望的验证码:\x20','InjectRepository','秒内不得重复发送验证码！','../../common/utils','test','Logger','9138969NAlEEL','getClientIp','saveRealNameInfo','该手机号已注册，请直接登录！','error','Repository','GlobalConfigService','@aiweb.com',':RATE_LIMIT:','该手机号未注册，请先注册！','verifyUserRegister','getInfo','userBalanceService','保存新用户到数据库...','noVerifyRegister:\x20','验证过程出现错误','2cbqqUY',':CODE:','getIp','请提供有效的邮箱地址或手机号码。','令牌已保存到Redis\x20-\x20用户ID:\x20','密码修改成功','注册成功','Contact:\x20','../userBalance/userBalance.service','family','HttpException','sign','userService','userDefautlAvatar','metadata','__param','3855584eOOukH','function','user','TOO_MANY_REQUESTS','updateUserPassword','verifyUserCredentials','身份验证错误，请检查相关信息','./../verification/verification.service','jwtService','172529doLTYc','验证码发送成功、请填写验证码完成','加密用户密码...','../mailer/mailer.service','get','object','authService','认证失败，请检查相关信息','savaLoginIp','design:paramtypes','../user/user.service','ACTIVE','addBalanceToNewUser','onModuleInit','1603110QbmTcv','完成新用户余额处理','验证码过期:\x20','ConfigEntity','__metadata','length','用户创建成功，用户ID:\x20',',\x20isPhone:\x20','globalConfigService','../globalConfig/config.entity','\x20is\x20available:\x20','isUsernameTaken','1409118DdKQhM','getNamespace','RedisCacheService','verifyIdentity','address','BAD_REQUEST','visitor','用户凭证验证成功，用户ID:\x20','验证码已过期，请重新发送！','开始实名认证流程','Phone\x20','username','sendCode','AuthService','updateUserPhone','UserService','redisCacheService','MailerService','实名认证结果:\x20','该邮箱已注册，请直接登录！','defineProperty','createUser','\x20输入的验证码:\x20','sendMail','createRandomUid','loginByOpenId','saveToken','../globalConfig/globalConfig.service','avatar','使用默认用户头像:\x20','用户名已存在！','getUserByContact','ipAddress','internal','forEach','log','debug','verificationService','获取默认用户头像...','当前邮箱已注册，请勿重复注册！','3993126Unmlhr','356511IalvFo','\x20is\x20taken:\x20','认证成功','验证码错误:\x20','loginWithCaptcha','Retrieved\x20redisCode\x20for\x20','updatePassword','NOT_FOUND','该邮箱未注册，请先注册！','VerificationService','开始用户登录流程，用户名:\x20','configEntity','del','verifyPhoneIdentity','今日发送验证码次数已达上限，请24小时后再试！','当前手机号已注册，请勿重复注册！','@visitor.com','getConfigs','IPv4','\x20-\x20用户ID:\x20','UserStatusEnum','bcryptjs','登录失败，用户凭证无效。','请输入验证码','登录失败:\x20用户凭证无效\x20-\x20用户名:\x20','24aodvwA','mailerService','../redisCache/redisCache.service','@nestjs/typeorm'];_0x4d29=function(){return _0x49d20d;};return _0x4d29();}var __decorate=this&&this[_0xebc8ec(0x102)]||function(_0x43e77b,_0x14c6ad,_0x55ee59,_0x19c63f){const _0x24535d=_0xebc8ec;var _0x5f5c43=arguments[_0x24535d(0xb0)],_0x3ee3fa=_0x5f5c43<0x3?_0x14c6ad:_0x19c63f===null?_0x19c63f=Object[_0x24535d(0xfe)](_0x14c6ad,_0x55ee59):_0x19c63f,_0x365c7d;if(typeof Reflect===_0x24535d(0xa2)&&typeof Reflect['decorate']===_0x24535d(0x95))_0x3ee3fa=Reflect['decorate'](_0x43e77b,_0x14c6ad,_0x55ee59,_0x19c63f);else{for(var _0x53b371=_0x43e77b[_0x24535d(0xb0)]-0x1;_0x53b371>=0x0;_0x53b371--)if(_0x365c7d=_0x43e77b[_0x53b371])_0x3ee3fa=(_0x5f5c43<0x3?_0x365c7d(_0x3ee3fa):_0x5f5c43>0x3?_0x365c7d(_0x14c6ad,_0x55ee59,_0x3ee3fa):_0x365c7d(_0x14c6ad,_0x55ee59))||_0x3ee3fa;}return _0x5f5c43>0x3&&_0x3ee3fa&&Object[_0x24535d(0xcb)](_0x14c6ad,_0x55ee59,_0x3ee3fa),_0x3ee3fa;},__metadata=this&&this[_0xebc8ec(0xaf)]||function(_0x24b264,_0x2f278e){const _0x4eaf5b=_0xebc8ec;if(typeof Reflect===_0x4eaf5b(0xa2)&&typeof Reflect[_0x4eaf5b(0x92)]===_0x4eaf5b(0x95))return Reflect[_0x4eaf5b(0x92)](_0x24b264,_0x2f278e);},__param=this&&this[_0xebc8ec(0x93)]||function(_0x1aacef,_0x181588){return function(_0xfda48a,_0x4a2cd2){_0x181588(_0xfda48a,_0x4a2cd2,_0x1aacef);};};Object[_0xebc8ec(0xcb)](exports,'__esModule',{'value':!![]}),exports[_0xebc8ec(0xc4)]=void 0x0;const user_constant_1=require('../../common/constants/user.constant'),utils_1=require(_0xebc8ec(0x10d)),globalConfig_service_1=require(_0xebc8ec(0xd2)),common_1=require('@nestjs/common'),jwt_1=require('@nestjs/jwt'),typeorm_1=require(_0xebc8ec(0xfc)),bcrypt=require(_0xebc8ec(0xf5)),os=require('os'),typeorm_2=require(_0xebc8ec(0x107)),config_entity_1=require(_0xebc8ec(0xb4)),mailer_service_1=require(_0xebc8ec(0xa0)),redisCache_service_1=require(_0xebc8ec(0xfb)),user_service_1=require(_0xebc8ec(0xa7)),userBalance_service_1=require(_0xebc8ec(0x8c)),verification_service_1=require(_0xebc8ec(0x9b));let AuthService=class AuthService{constructor(_0x21cf37,_0x18f8b8,_0x924ca5,_0x495f63,_0x40a412,_0x585b6d,_0xba2fcb,_0x40d0a7){const _0x290629=_0xebc8ec;this[_0x290629(0xeb)]=_0x21cf37,this[_0x290629(0x90)]=_0x18f8b8,this[_0x290629(0x9c)]=_0x924ca5,this[_0x290629(0xfa)]=_0x495f63,this['verificationService']=_0x40a412,this[_0x290629(0x80)]=_0x585b6d,this[_0x290629(0xc7)]=_0xba2fcb,this[_0x290629(0xb3)]=_0x40d0a7;}async[_0xebc8ec(0xaa)](){const _0x4f70bd=_0xebc8ec;this[_0x4f70bd(0x86)]();}async[_0xebc8ec(0x103)](_0x23d653,_0x38a238){const _0x40ad80=_0xebc8ec,{password:_0x129a2d,contact:_0x27b9f4,code:_0x22ee20}=_0x23d653;let _0x24f18b='',_0xf76bca='';const _0x180ba6=/\S+@\S+\.\S+/[_0x40ad80(0x10e)](_0x27b9f4),_0x2acbc1=/^\d{10,}$/[_0x40ad80(0x10e)](_0x27b9f4);common_1['Logger'][_0x40ad80(0xdb)](_0x40ad80(0x8b)+_0x27b9f4+_0x40ad80(0xfd)+_0x180ba6+_0x40ad80(0xb2)+_0x2acbc1);let _0xcd5e0=(0x0,utils_1[_0x40ad80(0xcf)])();while(!![]){const _0x3ca834=await this[_0x40ad80(0x90)][_0x40ad80(0x11a)]({'username':_0xcd5e0});common_1[_0x40ad80(0x10f)][_0x40ad80(0xdb)](_0x40ad80(0x109)+_0xcd5e0+_0x40ad80(0xe1)+_0x3ca834);if(_0x3ca834)break;_0xcd5e0=(0x0,utils_1[_0x40ad80(0xcf)])();}if(_0x180ba6){_0x24f18b=_0x27b9f4;const _0x34ebd2=await this[_0x40ad80(0x90)][_0x40ad80(0x11a)]({'username':_0xcd5e0,'email':_0x24f18b});common_1['Logger']['debug']('Email\x20'+_0x24f18b+_0x40ad80(0xb5)+_0x34ebd2);if(!_0x34ebd2)throw new common_1[(_0x40ad80(0x8e))](_0x40ad80(0xde),common_1[_0x40ad80(0x101)]['BAD_REQUEST']);}else{if(_0x2acbc1){_0xf76bca=_0x27b9f4;const _0x19b5b9=await this[_0x40ad80(0x90)]['verifyUserRegister']({'username':_0xcd5e0,'phone':_0xf76bca});common_1[_0x40ad80(0x10f)][_0x40ad80(0xdb)](_0x40ad80(0xc1)+_0xf76bca+'\x20is\x20available:\x20'+_0x19b5b9);if(!_0x19b5b9)throw new common_1[(_0x40ad80(0x8e))](_0x40ad80(0xef),common_1[_0x40ad80(0x101)]['BAD_REQUEST']);}else throw new common_1[(_0x40ad80(0x8e))](_0x40ad80(0x87),common_1[_0x40ad80(0x101)][_0x40ad80(0xbc)]);}const _0x21a93f=await this[_0x40ad80(0xb3)][_0x40ad80(0xf1)](['noVerifyRegister']);common_1[_0x40ad80(0x10f)][_0x40ad80(0xdb)](_0x40ad80(0x82)+_0x21a93f);if(_0x21a93f!=='1'){const _0x5c7e9a=await this['globalConfigService']['getNamespace'](),_0xca2f07=_0x5c7e9a+_0x40ad80(0x85)+_0x27b9f4,_0x4aaace=await this[_0x40ad80(0xc7)][_0x40ad80(0xa1)]({'key':_0xca2f07});common_1[_0x40ad80(0x10f)][_0x40ad80(0xdb)](_0x40ad80(0xe5)+_0x27b9f4+':\x20'+_0x4aaace);if(_0x22ee20==='')throw new common_1[(_0x40ad80(0x8e))](_0x40ad80(0xf7),common_1[_0x40ad80(0x101)]['BAD_REQUEST']);if(!_0x4aaace){common_1['Logger']['log']('验证码过期:\x20'+_0x27b9f4,_0x40ad80(0xa3));throw new common_1[(_0x40ad80(0x8e))]('验证码已过期，请重新发送！',common_1[_0x40ad80(0x101)][_0x40ad80(0xbc)]);}if(_0x22ee20!==_0x4aaace){common_1[_0x40ad80(0x10f)]['log'](_0x40ad80(0xe3)+_0x27b9f4+_0x40ad80(0xcd)+_0x22ee20+_0x40ad80(0x10a)+_0x4aaace,_0x40ad80(0xa3));throw new common_1['HttpException']('验证码填写错误，请重新输入！',common_1['HttpStatus'][_0x40ad80(0xbc)]);}}let _0x3f4325;if(_0x180ba6)_0x3f4325={'username':_0xcd5e0,'password':_0x129a2d,'email':_0x27b9f4,'status':user_constant_1[_0x40ad80(0xf4)][_0x40ad80(0xa8)]};else{const _0x123624=(0x0,utils_1[_0x40ad80(0xcf)])()+_0x40ad80(0x117);_0x3f4325={'username':_0xcd5e0,'password':_0x129a2d,'email':_0x123624,'phone':_0x27b9f4,'status':user_constant_1['UserStatusEnum'][_0x40ad80(0xa8)]};}common_1[_0x40ad80(0x10f)][_0x40ad80(0xdb)](_0x40ad80(0xdd));const _0x14307a=await this[_0x40ad80(0xb3)][_0x40ad80(0xf1)]([_0x40ad80(0x91)]);common_1['Logger'][_0x40ad80(0xdb)](_0x40ad80(0xd4)+_0x14307a),_0x3f4325[_0x40ad80(0xd3)]=_0x14307a,common_1[_0x40ad80(0x10f)][_0x40ad80(0xdb)](_0x40ad80(0x9f));const _0xac3ce7=bcrypt['hashSync'](_0x129a2d,0xa);_0x3f4325[_0x40ad80(0xff)]=_0xac3ce7,common_1['Logger'][_0x40ad80(0xdb)](_0x40ad80(0x81));const _0x4dccbd=await this[_0x40ad80(0x90)][_0x40ad80(0xcc)](_0x3f4325);return common_1[_0x40ad80(0x10f)]['debug'](_0x40ad80(0xb1)+_0x4dccbd['id']),await this[_0x40ad80(0x80)][_0x40ad80(0xa9)](_0x4dccbd['id']),common_1[_0x40ad80(0x10f)][_0x40ad80(0xdb)](_0x40ad80(0xac)),{'success':!![],'message':_0x40ad80(0x8a)};}async['login'](_0x55d37f,_0x20abc3){const _0x1ea862=_0xebc8ec;console['log'](_0x1ea862(0xea)+_0x55d37f['username']);const _0x3f6236=await this[_0x1ea862(0x90)][_0x1ea862(0x99)](_0x55d37f);if(!_0x3f6236){console[_0x1ea862(0x114)](_0x1ea862(0xf8)+_0x55d37f[_0x1ea862(0xc2)]);throw new common_1[(_0x1ea862(0x8e))](_0x1ea862(0xf6),common_1[_0x1ea862(0x101)]['UNAUTHORIZED']);}const {username:_0x39b7bc,id:_0x298878,email:_0x48a7bc,role:_0x17d4e3,openId:_0x246b67,client:_0x49adf2,phone:_0x17843a}=_0x3f6236;console[_0x1ea862(0xda)](_0x1ea862(0xbe)+_0x298878+',\x20用户名:\x20'+_0x39b7bc);const _0x26be98=(0x0,utils_1[_0x1ea862(0x111)])(_0x20abc3);await this[_0x1ea862(0x90)][_0x1ea862(0xa5)](_0x298878,_0x26be98),console[_0x1ea862(0xda)]('保存登录IP:\x20'+_0x26be98+_0x1ea862(0xf3)+_0x298878);const _0x318f45=await this[_0x1ea862(0x9c)]['sign']({'username':_0x39b7bc,'id':_0x298878,'email':_0x48a7bc,'role':_0x17d4e3,'openId':_0x246b67,'client':_0x49adf2,'phone':_0x17843a});return console[_0x1ea862(0xda)]('JWT令牌生成成功\x20-\x20用户ID:\x20'+_0x298878),await this[_0x1ea862(0xc7)]['saveToken'](_0x298878,_0x318f45),console['log'](_0x1ea862(0x88)+_0x298878),_0x318f45;}async[_0xebc8ec(0xe4)](_0x239dd1,_0x11b2dd){const _0x3ca921=_0xebc8ec,{contact:_0x5eadde,code:_0x9fc9b8}=_0x239dd1;let _0x497277='',_0x4206e1='';const _0x1184ca=/\S+@\S+\.\S+/[_0x3ca921(0x10e)](_0x5eadde),_0x82daa9=/^\d{10,}$/[_0x3ca921(0x10e)](_0x5eadde);if(_0x1184ca)_0x497277=_0x5eadde;else{if(_0x82daa9)_0x4206e1=_0x5eadde;else throw new common_1[(_0x3ca921(0x8e))](_0x3ca921(0x87),common_1[_0x3ca921(0x101)]['BAD_REQUEST']);}if(!![]){if(_0x1184ca){const _0x5446c2=await this[_0x3ca921(0x90)][_0x3ca921(0x11a)]({'email':_0x5eadde});if(_0x5446c2)throw new common_1['HttpException'](_0x3ca921(0xe8),common_1[_0x3ca921(0x101)][_0x3ca921(0xbc)]);}else{if(_0x82daa9){const _0x505946=await this[_0x3ca921(0x90)][_0x3ca921(0x11a)]({'phone':_0x5eadde});if(_0x505946)throw new common_1['HttpException'](_0x3ca921(0x119),common_1['HttpStatus'][_0x3ca921(0xbc)]);}}}else{if(_0x1184ca){const _0x1b082b=await this['userService'][_0x3ca921(0x11a)]({'email':_0x5eadde});if(!_0x1b082b)throw new common_1[(_0x3ca921(0x8e))](_0x3ca921(0xca),common_1[_0x3ca921(0x101)][_0x3ca921(0xbc)]);}else{if(_0x82daa9){const _0x5ef834=await this[_0x3ca921(0x90)][_0x3ca921(0x11a)]({'phone':_0x5eadde});if(!_0x5ef834)throw new common_1[(_0x3ca921(0x8e))](_0x3ca921(0x113),common_1[_0x3ca921(0x101)][_0x3ca921(0xbc)]);}}}const _0x477b0d=await this[_0x3ca921(0xb3)][_0x3ca921(0xb8)](),_0xdb91c3=_0x477b0d+_0x3ca921(0x85)+_0x5eadde,_0x359574=await this[_0x3ca921(0xc7)][_0x3ca921(0xa1)]({'key':_0xdb91c3});if(!_0x359574){common_1[_0x3ca921(0x10f)]['log'](_0x3ca921(0xad)+_0x5eadde,_0x3ca921(0xa3));throw new common_1['HttpException']('验证码已过期，请重新发送！',common_1[_0x3ca921(0x101)][_0x3ca921(0xbc)]);}if(_0x359574!==_0x9fc9b8){common_1[_0x3ca921(0x10f)]['log']('验证码错误:\x20'+_0x5eadde,_0x3ca921(0xa3));throw new common_1[(_0x3ca921(0x8e))]('验证码错误，请重新输入！',common_1[_0x3ca921(0x101)][_0x3ca921(0xbc)]);}const _0x1d62e1=await this[_0x3ca921(0x90)][_0x3ca921(0xd6)]({'email':_0x497277,'phone':_0x4206e1});if(!_0x1d62e1)throw new common_1[(_0x3ca921(0x8e))]('用户不存在，请先注册！',common_1['HttpStatus'][_0x3ca921(0xe7)]);if(_0x1d62e1[_0x3ca921(0x105)]!==user_constant_1['UserStatusEnum'][_0x3ca921(0xa8)])throw new common_1[(_0x3ca921(0x8e))](user_constant_1['UserStatusErrMsg'][_0x1d62e1['status']],common_1[_0x3ca921(0x101)][_0x3ca921(0xbc)]);const {username:_0x270794,id:_0x116414,role:_0x854e56,openId:_0x323979,client:_0x3f0933}=_0x1d62e1,_0x14c072=(0x0,utils_1[_0x3ca921(0x111)])(_0x11b2dd);await this[_0x3ca921(0x90)]['savaLoginIp'](_0x116414,_0x14c072);const _0x276a1a=await this[_0x3ca921(0x9c)][_0x3ca921(0x8f)]({'username':_0x270794,'id':_0x116414,'email':_0x497277,'role':_0x854e56,'openId':_0x323979,'client':_0x3f0933,'phone':_0x4206e1});return await this[_0x3ca921(0xc7)]['saveToken'](_0x116414,_0x276a1a),await this[_0x3ca921(0xc7)][_0x3ca921(0xec)](_0xdb91c3),_0x276a1a;}async[_0xebc8ec(0xd0)](_0x12e048,_0x174da8){const _0x5debba=_0xebc8ec,{status:_0x2ca093}=_0x12e048;if(_0x2ca093!==user_constant_1[_0x5debba(0xf4)][_0x5debba(0xa8)])throw new common_1[(_0x5debba(0x8e))](user_constant_1[_0x5debba(0x104)][_0x2ca093],common_1[_0x5debba(0x101)][_0x5debba(0xbc)]);const {username:_0x272cb8,id:_0x3448f5,email:_0x568931,role:_0x199549,openId:_0x51d57d,client:_0x44b011}=_0x12e048,_0x32b040=(0x0,utils_1[_0x5debba(0x111)])(_0x174da8);await this['userService'][_0x5debba(0xa5)](_0x3448f5,_0x32b040);const _0x9aac72=await this[_0x5debba(0x9c)][_0x5debba(0x8f)]({'username':_0x272cb8,'id':_0x3448f5,'email':_0x568931,'role':_0x199549,'openId':_0x51d57d,'client':_0x44b011});return await this[_0x5debba(0xc7)][_0x5debba(0xd1)](_0x3448f5,_0x9aac72),_0x9aac72;}async[_0xebc8ec(0x11b)](_0x414253){const _0x567dff=_0xebc8ec,{id:_0x57bf61}=_0x414253[_0x567dff(0x96)];return await this['userService'][_0x567dff(0x108)](_0x57bf61);}async[_0xebc8ec(0xe6)](_0x3297a5,_0x35c18c){const _0x15d394=_0xebc8ec,{id:_0x206f4f}=_0x3297a5[_0x15d394(0x96)];return this[_0x15d394(0x90)][_0x15d394(0x98)](_0x206f4f,_0x35c18c['password']),_0x15d394(0x89);}[_0xebc8ec(0x86)](){const _0x1b50bc=_0xebc8ec;let _0x2c8a71;const _0x2d341c=os['networkInterfaces']();Object['keys'](_0x2d341c)[_0x1b50bc(0xd9)](_0x4c4779=>{const _0x61f254=_0x1b50bc,_0x5097ed=_0x2d341c[_0x4c4779];for(let _0x11be8e=0x0;_0x11be8e<_0x5097ed[_0x61f254(0xb0)];_0x11be8e++){const _0x40c63e=_0x5097ed[_0x11be8e];if(_0x40c63e[_0x61f254(0x8d)]===_0x61f254(0xf2)&&_0x40c63e[_0x61f254(0xbb)]!=='127.0.0.1'&&!_0x40c63e[_0x61f254(0xd8)]){_0x2c8a71=_0x40c63e['address'];break;}}}),this[_0x1b50bc(0xd7)]=_0x2c8a71;}async[_0xebc8ec(0xc3)](_0xfcfb2a){const _0x3371cf=_0xebc8ec,{contact:_0x55098d,isLogin:_0x51ed1b}=_0xfcfb2a,_0x38707e=(0x0,utils_1['createRandomCode'])(),_0x1309d4=/\S+@\S+\.\S+/['test'](_0x55098d),_0x37759f=/^1\d{10}$/[_0x3371cf(0x10e)](_0x55098d);if(!_0x1309d4&&!_0x37759f)throw new common_1[(_0x3371cf(0x8e))](_0x3371cf(0x87),common_1[_0x3371cf(0x101)][_0x3371cf(0xbc)]);if(_0x51ed1b){if(_0x1309d4){const _0x366b33=await this['userService'][_0x3371cf(0x11a)]({'email':_0x55098d});if(_0x366b33)throw new common_1[(_0x3371cf(0x8e))]('该邮箱未注册，请先注册！',common_1[_0x3371cf(0x101)][_0x3371cf(0xbc)]);}else{if(_0x37759f){const _0x518c71=await this['userService'][_0x3371cf(0x11a)]({'phone':_0x55098d});if(_0x518c71)throw new common_1[(_0x3371cf(0x8e))]('该手机号未注册，请先注册！',common_1[_0x3371cf(0x101)][_0x3371cf(0xbc)]);}}}else{if(_0x1309d4){const _0x549b9a=await this['userService'][_0x3371cf(0x11a)]({'email':_0x55098d});if(!_0x549b9a)throw new common_1[(_0x3371cf(0x8e))](_0x3371cf(0xca),common_1[_0x3371cf(0x101)]['BAD_REQUEST']);}else{if(_0x37759f){const _0x52f782=await this['userService'][_0x3371cf(0x11a)]({'phone':_0x55098d});if(!_0x52f782)throw new common_1[(_0x3371cf(0x8e))](_0x3371cf(0x113),common_1[_0x3371cf(0x101)][_0x3371cf(0xbc)]);}}}const _0x3c5ccf=await this['globalConfigService'][_0x3371cf(0xb8)](),_0x3061bf=_0x3c5ccf+':CODE:'+_0x55098d,_0x168c0d=_0x3c5ccf+_0x3371cf(0x118)+_0x55098d,_0x62b969=await this[_0x3371cf(0xc7)]['ttl'](_0x3061bf);if(_0x62b969&&_0x62b969>0x0)throw new common_1[(_0x3371cf(0x8e))](_0x62b969+_0x3371cf(0x10c),common_1[_0x3371cf(0x101)][_0x3371cf(0xbc)]);const _0x4634e0=await this[_0x3371cf(0xc7)]['get']({'key':_0x168c0d})||0x0;if(_0x4634e0>=0xa)throw new common_1[(_0x3371cf(0x8e))](_0x3371cf(0xee),common_1[_0x3371cf(0x101)][_0x3371cf(0x97)]);if(_0x1309d4)await this[_0x3371cf(0xfa)][_0x3371cf(0xce)]({'to':_0x55098d,'context':{'code':_0x38707e}});else{if(_0x37759f){const _0x14d82e={'phone':_0x55098d,'code':_0x38707e};await this[_0x3371cf(0xdc)]['sendPhoneCode'](_0x14d82e);}}return await this[_0x3371cf(0xc7)][_0x3371cf(0x100)]({'key':_0x3061bf,'val':_0x38707e},0x5*0x3c),await this[_0x3371cf(0xc7)][_0x3371cf(0x100)]({'key':_0x168c0d,'val':Number(_0x4634e0)+0x1},0x18*0x3c*0x3c),await this[_0x3371cf(0xc7)][_0x3371cf(0x100)]({'key':_0x3061bf,'val':_0x38707e},0x3c),_0x3371cf(0x9e)+(_0x51ed1b?'注册':'验证')+'！';}['createTokenFromFingerprint'](_0x1de486){const _0x568db5=_0xebc8ec,_0x535df6=this['jwtService'][_0x568db5(0x8f)]({'username':'游客'+_0x1de486,'id':_0x1de486,'email':_0x1de486+_0x568db5(0xf0),'role':_0x568db5(0xbd),'openId':null,'client':null});return _0x535df6;}async[_0xebc8ec(0xba)](_0x5590b2,_0x489472){const _0x42bbe0=_0xebc8ec;common_1[_0x42bbe0(0x10f)][_0x42bbe0(0xdb)](_0x42bbe0(0xc0));const {name:_0x789450,idCard:_0x2c3db4}=_0x489472,{id:_0x31a3a9}=_0x5590b2[_0x42bbe0(0x96)];try{const _0x59738e=await this[_0x42bbe0(0xdc)][_0x42bbe0(0xba)](_0x489472);common_1['Logger'][_0x42bbe0(0xdb)](_0x42bbe0(0xc9)+_0x59738e);if(!_0x59738e)throw new common_1['HttpException']('身份验证错误，请检查实名信息',common_1[_0x42bbe0(0x101)][_0x42bbe0(0xbc)]);return await this[_0x42bbe0(0x90)][_0x42bbe0(0x112)](_0x31a3a9,_0x789450,_0x2c3db4),_0x42bbe0(0xe2);}catch(_0x523bd3){common_1[_0x42bbe0(0x10f)][_0x42bbe0(0x114)](_0x42bbe0(0x83),_0x523bd3);throw new common_1[(_0x42bbe0(0x8e))](_0x42bbe0(0xa4),common_1['HttpStatus'][_0x42bbe0(0xbc)]);}}async[_0xebc8ec(0xed)](_0x11dabe,_0x100b95){const _0x1e6312=_0xebc8ec;common_1[_0x1e6312(0x10f)][_0x1e6312(0xdb)](_0x1e6312(0x106));const {phone:_0x123d59,username:_0x41fa37,password:_0x32e12f,code:_0x5827aa}=_0x100b95,{id:_0x1a1766}=_0x11dabe[_0x1e6312(0x96)],_0x2215db=this[_0x1e6312(0xb3)]['getNamespace'](),_0x539ed0=_0x2215db+_0x1e6312(0x85)+_0x123d59,_0x17d1e9=await this[_0x1e6312(0xc7)][_0x1e6312(0xa1)]({'key':_0x539ed0});common_1[_0x1e6312(0x10f)][_0x1e6312(0xdb)](_0x1e6312(0xe5)+_0x123d59+':\x20'+_0x17d1e9);if(_0x5827aa==='')throw new common_1['HttpException'](_0x1e6312(0xf7),common_1[_0x1e6312(0x101)][_0x1e6312(0xbc)]);if(!_0x17d1e9){common_1[_0x1e6312(0x10f)]['log'](_0x1e6312(0xad)+_0x123d59,'authService');throw new common_1[(_0x1e6312(0x8e))](_0x1e6312(0xbf),common_1['HttpStatus'][_0x1e6312(0xbc)]);}if(_0x5827aa!==_0x17d1e9){common_1[_0x1e6312(0x10f)]['log'](_0x1e6312(0xe3)+_0x123d59+'\x20输入的验证码:\x20'+_0x5827aa+_0x1e6312(0x10a)+_0x17d1e9,'authService');throw new common_1[(_0x1e6312(0x8e))]('验证码填写错误，请重新输入！',common_1[_0x1e6312(0x101)][_0x1e6312(0xbc)]);}if(_0x41fa37){const _0x285da1=await this[_0x1e6312(0x90)][_0x1e6312(0xb6)](_0x100b95[_0x1e6312(0xc2)],_0x1a1766);if(_0x285da1)throw new common_1[(_0x1e6312(0x8e))](_0x1e6312(0xd5),common_1['HttpStatus'][_0x1e6312(0xbc)]);}try{return await this[_0x1e6312(0x90)][_0x1e6312(0xc5)](_0x1a1766,_0x123d59,_0x41fa37,_0x32e12f),_0x1e6312(0xe2);}catch(_0x5a4510){common_1[_0x1e6312(0x10f)]['error'](_0x1e6312(0x83),_0x5a4510);throw new common_1[(_0x1e6312(0x8e))](_0x1e6312(0x9a),common_1[_0x1e6312(0x101)][_0x1e6312(0xbc)]);}}};AuthService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0xebc8ec(0x10b)])(config_entity_1[_0xebc8ec(0xae)])),__metadata(_0xebc8ec(0xa6),[typeorm_2[_0xebc8ec(0x115)],user_service_1[_0xebc8ec(0xc6)],jwt_1['JwtService'],mailer_service_1[_0xebc8ec(0xc8)],verification_service_1[_0xebc8ec(0xe9)],userBalance_service_1['UserBalanceService'],redisCache_service_1[_0xebc8ec(0xb9)],globalConfig_service_1[_0xebc8ec(0x116)]])],AuthService),exports[_0xebc8ec(0xc4)]=AuthService;