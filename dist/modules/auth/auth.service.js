'use strict';const _0x48d21f=_0x3bba;function _0x23fb(){const _0x24eaf6=['686466KOUMSZ','test','sendPhoneCode','用户凭证验证成功，用户ID:\x20','visitor','addBalanceToNewUser','__metadata','verifyPhoneIdentity','注册成功','object','globalConfigService','Contact:\x20','ttl','updateUserPhone',':CODE:','./../verification/verification.service','Repository','../../common/utils','请输入验证码','register','请提供有效的邮箱地址或手机号码。',',\x20isPhone:\x20','用户名已存在！','\x20输入的验证码:\x20','noVerifyRegister:\x20','../user/user.service','getIp','登录失败，用户凭证无效。','实名认证结果:\x20','typeorm','@aiweb.com','verifyUserRegister','ipAddress','开始用户登录流程，用户名:\x20','loginByOpenId','getUserInfo','Logger','userBalanceService','该邮箱未注册，请先注册！','decorate','RedisCacheService','../userBalance/userBalance.service','BAD_REQUEST','loginWithCaptcha','InjectRepository','验证码过期:\x20','getOwnPropertyDescriptor','\x20-\x20用户ID:\x20','UserStatusErrMsg','authService','updatePassword','getNamespace','该手机号已注册，请直接登录！','Checking\x20if\x20username\x20','function','当前邮箱已注册，请勿重复注册！','该手机号未注册，请先注册！','@nestjs/typeorm','sign','sendMail','bcryptjs','AuthService','__param','user','savaLoginIp',',\x20isEmail:\x20','debug','keys','身份验证错误，请检查相关信息','847btcBKx','490YfoHAI','3520352gUtyeN','令牌已保存到Redis\x20-\x20用户ID:\x20','verifyIdentity','userService','set','获取默认用户头像...','createUser','3ubhGuu',',\x20期望的验证码:\x20','avatar','71304UwCQGg','__esModule','createRandomCode','@visitor.com','updateUserPassword','del','log','getInfo','Retrieved\x20redisCode\x20for\x20','JwtService','getClientIp','defineProperty','JWT令牌生成成功\x20-\x20用户ID:\x20','family','Injectable','jwtService','noVerifyRegister','networkInterfaces','address','GlobalConfigService','userDefautlAvatar','../globalConfig/config.entity','redisCacheService','用户不存在，请先注册！','验证码已过期，请重新发送！','IPv4','HttpStatus','status','验证码错误，请重新输入！','验证码填写错误，请重新输入！','error','开始实名认证流程','494883UJIJoL','../redisCache/redisCache.service','\x20is\x20available:\x20','password','验证码发送成功、请填写验证码完成','UserStatusEnum','hashSync','../../common/constants/user.constant','metadata','@nestjs/common','mailerService','3230675dYogMX','UNAUTHORIZED','saveToken','认证失败，请检查相关信息','保存登录IP:\x20','该邮箱已注册，请直接登录！','认证成功','12534OEIKBi','验证过程出现错误','verifyUserCredentials','sendCode','验证码错误:\x20','design:paramtypes','HttpException','登录失败:\x20用户凭证无效\x20-\x20用户名:\x20','Email\x20','__decorate','UserBalanceService','ACTIVE','get','加密用户密码...','length','configEntity','今日发送验证码次数已达上限，请24小时后再试！','密码修改成功','当前手机号已注册，请勿重复注册！','createRandomUid','开始手机号认证流程','\x20is\x20taken:\x20','forEach','VerificationService','verificationService','username','2531858THphMq','@nestjs/jwt'];_0x23fb=function(){return _0x24eaf6;};return _0x23fb();}(function(_0x4c69cc,_0x102997){const _0x71a235=_0x3bba,_0x1e3690=_0x4c69cc();while(!![]){try{const _0x3ae21e=-parseInt(_0x71a235(0x1b7))/0x1+-parseInt(_0x71a235(0x1e3))/0x2+parseInt(_0x71a235(0x233))/0x3*(-parseInt(_0x71a235(0x22c))/0x4)+-parseInt(_0x71a235(0x1c2))/0x5+parseInt(_0x71a235(0x1c9))/0x6*(parseInt(_0x71a235(0x22a))/0x7)+-parseInt(_0x71a235(0x236))/0x8+-parseInt(_0x71a235(0x1e5))/0x9*(-parseInt(_0x71a235(0x22b))/0xa);if(_0x3ae21e===_0x102997)break;else _0x1e3690['push'](_0x1e3690['shift']());}catch(_0x1f6cd0){_0x1e3690['push'](_0x1e3690['shift']());}}}(_0x23fb,0xa97e7));var __decorate=this&&this[_0x48d21f(0x1d2)]||function(_0x398cc5,_0x4037f3,_0xf377ea,_0x542657){const _0x5c42dc=_0x48d21f;var _0xfc3c7c=arguments[_0x5c42dc(0x1d7)],_0xd9241d=_0xfc3c7c<0x3?_0x4037f3:_0x542657===null?_0x542657=Object[_0x5c42dc(0x213)](_0x4037f3,_0xf377ea):_0x542657,_0x2b494d;if(typeof Reflect===_0x5c42dc(0x1ee)&&typeof Reflect[_0x5c42dc(0x20c)]===_0x5c42dc(0x21b))_0xd9241d=Reflect[_0x5c42dc(0x20c)](_0x398cc5,_0x4037f3,_0xf377ea,_0x542657);else{for(var _0x5ea95c=_0x398cc5[_0x5c42dc(0x1d7)]-0x1;_0x5ea95c>=0x0;_0x5ea95c--)if(_0x2b494d=_0x398cc5[_0x5ea95c])_0xd9241d=(_0xfc3c7c<0x3?_0x2b494d(_0xd9241d):_0xfc3c7c>0x3?_0x2b494d(_0x4037f3,_0xf377ea,_0xd9241d):_0x2b494d(_0x4037f3,_0xf377ea))||_0xd9241d;}return _0xfc3c7c>0x3&&_0xd9241d&&Object[_0x5c42dc(0x241)](_0x4037f3,_0xf377ea,_0xd9241d),_0xd9241d;},__metadata=this&&this[_0x48d21f(0x1eb)]||function(_0x212c60,_0x564fb0){const _0x16bab5=_0x48d21f;if(typeof Reflect===_0x16bab5(0x1ee)&&typeof Reflect[_0x16bab5(0x1bf)]==='function')return Reflect['metadata'](_0x212c60,_0x564fb0);},__param=this&&this[_0x48d21f(0x223)]||function(_0x50baba,_0x38e586){return function(_0xe6848c,_0x58a2e3){_0x38e586(_0xe6848c,_0x58a2e3,_0x50baba);};};Object[_0x48d21f(0x241)](exports,_0x48d21f(0x237),{'value':!![]}),exports[_0x48d21f(0x222)]=void 0x0;function _0x3bba(_0x5d71ee,_0x51a269){const _0x23fb2c=_0x23fb();return _0x3bba=function(_0x3bba35,_0x316329){_0x3bba35=_0x3bba35-0x1ab;let _0x119253=_0x23fb2c[_0x3bba35];return _0x119253;},_0x3bba(_0x5d71ee,_0x51a269);}const user_constant_1=require(_0x48d21f(0x1be)),utils_1=require(_0x48d21f(0x1f6)),globalConfig_service_1=require('../globalConfig/globalConfig.service'),common_1=require(_0x48d21f(0x1c0)),jwt_1=require(_0x48d21f(0x1e4)),typeorm_1=require(_0x48d21f(0x21e)),bcrypt=require(_0x48d21f(0x221)),os=require('os'),typeorm_2=require(_0x48d21f(0x202)),config_entity_1=require(_0x48d21f(0x1ac)),mailer_service_1=require('../mailer/mailer.service'),redisCache_service_1=require(_0x48d21f(0x1b8)),user_service_1=require(_0x48d21f(0x1fe)),userBalance_service_1=require(_0x48d21f(0x20e)),verification_service_1=require(_0x48d21f(0x1f4));let AuthService=class AuthService{constructor(_0x59e4f3,_0x5ef1fc,_0x591eff,_0x357988,_0x47be13,_0x355342,_0x3b3c05,_0x139e49){const _0x30f25a=_0x48d21f;this[_0x30f25a(0x1d8)]=_0x59e4f3,this['userService']=_0x5ef1fc,this[_0x30f25a(0x245)]=_0x591eff,this[_0x30f25a(0x1c1)]=_0x357988,this[_0x30f25a(0x1e1)]=_0x47be13,this[_0x30f25a(0x20a)]=_0x355342,this[_0x30f25a(0x1ad)]=_0x3b3c05,this['globalConfigService']=_0x139e49;}async['onModuleInit'](){const _0x4455b8=_0x48d21f;this[_0x4455b8(0x1ff)]();}async[_0x48d21f(0x1f8)](_0x3683ea,_0x583b42){const _0x261268=_0x48d21f,{password:_0x3e0d64,contact:_0x5095a8,code:_0x1cc8bd}=_0x3683ea;let _0x4efde0='',_0x270675='';const _0x487b2f=/\S+@\S+\.\S+/[_0x261268(0x1e6)](_0x5095a8),_0x46de5a=/^\d{10,}$/['test'](_0x5095a8);common_1[_0x261268(0x209)]['debug'](_0x261268(0x1f0)+_0x5095a8+_0x261268(0x226)+_0x487b2f+_0x261268(0x1fa)+_0x46de5a);let _0x5b3ac6=(0x0,utils_1['createRandomUid'])();while(!![]){const _0x513f5d=await this['userService'][_0x261268(0x204)]({'username':_0x5b3ac6});common_1['Logger'][_0x261268(0x227)](_0x261268(0x21a)+_0x5b3ac6+_0x261268(0x1de)+_0x513f5d);if(_0x513f5d)break;_0x5b3ac6=(0x0,utils_1[_0x261268(0x1dc)])();}if(_0x487b2f){_0x4efde0=_0x5095a8;const _0x25ae82=await this[_0x261268(0x22f)][_0x261268(0x204)]({'username':_0x5b3ac6,'email':_0x4efde0});common_1[_0x261268(0x209)][_0x261268(0x227)](_0x261268(0x1d1)+_0x4efde0+_0x261268(0x1b9)+_0x25ae82);if(!_0x25ae82)throw new common_1[(_0x261268(0x1cf))](_0x261268(0x21c),common_1[_0x261268(0x1b1)][_0x261268(0x20f)]);}else{if(_0x46de5a){_0x270675=_0x5095a8;const _0x493e81=await this[_0x261268(0x22f)][_0x261268(0x204)]({'username':_0x5b3ac6,'phone':_0x270675});common_1['Logger'][_0x261268(0x227)]('Phone\x20'+_0x270675+_0x261268(0x1b9)+_0x493e81);if(!_0x493e81)throw new common_1[(_0x261268(0x1cf))](_0x261268(0x1db),common_1[_0x261268(0x1b1)]['BAD_REQUEST']);}else throw new common_1[(_0x261268(0x1cf))](_0x261268(0x1f9),common_1[_0x261268(0x1b1)][_0x261268(0x20f)]);}const _0x46e63a=await this[_0x261268(0x1ef)]['getConfigs']([_0x261268(0x246)]);common_1[_0x261268(0x209)]['debug'](_0x261268(0x1fd)+_0x46e63a);if(_0x46e63a!=='1'){const _0x14f899=await this[_0x261268(0x1ef)][_0x261268(0x218)](),_0x5919a4=_0x14f899+':CODE:'+_0x5095a8,_0x198193=await this[_0x261268(0x1ad)][_0x261268(0x1d5)]({'key':_0x5919a4});common_1['Logger']['debug'](_0x261268(0x23e)+_0x5095a8+':\x20'+_0x198193);if(_0x1cc8bd==='')throw new common_1[(_0x261268(0x1cf))]('请输入验证码',common_1[_0x261268(0x1b1)]['BAD_REQUEST']);if(!_0x198193){common_1['Logger'][_0x261268(0x23c)](_0x261268(0x212)+_0x5095a8,'authService');throw new common_1['HttpException'](_0x261268(0x1af),common_1['HttpStatus'][_0x261268(0x20f)]);}if(_0x1cc8bd!==_0x198193){common_1[_0x261268(0x209)]['log'](_0x261268(0x1cd)+_0x5095a8+_0x261268(0x1fc)+_0x1cc8bd+_0x261268(0x234)+_0x198193,_0x261268(0x216));throw new common_1[(_0x261268(0x1cf))](_0x261268(0x1b4),common_1[_0x261268(0x1b1)][_0x261268(0x20f)]);}}let _0x4f3b6d;if(_0x487b2f)_0x4f3b6d={'username':_0x5b3ac6,'password':_0x3e0d64,'email':_0x5095a8,'status':user_constant_1[_0x261268(0x1bc)][_0x261268(0x1d4)]};else{const _0x508b4f=(0x0,utils_1[_0x261268(0x1dc)])()+_0x261268(0x203);_0x4f3b6d={'username':_0x5b3ac6,'password':_0x3e0d64,'email':_0x508b4f,'phone':_0x5095a8,'status':user_constant_1[_0x261268(0x1bc)][_0x261268(0x1d4)]};}common_1[_0x261268(0x209)]['debug'](_0x261268(0x231));const _0x19dff3=await this[_0x261268(0x1ef)]['getConfigs']([_0x261268(0x1ab)]);common_1[_0x261268(0x209)][_0x261268(0x227)]('使用默认用户头像:\x20'+_0x19dff3),_0x4f3b6d[_0x261268(0x235)]=_0x19dff3,common_1[_0x261268(0x209)]['debug'](_0x261268(0x1d6));const _0x336ddb=bcrypt[_0x261268(0x1bd)](_0x3e0d64,0xa);_0x4f3b6d[_0x261268(0x1ba)]=_0x336ddb,common_1[_0x261268(0x209)][_0x261268(0x227)]('保存新用户到数据库...');const _0x80960b=await this['userService'][_0x261268(0x232)](_0x4f3b6d);return common_1[_0x261268(0x209)][_0x261268(0x227)]('用户创建成功，用户ID:\x20'+_0x80960b['id']),await this[_0x261268(0x20a)][_0x261268(0x1ea)](_0x80960b['id']),common_1[_0x261268(0x209)][_0x261268(0x227)]('完成新用户余额处理'),{'success':!![],'message':_0x261268(0x1ed)};}async['login'](_0x5bf695,_0x8649ad){const _0x3e5bba=_0x48d21f;console[_0x3e5bba(0x23c)](_0x3e5bba(0x206)+_0x5bf695[_0x3e5bba(0x1e2)]);const _0x3c27d8=await this['userService'][_0x3e5bba(0x1cb)](_0x5bf695);if(!_0x3c27d8){console[_0x3e5bba(0x1b5)](_0x3e5bba(0x1d0)+_0x5bf695[_0x3e5bba(0x1e2)]);throw new common_1['HttpException'](_0x3e5bba(0x200),common_1[_0x3e5bba(0x1b1)][_0x3e5bba(0x1c3)]);}const {username:_0x4eaafb,id:_0x75e0df,email:_0x51f68d,role:_0x42422a,openId:_0x3c780c,client:_0x3b612b,phone:_0x167d6b}=_0x3c27d8;console[_0x3e5bba(0x23c)](_0x3e5bba(0x1e8)+_0x75e0df+',\x20用户名:\x20'+_0x4eaafb);const _0x5c3115=(0x0,utils_1[_0x3e5bba(0x240)])(_0x8649ad);await this['userService']['savaLoginIp'](_0x75e0df,_0x5c3115),console[_0x3e5bba(0x23c)](_0x3e5bba(0x1c6)+_0x5c3115+_0x3e5bba(0x214)+_0x75e0df);const _0x4502a1=await this[_0x3e5bba(0x245)][_0x3e5bba(0x21f)]({'username':_0x4eaafb,'id':_0x75e0df,'email':_0x51f68d,'role':_0x42422a,'openId':_0x3c780c,'client':_0x3b612b,'phone':_0x167d6b});return console[_0x3e5bba(0x23c)](_0x3e5bba(0x242)+_0x75e0df),await this[_0x3e5bba(0x1ad)][_0x3e5bba(0x1c4)](_0x75e0df,_0x4502a1),console['log'](_0x3e5bba(0x22d)+_0x75e0df),_0x4502a1;}async[_0x48d21f(0x210)](_0x5902c1,_0x14f447){const _0x33f5e7=_0x48d21f,{contact:_0x47fc67,code:_0x403310}=_0x5902c1;let _0x5638f2='',_0x419749='';const _0x22fdba=/\S+@\S+\.\S+/[_0x33f5e7(0x1e6)](_0x47fc67),_0x2785e9=/^\d{10,}$/[_0x33f5e7(0x1e6)](_0x47fc67);if(_0x22fdba)_0x5638f2=_0x47fc67;else{if(_0x2785e9)_0x419749=_0x47fc67;else throw new common_1[(_0x33f5e7(0x1cf))]('请提供有效的邮箱地址或手机号码。',common_1[_0x33f5e7(0x1b1)][_0x33f5e7(0x20f)]);}if(!![]){if(_0x22fdba){const _0x73c296=await this[_0x33f5e7(0x22f)][_0x33f5e7(0x204)]({'email':_0x47fc67});if(_0x73c296)throw new common_1['HttpException'](_0x33f5e7(0x20b),common_1[_0x33f5e7(0x1b1)][_0x33f5e7(0x20f)]);}else{if(_0x2785e9){const _0x36eeec=await this[_0x33f5e7(0x22f)]['verifyUserRegister']({'phone':_0x47fc67});if(_0x36eeec)throw new common_1[(_0x33f5e7(0x1cf))](_0x33f5e7(0x21d),common_1[_0x33f5e7(0x1b1)]['BAD_REQUEST']);}}}else{if(_0x22fdba){const _0x3a68da=await this[_0x33f5e7(0x22f)]['verifyUserRegister']({'email':_0x47fc67});if(!_0x3a68da)throw new common_1[(_0x33f5e7(0x1cf))](_0x33f5e7(0x1c7),common_1['HttpStatus'][_0x33f5e7(0x20f)]);}else{if(_0x2785e9){const _0x3a1add=await this[_0x33f5e7(0x22f)][_0x33f5e7(0x204)]({'phone':_0x47fc67});if(!_0x3a1add)throw new common_1['HttpException'](_0x33f5e7(0x219),common_1[_0x33f5e7(0x1b1)][_0x33f5e7(0x20f)]);}}}const _0x415ac3=await this['globalConfigService'][_0x33f5e7(0x218)](),_0x5cf66d=_0x415ac3+_0x33f5e7(0x1f3)+_0x47fc67,_0x57cd46=await this['redisCacheService'][_0x33f5e7(0x1d5)]({'key':_0x5cf66d});if(!_0x57cd46){common_1[_0x33f5e7(0x209)][_0x33f5e7(0x23c)](_0x33f5e7(0x212)+_0x47fc67,'authService');throw new common_1[(_0x33f5e7(0x1cf))]('验证码已过期，请重新发送！',common_1[_0x33f5e7(0x1b1)][_0x33f5e7(0x20f)]);}if(_0x57cd46!==_0x403310){common_1[_0x33f5e7(0x209)][_0x33f5e7(0x23c)](_0x33f5e7(0x1cd)+_0x47fc67,_0x33f5e7(0x216));throw new common_1[(_0x33f5e7(0x1cf))](_0x33f5e7(0x1b3),common_1[_0x33f5e7(0x1b1)][_0x33f5e7(0x20f)]);}const _0x20d791=await this['userService']['getUserByContact']({'email':_0x5638f2,'phone':_0x419749});if(!_0x20d791)throw new common_1[(_0x33f5e7(0x1cf))](_0x33f5e7(0x1ae),common_1[_0x33f5e7(0x1b1)]['NOT_FOUND']);if(_0x20d791[_0x33f5e7(0x1b2)]!==user_constant_1[_0x33f5e7(0x1bc)]['ACTIVE'])throw new common_1[(_0x33f5e7(0x1cf))](user_constant_1[_0x33f5e7(0x215)][_0x20d791[_0x33f5e7(0x1b2)]],common_1[_0x33f5e7(0x1b1)][_0x33f5e7(0x20f)]);const {username:_0x4cdc9d,id:_0x1c3795,role:_0x3d5256,openId:_0x473d1a,client:_0x34369b}=_0x20d791,_0x2fb2f2=(0x0,utils_1[_0x33f5e7(0x240)])(_0x14f447);await this[_0x33f5e7(0x22f)][_0x33f5e7(0x225)](_0x1c3795,_0x2fb2f2);const _0x588182=await this[_0x33f5e7(0x245)]['sign']({'username':_0x4cdc9d,'id':_0x1c3795,'email':_0x5638f2,'role':_0x3d5256,'openId':_0x473d1a,'client':_0x34369b,'phone':_0x419749});return await this[_0x33f5e7(0x1ad)]['saveToken'](_0x1c3795,_0x588182),await this['redisCacheService'][_0x33f5e7(0x23b)](_0x5cf66d),_0x588182;}async[_0x48d21f(0x207)](_0x53bd90,_0x9c3df5){const _0x50575e=_0x48d21f,{status:_0x2461b2}=_0x53bd90;if(_0x2461b2!==user_constant_1[_0x50575e(0x1bc)][_0x50575e(0x1d4)])throw new common_1[(_0x50575e(0x1cf))](user_constant_1[_0x50575e(0x215)][_0x2461b2],common_1[_0x50575e(0x1b1)][_0x50575e(0x20f)]);const {username:_0x153184,id:_0x24fe90,email:_0x3fd4dd,role:_0x3ed9df,openId:_0x3df2fb,client:_0x13d067}=_0x53bd90,_0x58034b=(0x0,utils_1['getClientIp'])(_0x9c3df5);await this[_0x50575e(0x22f)][_0x50575e(0x225)](_0x24fe90,_0x58034b);const _0x4235cc=await this['jwtService'][_0x50575e(0x21f)]({'username':_0x153184,'id':_0x24fe90,'email':_0x3fd4dd,'role':_0x3ed9df,'openId':_0x3df2fb,'client':_0x13d067});return await this[_0x50575e(0x1ad)]['saveToken'](_0x24fe90,_0x4235cc),_0x4235cc;}async[_0x48d21f(0x23d)](_0x264e95){const _0x4df8b8=_0x48d21f,{id:_0x17a28d}=_0x264e95[_0x4df8b8(0x224)];return await this[_0x4df8b8(0x22f)][_0x4df8b8(0x208)](_0x17a28d);}async[_0x48d21f(0x217)](_0x191915,_0x30cf81){const _0x5df1b0=_0x48d21f,{id:_0x100be0}=_0x191915[_0x5df1b0(0x224)];return this[_0x5df1b0(0x22f)][_0x5df1b0(0x23a)](_0x100be0,_0x30cf81[_0x5df1b0(0x1ba)]),_0x5df1b0(0x1da);}[_0x48d21f(0x1ff)](){const _0x8f1f7f=_0x48d21f;let _0xba3702;const _0x38301e=os[_0x8f1f7f(0x247)]();Object[_0x8f1f7f(0x228)](_0x38301e)[_0x8f1f7f(0x1df)](_0x5a00e1=>{const _0x3a6e78=_0x8f1f7f,_0x185e5b=_0x38301e[_0x5a00e1];for(let _0x1a451f=0x0;_0x1a451f<_0x185e5b[_0x3a6e78(0x1d7)];_0x1a451f++){const _0x365d2f=_0x185e5b[_0x1a451f];if(_0x365d2f[_0x3a6e78(0x243)]===_0x3a6e78(0x1b0)&&_0x365d2f[_0x3a6e78(0x248)]!=='127.0.0.1'&&!_0x365d2f['internal']){_0xba3702=_0x365d2f[_0x3a6e78(0x248)];break;}}}),this[_0x8f1f7f(0x205)]=_0xba3702;}async[_0x48d21f(0x1cc)](_0x44b97c){const _0x2aa647=_0x48d21f,{contact:_0x1f7a03,isLogin:_0xed40c0}=_0x44b97c,_0x30660c=(0x0,utils_1[_0x2aa647(0x238)])(),_0x3ddbd9=/\S+@\S+\.\S+/['test'](_0x1f7a03),_0x3d9509=/^1\d{10}$/[_0x2aa647(0x1e6)](_0x1f7a03);if(!_0x3ddbd9&&!_0x3d9509)throw new common_1[(_0x2aa647(0x1cf))](_0x2aa647(0x1f9),common_1['HttpStatus']['BAD_REQUEST']);if(_0xed40c0){if(_0x3ddbd9){const _0x38a5ff=await this[_0x2aa647(0x22f)]['verifyUserRegister']({'email':_0x1f7a03});if(_0x38a5ff)throw new common_1['HttpException'](_0x2aa647(0x20b),common_1[_0x2aa647(0x1b1)][_0x2aa647(0x20f)]);}else{if(_0x3d9509){const _0x3bae93=await this[_0x2aa647(0x22f)]['verifyUserRegister']({'phone':_0x1f7a03});if(_0x3bae93)throw new common_1[(_0x2aa647(0x1cf))](_0x2aa647(0x21d),common_1[_0x2aa647(0x1b1)][_0x2aa647(0x20f)]);}}}else{if(_0x3ddbd9){const _0x3d71b3=await this[_0x2aa647(0x22f)]['verifyUserRegister']({'email':_0x1f7a03});if(!_0x3d71b3)throw new common_1[(_0x2aa647(0x1cf))]('该邮箱已注册，请直接登录！',common_1[_0x2aa647(0x1b1)][_0x2aa647(0x20f)]);}else{if(_0x3d9509){const _0x3279d2=await this[_0x2aa647(0x22f)]['verifyUserRegister']({'phone':_0x1f7a03});if(!_0x3279d2)throw new common_1[(_0x2aa647(0x1cf))](_0x2aa647(0x219),common_1[_0x2aa647(0x1b1)]['BAD_REQUEST']);}}}const _0x3d5bdd=await this[_0x2aa647(0x1ef)][_0x2aa647(0x218)](),_0x4552c3=_0x3d5bdd+_0x2aa647(0x1f3)+_0x1f7a03,_0x4cf934=_0x3d5bdd+':RATE_LIMIT:'+_0x1f7a03,_0x4be234=await this[_0x2aa647(0x1ad)][_0x2aa647(0x1f1)](_0x4552c3);if(_0x4be234&&_0x4be234>0x0)throw new common_1[(_0x2aa647(0x1cf))](_0x4be234+'秒内不得重复发送验证码！',common_1[_0x2aa647(0x1b1)][_0x2aa647(0x20f)]);const _0x2ba862=await this[_0x2aa647(0x1ad)][_0x2aa647(0x1d5)]({'key':_0x4cf934})||0x0;if(_0x2ba862>=0xa)throw new common_1[(_0x2aa647(0x1cf))](_0x2aa647(0x1d9),common_1[_0x2aa647(0x1b1)]['TOO_MANY_REQUESTS']);if(_0x3ddbd9)await this[_0x2aa647(0x1c1)][_0x2aa647(0x220)]({'to':_0x1f7a03,'context':{'code':_0x30660c}});else{if(_0x3d9509){const _0x2fc9aa={'phone':_0x1f7a03,'code':_0x30660c};await this[_0x2aa647(0x1e1)][_0x2aa647(0x1e7)](_0x2fc9aa);}}return await this['redisCacheService'][_0x2aa647(0x230)]({'key':_0x4552c3,'val':_0x30660c},0x5*0x3c),await this[_0x2aa647(0x1ad)][_0x2aa647(0x230)]({'key':_0x4cf934,'val':Number(_0x2ba862)+0x1},0x18*0x3c*0x3c),await this['redisCacheService'][_0x2aa647(0x230)]({'key':_0x4552c3,'val':_0x30660c},0x3c),_0x2aa647(0x1bb)+(_0xed40c0?'注册':'验证')+'！';}['createTokenFromFingerprint'](_0x17502c){const _0x36aac9=_0x48d21f,_0x2c0418=this['jwtService']['sign']({'username':'游客'+_0x17502c,'id':_0x17502c,'email':_0x17502c+_0x36aac9(0x239),'role':_0x36aac9(0x1e9),'openId':null,'client':null});return _0x2c0418;}async[_0x48d21f(0x22e)](_0x45638e,_0x1d26af){const _0x1cf7be=_0x48d21f;common_1[_0x1cf7be(0x209)][_0x1cf7be(0x227)](_0x1cf7be(0x1b6));const {name:_0x14ccda,idCard:_0x1b0df2}=_0x1d26af,{id:_0xe11c1a}=_0x45638e[_0x1cf7be(0x224)];try{const _0x14d5a3=await this[_0x1cf7be(0x1e1)][_0x1cf7be(0x22e)](_0x1d26af);common_1['Logger'][_0x1cf7be(0x227)](_0x1cf7be(0x201)+_0x14d5a3);if(!_0x14d5a3)throw new common_1[(_0x1cf7be(0x1cf))]('身份验证错误，请检查实名信息',common_1[_0x1cf7be(0x1b1)][_0x1cf7be(0x20f)]);return await this[_0x1cf7be(0x22f)]['saveRealNameInfo'](_0xe11c1a,_0x14ccda,_0x1b0df2),'认证成功';}catch(_0x1d07cb){common_1[_0x1cf7be(0x209)][_0x1cf7be(0x1b5)](_0x1cf7be(0x1ca),_0x1d07cb);throw new common_1[(_0x1cf7be(0x1cf))](_0x1cf7be(0x1c5),common_1[_0x1cf7be(0x1b1)][_0x1cf7be(0x20f)]);}}async[_0x48d21f(0x1ec)](_0x2e546c,_0x67f416){const _0x4bdd6c=_0x48d21f;common_1['Logger'][_0x4bdd6c(0x227)](_0x4bdd6c(0x1dd));const {phone:_0xd547a4,username:_0x36c496,password:_0xfc8cec,code:_0x4ef75b}=_0x67f416,{id:_0x40169c}=_0x2e546c[_0x4bdd6c(0x224)],_0xff1a37=this[_0x4bdd6c(0x1ef)][_0x4bdd6c(0x218)](),_0x4b0d91=_0xff1a37+_0x4bdd6c(0x1f3)+_0xd547a4,_0xe78e98=await this[_0x4bdd6c(0x1ad)][_0x4bdd6c(0x1d5)]({'key':_0x4b0d91});common_1[_0x4bdd6c(0x209)][_0x4bdd6c(0x227)]('Retrieved\x20redisCode\x20for\x20'+_0xd547a4+':\x20'+_0xe78e98);if(_0x4ef75b==='')throw new common_1[(_0x4bdd6c(0x1cf))](_0x4bdd6c(0x1f7),common_1[_0x4bdd6c(0x1b1)]['BAD_REQUEST']);if(!_0xe78e98){common_1[_0x4bdd6c(0x209)][_0x4bdd6c(0x23c)]('验证码过期:\x20'+_0xd547a4,_0x4bdd6c(0x216));throw new common_1[(_0x4bdd6c(0x1cf))](_0x4bdd6c(0x1af),common_1[_0x4bdd6c(0x1b1)][_0x4bdd6c(0x20f)]);}if(_0x4ef75b!==_0xe78e98){common_1[_0x4bdd6c(0x209)][_0x4bdd6c(0x23c)]('验证码错误:\x20'+_0xd547a4+_0x4bdd6c(0x1fc)+_0x4ef75b+_0x4bdd6c(0x234)+_0xe78e98,_0x4bdd6c(0x216));throw new common_1[(_0x4bdd6c(0x1cf))](_0x4bdd6c(0x1b4),common_1[_0x4bdd6c(0x1b1)][_0x4bdd6c(0x20f)]);}if(_0x36c496){const _0x3af9be=await this[_0x4bdd6c(0x22f)]['isUsernameTaken'](_0x67f416['username'],_0x40169c);if(_0x3af9be)throw new common_1[(_0x4bdd6c(0x1cf))](_0x4bdd6c(0x1fb),common_1[_0x4bdd6c(0x1b1)][_0x4bdd6c(0x20f)]);}try{return await this[_0x4bdd6c(0x22f)][_0x4bdd6c(0x1f2)](_0x40169c,_0xd547a4,_0x36c496,_0xfc8cec),_0x4bdd6c(0x1c8);}catch(_0x489997){common_1[_0x4bdd6c(0x209)][_0x4bdd6c(0x1b5)](_0x4bdd6c(0x1ca),_0x489997);throw new common_1[(_0x4bdd6c(0x1cf))](_0x4bdd6c(0x229),common_1[_0x4bdd6c(0x1b1)][_0x4bdd6c(0x20f)]);}}};AuthService=__decorate([(0x0,common_1[_0x48d21f(0x244)])(),__param(0x0,(0x0,typeorm_1[_0x48d21f(0x211)])(config_entity_1['ConfigEntity'])),__metadata(_0x48d21f(0x1ce),[typeorm_2[_0x48d21f(0x1f5)],user_service_1['UserService'],jwt_1[_0x48d21f(0x23f)],mailer_service_1['MailerService'],verification_service_1[_0x48d21f(0x1e0)],userBalance_service_1[_0x48d21f(0x1d3)],redisCache_service_1[_0x48d21f(0x20d)],globalConfig_service_1[_0x48d21f(0x249)]])],AuthService),exports['AuthService']=AuthService;