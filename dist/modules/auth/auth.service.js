'use strict';const _0x334f9a=_0x4818;function _0x9c3e(){const _0x32d75c=['开始用户登录流程，用户名:\x20','verifyUserRegister','ACTIVE','configEntity','Checking\x20if\x20username\x20','userService','@nestjs/common','verifyPhoneIdentity','验证码过期:\x20','@visitor.com','Phone\x20','用户不存在，请先注册！','\x20is\x20taken:\x20','set','getIp','HttpException','username','sendPhoneCode','令牌已保存到Redis\x20-\x20用户ID:\x20','family','metadata','验证码错误:\x20',',\x20isEmail:\x20','../../common/utils','../redisCache/redisCache.service','Repository','@aiweb.com','saveRealNameInfo','verificationService','internal','password','getClientIp','请提供有效的邮箱地址或手机号码。','status','用户凭证验证成功，用户ID:\x20','../../common/constants/user.constant','HttpStatus','updateUserPhone',',\x20用户名:\x20','ttl','认证成功','getUserByContact','verifyIdentity','Injectable','验证码填写错误，请重新输入！','该邮箱已注册，请直接登录！','get','getUserInfo','MailerService','JwtService',':CODE:','../mailer/mailer.service','Logger','实名认证结果:\x20','验证码已过期，请重新发送！','authService','globalConfigService','UNAUTHORIZED','验证过程出现错误','redisCacheService','bcryptjs','请输入验证码','获取默认用户头像...','UserStatusEnum','开始实名认证流程','log','RedisCacheService','defineProperty','Email\x20','login','JWT令牌生成成功\x20-\x20用户ID:\x20','@nestjs/typeorm','createRandomUid','6MDWBvU','认证失败，请检查相关信息','注册成功','7966990MrtNFI','mailerService',',\x20期望的验证码:\x20','GlobalConfigService','address','Retrieved\x20redisCode\x20for\x20','../user/user.service','127.0.0.1','length','392959RIZmNV','createRandomCode','开始手机号认证流程','sign','userBalanceService','function','\x20is\x20available:\x20','loginWithCaptcha','该手机号未注册，请先注册！','保存新用户到数据库...','debug','getOwnPropertyDescriptor','@nestjs/jwt','onModuleInit','验证码发送成功、请填写验证码完成','BAD_REQUEST','该手机号已注册，请直接登录！','当前邮箱已注册，请勿重复注册！','sendCode','createTokenFromFingerprint','8xuigee','noVerifyRegister:\x20','用户创建成功，用户ID:\x20','getNamespace','getConfigs','登录失败:\x20用户凭证无效\x20-\x20用户名:\x20','加密用户密码...','UserService','4216640PfhUXI','VerificationService','583338QoYONO','TOO_MANY_REQUESTS','该邮箱未注册，请先注册！','AuthService','IPv4','savaLoginIp','使用默认用户头像:\x20','UserStatusErrMsg','用户名已存在！','./../verification/verification.service','jwtService','forEach','typeorm','当前手机号已注册，请勿重复注册！','身份验证错误，请检查相关信息','UserBalanceService',',\x20isPhone:\x20','test','decorate','updateUserPassword','saveToken','ipAddress','user','avatar','keys','error','verifyUserCredentials','登录失败，用户凭证无效。','验证码错误，请重新输入！','addBalanceToNewUser','object','密码修改成功','4528287CPrsql','799622UzDnoX','555108WgfTTE','3sCJDAh','design:paramtypes','../globalConfig/config.entity'];_0x9c3e=function(){return _0x32d75c;};return _0x9c3e();}(function(_0x4e57c5,_0x5ef3f4){const _0x12241a=_0x4818,_0x5d43c6=_0x4e57c5();while(!![]){try{const _0x49eced=parseInt(_0x12241a(0x1e1))/0x1+-parseInt(_0x12241a(0x187))/0x2+-parseInt(_0x12241a(0x189))/0x3*(-parseInt(_0x12241a(0x188))/0x4)+parseInt(_0x12241a(0x164))/0x5*(-parseInt(_0x12241a(0x1d5))/0x6)+-parseInt(_0x12241a(0x166))/0x7+-parseInt(_0x12241a(0x1f5))/0x8*(-parseInt(_0x12241a(0x186))/0x9)+parseInt(_0x12241a(0x1d8))/0xa;if(_0x49eced===_0x5ef3f4)break;else _0x5d43c6['push'](_0x5d43c6['shift']());}catch(_0x566696){_0x5d43c6['push'](_0x5d43c6['shift']());}}}(_0x9c3e,0x7b511));var __decorate=this&&this['__decorate']||function(_0x519ae3,_0x278293,_0x25a521,_0x114081){const _0x3790d3=_0x4818;var _0x3a1a3f=arguments['length'],_0x4aacad=_0x3a1a3f<0x3?_0x278293:_0x114081===null?_0x114081=Object[_0x3790d3(0x1ec)](_0x278293,_0x25a521):_0x114081,_0x3a8ad3;if(typeof Reflect===_0x3790d3(0x184)&&typeof Reflect[_0x3790d3(0x178)]==='function')_0x4aacad=Reflect['decorate'](_0x519ae3,_0x278293,_0x25a521,_0x114081);else{for(var _0x244c98=_0x519ae3[_0x3790d3(0x1e0)]-0x1;_0x244c98>=0x0;_0x244c98--)if(_0x3a8ad3=_0x519ae3[_0x244c98])_0x4aacad=(_0x3a1a3f<0x3?_0x3a8ad3(_0x4aacad):_0x3a1a3f>0x3?_0x3a8ad3(_0x278293,_0x25a521,_0x4aacad):_0x3a8ad3(_0x278293,_0x25a521))||_0x4aacad;}return _0x3a1a3f>0x3&&_0x4aacad&&Object['defineProperty'](_0x278293,_0x25a521,_0x4aacad),_0x4aacad;},__metadata=this&&this['__metadata']||function(_0x2ac989,_0x19584a){const _0x1ac7c4=_0x4818;if(typeof Reflect==='object'&&typeof Reflect[_0x1ac7c4(0x1a0)]===_0x1ac7c4(0x1e6))return Reflect['metadata'](_0x2ac989,_0x19584a);},__param=this&&this['__param']||function(_0x4bb8d2,_0x3d4053){return function(_0x2f64be,_0x430453){_0x3d4053(_0x2f64be,_0x430453,_0x4bb8d2);};};Object[_0x334f9a(0x1cf)](exports,'__esModule',{'value':!![]}),exports[_0x334f9a(0x169)]=void 0x0;function _0x4818(_0x5ecd52,_0x406d65){const _0x9c3eb=_0x9c3e();return _0x4818=function(_0x481848,_0x18653d){_0x481848=_0x481848-0x162;let _0x279f1a=_0x9c3eb[_0x481848];return _0x279f1a;},_0x4818(_0x5ecd52,_0x406d65);}const user_constant_1=require(_0x334f9a(0x1af)),utils_1=require(_0x334f9a(0x1a3)),globalConfig_service_1=require('../globalConfig/globalConfig.service'),common_1=require(_0x334f9a(0x192)),jwt_1=require(_0x334f9a(0x1ed)),typeorm_1=require(_0x334f9a(0x1d3)),bcrypt=require(_0x334f9a(0x1c8)),os=require('os'),typeorm_2=require(_0x334f9a(0x172)),config_entity_1=require(_0x334f9a(0x18b)),mailer_service_1=require(_0x334f9a(0x1bf)),redisCache_service_1=require(_0x334f9a(0x1a4)),user_service_1=require(_0x334f9a(0x1de)),userBalance_service_1=require('../userBalance/userBalance.service'),verification_service_1=require(_0x334f9a(0x16f));let AuthService=class AuthService{constructor(_0x240d08,_0x17cea0,_0x19855b,_0x389ac7,_0x551f17,_0x4cf6ce,_0x5e68f0,_0x2ad787){const _0x3b95f4=_0x334f9a;this[_0x3b95f4(0x18f)]=_0x240d08,this[_0x3b95f4(0x191)]=_0x17cea0,this[_0x3b95f4(0x170)]=_0x19855b,this[_0x3b95f4(0x1d9)]=_0x389ac7,this['verificationService']=_0x551f17,this[_0x3b95f4(0x1e5)]=_0x4cf6ce,this['redisCacheService']=_0x5e68f0,this[_0x3b95f4(0x1c4)]=_0x2ad787;}async[_0x334f9a(0x1ee)](){const _0x48d1e9=_0x334f9a;this[_0x48d1e9(0x19a)]();}async['register'](_0x2a63b8,_0x37d2bd){const _0x57d3d6=_0x334f9a,{password:_0x2a7def,contact:_0x4afdcd,code:_0xaee313}=_0x2a63b8;let _0x11d387='',_0x3f3d31='';const _0x37797a=/\S+@\S+\.\S+/['test'](_0x4afdcd),_0x24c8c9=/^\d{10,}$/['test'](_0x4afdcd);common_1['Logger'][_0x57d3d6(0x1eb)]('Contact:\x20'+_0x4afdcd+_0x57d3d6(0x1a2)+_0x37797a+_0x57d3d6(0x176)+_0x24c8c9);let _0x32794c=(0x0,utils_1[_0x57d3d6(0x1d4)])();while(!![]){const _0x4eeb51=await this[_0x57d3d6(0x191)][_0x57d3d6(0x18d)]({'username':_0x32794c});common_1[_0x57d3d6(0x1c0)][_0x57d3d6(0x1eb)](_0x57d3d6(0x190)+_0x32794c+_0x57d3d6(0x198)+_0x4eeb51);if(_0x4eeb51)break;_0x32794c=(0x0,utils_1[_0x57d3d6(0x1d4)])();}if(_0x37797a){_0x11d387=_0x4afdcd;const _0x22c6c2=await this['userService'][_0x57d3d6(0x18d)]({'username':_0x32794c,'email':_0x11d387});common_1[_0x57d3d6(0x1c0)]['debug'](_0x57d3d6(0x1d0)+_0x11d387+_0x57d3d6(0x1e7)+_0x22c6c2);if(!_0x22c6c2)throw new common_1[(_0x57d3d6(0x19b))](_0x57d3d6(0x1f2),common_1[_0x57d3d6(0x1b0)][_0x57d3d6(0x1f0)]);}else{if(_0x24c8c9){_0x3f3d31=_0x4afdcd;const _0x55c43e=await this[_0x57d3d6(0x191)]['verifyUserRegister']({'username':_0x32794c,'phone':_0x3f3d31});common_1[_0x57d3d6(0x1c0)][_0x57d3d6(0x1eb)](_0x57d3d6(0x196)+_0x3f3d31+'\x20is\x20available:\x20'+_0x55c43e);if(!_0x55c43e)throw new common_1[(_0x57d3d6(0x19b))](_0x57d3d6(0x173),common_1[_0x57d3d6(0x1b0)]['BAD_REQUEST']);}else throw new common_1[(_0x57d3d6(0x19b))](_0x57d3d6(0x1ac),common_1['HttpStatus'][_0x57d3d6(0x1f0)]);}const _0x12df1a=await this[_0x57d3d6(0x1c4)][_0x57d3d6(0x1f9)](['noVerifyRegister']);common_1[_0x57d3d6(0x1c0)][_0x57d3d6(0x1eb)](_0x57d3d6(0x1f6)+_0x12df1a);if(_0x12df1a!=='1'){const _0x4381b4=await this[_0x57d3d6(0x1c4)]['getNamespace'](),_0x3ee884=_0x4381b4+_0x57d3d6(0x1be)+_0x4afdcd,_0x2ec94c=await this[_0x57d3d6(0x1c7)][_0x57d3d6(0x1ba)]({'key':_0x3ee884});common_1[_0x57d3d6(0x1c0)]['debug'](_0x57d3d6(0x1dd)+_0x4afdcd+':\x20'+_0x2ec94c);if(_0xaee313==='')throw new common_1[(_0x57d3d6(0x19b))](_0x57d3d6(0x1c9),common_1['HttpStatus'][_0x57d3d6(0x1f0)]);if(!_0x2ec94c){common_1[_0x57d3d6(0x1c0)][_0x57d3d6(0x1cd)]('验证码过期:\x20'+_0x4afdcd,_0x57d3d6(0x1c3));throw new common_1['HttpException'](_0x57d3d6(0x1c2),common_1[_0x57d3d6(0x1b0)][_0x57d3d6(0x1f0)]);}if(_0xaee313!==_0x2ec94c){common_1[_0x57d3d6(0x1c0)][_0x57d3d6(0x1cd)](_0x57d3d6(0x1a1)+_0x4afdcd+'\x20输入的验证码:\x20'+_0xaee313+',\x20期望的验证码:\x20'+_0x2ec94c,_0x57d3d6(0x1c3));throw new common_1['HttpException'](_0x57d3d6(0x1b8),common_1['HttpStatus'][_0x57d3d6(0x1f0)]);}}let _0xda2087;if(_0x37797a)_0xda2087={'username':_0x32794c,'password':_0x2a7def,'email':_0x4afdcd,'status':user_constant_1[_0x57d3d6(0x1cb)][_0x57d3d6(0x18e)]};else{const _0x4a7ddf=(0x0,utils_1['createRandomUid'])()+_0x57d3d6(0x1a6);_0xda2087={'username':_0x32794c,'password':_0x2a7def,'email':_0x4a7ddf,'phone':_0x4afdcd,'status':user_constant_1[_0x57d3d6(0x1cb)][_0x57d3d6(0x18e)]};}common_1['Logger'][_0x57d3d6(0x1eb)](_0x57d3d6(0x1ca));const _0x1b360e=await this[_0x57d3d6(0x1c4)][_0x57d3d6(0x1f9)](['userDefautlAvatar']);common_1[_0x57d3d6(0x1c0)][_0x57d3d6(0x1eb)](_0x57d3d6(0x16c)+_0x1b360e),_0xda2087[_0x57d3d6(0x17d)]=_0x1b360e,common_1[_0x57d3d6(0x1c0)][_0x57d3d6(0x1eb)](_0x57d3d6(0x162));const _0x55c0d0=bcrypt['hashSync'](_0x2a7def,0xa);_0xda2087[_0x57d3d6(0x1aa)]=_0x55c0d0,common_1['Logger'][_0x57d3d6(0x1eb)](_0x57d3d6(0x1ea));const _0x5f3490=await this[_0x57d3d6(0x191)]['createUser'](_0xda2087);return common_1[_0x57d3d6(0x1c0)][_0x57d3d6(0x1eb)](_0x57d3d6(0x1f7)+_0x5f3490['id']),await this[_0x57d3d6(0x1e5)][_0x57d3d6(0x183)](_0x5f3490['id']),common_1[_0x57d3d6(0x1c0)][_0x57d3d6(0x1eb)]('完成新用户余额处理'),{'success':!![],'message':_0x57d3d6(0x1d7)};}async[_0x334f9a(0x1d1)](_0x5955b9,_0x1c5baf){const _0x597159=_0x334f9a;console[_0x597159(0x1cd)](_0x597159(0x18c)+_0x5955b9[_0x597159(0x19c)]);const _0x55122c=await this['userService'][_0x597159(0x180)](_0x5955b9);if(!_0x55122c){console['error'](_0x597159(0x1fa)+_0x5955b9[_0x597159(0x19c)]);throw new common_1[(_0x597159(0x19b))](_0x597159(0x181),common_1['HttpStatus'][_0x597159(0x1c5)]);}const {username:_0x2fa2ed,id:_0x3b4e6c,email:_0x4b694b,role:_0x1dc62f,openId:_0x481455,client:_0x245513,phone:_0xb5016b}=_0x55122c;console[_0x597159(0x1cd)](_0x597159(0x1ae)+_0x3b4e6c+_0x597159(0x1b2)+_0x2fa2ed);const _0x133fc5=(0x0,utils_1[_0x597159(0x1ab)])(_0x1c5baf);await this[_0x597159(0x191)][_0x597159(0x16b)](_0x3b4e6c,_0x133fc5),console[_0x597159(0x1cd)]('保存登录IP:\x20'+_0x133fc5+'\x20-\x20用户ID:\x20'+_0x3b4e6c);const _0x48613e=await this['jwtService'][_0x597159(0x1e4)]({'username':_0x2fa2ed,'id':_0x3b4e6c,'email':_0x4b694b,'role':_0x1dc62f,'openId':_0x481455,'client':_0x245513,'phone':_0xb5016b});return console[_0x597159(0x1cd)](_0x597159(0x1d2)+_0x3b4e6c),await this[_0x597159(0x1c7)][_0x597159(0x17a)](_0x3b4e6c,_0x48613e),console[_0x597159(0x1cd)](_0x597159(0x19e)+_0x3b4e6c),_0x48613e;}async[_0x334f9a(0x1e8)](_0x1941c5,_0x1a4b2f){const _0x54202f=_0x334f9a,{contact:_0x38f75d,code:_0x594bfa}=_0x1941c5;let _0x58f2b3='',_0x10284d='';const _0x4ad0ed=/\S+@\S+\.\S+/[_0x54202f(0x177)](_0x38f75d),_0xa6c80f=/^\d{10,}$/[_0x54202f(0x177)](_0x38f75d);if(_0x4ad0ed)_0x58f2b3=_0x38f75d;else{if(_0xa6c80f)_0x10284d=_0x38f75d;else throw new common_1[(_0x54202f(0x19b))](_0x54202f(0x1ac),common_1[_0x54202f(0x1b0)][_0x54202f(0x1f0)]);}if(!![]){if(_0x4ad0ed){const _0x1522d7=await this[_0x54202f(0x191)][_0x54202f(0x18d)]({'email':_0x38f75d});if(_0x1522d7)throw new common_1[(_0x54202f(0x19b))](_0x54202f(0x168),common_1[_0x54202f(0x1b0)]['BAD_REQUEST']);}else{if(_0xa6c80f){const _0x240492=await this[_0x54202f(0x191)][_0x54202f(0x18d)]({'phone':_0x38f75d});if(_0x240492)throw new common_1[(_0x54202f(0x19b))]('该手机号未注册，请先注册！',common_1[_0x54202f(0x1b0)]['BAD_REQUEST']);}}}else{if(_0x4ad0ed){const _0x12cfe0=await this['userService'][_0x54202f(0x18d)]({'email':_0x38f75d});if(!_0x12cfe0)throw new common_1[(_0x54202f(0x19b))]('该邮箱已注册，请直接登录！',common_1[_0x54202f(0x1b0)][_0x54202f(0x1f0)]);}else{if(_0xa6c80f){const _0x3e7d6e=await this['userService'][_0x54202f(0x18d)]({'phone':_0x38f75d});if(!_0x3e7d6e)throw new common_1['HttpException']('该手机号已注册，请直接登录！',common_1[_0x54202f(0x1b0)][_0x54202f(0x1f0)]);}}}const _0x2f61d1=await this[_0x54202f(0x1c4)][_0x54202f(0x1f8)](),_0x1e79d0=_0x2f61d1+_0x54202f(0x1be)+_0x38f75d,_0x54998e=await this[_0x54202f(0x1c7)][_0x54202f(0x1ba)]({'key':_0x1e79d0});if(!_0x54998e){common_1[_0x54202f(0x1c0)][_0x54202f(0x1cd)](_0x54202f(0x194)+_0x38f75d,'authService');throw new common_1[(_0x54202f(0x19b))]('验证码已过期，请重新发送！',common_1[_0x54202f(0x1b0)][_0x54202f(0x1f0)]);}if(_0x54998e!==_0x594bfa){common_1[_0x54202f(0x1c0)][_0x54202f(0x1cd)](_0x54202f(0x1a1)+_0x38f75d,_0x54202f(0x1c3));throw new common_1['HttpException'](_0x54202f(0x182),common_1[_0x54202f(0x1b0)]['BAD_REQUEST']);}const _0x172325=await this[_0x54202f(0x191)][_0x54202f(0x1b5)]({'email':_0x58f2b3,'phone':_0x10284d});if(!_0x172325)throw new common_1[(_0x54202f(0x19b))](_0x54202f(0x197),common_1['HttpStatus']['NOT_FOUND']);if(_0x172325[_0x54202f(0x1ad)]!==user_constant_1[_0x54202f(0x1cb)][_0x54202f(0x18e)])throw new common_1['HttpException'](user_constant_1[_0x54202f(0x16d)][_0x172325[_0x54202f(0x1ad)]],common_1[_0x54202f(0x1b0)][_0x54202f(0x1f0)]);const {username:_0xdd0a73,id:_0x11dcec,role:_0x1b0b17,openId:_0x3976a5,client:_0x42080c}=_0x172325,_0x17bdf1=(0x0,utils_1[_0x54202f(0x1ab)])(_0x1a4b2f);await this[_0x54202f(0x191)][_0x54202f(0x16b)](_0x11dcec,_0x17bdf1);const _0x2a8800=await this['jwtService'][_0x54202f(0x1e4)]({'username':_0xdd0a73,'id':_0x11dcec,'email':_0x58f2b3,'role':_0x1b0b17,'openId':_0x3976a5,'client':_0x42080c,'phone':_0x10284d});return await this['redisCacheService']['saveToken'](_0x11dcec,_0x2a8800),await this['redisCacheService']['del'](_0x1e79d0),_0x2a8800;}async['loginByOpenId'](_0x45ad80,_0x422f90){const _0x1e235b=_0x334f9a,{status:_0x213cbb}=_0x45ad80;if(_0x213cbb!==user_constant_1[_0x1e235b(0x1cb)][_0x1e235b(0x18e)])throw new common_1['HttpException'](user_constant_1['UserStatusErrMsg'][_0x213cbb],common_1['HttpStatus'][_0x1e235b(0x1f0)]);const {username:_0x47eaec,id:_0x5dbe32,email:_0x5afa45,role:_0x128b49,openId:_0x5221a8,client:_0xc34058}=_0x45ad80,_0x30778c=(0x0,utils_1[_0x1e235b(0x1ab)])(_0x422f90);await this[_0x1e235b(0x191)][_0x1e235b(0x16b)](_0x5dbe32,_0x30778c);const _0x1850c1=await this[_0x1e235b(0x170)][_0x1e235b(0x1e4)]({'username':_0x47eaec,'id':_0x5dbe32,'email':_0x5afa45,'role':_0x128b49,'openId':_0x5221a8,'client':_0xc34058});return await this[_0x1e235b(0x1c7)][_0x1e235b(0x17a)](_0x5dbe32,_0x1850c1),_0x1850c1;}async['getInfo'](_0x10ca94){const _0x51002b=_0x334f9a,{id:_0x21794f}=_0x10ca94[_0x51002b(0x17c)];return await this[_0x51002b(0x191)][_0x51002b(0x1bb)](_0x21794f);}async['updatePassword'](_0x14df93,_0x24f021){const _0x17aa63=_0x334f9a,{id:_0x3ade2a}=_0x14df93[_0x17aa63(0x17c)];return this[_0x17aa63(0x191)][_0x17aa63(0x179)](_0x3ade2a,_0x24f021['password']),_0x17aa63(0x185);}['getIp'](){const _0x1334f0=_0x334f9a;let _0x3c5038;const _0x2e4d47=os['networkInterfaces']();Object[_0x1334f0(0x17e)](_0x2e4d47)[_0x1334f0(0x171)](_0x50afc0=>{const _0x847dce=_0x1334f0,_0x229398=_0x2e4d47[_0x50afc0];for(let _0x2ad354=0x0;_0x2ad354<_0x229398[_0x847dce(0x1e0)];_0x2ad354++){const _0x3bb876=_0x229398[_0x2ad354];if(_0x3bb876[_0x847dce(0x19f)]===_0x847dce(0x16a)&&_0x3bb876[_0x847dce(0x1dc)]!==_0x847dce(0x1df)&&!_0x3bb876[_0x847dce(0x1a9)]){_0x3c5038=_0x3bb876[_0x847dce(0x1dc)];break;}}}),this[_0x1334f0(0x17b)]=_0x3c5038;}async[_0x334f9a(0x1f3)](_0x301175){const _0x3f52a8=_0x334f9a,{contact:_0x2dbbd3,isLogin:_0x43a37d}=_0x301175,_0x4f2760=(0x0,utils_1[_0x3f52a8(0x1e2)])(),_0x3e4001=/\S+@\S+\.\S+/[_0x3f52a8(0x177)](_0x2dbbd3),_0x50e1d8=/^1\d{10}$/[_0x3f52a8(0x177)](_0x2dbbd3);if(!_0x3e4001&&!_0x50e1d8)throw new common_1[(_0x3f52a8(0x19b))](_0x3f52a8(0x1ac),common_1[_0x3f52a8(0x1b0)][_0x3f52a8(0x1f0)]);if(_0x43a37d){if(_0x3e4001){const _0x45d54=await this[_0x3f52a8(0x191)][_0x3f52a8(0x18d)]({'email':_0x2dbbd3});if(_0x45d54)throw new common_1['HttpException'](_0x3f52a8(0x168),common_1[_0x3f52a8(0x1b0)][_0x3f52a8(0x1f0)]);}else{if(_0x50e1d8){const _0xbba161=await this[_0x3f52a8(0x191)][_0x3f52a8(0x18d)]({'phone':_0x2dbbd3});if(_0xbba161)throw new common_1[(_0x3f52a8(0x19b))](_0x3f52a8(0x1e9),common_1['HttpStatus']['BAD_REQUEST']);}}}else{if(_0x3e4001){const _0x51b750=await this[_0x3f52a8(0x191)][_0x3f52a8(0x18d)]({'email':_0x2dbbd3});if(!_0x51b750)throw new common_1[(_0x3f52a8(0x19b))](_0x3f52a8(0x1b9),common_1[_0x3f52a8(0x1b0)][_0x3f52a8(0x1f0)]);}else{if(_0x50e1d8){const _0x38145a=await this[_0x3f52a8(0x191)][_0x3f52a8(0x18d)]({'phone':_0x2dbbd3});if(!_0x38145a)throw new common_1[(_0x3f52a8(0x19b))](_0x3f52a8(0x1f1),common_1['HttpStatus'][_0x3f52a8(0x1f0)]);}}}const _0x56a297=await this[_0x3f52a8(0x1c4)]['getNamespace'](),_0x229116=_0x56a297+_0x3f52a8(0x1be)+_0x2dbbd3,_0x183cb9=_0x56a297+':RATE_LIMIT:'+_0x2dbbd3,_0x105601=await this[_0x3f52a8(0x1c7)][_0x3f52a8(0x1b3)](_0x229116);if(_0x105601&&_0x105601>0x0)throw new common_1[(_0x3f52a8(0x19b))](_0x105601+'秒内不得重复发送验证码！',common_1[_0x3f52a8(0x1b0)][_0x3f52a8(0x1f0)]);const _0x4ab531=await this[_0x3f52a8(0x1c7)][_0x3f52a8(0x1ba)]({'key':_0x183cb9})||0x0;if(_0x4ab531>=0xa)throw new common_1[(_0x3f52a8(0x19b))]('今日发送验证码次数已达上限，请24小时后再试！',common_1['HttpStatus'][_0x3f52a8(0x167)]);if(_0x3e4001)await this[_0x3f52a8(0x1d9)]['sendMail']({'to':_0x2dbbd3,'context':{'code':_0x4f2760}});else{if(_0x50e1d8){const _0x56b030={'phone':_0x2dbbd3,'code':_0x4f2760};await this['verificationService'][_0x3f52a8(0x19d)](_0x56b030);}}return await this[_0x3f52a8(0x1c7)]['set']({'key':_0x229116,'val':_0x4f2760},0x5*0x3c),await this['redisCacheService'][_0x3f52a8(0x199)]({'key':_0x183cb9,'val':Number(_0x4ab531)+0x1},0x18*0x3c*0x3c),await this[_0x3f52a8(0x1c7)]['set']({'key':_0x229116,'val':_0x4f2760},0x3c),_0x3f52a8(0x1ef)+(_0x43a37d?'注册':'验证')+'！';}[_0x334f9a(0x1f4)](_0x34d575){const _0x48a97c=_0x334f9a,_0x23abe3=this['jwtService'][_0x48a97c(0x1e4)]({'username':'游客'+_0x34d575,'id':_0x34d575,'email':_0x34d575+_0x48a97c(0x195),'role':'visitor','openId':null,'client':null});return _0x23abe3;}async[_0x334f9a(0x1b6)](_0xe89373,_0x5979b4){const _0x561e71=_0x334f9a;common_1[_0x561e71(0x1c0)][_0x561e71(0x1eb)](_0x561e71(0x1cc));const {name:_0xe17828,idCard:_0x86107c}=_0x5979b4,{id:_0x3d2689}=_0xe89373[_0x561e71(0x17c)];try{const _0x31b309=await this[_0x561e71(0x1a8)]['verifyIdentity'](_0x5979b4);common_1[_0x561e71(0x1c0)][_0x561e71(0x1eb)](_0x561e71(0x1c1)+_0x31b309);if(!_0x31b309)throw new common_1[(_0x561e71(0x19b))]('身份验证错误，请检查实名信息',common_1[_0x561e71(0x1b0)][_0x561e71(0x1f0)]);return await this[_0x561e71(0x191)][_0x561e71(0x1a7)](_0x3d2689,_0xe17828,_0x86107c),_0x561e71(0x1b4);}catch(_0x107ead){common_1[_0x561e71(0x1c0)]['error'](_0x561e71(0x1c6),_0x107ead);throw new common_1[(_0x561e71(0x19b))](_0x561e71(0x1d6),common_1[_0x561e71(0x1b0)][_0x561e71(0x1f0)]);}}async[_0x334f9a(0x193)](_0x4c8093,_0x260edc){const _0x454639=_0x334f9a;common_1[_0x454639(0x1c0)][_0x454639(0x1eb)](_0x454639(0x1e3));const {phone:_0x98bce0,username:_0x1fe27a,password:_0xc38fb1,code:_0x18cf09}=_0x260edc,{id:_0x98f7f2}=_0x4c8093[_0x454639(0x17c)],_0x2ce94a=this['globalConfigService'][_0x454639(0x1f8)](),_0x4c833b=_0x2ce94a+_0x454639(0x1be)+_0x98bce0,_0x2ee423=await this[_0x454639(0x1c7)][_0x454639(0x1ba)]({'key':_0x4c833b});common_1[_0x454639(0x1c0)][_0x454639(0x1eb)](_0x454639(0x1dd)+_0x98bce0+':\x20'+_0x2ee423);if(_0x18cf09==='')throw new common_1[(_0x454639(0x19b))]('请输入验证码',common_1[_0x454639(0x1b0)][_0x454639(0x1f0)]);if(!_0x2ee423){common_1['Logger'][_0x454639(0x1cd)](_0x454639(0x194)+_0x98bce0,_0x454639(0x1c3));throw new common_1[(_0x454639(0x19b))]('验证码已过期，请重新发送！',common_1[_0x454639(0x1b0)]['BAD_REQUEST']);}if(_0x18cf09!==_0x2ee423){common_1[_0x454639(0x1c0)][_0x454639(0x1cd)]('验证码错误:\x20'+_0x98bce0+'\x20输入的验证码:\x20'+_0x18cf09+_0x454639(0x1da)+_0x2ee423,_0x454639(0x1c3));throw new common_1[(_0x454639(0x19b))](_0x454639(0x1b8),common_1[_0x454639(0x1b0)][_0x454639(0x1f0)]);}if(_0x1fe27a){const _0x569a4f=await this[_0x454639(0x191)]['isUsernameTaken'](_0x260edc[_0x454639(0x19c)],_0x98f7f2);if(_0x569a4f)throw new common_1[(_0x454639(0x19b))](_0x454639(0x16e),common_1[_0x454639(0x1b0)][_0x454639(0x1f0)]);}try{return await this['userService'][_0x454639(0x1b1)](_0x98f7f2,_0x98bce0,_0x1fe27a,_0xc38fb1),_0x454639(0x1b4);}catch(_0x4aeeb4){common_1[_0x454639(0x1c0)][_0x454639(0x17f)](_0x454639(0x1c6),_0x4aeeb4);throw new common_1[(_0x454639(0x19b))](_0x454639(0x174),common_1[_0x454639(0x1b0)]['BAD_REQUEST']);}}};AuthService=__decorate([(0x0,common_1[_0x334f9a(0x1b7)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(config_entity_1['ConfigEntity'])),__metadata(_0x334f9a(0x18a),[typeorm_2[_0x334f9a(0x1a5)],user_service_1[_0x334f9a(0x163)],jwt_1[_0x334f9a(0x1bd)],mailer_service_1[_0x334f9a(0x1bc)],verification_service_1[_0x334f9a(0x165)],userBalance_service_1[_0x334f9a(0x175)],redisCache_service_1[_0x334f9a(0x1ce)],globalConfig_service_1[_0x334f9a(0x1db)]])],AuthService),exports[_0x334f9a(0x169)]=AuthService;