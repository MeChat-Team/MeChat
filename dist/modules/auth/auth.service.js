'use strict';const _0x36e20b=_0x1f09;function _0x1e3a(){const _0x326f26=['RedisCacheService',':CODE:','configEntity','keys','getUserByContact','@nestjs/jwt','forEach','登录失败:\x20用户凭证无效\x20-\x20用户名:\x20','17899NCwpsW','加密用户密码...','createRandomUid','\x20输入的验证码:\x20','Repository','getOwnPropertyDescriptor','验证码错误:\x20','\x20is\x20available:\x20','开始用户登录流程，用户名:\x20',':RATE_LIMIT:','error','object','getInfo','UserStatusEnum','bcryptjs','username','./../verification/verification.service','该邮箱已注册，请直接登录！','../redisCache/redisCache.service','getNamespace','JWT令牌生成成功\x20-\x20用户ID:\x20','log','Phone\x20','IPv4','../user/user.service','authService','@visitor.com','redisCacheService','defineProperty','del','getClientIp','1801232ePifOL','保存新用户到数据库...','getConfigs','用户创建成功，用户ID:\x20','用户不存在，请先注册！','family','VerificationService','秒内不得重复发送验证码！','../globalConfig/config.entity','AuthService','请输入验证码','密码修改成功','2676OMFHwK','addBalanceToNewUser','1RJKQeB','loginWithCaptcha','当前手机号已注册，请勿重复注册！','该手机号未注册，请先注册！','address','verifyUserRegister','@nestjs/common','用户名已存在！','Email\x20','../userBalance/userBalance.service','@aiweb.com','HttpException','BAD_REQUEST','function','password','userBalanceService','length','认证成功','login','updateUserPassword','internal','完成新用户余额处理','该邮箱未注册，请先注册！','decorate','1812345iAcFjo','当前邮箱已注册，请勿重复注册！','sendCode','使用默认用户头像:\x20','getIp','isUsernameTaken','该手机号已注册，请直接登录！','NOT_FOUND','createTokenFromFingerprint','test','4843860QyAVMj','sendPhoneCode',',\x20期望的验证码:\x20','ttl','UserStatusErrMsg','验证码已过期，请重新发送！','noVerifyRegister','JwtService','请提供有效的邮箱地址或手机号码。','updatePassword','@nestjs/typeorm','saveToken','register','获取默认用户头像...','savaLoginIp','sendMail','Injectable','loginByOpenId',',\x20isEmail:\x20','Contact:\x20','UserService','jwtService','验证码填写错误，请重新输入！','../mailer/mailer.service','design:paramtypes','UNAUTHORIZED','userService','Logger','__metadata','../globalConfig/globalConfig.service','networkInterfaces','visitor','get','保存登录IP:\x20','Checking\x20if\x20username\x20','debug','5225284ktPuUx','user','globalConfigService','metadata','sign','验证码错误，请重新输入！','onModuleInit',',\x20用户名:\x20','今日发送验证码次数已达上限，请24小时后再试！','ConfigEntity','9ZeBMqy','status','HttpStatus','mailerService','../../common/constants/user.constant','getUserInfo','__param','验证码过期:\x20','14112970cfXFSm','verificationService','127.0.0.1','\x20-\x20用户ID:\x20','Retrieved\x20redisCode\x20for\x20','set','verifyIdentity','ACTIVE','用户凭证验证成功，用户ID:\x20','2293688dikKgd'];_0x1e3a=function(){return _0x326f26;};return _0x1e3a();}(function(_0x875865,_0x57a148){const _0xb693d0=_0x1f09,_0x3e4426=_0x875865();while(!![]){try{const _0x46477a=-parseInt(_0xb693d0(0x12d))/0x1*(-parseInt(_0xb693d0(0x18e))/0x2)+parseInt(_0xb693d0(0x145))/0x3+-parseInt(_0xb693d0(0x173))/0x4+parseInt(_0xb693d0(0x14f))/0x5+parseInt(_0xb693d0(0x12b))/0x6*(parseInt(_0xb693d0(0x197))/0x7)+-parseInt(_0xb693d0(0x11f))/0x8+-parseInt(_0xb693d0(0x17d))/0x9*(parseInt(_0xb693d0(0x185))/0xa);if(_0x46477a===_0x57a148)break;else _0x3e4426['push'](_0x3e4426['shift']());}catch(_0x27f716){_0x3e4426['push'](_0x3e4426['shift']());}}}(_0x1e3a,0xdff85));function _0x1f09(_0x3c8851,_0x55f212){const _0x1e3af6=_0x1e3a();return _0x1f09=function(_0x1f0920,_0x403b37){_0x1f0920=_0x1f0920-0x10c;let _0x33d614=_0x1e3af6[_0x1f0920];return _0x33d614;},_0x1f09(_0x3c8851,_0x55f212);}var __decorate=this&&this['__decorate']||function(_0x54b2f2,_0x4aac56,_0x1b8d83,_0x30f258){const _0x3f05c4=_0x1f09;var _0x135987=arguments[_0x3f05c4(0x13d)],_0x5a889d=_0x135987<0x3?_0x4aac56:_0x30f258===null?_0x30f258=Object[_0x3f05c4(0x19c)](_0x4aac56,_0x1b8d83):_0x30f258,_0x13bfd5;if(typeof Reflect===_0x3f05c4(0x1a2)&&typeof Reflect[_0x3f05c4(0x144)]===_0x3f05c4(0x13a))_0x5a889d=Reflect[_0x3f05c4(0x144)](_0x54b2f2,_0x4aac56,_0x1b8d83,_0x30f258);else{for(var _0x4e307c=_0x54b2f2[_0x3f05c4(0x13d)]-0x1;_0x4e307c>=0x0;_0x4e307c--)if(_0x13bfd5=_0x54b2f2[_0x4e307c])_0x5a889d=(_0x135987<0x3?_0x13bfd5(_0x5a889d):_0x135987>0x3?_0x13bfd5(_0x4aac56,_0x1b8d83,_0x5a889d):_0x13bfd5(_0x4aac56,_0x1b8d83))||_0x5a889d;}return _0x135987>0x3&&_0x5a889d&&Object['defineProperty'](_0x4aac56,_0x1b8d83,_0x5a889d),_0x5a889d;},__metadata=this&&this[_0x36e20b(0x16b)]||function(_0x273da2,_0xcb98bb){const _0x462e35=_0x36e20b;if(typeof Reflect===_0x462e35(0x1a2)&&typeof Reflect[_0x462e35(0x176)]===_0x462e35(0x13a))return Reflect[_0x462e35(0x176)](_0x273da2,_0xcb98bb);},__param=this&&this[_0x36e20b(0x183)]||function(_0x4a9cb3,_0x26a4a9){return function(_0x5141f5,_0x3fc683){_0x26a4a9(_0x5141f5,_0x3fc683,_0x4a9cb3);};};Object[_0x36e20b(0x11c)](exports,'__esModule',{'value':!![]}),exports[_0x36e20b(0x128)]=void 0x0;const user_constant_1=require(_0x36e20b(0x181)),utils_1=require('../../common/utils'),globalConfig_service_1=require(_0x36e20b(0x16c)),common_1=require(_0x36e20b(0x133)),jwt_1=require(_0x36e20b(0x194)),typeorm_1=require(_0x36e20b(0x159)),bcrypt=require(_0x36e20b(0x10e)),os=require('os'),typeorm_2=require('typeorm'),config_entity_1=require(_0x36e20b(0x127)),mailer_service_1=require(_0x36e20b(0x166)),redisCache_service_1=require(_0x36e20b(0x112)),user_service_1=require(_0x36e20b(0x118)),userBalance_service_1=require(_0x36e20b(0x136)),verification_service_1=require(_0x36e20b(0x110));let AuthService=class AuthService{constructor(_0x480b01,_0x36dc0a,_0x393ac8,_0x58336f,_0x19b91a,_0x95bb4d,_0x286c32,_0x43b562){const _0x140ee4=_0x36e20b;this[_0x140ee4(0x191)]=_0x480b01,this[_0x140ee4(0x169)]=_0x36dc0a,this['jwtService']=_0x393ac8,this['mailerService']=_0x58336f,this[_0x140ee4(0x186)]=_0x19b91a,this[_0x140ee4(0x13c)]=_0x95bb4d,this[_0x140ee4(0x11b)]=_0x286c32,this['globalConfigService']=_0x43b562;}async[_0x36e20b(0x179)](){this['getIp']();}async[_0x36e20b(0x15b)](_0x4a2926,_0x4cc67f){const _0x33e80f=_0x36e20b,{password:_0x397130,contact:_0x550f60,code:_0x5d57c4}=_0x4a2926;let _0x2a91bf='',_0x489eeb='';const _0x192285=/\S+@\S+\.\S+/[_0x33e80f(0x14e)](_0x550f60),_0x53a5f0=/^\d{10,}$/[_0x33e80f(0x14e)](_0x550f60);common_1['Logger']['debug'](_0x33e80f(0x162)+_0x550f60+_0x33e80f(0x161)+_0x192285+',\x20isPhone:\x20'+_0x53a5f0);let _0x53c835=(0x0,utils_1['createRandomUid'])();while(!![]){const _0x322128=await this[_0x33e80f(0x169)]['verifyUserRegister']({'username':_0x53c835});common_1['Logger'][_0x33e80f(0x172)](_0x33e80f(0x171)+_0x53c835+'\x20is\x20taken:\x20'+_0x322128);if(_0x322128)break;_0x53c835=(0x0,utils_1['createRandomUid'])();}if(_0x192285){_0x2a91bf=_0x550f60;const _0x1d850c=await this[_0x33e80f(0x169)][_0x33e80f(0x132)]({'username':_0x53c835,'email':_0x2a91bf});common_1[_0x33e80f(0x16a)][_0x33e80f(0x172)](_0x33e80f(0x135)+_0x2a91bf+_0x33e80f(0x19e)+_0x1d850c);if(!_0x1d850c)throw new common_1[(_0x33e80f(0x138))](_0x33e80f(0x146),common_1[_0x33e80f(0x17f)][_0x33e80f(0x139)]);}else{if(_0x53a5f0){_0x489eeb=_0x550f60;const _0x3cee07=await this[_0x33e80f(0x169)][_0x33e80f(0x132)]({'username':_0x53c835,'phone':_0x489eeb});common_1[_0x33e80f(0x16a)]['debug'](_0x33e80f(0x116)+_0x489eeb+_0x33e80f(0x19e)+_0x3cee07);if(!_0x3cee07)throw new common_1[(_0x33e80f(0x138))](_0x33e80f(0x12f),common_1[_0x33e80f(0x17f)][_0x33e80f(0x139)]);}else throw new common_1[(_0x33e80f(0x138))]('请提供有效的邮箱地址或手机号码。',common_1[_0x33e80f(0x17f)]['BAD_REQUEST']);}const _0x10b26c=await this[_0x33e80f(0x175)][_0x33e80f(0x121)]([_0x33e80f(0x155)]);common_1[_0x33e80f(0x16a)][_0x33e80f(0x172)]('noVerifyRegister:\x20'+_0x10b26c);if(_0x10b26c!=='1'){const _0x2436e1=await this[_0x33e80f(0x175)][_0x33e80f(0x113)](),_0x4782d9=_0x2436e1+':CODE:'+_0x550f60,_0x5912dc=await this[_0x33e80f(0x11b)][_0x33e80f(0x16f)]({'key':_0x4782d9});common_1['Logger']['debug'](_0x33e80f(0x189)+_0x550f60+':\x20'+_0x5912dc);if(_0x5d57c4==='')throw new common_1[(_0x33e80f(0x138))](_0x33e80f(0x129),common_1[_0x33e80f(0x17f)][_0x33e80f(0x139)]);if(!_0x5912dc){common_1['Logger'][_0x33e80f(0x115)](_0x33e80f(0x184)+_0x550f60,_0x33e80f(0x119));throw new common_1[(_0x33e80f(0x138))](_0x33e80f(0x154),common_1['HttpStatus']['BAD_REQUEST']);}if(_0x5d57c4!==_0x5912dc){common_1[_0x33e80f(0x16a)]['log'](_0x33e80f(0x19d)+_0x550f60+_0x33e80f(0x19a)+_0x5d57c4+_0x33e80f(0x151)+_0x5912dc,'authService');throw new common_1[(_0x33e80f(0x138))]('验证码填写错误，请重新输入！',common_1['HttpStatus'][_0x33e80f(0x139)]);}}let _0x2cd150;if(_0x192285)_0x2cd150={'username':_0x53c835,'password':_0x397130,'email':_0x550f60,'status':user_constant_1[_0x33e80f(0x10d)][_0x33e80f(0x18c)]};else{const _0x2690f9=(0x0,utils_1[_0x33e80f(0x199)])()+_0x33e80f(0x137);_0x2cd150={'username':_0x53c835,'password':_0x397130,'email':_0x2690f9,'phone':_0x550f60,'status':user_constant_1[_0x33e80f(0x10d)][_0x33e80f(0x18c)]};}common_1[_0x33e80f(0x16a)][_0x33e80f(0x172)](_0x33e80f(0x15c));const _0x326d7c=await this[_0x33e80f(0x175)][_0x33e80f(0x121)](['userDefautlAvatar']);common_1[_0x33e80f(0x16a)][_0x33e80f(0x172)](_0x33e80f(0x148)+_0x326d7c),_0x2cd150['avatar']=_0x326d7c,common_1[_0x33e80f(0x16a)][_0x33e80f(0x172)](_0x33e80f(0x198));const _0x57378c=bcrypt['hashSync'](_0x397130,0xa);_0x2cd150[_0x33e80f(0x13b)]=_0x57378c,common_1[_0x33e80f(0x16a)][_0x33e80f(0x172)](_0x33e80f(0x120));const _0x2fdce6=await this[_0x33e80f(0x169)]['createUser'](_0x2cd150);return common_1['Logger'][_0x33e80f(0x172)](_0x33e80f(0x122)+_0x2fdce6['id']),await this['userBalanceService'][_0x33e80f(0x12c)](_0x2fdce6['id']),common_1[_0x33e80f(0x16a)][_0x33e80f(0x172)](_0x33e80f(0x142)),{'success':!![],'message':'注册成功'};}async[_0x36e20b(0x13f)](_0x3e6fa2,_0x26fc86){const _0x3b759f=_0x36e20b;console[_0x3b759f(0x115)](_0x3b759f(0x19f)+_0x3e6fa2[_0x3b759f(0x10f)]);const _0x45e69c=await this[_0x3b759f(0x169)]['verifyUserCredentials'](_0x3e6fa2);if(!_0x45e69c){console[_0x3b759f(0x1a1)](_0x3b759f(0x196)+_0x3e6fa2[_0x3b759f(0x10f)]);throw new common_1[(_0x3b759f(0x138))]('登录失败，用户凭证无效。',common_1[_0x3b759f(0x17f)][_0x3b759f(0x168)]);}const {username:_0x4127cb,id:_0x2f2b19,email:_0x18e518,role:_0x2a7eae,openId:_0x5be488,client:_0x2a78c3,phone:_0x17ccd9}=_0x45e69c;console[_0x3b759f(0x115)](_0x3b759f(0x18d)+_0x2f2b19+_0x3b759f(0x17a)+_0x4127cb);const _0x47098a=(0x0,utils_1[_0x3b759f(0x11e)])(_0x26fc86);await this[_0x3b759f(0x169)][_0x3b759f(0x15d)](_0x2f2b19,_0x47098a),console[_0x3b759f(0x115)](_0x3b759f(0x170)+_0x47098a+_0x3b759f(0x188)+_0x2f2b19);const _0x3fad86=await this[_0x3b759f(0x164)][_0x3b759f(0x177)]({'username':_0x4127cb,'id':_0x2f2b19,'email':_0x18e518,'role':_0x2a7eae,'openId':_0x5be488,'client':_0x2a78c3,'phone':_0x17ccd9});return console[_0x3b759f(0x115)](_0x3b759f(0x114)+_0x2f2b19),await this['redisCacheService'][_0x3b759f(0x15a)](_0x2f2b19,_0x3fad86),console[_0x3b759f(0x115)]('令牌已保存到Redis\x20-\x20用户ID:\x20'+_0x2f2b19),_0x3fad86;}async[_0x36e20b(0x12e)](_0x2fa616,_0x57f3f6){const _0x3658c5=_0x36e20b,{contact:_0xc9c622,code:_0x1c4d6c}=_0x2fa616;let _0x41f8cd='',_0xc0fd48='';const _0x387d54=/\S+@\S+\.\S+/['test'](_0xc9c622),_0x10d386=/^\d{10,}$/['test'](_0xc9c622);if(_0x387d54)_0x41f8cd=_0xc9c622;else{if(_0x10d386)_0xc0fd48=_0xc9c622;else throw new common_1[(_0x3658c5(0x138))](_0x3658c5(0x157),common_1[_0x3658c5(0x17f)][_0x3658c5(0x139)]);}if(!![]){if(_0x387d54){const _0x565ecc=await this[_0x3658c5(0x169)][_0x3658c5(0x132)]({'email':_0xc9c622});if(_0x565ecc)throw new common_1['HttpException'](_0x3658c5(0x143),common_1['HttpStatus'][_0x3658c5(0x139)]);}else{if(_0x10d386){const _0x1d36e7=await this['userService'][_0x3658c5(0x132)]({'phone':_0xc9c622});if(_0x1d36e7)throw new common_1['HttpException'](_0x3658c5(0x130),common_1[_0x3658c5(0x17f)][_0x3658c5(0x139)]);}}}else{if(_0x387d54){const _0x3487a6=await this['userService'][_0x3658c5(0x132)]({'email':_0xc9c622});if(!_0x3487a6)throw new common_1[(_0x3658c5(0x138))](_0x3658c5(0x111),common_1['HttpStatus']['BAD_REQUEST']);}else{if(_0x10d386){const _0x160e4a=await this[_0x3658c5(0x169)][_0x3658c5(0x132)]({'phone':_0xc9c622});if(!_0x160e4a)throw new common_1[(_0x3658c5(0x138))](_0x3658c5(0x14b),common_1[_0x3658c5(0x17f)][_0x3658c5(0x139)]);}}}const _0x17f399=await this[_0x3658c5(0x175)][_0x3658c5(0x113)](),_0x5f4d01=_0x17f399+_0x3658c5(0x190)+_0xc9c622,_0x3851be=await this['redisCacheService']['get']({'key':_0x5f4d01});if(!_0x3851be){common_1[_0x3658c5(0x16a)][_0x3658c5(0x115)]('验证码过期:\x20'+_0xc9c622,_0x3658c5(0x119));throw new common_1[(_0x3658c5(0x138))](_0x3658c5(0x154),common_1['HttpStatus'][_0x3658c5(0x139)]);}if(_0x3851be!==_0x1c4d6c){common_1[_0x3658c5(0x16a)][_0x3658c5(0x115)]('验证码错误:\x20'+_0xc9c622,_0x3658c5(0x119));throw new common_1[(_0x3658c5(0x138))](_0x3658c5(0x178),common_1['HttpStatus']['BAD_REQUEST']);}const _0xf69680=await this['userService'][_0x3658c5(0x193)]({'email':_0x41f8cd,'phone':_0xc0fd48});if(!_0xf69680)throw new common_1['HttpException'](_0x3658c5(0x123),common_1[_0x3658c5(0x17f)][_0x3658c5(0x14c)]);if(_0xf69680[_0x3658c5(0x17e)]!==user_constant_1[_0x3658c5(0x10d)][_0x3658c5(0x18c)])throw new common_1['HttpException'](user_constant_1[_0x3658c5(0x153)][_0xf69680['status']],common_1[_0x3658c5(0x17f)]['BAD_REQUEST']);const {username:_0x580c95,id:_0x341d5b,role:_0x3dd176,openId:_0x2c9f35,client:_0x31ddaf}=_0xf69680,_0x402777=(0x0,utils_1[_0x3658c5(0x11e)])(_0x57f3f6);await this['userService'][_0x3658c5(0x15d)](_0x341d5b,_0x402777);const _0x678b6c=await this[_0x3658c5(0x164)][_0x3658c5(0x177)]({'username':_0x580c95,'id':_0x341d5b,'email':_0x41f8cd,'role':_0x3dd176,'openId':_0x2c9f35,'client':_0x31ddaf,'phone':_0xc0fd48});return await this[_0x3658c5(0x11b)][_0x3658c5(0x15a)](_0x341d5b,_0x678b6c),await this['redisCacheService'][_0x3658c5(0x11d)](_0x5f4d01),_0x678b6c;}async[_0x36e20b(0x160)](_0x14afb4,_0x339752){const _0x33c3ec=_0x36e20b,{status:_0x4db631}=_0x14afb4;if(_0x4db631!==user_constant_1['UserStatusEnum']['ACTIVE'])throw new common_1[(_0x33c3ec(0x138))](user_constant_1['UserStatusErrMsg'][_0x4db631],common_1['HttpStatus'][_0x33c3ec(0x139)]);const {username:_0x263360,id:_0x311657,email:_0x2e5b91,role:_0x18c20a,openId:_0x3ef7e6,client:_0xb24d49}=_0x14afb4,_0x35d0f1=(0x0,utils_1['getClientIp'])(_0x339752);await this[_0x33c3ec(0x169)][_0x33c3ec(0x15d)](_0x311657,_0x35d0f1);const _0x1dcf85=await this[_0x33c3ec(0x164)][_0x33c3ec(0x177)]({'username':_0x263360,'id':_0x311657,'email':_0x2e5b91,'role':_0x18c20a,'openId':_0x3ef7e6,'client':_0xb24d49});return await this['redisCacheService'][_0x33c3ec(0x15a)](_0x311657,_0x1dcf85),_0x1dcf85;}async[_0x36e20b(0x10c)](_0x25629e){const _0x2f244c=_0x36e20b,{id:_0x5c5896}=_0x25629e['user'];return await this['userService'][_0x2f244c(0x182)](_0x5c5896);}async[_0x36e20b(0x158)](_0x26304d,_0x4d8d60){const _0x2fbc01=_0x36e20b,{id:_0x4936a5}=_0x26304d['user'];return this[_0x2fbc01(0x169)][_0x2fbc01(0x140)](_0x4936a5,_0x4d8d60[_0x2fbc01(0x13b)]),_0x2fbc01(0x12a);}[_0x36e20b(0x149)](){const _0x26ffda=_0x36e20b;let _0x2cfd8b;const _0x1fd592=os[_0x26ffda(0x16d)]();Object[_0x26ffda(0x192)](_0x1fd592)[_0x26ffda(0x195)](_0x156e3a=>{const _0x496845=_0x26ffda,_0x2bbeaf=_0x1fd592[_0x156e3a];for(let _0x4dc244=0x0;_0x4dc244<_0x2bbeaf[_0x496845(0x13d)];_0x4dc244++){const _0x2aa09a=_0x2bbeaf[_0x4dc244];if(_0x2aa09a[_0x496845(0x124)]===_0x496845(0x117)&&_0x2aa09a['address']!==_0x496845(0x187)&&!_0x2aa09a[_0x496845(0x141)]){_0x2cfd8b=_0x2aa09a[_0x496845(0x131)];break;}}}),this['ipAddress']=_0x2cfd8b;}async[_0x36e20b(0x147)](_0x12c3dd){const _0x236682=_0x36e20b,{contact:_0x3c90a1,isLogin:_0x56aa55}=_0x12c3dd,_0xe258e1=(0x0,utils_1['createRandomCode'])(),_0x9ef398=/\S+@\S+\.\S+/['test'](_0x3c90a1),_0x28accf=/^1\d{10}$/[_0x236682(0x14e)](_0x3c90a1);if(!_0x9ef398&&!_0x28accf)throw new common_1[(_0x236682(0x138))]('请提供有效的邮箱地址或手机号码。',common_1[_0x236682(0x17f)][_0x236682(0x139)]);if(_0x56aa55){if(_0x9ef398){const _0x5dbf24=await this['userService'][_0x236682(0x132)]({'email':_0x3c90a1});if(_0x5dbf24)throw new common_1[(_0x236682(0x138))](_0x236682(0x143),common_1[_0x236682(0x17f)][_0x236682(0x139)]);}else{if(_0x28accf){const _0x1bca85=await this['userService']['verifyUserRegister']({'phone':_0x3c90a1});if(_0x1bca85)throw new common_1[(_0x236682(0x138))](_0x236682(0x130),common_1['HttpStatus'][_0x236682(0x139)]);}}}else{if(_0x9ef398){const _0x3c224d=await this['userService'][_0x236682(0x132)]({'email':_0x3c90a1});if(!_0x3c224d)throw new common_1[(_0x236682(0x138))](_0x236682(0x111),common_1[_0x236682(0x17f)][_0x236682(0x139)]);}else{if(_0x28accf){const _0x1199d2=await this[_0x236682(0x169)][_0x236682(0x132)]({'phone':_0x3c90a1});if(!_0x1199d2)throw new common_1[(_0x236682(0x138))](_0x236682(0x14b),common_1['HttpStatus']['BAD_REQUEST']);}}}const _0x37145c=await this[_0x236682(0x175)][_0x236682(0x113)](),_0x1ab025=_0x37145c+_0x236682(0x190)+_0x3c90a1,_0x58112a=_0x37145c+_0x236682(0x1a0)+_0x3c90a1,_0xce2018=await this[_0x236682(0x11b)][_0x236682(0x152)](_0x1ab025);if(_0xce2018&&_0xce2018>0x0)throw new common_1[(_0x236682(0x138))](_0xce2018+_0x236682(0x126),common_1[_0x236682(0x17f)]['BAD_REQUEST']);const _0x50c49c=await this['redisCacheService'][_0x236682(0x16f)]({'key':_0x58112a})||0x0;if(_0x50c49c>=0xa)throw new common_1[(_0x236682(0x138))](_0x236682(0x17b),common_1['HttpStatus']['TOO_MANY_REQUESTS']);if(_0x9ef398)await this[_0x236682(0x180)][_0x236682(0x15e)]({'to':_0x3c90a1,'context':{'code':_0xe258e1}});else{if(_0x28accf){const _0x37c3cb={'phone':_0x3c90a1,'code':_0xe258e1};await this['verificationService'][_0x236682(0x150)](_0x37c3cb);}}return await this['redisCacheService'][_0x236682(0x18a)]({'key':_0x1ab025,'val':_0xe258e1},0x5*0x3c),await this[_0x236682(0x11b)]['set']({'key':_0x58112a,'val':Number(_0x50c49c)+0x1},0x18*0x3c*0x3c),await this[_0x236682(0x11b)]['set']({'key':_0x1ab025,'val':_0xe258e1},0x3c),'验证码发送成功、请填写验证码完成'+(_0x56aa55?'注册':'验证')+'！';}[_0x36e20b(0x14d)](_0x29903e){const _0x1b8ffa=_0x36e20b,_0x377f25=this[_0x1b8ffa(0x164)][_0x1b8ffa(0x177)]({'username':'游客'+_0x29903e,'id':_0x29903e,'email':_0x29903e+_0x1b8ffa(0x11a),'role':_0x1b8ffa(0x16e),'openId':null,'client':null});return _0x377f25;}async[_0x36e20b(0x18b)](_0x12343c,_0x5d22c0){const _0x5cc59d=_0x36e20b;common_1[_0x5cc59d(0x16a)][_0x5cc59d(0x172)]('开始实名认证流程');const {name:_0x4c3f5f,idCard:_0x5a59ba}=_0x5d22c0,{id:_0x2a490b}=_0x12343c[_0x5cc59d(0x174)];try{const _0x573c6c=await this[_0x5cc59d(0x186)][_0x5cc59d(0x18b)](_0x5d22c0);common_1[_0x5cc59d(0x16a)][_0x5cc59d(0x172)]('实名认证结果:\x20'+_0x573c6c);if(!_0x573c6c)throw new common_1[(_0x5cc59d(0x138))]('身份验证错误，请检查实名信息',common_1['HttpStatus']['BAD_REQUEST']);return await this[_0x5cc59d(0x169)]['saveRealNameInfo'](_0x2a490b,_0x4c3f5f,_0x5a59ba),_0x5cc59d(0x13e);}catch(_0xb1daaa){common_1[_0x5cc59d(0x16a)][_0x5cc59d(0x1a1)]('验证过程出现错误',_0xb1daaa);throw new common_1[(_0x5cc59d(0x138))]('认证失败，请检查相关信息',common_1[_0x5cc59d(0x17f)][_0x5cc59d(0x139)]);}}async['verifyPhoneIdentity'](_0x447461,_0x171800){const _0x2ffe4e=_0x36e20b;common_1[_0x2ffe4e(0x16a)]['debug']('开始手机号认证流程');const {phone:_0x373d91,username:_0x22a213,password:_0x3804db,code:_0x49493a}=_0x171800,{id:_0x3aae38}=_0x447461[_0x2ffe4e(0x174)],_0x8010c2=this[_0x2ffe4e(0x175)][_0x2ffe4e(0x113)](),_0x303749=_0x8010c2+_0x2ffe4e(0x190)+_0x373d91,_0x44d507=await this[_0x2ffe4e(0x11b)][_0x2ffe4e(0x16f)]({'key':_0x303749});common_1[_0x2ffe4e(0x16a)]['debug'](_0x2ffe4e(0x189)+_0x373d91+':\x20'+_0x44d507);if(_0x49493a==='')throw new common_1[(_0x2ffe4e(0x138))](_0x2ffe4e(0x129),common_1['HttpStatus'][_0x2ffe4e(0x139)]);if(!_0x44d507){common_1['Logger'][_0x2ffe4e(0x115)](_0x2ffe4e(0x184)+_0x373d91,'authService');throw new common_1['HttpException'](_0x2ffe4e(0x154),common_1[_0x2ffe4e(0x17f)][_0x2ffe4e(0x139)]);}if(_0x49493a!==_0x44d507){common_1[_0x2ffe4e(0x16a)][_0x2ffe4e(0x115)](_0x2ffe4e(0x19d)+_0x373d91+'\x20输入的验证码:\x20'+_0x49493a+_0x2ffe4e(0x151)+_0x44d507,'authService');throw new common_1[(_0x2ffe4e(0x138))](_0x2ffe4e(0x165),common_1['HttpStatus']['BAD_REQUEST']);}if(_0x22a213){const _0x320d49=await this[_0x2ffe4e(0x169)][_0x2ffe4e(0x14a)](_0x171800[_0x2ffe4e(0x10f)],_0x3aae38);if(_0x320d49)throw new common_1['HttpException'](_0x2ffe4e(0x134),common_1[_0x2ffe4e(0x17f)]['BAD_REQUEST']);}try{return await this[_0x2ffe4e(0x169)]['updateUserPhone'](_0x3aae38,_0x373d91,_0x22a213,_0x3804db),'认证成功';}catch(_0x38c537){common_1[_0x2ffe4e(0x16a)][_0x2ffe4e(0x1a1)]('验证过程出现错误',_0x38c537);throw new common_1[(_0x2ffe4e(0x138))]('身份验证错误，请检查相关信息',common_1[_0x2ffe4e(0x17f)]['BAD_REQUEST']);}}};AuthService=__decorate([(0x0,common_1[_0x36e20b(0x15f)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(config_entity_1[_0x36e20b(0x17c)])),__metadata(_0x36e20b(0x167),[typeorm_2[_0x36e20b(0x19b)],user_service_1[_0x36e20b(0x163)],jwt_1[_0x36e20b(0x156)],mailer_service_1['MailerService'],verification_service_1[_0x36e20b(0x125)],userBalance_service_1['UserBalanceService'],redisCache_service_1[_0x36e20b(0x18f)],globalConfig_service_1['GlobalConfigService']])],AuthService),exports[_0x36e20b(0x128)]=AuthService;