'use strict';const _0x2a9767=_0x168e;function _0x28f1(){const _0x6ff3a6=['验证过程出现错误','1663080zMagsQ','status','../../common/constants/user.constant','1049400gvJgDY','秒内不得重复发送验证码！','NOT_FOUND','验证码错误:\x20','保存新用户到数据库...','getConfigs',',\x20isPhone:\x20','user','Repository','noVerifyRegister',',\x20期望的验证码:\x20','getIp','21cqaNSV','5579022hQiDvq','defineProperty','userBalanceService','updateUserPassword','set','UserStatusErrMsg','__param','../redisCache/redisCache.service','address','mailerService','9204PZoRxu','getNamespace','verificationService','verifyUserCredentials','verifyUserRegister','@nestjs/jwt','./../verification/verification.service','加密用户密码...','使用默认用户头像:\x20','Injectable','UserStatusEnum','sendCode','../user/user.service','InjectRepository','updatePassword','登录失败:\x20用户凭证无效\x20-\x20用户名:\x20','@visitor.com','请提供有效的邮箱地址或手机号码。','createTokenFromFingerprint','../../common/utils','当前手机号已注册，请勿重复注册！','sign','error','userService','AuthService','createRandomCode','令牌已保存到Redis\x20-\x20用户ID:\x20','保存登录IP:\x20','object','验证码填写错误，请重新输入！','注册成功','login','\x20输入的验证码:\x20','loginWithCaptcha','开始用户登录流程，用户名:\x20','password','身份验证错误，请检查相关信息','design:paramtypes','../globalConfig/config.entity','jwtService','getClientIp','getUserInfo','当前邮箱已注册，请勿重复注册！','internal','metadata','认证成功','\x20-\x20用户ID:\x20','127.0.0.1','38kyTHSx','saveToken','visitor','verifyIdentity','用户不存在，请先注册！','isUsernameTaken','verifyPhoneIdentity','sendPhoneCode','登录失败，用户凭证无效。','HttpStatus','username','验证码发送成功、请填写验证码完成',',\x20用户名:\x20','redisCacheService','IPv4','64316VSnDRf','272NQaetV','\x20is\x20available:\x20','savaLoginIp','验证码过期:\x20','configEntity','243EykbNq','userDefautlAvatar','用户名已存在！','Logger','认证失败，请检查相关信息','BAD_REQUEST','用户创建成功，用户ID:\x20','该手机号已注册，请直接登录！','decorate','../globalConfig/globalConfig.service','saveRealNameInfo','del','../mailer/mailer.service','test','addBalanceToNewUser','UserBalanceService','RedisCacheService',':CODE:','../userBalance/userBalance.service','log','bcryptjs','HttpException','function','UserService','keys','用户凭证验证成功，用户ID:\x20','ipAddress','typeorm','该邮箱未注册，请先注册！','Email\x20','getUserByContact','密码修改成功','globalConfigService','createRandomUid','验证码已过期，请重新发送！','family','UNAUTHORIZED','身份验证错误，请检查实名信息','avatar','authService','101730eUzhUh','@nestjs/typeorm','length','@nestjs/common','请输入验证码','ACTIVE','今日发送验证码次数已达上限，请24小时后再试！','loginByOpenId','get','35363IlRKay','5FFnMWd','JwtService','debug'];_0x28f1=function(){return _0x6ff3a6;};return _0x28f1();}function _0x168e(_0x25e1ab,_0x105db7){const _0x28f1e9=_0x28f1();return _0x168e=function(_0x168ee7,_0x28339b){_0x168ee7=_0x168ee7-0xbf;let _0xf02537=_0x28f1e9[_0x168ee7];return _0xf02537;},_0x168e(_0x25e1ab,_0x105db7);}(function(_0x2366ea,_0x1a06c2){const _0x3b65be=_0x168e,_0x4d038a=_0x2366ea();while(!![]){try{const _0x1f18db=parseInt(_0x3b65be(0x106))/0x1*(parseInt(_0x3b65be(0xc0))/0x2)+-parseInt(_0x3b65be(0x11a))/0x3*(parseInt(_0x3b65be(0x125))/0x4)+-parseInt(_0x3b65be(0x107))/0x5*(parseInt(_0x3b65be(0x11b))/0x6)+-parseInt(_0x3b65be(0xcf))/0x7*(-parseInt(_0x3b65be(0xd0))/0x8)+-parseInt(_0x3b65be(0xd5))/0x9*(-parseInt(_0x3b65be(0xfd))/0xa)+parseInt(_0x3b65be(0x10e))/0xb+parseInt(_0x3b65be(0x10b))/0xc;if(_0x1f18db===_0x1a06c2)break;else _0x4d038a['push'](_0x4d038a['shift']());}catch(_0x516462){_0x4d038a['push'](_0x4d038a['shift']());}}}(_0x28f1,0x858be));var __decorate=this&&this['__decorate']||function(_0x24ef78,_0x4c1e1c,_0x5d5090,_0x53b6f6){const _0x4d3060=_0x168e;var _0x45cd4f=arguments[_0x4d3060(0xff)],_0x421d6e=_0x45cd4f<0x3?_0x4c1e1c:_0x53b6f6===null?_0x53b6f6=Object['getOwnPropertyDescriptor'](_0x4c1e1c,_0x5d5090):_0x53b6f6,_0xbe1642;if(typeof Reflect===_0x4d3060(0x141)&&typeof Reflect[_0x4d3060(0xdd)]===_0x4d3060(0xeb))_0x421d6e=Reflect['decorate'](_0x24ef78,_0x4c1e1c,_0x5d5090,_0x53b6f6);else{for(var _0x26404b=_0x24ef78[_0x4d3060(0xff)]-0x1;_0x26404b>=0x0;_0x26404b--)if(_0xbe1642=_0x24ef78[_0x26404b])_0x421d6e=(_0x45cd4f<0x3?_0xbe1642(_0x421d6e):_0x45cd4f>0x3?_0xbe1642(_0x4c1e1c,_0x5d5090,_0x421d6e):_0xbe1642(_0x4c1e1c,_0x5d5090))||_0x421d6e;}return _0x45cd4f>0x3&&_0x421d6e&&Object[_0x4d3060(0x11c)](_0x4c1e1c,_0x5d5090,_0x421d6e),_0x421d6e;},__metadata=this&&this['__metadata']||function(_0x65c520,_0x3d08b2){const _0x3ee555=_0x168e;if(typeof Reflect===_0x3ee555(0x141)&&typeof Reflect[_0x3ee555(0x151)]===_0x3ee555(0xeb))return Reflect['metadata'](_0x65c520,_0x3d08b2);},__param=this&&this[_0x2a9767(0x121)]||function(_0x56459a,_0x4d14c7){return function(_0x1aefcc,_0xac1945){_0x4d14c7(_0x1aefcc,_0xac1945,_0x56459a);};};Object[_0x2a9767(0x11c)](exports,'__esModule',{'value':!![]}),exports['AuthService']=void 0x0;const user_constant_1=require(_0x2a9767(0x10d)),utils_1=require(_0x2a9767(0x138)),globalConfig_service_1=require(_0x2a9767(0xde)),common_1=require(_0x2a9767(0x100)),jwt_1=require(_0x2a9767(0x12a)),typeorm_1=require(_0x2a9767(0xfe)),bcrypt=require(_0x2a9767(0xe9)),os=require('os'),typeorm_2=require(_0x2a9767(0xf0)),config_entity_1=require(_0x2a9767(0x14b)),mailer_service_1=require(_0x2a9767(0xe1)),redisCache_service_1=require(_0x2a9767(0x122)),user_service_1=require(_0x2a9767(0x131)),userBalance_service_1=require(_0x2a9767(0xe7)),verification_service_1=require(_0x2a9767(0x12b));let AuthService=class AuthService{constructor(_0x564637,_0x388c78,_0x51882a,_0x480cc4,_0x2868ed,_0x1530bf,_0x36707b,_0x2f8013){const _0x16723b=_0x2a9767;this[_0x16723b(0xd4)]=_0x564637,this[_0x16723b(0x13c)]=_0x388c78,this[_0x16723b(0x14c)]=_0x51882a,this[_0x16723b(0x124)]=_0x480cc4,this[_0x16723b(0x127)]=_0x2868ed,this[_0x16723b(0x11d)]=_0x1530bf,this[_0x16723b(0xcd)]=_0x36707b,this[_0x16723b(0xf5)]=_0x2f8013;}async['onModuleInit'](){this['getIp']();}async['register'](_0x17f646,_0x540db6){const _0xb3a05c=_0x2a9767,{password:_0x8d5e5c,contact:_0x3149da,code:_0x2ed69a}=_0x17f646;let _0x2e2376='',_0x80dc74='';const _0x50b85f=/\S+@\S+\.\S+/[_0xb3a05c(0xe2)](_0x3149da),_0x536676=/^\d{10,}$/['test'](_0x3149da);common_1['Logger'][_0xb3a05c(0x109)]('Contact:\x20'+_0x3149da+',\x20isEmail:\x20'+_0x50b85f+_0xb3a05c(0x114)+_0x536676);let _0x411657=(0x0,utils_1[_0xb3a05c(0xf6)])();while(!![]){const _0x1487bb=await this[_0xb3a05c(0x13c)][_0xb3a05c(0x129)]({'username':_0x411657});common_1['Logger'][_0xb3a05c(0x109)]('Checking\x20if\x20username\x20'+_0x411657+'\x20is\x20taken:\x20'+_0x1487bb);if(_0x1487bb)break;_0x411657=(0x0,utils_1[_0xb3a05c(0xf6)])();}if(_0x50b85f){_0x2e2376=_0x3149da;const _0x210b1c=await this[_0xb3a05c(0x13c)][_0xb3a05c(0x129)]({'username':_0x411657,'email':_0x2e2376});common_1[_0xb3a05c(0xd8)][_0xb3a05c(0x109)](_0xb3a05c(0xf2)+_0x2e2376+_0xb3a05c(0xd1)+_0x210b1c);if(!_0x210b1c)throw new common_1['HttpException'](_0xb3a05c(0x14f),common_1[_0xb3a05c(0xc9)][_0xb3a05c(0xda)]);}else{if(_0x536676){_0x80dc74=_0x3149da;const _0x225264=await this[_0xb3a05c(0x13c)][_0xb3a05c(0x129)]({'username':_0x411657,'phone':_0x80dc74});common_1['Logger'][_0xb3a05c(0x109)]('Phone\x20'+_0x80dc74+'\x20is\x20available:\x20'+_0x225264);if(!_0x225264)throw new common_1[(_0xb3a05c(0xea))](_0xb3a05c(0x139),common_1[_0xb3a05c(0xc9)]['BAD_REQUEST']);}else throw new common_1[(_0xb3a05c(0xea))]('请提供有效的邮箱地址或手机号码。',common_1[_0xb3a05c(0xc9)][_0xb3a05c(0xda)]);}const _0x3f4baa=await this[_0xb3a05c(0xf5)]['getConfigs']([_0xb3a05c(0x117)]);common_1[_0xb3a05c(0xd8)][_0xb3a05c(0x109)]('noVerifyRegister:\x20'+_0x3f4baa);if(_0x3f4baa!=='1'){const _0x2e69e5=await this[_0xb3a05c(0xf5)][_0xb3a05c(0x126)](),_0x5c3161=_0x2e69e5+_0xb3a05c(0xe6)+_0x3149da,_0x171e70=await this[_0xb3a05c(0xcd)][_0xb3a05c(0x105)]({'key':_0x5c3161});common_1[_0xb3a05c(0xd8)][_0xb3a05c(0x109)]('Retrieved\x20redisCode\x20for\x20'+_0x3149da+':\x20'+_0x171e70);if(_0x2ed69a==='')throw new common_1[(_0xb3a05c(0xea))](_0xb3a05c(0x101),common_1[_0xb3a05c(0xc9)][_0xb3a05c(0xda)]);if(!_0x171e70){common_1['Logger'][_0xb3a05c(0xe8)](_0xb3a05c(0xd3)+_0x3149da,_0xb3a05c(0xfc));throw new common_1[(_0xb3a05c(0xea))](_0xb3a05c(0xf7),common_1[_0xb3a05c(0xc9)][_0xb3a05c(0xda)]);}if(_0x2ed69a!==_0x171e70){common_1['Logger'][_0xb3a05c(0xe8)]('验证码错误:\x20'+_0x3149da+'\x20输入的验证码:\x20'+_0x2ed69a+',\x20期望的验证码:\x20'+_0x171e70,_0xb3a05c(0xfc));throw new common_1[(_0xb3a05c(0xea))](_0xb3a05c(0x142),common_1[_0xb3a05c(0xc9)][_0xb3a05c(0xda)]);}}let _0x287c69;if(_0x50b85f)_0x287c69={'username':_0x411657,'password':_0x8d5e5c,'email':_0x3149da,'status':user_constant_1[_0xb3a05c(0x12f)][_0xb3a05c(0x102)]};else{const _0x4da378=(0x0,utils_1[_0xb3a05c(0xf6)])()+'@aiweb.com';_0x287c69={'username':_0x411657,'password':_0x8d5e5c,'email':_0x4da378,'phone':_0x3149da,'status':user_constant_1[_0xb3a05c(0x12f)][_0xb3a05c(0x102)]};}common_1[_0xb3a05c(0xd8)]['debug']('获取默认用户头像...');const _0x5ba228=await this[_0xb3a05c(0xf5)][_0xb3a05c(0x113)]([_0xb3a05c(0xd6)]);common_1['Logger']['debug'](_0xb3a05c(0x12d)+_0x5ba228),_0x287c69[_0xb3a05c(0xfb)]=_0x5ba228,common_1[_0xb3a05c(0xd8)][_0xb3a05c(0x109)](_0xb3a05c(0x12c));const _0x179353=bcrypt['hashSync'](_0x8d5e5c,0xa);_0x287c69[_0xb3a05c(0x148)]=_0x179353,common_1[_0xb3a05c(0xd8)]['debug'](_0xb3a05c(0x112));const _0x167523=await this['userService']['createUser'](_0x287c69);return common_1[_0xb3a05c(0xd8)][_0xb3a05c(0x109)](_0xb3a05c(0xdb)+_0x167523['id']),await this[_0xb3a05c(0x11d)][_0xb3a05c(0xe3)](_0x167523['id']),common_1[_0xb3a05c(0xd8)][_0xb3a05c(0x109)]('完成新用户余额处理'),{'success':!![],'message':_0xb3a05c(0x143)};}async[_0x2a9767(0x144)](_0x36cade,_0x55216a){const _0xaa19b3=_0x2a9767;console[_0xaa19b3(0xe8)](_0xaa19b3(0x147)+_0x36cade['username']);const _0x4e7c4c=await this[_0xaa19b3(0x13c)][_0xaa19b3(0x128)](_0x36cade);if(!_0x4e7c4c){console[_0xaa19b3(0x13b)](_0xaa19b3(0x134)+_0x36cade[_0xaa19b3(0xca)]);throw new common_1['HttpException'](_0xaa19b3(0xc8),common_1[_0xaa19b3(0xc9)][_0xaa19b3(0xf9)]);}const {username:_0x59a7c4,id:_0x3120f4,email:_0x27753a,role:_0x43e6d8,openId:_0x920fde,client:_0xa7c516,phone:_0x9853da}=_0x4e7c4c;console[_0xaa19b3(0xe8)](_0xaa19b3(0xee)+_0x3120f4+_0xaa19b3(0xcc)+_0x59a7c4);const _0x7c1c05=(0x0,utils_1['getClientIp'])(_0x55216a);await this[_0xaa19b3(0x13c)]['savaLoginIp'](_0x3120f4,_0x7c1c05),console['log'](_0xaa19b3(0x140)+_0x7c1c05+_0xaa19b3(0x153)+_0x3120f4);const _0x200605=await this[_0xaa19b3(0x14c)][_0xaa19b3(0x13a)]({'username':_0x59a7c4,'id':_0x3120f4,'email':_0x27753a,'role':_0x43e6d8,'openId':_0x920fde,'client':_0xa7c516,'phone':_0x9853da});return console[_0xaa19b3(0xe8)]('JWT令牌生成成功\x20-\x20用户ID:\x20'+_0x3120f4),await this['redisCacheService'][_0xaa19b3(0xc1)](_0x3120f4,_0x200605),console[_0xaa19b3(0xe8)](_0xaa19b3(0x13f)+_0x3120f4),_0x200605;}async[_0x2a9767(0x146)](_0x1a52e9,_0x2d1413){const _0x3cf11f=_0x2a9767,{contact:_0x15b81c,code:_0x32966d}=_0x1a52e9;let _0x101a85='',_0x40bb06='';const _0x668fd2=/\S+@\S+\.\S+/[_0x3cf11f(0xe2)](_0x15b81c),_0x3736d7=/^\d{10,}$/[_0x3cf11f(0xe2)](_0x15b81c);if(_0x668fd2)_0x101a85=_0x15b81c;else{if(_0x3736d7)_0x40bb06=_0x15b81c;else throw new common_1[(_0x3cf11f(0xea))](_0x3cf11f(0x136),common_1[_0x3cf11f(0xc9)]['BAD_REQUEST']);}if(!![]){if(_0x668fd2){const _0x5d7af1=await this[_0x3cf11f(0x13c)][_0x3cf11f(0x129)]({'email':_0x15b81c});if(_0x5d7af1)throw new common_1[(_0x3cf11f(0xea))](_0x3cf11f(0xf1),common_1[_0x3cf11f(0xc9)][_0x3cf11f(0xda)]);}else{if(_0x3736d7){const _0x10d572=await this[_0x3cf11f(0x13c)][_0x3cf11f(0x129)]({'phone':_0x15b81c});if(_0x10d572)throw new common_1['HttpException']('该手机号未注册，请先注册！',common_1[_0x3cf11f(0xc9)][_0x3cf11f(0xda)]);}}}else{if(_0x668fd2){const _0x2a231c=await this[_0x3cf11f(0x13c)][_0x3cf11f(0x129)]({'email':_0x15b81c});if(!_0x2a231c)throw new common_1['HttpException']('该邮箱已注册，请直接登录！',common_1[_0x3cf11f(0xc9)]['BAD_REQUEST']);}else{if(_0x3736d7){const _0x5214f9=await this[_0x3cf11f(0x13c)][_0x3cf11f(0x129)]({'phone':_0x15b81c});if(!_0x5214f9)throw new common_1[(_0x3cf11f(0xea))]('该手机号已注册，请直接登录！',common_1['HttpStatus'][_0x3cf11f(0xda)]);}}}const _0x4cb311=await this['globalConfigService']['getNamespace'](),_0x5da612=_0x4cb311+_0x3cf11f(0xe6)+_0x15b81c,_0x2d34f8=await this[_0x3cf11f(0xcd)][_0x3cf11f(0x105)]({'key':_0x5da612});if(!_0x2d34f8){common_1[_0x3cf11f(0xd8)][_0x3cf11f(0xe8)]('验证码过期:\x20'+_0x15b81c,_0x3cf11f(0xfc));throw new common_1[(_0x3cf11f(0xea))](_0x3cf11f(0xf7),common_1[_0x3cf11f(0xc9)][_0x3cf11f(0xda)]);}if(_0x2d34f8!==_0x32966d){common_1[_0x3cf11f(0xd8)][_0x3cf11f(0xe8)](_0x3cf11f(0x111)+_0x15b81c,'authService');throw new common_1[(_0x3cf11f(0xea))]('验证码错误，请重新输入！',common_1[_0x3cf11f(0xc9)][_0x3cf11f(0xda)]);}const _0x5be1dc=await this[_0x3cf11f(0x13c)][_0x3cf11f(0xf3)]({'email':_0x101a85,'phone':_0x40bb06});if(!_0x5be1dc)throw new common_1[(_0x3cf11f(0xea))](_0x3cf11f(0xc4),common_1['HttpStatus'][_0x3cf11f(0x110)]);if(_0x5be1dc[_0x3cf11f(0x10c)]!==user_constant_1['UserStatusEnum']['ACTIVE'])throw new common_1[(_0x3cf11f(0xea))](user_constant_1['UserStatusErrMsg'][_0x5be1dc[_0x3cf11f(0x10c)]],common_1[_0x3cf11f(0xc9)]['BAD_REQUEST']);const {username:_0x530506,id:_0x337cc7,role:_0x5c51b1,openId:_0x161918,client:_0xec20ac}=_0x5be1dc,_0x5c5945=(0x0,utils_1[_0x3cf11f(0x14d)])(_0x2d1413);await this['userService'][_0x3cf11f(0xd2)](_0x337cc7,_0x5c5945);const _0x3273d9=await this[_0x3cf11f(0x14c)][_0x3cf11f(0x13a)]({'username':_0x530506,'id':_0x337cc7,'email':_0x101a85,'role':_0x5c51b1,'openId':_0x161918,'client':_0xec20ac,'phone':_0x40bb06});return await this[_0x3cf11f(0xcd)][_0x3cf11f(0xc1)](_0x337cc7,_0x3273d9),await this[_0x3cf11f(0xcd)][_0x3cf11f(0xe0)](_0x5da612),_0x3273d9;}async[_0x2a9767(0x104)](_0x16f48f,_0x4378b7){const _0x31a3cf=_0x2a9767,{status:_0x576f11}=_0x16f48f;if(_0x576f11!==user_constant_1[_0x31a3cf(0x12f)][_0x31a3cf(0x102)])throw new common_1['HttpException'](user_constant_1[_0x31a3cf(0x120)][_0x576f11],common_1[_0x31a3cf(0xc9)][_0x31a3cf(0xda)]);const {username:_0x203788,id:_0x5bda36,email:_0x5b61ee,role:_0x428e7b,openId:_0x32dcbf,client:_0x56b6d2}=_0x16f48f,_0x4f4fb9=(0x0,utils_1[_0x31a3cf(0x14d)])(_0x4378b7);await this[_0x31a3cf(0x13c)]['savaLoginIp'](_0x5bda36,_0x4f4fb9);const _0x35e7d5=await this[_0x31a3cf(0x14c)][_0x31a3cf(0x13a)]({'username':_0x203788,'id':_0x5bda36,'email':_0x5b61ee,'role':_0x428e7b,'openId':_0x32dcbf,'client':_0x56b6d2});return await this[_0x31a3cf(0xcd)][_0x31a3cf(0xc1)](_0x5bda36,_0x35e7d5),_0x35e7d5;}async['getInfo'](_0x4b5a02){const _0x4f0f47=_0x2a9767,{id:_0x38e9b5}=_0x4b5a02[_0x4f0f47(0x115)];return await this[_0x4f0f47(0x13c)][_0x4f0f47(0x14e)](_0x38e9b5);}async[_0x2a9767(0x133)](_0x397562,_0x2a737b){const _0x203df6=_0x2a9767,{id:_0x336429}=_0x397562[_0x203df6(0x115)];return this[_0x203df6(0x13c)][_0x203df6(0x11e)](_0x336429,_0x2a737b[_0x203df6(0x148)]),_0x203df6(0xf4);}[_0x2a9767(0x119)](){const _0x2d33aa=_0x2a9767;let _0x116f1c;const _0x2ca8a0=os['networkInterfaces']();Object[_0x2d33aa(0xed)](_0x2ca8a0)['forEach'](_0x7775da=>{const _0x2423ee=_0x2d33aa,_0x10979c=_0x2ca8a0[_0x7775da];for(let _0x15d79b=0x0;_0x15d79b<_0x10979c[_0x2423ee(0xff)];_0x15d79b++){const _0x5e2820=_0x10979c[_0x15d79b];if(_0x5e2820[_0x2423ee(0xf8)]===_0x2423ee(0xce)&&_0x5e2820[_0x2423ee(0x123)]!==_0x2423ee(0xbf)&&!_0x5e2820[_0x2423ee(0x150)]){_0x116f1c=_0x5e2820[_0x2423ee(0x123)];break;}}}),this[_0x2d33aa(0xef)]=_0x116f1c;}async[_0x2a9767(0x130)](_0x5eb4fb){const _0x1fab1d=_0x2a9767,{contact:_0xbf8796,isLogin:_0x153a4f}=_0x5eb4fb,_0x400bde=(0x0,utils_1[_0x1fab1d(0x13e)])(),_0x295340=/\S+@\S+\.\S+/[_0x1fab1d(0xe2)](_0xbf8796),_0x42a1be=/^1\d{10}$/[_0x1fab1d(0xe2)](_0xbf8796);if(!_0x295340&&!_0x42a1be)throw new common_1[(_0x1fab1d(0xea))](_0x1fab1d(0x136),common_1[_0x1fab1d(0xc9)][_0x1fab1d(0xda)]);if(_0x153a4f){if(_0x295340){const _0x4410ac=await this[_0x1fab1d(0x13c)]['verifyUserRegister']({'email':_0xbf8796});if(_0x4410ac)throw new common_1[(_0x1fab1d(0xea))](_0x1fab1d(0xf1),common_1[_0x1fab1d(0xc9)]['BAD_REQUEST']);}else{if(_0x42a1be){const _0x348fbf=await this[_0x1fab1d(0x13c)]['verifyUserRegister']({'phone':_0xbf8796});if(_0x348fbf)throw new common_1['HttpException']('该手机号未注册，请先注册！',common_1['HttpStatus'][_0x1fab1d(0xda)]);}}}else{if(_0x295340){const _0x1ec66c=await this['userService']['verifyUserRegister']({'email':_0xbf8796});if(!_0x1ec66c)throw new common_1[(_0x1fab1d(0xea))]('该邮箱已注册，请直接登录！',common_1[_0x1fab1d(0xc9)]['BAD_REQUEST']);}else{if(_0x42a1be){const _0x3a66f4=await this[_0x1fab1d(0x13c)][_0x1fab1d(0x129)]({'phone':_0xbf8796});if(!_0x3a66f4)throw new common_1[(_0x1fab1d(0xea))](_0x1fab1d(0xdc),common_1[_0x1fab1d(0xc9)][_0x1fab1d(0xda)]);}}}const _0x23e2d2=await this[_0x1fab1d(0xf5)][_0x1fab1d(0x126)](),_0x18c16e=_0x23e2d2+_0x1fab1d(0xe6)+_0xbf8796,_0x4d4ee7=_0x23e2d2+':RATE_LIMIT:'+_0xbf8796,_0x18dce9=await this[_0x1fab1d(0xcd)]['ttl'](_0x18c16e);if(_0x18dce9&&_0x18dce9>0x0)throw new common_1['HttpException'](_0x18dce9+_0x1fab1d(0x10f),common_1[_0x1fab1d(0xc9)]['BAD_REQUEST']);const _0x95d0d8=await this[_0x1fab1d(0xcd)]['get']({'key':_0x4d4ee7})||0x0;if(_0x95d0d8>=0xa)throw new common_1[(_0x1fab1d(0xea))](_0x1fab1d(0x103),common_1[_0x1fab1d(0xc9)]['TOO_MANY_REQUESTS']);if(_0x295340)await this[_0x1fab1d(0x124)]['sendMail']({'to':_0xbf8796,'context':{'code':_0x400bde}});else{if(_0x42a1be){const _0x3082bd={'phone':_0xbf8796,'code':_0x400bde};await this[_0x1fab1d(0x127)][_0x1fab1d(0xc7)](_0x3082bd);}}return await this['redisCacheService']['set']({'key':_0x18c16e,'val':_0x400bde},0x5*0x3c),await this['redisCacheService'][_0x1fab1d(0x11f)]({'key':_0x4d4ee7,'val':Number(_0x95d0d8)+0x1},0x18*0x3c*0x3c),await this[_0x1fab1d(0xcd)][_0x1fab1d(0x11f)]({'key':_0x18c16e,'val':_0x400bde},0x3c),_0x1fab1d(0xcb)+(_0x153a4f?'注册':'验证')+'！';}[_0x2a9767(0x137)](_0x3e3e10){const _0x3d31bc=_0x2a9767,_0x4b9924=this['jwtService'][_0x3d31bc(0x13a)]({'username':'游客'+_0x3e3e10,'id':_0x3e3e10,'email':_0x3e3e10+_0x3d31bc(0x135),'role':_0x3d31bc(0xc2),'openId':null,'client':null});return _0x4b9924;}async[_0x2a9767(0xc3)](_0x117051,_0x19cfab){const _0x1d96e4=_0x2a9767;common_1[_0x1d96e4(0xd8)]['debug']('开始实名认证流程');const {name:_0x4b52b9,idCard:_0x7b1514}=_0x19cfab,{id:_0xc77472}=_0x117051['user'];try{const _0x32714d=await this[_0x1d96e4(0x127)][_0x1d96e4(0xc3)](_0x19cfab);common_1[_0x1d96e4(0xd8)][_0x1d96e4(0x109)]('实名认证结果:\x20'+_0x32714d);if(!_0x32714d)throw new common_1[(_0x1d96e4(0xea))](_0x1d96e4(0xfa),common_1[_0x1d96e4(0xc9)][_0x1d96e4(0xda)]);return await this[_0x1d96e4(0x13c)][_0x1d96e4(0xdf)](_0xc77472,_0x4b52b9,_0x7b1514),'认证成功';}catch(_0x3194f9){common_1[_0x1d96e4(0xd8)][_0x1d96e4(0x13b)](_0x1d96e4(0x10a),_0x3194f9);throw new common_1[(_0x1d96e4(0xea))](_0x1d96e4(0xd9),common_1[_0x1d96e4(0xc9)][_0x1d96e4(0xda)]);}}async[_0x2a9767(0xc6)](_0x289c80,_0x45409d){const _0x154865=_0x2a9767;common_1[_0x154865(0xd8)][_0x154865(0x109)]('开始手机号认证流程');const {phone:_0x278bb8,username:_0xacfe3f,password:_0x54113b,code:_0x3e176f}=_0x45409d,{id:_0x2d1078}=_0x289c80['user'],_0x4673db=this['globalConfigService']['getNamespace'](),_0x59b570=_0x4673db+_0x154865(0xe6)+_0x278bb8,_0x1e2030=await this[_0x154865(0xcd)]['get']({'key':_0x59b570});common_1[_0x154865(0xd8)][_0x154865(0x109)]('Retrieved\x20redisCode\x20for\x20'+_0x278bb8+':\x20'+_0x1e2030);if(_0x3e176f==='')throw new common_1[(_0x154865(0xea))](_0x154865(0x101),common_1[_0x154865(0xc9)][_0x154865(0xda)]);if(!_0x1e2030){common_1['Logger'][_0x154865(0xe8)](_0x154865(0xd3)+_0x278bb8,_0x154865(0xfc));throw new common_1['HttpException']('验证码已过期，请重新发送！',common_1['HttpStatus'][_0x154865(0xda)]);}if(_0x3e176f!==_0x1e2030){common_1[_0x154865(0xd8)][_0x154865(0xe8)](_0x154865(0x111)+_0x278bb8+_0x154865(0x145)+_0x3e176f+_0x154865(0x118)+_0x1e2030,_0x154865(0xfc));throw new common_1[(_0x154865(0xea))](_0x154865(0x142),common_1[_0x154865(0xc9)][_0x154865(0xda)]);}if(_0xacfe3f){const _0xaf73b=await this[_0x154865(0x13c)][_0x154865(0xc5)](_0x45409d['username'],_0x2d1078);if(_0xaf73b)throw new common_1[(_0x154865(0xea))](_0x154865(0xd7),common_1['HttpStatus']['BAD_REQUEST']);}try{return await this['userService']['updateUserPhone'](_0x2d1078,_0x278bb8,_0xacfe3f,_0x54113b),_0x154865(0x152);}catch(_0x2f9a43){common_1[_0x154865(0xd8)]['error']('验证过程出现错误',_0x2f9a43);throw new common_1[(_0x154865(0xea))](_0x154865(0x149),common_1[_0x154865(0xc9)][_0x154865(0xda)]);}}};AuthService=__decorate([(0x0,common_1[_0x2a9767(0x12e)])(),__param(0x0,(0x0,typeorm_1[_0x2a9767(0x132)])(config_entity_1['ConfigEntity'])),__metadata(_0x2a9767(0x14a),[typeorm_2[_0x2a9767(0x116)],user_service_1[_0x2a9767(0xec)],jwt_1[_0x2a9767(0x108)],mailer_service_1['MailerService'],verification_service_1['VerificationService'],userBalance_service_1[_0x2a9767(0xe4)],redisCache_service_1[_0x2a9767(0xe5)],globalConfig_service_1['GlobalConfigService']])],AuthService),exports[_0x2a9767(0x13d)]=AuthService;