'use strict';const _0x5d95e=_0x20a3;(function(_0x8ded60,_0x4ee061){const _0x2a4e2f=_0x20a3,_0x37783a=_0x8ded60();while(!![]){try{const _0x33d697=-parseInt(_0x2a4e2f(0x85))/0x1+-parseInt(_0x2a4e2f(0xb9))/0x2*(parseInt(_0x2a4e2f(0xa7))/0x3)+-parseInt(_0x2a4e2f(0xbc))/0x4*(-parseInt(_0x2a4e2f(0xae))/0x5)+parseInt(_0x2a4e2f(0xd1))/0x6+parseInt(_0x2a4e2f(0x90))/0x7+parseInt(_0x2a4e2f(0x77))/0x8+parseInt(_0x2a4e2f(0xca))/0x9;if(_0x33d697===_0x4ee061)break;else _0x37783a['push'](_0x37783a['shift']());}catch(_0x4a6784){_0x37783a['push'](_0x37783a['shift']());}}}(_0x526d,0xe291c));var __decorate=this&&this[_0x5d95e(0xc5)]||function(_0x305679,_0x55248e,_0x2884bf,_0x2761b8){const _0x4bd165=_0x5d95e;var _0x1151d5=arguments[_0x4bd165(0x95)],_0x5008a6=_0x1151d5<0x3?_0x55248e:_0x2761b8===null?_0x2761b8=Object[_0x4bd165(0xa9)](_0x55248e,_0x2884bf):_0x2761b8,_0x34bf0c;if(typeof Reflect==='object'&&typeof Reflect[_0x4bd165(0xaa)]===_0x4bd165(0xd6))_0x5008a6=Reflect[_0x4bd165(0xaa)](_0x305679,_0x55248e,_0x2884bf,_0x2761b8);else{for(var _0x443082=_0x305679[_0x4bd165(0x95)]-0x1;_0x443082>=0x0;_0x443082--)if(_0x34bf0c=_0x305679[_0x443082])_0x5008a6=(_0x1151d5<0x3?_0x34bf0c(_0x5008a6):_0x1151d5>0x3?_0x34bf0c(_0x55248e,_0x2884bf,_0x5008a6):_0x34bf0c(_0x55248e,_0x2884bf))||_0x5008a6;}return _0x1151d5>0x3&&_0x5008a6&&Object[_0x4bd165(0xb4)](_0x55248e,_0x2884bf,_0x5008a6),_0x5008a6;},__metadata=this&&this[_0x5d95e(0xd8)]||function(_0x215ed2,_0x4a54f8){const _0x341294=_0x5d95e;if(typeof Reflect===_0x341294(0x93)&&typeof Reflect['metadata']===_0x341294(0xd6))return Reflect[_0x341294(0xd0)](_0x215ed2,_0x4a54f8);},__param=this&&this[_0x5d95e(0xb0)]||function(_0x5756d6,_0x2b8440){return function(_0x18823f,_0xa5ea99){_0x2b8440(_0x18823f,_0xa5ea99,_0x5756d6);};};function _0x20a3(_0x371e05,_0x53a269){const _0x526de3=_0x526d();return _0x20a3=function(_0x20a3b8,_0x11f5d4){_0x20a3b8=_0x20a3b8-0x76;let _0x592251=_0x526de3[_0x20a3b8];return _0x592251;},_0x20a3(_0x371e05,_0x53a269);}Object[_0x5d95e(0xb4)](exports,_0x5d95e(0xb1),{'value':!![]}),exports[_0x5d95e(0x88)]=void 0x0;const status_constant_1=require(_0x5d95e(0xa1)),utils_1=require(_0x5d95e(0xbb)),common_1=require('@nestjs/common'),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require('typeorm'),models_entity_1=require(_0x5d95e(0xce));let ModelsService=class ModelsService{constructor(_0x59a3d6){const _0x54ca8f=_0x5d95e;this[_0x54ca8f(0xc1)]=_0x59a3d6,this[_0x54ca8f(0x9f)]=[],this[_0x54ca8f(0xc0)]={},this[_0x54ca8f(0x8a)]={},this[_0x54ca8f(0x81)]={},this['keyPoolIndexMap']={};}async[_0x5d95e(0x9c)](){const _0x26ce77=_0x5d95e;await this[_0x26ce77(0xa6)]();}async['initCalcKey'](){const _0x9b6bcd=_0x5d95e;this[_0x9b6bcd(0x81)]={},this[_0x9b6bcd(0xac)]={},this[_0x9b6bcd(0x8a)]={},this[_0x9b6bcd(0xc0)]={},this[_0x9b6bcd(0x9f)]=[];const _0x2d603f=await this[_0x9b6bcd(0xc1)]['find']({'where':{'status':!![]}}),_0x25e304=_0x2d603f[_0x9b6bcd(0x79)]((_0x37f349,_0x154b5e)=>{const _0x2d9567=_0x9b6bcd;return!_0x37f349[_0x154b5e[_0x2d9567(0xb8)]]?_0x37f349[_0x154b5e[_0x2d9567(0xb8)]]=[_0x154b5e]:_0x37f349[_0x154b5e[_0x2d9567(0xb8)]][_0x2d9567(0x96)](_0x154b5e),_0x37f349;},{});this[_0x9b6bcd(0x9f)]=Object['keys'](_0x25e304)[_0x9b6bcd(0x89)](_0x4710c8=>{return{'label':status_constant_1['ModelsMapCn'][_0x4710c8],'val':_0x4710c8};}),this[_0x9b6bcd(0xc0)]=_0x25e304,this[_0x9b6bcd(0x8a)]={},_0x2d603f[_0x9b6bcd(0x78)](_0x506e71=>{const _0x2103fb=_0x9b6bcd,{keyType:_0x4184cc,model:_0x394239}=_0x506e71;if(!this[_0x2103fb(0x81)][_0x394239])this[_0x2103fb(0x81)][_0x394239]=[];this[_0x2103fb(0x81)][_0x394239][_0x2103fb(0x96)](_0x506e71);if(!this['keyPoolIndexMap'][_0x394239])this[_0x2103fb(0xac)][_0x394239]=0x0;if(!this[_0x2103fb(0x8a)][_0x4184cc])this[_0x2103fb(0x8a)][_0x4184cc]={};if(!this[_0x2103fb(0x8a)][_0x4184cc][_0x394239])this[_0x2103fb(0x8a)][_0x4184cc][_0x394239]=[];this[_0x2103fb(0x8a)][_0x4184cc][_0x394239][_0x2103fb(0x96)](_0x506e71);});}async[_0x5d95e(0x8d)](_0xf440e9,_0x1c35fe,_0x2b7d14=-0x1){const _0x5d79e7=_0x5d95e,_0x4aa9f9=await this[_0x5d79e7(0xc1)][_0x5d79e7(0xc7)]({'id':_0xf440e9},{'status':![],'keyStatus':_0x2b7d14,'remark':_0x1c35fe});common_1['Logger'][_0x5d79e7(0x83)](_0x5d79e7(0x99)+_0xf440e9+_0x5d79e7(0xc8)),this[_0x5d79e7(0xa6)]();}async[_0x5d95e(0xbe)](_0x7ee175){const _0x30962a=_0x5d95e;let _0x2ba543=await this[_0x30962a(0xc1)][_0x30962a(0x86)]({'where':{'model':_0x7ee175}});if(!_0x2ba543)return null;return _0x2ba543;}async[_0x5d95e(0x7b)](_0x2eb6e0){const _0x4ba4fe=_0x5d95e,_0xf5a602=await this[_0x4ba4fe(0xc1)][_0x4ba4fe(0xcb)]({'where':{'model':(0x0,typeorm_2[_0x4ba4fe(0xab)])(_0x2eb6e0+'%')}});if(_0xf5a602[_0x4ba4fe(0x95)]===0x0)throw new common_1[(_0x4ba4fe(0x9e))](_0x4ba4fe(0x82),common_1[_0x4ba4fe(0xbd)][_0x4ba4fe(0x9a)]);const _0x210a5d=_0xf5a602[0x0],_0x41fbcb=_0x210a5d[_0x4ba4fe(0xd7)][_0x4ba4fe(0xd2)](_0x2eb6e0,''),_0x5b09be=Object[_0x4ba4fe(0x80)](Object[_0x4ba4fe(0x80)]({},_0x210a5d),{'model':_0x41fbcb});return _0x5b09be;}async['getBaseConfig'](){const _0x4c3eeb=_0x5d95e;if(!this[_0x4c3eeb(0x9f)][_0x4c3eeb(0x95)]||!Object['keys'](this['modelMaps'])[_0x4c3eeb(0x95)])return;const {keyType:_0x1ddb27,modelName:_0x3517b0,model:_0x51db51,deductType:_0x370774,deduct:_0x49a579,isFileUpload:_0x5e84e0,modelAvatar:_0x210c6e,modelDescription:_0x33a76c}=this['modelMaps'][0x1][0x0];return{'modelInfo':{'keyType':_0x1ddb27,'modelName':_0x3517b0,'model':_0x51db51,'deductType':_0x370774,'deduct':_0x49a579,'isFileUpload':_0x5e84e0,'modelAvatar':_0x210c6e,'modelDescription':_0x33a76c}};}async[_0x5d95e(0x9d)](_0x4d0341){const _0x296e5f=_0x5d95e;try{isNaN(_0x4d0341[_0x296e5f(0xb7)])&&(_0x4d0341[_0x296e5f(0xb7)]=null);const {id:_0x127986}=_0x4d0341;_0x4d0341['status']&&(_0x4d0341[_0x296e5f(0xba)]=0x1);if(_0x127986){const _0x10a027=await this[_0x296e5f(0xc1)][_0x296e5f(0xc7)]({'id':_0x127986},_0x4d0341);return await this[_0x296e5f(0xa6)](),_0x10a027[_0x296e5f(0xaf)]>0x0;}else{const {keyType:_0xa875b4,key:_0x12dec5}=_0x4d0341;if(Number(_0xa875b4!==0x1)){const _0x346790=await this[_0x296e5f(0xc1)]['save'](_0x4d0341);return await this['initCalcKey'](),_0x346790;}else{const _0x401e7a=_0x12dec5[_0x296e5f(0x89)](_0x146c53=>{const _0x26e6c6=_0x296e5f;try{const _0xf7363d=JSON[_0x26e6c6(0x7c)](JSON[_0x26e6c6(0xc2)](_0x4d0341));return _0xf7363d[_0x26e6c6(0x84)]=_0x146c53,isNaN(_0xf7363d['timeout'])&&(_0xf7363d[_0x26e6c6(0xb7)]=null),_0xf7363d;}catch(_0x2acc26){console[_0x26e6c6(0xad)](_0x26e6c6(0x92),_0x2acc26);}}),_0x2040b3=await this[_0x296e5f(0xc1)][_0x296e5f(0x9b)](_0x401e7a);return await this[_0x296e5f(0xa6)](),_0x2040b3;}}}catch(_0x563beb){console[_0x296e5f(0xad)](_0x296e5f(0x8f),_0x563beb);}}async[_0x5d95e(0xcc)]({id:_0x4b9b75}){const _0x446ef9=_0x5d95e;if(!_0x4b9b75)throw new common_1['HttpException'](_0x446ef9(0x7e),common_1[_0x446ef9(0xbd)][_0x446ef9(0x9a)]);const _0xc484c3=await this['modelsEntity'][_0x446ef9(0x86)]({'where':{'id':_0x4b9b75}});if(!_0xc484c3)throw new common_1[(_0x446ef9(0x9e))](_0x446ef9(0xcf),common_1[_0x446ef9(0xbd)][_0x446ef9(0x9a)]);const _0x5cc9f4=await this[_0x446ef9(0xc1)]['delete']({'id':_0x4b9b75});return await this[_0x446ef9(0xa6)](),_0x5cc9f4;}async[_0x5d95e(0xd5)](_0x55e4e2,_0x31328b){const _0x100de9=_0x5d95e,{role:_0x53b698}=_0x55e4e2[_0x100de9(0xd9)],{keyType:_0x10402f,key:_0x20ba87,status:_0x3e315f,model:_0x2b85f6,page:page=0x1,size:size=0xa}=_0x31328b;let _0x5aca5b={};_0x10402f&&(_0x5aca5b[_0x100de9(0xb8)]=_0x10402f),_0x2b85f6&&(_0x5aca5b['model']=_0x2b85f6),_0x3e315f&&(_0x5aca5b[_0x100de9(0xc6)]=Number(_0x3e315f)===0x1?!![]:![]),_0x20ba87&&(_0x5aca5b[_0x100de9(0x84)]=(0x0,typeorm_2[_0x100de9(0xab)])('%'+_0x20ba87+'%'));const [_0x338017,_0x10d151]=await this['modelsEntity'][_0x100de9(0xa5)]({'where':_0x5aca5b,'order':{'modelOrder':_0x100de9(0x97)},'skip':(page-0x1)*size,'take':size});return _0x53b698!==_0x100de9(0x7f)&&_0x338017[_0x100de9(0x78)](_0x26aaa3=>{const _0x546f37=_0x100de9;_0x26aaa3[_0x546f37(0x84)]&&(_0x26aaa3[_0x546f37(0x84)]=(0x0,utils_1[_0x546f37(0xb5)])(_0x26aaa3[_0x546f37(0x84)]));}),{'rows':_0x338017,'count':_0x10d151};}async[_0x5d95e(0xb6)](){const _0x4437f0=_0x5d95e,_0x4cd115=JSON['parse'](JSON[_0x4437f0(0xc2)](this['modelMaps']));return Object[_0x4437f0(0x94)](_0x4cd115)['forEach'](_0x5edc57=>{const _0x1f0421=_0x4437f0;_0x4cd115[_0x5edc57]=_0x4cd115[_0x5edc57][_0x1f0421(0xd4)](_0x4bfaa1=>_0x4bfaa1[_0x1f0421(0xba)]===0x1)[_0x1f0421(0xd3)]((_0x1b8e3a,_0x57c9af)=>_0x1b8e3a[_0x1f0421(0x7d)]-_0x57c9af[_0x1f0421(0x7d)]),_0x4cd115[_0x5edc57]=Array['from'](_0x4cd115[_0x5edc57][_0x1f0421(0x89)](_0x3486f5=>{const {modelName:_0x263556,keyType:_0x69adc8,model:_0x2113cc,deduct:_0x2c0162,deductType:_0x17ef19,maxRounds:_0x240953,modelAvatar:_0x19abaa,isFileUpload:_0x270cea,modelDescription:_0x37810f}=_0x3486f5;return{'modelName':_0x263556,'keyType':_0x69adc8,'model':_0x2113cc,'deduct':_0x2c0162,'deductType':_0x17ef19,'maxRounds':_0x240953,'modelAvatar':_0x19abaa,'isFileUpload':_0x270cea,'modelDescription':_0x37810f};})[_0x1f0421(0x79)]((_0x483fae,_0x485614)=>_0x483fae[_0x1f0421(0xc4)](_0x485614[_0x1f0421(0x87)],_0x485614),new Map())[_0x1f0421(0x91)]());}),{'modelTypeList':this[_0x4437f0(0x9f)],'modelMaps':_0x4cd115};}async[_0x5d95e(0x8b)](){const _0x558d6f=_0x5d95e,_0x53742b=await this['modelsEntity'][_0x558d6f(0x86)]({'where':{'model':_0x558d6f(0xc3)}});return _0x53742b?{'modelName':_0x53742b[_0x558d6f(0x87)],'model':_0x53742b[_0x558d6f(0xd7)],'deduct':_0x53742b['deduct'],'deductType':_0x53742b[_0x558d6f(0xa8)]}:null;}async[_0x5d95e(0xa4)](_0xa4f606,_0x57cf2b){const _0x2d09f9=_0x5d95e;await this[_0x2d09f9(0xc1)][_0x2d09f9(0x7a)]()[_0x2d09f9(0xc7)](models_entity_1[_0x2d09f9(0xa3)])[_0x2d09f9(0xc4)]({'useCount':()=>_0x2d09f9(0xb2),'useToken':()=>'useToken\x20+\x20'+_0x57cf2b})[_0x2d09f9(0x76)]('id\x20=\x20:id',{'id':_0xa4f606})[_0x2d09f9(0xa0)]();}async[_0x5d95e(0xa2)](){const _0x57d3df=_0x5d95e;return await this[_0x57d3df(0xc1)]['find']();}async['queryModelType'](_0x109931){return 0x1;}async[_0x5d95e(0xcd)](_0x465db2){return 0x1;}async[_0x5d95e(0x8c)](_0x698f43){return 0x1;}async[_0x5d95e(0xb3)](_0x3c3cc7){const _0x21f7f9=await this['modelsEntity']['findOne']({'where':{'model':_0x3c3cc7,'status':!![],'keyStatus':0x1}});return _0x21f7f9;}};ModelsService=__decorate([(0x0,common_1[_0x5d95e(0xc9)])(),__param(0x0,(0x0,typeorm_1[_0x5d95e(0x8e)])(models_entity_1[_0x5d95e(0xa3)])),__metadata(_0x5d95e(0xbf),[typeorm_2[_0x5d95e(0x98)]])],ModelsService),exports[_0x5d95e(0x88)]=ModelsService;function _0x526d(){const _0x211c05=['modelsList','timeout','keyType','63508aRkgql','keyStatus','../../common/utils','1262276DvRUNa','HttpStatus','getCurrentModelKeyInfo','design:paramtypes','modelMaps','modelsEntity','stringify','midjourney','set','__decorate','status','update','\x20欠费或被官方封禁导致不可用，已被系统自动锁定','Injectable','3976110SSBmFy','find','delModel','setModelType','./models.entity','当前账号不存在！','metadata','9041358UWXtFx','replace','sort','filter','queryModels','function','model','__metadata','user','where','324856wkLLcp','forEach','reduce','createQueryBuilder','getSpecialModelKeyInfo','parse','modelOrder','缺失必要参数！','super','assign','keyPoolMap','未找到匹配的模型，请重新选择模型！','error','key','1072947PriTwZ','findOne','modelName','ModelsService','map','keyList','getMjInfo','delModelType','lockKey','InjectRepository','error:\x20','9653546DLQMlu','values','parse\x20error:\x20','object','keys','length','push','ASC','Repository','key:\x20','BAD_REQUEST','save','onModuleInit','setModel','HttpException','modelTypes','execute','../../common/constants/status.constant','getAllKey','ModelsEntity','saveUseLog','findAndCount','initCalcKey','159TAJcwS','deductType','getOwnPropertyDescriptor','decorate','Like','keyPoolIndexMap','log','5pAqmvJ','affected','__param','__esModule','useCount\x20+\x201','getModelConfigByName','defineProperty','hideString'];_0x526d=function(){return _0x211c05;};return _0x526d();}