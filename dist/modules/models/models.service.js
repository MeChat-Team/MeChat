'use strict';const _0x5d71b3=_0xa1f5;(function(_0x5aa85c,_0x15854c){const _0x12cc50=_0xa1f5,_0x3d73fc=_0x5aa85c();while(!![]){try{const _0x23f0b6=-parseInt(_0x12cc50(0xc1))/0x1+-parseInt(_0x12cc50(0xd6))/0x2*(-parseInt(_0x12cc50(0xac))/0x3)+parseInt(_0x12cc50(0x99))/0x4*(parseInt(_0x12cc50(0x97))/0x5)+-parseInt(_0x12cc50(0x9f))/0x6+-parseInt(_0x12cc50(0xc5))/0x7*(parseInt(_0x12cc50(0xa0))/0x8)+parseInt(_0x12cc50(0xc8))/0x9+parseInt(_0x12cc50(0xb7))/0xa;if(_0x23f0b6===_0x15854c)break;else _0x3d73fc['push'](_0x3d73fc['shift']());}catch(_0x4ce04a){_0x3d73fc['push'](_0x3d73fc['shift']());}}}(_0x4feb,0x554cc));var __decorate=this&&this[_0x5d71b3(0xb5)]||function(_0x3f65d8,_0x55afd2,_0x13ab6b,_0x48eac4){const _0x31ad51=_0x5d71b3;var _0xd0f7fe=arguments[_0x31ad51(0xa4)],_0x3be891=_0xd0f7fe<0x3?_0x55afd2:_0x48eac4===null?_0x48eac4=Object[_0x31ad51(0xe0)](_0x55afd2,_0x13ab6b):_0x48eac4,_0x40e87d;if(typeof Reflect===_0x31ad51(0xb8)&&typeof Reflect[_0x31ad51(0xb1)]===_0x31ad51(0xbf))_0x3be891=Reflect['decorate'](_0x3f65d8,_0x55afd2,_0x13ab6b,_0x48eac4);else{for(var _0x4118c8=_0x3f65d8[_0x31ad51(0xa4)]-0x1;_0x4118c8>=0x0;_0x4118c8--)if(_0x40e87d=_0x3f65d8[_0x4118c8])_0x3be891=(_0xd0f7fe<0x3?_0x40e87d(_0x3be891):_0xd0f7fe>0x3?_0x40e87d(_0x55afd2,_0x13ab6b,_0x3be891):_0x40e87d(_0x55afd2,_0x13ab6b))||_0x3be891;}return _0xd0f7fe>0x3&&_0x3be891&&Object['defineProperty'](_0x55afd2,_0x13ab6b,_0x3be891),_0x3be891;},__metadata=this&&this[_0x5d71b3(0xbc)]||function(_0x31c3aa,_0x5d216d){const _0x23e9a3=_0x5d71b3;if(typeof Reflect===_0x23e9a3(0xb8)&&typeof Reflect[_0x23e9a3(0x9c)]===_0x23e9a3(0xbf))return Reflect[_0x23e9a3(0x9c)](_0x31c3aa,_0x5d216d);},__param=this&&this[_0x5d71b3(0xce)]||function(_0x499f98,_0x2e16d2){return function(_0x301fd3,_0x506d50){_0x2e16d2(_0x301fd3,_0x506d50,_0x499f98);};};function _0xa1f5(_0x345373,_0x1253ff){const _0x4febc5=_0x4feb();return _0xa1f5=function(_0xa1f504,_0x4fff57){_0xa1f504=_0xa1f504-0x90;let _0x48e963=_0x4febc5[_0xa1f504];return _0x48e963;},_0xa1f5(_0x345373,_0x1253ff);}Object[_0x5d71b3(0xda)](exports,_0x5d71b3(0xd4),{'value':!![]}),exports['ModelsService']=void 0x0;const status_constant_1=require('../../common/constants/status.constant'),utils_1=require(_0x5d71b3(0x90)),common_1=require(_0x5d71b3(0xab)),typeorm_1=require(_0x5d71b3(0xe7)),typeorm_2=require('typeorm'),models_entity_1=require(_0x5d71b3(0x98));let ModelsService=class ModelsService{constructor(_0x5d8316){const _0x42002b=_0x5d71b3;this[_0x42002b(0xaf)]=_0x5d8316,this[_0x42002b(0xbe)]=[],this[_0x42002b(0xcf)]={},this[_0x42002b(0xa7)]={},this[_0x42002b(0xb3)]={},this[_0x42002b(0x9a)]={};}async['onModuleInit'](){const _0x2068f0=_0x5d71b3;await this[_0x2068f0(0x9d)]();}async[_0x5d71b3(0x9d)](){const _0x512a20=_0x5d71b3;this[_0x512a20(0xb3)]={},this['keyPoolIndexMap']={},this[_0x512a20(0xa7)]={},this[_0x512a20(0xcf)]={},this[_0x512a20(0xbe)]=[];const _0x324f09=await this[_0x512a20(0xaf)]['find']({'where':{'status':!![]}}),_0x468ce0=_0x324f09[_0x512a20(0xd5)]((_0x2c6f38,_0x445264)=>{const _0x5f2a6e=_0x512a20;return!_0x2c6f38[_0x445264[_0x5f2a6e(0xdf)]]?_0x2c6f38[_0x445264[_0x5f2a6e(0xdf)]]=[_0x445264]:_0x2c6f38[_0x445264[_0x5f2a6e(0xdf)]]['push'](_0x445264),_0x2c6f38;},{});this[_0x512a20(0xbe)]=Object[_0x512a20(0xd8)](_0x468ce0)[_0x512a20(0xad)](_0x3b2326=>{const _0x258265=_0x512a20;return{'label':status_constant_1[_0x258265(0xa5)][_0x3b2326],'val':_0x3b2326};}),this['modelMaps']=_0x468ce0,this[_0x512a20(0xa7)]={},_0x324f09[_0x512a20(0xb2)](_0x2ea1bc=>{const _0x5e8bf4=_0x512a20,{keyType:_0x4ec7db,model:_0x1a69d3}=_0x2ea1bc;if(!this[_0x5e8bf4(0xb3)][_0x1a69d3])this[_0x5e8bf4(0xb3)][_0x1a69d3]=[];this[_0x5e8bf4(0xb3)][_0x1a69d3][_0x5e8bf4(0xca)](_0x2ea1bc);if(!this['keyPoolIndexMap'][_0x1a69d3])this[_0x5e8bf4(0x9a)][_0x1a69d3]=0x0;if(!this[_0x5e8bf4(0xa7)][_0x4ec7db])this[_0x5e8bf4(0xa7)][_0x4ec7db]={};if(!this[_0x5e8bf4(0xa7)][_0x4ec7db][_0x1a69d3])this['keyList'][_0x4ec7db][_0x1a69d3]=[];this['keyList'][_0x4ec7db][_0x1a69d3][_0x5e8bf4(0xca)](_0x2ea1bc);});}async[_0x5d71b3(0xba)](_0x3571ee,_0x17f5fc,_0x3e8ff3=-0x1){const _0xb57227=_0x5d71b3,_0x21a293=await this[_0xb57227(0xaf)]['update']({'id':_0x3571ee},{'status':![],'keyStatus':_0x3e8ff3,'remark':_0x17f5fc});common_1[_0xb57227(0xd1)][_0xb57227(0xa2)](_0xb57227(0xe9)+_0x3571ee+_0xb57227(0xde)),this[_0xb57227(0x9d)]();}async['getCurrentModelKeyInfo'](_0x57b3ea){const _0x333205=_0x5d71b3;let _0xfd39bf=await this[_0x333205(0xaf)]['findOne']({'where':{'model':_0x57b3ea}});if(!_0xfd39bf)return null;return _0xfd39bf;}async[_0x5d71b3(0xc0)](_0x1f993f){const _0x4f5ada=_0x5d71b3,_0x2a4b02=await this[_0x4f5ada(0xaf)]['find']({'where':{'model':(0x0,typeorm_2[_0x4f5ada(0xe5)])(_0x1f993f+'%')}});if(_0x2a4b02[_0x4f5ada(0xa4)]===0x0)throw new common_1[(_0x4f5ada(0xae))](_0x4f5ada(0x92),common_1['HttpStatus']['BAD_REQUEST']);const _0x465ab5=_0x2a4b02[0x0],_0x2c32ff=_0x465ab5[_0x4f5ada(0xa6)][_0x4f5ada(0xd7)](_0x1f993f,''),_0x35a5b8=Object['assign'](Object[_0x4f5ada(0xb4)]({},_0x465ab5),{'model':_0x2c32ff});return _0x35a5b8;}async[_0x5d71b3(0xec)](){const _0x56e4aa=_0x5d71b3;if(!this[_0x56e4aa(0xbe)][_0x56e4aa(0xa4)]||!Object[_0x56e4aa(0xd8)](this[_0x56e4aa(0xcf)])['length'])return;const {keyType:_0x3a522f,modelName:_0x59b9c1,model:_0xdffd0,deductType:_0x1923bb,deduct:_0x17df81,isFileUpload:_0x9b77bf,modelAvatar:_0x241408,modelDescription:_0x309238}=this[_0x56e4aa(0xcf)][0x1][0x0];return{'modelInfo':{'keyType':_0x3a522f,'modelName':_0x59b9c1,'model':_0xdffd0,'deductType':_0x1923bb,'deduct':_0x17df81,'isFileUpload':_0x9b77bf,'modelAvatar':_0x241408,'modelDescription':_0x309238}};}async['setModel'](_0x5ed238){const _0x32035e=_0x5d71b3;try{isNaN(_0x5ed238['timeout'])&&(_0x5ed238[_0x32035e(0xea)]=null);const {id:_0x127ee7}=_0x5ed238;_0x5ed238[_0x32035e(0xa9)]&&(_0x5ed238['keyStatus']=0x1);if(_0x127ee7){const _0x508cb1=await this['modelsEntity'][_0x32035e(0x95)]({'id':_0x127ee7},_0x5ed238);return await this[_0x32035e(0x9d)](),_0x508cb1[_0x32035e(0xaa)]>0x0;}else{const {keyType:_0x2da3bd,key:_0x38852f}=_0x5ed238;if(Number(_0x2da3bd!==0x1)){const _0x4491e4=await this['modelsEntity'][_0x32035e(0xb6)](_0x5ed238);return await this[_0x32035e(0x9d)](),_0x4491e4;}else{const _0x5402bb=_0x38852f['map'](_0x31e42b=>{const _0x2542b2=_0x32035e;try{const _0x4ac0f9=JSON['parse'](JSON[_0x2542b2(0xc3)](_0x5ed238));return _0x4ac0f9[_0x2542b2(0xe6)]=_0x31e42b,isNaN(_0x4ac0f9[_0x2542b2(0xea)])&&(_0x4ac0f9[_0x2542b2(0xea)]=null),_0x4ac0f9;}catch(_0xe59490){console[_0x2542b2(0xe2)]('parse\x20error:\x20',_0xe59490);}}),_0x3a7b79=await this[_0x32035e(0xaf)][_0x32035e(0xb6)](_0x5402bb);return await this[_0x32035e(0x9d)](),_0x3a7b79;}}}catch(_0x34693b){console[_0x32035e(0xe2)](_0x32035e(0xcd),_0x34693b);}}async['delModel']({id:_0x23dfd2}){const _0x2a8b43=_0x5d71b3;if(!_0x23dfd2)throw new common_1['HttpException'](_0x2a8b43(0xd0),common_1['HttpStatus'][_0x2a8b43(0xbb)]);const _0x298854=await this[_0x2a8b43(0xaf)][_0x2a8b43(0xe4)]({'where':{'id':_0x23dfd2}});if(!_0x298854)throw new common_1[(_0x2a8b43(0xae))](_0x2a8b43(0xc7),common_1[_0x2a8b43(0x9e)]['BAD_REQUEST']);const _0x1f82d6=await this['modelsEntity']['delete']({'id':_0x23dfd2});return await this['initCalcKey'](),_0x1f82d6;}async['queryModels'](_0x3615af,_0x4b7ef4){const _0x4e61b0=_0x5d71b3,{role:_0x469932}=_0x3615af['user'],{keyType:_0x5196f8,key:_0x62101c,status:_0x28299c,model:_0x3c5ddc,page:page=0x1,size:size=0xa}=_0x4b7ef4;let _0xf211d0={};_0x5196f8&&(_0xf211d0[_0x4e61b0(0xdf)]=_0x5196f8),_0x3c5ddc&&(_0xf211d0['model']=_0x3c5ddc),_0x28299c&&(_0xf211d0[_0x4e61b0(0xa9)]=Number(_0x28299c)===0x1?!![]:![]),_0x62101c&&(_0xf211d0[_0x4e61b0(0xe6)]=(0x0,typeorm_2[_0x4e61b0(0xe5)])('%'+_0x62101c+'%'));const [_0x52722f,_0x466db7]=await this['modelsEntity'][_0x4e61b0(0xe8)]({'where':_0xf211d0,'order':{'modelOrder':_0x4e61b0(0xcc)},'skip':(page-0x1)*size,'take':size});return _0x469932!==_0x4e61b0(0xbd)&&_0x52722f[_0x4e61b0(0xb2)](_0x43f746=>{const _0x44dbce=_0x4e61b0;_0x43f746['key']&&(_0x43f746['key']=(0x0,utils_1[_0x44dbce(0xe3)])(_0x43f746['key']));}),{'rows':_0x52722f,'count':_0x466db7};}async['modelsList'](){const _0x5698cf=_0x5d71b3,_0x1f41a8=JSON[_0x5698cf(0xd2)](JSON[_0x5698cf(0xc3)](this['modelMaps']));return Object['keys'](_0x1f41a8)[_0x5698cf(0xb2)](_0x120c7f=>{const _0x978170=_0x5698cf;_0x1f41a8[_0x120c7f]=_0x1f41a8[_0x120c7f]['filter'](_0x37ea94=>_0x37ea94['keyStatus']===0x1)[_0x978170(0xb0)]((_0x1889e1,_0x32150b)=>_0x1889e1[_0x978170(0x91)]-_0x32150b[_0x978170(0x91)]),_0x1f41a8[_0x120c7f]=Array[_0x978170(0xa3)](_0x1f41a8[_0x120c7f][_0x978170(0xad)](_0x264d6b=>{const _0x31ed4d=_0x978170,{modelName:_0x9248fe,keyType:_0x2279ab,model:_0x35da5e,deduct:_0x1d5018,deductType:_0x716ec5,maxRounds:_0x1c9523,modelAvatar:_0x3d00ab,isFileUpload:_0x103779,modelDescription:_0x222862}=_0x264d6b;return{'modelName':_0x9248fe,'keyType':_0x2279ab,'model':_0x35da5e,'deduct':_0x1d5018,'deductType':_0x716ec5,'maxRounds':_0x1c9523,'modelAvatar':_0x3d00ab,'isFileUpload':_0x103779,'modelDescription':_0x222862,'isTokenBased':_0x264d6b[_0x31ed4d(0xc9)],'maxModelTokens':_0x264d6b[_0x31ed4d(0xdb)],'modelLimits':_0x264d6b[_0x31ed4d(0x93)],'tokenFeeRatio':_0x264d6b[_0x31ed4d(0xc6)]};})[_0x978170(0xd5)]((_0x2378fe,_0x30bdad)=>_0x2378fe[_0x978170(0xb9)](_0x30bdad['modelName'],_0x30bdad),new Map())['values']());}),{'modelTypeList':this[_0x5698cf(0xbe)],'modelMaps':_0x1f41a8};}async['getMjInfo'](){const _0x45cf0e=_0x5d71b3,_0x19d423=await this[_0x45cf0e(0xaf)][_0x45cf0e(0xe4)]({'where':{'model':_0x45cf0e(0x9b)}});return _0x19d423?{'modelName':_0x19d423[_0x45cf0e(0xdc)],'model':_0x19d423[_0x45cf0e(0xa6)],'deduct':_0x19d423['deduct'],'deductType':_0x19d423[_0x45cf0e(0xc2)]}:null;}async[_0x5d71b3(0xa8)](_0x3dbf52,_0x4c3b6a){const _0x2bf8d3=_0x5d71b3;await this[_0x2bf8d3(0xaf)][_0x2bf8d3(0x96)]()['update'](models_entity_1[_0x2bf8d3(0xd9)])[_0x2bf8d3(0xb9)]({'useCount':()=>'useCount\x20+\x201','useToken':()=>'useToken\x20+\x20'+_0x4c3b6a})[_0x2bf8d3(0xe1)](_0x2bf8d3(0xd3),{'id':_0x3dbf52})[_0x2bf8d3(0xdd)]();}async['getAllKey'](){return await this['modelsEntity']['find']();}async['queryModelType'](_0x35fb9b){return 0x1;}async['setModelType'](_0x40bdf0){return 0x1;}async[_0x5d71b3(0xcb)](_0xc2d3e3){return 0x1;}async[_0x5d71b3(0xa1)](_0x3fb628){const _0x4c41d4=_0x5d71b3,_0x19bc85=await this[_0x4c41d4(0xaf)][_0x4c41d4(0xe4)]({'where':{'model':_0x3fb628,'status':!![],'keyStatus':0x1}});return _0x19bc85;}};function _0x4feb(){const _0x2dc526=['Like','key','@nestjs/typeorm','findAndCount','key:\x20','timeout','ModelsService','getBaseConfig','../../common/utils','modelOrder','未找到匹配的模型，请重新选择模型！','modelLimits','Injectable','update','createQueryBuilder','5ndCpsv','./models.entity','1153604EaLdww','keyPoolIndexMap','midjourney','metadata','initCalcKey','HttpStatus','3349236inrbQt','14024MAecfF','getModelConfigByName','error','from','length','ModelsMapCn','model','keyList','saveUseLog','status','affected','@nestjs/common','174027hbzfzI','map','HttpException','modelsEntity','sort','decorate','forEach','keyPoolMap','assign','__decorate','save','7808390GFDohk','object','set','lockKey','BAD_REQUEST','__metadata','super','modelTypes','function','getSpecialModelKeyInfo','437546eEOOiz','deductType','stringify','Repository','1141ZuXCsv','tokenFeeRatio','当前账号不存在！','356022ErPyiw','isTokenBased','push','delModelType','ASC','error:\x20','__param','modelMaps','缺失必要参数！','Logger','parse','id\x20=\x20:id','__esModule','reduce','18UTmqEr','replace','keys','ModelsEntity','defineProperty','maxModelTokens','modelName','execute','\x20欠费或被官方封禁导致不可用，已被系统自动锁定','keyType','getOwnPropertyDescriptor','where','log','hideString','findOne'];_0x4feb=function(){return _0x2dc526;};return _0x4feb();}ModelsService=__decorate([(0x0,common_1[_0x5d71b3(0x94)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(models_entity_1[_0x5d71b3(0xd9)])),__metadata('design:paramtypes',[typeorm_2[_0x5d71b3(0xc4)]])],ModelsService),exports[_0x5d71b3(0xeb)]=ModelsService;