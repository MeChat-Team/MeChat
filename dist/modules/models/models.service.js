'use strict';const _0x1f1082=_0x5341;(function(_0x20782a,_0x344b1f){const _0x494fd6=_0x5341,_0x18de3d=_0x20782a();while(!![]){try{const _0x5057e9=-parseInt(_0x494fd6(0x1e8))/0x1*(parseInt(_0x494fd6(0x1c8))/0x2)+-parseInt(_0x494fd6(0x193))/0x3*(parseInt(_0x494fd6(0x1b5))/0x4)+-parseInt(_0x494fd6(0x1b8))/0x5+-parseInt(_0x494fd6(0x19f))/0x6*(parseInt(_0x494fd6(0x1c3))/0x7)+parseInt(_0x494fd6(0x1ba))/0x8*(parseInt(_0x494fd6(0x1b4))/0x9)+-parseInt(_0x494fd6(0x1a8))/0xa+parseInt(_0x494fd6(0x1a1))/0xb;if(_0x5057e9===_0x344b1f)break;else _0x18de3d['push'](_0x18de3d['shift']());}catch(_0x44fdda){_0x18de3d['push'](_0x18de3d['shift']());}}}(_0x4e0d,0xb7677));var __decorate=this&&this['__decorate']||function(_0x11d254,_0x3c26dd,_0x1e36eb,_0x1bb73c){const _0x426e17=_0x5341;var _0x2ae183=arguments[_0x426e17(0x1df)],_0x80b2e6=_0x2ae183<0x3?_0x3c26dd:_0x1bb73c===null?_0x1bb73c=Object[_0x426e17(0x195)](_0x3c26dd,_0x1e36eb):_0x1bb73c,_0x5404ab;if(typeof Reflect===_0x426e17(0x187)&&typeof Reflect[_0x426e17(0x1d2)]==='function')_0x80b2e6=Reflect[_0x426e17(0x1d2)](_0x11d254,_0x3c26dd,_0x1e36eb,_0x1bb73c);else{for(var _0x5cb2f7=_0x11d254[_0x426e17(0x1df)]-0x1;_0x5cb2f7>=0x0;_0x5cb2f7--)if(_0x5404ab=_0x11d254[_0x5cb2f7])_0x80b2e6=(_0x2ae183<0x3?_0x5404ab(_0x80b2e6):_0x2ae183>0x3?_0x5404ab(_0x3c26dd,_0x1e36eb,_0x80b2e6):_0x5404ab(_0x3c26dd,_0x1e36eb))||_0x80b2e6;}return _0x2ae183>0x3&&_0x80b2e6&&Object[_0x426e17(0x1ca)](_0x3c26dd,_0x1e36eb,_0x80b2e6),_0x80b2e6;},__metadata=this&&this['__metadata']||function(_0x35813f,_0x2a5e19){const _0x4c0c9f=_0x5341;if(typeof Reflect===_0x4c0c9f(0x187)&&typeof Reflect[_0x4c0c9f(0x18e)]===_0x4c0c9f(0x18c))return Reflect[_0x4c0c9f(0x18e)](_0x35813f,_0x2a5e19);},__param=this&&this[_0x1f1082(0x188)]||function(_0xf66d7c,_0x152bdd){return function(_0x53eb7b,_0x1a3514){_0x152bdd(_0x53eb7b,_0x1a3514,_0xf66d7c);};};Object[_0x1f1082(0x1ca)](exports,_0x1f1082(0x1de),{'value':!![]}),exports['ModelsService']=void 0x0;function _0x5341(_0x1216e7,_0x346df0){const _0x4e0d65=_0x4e0d();return _0x5341=function(_0x534136,_0x30983f){_0x534136=_0x534136-0x186;let _0x175b82=_0x4e0d65[_0x534136];return _0x175b82;},_0x5341(_0x1216e7,_0x346df0);}const status_constant_1=require(_0x1f1082(0x1d3)),utils_1=require(_0x1f1082(0x1c0)),common_1=require('@nestjs/common'),typeorm_1=require(_0x1f1082(0x1dd)),typeorm_2=require(_0x1f1082(0x1e9)),models_entity_1=require(_0x1f1082(0x1a7));function _0x4e0d(){const _0x1ef104=['54066606vDiyzW','user','createQueryBuilder','lockKey','status','getSpecialModelKeyInfo','./models.entity','5906870QxKKuj','keys','modelOrder','log','setModel','ModelsService','ASC','keyPoolMap','stringify','ModelsEntity','timeout','midjourney','5409UTamsO','116DjdThO','assign','Injectable','3653920TRFAdl','save','832bQtvou','map','keyStatus','getBaseConfig','find','from','../../common/utils','replace','getMjInfo','482321UChQet','InjectRepository','reduce','key:\x20','queryModels','2MIIAgY','forEach','defineProperty','ModelsMapCn','keyPoolIndexMap','push','缺失必要参数！','modelLimits','Like','modelTypes','decorate','../../common/constants/status.constant','modelMaps','hideString','keyType','key','HttpException','getCurrentModelKeyInfo','useToken\x20+\x20','initCalcKey','findOne','@nestjs/typeorm','__esModule','length','update','getModelConfigByName','delModelType','queryModelType','modelsEntity','model','error:\x20','\x20欠费或被官方封禁导致不可用，已被系统自动锁定','1266361XqVvkd','typeorm','未找到匹配的模型，请重新选择模型！','object','__param','set','delete','sort','function','当前账号不存在！','metadata','Logger','where','keyList','deductType','19824UbslFf','affected','getOwnPropertyDescriptor','modelsList','BAD_REQUEST','HttpStatus','deduct','id\x20=\x20:id','tokenFeeRatio','isTokenBased','modelName','parse\x20error:\x20','126OuPDIt','filter'];_0x4e0d=function(){return _0x1ef104;};return _0x4e0d();}let ModelsService=class ModelsService{constructor(_0x17ba4b){const _0xc58a20=_0x1f1082;this['modelsEntity']=_0x17ba4b,this[_0xc58a20(0x1d1)]=[],this[_0xc58a20(0x1d4)]={},this['keyList']={},this['keyPoolMap']={},this[_0xc58a20(0x1cc)]={};}async['onModuleInit'](){const _0x3374ec=_0x1f1082;await this[_0x3374ec(0x1db)]();}async[_0x1f1082(0x1db)](){const _0xa1432c=_0x1f1082;this[_0xa1432c(0x1af)]={},this[_0xa1432c(0x1cc)]={},this[_0xa1432c(0x191)]={},this[_0xa1432c(0x1d4)]={},this[_0xa1432c(0x1d1)]=[];const _0x13604a=await this[_0xa1432c(0x1e4)][_0xa1432c(0x1be)]({'where':{'status':!![]}}),_0x48f643=_0x13604a[_0xa1432c(0x1c5)]((_0x10f274,_0x5f52c7)=>{const _0x52f80a=_0xa1432c;return!_0x10f274[_0x5f52c7[_0x52f80a(0x1d6)]]?_0x10f274[_0x5f52c7[_0x52f80a(0x1d6)]]=[_0x5f52c7]:_0x10f274[_0x5f52c7[_0x52f80a(0x1d6)]]['push'](_0x5f52c7),_0x10f274;},{});this[_0xa1432c(0x1d1)]=Object[_0xa1432c(0x1a9)](_0x48f643)[_0xa1432c(0x1bb)](_0x30a0d2=>{const _0x10e971=_0xa1432c;return{'label':status_constant_1[_0x10e971(0x1cb)][_0x30a0d2],'val':_0x30a0d2};}),this['modelMaps']=_0x48f643,this['keyList']={},_0x13604a[_0xa1432c(0x1c9)](_0x4f41f8=>{const _0x519ded=_0xa1432c,{keyType:_0xef9ea2,model:_0x33c26b}=_0x4f41f8;if(!this[_0x519ded(0x1af)][_0x33c26b])this[_0x519ded(0x1af)][_0x33c26b]=[];this[_0x519ded(0x1af)][_0x33c26b]['push'](_0x4f41f8);if(!this[_0x519ded(0x1cc)][_0x33c26b])this[_0x519ded(0x1cc)][_0x33c26b]=0x0;if(!this[_0x519ded(0x191)][_0xef9ea2])this[_0x519ded(0x191)][_0xef9ea2]={};if(!this[_0x519ded(0x191)][_0xef9ea2][_0x33c26b])this[_0x519ded(0x191)][_0xef9ea2][_0x33c26b]=[];this[_0x519ded(0x191)][_0xef9ea2][_0x33c26b][_0x519ded(0x1cd)](_0x4f41f8);});}async[_0x1f1082(0x1a4)](_0x6a3e1e,_0x26fb2e,_0x586abc=-0x1){const _0x3c77c2=_0x1f1082,_0x49dc21=await this[_0x3c77c2(0x1e4)][_0x3c77c2(0x1e0)]({'id':_0x6a3e1e},{'status':![],'keyStatus':_0x586abc,'remark':_0x26fb2e});common_1[_0x3c77c2(0x18f)]['error'](_0x3c77c2(0x1c6)+_0x6a3e1e+_0x3c77c2(0x1e7)),this[_0x3c77c2(0x1db)]();}async[_0x1f1082(0x1d9)](_0x4e2a6f){const _0x53188d=_0x1f1082;let _0x11d134=await this['modelsEntity'][_0x53188d(0x1dc)]({'where':{'model':_0x4e2a6f}});if(!_0x11d134)return null;return _0x11d134;}async[_0x1f1082(0x1a6)](_0x1f5eef){const _0x229b71=_0x1f1082,_0x11f9ae=await this[_0x229b71(0x1e4)]['find']({'where':{'model':(0x0,typeorm_2[_0x229b71(0x1d0)])(_0x1f5eef+'%')}});if(_0x11f9ae[_0x229b71(0x1df)]===0x0)throw new common_1[(_0x229b71(0x1d8))](_0x229b71(0x186),common_1[_0x229b71(0x198)][_0x229b71(0x197)]);const _0x3673aa=_0x11f9ae[0x0],_0x559849=_0x3673aa[_0x229b71(0x1e5)][_0x229b71(0x1c1)](_0x1f5eef,''),_0x580ee6=Object[_0x229b71(0x1b6)](Object['assign']({},_0x3673aa),{'model':_0x559849});return _0x580ee6;}async[_0x1f1082(0x1bd)](){const _0x2a6842=_0x1f1082;if(!this[_0x2a6842(0x1d1)][_0x2a6842(0x1df)]||!Object[_0x2a6842(0x1a9)](this['modelMaps'])[_0x2a6842(0x1df)])return;const {keyType:_0x307185,modelName:_0x14c534,model:_0x51503e,deductType:_0x2d76c3,deduct:_0x21170f,isFileUpload:_0x2ae451,modelAvatar:_0x2f1493,modelDescription:_0x47731a}=this[_0x2a6842(0x1d4)][0x1][0x0];return{'modelInfo':{'keyType':_0x307185,'modelName':_0x14c534,'model':_0x51503e,'deductType':_0x2d76c3,'deduct':_0x21170f,'isFileUpload':_0x2ae451,'modelAvatar':_0x2f1493,'modelDescription':_0x47731a}};}async[_0x1f1082(0x1ac)](_0x491335){const _0x3b4b99=_0x1f1082;try{isNaN(_0x491335[_0x3b4b99(0x1b2)])&&(_0x491335[_0x3b4b99(0x1b2)]=null);const {id:_0x76063}=_0x491335;_0x491335[_0x3b4b99(0x1a5)]&&(_0x491335['keyStatus']=0x1);if(_0x76063){const _0x5dc816=await this[_0x3b4b99(0x1e4)][_0x3b4b99(0x1e0)]({'id':_0x76063},_0x491335);return await this[_0x3b4b99(0x1db)](),_0x5dc816[_0x3b4b99(0x194)]>0x0;}else{const {keyType:_0x3bee87,key:_0x2cded2}=_0x491335;if(Number(_0x3bee87!==0x1)){const _0xa8c539=await this[_0x3b4b99(0x1e4)][_0x3b4b99(0x1b9)](_0x491335);return await this[_0x3b4b99(0x1db)](),_0xa8c539;}else{const _0x2ec82f=_0x2cded2[_0x3b4b99(0x1bb)](_0x514660=>{const _0x3ff516=_0x3b4b99;try{const _0x3cbef6=JSON['parse'](JSON[_0x3ff516(0x1b0)](_0x491335));return _0x3cbef6['key']=_0x514660,isNaN(_0x3cbef6[_0x3ff516(0x1b2)])&&(_0x3cbef6[_0x3ff516(0x1b2)]=null),_0x3cbef6;}catch(_0x5c14a3){console[_0x3ff516(0x1ab)](_0x3ff516(0x19e),_0x5c14a3);}}),_0x117ad1=await this['modelsEntity']['save'](_0x2ec82f);return await this[_0x3b4b99(0x1db)](),_0x117ad1;}}}catch(_0x37a4bc){console[_0x3b4b99(0x1ab)](_0x3b4b99(0x1e6),_0x37a4bc);}}async['delModel']({id:_0x21b6fd}){const _0x5df6ab=_0x1f1082;if(!_0x21b6fd)throw new common_1[(_0x5df6ab(0x1d8))](_0x5df6ab(0x1ce),common_1[_0x5df6ab(0x198)][_0x5df6ab(0x197)]);const _0x45cad2=await this['modelsEntity'][_0x5df6ab(0x1dc)]({'where':{'id':_0x21b6fd}});if(!_0x45cad2)throw new common_1['HttpException'](_0x5df6ab(0x18d),common_1[_0x5df6ab(0x198)][_0x5df6ab(0x197)]);const _0x50bd00=await this[_0x5df6ab(0x1e4)][_0x5df6ab(0x18a)]({'id':_0x21b6fd});return await this['initCalcKey'](),_0x50bd00;}async[_0x1f1082(0x1c7)](_0x4e942f,_0x22d2b3){const _0x1afb6f=_0x1f1082,{role:_0x2f0d28}=_0x4e942f[_0x1afb6f(0x1a2)],{keyType:_0x3b0930,key:_0x519bc4,status:_0x24aecf,model:_0x566686,page:page=0x1,size:size=0xa}=_0x22d2b3;let _0x4bc4df={};_0x3b0930&&(_0x4bc4df[_0x1afb6f(0x1d6)]=_0x3b0930),_0x566686&&(_0x4bc4df[_0x1afb6f(0x1e5)]=_0x566686),_0x24aecf&&(_0x4bc4df[_0x1afb6f(0x1a5)]=Number(_0x24aecf)===0x1?!![]:![]),_0x519bc4&&(_0x4bc4df['key']=(0x0,typeorm_2[_0x1afb6f(0x1d0)])('%'+_0x519bc4+'%'));const [_0x3fb04b,_0x455e32]=await this[_0x1afb6f(0x1e4)]['findAndCount']({'where':_0x4bc4df,'order':{'modelOrder':_0x1afb6f(0x1ae)},'skip':(page-0x1)*size,'take':size});return _0x2f0d28!=='super'&&_0x3fb04b[_0x1afb6f(0x1c9)](_0x588980=>{const _0x25564e=_0x1afb6f;_0x588980[_0x25564e(0x1d7)]&&(_0x588980[_0x25564e(0x1d7)]=(0x0,utils_1[_0x25564e(0x1d5)])(_0x588980['key']));}),{'rows':_0x3fb04b,'count':_0x455e32};}async[_0x1f1082(0x196)](){const _0x355d57=_0x1f1082,_0x134b8d=JSON['parse'](JSON[_0x355d57(0x1b0)](this[_0x355d57(0x1d4)]));return Object[_0x355d57(0x1a9)](_0x134b8d)[_0x355d57(0x1c9)](_0x3cd6f6=>{const _0x1ff393=_0x355d57;_0x134b8d[_0x3cd6f6]=_0x134b8d[_0x3cd6f6][_0x1ff393(0x1a0)](_0x3bac25=>_0x3bac25[_0x1ff393(0x1bc)]===0x1)[_0x1ff393(0x18b)]((_0x4103b3,_0x2eef9a)=>_0x4103b3[_0x1ff393(0x1aa)]-_0x2eef9a[_0x1ff393(0x1aa)]),_0x134b8d[_0x3cd6f6]=Array[_0x1ff393(0x1bf)](_0x134b8d[_0x3cd6f6]['map'](_0xab82c7=>{const _0x2892a4=_0x1ff393,{modelName:_0x5352eb,keyType:_0x50546c,model:_0xf52eda,deduct:_0x42f140,deductType:_0x42a2b3,maxRounds:_0x2c953c,modelAvatar:_0x1603c8,isFileUpload:_0x442a51,modelDescription:_0x1e6231}=_0xab82c7;return{'modelName':_0x5352eb,'keyType':_0x50546c,'model':_0xf52eda,'deduct':_0x42f140,'deductType':_0x42a2b3,'maxRounds':_0x2c953c,'modelAvatar':_0x1603c8,'isFileUpload':_0x442a51,'modelDescription':_0x1e6231,'isTokenBased':_0xab82c7[_0x2892a4(0x19c)],'maxModelTokens':_0xab82c7['maxModelTokens'],'modelLimits':_0xab82c7[_0x2892a4(0x1cf)],'tokenFeeRatio':_0xab82c7[_0x2892a4(0x19b)]};})[_0x1ff393(0x1c5)]((_0x440637,_0x3fe10c)=>_0x440637[_0x1ff393(0x189)](_0x3fe10c['modelName'],_0x3fe10c),new Map())['values']());}),{'modelTypeList':this[_0x355d57(0x1d1)],'modelMaps':_0x134b8d};}async[_0x1f1082(0x1c2)](){const _0x5935f6=_0x1f1082,_0x458aa7=await this[_0x5935f6(0x1e4)]['findOne']({'where':{'model':_0x5935f6(0x1b3)}});return _0x458aa7?{'modelName':_0x458aa7[_0x5935f6(0x19d)],'model':_0x458aa7['model'],'deduct':_0x458aa7[_0x5935f6(0x199)],'deductType':_0x458aa7[_0x5935f6(0x192)]}:null;}async['saveUseLog'](_0x235d8c,_0x4eda45){const _0x3da82a=_0x1f1082;await this[_0x3da82a(0x1e4)][_0x3da82a(0x1a3)]()[_0x3da82a(0x1e0)](models_entity_1[_0x3da82a(0x1b1)])[_0x3da82a(0x189)]({'useCount':()=>'useCount\x20+\x201','useToken':()=>_0x3da82a(0x1da)+_0x4eda45})[_0x3da82a(0x190)](_0x3da82a(0x19a),{'id':_0x235d8c})['execute']();}async['getAllKey'](){const _0x2a94d0=_0x1f1082;return await this[_0x2a94d0(0x1e4)]['find']();}async[_0x1f1082(0x1e3)](_0x56d36c){return 0x1;}async['setModelType'](_0x3b361f){return 0x1;}async[_0x1f1082(0x1e2)](_0x3183ca){return 0x1;}async[_0x1f1082(0x1e1)](_0x3f2269){const _0x58b8dd=_0x1f1082,_0x11055a=await this[_0x58b8dd(0x1e4)][_0x58b8dd(0x1dc)]({'where':{'model':_0x3f2269,'status':!![],'keyStatus':0x1}});return _0x11055a;}};ModelsService=__decorate([(0x0,common_1[_0x1f1082(0x1b7)])(),__param(0x0,(0x0,typeorm_1[_0x1f1082(0x1c4)])(models_entity_1[_0x1f1082(0x1b1)])),__metadata('design:paramtypes',[typeorm_2['Repository']])],ModelsService),exports[_0x1f1082(0x1ad)]=ModelsService;