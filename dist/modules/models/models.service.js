'use strict';const _0x5ae611=_0x1db0;(function(_0x117a64,_0x2f14c5){const _0x43ca91=_0x1db0,_0x5afab3=_0x117a64();while(!![]){try{const _0x572819=-parseInt(_0x43ca91(0x195))/0x1*(parseInt(_0x43ca91(0x174))/0x2)+-parseInt(_0x43ca91(0x175))/0x3*(-parseInt(_0x43ca91(0x1b0))/0x4)+parseInt(_0x43ca91(0x1c5))/0x5+-parseInt(_0x43ca91(0x19c))/0x6*(parseInt(_0x43ca91(0x173))/0x7)+parseInt(_0x43ca91(0x1ad))/0x8+-parseInt(_0x43ca91(0x188))/0x9*(-parseInt(_0x43ca91(0x1ba))/0xa)+-parseInt(_0x43ca91(0x1b9))/0xb;if(_0x572819===_0x2f14c5)break;else _0x5afab3['push'](_0x5afab3['shift']());}catch(_0x592e30){_0x5afab3['push'](_0x5afab3['shift']());}}}(_0x268b,0xae973));var __decorate=this&&this[_0x5ae611(0x16b)]||function(_0xebe7aa,_0x569efe,_0x434ca0,_0x2e944c){const _0x31f49b=_0x5ae611;var _0x499d00=arguments[_0x31f49b(0x1b4)],_0x394b6c=_0x499d00<0x3?_0x569efe:_0x2e944c===null?_0x2e944c=Object['getOwnPropertyDescriptor'](_0x569efe,_0x434ca0):_0x2e944c,_0x3f35f8;if(typeof Reflect==='object'&&typeof Reflect[_0x31f49b(0x1b7)]===_0x31f49b(0x1a9))_0x394b6c=Reflect[_0x31f49b(0x1b7)](_0xebe7aa,_0x569efe,_0x434ca0,_0x2e944c);else{for(var _0x2ffa4b=_0xebe7aa[_0x31f49b(0x1b4)]-0x1;_0x2ffa4b>=0x0;_0x2ffa4b--)if(_0x3f35f8=_0xebe7aa[_0x2ffa4b])_0x394b6c=(_0x499d00<0x3?_0x3f35f8(_0x394b6c):_0x499d00>0x3?_0x3f35f8(_0x569efe,_0x434ca0,_0x394b6c):_0x3f35f8(_0x569efe,_0x434ca0))||_0x394b6c;}return _0x499d00>0x3&&_0x394b6c&&Object[_0x31f49b(0x178)](_0x569efe,_0x434ca0,_0x394b6c),_0x394b6c;},__metadata=this&&this[_0x5ae611(0x177)]||function(_0x84d269,_0x5659d3){const _0x4087ab=_0x5ae611;if(typeof Reflect===_0x4087ab(0x17c)&&typeof Reflect[_0x4087ab(0x16d)]===_0x4087ab(0x1a9))return Reflect['metadata'](_0x84d269,_0x5659d3);},__param=this&&this[_0x5ae611(0x168)]||function(_0x36d340,_0x482c90){return function(_0x36ae86,_0x35852c){_0x482c90(_0x36ae86,_0x35852c,_0x36d340);};};function _0x1db0(_0x23ad6b,_0x4f19b3){const _0x268b90=_0x268b();return _0x1db0=function(_0x1db050,_0x266dd6){_0x1db050=_0x1db050-0x168;let _0x4dffff=_0x268b90[_0x1db050];return _0x4dffff;},_0x1db0(_0x23ad6b,_0x4f19b3);}Object['defineProperty'](exports,_0x5ae611(0x17b),{'value':!![]}),exports[_0x5ae611(0x1cb)]=void 0x0;function _0x268b(){const _0x2876fe=['../../common/utils','createQueryBuilder','175tOEWzP','2usCPRe','3YSUgZu','useToken\x20+\x20','__metadata','defineProperty','sort','forEach','__esModule','object','update','hideString','timeout','keyList','map','find','useCount\x20+\x201','values','status','modelName','push','2109555fQDJZJ','id\x20=\x20:id','findAndCount','super','getModelConfigByName','deductType','InjectRepository','parse\x20error:\x20','typeorm','keyType','user','modelOrder','queryModels','86650XMmJkz','delModelType','ModelsMapCn','design:paramtypes','model','from','deduct','60114ngMLCw','未找到匹配的模型，请重新选择模型！','midjourney','stringify','findOne','isTokenBased','getCurrentModelKeyInfo','replace','key:\x20','modelsList','save','Logger','where','function','@nestjs/typeorm','ModelsEntity','modelMaps','9369936QaZUou','Like','reduce','4645036tJGUjq','keyPoolIndexMap','./models.entity','BAD_REQUEST','length','Injectable','modelTypes','decorate','modelsEntity','30838863cYTjTu','20rkWesW','assign','keyPoolMap','当前账号不存在！','delete','parse','\x20欠费或被官方封禁导致不可用，已被系统自动锁定','set','log','execute','keys','5272450RXmeoq','key','maxModelTokens','HttpStatus','getBaseConfig','keyStatus','ModelsService','__param','../../common/constants/status.constant','modelLimits','__decorate','HttpException','metadata','缺失必要参数！','initCalcKey','affected'];_0x268b=function(){return _0x2876fe;};return _0x268b();}const status_constant_1=require(_0x5ae611(0x169)),utils_1=require(_0x5ae611(0x171)),common_1=require('@nestjs/common'),typeorm_1=require(_0x5ae611(0x1aa)),typeorm_2=require(_0x5ae611(0x190)),models_entity_1=require(_0x5ae611(0x1b2));let ModelsService=class ModelsService{constructor(_0x28d7a9){const _0x372f89=_0x5ae611;this[_0x372f89(0x1b8)]=_0x28d7a9,this['modelTypes']=[],this[_0x372f89(0x1ac)]={},this[_0x372f89(0x180)]={},this[_0x372f89(0x1bc)]={},this[_0x372f89(0x1b1)]={};}async['onModuleInit'](){const _0x40c179=_0x5ae611;await this[_0x40c179(0x16f)]();}async[_0x5ae611(0x16f)](){const _0x274997=_0x5ae611;this['keyPoolMap']={},this[_0x274997(0x1b1)]={},this[_0x274997(0x180)]={},this[_0x274997(0x1ac)]={},this[_0x274997(0x1b6)]=[];const _0x4d5fc9=await this['modelsEntity']['find']({'where':{'status':!![]}}),_0x724a3c=_0x4d5fc9[_0x274997(0x1af)]((_0x1636c6,_0x35b598)=>{const _0x11317d=_0x274997;return!_0x1636c6[_0x35b598[_0x11317d(0x191)]]?_0x1636c6[_0x35b598[_0x11317d(0x191)]]=[_0x35b598]:_0x1636c6[_0x35b598[_0x11317d(0x191)]][_0x11317d(0x187)](_0x35b598),_0x1636c6;},{});this['modelTypes']=Object[_0x274997(0x1c4)](_0x724a3c)['map'](_0x54064e=>{const _0x2abafd=_0x274997;return{'label':status_constant_1[_0x2abafd(0x197)][_0x54064e],'val':_0x54064e};}),this[_0x274997(0x1ac)]=_0x724a3c,this[_0x274997(0x180)]={},_0x4d5fc9[_0x274997(0x17a)](_0x244279=>{const _0x531731=_0x274997,{keyType:_0x33dafb,model:_0x5dea8f}=_0x244279;if(!this['keyPoolMap'][_0x5dea8f])this['keyPoolMap'][_0x5dea8f]=[];this['keyPoolMap'][_0x5dea8f]['push'](_0x244279);if(!this[_0x531731(0x1b1)][_0x5dea8f])this[_0x531731(0x1b1)][_0x5dea8f]=0x0;if(!this[_0x531731(0x180)][_0x33dafb])this['keyList'][_0x33dafb]={};if(!this[_0x531731(0x180)][_0x33dafb][_0x5dea8f])this[_0x531731(0x180)][_0x33dafb][_0x5dea8f]=[];this['keyList'][_0x33dafb][_0x5dea8f][_0x531731(0x187)](_0x244279);});}async['lockKey'](_0x4ef779,_0x29a87e,_0x1f4407=-0x1){const _0x3bb6ec=_0x5ae611,_0x380c97=await this['modelsEntity'][_0x3bb6ec(0x17d)]({'id':_0x4ef779},{'status':![],'keyStatus':_0x1f4407,'remark':_0x29a87e});common_1[_0x3bb6ec(0x1a7)]['error'](_0x3bb6ec(0x1a4)+_0x4ef779+_0x3bb6ec(0x1c0)),this[_0x3bb6ec(0x16f)]();}async[_0x5ae611(0x1a2)](_0x1d831b){const _0x39cf33=_0x5ae611;let _0x4eea80=await this[_0x39cf33(0x1b8)][_0x39cf33(0x1a0)]({'where':{'model':_0x1d831b}});if(!_0x4eea80)return null;return _0x4eea80;}async['getSpecialModelKeyInfo'](_0x415fbd){const _0x227f4a=_0x5ae611,_0x2b249c=await this[_0x227f4a(0x1b8)][_0x227f4a(0x182)]({'where':{'model':(0x0,typeorm_2[_0x227f4a(0x1ae)])(_0x415fbd+'%')}});if(_0x2b249c[_0x227f4a(0x1b4)]===0x0)throw new common_1[(_0x227f4a(0x16c))](_0x227f4a(0x19d),common_1[_0x227f4a(0x1c8)][_0x227f4a(0x1b3)]);const _0x6b65ec=_0x2b249c[0x0],_0x562ec2=_0x6b65ec[_0x227f4a(0x199)][_0x227f4a(0x1a3)](_0x415fbd,''),_0x2474af=Object[_0x227f4a(0x1bb)](Object[_0x227f4a(0x1bb)]({},_0x6b65ec),{'model':_0x562ec2});return _0x2474af;}async[_0x5ae611(0x1c9)](){const _0x3d23ec=_0x5ae611;if(!this[_0x3d23ec(0x1b6)][_0x3d23ec(0x1b4)]||!Object[_0x3d23ec(0x1c4)](this[_0x3d23ec(0x1ac)])[_0x3d23ec(0x1b4)])return;const {keyType:_0x2b2b8d,modelName:_0x213b5d,model:_0x922ab1,deductType:_0x53848d,deduct:_0x4fa646,isFileUpload:_0x39990a,modelAvatar:_0x300f47,modelDescription:_0x135ab2}=this[_0x3d23ec(0x1ac)][0x1][0x0];return{'modelInfo':{'keyType':_0x2b2b8d,'modelName':_0x213b5d,'model':_0x922ab1,'deductType':_0x53848d,'deduct':_0x4fa646,'isFileUpload':_0x39990a,'modelAvatar':_0x300f47,'modelDescription':_0x135ab2}};}async['setModel'](_0x1cba13){const _0x225115=_0x5ae611;try{isNaN(_0x1cba13[_0x225115(0x17f)])&&(_0x1cba13[_0x225115(0x17f)]=null);const {id:_0x1e1b3b}=_0x1cba13;_0x1cba13['status']&&(_0x1cba13[_0x225115(0x1ca)]=0x1);if(_0x1e1b3b){const _0x3556cc=await this['modelsEntity'][_0x225115(0x17d)]({'id':_0x1e1b3b},_0x1cba13);return await this[_0x225115(0x16f)](),_0x3556cc[_0x225115(0x170)]>0x0;}else{const {keyType:_0x2dd9a6,key:_0x2b021e}=_0x1cba13;if(Number(_0x2dd9a6!==0x1)){const _0x1c53c6=await this[_0x225115(0x1b8)][_0x225115(0x1a6)](_0x1cba13);return await this['initCalcKey'](),_0x1c53c6;}else{const _0x5a997e=_0x2b021e['map'](_0x4bf8e4=>{const _0x34d545=_0x225115;try{const _0x5bd7ca=JSON[_0x34d545(0x1bf)](JSON[_0x34d545(0x19f)](_0x1cba13));return _0x5bd7ca[_0x34d545(0x1c6)]=_0x4bf8e4,isNaN(_0x5bd7ca['timeout'])&&(_0x5bd7ca['timeout']=null),_0x5bd7ca;}catch(_0x43774f){console[_0x34d545(0x1c2)](_0x34d545(0x18f),_0x43774f);}}),_0x163f02=await this[_0x225115(0x1b8)][_0x225115(0x1a6)](_0x5a997e);return await this[_0x225115(0x16f)](),_0x163f02;}}}catch(_0x103fa6){console[_0x225115(0x1c2)]('error:\x20',_0x103fa6);}}async['delModel']({id:_0x5898f4}){const _0x3d7458=_0x5ae611;if(!_0x5898f4)throw new common_1[(_0x3d7458(0x16c))](_0x3d7458(0x16e),common_1[_0x3d7458(0x1c8)][_0x3d7458(0x1b3)]);const _0x29d2dc=await this['modelsEntity'][_0x3d7458(0x1a0)]({'where':{'id':_0x5898f4}});if(!_0x29d2dc)throw new common_1[(_0x3d7458(0x16c))](_0x3d7458(0x1bd),common_1['HttpStatus'][_0x3d7458(0x1b3)]);const _0x3292e9=await this['modelsEntity'][_0x3d7458(0x1be)]({'id':_0x5898f4});return await this['initCalcKey'](),_0x3292e9;}async[_0x5ae611(0x194)](_0x3832f4,_0x4bc0b5){const _0x39458f=_0x5ae611,{role:_0x45ed09}=_0x3832f4[_0x39458f(0x192)],{keyType:_0x5bb9a1,key:_0xdb48d9,status:_0x4db054,model:_0x589ed9,page:page=0x1,size:size=0xa}=_0x4bc0b5;let _0x560395={};_0x5bb9a1&&(_0x560395[_0x39458f(0x191)]=_0x5bb9a1),_0x589ed9&&(_0x560395[_0x39458f(0x199)]=_0x589ed9),_0x4db054&&(_0x560395[_0x39458f(0x185)]=Number(_0x4db054)===0x1?!![]:![]),_0xdb48d9&&(_0x560395['key']=(0x0,typeorm_2[_0x39458f(0x1ae)])('%'+_0xdb48d9+'%'));const [_0x26ee30,_0x5c30f7]=await this[_0x39458f(0x1b8)][_0x39458f(0x18a)]({'where':_0x560395,'order':{'modelOrder':'ASC'},'skip':(page-0x1)*size,'take':size});return _0x45ed09!==_0x39458f(0x18b)&&_0x26ee30[_0x39458f(0x17a)](_0x3c7d35=>{const _0x4f40fa=_0x39458f;_0x3c7d35['key']&&(_0x3c7d35[_0x4f40fa(0x1c6)]=(0x0,utils_1[_0x4f40fa(0x17e)])(_0x3c7d35[_0x4f40fa(0x1c6)]));}),{'rows':_0x26ee30,'count':_0x5c30f7};}async[_0x5ae611(0x1a5)](){const _0x51b275=_0x5ae611,_0x58c31d=JSON[_0x51b275(0x1bf)](JSON['stringify'](this[_0x51b275(0x1ac)]));return Object[_0x51b275(0x1c4)](_0x58c31d)[_0x51b275(0x17a)](_0x840afa=>{const _0x4213c0=_0x51b275;_0x58c31d[_0x840afa]=_0x58c31d[_0x840afa]['filter'](_0x3bbb64=>_0x3bbb64[_0x4213c0(0x1ca)]===0x1)[_0x4213c0(0x179)]((_0x5f26c3,_0x148e4c)=>_0x5f26c3[_0x4213c0(0x193)]-_0x148e4c[_0x4213c0(0x193)]),_0x58c31d[_0x840afa]=Array[_0x4213c0(0x19a)](_0x58c31d[_0x840afa][_0x4213c0(0x181)](_0x5ec5eb=>{const _0x10778d=_0x4213c0,{modelName:_0x498ac6,keyType:_0x381325,model:_0x3ac3db,deduct:_0x2b3776,deductType:_0x3efa8e,maxRounds:_0x596b70,modelAvatar:_0x3e5cac,isFileUpload:_0x3d9218,modelDescription:_0x3d237f}=_0x5ec5eb;return{'modelName':_0x498ac6,'keyType':_0x381325,'model':_0x3ac3db,'deduct':_0x2b3776,'deductType':_0x3efa8e,'maxRounds':_0x596b70,'modelAvatar':_0x3e5cac,'isFileUpload':_0x3d9218,'modelDescription':_0x3d237f,'isTokenBased':_0x5ec5eb[_0x10778d(0x1a1)],'maxModelTokens':_0x5ec5eb[_0x10778d(0x1c7)],'modelLimits':_0x5ec5eb[_0x10778d(0x16a)],'tokenFeeRatio':_0x5ec5eb['tokenFeeRatio'],'modelOrder':_0x5ec5eb[_0x10778d(0x193)]};})[_0x4213c0(0x1af)]((_0x2c8def,_0x33a16e)=>_0x2c8def[_0x4213c0(0x1c1)](_0x33a16e[_0x4213c0(0x186)],_0x33a16e),new Map())[_0x4213c0(0x184)]());}),{'modelTypeList':this[_0x51b275(0x1b6)],'modelMaps':_0x58c31d};}async['getMjInfo'](){const _0x198ba2=_0x5ae611,_0x2ee86f=await this[_0x198ba2(0x1b8)][_0x198ba2(0x1a0)]({'where':{'model':_0x198ba2(0x19e)}});return _0x2ee86f?{'modelName':_0x2ee86f[_0x198ba2(0x186)],'model':_0x2ee86f['model'],'deduct':_0x2ee86f[_0x198ba2(0x19b)],'deductType':_0x2ee86f[_0x198ba2(0x18d)]}:null;}async['saveUseLog'](_0x20dd85,_0x38daef){const _0x3635c3=_0x5ae611;await this['modelsEntity'][_0x3635c3(0x172)]()['update'](models_entity_1['ModelsEntity'])[_0x3635c3(0x1c1)]({'useCount':()=>_0x3635c3(0x183),'useToken':()=>_0x3635c3(0x176)+_0x38daef})[_0x3635c3(0x1a8)](_0x3635c3(0x189),{'id':_0x20dd85})[_0x3635c3(0x1c3)]();}async['getAllKey'](){const _0x4796f2=_0x5ae611;return await this[_0x4796f2(0x1b8)][_0x4796f2(0x182)]();}async['queryModelType'](_0x5a9deb){return 0x1;}async['setModelType'](_0x5e9ad5){return 0x1;}async[_0x5ae611(0x196)](_0x18a0b6){return 0x1;}async[_0x5ae611(0x18c)](_0x177afe){const _0x41db75=_0x5ae611,_0x26c28f=await this[_0x41db75(0x1b8)]['findOne']({'where':{'model':_0x177afe,'status':!![],'keyStatus':0x1}});return _0x26c28f;}};ModelsService=__decorate([(0x0,common_1[_0x5ae611(0x1b5)])(),__param(0x0,(0x0,typeorm_1[_0x5ae611(0x18e)])(models_entity_1[_0x5ae611(0x1ab)])),__metadata(_0x5ae611(0x198),[typeorm_2['Repository']])],ModelsService),exports[_0x5ae611(0x1cb)]=ModelsService;