'use strict';const _0x419bbd=_0xd8fa;function _0x3ba0(){const _0x54f2f1=['metadata','keyType','11mPxGJL','super','9011140zXeZVc','getOwnPropertyDescriptor','@nestjs/common','keyPoolIndexMap','where','getModelConfigByName','typeorm','stringify','6317811ImWhJZ','../../common/utils','forEach','9642vnXauz','modelMaps','decorate','756528xoWSqI','ModelsMapCn','queryModelType','createQueryBuilder','parse\x20error:\x20','Injectable','parse','keyPoolMap','execute','4fuGHco','keyList','18992316KURwOf','queryModels','key','function','log','object','length','BAD_REQUEST','ModelsEntity','modelsEntity','HttpException','keys','getSpecialModelKeyInfo','635QKCTBv','findOne','model','useCount\x20+\x201','未找到匹配的模型，请重新选择模型！','values','replace','21MLkaNw','__metadata','keyStatus','getBaseConfig','getAllKey','defineProperty','assign','getMjInfo','update','modelName','3300636tHZdcf','onModuleInit','map','modelOrder','setModelType','delModelType','__esModule','delModel','error','initCalcKey','findAndCount','HttpStatus','midjourney','3cqawXq','timeout','InjectRepository','design:paramtypes','739325PIHZMD','hideString','set','user','modelTypes','find','from','save','status','lockKey','Repository','ASC','push','deduct','filter','当前账号不存在！'];_0x3ba0=function(){return _0x54f2f1;};return _0x3ba0();}(function(_0x8c343e,_0x3fc6a0){const _0x1efef2=_0xd8fa,_0x464519=_0x8c343e();while(!![]){try{const _0x14f62b=-parseInt(_0x1efef2(0x97))/0x1*(parseInt(_0x1efef2(0xc2))/0x2)+parseInt(_0x1efef2(0x93))/0x3*(parseInt(_0x1efef2(0x86))/0x4)+parseInt(_0x1efef2(0x75))/0x5*(-parseInt(_0x1efef2(0xb6))/0x6)+-parseInt(_0x1efef2(0x7c))/0x7*(-parseInt(_0x1efef2(0xb9))/0x8)+parseInt(_0x1efef2(0xb3))/0x9+-parseInt(_0x1efef2(0xab))/0xa*(parseInt(_0x1efef2(0xa9))/0xb)+parseInt(_0x1efef2(0xc4))/0xc;if(_0x14f62b===_0x3fc6a0)break;else _0x464519['push'](_0x464519['shift']());}catch(_0x4259d8){_0x464519['push'](_0x464519['shift']());}}}(_0x3ba0,0xc5acc));function _0xd8fa(_0x12eaca,_0x3e938a){const _0x3ba084=_0x3ba0();return _0xd8fa=function(_0xd8fa32,_0x230895){_0xd8fa32=_0xd8fa32-0x70;let _0x5ba585=_0x3ba084[_0xd8fa32];return _0x5ba585;},_0xd8fa(_0x12eaca,_0x3e938a);}var __decorate=this&&this['__decorate']||function(_0x5e45a2,_0x3c048b,_0x3c7277,_0x5d6ed5){const _0x41e237=_0xd8fa;var _0x4bf0c2=arguments[_0x41e237(0xca)],_0x5c27dd=_0x4bf0c2<0x3?_0x3c048b:_0x5d6ed5===null?_0x5d6ed5=Object[_0x41e237(0xac)](_0x3c048b,_0x3c7277):_0x5d6ed5,_0x3223a4;if(typeof Reflect===_0x41e237(0xc9)&&typeof Reflect[_0x41e237(0xb8)]===_0x41e237(0xc7))_0x5c27dd=Reflect[_0x41e237(0xb8)](_0x5e45a2,_0x3c048b,_0x3c7277,_0x5d6ed5);else{for(var _0x20f6fa=_0x5e45a2[_0x41e237(0xca)]-0x1;_0x20f6fa>=0x0;_0x20f6fa--)if(_0x3223a4=_0x5e45a2[_0x20f6fa])_0x5c27dd=(_0x4bf0c2<0x3?_0x3223a4(_0x5c27dd):_0x4bf0c2>0x3?_0x3223a4(_0x3c048b,_0x3c7277,_0x5c27dd):_0x3223a4(_0x3c048b,_0x3c7277))||_0x5c27dd;}return _0x4bf0c2>0x3&&_0x5c27dd&&Object['defineProperty'](_0x3c048b,_0x3c7277,_0x5c27dd),_0x5c27dd;},__metadata=this&&this[_0x419bbd(0x7d)]||function(_0x2245da,_0x3160dc){const _0x154e7a=_0x419bbd;if(typeof Reflect===_0x154e7a(0xc9)&&typeof Reflect[_0x154e7a(0xa7)]===_0x154e7a(0xc7))return Reflect[_0x154e7a(0xa7)](_0x2245da,_0x3160dc);},__param=this&&this['__param']||function(_0x1b9bfb,_0x27dd27){return function(_0x169a0e,_0x491652){_0x27dd27(_0x169a0e,_0x491652,_0x1b9bfb);};};Object[_0x419bbd(0x81)](exports,_0x419bbd(0x8c),{'value':!![]}),exports['ModelsService']=void 0x0;const status_constant_1=require('../../common/constants/status.constant'),utils_1=require(_0x419bbd(0xb4)),common_1=require(_0x419bbd(0xad)),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0x419bbd(0xb1)),models_entity_1=require('./models.entity');let ModelsService=class ModelsService{constructor(_0x226f94){const _0x21bfb8=_0x419bbd;this[_0x21bfb8(0x71)]=_0x226f94,this[_0x21bfb8(0x9b)]=[],this[_0x21bfb8(0xb7)]={},this[_0x21bfb8(0xc3)]={},this['keyPoolMap']={},this['keyPoolIndexMap']={};}async[_0x419bbd(0x87)](){await this['initCalcKey']();}async['initCalcKey'](){const _0x4f9de1=_0x419bbd;this['keyPoolMap']={},this['keyPoolIndexMap']={},this[_0x4f9de1(0xc3)]={},this[_0x4f9de1(0xb7)]={},this[_0x4f9de1(0x9b)]=[];const _0x1340a5=await this[_0x4f9de1(0x71)][_0x4f9de1(0x9c)]({'where':{'status':!![]}}),_0x188b6f=_0x1340a5['reduce']((_0xfc1e5c,_0x37993c)=>{const _0x5ac64b=_0x4f9de1;return!_0xfc1e5c[_0x37993c[_0x5ac64b(0xa8)]]?_0xfc1e5c[_0x37993c[_0x5ac64b(0xa8)]]=[_0x37993c]:_0xfc1e5c[_0x37993c[_0x5ac64b(0xa8)]][_0x5ac64b(0xa3)](_0x37993c),_0xfc1e5c;},{});this[_0x4f9de1(0x9b)]=Object[_0x4f9de1(0x73)](_0x188b6f)[_0x4f9de1(0x88)](_0x35984e=>{const _0x4f779c=_0x4f9de1;return{'label':status_constant_1[_0x4f779c(0xba)][_0x35984e],'val':_0x35984e};}),this[_0x4f9de1(0xb7)]=_0x188b6f,this[_0x4f9de1(0xc3)]={},_0x1340a5[_0x4f9de1(0xb5)](_0x346a94=>{const _0x398342=_0x4f9de1,{keyType:_0x48b455,model:_0x4e44f7}=_0x346a94;if(!this[_0x398342(0xc0)][_0x4e44f7])this[_0x398342(0xc0)][_0x4e44f7]=[];this['keyPoolMap'][_0x4e44f7][_0x398342(0xa3)](_0x346a94);if(!this[_0x398342(0xae)][_0x4e44f7])this['keyPoolIndexMap'][_0x4e44f7]=0x0;if(!this[_0x398342(0xc3)][_0x48b455])this['keyList'][_0x48b455]={};if(!this['keyList'][_0x48b455][_0x4e44f7])this[_0x398342(0xc3)][_0x48b455][_0x4e44f7]=[];this[_0x398342(0xc3)][_0x48b455][_0x4e44f7][_0x398342(0xa3)](_0x346a94);});}async[_0x419bbd(0xa0)](_0x345f9f,_0xfd2376,_0x464ebc=-0x1){const _0x49bd47=_0x419bbd,_0x163172=await this[_0x49bd47(0x71)][_0x49bd47(0x84)]({'id':_0x345f9f},{'status':![],'keyStatus':_0x464ebc,'remark':_0xfd2376});common_1['Logger'][_0x49bd47(0x8e)]('key:\x20'+_0x345f9f+'\x20欠费或被官方封禁导致不可用，已被系统自动锁定'),this[_0x49bd47(0x8f)]();}async['getCurrentModelKeyInfo'](_0x5ebf9b){const _0x185f8e=_0x419bbd;let _0x15faee=await this[_0x185f8e(0x71)][_0x185f8e(0x76)]({'where':{'model':_0x5ebf9b}});if(!_0x15faee)return null;return _0x15faee;}async[_0x419bbd(0x74)](_0x386ab0){const _0x3a38fa=_0x419bbd,_0x488d63=await this[_0x3a38fa(0x71)][_0x3a38fa(0x9c)]({'where':{'model':(0x0,typeorm_2['Like'])(_0x386ab0+'%')}});if(_0x488d63['length']===0x0)throw new common_1[(_0x3a38fa(0x72))](_0x3a38fa(0x79),common_1['HttpStatus'][_0x3a38fa(0xcb)]);const _0x3fb9c5=_0x488d63[0x0],_0x708fb1=_0x3fb9c5[_0x3a38fa(0x77)][_0x3a38fa(0x7b)](_0x386ab0,''),_0x2cec68=Object[_0x3a38fa(0x82)](Object[_0x3a38fa(0x82)]({},_0x3fb9c5),{'model':_0x708fb1});return _0x2cec68;}async[_0x419bbd(0x7f)](){const _0x230b12=_0x419bbd;if(!this[_0x230b12(0x9b)][_0x230b12(0xca)]||!Object[_0x230b12(0x73)](this['modelMaps'])[_0x230b12(0xca)])return;const {keyType:_0x496885,modelName:_0x516983,model:_0x344ade,deductType:_0x422d69,deduct:_0x3ba9c3,isFileUpload:_0x3e99dc,modelAvatar:_0xbe8609,modelDescription:_0x43385d}=this[_0x230b12(0xb7)][0x1][0x0];return{'modelInfo':{'keyType':_0x496885,'modelName':_0x516983,'model':_0x344ade,'deductType':_0x422d69,'deduct':_0x3ba9c3,'isFileUpload':_0x3e99dc,'modelAvatar':_0xbe8609,'modelDescription':_0x43385d}};}async['setModel'](_0x30ca44){const _0x504596=_0x419bbd;try{isNaN(_0x30ca44['timeout'])&&(_0x30ca44[_0x504596(0x94)]=null);const {id:_0x5c0877}=_0x30ca44;_0x30ca44[_0x504596(0x9f)]&&(_0x30ca44[_0x504596(0x7e)]=0x1);if(_0x5c0877){const _0x44f0c3=await this[_0x504596(0x71)][_0x504596(0x84)]({'id':_0x5c0877},_0x30ca44);return await this['initCalcKey'](),_0x44f0c3['affected']>0x0;}else{const {keyType:_0x7dcdba,key:_0x4f68e4}=_0x30ca44;if(Number(_0x7dcdba!==0x1)){const _0x283f1d=await this['modelsEntity'][_0x504596(0x9e)](_0x30ca44);return await this['initCalcKey'](),_0x283f1d;}else{const _0x4d873c=_0x4f68e4[_0x504596(0x88)](_0x435f9a=>{const _0x860e66=_0x504596;try{const _0x315cae=JSON['parse'](JSON[_0x860e66(0xb2)](_0x30ca44));return _0x315cae[_0x860e66(0xc6)]=_0x435f9a,isNaN(_0x315cae[_0x860e66(0x94)])&&(_0x315cae[_0x860e66(0x94)]=null),_0x315cae;}catch(_0x59d747){console[_0x860e66(0xc8)](_0x860e66(0xbd),_0x59d747);}}),_0x2f9e9e=await this[_0x504596(0x71)][_0x504596(0x9e)](_0x4d873c);return await this[_0x504596(0x8f)](),_0x2f9e9e;}}}catch(_0x5c8d80){console['log']('error:\x20',_0x5c8d80);}}async[_0x419bbd(0x8d)]({id:_0x2b5b44}){const _0x265b78=_0x419bbd;if(!_0x2b5b44)throw new common_1[(_0x265b78(0x72))]('缺失必要参数！',common_1[_0x265b78(0x91)]['BAD_REQUEST']);const _0x5765ef=await this['modelsEntity'][_0x265b78(0x76)]({'where':{'id':_0x2b5b44}});if(!_0x5765ef)throw new common_1[(_0x265b78(0x72))](_0x265b78(0xa6),common_1[_0x265b78(0x91)]['BAD_REQUEST']);const _0x7f5078=await this[_0x265b78(0x71)]['delete']({'id':_0x2b5b44});return await this[_0x265b78(0x8f)](),_0x7f5078;}async[_0x419bbd(0xc5)](_0x4d1774,_0x4ecf5c){const _0x29ecf3=_0x419bbd,{role:_0x53224c}=_0x4d1774[_0x29ecf3(0x9a)],{keyType:_0x1383a2,key:_0x523249,status:_0x20a23c,model:_0x41da98,page:page=0x1,size:size=0xa}=_0x4ecf5c;let _0x2e19eb={};_0x1383a2&&(_0x2e19eb[_0x29ecf3(0xa8)]=_0x1383a2),_0x41da98&&(_0x2e19eb['model']=_0x41da98),_0x20a23c&&(_0x2e19eb[_0x29ecf3(0x9f)]=Number(_0x20a23c)===0x1?!![]:![]),_0x523249&&(_0x2e19eb[_0x29ecf3(0xc6)]=(0x0,typeorm_2['Like'])('%'+_0x523249+'%'));const [_0x315e96,_0x3c9452]=await this[_0x29ecf3(0x71)][_0x29ecf3(0x90)]({'where':_0x2e19eb,'order':{'modelOrder':_0x29ecf3(0xa2)},'skip':(page-0x1)*size,'take':size});return _0x53224c!==_0x29ecf3(0xaa)&&_0x315e96[_0x29ecf3(0xb5)](_0x47b763=>{const _0x3ca91d=_0x29ecf3;_0x47b763['key']&&(_0x47b763[_0x3ca91d(0xc6)]=(0x0,utils_1[_0x3ca91d(0x98)])(_0x47b763['key']));}),{'rows':_0x315e96,'count':_0x3c9452};}async['modelsList'](){const _0x36795b=_0x419bbd,_0xb73070=JSON[_0x36795b(0xbf)](JSON[_0x36795b(0xb2)](this[_0x36795b(0xb7)]));return Object[_0x36795b(0x73)](_0xb73070)[_0x36795b(0xb5)](_0x4db064=>{const _0x8c8b2e=_0x36795b;_0xb73070[_0x4db064]=_0xb73070[_0x4db064][_0x8c8b2e(0xa5)](_0x20c9a7=>_0x20c9a7[_0x8c8b2e(0x7e)]===0x1)['sort']((_0x992dc5,_0x14d909)=>_0x992dc5[_0x8c8b2e(0x89)]-_0x14d909[_0x8c8b2e(0x89)]),_0xb73070[_0x4db064]=Array[_0x8c8b2e(0x9d)](_0xb73070[_0x4db064]['map'](_0x37183b=>{const {modelName:_0x4d87b5,keyType:_0x550aa9,model:_0x3000f6,deduct:_0x3ca1e1,deductType:_0x15f359,maxRounds:_0x42f0da,modelAvatar:_0x574d03,isFileUpload:_0x40a627,modelDescription:_0x3675cb}=_0x37183b;return{'modelName':_0x4d87b5,'keyType':_0x550aa9,'model':_0x3000f6,'deduct':_0x3ca1e1,'deductType':_0x15f359,'maxRounds':_0x42f0da,'modelAvatar':_0x574d03,'isFileUpload':_0x40a627,'modelDescription':_0x3675cb};})['reduce']((_0x502c17,_0x416d88)=>_0x502c17[_0x8c8b2e(0x99)](_0x416d88[_0x8c8b2e(0x85)],_0x416d88),new Map())[_0x8c8b2e(0x7a)]());}),{'modelTypeList':this['modelTypes'],'modelMaps':_0xb73070};}async[_0x419bbd(0x83)](){const _0x3dd1de=_0x419bbd,_0xdaeb49=await this[_0x3dd1de(0x71)][_0x3dd1de(0x76)]({'where':{'model':_0x3dd1de(0x92)}});return _0xdaeb49?{'modelName':_0xdaeb49[_0x3dd1de(0x85)],'model':_0xdaeb49[_0x3dd1de(0x77)],'deduct':_0xdaeb49[_0x3dd1de(0xa4)],'deductType':_0xdaeb49['deductType']}:null;}async['saveUseLog'](_0xf66ffd,_0x342541){const _0x31a55a=_0x419bbd;await this['modelsEntity'][_0x31a55a(0xbc)]()[_0x31a55a(0x84)](models_entity_1['ModelsEntity'])[_0x31a55a(0x99)]({'useCount':()=>_0x31a55a(0x78),'useToken':()=>'useToken\x20+\x20'+_0x342541})[_0x31a55a(0xaf)]('id\x20=\x20:id',{'id':_0xf66ffd})[_0x31a55a(0xc1)]();}async[_0x419bbd(0x80)](){const _0x1d2b79=_0x419bbd;return await this[_0x1d2b79(0x71)]['find']();}async[_0x419bbd(0xbb)](_0x2611e5){return 0x1;}async[_0x419bbd(0x8a)](_0x583e00){return 0x1;}async[_0x419bbd(0x8b)](_0x59faf0){return 0x1;}async[_0x419bbd(0xb0)](_0x5e10d9){const _0x41ec8f=_0x419bbd,_0x442664=await this[_0x41ec8f(0x71)][_0x41ec8f(0x76)]({'where':{'model':_0x5e10d9,'status':!![],'keyStatus':0x1}});return _0x442664;}};ModelsService=__decorate([(0x0,common_1[_0x419bbd(0xbe)])(),__param(0x0,(0x0,typeorm_1[_0x419bbd(0x95)])(models_entity_1[_0x419bbd(0x70)])),__metadata(_0x419bbd(0x96),[typeorm_2[_0x419bbd(0xa1)]])],ModelsService),exports['ModelsService']=ModelsService;