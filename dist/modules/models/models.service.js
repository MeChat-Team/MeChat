'use strict';const _0x1c397f=_0x58bf;(function(_0x3066c9,_0x521e37){const _0x510ad6=_0x58bf,_0xc4039d=_0x3066c9();while(!![]){try{const _0x4632b3=parseInt(_0x510ad6(0x217))/0x1+-parseInt(_0x510ad6(0x210))/0x2*(-parseInt(_0x510ad6(0x1f4))/0x3)+-parseInt(_0x510ad6(0x1e5))/0x4+-parseInt(_0x510ad6(0x1e9))/0x5*(-parseInt(_0x510ad6(0x1cf))/0x6)+-parseInt(_0x510ad6(0x1ca))/0x7*(-parseInt(_0x510ad6(0x1ee))/0x8)+-parseInt(_0x510ad6(0x1d5))/0x9*(parseInt(_0x510ad6(0x21b))/0xa)+parseInt(_0x510ad6(0x1f2))/0xb*(-parseInt(_0x510ad6(0x1f0))/0xc);if(_0x4632b3===_0x521e37)break;else _0xc4039d['push'](_0xc4039d['shift']());}catch(_0x286462){_0xc4039d['push'](_0xc4039d['shift']());}}}(_0x4306,0xed35a));function _0x58bf(_0x2e670d,_0x442c37){const _0x43068d=_0x4306();return _0x58bf=function(_0x58bfe6,_0x6bd2f3){_0x58bfe6=_0x58bfe6-0x1c0;let _0x480e9d=_0x43068d[_0x58bfe6];return _0x480e9d;},_0x58bf(_0x2e670d,_0x442c37);}var __decorate=this&&this[_0x1c397f(0x1fb)]||function(_0x3d0c13,_0x5b5623,_0x3f2398,_0x2090ab){const _0x301967=_0x1c397f;var _0x6ef60f=arguments[_0x301967(0x1c2)],_0x46ad31=_0x6ef60f<0x3?_0x5b5623:_0x2090ab===null?_0x2090ab=Object[_0x301967(0x20e)](_0x5b5623,_0x3f2398):_0x2090ab,_0x1f3b55;if(typeof Reflect===_0x301967(0x1c0)&&typeof Reflect['decorate']===_0x301967(0x1d8))_0x46ad31=Reflect[_0x301967(0x1fa)](_0x3d0c13,_0x5b5623,_0x3f2398,_0x2090ab);else{for(var _0x1da6bb=_0x3d0c13[_0x301967(0x1c2)]-0x1;_0x1da6bb>=0x0;_0x1da6bb--)if(_0x1f3b55=_0x3d0c13[_0x1da6bb])_0x46ad31=(_0x6ef60f<0x3?_0x1f3b55(_0x46ad31):_0x6ef60f>0x3?_0x1f3b55(_0x5b5623,_0x3f2398,_0x46ad31):_0x1f3b55(_0x5b5623,_0x3f2398))||_0x46ad31;}return _0x6ef60f>0x3&&_0x46ad31&&Object[_0x301967(0x1c6)](_0x5b5623,_0x3f2398,_0x46ad31),_0x46ad31;},__metadata=this&&this[_0x1c397f(0x1d2)]||function(_0x5cfcc4,_0x286e74){const _0x5420fd=_0x1c397f;if(typeof Reflect===_0x5420fd(0x1c0)&&typeof Reflect[_0x5420fd(0x1ef)]===_0x5420fd(0x1d8))return Reflect[_0x5420fd(0x1ef)](_0x5cfcc4,_0x286e74);},__param=this&&this[_0x1c397f(0x1ea)]||function(_0xb1a085,_0x194886){return function(_0x3d63d1,_0x2ae3c9){_0x194886(_0x3d63d1,_0x2ae3c9,_0xb1a085);};};Object[_0x1c397f(0x1c6)](exports,_0x1c397f(0x1d3),{'value':!![]}),exports['ModelsService']=void 0x0;const status_constant_1=require('../../common/constants/status.constant'),utils_1=require(_0x1c397f(0x1e6)),common_1=require('@nestjs/common'),typeorm_1=require(_0x1c397f(0x1e0)),typeorm_2=require(_0x1c397f(0x214)),models_entity_1=require(_0x1c397f(0x1d1));function _0x4306(){const _0x2df777=['InjectRepository','find','timeout','getAllKey','assign','error:\x20','getSpecialModelKeyInfo','findOne','super','affected','from','keyPoolMap','key','getOwnPropertyDescriptor','HttpException','1611678JIMzxO','id\x20=\x20:id','modelName','keyType','typeorm','hideString','log','794253TTwwvj','keyPoolIndexMap','HttpStatus','useToken\x20+\x20','44960NvnQdF','getBaseConfig','object','update','length','set','modelTypes','keyStatus','defineProperty','stringify','error','Logger','3409cKnoHU','model','keys','BAD_REQUEST','Like','42NNVLcd','ModelsMapCn','./models.entity','__metadata','__esModule','setModel','234AtCsUa','ASC','deduct','function','当前账号不存在！','parse','modelOrder','where','save','modelMaps','map','@nestjs/typeorm','reduce','push','Injectable','queryModelType','3345204fBYjVp','../../common/utils','forEach','setModelType','1269455YQbaYV','__param','design:paramtypes','modelsList','status','184HIIRyv','metadata','17564676QuLOPu','initCalcKey','11TBVtIf','key:\x20','3zEHJHT','keyList','\x20欠费或被官方封禁导致不可用，已被系统自动锁定','findAndCount','getCurrentModelKeyInfo','ModelsEntity','decorate','__decorate','midjourney','values','queryModels','modelsEntity','saveUseLog'];_0x4306=function(){return _0x2df777;};return _0x4306();}let ModelsService=class ModelsService{constructor(_0x1af414){const _0x19cafd=_0x1c397f;this[_0x19cafd(0x1ff)]=_0x1af414,this[_0x19cafd(0x1c4)]=[],this['modelMaps']={},this['keyList']={},this[_0x19cafd(0x20c)]={},this[_0x19cafd(0x218)]={};}async['onModuleInit'](){const _0x422ac5=_0x1c397f;await this[_0x422ac5(0x1f1)]();}async['initCalcKey'](){const _0x483854=_0x1c397f;this[_0x483854(0x20c)]={},this[_0x483854(0x218)]={},this[_0x483854(0x1f5)]={},this['modelMaps']={},this[_0x483854(0x1c4)]=[];const _0x5bfab0=await this[_0x483854(0x1ff)][_0x483854(0x202)]({'where':{'status':!![]}}),_0x256f22=_0x5bfab0[_0x483854(0x1e1)]((_0x1c14a0,_0x47dd8f)=>{const _0x44b69b=_0x483854;return!_0x1c14a0[_0x47dd8f[_0x44b69b(0x213)]]?_0x1c14a0[_0x47dd8f[_0x44b69b(0x213)]]=[_0x47dd8f]:_0x1c14a0[_0x47dd8f[_0x44b69b(0x213)]][_0x44b69b(0x1e2)](_0x47dd8f),_0x1c14a0;},{});this['modelTypes']=Object[_0x483854(0x1cc)](_0x256f22)['map'](_0xb3cd22=>{const _0x47021e=_0x483854;return{'label':status_constant_1[_0x47021e(0x1d0)][_0xb3cd22],'val':_0xb3cd22};}),this[_0x483854(0x1de)]=_0x256f22,this[_0x483854(0x1f5)]={},_0x5bfab0[_0x483854(0x1e7)](_0x42d656=>{const _0x578bbf=_0x483854,{keyType:_0x585a5d,model:_0xa8757d}=_0x42d656;if(!this[_0x578bbf(0x20c)][_0xa8757d])this[_0x578bbf(0x20c)][_0xa8757d]=[];this['keyPoolMap'][_0xa8757d]['push'](_0x42d656);if(!this[_0x578bbf(0x218)][_0xa8757d])this[_0x578bbf(0x218)][_0xa8757d]=0x0;if(!this[_0x578bbf(0x1f5)][_0x585a5d])this[_0x578bbf(0x1f5)][_0x585a5d]={};if(!this[_0x578bbf(0x1f5)][_0x585a5d][_0xa8757d])this[_0x578bbf(0x1f5)][_0x585a5d][_0xa8757d]=[];this[_0x578bbf(0x1f5)][_0x585a5d][_0xa8757d][_0x578bbf(0x1e2)](_0x42d656);});}async['lockKey'](_0x134415,_0x275370,_0x58c9ea=-0x1){const _0xe3b792=_0x1c397f,_0xbc5ed0=await this[_0xe3b792(0x1ff)][_0xe3b792(0x1c1)]({'id':_0x134415},{'status':![],'keyStatus':_0x58c9ea,'remark':_0x275370});common_1[_0xe3b792(0x1c9)][_0xe3b792(0x1c8)](_0xe3b792(0x1f3)+_0x134415+_0xe3b792(0x1f6)),this[_0xe3b792(0x1f1)]();}async[_0x1c397f(0x1f8)](_0x3483c4){const _0x1ccc5f=_0x1c397f;let _0x4f3905=await this['modelsEntity'][_0x1ccc5f(0x208)]({'where':{'model':_0x3483c4}});if(!_0x4f3905)return null;return _0x4f3905;}async[_0x1c397f(0x207)](_0x5d1e7a){const _0x4295d5=_0x1c397f,_0x2fa91a=await this[_0x4295d5(0x1ff)][_0x4295d5(0x202)]({'where':{'model':(0x0,typeorm_2[_0x4295d5(0x1ce)])(_0x5d1e7a+'%')}});if(_0x2fa91a[_0x4295d5(0x1c2)]===0x0)throw new common_1[(_0x4295d5(0x20f))]('未找到匹配的模型，请重新选择模型！',common_1[_0x4295d5(0x219)][_0x4295d5(0x1cd)]);const _0x54f4aa=_0x2fa91a[0x0],_0x32c743=_0x54f4aa[_0x4295d5(0x1cb)]['replace'](_0x5d1e7a,''),_0xd73e17=Object[_0x4295d5(0x205)](Object[_0x4295d5(0x205)]({},_0x54f4aa),{'model':_0x32c743});return _0xd73e17;}async[_0x1c397f(0x21c)](){const _0x3f504c=_0x1c397f;if(!this['modelTypes'][_0x3f504c(0x1c2)]||!Object['keys'](this[_0x3f504c(0x1de)])['length'])return;const {keyType:_0x53514f,modelName:_0x297458,model:_0x5b66b5,deductType:_0x4323ff,deduct:_0xb5d44,isFileUpload:_0x122f17,modelAvatar:_0x19d872,modelDescription:_0x35044d}=this[_0x3f504c(0x1de)][0x1][0x0];return{'modelInfo':{'keyType':_0x53514f,'modelName':_0x297458,'model':_0x5b66b5,'deductType':_0x4323ff,'deduct':_0xb5d44,'isFileUpload':_0x122f17,'modelAvatar':_0x19d872,'modelDescription':_0x35044d}};}async[_0x1c397f(0x1d4)](_0x349ce5){const _0x55ae14=_0x1c397f;try{isNaN(_0x349ce5[_0x55ae14(0x203)])&&(_0x349ce5[_0x55ae14(0x203)]=null);const {id:_0x4b393b}=_0x349ce5;_0x349ce5[_0x55ae14(0x1ed)]&&(_0x349ce5['keyStatus']=0x1);if(_0x4b393b){const _0x2ce312=await this[_0x55ae14(0x1ff)][_0x55ae14(0x1c1)]({'id':_0x4b393b},_0x349ce5);return await this[_0x55ae14(0x1f1)](),_0x2ce312[_0x55ae14(0x20a)]>0x0;}else{const {keyType:_0x123a15,key:_0x916e08}=_0x349ce5;if(Number(_0x123a15!==0x1)){const _0x186f7d=await this[_0x55ae14(0x1ff)]['save'](_0x349ce5);return await this[_0x55ae14(0x1f1)](),_0x186f7d;}else{const _0x10508b=_0x916e08[_0x55ae14(0x1df)](_0x1a3b42=>{const _0x5ee51d=_0x55ae14;try{const _0x35c87e=JSON[_0x5ee51d(0x1da)](JSON[_0x5ee51d(0x1c7)](_0x349ce5));return _0x35c87e['key']=_0x1a3b42,isNaN(_0x35c87e[_0x5ee51d(0x203)])&&(_0x35c87e[_0x5ee51d(0x203)]=null),_0x35c87e;}catch(_0x475b84){console[_0x5ee51d(0x216)]('parse\x20error:\x20',_0x475b84);}}),_0xa10e7b=await this[_0x55ae14(0x1ff)][_0x55ae14(0x1dd)](_0x10508b);return await this[_0x55ae14(0x1f1)](),_0xa10e7b;}}}catch(_0x5ab239){console[_0x55ae14(0x216)](_0x55ae14(0x206),_0x5ab239);}}async['delModel']({id:_0x582ca7}){const _0xd7dfa3=_0x1c397f;if(!_0x582ca7)throw new common_1['HttpException']('缺失必要参数！',common_1['HttpStatus'][_0xd7dfa3(0x1cd)]);const _0x27f8a2=await this['modelsEntity'][_0xd7dfa3(0x208)]({'where':{'id':_0x582ca7}});if(!_0x27f8a2)throw new common_1[(_0xd7dfa3(0x20f))](_0xd7dfa3(0x1d9),common_1[_0xd7dfa3(0x219)][_0xd7dfa3(0x1cd)]);const _0x1e83cc=await this[_0xd7dfa3(0x1ff)]['delete']({'id':_0x582ca7});return await this[_0xd7dfa3(0x1f1)](),_0x1e83cc;}async[_0x1c397f(0x1fe)](_0xcaa875,_0x1fdfbb){const _0x4e85e0=_0x1c397f,{role:_0x49e299}=_0xcaa875['user'],{keyType:_0x112ddf,key:_0x69b54e,status:_0x393082,model:_0x463132,page:page=0x1,size:size=0xa}=_0x1fdfbb;let _0x342b02={};_0x112ddf&&(_0x342b02[_0x4e85e0(0x213)]=_0x112ddf),_0x463132&&(_0x342b02[_0x4e85e0(0x1cb)]=_0x463132),_0x393082&&(_0x342b02[_0x4e85e0(0x1ed)]=Number(_0x393082)===0x1?!![]:![]),_0x69b54e&&(_0x342b02['key']=(0x0,typeorm_2[_0x4e85e0(0x1ce)])('%'+_0x69b54e+'%'));const [_0x27b18e,_0x59453f]=await this[_0x4e85e0(0x1ff)][_0x4e85e0(0x1f7)]({'where':_0x342b02,'order':{'modelOrder':_0x4e85e0(0x1d6)},'skip':(page-0x1)*size,'take':size});return _0x49e299!==_0x4e85e0(0x209)&&_0x27b18e[_0x4e85e0(0x1e7)](_0x190eae=>{const _0x1fcd9a=_0x4e85e0;_0x190eae[_0x1fcd9a(0x20d)]&&(_0x190eae[_0x1fcd9a(0x20d)]=(0x0,utils_1[_0x1fcd9a(0x215)])(_0x190eae[_0x1fcd9a(0x20d)]));}),{'rows':_0x27b18e,'count':_0x59453f};}async[_0x1c397f(0x1ec)](){const _0x9882bc=_0x1c397f,_0x3838f0=JSON['parse'](JSON[_0x9882bc(0x1c7)](this['modelMaps']));return Object['keys'](_0x3838f0)[_0x9882bc(0x1e7)](_0x1d1685=>{const _0x387152=_0x9882bc;_0x3838f0[_0x1d1685]=_0x3838f0[_0x1d1685]['filter'](_0x17d699=>_0x17d699[_0x387152(0x1c5)]===0x1)['sort']((_0x225c1f,_0x1f9bf0)=>_0x225c1f['modelOrder']-_0x1f9bf0[_0x387152(0x1db)]),_0x3838f0[_0x1d1685]=Array[_0x387152(0x20b)](_0x3838f0[_0x1d1685]['map'](_0x5df163=>{const {modelName:_0x2bcb22,keyType:_0x4bbcc9,model:_0x460ca0,deduct:_0x30abc1,deductType:_0x328d62,maxRounds:_0x197748,modelAvatar:_0x3d0b66,isFileUpload:_0xa1f3c7,modelDescription:_0x2c44b0}=_0x5df163;return{'modelName':_0x2bcb22,'keyType':_0x4bbcc9,'model':_0x460ca0,'deduct':_0x30abc1,'deductType':_0x328d62,'maxRounds':_0x197748,'modelAvatar':_0x3d0b66,'isFileUpload':_0xa1f3c7,'modelDescription':_0x2c44b0};})[_0x387152(0x1e1)]((_0xc81a9a,_0x5a324b)=>_0xc81a9a[_0x387152(0x1c3)](_0x5a324b[_0x387152(0x212)],_0x5a324b),new Map())[_0x387152(0x1fd)]());}),{'modelTypeList':this[_0x9882bc(0x1c4)],'modelMaps':_0x3838f0};}async['getMjInfo'](){const _0x4e1653=_0x1c397f,_0x28c583=await this[_0x4e1653(0x1ff)][_0x4e1653(0x208)]({'where':{'model':_0x4e1653(0x1fc)}});return _0x28c583?{'modelName':_0x28c583[_0x4e1653(0x212)],'model':_0x28c583[_0x4e1653(0x1cb)],'deduct':_0x28c583[_0x4e1653(0x1d7)],'deductType':_0x28c583['deductType']}:null;}async[_0x1c397f(0x200)](_0x109eda,_0x32d3e0){const _0x3cd12e=_0x1c397f;await this[_0x3cd12e(0x1ff)]['createQueryBuilder']()[_0x3cd12e(0x1c1)](models_entity_1[_0x3cd12e(0x1f9)])['set']({'useCount':()=>'useCount\x20+\x201','useToken':()=>_0x3cd12e(0x21a)+_0x32d3e0})[_0x3cd12e(0x1dc)](_0x3cd12e(0x211),{'id':_0x109eda})['execute']();}async[_0x1c397f(0x204)](){const _0x1d3059=_0x1c397f;return await this[_0x1d3059(0x1ff)][_0x1d3059(0x202)]();}async[_0x1c397f(0x1e4)](_0x4f9b53){return 0x1;}async[_0x1c397f(0x1e8)](_0xda0af3){return 0x1;}async['delModelType'](_0x36a85e){return 0x1;}async['getModelConfigByName'](_0x1832a0){const _0x56592c=_0x1c397f,_0x37e59d=await this[_0x56592c(0x1ff)][_0x56592c(0x208)]({'where':{'model':_0x1832a0,'status':!![],'keyStatus':0x1}});return _0x37e59d;}};ModelsService=__decorate([(0x0,common_1[_0x1c397f(0x1e3)])(),__param(0x0,(0x0,typeorm_1[_0x1c397f(0x201)])(models_entity_1[_0x1c397f(0x1f9)])),__metadata(_0x1c397f(0x1eb),[typeorm_2['Repository']])],ModelsService),exports['ModelsService']=ModelsService;