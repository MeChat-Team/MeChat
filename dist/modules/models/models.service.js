'use strict';const _0x5e2e9e=_0x39f6;(function(_0x4ebb99,_0x48fc97){const _0x588945=_0x39f6,_0x1dd02f=_0x4ebb99();while(!![]){try{const _0x2852ce=-parseInt(_0x588945(0x189))/0x1+-parseInt(_0x588945(0x193))/0x2*(-parseInt(_0x588945(0x19b))/0x3)+parseInt(_0x588945(0x1a6))/0x4+-parseInt(_0x588945(0x17d))/0x5*(-parseInt(_0x588945(0x158))/0x6)+-parseInt(_0x588945(0x180))/0x7*(-parseInt(_0x588945(0x196))/0x8)+-parseInt(_0x588945(0x169))/0x9+-parseInt(_0x588945(0x1a4))/0xa;if(_0x2852ce===_0x48fc97)break;else _0x1dd02f['push'](_0x1dd02f['shift']());}catch(_0x19a1b2){_0x1dd02f['push'](_0x1dd02f['shift']());}}}(_0x2200,0x66224));var __decorate=this&&this[_0x5e2e9e(0x198)]||function(_0x1324f8,_0x3c6c9d,_0x2be964,_0x47f363){const _0x28bfbd=_0x5e2e9e;var _0x47ab19=arguments[_0x28bfbd(0x1ae)],_0x21a8da=_0x47ab19<0x3?_0x3c6c9d:_0x47f363===null?_0x47f363=Object['getOwnPropertyDescriptor'](_0x3c6c9d,_0x2be964):_0x47f363,_0x2ecf32;if(typeof Reflect===_0x28bfbd(0x1ab)&&typeof Reflect[_0x28bfbd(0x17b)]===_0x28bfbd(0x1a8))_0x21a8da=Reflect[_0x28bfbd(0x17b)](_0x1324f8,_0x3c6c9d,_0x2be964,_0x47f363);else{for(var _0x1279c9=_0x1324f8[_0x28bfbd(0x1ae)]-0x1;_0x1279c9>=0x0;_0x1279c9--)if(_0x2ecf32=_0x1324f8[_0x1279c9])_0x21a8da=(_0x47ab19<0x3?_0x2ecf32(_0x21a8da):_0x47ab19>0x3?_0x2ecf32(_0x3c6c9d,_0x2be964,_0x21a8da):_0x2ecf32(_0x3c6c9d,_0x2be964))||_0x21a8da;}return _0x47ab19>0x3&&_0x21a8da&&Object['defineProperty'](_0x3c6c9d,_0x2be964,_0x21a8da),_0x21a8da;},__metadata=this&&this['__metadata']||function(_0x4dc5da,_0x3bc989){const _0x9d097d=_0x5e2e9e;if(typeof Reflect===_0x9d097d(0x1ab)&&typeof Reflect['metadata']===_0x9d097d(0x1a8))return Reflect[_0x9d097d(0x16b)](_0x4dc5da,_0x3bc989);},__param=this&&this[_0x5e2e9e(0x16a)]||function(_0x466ad5,_0x3a5779){return function(_0x29d7b9,_0x50387b){_0x3a5779(_0x29d7b9,_0x50387b,_0x466ad5);};};Object[_0x5e2e9e(0x164)](exports,_0x5e2e9e(0x183),{'value':!![]}),exports['ModelsService']=void 0x0;const status_constant_1=require('../../common/constants/status.constant'),utils_1=require(_0x5e2e9e(0x19f)),common_1=require(_0x5e2e9e(0x1a9)),typeorm_1=require(_0x5e2e9e(0x178)),typeorm_2=require(_0x5e2e9e(0x157)),models_entity_1=require(_0x5e2e9e(0x17e));function _0x2200(){const _0x406949=['@nestjs/common','ModelsEntity','object','replace','execute','length','saveUseLog','HttpException','assign','filter','timeout','where','status','未找到匹配的模型，请重新选择模型！','typeorm','6xaRtrJ','design:paramtypes','Injectable','ASC','getSpecialModelKeyInfo','getCurrentModelKeyInfo','ModelsMapCn','setModel','modelOrder','from','modelsList','useToken\x20+\x20','defineProperty','keyList','forEach','keyPoolIndexMap','log','1802763tKDAug','__param','metadata','hideString','HttpStatus','key','Like','ModelsService','lockKey','values','error:\x20','keyType','keyPoolMap','error','createQueryBuilder','@nestjs/typeorm','delModel','key:\x20','decorate','queryModels','651445URsVgA','./models.entity','getModelConfigByName','23443AoNSza','modelsEntity','findOne','__esModule','initCalcKey','update','model','getAllKey','getBaseConfig','414164SzishH','modelName','stringify','modelMaps','push','findAndCount','InjectRepository','deductType','save','Repository','246GfOJqS','set','reduce','1656whjAmK','setModelType','__decorate','\x20欠费或被官方封禁导致不可用，已被系统自动锁定','当前账号不存在！','16521pcKnGW','keys','map','super','../../common/utils','find','modelTypes','queryModelType','BAD_REQUEST','12438150elBUHL','Logger','3102932HYoMkM','parse','function'];_0x2200=function(){return _0x406949;};return _0x2200();}function _0x39f6(_0x1aa8c0,_0x220061){const _0x2200e2=_0x2200();return _0x39f6=function(_0x39f62a,_0x1e3903){_0x39f62a=_0x39f62a-0x153;let _0x4fd5d3=_0x2200e2[_0x39f62a];return _0x4fd5d3;},_0x39f6(_0x1aa8c0,_0x220061);}let ModelsService=class ModelsService{constructor(_0x32fe54){const _0x3e8118=_0x5e2e9e;this[_0x3e8118(0x181)]=_0x32fe54,this[_0x3e8118(0x1a1)]=[],this[_0x3e8118(0x18c)]={},this[_0x3e8118(0x165)]={},this[_0x3e8118(0x175)]={},this[_0x3e8118(0x167)]={};}async['onModuleInit'](){await this['initCalcKey']();}async[_0x5e2e9e(0x184)](){const _0x5b3800=_0x5e2e9e;this[_0x5b3800(0x175)]={},this[_0x5b3800(0x167)]={},this[_0x5b3800(0x165)]={},this[_0x5b3800(0x18c)]={},this[_0x5b3800(0x1a1)]=[];const _0x2226a6=await this[_0x5b3800(0x181)][_0x5b3800(0x1a0)]({'where':{'status':!![]}}),_0x17813a=_0x2226a6['reduce']((_0x2b800d,_0x17b679)=>{const _0x426e22=_0x5b3800;return!_0x2b800d[_0x17b679[_0x426e22(0x174)]]?_0x2b800d[_0x17b679[_0x426e22(0x174)]]=[_0x17b679]:_0x2b800d[_0x17b679['keyType']][_0x426e22(0x18d)](_0x17b679),_0x2b800d;},{});this[_0x5b3800(0x1a1)]=Object[_0x5b3800(0x19c)](_0x17813a)[_0x5b3800(0x19d)](_0x13f4af=>{const _0x152fe3=_0x5b3800;return{'label':status_constant_1[_0x152fe3(0x15e)][_0x13f4af],'val':_0x13f4af};}),this[_0x5b3800(0x18c)]=_0x17813a,this[_0x5b3800(0x165)]={},_0x2226a6[_0x5b3800(0x166)](_0xe2ee37=>{const _0x1ffbe7=_0x5b3800,{keyType:_0x448411,model:_0x3fda98}=_0xe2ee37;if(!this['keyPoolMap'][_0x3fda98])this[_0x1ffbe7(0x175)][_0x3fda98]=[];this[_0x1ffbe7(0x175)][_0x3fda98][_0x1ffbe7(0x18d)](_0xe2ee37);if(!this[_0x1ffbe7(0x167)][_0x3fda98])this[_0x1ffbe7(0x167)][_0x3fda98]=0x0;if(!this[_0x1ffbe7(0x165)][_0x448411])this[_0x1ffbe7(0x165)][_0x448411]={};if(!this[_0x1ffbe7(0x165)][_0x448411][_0x3fda98])this['keyList'][_0x448411][_0x3fda98]=[];this['keyList'][_0x448411][_0x3fda98][_0x1ffbe7(0x18d)](_0xe2ee37);});}async[_0x5e2e9e(0x171)](_0x29f7a0,_0xc294a3,_0x3df8d3=-0x1){const _0x280bbb=_0x5e2e9e,_0x219f97=await this['modelsEntity']['update']({'id':_0x29f7a0},{'status':![],'keyStatus':_0x3df8d3,'remark':_0xc294a3});common_1[_0x280bbb(0x1a5)][_0x280bbb(0x176)](_0x280bbb(0x17a)+_0x29f7a0+_0x280bbb(0x199)),this['initCalcKey']();}async[_0x5e2e9e(0x15d)](_0x3eb26e){const _0x2c074e=_0x5e2e9e;let _0x3def0b=await this[_0x2c074e(0x181)][_0x2c074e(0x182)]({'where':{'model':_0x3eb26e}});if(!_0x3def0b)return null;return _0x3def0b;}async[_0x5e2e9e(0x15c)](_0x15f02b){const _0x1391b2=_0x5e2e9e,_0x2fabe6=await this[_0x1391b2(0x181)]['find']({'where':{'model':(0x0,typeorm_2[_0x1391b2(0x16f)])(_0x15f02b+'%')}});if(_0x2fabe6[_0x1391b2(0x1ae)]===0x0)throw new common_1[(_0x1391b2(0x1b0))](_0x1391b2(0x156),common_1[_0x1391b2(0x16d)]['BAD_REQUEST']);const _0x3c357d=_0x2fabe6[0x0],_0x1b5efb=_0x3c357d['model'][_0x1391b2(0x1ac)](_0x15f02b,''),_0xcc8dc0=Object[_0x1391b2(0x1b1)](Object[_0x1391b2(0x1b1)]({},_0x3c357d),{'model':_0x1b5efb});return _0xcc8dc0;}async[_0x5e2e9e(0x188)](){const _0x3ee228=_0x5e2e9e;if(!this['modelTypes']['length']||!Object[_0x3ee228(0x19c)](this[_0x3ee228(0x18c)])['length'])return;const {keyType:_0xd0b40b,modelName:_0x2e9bed,model:_0x4e6b72,deductType:_0x2f06c5,deduct:_0x7b7dbb,isFileUpload:_0x5442aa,modelAvatar:_0x1f2301,modelDescription:_0x3e31e0}=this[_0x3ee228(0x18c)][0x1][0x0];return{'modelInfo':{'keyType':_0xd0b40b,'modelName':_0x2e9bed,'model':_0x4e6b72,'deductType':_0x2f06c5,'deduct':_0x7b7dbb,'isFileUpload':_0x5442aa,'modelAvatar':_0x1f2301,'modelDescription':_0x3e31e0}};}async[_0x5e2e9e(0x15f)](_0x227661){const _0x11a852=_0x5e2e9e;try{isNaN(_0x227661['timeout'])&&(_0x227661[_0x11a852(0x153)]=null);const {id:_0x280830}=_0x227661;_0x227661[_0x11a852(0x155)]&&(_0x227661['keyStatus']=0x1);if(_0x280830){const _0x1c9693=await this['modelsEntity']['update']({'id':_0x280830},_0x227661);return await this[_0x11a852(0x184)](),_0x1c9693['affected']>0x0;}else{const {keyType:_0x244fb0,key:_0x5a78e9}=_0x227661;if(Number(_0x244fb0!==0x1)){const _0x5bc40a=await this['modelsEntity'][_0x11a852(0x191)](_0x227661);return await this[_0x11a852(0x184)](),_0x5bc40a;}else{const _0x575743=_0x5a78e9[_0x11a852(0x19d)](_0x54c258=>{const _0x57df69=_0x11a852;try{const _0x40eb9d=JSON[_0x57df69(0x1a7)](JSON[_0x57df69(0x18b)](_0x227661));return _0x40eb9d[_0x57df69(0x16e)]=_0x54c258,isNaN(_0x40eb9d[_0x57df69(0x153)])&&(_0x40eb9d[_0x57df69(0x153)]=null),_0x40eb9d;}catch(_0x2635a9){console[_0x57df69(0x168)]('parse\x20error:\x20',_0x2635a9);}}),_0x1d7ddc=await this[_0x11a852(0x181)][_0x11a852(0x191)](_0x575743);return await this[_0x11a852(0x184)](),_0x1d7ddc;}}}catch(_0x530687){console[_0x11a852(0x168)](_0x11a852(0x173),_0x530687);}}async[_0x5e2e9e(0x179)]({id:_0x4db4a5}){const _0x5417b4=_0x5e2e9e;if(!_0x4db4a5)throw new common_1[(_0x5417b4(0x1b0))]('缺失必要参数！',common_1['HttpStatus']['BAD_REQUEST']);const _0x571cf7=await this[_0x5417b4(0x181)][_0x5417b4(0x182)]({'where':{'id':_0x4db4a5}});if(!_0x571cf7)throw new common_1['HttpException'](_0x5417b4(0x19a),common_1[_0x5417b4(0x16d)][_0x5417b4(0x1a3)]);const _0x464a50=await this[_0x5417b4(0x181)]['delete']({'id':_0x4db4a5});return await this['initCalcKey'](),_0x464a50;}async[_0x5e2e9e(0x17c)](_0x2b61cf,_0x1da27a){const _0x5d357c=_0x5e2e9e,{role:_0x13da30}=_0x2b61cf['user'],{keyType:_0x169c7d,key:_0x4cf9aa,status:_0x161efe,model:_0x409e42,page:page=0x1,size:size=0xa}=_0x1da27a;let _0x75eb41={};_0x169c7d&&(_0x75eb41[_0x5d357c(0x174)]=_0x169c7d),_0x409e42&&(_0x75eb41[_0x5d357c(0x186)]=_0x409e42),_0x161efe&&(_0x75eb41[_0x5d357c(0x155)]=Number(_0x161efe)===0x1?!![]:![]),_0x4cf9aa&&(_0x75eb41[_0x5d357c(0x16e)]=(0x0,typeorm_2[_0x5d357c(0x16f)])('%'+_0x4cf9aa+'%'));const [_0x3bcca0,_0x48fc84]=await this[_0x5d357c(0x181)][_0x5d357c(0x18e)]({'where':_0x75eb41,'order':{'modelOrder':_0x5d357c(0x15b)},'skip':(page-0x1)*size,'take':size});return _0x13da30!==_0x5d357c(0x19e)&&_0x3bcca0[_0x5d357c(0x166)](_0x10a318=>{const _0x34e770=_0x5d357c;_0x10a318[_0x34e770(0x16e)]&&(_0x10a318['key']=(0x0,utils_1[_0x34e770(0x16c)])(_0x10a318[_0x34e770(0x16e)]));}),{'rows':_0x3bcca0,'count':_0x48fc84};}async[_0x5e2e9e(0x162)](){const _0x1cf992=_0x5e2e9e,_0x4fdf68=JSON['parse'](JSON[_0x1cf992(0x18b)](this[_0x1cf992(0x18c)]));return Object[_0x1cf992(0x19c)](_0x4fdf68)[_0x1cf992(0x166)](_0x517eee=>{const _0x423269=_0x1cf992;_0x4fdf68[_0x517eee]=_0x4fdf68[_0x517eee][_0x423269(0x1b2)](_0x348c1a=>_0x348c1a['keyStatus']===0x1)['sort']((_0x3efbe8,_0x43a791)=>_0x3efbe8[_0x423269(0x160)]-_0x43a791[_0x423269(0x160)]),_0x4fdf68[_0x517eee]=Array[_0x423269(0x161)](_0x4fdf68[_0x517eee][_0x423269(0x19d)](_0x4162ad=>{const {modelName:_0x3f8339,keyType:_0x1e8e4,model:_0x4a1d18,deduct:_0x314d78,deductType:_0x35f2aa,maxRounds:_0x477b27,modelAvatar:_0x4edb28,isFileUpload:_0x2f7f49,modelDescription:_0x5f4a26}=_0x4162ad;return{'modelName':_0x3f8339,'keyType':_0x1e8e4,'model':_0x4a1d18,'deduct':_0x314d78,'deductType':_0x35f2aa,'maxRounds':_0x477b27,'modelAvatar':_0x4edb28,'isFileUpload':_0x2f7f49,'modelDescription':_0x5f4a26};})[_0x423269(0x195)]((_0x383d29,_0x33e558)=>_0x383d29[_0x423269(0x194)](_0x33e558[_0x423269(0x18a)],_0x33e558),new Map())[_0x423269(0x172)]());}),{'modelTypeList':this[_0x1cf992(0x1a1)],'modelMaps':_0x4fdf68};}async['getMjInfo'](){const _0x6e0c38=_0x5e2e9e,_0x23d0fb=await this[_0x6e0c38(0x181)]['findOne']({'where':{'model':'midjourney'}});return _0x23d0fb?{'modelName':_0x23d0fb['modelName'],'model':_0x23d0fb[_0x6e0c38(0x186)],'deduct':_0x23d0fb['deduct'],'deductType':_0x23d0fb[_0x6e0c38(0x190)]}:null;}async[_0x5e2e9e(0x1af)](_0x21e435,_0xc0f78f){const _0x3e6395=_0x5e2e9e;await this[_0x3e6395(0x181)][_0x3e6395(0x177)]()[_0x3e6395(0x185)](models_entity_1[_0x3e6395(0x1aa)])[_0x3e6395(0x194)]({'useCount':()=>'useCount\x20+\x201','useToken':()=>_0x3e6395(0x163)+_0xc0f78f})[_0x3e6395(0x154)]('id\x20=\x20:id',{'id':_0x21e435})[_0x3e6395(0x1ad)]();}async[_0x5e2e9e(0x187)](){const _0x2fcad9=_0x5e2e9e;return await this[_0x2fcad9(0x181)][_0x2fcad9(0x1a0)]();}async[_0x5e2e9e(0x1a2)](_0x53035f){return 0x1;}async[_0x5e2e9e(0x197)](_0x51af7c){return 0x1;}async['delModelType'](_0x597fc0){return 0x1;}async[_0x5e2e9e(0x17f)](_0x3219b4){const _0x2d9960=_0x5e2e9e,_0x4f0af6=await this[_0x2d9960(0x181)][_0x2d9960(0x182)]({'where':{'model':_0x3219b4,'status':!![],'keyStatus':0x1}});return _0x4f0af6;}};ModelsService=__decorate([(0x0,common_1[_0x5e2e9e(0x15a)])(),__param(0x0,(0x0,typeorm_1[_0x5e2e9e(0x18f)])(models_entity_1['ModelsEntity'])),__metadata(_0x5e2e9e(0x159),[typeorm_2[_0x5e2e9e(0x192)]])],ModelsService),exports[_0x5e2e9e(0x170)]=ModelsService;