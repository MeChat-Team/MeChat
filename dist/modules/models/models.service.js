'use strict';const _0x56a458=_0x447e;(function(_0x2283a2,_0x42d1f0){const _0x1edc1a=_0x447e,_0x3b58a9=_0x2283a2();while(!![]){try{const _0x21ec6f=parseInt(_0x1edc1a(0x171))/0x1*(parseInt(_0x1edc1a(0x189))/0x2)+parseInt(_0x1edc1a(0x148))/0x3+-parseInt(_0x1edc1a(0x15e))/0x4+parseInt(_0x1edc1a(0x18a))/0x5+-parseInt(_0x1edc1a(0x170))/0x6+parseInt(_0x1edc1a(0x184))/0x7+parseInt(_0x1edc1a(0x152))/0x8;if(_0x21ec6f===_0x42d1f0)break;else _0x3b58a9['push'](_0x3b58a9['shift']());}catch(_0x56d88a){_0x3b58a9['push'](_0x3b58a9['shift']());}}}(_0x26bc,0x61242));function _0x447e(_0x40a46b,_0x1e0803){const _0x26bca4=_0x26bc();return _0x447e=function(_0x447ea3,_0x1d507c){_0x447ea3=_0x447ea3-0x13e;let _0x1506e9=_0x26bca4[_0x447ea3];return _0x1506e9;},_0x447e(_0x40a46b,_0x1e0803);}var __decorate=this&&this['__decorate']||function(_0x4c2262,_0x300cb0,_0x12aaba,_0x5e0430){const _0x5591c9=_0x447e;var _0x18daef=arguments[_0x5591c9(0x175)],_0x1b860d=_0x18daef<0x3?_0x300cb0:_0x5e0430===null?_0x5e0430=Object[_0x5591c9(0x15c)](_0x300cb0,_0x12aaba):_0x5e0430,_0x497c8d;if(typeof Reflect===_0x5591c9(0x182)&&typeof Reflect[_0x5591c9(0x187)]===_0x5591c9(0x155))_0x1b860d=Reflect['decorate'](_0x4c2262,_0x300cb0,_0x12aaba,_0x5e0430);else{for(var _0x3ee15c=_0x4c2262[_0x5591c9(0x175)]-0x1;_0x3ee15c>=0x0;_0x3ee15c--)if(_0x497c8d=_0x4c2262[_0x3ee15c])_0x1b860d=(_0x18daef<0x3?_0x497c8d(_0x1b860d):_0x18daef>0x3?_0x497c8d(_0x300cb0,_0x12aaba,_0x1b860d):_0x497c8d(_0x300cb0,_0x12aaba))||_0x1b860d;}return _0x18daef>0x3&&_0x1b860d&&Object[_0x5591c9(0x160)](_0x300cb0,_0x12aaba,_0x1b860d),_0x1b860d;},__metadata=this&&this[_0x56a458(0x14e)]||function(_0x19b285,_0x48949b){const _0x4dd162=_0x56a458;if(typeof Reflect==='object'&&typeof Reflect[_0x4dd162(0x151)]==='function')return Reflect[_0x4dd162(0x151)](_0x19b285,_0x48949b);},__param=this&&this['__param']||function(_0x169d04,_0x357b65){return function(_0x39eb76,_0x113aae){_0x357b65(_0x39eb76,_0x113aae,_0x169d04);};};function _0x26bc(){const _0xdb3cc5=['sort','key','decorate','setModel','1532ugmxsW','1908030ZWKwpB','isTokenBased','status','delModelType','Repository','initCalcKey','Like','findAndCount','__esModule','model','update','user','replace','setModelType','createQueryBuilder','forEach','midjourney','error:\x20','onModuleInit','error','parse\x20error:\x20','modelsList','缺失必要参数！','assign','useToken\x20+\x20','delModel','@nestjs/typeorm','keyStatus','21816AwbNTD','modelLimits','find','当前账号不存在！','modelMaps','getModelConfigByName','__metadata','getSpecialModelKeyInfo','HttpException','metadata','94272pyUUHw','keyPoolIndexMap','BAD_REQUEST','function','queryModelType','keyPoolMap','../../common/utils','push','../../common/constants/status.constant','from','getOwnPropertyDescriptor','parse','1890172EtDSvV','ModelsService','defineProperty','keyList','HttpStatus','modelsEntity','map','modelTypes','findOne','id\x20=\x20:id','Logger','keys','lockKey','timeout','getMjInfo','modelName','\x20欠费或被官方封禁导致不可用，已被系统自动锁定','where','2788776bzUtyx','293KClMQD','Injectable','deduct','typeorm','length','reduce','save','@nestjs/common','useCount\x20+\x201','delete','未找到匹配的模型，请重新选择模型！','ASC','modelOrder','key:\x20','log','keyType','getBaseConfig','object','stringify','4970903yNsbkw'];_0x26bc=function(){return _0xdb3cc5;};return _0x26bc();}Object[_0x56a458(0x160)](exports,_0x56a458(0x192),{'value':!![]}),exports['ModelsService']=void 0x0;const status_constant_1=require(_0x56a458(0x15a)),utils_1=require(_0x56a458(0x158)),common_1=require(_0x56a458(0x178)),typeorm_1=require(_0x56a458(0x146)),typeorm_2=require(_0x56a458(0x174)),models_entity_1=require('./models.entity');let ModelsService=class ModelsService{constructor(_0x5c620e){const _0x2454e3=_0x56a458;this['modelsEntity']=_0x5c620e,this[_0x2454e3(0x165)]=[],this[_0x2454e3(0x14c)]={},this[_0x2454e3(0x161)]={},this[_0x2454e3(0x157)]={},this['keyPoolIndexMap']={};}async[_0x56a458(0x13e)](){const _0x37b681=_0x56a458;await this[_0x37b681(0x18f)]();}async[_0x56a458(0x18f)](){const _0x3c8ecb=_0x56a458;this[_0x3c8ecb(0x157)]={},this[_0x3c8ecb(0x153)]={},this['keyList']={},this[_0x3c8ecb(0x14c)]={},this[_0x3c8ecb(0x165)]=[];const _0x2b1a7b=await this['modelsEntity'][_0x3c8ecb(0x14a)]({'where':{'status':!![]}}),_0x4c3dad=_0x2b1a7b[_0x3c8ecb(0x176)]((_0x5b578d,_0x2bd717)=>{const _0x275bbb=_0x3c8ecb;return!_0x5b578d[_0x2bd717[_0x275bbb(0x180)]]?_0x5b578d[_0x2bd717[_0x275bbb(0x180)]]=[_0x2bd717]:_0x5b578d[_0x2bd717['keyType']]['push'](_0x2bd717),_0x5b578d;},{});this[_0x3c8ecb(0x165)]=Object[_0x3c8ecb(0x169)](_0x4c3dad)['map'](_0x2095bb=>{return{'label':status_constant_1['ModelsMapCn'][_0x2095bb],'val':_0x2095bb};}),this[_0x3c8ecb(0x14c)]=_0x4c3dad,this[_0x3c8ecb(0x161)]={},_0x2b1a7b['forEach'](_0x4a3ff3=>{const _0x5bc8f2=_0x3c8ecb,{keyType:_0x2a5318,model:_0x51a647}=_0x4a3ff3;if(!this[_0x5bc8f2(0x157)][_0x51a647])this[_0x5bc8f2(0x157)][_0x51a647]=[];this[_0x5bc8f2(0x157)][_0x51a647][_0x5bc8f2(0x159)](_0x4a3ff3);if(!this[_0x5bc8f2(0x153)][_0x51a647])this[_0x5bc8f2(0x153)][_0x51a647]=0x0;if(!this[_0x5bc8f2(0x161)][_0x2a5318])this[_0x5bc8f2(0x161)][_0x2a5318]={};if(!this['keyList'][_0x2a5318][_0x51a647])this[_0x5bc8f2(0x161)][_0x2a5318][_0x51a647]=[];this[_0x5bc8f2(0x161)][_0x2a5318][_0x51a647][_0x5bc8f2(0x159)](_0x4a3ff3);});}async[_0x56a458(0x16a)](_0x3ea79c,_0x43fd65,_0x520169=-0x1){const _0x23f268=_0x56a458,_0x58b8e8=await this[_0x23f268(0x163)]['update']({'id':_0x3ea79c},{'status':![],'keyStatus':_0x520169,'remark':_0x43fd65});common_1[_0x23f268(0x168)][_0x23f268(0x13f)](_0x23f268(0x17e)+_0x3ea79c+_0x23f268(0x16e)),this[_0x23f268(0x18f)]();}async['getCurrentModelKeyInfo'](_0x5e736e){let _0x24d04b=await this['modelsEntity']['findOne']({'where':{'model':_0x5e736e}});if(!_0x24d04b)return null;return _0x24d04b;}async[_0x56a458(0x14f)](_0x5af74a){const _0xd3be2b=_0x56a458,_0x50e301=await this[_0xd3be2b(0x163)][_0xd3be2b(0x14a)]({'where':{'model':(0x0,typeorm_2[_0xd3be2b(0x190)])(_0x5af74a+'%')}});if(_0x50e301[_0xd3be2b(0x175)]===0x0)throw new common_1[(_0xd3be2b(0x150))](_0xd3be2b(0x17b),common_1[_0xd3be2b(0x162)][_0xd3be2b(0x154)]);const _0x3b1f6b=_0x50e301[0x0],_0x5720a5=_0x3b1f6b[_0xd3be2b(0x193)][_0xd3be2b(0x196)](_0x5af74a,''),_0xf9fa09=Object[_0xd3be2b(0x143)](Object[_0xd3be2b(0x143)]({},_0x3b1f6b),{'model':_0x5720a5});return _0xf9fa09;}async[_0x56a458(0x181)](){const _0x3200d8=_0x56a458;if(!this[_0x3200d8(0x165)][_0x3200d8(0x175)]||!Object[_0x3200d8(0x169)](this[_0x3200d8(0x14c)])[_0x3200d8(0x175)])return;const {keyType:_0x330dfe,modelName:_0x5c55d1,model:_0x50d5cc,deductType:_0x1f28af,deduct:_0x5d337f,isFileUpload:_0x5ba07d,modelAvatar:_0x2386f0,modelDescription:_0x408e3a}=this[_0x3200d8(0x14c)][0x1][0x0];return{'modelInfo':{'keyType':_0x330dfe,'modelName':_0x5c55d1,'model':_0x50d5cc,'deductType':_0x1f28af,'deduct':_0x5d337f,'isFileUpload':_0x5ba07d,'modelAvatar':_0x2386f0,'modelDescription':_0x408e3a}};}async[_0x56a458(0x188)](_0xcd301f){const _0x31c2a8=_0x56a458;try{isNaN(_0xcd301f[_0x31c2a8(0x16b)])&&(_0xcd301f[_0x31c2a8(0x16b)]=null);const {id:_0x4f28ab}=_0xcd301f;_0xcd301f[_0x31c2a8(0x18c)]&&(_0xcd301f[_0x31c2a8(0x147)]=0x1);if(_0x4f28ab){const _0x37d8da=await this[_0x31c2a8(0x163)][_0x31c2a8(0x194)]({'id':_0x4f28ab},_0xcd301f);return await this[_0x31c2a8(0x18f)](),_0x37d8da['affected']>0x0;}else{const {keyType:_0x1562ed,key:_0x587378}=_0xcd301f;if(Number(_0x1562ed!==0x1)){const _0x309972=await this[_0x31c2a8(0x163)][_0x31c2a8(0x177)](_0xcd301f);return await this['initCalcKey'](),_0x309972;}else{const _0xc96136=_0x587378[_0x31c2a8(0x164)](_0x5e0c02=>{const _0x570d47=_0x31c2a8;try{const _0x5bd73c=JSON[_0x570d47(0x15d)](JSON[_0x570d47(0x183)](_0xcd301f));return _0x5bd73c[_0x570d47(0x186)]=_0x5e0c02,isNaN(_0x5bd73c[_0x570d47(0x16b)])&&(_0x5bd73c[_0x570d47(0x16b)]=null),_0x5bd73c;}catch(_0xba10af){console[_0x570d47(0x17f)](_0x570d47(0x140),_0xba10af);}}),_0x301084=await this[_0x31c2a8(0x163)][_0x31c2a8(0x177)](_0xc96136);return await this[_0x31c2a8(0x18f)](),_0x301084;}}}catch(_0x22bde3){console['log'](_0x31c2a8(0x19b),_0x22bde3);}}async[_0x56a458(0x145)]({id:_0x2f91e4}){const _0x352548=_0x56a458;if(!_0x2f91e4)throw new common_1[(_0x352548(0x150))](_0x352548(0x142),common_1[_0x352548(0x162)][_0x352548(0x154)]);const _0x15ab2d=await this[_0x352548(0x163)][_0x352548(0x166)]({'where':{'id':_0x2f91e4}});if(!_0x15ab2d)throw new common_1[(_0x352548(0x150))](_0x352548(0x14b),common_1[_0x352548(0x162)][_0x352548(0x154)]);const _0x190de7=await this[_0x352548(0x163)][_0x352548(0x17a)]({'id':_0x2f91e4});return await this[_0x352548(0x18f)](),_0x190de7;}async['queryModels'](_0x4b7b80,_0xe30969){const _0x45b893=_0x56a458,{role:_0xf205f2}=_0x4b7b80[_0x45b893(0x195)],{keyType:_0x455e6d,key:_0x30d5ab,status:_0x184884,model:_0xfb129b,page:page=0x1,size:size=0xa}=_0xe30969;let _0x1d02f4={};_0x455e6d&&(_0x1d02f4[_0x45b893(0x180)]=_0x455e6d),_0xfb129b&&(_0x1d02f4[_0x45b893(0x193)]=_0xfb129b),_0x184884&&(_0x1d02f4[_0x45b893(0x18c)]=Number(_0x184884)===0x1?!![]:![]),_0x30d5ab&&(_0x1d02f4[_0x45b893(0x186)]=(0x0,typeorm_2[_0x45b893(0x190)])('%'+_0x30d5ab+'%'));const [_0x43a4cb,_0x5178ee]=await this[_0x45b893(0x163)][_0x45b893(0x191)]({'where':_0x1d02f4,'order':{'modelOrder':_0x45b893(0x17c)},'skip':(page-0x1)*size,'take':size});return _0xf205f2!=='super'&&_0x43a4cb[_0x45b893(0x199)](_0x386d21=>{const _0xb0d3a=_0x45b893;_0x386d21[_0xb0d3a(0x186)]&&(_0x386d21[_0xb0d3a(0x186)]=(0x0,utils_1['hideString'])(_0x386d21[_0xb0d3a(0x186)]));}),{'rows':_0x43a4cb,'count':_0x5178ee};}async[_0x56a458(0x141)](){const _0x5e6c19=_0x56a458,_0x3e1a2e=JSON[_0x5e6c19(0x15d)](JSON[_0x5e6c19(0x183)](this[_0x5e6c19(0x14c)]));return Object[_0x5e6c19(0x169)](_0x3e1a2e)[_0x5e6c19(0x199)](_0x3f003c=>{const _0x5627b4=_0x5e6c19;_0x3e1a2e[_0x3f003c]=_0x3e1a2e[_0x3f003c]['filter'](_0x38cda3=>_0x38cda3[_0x5627b4(0x147)]===0x1)[_0x5627b4(0x185)]((_0x1f1f99,_0x146b1e)=>_0x1f1f99[_0x5627b4(0x17d)]-_0x146b1e[_0x5627b4(0x17d)]),_0x3e1a2e[_0x3f003c]=Array[_0x5627b4(0x15b)](_0x3e1a2e[_0x3f003c][_0x5627b4(0x164)](_0x1b48d1=>{const _0x288a39=_0x5627b4,{modelName:_0x47c82f,keyType:_0x3715e9,model:_0x38556a,deduct:_0x44e4f3,deductType:_0xa7b660,maxRounds:_0x31b589,modelAvatar:_0x5b67ac,isFileUpload:_0xea739a,modelDescription:_0x2a2b3f}=_0x1b48d1;return{'modelName':_0x47c82f,'keyType':_0x3715e9,'model':_0x38556a,'deduct':_0x44e4f3,'deductType':_0xa7b660,'maxRounds':_0x31b589,'modelAvatar':_0x5b67ac,'isFileUpload':_0xea739a,'modelDescription':_0x2a2b3f,'isTokenBased':_0x1b48d1[_0x288a39(0x18b)],'maxModelTokens':_0x1b48d1['maxModelTokens'],'modelLimits':_0x1b48d1[_0x288a39(0x149)],'tokenFeeRatio':_0x1b48d1['tokenFeeRatio'],'modelOrder':_0x1b48d1[_0x288a39(0x17d)]};})[_0x5627b4(0x176)]((_0x25da84,_0x5baeb1)=>_0x25da84['set'](_0x5baeb1[_0x5627b4(0x16d)],_0x5baeb1),new Map())['values']());}),{'modelTypeList':this[_0x5e6c19(0x165)],'modelMaps':_0x3e1a2e};}async[_0x56a458(0x16c)](){const _0x2597f8=_0x56a458,_0x1a8d8f=await this[_0x2597f8(0x163)]['findOne']({'where':{'model':_0x2597f8(0x19a)}});return _0x1a8d8f?{'modelName':_0x1a8d8f[_0x2597f8(0x16d)],'model':_0x1a8d8f['model'],'deduct':_0x1a8d8f[_0x2597f8(0x173)],'deductType':_0x1a8d8f['deductType']}:null;}async['saveUseLog'](_0x4f52db,_0x593e71){const _0x47232a=_0x56a458;await this[_0x47232a(0x163)][_0x47232a(0x198)]()[_0x47232a(0x194)](models_entity_1['ModelsEntity'])['set']({'useCount':()=>_0x47232a(0x179),'useToken':()=>_0x47232a(0x144)+_0x593e71})[_0x47232a(0x16f)](_0x47232a(0x167),{'id':_0x4f52db})['execute']();}async['getAllKey'](){const _0x1bc97e=_0x56a458;return await this['modelsEntity'][_0x1bc97e(0x14a)]();}async[_0x56a458(0x156)](_0x21c0cb){return 0x1;}async[_0x56a458(0x197)](_0x1bc2dc){return 0x1;}async[_0x56a458(0x18d)](_0x45d167){return 0x1;}async[_0x56a458(0x14d)](_0x455807){const _0x34d1fc=_0x56a458,_0x55abe8=await this[_0x34d1fc(0x163)]['findOne']({'where':{'model':_0x455807,'status':!![],'keyStatus':0x1}});return _0x55abe8;}};ModelsService=__decorate([(0x0,common_1[_0x56a458(0x172)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(models_entity_1['ModelsEntity'])),__metadata('design:paramtypes',[typeorm_2[_0x56a458(0x18e)]])],ModelsService),exports[_0x56a458(0x15f)]=ModelsService;