'use strict';function _0x5c0b(_0x4787bf,_0x5753ea){const _0x24455a=_0x2445();return _0x5c0b=function(_0x5c0b5f,_0x157c89){_0x5c0b5f=_0x5c0b5f-0xe6;let _0x6e21ad=_0x24455a[_0x5c0b5f];return _0x6e21ad;},_0x5c0b(_0x4787bf,_0x5753ea);}const _0x2699c0=_0x5c0b;(function(_0x59a574,_0x52fa49){const _0x3d4125=_0x5c0b,_0x4dde55=_0x59a574();while(!![]){try{const _0x30e538=parseInt(_0x3d4125(0x144))/0x1+parseInt(_0x3d4125(0x11f))/0x2*(-parseInt(_0x3d4125(0x10a))/0x3)+-parseInt(_0x3d4125(0x138))/0x4+-parseInt(_0x3d4125(0xf9))/0x5+parseInt(_0x3d4125(0x108))/0x6*(parseInt(_0x3d4125(0x130))/0x7)+-parseInt(_0x3d4125(0x10f))/0x8*(-parseInt(_0x3d4125(0x13d))/0x9)+parseInt(_0x3d4125(0x119))/0xa;if(_0x30e538===_0x52fa49)break;else _0x4dde55['push'](_0x4dde55['shift']());}catch(_0x22da14){_0x4dde55['push'](_0x4dde55['shift']());}}}(_0x2445,0xb7127));var __decorate=this&&this[_0x2699c0(0x102)]||function(_0x5771b1,_0x4f866f,_0x19cb10,_0x5e8121){const _0x16c063=_0x2699c0;var _0x199e90=arguments['length'],_0x1ad0ee=_0x199e90<0x3?_0x4f866f:_0x5e8121===null?_0x5e8121=Object[_0x16c063(0xf0)](_0x4f866f,_0x19cb10):_0x5e8121,_0x52cf23;if(typeof Reflect===_0x16c063(0x127)&&typeof Reflect[_0x16c063(0x122)]===_0x16c063(0x123))_0x1ad0ee=Reflect[_0x16c063(0x122)](_0x5771b1,_0x4f866f,_0x19cb10,_0x5e8121);else{for(var _0x263242=_0x5771b1[_0x16c063(0x12d)]-0x1;_0x263242>=0x0;_0x263242--)if(_0x52cf23=_0x5771b1[_0x263242])_0x1ad0ee=(_0x199e90<0x3?_0x52cf23(_0x1ad0ee):_0x199e90>0x3?_0x52cf23(_0x4f866f,_0x19cb10,_0x1ad0ee):_0x52cf23(_0x4f866f,_0x19cb10))||_0x1ad0ee;}return _0x199e90>0x3&&_0x1ad0ee&&Object[_0x16c063(0x137)](_0x4f866f,_0x19cb10,_0x1ad0ee),_0x1ad0ee;},__metadata=this&&this['__metadata']||function(_0x504172,_0x3de74d){const _0x125284=_0x2699c0;if(typeof Reflect===_0x125284(0x127)&&typeof Reflect[_0x125284(0xf2)]==='function')return Reflect[_0x125284(0xf2)](_0x504172,_0x3de74d);},__param=this&&this[_0x2699c0(0x103)]||function(_0x10fbaf,_0x5d7f7c){return function(_0x1fdc50,_0x280d5e){_0x5d7f7c(_0x1fdc50,_0x280d5e,_0x10fbaf);};};function _0x2445(){const _0x2dd2a0=['keyPoolIndexMap','timeout','deductType','15648lrqGLe','parse\x20error:\x20','keyPoolMap','deduct','typeorm','log','delete','keys','stringify','findAndCount','15490430FpRNqY','update','Like','initCalcKey','design:paramtypes','useToken\x20+\x20','2kfNBHg','hideString','__esModule','decorate','function','modelTypes','status','sort','object','super','reduce','keyType','onModuleInit','./models.entity','length','\x20欠费或被官方封禁导致不可用，已被系统自动锁定','ModelsService','7qskmLu','save','key','ModelsEntity','../../common/constants/status.constant','error','getBaseConfig','defineProperty','1465760yqCmfO','assign','useCount\x20+\x201','forEach','execute','2322BYGNbl','from','HttpException','keyList','error:\x20','getSpecialModelKeyInfo','Repository','787715LxxXUV','filter','findOne','find','当前账号不存在！','Logger','ASC','queryModelType','where','getCurrentModelKeyInfo','queryModels','getOwnPropertyDescriptor','BAD_REQUEST','metadata','未找到匹配的模型，请重新选择模型！','values','modelMaps','replace','setModelType','ModelsMapCn','5179955wipfkD','HttpStatus','model','modelOrder','id\x20=\x20:id','push','parse','modelsList','@nestjs/typeorm','__decorate','__param','createQueryBuilder','affected','Injectable','set','4813860xZJVOE','modelsEntity','4474266vARVzc','map'];_0x2445=function(){return _0x2dd2a0;};return _0x2445();}Object[_0x2699c0(0x137)](exports,_0x2699c0(0x121),{'value':!![]}),exports[_0x2699c0(0x12f)]=void 0x0;const status_constant_1=require(_0x2699c0(0x134)),utils_1=require('../../common/utils'),common_1=require('@nestjs/common'),typeorm_1=require(_0x2699c0(0x101)),typeorm_2=require(_0x2699c0(0x113)),models_entity_1=require(_0x2699c0(0x12c));let ModelsService=class ModelsService{constructor(_0x118d88){const _0x45a2f3=_0x2699c0;this[_0x45a2f3(0x109)]=_0x118d88,this[_0x45a2f3(0x124)]=[],this[_0x45a2f3(0xf5)]={},this[_0x45a2f3(0x140)]={},this[_0x45a2f3(0x111)]={},this[_0x45a2f3(0x10c)]={};}async[_0x2699c0(0x12b)](){const _0xd2fa40=_0x2699c0;await this[_0xd2fa40(0x11c)]();}async[_0x2699c0(0x11c)](){const _0x54b8c4=_0x2699c0;this[_0x54b8c4(0x111)]={},this[_0x54b8c4(0x10c)]={},this['keyList']={},this['modelMaps']={},this[_0x54b8c4(0x124)]=[];const _0x56e4a5=await this['modelsEntity'][_0x54b8c4(0xe8)]({'where':{'status':!![]}}),_0x596f07=_0x56e4a5[_0x54b8c4(0x129)]((_0x38c63d,_0x1f0a5c)=>{const _0xf2096b=_0x54b8c4;return!_0x38c63d[_0x1f0a5c['keyType']]?_0x38c63d[_0x1f0a5c[_0xf2096b(0x12a)]]=[_0x1f0a5c]:_0x38c63d[_0x1f0a5c[_0xf2096b(0x12a)]][_0xf2096b(0xfe)](_0x1f0a5c),_0x38c63d;},{});this['modelTypes']=Object[_0x54b8c4(0x116)](_0x596f07)['map'](_0x292b58=>{const _0x4b9013=_0x54b8c4;return{'label':status_constant_1[_0x4b9013(0xf8)][_0x292b58],'val':_0x292b58};}),this[_0x54b8c4(0xf5)]=_0x596f07,this[_0x54b8c4(0x140)]={},_0x56e4a5[_0x54b8c4(0x13b)](_0x3eddb=>{const _0x51c87a=_0x54b8c4,{keyType:_0x457571,model:_0x27cdd9}=_0x3eddb;if(!this['keyPoolMap'][_0x27cdd9])this[_0x51c87a(0x111)][_0x27cdd9]=[];this[_0x51c87a(0x111)][_0x27cdd9]['push'](_0x3eddb);if(!this[_0x51c87a(0x10c)][_0x27cdd9])this[_0x51c87a(0x10c)][_0x27cdd9]=0x0;if(!this['keyList'][_0x457571])this['keyList'][_0x457571]={};if(!this[_0x51c87a(0x140)][_0x457571][_0x27cdd9])this['keyList'][_0x457571][_0x27cdd9]=[];this['keyList'][_0x457571][_0x27cdd9][_0x51c87a(0xfe)](_0x3eddb);});}async['lockKey'](_0x33a266,_0x25c7ac,_0x5a83b2=-0x1){const _0x8d3050=_0x2699c0,_0x399415=await this[_0x8d3050(0x109)][_0x8d3050(0x11a)]({'id':_0x33a266},{'status':![],'keyStatus':_0x5a83b2,'remark':_0x25c7ac});common_1[_0x8d3050(0xea)][_0x8d3050(0x135)]('key:\x20'+_0x33a266+_0x8d3050(0x12e)),this[_0x8d3050(0x11c)]();}async[_0x2699c0(0xee)](_0x3bc63b){const _0x51fc31=_0x2699c0;let _0x2d6c23=await this[_0x51fc31(0x109)][_0x51fc31(0xe7)]({'where':{'model':_0x3bc63b}});if(!_0x2d6c23)return null;return _0x2d6c23;}async[_0x2699c0(0x142)](_0x4f713a){const _0x1b4393=_0x2699c0,_0x346077=await this[_0x1b4393(0x109)][_0x1b4393(0xe8)]({'where':{'model':(0x0,typeorm_2[_0x1b4393(0x11b)])(_0x4f713a+'%')}});if(_0x346077[_0x1b4393(0x12d)]===0x0)throw new common_1['HttpException'](_0x1b4393(0xf3),common_1[_0x1b4393(0xfa)]['BAD_REQUEST']);const _0x2efc41=_0x346077[0x0],_0x2d3cd7=_0x2efc41['model'][_0x1b4393(0xf6)](_0x4f713a,''),_0x57f24b=Object[_0x1b4393(0x139)](Object['assign']({},_0x2efc41),{'model':_0x2d3cd7});return _0x57f24b;}async[_0x2699c0(0x136)](){const _0x229ed2=_0x2699c0;if(!this[_0x229ed2(0x124)]['length']||!Object['keys'](this['modelMaps'])[_0x229ed2(0x12d)])return;const {keyType:_0x54885d,modelName:_0x4664fb,model:_0x19928c,deductType:_0x254f93,deduct:_0x47afa4,isFileUpload:_0x49ec3e,modelAvatar:_0x4befdc,modelDescription:_0x1f786d}=this[_0x229ed2(0xf5)][0x1][0x0];return{'modelInfo':{'keyType':_0x54885d,'modelName':_0x4664fb,'model':_0x19928c,'deductType':_0x254f93,'deduct':_0x47afa4,'isFileUpload':_0x49ec3e,'modelAvatar':_0x4befdc,'modelDescription':_0x1f786d}};}async['setModel'](_0x563f71){const _0x2a929c=_0x2699c0;try{isNaN(_0x563f71[_0x2a929c(0x10d)])&&(_0x563f71[_0x2a929c(0x10d)]=null);const {id:_0x5a194f}=_0x563f71;_0x563f71[_0x2a929c(0x125)]&&(_0x563f71['keyStatus']=0x1);if(_0x5a194f){const _0x528d94=await this['modelsEntity'][_0x2a929c(0x11a)]({'id':_0x5a194f},_0x563f71);return await this['initCalcKey'](),_0x528d94[_0x2a929c(0x105)]>0x0;}else{const {keyType:_0x55c63a,key:_0x5a093c}=_0x563f71;if(Number(_0x55c63a!==0x1)){const _0x5b1f51=await this[_0x2a929c(0x109)][_0x2a929c(0x131)](_0x563f71);return await this[_0x2a929c(0x11c)](),_0x5b1f51;}else{const _0x2f450e=_0x5a093c[_0x2a929c(0x10b)](_0x235e27=>{const _0xe3acdd=_0x2a929c;try{const _0x5e0cb2=JSON[_0xe3acdd(0xff)](JSON[_0xe3acdd(0x117)](_0x563f71));return _0x5e0cb2[_0xe3acdd(0x132)]=_0x235e27,isNaN(_0x5e0cb2[_0xe3acdd(0x10d)])&&(_0x5e0cb2[_0xe3acdd(0x10d)]=null),_0x5e0cb2;}catch(_0x32dba0){console['log'](_0xe3acdd(0x110),_0x32dba0);}}),_0xabc9e4=await this[_0x2a929c(0x109)]['save'](_0x2f450e);return await this[_0x2a929c(0x11c)](),_0xabc9e4;}}}catch(_0x386628){console[_0x2a929c(0x114)](_0x2a929c(0x141),_0x386628);}}async['delModel']({id:_0x216ab7}){const _0x4cebc7=_0x2699c0;if(!_0x216ab7)throw new common_1[(_0x4cebc7(0x13f))]('缺失必要参数！',common_1[_0x4cebc7(0xfa)][_0x4cebc7(0xf1)]);const _0xb2a0ba=await this[_0x4cebc7(0x109)][_0x4cebc7(0xe7)]({'where':{'id':_0x216ab7}});if(!_0xb2a0ba)throw new common_1[(_0x4cebc7(0x13f))](_0x4cebc7(0xe9),common_1['HttpStatus'][_0x4cebc7(0xf1)]);const _0x593029=await this[_0x4cebc7(0x109)][_0x4cebc7(0x115)]({'id':_0x216ab7});return await this['initCalcKey'](),_0x593029;}async[_0x2699c0(0xef)](_0x33abca,_0x348b99){const _0x577d1c=_0x2699c0,{role:_0x9d7a55}=_0x33abca['user'],{keyType:_0x7eb0a0,key:_0x51351d,status:_0x2db532,model:_0x45b33b,page:page=0x1,size:size=0xa}=_0x348b99;let _0x372dcf={};_0x7eb0a0&&(_0x372dcf['keyType']=_0x7eb0a0),_0x45b33b&&(_0x372dcf[_0x577d1c(0xfb)]=_0x45b33b),_0x2db532&&(_0x372dcf[_0x577d1c(0x125)]=Number(_0x2db532)===0x1?!![]:![]),_0x51351d&&(_0x372dcf[_0x577d1c(0x132)]=(0x0,typeorm_2['Like'])('%'+_0x51351d+'%'));const [_0x4c3edb,_0x53a7bc]=await this['modelsEntity'][_0x577d1c(0x118)]({'where':_0x372dcf,'order':{'modelOrder':_0x577d1c(0xeb)},'skip':(page-0x1)*size,'take':size});return _0x9d7a55!==_0x577d1c(0x128)&&_0x4c3edb[_0x577d1c(0x13b)](_0x523636=>{const _0x52ae96=_0x577d1c;_0x523636[_0x52ae96(0x132)]&&(_0x523636[_0x52ae96(0x132)]=(0x0,utils_1[_0x52ae96(0x120)])(_0x523636[_0x52ae96(0x132)]));}),{'rows':_0x4c3edb,'count':_0x53a7bc};}async[_0x2699c0(0x100)](){const _0x43a4d4=_0x2699c0,_0x2e3bb6=JSON[_0x43a4d4(0xff)](JSON['stringify'](this[_0x43a4d4(0xf5)]));return Object[_0x43a4d4(0x116)](_0x2e3bb6)[_0x43a4d4(0x13b)](_0x1a3b75=>{const _0x352976=_0x43a4d4;_0x2e3bb6[_0x1a3b75]=_0x2e3bb6[_0x1a3b75][_0x352976(0xe6)](_0xa3975a=>_0xa3975a['keyStatus']===0x1)[_0x352976(0x126)]((_0x9281e0,_0x5ebfee)=>_0x9281e0[_0x352976(0xfc)]-_0x5ebfee[_0x352976(0xfc)]),_0x2e3bb6[_0x1a3b75]=Array[_0x352976(0x13e)](_0x2e3bb6[_0x1a3b75]['map'](_0x9a7c46=>{const {modelName:_0x4aec2b,keyType:_0x54515f,model:_0x861d4e,deduct:_0x8f4ef3,deductType:_0x27d7ba,maxRounds:_0x45b290,modelAvatar:_0x54f1bd,isFileUpload:_0x137dfa,modelDescription:_0xb1217c}=_0x9a7c46;return{'modelName':_0x4aec2b,'keyType':_0x54515f,'model':_0x861d4e,'deduct':_0x8f4ef3,'deductType':_0x27d7ba,'maxRounds':_0x45b290,'modelAvatar':_0x54f1bd,'isFileUpload':_0x137dfa,'modelDescription':_0xb1217c};})[_0x352976(0x129)]((_0x29ae37,_0x30024e)=>_0x29ae37[_0x352976(0x107)](_0x30024e['modelName'],_0x30024e),new Map())[_0x352976(0xf4)]());}),{'modelTypeList':this[_0x43a4d4(0x124)],'modelMaps':_0x2e3bb6};}async['getMjInfo'](){const _0x568839=_0x2699c0,_0x58130b=await this[_0x568839(0x109)][_0x568839(0xe7)]({'where':{'model':'midjourney'}});return _0x58130b?{'modelName':_0x58130b['modelName'],'model':_0x58130b[_0x568839(0xfb)],'deduct':_0x58130b[_0x568839(0x112)],'deductType':_0x58130b[_0x568839(0x10e)]}:null;}async['saveUseLog'](_0x474b92,_0x3f3fdd){const _0x2e0376=_0x2699c0;await this[_0x2e0376(0x109)][_0x2e0376(0x104)]()[_0x2e0376(0x11a)](models_entity_1[_0x2e0376(0x133)])[_0x2e0376(0x107)]({'useCount':()=>_0x2e0376(0x13a),'useToken':()=>_0x2e0376(0x11e)+_0x3f3fdd})[_0x2e0376(0xed)](_0x2e0376(0xfd),{'id':_0x474b92})[_0x2e0376(0x13c)]();}async['getAllKey'](){const _0x2ec79c=_0x2699c0;return await this[_0x2ec79c(0x109)][_0x2ec79c(0xe8)]();}async[_0x2699c0(0xec)](_0x30cc5a){return 0x1;}async[_0x2699c0(0xf7)](_0x465cf6){return 0x1;}async['delModelType'](_0x27aa05){return 0x1;}async['getModelConfigByName'](_0xe0e911){const _0x54362e=_0x2699c0,_0x117768=await this['modelsEntity'][_0x54362e(0xe7)]({'where':{'model':_0xe0e911,'status':!![],'keyStatus':0x1}});return _0x117768;}};ModelsService=__decorate([(0x0,common_1[_0x2699c0(0x106)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(models_entity_1[_0x2699c0(0x133)])),__metadata(_0x2699c0(0x11d),[typeorm_2[_0x2699c0(0x143)]])],ModelsService),exports[_0x2699c0(0x12f)]=ModelsService;