'use strict';const _0x12e376=_0x36f7;(function(_0xbea4ef,_0x14eb12){const _0x5003a7=_0x36f7,_0xdae5e9=_0xbea4ef();while(!![]){try{const _0x536b91=parseInt(_0x5003a7(0x199))/0x1+-parseInt(_0x5003a7(0x19d))/0x2+-parseInt(_0x5003a7(0x195))/0x3*(-parseInt(_0x5003a7(0x1c4))/0x4)+parseInt(_0x5003a7(0x1ad))/0x5*(-parseInt(_0x5003a7(0x1ba))/0x6)+-parseInt(_0x5003a7(0x193))/0x7*(parseInt(_0x5003a7(0x1ac))/0x8)+parseInt(_0x5003a7(0x1c1))/0x9+parseInt(_0x5003a7(0x1d8))/0xa;if(_0x536b91===_0x14eb12)break;else _0xdae5e9['push'](_0xdae5e9['shift']());}catch(_0x4d73f3){_0xdae5e9['push'](_0xdae5e9['shift']());}}}(_0x4f0b,0x415bb));function _0x4f0b(){const _0x292ec5=['timeout','findOne','useCount\x20+\x201','113141CefIpb','Like','model','delete','370204NeJpiy','values','execute','keys','keyList','affected','queryModels','ModelsService','log','HttpException','function','defineProperty','error:\x20','未找到匹配的模型，请重新选择模型！','Repository','56erKanZ','5PLGoGQ','getMjInfo','object','metadata','save','HttpStatus','stringify','getBaseConfig','modelsEntity','super','delModelType','modelMaps','getOwnPropertyDescriptor','2294658fbcslB','Logger','getAllKey','modelsList','initCalcKey','__decorate','ModelsMapCn','258903IFHxeP','@nestjs/common','modelTypes','4nqinmF','lockKey','modelOrder','id\x20=\x20:id','push','__metadata','deduct','decorate','key','set','deductType','onModuleInit','design:paramtypes','keyStatus','BAD_REQUEST','queryModelType','keyPoolIndexMap','where','../../common/constants/status.constant','../../common/utils','2603550jjFuIC','keyType','findAndCount','parse','modelName','keyPoolMap','assign','reduce','__esModule','user','缺失必要参数！','forEach','@nestjs/typeorm','status','useToken\x20+\x20','saveUseLog','__param','setModelType','update','createQueryBuilder','find','hideString','length','getSpecialModelKeyInfo','64589DJAEMH','map','1492734nmtnwr'];_0x4f0b=function(){return _0x292ec5;};return _0x4f0b();}var __decorate=this&&this[_0x12e376(0x1bf)]||function(_0x149e10,_0x51f9ca,_0x432304,_0xdfdc23){const _0x48b4d0=_0x12e376;var _0x22abd3=arguments['length'],_0x909133=_0x22abd3<0x3?_0x51f9ca:_0xdfdc23===null?_0xdfdc23=Object[_0x48b4d0(0x1b9)](_0x51f9ca,_0x432304):_0xdfdc23,_0x5a54c1;if(typeof Reflect===_0x48b4d0(0x1af)&&typeof Reflect['decorate']===_0x48b4d0(0x1a7))_0x909133=Reflect[_0x48b4d0(0x1cb)](_0x149e10,_0x51f9ca,_0x432304,_0xdfdc23);else{for(var _0x299a82=_0x149e10[_0x48b4d0(0x191)]-0x1;_0x299a82>=0x0;_0x299a82--)if(_0x5a54c1=_0x149e10[_0x299a82])_0x909133=(_0x22abd3<0x3?_0x5a54c1(_0x909133):_0x22abd3>0x3?_0x5a54c1(_0x51f9ca,_0x432304,_0x909133):_0x5a54c1(_0x51f9ca,_0x432304))||_0x909133;}return _0x22abd3>0x3&&_0x909133&&Object[_0x48b4d0(0x1a8)](_0x51f9ca,_0x432304,_0x909133),_0x909133;},__metadata=this&&this[_0x12e376(0x1c9)]||function(_0x11338a,_0x5a9df7){const _0x1ec3a0=_0x12e376;if(typeof Reflect===_0x1ec3a0(0x1af)&&typeof Reflect[_0x1ec3a0(0x1b0)]===_0x1ec3a0(0x1a7))return Reflect[_0x1ec3a0(0x1b0)](_0x11338a,_0x5a9df7);},__param=this&&this[_0x12e376(0x18b)]||function(_0x471314,_0x47ec23){return function(_0x281c36,_0x2bc760){_0x47ec23(_0x281c36,_0x2bc760,_0x471314);};};Object['defineProperty'](exports,_0x12e376(0x183),{'value':!![]}),exports[_0x12e376(0x1a4)]=void 0x0;function _0x36f7(_0x2fdbea,_0x186460){const _0x4f0ba6=_0x4f0b();return _0x36f7=function(_0x36f798,_0xa863a4){_0x36f798=_0x36f798-0x180;let _0x1b381b=_0x4f0ba6[_0x36f798];return _0x1b381b;},_0x36f7(_0x2fdbea,_0x186460);}const status_constant_1=require(_0x12e376(0x1d6)),utils_1=require(_0x12e376(0x1d7)),common_1=require(_0x12e376(0x1c2)),typeorm_1=require(_0x12e376(0x187)),typeorm_2=require('typeorm'),models_entity_1=require('./models.entity');let ModelsService=class ModelsService{constructor(_0x221963){const _0x4ae322=_0x12e376;this[_0x4ae322(0x1b5)]=_0x221963,this[_0x4ae322(0x1c3)]=[],this['modelMaps']={},this[_0x4ae322(0x1a1)]={},this['keyPoolMap']={},this[_0x4ae322(0x1d4)]={};}async[_0x12e376(0x1cf)](){const _0x870ed6=_0x12e376;await this[_0x870ed6(0x1be)]();}async[_0x12e376(0x1be)](){const _0x35eb03=_0x12e376;this['keyPoolMap']={},this[_0x35eb03(0x1d4)]={},this[_0x35eb03(0x1a1)]={},this['modelMaps']={},this[_0x35eb03(0x1c3)]=[];const _0x284897=await this[_0x35eb03(0x1b5)][_0x35eb03(0x18f)]({'where':{'status':!![]}}),_0x3f7d6a=_0x284897['reduce']((_0x42d313,_0x3db341)=>{const _0x5eee1c=_0x35eb03;return!_0x42d313[_0x3db341[_0x5eee1c(0x1d9)]]?_0x42d313[_0x3db341[_0x5eee1c(0x1d9)]]=[_0x3db341]:_0x42d313[_0x3db341[_0x5eee1c(0x1d9)]][_0x5eee1c(0x1c8)](_0x3db341),_0x42d313;},{});this[_0x35eb03(0x1c3)]=Object[_0x35eb03(0x1a0)](_0x3f7d6a)[_0x35eb03(0x194)](_0x1162d0=>{const _0x1fb23c=_0x35eb03;return{'label':status_constant_1[_0x1fb23c(0x1c0)][_0x1162d0],'val':_0x1162d0};}),this[_0x35eb03(0x1b8)]=_0x3f7d6a,this[_0x35eb03(0x1a1)]={},_0x284897[_0x35eb03(0x186)](_0x44ce14=>{const _0x4783f6=_0x35eb03,{keyType:_0x595236,model:_0x55eda5}=_0x44ce14;if(!this[_0x4783f6(0x180)][_0x55eda5])this['keyPoolMap'][_0x55eda5]=[];this[_0x4783f6(0x180)][_0x55eda5][_0x4783f6(0x1c8)](_0x44ce14);if(!this[_0x4783f6(0x1d4)][_0x55eda5])this[_0x4783f6(0x1d4)][_0x55eda5]=0x0;if(!this[_0x4783f6(0x1a1)][_0x595236])this[_0x4783f6(0x1a1)][_0x595236]={};if(!this[_0x4783f6(0x1a1)][_0x595236][_0x55eda5])this[_0x4783f6(0x1a1)][_0x595236][_0x55eda5]=[];this['keyList'][_0x595236][_0x55eda5][_0x4783f6(0x1c8)](_0x44ce14);});}async[_0x12e376(0x1c5)](_0x1f1348,_0x3d5756,_0x30159f=-0x1){const _0x9c9e73=_0x12e376,_0x7c73be=await this[_0x9c9e73(0x1b5)][_0x9c9e73(0x18d)]({'id':_0x1f1348},{'status':![],'keyStatus':_0x30159f,'remark':_0x3d5756});common_1[_0x9c9e73(0x1bb)]['error']('key:\x20'+_0x1f1348+'\x20欠费或被官方封禁导致不可用，已被系统自动锁定'),this[_0x9c9e73(0x1be)]();}async['getCurrentModelKeyInfo'](_0x19f1c1){const _0x220fb2=_0x12e376;let _0x1dcaaf=await this['modelsEntity'][_0x220fb2(0x197)]({'where':{'model':_0x19f1c1}});if(!_0x1dcaaf)return null;return _0x1dcaaf;}async[_0x12e376(0x192)](_0x538da5){const _0x174cf3=_0x12e376,_0x188853=await this[_0x174cf3(0x1b5)]['find']({'where':{'model':(0x0,typeorm_2['Like'])(_0x538da5+'%')}});if(_0x188853[_0x174cf3(0x191)]===0x0)throw new common_1[(_0x174cf3(0x1a6))](_0x174cf3(0x1aa),common_1[_0x174cf3(0x1b2)]['BAD_REQUEST']);const _0x498cc9=_0x188853[0x0],_0x1306fc=_0x498cc9[_0x174cf3(0x19b)]['replace'](_0x538da5,''),_0x5ecd09=Object[_0x174cf3(0x181)](Object[_0x174cf3(0x181)]({},_0x498cc9),{'model':_0x1306fc});return _0x5ecd09;}async[_0x12e376(0x1b4)](){const _0x2b6007=_0x12e376;if(!this[_0x2b6007(0x1c3)][_0x2b6007(0x191)]||!Object['keys'](this['modelMaps'])[_0x2b6007(0x191)])return;const {keyType:_0x5348d3,modelName:_0x27aebb,model:_0x8b80af,deductType:_0x46a8d0,deduct:_0x164f01,isFileUpload:_0x757ec8,modelAvatar:_0x331642,modelDescription:_0xb9b9d1}=this[_0x2b6007(0x1b8)][0x1][0x0];return{'modelInfo':{'keyType':_0x5348d3,'modelName':_0x27aebb,'model':_0x8b80af,'deductType':_0x46a8d0,'deduct':_0x164f01,'isFileUpload':_0x757ec8,'modelAvatar':_0x331642,'modelDescription':_0xb9b9d1}};}async['setModel'](_0x37b846){const _0x575896=_0x12e376;try{isNaN(_0x37b846[_0x575896(0x196)])&&(_0x37b846[_0x575896(0x196)]=null);const {id:_0x31a8fc}=_0x37b846;_0x37b846[_0x575896(0x188)]&&(_0x37b846[_0x575896(0x1d1)]=0x1);if(_0x31a8fc){const _0x264150=await this[_0x575896(0x1b5)][_0x575896(0x18d)]({'id':_0x31a8fc},_0x37b846);return await this[_0x575896(0x1be)](),_0x264150[_0x575896(0x1a2)]>0x0;}else{const {keyType:_0x4e4ca2,key:_0x3d9c08}=_0x37b846;if(Number(_0x4e4ca2!==0x1)){const _0xc724bb=await this['modelsEntity'][_0x575896(0x1b1)](_0x37b846);return await this[_0x575896(0x1be)](),_0xc724bb;}else{const _0x65b252=_0x3d9c08[_0x575896(0x194)](_0x2b3fc4=>{const _0x18cd89=_0x575896;try{const _0xeda78c=JSON[_0x18cd89(0x1db)](JSON['stringify'](_0x37b846));return _0xeda78c[_0x18cd89(0x1cc)]=_0x2b3fc4,isNaN(_0xeda78c[_0x18cd89(0x196)])&&(_0xeda78c[_0x18cd89(0x196)]=null),_0xeda78c;}catch(_0x3e35b8){console[_0x18cd89(0x1a5)]('parse\x20error:\x20',_0x3e35b8);}}),_0x159e48=await this[_0x575896(0x1b5)][_0x575896(0x1b1)](_0x65b252);return await this['initCalcKey'](),_0x159e48;}}}catch(_0xa010fb){console[_0x575896(0x1a5)](_0x575896(0x1a9),_0xa010fb);}}async['delModel']({id:_0x4ace3a}){const _0x1748fb=_0x12e376;if(!_0x4ace3a)throw new common_1[(_0x1748fb(0x1a6))](_0x1748fb(0x185),common_1['HttpStatus'][_0x1748fb(0x1d2)]);const _0x3e3165=await this[_0x1748fb(0x1b5)]['findOne']({'where':{'id':_0x4ace3a}});if(!_0x3e3165)throw new common_1[(_0x1748fb(0x1a6))]('当前账号不存在！',common_1[_0x1748fb(0x1b2)][_0x1748fb(0x1d2)]);const _0x480d14=await this[_0x1748fb(0x1b5)][_0x1748fb(0x19c)]({'id':_0x4ace3a});return await this[_0x1748fb(0x1be)](),_0x480d14;}async[_0x12e376(0x1a3)](_0x546830,_0x5674b1){const _0x1858c5=_0x12e376,{role:_0x432464}=_0x546830[_0x1858c5(0x184)],{keyType:_0x37d52f,key:_0x482bc5,status:_0x3183d8,model:_0x3c3fd8,page:page=0x1,size:size=0xa}=_0x5674b1;let _0x366d7d={};_0x37d52f&&(_0x366d7d[_0x1858c5(0x1d9)]=_0x37d52f),_0x3c3fd8&&(_0x366d7d[_0x1858c5(0x19b)]=_0x3c3fd8),_0x3183d8&&(_0x366d7d['status']=Number(_0x3183d8)===0x1?!![]:![]),_0x482bc5&&(_0x366d7d['key']=(0x0,typeorm_2[_0x1858c5(0x19a)])('%'+_0x482bc5+'%'));const [_0x2b7587,_0x59410c]=await this[_0x1858c5(0x1b5)][_0x1858c5(0x1da)]({'where':_0x366d7d,'order':{'modelOrder':'ASC'},'skip':(page-0x1)*size,'take':size});return _0x432464!==_0x1858c5(0x1b6)&&_0x2b7587['forEach'](_0x14e376=>{const _0x3daa09=_0x1858c5;_0x14e376['key']&&(_0x14e376['key']=(0x0,utils_1[_0x3daa09(0x190)])(_0x14e376[_0x3daa09(0x1cc)]));}),{'rows':_0x2b7587,'count':_0x59410c};}async[_0x12e376(0x1bd)](){const _0x5bc6e1=_0x12e376,_0x3bf54a=JSON[_0x5bc6e1(0x1db)](JSON[_0x5bc6e1(0x1b3)](this[_0x5bc6e1(0x1b8)]));return Object[_0x5bc6e1(0x1a0)](_0x3bf54a)[_0x5bc6e1(0x186)](_0x3f4f53=>{const _0xf8a234=_0x5bc6e1;_0x3bf54a[_0x3f4f53]=_0x3bf54a[_0x3f4f53]['filter'](_0xd767b2=>_0xd767b2[_0xf8a234(0x1d1)]===0x1)['sort']((_0x34b541,_0x242ff0)=>_0x34b541[_0xf8a234(0x1c6)]-_0x242ff0['modelOrder']),_0x3bf54a[_0x3f4f53]=Array['from'](_0x3bf54a[_0x3f4f53][_0xf8a234(0x194)](_0x39a18e=>{const {modelName:_0x2892cd,keyType:_0x29e355,model:_0x36663f,deduct:_0x58a3cb,deductType:_0x19903d,maxRounds:_0x17a7be,modelAvatar:_0x4acc7c,isFileUpload:_0x57515,modelDescription:_0x11b6ba}=_0x39a18e;return{'modelName':_0x2892cd,'keyType':_0x29e355,'model':_0x36663f,'deduct':_0x58a3cb,'deductType':_0x19903d,'maxRounds':_0x17a7be,'modelAvatar':_0x4acc7c,'isFileUpload':_0x57515,'modelDescription':_0x11b6ba};})[_0xf8a234(0x182)]((_0x6a51be,_0x58c9c1)=>_0x6a51be['set'](_0x58c9c1[_0xf8a234(0x1dc)],_0x58c9c1),new Map())[_0xf8a234(0x19e)]());}),{'modelTypeList':this[_0x5bc6e1(0x1c3)],'modelMaps':_0x3bf54a};}async[_0x12e376(0x1ae)](){const _0x3458a9=_0x12e376,_0xb6c1f6=await this[_0x3458a9(0x1b5)][_0x3458a9(0x197)]({'where':{'model':'midjourney'}});return _0xb6c1f6?{'modelName':_0xb6c1f6[_0x3458a9(0x1dc)],'model':_0xb6c1f6['model'],'deduct':_0xb6c1f6[_0x3458a9(0x1ca)],'deductType':_0xb6c1f6[_0x3458a9(0x1ce)]}:null;}async[_0x12e376(0x18a)](_0x26af1c,_0x208299){const _0x3560a7=_0x12e376;await this[_0x3560a7(0x1b5)][_0x3560a7(0x18e)]()['update'](models_entity_1['ModelsEntity'])[_0x3560a7(0x1cd)]({'useCount':()=>_0x3560a7(0x198),'useToken':()=>_0x3560a7(0x189)+_0x208299})[_0x3560a7(0x1d5)](_0x3560a7(0x1c7),{'id':_0x26af1c})[_0x3560a7(0x19f)]();}async[_0x12e376(0x1bc)](){const _0x5d682a=_0x12e376;return await this[_0x5d682a(0x1b5)][_0x5d682a(0x18f)]();}async[_0x12e376(0x1d3)](_0xc20b37){return 0x1;}async[_0x12e376(0x18c)](_0x16ce85){return 0x1;}async[_0x12e376(0x1b7)](_0x2f58fa){return 0x1;}async['getModelConfigByName'](_0x2bd1fe){const _0x3f7ea8=_0x12e376,_0x3b47f5=await this[_0x3f7ea8(0x1b5)][_0x3f7ea8(0x197)]({'where':{'model':_0x2bd1fe,'status':!![],'keyStatus':0x1}});return _0x3b47f5;}};ModelsService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(models_entity_1['ModelsEntity'])),__metadata(_0x12e376(0x1d0),[typeorm_2[_0x12e376(0x1ab)]])],ModelsService),exports[_0x12e376(0x1a4)]=ModelsService;