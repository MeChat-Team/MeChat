'use strict';const _0x2aaa4d=_0x11a9;function _0x11a9(_0x5d6e88,_0x1c5523){const _0x40eba5=_0x40eb();return _0x11a9=function(_0x11a9ff,_0x44704d){_0x11a9ff=_0x11a9ff-0xbf;let _0x50d2c1=_0x40eba5[_0x11a9ff];return _0x50d2c1;},_0x11a9(_0x5d6e88,_0x1c5523);}(function(_0x2209ff,_0x4adf9d){const _0xa20ee0=_0x11a9,_0x32207e=_0x2209ff();while(!![]){try{const _0x3559f9=-parseInt(_0xa20ee0(0x111))/0x1*(parseInt(_0xa20ee0(0xf7))/0x2)+parseInt(_0xa20ee0(0x10c))/0x3*(-parseInt(_0xa20ee0(0x127))/0x4)+parseInt(_0xa20ee0(0xca))/0x5*(parseInt(_0xa20ee0(0x142))/0x6)+parseInt(_0xa20ee0(0xfc))/0x7*(parseInt(_0xa20ee0(0xfe))/0x8)+-parseInt(_0xa20ee0(0x148))/0x9+-parseInt(_0xa20ee0(0xef))/0xa*(parseInt(_0xa20ee0(0xc3))/0xb)+parseInt(_0xa20ee0(0x104))/0xc;if(_0x3559f9===_0x4adf9d)break;else _0x32207e['push'](_0x32207e['shift']());}catch(_0x34486c){_0x32207e['push'](_0x32207e['shift']());}}}(_0x40eb,0x25554));var __decorate=this&&this['__decorate']||function(_0x511bc1,_0x325a00,_0x2336fd,_0x1a7738){const _0x12a136=_0x11a9;var _0xd14433=arguments[_0x12a136(0xdf)],_0x243b27=_0xd14433<0x3?_0x325a00:_0x1a7738===null?_0x1a7738=Object[_0x12a136(0x11a)](_0x325a00,_0x2336fd):_0x1a7738,_0x3a4d68;if(typeof Reflect===_0x12a136(0x107)&&typeof Reflect[_0x12a136(0xe5)]===_0x12a136(0xe4))_0x243b27=Reflect[_0x12a136(0xe5)](_0x511bc1,_0x325a00,_0x2336fd,_0x1a7738);else{for(var _0x400f43=_0x511bc1['length']-0x1;_0x400f43>=0x0;_0x400f43--)if(_0x3a4d68=_0x511bc1[_0x400f43])_0x243b27=(_0xd14433<0x3?_0x3a4d68(_0x243b27):_0xd14433>0x3?_0x3a4d68(_0x325a00,_0x2336fd,_0x243b27):_0x3a4d68(_0x325a00,_0x2336fd))||_0x243b27;}return _0xd14433>0x3&&_0x243b27&&Object[_0x12a136(0xfa)](_0x325a00,_0x2336fd,_0x243b27),_0x243b27;},__metadata=this&&this[_0x2aaa4d(0x12d)]||function(_0x225469,_0x4c846e){const _0xcc40c7=_0x2aaa4d;if(typeof Reflect===_0xcc40c7(0x107)&&typeof Reflect[_0xcc40c7(0x136)]==='function')return Reflect[_0xcc40c7(0x136)](_0x225469,_0x4c846e);};function _0x40eb(){const _0x479245=['../globalConfig/globalConfig.service','php','base64','toString','put','tencentCosAcceleratedDomain','cosSecretKey','uploadFileToLocal','mime-types','非法路径，禁止访问目录之外的位置','上传图片失败[ali]','headers','append','length','putObject','文件保存失败:\x20','aliOssBucket','cosSecretId','function','decorate','chevereto','data','https://','文件已上传到阿里云\x20OSS。访问\x20URL:\x20','TRUE','Logger','dev/','ali-oss','cosRegion','10LDHCbB','substring','mkdir','创建目录失败:\x20','__esModule','使用本地存储上传文件','file/','getConfigs','4NIrYmo','formatUrl','stream','defineProperty','GlobalConfigService','13720FFhVxY','getBufferFromUrl','40GmzAEG','public','axios','使用阿里云\x20OSS\x20上传文件','exe','BAD_REQUEST','6810948QVYpgE','上传图片失败[Chevereto]','cheveretoUploadPath','object','aliOssStatus','文件已上传到腾讯云\x20COS。访问\x20URL:\x20','当前已开启全球加速----------------->','basename','391539hAxDIi','code','key','design:paramtypes','random','71798zPWFzJ','UploadService','path','ali\x20开始上传','image','aliOssRegion','Location','tencentCosStatus','toLowerCase','getOwnPropertyDescriptor','content-type','cosBucket','tencentCos','getTime','onModuleInit','url','tencent','使用腾讯云\x20COS\x20上传文件','source','ali','status','title','8rEplmN','removeSpecialCharacters','上传配置状态\x20-\x20腾讯云:本地存储:\x20','Injectable',',\x20Chevereto:\x20','cheveretoStatus','__metadata','acceleratedDomain','promises','error','Chevereto\x20--->\x20res','localStorageStatus','siteUrl','cos-nodejs-sdk-v5','stream-to-buffer','metadata','ISDEV','HttpStatus','上传图片失败[Chevereto|buffer]\x20-->\x20','aliOssAccessKeyId','error:\x20','未配置任何上传方式','cheveretoKey','response','globalConfigService','join','endsWith','6654fyVRbA','file','message','上传失败:\x20','extension','default','391527KrpuGV','uploadFileByTencentCos','stringify','env',',\x20阿里云:\x20','2313707GRSjGo','uploadFileByAliOss','HttpException','getUploadType','replace','log','slice','1055ofKTzt','get','文件已上传到本地存储。访问\x20URL:\x20','cwd','uploadFileByChevereto','catch','getUploadConfig','others'];_0x40eb=function(){return _0x479245;};return _0x40eb();}Object[_0x2aaa4d(0xfa)](exports,_0x2aaa4d(0xf3),{'value':!![]}),exports['UploadService']=void 0x0;const utils_1=require('../../common/utils'),common_1=require('@nestjs/common'),ALIOSS=require(_0x2aaa4d(0xed)),axios_1=require(_0x2aaa4d(0x100)),TENCENTCOS=require(_0x2aaa4d(0x134)),FormData=require('form-data'),fs_1=require('fs'),mime=require(_0x2aaa4d(0xda)),path=require(_0x2aaa4d(0x113)),streamToBuffer=require(_0x2aaa4d(0x135)),globalConfig_service_1=require(_0x2aaa4d(0xd2)),blacklist=[_0x2aaa4d(0x102),'sh','bat','js',_0x2aaa4d(0xd3),'py'];let UploadService=class UploadService{constructor(_0xef6ff6){const _0x1a0d87=_0x2aaa4d;this[_0x1a0d87(0x13f)]=_0xef6ff6;}[_0x2aaa4d(0x11f)](){}async['uploadFile'](_0x2dd3a5,_0x4055cf='others'){const _0x5b4a2b=_0x2aaa4d,{buffer:_0x103a18,mimetype:_0x1fdf31}=_0x2dd3a5;process[_0x5b4a2b(0xc1)][_0x5b4a2b(0x137)]===_0x5b4a2b(0xea)&&(_0x4055cf=_0x5b4a2b(0xec)+_0x4055cf);const _0x5d5aa1=mime[_0x5b4a2b(0x146)](_0x1fdf31)||'';!_0x5d5aa1&&common_1[_0x5b4a2b(0xeb)][_0x5b4a2b(0x130)]('无法识别文件类型，请检查文件',_0x5b4a2b(0x112));if(blacklist['includes'](_0x5d5aa1[_0x5b4a2b(0x119)]())){common_1[_0x5b4a2b(0xeb)][_0x5b4a2b(0x130)]('不允许上传此类型的文件','UploadService');throw new Error('不允许上传此类型的文件');}const _0x2b34e9=new Date(),_0x524e0e=_0x2b34e9[_0x5b4a2b(0x11e)](),_0x43dd4f=Math[_0x5b4a2b(0x110)]()['toString'](0x24)[_0x5b4a2b(0xf0)](0x2,0x6),_0x5d8177=_0x524e0e+'_'+_0x43dd4f+'.'+_0x5d5aa1,{tencentCosStatus:tencentCosStatus=0x0,aliOssStatus:aliOssStatus=0x0,cheveretoStatus:cheveretoStatus=0x0,localStorageStatus:localStorageStatus=0x0}=await this[_0x5b4a2b(0x13f)][_0x5b4a2b(0xf6)]([_0x5b4a2b(0x118),_0x5b4a2b(0x108),_0x5b4a2b(0x12c),_0x5b4a2b(0x132)]);common_1[_0x5b4a2b(0xeb)][_0x5b4a2b(0xc8)](_0x5b4a2b(0x129)+localStorageStatus+',\x20'+tencentCosStatus+_0x5b4a2b(0xc2)+aliOssStatus+_0x5b4a2b(0x12b)+cheveretoStatus,'UploadService');if(!Number(tencentCosStatus)&&!Number(aliOssStatus)&&!Number(cheveretoStatus)&&!Number(localStorageStatus)){common_1[_0x5b4a2b(0xeb)][_0x5b4a2b(0x130)](_0x5b4a2b(0x13c),_0x5b4a2b(0x112));throw new common_1[(_0x5b4a2b(0xc5))]('请先前往后台配置上传图片的方式',common_1['HttpStatus'][_0x5b4a2b(0x103)]);}try{if(Number(localStorageStatus)){common_1[_0x5b4a2b(0xeb)][_0x5b4a2b(0xc8)](_0x5b4a2b(0xf4),_0x5b4a2b(0x112));const _0x15fee4=await this[_0x5b4a2b(0xd9)]({'filename':_0x5d8177,'buffer':_0x103a18,'dir':_0x4055cf});return common_1['Logger'][_0x5b4a2b(0xc8)](_0x5b4a2b(0xcc)+_0x15fee4,_0x5b4a2b(0x112)),_0x15fee4;}if(Number(tencentCosStatus)){common_1[_0x5b4a2b(0xeb)]['log'](_0x5b4a2b(0x122),'UploadService');const _0x36ff9b=await this['uploadFileByTencentCos']({'filename':_0x5d8177,'buffer':_0x103a18,'dir':_0x4055cf});return common_1['Logger']['log'](_0x5b4a2b(0x109)+_0x36ff9b,_0x5b4a2b(0x112)),_0x36ff9b;}if(Number(aliOssStatus)){common_1['Logger'][_0x5b4a2b(0xc8)](_0x5b4a2b(0x101),_0x5b4a2b(0x112));const _0x1e3b57=await this[_0x5b4a2b(0xc4)]({'filename':_0x5d8177,'buffer':_0x103a18,'dir':_0x4055cf});return common_1['Logger']['log'](_0x5b4a2b(0xe9)+_0x1e3b57,_0x5b4a2b(0x112)),_0x1e3b57;}if(Number(cheveretoStatus)){common_1['Logger']['log']('使用\x20Chevereto\x20上传文件','UploadService');const _0x9341f6=await this[_0x5b4a2b(0xce)]({'filename':_0x5d8177,'buffer':_0x103a18[_0x5b4a2b(0xd5)]('base64')});return common_1[_0x5b4a2b(0xeb)][_0x5b4a2b(0xc8)]('文件已上传到\x20Chevereto。访问\x20URL:\x20'+_0x9341f6,_0x5b4a2b(0x112)),_0x9341f6;}}catch(_0x39c290){common_1['Logger'][_0x5b4a2b(0x130)](_0x5b4a2b(0x145)+_0x39c290[_0x5b4a2b(0x144)],_0x5b4a2b(0x112));throw _0x39c290;}}async[_0x2aaa4d(0xc6)](){const _0x232103=_0x2aaa4d,{tencentCosStatus:tencentCosStatus=0x0,aliOssStatus:aliOssStatus=0x0,cheveretoStatus:cheveretoStatus=0x0}=await this[_0x232103(0x13f)][_0x232103(0xf6)]([_0x232103(0x118),_0x232103(0x108),_0x232103(0x12c)]);if(Number(tencentCosStatus))return'tencent';if(Number(aliOssStatus))return'ali';if(Number(cheveretoStatus))return _0x232103(0xe6);}async['uploadFileFromUrl']({url:_0x39c851,dir:dir=_0x2aaa4d(0xd1)}){const _0x11986d=_0x2aaa4d;process['env']['ISDEV']===_0x11986d(0xea)&&(dir=_0x11986d(0xec)+dir);const {buffer:_0x69f1e6,mimeType:_0x366a00}=await this[_0x11986d(0xfd)](_0x39c851);return await this['uploadFile']({'buffer':_0x69f1e6,'mimetype':_0x366a00},dir);}async[_0x2aaa4d(0xbf)]({filename:_0x3a2451,buffer:_0x1b9b4c,dir:_0xd955b1}){const _0x3307c6=_0x2aaa4d,{Bucket:_0x53ba6c,Region:_0x471d46,SecretId:_0x5512f3,SecretKey:_0x1cbaad}=await this['getUploadConfig'](_0x3307c6(0x121));this[_0x3307c6(0x11d)]=new TENCENTCOS({'SecretId':_0x5512f3,'SecretKey':_0x1cbaad,'FileParallelLimit':0xa});try{return new Promise(async(_0x3a30aa,_0x3ce627)=>{const _0x57b3d7=_0x3307c6;this[_0x57b3d7(0x11d)][_0x57b3d7(0xe0)]({'Bucket':(0x0,utils_1['removeSpecialCharacters'])(_0x53ba6c),'Region':(0x0,utils_1[_0x57b3d7(0x128)])(_0x471d46),'Key':_0xd955b1+'/'+_0x3a2451,'StorageClass':'STANDARD','Body':_0x1b9b4c},async(_0x2ce29e,_0x540510)=>{const _0x3277b5=_0x57b3d7;if(_0x2ce29e)return console[_0x3277b5(0xc8)]('cos\x20->\x20err:\x20',_0x2ce29e),_0x3ce627(_0x2ce29e);let _0x83e8c6=_0x540510[_0x3277b5(0x117)][_0x3277b5(0xc7)](/^(http:\/\/|https:\/\/|\/\/|)(.*)/,'https://$2');const {acceleratedDomain:_0x2e5dc1}=await this['getUploadConfig'](_0x3277b5(0x121));return _0x2e5dc1&&(_0x83e8c6=_0x83e8c6[_0x3277b5(0xc7)](/^(https:\/\/[^/]+)(\/.*)$/,'https://'+_0x2e5dc1+'$2'),console[_0x3277b5(0xc8)](_0x3277b5(0x10a),_0x83e8c6)),_0x3a30aa(_0x83e8c6);});});}catch(_0x5ce7b6){console[_0x3307c6(0xc8)]('error:\x20',_0x5ce7b6);throw new common_1[(_0x3307c6(0xc5))]('上传图片失败[ten]',common_1[_0x3307c6(0x138)][_0x3307c6(0x103)]);}}async['uploadFileByAliOss']({filename:_0x21c620,buffer:_0x301cb8,dir:_0x248bf1}){const _0x6aa42a=_0x2aaa4d,{region:_0x4d311a,bucket:_0x4b05c5,accessKeyId:_0x500600,accessKeySecret:_0x4812fd}=await this[_0x6aa42a(0xd0)](_0x6aa42a(0x124)),_0x3185cb=new ALIOSS({'region':(0x0,utils_1['removeSpecialCharacters'])(_0x4d311a),'accessKeyId':_0x500600,'accessKeySecret':_0x4812fd,'bucket':(0x0,utils_1[_0x6aa42a(0x128)])(_0x4b05c5)});try{return console[_0x6aa42a(0xc8)](_0x6aa42a(0x114)),new Promise((_0x15c8be,_0x1e93c4)=>{const _0x729089=_0x6aa42a;_0x3185cb[_0x729089(0xd6)](_0x248bf1+'/'+_0x21c620,_0x301cb8)['then'](async _0x5a0e60=>{const _0x1ea5af=_0x729089,{acceleratedDomain:_0x255702}=await this[_0x1ea5af(0xd0)](_0x1ea5af(0x124));_0x255702&&(_0x5a0e60[_0x1ea5af(0x120)]=_0x5a0e60['url']['replace'](/^(https:\/\/[^/]+)(\/.*)$/,_0x1ea5af(0xe8)+_0x255702+'$2'),console[_0x1ea5af(0xc8)]('当前已开启全球加速----------------->',_0x5a0e60[_0x1ea5af(0x120)])),_0x15c8be(_0x5a0e60[_0x1ea5af(0x120)]);})[_0x729089(0xcf)](_0x31dc94=>{_0x1e93c4(_0x31dc94);});});}catch(_0x5f00c2){throw new common_1[(_0x6aa42a(0xc5))](_0x6aa42a(0xdc),common_1[_0x6aa42a(0x138)][_0x6aa42a(0x103)]);}}async[_0x2aaa4d(0xd9)]({filename:_0x5c5a4c,buffer:_0xe69f40,dir:dir=_0x2aaa4d(0xd1)}){const _0x3bd1b2=_0x2aaa4d,_0x9986d5=path['normalize'](dir)['replace'](/^(\.\.(\/|\\|$))+/,''),_0x96d4f8=path[_0x3bd1b2(0x10b)](_0x5c5a4c),_0xd7cc7c=process[_0x3bd1b2(0xcd)](),_0xf5c0c8=path[_0x3bd1b2(0x140)](_0xd7cc7c,'public','file',_0x9986d5),_0x5eddc6=path[_0x3bd1b2(0x140)](_0xf5c0c8,_0x96d4f8);if(!_0x5eddc6['startsWith'](path['join'](_0xd7cc7c,_0x3bd1b2(0xff),_0x3bd1b2(0x143))))throw new Error(_0x3bd1b2(0xdb));try{await fs_1['promises'][_0x3bd1b2(0xf1)](_0xf5c0c8,{'recursive':!![]});}catch(_0x1c5248){common_1['Logger'][_0x3bd1b2(0x130)](_0x3bd1b2(0xf2)+_0xf5c0c8,_0x1c5248);throw _0x1c5248;}try{await fs_1[_0x3bd1b2(0x12f)]['writeFile'](_0x5eddc6,_0xe69f40,{'mode':0x124});}catch(_0x353841){common_1['Logger'][_0x3bd1b2(0x130)](_0x3bd1b2(0xe1)+_0x5eddc6,_0x353841);throw _0x353841;}let _0x5df2c1=_0x3bd1b2(0xf5)+_0x9986d5+'/'+_0x96d4f8;const _0x43d97c=await this[_0x3bd1b2(0x13f)][_0x3bd1b2(0xf6)]([_0x3bd1b2(0x133)]);if(_0x43d97c){const _0x471425=(0x0,utils_1[_0x3bd1b2(0xf8)])(_0x43d97c);_0x5df2c1=_0x471425+'/'+_0x5df2c1;}return _0x5df2c1;}async['uploadFileByChevereto']({filename:filename='',buffer:_0x3fa83c}){const _0x5111b0=_0x2aaa4d;var _0x4f2588;const {key:_0x5ef845,uploadPath:_0x5f4bda}=await this[_0x5111b0(0xd0)](_0x5111b0(0xe6));let _0x417144=_0x5f4bda[_0x5111b0(0x141)]('/')?_0x5f4bda[_0x5111b0(0xc9)](0x0,-0x1):_0x5f4bda;const _0x6f37ba=new FormData(),_0x35af2b=_0x3fa83c[_0x5111b0(0xd5)](_0x5111b0(0xd4));_0x6f37ba[_0x5111b0(0xde)](_0x5111b0(0x123),_0x35af2b),_0x6f37ba[_0x5111b0(0xde)](_0x5111b0(0x10e),_0x5ef845),_0x6f37ba['append'](_0x5111b0(0x126),filename);try{const _0x24a775=await axios_1[_0x5111b0(0x147)]['post'](_0x417144,_0x6f37ba,{'headers':{'X-API-Key':_0x5ef845}});if((_0x24a775===null||_0x24a775===void 0x0?void 0x0:_0x24a775[_0x5111b0(0x125)])===0xc8)return _0x24a775[_0x5111b0(0xe7)][_0x5111b0(0x115)]['url'];else console['log'](_0x5111b0(0x131),_0x24a775===null||_0x24a775===void 0x0?void 0x0:_0x24a775['data'][_0x5111b0(0x10d)],_0x24a775===null||_0x24a775===void 0x0?void 0x0:_0x24a775[_0x5111b0(0xe7)]['error']['message']),common_1[_0x5111b0(0xeb)][_0x5111b0(0x130)](_0x5111b0(0x105),JSON[_0x5111b0(0xc0)](_0x24a775[_0x5111b0(0xe7)]));}catch(_0x2c77f8){console['log'](_0x5111b0(0x13b),_0x2c77f8);throw new common_1[(_0x5111b0(0xc5))](_0x5111b0(0x139)+((_0x4f2588=_0x2c77f8[_0x5111b0(0x13e)])===null||_0x4f2588===void 0x0?void 0x0:_0x4f2588[_0x5111b0(0xe7)][_0x5111b0(0x130)][_0x5111b0(0x144)]),common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x2aaa4d(0xd0)](_0x3cffa0){const _0x3f0f3f=_0x2aaa4d;if(_0x3cffa0===_0x3f0f3f(0x124)){const {aliOssRegion:_0x240f53,aliOssBucket:_0xf283b6,aliOssAccessKeyId:_0x315413,aliOssAccessKeySecret:_0x4b54c3,aliOssAcceleratedDomain:_0x27a2ad}=await this[_0x3f0f3f(0x13f)]['getConfigs']([_0x3f0f3f(0x116),_0x3f0f3f(0xe2),_0x3f0f3f(0x13a),'aliOssAccessKeySecret',_0x3f0f3f(0x12e)]);return{'region':_0x240f53,'bucket':_0xf283b6,'accessKeyId':_0x315413,'accessKeySecret':_0x4b54c3,'acceleratedDomain':_0x27a2ad};}if(_0x3cffa0==='tencent'){const {cosBucket:_0x512a07,cosRegion:_0x3fcca2,cosSecretId:_0x3a9604,cosSecretKey:_0x494e3a,tencentCosAcceleratedDomain:_0x236644}=await this[_0x3f0f3f(0x13f)][_0x3f0f3f(0xf6)]([_0x3f0f3f(0x11c),_0x3f0f3f(0xee),_0x3f0f3f(0xe3),_0x3f0f3f(0xd8),_0x3f0f3f(0xd7)]);return{'Bucket':_0x512a07,'Region':_0x3fcca2,'SecretId':_0x3a9604,'SecretKey':_0x494e3a,'acceleratedDomain':_0x236644};}if(_0x3cffa0==='chevereto'){const {cheveretoKey:_0x477f76,cheveretoUploadPath:_0x1c8f43}=await this[_0x3f0f3f(0x13f)][_0x3f0f3f(0xf6)]([_0x3f0f3f(0x13d),_0x3f0f3f(0x106)]);return{'key':_0x477f76,'uploadPath':_0x1c8f43};}}async[_0x2aaa4d(0xfd)](_0x33de1a){const _0xbfe246=_0x2aaa4d,_0x32d9c4=await axios_1[_0xbfe246(0x147)][_0xbfe246(0xcb)](_0x33de1a,{'responseType':_0xbfe246(0xf9)}),_0x6bb9a9=await new Promise((_0x2d852a,_0x4d97ed)=>{const _0x29ad12=_0xbfe246;streamToBuffer(_0x32d9c4[_0x29ad12(0xe7)],(_0x202336,_0x211a27)=>{const _0x37b9c2=_0x29ad12;_0x202336?_0x4d97ed(new common_1[(_0x37b9c2(0xc5))]('获取图片资源失败，请重新试试吧！',common_1[_0x37b9c2(0x138)]['BAD_REQUEST'])):_0x2d852a(_0x211a27);});}),_0x3a0042=_0x32d9c4[_0xbfe246(0xdd)][_0xbfe246(0x11b)];return{'buffer':_0x6bb9a9,'mimeType':_0x3a0042};}};UploadService=__decorate([(0x0,common_1[_0x2aaa4d(0x12a)])(),__metadata(_0x2aaa4d(0x10f),[globalConfig_service_1[_0x2aaa4d(0xfb)]])],UploadService),exports['UploadService']=UploadService;