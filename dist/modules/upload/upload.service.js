'use strict';const _0x599073=_0x11fe;(function(_0xdf1c4,_0x1fe048){const _0x35f426=_0x11fe,_0x15667e=_0xdf1c4();while(!![]){try{const _0x595345=-parseInt(_0x35f426(0x1bf))/0x1+parseInt(_0x35f426(0x1e8))/0x2+parseInt(_0x35f426(0x1d4))/0x3+-parseInt(_0x35f426(0x1fe))/0x4+parseInt(_0x35f426(0x1b1))/0x5*(parseInt(_0x35f426(0x21e))/0x6)+parseInt(_0x35f426(0x1c6))/0x7*(-parseInt(_0x35f426(0x1a4))/0x8)+parseInt(_0x35f426(0x1d5))/0x9;if(_0x595345===_0x1fe048)break;else _0x15667e['push'](_0x15667e['shift']());}catch(_0xdadb89){_0x15667e['push'](_0x15667e['shift']());}}}(_0x3db3,0x93f7f));function _0x3db3(){const _0x1daeba=['exe','localStorageStatus','decorate','getConfigs','file','globalConfigService','Location','获取图片资源失败，请重新试试吧！','log','../../common/utils','cos\x20->\x20err:\x20','781734noeqKI','9452880wiHrwp','uploadFileByAliOss','append','上传失败:\x20','getBufferFromUrl','ali\x20开始上传','removeSpecialCharacters','public','stream','headers','response','startsWith','BAD_REQUEST','上传配置状态\x20-\x20腾讯云:本地存储:\x20','cheveretoKey','使用腾讯云\x20COS\x20上传文件','get','dev/','replace','1303968wyzngk','https://$2','Chevereto\x20--->\x20res','uploadFileToLocal','上传图片失败[ali]','error:\x20','function','__decorate','php','form-data','mkdir','toLowerCase','title','onModuleInit','getTime','design:paramtypes','status','HttpStatus','__metadata','HttpException','chevereto','mime-types','1216872MdmdQd','base64','message','put','getOwnPropertyDescriptor','UploadService','ali-oss','post','uploadFile','promises','无法识别文件类型，请检查文件','aliOssStatus','basename','key','uploadFileByTencentCos','others','formatUrl','data','extension','substring','error','uploadFileByChevereto','STANDARD','tencentCosStatus','includes','putObject','uploadFileFromUrl','tencentCos','acceleratedDomain','then','__esModule','code','1338NYQDzX','https://','521048wmdnXa','Injectable','stringify','env','object','siteUrl','当前已开启全球加速----------------->','文件已上传到\x20Chevereto。访问\x20URL:\x20','cosRegion','slice','ali','getUploadConfig','文件已上传到阿里云\x20OSS。访问\x20URL:\x20','1695iVMZVs','aliOssAccessKeyId','metadata','上传图片失败[Chevereto]','使用\x20Chevereto\x20上传文件','aliOssAccessKeySecret','Logger','endsWith','toString','tencent','cosSecretId','上传图片失败[ten]','TRUE','@nestjs/common','997920gAxMaJ','文件已上传到腾讯云\x20COS。访问\x20URL:\x20','default','不允许上传此类型的文件','cheveretoUploadPath','defineProperty','cosBucket','14gJNrvT','url','cheveretoStatus'];_0x3db3=function(){return _0x1daeba;};return _0x3db3();}var __decorate=this&&this[_0x599073(0x1ef)]||function(_0x404731,_0x681f9e,_0x164a66,_0x14a706){const _0x203348=_0x599073;var _0x25c9e8=arguments['length'],_0x88e711=_0x25c9e8<0x3?_0x681f9e:_0x14a706===null?_0x14a706=Object[_0x203348(0x202)](_0x681f9e,_0x164a66):_0x14a706,_0x289dc6;if(typeof Reflect===_0x203348(0x1a8)&&typeof Reflect[_0x203348(0x1cb)]===_0x203348(0x1ee))_0x88e711=Reflect[_0x203348(0x1cb)](_0x404731,_0x681f9e,_0x164a66,_0x14a706);else{for(var _0x551afc=_0x404731['length']-0x1;_0x551afc>=0x0;_0x551afc--)if(_0x289dc6=_0x404731[_0x551afc])_0x88e711=(_0x25c9e8<0x3?_0x289dc6(_0x88e711):_0x25c9e8>0x3?_0x289dc6(_0x681f9e,_0x164a66,_0x88e711):_0x289dc6(_0x681f9e,_0x164a66))||_0x88e711;}return _0x25c9e8>0x3&&_0x88e711&&Object[_0x203348(0x1c4)](_0x681f9e,_0x164a66,_0x88e711),_0x88e711;},__metadata=this&&this[_0x599073(0x1fa)]||function(_0x20ecce,_0x2aa155){const _0x2b5817=_0x599073;if(typeof Reflect===_0x2b5817(0x1a8)&&typeof Reflect[_0x2b5817(0x1b3)]===_0x2b5817(0x1ee))return Reflect['metadata'](_0x20ecce,_0x2aa155);};Object[_0x599073(0x1c4)](exports,_0x599073(0x21c),{'value':!![]}),exports[_0x599073(0x203)]=void 0x0;function _0x11fe(_0x4dbc08,_0x1cd02a){const _0x3db36a=_0x3db3();return _0x11fe=function(_0x11fe19,_0x3d0cac){_0x11fe19=_0x11fe19-0x1a3;let _0x5b5c61=_0x3db36a[_0x11fe19];return _0x5b5c61;},_0x11fe(_0x4dbc08,_0x1cd02a);}const utils_1=require(_0x599073(0x1d2)),common_1=require(_0x599073(0x1be)),ALIOSS=require(_0x599073(0x204)),axios_1=require('axios'),TENCENTCOS=require('cos-nodejs-sdk-v5'),FormData=require(_0x599073(0x1f1)),fs_1=require('fs'),mime=require(_0x599073(0x1fd)),path=require('path'),streamToBuffer=require('stream-to-buffer'),globalConfig_service_1=require('../globalConfig/globalConfig.service'),blacklist=[_0x599073(0x1c9),'sh','bat','js',_0x599073(0x1f0),'py'];let UploadService=class UploadService{constructor(_0x5dac37){this['globalConfigService']=_0x5dac37;}[_0x599073(0x1f5)](){}async[_0x599073(0x206)](_0x5cddb5,_0x400650='others'){const _0x1d256a=_0x599073,{buffer:_0x3e8b9b,mimetype:_0x3a68b7}=_0x5cddb5;process[_0x1d256a(0x1a7)]['ISDEV']===_0x1d256a(0x1bd)&&(_0x400650=_0x1d256a(0x1e6)+_0x400650);const _0xee3ab7=mime[_0x1d256a(0x210)](_0x3a68b7)||'';!_0xee3ab7&&common_1[_0x1d256a(0x1b7)][_0x1d256a(0x212)](_0x1d256a(0x208),_0x1d256a(0x203));if(blacklist[_0x1d256a(0x216)](_0xee3ab7[_0x1d256a(0x1f3)]())){common_1[_0x1d256a(0x1b7)][_0x1d256a(0x212)](_0x1d256a(0x1c2),_0x1d256a(0x203));throw new Error(_0x1d256a(0x1c2));}const _0x545bf6=new Date(),_0x4436b4=_0x545bf6[_0x1d256a(0x1f6)](),_0x29dcec=Math['random']()[_0x1d256a(0x1b9)](0x24)[_0x1d256a(0x211)](0x2,0x6),_0x56a39a=_0x4436b4+'_'+_0x29dcec+'.'+_0xee3ab7,{tencentCosStatus:tencentCosStatus=0x0,aliOssStatus:aliOssStatus=0x0,cheveretoStatus:cheveretoStatus=0x0,localStorageStatus:localStorageStatus=0x0}=await this[_0x1d256a(0x1ce)][_0x1d256a(0x1cc)]([_0x1d256a(0x215),_0x1d256a(0x209),_0x1d256a(0x1c8),_0x1d256a(0x1ca)]);common_1['Logger'][_0x1d256a(0x1d1)](_0x1d256a(0x1e2)+localStorageStatus+',\x20'+tencentCosStatus+',\x20阿里云:\x20'+aliOssStatus+',\x20Chevereto:\x20'+cheveretoStatus,_0x1d256a(0x203));if(!Number(tencentCosStatus)&&!Number(aliOssStatus)&&!Number(cheveretoStatus)&&!Number(localStorageStatus)){common_1[_0x1d256a(0x1b7)]['error']('未配置任何上传方式',_0x1d256a(0x203));throw new common_1['HttpException']('请先前往后台配置上传图片的方式',common_1['HttpStatus']['BAD_REQUEST']);}try{if(Number(localStorageStatus)){common_1[_0x1d256a(0x1b7)][_0x1d256a(0x1d1)]('使用本地存储上传文件',_0x1d256a(0x203));const _0x29977a=await this[_0x1d256a(0x1eb)]({'filename':_0x56a39a,'buffer':_0x3e8b9b,'dir':_0x400650});return common_1['Logger'][_0x1d256a(0x1d1)]('文件已上传到本地存储。访问\x20URL:\x20'+_0x29977a,'UploadService'),_0x29977a;}if(Number(tencentCosStatus)){common_1[_0x1d256a(0x1b7)]['log'](_0x1d256a(0x1e4),'UploadService');const _0x24c18a=await this[_0x1d256a(0x20c)]({'filename':_0x56a39a,'buffer':_0x3e8b9b,'dir':_0x400650});return common_1[_0x1d256a(0x1b7)][_0x1d256a(0x1d1)](_0x1d256a(0x1c0)+_0x24c18a,_0x1d256a(0x203)),_0x24c18a;}if(Number(aliOssStatus)){common_1[_0x1d256a(0x1b7)][_0x1d256a(0x1d1)]('使用阿里云\x20OSS\x20上传文件',_0x1d256a(0x203));const _0x20b57a=await this['uploadFileByAliOss']({'filename':_0x56a39a,'buffer':_0x3e8b9b,'dir':_0x400650});return common_1[_0x1d256a(0x1b7)][_0x1d256a(0x1d1)](_0x1d256a(0x1b0)+_0x20b57a,_0x1d256a(0x203)),_0x20b57a;}if(Number(cheveretoStatus)){common_1[_0x1d256a(0x1b7)][_0x1d256a(0x1d1)](_0x1d256a(0x1b5),'UploadService');const _0x251849=await this[_0x1d256a(0x213)]({'filename':_0x56a39a,'buffer':_0x3e8b9b[_0x1d256a(0x1b9)]('base64')});return common_1['Logger'][_0x1d256a(0x1d1)](_0x1d256a(0x1ab)+_0x251849,_0x1d256a(0x203)),_0x251849;}}catch(_0x332ff0){common_1[_0x1d256a(0x1b7)][_0x1d256a(0x212)](_0x1d256a(0x1d8)+_0x332ff0[_0x1d256a(0x200)],_0x1d256a(0x203));throw _0x332ff0;}}async['getUploadType'](){const _0xfad154=_0x599073,{tencentCosStatus:tencentCosStatus=0x0,aliOssStatus:aliOssStatus=0x0,cheveretoStatus:cheveretoStatus=0x0}=await this[_0xfad154(0x1ce)][_0xfad154(0x1cc)]([_0xfad154(0x215),_0xfad154(0x209),'cheveretoStatus']);if(Number(tencentCosStatus))return _0xfad154(0x1ba);if(Number(aliOssStatus))return _0xfad154(0x1ae);if(Number(cheveretoStatus))return _0xfad154(0x1fc);}async[_0x599073(0x218)]({url:_0x49c1b2,dir:dir=_0x599073(0x20d)}){const _0x3a556b=_0x599073;process[_0x3a556b(0x1a7)]['ISDEV']==='TRUE'&&(dir=_0x3a556b(0x1e6)+dir);const {buffer:_0xf84a72,mimeType:_0x11d818}=await this[_0x3a556b(0x1d9)](_0x49c1b2);return await this['uploadFile']({'buffer':_0xf84a72,'mimetype':_0x11d818},dir);}async[_0x599073(0x20c)]({filename:_0x11c6a2,buffer:_0x2d3903,dir:_0x313a37}){const _0x5b881f=_0x599073,{Bucket:_0x1ba4f4,Region:_0x3cec36,SecretId:_0x449d8a,SecretKey:_0x3ea395}=await this[_0x5b881f(0x1af)](_0x5b881f(0x1ba));this[_0x5b881f(0x219)]=new TENCENTCOS({'SecretId':_0x449d8a,'SecretKey':_0x3ea395,'FileParallelLimit':0xa});try{return new Promise(async(_0x1b7cfc,_0x780b33)=>{const _0x296512=_0x5b881f;this[_0x296512(0x219)][_0x296512(0x217)]({'Bucket':(0x0,utils_1['removeSpecialCharacters'])(_0x1ba4f4),'Region':(0x0,utils_1[_0x296512(0x1db)])(_0x3cec36),'Key':_0x313a37+'/'+_0x11c6a2,'StorageClass':_0x296512(0x214),'Body':_0x2d3903},async(_0x216b21,_0x50794b)=>{const _0x477adf=_0x296512;if(_0x216b21)return console[_0x477adf(0x1d1)](_0x477adf(0x1d3),_0x216b21),_0x780b33(_0x216b21);let _0x4c0bb1=_0x50794b[_0x477adf(0x1cf)]['replace'](/^(http:\/\/|https:\/\/|\/\/|)(.*)/,_0x477adf(0x1e9));const {acceleratedDomain:_0x49538f}=await this[_0x477adf(0x1af)](_0x477adf(0x1ba));return _0x49538f&&(_0x4c0bb1=_0x4c0bb1[_0x477adf(0x1e7)](/^(https:\/\/[^/]+)(\/.*)$/,_0x477adf(0x1a3)+_0x49538f+'$2'),console[_0x477adf(0x1d1)](_0x477adf(0x1aa),_0x4c0bb1)),_0x1b7cfc(_0x4c0bb1);});});}catch(_0x1ecd5e){console['log'](_0x5b881f(0x1ed),_0x1ecd5e);throw new common_1['HttpException'](_0x5b881f(0x1bc),common_1['HttpStatus'][_0x5b881f(0x1e1)]);}}async[_0x599073(0x1d6)]({filename:_0x336959,buffer:_0x2a2e1a,dir:_0x7ddffa}){const _0x2ab534=_0x599073,{region:_0x3d0a85,bucket:_0x2121d4,accessKeyId:_0x349cef,accessKeySecret:_0x38a75c}=await this[_0x2ab534(0x1af)](_0x2ab534(0x1ae)),_0x3e6f25=new ALIOSS({'region':(0x0,utils_1[_0x2ab534(0x1db)])(_0x3d0a85),'accessKeyId':_0x349cef,'accessKeySecret':_0x38a75c,'bucket':(0x0,utils_1['removeSpecialCharacters'])(_0x2121d4)});try{return console[_0x2ab534(0x1d1)](_0x2ab534(0x1da)),new Promise((_0x4e1af6,_0x5d7baf)=>{const _0x2ad380=_0x2ab534;_0x3e6f25[_0x2ad380(0x201)](_0x7ddffa+'/'+_0x336959,_0x2a2e1a)[_0x2ad380(0x21b)](async _0x9333ef=>{const _0x31d4c7=_0x2ad380,{acceleratedDomain:_0x500a94}=await this['getUploadConfig'](_0x31d4c7(0x1ae));_0x500a94&&(_0x9333ef[_0x31d4c7(0x1c7)]=_0x9333ef['url'][_0x31d4c7(0x1e7)](/^(https:\/\/[^/]+)(\/.*)$/,_0x31d4c7(0x1a3)+_0x500a94+'$2'),console[_0x31d4c7(0x1d1)](_0x31d4c7(0x1aa),_0x9333ef['url'])),_0x4e1af6(_0x9333ef['url']);})['catch'](_0x23c44b=>{_0x5d7baf(_0x23c44b);});});}catch(_0x4cec1f){throw new common_1[(_0x2ab534(0x1fb))](_0x2ab534(0x1ec),common_1[_0x2ab534(0x1f9)][_0x2ab534(0x1e1)]);}}async[_0x599073(0x1eb)]({filename:_0x3e9628,buffer:_0xeb898f,dir:dir='others'}){const _0x15276a=_0x599073,_0x44afd5=path['normalize'](dir)[_0x15276a(0x1e7)](/^(\.\.(\/|\\|$))+/,''),_0x4c1785=path[_0x15276a(0x20a)](_0x3e9628),_0x274017=process['cwd'](),_0x75a7f7=path['join'](_0x274017,'public',_0x15276a(0x1cd),_0x44afd5),_0x3924ec=path['join'](_0x75a7f7,_0x4c1785);if(!_0x3924ec[_0x15276a(0x1e0)](path['join'](_0x274017,_0x15276a(0x1dc),'file')))throw new Error('非法路径，禁止访问目录之外的位置');try{await fs_1[_0x15276a(0x207)][_0x15276a(0x1f2)](_0x75a7f7,{'recursive':!![]});}catch(_0x7ca136){common_1[_0x15276a(0x1b7)][_0x15276a(0x212)]('创建目录失败:\x20'+_0x75a7f7,_0x7ca136);throw _0x7ca136;}try{await fs_1[_0x15276a(0x207)]['writeFile'](_0x3924ec,_0xeb898f,{'mode':0x124});}catch(_0x3281e4){common_1[_0x15276a(0x1b7)][_0x15276a(0x212)]('文件保存失败:\x20'+_0x3924ec,_0x3281e4);throw _0x3281e4;}let _0x5dc170='file/'+_0x44afd5+'/'+_0x4c1785;const _0xa66b7f=await this['globalConfigService']['getConfigs']([_0x15276a(0x1a9)]);if(_0xa66b7f){const _0x2afe5c=(0x0,utils_1[_0x15276a(0x20e)])(_0xa66b7f);_0x5dc170=_0x2afe5c+'/'+_0x5dc170;}return _0x5dc170;}async[_0x599073(0x213)]({filename:filename='',buffer:_0x1aa4dd}){const _0x1e4630=_0x599073;var _0x108134;const {key:_0x4a85b4,uploadPath:_0x460fdc}=await this[_0x1e4630(0x1af)](_0x1e4630(0x1fc));let _0x2986f3=_0x460fdc[_0x1e4630(0x1b8)]('/')?_0x460fdc[_0x1e4630(0x1ad)](0x0,-0x1):_0x460fdc;const _0x2ab868=new FormData(),_0x7bad5c=_0x1aa4dd[_0x1e4630(0x1b9)](_0x1e4630(0x1ff));_0x2ab868[_0x1e4630(0x1d7)]('source',_0x7bad5c),_0x2ab868[_0x1e4630(0x1d7)](_0x1e4630(0x20b),_0x4a85b4),_0x2ab868[_0x1e4630(0x1d7)](_0x1e4630(0x1f4),filename);try{const _0x371c64=await axios_1[_0x1e4630(0x1c1)][_0x1e4630(0x205)](_0x2986f3,_0x2ab868,{'headers':{'X-API-Key':_0x4a85b4}});if((_0x371c64===null||_0x371c64===void 0x0?void 0x0:_0x371c64[_0x1e4630(0x1f8)])===0xc8)return _0x371c64['data']['image'][_0x1e4630(0x1c7)];else console[_0x1e4630(0x1d1)](_0x1e4630(0x1ea),_0x371c64===null||_0x371c64===void 0x0?void 0x0:_0x371c64[_0x1e4630(0x20f)][_0x1e4630(0x21d)],_0x371c64===null||_0x371c64===void 0x0?void 0x0:_0x371c64[_0x1e4630(0x20f)][_0x1e4630(0x212)]['message']),common_1['Logger']['error'](_0x1e4630(0x1b4),JSON[_0x1e4630(0x1a6)](_0x371c64['data']));}catch(_0x153611){console['log']('error:\x20',_0x153611);throw new common_1[(_0x1e4630(0x1fb))]('上传图片失败[Chevereto|buffer]\x20-->\x20'+((_0x108134=_0x153611[_0x1e4630(0x1df)])===null||_0x108134===void 0x0?void 0x0:_0x108134[_0x1e4630(0x20f)][_0x1e4630(0x212)][_0x1e4630(0x200)]),common_1[_0x1e4630(0x1f9)][_0x1e4630(0x1e1)]);}}async[_0x599073(0x1af)](_0x48ef71){const _0x5aa376=_0x599073;if(_0x48ef71===_0x5aa376(0x1ae)){const {aliOssRegion:_0x536a06,aliOssBucket:_0xc82367,aliOssAccessKeyId:_0xdd92cf,aliOssAccessKeySecret:_0x4d176f,aliOssAcceleratedDomain:_0x3c70f0}=await this[_0x5aa376(0x1ce)][_0x5aa376(0x1cc)](['aliOssRegion','aliOssBucket',_0x5aa376(0x1b2),_0x5aa376(0x1b6),_0x5aa376(0x21a)]);return{'region':_0x536a06,'bucket':_0xc82367,'accessKeyId':_0xdd92cf,'accessKeySecret':_0x4d176f,'acceleratedDomain':_0x3c70f0};}if(_0x48ef71===_0x5aa376(0x1ba)){const {cosBucket:_0x3c90e9,cosRegion:_0x510e7e,cosSecretId:_0x5051d5,cosSecretKey:_0x571207,tencentCosAcceleratedDomain:_0x38d7ac}=await this[_0x5aa376(0x1ce)][_0x5aa376(0x1cc)]([_0x5aa376(0x1c5),_0x5aa376(0x1ac),_0x5aa376(0x1bb),'cosSecretKey','tencentCosAcceleratedDomain']);return{'Bucket':_0x3c90e9,'Region':_0x510e7e,'SecretId':_0x5051d5,'SecretKey':_0x571207,'acceleratedDomain':_0x38d7ac};}if(_0x48ef71===_0x5aa376(0x1fc)){const {cheveretoKey:_0x2170d2,cheveretoUploadPath:_0x1175d2}=await this[_0x5aa376(0x1ce)][_0x5aa376(0x1cc)]([_0x5aa376(0x1e3),_0x5aa376(0x1c3)]);return{'key':_0x2170d2,'uploadPath':_0x1175d2};}}async[_0x599073(0x1d9)](_0x493736){const _0x49d991=_0x599073,_0x5ea73e=await axios_1[_0x49d991(0x1c1)][_0x49d991(0x1e5)](_0x493736,{'responseType':_0x49d991(0x1dd)}),_0x10517e=await new Promise((_0x5f0de9,_0x31dd6e)=>{const _0x471698=_0x49d991;streamToBuffer(_0x5ea73e[_0x471698(0x20f)],(_0x438952,_0x4977e4)=>{const _0x44330e=_0x471698;_0x438952?_0x31dd6e(new common_1[(_0x44330e(0x1fb))](_0x44330e(0x1d0),common_1[_0x44330e(0x1f9)][_0x44330e(0x1e1)])):_0x5f0de9(_0x4977e4);});}),_0x3f5523=_0x5ea73e[_0x49d991(0x1de)]['content-type'];return{'buffer':_0x10517e,'mimeType':_0x3f5523};}};UploadService=__decorate([(0x0,common_1[_0x599073(0x1a5)])(),__metadata(_0x599073(0x1f7),[globalConfig_service_1['GlobalConfigService']])],UploadService),exports['UploadService']=UploadService;