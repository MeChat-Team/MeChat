'use strict';const _0x3fb7c5=_0x20e1;(function(_0x1dd937,_0xca32cb){const _0x26e8b1=_0x20e1,_0xb7931b=_0x1dd937();while(!![]){try{const _0x4e9817=parseInt(_0x26e8b1(0x150))/0x1+-parseInt(_0x26e8b1(0x152))/0x2+parseInt(_0x26e8b1(0x155))/0x3+-parseInt(_0x26e8b1(0x122))/0x4*(-parseInt(_0x26e8b1(0x16a))/0x5)+parseInt(_0x26e8b1(0x173))/0x6*(-parseInt(_0x26e8b1(0x11d))/0x7)+parseInt(_0x26e8b1(0x18b))/0x8+parseInt(_0x26e8b1(0x178))/0x9;if(_0x4e9817===_0xca32cb)break;else _0xb7931b['push'](_0xb7931b['shift']());}catch(_0xc6f4a3){_0xb7931b['push'](_0xb7931b['shift']());}}}(_0x56f2,0x842c6));var __decorate=this&&this['__decorate']||function(_0x48fcf0,_0x2bade9,_0x3a9f59,_0x1ed784){const _0x2ef323=_0x20e1;var _0x1f71b6=arguments[_0x2ef323(0x189)],_0x580ce3=_0x1f71b6<0x3?_0x2bade9:_0x1ed784===null?_0x1ed784=Object[_0x2ef323(0x17a)](_0x2bade9,_0x3a9f59):_0x1ed784,_0x260fdc;if(typeof Reflect===_0x2ef323(0x15c)&&typeof Reflect[_0x2ef323(0x14b)]===_0x2ef323(0x19a))_0x580ce3=Reflect[_0x2ef323(0x14b)](_0x48fcf0,_0x2bade9,_0x3a9f59,_0x1ed784);else{for(var _0x8c94fd=_0x48fcf0[_0x2ef323(0x189)]-0x1;_0x8c94fd>=0x0;_0x8c94fd--)if(_0x260fdc=_0x48fcf0[_0x8c94fd])_0x580ce3=(_0x1f71b6<0x3?_0x260fdc(_0x580ce3):_0x1f71b6>0x3?_0x260fdc(_0x2bade9,_0x3a9f59,_0x580ce3):_0x260fdc(_0x2bade9,_0x3a9f59))||_0x580ce3;}return _0x1f71b6>0x3&&_0x580ce3&&Object['defineProperty'](_0x2bade9,_0x3a9f59,_0x580ce3),_0x580ce3;},__metadata=this&&this[_0x3fb7c5(0x168)]||function(_0x33b9e5,_0x712d7){const _0x3134b2=_0x3fb7c5;if(typeof Reflect===_0x3134b2(0x15c)&&typeof Reflect[_0x3134b2(0x154)]==='function')return Reflect['metadata'](_0x33b9e5,_0x712d7);};Object[_0x3fb7c5(0x133)](exports,_0x3fb7c5(0x192),{'value':!![]}),exports[_0x3fb7c5(0x12d)]=void 0x0;const utils_1=require(_0x3fb7c5(0x129)),common_1=require(_0x3fb7c5(0x153)),ALIOSS=require(_0x3fb7c5(0x12e)),axios_1=require(_0x3fb7c5(0x15e)),TENCENTCOS=require(_0x3fb7c5(0x148)),FormData=require(_0x3fb7c5(0x14e)),fs_1=require('fs'),mime=require('mime-types'),path=require(_0x3fb7c5(0x186)),streamToBuffer=require(_0x3fb7c5(0x132)),globalConfig_service_1=require('../globalConfig/globalConfig.service'),blacklist=['exe','sh','bat','js','php','py'];let UploadService=class UploadService{constructor(_0x3630de){this['globalConfigService']=_0x3630de;}['onModuleInit'](){}async[_0x3fb7c5(0x169)](_0x3ab94a,_0x25a0a6=_0x3fb7c5(0x181)){const _0x5df87b=_0x3fb7c5,{buffer:_0x1027ff,mimetype:_0x5b74d5}=_0x3ab94a;process[_0x5df87b(0x171)]['ISDEV']===_0x5df87b(0x151)&&(_0x25a0a6='dev/'+_0x25a0a6);const _0x10ad3d=mime[_0x5df87b(0x131)](_0x5b74d5)||'';!_0x10ad3d&&common_1[_0x5df87b(0x144)][_0x5df87b(0x175)]('无法识别文件类型，请检查文件',_0x5df87b(0x12d));if(blacklist[_0x5df87b(0x145)](_0x10ad3d[_0x5df87b(0x121)]())){common_1[_0x5df87b(0x144)]['error'](_0x5df87b(0x13f),'UploadService');throw new Error(_0x5df87b(0x13f));}const _0x292ea9=new Date(),_0x1ad4e3=_0x292ea9[_0x5df87b(0x120)](),_0x5198a6=Math[_0x5df87b(0x184)]()[_0x5df87b(0x162)](0x24)['substring'](0x2,0x6),_0x5e6f28=_0x1ad4e3+'_'+_0x5198a6+'.'+_0x10ad3d,{tencentCosStatus:tencentCosStatus=0x0,aliOssStatus:aliOssStatus=0x0,cheveretoStatus:cheveretoStatus=0x0,localStorageStatus:localStorageStatus=0x0}=await this[_0x5df87b(0x13b)][_0x5df87b(0x125)]([_0x5df87b(0x16d),_0x5df87b(0x14d),_0x5df87b(0x12c),_0x5df87b(0x117)]);common_1[_0x5df87b(0x144)]['log'](_0x5df87b(0x14f)+localStorageStatus+',\x20'+tencentCosStatus+_0x5df87b(0x16f)+aliOssStatus+_0x5df87b(0x172)+cheveretoStatus,_0x5df87b(0x12d));if(!Number(tencentCosStatus)&&!Number(aliOssStatus)&&!Number(cheveretoStatus)&&!Number(localStorageStatus)){common_1['Logger'][_0x5df87b(0x175)](_0x5df87b(0x170),'UploadService');throw new common_1[(_0x5df87b(0x165))]('请先前往后台配置上传图片的方式',common_1[_0x5df87b(0x138)]['BAD_REQUEST']);}try{if(Number(localStorageStatus)){common_1['Logger'][_0x5df87b(0x15f)](_0x5df87b(0x18e),_0x5df87b(0x12d));const _0x205f71=await this[_0x5df87b(0x139)]({'filename':_0x5e6f28,'buffer':_0x1027ff,'dir':_0x25a0a6});return common_1[_0x5df87b(0x144)][_0x5df87b(0x15f)](_0x5df87b(0x193)+_0x205f71,_0x5df87b(0x12d)),_0x205f71;}if(Number(tencentCosStatus)){common_1[_0x5df87b(0x144)][_0x5df87b(0x15f)](_0x5df87b(0x156),_0x5df87b(0x12d));const _0x3c434b=await this[_0x5df87b(0x196)]({'filename':_0x5e6f28,'buffer':_0x1027ff,'dir':_0x25a0a6});return common_1[_0x5df87b(0x144)][_0x5df87b(0x15f)]('文件已上传到腾讯云\x20COS。访问\x20URL:\x20'+_0x3c434b,_0x5df87b(0x12d)),_0x3c434b;}if(Number(aliOssStatus)){common_1[_0x5df87b(0x144)][_0x5df87b(0x15f)](_0x5df87b(0x182),_0x5df87b(0x12d));const _0x3fb00a=await this[_0x5df87b(0x11a)]({'filename':_0x5e6f28,'buffer':_0x1027ff,'dir':_0x25a0a6});return common_1[_0x5df87b(0x144)][_0x5df87b(0x15f)](_0x5df87b(0x118)+_0x3fb00a,'UploadService'),_0x3fb00a;}if(Number(cheveretoStatus)){common_1['Logger'][_0x5df87b(0x15f)](_0x5df87b(0x130),_0x5df87b(0x12d));const _0x57d59c=await this[_0x5df87b(0x13c)]({'filename':_0x5e6f28,'buffer':_0x1027ff[_0x5df87b(0x162)](_0x5df87b(0x11f))});return common_1[_0x5df87b(0x144)][_0x5df87b(0x15f)](_0x5df87b(0x159)+_0x57d59c,_0x5df87b(0x12d)),_0x57d59c;}}catch(_0x29f7b4){common_1[_0x5df87b(0x144)][_0x5df87b(0x175)](_0x5df87b(0x119)+_0x29f7b4[_0x5df87b(0x191)],'UploadService');throw _0x29f7b4;}}async[_0x3fb7c5(0x18f)](){const _0x1e1358=_0x3fb7c5,{tencentCosStatus:tencentCosStatus=0x0,aliOssStatus:aliOssStatus=0x0,cheveretoStatus:cheveretoStatus=0x0}=await this['globalConfigService'][_0x1e1358(0x125)](['tencentCosStatus','aliOssStatus','cheveretoStatus']);if(Number(tencentCosStatus))return _0x1e1358(0x123);if(Number(aliOssStatus))return _0x1e1358(0x141);if(Number(cheveretoStatus))return _0x1e1358(0x13e);}async['uploadFileFromUrl']({url:_0x3b4048,dir:dir='others'}){const _0x2e9548=_0x3fb7c5;process['env']['ISDEV']==='TRUE'&&(dir=_0x2e9548(0x12a)+dir);const {buffer:_0x27db12,mimeType:_0x5538e4}=await this['getBufferFromUrl'](_0x3b4048);return await this['uploadFile']({'buffer':_0x27db12,'mimetype':_0x5538e4},dir);}async['uploadFileByTencentCos']({filename:_0x2fee0c,buffer:_0x4ffa7f,dir:_0x3ecde6}){const _0x12fbb6=_0x3fb7c5,{Bucket:_0x52346e,Region:_0xa0f031,SecretId:_0x3226a9,SecretKey:_0x1864c8}=await this[_0x12fbb6(0x13a)](_0x12fbb6(0x123));this[_0x12fbb6(0x128)]=new TENCENTCOS({'SecretId':_0x3226a9,'SecretKey':_0x1864c8,'FileParallelLimit':0xa});try{return new Promise(async(_0x24dd13,_0xfb4f23)=>{const _0x46849b=_0x12fbb6;this[_0x46849b(0x128)][_0x46849b(0x167)]({'Bucket':(0x0,utils_1[_0x46849b(0x136)])(_0x52346e),'Region':(0x0,utils_1[_0x46849b(0x136)])(_0xa0f031),'Key':_0x3ecde6+'/'+_0x2fee0c,'StorageClass':_0x46849b(0x116),'Body':_0x4ffa7f},async(_0x1d6a15,_0x297d78)=>{const _0x5ceb6d=_0x46849b;if(_0x1d6a15)return console[_0x5ceb6d(0x15f)](_0x5ceb6d(0x140),_0x1d6a15),_0xfb4f23(_0x1d6a15);let _0x28d3fd=_0x297d78['Location'][_0x5ceb6d(0x15b)](/^(http:\/\/|https:\/\/|\/\/|)(.*)/,_0x5ceb6d(0x176));const {acceleratedDomain:_0x2518f2}=await this[_0x5ceb6d(0x13a)](_0x5ceb6d(0x123));return _0x2518f2&&(_0x28d3fd=_0x28d3fd['replace'](/^(https:\/\/[^/]+)(\/.*)$/,_0x5ceb6d(0x180)+_0x2518f2+'$2'),console[_0x5ceb6d(0x15f)]('当前已开启全球加速----------------->',_0x28d3fd)),_0x24dd13(_0x28d3fd);});});}catch(_0xafb4d){console['log'](_0x12fbb6(0x19b),_0xafb4d);throw new common_1['HttpException'](_0x12fbb6(0x187),common_1[_0x12fbb6(0x138)][_0x12fbb6(0x160)]);}}async[_0x3fb7c5(0x11a)]({filename:_0x511466,buffer:_0x41f46b,dir:_0x51b67e}){const _0x468ffd=_0x3fb7c5,{region:_0x2e1e48,bucket:_0x47c62f,accessKeyId:_0x32667f,accessKeySecret:_0x38cf91}=await this[_0x468ffd(0x13a)](_0x468ffd(0x141)),_0x52f374=new ALIOSS({'region':(0x0,utils_1[_0x468ffd(0x136)])(_0x2e1e48),'accessKeyId':_0x32667f,'accessKeySecret':_0x38cf91,'bucket':(0x0,utils_1[_0x468ffd(0x136)])(_0x47c62f)});try{return console[_0x468ffd(0x15f)]('ali\x20开始上传'),new Promise((_0x3c296f,_0x560e13)=>{const _0x2d1139=_0x468ffd;_0x52f374[_0x2d1139(0x146)](_0x51b67e+'/'+_0x511466,_0x41f46b)[_0x2d1139(0x16b)](async _0x42789f=>{const _0x3e985e=_0x2d1139,{acceleratedDomain:_0x5eaa9c}=await this['getUploadConfig'](_0x3e985e(0x141));_0x5eaa9c&&(_0x42789f[_0x3e985e(0x18d)]=_0x42789f[_0x3e985e(0x18d)][_0x3e985e(0x15b)](/^(https:\/\/[^/]+)(\/.*)$/,'https://'+_0x5eaa9c+'$2'),console[_0x3e985e(0x15f)]('当前已开启全球加速----------------->',_0x42789f[_0x3e985e(0x18d)])),_0x3c296f(_0x42789f[_0x3e985e(0x18d)]);})['catch'](_0xd0acc7=>{_0x560e13(_0xd0acc7);});});}catch(_0x12529d){throw new common_1[(_0x468ffd(0x165))](_0x468ffd(0x15d),common_1[_0x468ffd(0x138)][_0x468ffd(0x160)]);}}async[_0x3fb7c5(0x139)]({filename:_0x21bbef,buffer:_0x3eab4a,dir:dir=_0x3fb7c5(0x181)}){const _0x408bd9=_0x3fb7c5,_0xf5d05c=path[_0x408bd9(0x14a)](dir)[_0x408bd9(0x15b)](/^(\.\.(\/|\\|$))+/,''),_0x15b371=path['basename'](_0x21bbef),_0x2f5cfe=process[_0x408bd9(0x12b)](),_0x4e760c=path[_0x408bd9(0x126)](_0x2f5cfe,_0x408bd9(0x177),_0x408bd9(0x161),_0xf5d05c),_0x249f6f=path[_0x408bd9(0x126)](_0x4e760c,_0x15b371);if(!_0x249f6f[_0x408bd9(0x149)](path[_0x408bd9(0x126)](_0x2f5cfe,_0x408bd9(0x177),'file')))throw new Error(_0x408bd9(0x15a));try{await fs_1[_0x408bd9(0x17f)][_0x408bd9(0x18a)](_0x4e760c,{'recursive':!![]});}catch(_0xe5883d){common_1[_0x408bd9(0x144)]['error'](_0x408bd9(0x157)+_0x4e760c,_0xe5883d);throw _0xe5883d;}try{await fs_1['promises'][_0x408bd9(0x143)](_0x249f6f,_0x3eab4a,{'mode':0x124});}catch(_0x1ced4d){common_1[_0x408bd9(0x144)]['error'](_0x408bd9(0x11c)+_0x249f6f,_0x1ced4d);throw _0x1ced4d;}let _0x5ee082=_0x408bd9(0x174)+_0xf5d05c+'/'+_0x15b371;const _0x2f54a8=await this[_0x408bd9(0x13b)][_0x408bd9(0x125)]([_0x408bd9(0x14c)]);if(_0x2f54a8){const _0x46da6e=(0x0,utils_1[_0x408bd9(0x185)])(_0x2f54a8);_0x5ee082=_0x46da6e+'/'+_0x5ee082;}return _0x5ee082;}async[_0x3fb7c5(0x13c)]({filename:filename='',buffer:_0x51315a}){const _0xf3e0d5=_0x3fb7c5;var _0x44847d;const {key:_0x1e4dfa,uploadPath:_0x162700}=await this[_0xf3e0d5(0x13a)](_0xf3e0d5(0x13e));let _0x42a8cf=_0x162700[_0xf3e0d5(0x134)]('/')?_0x162700[_0xf3e0d5(0x13d)](0x0,-0x1):_0x162700;const _0x55a01c=new FormData(),_0xcb2810=_0x51315a[_0xf3e0d5(0x162)](_0xf3e0d5(0x11f));_0x55a01c[_0xf3e0d5(0x163)]('source',_0xcb2810),_0x55a01c[_0xf3e0d5(0x163)](_0xf3e0d5(0x17b),_0x1e4dfa),_0x55a01c[_0xf3e0d5(0x163)](_0xf3e0d5(0x147),filename);try{const _0x3d2356=await axios_1[_0xf3e0d5(0x179)]['post'](_0x42a8cf,_0x55a01c,{'headers':{'X-API-Key':_0x1e4dfa}});if((_0x3d2356===null||_0x3d2356===void 0x0?void 0x0:_0x3d2356[_0xf3e0d5(0x164)])===0xc8)return _0x3d2356[_0xf3e0d5(0x124)][_0xf3e0d5(0x18c)][_0xf3e0d5(0x18d)];else console[_0xf3e0d5(0x15f)](_0xf3e0d5(0x16c),_0x3d2356===null||_0x3d2356===void 0x0?void 0x0:_0x3d2356['data']['code'],_0x3d2356===null||_0x3d2356===void 0x0?void 0x0:_0x3d2356[_0xf3e0d5(0x124)][_0xf3e0d5(0x175)][_0xf3e0d5(0x191)]),common_1['Logger'][_0xf3e0d5(0x175)](_0xf3e0d5(0x17d),JSON[_0xf3e0d5(0x188)](_0x3d2356['data']));}catch(_0x44c91e){console[_0xf3e0d5(0x15f)](_0xf3e0d5(0x19b),_0x44c91e);throw new common_1[(_0xf3e0d5(0x165))](_0xf3e0d5(0x11e)+((_0x44847d=_0x44c91e[_0xf3e0d5(0x137)])===null||_0x44847d===void 0x0?void 0x0:_0x44847d['data']['error'][_0xf3e0d5(0x191)]),common_1[_0xf3e0d5(0x138)]['BAD_REQUEST']);}}async[_0x3fb7c5(0x13a)](_0xc06fd4){const _0xc51174=_0x3fb7c5;if(_0xc06fd4===_0xc51174(0x141)){const {aliOssRegion:_0x263f10,aliOssBucket:_0x1d647c,aliOssAccessKeyId:_0xdd9a27,aliOssAccessKeySecret:_0x2d6199,aliOssAcceleratedDomain:_0x38c4f9}=await this[_0xc51174(0x13b)]['getConfigs'](['aliOssRegion',_0xc51174(0x199),_0xc51174(0x195),'aliOssAccessKeySecret',_0xc51174(0x194)]);return{'region':_0x263f10,'bucket':_0x1d647c,'accessKeyId':_0xdd9a27,'accessKeySecret':_0x2d6199,'acceleratedDomain':_0x38c4f9};}if(_0xc06fd4===_0xc51174(0x123)){const {cosBucket:_0x24b0ad,cosRegion:_0x3509ff,cosSecretId:_0x4f87fd,cosSecretKey:_0x4f4e59,tencentCosAcceleratedDomain:_0x562bd1}=await this[_0xc51174(0x13b)]['getConfigs']([_0xc51174(0x16e),_0xc51174(0x11b),_0xc51174(0x197),'cosSecretKey',_0xc51174(0x190)]);return{'Bucket':_0x24b0ad,'Region':_0x3509ff,'SecretId':_0x4f87fd,'SecretKey':_0x4f4e59,'acceleratedDomain':_0x562bd1};}if(_0xc06fd4===_0xc51174(0x13e)){const {cheveretoKey:_0x15214e,cheveretoUploadPath:_0x38d910}=await this[_0xc51174(0x13b)][_0xc51174(0x125)]([_0xc51174(0x12f),'cheveretoUploadPath']);return{'key':_0x15214e,'uploadPath':_0x38d910};}}async[_0x3fb7c5(0x135)](_0x1a7808){const _0x384990=_0x3fb7c5,_0xe39f55=await axios_1[_0x384990(0x179)][_0x384990(0x158)](_0x1a7808,{'responseType':_0x384990(0x198)}),_0x3bf318=await new Promise((_0x2f78c4,_0x50e0c1)=>{streamToBuffer(_0xe39f55['data'],(_0x216f93,_0x29ca47)=>{const _0x44af6b=_0x20e1;_0x216f93?_0x50e0c1(new common_1[(_0x44af6b(0x165))](_0x44af6b(0x166),common_1[_0x44af6b(0x138)]['BAD_REQUEST'])):_0x2f78c4(_0x29ca47);});}),_0x26d047=_0xe39f55[_0x384990(0x17e)][_0x384990(0x183)];return{'buffer':_0x3bf318,'mimeType':_0x26d047};}};function _0x20e1(_0x1b1a28,_0x1215a8){const _0x56f24c=_0x56f2();return _0x20e1=function(_0x20e1dc,_0x1b5460){_0x20e1dc=_0x20e1dc-0x116;let _0x28a40b=_0x56f24c[_0x20e1dc];return _0x28a40b;},_0x20e1(_0x1b1a28,_0x1215a8);}function _0x56f2(){const _0x4b927c=['967188zqKraQ','使用腾讯云\x20COS\x20上传文件','创建目录失败:\x20','get','文件已上传到\x20Chevereto。访问\x20URL:\x20','非法路径，禁止访问目录之外的位置','replace','object','上传图片失败[ali]','axios','log','BAD_REQUEST','file','toString','append','status','HttpException','获取图片资源失败，请重新试试吧！','putObject','__metadata','uploadFile','875tFlJJp','then','Chevereto\x20--->\x20res','tencentCosStatus','cosBucket',',\x20阿里云:\x20','未配置任何上传方式','env',',\x20Chevereto:\x20','5320824EbVVED','file/','error','https://$2','public','684684xgMPlh','default','getOwnPropertyDescriptor','key','design:paramtypes','上传图片失败[Chevereto]','headers','promises','https://','others','使用阿里云\x20OSS\x20上传文件','content-type','random','formatUrl','path','上传图片失败[ten]','stringify','length','mkdir','8489816vBjZQx','image','url','使用本地存储上传文件','getUploadType','tencentCosAcceleratedDomain','message','__esModule','文件已上传到本地存储。访问\x20URL:\x20','acceleratedDomain','aliOssAccessKeyId','uploadFileByTencentCos','cosSecretId','stream','aliOssBucket','function','error:\x20','STANDARD','localStorageStatus','文件已上传到阿里云\x20OSS。访问\x20URL:\x20','上传失败:\x20','uploadFileByAliOss','cosRegion','文件保存失败:\x20','7efmQAl','上传图片失败[Chevereto|buffer]\x20-->\x20','base64','getTime','toLowerCase','9220CHMgIo','tencent','data','getConfigs','join','GlobalConfigService','tencentCos','../../common/utils','dev/','cwd','cheveretoStatus','UploadService','ali-oss','cheveretoKey','使用\x20Chevereto\x20上传文件','extension','stream-to-buffer','defineProperty','endsWith','getBufferFromUrl','removeSpecialCharacters','response','HttpStatus','uploadFileToLocal','getUploadConfig','globalConfigService','uploadFileByChevereto','slice','chevereto','不允许上传此类型的文件','cos\x20->\x20err:\x20','ali','Injectable','writeFile','Logger','includes','put','title','cos-nodejs-sdk-v5','startsWith','normalize','decorate','siteUrl','aliOssStatus','form-data','上传配置状态\x20-\x20腾讯云:本地存储:\x20','501553HGgzcU','TRUE','1872882SSSWnq','@nestjs/common','metadata'];_0x56f2=function(){return _0x4b927c;};return _0x56f2();}UploadService=__decorate([(0x0,common_1[_0x3fb7c5(0x142)])(),__metadata(_0x3fb7c5(0x17c),[globalConfig_service_1[_0x3fb7c5(0x127)]])],UploadService),exports['UploadService']=UploadService;