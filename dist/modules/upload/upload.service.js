'use strict';const _0x24d5f4=_0x5cef;(function(_0x173326,_0x1e7106){const _0xb5c523=_0x5cef,_0x10251d=_0x173326();while(!![]){try{const _0x6db196=-parseInt(_0xb5c523(0x1b7))/0x1+parseInt(_0xb5c523(0x179))/0x2+parseInt(_0xb5c523(0x1b1))/0x3+parseInt(_0xb5c523(0x1ab))/0x4*(parseInt(_0xb5c523(0x18c))/0x5)+parseInt(_0xb5c523(0x190))/0x6+parseInt(_0xb5c523(0x187))/0x7+parseInt(_0xb5c523(0x1c1))/0x8*(-parseInt(_0xb5c523(0x17b))/0x9);if(_0x6db196===_0x1e7106)break;else _0x10251d['push'](_0x10251d['shift']());}catch(_0x13d85d){_0x10251d['push'](_0x10251d['shift']());}}}(_0x25d9,0xafbde));function _0x5cef(_0x389403,_0x4881c7){const _0x25d99a=_0x25d9();return _0x5cef=function(_0x5cef97,_0x4d7806){_0x5cef97=_0x5cef97-0x14a;let _0x35c477=_0x25d99a[_0x5cef97];return _0x35c477;},_0x5cef(_0x389403,_0x4881c7);}function _0x25d9(){const _0x29a1c1=['aliOssAccessKeyId','uploadFileByChevereto','getUploadConfig','writeFile','1281419mWaeQh','上传图片失败[ten]','globalConfigService','文件已上传到腾讯云\x20COS。访问\x20URL:\x20','normalize','getOwnPropertyDescriptor','使用腾讯云\x20COS\x20上传文件','cheveretoKey','上传图片失败[ali]','status','76040aPOVoH','file/','@nestjs/common','content-type','非法路径，禁止访问目录之外的位置','onModuleInit','使用本地存储上传文件','log','siteUrl','basename','ali\x20开始上传','上传图片失败[Chevereto]','TRUE','uploadFileByTencentCos','tencentCosAcceleratedDomain','文件已上传到本地存储。访问\x20URL:\x20','stringify','function','uploadFileToLocal','tencentCos','env','path','使用阿里云\x20OSS\x20上传文件','无法识别文件类型，请检查文件','cosBucket','getTime','join','获取图片资源失败，请重新试试吧！','aliOssBucket','BAD_REQUEST','HttpException','source','未配置任何上传方式','https://','dev/','ISDEV','url','uploadFileByAliOss','tencentCosStatus','getConfigs','slice','cheveretoUploadPath','cosSecretKey','Logger','removeSpecialCharacters','post','cosRegion','ali','使用\x20Chevereto\x20上传文件','includes','STANDARD','key','bat','tencent','getBufferFromUrl','cosSecretId','append','axios','uploadFileFromUrl','public','promises','toString','exe','stream','100138qZQRtD','acceleratedDomain','450XZsdrL','UploadService','decorate','file','__esModule','then','base64','default','design:paramtypes','metadata','random','code','432789TRuKWg','error','others','Chevereto\x20--->\x20res','Location','65EAXWnS','文件已上传到阿里云\x20OSS。访问\x20URL:\x20','请先前往后台配置上传图片的方式','uploadFile','8075820EGbVLQ','aliOssStatus','title','formatUrl','image','stream-to-buffer','上传失败:\x20','put','startsWith','cwd','toLowerCase','不允许上传此类型的文件','创建目录失败:\x20','error:\x20','defineProperty','substring','mime-types','HttpStatus','length','当前已开启全球加速----------------->','localStorageStatus','chevereto','message','replace','cos-nodejs-sdk-v5','aliOssAccessKeySecret','cos\x20->\x20err:\x20','183672goNFVq','__metadata','data','../globalConfig/globalConfig.service',',\x20阿里云:\x20','catch','1265121QMLOUt','get'];_0x25d9=function(){return _0x29a1c1;};return _0x25d9();}var __decorate=this&&this['__decorate']||function(_0x578fa4,_0x1e88fa,_0x4a39d2,_0x533b2e){const _0x43b195=_0x5cef;var _0x134f67=arguments[_0x43b195(0x1a2)],_0x489bdd=_0x134f67<0x3?_0x1e88fa:_0x533b2e===null?_0x533b2e=Object[_0x43b195(0x1bc)](_0x1e88fa,_0x4a39d2):_0x533b2e,_0x5a7118;if(typeof Reflect==='object'&&typeof Reflect[_0x43b195(0x17d)]==='function')_0x489bdd=Reflect[_0x43b195(0x17d)](_0x578fa4,_0x1e88fa,_0x4a39d2,_0x533b2e);else{for(var _0x241be2=_0x578fa4['length']-0x1;_0x241be2>=0x0;_0x241be2--)if(_0x5a7118=_0x578fa4[_0x241be2])_0x489bdd=(_0x134f67<0x3?_0x5a7118(_0x489bdd):_0x134f67>0x3?_0x5a7118(_0x1e88fa,_0x4a39d2,_0x489bdd):_0x5a7118(_0x1e88fa,_0x4a39d2))||_0x489bdd;}return _0x134f67>0x3&&_0x489bdd&&Object['defineProperty'](_0x1e88fa,_0x4a39d2,_0x489bdd),_0x489bdd;},__metadata=this&&this[_0x24d5f4(0x1ac)]||function(_0x11d485,_0x326de7){const _0x4ae731=_0x24d5f4;if(typeof Reflect==='object'&&typeof Reflect['metadata']===_0x4ae731(0x14a))return Reflect[_0x4ae731(0x184)](_0x11d485,_0x326de7);};Object[_0x24d5f4(0x19e)](exports,_0x24d5f4(0x17f),{'value':!![]}),exports['UploadService']=void 0x0;const utils_1=require('../../common/utils'),common_1=require(_0x24d5f4(0x1c3)),ALIOSS=require('ali-oss'),axios_1=require(_0x24d5f4(0x172)),TENCENTCOS=require(_0x24d5f4(0x1a8)),FormData=require('form-data'),fs_1=require('fs'),mime=require(_0x24d5f4(0x1a0)),path=require(_0x24d5f4(0x14e)),streamToBuffer=require(_0x24d5f4(0x195)),globalConfig_service_1=require(_0x24d5f4(0x1ae)),blacklist=[_0x24d5f4(0x177),'sh',_0x24d5f4(0x16d),'js','php','py'];let UploadService=class UploadService{constructor(_0x4f3a35){const _0x5065ec=_0x24d5f4;this[_0x5065ec(0x1b9)]=_0x4f3a35;}[_0x24d5f4(0x1c6)](){}async[_0x24d5f4(0x18f)](_0x3f5a98,_0x401ada=_0x24d5f4(0x189)){const _0x28d6f2=_0x24d5f4,{buffer:_0x3b4000,mimetype:_0x26733b}=_0x3f5a98;process['env'][_0x28d6f2(0x15c)]==='TRUE'&&(_0x401ada=_0x28d6f2(0x15b)+_0x401ada);const _0x86d55a=mime['extension'](_0x26733b)||'';!_0x86d55a&&common_1[_0x28d6f2(0x164)]['error'](_0x28d6f2(0x150),_0x28d6f2(0x17c));if(blacklist[_0x28d6f2(0x16a)](_0x86d55a[_0x28d6f2(0x19a)]())){common_1[_0x28d6f2(0x164)][_0x28d6f2(0x188)](_0x28d6f2(0x19b),_0x28d6f2(0x17c));throw new Error(_0x28d6f2(0x19b));}const _0x512d72=new Date(),_0x3dbac1=_0x512d72[_0x28d6f2(0x152)](),_0x25efcc=Math[_0x28d6f2(0x185)]()[_0x28d6f2(0x176)](0x24)[_0x28d6f2(0x19f)](0x2,0x6),_0x3b0fd0=_0x3dbac1+'_'+_0x25efcc+'.'+_0x86d55a,{tencentCosStatus:tencentCosStatus=0x0,aliOssStatus:aliOssStatus=0x0,cheveretoStatus:cheveretoStatus=0x0,localStorageStatus:localStorageStatus=0x0}=await this['globalConfigService'][_0x28d6f2(0x160)]([_0x28d6f2(0x15f),_0x28d6f2(0x191),'cheveretoStatus',_0x28d6f2(0x1a4)]);common_1[_0x28d6f2(0x164)][_0x28d6f2(0x1c8)]('上传配置状态\x20-\x20腾讯云:本地存储:\x20'+localStorageStatus+',\x20'+tencentCosStatus+_0x28d6f2(0x1af)+aliOssStatus+',\x20Chevereto:\x20'+cheveretoStatus,_0x28d6f2(0x17c));if(!Number(tencentCosStatus)&&!Number(aliOssStatus)&&!Number(cheveretoStatus)&&!Number(localStorageStatus)){common_1[_0x28d6f2(0x164)][_0x28d6f2(0x188)](_0x28d6f2(0x159),_0x28d6f2(0x17c));throw new common_1[(_0x28d6f2(0x157))](_0x28d6f2(0x18e),common_1[_0x28d6f2(0x1a1)]['BAD_REQUEST']);}try{if(Number(localStorageStatus)){common_1[_0x28d6f2(0x164)][_0x28d6f2(0x1c8)](_0x28d6f2(0x1c7),_0x28d6f2(0x17c));const _0x57e9cd=await this[_0x28d6f2(0x14b)]({'filename':_0x3b0fd0,'buffer':_0x3b4000,'dir':_0x401ada});return common_1[_0x28d6f2(0x164)]['log'](_0x28d6f2(0x1d0)+_0x57e9cd,'UploadService'),_0x57e9cd;}if(Number(tencentCosStatus)){common_1[_0x28d6f2(0x164)][_0x28d6f2(0x1c8)](_0x28d6f2(0x1bd),_0x28d6f2(0x17c));const _0x470f19=await this[_0x28d6f2(0x1ce)]({'filename':_0x3b0fd0,'buffer':_0x3b4000,'dir':_0x401ada});return common_1[_0x28d6f2(0x164)][_0x28d6f2(0x1c8)](_0x28d6f2(0x1ba)+_0x470f19,'UploadService'),_0x470f19;}if(Number(aliOssStatus)){common_1['Logger']['log'](_0x28d6f2(0x14f),_0x28d6f2(0x17c));const _0x31b8e0=await this[_0x28d6f2(0x15e)]({'filename':_0x3b0fd0,'buffer':_0x3b4000,'dir':_0x401ada});return common_1[_0x28d6f2(0x164)]['log'](_0x28d6f2(0x18d)+_0x31b8e0,_0x28d6f2(0x17c)),_0x31b8e0;}if(Number(cheveretoStatus)){common_1[_0x28d6f2(0x164)][_0x28d6f2(0x1c8)](_0x28d6f2(0x169),_0x28d6f2(0x17c));const _0x4a8f9c=await this[_0x28d6f2(0x1b4)]({'filename':_0x3b0fd0,'buffer':_0x3b4000[_0x28d6f2(0x176)](_0x28d6f2(0x181))});return common_1[_0x28d6f2(0x164)]['log']('文件已上传到\x20Chevereto。访问\x20URL:\x20'+_0x4a8f9c,'UploadService'),_0x4a8f9c;}}catch(_0x33fdd7){common_1[_0x28d6f2(0x164)][_0x28d6f2(0x188)](_0x28d6f2(0x196)+_0x33fdd7[_0x28d6f2(0x1a6)],_0x28d6f2(0x17c));throw _0x33fdd7;}}async['getUploadType'](){const _0x3c9f41=_0x24d5f4,{tencentCosStatus:tencentCosStatus=0x0,aliOssStatus:aliOssStatus=0x0,cheveretoStatus:cheveretoStatus=0x0}=await this[_0x3c9f41(0x1b9)]['getConfigs']([_0x3c9f41(0x15f),'aliOssStatus','cheveretoStatus']);if(Number(tencentCosStatus))return _0x3c9f41(0x16e);if(Number(aliOssStatus))return _0x3c9f41(0x168);if(Number(cheveretoStatus))return'chevereto';}async[_0x24d5f4(0x173)]({url:_0x4cc975,dir:dir=_0x24d5f4(0x189)}){const _0x1f6b15=_0x24d5f4;process[_0x1f6b15(0x14d)][_0x1f6b15(0x15c)]===_0x1f6b15(0x1cd)&&(dir=_0x1f6b15(0x15b)+dir);const {buffer:_0x43a9ad,mimeType:_0x4be3e6}=await this['getBufferFromUrl'](_0x4cc975);return await this['uploadFile']({'buffer':_0x43a9ad,'mimetype':_0x4be3e6},dir);}async[_0x24d5f4(0x1ce)]({filename:_0x183b8c,buffer:_0x5f476e,dir:_0x54bf9a}){const _0x3b62e9=_0x24d5f4,{Bucket:_0x1adc82,Region:_0x133b1e,SecretId:_0x1f4a00,SecretKey:_0x3f72d2}=await this[_0x3b62e9(0x1b5)](_0x3b62e9(0x16e));this[_0x3b62e9(0x14c)]=new TENCENTCOS({'SecretId':_0x1f4a00,'SecretKey':_0x3f72d2,'FileParallelLimit':0xa});try{return new Promise(async(_0x1b9574,_0x10a615)=>{const _0x4c4534=_0x3b62e9;this[_0x4c4534(0x14c)]['putObject']({'Bucket':(0x0,utils_1[_0x4c4534(0x165)])(_0x1adc82),'Region':(0x0,utils_1[_0x4c4534(0x165)])(_0x133b1e),'Key':_0x54bf9a+'/'+_0x183b8c,'StorageClass':_0x4c4534(0x16b),'Body':_0x5f476e},async(_0x3014b7,_0x3f933c)=>{const _0x2a5864=_0x4c4534;if(_0x3014b7)return console['log'](_0x2a5864(0x1aa),_0x3014b7),_0x10a615(_0x3014b7);let _0x525f0a=_0x3f933c[_0x2a5864(0x18b)][_0x2a5864(0x1a7)](/^(http:\/\/|https:\/\/|\/\/|)(.*)/,'https://$2');const {acceleratedDomain:_0x375037}=await this[_0x2a5864(0x1b5)](_0x2a5864(0x16e));return _0x375037&&(_0x525f0a=_0x525f0a[_0x2a5864(0x1a7)](/^(https:\/\/[^/]+)(\/.*)$/,_0x2a5864(0x15a)+_0x375037+'$2'),console[_0x2a5864(0x1c8)](_0x2a5864(0x1a3),_0x525f0a)),_0x1b9574(_0x525f0a);});});}catch(_0x429bd0){console[_0x3b62e9(0x1c8)](_0x3b62e9(0x19d),_0x429bd0);throw new common_1['HttpException'](_0x3b62e9(0x1b8),common_1[_0x3b62e9(0x1a1)][_0x3b62e9(0x156)]);}}async[_0x24d5f4(0x15e)]({filename:_0x13caab,buffer:_0x691238,dir:_0x3353b2}){const _0x5a1939=_0x24d5f4,{region:_0x57e7c5,bucket:_0x2286a2,accessKeyId:_0x110b76,accessKeySecret:_0x1cd214}=await this[_0x5a1939(0x1b5)](_0x5a1939(0x168)),_0x1d5ffd=new ALIOSS({'region':(0x0,utils_1[_0x5a1939(0x165)])(_0x57e7c5),'accessKeyId':_0x110b76,'accessKeySecret':_0x1cd214,'bucket':(0x0,utils_1[_0x5a1939(0x165)])(_0x2286a2)});try{return console[_0x5a1939(0x1c8)](_0x5a1939(0x1cb)),new Promise((_0x56ed60,_0x3c77df)=>{const _0x4beb7d=_0x5a1939;_0x1d5ffd[_0x4beb7d(0x197)](_0x3353b2+'/'+_0x13caab,_0x691238)[_0x4beb7d(0x180)](async _0x1541da=>{const _0x1dfd6c=_0x4beb7d,{acceleratedDomain:_0x1c0e71}=await this[_0x1dfd6c(0x1b5)](_0x1dfd6c(0x168));_0x1c0e71&&(_0x1541da['url']=_0x1541da[_0x1dfd6c(0x15d)][_0x1dfd6c(0x1a7)](/^(https:\/\/[^/]+)(\/.*)$/,_0x1dfd6c(0x15a)+_0x1c0e71+'$2'),console[_0x1dfd6c(0x1c8)](_0x1dfd6c(0x1a3),_0x1541da[_0x1dfd6c(0x15d)])),_0x56ed60(_0x1541da[_0x1dfd6c(0x15d)]);})[_0x4beb7d(0x1b0)](_0x58e1f4=>{_0x3c77df(_0x58e1f4);});});}catch(_0x3c27f5){throw new common_1[(_0x5a1939(0x157))](_0x5a1939(0x1bf),common_1[_0x5a1939(0x1a1)][_0x5a1939(0x156)]);}}async['uploadFileToLocal']({filename:_0x2f3e6b,buffer:_0x37f8ab,dir:dir=_0x24d5f4(0x189)}){const _0x24b1d0=_0x24d5f4,_0xbb4b56=path[_0x24b1d0(0x1bb)](dir)[_0x24b1d0(0x1a7)](/^(\.\.(\/|\\|$))+/,''),_0x624c77=path[_0x24b1d0(0x1ca)](_0x2f3e6b),_0x33ce70=process[_0x24b1d0(0x199)](),_0x11386e=path['join'](_0x33ce70,_0x24b1d0(0x174),_0x24b1d0(0x17e),_0xbb4b56),_0x118b3f=path[_0x24b1d0(0x153)](_0x11386e,_0x624c77);if(!_0x118b3f[_0x24b1d0(0x198)](path[_0x24b1d0(0x153)](_0x33ce70,_0x24b1d0(0x174),'file')))throw new Error(_0x24b1d0(0x1c5));try{await fs_1[_0x24b1d0(0x175)]['mkdir'](_0x11386e,{'recursive':!![]});}catch(_0x1ba330){common_1[_0x24b1d0(0x164)]['error'](_0x24b1d0(0x19c)+_0x11386e,_0x1ba330);throw _0x1ba330;}try{await fs_1['promises'][_0x24b1d0(0x1b6)](_0x118b3f,_0x37f8ab,{'mode':0x124});}catch(_0x3fc1e2){common_1[_0x24b1d0(0x164)][_0x24b1d0(0x188)]('文件保存失败:\x20'+_0x118b3f,_0x3fc1e2);throw _0x3fc1e2;}let _0x5884fb=_0x24b1d0(0x1c2)+_0xbb4b56+'/'+_0x624c77;const _0x447c78=await this[_0x24b1d0(0x1b9)][_0x24b1d0(0x160)]([_0x24b1d0(0x1c9)]);if(_0x447c78){const _0x243593=(0x0,utils_1[_0x24b1d0(0x193)])(_0x447c78);_0x5884fb=_0x243593+'/'+_0x5884fb;}return _0x5884fb;}async[_0x24d5f4(0x1b4)]({filename:filename='',buffer:_0x3e2881}){const _0x1a8fb3=_0x24d5f4;var _0x1cdc16;const {key:_0x22d2fb,uploadPath:_0x1f15c8}=await this[_0x1a8fb3(0x1b5)](_0x1a8fb3(0x1a5));let _0x36c232=_0x1f15c8['endsWith']('/')?_0x1f15c8[_0x1a8fb3(0x161)](0x0,-0x1):_0x1f15c8;const _0x45fd35=new FormData(),_0x55d22e=_0x3e2881[_0x1a8fb3(0x176)](_0x1a8fb3(0x181));_0x45fd35[_0x1a8fb3(0x171)](_0x1a8fb3(0x158),_0x55d22e),_0x45fd35[_0x1a8fb3(0x171)](_0x1a8fb3(0x16c),_0x22d2fb),_0x45fd35[_0x1a8fb3(0x171)](_0x1a8fb3(0x192),filename);try{const _0x31a695=await axios_1[_0x1a8fb3(0x182)][_0x1a8fb3(0x166)](_0x36c232,_0x45fd35,{'headers':{'X-API-Key':_0x22d2fb}});if((_0x31a695===null||_0x31a695===void 0x0?void 0x0:_0x31a695[_0x1a8fb3(0x1c0)])===0xc8)return _0x31a695[_0x1a8fb3(0x1ad)][_0x1a8fb3(0x194)][_0x1a8fb3(0x15d)];else console[_0x1a8fb3(0x1c8)](_0x1a8fb3(0x18a),_0x31a695===null||_0x31a695===void 0x0?void 0x0:_0x31a695[_0x1a8fb3(0x1ad)][_0x1a8fb3(0x186)],_0x31a695===null||_0x31a695===void 0x0?void 0x0:_0x31a695[_0x1a8fb3(0x1ad)][_0x1a8fb3(0x188)][_0x1a8fb3(0x1a6)]),common_1[_0x1a8fb3(0x164)]['error'](_0x1a8fb3(0x1cc),JSON[_0x1a8fb3(0x1d1)](_0x31a695['data']));}catch(_0x18e96a){console[_0x1a8fb3(0x1c8)](_0x1a8fb3(0x19d),_0x18e96a);throw new common_1[(_0x1a8fb3(0x157))]('上传图片失败[Chevereto|buffer]\x20-->\x20'+((_0x1cdc16=_0x18e96a['response'])===null||_0x1cdc16===void 0x0?void 0x0:_0x1cdc16[_0x1a8fb3(0x1ad)]['error'][_0x1a8fb3(0x1a6)]),common_1['HttpStatus'][_0x1a8fb3(0x156)]);}}async['getUploadConfig'](_0x1584a5){const _0x185a22=_0x24d5f4;if(_0x1584a5===_0x185a22(0x168)){const {aliOssRegion:_0x15c633,aliOssBucket:_0x58ddb6,aliOssAccessKeyId:_0x5efb4a,aliOssAccessKeySecret:_0x19c0c0,aliOssAcceleratedDomain:_0x10c8c5}=await this['globalConfigService'][_0x185a22(0x160)](['aliOssRegion',_0x185a22(0x155),_0x185a22(0x1b3),_0x185a22(0x1a9),_0x185a22(0x17a)]);return{'region':_0x15c633,'bucket':_0x58ddb6,'accessKeyId':_0x5efb4a,'accessKeySecret':_0x19c0c0,'acceleratedDomain':_0x10c8c5};}if(_0x1584a5===_0x185a22(0x16e)){const {cosBucket:_0x44ec65,cosRegion:_0x3db1ee,cosSecretId:_0x389d05,cosSecretKey:_0x2d083b,tencentCosAcceleratedDomain:_0xcf3065}=await this['globalConfigService'][_0x185a22(0x160)]([_0x185a22(0x151),_0x185a22(0x167),_0x185a22(0x170),_0x185a22(0x163),_0x185a22(0x1cf)]);return{'Bucket':_0x44ec65,'Region':_0x3db1ee,'SecretId':_0x389d05,'SecretKey':_0x2d083b,'acceleratedDomain':_0xcf3065};}if(_0x1584a5===_0x185a22(0x1a5)){const {cheveretoKey:_0x499741,cheveretoUploadPath:_0x152a1f}=await this[_0x185a22(0x1b9)][_0x185a22(0x160)]([_0x185a22(0x1be),_0x185a22(0x162)]);return{'key':_0x499741,'uploadPath':_0x152a1f};}}async[_0x24d5f4(0x16f)](_0x8984){const _0x559f28=_0x24d5f4,_0x1f7ec9=await axios_1['default'][_0x559f28(0x1b2)](_0x8984,{'responseType':_0x559f28(0x178)}),_0x407474=await new Promise((_0x178010,_0x31d4c7)=>{const _0x527a14=_0x559f28;streamToBuffer(_0x1f7ec9[_0x527a14(0x1ad)],(_0x5eaa79,_0x1cbd4c)=>{const _0x44cfa8=_0x527a14;_0x5eaa79?_0x31d4c7(new common_1[(_0x44cfa8(0x157))](_0x44cfa8(0x154),common_1[_0x44cfa8(0x1a1)][_0x44cfa8(0x156)])):_0x178010(_0x1cbd4c);});}),_0x725084=_0x1f7ec9['headers'][_0x559f28(0x1c4)];return{'buffer':_0x407474,'mimeType':_0x725084};}};UploadService=__decorate([(0x0,common_1['Injectable'])(),__metadata(_0x24d5f4(0x183),[globalConfig_service_1['GlobalConfigService']])],UploadService),exports[_0x24d5f4(0x17c)]=UploadService;