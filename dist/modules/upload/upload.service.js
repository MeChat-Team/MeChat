'use strict';const _0x5d3194=_0x38da;(function(_0x2e5bf0,_0x3b6788){const _0x1618c0=_0x38da,_0x266714=_0x2e5bf0();while(!![]){try{const _0x2c3b92=parseInt(_0x1618c0(0x135))/0x1+parseInt(_0x1618c0(0x108))/0x2*(parseInt(_0x1618c0(0x187))/0x3)+parseInt(_0x1618c0(0x132))/0x4*(-parseInt(_0x1618c0(0x115))/0x5)+parseInt(_0x1618c0(0x113))/0x6*(parseInt(_0x1618c0(0x177))/0x7)+parseInt(_0x1618c0(0x15e))/0x8*(-parseInt(_0x1618c0(0x136))/0x9)+-parseInt(_0x1618c0(0x160))/0xa*(-parseInt(_0x1618c0(0x109))/0xb)+-parseInt(_0x1618c0(0x154))/0xc*(-parseInt(_0x1618c0(0x152))/0xd);if(_0x2c3b92===_0x3b6788)break;else _0x266714['push'](_0x266714['shift']());}catch(_0xd37690){_0x266714['push'](_0x266714['shift']());}}}(_0x3fc5,0x5d5bc));function _0x38da(_0x353b14,_0x3c61a9){const _0x3fc5f0=_0x3fc5();return _0x38da=function(_0x38da78,_0x3f1eeb){_0x38da78=_0x38da78-0xff;let _0xbb3e0e=_0x3fc5f0[_0x38da78];return _0xbb3e0e;},_0x38da(_0x353b14,_0x3c61a9);}var __decorate=this&&this['__decorate']||function(_0x2eba49,_0x5a0839,_0x5ca372,_0x391db3){const _0x1b09b9=_0x38da;var _0x5a67a9=arguments[_0x1b09b9(0x18b)],_0x39c539=_0x5a67a9<0x3?_0x5a0839:_0x391db3===null?_0x391db3=Object[_0x1b09b9(0x158)](_0x5a0839,_0x5ca372):_0x391db3,_0x30fa87;if(typeof Reflect===_0x1b09b9(0x140)&&typeof Reflect[_0x1b09b9(0x133)]===_0x1b09b9(0x149))_0x39c539=Reflect[_0x1b09b9(0x133)](_0x2eba49,_0x5a0839,_0x5ca372,_0x391db3);else{for(var _0x1505d8=_0x2eba49[_0x1b09b9(0x18b)]-0x1;_0x1505d8>=0x0;_0x1505d8--)if(_0x30fa87=_0x2eba49[_0x1505d8])_0x39c539=(_0x5a67a9<0x3?_0x30fa87(_0x39c539):_0x5a67a9>0x3?_0x30fa87(_0x5a0839,_0x5ca372,_0x39c539):_0x30fa87(_0x5a0839,_0x5ca372))||_0x39c539;}return _0x5a67a9>0x3&&_0x39c539&&Object[_0x1b09b9(0x14a)](_0x5a0839,_0x5ca372,_0x39c539),_0x39c539;},__metadata=this&&this[_0x5d3194(0x12c)]||function(_0x5a780a,_0x49af4c){const _0x27b034=_0x5d3194;if(typeof Reflect===_0x27b034(0x140)&&typeof Reflect[_0x27b034(0x10f)]==='function')return Reflect['metadata'](_0x5a780a,_0x49af4c);};Object[_0x5d3194(0x14a)](exports,'__esModule',{'value':!![]}),exports[_0x5d3194(0x12f)]=void 0x0;function _0x3fc5(){const _0x38d203=['BAD_REQUEST','ali','extension','上传图片失败[Chevereto]','文件保存失败:\x20','slice','base64','join','acceleratedDomain','cosSecretId','public','cheveretoKey','uploadFileToLocal','未配置任何上传方式','上传失败:\x20','aliOssStatus','Injectable','stream-to-buffer','文件已上传到阿里云\x20OSS。访问\x20URL:\x20','使用\x20Chevereto\x20上传文件','uploadFileByChevereto','14175cjBhit','mkdir','bat','catch','aliOssBucket','then','Chevereto\x20--->\x20res','文件已上传到腾讯云\x20COS。访问\x20URL:\x20','getUploadConfig','HttpException','file/','aliOssAccessKeySecret','https://','formatUrl','cheveretoUploadPath','random','20253CbNlXc','上传图片失败[Chevereto|buffer]\x20-->\x20','aliOssAccessKeyId','tencentCosStatus','length','error','toLowerCase','tencent','cos\x20->\x20err:\x20','default','aliOssRegion','headers','log','tencentCosAcceleratedDomain','82LoULRI','34529bpjCfd','uploadFile','onModuleInit','上传配置状态\x20-\x20腾讯云:本地存储:\x20','siteUrl','getUploadType','metadata','removeSpecialCharacters','content-type','GlobalConfigService','30StLmeH','无法识别文件类型，请检查文件','940caaqDf','source','Location','getBufferFromUrl','url','dev/','image','put','cosRegion','putObject',',\x20阿里云:\x20','stringify',',\x20Chevereto:\x20','data','uploadFileFromUrl','title','message','substring','design:paramtypes','Logger','append','others','replace','__metadata','不允许上传此类型的文件','error:\x20','UploadService','get','cosSecretKey','12892LxxCOX','decorate','basename','519346IOREEP','27kHlMNA','当前已开启全球加速----------------->','STANDARD','uploadFileByTencentCos','chevereto','status','getConfigs','使用本地存储上传文件','非法路径，禁止访问目录之外的位置','tencentCos','object','php','post','请先前往后台配置上传图片的方式','code','ali-oss','ISDEV','getTime','@nestjs/common','function','defineProperty','endsWith','toString','文件已上传到本地存储。访问\x20URL:\x20','path','HttpStatus','axios','env','15847KTaSPL','stream','1596JlapUf','file','uploadFileByAliOss','promises','getOwnPropertyDescriptor','上传图片失败[ali]','globalConfigService','normalize','localStorageStatus','form-data','1646096RxBIXM','cheveretoStatus','2030biuKgA','创建目录失败:\x20'];_0x3fc5=function(){return _0x38d203;};return _0x3fc5();}const utils_1=require('../../common/utils'),common_1=require(_0x5d3194(0x148)),ALIOSS=require(_0x5d3194(0x145)),axios_1=require(_0x5d3194(0x150)),TENCENTCOS=require('cos-nodejs-sdk-v5'),FormData=require(_0x5d3194(0x15d)),fs_1=require('fs'),mime=require('mime-types'),path=require(_0x5d3194(0x14e)),streamToBuffer=require(_0x5d3194(0x173)),globalConfig_service_1=require('../globalConfig/globalConfig.service'),blacklist=['exe','sh',_0x5d3194(0x179),'js',_0x5d3194(0x141),'py'];let UploadService=class UploadService{constructor(_0x42bedd){const _0x50eb2f=_0x5d3194;this[_0x50eb2f(0x15a)]=_0x42bedd;}[_0x5d3194(0x10b)](){}async[_0x5d3194(0x10a)](_0x5e184a,_0x23ac58=_0x5d3194(0x12a)){const _0x4c6cd7=_0x5d3194,{buffer:_0x3ceab7,mimetype:_0x114f09}=_0x5e184a;process[_0x4c6cd7(0x151)]['ISDEV']==='TRUE'&&(_0x23ac58=_0x4c6cd7(0x11a)+_0x23ac58);const _0xae7102=mime[_0x4c6cd7(0x164)](_0x114f09)||'';!_0xae7102&&common_1['Logger'][_0x4c6cd7(0xff)](_0x4c6cd7(0x114),'UploadService');if(blacklist['includes'](_0xae7102[_0x4c6cd7(0x100)]())){common_1[_0x4c6cd7(0x128)][_0x4c6cd7(0xff)]('不允许上传此类型的文件',_0x4c6cd7(0x12f));throw new Error(_0x4c6cd7(0x12d));}const _0x53a61a=new Date(),_0x36f639=_0x53a61a[_0x4c6cd7(0x147)](),_0x178a7b=Math[_0x4c6cd7(0x186)]()[_0x4c6cd7(0x14c)](0x24)[_0x4c6cd7(0x126)](0x2,0x6),_0x4471ac=_0x36f639+'_'+_0x178a7b+'.'+_0xae7102,{tencentCosStatus:tencentCosStatus=0x0,aliOssStatus:aliOssStatus=0x0,cheveretoStatus:cheveretoStatus=0x0,localStorageStatus:localStorageStatus=0x0}=await this['globalConfigService'][_0x4c6cd7(0x13c)]([_0x4c6cd7(0x18a),_0x4c6cd7(0x171),_0x4c6cd7(0x15f),_0x4c6cd7(0x15c)]);common_1[_0x4c6cd7(0x128)][_0x4c6cd7(0x106)](_0x4c6cd7(0x10c)+localStorageStatus+',\x20'+tencentCosStatus+_0x4c6cd7(0x11f)+aliOssStatus+_0x4c6cd7(0x121)+cheveretoStatus,_0x4c6cd7(0x12f));if(!Number(tencentCosStatus)&&!Number(aliOssStatus)&&!Number(cheveretoStatus)&&!Number(localStorageStatus)){common_1[_0x4c6cd7(0x128)][_0x4c6cd7(0xff)](_0x4c6cd7(0x16f),_0x4c6cd7(0x12f));throw new common_1[(_0x4c6cd7(0x180))](_0x4c6cd7(0x143),common_1['HttpStatus'][_0x4c6cd7(0x162)]);}try{if(Number(localStorageStatus)){common_1[_0x4c6cd7(0x128)][_0x4c6cd7(0x106)](_0x4c6cd7(0x13d),_0x4c6cd7(0x12f));const _0x3be3bc=await this['uploadFileToLocal']({'filename':_0x4471ac,'buffer':_0x3ceab7,'dir':_0x23ac58});return common_1[_0x4c6cd7(0x128)][_0x4c6cd7(0x106)](_0x4c6cd7(0x14d)+_0x3be3bc,_0x4c6cd7(0x12f)),_0x3be3bc;}if(Number(tencentCosStatus)){common_1[_0x4c6cd7(0x128)]['log']('使用腾讯云\x20COS\x20上传文件',_0x4c6cd7(0x12f));const _0x4c74ae=await this[_0x4c6cd7(0x139)]({'filename':_0x4471ac,'buffer':_0x3ceab7,'dir':_0x23ac58});return common_1[_0x4c6cd7(0x128)][_0x4c6cd7(0x106)](_0x4c6cd7(0x17e)+_0x4c74ae,_0x4c6cd7(0x12f)),_0x4c74ae;}if(Number(aliOssStatus)){common_1[_0x4c6cd7(0x128)][_0x4c6cd7(0x106)]('使用阿里云\x20OSS\x20上传文件',_0x4c6cd7(0x12f));const _0x29ee04=await this[_0x4c6cd7(0x156)]({'filename':_0x4471ac,'buffer':_0x3ceab7,'dir':_0x23ac58});return common_1['Logger'][_0x4c6cd7(0x106)](_0x4c6cd7(0x174)+_0x29ee04,'UploadService'),_0x29ee04;}if(Number(cheveretoStatus)){common_1[_0x4c6cd7(0x128)]['log'](_0x4c6cd7(0x175),_0x4c6cd7(0x12f));const _0x1721fe=await this['uploadFileByChevereto']({'filename':_0x4471ac,'buffer':_0x3ceab7[_0x4c6cd7(0x14c)](_0x4c6cd7(0x168))});return common_1[_0x4c6cd7(0x128)][_0x4c6cd7(0x106)]('文件已上传到\x20Chevereto。访问\x20URL:\x20'+_0x1721fe,_0x4c6cd7(0x12f)),_0x1721fe;}}catch(_0x4ece15){common_1['Logger'][_0x4c6cd7(0xff)](_0x4c6cd7(0x170)+_0x4ece15[_0x4c6cd7(0x125)],_0x4c6cd7(0x12f));throw _0x4ece15;}}async[_0x5d3194(0x10e)](){const _0x33565f=_0x5d3194,{tencentCosStatus:tencentCosStatus=0x0,aliOssStatus:aliOssStatus=0x0,cheveretoStatus:cheveretoStatus=0x0}=await this['globalConfigService']['getConfigs']([_0x33565f(0x18a),_0x33565f(0x171),_0x33565f(0x15f)]);if(Number(tencentCosStatus))return'tencent';if(Number(aliOssStatus))return _0x33565f(0x163);if(Number(cheveretoStatus))return _0x33565f(0x13a);}async[_0x5d3194(0x123)]({url:_0x2dd4e4,dir:dir=_0x5d3194(0x12a)}){const _0x535b0e=_0x5d3194;process[_0x535b0e(0x151)][_0x535b0e(0x146)]==='TRUE'&&(dir=_0x535b0e(0x11a)+dir);const {buffer:_0x34d876,mimeType:_0x5d54d3}=await this['getBufferFromUrl'](_0x2dd4e4);return await this['uploadFile']({'buffer':_0x34d876,'mimetype':_0x5d54d3},dir);}async['uploadFileByTencentCos']({filename:_0x35bb37,buffer:_0x21c2bc,dir:_0x1d33cc}){const _0x16b1a0=_0x5d3194,{Bucket:_0x2b52ca,Region:_0x4bb1c4,SecretId:_0x4738f8,SecretKey:_0x3d8080}=await this[_0x16b1a0(0x17f)](_0x16b1a0(0x101));this[_0x16b1a0(0x13f)]=new TENCENTCOS({'SecretId':_0x4738f8,'SecretKey':_0x3d8080,'FileParallelLimit':0xa});try{return new Promise(async(_0x41809c,_0x5eda69)=>{const _0x2b95da=_0x16b1a0;this[_0x2b95da(0x13f)][_0x2b95da(0x11e)]({'Bucket':(0x0,utils_1['removeSpecialCharacters'])(_0x2b52ca),'Region':(0x0,utils_1[_0x2b95da(0x110)])(_0x4bb1c4),'Key':_0x1d33cc+'/'+_0x35bb37,'StorageClass':_0x2b95da(0x138),'Body':_0x21c2bc},async(_0x46fde1,_0x3bc413)=>{const _0x27d138=_0x2b95da;if(_0x46fde1)return console['log'](_0x27d138(0x102),_0x46fde1),_0x5eda69(_0x46fde1);let _0x5ad34f=_0x3bc413[_0x27d138(0x117)]['replace'](/^(http:\/\/|https:\/\/|\/\/|)(.*)/,'https://$2');const {acceleratedDomain:_0x12f082}=await this[_0x27d138(0x17f)](_0x27d138(0x101));return _0x12f082&&(_0x5ad34f=_0x5ad34f['replace'](/^(https:\/\/[^/]+)(\/.*)$/,'https://'+_0x12f082+'$2'),console['log'](_0x27d138(0x137),_0x5ad34f)),_0x41809c(_0x5ad34f);});});}catch(_0xe287d2){console[_0x16b1a0(0x106)]('error:\x20',_0xe287d2);throw new common_1[(_0x16b1a0(0x180))]('上传图片失败[ten]',common_1[_0x16b1a0(0x14f)][_0x16b1a0(0x162)]);}}async[_0x5d3194(0x156)]({filename:_0x10f5ec,buffer:_0x306ae7,dir:_0x8802ba}){const _0x1e66dd=_0x5d3194,{region:_0x11f5ac,bucket:_0x94e608,accessKeyId:_0x45f3c7,accessKeySecret:_0xc811b4}=await this[_0x1e66dd(0x17f)](_0x1e66dd(0x163)),_0x2794bf=new ALIOSS({'region':(0x0,utils_1[_0x1e66dd(0x110)])(_0x11f5ac),'accessKeyId':_0x45f3c7,'accessKeySecret':_0xc811b4,'bucket':(0x0,utils_1[_0x1e66dd(0x110)])(_0x94e608)});try{return console[_0x1e66dd(0x106)]('ali\x20开始上传'),new Promise((_0x4915b6,_0x499910)=>{const _0x2d8ea1=_0x1e66dd;_0x2794bf[_0x2d8ea1(0x11c)](_0x8802ba+'/'+_0x10f5ec,_0x306ae7)[_0x2d8ea1(0x17c)](async _0x24e0ea=>{const _0x3b6667=_0x2d8ea1,{acceleratedDomain:_0x507a4a}=await this['getUploadConfig'](_0x3b6667(0x163));_0x507a4a&&(_0x24e0ea[_0x3b6667(0x119)]=_0x24e0ea[_0x3b6667(0x119)]['replace'](/^(https:\/\/[^/]+)(\/.*)$/,_0x3b6667(0x183)+_0x507a4a+'$2'),console[_0x3b6667(0x106)](_0x3b6667(0x137),_0x24e0ea['url'])),_0x4915b6(_0x24e0ea[_0x3b6667(0x119)]);})[_0x2d8ea1(0x17a)](_0x3c634c=>{_0x499910(_0x3c634c);});});}catch(_0x58174f){throw new common_1[(_0x1e66dd(0x180))](_0x1e66dd(0x159),common_1[_0x1e66dd(0x14f)][_0x1e66dd(0x162)]);}}async[_0x5d3194(0x16e)]({filename:_0x3f321f,buffer:_0x5ac058,dir:dir=_0x5d3194(0x12a)}){const _0x58469d=_0x5d3194,_0x2a20a=path[_0x58469d(0x15b)](dir)[_0x58469d(0x12b)](/^(\.\.(\/|\\|$))+/,''),_0xe456b8=path[_0x58469d(0x134)](_0x3f321f),_0x38490e=process['cwd'](),_0x4426f8=path['join'](_0x38490e,_0x58469d(0x16c),_0x58469d(0x155),_0x2a20a),_0xfe78f9=path[_0x58469d(0x169)](_0x4426f8,_0xe456b8);if(!_0xfe78f9['startsWith'](path[_0x58469d(0x169)](_0x38490e,_0x58469d(0x16c),'file')))throw new Error(_0x58469d(0x13e));try{await fs_1[_0x58469d(0x157)][_0x58469d(0x178)](_0x4426f8,{'recursive':!![]});}catch(_0x40a047){common_1[_0x58469d(0x128)]['error'](_0x58469d(0x161)+_0x4426f8,_0x40a047);throw _0x40a047;}try{await fs_1[_0x58469d(0x157)]['writeFile'](_0xfe78f9,_0x5ac058,{'mode':0x124});}catch(_0x1d27e7){common_1[_0x58469d(0x128)][_0x58469d(0xff)](_0x58469d(0x166)+_0xfe78f9,_0x1d27e7);throw _0x1d27e7;}let _0x7b733d=_0x58469d(0x181)+_0x2a20a+'/'+_0xe456b8;const _0x205d57=await this['globalConfigService'][_0x58469d(0x13c)]([_0x58469d(0x10d)]);if(_0x205d57){const _0x45b15c=(0x0,utils_1[_0x58469d(0x184)])(_0x205d57);_0x7b733d=_0x45b15c+'/'+_0x7b733d;}return _0x7b733d;}async[_0x5d3194(0x176)]({filename:filename='',buffer:_0x375593}){const _0x3b5fa6=_0x5d3194;var _0x1c0371;const {key:_0x5cdced,uploadPath:_0x566c38}=await this[_0x3b5fa6(0x17f)](_0x3b5fa6(0x13a));let _0x4c0cee=_0x566c38[_0x3b5fa6(0x14b)]('/')?_0x566c38[_0x3b5fa6(0x167)](0x0,-0x1):_0x566c38;const _0x26aa73=new FormData(),_0x2a8735=_0x375593['toString'](_0x3b5fa6(0x168));_0x26aa73['append'](_0x3b5fa6(0x116),_0x2a8735),_0x26aa73[_0x3b5fa6(0x129)]('key',_0x5cdced),_0x26aa73[_0x3b5fa6(0x129)](_0x3b5fa6(0x124),filename);try{const _0x3e45fc=await axios_1[_0x3b5fa6(0x103)][_0x3b5fa6(0x142)](_0x4c0cee,_0x26aa73,{'headers':{'X-API-Key':_0x5cdced}});if((_0x3e45fc===null||_0x3e45fc===void 0x0?void 0x0:_0x3e45fc[_0x3b5fa6(0x13b)])===0xc8)return _0x3e45fc[_0x3b5fa6(0x122)][_0x3b5fa6(0x11b)][_0x3b5fa6(0x119)];else console[_0x3b5fa6(0x106)](_0x3b5fa6(0x17d),_0x3e45fc===null||_0x3e45fc===void 0x0?void 0x0:_0x3e45fc[_0x3b5fa6(0x122)][_0x3b5fa6(0x144)],_0x3e45fc===null||_0x3e45fc===void 0x0?void 0x0:_0x3e45fc[_0x3b5fa6(0x122)][_0x3b5fa6(0xff)][_0x3b5fa6(0x125)]),common_1[_0x3b5fa6(0x128)][_0x3b5fa6(0xff)](_0x3b5fa6(0x165),JSON[_0x3b5fa6(0x120)](_0x3e45fc[_0x3b5fa6(0x122)]));}catch(_0x5b2d7c){console[_0x3b5fa6(0x106)](_0x3b5fa6(0x12e),_0x5b2d7c);throw new common_1[(_0x3b5fa6(0x180))](_0x3b5fa6(0x188)+((_0x1c0371=_0x5b2d7c['response'])===null||_0x1c0371===void 0x0?void 0x0:_0x1c0371['data'][_0x3b5fa6(0xff)][_0x3b5fa6(0x125)]),common_1[_0x3b5fa6(0x14f)][_0x3b5fa6(0x162)]);}}async[_0x5d3194(0x17f)](_0x2b7d49){const _0x4afaa8=_0x5d3194;if(_0x2b7d49==='ali'){const {aliOssRegion:_0x4c1e10,aliOssBucket:_0x5a8715,aliOssAccessKeyId:_0x2129f8,aliOssAccessKeySecret:_0x4593f8,aliOssAcceleratedDomain:_0xf1248a}=await this[_0x4afaa8(0x15a)]['getConfigs']([_0x4afaa8(0x104),_0x4afaa8(0x17b),_0x4afaa8(0x189),_0x4afaa8(0x182),_0x4afaa8(0x16a)]);return{'region':_0x4c1e10,'bucket':_0x5a8715,'accessKeyId':_0x2129f8,'accessKeySecret':_0x4593f8,'acceleratedDomain':_0xf1248a};}if(_0x2b7d49==='tencent'){const {cosBucket:_0x2a2a49,cosRegion:_0x17f5df,cosSecretId:_0x15d03a,cosSecretKey:_0x9e604b,tencentCosAcceleratedDomain:_0x35e7fb}=await this['globalConfigService'][_0x4afaa8(0x13c)](['cosBucket',_0x4afaa8(0x11d),_0x4afaa8(0x16b),_0x4afaa8(0x131),_0x4afaa8(0x107)]);return{'Bucket':_0x2a2a49,'Region':_0x17f5df,'SecretId':_0x15d03a,'SecretKey':_0x9e604b,'acceleratedDomain':_0x35e7fb};}if(_0x2b7d49==='chevereto'){const {cheveretoKey:_0x4887d2,cheveretoUploadPath:_0x4ce569}=await this[_0x4afaa8(0x15a)][_0x4afaa8(0x13c)]([_0x4afaa8(0x16d),_0x4afaa8(0x185)]);return{'key':_0x4887d2,'uploadPath':_0x4ce569};}}async[_0x5d3194(0x118)](_0x3d7c4f){const _0x4ebcc9=_0x5d3194,_0x22891b=await axios_1[_0x4ebcc9(0x103)][_0x4ebcc9(0x130)](_0x3d7c4f,{'responseType':_0x4ebcc9(0x153)}),_0x383394=await new Promise((_0x2fcde5,_0x42c74a)=>{const _0x40c599=_0x4ebcc9;streamToBuffer(_0x22891b[_0x40c599(0x122)],(_0x42fcec,_0xa00e00)=>{const _0x2886ef=_0x40c599;_0x42fcec?_0x42c74a(new common_1[(_0x2886ef(0x180))]('获取图片资源失败，请重新试试吧！',common_1[_0x2886ef(0x14f)][_0x2886ef(0x162)])):_0x2fcde5(_0xa00e00);});}),_0x241e1a=_0x22891b[_0x4ebcc9(0x105)][_0x4ebcc9(0x111)];return{'buffer':_0x383394,'mimeType':_0x241e1a};}};UploadService=__decorate([(0x0,common_1[_0x5d3194(0x172)])(),__metadata(_0x5d3194(0x127),[globalConfig_service_1[_0x5d3194(0x112)]])],UploadService),exports[_0x5d3194(0x12f)]=UploadService;