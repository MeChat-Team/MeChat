'use strict';const _0x1ff6d8=_0x3d45;(function(_0x22af95,_0x278b9d){const _0x47ada6=_0x3d45,_0x20ba50=_0x22af95();while(!![]){try{const _0xa40ad=parseInt(_0x47ada6(0x19a))/0x1+parseInt(_0x47ada6(0x18a))/0x2*(parseInt(_0x47ada6(0x153))/0x3)+parseInt(_0x47ada6(0x16f))/0x4+parseInt(_0x47ada6(0x140))/0x5+parseInt(_0x47ada6(0x171))/0x6*(-parseInt(_0x47ada6(0x17e))/0x7)+parseInt(_0x47ada6(0x184))/0x8*(parseInt(_0x47ada6(0x14b))/0x9)+-parseInt(_0x47ada6(0x1b5))/0xa*(parseInt(_0x47ada6(0x17c))/0xb);if(_0xa40ad===_0x278b9d)break;else _0x20ba50['push'](_0x20ba50['shift']());}catch(_0x432449){_0x20ba50['push'](_0x20ba50['shift']());}}}(_0x570a,0xb2495));function _0x570a(){const _0x180e68=['316849BFFQoq','aliOssRegion','join','https://','无法识别文件类型，请检查文件','error','uploadFileToLocal','ISDEV','上传图片失败[ten]','toString','Injectable','path','base64','get','stream-to-buffer','design:paramtypes','writeFile','acceleratedDomain','cos-nodejs-sdk-v5','error:\x20','bat','put','startsWith','上传配置状态\x20-\x20腾讯云:本地存储:\x20','default','TRUE','使用\x20Chevereto\x20上传文件','10JsiAGK','length','substring','key','chevereto','cheveretoKey','formatUrl','random','then','cheveretoUploadPath','上传图片失败[ali]','normalize','function','title','getConfigs','ali-oss','文件已上传到阿里云\x20OSS。访问\x20URL:\x20','localStorageStatus','file','GlobalConfigService','1764360wwKsEk','不允许上传此类型的文件','status','cosSecretKey',',\x20阿里云:\x20','STANDARD','globalConfigService','others','metadata','tencentCosStatus','上传图片失败[Chevereto|buffer]\x20-->\x20','821619bTbZfR','mime-types','axios','post','code','file/','getUploadType','Logger','513drBqUa','BAD_REQUEST','decorate','uploadFileFromUrl','removeSpecialCharacters','../globalConfig/globalConfig.service','source','文件已上传到\x20Chevereto。访问\x20URL:\x20','HttpException','log','url','public','uploadFileByChevereto','__metadata','toLowerCase','aliOssAccessKeySecret','使用本地存储上传文件','exe','Location','slice','replace','stringify','aliOssStatus','append','response','extension','includes','stream','2935616diIOGW','cosBucket','12iCNHpr','getBufferFromUrl','ali','object','tencent','image','message','defineProperty','tencentCosAcceleratedDomain','promises','uploadFileByAliOss','26641538pEIiks','getUploadConfig','923657MOWZfE','aliOssBucket','env','请先前往后台配置上传图片的方式','dev/','非法路径，禁止访问目录之外的位置','120znNFDA','HttpStatus','使用阿里云\x20OSS\x20上传文件','https://$2','UploadService','uploadFile','7522udjjzF','putObject','未配置任何上传方式','tencentCos','创建目录失败:\x20','文件已上传到本地存储。访问\x20URL:\x20','siteUrl','cosSecretId','文件已上传到腾讯云\x20COS。访问\x20URL:\x20','../../common/utils','cheveretoStatus','uploadFileByTencentCos','文件保存失败:\x20','content-type','cosRegion','data'];_0x570a=function(){return _0x180e68;};return _0x570a();}function _0x3d45(_0x1ddffc,_0x257b23){const _0x570ad5=_0x570a();return _0x3d45=function(_0x3d4533,_0x23318d){_0x3d4533=_0x3d4533-0x13f;let _0x4914a0=_0x570ad5[_0x3d4533];return _0x4914a0;},_0x3d45(_0x1ddffc,_0x257b23);}var __decorate=this&&this['__decorate']||function(_0x40c108,_0x303d49,_0x2f236d,_0x171fc9){const _0x56731d=_0x3d45;var _0x31d81c=arguments[_0x56731d(0x1b6)],_0x424b6f=_0x31d81c<0x3?_0x303d49:_0x171fc9===null?_0x171fc9=Object['getOwnPropertyDescriptor'](_0x303d49,_0x2f236d):_0x171fc9,_0x8d0221;if(typeof Reflect===_0x56731d(0x174)&&typeof Reflect[_0x56731d(0x155)]===_0x56731d(0x1c1))_0x424b6f=Reflect['decorate'](_0x40c108,_0x303d49,_0x2f236d,_0x171fc9);else{for(var _0x3ac7ae=_0x40c108[_0x56731d(0x1b6)]-0x1;_0x3ac7ae>=0x0;_0x3ac7ae--)if(_0x8d0221=_0x40c108[_0x3ac7ae])_0x424b6f=(_0x31d81c<0x3?_0x8d0221(_0x424b6f):_0x31d81c>0x3?_0x8d0221(_0x303d49,_0x2f236d,_0x424b6f):_0x8d0221(_0x303d49,_0x2f236d))||_0x424b6f;}return _0x31d81c>0x3&&_0x424b6f&&Object[_0x56731d(0x178)](_0x303d49,_0x2f236d,_0x424b6f),_0x424b6f;},__metadata=this&&this[_0x1ff6d8(0x160)]||function(_0x5d3a63,_0x411f72){const _0x43d59e=_0x1ff6d8;if(typeof Reflect===_0x43d59e(0x174)&&typeof Reflect[_0x43d59e(0x148)]===_0x43d59e(0x1c1))return Reflect['metadata'](_0x5d3a63,_0x411f72);};Object[_0x1ff6d8(0x178)](exports,'__esModule',{'value':!![]}),exports[_0x1ff6d8(0x188)]=void 0x0;const utils_1=require(_0x1ff6d8(0x193)),common_1=require('@nestjs/common'),ALIOSS=require(_0x1ff6d8(0x1c4)),axios_1=require(_0x1ff6d8(0x14d)),TENCENTCOS=require(_0x1ff6d8(0x1ac)),FormData=require('form-data'),fs_1=require('fs'),mime=require(_0x1ff6d8(0x14c)),path=require(_0x1ff6d8(0x1a5)),streamToBuffer=require(_0x1ff6d8(0x1a8)),globalConfig_service_1=require(_0x1ff6d8(0x158)),blacklist=[_0x1ff6d8(0x164),'sh',_0x1ff6d8(0x1ae),'js','php','py'];let UploadService=class UploadService{constructor(_0x298518){const _0x385a73=_0x1ff6d8;this[_0x385a73(0x146)]=_0x298518;}['onModuleInit'](){}async[_0x1ff6d8(0x189)](_0x4d769e,_0xa99081=_0x1ff6d8(0x147)){const _0xfaa2fc=_0x1ff6d8,{buffer:_0x563b4d,mimetype:_0xf9bc1d}=_0x4d769e;process[_0xfaa2fc(0x180)][_0xfaa2fc(0x1a1)]==='TRUE'&&(_0xa99081='dev/'+_0xa99081);const _0x270fc4=mime[_0xfaa2fc(0x16c)](_0xf9bc1d)||'';!_0x270fc4&&common_1[_0xfaa2fc(0x152)]['error'](_0xfaa2fc(0x19e),_0xfaa2fc(0x188));if(blacklist[_0xfaa2fc(0x16d)](_0x270fc4[_0xfaa2fc(0x161)]())){common_1[_0xfaa2fc(0x152)][_0xfaa2fc(0x19f)](_0xfaa2fc(0x141),_0xfaa2fc(0x188));throw new Error(_0xfaa2fc(0x141));}const _0x214f37=new Date(),_0x411d18=_0x214f37['getTime'](),_0x1fa3c6=Math[_0xfaa2fc(0x1bc)]()[_0xfaa2fc(0x1a3)](0x24)[_0xfaa2fc(0x1b7)](0x2,0x6),_0x4dd642=_0x411d18+'_'+_0x1fa3c6+'.'+_0x270fc4,{tencentCosStatus:tencentCosStatus=0x0,aliOssStatus:aliOssStatus=0x0,cheveretoStatus:cheveretoStatus=0x0,localStorageStatus:localStorageStatus=0x0}=await this[_0xfaa2fc(0x146)][_0xfaa2fc(0x1c3)]([_0xfaa2fc(0x149),_0xfaa2fc(0x169),'cheveretoStatus',_0xfaa2fc(0x1c6)]);common_1['Logger']['log'](_0xfaa2fc(0x1b1)+localStorageStatus+',\x20'+tencentCosStatus+_0xfaa2fc(0x144)+aliOssStatus+',\x20Chevereto:\x20'+cheveretoStatus,_0xfaa2fc(0x188));if(!Number(tencentCosStatus)&&!Number(aliOssStatus)&&!Number(cheveretoStatus)&&!Number(localStorageStatus)){common_1[_0xfaa2fc(0x152)][_0xfaa2fc(0x19f)](_0xfaa2fc(0x18c),_0xfaa2fc(0x188));throw new common_1[(_0xfaa2fc(0x15b))](_0xfaa2fc(0x181),common_1[_0xfaa2fc(0x185)][_0xfaa2fc(0x154)]);}try{if(Number(localStorageStatus)){common_1[_0xfaa2fc(0x152)][_0xfaa2fc(0x15c)](_0xfaa2fc(0x163),_0xfaa2fc(0x188));const _0x6a3999=await this[_0xfaa2fc(0x1a0)]({'filename':_0x4dd642,'buffer':_0x563b4d,'dir':_0xa99081});return common_1['Logger']['log'](_0xfaa2fc(0x18f)+_0x6a3999,_0xfaa2fc(0x188)),_0x6a3999;}if(Number(tencentCosStatus)){common_1[_0xfaa2fc(0x152)]['log']('使用腾讯云\x20COS\x20上传文件',_0xfaa2fc(0x188));const _0x428539=await this[_0xfaa2fc(0x195)]({'filename':_0x4dd642,'buffer':_0x563b4d,'dir':_0xa99081});return common_1[_0xfaa2fc(0x152)]['log'](_0xfaa2fc(0x192)+_0x428539,_0xfaa2fc(0x188)),_0x428539;}if(Number(aliOssStatus)){common_1[_0xfaa2fc(0x152)]['log'](_0xfaa2fc(0x186),_0xfaa2fc(0x188));const _0x5ea103=await this['uploadFileByAliOss']({'filename':_0x4dd642,'buffer':_0x563b4d,'dir':_0xa99081});return common_1[_0xfaa2fc(0x152)]['log'](_0xfaa2fc(0x1c5)+_0x5ea103,_0xfaa2fc(0x188)),_0x5ea103;}if(Number(cheveretoStatus)){common_1['Logger'][_0xfaa2fc(0x15c)](_0xfaa2fc(0x1b4),_0xfaa2fc(0x188));const _0x3b57d3=await this[_0xfaa2fc(0x15f)]({'filename':_0x4dd642,'buffer':_0x563b4d[_0xfaa2fc(0x1a3)](_0xfaa2fc(0x1a6))});return common_1['Logger'][_0xfaa2fc(0x15c)](_0xfaa2fc(0x15a)+_0x3b57d3,_0xfaa2fc(0x188)),_0x3b57d3;}}catch(_0x45391d){common_1[_0xfaa2fc(0x152)]['error']('上传失败:\x20'+_0x45391d[_0xfaa2fc(0x177)],_0xfaa2fc(0x188));throw _0x45391d;}}async[_0x1ff6d8(0x151)](){const _0x4d6a4c=_0x1ff6d8,{tencentCosStatus:tencentCosStatus=0x0,aliOssStatus:aliOssStatus=0x0,cheveretoStatus:cheveretoStatus=0x0}=await this[_0x4d6a4c(0x146)][_0x4d6a4c(0x1c3)]([_0x4d6a4c(0x149),_0x4d6a4c(0x169),_0x4d6a4c(0x194)]);if(Number(tencentCosStatus))return _0x4d6a4c(0x175);if(Number(aliOssStatus))return'ali';if(Number(cheveretoStatus))return _0x4d6a4c(0x1b9);}async[_0x1ff6d8(0x156)]({url:_0x4fb6ca,dir:dir=_0x1ff6d8(0x147)}){const _0x173f8d=_0x1ff6d8;process[_0x173f8d(0x180)][_0x173f8d(0x1a1)]===_0x173f8d(0x1b3)&&(dir=_0x173f8d(0x182)+dir);const {buffer:_0x2721bd,mimeType:_0x4849dc}=await this[_0x173f8d(0x172)](_0x4fb6ca);return await this[_0x173f8d(0x189)]({'buffer':_0x2721bd,'mimetype':_0x4849dc},dir);}async[_0x1ff6d8(0x195)]({filename:_0x407a53,buffer:_0x5878e1,dir:_0x4dc13f}){const _0x3c5a45=_0x1ff6d8,{Bucket:_0x44a188,Region:_0x49eb0c,SecretId:_0x1e3103,SecretKey:_0x4b1ba3}=await this[_0x3c5a45(0x17d)]('tencent');this[_0x3c5a45(0x18d)]=new TENCENTCOS({'SecretId':_0x1e3103,'SecretKey':_0x4b1ba3,'FileParallelLimit':0xa});try{return new Promise(async(_0x2e11b1,_0x284826)=>{const _0x375406=_0x3c5a45;this['tencentCos'][_0x375406(0x18b)]({'Bucket':(0x0,utils_1[_0x375406(0x157)])(_0x44a188),'Region':(0x0,utils_1[_0x375406(0x157)])(_0x49eb0c),'Key':_0x4dc13f+'/'+_0x407a53,'StorageClass':_0x375406(0x145),'Body':_0x5878e1},async(_0x476b43,_0x15e483)=>{const _0x2fbb46=_0x375406;if(_0x476b43)return console['log']('cos\x20->\x20err:\x20',_0x476b43),_0x284826(_0x476b43);let _0x255e0f=_0x15e483[_0x2fbb46(0x165)]['replace'](/^(http:\/\/|https:\/\/|\/\/|)(.*)/,_0x2fbb46(0x187));const {acceleratedDomain:_0x3ca737}=await this[_0x2fbb46(0x17d)]('tencent');return _0x3ca737&&(_0x255e0f=_0x255e0f[_0x2fbb46(0x167)](/^(https:\/\/[^/]+)(\/.*)$/,_0x2fbb46(0x19d)+_0x3ca737+'$2'),console[_0x2fbb46(0x15c)]('当前已开启全球加速----------------->',_0x255e0f)),_0x2e11b1(_0x255e0f);});});}catch(_0x14b343){console[_0x3c5a45(0x15c)]('error:\x20',_0x14b343);throw new common_1[(_0x3c5a45(0x15b))](_0x3c5a45(0x1a2),common_1[_0x3c5a45(0x185)][_0x3c5a45(0x154)]);}}async[_0x1ff6d8(0x17b)]({filename:_0x129821,buffer:_0x397b09,dir:_0x368bc6}){const _0x399f04=_0x1ff6d8,{region:_0x2108b0,bucket:_0x1ba96a,accessKeyId:_0xace3d8,accessKeySecret:_0x469568}=await this[_0x399f04(0x17d)](_0x399f04(0x173)),_0x58cc24=new ALIOSS({'region':(0x0,utils_1['removeSpecialCharacters'])(_0x2108b0),'accessKeyId':_0xace3d8,'accessKeySecret':_0x469568,'bucket':(0x0,utils_1[_0x399f04(0x157)])(_0x1ba96a)});try{return console[_0x399f04(0x15c)]('ali\x20开始上传'),new Promise((_0x289c7e,_0x2bf0ec)=>{const _0x27a1a3=_0x399f04;_0x58cc24[_0x27a1a3(0x1af)](_0x368bc6+'/'+_0x129821,_0x397b09)[_0x27a1a3(0x1bd)](async _0x5d322f=>{const _0x5185b0=_0x27a1a3,{acceleratedDomain:_0x2fc169}=await this[_0x5185b0(0x17d)](_0x5185b0(0x173));_0x2fc169&&(_0x5d322f['url']=_0x5d322f[_0x5185b0(0x15d)][_0x5185b0(0x167)](/^(https:\/\/[^/]+)(\/.*)$/,_0x5185b0(0x19d)+_0x2fc169+'$2'),console[_0x5185b0(0x15c)]('当前已开启全球加速----------------->',_0x5d322f[_0x5185b0(0x15d)])),_0x289c7e(_0x5d322f[_0x5185b0(0x15d)]);})['catch'](_0x1eb947=>{_0x2bf0ec(_0x1eb947);});});}catch(_0x5a2bd1){throw new common_1['HttpException'](_0x399f04(0x1bf),common_1[_0x399f04(0x185)][_0x399f04(0x154)]);}}async[_0x1ff6d8(0x1a0)]({filename:_0x417ea6,buffer:_0x4ade26,dir:dir=_0x1ff6d8(0x147)}){const _0x205c80=_0x1ff6d8,_0xbe4401=path[_0x205c80(0x1c0)](dir)[_0x205c80(0x167)](/^(\.\.(\/|\\|$))+/,''),_0x1be9ee=path['basename'](_0x417ea6),_0x440349=process['cwd'](),_0x5d1804=path[_0x205c80(0x19c)](_0x440349,_0x205c80(0x15e),'file',_0xbe4401),_0x498ad4=path[_0x205c80(0x19c)](_0x5d1804,_0x1be9ee);if(!_0x498ad4[_0x205c80(0x1b0)](path[_0x205c80(0x19c)](_0x440349,_0x205c80(0x15e),_0x205c80(0x1c7))))throw new Error(_0x205c80(0x183));try{await fs_1[_0x205c80(0x17a)]['mkdir'](_0x5d1804,{'recursive':!![]});}catch(_0x21744f){common_1[_0x205c80(0x152)]['error'](_0x205c80(0x18e)+_0x5d1804,_0x21744f);throw _0x21744f;}try{await fs_1[_0x205c80(0x17a)][_0x205c80(0x1aa)](_0x498ad4,_0x4ade26,{'mode':0x124});}catch(_0x831f0a){common_1[_0x205c80(0x152)][_0x205c80(0x19f)](_0x205c80(0x196)+_0x498ad4,_0x831f0a);throw _0x831f0a;}let _0x490dfe=_0x205c80(0x150)+_0xbe4401+'/'+_0x1be9ee;const _0x343241=await this[_0x205c80(0x146)][_0x205c80(0x1c3)]([_0x205c80(0x190)]);if(_0x343241){const _0x5dc80c=(0x0,utils_1[_0x205c80(0x1bb)])(_0x343241);_0x490dfe=_0x5dc80c+'/'+_0x490dfe;}return _0x490dfe;}async['uploadFileByChevereto']({filename:filename='',buffer:_0x515a51}){const _0x1faed0=_0x1ff6d8;var _0x470e7b;const {key:_0x30caed,uploadPath:_0x3df1a1}=await this['getUploadConfig']('chevereto');let _0x4ee257=_0x3df1a1['endsWith']('/')?_0x3df1a1[_0x1faed0(0x166)](0x0,-0x1):_0x3df1a1;const _0x271531=new FormData(),_0x516f4e=_0x515a51[_0x1faed0(0x1a3)](_0x1faed0(0x1a6));_0x271531[_0x1faed0(0x16a)](_0x1faed0(0x159),_0x516f4e),_0x271531['append'](_0x1faed0(0x1b8),_0x30caed),_0x271531[_0x1faed0(0x16a)](_0x1faed0(0x1c2),filename);try{const _0xc51a65=await axios_1[_0x1faed0(0x1b2)][_0x1faed0(0x14e)](_0x4ee257,_0x271531,{'headers':{'X-API-Key':_0x30caed}});if((_0xc51a65===null||_0xc51a65===void 0x0?void 0x0:_0xc51a65[_0x1faed0(0x142)])===0xc8)return _0xc51a65['data'][_0x1faed0(0x176)]['url'];else console['log']('Chevereto\x20--->\x20res',_0xc51a65===null||_0xc51a65===void 0x0?void 0x0:_0xc51a65[_0x1faed0(0x199)][_0x1faed0(0x14f)],_0xc51a65===null||_0xc51a65===void 0x0?void 0x0:_0xc51a65[_0x1faed0(0x199)][_0x1faed0(0x19f)]['message']),common_1['Logger'][_0x1faed0(0x19f)]('上传图片失败[Chevereto]',JSON[_0x1faed0(0x168)](_0xc51a65[_0x1faed0(0x199)]));}catch(_0x37aa0e){console[_0x1faed0(0x15c)](_0x1faed0(0x1ad),_0x37aa0e);throw new common_1[(_0x1faed0(0x15b))](_0x1faed0(0x14a)+((_0x470e7b=_0x37aa0e[_0x1faed0(0x16b)])===null||_0x470e7b===void 0x0?void 0x0:_0x470e7b[_0x1faed0(0x199)][_0x1faed0(0x19f)]['message']),common_1[_0x1faed0(0x185)][_0x1faed0(0x154)]);}}async['getUploadConfig'](_0x4ecc20){const _0x29b19e=_0x1ff6d8;if(_0x4ecc20===_0x29b19e(0x173)){const {aliOssRegion:_0x3a4274,aliOssBucket:_0x29e3a8,aliOssAccessKeyId:_0x4acd7a,aliOssAccessKeySecret:_0x209168,aliOssAcceleratedDomain:_0x38b84b}=await this['globalConfigService']['getConfigs']([_0x29b19e(0x19b),_0x29b19e(0x17f),'aliOssAccessKeyId',_0x29b19e(0x162),_0x29b19e(0x1ab)]);return{'region':_0x3a4274,'bucket':_0x29e3a8,'accessKeyId':_0x4acd7a,'accessKeySecret':_0x209168,'acceleratedDomain':_0x38b84b};}if(_0x4ecc20===_0x29b19e(0x175)){const {cosBucket:_0x446513,cosRegion:_0x4db76d,cosSecretId:_0xbab6a4,cosSecretKey:_0x54d311,tencentCosAcceleratedDomain:_0x31801d}=await this[_0x29b19e(0x146)][_0x29b19e(0x1c3)]([_0x29b19e(0x170),_0x29b19e(0x198),_0x29b19e(0x191),_0x29b19e(0x143),_0x29b19e(0x179)]);return{'Bucket':_0x446513,'Region':_0x4db76d,'SecretId':_0xbab6a4,'SecretKey':_0x54d311,'acceleratedDomain':_0x31801d};}if(_0x4ecc20===_0x29b19e(0x1b9)){const {cheveretoKey:_0x165f3c,cheveretoUploadPath:_0x4fd49d}=await this['globalConfigService'][_0x29b19e(0x1c3)]([_0x29b19e(0x1ba),_0x29b19e(0x1be)]);return{'key':_0x165f3c,'uploadPath':_0x4fd49d};}}async[_0x1ff6d8(0x172)](_0x4bc306){const _0x464ade=_0x1ff6d8,_0x2b6668=await axios_1['default'][_0x464ade(0x1a7)](_0x4bc306,{'responseType':_0x464ade(0x16e)}),_0x520a71=await new Promise((_0x13bcff,_0x1d5881)=>{streamToBuffer(_0x2b6668['data'],(_0x2ca456,_0x248a4f)=>{const _0x4ab7fb=_0x3d45;_0x2ca456?_0x1d5881(new common_1['HttpException']('获取图片资源失败，请重新试试吧！',common_1[_0x4ab7fb(0x185)][_0x4ab7fb(0x154)])):_0x13bcff(_0x248a4f);});}),_0x39b5a0=_0x2b6668['headers'][_0x464ade(0x197)];return{'buffer':_0x520a71,'mimeType':_0x39b5a0};}};UploadService=__decorate([(0x0,common_1[_0x1ff6d8(0x1a4)])(),__metadata(_0x1ff6d8(0x1a9),[globalConfig_service_1[_0x1ff6d8(0x13f)]])],UploadService),exports[_0x1ff6d8(0x188)]=UploadService;