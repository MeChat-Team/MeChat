'use strict';const _0x448faa=_0x40c7;(function(_0x5a1774,_0x3c46dc){const _0x334d28=_0x40c7,_0xed1c79=_0x5a1774();while(!![]){try{const _0x2ba2d1=parseInt(_0x334d28(0x1c2))/0x1+parseInt(_0x334d28(0x22e))/0x2+parseInt(_0x334d28(0x1da))/0x3+-parseInt(_0x334d28(0x239))/0x4+parseInt(_0x334d28(0x211))/0x5*(-parseInt(_0x334d28(0x1f4))/0x6)+parseInt(_0x334d28(0x201))/0x7*(-parseInt(_0x334d28(0x22c))/0x8)+parseInt(_0x334d28(0x1d1))/0x9;if(_0x2ba2d1===_0x3c46dc)break;else _0xed1c79['push'](_0xed1c79['shift']());}catch(_0x456601){_0xed1c79['push'](_0xed1c79['shift']());}}}(_0x50ca,0x45da1));function _0x40c7(_0x4f88d6,_0x4adb77){const _0x50ca26=_0x50ca();return _0x40c7=function(_0x40c785,_0x5b6ba2){_0x40c785=_0x40c785-0x1bb;let _0x184afb=_0x50ca26[_0x40c785];return _0x184afb;},_0x40c7(_0x4f88d6,_0x4adb77);}var __decorate=this&&this[_0x448faa(0x1bd)]||function(_0x3e927f,_0x123938,_0x572c63,_0x1dae48){const _0xdf02b9=_0x448faa;var _0xf835ef=arguments[_0xdf02b9(0x202)],_0xb5e1ba=_0xf835ef<0x3?_0x123938:_0x1dae48===null?_0x1dae48=Object['getOwnPropertyDescriptor'](_0x123938,_0x572c63):_0x1dae48,_0x48b374;if(typeof Reflect===_0xdf02b9(0x1fb)&&typeof Reflect['decorate']==='function')_0xb5e1ba=Reflect['decorate'](_0x3e927f,_0x123938,_0x572c63,_0x1dae48);else{for(var _0x5789ac=_0x3e927f[_0xdf02b9(0x202)]-0x1;_0x5789ac>=0x0;_0x5789ac--)if(_0x48b374=_0x3e927f[_0x5789ac])_0xb5e1ba=(_0xf835ef<0x3?_0x48b374(_0xb5e1ba):_0xf835ef>0x3?_0x48b374(_0x123938,_0x572c63,_0xb5e1ba):_0x48b374(_0x123938,_0x572c63))||_0xb5e1ba;}return _0xf835ef>0x3&&_0xb5e1ba&&Object['defineProperty'](_0x123938,_0x572c63,_0xb5e1ba),_0xb5e1ba;},__metadata=this&&this[_0x448faa(0x1c5)]||function(_0x3748e5,_0x1b3e22){const _0x5586d8=_0x448faa;if(typeof Reflect===_0x5586d8(0x1fb)&&typeof Reflect['metadata']===_0x5586d8(0x1db))return Reflect['metadata'](_0x3748e5,_0x1b3e22);};function _0x50ca(){const _0x1f9123=['上传图片失败[ali]','path','ali','put','ISDEV','default','getUploadConfig','uploadFile','log','substring','5394078ARbaRL','putObject','文件已上传到\x20Chevereto。访问\x20URL:\x20','join','php','uploadFileByChevereto','TRUE','文件已上传到本地存储。访问\x20URL:\x20','stringify','480090QBIjeP','function','globalConfigService','file/','title','获取图片资源失败，请重新试试吧！','aliOssStatus','GlobalConfigService','当前已开启全球加速----------------->','tencent','aliOssBucket','slice','file','error','chevereto','../globalConfig/globalConfig.service','上传图片失败[ten]','cheveretoKey','uploadFileByAliOss','getUploadType','创建目录失败:\x20','dev/','get','uploadFileByTencentCos','../../common/utils','cosBucket','12dxPMry','formatUrl','aliOssAccessKeySecret','ali-oss','HttpStatus','endsWith','上传配置状态\x20-\x20腾讯云:本地存储:\x20','object','STANDARD','tencentCosStatus','Injectable','code','replace','231jWFvwN','length','HttpException','catch','writeFile','getBufferFromUrl','使用腾讯云\x20COS\x20上传文件','response','acceleratedDomain','mime-types','random','上传图片失败[Chevereto|buffer]\x20-->\x20','cosRegion','others','base64','siteUrl','1121585yADDVp','includes','tencentCosAcceleratedDomain','UploadService','aliOssRegion','env','cos\x20->\x20err:\x20','使用本地存储上传文件','上传图片失败[Chevereto]','defineProperty','data','uploadFileToLocal','无法识别文件类型，请检查文件','https://$2','Location','请先前往后台配置上传图片的方式','toString','design:paramtypes','文件已上传到腾讯云\x20COS。访问\x20URL:\x20','key','getConfigs','normalize','不允许上传此类型的文件','上传失败:\x20','basename','error:\x20','removeSpecialCharacters','124216YlXKDa','headers','830472fEyarY','使用\x20Chevereto\x20上传文件','message','https://','cos-nodejs-sdk-v5','@nestjs/common','exe','cosSecretId','source','extension','__esModule','620420NWBDRA','Logger','BAD_REQUEST','cheveretoUploadPath','__decorate','tencentCos','ali\x20开始上传','append','promises','227635xfiVFL','public','url','__metadata','未配置任何上传方式'];_0x50ca=function(){return _0x1f9123;};return _0x50ca();}Object[_0x448faa(0x21a)](exports,_0x448faa(0x238),{'value':!![]}),exports['UploadService']=void 0x0;const utils_1=require(_0x448faa(0x1f2)),common_1=require(_0x448faa(0x233)),ALIOSS=require(_0x448faa(0x1f7)),axios_1=require('axios'),TENCENTCOS=require(_0x448faa(0x232)),FormData=require('form-data'),fs_1=require('fs'),mime=require(_0x448faa(0x20a)),path=require(_0x448faa(0x1c8)),streamToBuffer=require('stream-to-buffer'),globalConfig_service_1=require(_0x448faa(0x1e9)),blacklist=[_0x448faa(0x234),'sh','bat','js',_0x448faa(0x1d5),'py'];let UploadService=class UploadService{constructor(_0x523a07){const _0xbfeaf9=_0x448faa;this[_0xbfeaf9(0x1dc)]=_0x523a07;}['onModuleInit'](){}async[_0x448faa(0x1ce)](_0x2dc562,_0x18f7df=_0x448faa(0x20e)){const _0x415300=_0x448faa,{buffer:_0x4e5981,mimetype:_0x45e876}=_0x2dc562;process[_0x415300(0x216)][_0x415300(0x1cb)]==='TRUE'&&(_0x18f7df=_0x415300(0x1ef)+_0x18f7df);const _0x364306=mime[_0x415300(0x237)](_0x45e876)||'';!_0x364306&&common_1['Logger'][_0x415300(0x1e7)](_0x415300(0x21d),_0x415300(0x214));if(blacklist[_0x415300(0x212)](_0x364306['toLowerCase']())){common_1[_0x415300(0x23a)][_0x415300(0x1e7)]('不允许上传此类型的文件','UploadService');throw new Error(_0x415300(0x227));}const _0x51655a=new Date(),_0x20ea5e=_0x51655a['getTime'](),_0x3e0948=Math[_0x415300(0x20b)]()['toString'](0x24)[_0x415300(0x1d0)](0x2,0x6),_0x55d39a=_0x20ea5e+'_'+_0x3e0948+'.'+_0x364306,{tencentCosStatus:tencentCosStatus=0x0,aliOssStatus:aliOssStatus=0x0,cheveretoStatus:cheveretoStatus=0x0,localStorageStatus:localStorageStatus=0x0}=await this[_0x415300(0x1dc)]['getConfigs']([_0x415300(0x1fd),_0x415300(0x1e0),'cheveretoStatus','localStorageStatus']);common_1[_0x415300(0x23a)]['log'](_0x415300(0x1fa)+localStorageStatus+',\x20'+tencentCosStatus+',\x20阿里云:\x20'+aliOssStatus+',\x20Chevereto:\x20'+cheveretoStatus,_0x415300(0x214));if(!Number(tencentCosStatus)&&!Number(aliOssStatus)&&!Number(cheveretoStatus)&&!Number(localStorageStatus)){common_1[_0x415300(0x23a)][_0x415300(0x1e7)](_0x415300(0x1c6),_0x415300(0x214));throw new common_1['HttpException'](_0x415300(0x220),common_1['HttpStatus'][_0x415300(0x1bb)]);}try{if(Number(localStorageStatus)){common_1[_0x415300(0x23a)][_0x415300(0x1cf)](_0x415300(0x218),_0x415300(0x214));const _0x2c17b6=await this[_0x415300(0x21c)]({'filename':_0x55d39a,'buffer':_0x4e5981,'dir':_0x18f7df});return common_1[_0x415300(0x23a)][_0x415300(0x1cf)](_0x415300(0x1d8)+_0x2c17b6,'UploadService'),_0x2c17b6;}if(Number(tencentCosStatus)){common_1[_0x415300(0x23a)]['log'](_0x415300(0x207),_0x415300(0x214));const _0x39ead5=await this['uploadFileByTencentCos']({'filename':_0x55d39a,'buffer':_0x4e5981,'dir':_0x18f7df});return common_1[_0x415300(0x23a)][_0x415300(0x1cf)](_0x415300(0x223)+_0x39ead5,'UploadService'),_0x39ead5;}if(Number(aliOssStatus)){common_1[_0x415300(0x23a)][_0x415300(0x1cf)]('使用阿里云\x20OSS\x20上传文件',_0x415300(0x214));const _0x3b1433=await this[_0x415300(0x1ec)]({'filename':_0x55d39a,'buffer':_0x4e5981,'dir':_0x18f7df});return common_1[_0x415300(0x23a)][_0x415300(0x1cf)]('文件已上传到阿里云\x20OSS。访问\x20URL:\x20'+_0x3b1433,_0x415300(0x214)),_0x3b1433;}if(Number(cheveretoStatus)){common_1[_0x415300(0x23a)][_0x415300(0x1cf)](_0x415300(0x22f),_0x415300(0x214));const _0x11a124=await this['uploadFileByChevereto']({'filename':_0x55d39a,'buffer':_0x4e5981['toString'](_0x415300(0x20f))});return common_1[_0x415300(0x23a)][_0x415300(0x1cf)](_0x415300(0x1d3)+_0x11a124,_0x415300(0x214)),_0x11a124;}}catch(_0x5f2999){common_1[_0x415300(0x23a)][_0x415300(0x1e7)](_0x415300(0x228)+_0x5f2999[_0x415300(0x230)],_0x415300(0x214));throw _0x5f2999;}}async[_0x448faa(0x1ed)](){const _0x589bc4=_0x448faa,{tencentCosStatus:tencentCosStatus=0x0,aliOssStatus:aliOssStatus=0x0,cheveretoStatus:cheveretoStatus=0x0}=await this[_0x589bc4(0x1dc)][_0x589bc4(0x225)](['tencentCosStatus','aliOssStatus','cheveretoStatus']);if(Number(tencentCosStatus))return _0x589bc4(0x1e3);if(Number(aliOssStatus))return _0x589bc4(0x1c9);if(Number(cheveretoStatus))return _0x589bc4(0x1e8);}async['uploadFileFromUrl']({url:_0xdf6804,dir:dir=_0x448faa(0x20e)}){const _0x390db9=_0x448faa;process[_0x390db9(0x216)][_0x390db9(0x1cb)]===_0x390db9(0x1d7)&&(dir=_0x390db9(0x1ef)+dir);const {buffer:_0x1ddb44,mimeType:_0x417bf4}=await this[_0x390db9(0x206)](_0xdf6804);return await this['uploadFile']({'buffer':_0x1ddb44,'mimetype':_0x417bf4},dir);}async[_0x448faa(0x1f1)]({filename:_0x487a58,buffer:_0x5a9a7f,dir:_0x1c6873}){const _0x438604=_0x448faa,{Bucket:_0x36c17b,Region:_0x11b1e9,SecretId:_0x1adb36,SecretKey:_0x3ac57b}=await this[_0x438604(0x1cd)](_0x438604(0x1e3));this[_0x438604(0x1be)]=new TENCENTCOS({'SecretId':_0x1adb36,'SecretKey':_0x3ac57b,'FileParallelLimit':0xa});try{return new Promise(async(_0x77c691,_0xfa129a)=>{const _0x56b341=_0x438604;this[_0x56b341(0x1be)][_0x56b341(0x1d2)]({'Bucket':(0x0,utils_1[_0x56b341(0x22b)])(_0x36c17b),'Region':(0x0,utils_1['removeSpecialCharacters'])(_0x11b1e9),'Key':_0x1c6873+'/'+_0x487a58,'StorageClass':_0x56b341(0x1fc),'Body':_0x5a9a7f},async(_0x58afc1,_0x594349)=>{const _0x619d8c=_0x56b341;if(_0x58afc1)return console[_0x619d8c(0x1cf)](_0x619d8c(0x217),_0x58afc1),_0xfa129a(_0x58afc1);let _0x16ac22=_0x594349[_0x619d8c(0x21f)]['replace'](/^(http:\/\/|https:\/\/|\/\/|)(.*)/,_0x619d8c(0x21e));const {acceleratedDomain:_0x4b8a6d}=await this['getUploadConfig']('tencent');return _0x4b8a6d&&(_0x16ac22=_0x16ac22[_0x619d8c(0x200)](/^(https:\/\/[^/]+)(\/.*)$/,_0x619d8c(0x231)+_0x4b8a6d+'$2'),console[_0x619d8c(0x1cf)]('当前已开启全球加速----------------->',_0x16ac22)),_0x77c691(_0x16ac22);});});}catch(_0x5713fd){console[_0x438604(0x1cf)](_0x438604(0x22a),_0x5713fd);throw new common_1[(_0x438604(0x203))](_0x438604(0x1ea),common_1[_0x438604(0x1f8)][_0x438604(0x1bb)]);}}async['uploadFileByAliOss']({filename:_0x6f4753,buffer:_0x907783,dir:_0x45c154}){const _0x1a5a82=_0x448faa,{region:_0x25e529,bucket:_0x3e99bc,accessKeyId:_0x119ff5,accessKeySecret:_0x27d890}=await this['getUploadConfig'](_0x1a5a82(0x1c9)),_0x296fdd=new ALIOSS({'region':(0x0,utils_1[_0x1a5a82(0x22b)])(_0x25e529),'accessKeyId':_0x119ff5,'accessKeySecret':_0x27d890,'bucket':(0x0,utils_1[_0x1a5a82(0x22b)])(_0x3e99bc)});try{return console[_0x1a5a82(0x1cf)](_0x1a5a82(0x1bf)),new Promise((_0x5abad7,_0x1f880e)=>{const _0xfe4353=_0x1a5a82;_0x296fdd[_0xfe4353(0x1ca)](_0x45c154+'/'+_0x6f4753,_0x907783)['then'](async _0x252f19=>{const _0x17c813=_0xfe4353,{acceleratedDomain:_0x3d9a03}=await this[_0x17c813(0x1cd)]('ali');_0x3d9a03&&(_0x252f19[_0x17c813(0x1c4)]=_0x252f19[_0x17c813(0x1c4)]['replace'](/^(https:\/\/[^/]+)(\/.*)$/,_0x17c813(0x231)+_0x3d9a03+'$2'),console[_0x17c813(0x1cf)](_0x17c813(0x1e2),_0x252f19[_0x17c813(0x1c4)])),_0x5abad7(_0x252f19[_0x17c813(0x1c4)]);})[_0xfe4353(0x204)](_0x5353c4=>{_0x1f880e(_0x5353c4);});});}catch(_0x4c36e4){throw new common_1['HttpException'](_0x1a5a82(0x1c7),common_1[_0x1a5a82(0x1f8)][_0x1a5a82(0x1bb)]);}}async[_0x448faa(0x21c)]({filename:_0x5c258b,buffer:_0x3f98b5,dir:dir=_0x448faa(0x20e)}){const _0x3a63c7=_0x448faa,_0x544aff=path[_0x3a63c7(0x226)](dir)[_0x3a63c7(0x200)](/^(\.\.(\/|\\|$))+/,''),_0x4c7cf7=path[_0x3a63c7(0x229)](_0x5c258b),_0x12597f=process['cwd'](),_0x18780e=path['join'](_0x12597f,_0x3a63c7(0x1c3),'file',_0x544aff),_0x4d48af=path[_0x3a63c7(0x1d4)](_0x18780e,_0x4c7cf7);if(!_0x4d48af['startsWith'](path['join'](_0x12597f,_0x3a63c7(0x1c3),_0x3a63c7(0x1e6))))throw new Error('非法路径，禁止访问目录之外的位置');try{await fs_1[_0x3a63c7(0x1c1)]['mkdir'](_0x18780e,{'recursive':!![]});}catch(_0x4074e1){common_1[_0x3a63c7(0x23a)][_0x3a63c7(0x1e7)](_0x3a63c7(0x1ee)+_0x18780e,_0x4074e1);throw _0x4074e1;}try{await fs_1[_0x3a63c7(0x1c1)][_0x3a63c7(0x205)](_0x4d48af,_0x3f98b5,{'mode':0x124});}catch(_0x377884){common_1[_0x3a63c7(0x23a)][_0x3a63c7(0x1e7)]('文件保存失败:\x20'+_0x4d48af,_0x377884);throw _0x377884;}let _0x1b171a=_0x3a63c7(0x1dd)+_0x544aff+'/'+_0x4c7cf7;const _0x282946=await this['globalConfigService'][_0x3a63c7(0x225)]([_0x3a63c7(0x210)]);if(_0x282946){const _0x247197=(0x0,utils_1[_0x3a63c7(0x1f5)])(_0x282946);_0x1b171a=_0x247197+'/'+_0x1b171a;}return _0x1b171a;}async[_0x448faa(0x1d6)]({filename:filename='',buffer:_0x2a9283}){const _0xcf42c9=_0x448faa;var _0x17f0b9;const {key:_0x2246e9,uploadPath:_0x2defdc}=await this[_0xcf42c9(0x1cd)]('chevereto');let _0x56f54a=_0x2defdc[_0xcf42c9(0x1f9)]('/')?_0x2defdc[_0xcf42c9(0x1e5)](0x0,-0x1):_0x2defdc;const _0x4d80d7=new FormData(),_0x1a31c5=_0x2a9283[_0xcf42c9(0x221)](_0xcf42c9(0x20f));_0x4d80d7[_0xcf42c9(0x1c0)](_0xcf42c9(0x236),_0x1a31c5),_0x4d80d7[_0xcf42c9(0x1c0)](_0xcf42c9(0x224),_0x2246e9),_0x4d80d7['append'](_0xcf42c9(0x1de),filename);try{const _0x5e7d9f=await axios_1[_0xcf42c9(0x1cc)]['post'](_0x56f54a,_0x4d80d7,{'headers':{'X-API-Key':_0x2246e9}});if((_0x5e7d9f===null||_0x5e7d9f===void 0x0?void 0x0:_0x5e7d9f['status'])===0xc8)return _0x5e7d9f['data']['image'][_0xcf42c9(0x1c4)];else console[_0xcf42c9(0x1cf)]('Chevereto\x20--->\x20res',_0x5e7d9f===null||_0x5e7d9f===void 0x0?void 0x0:_0x5e7d9f[_0xcf42c9(0x21b)][_0xcf42c9(0x1ff)],_0x5e7d9f===null||_0x5e7d9f===void 0x0?void 0x0:_0x5e7d9f[_0xcf42c9(0x21b)]['error']['message']),common_1[_0xcf42c9(0x23a)][_0xcf42c9(0x1e7)](_0xcf42c9(0x219),JSON[_0xcf42c9(0x1d9)](_0x5e7d9f[_0xcf42c9(0x21b)]));}catch(_0x3a83e3){console[_0xcf42c9(0x1cf)](_0xcf42c9(0x22a),_0x3a83e3);throw new common_1[(_0xcf42c9(0x203))](_0xcf42c9(0x20c)+((_0x17f0b9=_0x3a83e3[_0xcf42c9(0x208)])===null||_0x17f0b9===void 0x0?void 0x0:_0x17f0b9[_0xcf42c9(0x21b)][_0xcf42c9(0x1e7)]['message']),common_1[_0xcf42c9(0x1f8)][_0xcf42c9(0x1bb)]);}}async[_0x448faa(0x1cd)](_0x395f5){const _0x7d3c44=_0x448faa;if(_0x395f5===_0x7d3c44(0x1c9)){const {aliOssRegion:_0x1c0f6a,aliOssBucket:_0x261b05,aliOssAccessKeyId:_0x176766,aliOssAccessKeySecret:_0xc4fb92,aliOssAcceleratedDomain:_0x386c7b}=await this[_0x7d3c44(0x1dc)]['getConfigs']([_0x7d3c44(0x215),_0x7d3c44(0x1e4),'aliOssAccessKeyId',_0x7d3c44(0x1f6),_0x7d3c44(0x209)]);return{'region':_0x1c0f6a,'bucket':_0x261b05,'accessKeyId':_0x176766,'accessKeySecret':_0xc4fb92,'acceleratedDomain':_0x386c7b};}if(_0x395f5==='tencent'){const {cosBucket:_0x3e724f,cosRegion:_0x56de53,cosSecretId:_0x5a4c51,cosSecretKey:_0x356c55,tencentCosAcceleratedDomain:_0x6bd3a0}=await this[_0x7d3c44(0x1dc)][_0x7d3c44(0x225)]([_0x7d3c44(0x1f3),_0x7d3c44(0x20d),_0x7d3c44(0x235),'cosSecretKey',_0x7d3c44(0x213)]);return{'Bucket':_0x3e724f,'Region':_0x56de53,'SecretId':_0x5a4c51,'SecretKey':_0x356c55,'acceleratedDomain':_0x6bd3a0};}if(_0x395f5===_0x7d3c44(0x1e8)){const {cheveretoKey:_0x338a5e,cheveretoUploadPath:_0x14a0cc}=await this[_0x7d3c44(0x1dc)][_0x7d3c44(0x225)]([_0x7d3c44(0x1eb),_0x7d3c44(0x1bc)]);return{'key':_0x338a5e,'uploadPath':_0x14a0cc};}}async[_0x448faa(0x206)](_0x9832c7){const _0x347190=_0x448faa,_0xf0e7b6=await axios_1['default'][_0x347190(0x1f0)](_0x9832c7,{'responseType':'stream'}),_0x558886=await new Promise((_0x1858b4,_0x203621)=>{streamToBuffer(_0xf0e7b6['data'],(_0x441ddd,_0x2fcdec)=>{const _0x443a15=_0x40c7;_0x441ddd?_0x203621(new common_1[(_0x443a15(0x203))](_0x443a15(0x1df),common_1[_0x443a15(0x1f8)]['BAD_REQUEST'])):_0x1858b4(_0x2fcdec);});}),_0x303e16=_0xf0e7b6[_0x347190(0x22d)]['content-type'];return{'buffer':_0x558886,'mimeType':_0x303e16};}};UploadService=__decorate([(0x0,common_1[_0x448faa(0x1fe)])(),__metadata(_0x448faa(0x222),[globalConfig_service_1[_0x448faa(0x1e1)]])],UploadService),exports['UploadService']=UploadService;