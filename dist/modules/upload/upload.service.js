'use strict';function _0x19fb(){const _0x1f9db4=['normalize','tencentCos','headers','文件保存失败:\x20','aliOssAccessKeySecret','length','toLowerCase','tencent','acceleratedDomain','TRUE','error','cheveretoUploadPath','post','上传图片失败[Chevereto|buffer]\x20-->\x20','文件已上传到阿里云\x20OSS。访问\x20URL:\x20','form-data','basename','文件已上传到本地存储。访问\x20URL:\x20','tencentCosAcceleratedDomain','random','687395cyJKsN','php','getUploadConfig','substring','others','uploadFileByTencentCos','object','log',',\x20阿里云:\x20','__metadata','cosRegion','使用阿里云\x20OSS\x20上传文件','3864680YJZckN','replace','@nestjs/common','decorate',',\x20Chevereto:\x20','上传图片失败[ali]','catch','content-type','使用本地存储上传文件','putObject','cos-nodejs-sdk-v5','then','formatUrl','__decorate','mime-types','STANDARD','exe','文件已上传到腾讯云\x20COS。访问\x20URL:\x20','cwd','cheveretoStatus','uploadFileToLocal','uploadFileByAliOss','endsWith','上传配置状态\x20-\x20腾讯云:本地存储:\x20','HttpStatus','5DfrTrG','GlobalConfigService','创建目录失败:\x20','../globalConfig/globalConfig.service','__esModule','无法识别文件类型，请检查文件','message','使用腾讯云\x20COS\x20上传文件','function','18rKdPnF','非法路径，禁止访问目录之外的位置','不允许上传此类型的文件','title','base64','Logger','BAD_REQUEST','获取图片资源失败，请重新试试吧！','ISDEV','Chevereto\x20--->\x20res','tencentCosStatus','getUploadType','82844gWZMTk','url','744472sWcyAA','get','https://','4571hsKfRw','design:paramtypes','https://$2','getConfigs','getTime','aliOssStatus','bat','put','file','response','uploadFile','getOwnPropertyDescriptor','default','chevereto','join','1099827HPeZOS','HttpException','defineProperty','uploadFileFromUrl','path','metadata','error:\x20','siteUrl','aliOssBucket','writeFile','上传失败:\x20','cos\x20->\x20err:\x20','ali','getBufferFromUrl','1772536sFqFvD','上传图片失败[ten]','promises','data','status','dev/','includes','mkdir','cosSecretId','image','append','cheveretoKey','startsWith','globalConfigService','aliOssRegion','removeSpecialCharacters','axios','上传图片失败[Chevereto]','uploadFileByChevereto','toString','4098BaHOsS','key','UploadService','ali-oss','code'];_0x19fb=function(){return _0x1f9db4;};return _0x19fb();}const _0x2b587b=_0xe4c3;(function(_0x403226,_0x4f8901){const _0x53bbbd=_0xe4c3,_0x3366de=_0x403226();while(!![]){try{const _0x2da2d1=-parseInt(_0x53bbbd(0x11d))/0x1+-parseInt(_0x53bbbd(0xce))/0x2+-parseInt(_0x53bbbd(0xe2))/0x3+parseInt(_0x53bbbd(0xd0))/0x4*(parseInt(_0x53bbbd(0xb9))/0x5)+-parseInt(_0x53bbbd(0x104))/0x6*(-parseInt(_0x53bbbd(0xd3))/0x7)+parseInt(_0x53bbbd(0xf0))/0x8*(parseInt(_0x53bbbd(0xc2))/0x9)+parseInt(_0x53bbbd(0xa0))/0xa;if(_0x2da2d1===_0x4f8901)break;else _0x3366de['push'](_0x3366de['shift']());}catch(_0x2f34c5){_0x3366de['push'](_0x3366de['shift']());}}}(_0x19fb,0x596d5));var __decorate=this&&this[_0x2b587b(0xad)]||function(_0xb3af60,_0x5beba1,_0x147c8e,_0x5a479e){const _0x182972=_0x2b587b;var _0x8d21ac=arguments[_0x182972(0x10e)],_0xb0af81=_0x8d21ac<0x3?_0x5beba1:_0x5a479e===null?_0x5a479e=Object[_0x182972(0xde)](_0x5beba1,_0x147c8e):_0x5a479e,_0x1b1fb0;if(typeof Reflect==='object'&&typeof Reflect[_0x182972(0xa3)]===_0x182972(0xc1))_0xb0af81=Reflect[_0x182972(0xa3)](_0xb3af60,_0x5beba1,_0x147c8e,_0x5a479e);else{for(var _0x58d855=_0xb3af60['length']-0x1;_0x58d855>=0x0;_0x58d855--)if(_0x1b1fb0=_0xb3af60[_0x58d855])_0xb0af81=(_0x8d21ac<0x3?_0x1b1fb0(_0xb0af81):_0x8d21ac>0x3?_0x1b1fb0(_0x5beba1,_0x147c8e,_0xb0af81):_0x1b1fb0(_0x5beba1,_0x147c8e))||_0xb0af81;}return _0x8d21ac>0x3&&_0xb0af81&&Object[_0x182972(0xe4)](_0x5beba1,_0x147c8e,_0xb0af81),_0xb0af81;},__metadata=this&&this[_0x2b587b(0x9d)]||function(_0x436085,_0x53164c){const _0x146c96=_0x2b587b;if(typeof Reflect===_0x146c96(0x9a)&&typeof Reflect['metadata']==='function')return Reflect[_0x146c96(0xe7)](_0x436085,_0x53164c);};Object['defineProperty'](exports,_0x2b587b(0xbd),{'value':!![]}),exports[_0x2b587b(0x106)]=void 0x0;const utils_1=require('../../common/utils'),common_1=require(_0x2b587b(0xa2)),ALIOSS=require(_0x2b587b(0x107)),axios_1=require(_0x2b587b(0x100)),TENCENTCOS=require(_0x2b587b(0xaa)),FormData=require(_0x2b587b(0x118)),fs_1=require('fs'),mime=require(_0x2b587b(0xae)),path=require(_0x2b587b(0xe6)),streamToBuffer=require('stream-to-buffer'),globalConfig_service_1=require(_0x2b587b(0xbc)),blacklist=[_0x2b587b(0xb0),'sh',_0x2b587b(0xd9),'js',_0x2b587b(0x11e),'py'];let UploadService=class UploadService{constructor(_0x384ebc){const _0x911eb7=_0x2b587b;this[_0x911eb7(0xfd)]=_0x384ebc;}['onModuleInit'](){}async[_0x2b587b(0xdd)](_0x885812,_0x492e34='others'){const _0x399f5e=_0x2b587b,{buffer:_0x2b04de,mimetype:_0x64dbf3}=_0x885812;process['env'][_0x399f5e(0xca)]==='TRUE'&&(_0x492e34=_0x399f5e(0xf5)+_0x492e34);const _0x47e76b=mime['extension'](_0x64dbf3)||'';!_0x47e76b&&common_1[_0x399f5e(0xc7)]['error'](_0x399f5e(0xbe),'UploadService');if(blacklist[_0x399f5e(0xf6)](_0x47e76b[_0x399f5e(0x10f)]())){common_1[_0x399f5e(0xc7)][_0x399f5e(0x113)](_0x399f5e(0xc4),_0x399f5e(0x106));throw new Error(_0x399f5e(0xc4));}const _0x4d2c44=new Date(),_0xaf532=_0x4d2c44[_0x399f5e(0xd7)](),_0x4a24b9=Math[_0x399f5e(0x11c)]()['toString'](0x24)[_0x399f5e(0x97)](0x2,0x6),_0x3f64bb=_0xaf532+'_'+_0x4a24b9+'.'+_0x47e76b,{tencentCosStatus:tencentCosStatus=0x0,aliOssStatus:aliOssStatus=0x0,cheveretoStatus:cheveretoStatus=0x0,localStorageStatus:localStorageStatus=0x0}=await this[_0x399f5e(0xfd)][_0x399f5e(0xd6)]([_0x399f5e(0xcc),_0x399f5e(0xd8),_0x399f5e(0xb3),'localStorageStatus']);common_1[_0x399f5e(0xc7)][_0x399f5e(0x9b)](_0x399f5e(0xb7)+localStorageStatus+',\x20'+tencentCosStatus+_0x399f5e(0x9c)+aliOssStatus+_0x399f5e(0xa4)+cheveretoStatus,_0x399f5e(0x106));if(!Number(tencentCosStatus)&&!Number(aliOssStatus)&&!Number(cheveretoStatus)&&!Number(localStorageStatus)){common_1[_0x399f5e(0xc7)][_0x399f5e(0x113)]('未配置任何上传方式',_0x399f5e(0x106));throw new common_1[(_0x399f5e(0xe3))]('请先前往后台配置上传图片的方式',common_1[_0x399f5e(0xb8)][_0x399f5e(0xc8)]);}try{if(Number(localStorageStatus)){common_1[_0x399f5e(0xc7)]['log'](_0x399f5e(0xa8),'UploadService');const _0x392654=await this[_0x399f5e(0xb4)]({'filename':_0x3f64bb,'buffer':_0x2b04de,'dir':_0x492e34});return common_1[_0x399f5e(0xc7)][_0x399f5e(0x9b)](_0x399f5e(0x11a)+_0x392654,_0x399f5e(0x106)),_0x392654;}if(Number(tencentCosStatus)){common_1[_0x399f5e(0xc7)][_0x399f5e(0x9b)](_0x399f5e(0xc0),_0x399f5e(0x106));const _0x176bf9=await this[_0x399f5e(0x99)]({'filename':_0x3f64bb,'buffer':_0x2b04de,'dir':_0x492e34});return common_1[_0x399f5e(0xc7)][_0x399f5e(0x9b)](_0x399f5e(0xb1)+_0x176bf9,'UploadService'),_0x176bf9;}if(Number(aliOssStatus)){common_1[_0x399f5e(0xc7)][_0x399f5e(0x9b)](_0x399f5e(0x9f),_0x399f5e(0x106));const _0x341701=await this['uploadFileByAliOss']({'filename':_0x3f64bb,'buffer':_0x2b04de,'dir':_0x492e34});return common_1[_0x399f5e(0xc7)][_0x399f5e(0x9b)](_0x399f5e(0x117)+_0x341701,'UploadService'),_0x341701;}if(Number(cheveretoStatus)){common_1['Logger'][_0x399f5e(0x9b)]('使用\x20Chevereto\x20上传文件',_0x399f5e(0x106));const _0xfedf04=await this[_0x399f5e(0x102)]({'filename':_0x3f64bb,'buffer':_0x2b04de[_0x399f5e(0x103)]('base64')});return common_1[_0x399f5e(0xc7)][_0x399f5e(0x9b)]('文件已上传到\x20Chevereto。访问\x20URL:\x20'+_0xfedf04,_0x399f5e(0x106)),_0xfedf04;}}catch(_0x26e1e5){common_1[_0x399f5e(0xc7)][_0x399f5e(0x113)](_0x399f5e(0xec)+_0x26e1e5[_0x399f5e(0xbf)],_0x399f5e(0x106));throw _0x26e1e5;}}async[_0x2b587b(0xcd)](){const _0x5ecaf9=_0x2b587b,{tencentCosStatus:tencentCosStatus=0x0,aliOssStatus:aliOssStatus=0x0,cheveretoStatus:cheveretoStatus=0x0}=await this[_0x5ecaf9(0xfd)][_0x5ecaf9(0xd6)](['tencentCosStatus','aliOssStatus','cheveretoStatus']);if(Number(tencentCosStatus))return'tencent';if(Number(aliOssStatus))return _0x5ecaf9(0xee);if(Number(cheveretoStatus))return _0x5ecaf9(0xe0);}async[_0x2b587b(0xe5)]({url:_0x5be832,dir:dir=_0x2b587b(0x98)}){const _0x2ac02a=_0x2b587b;process['env'][_0x2ac02a(0xca)]===_0x2ac02a(0x112)&&(dir=_0x2ac02a(0xf5)+dir);const {buffer:_0x2f4fb2,mimeType:_0x2d0fbe}=await this[_0x2ac02a(0xef)](_0x5be832);return await this['uploadFile']({'buffer':_0x2f4fb2,'mimetype':_0x2d0fbe},dir);}async[_0x2b587b(0x99)]({filename:_0xed2d0b,buffer:_0x411dc8,dir:_0x346c4a}){const _0x131731=_0x2b587b,{Bucket:_0x42cb8f,Region:_0x49f2f9,SecretId:_0x5a54c1,SecretKey:_0xc567c7}=await this['getUploadConfig'](_0x131731(0x110));this[_0x131731(0x10a)]=new TENCENTCOS({'SecretId':_0x5a54c1,'SecretKey':_0xc567c7,'FileParallelLimit':0xa});try{return new Promise(async(_0x1041aa,_0x253bb6)=>{const _0x12abaa=_0x131731;this[_0x12abaa(0x10a)][_0x12abaa(0xa9)]({'Bucket':(0x0,utils_1['removeSpecialCharacters'])(_0x42cb8f),'Region':(0x0,utils_1['removeSpecialCharacters'])(_0x49f2f9),'Key':_0x346c4a+'/'+_0xed2d0b,'StorageClass':_0x12abaa(0xaf),'Body':_0x411dc8},async(_0x28ff93,_0x33d8d0)=>{const _0x594ce=_0x12abaa;if(_0x28ff93)return console['log'](_0x594ce(0xed),_0x28ff93),_0x253bb6(_0x28ff93);let _0x26d4a2=_0x33d8d0['Location'][_0x594ce(0xa1)](/^(http:\/\/|https:\/\/|\/\/|)(.*)/,_0x594ce(0xd5));const {acceleratedDomain:_0x265211}=await this[_0x594ce(0x11f)](_0x594ce(0x110));return _0x265211&&(_0x26d4a2=_0x26d4a2[_0x594ce(0xa1)](/^(https:\/\/[^/]+)(\/.*)$/,'https://'+_0x265211+'$2'),console[_0x594ce(0x9b)]('当前已开启全球加速----------------->',_0x26d4a2)),_0x1041aa(_0x26d4a2);});});}catch(_0x2a1980){console[_0x131731(0x9b)](_0x131731(0xe8),_0x2a1980);throw new common_1[(_0x131731(0xe3))](_0x131731(0xf1),common_1[_0x131731(0xb8)][_0x131731(0xc8)]);}}async[_0x2b587b(0xb5)]({filename:_0x5d546e,buffer:_0x5837f6,dir:_0xdaca9e}){const _0x3340ea=_0x2b587b,{region:_0x5232eb,bucket:_0x4c3167,accessKeyId:_0x305598,accessKeySecret:_0x463ab4}=await this[_0x3340ea(0x11f)](_0x3340ea(0xee)),_0x52217b=new ALIOSS({'region':(0x0,utils_1[_0x3340ea(0xff)])(_0x5232eb),'accessKeyId':_0x305598,'accessKeySecret':_0x463ab4,'bucket':(0x0,utils_1[_0x3340ea(0xff)])(_0x4c3167)});try{return console[_0x3340ea(0x9b)]('ali\x20开始上传'),new Promise((_0x2e5760,_0x44b98f)=>{const _0x6a9787=_0x3340ea;_0x52217b[_0x6a9787(0xda)](_0xdaca9e+'/'+_0x5d546e,_0x5837f6)[_0x6a9787(0xab)](async _0x29b2cf=>{const _0x43d100=_0x6a9787,{acceleratedDomain:_0x4f1aa6}=await this[_0x43d100(0x11f)](_0x43d100(0xee));_0x4f1aa6&&(_0x29b2cf[_0x43d100(0xcf)]=_0x29b2cf[_0x43d100(0xcf)][_0x43d100(0xa1)](/^(https:\/\/[^/]+)(\/.*)$/,_0x43d100(0xd2)+_0x4f1aa6+'$2'),console[_0x43d100(0x9b)]('当前已开启全球加速----------------->',_0x29b2cf[_0x43d100(0xcf)])),_0x2e5760(_0x29b2cf[_0x43d100(0xcf)]);})[_0x6a9787(0xa6)](_0x347b23=>{_0x44b98f(_0x347b23);});});}catch(_0x5d25fd){throw new common_1[(_0x3340ea(0xe3))](_0x3340ea(0xa5),common_1[_0x3340ea(0xb8)]['BAD_REQUEST']);}}async[_0x2b587b(0xb4)]({filename:_0x31412c,buffer:_0x5deedc,dir:dir='others'}){const _0x4f0183=_0x2b587b,_0x3851d6=path[_0x4f0183(0x109)](dir)[_0x4f0183(0xa1)](/^(\.\.(\/|\\|$))+/,''),_0x12b348=path[_0x4f0183(0x119)](_0x31412c),_0x2f569a=process[_0x4f0183(0xb2)](),_0xfa4e08=path[_0x4f0183(0xe1)](_0x2f569a,'public',_0x4f0183(0xdb),_0x3851d6),_0x49ba7c=path[_0x4f0183(0xe1)](_0xfa4e08,_0x12b348);if(!_0x49ba7c[_0x4f0183(0xfc)](path[_0x4f0183(0xe1)](_0x2f569a,'public','file')))throw new Error(_0x4f0183(0xc3));try{await fs_1[_0x4f0183(0xf2)][_0x4f0183(0xf7)](_0xfa4e08,{'recursive':!![]});}catch(_0x193535){common_1[_0x4f0183(0xc7)][_0x4f0183(0x113)](_0x4f0183(0xbb)+_0xfa4e08,_0x193535);throw _0x193535;}try{await fs_1[_0x4f0183(0xf2)][_0x4f0183(0xeb)](_0x49ba7c,_0x5deedc,{'mode':0x124});}catch(_0x158297){common_1['Logger'][_0x4f0183(0x113)](_0x4f0183(0x10c)+_0x49ba7c,_0x158297);throw _0x158297;}let _0x5573a2='file/'+_0x3851d6+'/'+_0x12b348;const _0x29132e=await this['globalConfigService']['getConfigs']([_0x4f0183(0xe9)]);if(_0x29132e){const _0x153b5d=(0x0,utils_1[_0x4f0183(0xac)])(_0x29132e);_0x5573a2=_0x153b5d+'/'+_0x5573a2;}return _0x5573a2;}async[_0x2b587b(0x102)]({filename:filename='',buffer:_0x4c4045}){const _0x5daabd=_0x2b587b;var _0x4d8f28;const {key:_0x505ec2,uploadPath:_0x3ee08e}=await this['getUploadConfig'](_0x5daabd(0xe0));let _0x3e2df2=_0x3ee08e[_0x5daabd(0xb6)]('/')?_0x3ee08e['slice'](0x0,-0x1):_0x3ee08e;const _0x4bf66c=new FormData(),_0x4cbdb1=_0x4c4045[_0x5daabd(0x103)](_0x5daabd(0xc6));_0x4bf66c['append']('source',_0x4cbdb1),_0x4bf66c[_0x5daabd(0xfa)](_0x5daabd(0x105),_0x505ec2),_0x4bf66c[_0x5daabd(0xfa)](_0x5daabd(0xc5),filename);try{const _0x108854=await axios_1[_0x5daabd(0xdf)][_0x5daabd(0x115)](_0x3e2df2,_0x4bf66c,{'headers':{'X-API-Key':_0x505ec2}});if((_0x108854===null||_0x108854===void 0x0?void 0x0:_0x108854[_0x5daabd(0xf4)])===0xc8)return _0x108854[_0x5daabd(0xf3)][_0x5daabd(0xf9)][_0x5daabd(0xcf)];else console[_0x5daabd(0x9b)](_0x5daabd(0xcb),_0x108854===null||_0x108854===void 0x0?void 0x0:_0x108854[_0x5daabd(0xf3)][_0x5daabd(0x108)],_0x108854===null||_0x108854===void 0x0?void 0x0:_0x108854[_0x5daabd(0xf3)][_0x5daabd(0x113)]['message']),common_1[_0x5daabd(0xc7)][_0x5daabd(0x113)](_0x5daabd(0x101),JSON['stringify'](_0x108854[_0x5daabd(0xf3)]));}catch(_0x509584){console[_0x5daabd(0x9b)](_0x5daabd(0xe8),_0x509584);throw new common_1[(_0x5daabd(0xe3))](_0x5daabd(0x116)+((_0x4d8f28=_0x509584[_0x5daabd(0xdc)])===null||_0x4d8f28===void 0x0?void 0x0:_0x4d8f28[_0x5daabd(0xf3)][_0x5daabd(0x113)][_0x5daabd(0xbf)]),common_1[_0x5daabd(0xb8)]['BAD_REQUEST']);}}async[_0x2b587b(0x11f)](_0x55779f){const _0x53f8c6=_0x2b587b;if(_0x55779f===_0x53f8c6(0xee)){const {aliOssRegion:_0xd24466,aliOssBucket:_0x29e228,aliOssAccessKeyId:_0x55b171,aliOssAccessKeySecret:_0x49ad77,aliOssAcceleratedDomain:_0x589cd6}=await this[_0x53f8c6(0xfd)][_0x53f8c6(0xd6)]([_0x53f8c6(0xfe),_0x53f8c6(0xea),'aliOssAccessKeyId',_0x53f8c6(0x10d),_0x53f8c6(0x111)]);return{'region':_0xd24466,'bucket':_0x29e228,'accessKeyId':_0x55b171,'accessKeySecret':_0x49ad77,'acceleratedDomain':_0x589cd6};}if(_0x55779f===_0x53f8c6(0x110)){const {cosBucket:_0x3a08cd,cosRegion:_0x1e6255,cosSecretId:_0x32e107,cosSecretKey:_0x422c72,tencentCosAcceleratedDomain:_0x37cb9d}=await this[_0x53f8c6(0xfd)][_0x53f8c6(0xd6)](['cosBucket',_0x53f8c6(0x9e),_0x53f8c6(0xf8),'cosSecretKey',_0x53f8c6(0x11b)]);return{'Bucket':_0x3a08cd,'Region':_0x1e6255,'SecretId':_0x32e107,'SecretKey':_0x422c72,'acceleratedDomain':_0x37cb9d};}if(_0x55779f===_0x53f8c6(0xe0)){const {cheveretoKey:_0x177bdc,cheveretoUploadPath:_0x57e1c3}=await this[_0x53f8c6(0xfd)][_0x53f8c6(0xd6)]([_0x53f8c6(0xfb),_0x53f8c6(0x114)]);return{'key':_0x177bdc,'uploadPath':_0x57e1c3};}}async[_0x2b587b(0xef)](_0x1cbb43){const _0x1535f7=_0x2b587b,_0x1c3adf=await axios_1[_0x1535f7(0xdf)][_0x1535f7(0xd1)](_0x1cbb43,{'responseType':'stream'}),_0x1d002a=await new Promise((_0x490f00,_0x449374)=>{const _0x37117c=_0x1535f7;streamToBuffer(_0x1c3adf[_0x37117c(0xf3)],(_0x3eb4b5,_0x107c2c)=>{const _0x3fce0e=_0x37117c;_0x3eb4b5?_0x449374(new common_1[(_0x3fce0e(0xe3))](_0x3fce0e(0xc9),common_1['HttpStatus'][_0x3fce0e(0xc8)])):_0x490f00(_0x107c2c);});}),_0x9336b7=_0x1c3adf[_0x1535f7(0x10b)][_0x1535f7(0xa7)];return{'buffer':_0x1d002a,'mimeType':_0x9336b7};}};function _0xe4c3(_0x3858f7,_0x274ed2){const _0x19fb91=_0x19fb();return _0xe4c3=function(_0xe4c3c5,_0xc7f7c6){_0xe4c3c5=_0xe4c3c5-0x97;let _0x33e7fe=_0x19fb91[_0xe4c3c5];return _0x33e7fe;},_0xe4c3(_0x3858f7,_0x274ed2);}UploadService=__decorate([(0x0,common_1['Injectable'])(),__metadata(_0x2b587b(0xd4),[globalConfig_service_1[_0x2b587b(0xba)]])],UploadService),exports[_0x2b587b(0x106)]=UploadService;