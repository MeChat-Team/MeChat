'use strict';const _0x926459=_0x3811;(function(_0x1e2633,_0x286df7){const _0x2edf22=_0x3811,_0x287c3d=_0x1e2633();while(!![]){try{const _0x318fe6=-parseInt(_0x2edf22(0x1d7))/0x1*(-parseInt(_0x2edf22(0x18f))/0x2)+parseInt(_0x2edf22(0x183))/0x3*(-parseInt(_0x2edf22(0x1be))/0x4)+-parseInt(_0x2edf22(0x15f))/0x5+-parseInt(_0x2edf22(0x1ce))/0x6*(parseInt(_0x2edf22(0x171))/0x7)+parseInt(_0x2edf22(0x199))/0x8+parseInt(_0x2edf22(0x1c5))/0x9*(-parseInt(_0x2edf22(0x1ae))/0xa)+-parseInt(_0x2edf22(0x159))/0xb*(-parseInt(_0x2edf22(0x16c))/0xc);if(_0x318fe6===_0x286df7)break;else _0x287c3d['push'](_0x287c3d['shift']());}catch(_0x225905){_0x287c3d['push'](_0x287c3d['shift']());}}}(_0x2682,0xc3afb));var __decorate=this&&this[_0x926459(0x1ac)]||function(_0x3d936f,_0x1318c7,_0x33fead,_0x2120fd){const _0x194047=_0x926459;var _0x1ddbca=arguments[_0x194047(0x193)],_0x3cd5a0=_0x1ddbca<0x3?_0x1318c7:_0x2120fd===null?_0x2120fd=Object[_0x194047(0x165)](_0x1318c7,_0x33fead):_0x2120fd,_0x36270c;if(typeof Reflect==='object'&&typeof Reflect[_0x194047(0x1d5)]===_0x194047(0x1b3))_0x3cd5a0=Reflect[_0x194047(0x1d5)](_0x3d936f,_0x1318c7,_0x33fead,_0x2120fd);else{for(var _0x54b40d=_0x3d936f['length']-0x1;_0x54b40d>=0x0;_0x54b40d--)if(_0x36270c=_0x3d936f[_0x54b40d])_0x3cd5a0=(_0x1ddbca<0x3?_0x36270c(_0x3cd5a0):_0x1ddbca>0x3?_0x36270c(_0x1318c7,_0x33fead,_0x3cd5a0):_0x36270c(_0x1318c7,_0x33fead))||_0x3cd5a0;}return _0x1ddbca>0x3&&_0x3cd5a0&&Object[_0x194047(0x1ba)](_0x1318c7,_0x33fead,_0x3cd5a0),_0x3cd5a0;},__metadata=this&&this[_0x926459(0x18d)]||function(_0x4d9422,_0x38a4a2){const _0x531e7d=_0x926459;if(typeof Reflect===_0x531e7d(0x1a7)&&typeof Reflect[_0x531e7d(0x1ab)]==='function')return Reflect[_0x531e7d(0x1ab)](_0x4d9422,_0x38a4a2);};Object[_0x926459(0x1ba)](exports,_0x926459(0x154),{'value':!![]}),exports[_0x926459(0x19b)]=void 0x0;const utils_1=require('../../common/utils'),common_1=require(_0x926459(0x1b5)),ALIOSS=require(_0x926459(0x17c)),axios_1=require(_0x926459(0x185)),TENCENTCOS=require(_0x926459(0x1cb)),FormData=require('form-data'),fs_1=require('fs'),mime=require(_0x926459(0x1aa)),path=require(_0x926459(0x1d1)),streamToBuffer=require(_0x926459(0x166)),globalConfig_service_1=require(_0x926459(0x19f)),blacklist=[_0x926459(0x15a),'sh',_0x926459(0x1c4),'js','php','py'];function _0x2682(){const _0x4ddb52=['extension','length','tencent','removeSpecialCharacters','HttpException','stream','content-type','10976512fTvdRt','aliOssAccessKeyId','UploadService','file/','toLowerCase','Injectable','../globalConfig/globalConfig.service','BAD_REQUEST','putObject','非法路径，禁止访问目录之外的位置','slice','https://$2','上传配置状态\x20-\x20腾讯云:本地存储:\x20','writeFile','object','cwd','error:\x20','mime-types','metadata','__decorate',',\x20阿里云:\x20','1070TeEDqZ','normalize','uploadFileByChevereto','toString','data','function','cosSecretKey','@nestjs/common','source','siteUrl','tencentCosStatus','public','defineProperty','Logger','onModuleInit','code','4MJNtNt','aliOssBucket','design:paramtypes','uploadFileByAliOss','base64','file','bat','129033NFOOJg','ali\x20开始上传','uploadFileByTencentCos','env','random','uploadFileToLocal','cos-nodejs-sdk-v5','post','cosRegion','108hEYrBU','tencentCosAcceleratedDomain','aliOssStatus','path','getBufferFromUrl','https://','未配置任何上传方式','decorate','GlobalConfigService','1560316jetRtD','tencentCos','append','__esModule','key','basename','title','image','136037YBZphF','exe','log','上传图片失败[Chevereto|buffer]\x20-->\x20','文件已上传到阿里云\x20OSS。访问\x20URL:\x20','aliOssRegion','4143280BmjpNU','catch','getUploadType','getUploadConfig','uploadFile','chevereto','getOwnPropertyDescriptor','stream-to-buffer','文件保存失败:\x20','error','join','response','includes','1524cIdiXY','replace','acceleratedDomain','cheveretoKey','上传图片失败[ten]','80297vfJpNZ','不允许上传此类型的文件','getConfigs','cosBucket','Chevereto\x20--->\x20res','others','上传图片失败[ali]','dev/','headers','TRUE','HttpStatus','ali-oss','cheveretoStatus','globalConfigService','get','上传图片失败[Chevereto]','当前已开启全球加速----------------->',',\x20Chevereto:\x20','3396795DmHkQG','stringify','axios','ali','使用腾讯云\x20COS\x20上传文件','cosSecretId','aliOssAccessKeySecret','ISDEV','url','获取图片资源失败，请重新试试吧！','__metadata','message','2qeSlWr','使用本地存储上传文件','default'];_0x2682=function(){return _0x4ddb52;};return _0x2682();}function _0x3811(_0xfb7ab2,_0x289178){const _0x2682cf=_0x2682();return _0x3811=function(_0x381126,_0x4fca14){_0x381126=_0x381126-0x153;let _0x2365c2=_0x2682cf[_0x381126];return _0x2365c2;},_0x3811(_0xfb7ab2,_0x289178);}let UploadService=class UploadService{constructor(_0x517a01){const _0x1ca896=_0x926459;this[_0x1ca896(0x17e)]=_0x517a01;}[_0x926459(0x1bc)](){}async['uploadFile'](_0x3233aa,_0x3ce0b2=_0x926459(0x176)){const _0x2adeb1=_0x926459,{buffer:_0x1a81c2,mimetype:_0x4bff7c}=_0x3233aa;process[_0x2adeb1(0x1c8)][_0x2adeb1(0x18a)]===_0x2adeb1(0x17a)&&(_0x3ce0b2=_0x2adeb1(0x178)+_0x3ce0b2);const _0x5cda6d=mime[_0x2adeb1(0x192)](_0x4bff7c)||'';!_0x5cda6d&&common_1[_0x2adeb1(0x1bb)][_0x2adeb1(0x168)]('无法识别文件类型，请检查文件',_0x2adeb1(0x19b));if(blacklist[_0x2adeb1(0x16b)](_0x5cda6d[_0x2adeb1(0x19d)]())){common_1[_0x2adeb1(0x1bb)][_0x2adeb1(0x168)]('不允许上传此类型的文件',_0x2adeb1(0x19b));throw new Error(_0x2adeb1(0x172));}const _0x26dcce=new Date(),_0x4ba4cd=_0x26dcce['getTime'](),_0x46247c=Math[_0x2adeb1(0x1c9)]()[_0x2adeb1(0x1b1)](0x24)['substring'](0x2,0x6),_0x36b002=_0x4ba4cd+'_'+_0x46247c+'.'+_0x5cda6d,{tencentCosStatus:tencentCosStatus=0x0,aliOssStatus:aliOssStatus=0x0,cheveretoStatus:cheveretoStatus=0x0,localStorageStatus:localStorageStatus=0x0}=await this['globalConfigService']['getConfigs'](['tencentCosStatus',_0x2adeb1(0x1d0),_0x2adeb1(0x17d),'localStorageStatus']);common_1[_0x2adeb1(0x1bb)][_0x2adeb1(0x15b)](_0x2adeb1(0x1a5)+localStorageStatus+',\x20'+tencentCosStatus+_0x2adeb1(0x1ad)+aliOssStatus+_0x2adeb1(0x182)+cheveretoStatus,_0x2adeb1(0x19b));if(!Number(tencentCosStatus)&&!Number(aliOssStatus)&&!Number(cheveretoStatus)&&!Number(localStorageStatus)){common_1[_0x2adeb1(0x1bb)][_0x2adeb1(0x168)](_0x2adeb1(0x1d4),'UploadService');throw new common_1[(_0x2adeb1(0x196))]('请先前往后台配置上传图片的方式',common_1[_0x2adeb1(0x17b)][_0x2adeb1(0x1a0)]);}try{if(Number(localStorageStatus)){common_1['Logger'][_0x2adeb1(0x15b)](_0x2adeb1(0x190),_0x2adeb1(0x19b));const _0x30cac1=await this[_0x2adeb1(0x1ca)]({'filename':_0x36b002,'buffer':_0x1a81c2,'dir':_0x3ce0b2});return common_1[_0x2adeb1(0x1bb)][_0x2adeb1(0x15b)]('文件已上传到本地存储。访问\x20URL:\x20'+_0x30cac1,_0x2adeb1(0x19b)),_0x30cac1;}if(Number(tencentCosStatus)){common_1['Logger']['log'](_0x2adeb1(0x187),_0x2adeb1(0x19b));const _0x5722e4=await this[_0x2adeb1(0x1c7)]({'filename':_0x36b002,'buffer':_0x1a81c2,'dir':_0x3ce0b2});return common_1['Logger'][_0x2adeb1(0x15b)]('文件已上传到腾讯云\x20COS。访问\x20URL:\x20'+_0x5722e4,_0x2adeb1(0x19b)),_0x5722e4;}if(Number(aliOssStatus)){common_1[_0x2adeb1(0x1bb)]['log']('使用阿里云\x20OSS\x20上传文件',_0x2adeb1(0x19b));const _0x3b597d=await this[_0x2adeb1(0x1c1)]({'filename':_0x36b002,'buffer':_0x1a81c2,'dir':_0x3ce0b2});return common_1[_0x2adeb1(0x1bb)]['log'](_0x2adeb1(0x15d)+_0x3b597d,'UploadService'),_0x3b597d;}if(Number(cheveretoStatus)){common_1[_0x2adeb1(0x1bb)]['log']('使用\x20Chevereto\x20上传文件',_0x2adeb1(0x19b));const _0x43a6f6=await this['uploadFileByChevereto']({'filename':_0x36b002,'buffer':_0x1a81c2[_0x2adeb1(0x1b1)](_0x2adeb1(0x1c2))});return common_1[_0x2adeb1(0x1bb)][_0x2adeb1(0x15b)]('文件已上传到\x20Chevereto。访问\x20URL:\x20'+_0x43a6f6,_0x2adeb1(0x19b)),_0x43a6f6;}}catch(_0x52ef9e){common_1['Logger'][_0x2adeb1(0x168)]('上传失败:\x20'+_0x52ef9e[_0x2adeb1(0x18e)],_0x2adeb1(0x19b));throw _0x52ef9e;}}async[_0x926459(0x161)](){const _0xbb86fc=_0x926459,{tencentCosStatus:tencentCosStatus=0x0,aliOssStatus:aliOssStatus=0x0,cheveretoStatus:cheveretoStatus=0x0}=await this[_0xbb86fc(0x17e)][_0xbb86fc(0x173)]([_0xbb86fc(0x1b8),_0xbb86fc(0x1d0),_0xbb86fc(0x17d)]);if(Number(tencentCosStatus))return _0xbb86fc(0x194);if(Number(aliOssStatus))return _0xbb86fc(0x186);if(Number(cheveretoStatus))return _0xbb86fc(0x164);}async['uploadFileFromUrl']({url:_0x49bc99,dir:dir=_0x926459(0x176)}){const _0x2065ab=_0x926459;process[_0x2065ab(0x1c8)]['ISDEV']==='TRUE'&&(dir=_0x2065ab(0x178)+dir);const {buffer:_0x50afe5,mimeType:_0xc51fa7}=await this[_0x2065ab(0x1d2)](_0x49bc99);return await this[_0x2065ab(0x163)]({'buffer':_0x50afe5,'mimetype':_0xc51fa7},dir);}async[_0x926459(0x1c7)]({filename:_0x57c9e1,buffer:_0xc311f6,dir:_0x5ec432}){const _0x389890=_0x926459,{Bucket:_0x250fb5,Region:_0x1249f5,SecretId:_0x426845,SecretKey:_0x387d3b}=await this[_0x389890(0x162)]('tencent');this['tencentCos']=new TENCENTCOS({'SecretId':_0x426845,'SecretKey':_0x387d3b,'FileParallelLimit':0xa});try{return new Promise(async(_0x2deacf,_0x23b05f)=>{const _0x3bee5d=_0x389890;this[_0x3bee5d(0x1d8)][_0x3bee5d(0x1a1)]({'Bucket':(0x0,utils_1[_0x3bee5d(0x195)])(_0x250fb5),'Region':(0x0,utils_1[_0x3bee5d(0x195)])(_0x1249f5),'Key':_0x5ec432+'/'+_0x57c9e1,'StorageClass':'STANDARD','Body':_0xc311f6},async(_0x38abc3,_0xb32846)=>{const _0x13da68=_0x3bee5d;if(_0x38abc3)return console[_0x13da68(0x15b)]('cos\x20->\x20err:\x20',_0x38abc3),_0x23b05f(_0x38abc3);let _0x38b03c=_0xb32846['Location']['replace'](/^(http:\/\/|https:\/\/|\/\/|)(.*)/,_0x13da68(0x1a4));const {acceleratedDomain:_0x21beb9}=await this['getUploadConfig'](_0x13da68(0x194));return _0x21beb9&&(_0x38b03c=_0x38b03c[_0x13da68(0x16d)](/^(https:\/\/[^/]+)(\/.*)$/,_0x13da68(0x1d3)+_0x21beb9+'$2'),console['log'](_0x13da68(0x181),_0x38b03c)),_0x2deacf(_0x38b03c);});});}catch(_0x54747a){console['log'](_0x389890(0x1a9),_0x54747a);throw new common_1[(_0x389890(0x196))](_0x389890(0x170),common_1[_0x389890(0x17b)]['BAD_REQUEST']);}}async[_0x926459(0x1c1)]({filename:_0x4a2cb7,buffer:_0x3e228e,dir:_0xa7adba}){const _0x214309=_0x926459,{region:_0x41f7ba,bucket:_0x59f628,accessKeyId:_0x21e8e2,accessKeySecret:_0x509725}=await this['getUploadConfig'](_0x214309(0x186)),_0x238d51=new ALIOSS({'region':(0x0,utils_1[_0x214309(0x195)])(_0x41f7ba),'accessKeyId':_0x21e8e2,'accessKeySecret':_0x509725,'bucket':(0x0,utils_1['removeSpecialCharacters'])(_0x59f628)});try{return console['log'](_0x214309(0x1c6)),new Promise((_0x1d2056,_0x295991)=>{const _0x329a5a=_0x214309;_0x238d51['put'](_0xa7adba+'/'+_0x4a2cb7,_0x3e228e)['then'](async _0x101cda=>{const _0x3e69df=_0x3811,{acceleratedDomain:_0x5101d7}=await this[_0x3e69df(0x162)](_0x3e69df(0x186));_0x5101d7&&(_0x101cda[_0x3e69df(0x18b)]=_0x101cda[_0x3e69df(0x18b)]['replace'](/^(https:\/\/[^/]+)(\/.*)$/,_0x3e69df(0x1d3)+_0x5101d7+'$2'),console[_0x3e69df(0x15b)](_0x3e69df(0x181),_0x101cda[_0x3e69df(0x18b)])),_0x1d2056(_0x101cda[_0x3e69df(0x18b)]);})[_0x329a5a(0x160)](_0x43f645=>{_0x295991(_0x43f645);});});}catch(_0x33a09c){throw new common_1[(_0x214309(0x196))](_0x214309(0x177),common_1[_0x214309(0x17b)][_0x214309(0x1a0)]);}}async[_0x926459(0x1ca)]({filename:_0x1f9497,buffer:_0x23db79,dir:dir='others'}){const _0x15dc28=_0x926459,_0x5b4919=path[_0x15dc28(0x1af)](dir)['replace'](/^(\.\.(\/|\\|$))+/,''),_0x51a0e4=path[_0x15dc28(0x156)](_0x1f9497),_0x148e65=process[_0x15dc28(0x1a8)](),_0x4e86f5=path[_0x15dc28(0x169)](_0x148e65,_0x15dc28(0x1b9),_0x15dc28(0x1c3),_0x5b4919),_0x16a437=path['join'](_0x4e86f5,_0x51a0e4);if(!_0x16a437['startsWith'](path['join'](_0x148e65,_0x15dc28(0x1b9),_0x15dc28(0x1c3))))throw new Error(_0x15dc28(0x1a2));try{await fs_1['promises']['mkdir'](_0x4e86f5,{'recursive':!![]});}catch(_0x44f327){common_1['Logger'][_0x15dc28(0x168)]('创建目录失败:\x20'+_0x4e86f5,_0x44f327);throw _0x44f327;}try{await fs_1['promises'][_0x15dc28(0x1a6)](_0x16a437,_0x23db79,{'mode':0x124});}catch(_0x418d5f){common_1[_0x15dc28(0x1bb)][_0x15dc28(0x168)](_0x15dc28(0x167)+_0x16a437,_0x418d5f);throw _0x418d5f;}let _0x2b4d4b=_0x15dc28(0x19c)+_0x5b4919+'/'+_0x51a0e4;const _0x56143a=await this['globalConfigService'][_0x15dc28(0x173)]([_0x15dc28(0x1b7)]);if(_0x56143a){const _0x326dde=(0x0,utils_1['formatUrl'])(_0x56143a);_0x2b4d4b=_0x326dde+'/'+_0x2b4d4b;}return _0x2b4d4b;}async[_0x926459(0x1b0)]({filename:filename='',buffer:_0x32b4ce}){const _0x4032d7=_0x926459;var _0x1ead4f;const {key:_0x1843ba,uploadPath:_0x79aaf9}=await this[_0x4032d7(0x162)]('chevereto');let _0x2687d3=_0x79aaf9['endsWith']('/')?_0x79aaf9[_0x4032d7(0x1a3)](0x0,-0x1):_0x79aaf9;const _0x56f0d7=new FormData(),_0x237d46=_0x32b4ce['toString']('base64');_0x56f0d7[_0x4032d7(0x153)](_0x4032d7(0x1b6),_0x237d46),_0x56f0d7['append'](_0x4032d7(0x155),_0x1843ba),_0x56f0d7[_0x4032d7(0x153)](_0x4032d7(0x157),filename);try{const _0x1ab612=await axios_1[_0x4032d7(0x191)][_0x4032d7(0x1cc)](_0x2687d3,_0x56f0d7,{'headers':{'X-API-Key':_0x1843ba}});if((_0x1ab612===null||_0x1ab612===void 0x0?void 0x0:_0x1ab612['status'])===0xc8)return _0x1ab612[_0x4032d7(0x1b2)][_0x4032d7(0x158)][_0x4032d7(0x18b)];else console[_0x4032d7(0x15b)](_0x4032d7(0x175),_0x1ab612===null||_0x1ab612===void 0x0?void 0x0:_0x1ab612[_0x4032d7(0x1b2)][_0x4032d7(0x1bd)],_0x1ab612===null||_0x1ab612===void 0x0?void 0x0:_0x1ab612[_0x4032d7(0x1b2)][_0x4032d7(0x168)][_0x4032d7(0x18e)]),common_1[_0x4032d7(0x1bb)]['error'](_0x4032d7(0x180),JSON[_0x4032d7(0x184)](_0x1ab612[_0x4032d7(0x1b2)]));}catch(_0x50c8d0){console['log'](_0x4032d7(0x1a9),_0x50c8d0);throw new common_1[(_0x4032d7(0x196))](_0x4032d7(0x15c)+((_0x1ead4f=_0x50c8d0[_0x4032d7(0x16a)])===null||_0x1ead4f===void 0x0?void 0x0:_0x1ead4f[_0x4032d7(0x1b2)][_0x4032d7(0x168)][_0x4032d7(0x18e)]),common_1['HttpStatus'][_0x4032d7(0x1a0)]);}}async[_0x926459(0x162)](_0x7729fd){const _0x558f27=_0x926459;if(_0x7729fd===_0x558f27(0x186)){const {aliOssRegion:_0x55a471,aliOssBucket:_0x5a3b5d,aliOssAccessKeyId:_0x19dc60,aliOssAccessKeySecret:_0x8d7ea6,aliOssAcceleratedDomain:_0x5208dd}=await this[_0x558f27(0x17e)][_0x558f27(0x173)]([_0x558f27(0x15e),_0x558f27(0x1bf),_0x558f27(0x19a),_0x558f27(0x189),_0x558f27(0x16e)]);return{'region':_0x55a471,'bucket':_0x5a3b5d,'accessKeyId':_0x19dc60,'accessKeySecret':_0x8d7ea6,'acceleratedDomain':_0x5208dd};}if(_0x7729fd===_0x558f27(0x194)){const {cosBucket:_0x3a1d3f,cosRegion:_0x14ca17,cosSecretId:_0x1cb16f,cosSecretKey:_0x212831,tencentCosAcceleratedDomain:_0xfbea3f}=await this[_0x558f27(0x17e)][_0x558f27(0x173)]([_0x558f27(0x174),_0x558f27(0x1cd),_0x558f27(0x188),_0x558f27(0x1b4),_0x558f27(0x1cf)]);return{'Bucket':_0x3a1d3f,'Region':_0x14ca17,'SecretId':_0x1cb16f,'SecretKey':_0x212831,'acceleratedDomain':_0xfbea3f};}if(_0x7729fd==='chevereto'){const {cheveretoKey:_0x22da91,cheveretoUploadPath:_0x3934db}=await this[_0x558f27(0x17e)][_0x558f27(0x173)]([_0x558f27(0x16f),'cheveretoUploadPath']);return{'key':_0x22da91,'uploadPath':_0x3934db};}}async[_0x926459(0x1d2)](_0x2a9af1){const _0x4382be=_0x926459,_0x584497=await axios_1[_0x4382be(0x191)][_0x4382be(0x17f)](_0x2a9af1,{'responseType':_0x4382be(0x197)}),_0x1181a0=await new Promise((_0x2e89c6,_0x9a1e26)=>{streamToBuffer(_0x584497['data'],(_0x53252b,_0x5a7b04)=>{const _0x5205d5=_0x3811;_0x53252b?_0x9a1e26(new common_1[(_0x5205d5(0x196))](_0x5205d5(0x18c),common_1[_0x5205d5(0x17b)]['BAD_REQUEST'])):_0x2e89c6(_0x5a7b04);});}),_0x45ff22=_0x584497[_0x4382be(0x179)][_0x4382be(0x198)];return{'buffer':_0x1181a0,'mimeType':_0x45ff22};}};UploadService=__decorate([(0x0,common_1[_0x926459(0x19e)])(),__metadata(_0x926459(0x1c0),[globalConfig_service_1[_0x926459(0x1d6)]])],UploadService),exports[_0x926459(0x19b)]=UploadService;