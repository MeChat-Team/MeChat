'use strict';const _0x40051d=_0x18c8;(function(_0xcbade1,_0xf1d9bd){const _0x1e4b81=_0x18c8,_0xb877e5=_0xcbade1();while(!![]){try{const _0xd72b63=parseInt(_0x1e4b81(0x16a))/0x1+-parseInt(_0x1e4b81(0x175))/0x2+-parseInt(_0x1e4b81(0x149))/0x3+parseInt(_0x1e4b81(0x197))/0x4*(-parseInt(_0x1e4b81(0x170))/0x5)+-parseInt(_0x1e4b81(0x1b2))/0x6*(-parseInt(_0x1e4b81(0x1b8))/0x7)+-parseInt(_0x1e4b81(0x16b))/0x8*(-parseInt(_0x1e4b81(0x18a))/0x9)+parseInt(_0x1e4b81(0x146))/0xa;if(_0xd72b63===_0xf1d9bd)break;else _0xb877e5['push'](_0xb877e5['shift']());}catch(_0x55250d){_0xb877e5['push'](_0xb877e5['shift']());}}}(_0x318c,0xce32e));function _0x318c(){const _0x32208e=['image','14557280KUHrVM','上传配置状态\x20-\x20腾讯云:本地存储:\x20','source','2895093Cmalqq','bat','文件已上传到本地存储。访问\x20URL:\x20','uploadFile','cosSecretId',',\x20阿里云:\x20','https://','get','onModuleInit','others','normalize','cos-nodejs-sdk-v5',',\x20Chevereto:\x20','aliOssAccessKeyId','append','Chevereto\x20--->\x20res','message','php','dev/','tencent','TRUE','form-data','env','length','aliOssRegion','then','未配置任何上传方式','HttpException','getOwnPropertyDescriptor','acceleratedDomain','cosBucket','defineProperty','tencentCosAcceleratedDomain','1284395XgvhmR','573008WDlILJ','default','getUploadConfig','aliOssStatus','Injectable','100OcRsAr','globalConfigService','join','put','design:paramtypes','2048542Cbjbpy','tencentCos','__decorate','getConfigs','putObject','path','文件已上传到\x20Chevereto。访问\x20URL:\x20','cosSecretKey','ali\x20开始上传','文件已上传到腾讯云\x20COS。访问\x20URL:\x20','Location','上传图片失败[Chevereto|buffer]\x20-->\x20','BAD_REQUEST','key','无法识别文件类型，请检查文件','code','uploadFileByAliOss','function','cheveretoStatus','headers','file','81oVQcuf','substring','__esModule','ISDEV','不允许上传此类型的文件','stream-to-buffer','catch','HttpStatus','aliOssAccessKeySecret','base64','文件保存失败:\x20','extension','includes','146088BqGVkN','当前已开启全球加速----------------->','error','GlobalConfigService','上传失败:\x20','uploadFileToLocal','uploadFileFromUrl','file/','上传图片失败[ali]','uploadFileByTencentCos','random','uploadFileByChevereto','mkdir','log','removeSpecialCharacters','promises','response','title','toString','formatUrl','使用\x20Chevereto\x20上传文件','basename','使用本地存储上传文件','toLowerCase','请先前往后台配置上传图片的方式','UploadService','ali','1077450KabKOS','object','https://$2','writeFile','metadata','stringify','7yGnZtA','Logger','error:\x20','tencentCosStatus','replace','url','chevereto','data','localStorageStatus','cheveretoUploadPath','axios','cosRegion'];_0x318c=function(){return _0x32208e;};return _0x318c();}var __decorate=this&&this[_0x40051d(0x177)]||function(_0x495526,_0x5da25e,_0xe9deab,_0x53209f){const _0x2502ab=_0x40051d;var _0x1fe42e=arguments[_0x2502ab(0x160)],_0x2f2733=_0x1fe42e<0x3?_0x5da25e:_0x53209f===null?_0x53209f=Object[_0x2502ab(0x165)](_0x5da25e,_0xe9deab):_0x53209f,_0x401cf2;if(typeof Reflect===_0x2502ab(0x1b3)&&typeof Reflect['decorate']==='function')_0x2f2733=Reflect['decorate'](_0x495526,_0x5da25e,_0xe9deab,_0x53209f);else{for(var _0x32f77c=_0x495526[_0x2502ab(0x160)]-0x1;_0x32f77c>=0x0;_0x32f77c--)if(_0x401cf2=_0x495526[_0x32f77c])_0x2f2733=(_0x1fe42e<0x3?_0x401cf2(_0x2f2733):_0x1fe42e>0x3?_0x401cf2(_0x5da25e,_0xe9deab,_0x2f2733):_0x401cf2(_0x5da25e,_0xe9deab))||_0x2f2733;}return _0x1fe42e>0x3&&_0x2f2733&&Object[_0x2502ab(0x168)](_0x5da25e,_0xe9deab,_0x2f2733),_0x2f2733;},__metadata=this&&this['__metadata']||function(_0x2612c5,_0x4961ab){const _0x3c742e=_0x40051d;if(typeof Reflect===_0x3c742e(0x1b3)&&typeof Reflect['metadata']===_0x3c742e(0x186))return Reflect[_0x3c742e(0x1b6)](_0x2612c5,_0x4961ab);};Object[_0x40051d(0x168)](exports,_0x40051d(0x18c),{'value':!![]}),exports[_0x40051d(0x1b0)]=void 0x0;const utils_1=require('../../common/utils'),common_1=require('@nestjs/common'),ALIOSS=require('ali-oss'),axios_1=require(_0x40051d(0x143)),TENCENTCOS=require(_0x40051d(0x154)),FormData=require(_0x40051d(0x15e)),fs_1=require('fs'),mime=require('mime-types'),path=require(_0x40051d(0x17a)),streamToBuffer=require(_0x40051d(0x18f)),globalConfig_service_1=require('../globalConfig/globalConfig.service'),blacklist=['exe','sh',_0x40051d(0x14a),'js',_0x40051d(0x15a),'py'];function _0x18c8(_0x51f844,_0x158a2b){const _0x318c92=_0x318c();return _0x18c8=function(_0x18c86f,_0x28f0e3){_0x18c86f=_0x18c86f-0x143;let _0x3fb55d=_0x318c92[_0x18c86f];return _0x3fb55d;},_0x18c8(_0x51f844,_0x158a2b);}let UploadService=class UploadService{constructor(_0x41fce4){const _0x269114=_0x40051d;this[_0x269114(0x171)]=_0x41fce4;}[_0x40051d(0x151)](){}async[_0x40051d(0x14c)](_0x1e14a7,_0x20c86c=_0x40051d(0x152)){const _0x2edb67=_0x40051d,{buffer:_0x4183b2,mimetype:_0x5a7fbd}=_0x1e14a7;process[_0x2edb67(0x15f)][_0x2edb67(0x18d)]==='TRUE'&&(_0x20c86c=_0x2edb67(0x15b)+_0x20c86c);const _0x536c81=mime[_0x2edb67(0x195)](_0x5a7fbd)||'';!_0x536c81&&common_1[_0x2edb67(0x1b9)][_0x2edb67(0x199)](_0x2edb67(0x183),_0x2edb67(0x1b0));if(blacklist[_0x2edb67(0x196)](_0x536c81[_0x2edb67(0x1ae)]())){common_1['Logger']['error'](_0x2edb67(0x18e),'UploadService');throw new Error('不允许上传此类型的文件');}const _0x46aec5=new Date(),_0x13afdc=_0x46aec5['getTime'](),_0x4b4a5e=Math[_0x2edb67(0x1a1)]()[_0x2edb67(0x1a9)](0x24)[_0x2edb67(0x18b)](0x2,0x6),_0x316156=_0x13afdc+'_'+_0x4b4a5e+'.'+_0x536c81,{tencentCosStatus:tencentCosStatus=0x0,aliOssStatus:aliOssStatus=0x0,cheveretoStatus:cheveretoStatus=0x0,localStorageStatus:localStorageStatus=0x0}=await this[_0x2edb67(0x171)][_0x2edb67(0x178)]([_0x2edb67(0x1bb),_0x2edb67(0x16e),'cheveretoStatus',_0x2edb67(0x1c0)]);common_1[_0x2edb67(0x1b9)][_0x2edb67(0x1a4)](_0x2edb67(0x147)+localStorageStatus+',\x20'+tencentCosStatus+_0x2edb67(0x14e)+aliOssStatus+_0x2edb67(0x155)+cheveretoStatus,'UploadService');if(!Number(tencentCosStatus)&&!Number(aliOssStatus)&&!Number(cheveretoStatus)&&!Number(localStorageStatus)){common_1[_0x2edb67(0x1b9)][_0x2edb67(0x199)](_0x2edb67(0x163),_0x2edb67(0x1b0));throw new common_1[(_0x2edb67(0x164))](_0x2edb67(0x1af),common_1['HttpStatus']['BAD_REQUEST']);}try{if(Number(localStorageStatus)){common_1[_0x2edb67(0x1b9)][_0x2edb67(0x1a4)](_0x2edb67(0x1ad),_0x2edb67(0x1b0));const _0x1d1eb0=await this[_0x2edb67(0x19c)]({'filename':_0x316156,'buffer':_0x4183b2,'dir':_0x20c86c});return common_1[_0x2edb67(0x1b9)][_0x2edb67(0x1a4)](_0x2edb67(0x14b)+_0x1d1eb0,_0x2edb67(0x1b0)),_0x1d1eb0;}if(Number(tencentCosStatus)){common_1[_0x2edb67(0x1b9)]['log']('使用腾讯云\x20COS\x20上传文件',_0x2edb67(0x1b0));const _0x434e9d=await this[_0x2edb67(0x1a0)]({'filename':_0x316156,'buffer':_0x4183b2,'dir':_0x20c86c});return common_1[_0x2edb67(0x1b9)]['log'](_0x2edb67(0x17e)+_0x434e9d,'UploadService'),_0x434e9d;}if(Number(aliOssStatus)){common_1[_0x2edb67(0x1b9)][_0x2edb67(0x1a4)]('使用阿里云\x20OSS\x20上传文件','UploadService');const _0x2e479a=await this['uploadFileByAliOss']({'filename':_0x316156,'buffer':_0x4183b2,'dir':_0x20c86c});return common_1['Logger'][_0x2edb67(0x1a4)]('文件已上传到阿里云\x20OSS。访问\x20URL:\x20'+_0x2e479a,_0x2edb67(0x1b0)),_0x2e479a;}if(Number(cheveretoStatus)){common_1[_0x2edb67(0x1b9)][_0x2edb67(0x1a4)](_0x2edb67(0x1ab),_0x2edb67(0x1b0));const _0x51a745=await this[_0x2edb67(0x1a2)]({'filename':_0x316156,'buffer':_0x4183b2[_0x2edb67(0x1a9)](_0x2edb67(0x193))});return common_1[_0x2edb67(0x1b9)][_0x2edb67(0x1a4)](_0x2edb67(0x17b)+_0x51a745,_0x2edb67(0x1b0)),_0x51a745;}}catch(_0x1fab4d){common_1[_0x2edb67(0x1b9)][_0x2edb67(0x199)](_0x2edb67(0x19b)+_0x1fab4d[_0x2edb67(0x159)],_0x2edb67(0x1b0));throw _0x1fab4d;}}async['getUploadType'](){const _0x18aea9=_0x40051d,{tencentCosStatus:tencentCosStatus=0x0,aliOssStatus:aliOssStatus=0x0,cheveretoStatus:cheveretoStatus=0x0}=await this[_0x18aea9(0x171)][_0x18aea9(0x178)]([_0x18aea9(0x1bb),_0x18aea9(0x16e),_0x18aea9(0x187)]);if(Number(tencentCosStatus))return _0x18aea9(0x15c);if(Number(aliOssStatus))return'ali';if(Number(cheveretoStatus))return'chevereto';}async[_0x40051d(0x19d)]({url:_0x135dbb,dir:dir=_0x40051d(0x152)}){const _0x45d4c0=_0x40051d;process[_0x45d4c0(0x15f)][_0x45d4c0(0x18d)]===_0x45d4c0(0x15d)&&(dir='dev/'+dir);const {buffer:_0x3d0899,mimeType:_0x39a313}=await this['getBufferFromUrl'](_0x135dbb);return await this[_0x45d4c0(0x14c)]({'buffer':_0x3d0899,'mimetype':_0x39a313},dir);}async[_0x40051d(0x1a0)]({filename:_0x5340a0,buffer:_0x317b38,dir:_0x27e0b2}){const _0x2720f0=_0x40051d,{Bucket:_0x38238b,Region:_0x3e3c5e,SecretId:_0x4b282a,SecretKey:_0xea826e}=await this['getUploadConfig'](_0x2720f0(0x15c));this['tencentCos']=new TENCENTCOS({'SecretId':_0x4b282a,'SecretKey':_0xea826e,'FileParallelLimit':0xa});try{return new Promise(async(_0x2bb36b,_0x469235)=>{const _0x4461ab=_0x2720f0;this[_0x4461ab(0x176)][_0x4461ab(0x179)]({'Bucket':(0x0,utils_1[_0x4461ab(0x1a5)])(_0x38238b),'Region':(0x0,utils_1[_0x4461ab(0x1a5)])(_0x3e3c5e),'Key':_0x27e0b2+'/'+_0x5340a0,'StorageClass':'STANDARD','Body':_0x317b38},async(_0x424632,_0x4e4b29)=>{const _0x44cb10=_0x4461ab;if(_0x424632)return console[_0x44cb10(0x1a4)]('cos\x20->\x20err:\x20',_0x424632),_0x469235(_0x424632);let _0x2fa4d0=_0x4e4b29[_0x44cb10(0x17f)][_0x44cb10(0x1bc)](/^(http:\/\/|https:\/\/|\/\/|)(.*)/,_0x44cb10(0x1b4));const {acceleratedDomain:_0x552669}=await this[_0x44cb10(0x16d)](_0x44cb10(0x15c));return _0x552669&&(_0x2fa4d0=_0x2fa4d0[_0x44cb10(0x1bc)](/^(https:\/\/[^/]+)(\/.*)$/,_0x44cb10(0x14f)+_0x552669+'$2'),console[_0x44cb10(0x1a4)]('当前已开启全球加速----------------->',_0x2fa4d0)),_0x2bb36b(_0x2fa4d0);});});}catch(_0x13bc7d){console[_0x2720f0(0x1a4)](_0x2720f0(0x1ba),_0x13bc7d);throw new common_1[(_0x2720f0(0x164))]('上传图片失败[ten]',common_1['HttpStatus'][_0x2720f0(0x181)]);}}async[_0x40051d(0x185)]({filename:_0x2255f6,buffer:_0x14931f,dir:_0x34bd6b}){const _0x573f9f=_0x40051d,{region:_0x5e76ba,bucket:_0x16e27f,accessKeyId:_0x254bd3,accessKeySecret:_0x2d4ce1}=await this[_0x573f9f(0x16d)](_0x573f9f(0x1b1)),_0x42c35b=new ALIOSS({'region':(0x0,utils_1[_0x573f9f(0x1a5)])(_0x5e76ba),'accessKeyId':_0x254bd3,'accessKeySecret':_0x2d4ce1,'bucket':(0x0,utils_1['removeSpecialCharacters'])(_0x16e27f)});try{return console[_0x573f9f(0x1a4)](_0x573f9f(0x17d)),new Promise((_0x286418,_0x1b2b15)=>{const _0x4996d8=_0x573f9f;_0x42c35b[_0x4996d8(0x173)](_0x34bd6b+'/'+_0x2255f6,_0x14931f)[_0x4996d8(0x162)](async _0x358400=>{const _0x183715=_0x4996d8,{acceleratedDomain:_0x40220e}=await this['getUploadConfig']('ali');_0x40220e&&(_0x358400[_0x183715(0x1bd)]=_0x358400[_0x183715(0x1bd)][_0x183715(0x1bc)](/^(https:\/\/[^/]+)(\/.*)$/,_0x183715(0x14f)+_0x40220e+'$2'),console[_0x183715(0x1a4)](_0x183715(0x198),_0x358400[_0x183715(0x1bd)])),_0x286418(_0x358400[_0x183715(0x1bd)]);})[_0x4996d8(0x190)](_0x14130b=>{_0x1b2b15(_0x14130b);});});}catch(_0x56114b){throw new common_1[(_0x573f9f(0x164))](_0x573f9f(0x19f),common_1['HttpStatus'][_0x573f9f(0x181)]);}}async[_0x40051d(0x19c)]({filename:_0x23f273,buffer:_0x191db4,dir:dir=_0x40051d(0x152)}){const _0x214f4b=_0x40051d,_0x4ab1e8=path[_0x214f4b(0x153)](dir)['replace'](/^(\.\.(\/|\\|$))+/,''),_0x17159f=path[_0x214f4b(0x1ac)](_0x23f273),_0x495171=process['cwd'](),_0x4043c5=path['join'](_0x495171,'public',_0x214f4b(0x189),_0x4ab1e8),_0x31f8ab=path[_0x214f4b(0x172)](_0x4043c5,_0x17159f);if(!_0x31f8ab['startsWith'](path[_0x214f4b(0x172)](_0x495171,'public','file')))throw new Error('非法路径，禁止访问目录之外的位置');try{await fs_1[_0x214f4b(0x1a6)][_0x214f4b(0x1a3)](_0x4043c5,{'recursive':!![]});}catch(_0x1bd3a6){common_1['Logger'][_0x214f4b(0x199)]('创建目录失败:\x20'+_0x4043c5,_0x1bd3a6);throw _0x1bd3a6;}try{await fs_1[_0x214f4b(0x1a6)][_0x214f4b(0x1b5)](_0x31f8ab,_0x191db4,{'mode':0x124});}catch(_0x5f069b){common_1[_0x214f4b(0x1b9)][_0x214f4b(0x199)](_0x214f4b(0x194)+_0x31f8ab,_0x5f069b);throw _0x5f069b;}let _0x14c57a=_0x214f4b(0x19e)+_0x4ab1e8+'/'+_0x17159f;const _0x325fd9=await this[_0x214f4b(0x171)]['getConfigs'](['siteUrl']);if(_0x325fd9){const _0x4a34b0=(0x0,utils_1[_0x214f4b(0x1aa)])(_0x325fd9);_0x14c57a=_0x4a34b0+'/'+_0x14c57a;}return _0x14c57a;}async[_0x40051d(0x1a2)]({filename:filename='',buffer:_0x16cc9b}){const _0x1e46db=_0x40051d;var _0x1570bd;const {key:_0x16bc7f,uploadPath:_0x18dc98}=await this['getUploadConfig'](_0x1e46db(0x1be));let _0x2aa58f=_0x18dc98['endsWith']('/')?_0x18dc98['slice'](0x0,-0x1):_0x18dc98;const _0x316419=new FormData(),_0x6e5866=_0x16cc9b['toString'](_0x1e46db(0x193));_0x316419[_0x1e46db(0x157)](_0x1e46db(0x148),_0x6e5866),_0x316419[_0x1e46db(0x157)](_0x1e46db(0x182),_0x16bc7f),_0x316419[_0x1e46db(0x157)](_0x1e46db(0x1a8),filename);try{const _0x3a1270=await axios_1[_0x1e46db(0x16c)]['post'](_0x2aa58f,_0x316419,{'headers':{'X-API-Key':_0x16bc7f}});if((_0x3a1270===null||_0x3a1270===void 0x0?void 0x0:_0x3a1270['status'])===0xc8)return _0x3a1270[_0x1e46db(0x1bf)][_0x1e46db(0x145)][_0x1e46db(0x1bd)];else console[_0x1e46db(0x1a4)](_0x1e46db(0x158),_0x3a1270===null||_0x3a1270===void 0x0?void 0x0:_0x3a1270[_0x1e46db(0x1bf)][_0x1e46db(0x184)],_0x3a1270===null||_0x3a1270===void 0x0?void 0x0:_0x3a1270[_0x1e46db(0x1bf)]['error'][_0x1e46db(0x159)]),common_1[_0x1e46db(0x1b9)][_0x1e46db(0x199)]('上传图片失败[Chevereto]',JSON[_0x1e46db(0x1b7)](_0x3a1270[_0x1e46db(0x1bf)]));}catch(_0x3f9ef2){console[_0x1e46db(0x1a4)](_0x1e46db(0x1ba),_0x3f9ef2);throw new common_1[(_0x1e46db(0x164))](_0x1e46db(0x180)+((_0x1570bd=_0x3f9ef2[_0x1e46db(0x1a7)])===null||_0x1570bd===void 0x0?void 0x0:_0x1570bd[_0x1e46db(0x1bf)][_0x1e46db(0x199)]['message']),common_1['HttpStatus']['BAD_REQUEST']);}}async['getUploadConfig'](_0xe43f71){const _0x351111=_0x40051d;if(_0xe43f71==='ali'){const {aliOssRegion:_0xa0f00e,aliOssBucket:_0x3e55e4,aliOssAccessKeyId:_0xd8fc2e,aliOssAccessKeySecret:_0x5c237c,aliOssAcceleratedDomain:_0x29d279}=await this[_0x351111(0x171)][_0x351111(0x178)]([_0x351111(0x161),'aliOssBucket',_0x351111(0x156),_0x351111(0x192),_0x351111(0x166)]);return{'region':_0xa0f00e,'bucket':_0x3e55e4,'accessKeyId':_0xd8fc2e,'accessKeySecret':_0x5c237c,'acceleratedDomain':_0x29d279};}if(_0xe43f71===_0x351111(0x15c)){const {cosBucket:_0x1a1352,cosRegion:_0x1a4886,cosSecretId:_0x55addd,cosSecretKey:_0x31aa59,tencentCosAcceleratedDomain:_0x4ee393}=await this[_0x351111(0x171)]['getConfigs']([_0x351111(0x167),_0x351111(0x144),_0x351111(0x14d),_0x351111(0x17c),_0x351111(0x169)]);return{'Bucket':_0x1a1352,'Region':_0x1a4886,'SecretId':_0x55addd,'SecretKey':_0x31aa59,'acceleratedDomain':_0x4ee393};}if(_0xe43f71==='chevereto'){const {cheveretoKey:_0x116bb2,cheveretoUploadPath:_0x14be15}=await this[_0x351111(0x171)][_0x351111(0x178)](['cheveretoKey',_0x351111(0x1c1)]);return{'key':_0x116bb2,'uploadPath':_0x14be15};}}async['getBufferFromUrl'](_0xeb10d){const _0x47b6a4=_0x40051d,_0x63dc0d=await axios_1[_0x47b6a4(0x16c)][_0x47b6a4(0x150)](_0xeb10d,{'responseType':'stream'}),_0x55a06c=await new Promise((_0x28d34a,_0x598b0c)=>{streamToBuffer(_0x63dc0d['data'],(_0x1fdf39,_0x1bbba7)=>{const _0x305ccd=_0x18c8;_0x1fdf39?_0x598b0c(new common_1[(_0x305ccd(0x164))]('获取图片资源失败，请重新试试吧！',common_1[_0x305ccd(0x191)][_0x305ccd(0x181)])):_0x28d34a(_0x1bbba7);});}),_0x282f69=_0x63dc0d[_0x47b6a4(0x188)]['content-type'];return{'buffer':_0x55a06c,'mimeType':_0x282f69};}};UploadService=__decorate([(0x0,common_1[_0x40051d(0x16f)])(),__metadata(_0x40051d(0x174),[globalConfig_service_1[_0x40051d(0x19a)]])],UploadService),exports[_0x40051d(0x1b0)]=UploadService;