'use strict';const _0x5a8a67=_0x5900;(function(_0x1a899d,_0x535721){const _0x4c92fb=_0x5900,_0x22a441=_0x1a899d();while(!![]){try{const _0x2c2137=parseInt(_0x4c92fb(0x16f))/0x1*(-parseInt(_0x4c92fb(0x11e))/0x2)+-parseInt(_0x4c92fb(0x10f))/0x3*(-parseInt(_0x4c92fb(0x111))/0x4)+parseInt(_0x4c92fb(0xf8))/0x5*(parseInt(_0x4c92fb(0x10d))/0x6)+parseInt(_0x4c92fb(0x152))/0x7*(-parseInt(_0x4c92fb(0x166))/0x8)+-parseInt(_0x4c92fb(0x124))/0x9*(parseInt(_0x4c92fb(0x109))/0xa)+-parseInt(_0x4c92fb(0x14a))/0xb+-parseInt(_0x4c92fb(0x17d))/0xc*(-parseInt(_0x4c92fb(0x100))/0xd);if(_0x2c2137===_0x535721)break;else _0x22a441['push'](_0x22a441['shift']());}catch(_0x13ae4e){_0x22a441['push'](_0x22a441['shift']());}}}(_0x2802,0x8e233));var __decorate=this&&this[_0x5a8a67(0x133)]||function(_0x1e037f,_0x3593ed,_0x366363,_0x10f238){const _0x438ad0=_0x5a8a67;var _0x4abb81=arguments[_0x438ad0(0x130)],_0x4d0168=_0x4abb81<0x3?_0x3593ed:_0x10f238===null?_0x10f238=Object[_0x438ad0(0x162)](_0x3593ed,_0x366363):_0x10f238,_0x1c6c24;if(typeof Reflect===_0x438ad0(0x122)&&typeof Reflect[_0x438ad0(0x141)]===_0x438ad0(0x173))_0x4d0168=Reflect[_0x438ad0(0x141)](_0x1e037f,_0x3593ed,_0x366363,_0x10f238);else{for(var _0x5aac58=_0x1e037f[_0x438ad0(0x130)]-0x1;_0x5aac58>=0x0;_0x5aac58--)if(_0x1c6c24=_0x1e037f[_0x5aac58])_0x4d0168=(_0x4abb81<0x3?_0x1c6c24(_0x4d0168):_0x4abb81>0x3?_0x1c6c24(_0x3593ed,_0x366363,_0x4d0168):_0x1c6c24(_0x3593ed,_0x366363))||_0x4d0168;}return _0x4abb81>0x3&&_0x4d0168&&Object[_0x438ad0(0xfb)](_0x3593ed,_0x366363,_0x4d0168),_0x4d0168;},__metadata=this&&this[_0x5a8a67(0x168)]||function(_0x52ccc6,_0x557a32){const _0x73526=_0x5a8a67;if(typeof Reflect==='object'&&typeof Reflect['metadata']===_0x73526(0x173))return Reflect[_0x73526(0x14c)](_0x52ccc6,_0x557a32);};Object[_0x5a8a67(0xfb)](exports,_0x5a8a67(0x156),{'value':!![]}),exports[_0x5a8a67(0x164)]=void 0x0;const utils_1=require(_0x5a8a67(0x10b)),common_1=require(_0x5a8a67(0x12b)),ALIOSS=require(_0x5a8a67(0x10e)),axios_1=require(_0x5a8a67(0x120)),TENCENTCOS=require(_0x5a8a67(0x15c)),FormData=require('form-data'),fs_1=require('fs'),mime=require(_0x5a8a67(0x17a)),path=require('path'),streamToBuffer=require('stream-to-buffer'),globalConfig_service_1=require(_0x5a8a67(0x116)),blacklist=[_0x5a8a67(0x171),'sh','bat','js',_0x5a8a67(0x121),'py'];let UploadService=class UploadService{constructor(_0x25d3d8){const _0xbe770a=_0x5a8a67;this[_0xbe770a(0x10c)]=_0x25d3d8;}['onModuleInit'](){}async['uploadFile'](_0x349bb2,_0x2f4d77='others'){const _0x2d78ed=_0x5a8a67,{buffer:_0x198814,mimetype:_0x51b3b1}=_0x349bb2;process[_0x2d78ed(0x161)][_0x2d78ed(0x15b)]===_0x2d78ed(0x131)&&(_0x2f4d77=_0x2d78ed(0x12d)+_0x2f4d77);const _0x4f929a=mime['extension'](_0x51b3b1)||'';!_0x4f929a&&common_1[_0x2d78ed(0x170)][_0x2d78ed(0x101)](_0x2d78ed(0x139),_0x2d78ed(0x164));if(blacklist['includes'](_0x4f929a[_0x2d78ed(0x13b)]())){common_1[_0x2d78ed(0x170)][_0x2d78ed(0x101)](_0x2d78ed(0x15a),_0x2d78ed(0x164));throw new Error('不允许上传此类型的文件');}const _0x1a396e=new Date(),_0xd3775=_0x1a396e['getTime'](),_0x1249f8=Math[_0x2d78ed(0x14f)]()[_0x2d78ed(0x123)](0x24)[_0x2d78ed(0x104)](0x2,0x6),_0x10ee18=_0xd3775+'_'+_0x1249f8+'.'+_0x4f929a,{tencentCosStatus:tencentCosStatus=0x0,aliOssStatus:aliOssStatus=0x0,cheveretoStatus:cheveretoStatus=0x0,localStorageStatus:localStorageStatus=0x0}=await this[_0x2d78ed(0x10c)][_0x2d78ed(0x125)]([_0x2d78ed(0x169),_0x2d78ed(0x149),_0x2d78ed(0x135),_0x2d78ed(0x15d)]);common_1[_0x2d78ed(0x170)][_0x2d78ed(0x177)](_0x2d78ed(0xf9)+localStorageStatus+',\x20'+tencentCosStatus+',\x20阿里云:\x20'+aliOssStatus+_0x2d78ed(0x157)+cheveretoStatus,'UploadService');if(!Number(tencentCosStatus)&&!Number(aliOssStatus)&&!Number(cheveretoStatus)&&!Number(localStorageStatus)){common_1[_0x2d78ed(0x170)]['error'](_0x2d78ed(0x13a),_0x2d78ed(0x164));throw new common_1[(_0x2d78ed(0x13c))](_0x2d78ed(0x16b),common_1['HttpStatus'][_0x2d78ed(0x154)]);}try{if(Number(localStorageStatus)){common_1[_0x2d78ed(0x170)][_0x2d78ed(0x177)](_0x2d78ed(0xff),_0x2d78ed(0x164));const _0x228e7b=await this[_0x2d78ed(0x17c)]({'filename':_0x10ee18,'buffer':_0x198814,'dir':_0x2f4d77});return common_1[_0x2d78ed(0x170)]['log']('文件已上传到本地存储。访问\x20URL:\x20'+_0x228e7b,'UploadService'),_0x228e7b;}if(Number(tencentCosStatus)){common_1[_0x2d78ed(0x170)][_0x2d78ed(0x177)]('使用腾讯云\x20COS\x20上传文件','UploadService');const _0x4c3c41=await this[_0x2d78ed(0x118)]({'filename':_0x10ee18,'buffer':_0x198814,'dir':_0x2f4d77});return common_1[_0x2d78ed(0x170)][_0x2d78ed(0x177)](_0x2d78ed(0x136)+_0x4c3c41,_0x2d78ed(0x164)),_0x4c3c41;}if(Number(aliOssStatus)){common_1[_0x2d78ed(0x170)][_0x2d78ed(0x177)](_0x2d78ed(0x153),_0x2d78ed(0x164));const _0x470f19=await this[_0x2d78ed(0x150)]({'filename':_0x10ee18,'buffer':_0x198814,'dir':_0x2f4d77});return common_1[_0x2d78ed(0x170)][_0x2d78ed(0x177)]('文件已上传到阿里云\x20OSS。访问\x20URL:\x20'+_0x470f19,_0x2d78ed(0x164)),_0x470f19;}if(Number(cheveretoStatus)){common_1[_0x2d78ed(0x170)][_0x2d78ed(0x177)](_0x2d78ed(0x16e),_0x2d78ed(0x164));const _0x5a2a2f=await this[_0x2d78ed(0x128)]({'filename':_0x10ee18,'buffer':_0x198814['toString'](_0x2d78ed(0x17e))});return common_1[_0x2d78ed(0x170)][_0x2d78ed(0x177)]('文件已上传到\x20Chevereto。访问\x20URL:\x20'+_0x5a2a2f,_0x2d78ed(0x164)),_0x5a2a2f;}}catch(_0x39c41c){common_1[_0x2d78ed(0x170)]['error'](_0x2d78ed(0x147)+_0x39c41c[_0x2d78ed(0x105)],'UploadService');throw _0x39c41c;}}async[_0x5a8a67(0x12e)](){const _0x5ee6e1=_0x5a8a67,{tencentCosStatus:tencentCosStatus=0x0,aliOssStatus:aliOssStatus=0x0,cheveretoStatus:cheveretoStatus=0x0}=await this[_0x5ee6e1(0x10c)]['getConfigs'](['tencentCosStatus',_0x5ee6e1(0x149),_0x5ee6e1(0x135)]);if(Number(tencentCosStatus))return _0x5ee6e1(0x167);if(Number(aliOssStatus))return'ali';if(Number(cheveretoStatus))return _0x5ee6e1(0x16a);}async[_0x5a8a67(0x15f)]({url:_0xe4f218,dir:dir=_0x5a8a67(0x137)}){const _0x235d89=_0x5a8a67;process[_0x235d89(0x161)][_0x235d89(0x15b)]===_0x235d89(0x131)&&(dir=_0x235d89(0x12d)+dir);const {buffer:_0x807d9a,mimeType:_0x1d7652}=await this[_0x235d89(0x14b)](_0xe4f218);return await this[_0x235d89(0x17b)]({'buffer':_0x807d9a,'mimetype':_0x1d7652},dir);}async[_0x5a8a67(0x118)]({filename:_0x21b1e2,buffer:_0x5f1335,dir:_0x6f75b3}){const _0x387952=_0x5a8a67,{Bucket:_0x510e5b,Region:_0x1ed0e3,SecretId:_0x2fd9db,SecretKey:_0xbddc09}=await this[_0x387952(0x11a)](_0x387952(0x167));this['tencentCos']=new TENCENTCOS({'SecretId':_0x2fd9db,'SecretKey':_0xbddc09,'FileParallelLimit':0xa});try{return new Promise(async(_0x116bcf,_0x5532ef)=>{const _0x3619c1=_0x387952;this[_0x3619c1(0x11c)][_0x3619c1(0x15e)]({'Bucket':(0x0,utils_1[_0x3619c1(0x112)])(_0x510e5b),'Region':(0x0,utils_1[_0x3619c1(0x112)])(_0x1ed0e3),'Key':_0x6f75b3+'/'+_0x21b1e2,'StorageClass':_0x3619c1(0x159),'Body':_0x5f1335},async(_0x455dea,_0x1fc405)=>{const _0x35679d=_0x3619c1;if(_0x455dea)return console[_0x35679d(0x177)](_0x35679d(0x113),_0x455dea),_0x5532ef(_0x455dea);let _0x386f8b=_0x1fc405['Location'][_0x35679d(0x114)](/^(http:\/\/|https:\/\/|\/\/|)(.*)/,_0x35679d(0x163));const {acceleratedDomain:_0x10efe4}=await this[_0x35679d(0x11a)](_0x35679d(0x167));return _0x10efe4&&(_0x386f8b=_0x386f8b[_0x35679d(0x114)](/^(https:\/\/[^/]+)(\/.*)$/,'https://'+_0x10efe4+'$2'),console[_0x35679d(0x177)](_0x35679d(0x126),_0x386f8b)),_0x116bcf(_0x386f8b);});});}catch(_0x11214a){console['log'](_0x387952(0x11d),_0x11214a);throw new common_1[(_0x387952(0x13c))](_0x387952(0xfe),common_1['HttpStatus'][_0x387952(0x154)]);}}async[_0x5a8a67(0x150)]({filename:_0x89bd03,buffer:_0x27623e,dir:_0x673452}){const _0xc7b7dc=_0x5a8a67,{region:_0x54cdef,bucket:_0x11291a,accessKeyId:_0x19187f,accessKeySecret:_0x3c5d08}=await this['getUploadConfig'](_0xc7b7dc(0x144)),_0x23ac70=new ALIOSS({'region':(0x0,utils_1[_0xc7b7dc(0x112)])(_0x54cdef),'accessKeyId':_0x19187f,'accessKeySecret':_0x3c5d08,'bucket':(0x0,utils_1['removeSpecialCharacters'])(_0x11291a)});try{return console[_0xc7b7dc(0x177)]('ali\x20开始上传'),new Promise((_0x20df37,_0x2a2e4a)=>{const _0x984288=_0xc7b7dc;_0x23ac70[_0x984288(0xfd)](_0x673452+'/'+_0x89bd03,_0x27623e)[_0x984288(0x12a)](async _0x4385e8=>{const _0x1f939d=_0x984288,{acceleratedDomain:_0x37e802}=await this[_0x1f939d(0x11a)](_0x1f939d(0x144));_0x37e802&&(_0x4385e8[_0x1f939d(0x148)]=_0x4385e8[_0x1f939d(0x148)][_0x1f939d(0x114)](/^(https:\/\/[^/]+)(\/.*)$/,_0x1f939d(0x132)+_0x37e802+'$2'),console[_0x1f939d(0x177)](_0x1f939d(0x126),_0x4385e8['url'])),_0x20df37(_0x4385e8['url']);})[_0x984288(0x178)](_0x13bfd5=>{_0x2a2e4a(_0x13bfd5);});});}catch(_0x56d779){throw new common_1[(_0xc7b7dc(0x13c))]('上传图片失败[ali]',common_1[_0xc7b7dc(0x143)]['BAD_REQUEST']);}}async[_0x5a8a67(0x17c)]({filename:_0x43f46a,buffer:_0x59fca6,dir:dir=_0x5a8a67(0x137)}){const _0x29db87=_0x5a8a67,_0x5138bf=path[_0x29db87(0x140)](dir)['replace'](/^(\.\.(\/|\\|$))+/,''),_0x495085=path[_0x29db87(0x10a)](_0x43f46a),_0x410fcb=process[_0x29db87(0x127)](),_0x29d6bc=path['join'](_0x410fcb,'public','file',_0x5138bf),_0x2e7906=path['join'](_0x29d6bc,_0x495085);if(!_0x2e7906[_0x29db87(0x12f)](path[_0x29db87(0x14e)](_0x410fcb,_0x29db87(0x176),_0x29db87(0x14d))))throw new Error(_0x29db87(0xfa));try{await fs_1['promises']['mkdir'](_0x29d6bc,{'recursive':!![]});}catch(_0x4ef8ac){common_1['Logger']['error'](_0x29db87(0x16c)+_0x29d6bc,_0x4ef8ac);throw _0x4ef8ac;}try{await fs_1[_0x29db87(0x175)]['writeFile'](_0x2e7906,_0x59fca6,{'mode':0x124});}catch(_0x3de494){common_1[_0x29db87(0x170)][_0x29db87(0x101)](_0x29db87(0x102)+_0x2e7906,_0x3de494);throw _0x3de494;}let _0x58d673=_0x29db87(0x158)+_0x5138bf+'/'+_0x495085;const _0x5af4c8=await this[_0x29db87(0x10c)][_0x29db87(0x125)]([_0x29db87(0x151)]);if(_0x5af4c8){const _0x5d72f1=(0x0,utils_1[_0x29db87(0x108)])(_0x5af4c8);_0x58d673=_0x5d72f1+'/'+_0x58d673;}return _0x58d673;}async[_0x5a8a67(0x128)]({filename:filename='',buffer:_0x1b224d}){const _0x117f0c=_0x5a8a67;var _0x18e1f8;const {key:_0x3256c0,uploadPath:_0x1dcd8f}=await this[_0x117f0c(0x11a)](_0x117f0c(0x16a));let _0x404187=_0x1dcd8f[_0x117f0c(0x155)]('/')?_0x1dcd8f[_0x117f0c(0x119)](0x0,-0x1):_0x1dcd8f;const _0x484ded=new FormData(),_0x587aa8=_0x1b224d['toString'](_0x117f0c(0x17e));_0x484ded[_0x117f0c(0x172)]('source',_0x587aa8),_0x484ded[_0x117f0c(0x172)]('key',_0x3256c0),_0x484ded[_0x117f0c(0x172)](_0x117f0c(0x138),filename);try{const _0x3fef74=await axios_1[_0x117f0c(0x110)][_0x117f0c(0x103)](_0x404187,_0x484ded,{'headers':{'X-API-Key':_0x3256c0}});if((_0x3fef74===null||_0x3fef74===void 0x0?void 0x0:_0x3fef74[_0x117f0c(0x174)])===0xc8)return _0x3fef74['data'][_0x117f0c(0x117)]['url'];else console[_0x117f0c(0x177)](_0x117f0c(0x11f),_0x3fef74===null||_0x3fef74===void 0x0?void 0x0:_0x3fef74[_0x117f0c(0x13f)]['code'],_0x3fef74===null||_0x3fef74===void 0x0?void 0x0:_0x3fef74['data'][_0x117f0c(0x101)]['message']),common_1[_0x117f0c(0x170)][_0x117f0c(0x101)](_0x117f0c(0x134),JSON['stringify'](_0x3fef74[_0x117f0c(0x13f)]));}catch(_0x145ffd){console[_0x117f0c(0x177)](_0x117f0c(0x11d),_0x145ffd);throw new common_1[(_0x117f0c(0x13c))](_0x117f0c(0x160)+((_0x18e1f8=_0x145ffd[_0x117f0c(0x13d)])===null||_0x18e1f8===void 0x0?void 0x0:_0x18e1f8['data'][_0x117f0c(0x101)][_0x117f0c(0x105)]),common_1['HttpStatus']['BAD_REQUEST']);}}async['getUploadConfig'](_0x47fa41){const _0x2e99f2=_0x5a8a67;if(_0x47fa41==='ali'){const {aliOssRegion:_0x54e284,aliOssBucket:_0x5f07fc,aliOssAccessKeyId:_0x302148,aliOssAccessKeySecret:_0x3b9735,aliOssAcceleratedDomain:_0x193ce3}=await this['globalConfigService']['getConfigs'](['aliOssRegion',_0x2e99f2(0x142),'aliOssAccessKeyId',_0x2e99f2(0x129),'acceleratedDomain']);return{'region':_0x54e284,'bucket':_0x5f07fc,'accessKeyId':_0x302148,'accessKeySecret':_0x3b9735,'acceleratedDomain':_0x193ce3};}if(_0x47fa41===_0x2e99f2(0x167)){const {cosBucket:_0x3f7430,cosRegion:_0x383e22,cosSecretId:_0xb500af,cosSecretKey:_0x1d5298,tencentCosAcceleratedDomain:_0x5907e3}=await this[_0x2e99f2(0x10c)][_0x2e99f2(0x125)]([_0x2e99f2(0x13e),_0x2e99f2(0x165),_0x2e99f2(0x11b),_0x2e99f2(0x145),_0x2e99f2(0x106)]);return{'Bucket':_0x3f7430,'Region':_0x383e22,'SecretId':_0xb500af,'SecretKey':_0x1d5298,'acceleratedDomain':_0x5907e3};}if(_0x47fa41==='chevereto'){const {cheveretoKey:_0x5af06c,cheveretoUploadPath:_0x56d2f7}=await this[_0x2e99f2(0x10c)]['getConfigs']([_0x2e99f2(0x107),'cheveretoUploadPath']);return{'key':_0x5af06c,'uploadPath':_0x56d2f7};}}async[_0x5a8a67(0x14b)](_0x5686a5){const _0x17dccc=_0x5a8a67,_0x14e82c=await axios_1[_0x17dccc(0x110)][_0x17dccc(0x16d)](_0x5686a5,{'responseType':_0x17dccc(0x146)}),_0x503343=await new Promise((_0x14cd8a,_0x157334)=>{const _0x82ab19=_0x17dccc;streamToBuffer(_0x14e82c[_0x82ab19(0x13f)],(_0x59847b,_0x51e073)=>{const _0x35e2e9=_0x82ab19;_0x59847b?_0x157334(new common_1[(_0x35e2e9(0x13c))](_0x35e2e9(0x12c),common_1[_0x35e2e9(0x143)]['BAD_REQUEST'])):_0x14cd8a(_0x51e073);});}),_0x38d482=_0x14e82c[_0x17dccc(0xfc)][_0x17dccc(0x115)];return{'buffer':_0x503343,'mimeType':_0x38d482};}};function _0x2802(){const _0x77db23=['不允许上传此类型的文件','ISDEV','cos-nodejs-sdk-v5','localStorageStatus','putObject','uploadFileFromUrl','上传图片失败[Chevereto|buffer]\x20-->\x20','env','getOwnPropertyDescriptor','https://$2','UploadService','cosRegion','4368040ROLfBC','tencent','__metadata','tencentCosStatus','chevereto','请先前往后台配置上传图片的方式','创建目录失败:\x20','get','使用\x20Chevereto\x20上传文件','1140681xERRji','Logger','exe','append','function','status','promises','public','log','catch','GlobalConfigService','mime-types','uploadFile','uploadFileToLocal','30300684ueqwfE','base64','5Fhnbjo','上传配置状态\x20-\x20腾讯云:本地存储:\x20','非法路径，禁止访问目录之外的位置','defineProperty','headers','put','上传图片失败[ten]','使用本地存储上传文件','13zRMAGj','error','文件保存失败:\x20','post','substring','message','tencentCosAcceleratedDomain','cheveretoKey','formatUrl','8980qydWwd','basename','../../common/utils','globalConfigService','4855062SEDvpe','ali-oss','3pAAYvk','default','1927252xGSGZK','removeSpecialCharacters','cos\x20->\x20err:\x20','replace','content-type','../globalConfig/globalConfig.service','image','uploadFileByTencentCos','slice','getUploadConfig','cosSecretId','tencentCos','error:\x20','2rxeHfl','Chevereto\x20--->\x20res','axios','php','object','toString','9657lrjEHe','getConfigs','当前已开启全球加速----------------->','cwd','uploadFileByChevereto','aliOssAccessKeySecret','then','@nestjs/common','获取图片资源失败，请重新试试吧！','dev/','getUploadType','startsWith','length','TRUE','https://','__decorate','上传图片失败[Chevereto]','cheveretoStatus','文件已上传到腾讯云\x20COS。访问\x20URL:\x20','others','title','无法识别文件类型，请检查文件','未配置任何上传方式','toLowerCase','HttpException','response','cosBucket','data','normalize','decorate','aliOssBucket','HttpStatus','ali','cosSecretKey','stream','上传失败:\x20','url','aliOssStatus','6419732kxtwCj','getBufferFromUrl','metadata','file','join','random','uploadFileByAliOss','siteUrl','7jOYlOX','使用阿里云\x20OSS\x20上传文件','BAD_REQUEST','endsWith','__esModule',',\x20Chevereto:\x20','file/','STANDARD'];_0x2802=function(){return _0x77db23;};return _0x2802();}function _0x5900(_0x2f2e88,_0x131066){const _0x2802c1=_0x2802();return _0x5900=function(_0x5900b3,_0x85b189){_0x5900b3=_0x5900b3-0xf8;let _0x56c57e=_0x2802c1[_0x5900b3];return _0x56c57e;},_0x5900(_0x2f2e88,_0x131066);}UploadService=__decorate([(0x0,common_1['Injectable'])(),__metadata('design:paramtypes',[globalConfig_service_1[_0x5a8a67(0x179)]])],UploadService),exports[_0x5a8a67(0x164)]=UploadService;