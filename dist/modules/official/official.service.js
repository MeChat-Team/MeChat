'use strict';const _0x1006a4=_0x6455;function _0x6455(_0x438033,_0x3ba1f3){const _0x337e6c=_0x337e();return _0x6455=function(_0x64556c,_0x3bf657){_0x64556c=_0x64556c-0x16f;let _0x1b3338=_0x337e6c[_0x64556c];return _0x1b3338;},_0x6455(_0x438033,_0x3ba1f3);}(function(_0x33e9ff,_0x79f3f0){const _0x18b3c4=_0x6455,_0x1adf10=_0x33e9ff();while(!![]){try{const _0x2e1923=parseInt(_0x18b3c4(0x178))/0x1*(-parseInt(_0x18b3c4(0x1a6))/0x2)+parseInt(_0x18b3c4(0x192))/0x3+-parseInt(_0x18b3c4(0x18a))/0x4+-parseInt(_0x18b3c4(0x17a))/0x5+-parseInt(_0x18b3c4(0x1c3))/0x6+parseInt(_0x18b3c4(0x18b))/0x7+parseInt(_0x18b3c4(0x1d0))/0x8;if(_0x2e1923===_0x79f3f0)break;else _0x1adf10['push'](_0x1adf10['shift']());}catch(_0x5587a4){_0x1adf10['push'](_0x1adf10['shift']());}}}(_0x337e,0x38dde));var __decorate=this&&this[_0x1006a4(0x182)]||function(_0x6fea41,_0x45ce36,_0x163bc9,_0x13a0fa){const _0x5437b0=_0x1006a4;var _0x9e0320=arguments['length'],_0xec5f0f=_0x9e0320<0x3?_0x45ce36:_0x13a0fa===null?_0x13a0fa=Object[_0x5437b0(0x1bc)](_0x45ce36,_0x163bc9):_0x13a0fa,_0x5c7d5b;if(typeof Reflect===_0x5437b0(0x19f)&&typeof Reflect['decorate']===_0x5437b0(0x1d2))_0xec5f0f=Reflect['decorate'](_0x6fea41,_0x45ce36,_0x163bc9,_0x13a0fa);else{for(var _0x41c3d8=_0x6fea41['length']-0x1;_0x41c3d8>=0x0;_0x41c3d8--)if(_0x5c7d5b=_0x6fea41[_0x41c3d8])_0xec5f0f=(_0x9e0320<0x3?_0x5c7d5b(_0xec5f0f):_0x9e0320>0x3?_0x5c7d5b(_0x45ce36,_0x163bc9,_0xec5f0f):_0x5c7d5b(_0x45ce36,_0x163bc9))||_0xec5f0f;}return _0x9e0320>0x3&&_0xec5f0f&&Object['defineProperty'](_0x45ce36,_0x163bc9,_0xec5f0f),_0xec5f0f;},__metadata=this&&this[_0x1006a4(0x1bd)]||function(_0x1650df,_0x12598a){const _0x308ef6=_0x1006a4;if(typeof Reflect===_0x308ef6(0x19f)&&typeof Reflect[_0x308ef6(0x1c4)]==='function')return Reflect[_0x308ef6(0x1c4)](_0x1650df,_0x12598a);};function _0x337e(){const _0x198517=['1169205mGgXbl','QR_STR_SCENE',']]></ToUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<FromUserName><![CDATA[','crypto','env','sha1','weChatApiUrl','&timestamp=','chatgptService','digest','getRedirectUrl','hex','/connect/oauth2/authorize?appid=','object','join','design:paramtypes','sceneStrMap','defineProperty','split',']]></FromUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<CreateTime>','114jBlaPD','回跳跳转地址:\x20','HttpStatus','getQRSceneStr','处理扫码事件时发生错误','toFixed','verify','../chat/chat.service','/sns/oauth2/access_token?appid=','Error\x20in\x20scan\x20method:','weChatOpenUrl','onModuleInit','/cgi-bin/qrcode/create?access_token=','\x0a\x20\x20\x20\x20<xml>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<ToUserName><![CDATA[','getQRCodeTicket','authService','getUserFromOpenId','post','&secret=','autoreplyService','message','非法参数:\x20未找到的\x20sceneStr\x20','getOwnPropertyDescriptor','__metadata','loginBySceneStr','fromusername','UserService','OfficialService','log','422826oiZWpt','metadata','getTime','&grant_type=authorization_code','loginByOpenId','getUserOpenId','genXmlMsg','scanBindWx','globalConfigService','formatUrl','./../user/user.service','getConfigs','update','5450080toiaXr','wechatAccessToken','function','./../globalConfig/globalConfig.service','fetchQRCodeTicket','officialAutoReplyText','jsapiTicket:\x20','getJsapiTicket','default','&url=','&noncestr=','Stack\x20trace:','wechatOfficialAppId','getUserById','Logger','getQRSceneStrByBind',']]></Content>\x0a\x20\x20\x20\x20</xml>','user',',\x20sceneStr:\x20','stack','appId:\x20','now','由于公众号的回复限制、过长的问题我们可能无法回复、您可以前往我们的官方站点享受更加完善的服务、如果您有更多问题、欢迎像我提问！','ChatService','userService','7114nNrFUH','./../autoreply/autoreply.service','1955425YqFaOi','tousername','../../common/utils','wechatOfficialToken','get','createRandomNonceStr','str:\x20','AuthService','__decorate','jsapi_ticket=','非法参数','scanedSceneStrMap','HttpException','Injectable','</CreateTime>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<MsgType><![CDATA[text]]></MsgType>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<Content><![CDATA[','bindWxBySceneStr','700820FLJqMq','1429330sggKKC','getWechatAccessToken','No\x20user\x20found','请求超时','BAD_REQUEST','https://api.weixin.qq.com','error'];_0x337e=function(){return _0x198517;};return _0x337e();}Object[_0x1006a4(0x1a3)](exports,'__esModule',{'value':!![]}),exports['OfficialService']=void 0x0;const utils_1=require(_0x1006a4(0x17c)),common_1=require('@nestjs/common'),axios_1=require('axios'),crypto=require(_0x1006a4(0x195)),chat_service_1=require(_0x1006a4(0x1ad)),auth_service_1=require('./../auth/auth.service'),autoreply_service_1=require(_0x1006a4(0x179)),globalConfig_service_1=require(_0x1006a4(0x1d3)),user_service_1=require(_0x1006a4(0x1cd));let OfficialService=class OfficialService{constructor(_0x5accd2,_0x54ec3c,_0x14802f,_0x18604b,_0x9b0d0e){const _0x10ca4a=_0x1006a4;this[_0x10ca4a(0x1b9)]=_0x5accd2,this[_0x10ca4a(0x177)]=_0x54ec3c,this[_0x10ca4a(0x1b5)]=_0x14802f,this[_0x10ca4a(0x1cb)]=_0x18604b,this[_0x10ca4a(0x19a)]=_0x9b0d0e,this[_0x10ca4a(0x1a2)]={},this['scanedSceneStrMap']={};}async[_0x1006a4(0x1b1)](){const _0x19453c=_0x1006a4;await this['globalConfigService'][_0x19453c(0x18c)](!![]);}async[_0x1006a4(0x1a9)](){let _0x4ffcfc=(0x0,utils_1['createRandomNonceStr'])(0x20);return this['sceneStrMap'][_0x4ffcfc]=!![],_0x4ffcfc;}async[_0x1006a4(0x1df)](_0x42d1af){const _0x3ed3d1=_0x1006a4,{id:_0x12d936}=_0x42d1af[_0x3ed3d1(0x170)],_0x52e081=(0x0,utils_1[_0x3ed3d1(0x17f)])(0x20)+'/'+_0x12d936;return this['sceneStrMap'][_0x52e081]=!![],_0x52e081;}async[_0x1006a4(0x1b4)](_0x4f938e){return this['fetchQRCodeTicket'](_0x4f938e);}async[_0x1006a4(0x19c)](_0x97f4e8){const _0x54577d=_0x1006a4,_0x419c87=await this[_0x54577d(0x1cb)][_0x54577d(0x1ce)](['wechatOfficialAppId']),_0x594759=(0x0,utils_1[_0x54577d(0x1cc)])(process[_0x54577d(0x196)][_0x54577d(0x1b0)]||'https://open.weixin.qq.com'),_0x294a46=_0x594759+_0x54577d(0x19e)+_0x419c87+'&redirect_uri='+encodeURIComponent(_0x97f4e8)+'&response_type=code&scope=snsapi_base&state=weChatLogin#wechat_redirect';return console[_0x54577d(0x1c2)](_0x54577d(0x1a7),_0x294a46),_0x294a46;}async[_0x1006a4(0x1d7)](_0x31a538){const _0x1c2ee1=_0x1006a4,_0x10ce9f=(0x0,utils_1['createRandomNonceStr'])(0x20),_0x4058f3=(Date[_0x1c2ee1(0x174)]()/0x3e8)[_0x1c2ee1(0x1ab)](0x0),_0x13f007=await this[_0x1c2ee1(0x1cb)][_0x1c2ee1(0x1ce)](['wechatJsapiTicket']);console[_0x1c2ee1(0x1c2)](_0x1c2ee1(0x1d6),_0x13f007);const _0x2381a2=await this[_0x1c2ee1(0x1cb)][_0x1c2ee1(0x1ce)]([_0x1c2ee1(0x1dc)]);console['log'](_0x1c2ee1(0x173),_0x2381a2);const _0x8b4610=_0x1c2ee1(0x183)+_0x13f007+_0x1c2ee1(0x1da)+_0x10ce9f+_0x1c2ee1(0x199)+_0x4058f3+_0x1c2ee1(0x1d9)+_0x31a538;console[_0x1c2ee1(0x1c2)](_0x1c2ee1(0x180),_0x8b4610);const _0xcdee0a=this[_0x1c2ee1(0x197)](_0x8b4610);return{'appId':_0x2381a2,'nonceStr':_0x10ce9f,'timestamp':_0x4058f3,'signature':_0xcdee0a};}async[_0x1006a4(0x1d4)](_0x5af5b6){const _0x2f2215=_0x1006a4,_0x391b65=await this['globalConfigService'][_0x2f2215(0x1ce)]([_0x2f2215(0x1d1)]),_0x34ccd2=(0x0,utils_1[_0x2f2215(0x1cc)])(process[_0x2f2215(0x196)][_0x2f2215(0x198)]||'https://api.weixin.qq.com'),_0x205907={'action_name':_0x2f2215(0x193),'action_info':{'scene':{'scene_str':_0x5af5b6}}},_0x254a07=await axios_1[_0x2f2215(0x1d8)][_0x2f2215(0x1b7)](_0x34ccd2+_0x2f2215(0x1b2)+_0x391b65,_0x205907),{data:{errmsg:_0x21c8c4,ticket:_0x55869e}}=_0x254a07;if(_0x21c8c4)throw new common_1['HttpException'](_0x21c8c4,common_1[_0x2f2215(0x1a8)][_0x2f2215(0x18f)]);return _0x55869e;}async['loginByCode'](_0x6e74d8,_0x5d5f7e){const _0x5ac178=_0x1006a4,_0x771904=await this[_0x5ac178(0x1cb)][_0x5ac178(0x1ce)]([_0x5ac178(0x1dc)]),_0x4a4c71=await this[_0x5ac178(0x1cb)][_0x5ac178(0x1ce)](['wechatOfficialAppSecret']),_0x113f1c=(0x0,utils_1[_0x5ac178(0x1cc)])(process[_0x5ac178(0x196)][_0x5ac178(0x198)]||_0x5ac178(0x190)),_0x49dac0=await axios_1[_0x5ac178(0x1d8)][_0x5ac178(0x17e)](_0x113f1c+_0x5ac178(0x1ae)+_0x771904+_0x5ac178(0x1b8)+_0x4a4c71+'&code='+_0x5d5f7e+_0x5ac178(0x1c6)),{data:{errmsg:_0x49455e,openid:_0x1900f2}}=_0x49dac0;if(_0x49455e)throw new common_1[(_0x5ac178(0x186))](_0x49455e,common_1[_0x5ac178(0x1a8)]['BAD_REQUEST']);let _0x508763;return _0x508763=await this[_0x5ac178(0x177)][_0x5ac178(0x1c8)](_0x1900f2),!_0x508763&&(_0x508763=await this['userService'][_0x5ac178(0x1b6)](_0x1900f2)),this[_0x5ac178(0x1b5)][_0x5ac178(0x1c7)](_0x508763,_0x6e74d8);}async['scan'](_0x1c8d1e,_0x75396d){const _0x4c9a29=_0x1006a4;try{common_1[_0x4c9a29(0x1de)][_0x4c9a29(0x1c2)]('Scanning\x20with\x20openID:\x20'+_0x1c8d1e+_0x4c9a29(0x171)+_0x75396d,_0x4c9a29(0x1c1));if(!this[_0x4c9a29(0x1a2)][_0x75396d]){common_1['Logger'][_0x4c9a29(0x191)](_0x4c9a29(0x1bb)+_0x75396d);throw new common_1[(_0x4c9a29(0x186))](_0x4c9a29(0x184),common_1[_0x4c9a29(0x1a8)][_0x4c9a29(0x18f)]);}const _0x939b23=await this[_0x4c9a29(0x177)][_0x4c9a29(0x1b6)](_0x1c8d1e,_0x75396d);common_1[_0x4c9a29(0x1de)][_0x4c9a29(0x1c2)]('User\x20found:\x20'+(_0x939b23?_0x939b23['id']:_0x4c9a29(0x18d)),_0x4c9a29(0x1c1)),this[_0x4c9a29(0x185)][_0x75396d]=_0x939b23['id'];}catch(_0x36d7d4){common_1['Logger']['error'](_0x4c9a29(0x1af),_0x36d7d4[_0x4c9a29(0x1ba)]),common_1[_0x4c9a29(0x1de)][_0x4c9a29(0x191)](_0x4c9a29(0x1db),_0x36d7d4[_0x4c9a29(0x172)]);throw new common_1[(_0x4c9a29(0x186))](_0x4c9a29(0x1aa),common_1[_0x4c9a29(0x1a8)]['INTERNAL_SERVER_ERROR']);}}async[_0x1006a4(0x1be)](_0x138a67,_0x2ac70e){const _0x1175c2=_0x1006a4,{sceneStr:_0x40d423}=_0x2ac70e;if(!this[_0x1175c2(0x1a2)][_0x40d423])return;const _0x4c05a6=this[_0x1175c2(0x185)][_0x40d423];if(!_0x4c05a6)return'';const _0x1aabf2=await this['userService'][_0x1175c2(0x1dd)](_0x4c05a6);return delete this[_0x1175c2(0x185)][_0x40d423],this[_0x1175c2(0x1b5)]['loginByOpenId'](_0x1aabf2,_0x138a67);}async[_0x1006a4(0x1ca)](_0x32f8c9,_0x27c485){const _0x501b06=_0x1006a4;if(!this['sceneStrMap'][_0x27c485])throw new common_1['HttpException'](_0x501b06(0x184),common_1['HttpStatus']['BAD_REQUEST']);const _0x274800=_0x27c485[_0x501b06(0x1a4)]('/')[0x1],_0x35a264=await this['userService']['bindWx'](_0x32f8c9,_0x274800);this[_0x501b06(0x185)][_0x27c485]=_0x35a264;}async[_0x1006a4(0x189)](_0x126f00,_0x56b1e4){const _0x486f6c=_0x1006a4;if(!this['sceneStrMap'][_0x56b1e4])throw new common_1[(_0x486f6c(0x186))]('非法参数',common_1[_0x486f6c(0x1a8)]['BAD_REQUEST']);const {id:_0x5d9a14}=_0x126f00[_0x486f6c(0x170)],_0x88cb24=this[_0x486f6c(0x185)][_0x56b1e4];if(!_0x88cb24)return'';return delete this['scanedSceneStrMap'][_0x56b1e4],_0x88cb24;}async[_0x1006a4(0x1ac)](_0x21f7b9,_0x1f7383,_0x292c85){const _0x1b7abb=_0x1006a4,_0x29ef58=await this[_0x1b7abb(0x1cb)][_0x1b7abb(0x1ce)]([_0x1b7abb(0x17d)])||'';return await this[_0x1b7abb(0x197)]([_0x29ef58,_0x1f7383,_0x292c85]['sort']()[_0x1b7abb(0x1a0)](''))==_0x21f7b9;}[_0x1006a4(0x197)](_0x1d889f){const _0x298210=_0x1006a4;return crypto['createHash'](_0x298210(0x197))[_0x298210(0x1cf)](_0x1d889f)[_0x298210(0x19b)](_0x298210(0x19d));}async['genXmlMsgByConfig'](_0x3cc642,_0x2af8f8){const _0x45679e=_0x1006a4,_0x5da489=await this[_0x45679e(0x1cb)][_0x45679e(0x1ce)]([_0x2af8f8]);return this[_0x45679e(0x1c9)](_0x3cc642,_0x5da489);}async[_0x1006a4(0x1c9)](_0x595884,_0x139657){const _0x381841=_0x1006a4;return _0x381841(0x1b3)+_0x595884[_0x381841(0x1bf)][0x0]+_0x381841(0x194)+_0x595884[_0x381841(0x17b)][0x0]+_0x381841(0x1a5)+new Date()[_0x381841(0x1c5)]()+_0x381841(0x188)+_0x139657+_0x381841(0x16f);}async['aotoPlay'](_0x36beba){const _0x108baa=_0x1006a4,_0x371b37=new Promise((_0x1d455c,_0x3794dd)=>{setTimeout(()=>{const _0x47fb2f=_0x6455;_0x3794dd(new Error(_0x47fb2f(0x18e)));},0x12c0);});let _0x1d69a2=await this[_0x108baa(0x1cb)][_0x108baa(0x1ce)]([_0x108baa(0x1d5)])||_0x108baa(0x175);return _0x1d69a2;}};OfficialService=__decorate([(0x0,common_1[_0x1006a4(0x187)])(),__metadata(_0x1006a4(0x1a1),[autoreply_service_1['AutoreplyService'],user_service_1[_0x1006a4(0x1c0)],auth_service_1[_0x1006a4(0x181)],globalConfig_service_1['GlobalConfigService'],chat_service_1[_0x1006a4(0x176)]])],OfficialService),exports[_0x1006a4(0x1c1)]=OfficialService;