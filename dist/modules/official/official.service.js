'use strict';function _0x57bc(){const _0x4f5d09=['__esModule','design:paramtypes','fetchQRCodeTicket','bindWxBySceneStr','856LGRXLu','getTime','bindWx','https://open.weixin.qq.com','/sns/oauth2/access_token?appid=','defineProperty','loginByCode','非法参数','INTERNAL_SERVER_ERROR','getUserOpenId','createRandomNonceStr','sort','now','User\x20found:\x20','&grant_type=authorization_code','getConfigs','HttpStatus','get','function','createHash','2FZrVNL',']]></ToUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<FromUserName><![CDATA[','7300650ixuwGl','error','wechatOfficialAppId','6890LnlVyH','getUserById','scan','AutoreplyService','61039wqGWRY','crypto','log','env',']]></FromUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<CreateTime>','formatUrl','HttpException','post','globalConfigService','/connect/oauth2/authorize?appid=','No\x20user\x20found','join','default','BAD_REQUEST','41157CKRmBQ','str:\x20','6040148vjeidC','78xRveFF','./../auth/auth.service','ChatService','loginByOpenId','请求超时','getQRCodeTicket','\x0a\x20\x20\x20\x20<xml>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<ToUserName><![CDATA[','officialAutoReplyText','update','./../user/user.service','回跳跳转地址:\x20','AuthService','jsapiTicket:\x20',',\x20sceneStr:\x20','decorate','__metadata','onModuleInit','wechatJsapiTicket','wechatOfficialToken','https://api.weixin.qq.com','&secret=','split','fromusername','metadata','./../autoreply/autoreply.service','getQRSceneStr','/cgi-bin/qrcode/create?access_token=','Stack\x20trace:','message','user','userService','&redirect_uri=','@nestjs/common','appId:\x20','jsapi_ticket=','chatgptService','sha1','digest','weChatApiUrl','getOwnPropertyDescriptor','576078UbnGfw','QR_STR_SCENE','2115954cmRsrz','sceneStrMap','genXmlMsg','scanedSceneStrMap','Logger','../chat/chat.service','Scanning\x20with\x20openID:\x20','genXmlMsgByConfig','OfficialService','Injectable','axios','stack','object','getUserFromOpenId','&noncestr=','&response_type=code&scope=snsapi_base&state=weChatLogin#wechat_redirect','../../common/utils','__decorate','290689Atlvrf','weChatOpenUrl','处理扫码事件时发生错误','verify','&url=',']]></Content>\x0a\x20\x20\x20\x20</xml>','</CreateTime>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<MsgType><![CDATA[text]]></MsgType>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<Content><![CDATA[','getJsapiTicket','authService','&timestamp=','length'];_0x57bc=function(){return _0x4f5d09;};return _0x57bc();}function _0x2da4(_0x1a19e2,_0x349238){const _0x57bc7a=_0x57bc();return _0x2da4=function(_0x2da45c,_0x390a95){_0x2da45c=_0x2da45c-0xc7;let _0x3efed0=_0x57bc7a[_0x2da45c];return _0x3efed0;},_0x2da4(_0x1a19e2,_0x349238);}const _0x3e2509=_0x2da4;(function(_0x557b1a,_0x59724a){const _0x331b24=_0x2da4,_0x1ae71c=_0x557b1a();while(!![]){try{const _0x29275c=-parseInt(_0x331b24(0x105))/0x1*(parseInt(_0x331b24(0xce))/0x2)+parseInt(_0x331b24(0xd0))/0x3+-parseInt(_0x331b24(0x11e))/0x4+-parseInt(_0x331b24(0x107))/0x5+-parseInt(_0x331b24(0x11f))/0x6*(parseInt(_0x331b24(0xe2))/0x7)+-parseInt(_0x331b24(0xf1))/0x8*(-parseInt(_0x331b24(0x11c))/0x9)+parseInt(_0x331b24(0x10a))/0xa*(parseInt(_0x331b24(0x10e))/0xb);if(_0x29275c===_0x59724a)break;else _0x1ae71c['push'](_0x1ae71c['shift']());}catch(_0x18b8b6){_0x1ae71c['push'](_0x1ae71c['shift']());}}}(_0x57bc,0xe37d2));var __decorate=this&&this[_0x3e2509(0xe1)]||function(_0x12c866,_0x3df30c,_0x2ad294,_0x274527){const _0x4090b2=_0x3e2509;var _0x3bcc1a=arguments['length'],_0x10af8c=_0x3bcc1a<0x3?_0x3df30c:_0x274527===null?_0x274527=Object[_0x4090b2(0xcd)](_0x3df30c,_0x2ad294):_0x274527,_0x2d2ec9;if(typeof Reflect==='object'&&typeof Reflect[_0x4090b2(0x12d)]==='function')_0x10af8c=Reflect['decorate'](_0x12c866,_0x3df30c,_0x2ad294,_0x274527);else{for(var _0x592030=_0x12c866[_0x4090b2(0xec)]-0x1;_0x592030>=0x0;_0x592030--)if(_0x2d2ec9=_0x12c866[_0x592030])_0x10af8c=(_0x3bcc1a<0x3?_0x2d2ec9(_0x10af8c):_0x3bcc1a>0x3?_0x2d2ec9(_0x3df30c,_0x2ad294,_0x10af8c):_0x2d2ec9(_0x3df30c,_0x2ad294))||_0x10af8c;}return _0x3bcc1a>0x3&&_0x10af8c&&Object[_0x4090b2(0xf6)](_0x3df30c,_0x2ad294,_0x10af8c),_0x10af8c;},__metadata=this&&this[_0x3e2509(0x12e)]||function(_0x51c360,_0x561544){const _0x41f11b=_0x3e2509;if(typeof Reflect===_0x41f11b(0xdc)&&typeof Reflect[_0x41f11b(0x136)]===_0x41f11b(0x103))return Reflect[_0x41f11b(0x136)](_0x51c360,_0x561544);};Object[_0x3e2509(0xf6)](exports,_0x3e2509(0xed),{'value':!![]}),exports[_0x3e2509(0xd8)]=void 0x0;const utils_1=require(_0x3e2509(0xe0)),common_1=require(_0x3e2509(0x13f)),axios_1=require(_0x3e2509(0xda)),crypto=require(_0x3e2509(0x10f)),chat_service_1=require(_0x3e2509(0xd5)),auth_service_1=require(_0x3e2509(0x120)),autoreply_service_1=require(_0x3e2509(0x137)),globalConfig_service_1=require('./../globalConfig/globalConfig.service'),user_service_1=require(_0x3e2509(0x128));let OfficialService=class OfficialService{constructor(_0x14e2be,_0x586452,_0x3d4aa2,_0x54361f,_0x4bb432){const _0x329705=_0x3e2509;this['autoreplyService']=_0x14e2be,this[_0x329705(0x13d)]=_0x586452,this['authService']=_0x3d4aa2,this[_0x329705(0x116)]=_0x54361f,this[_0x329705(0xc9)]=_0x4bb432,this[_0x329705(0xd1)]={},this['scanedSceneStrMap']={};}async[_0x3e2509(0x12f)](){const _0x12f935=_0x3e2509;await this[_0x12f935(0x116)]['getWechatAccessToken'](!![]);}async[_0x3e2509(0x138)](){const _0x9b1bc7=_0x3e2509;let _0x2e2015=(0x0,utils_1[_0x9b1bc7(0xfb)])(0x20);return this[_0x9b1bc7(0xd1)][_0x2e2015]=!![],_0x2e2015;}async['getQRSceneStrByBind'](_0x4bc3f9){const _0x34f9c3=_0x3e2509,{id:_0x37549a}=_0x4bc3f9[_0x34f9c3(0x13c)],_0xcb405b=(0x0,utils_1[_0x34f9c3(0xfb)])(0x20)+'/'+_0x37549a;return this[_0x34f9c3(0xd1)][_0xcb405b]=!![],_0xcb405b;}async[_0x3e2509(0x124)](_0x24df11){const _0x328757=_0x3e2509;return this[_0x328757(0xef)](_0x24df11);}async['getRedirectUrl'](_0x42de49){const _0x425587=_0x3e2509,_0x4d3e9d=await this[_0x425587(0x116)][_0x425587(0x100)](['wechatOfficialAppId']),_0x17cc9f=(0x0,utils_1['formatUrl'])(process[_0x425587(0x111)][_0x425587(0xe3)]||_0x425587(0xf4)),_0x1b9497=_0x17cc9f+_0x425587(0x117)+_0x4d3e9d+_0x425587(0x13e)+encodeURIComponent(_0x42de49)+_0x425587(0xdf);return console[_0x425587(0x110)](_0x425587(0x129),_0x1b9497),_0x1b9497;}async[_0x3e2509(0xe9)](_0x424d75){const _0x3d42fb=_0x3e2509,_0x1fbd15=(0x0,utils_1[_0x3d42fb(0xfb)])(0x20),_0x205495=(Date[_0x3d42fb(0xfd)]()/0x3e8)['toFixed'](0x0),_0x55771c=await this['globalConfigService'][_0x3d42fb(0x100)]([_0x3d42fb(0x130)]);console[_0x3d42fb(0x110)](_0x3d42fb(0x12b),_0x55771c);const _0x2544de=await this['globalConfigService']['getConfigs']([_0x3d42fb(0x109)]);console['log'](_0x3d42fb(0xc7),_0x2544de);const _0x414f3c=_0x3d42fb(0xc8)+_0x55771c+_0x3d42fb(0xde)+_0x1fbd15+_0x3d42fb(0xeb)+_0x205495+_0x3d42fb(0xe6)+_0x424d75;console[_0x3d42fb(0x110)](_0x3d42fb(0x11d),_0x414f3c);const _0x4d12fd=this['sha1'](_0x414f3c);return{'appId':_0x2544de,'nonceStr':_0x1fbd15,'timestamp':_0x205495,'signature':_0x4d12fd};}async[_0x3e2509(0xef)](_0x18c71c){const _0x71d492=_0x3e2509,_0x4b1fee=await this[_0x71d492(0x116)][_0x71d492(0x100)](['wechatAccessToken']),_0x2d7fee=(0x0,utils_1[_0x71d492(0x113)])(process[_0x71d492(0x111)]['weChatApiUrl']||_0x71d492(0x132)),_0x1ab519={'action_name':_0x71d492(0xcf),'action_info':{'scene':{'scene_str':_0x18c71c}}},_0x3b46f6=await axios_1[_0x71d492(0x11a)][_0x71d492(0x115)](_0x2d7fee+_0x71d492(0x139)+_0x4b1fee,_0x1ab519),{data:{errmsg:_0x3b2fff,ticket:_0xd6b96c}}=_0x3b46f6;if(_0x3b2fff)throw new common_1['HttpException'](_0x3b2fff,common_1['HttpStatus'][_0x71d492(0x11b)]);return _0xd6b96c;}async[_0x3e2509(0xf7)](_0x6ff0d4,_0x1d9e8a){const _0x54869a=_0x3e2509,_0x3e9c3e=await this[_0x54869a(0x116)][_0x54869a(0x100)]([_0x54869a(0x109)]),_0xc61097=await this[_0x54869a(0x116)][_0x54869a(0x100)](['wechatOfficialAppSecret']),_0x4991b8=(0x0,utils_1['formatUrl'])(process[_0x54869a(0x111)][_0x54869a(0xcc)]||_0x54869a(0x132)),_0x2c460c=await axios_1[_0x54869a(0x11a)][_0x54869a(0x102)](_0x4991b8+_0x54869a(0xf5)+_0x3e9c3e+_0x54869a(0x133)+_0xc61097+'&code='+_0x1d9e8a+_0x54869a(0xff)),{data:{errmsg:_0xb8dee8,openid:_0x20bc3a}}=_0x2c460c;if(_0xb8dee8)throw new common_1['HttpException'](_0xb8dee8,common_1['HttpStatus'][_0x54869a(0x11b)]);let _0x18ffde;return _0x18ffde=await this['userService'][_0x54869a(0xfa)](_0x20bc3a),!_0x18ffde&&(_0x18ffde=await this[_0x54869a(0x13d)][_0x54869a(0xdd)](_0x20bc3a)),this[_0x54869a(0xea)][_0x54869a(0x122)](_0x18ffde,_0x6ff0d4);}async[_0x3e2509(0x10c)](_0x566b33,_0x3b062c){const _0x2b6102=_0x3e2509;try{common_1[_0x2b6102(0xd4)][_0x2b6102(0x110)](_0x2b6102(0xd6)+_0x566b33+_0x2b6102(0x12c)+_0x3b062c,_0x2b6102(0xd8));if(!this['sceneStrMap'][_0x3b062c]){common_1['Logger'][_0x2b6102(0x108)]('非法参数:\x20未找到的\x20sceneStr\x20'+_0x3b062c);throw new common_1[(_0x2b6102(0x114))](_0x2b6102(0xf8),common_1[_0x2b6102(0x101)][_0x2b6102(0x11b)]);}const _0x5e6e83=await this['userService'][_0x2b6102(0xdd)](_0x566b33,_0x3b062c);common_1[_0x2b6102(0xd4)][_0x2b6102(0x110)](_0x2b6102(0xfe)+(_0x5e6e83?_0x5e6e83['id']:_0x2b6102(0x118)),_0x2b6102(0xd8)),this[_0x2b6102(0xd3)][_0x3b062c]=_0x5e6e83['id'];}catch(_0x379926){common_1[_0x2b6102(0xd4)][_0x2b6102(0x108)]('Error\x20in\x20scan\x20method:',_0x379926[_0x2b6102(0x13b)]),common_1[_0x2b6102(0xd4)]['error'](_0x2b6102(0x13a),_0x379926[_0x2b6102(0xdb)]);throw new common_1[(_0x2b6102(0x114))](_0x2b6102(0xe4),common_1[_0x2b6102(0x101)][_0x2b6102(0xf9)]);}}async['loginBySceneStr'](_0x28cfbb,_0x45012c){const _0x3d7064=_0x3e2509,{sceneStr:_0x33fdde}=_0x45012c;if(!this[_0x3d7064(0xd1)][_0x33fdde])return;const _0x513bbe=this['scanedSceneStrMap'][_0x33fdde];if(!_0x513bbe)return'';const _0x3ae998=await this['userService'][_0x3d7064(0x10b)](_0x513bbe);return delete this['scanedSceneStrMap'][_0x33fdde],this[_0x3d7064(0xea)]['loginByOpenId'](_0x3ae998,_0x28cfbb);}async['scanBindWx'](_0x2519fc,_0x28188c){const _0x1e0e4e=_0x3e2509;if(!this[_0x1e0e4e(0xd1)][_0x28188c])throw new common_1[(_0x1e0e4e(0x114))]('非法参数',common_1[_0x1e0e4e(0x101)][_0x1e0e4e(0x11b)]);const _0x3bd10e=_0x28188c[_0x1e0e4e(0x134)]('/')[0x1],_0x4f3a0a=await this['userService'][_0x1e0e4e(0xf3)](_0x2519fc,_0x3bd10e);this['scanedSceneStrMap'][_0x28188c]=_0x4f3a0a;}async[_0x3e2509(0xf0)](_0x35c206,_0x8a1b91){const _0x92641b=_0x3e2509;if(!this[_0x92641b(0xd1)][_0x8a1b91])throw new common_1[(_0x92641b(0x114))](_0x92641b(0xf8),common_1[_0x92641b(0x101)][_0x92641b(0x11b)]);const {id:_0x53dfe7}=_0x35c206['user'],_0x4611f7=this[_0x92641b(0xd3)][_0x8a1b91];if(!_0x4611f7)return'';return delete this[_0x92641b(0xd3)][_0x8a1b91],_0x4611f7;}async[_0x3e2509(0xe5)](_0x1fa46b,_0x2fc0ec,_0x25d27c){const _0x571461=_0x3e2509,_0x509e0d=await this[_0x571461(0x116)]['getConfigs']([_0x571461(0x131)])||'';return await this[_0x571461(0xca)]([_0x509e0d,_0x2fc0ec,_0x25d27c][_0x571461(0xfc)]()[_0x571461(0x119)](''))==_0x1fa46b;}['sha1'](_0x4e01cf){const _0x5cfcc7=_0x3e2509;return crypto[_0x5cfcc7(0x104)](_0x5cfcc7(0xca))[_0x5cfcc7(0x127)](_0x4e01cf)[_0x5cfcc7(0xcb)]('hex');}async[_0x3e2509(0xd7)](_0xacaf8d,_0x126931){const _0x157413=_0x3e2509,_0x42be61=await this[_0x157413(0x116)]['getConfigs']([_0x126931]);return this[_0x157413(0xd2)](_0xacaf8d,_0x42be61);}async[_0x3e2509(0xd2)](_0x35b022,_0x2c3e5d){const _0x16ceec=_0x3e2509;return _0x16ceec(0x125)+_0x35b022[_0x16ceec(0x135)][0x0]+_0x16ceec(0x106)+_0x35b022['tousername'][0x0]+_0x16ceec(0x112)+new Date()[_0x16ceec(0xf2)]()+_0x16ceec(0xe8)+_0x2c3e5d+_0x16ceec(0xe7);}async['aotoPlay'](_0x5d8080){const _0x3084c2=_0x3e2509,_0x2177f8=new Promise((_0x41be7b,_0x148fec)=>{setTimeout(()=>{const _0x1c2507=_0x2da4;_0x148fec(new Error(_0x1c2507(0x123)));},0x12c0);});let _0x51bb33=await this[_0x3084c2(0x116)][_0x3084c2(0x100)]([_0x3084c2(0x126)])||'由于公众号的回复限制、过长的问题我们可能无法回复、您可以前往我们的官方站点享受更加完善的服务、如果您有更多问题、欢迎像我提问！';return _0x51bb33;}};OfficialService=__decorate([(0x0,common_1[_0x3e2509(0xd9)])(),__metadata(_0x3e2509(0xee),[autoreply_service_1[_0x3e2509(0x10d)],user_service_1['UserService'],auth_service_1[_0x3e2509(0x12a)],globalConfig_service_1['GlobalConfigService'],chat_service_1[_0x3e2509(0x121)]])],OfficialService),exports['OfficialService']=OfficialService;