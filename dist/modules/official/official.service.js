'use strict';function _0x21cb(_0x34afa7,_0x599b9c){const _0x4ff56e=_0x4ff5();return _0x21cb=function(_0x21cb6c,_0x37794f){_0x21cb6c=_0x21cb6c-0x1ec;let _0x19dd6f=_0x4ff56e[_0x21cb6c];return _0x19dd6f;},_0x21cb(_0x34afa7,_0x599b9c);}const _0x279f32=_0x21cb;function _0x4ff5(){const _0x46df51=['getUserFromOpenId','sort','formatUrl','Injectable','scanedSceneStrMap','getQRSceneStrByBind','1620395lSzvQm','log','./../autoreply/autoreply.service','getWechatAccessToken','userService','\x0a\x20\x20\x20\x20<xml>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<ToUserName><![CDATA[','Scanning\x20with\x20openID:\x20','defineProperty','getQRSceneStr','&url=','split','globalConfigService','./../globalConfig/globalConfig.service','weChatOpenUrl','verify','getOwnPropertyDescriptor','/sns/oauth2/access_token?appid=','function','Stack\x20trace:',',\x20sceneStr:\x20','Error\x20in\x20scan\x20method:','default','message','364876QomQWx','../../common/utils','QR_STR_SCENE','getRedirectUrl','length','Logger','createRandomNonceStr','GlobalConfigService','fromusername','loginBySceneStr','stack','3yeyRMr','272826vXaHJK','2876540ceBRuN','digest','ChatService','非法参数','No\x20user\x20found','回跳跳转地址:\x20','user','design:paramtypes','getQRCodeTicket','INTERNAL_SERVER_ERROR','tousername','User\x20found:\x20',']]></ToUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<FromUserName><![CDATA[','now','https://open.weixin.qq.com','非法参数:\x20未找到的\x20sceneStr\x20','由于公众号的回复限制、过长的问题我们可能无法回复、您可以前往我们的官方站点享受更加完善的服务、如果您有更多问题、欢迎像我提问！','getConfigs','chatgptService','env','&grant_type=authorization_code','getUserOpenId','sceneStrMap','scan','wechatAccessToken','fetchQRCodeTicket','AuthService','&secret=','https://api.weixin.qq.com','sha1','crypto','BAD_REQUEST','@nestjs/common','535092hmQBBQ','loginByOpenId','object','处理扫码事件时发生错误','3647632QKHkoz','error','metadata','jsapi_ticket=','__esModule','HttpException','../chat/chat.service','./../auth/auth.service','请求超时','hex','createHash','wechatOfficialAppId','AutoreplyService','post','decorate','weChatApiUrl','./../user/user.service','&redirect_uri=','autoreplyService','OfficialService','axios','/connect/oauth2/authorize?appid=','969580ixjmOw',']]></Content>\x0a\x20\x20\x20\x20</xml>','HttpStatus','wechatOfficialToken','scanBindWx','authService'];_0x4ff5=function(){return _0x46df51;};return _0x4ff5();}(function(_0x3f1d6b,_0x3e2d91){const _0x248f2f=_0x21cb,_0x5dc2c7=_0x3f1d6b();while(!![]){try{const _0x12d4ff=parseInt(_0x248f2f(0x1f6))/0x1+parseInt(_0x248f2f(0x224))/0x2*(parseInt(_0x248f2f(0x201))/0x3)+-parseInt(_0x248f2f(0x23e))/0x4+-parseInt(_0x248f2f(0x203))/0x5+-parseInt(_0x248f2f(0x202))/0x6+parseInt(_0x248f2f(0x24a))/0x7+parseInt(_0x248f2f(0x228))/0x8;if(_0x12d4ff===_0x3e2d91)break;else _0x5dc2c7['push'](_0x5dc2c7['shift']());}catch(_0x5d4890){_0x5dc2c7['push'](_0x5dc2c7['shift']());}}}(_0x4ff5,0x6f7ef));var __decorate=this&&this['__decorate']||function(_0x4f53d9,_0x41d3ce,_0x4e19f6,_0x2651bd){const _0x2f360f=_0x21cb;var _0x43b746=arguments[_0x2f360f(0x1fa)],_0x1ac007=_0x43b746<0x3?_0x41d3ce:_0x2651bd===null?_0x2651bd=Object[_0x2f360f(0x1ee)](_0x41d3ce,_0x4e19f6):_0x2651bd,_0x3c4512;if(typeof Reflect===_0x2f360f(0x226)&&typeof Reflect[_0x2f360f(0x236)]==='function')_0x1ac007=Reflect[_0x2f360f(0x236)](_0x4f53d9,_0x41d3ce,_0x4e19f6,_0x2651bd);else{for(var _0x3cf480=_0x4f53d9[_0x2f360f(0x1fa)]-0x1;_0x3cf480>=0x0;_0x3cf480--)if(_0x3c4512=_0x4f53d9[_0x3cf480])_0x1ac007=(_0x43b746<0x3?_0x3c4512(_0x1ac007):_0x43b746>0x3?_0x3c4512(_0x41d3ce,_0x4e19f6,_0x1ac007):_0x3c4512(_0x41d3ce,_0x4e19f6))||_0x1ac007;}return _0x43b746>0x3&&_0x1ac007&&Object[_0x2f360f(0x251)](_0x41d3ce,_0x4e19f6,_0x1ac007),_0x1ac007;},__metadata=this&&this['__metadata']||function(_0x54d501,_0xdd0874){const _0x27c491=_0x21cb;if(typeof Reflect==='object'&&typeof Reflect[_0x27c491(0x22a)]===_0x27c491(0x1f0))return Reflect[_0x27c491(0x22a)](_0x54d501,_0xdd0874);};Object[_0x279f32(0x251)](exports,_0x279f32(0x22c),{'value':!![]}),exports[_0x279f32(0x23b)]=void 0x0;const utils_1=require(_0x279f32(0x1f7)),common_1=require(_0x279f32(0x223)),axios_1=require(_0x279f32(0x23c)),crypto=require(_0x279f32(0x221)),chat_service_1=require(_0x279f32(0x22e)),auth_service_1=require(_0x279f32(0x22f)),autoreply_service_1=require(_0x279f32(0x24c)),globalConfig_service_1=require(_0x279f32(0x256)),user_service_1=require(_0x279f32(0x238));let OfficialService=class OfficialService{constructor(_0x5b0ab4,_0x4eb5fe,_0x4a4180,_0x3e6fdc,_0x1a28eb){const _0x1683bf=_0x279f32;this[_0x1683bf(0x23a)]=_0x5b0ab4,this['userService']=_0x4eb5fe,this[_0x1683bf(0x243)]=_0x4a4180,this[_0x1683bf(0x255)]=_0x3e6fdc,this[_0x1683bf(0x215)]=_0x1a28eb,this[_0x1683bf(0x219)]={},this[_0x1683bf(0x248)]={};}async['onModuleInit'](){const _0x18d3af=_0x279f32;await this['globalConfigService'][_0x18d3af(0x24d)](!![]);}async[_0x279f32(0x252)](){const _0x310e51=_0x279f32;let _0x36f604=(0x0,utils_1[_0x310e51(0x1fc)])(0x20);return this[_0x310e51(0x219)][_0x36f604]=!![],_0x36f604;}async[_0x279f32(0x249)](_0x1f62f8){const _0x1b76b5=_0x279f32,{id:_0x307bf9}=_0x1f62f8[_0x1b76b5(0x209)],_0xa470f=(0x0,utils_1[_0x1b76b5(0x1fc)])(0x20)+'/'+_0x307bf9;return this['sceneStrMap'][_0xa470f]=!![],_0xa470f;}async[_0x279f32(0x20b)](_0x107f4b){const _0x5e6c85=_0x279f32;return this[_0x5e6c85(0x21c)](_0x107f4b);}async[_0x279f32(0x1f9)](_0x24a2a2){const _0x524d9c=_0x279f32,_0x433c70=await this[_0x524d9c(0x255)][_0x524d9c(0x214)]([_0x524d9c(0x233)]),_0x4878f6=(0x0,utils_1[_0x524d9c(0x246)])(process[_0x524d9c(0x216)][_0x524d9c(0x1ec)]||_0x524d9c(0x211)),_0x5436a4=_0x4878f6+_0x524d9c(0x23d)+_0x433c70+_0x524d9c(0x239)+encodeURIComponent(_0x24a2a2)+'&response_type=code&scope=snsapi_base&state=weChatLogin#wechat_redirect';return console[_0x524d9c(0x24b)](_0x524d9c(0x208),_0x5436a4),_0x5436a4;}async['getJsapiTicket'](_0x3fca6a){const _0x46c60a=_0x279f32,_0x7b734=(0x0,utils_1['createRandomNonceStr'])(0x20),_0x5c4b9b=(Date[_0x46c60a(0x210)]()/0x3e8)['toFixed'](0x0),_0x2a1f6b=await this[_0x46c60a(0x255)]['getConfigs'](['wechatJsapiTicket']);console[_0x46c60a(0x24b)]('jsapiTicket:\x20',_0x2a1f6b);const _0x54ea05=await this[_0x46c60a(0x255)][_0x46c60a(0x214)]([_0x46c60a(0x233)]);console[_0x46c60a(0x24b)]('appId:\x20',_0x54ea05);const _0xd08e32=_0x46c60a(0x22b)+_0x2a1f6b+'&noncestr='+_0x7b734+'&timestamp='+_0x5c4b9b+_0x46c60a(0x253)+_0x3fca6a;console[_0x46c60a(0x24b)]('str:\x20',_0xd08e32);const _0x562b72=this['sha1'](_0xd08e32);return{'appId':_0x54ea05,'nonceStr':_0x7b734,'timestamp':_0x5c4b9b,'signature':_0x562b72};}async['fetchQRCodeTicket'](_0x5465fc){const _0x109376=_0x279f32,_0x121e29=await this[_0x109376(0x255)][_0x109376(0x214)]([_0x109376(0x21b)]),_0x39c273=(0x0,utils_1[_0x109376(0x246)])(process['env'][_0x109376(0x237)]||_0x109376(0x21f)),_0x5aa9a4={'action_name':_0x109376(0x1f8),'action_info':{'scene':{'scene_str':_0x5465fc}}},_0x395333=await axios_1['default'][_0x109376(0x235)](_0x39c273+'/cgi-bin/qrcode/create?access_token='+_0x121e29,_0x5aa9a4),{data:{errmsg:_0x3c08f2,ticket:_0x533f55}}=_0x395333;if(_0x3c08f2)throw new common_1['HttpException'](_0x3c08f2,common_1[_0x109376(0x240)][_0x109376(0x222)]);return _0x533f55;}async['loginByCode'](_0x47a76a,_0x282333){const _0x417804=_0x279f32,_0xdb557c=await this[_0x417804(0x255)][_0x417804(0x214)]([_0x417804(0x233)]),_0x4e980a=await this[_0x417804(0x255)]['getConfigs'](['wechatOfficialAppSecret']),_0x5c1b47=(0x0,utils_1[_0x417804(0x246)])(process[_0x417804(0x216)][_0x417804(0x237)]||_0x417804(0x21f)),_0x26d85c=await axios_1[_0x417804(0x1f4)]['get'](_0x5c1b47+_0x417804(0x1ef)+_0xdb557c+_0x417804(0x21e)+_0x4e980a+'&code='+_0x282333+_0x417804(0x217)),{data:{errmsg:_0x4bc1b9,openid:_0x2b22bd}}=_0x26d85c;if(_0x4bc1b9)throw new common_1[(_0x417804(0x22d))](_0x4bc1b9,common_1[_0x417804(0x240)][_0x417804(0x222)]);let _0x6538f9;return _0x6538f9=await this[_0x417804(0x24e)][_0x417804(0x218)](_0x2b22bd),!_0x6538f9&&(_0x6538f9=await this[_0x417804(0x24e)]['getUserFromOpenId'](_0x2b22bd)),this[_0x417804(0x243)]['loginByOpenId'](_0x6538f9,_0x47a76a);}async[_0x279f32(0x21a)](_0x508093,_0x580594){const _0x43c544=_0x279f32;try{common_1[_0x43c544(0x1fb)][_0x43c544(0x24b)](_0x43c544(0x250)+_0x508093+_0x43c544(0x1f2)+_0x580594,'OfficialService');if(!this['sceneStrMap'][_0x580594]){common_1[_0x43c544(0x1fb)][_0x43c544(0x229)](_0x43c544(0x212)+_0x580594);throw new common_1[(_0x43c544(0x22d))](_0x43c544(0x206),common_1[_0x43c544(0x240)]['BAD_REQUEST']);}const _0x1703da=await this['userService'][_0x43c544(0x244)](_0x508093,_0x580594);common_1['Logger'][_0x43c544(0x24b)](_0x43c544(0x20e)+(_0x1703da?_0x1703da['id']:_0x43c544(0x207)),_0x43c544(0x23b)),this[_0x43c544(0x248)][_0x580594]=_0x1703da['id'];}catch(_0x13bb1d){common_1[_0x43c544(0x1fb)][_0x43c544(0x229)](_0x43c544(0x1f3),_0x13bb1d[_0x43c544(0x1f5)]),common_1[_0x43c544(0x1fb)]['error'](_0x43c544(0x1f1),_0x13bb1d[_0x43c544(0x200)]);throw new common_1[(_0x43c544(0x22d))](_0x43c544(0x227),common_1[_0x43c544(0x240)][_0x43c544(0x20c)]);}}async[_0x279f32(0x1ff)](_0x26e5e0,_0x360aad){const _0x3a384a=_0x279f32,{sceneStr:_0x4c2558}=_0x360aad;if(!this['sceneStrMap'][_0x4c2558])return;const _0x2599d6=this[_0x3a384a(0x248)][_0x4c2558];if(!_0x2599d6)return'';const _0x25e5ef=await this['userService']['getUserById'](_0x2599d6);return delete this[_0x3a384a(0x248)][_0x4c2558],this['authService'][_0x3a384a(0x225)](_0x25e5ef,_0x26e5e0);}async[_0x279f32(0x242)](_0x8f0a7,_0x28a5fd){const _0x876877=_0x279f32;if(!this[_0x876877(0x219)][_0x28a5fd])throw new common_1[(_0x876877(0x22d))](_0x876877(0x206),common_1[_0x876877(0x240)][_0x876877(0x222)]);const _0x1a9177=_0x28a5fd[_0x876877(0x254)]('/')[0x1],_0x41d3e0=await this[_0x876877(0x24e)]['bindWx'](_0x8f0a7,_0x1a9177);this[_0x876877(0x248)][_0x28a5fd]=_0x41d3e0;}async['bindWxBySceneStr'](_0x31a2fc,_0x18c5ff){const _0x1a6a19=_0x279f32;if(!this[_0x1a6a19(0x219)][_0x18c5ff])throw new common_1[(_0x1a6a19(0x22d))](_0x1a6a19(0x206),common_1[_0x1a6a19(0x240)]['BAD_REQUEST']);const {id:_0xcaf497}=_0x31a2fc[_0x1a6a19(0x209)],_0x1f4c1a=this[_0x1a6a19(0x248)][_0x18c5ff];if(!_0x1f4c1a)return'';return delete this['scanedSceneStrMap'][_0x18c5ff],_0x1f4c1a;}async[_0x279f32(0x1ed)](_0x960355,_0x201269,_0x2d102f){const _0x4bf222=_0x279f32,_0x16c35d=await this[_0x4bf222(0x255)][_0x4bf222(0x214)]([_0x4bf222(0x241)])||'';return await this['sha1']([_0x16c35d,_0x201269,_0x2d102f][_0x4bf222(0x245)]()['join'](''))==_0x960355;}[_0x279f32(0x220)](_0x7946df){const _0x80b876=_0x279f32;return crypto[_0x80b876(0x232)](_0x80b876(0x220))['update'](_0x7946df)[_0x80b876(0x204)](_0x80b876(0x231));}async['genXmlMsgByConfig'](_0x320ee4,_0x4c0d61){const _0x178821=_0x279f32,_0x7e1184=await this[_0x178821(0x255)]['getConfigs']([_0x4c0d61]);return this['genXmlMsg'](_0x320ee4,_0x7e1184);}async['genXmlMsg'](_0x4e54f7,_0x26dbf8){const _0x5ebf7c=_0x279f32;return _0x5ebf7c(0x24f)+_0x4e54f7[_0x5ebf7c(0x1fe)][0x0]+_0x5ebf7c(0x20f)+_0x4e54f7[_0x5ebf7c(0x20d)][0x0]+']]></FromUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<CreateTime>'+new Date()['getTime']()+'</CreateTime>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<MsgType><![CDATA[text]]></MsgType>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<Content><![CDATA['+_0x26dbf8+_0x5ebf7c(0x23f);}async['aotoPlay'](_0x17a45a){const _0x109bdb=_0x279f32,_0x2860e0=new Promise((_0x23a46b,_0x2a0516)=>{setTimeout(()=>{const _0x30792f=_0x21cb;_0x2a0516(new Error(_0x30792f(0x230)));},0x12c0);});let _0x1bf4e7=await this[_0x109bdb(0x255)][_0x109bdb(0x214)](['officialAutoReplyText'])||_0x109bdb(0x213);return _0x1bf4e7;}};OfficialService=__decorate([(0x0,common_1[_0x279f32(0x247)])(),__metadata(_0x279f32(0x20a),[autoreply_service_1[_0x279f32(0x234)],user_service_1['UserService'],auth_service_1[_0x279f32(0x21d)],globalConfig_service_1[_0x279f32(0x1fd)],chat_service_1[_0x279f32(0x205)]])],OfficialService),exports['OfficialService']=OfficialService;