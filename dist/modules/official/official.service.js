'use strict';const _0x4ab5de=_0x10d6;(function(_0x1dd561,_0x34fc5a){const _0x571df0=_0x10d6,_0x5d782f=_0x1dd561();while(!![]){try{const _0x4ec27d=-parseInt(_0x571df0(0xee))/0x1*(-parseInt(_0x571df0(0x104))/0x2)+-parseInt(_0x571df0(0xe5))/0x3+-parseInt(_0x571df0(0x119))/0x4*(parseInt(_0x571df0(0xe1))/0x5)+-parseInt(_0x571df0(0x131))/0x6+-parseInt(_0x571df0(0x133))/0x7+-parseInt(_0x571df0(0x137))/0x8*(parseInt(_0x571df0(0x10d))/0x9)+-parseInt(_0x571df0(0xd4))/0xa*(-parseInt(_0x571df0(0x12b))/0xb);if(_0x4ec27d===_0x34fc5a)break;else _0x5d782f['push'](_0x5d782f['shift']());}catch(_0x49d243){_0x5d782f['push'](_0x5d782f['shift']());}}}(_0x3124,0xce474));function _0x3124(){const _0xd71f51=['message','wechatJsapiTicket','axios','authService','16894405fEnmVe','weChatApiUrl','sceneStrMap','join','weChatOpenUrl','bindWx','788154OEDqOF','now','2098929SucmiV','OfficialService','Logger','getConfigs','6398752stbNfz','__metadata','length','../../common/utils','getWechatAccessToken',']]></Content>\x0a\x20\x20\x20\x20</xml>','env','Error\x20in\x20scan\x20method:','/sns/oauth2/access_token?appid=','defineProperty','object','user','10Iinvan',',\x20sceneStr:\x20','../chat/chat.service','fromusername','/connect/oauth2/authorize?appid=','__esModule','./../auth/auth.service','aotoPlay','jsapi_ticket=','loginBySceneStr','Injectable','wechatAccessToken','BAD_REQUEST','11010sbaEKx','HttpException','&grant_type=authorization_code','onModuleInit','1100658CMQpJf','getRedirectUrl','bindWxBySceneStr','createHash','log','loginByOpenId','update','./../user/user.service','getUserById','1sTCzZx','@nestjs/common','非法参数:\x20未找到的\x20sceneStr\x20','/cgi-bin/qrcode/create?access_token=','非法参数','wechatOfficialAppId','error','QR_STR_SCENE','INTERNAL_SERVER_ERROR','回跳跳转地址:\x20','tousername','ChatService','fetchQRCodeTicket','getOwnPropertyDescriptor','</CreateTime>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<MsgType><![CDATA[text]]></MsgType>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<Content><![CDATA[','&timestamp=','AutoreplyService','\x0a\x20\x20\x20\x20<xml>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<ToUserName><![CDATA[','metadata','genXmlMsgByConfig','hex','scanedSceneStrMap','2170718JktJrv','scan','No\x20user\x20found','getUserFromOpenId','./../autoreply/autoreply.service','&response_type=code&scope=snsapi_base&state=weChatLogin#wechat_redirect','sort','globalConfigService','crypto','9YDvRnn','HttpStatus','sha1','split','decorate','请求超时','getTime','createRandomNonceStr','wechatOfficialAppSecret','处理扫码事件时发生错误','userService',']]></FromUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<CreateTime>','324hGZlpz','GlobalConfigService','toFixed','&code=','UserService','digest','verify','Scanning\x20with\x20openID:\x20','genXmlMsg','https://open.weixin.qq.com','function','loginByCode','getQRSceneStr','formatUrl'];_0x3124=function(){return _0xd71f51;};return _0x3124();}function _0x10d6(_0x5440f0,_0x1c522c){const _0x31243f=_0x3124();return _0x10d6=function(_0x10d667,_0x449a9a){_0x10d667=_0x10d667-0xcd;let _0x229ecd=_0x31243f[_0x10d667];return _0x229ecd;},_0x10d6(_0x5440f0,_0x1c522c);}var __decorate=this&&this['__decorate']||function(_0x102a2d,_0x135def,_0x24fb03,_0x1e0713){const _0x59a3f6=_0x10d6;var _0x3f402d=arguments[_0x59a3f6(0x139)],_0x4c6e7c=_0x3f402d<0x3?_0x135def:_0x1e0713===null?_0x1e0713=Object[_0x59a3f6(0xfb)](_0x135def,_0x24fb03):_0x1e0713,_0x4355af;if(typeof Reflect===_0x59a3f6(0xd2)&&typeof Reflect[_0x59a3f6(0x111)]===_0x59a3f6(0x123))_0x4c6e7c=Reflect[_0x59a3f6(0x111)](_0x102a2d,_0x135def,_0x24fb03,_0x1e0713);else{for(var _0x208ce1=_0x102a2d['length']-0x1;_0x208ce1>=0x0;_0x208ce1--)if(_0x4355af=_0x102a2d[_0x208ce1])_0x4c6e7c=(_0x3f402d<0x3?_0x4355af(_0x4c6e7c):_0x3f402d>0x3?_0x4355af(_0x135def,_0x24fb03,_0x4c6e7c):_0x4355af(_0x135def,_0x24fb03))||_0x4c6e7c;}return _0x3f402d>0x3&&_0x4c6e7c&&Object[_0x59a3f6(0xd1)](_0x135def,_0x24fb03,_0x4c6e7c),_0x4c6e7c;},__metadata=this&&this[_0x4ab5de(0x138)]||function(_0x43305f,_0x54eb37){const _0x30366d=_0x4ab5de;if(typeof Reflect===_0x30366d(0xd2)&&typeof Reflect[_0x30366d(0x100)]==='function')return Reflect[_0x30366d(0x100)](_0x43305f,_0x54eb37);};Object[_0x4ab5de(0xd1)](exports,_0x4ab5de(0xd9),{'value':!![]}),exports[_0x4ab5de(0x134)]=void 0x0;const utils_1=require(_0x4ab5de(0x13a)),common_1=require(_0x4ab5de(0xef)),axios_1=require(_0x4ab5de(0x129)),crypto=require(_0x4ab5de(0x10c)),chat_service_1=require(_0x4ab5de(0xd6)),auth_service_1=require(_0x4ab5de(0xda)),autoreply_service_1=require(_0x4ab5de(0x108)),globalConfig_service_1=require('./../globalConfig/globalConfig.service'),user_service_1=require(_0x4ab5de(0xec));let OfficialService=class OfficialService{constructor(_0xef8d1e,_0x3cee88,_0x2c19c0,_0x58da16,_0x549edf){const _0x43f4ac=_0x4ab5de;this['autoreplyService']=_0xef8d1e,this['userService']=_0x3cee88,this[_0x43f4ac(0x12a)]=_0x2c19c0,this[_0x43f4ac(0x10b)]=_0x58da16,this['chatgptService']=_0x549edf,this[_0x43f4ac(0x12d)]={},this[_0x43f4ac(0x103)]={};}async[_0x4ab5de(0xe4)](){const _0x1ac80a=_0x4ab5de;await this[_0x1ac80a(0x10b)][_0x1ac80a(0x13b)](!![]);}async[_0x4ab5de(0x125)](){let _0x1d2d81=(0x0,utils_1['createRandomNonceStr'])(0x20);return this['sceneStrMap'][_0x1d2d81]=!![],_0x1d2d81;}async['getQRSceneStrByBind'](_0x24818b){const _0x47c579=_0x4ab5de,{id:_0x159b40}=_0x24818b[_0x47c579(0xd3)],_0x5ab4d0=(0x0,utils_1['createRandomNonceStr'])(0x20)+'/'+_0x159b40;return this[_0x47c579(0x12d)][_0x5ab4d0]=!![],_0x5ab4d0;}async['getQRCodeTicket'](_0x598165){const _0x3dc2e7=_0x4ab5de;return this[_0x3dc2e7(0xfa)](_0x598165);}async[_0x4ab5de(0xe6)](_0x18b3df){const _0x2b9e2d=_0x4ab5de,_0x26e5ec=await this[_0x2b9e2d(0x10b)][_0x2b9e2d(0x136)]([_0x2b9e2d(0xf3)]),_0x172527=(0x0,utils_1[_0x2b9e2d(0x126)])(process['env'][_0x2b9e2d(0x12f)]||_0x2b9e2d(0x122)),_0x4da889=_0x172527+_0x2b9e2d(0xd8)+_0x26e5ec+'&redirect_uri='+encodeURIComponent(_0x18b3df)+_0x2b9e2d(0x109);return console[_0x2b9e2d(0xe9)](_0x2b9e2d(0xf7),_0x4da889),_0x4da889;}async['getJsapiTicket'](_0x35f865){const _0xddf0f5=_0x4ab5de,_0x5577cb=(0x0,utils_1[_0xddf0f5(0x114)])(0x20),_0x5d0f85=(Date[_0xddf0f5(0x132)]()/0x3e8)[_0xddf0f5(0x11b)](0x0),_0x295dbe=await this[_0xddf0f5(0x10b)]['getConfigs']([_0xddf0f5(0x128)]);console['log']('jsapiTicket:\x20',_0x295dbe);const _0x3ee25d=await this[_0xddf0f5(0x10b)][_0xddf0f5(0x136)]([_0xddf0f5(0xf3)]);console[_0xddf0f5(0xe9)]('appId:\x20',_0x3ee25d);const _0x2b83ff=_0xddf0f5(0xdc)+_0x295dbe+'&noncestr='+_0x5577cb+_0xddf0f5(0xfd)+_0x5d0f85+'&url='+_0x35f865;console[_0xddf0f5(0xe9)]('str:\x20',_0x2b83ff);const _0x1bd598=this[_0xddf0f5(0x10f)](_0x2b83ff);return{'appId':_0x3ee25d,'nonceStr':_0x5577cb,'timestamp':_0x5d0f85,'signature':_0x1bd598};}async[_0x4ab5de(0xfa)](_0x166575){const _0xcaf99c=_0x4ab5de,_0xaa30b4=await this['globalConfigService']['getConfigs']([_0xcaf99c(0xdf)]),_0x51c9e9=(0x0,utils_1[_0xcaf99c(0x126)])(process[_0xcaf99c(0xce)][_0xcaf99c(0x12c)]||'https://api.weixin.qq.com'),_0x451d25={'action_name':_0xcaf99c(0xf5),'action_info':{'scene':{'scene_str':_0x166575}}},_0x1c0562=await axios_1['default']['post'](_0x51c9e9+_0xcaf99c(0xf1)+_0xaa30b4,_0x451d25),{data:{errmsg:_0x14fb93,ticket:_0x41adf4}}=_0x1c0562;if(_0x14fb93)throw new common_1[(_0xcaf99c(0xe2))](_0x14fb93,common_1[_0xcaf99c(0x10e)][_0xcaf99c(0xe0)]);return _0x41adf4;}async[_0x4ab5de(0x124)](_0x1232ef,_0x5ac1e4){const _0x51a13a=_0x4ab5de,_0x2eca9d=await this[_0x51a13a(0x10b)][_0x51a13a(0x136)]([_0x51a13a(0xf3)]),_0x3f2c11=await this[_0x51a13a(0x10b)][_0x51a13a(0x136)]([_0x51a13a(0x115)]),_0x5352a6=(0x0,utils_1[_0x51a13a(0x126)])(process[_0x51a13a(0xce)][_0x51a13a(0x12c)]||'https://api.weixin.qq.com'),_0x43bddd=await axios_1['default']['get'](_0x5352a6+_0x51a13a(0xd0)+_0x2eca9d+'&secret='+_0x3f2c11+_0x51a13a(0x11c)+_0x5ac1e4+_0x51a13a(0xe3)),{data:{errmsg:_0x41ee33,openid:_0x55ccc0}}=_0x43bddd;if(_0x41ee33)throw new common_1[(_0x51a13a(0xe2))](_0x41ee33,common_1[_0x51a13a(0x10e)]['BAD_REQUEST']);let _0x51e996;return _0x51e996=await this[_0x51a13a(0x117)]['getUserOpenId'](_0x55ccc0),!_0x51e996&&(_0x51e996=await this['userService'][_0x51a13a(0x107)](_0x55ccc0)),this['authService'][_0x51a13a(0xea)](_0x51e996,_0x1232ef);}async[_0x4ab5de(0x105)](_0x55e847,_0x3bf150){const _0x57d697=_0x4ab5de;try{common_1['Logger'][_0x57d697(0xe9)](_0x57d697(0x120)+_0x55e847+_0x57d697(0xd5)+_0x3bf150,'OfficialService');if(!this[_0x57d697(0x12d)][_0x3bf150]){common_1[_0x57d697(0x135)][_0x57d697(0xf4)](_0x57d697(0xf0)+_0x3bf150);throw new common_1[(_0x57d697(0xe2))](_0x57d697(0xf2),common_1['HttpStatus'][_0x57d697(0xe0)]);}const _0x535343=await this[_0x57d697(0x117)]['getUserFromOpenId'](_0x55e847,_0x3bf150);common_1[_0x57d697(0x135)][_0x57d697(0xe9)]('User\x20found:\x20'+(_0x535343?_0x535343['id']:_0x57d697(0x106)),_0x57d697(0x134)),this[_0x57d697(0x103)][_0x3bf150]=_0x535343['id'];}catch(_0x292847){common_1[_0x57d697(0x135)][_0x57d697(0xf4)](_0x57d697(0xcf),_0x292847[_0x57d697(0x127)]),common_1[_0x57d697(0x135)][_0x57d697(0xf4)]('Stack\x20trace:',_0x292847['stack']);throw new common_1[(_0x57d697(0xe2))](_0x57d697(0x116),common_1[_0x57d697(0x10e)][_0x57d697(0xf6)]);}}async[_0x4ab5de(0xdd)](_0x309bde,_0x13d569){const _0x12d942=_0x4ab5de,{sceneStr:_0x3853d4}=_0x13d569;if(!this['sceneStrMap'][_0x3853d4])return;const _0x3a9a52=this[_0x12d942(0x103)][_0x3853d4];if(!_0x3a9a52)return'';const _0x4a3b43=await this[_0x12d942(0x117)][_0x12d942(0xed)](_0x3a9a52);return delete this[_0x12d942(0x103)][_0x3853d4],this[_0x12d942(0x12a)][_0x12d942(0xea)](_0x4a3b43,_0x309bde);}async['scanBindWx'](_0x407eb1,_0x4cb725){const _0x3fca77=_0x4ab5de;if(!this[_0x3fca77(0x12d)][_0x4cb725])throw new common_1[(_0x3fca77(0xe2))]('非法参数',common_1[_0x3fca77(0x10e)][_0x3fca77(0xe0)]);const _0x4dc12f=_0x4cb725[_0x3fca77(0x110)]('/')[0x1],_0xac0e35=await this[_0x3fca77(0x117)][_0x3fca77(0x130)](_0x407eb1,_0x4dc12f);this[_0x3fca77(0x103)][_0x4cb725]=_0xac0e35;}async[_0x4ab5de(0xe7)](_0x51978a,_0x4dfe7b){const _0x3d4d6e=_0x4ab5de;if(!this[_0x3d4d6e(0x12d)][_0x4dfe7b])throw new common_1[(_0x3d4d6e(0xe2))](_0x3d4d6e(0xf2),common_1[_0x3d4d6e(0x10e)][_0x3d4d6e(0xe0)]);const {id:_0xcab274}=_0x51978a['user'],_0x5bc7c4=this[_0x3d4d6e(0x103)][_0x4dfe7b];if(!_0x5bc7c4)return'';return delete this[_0x3d4d6e(0x103)][_0x4dfe7b],_0x5bc7c4;}async[_0x4ab5de(0x11f)](_0x21458d,_0xfd4c39,_0x474584){const _0x55bf56=_0x4ab5de,_0x57e681=await this[_0x55bf56(0x10b)][_0x55bf56(0x136)](['wechatOfficialToken'])||'';return await this[_0x55bf56(0x10f)]([_0x57e681,_0xfd4c39,_0x474584][_0x55bf56(0x10a)]()[_0x55bf56(0x12e)](''))==_0x21458d;}[_0x4ab5de(0x10f)](_0x1c4414){const _0x8d91f6=_0x4ab5de;return crypto[_0x8d91f6(0xe8)](_0x8d91f6(0x10f))[_0x8d91f6(0xeb)](_0x1c4414)[_0x8d91f6(0x11e)](_0x8d91f6(0x102));}async[_0x4ab5de(0x101)](_0x23442e,_0x945ae8){const _0x2ce4ac=_0x4ab5de,_0x1ccca1=await this['globalConfigService']['getConfigs']([_0x945ae8]);return this[_0x2ce4ac(0x121)](_0x23442e,_0x1ccca1);}async['genXmlMsg'](_0x45ba91,_0x3ccea0){const _0x57d9b2=_0x4ab5de;return _0x57d9b2(0xff)+_0x45ba91[_0x57d9b2(0xd7)][0x0]+']]></ToUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<FromUserName><![CDATA['+_0x45ba91[_0x57d9b2(0xf8)][0x0]+_0x57d9b2(0x118)+new Date()[_0x57d9b2(0x113)]()+_0x57d9b2(0xfc)+_0x3ccea0+_0x57d9b2(0xcd);}async[_0x4ab5de(0xdb)](_0x5d4550){const _0x54000d=_0x4ab5de,_0x2045b4=new Promise((_0x17bc55,_0xa7a92d)=>{setTimeout(()=>{const _0x5a387b=_0x10d6;_0xa7a92d(new Error(_0x5a387b(0x112)));},0x12c0);});let _0x31f0a8=await this[_0x54000d(0x10b)][_0x54000d(0x136)](['officialAutoReplyText'])||'由于公众号的回复限制、过长的问题我们可能无法回复、您可以前往我们的官方站点享受更加完善的服务、如果您有更多问题、欢迎像我提问！';return _0x31f0a8;}};OfficialService=__decorate([(0x0,common_1[_0x4ab5de(0xde)])(),__metadata('design:paramtypes',[autoreply_service_1[_0x4ab5de(0xfe)],user_service_1[_0x4ab5de(0x11d)],auth_service_1['AuthService'],globalConfig_service_1[_0x4ab5de(0x11a)],chat_service_1[_0x4ab5de(0xf9)]])],OfficialService),exports[_0x4ab5de(0x134)]=OfficialService;