'use strict';const _0x3411d9=_0x3825;(function(_0x30fa52,_0x14b9a6){const _0xa0b168=_0x3825,_0x42f8cc=_0x30fa52();while(!![]){try{const _0x538fc1=parseInt(_0xa0b168(0x16d))/0x1*(parseInt(_0xa0b168(0x18b))/0x2)+parseInt(_0xa0b168(0x153))/0x3+-parseInt(_0xa0b168(0x19e))/0x4*(-parseInt(_0xa0b168(0x166))/0x5)+-parseInt(_0xa0b168(0x144))/0x6+-parseInt(_0xa0b168(0x178))/0x7+-parseInt(_0xa0b168(0x179))/0x8*(parseInt(_0xa0b168(0x151))/0x9)+-parseInt(_0xa0b168(0x138))/0xa;if(_0x538fc1===_0x14b9a6)break;else _0x42f8cc['push'](_0x42f8cc['shift']());}catch(_0x2f318b){_0x42f8cc['push'](_0x42f8cc['shift']());}}}(_0x5966,0x6c759));var __decorate=this&&this[_0x3411d9(0x18f)]||function(_0x237bb1,_0x7fd75c,_0x124ab0,_0xaa8544){const _0x365259=_0x3411d9;var _0x1a6986=arguments[_0x365259(0x131)],_0x22b45e=_0x1a6986<0x3?_0x7fd75c:_0xaa8544===null?_0xaa8544=Object[_0x365259(0x163)](_0x7fd75c,_0x124ab0):_0xaa8544,_0x5aa106;if(typeof Reflect===_0x365259(0x161)&&typeof Reflect[_0x365259(0x17c)]===_0x365259(0x165))_0x22b45e=Reflect[_0x365259(0x17c)](_0x237bb1,_0x7fd75c,_0x124ab0,_0xaa8544);else{for(var _0x159a76=_0x237bb1['length']-0x1;_0x159a76>=0x0;_0x159a76--)if(_0x5aa106=_0x237bb1[_0x159a76])_0x22b45e=(_0x1a6986<0x3?_0x5aa106(_0x22b45e):_0x1a6986>0x3?_0x5aa106(_0x7fd75c,_0x124ab0,_0x22b45e):_0x5aa106(_0x7fd75c,_0x124ab0))||_0x22b45e;}return _0x1a6986>0x3&&_0x22b45e&&Object[_0x365259(0x164)](_0x7fd75c,_0x124ab0,_0x22b45e),_0x22b45e;},__metadata=this&&this['__metadata']||function(_0x36c60a,_0xcf0b13){const _0x139cd5=_0x3411d9;if(typeof Reflect===_0x139cd5(0x161)&&typeof Reflect[_0x139cd5(0x155)]===_0x139cd5(0x165))return Reflect[_0x139cd5(0x155)](_0x36c60a,_0xcf0b13);};Object[_0x3411d9(0x164)](exports,_0x3411d9(0x172),{'value':!![]}),exports[_0x3411d9(0x184)]=void 0x0;const utils_1=require(_0x3411d9(0x181)),common_1=require(_0x3411d9(0x17a)),axios_1=require(_0x3411d9(0x137)),crypto=require('crypto'),chat_service_1=require('../chat/chat.service'),auth_service_1=require(_0x3411d9(0x13c)),autoreply_service_1=require(_0x3411d9(0x17b)),globalConfig_service_1=require(_0x3411d9(0x13a)),user_service_1=require(_0x3411d9(0x19c));let OfficialService=class OfficialService{constructor(_0x2b676b,_0x221483,_0x422b69,_0x4bb23b,_0x108eb9){const _0x14ae39=_0x3411d9;this['autoreplyService']=_0x2b676b,this[_0x14ae39(0x174)]=_0x221483,this[_0x14ae39(0x149)]=_0x422b69,this[_0x14ae39(0x135)]=_0x4bb23b,this[_0x14ae39(0x18c)]=_0x108eb9,this[_0x14ae39(0x159)]={},this['scanedSceneStrMap']={};}async[_0x3411d9(0x17d)](){const _0x2da6a5=_0x3411d9;await this[_0x2da6a5(0x135)][_0x2da6a5(0x193)](!![]);}async[_0x3411d9(0x191)](){const _0x2b935d=_0x3411d9;let _0x4d9da7=(0x0,utils_1[_0x2b935d(0x15b)])(0x20);return this[_0x2b935d(0x159)][_0x4d9da7]=!![],_0x4d9da7;}async['getQRSceneStrByBind'](_0x1b35a7){const _0x2cce0c=_0x3411d9,{id:_0x2aa8fe}=_0x1b35a7[_0x2cce0c(0x130)],_0x4c0225=(0x0,utils_1[_0x2cce0c(0x15b)])(0x20)+'/'+_0x2aa8fe;return this[_0x2cce0c(0x159)][_0x4c0225]=!![],_0x4c0225;}async[_0x3411d9(0x185)](_0x518995){const _0x2f7efc=_0x3411d9;return this[_0x2f7efc(0x14f)](_0x518995);}async[_0x3411d9(0x157)](_0x1363ff){const _0x40f57d=_0x3411d9,_0x45104b=await this['globalConfigService'][_0x40f57d(0x188)](['wechatOfficialAppId']),_0x57a876=(0x0,utils_1[_0x40f57d(0x169)])(process[_0x40f57d(0x168)][_0x40f57d(0x18e)]||_0x40f57d(0x170)),_0x3f89b9=_0x57a876+_0x40f57d(0x14a)+_0x45104b+_0x40f57d(0x13d)+encodeURIComponent(_0x1363ff)+_0x40f57d(0x14d);return console[_0x40f57d(0x154)](_0x40f57d(0x15a),_0x3f89b9),_0x3f89b9;}async[_0x3411d9(0x199)](_0x595002){const _0xd62c8c=_0x3411d9,_0x28a94e=(0x0,utils_1['createRandomNonceStr'])(0x20),_0x527424=(Date[_0xd62c8c(0x152)]()/0x3e8)[_0xd62c8c(0x195)](0x0),_0x4363dc=await this[_0xd62c8c(0x135)]['getConfigs'](['wechatJsapiTicket']);console['log'](_0xd62c8c(0x194),_0x4363dc);const _0x5a07ba=await this[_0xd62c8c(0x135)][_0xd62c8c(0x188)]([_0xd62c8c(0x190)]);console[_0xd62c8c(0x154)](_0xd62c8c(0x143),_0x5a07ba);const _0x3f948c='jsapi_ticket='+_0x4363dc+'&noncestr='+_0x28a94e+_0xd62c8c(0x141)+_0x527424+'&url='+_0x595002;console['log'](_0xd62c8c(0x160),_0x3f948c);const _0x60cd8e=this[_0xd62c8c(0x162)](_0x3f948c);return{'appId':_0x5a07ba,'nonceStr':_0x28a94e,'timestamp':_0x527424,'signature':_0x60cd8e};}async[_0x3411d9(0x14f)](_0x43515a){const _0x581de0=_0x3411d9,_0x11fd27=await this['globalConfigService']['getConfigs']([_0x581de0(0x186)]),_0x3770c4=(0x0,utils_1['formatUrl'])(process['env'][_0x581de0(0x177)]||_0x581de0(0x158)),_0xd676e={'action_name':'QR_STR_SCENE','action_info':{'scene':{'scene_str':_0x43515a}}},_0x359da3=await axios_1[_0x581de0(0x171)]['post'](_0x3770c4+_0x581de0(0x16b)+_0x11fd27,_0xd676e),{data:{errmsg:_0x225f6c,ticket:_0x2091d1}}=_0x359da3;if(_0x225f6c)throw new common_1[(_0x581de0(0x13b))](_0x225f6c,common_1[_0x581de0(0x14b)][_0x581de0(0x134)]);return _0x2091d1;}async[_0x3411d9(0x15f)](_0x3f4b34,_0x1df21b){const _0x5d1c43=_0x3411d9,_0x3b39c9=await this[_0x5d1c43(0x135)][_0x5d1c43(0x188)]([_0x5d1c43(0x190)]),_0x154b5c=await this['globalConfigService']['getConfigs']([_0x5d1c43(0x145)]),_0x42f110=(0x0,utils_1[_0x5d1c43(0x169)])(process[_0x5d1c43(0x168)][_0x5d1c43(0x177)]||'https://api.weixin.qq.com'),_0x5dbf0e=await axios_1[_0x5d1c43(0x171)][_0x5d1c43(0x150)](_0x42f110+_0x5d1c43(0x189)+_0x3b39c9+'&secret='+_0x154b5c+'&code='+_0x1df21b+_0x5d1c43(0x182)),{data:{errmsg:_0x5827be,openid:_0x54b180}}=_0x5dbf0e;if(_0x5827be)throw new common_1[(_0x5d1c43(0x13b))](_0x5827be,common_1[_0x5d1c43(0x14b)][_0x5d1c43(0x134)]);let _0x21a037;return _0x21a037=await this[_0x5d1c43(0x174)]['getUserOpenId'](_0x54b180),!_0x21a037&&(_0x21a037=await this['userService'][_0x5d1c43(0x183)](_0x54b180)),this['authService']['loginByOpenId'](_0x21a037,_0x3f4b34);}async[_0x3411d9(0x18a)](_0x4a959e,_0x1a2d65){const _0x5616b1=_0x3411d9;try{common_1[_0x5616b1(0x133)][_0x5616b1(0x154)]('Scanning\x20with\x20openID:\x20'+_0x4a959e+_0x5616b1(0x19b)+_0x1a2d65,_0x5616b1(0x184));if(!this['sceneStrMap'][_0x1a2d65]){common_1[_0x5616b1(0x133)][_0x5616b1(0x180)](_0x5616b1(0x196)+_0x1a2d65);throw new common_1['HttpException'](_0x5616b1(0x16f),common_1['HttpStatus'][_0x5616b1(0x134)]);}const _0x3c6b54=await this[_0x5616b1(0x174)]['getUserFromOpenId'](_0x4a959e,_0x1a2d65);common_1[_0x5616b1(0x133)][_0x5616b1(0x154)]('User\x20found:\x20'+(_0x3c6b54?_0x3c6b54['id']:'No\x20user\x20found'),_0x5616b1(0x184)),this[_0x5616b1(0x147)][_0x1a2d65]=_0x3c6b54['id'];}catch(_0x22adf9){common_1['Logger'][_0x5616b1(0x180)](_0x5616b1(0x176),_0x22adf9['message']),common_1[_0x5616b1(0x133)][_0x5616b1(0x180)](_0x5616b1(0x132),_0x22adf9[_0x5616b1(0x175)]);throw new common_1[(_0x5616b1(0x13b))]('处理扫码事件时发生错误',common_1[_0x5616b1(0x14b)][_0x5616b1(0x156)]);}}async['loginBySceneStr'](_0x12498d,_0x158301){const _0x23f8bb=_0x3411d9,{sceneStr:_0x579a22}=_0x158301;if(!this[_0x23f8bb(0x159)][_0x579a22])return;const _0x52318c=this[_0x23f8bb(0x147)][_0x579a22];if(!_0x52318c)return'';const _0x15c02a=await this[_0x23f8bb(0x174)][_0x23f8bb(0x136)](_0x52318c);return delete this[_0x23f8bb(0x147)][_0x579a22],this[_0x23f8bb(0x149)]['loginByOpenId'](_0x15c02a,_0x12498d);}async[_0x3411d9(0x19a)](_0x2b0e25,_0x1d9c81){const _0x72c994=_0x3411d9;if(!this[_0x72c994(0x159)][_0x1d9c81])throw new common_1[(_0x72c994(0x13b))](_0x72c994(0x16f),common_1[_0x72c994(0x14b)]['BAD_REQUEST']);const _0x3ce515=_0x1d9c81[_0x72c994(0x13f)]('/')[0x1],_0x4f4a39=await this[_0x72c994(0x174)][_0x72c994(0x16e)](_0x2b0e25,_0x3ce515);this[_0x72c994(0x147)][_0x1d9c81]=_0x4f4a39;}async[_0x3411d9(0x17e)](_0x4e5501,_0x4cb8cc){const _0x4fb423=_0x3411d9;if(!this[_0x4fb423(0x159)][_0x4cb8cc])throw new common_1['HttpException'](_0x4fb423(0x16f),common_1['HttpStatus'][_0x4fb423(0x134)]);const {id:_0x31cd0f}=_0x4e5501[_0x4fb423(0x130)],_0x43d80b=this[_0x4fb423(0x147)][_0x4cb8cc];if(!_0x43d80b)return'';return delete this[_0x4fb423(0x147)][_0x4cb8cc],_0x43d80b;}async[_0x3411d9(0x148)](_0x5a7ca8,_0x3c4d5f,_0x317ba4){const _0x2d256f=_0x3411d9,_0x478093=await this['globalConfigService']['getConfigs']([_0x2d256f(0x17f)])||'';return await this[_0x2d256f(0x162)]([_0x478093,_0x3c4d5f,_0x317ba4][_0x2d256f(0x14c)]()[_0x2d256f(0x173)](''))==_0x5a7ca8;}['sha1'](_0x2819de){const _0x3fd51c=_0x3411d9;return crypto[_0x3fd51c(0x197)](_0x3fd51c(0x162))[_0x3fd51c(0x15d)](_0x2819de)[_0x3fd51c(0x142)](_0x3fd51c(0x14e));}async[_0x3411d9(0x192)](_0x21b0a6,_0x382ce7){const _0x5094ce=_0x3411d9,_0x4875cb=await this['globalConfigService'][_0x5094ce(0x188)]([_0x382ce7]);return this[_0x5094ce(0x15c)](_0x21b0a6,_0x4875cb);}async[_0x3411d9(0x15c)](_0x370d04,_0x4b09ac){const _0x1da026=_0x3411d9;return'\x0a\x20\x20\x20\x20<xml>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<ToUserName><![CDATA['+_0x370d04[_0x1da026(0x139)][0x0]+_0x1da026(0x15e)+_0x370d04['tousername'][0x0]+_0x1da026(0x167)+new Date()[_0x1da026(0x146)]()+'</CreateTime>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<MsgType><![CDATA[text]]></MsgType>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<Content><![CDATA['+_0x4b09ac+']]></Content>\x0a\x20\x20\x20\x20</xml>';}async[_0x3411d9(0x198)](_0x58e665){const _0x1a9593=_0x3411d9,_0x20fdba=new Promise((_0x4d9e4d,_0x1d2ae3)=>{setTimeout(()=>{const _0x50afa9=_0x3825;_0x1d2ae3(new Error(_0x50afa9(0x187)));},0x12c0);});let _0x141a53=await this['globalConfigService']['getConfigs'](['officialAutoReplyText'])||_0x1a9593(0x18d);return _0x141a53;}};function _0x3825(_0x49e815,_0x8f2ba4){const _0x59663f=_0x5966();return _0x3825=function(_0x38255e,_0x1477ff){_0x38255e=_0x38255e-0x130;let _0x575503=_0x59663f[_0x38255e];return _0x575503;},_0x3825(_0x49e815,_0x8f2ba4);}OfficialService=__decorate([(0x0,common_1[_0x3411d9(0x16c)])(),__metadata(_0x3411d9(0x19d),[autoreply_service_1[_0x3411d9(0x13e)],user_service_1[_0x3411d9(0x16a)],auth_service_1['AuthService'],globalConfig_service_1[_0x3411d9(0x140)],chat_service_1['ChatService']])],OfficialService),exports[_0x3411d9(0x184)]=OfficialService;function _0x5966(){const _0x56865f=['GlobalConfigService','&timestamp=','digest','appId:\x20','3224406OilDVB','wechatOfficialAppSecret','getTime','scanedSceneStrMap','verify','authService','/connect/oauth2/authorize?appid=','HttpStatus','sort','&response_type=code&scope=snsapi_base&state=weChatLogin#wechat_redirect','hex','fetchQRCodeTicket','get','1557fNKroI','now','1686999wpUlKL','log','metadata','INTERNAL_SERVER_ERROR','getRedirectUrl','https://api.weixin.qq.com','sceneStrMap','回跳跳转地址:\x20','createRandomNonceStr','genXmlMsg','update',']]></ToUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<FromUserName><![CDATA[','loginByCode','str:\x20','object','sha1','getOwnPropertyDescriptor','defineProperty','function','28820eLiXPm',']]></FromUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<CreateTime>','env','formatUrl','UserService','/cgi-bin/qrcode/create?access_token=','Injectable','461ZSKOMU','bindWx','非法参数','https://open.weixin.qq.com','default','__esModule','join','userService','stack','Error\x20in\x20scan\x20method:','weChatApiUrl','3168305WdTAAc','4288tBmtYq','@nestjs/common','./../autoreply/autoreply.service','decorate','onModuleInit','bindWxBySceneStr','wechatOfficialToken','error','../../common/utils','&grant_type=authorization_code','getUserFromOpenId','OfficialService','getQRCodeTicket','wechatAccessToken','请求超时','getConfigs','/sns/oauth2/access_token?appid=','scan','2880TInqOT','chatgptService','由于公众号的回复限制、过长的问题我们可能无法回复、您可以前往我们的官方站点享受更加完善的服务、如果您有更多问题、欢迎像我提问！','weChatOpenUrl','__decorate','wechatOfficialAppId','getQRSceneStr','genXmlMsgByConfig','getWechatAccessToken','jsapiTicket:\x20','toFixed','非法参数:\x20未找到的\x20sceneStr\x20','createHash','aotoPlay','getJsapiTicket','scanBindWx',',\x20sceneStr:\x20','./../user/user.service','design:paramtypes','372nomYPp','user','length','Stack\x20trace:','Logger','BAD_REQUEST','globalConfigService','getUserById','axios','2352320AIdMqV','fromusername','./../globalConfig/globalConfig.service','HttpException','./../auth/auth.service','&redirect_uri=','AutoreplyService','split'];_0x5966=function(){return _0x56865f;};return _0x5966();}