'use strict';const _0x5166c2=_0x5d08;(function(_0x336bb7,_0x98ef8d){const _0x1dd90f=_0x5d08,_0x2d7ac6=_0x336bb7();while(!![]){try{const _0x49b0a2=parseInt(_0x1dd90f(0x218))/0x1+parseInt(_0x1dd90f(0x20e))/0x2+parseInt(_0x1dd90f(0x208))/0x3+-parseInt(_0x1dd90f(0x225))/0x4+parseInt(_0x1dd90f(0x1d8))/0x5*(parseInt(_0x1dd90f(0x203))/0x6)+parseInt(_0x1dd90f(0x1f7))/0x7*(-parseInt(_0x1dd90f(0x1c7))/0x8)+-parseInt(_0x1dd90f(0x227))/0x9;if(_0x49b0a2===_0x98ef8d)break;else _0x2d7ac6['push'](_0x2d7ac6['shift']());}catch(_0x479506){_0x2d7ac6['push'](_0x2d7ac6['shift']());}}}(_0x293b,0x468d5));var __decorate=this&&this[_0x5166c2(0x233)]||function(_0x259d43,_0x1e511b,_0x4e144d,_0x259bdd){const _0x3601de=_0x5166c2;var _0x7d001d=arguments[_0x3601de(0x228)],_0x1fcf02=_0x7d001d<0x3?_0x1e511b:_0x259bdd===null?_0x259bdd=Object[_0x3601de(0x206)](_0x1e511b,_0x4e144d):_0x259bdd,_0x430ba0;if(typeof Reflect===_0x3601de(0x1ea)&&typeof Reflect[_0x3601de(0x1ff)]==='function')_0x1fcf02=Reflect[_0x3601de(0x1ff)](_0x259d43,_0x1e511b,_0x4e144d,_0x259bdd);else{for(var _0x483581=_0x259d43[_0x3601de(0x228)]-0x1;_0x483581>=0x0;_0x483581--)if(_0x430ba0=_0x259d43[_0x483581])_0x1fcf02=(_0x7d001d<0x3?_0x430ba0(_0x1fcf02):_0x7d001d>0x3?_0x430ba0(_0x1e511b,_0x4e144d,_0x1fcf02):_0x430ba0(_0x1e511b,_0x4e144d))||_0x1fcf02;}return _0x7d001d>0x3&&_0x1fcf02&&Object[_0x3601de(0x209)](_0x1e511b,_0x4e144d,_0x1fcf02),_0x1fcf02;},__metadata=this&&this[_0x5166c2(0x1e0)]||function(_0x1fb2a5,_0x2d7a23){const _0x585bd4=_0x5166c2;if(typeof Reflect==='object'&&typeof Reflect[_0x585bd4(0x1cd)]===_0x585bd4(0x217))return Reflect[_0x585bd4(0x1cd)](_0x1fb2a5,_0x2d7a23);};function _0x5d08(_0xe6575d,_0x36c6b9){const _0x293bef=_0x293b();return _0x5d08=function(_0x5d08d3,_0xfb8b22){_0x5d08d3=_0x5d08d3-0x1c5;let _0x505f5a=_0x293bef[_0x5d08d3];return _0x505f5a;},_0x5d08(_0xe6575d,_0x36c6b9);}Object['defineProperty'](exports,_0x5166c2(0x234),{'value':!![]}),exports[_0x5166c2(0x1d0)]=void 0x0;const utils_1=require(_0x5166c2(0x22b)),common_1=require(_0x5166c2(0x1fe)),axios_1=require(_0x5166c2(0x204)),crypto=require(_0x5166c2(0x1d9)),chat_service_1=require(_0x5166c2(0x1df)),auth_service_1=require(_0x5166c2(0x20f)),autoreply_service_1=require(_0x5166c2(0x20d)),globalConfig_service_1=require(_0x5166c2(0x1d3)),user_service_1=require(_0x5166c2(0x1e9));let OfficialService=class OfficialService{constructor(_0x471e61,_0x3bf143,_0x235e5a,_0x4ebee1,_0x6d6052){const _0x19cbd3=_0x5166c2;this[_0x19cbd3(0x1c6)]=_0x471e61,this[_0x19cbd3(0x220)]=_0x3bf143,this['authService']=_0x235e5a,this[_0x19cbd3(0x1f9)]=_0x4ebee1,this[_0x19cbd3(0x1ce)]=_0x6d6052,this['sceneStrMap']={},this[_0x19cbd3(0x1e2)]={};}async[_0x5166c2(0x1da)](){const _0x98751f=_0x5166c2;await this[_0x98751f(0x1f9)][_0x98751f(0x211)](!![]);}async['getQRSceneStr'](){const _0x5bb380=_0x5166c2;let _0x1c7a8d=(0x0,utils_1['createRandomNonceStr'])(0x20);return this[_0x5bb380(0x1cb)][_0x1c7a8d]=!![],_0x1c7a8d;}async[_0x5166c2(0x21e)](_0x5e5c91){const _0x1fd07e=_0x5166c2,{id:_0x43db63}=_0x5e5c91['user'],_0x3a0bbe=(0x0,utils_1[_0x1fd07e(0x1e7)])(0x20)+'/'+_0x43db63;return this[_0x1fd07e(0x1cb)][_0x3a0bbe]=!![],_0x3a0bbe;}async['getQRCodeTicket'](_0x16dff2){const _0x12fab6=_0x5166c2;return this[_0x12fab6(0x202)](_0x16dff2);}async[_0x5166c2(0x214)](_0x344d0a){const _0x1ce295=_0x5166c2,_0x37d62a=await this['globalConfigService'][_0x1ce295(0x1d1)](['wechatOfficialAppId']),_0xae6574=(0x0,utils_1['formatUrl'])(process[_0x1ce295(0x1ca)][_0x1ce295(0x1de)]||_0x1ce295(0x20a)),_0x4546b7=_0xae6574+_0x1ce295(0x201)+_0x37d62a+'&redirect_uri='+encodeURIComponent(_0x344d0a)+_0x1ce295(0x231);return console[_0x1ce295(0x230)](_0x1ce295(0x22d),_0x4546b7),_0x4546b7;}async[_0x5166c2(0x20c)](_0x2bbc5f){const _0xc4a261=_0x5166c2,_0x33a878=(0x0,utils_1[_0xc4a261(0x1e7)])(0x20),_0x56f9fc=(Date[_0xc4a261(0x216)]()/0x3e8)['toFixed'](0x0),_0x4fbcbb=await this['globalConfigService'][_0xc4a261(0x1d1)]([_0xc4a261(0x226)]);console[_0xc4a261(0x230)](_0xc4a261(0x223),_0x4fbcbb);const _0x596b2b=await this[_0xc4a261(0x1f9)][_0xc4a261(0x1d1)]([_0xc4a261(0x236)]);console[_0xc4a261(0x230)]('appId:\x20',_0x596b2b);const _0x54f2f9=_0xc4a261(0x1d2)+_0x4fbcbb+'&noncestr='+_0x33a878+_0xc4a261(0x213)+_0x56f9fc+'&url='+_0x2bbc5f;console[_0xc4a261(0x230)]('str:\x20',_0x54f2f9);const _0x1b8339=this[_0xc4a261(0x229)](_0x54f2f9);return{'appId':_0x596b2b,'nonceStr':_0x33a878,'timestamp':_0x56f9fc,'signature':_0x1b8339};}async[_0x5166c2(0x202)](_0x5c5ecb){const _0x13efa0=_0x5166c2,_0x53ed26=await this[_0x13efa0(0x1f9)][_0x13efa0(0x1d1)]([_0x13efa0(0x22f)]),_0xfa5e78=(0x0,utils_1[_0x13efa0(0x1e1)])(process[_0x13efa0(0x1ca)][_0x13efa0(0x1d6)]||'https://api.weixin.qq.com'),_0x3fb2cf={'action_name':'QR_STR_SCENE','action_info':{'scene':{'scene_str':_0x5c5ecb}}},_0x1bd2b3=await axios_1[_0x13efa0(0x210)][_0x13efa0(0x20b)](_0xfa5e78+_0x13efa0(0x1dc)+_0x53ed26,_0x3fb2cf),{data:{errmsg:_0x4b5f20,ticket:_0x273694}}=_0x1bd2b3;if(_0x4b5f20)throw new common_1['HttpException'](_0x4b5f20,common_1[_0x13efa0(0x219)][_0x13efa0(0x212)]);return _0x273694;}async[_0x5166c2(0x222)](_0x37c962,_0x2ae620){const _0x336475=_0x5166c2,_0x1baadc=await this[_0x336475(0x1f9)][_0x336475(0x1d1)]([_0x336475(0x236)]),_0x3da118=await this[_0x336475(0x1f9)][_0x336475(0x1d1)]([_0x336475(0x1f8)]),_0x118f19=(0x0,utils_1[_0x336475(0x1e1)])(process[_0x336475(0x1ca)][_0x336475(0x1d6)]||_0x336475(0x1f5)),_0x5dc751=await axios_1[_0x336475(0x210)][_0x336475(0x22a)](_0x118f19+_0x336475(0x1e8)+_0x1baadc+'&secret='+_0x3da118+'&code='+_0x2ae620+'&grant_type=authorization_code'),{data:{errmsg:_0x2c7635,openid:_0x37fe7b}}=_0x5dc751;if(_0x2c7635)throw new common_1['HttpException'](_0x2c7635,common_1[_0x336475(0x219)][_0x336475(0x212)]);let _0x11379a;return _0x11379a=await this[_0x336475(0x220)][_0x336475(0x1d4)](_0x37fe7b),!_0x11379a&&(_0x11379a=await this[_0x336475(0x220)][_0x336475(0x1f1)](_0x37fe7b)),this[_0x336475(0x1f4)][_0x336475(0x1eb)](_0x11379a,_0x37c962);}async[_0x5166c2(0x21f)](_0x545ba3,_0x5df9b1){const _0xa8efff=_0x5166c2;try{common_1['Logger']['log']('Scanning\x20with\x20openID:\x20'+_0x545ba3+_0xa8efff(0x1c8)+_0x5df9b1,'OfficialService');if(!this[_0xa8efff(0x1cb)][_0x5df9b1]){common_1[_0xa8efff(0x1f2)][_0xa8efff(0x1e5)](_0xa8efff(0x21d)+_0x5df9b1);throw new common_1['HttpException']('非法参数',common_1[_0xa8efff(0x219)][_0xa8efff(0x212)]);}const _0x54225d=await this[_0xa8efff(0x220)]['getUserFromOpenId'](_0x545ba3,_0x5df9b1);common_1[_0xa8efff(0x1f2)][_0xa8efff(0x230)](_0xa8efff(0x1ec)+(_0x54225d?_0x54225d['id']:'No\x20user\x20found'),_0xa8efff(0x1d0)),this[_0xa8efff(0x1e2)][_0x5df9b1]=_0x54225d['id'];}catch(_0x1e2403){common_1['Logger'][_0xa8efff(0x1e5)](_0xa8efff(0x1fd),_0x1e2403[_0xa8efff(0x1db)]),common_1[_0xa8efff(0x1f2)][_0xa8efff(0x1e5)](_0xa8efff(0x1cf),_0x1e2403[_0xa8efff(0x21a)]);throw new common_1[(_0xa8efff(0x1d5))](_0xa8efff(0x1ed),common_1[_0xa8efff(0x219)]['INTERNAL_SERVER_ERROR']);}}async[_0x5166c2(0x221)](_0x295831,_0x3a9f60){const _0x1ea2ba=_0x5166c2,{sceneStr:_0x316a4a}=_0x3a9f60;if(!this[_0x1ea2ba(0x1cb)][_0x316a4a])return;const _0x49016b=this[_0x1ea2ba(0x1e2)][_0x316a4a];if(!_0x49016b)return'';const _0x3ef8f6=await this[_0x1ea2ba(0x220)][_0x1ea2ba(0x1d7)](_0x49016b);return delete this[_0x1ea2ba(0x1e2)][_0x316a4a],this['authService'][_0x1ea2ba(0x1eb)](_0x3ef8f6,_0x295831);}async[_0x5166c2(0x1cc)](_0x480b53,_0x503c45){const _0x466e07=_0x5166c2;if(!this[_0x466e07(0x1cb)][_0x503c45])throw new common_1[(_0x466e07(0x1d5))](_0x466e07(0x1fb),common_1[_0x466e07(0x219)][_0x466e07(0x212)]);const _0x97e8d4=_0x503c45['split']('/')[0x1],_0x1757de=await this[_0x466e07(0x220)]['bindWx'](_0x480b53,_0x97e8d4);this[_0x466e07(0x1e2)][_0x503c45]=_0x1757de;}async[_0x5166c2(0x200)](_0x38d828,_0xb7e306){const _0x50abb8=_0x5166c2;if(!this[_0x50abb8(0x1cb)][_0xb7e306])throw new common_1['HttpException'](_0x50abb8(0x1fb),common_1['HttpStatus'][_0x50abb8(0x212)]);const {id:_0x593825}=_0x38d828[_0x50abb8(0x22c)],_0x134564=this[_0x50abb8(0x1e2)][_0xb7e306];if(!_0x134564)return'';return delete this[_0x50abb8(0x1e2)][_0xb7e306],_0x134564;}async['verify'](_0x3ba8b1,_0x1ce9b5,_0x156490){const _0x18705d=_0x5166c2,_0xf63144=await this[_0x18705d(0x1f9)]['getConfigs'](['wechatOfficialToken'])||'';return await this[_0x18705d(0x229)]([_0xf63144,_0x1ce9b5,_0x156490][_0x18705d(0x1e3)]()[_0x18705d(0x1f3)](''))==_0x3ba8b1;}[_0x5166c2(0x229)](_0x3743f7){const _0x327ba3=_0x5166c2;return crypto[_0x327ba3(0x22e)](_0x327ba3(0x229))[_0x327ba3(0x1f6)](_0x3743f7)[_0x327ba3(0x235)](_0x327ba3(0x1f0));}async[_0x5166c2(0x205)](_0x54691d,_0x154388){const _0x57d738=_0x5166c2,_0x65432f=await this[_0x57d738(0x1f9)][_0x57d738(0x1d1)]([_0x154388]);return this[_0x57d738(0x207)](_0x54691d,_0x65432f);}async[_0x5166c2(0x207)](_0x26f39,_0x52b7f2){const _0x3d3d21=_0x5166c2;return _0x3d3d21(0x1fc)+_0x26f39[_0x3d3d21(0x232)][0x0]+_0x3d3d21(0x21c)+_0x26f39['tousername'][0x0]+_0x3d3d21(0x1e4)+new Date()[_0x3d3d21(0x1fa)]()+_0x3d3d21(0x1dd)+_0x52b7f2+']]></Content>\x0a\x20\x20\x20\x20</xml>';}async[_0x5166c2(0x224)](_0xb2b620){const _0x5786c6=_0x5166c2,_0x560aa2=new Promise((_0x41ba55,_0x7e4594)=>{setTimeout(()=>{_0x7e4594(new Error('请求超时'));},0x12c0);});let _0x22355a=await this[_0x5786c6(0x1f9)]['getConfigs']([_0x5786c6(0x1e6)])||_0x5786c6(0x1c9);return _0x22355a;}};function _0x293b(){const _0x25f957=['sort',']]></FromUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<CreateTime>','error','officialAutoReplyText','createRandomNonceStr','/sns/oauth2/access_token?appid=','./../user/user.service','object','loginByOpenId','User\x20found:\x20','处理扫码事件时发生错误','Injectable','AutoreplyService','hex','getUserFromOpenId','Logger','join','authService','https://api.weixin.qq.com','update','14ucIaaF','wechatOfficialAppSecret','globalConfigService','getTime','非法参数','\x0a\x20\x20\x20\x20<xml>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<ToUserName><![CDATA[','Error\x20in\x20scan\x20method:','@nestjs/common','decorate','bindWxBySceneStr','/connect/oauth2/authorize?appid=','fetchQRCodeTicket','400506yeUWnq','axios','genXmlMsgByConfig','getOwnPropertyDescriptor','genXmlMsg','1457421RUYAfu','defineProperty','https://open.weixin.qq.com','post','getJsapiTicket','./../autoreply/autoreply.service','369638WqmqTC','./../auth/auth.service','default','getWechatAccessToken','BAD_REQUEST','&timestamp=','getRedirectUrl','ChatService','now','function','494019cKAKre','HttpStatus','stack','GlobalConfigService',']]></ToUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<FromUserName><![CDATA[','非法参数:\x20未找到的\x20sceneStr\x20','getQRSceneStrByBind','scan','userService','loginBySceneStr','loginByCode','jsapiTicket:\x20','aotoPlay','1394356PpUspk','wechatJsapiTicket','7047279uaNrfh','length','sha1','get','../../common/utils','user','回跳跳转地址:\x20','createHash','wechatAccessToken','log','&response_type=code&scope=snsapi_base&state=weChatLogin#wechat_redirect','fromusername','__decorate','__esModule','digest','wechatOfficialAppId','UserService','autoreplyService','44192hWjdFi',',\x20sceneStr:\x20','由于公众号的回复限制、过长的问题我们可能无法回复、您可以前往我们的官方站点享受更加完善的服务、如果您有更多问题、欢迎像我提问！','env','sceneStrMap','scanBindWx','metadata','chatgptService','Stack\x20trace:','OfficialService','getConfigs','jsapi_ticket=','./../globalConfig/globalConfig.service','getUserOpenId','HttpException','weChatApiUrl','getUserById','20YpUYAv','crypto','onModuleInit','message','/cgi-bin/qrcode/create?access_token=','</CreateTime>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<MsgType><![CDATA[text]]></MsgType>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<Content><![CDATA[','weChatOpenUrl','../chat/chat.service','__metadata','formatUrl','scanedSceneStrMap'];_0x293b=function(){return _0x25f957;};return _0x293b();}OfficialService=__decorate([(0x0,common_1[_0x5166c2(0x1ee)])(),__metadata('design:paramtypes',[autoreply_service_1[_0x5166c2(0x1ef)],user_service_1[_0x5166c2(0x1c5)],auth_service_1['AuthService'],globalConfig_service_1[_0x5166c2(0x21b)],chat_service_1[_0x5166c2(0x215)]])],OfficialService),exports['OfficialService']=OfficialService;