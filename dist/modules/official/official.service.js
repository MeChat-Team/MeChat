'use strict';function _0x4cb4(_0x12bd07,_0x239bad){const _0x11547e=_0x1154();return _0x4cb4=function(_0x4cb4a0,_0x42340e){_0x4cb4a0=_0x4cb4a0-0x7b;let _0x570fe8=_0x11547e[_0x4cb4a0];return _0x570fe8;},_0x4cb4(_0x12bd07,_0x239bad);}const _0x232c41=_0x4cb4;(function(_0x515497,_0x402363){const _0x471f9f=_0x4cb4,_0x128a5a=_0x515497();while(!![]){try{const _0x18def0=-parseInt(_0x471f9f(0xc7))/0x1*(parseInt(_0x471f9f(0xea))/0x2)+-parseInt(_0x471f9f(0x9f))/0x3*(-parseInt(_0x471f9f(0xa9))/0x4)+-parseInt(_0x471f9f(0xaa))/0x5+-parseInt(_0x471f9f(0x94))/0x6+parseInt(_0x471f9f(0x7f))/0x7*(parseInt(_0x471f9f(0xb1))/0x8)+parseInt(_0x471f9f(0xb9))/0x9+-parseInt(_0x471f9f(0xa0))/0xa;if(_0x18def0===_0x402363)break;else _0x128a5a['push'](_0x128a5a['shift']());}catch(_0x1974fd){_0x128a5a['push'](_0x128a5a['shift']());}}}(_0x1154,0xe65d1));function _0x1154(){const _0x45bb4c=['log','sort','../../common/utils','@nestjs/common','AuthService','error',']]></ToUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<FromUserName><![CDATA[','9244flfjcW','sha1','/cgi-bin/qrcode/create?access_token=','user','digest','length','https://open.weixin.qq.com','jsapi_ticket=','default','authService','./../auth/auth.service','globalConfigService','function','metadata','tousername','weChatOpenUrl','/sns/oauth2/access_token?appid=','AutoreplyService','wechatAccessToken','post','createHash','loginBySceneStr','weChatApiUrl','getUserById','&timestamp=','getQRSceneStrByBind','join','BAD_REQUEST','createRandomNonceStr','chatgptService','scanedSceneStrMap',']]></Content>\x0a\x20\x20\x20\x20</xml>','&url=','https://api.weixin.qq.com','fetchQRCodeTicket','158pABPhL','/connect/oauth2/authorize?appid=','design:paramtypes','formatUrl','wechatOfficialAppId','getQRCodeTicket','QR_STR_SCENE','get','decorate','defineProperty','HttpException','autoreplyService','now','7481789rVigUC','&secret=','loginByOpenId','bindWxBySceneStr','&code=','getWechatAccessToken','officialAutoReplyText','loginByCode','getRedirectUrl','appId:\x20','Error\x20in\x20scan\x20method:','hex','sceneStrMap','非法参数','jsapiTicket:\x20','message','&response_type=code&scope=snsapi_base&state=weChatLogin#wechat_redirect','No\x20user\x20found','genXmlMsgByConfig','OfficialService','userService','3015060baTSuw',']]></FromUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<CreateTime>','getJsapiTicket','Scanning\x20with\x20openID:\x20','回跳跳转地址:\x20','Injectable','getTime','./../globalConfig/globalConfig.service','axios','getConfigs','\x0a\x20\x20\x20\x20<xml>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<ToUserName><![CDATA[','3YfMJtH','6515090JkXztm','</CreateTime>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<MsgType><![CDATA[text]]></MsgType>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<Content><![CDATA[','object','GlobalConfigService','__esModule','bindWx','aotoPlay','Logger','toFixed','4174968xWKMdi','2563980OrCjZa','onModuleInit','处理扫码事件时发生错误','请求超时','__metadata','genXmlMsg','INTERNAL_SERVER_ERROR','8ooobvK','getOwnPropertyDescriptor','HttpStatus','ChatService','&grant_type=authorization_code','scan','../chat/chat.service','getUserFromOpenId','11052819KjVuvN','__decorate','env','wechatOfficialAppSecret','update','stack','str:\x20'];_0x1154=function(){return _0x45bb4c;};return _0x1154();}var __decorate=this&&this[_0x232c41(0xba)]||function(_0x3e5b70,_0x265a84,_0x1e8f8f,_0x35d92a){const _0x94b088=_0x232c41;var _0x35444e=arguments[_0x94b088(0xcc)],_0x5f5761=_0x35444e<0x3?_0x265a84:_0x35d92a===null?_0x35d92a=Object[_0x94b088(0xb2)](_0x265a84,_0x1e8f8f):_0x35d92a,_0x16b666;if(typeof Reflect==='object'&&typeof Reflect[_0x94b088(0xf2)]===_0x94b088(0xd3))_0x5f5761=Reflect['decorate'](_0x3e5b70,_0x265a84,_0x1e8f8f,_0x35d92a);else{for(var _0x145e94=_0x3e5b70[_0x94b088(0xcc)]-0x1;_0x145e94>=0x0;_0x145e94--)if(_0x16b666=_0x3e5b70[_0x145e94])_0x5f5761=(_0x35444e<0x3?_0x16b666(_0x5f5761):_0x35444e>0x3?_0x16b666(_0x265a84,_0x1e8f8f,_0x5f5761):_0x16b666(_0x265a84,_0x1e8f8f))||_0x5f5761;}return _0x35444e>0x3&&_0x5f5761&&Object[_0x94b088(0x7b)](_0x265a84,_0x1e8f8f,_0x5f5761),_0x5f5761;},__metadata=this&&this[_0x232c41(0xae)]||function(_0x1e5767,_0x2ed370){const _0x27db68=_0x232c41;if(typeof Reflect===_0x27db68(0xa2)&&typeof Reflect['metadata']===_0x27db68(0xd3))return Reflect[_0x27db68(0xd4)](_0x1e5767,_0x2ed370);};Object[_0x232c41(0x7b)](exports,_0x232c41(0xa4),{'value':!![]}),exports[_0x232c41(0x92)]=void 0x0;const utils_1=require(_0x232c41(0xc2)),common_1=require(_0x232c41(0xc3)),axios_1=require(_0x232c41(0x9c)),crypto=require('crypto'),chat_service_1=require(_0x232c41(0xb7)),auth_service_1=require(_0x232c41(0xd1)),autoreply_service_1=require('./../autoreply/autoreply.service'),globalConfig_service_1=require(_0x232c41(0x9b)),user_service_1=require('./../user/user.service');let OfficialService=class OfficialService{constructor(_0x246c57,_0x11b7e1,_0x232062,_0x3661ba,_0x17c0cd){const _0x5bd2ab=_0x232c41;this[_0x5bd2ab(0x7d)]=_0x246c57,this['userService']=_0x11b7e1,this[_0x5bd2ab(0xd0)]=_0x232062,this['globalConfigService']=_0x3661ba,this[_0x5bd2ab(0xe4)]=_0x17c0cd,this['sceneStrMap']={},this[_0x5bd2ab(0xe5)]={};}async[_0x232c41(0xab)](){const _0x4fa1f2=_0x232c41;await this[_0x4fa1f2(0xd2)][_0x4fa1f2(0x84)](!![]);}async['getQRSceneStr'](){const _0x4ddd52=_0x232c41;let _0x55a9b0=(0x0,utils_1['createRandomNonceStr'])(0x20);return this[_0x4ddd52(0x8b)][_0x55a9b0]=!![],_0x55a9b0;}async[_0x232c41(0xe0)](_0x15a364){const _0xa82705=_0x232c41,{id:_0x2a5d02}=_0x15a364[_0xa82705(0xca)],_0x4f6733=(0x0,utils_1['createRandomNonceStr'])(0x20)+'/'+_0x2a5d02;return this[_0xa82705(0x8b)][_0x4f6733]=!![],_0x4f6733;}async[_0x232c41(0xef)](_0x199615){const _0x37d7e2=_0x232c41;return this[_0x37d7e2(0xe9)](_0x199615);}async[_0x232c41(0x87)](_0x599cfa){const _0x1adf69=_0x232c41,_0x3a668e=await this[_0x1adf69(0xd2)][_0x1adf69(0x9d)]([_0x1adf69(0xee)]),_0x18ce8b=(0x0,utils_1[_0x1adf69(0xed)])(process['env'][_0x1adf69(0xd6)]||_0x1adf69(0xcd)),_0x3859fa=_0x18ce8b+_0x1adf69(0xeb)+_0x3a668e+'&redirect_uri='+encodeURIComponent(_0x599cfa)+_0x1adf69(0x8f);return console[_0x1adf69(0xc0)](_0x1adf69(0x98),_0x3859fa),_0x3859fa;}async[_0x232c41(0x96)](_0x46c5e4){const _0x147532=_0x232c41,_0x556ade=(0x0,utils_1[_0x147532(0xe3)])(0x20),_0x11a3e5=(Date[_0x147532(0x7e)]()/0x3e8)[_0x147532(0xa8)](0x0),_0x5c97f7=await this[_0x147532(0xd2)][_0x147532(0x9d)](['wechatJsapiTicket']);console[_0x147532(0xc0)](_0x147532(0x8d),_0x5c97f7);const _0x54ff84=await this['globalConfigService'][_0x147532(0x9d)](['wechatOfficialAppId']);console[_0x147532(0xc0)](_0x147532(0x88),_0x54ff84);const _0x4df06d=_0x147532(0xce)+_0x5c97f7+'&noncestr='+_0x556ade+_0x147532(0xdf)+_0x11a3e5+_0x147532(0xe7)+_0x46c5e4;console[_0x147532(0xc0)](_0x147532(0xbf),_0x4df06d);const _0x457a74=this[_0x147532(0xc8)](_0x4df06d);return{'appId':_0x54ff84,'nonceStr':_0x556ade,'timestamp':_0x11a3e5,'signature':_0x457a74};}async[_0x232c41(0xe9)](_0x217f41){const _0x15244f=_0x232c41,_0x14fe37=await this['globalConfigService'][_0x15244f(0x9d)]([_0x15244f(0xd9)]),_0x4ac4fa=(0x0,utils_1[_0x15244f(0xed)])(process['env'][_0x15244f(0xdd)]||'https://api.weixin.qq.com'),_0xf60492={'action_name':_0x15244f(0xf0),'action_info':{'scene':{'scene_str':_0x217f41}}},_0xaca1cf=await axios_1[_0x15244f(0xcf)][_0x15244f(0xda)](_0x4ac4fa+_0x15244f(0xc9)+_0x14fe37,_0xf60492),{data:{errmsg:_0x142e35,ticket:_0x468547}}=_0xaca1cf;if(_0x142e35)throw new common_1[(_0x15244f(0x7c))](_0x142e35,common_1['HttpStatus']['BAD_REQUEST']);return _0x468547;}async[_0x232c41(0x86)](_0x45d43c,_0x5ff9b8){const _0x27d880=_0x232c41,_0x159fd6=await this[_0x27d880(0xd2)][_0x27d880(0x9d)]([_0x27d880(0xee)]),_0x27ddda=await this['globalConfigService'][_0x27d880(0x9d)]([_0x27d880(0xbc)]),_0x3c1e4a=(0x0,utils_1['formatUrl'])(process[_0x27d880(0xbb)][_0x27d880(0xdd)]||_0x27d880(0xe8)),_0x27b1a9=await axios_1[_0x27d880(0xcf)][_0x27d880(0xf1)](_0x3c1e4a+_0x27d880(0xd7)+_0x159fd6+_0x27d880(0x80)+_0x27ddda+_0x27d880(0x83)+_0x5ff9b8+_0x27d880(0xb5)),{data:{errmsg:_0xfca64b,openid:_0x116919}}=_0x27b1a9;if(_0xfca64b)throw new common_1['HttpException'](_0xfca64b,common_1[_0x27d880(0xb3)][_0x27d880(0xe2)]);let _0x1bfd34;return _0x1bfd34=await this[_0x27d880(0x93)]['getUserOpenId'](_0x116919),!_0x1bfd34&&(_0x1bfd34=await this['userService'][_0x27d880(0xb8)](_0x116919)),this[_0x27d880(0xd0)][_0x27d880(0x81)](_0x1bfd34,_0x45d43c);}async[_0x232c41(0xb6)](_0x11d952,_0xd68eb5){const _0x56bbf9=_0x232c41;try{common_1[_0x56bbf9(0xa7)][_0x56bbf9(0xc0)](_0x56bbf9(0x97)+_0x11d952+',\x20sceneStr:\x20'+_0xd68eb5,'OfficialService');if(!this['sceneStrMap'][_0xd68eb5]){common_1[_0x56bbf9(0xa7)]['error']('非法参数:\x20未找到的\x20sceneStr\x20'+_0xd68eb5);throw new common_1[(_0x56bbf9(0x7c))](_0x56bbf9(0x8c),common_1[_0x56bbf9(0xb3)][_0x56bbf9(0xe2)]);}const _0xbf18d3=await this[_0x56bbf9(0x93)][_0x56bbf9(0xb8)](_0x11d952,_0xd68eb5);common_1['Logger']['log']('User\x20found:\x20'+(_0xbf18d3?_0xbf18d3['id']:_0x56bbf9(0x90)),_0x56bbf9(0x92)),this[_0x56bbf9(0xe5)][_0xd68eb5]=_0xbf18d3['id'];}catch(_0x4938a4){common_1[_0x56bbf9(0xa7)][_0x56bbf9(0xc5)](_0x56bbf9(0x89),_0x4938a4[_0x56bbf9(0x8e)]),common_1[_0x56bbf9(0xa7)][_0x56bbf9(0xc5)]('Stack\x20trace:',_0x4938a4[_0x56bbf9(0xbe)]);throw new common_1[(_0x56bbf9(0x7c))](_0x56bbf9(0xac),common_1[_0x56bbf9(0xb3)][_0x56bbf9(0xb0)]);}}async[_0x232c41(0xdc)](_0x2ee632,_0x12d45d){const _0x2ed42e=_0x232c41,{sceneStr:_0x3247f4}=_0x12d45d;if(!this[_0x2ed42e(0x8b)][_0x3247f4])return;const _0x4bce08=this['scanedSceneStrMap'][_0x3247f4];if(!_0x4bce08)return'';const _0x4c2ef9=await this['userService'][_0x2ed42e(0xde)](_0x4bce08);return delete this[_0x2ed42e(0xe5)][_0x3247f4],this['authService'][_0x2ed42e(0x81)](_0x4c2ef9,_0x2ee632);}async['scanBindWx'](_0x5b9ab5,_0x1426e8){const _0x17993c=_0x232c41;if(!this['sceneStrMap'][_0x1426e8])throw new common_1[(_0x17993c(0x7c))](_0x17993c(0x8c),common_1['HttpStatus']['BAD_REQUEST']);const _0xe16bfd=_0x1426e8['split']('/')[0x1],_0x2dc66f=await this[_0x17993c(0x93)][_0x17993c(0xa5)](_0x5b9ab5,_0xe16bfd);this['scanedSceneStrMap'][_0x1426e8]=_0x2dc66f;}async[_0x232c41(0x82)](_0x423590,_0x11bd6f){const _0x301025=_0x232c41;if(!this['sceneStrMap'][_0x11bd6f])throw new common_1[(_0x301025(0x7c))](_0x301025(0x8c),common_1[_0x301025(0xb3)][_0x301025(0xe2)]);const {id:_0x436458}=_0x423590[_0x301025(0xca)],_0x3b4444=this[_0x301025(0xe5)][_0x11bd6f];if(!_0x3b4444)return'';return delete this[_0x301025(0xe5)][_0x11bd6f],_0x3b4444;}async['verify'](_0xde5f40,_0x2b6585,_0x3a412a){const _0x27727e=_0x232c41,_0xf8f61e=await this[_0x27727e(0xd2)][_0x27727e(0x9d)](['wechatOfficialToken'])||'';return await this['sha1']([_0xf8f61e,_0x2b6585,_0x3a412a][_0x27727e(0xc1)]()[_0x27727e(0xe1)](''))==_0xde5f40;}['sha1'](_0x51bb75){const _0x418fb8=_0x232c41;return crypto[_0x418fb8(0xdb)](_0x418fb8(0xc8))[_0x418fb8(0xbd)](_0x51bb75)[_0x418fb8(0xcb)](_0x418fb8(0x8a));}async[_0x232c41(0x91)](_0xea2524,_0x139d30){const _0x208abd=_0x232c41,_0x5b1952=await this[_0x208abd(0xd2)][_0x208abd(0x9d)]([_0x139d30]);return this[_0x208abd(0xaf)](_0xea2524,_0x5b1952);}async[_0x232c41(0xaf)](_0x12e1d8,_0x5c71be){const _0x12caa7=_0x232c41;return _0x12caa7(0x9e)+_0x12e1d8['fromusername'][0x0]+_0x12caa7(0xc6)+_0x12e1d8[_0x12caa7(0xd5)][0x0]+_0x12caa7(0x95)+new Date()[_0x12caa7(0x9a)]()+_0x12caa7(0xa1)+_0x5c71be+_0x12caa7(0xe6);}async[_0x232c41(0xa6)](_0x440b27){const _0x183e45=_0x232c41,_0x4eb967=new Promise((_0x3f16bb,_0x35adad)=>{setTimeout(()=>{const _0x12ff47=_0x4cb4;_0x35adad(new Error(_0x12ff47(0xad)));},0x12c0);});let _0x2e4fb6=await this[_0x183e45(0xd2)][_0x183e45(0x9d)]([_0x183e45(0x85)])||'由于公众号的回复限制、过长的问题我们可能无法回复、您可以前往我们的官方站点享受更加完善的服务、如果您有更多问题、欢迎像我提问！';return _0x2e4fb6;}};OfficialService=__decorate([(0x0,common_1[_0x232c41(0x99)])(),__metadata(_0x232c41(0xec),[autoreply_service_1[_0x232c41(0xd8)],user_service_1['UserService'],auth_service_1[_0x232c41(0xc4)],globalConfig_service_1[_0x232c41(0xa3)],chat_service_1[_0x232c41(0xb4)]])],OfficialService),exports[_0x232c41(0x92)]=OfficialService;