'use strict';const _0x274843=_0x2383;(function(_0x9887d2,_0x1a9dd4){const _0x3f501c=_0x2383,_0x4e3167=_0x9887d2();while(!![]){try{const _0x10623c=-parseInt(_0x3f501c(0x109))/0x1*(-parseInt(_0x3f501c(0x145))/0x2)+parseInt(_0x3f501c(0x16a))/0x3*(-parseInt(_0x3f501c(0x139))/0x4)+-parseInt(_0x3f501c(0x12f))/0x5*(parseInt(_0x3f501c(0x120))/0x6)+parseInt(_0x3f501c(0x163))/0x7*(-parseInt(_0x3f501c(0x14c))/0x8)+-parseInt(_0x3f501c(0x11c))/0x9+-parseInt(_0x3f501c(0x16b))/0xa*(parseInt(_0x3f501c(0x111))/0xb)+parseInt(_0x3f501c(0x133))/0xc;if(_0x10623c===_0x1a9dd4)break;else _0x4e3167['push'](_0x4e3167['shift']());}catch(_0x474ac9){_0x4e3167['push'](_0x4e3167['shift']());}}}(_0x544c,0x500e0));function _0x2383(_0x118547,_0x14c48d){const _0x544cbe=_0x544c();return _0x2383=function(_0x238346,_0x331f7b){_0x238346=_0x238346-0x105;let _0x1136a7=_0x544cbe[_0x238346];return _0x1136a7;},_0x2383(_0x118547,_0x14c48d);}var __decorate=this&&this[_0x274843(0x155)]||function(_0x105a78,_0x2468d1,_0x2ab7c8,_0x7ffdf2){const _0x4f4b4c=_0x274843;var _0x3a3f87=arguments['length'],_0x3a6ac3=_0x3a3f87<0x3?_0x2468d1:_0x7ffdf2===null?_0x7ffdf2=Object[_0x4f4b4c(0x11b)](_0x2468d1,_0x2ab7c8):_0x7ffdf2,_0x1ddcc2;if(typeof Reflect===_0x4f4b4c(0x13d)&&typeof Reflect[_0x4f4b4c(0x16f)]==='function')_0x3a6ac3=Reflect[_0x4f4b4c(0x16f)](_0x105a78,_0x2468d1,_0x2ab7c8,_0x7ffdf2);else{for(var _0x243d9e=_0x105a78[_0x4f4b4c(0x162)]-0x1;_0x243d9e>=0x0;_0x243d9e--)if(_0x1ddcc2=_0x105a78[_0x243d9e])_0x3a6ac3=(_0x3a3f87<0x3?_0x1ddcc2(_0x3a6ac3):_0x3a3f87>0x3?_0x1ddcc2(_0x2468d1,_0x2ab7c8,_0x3a6ac3):_0x1ddcc2(_0x2468d1,_0x2ab7c8))||_0x3a6ac3;}return _0x3a3f87>0x3&&_0x3a6ac3&&Object[_0x4f4b4c(0x144)](_0x2468d1,_0x2ab7c8,_0x3a6ac3),_0x3a6ac3;},__metadata=this&&this[_0x274843(0x124)]||function(_0x5d2b2a,_0x3a0618){const _0x428791=_0x274843;if(typeof Reflect===_0x428791(0x13d)&&typeof Reflect[_0x428791(0x159)]===_0x428791(0x14b))return Reflect[_0x428791(0x159)](_0x5d2b2a,_0x3a0618);};Object[_0x274843(0x144)](exports,'__esModule',{'value':!![]}),exports[_0x274843(0x146)]=void 0x0;const utils_1=require(_0x274843(0x105)),common_1=require('@nestjs/common'),axios_1=require(_0x274843(0x16c)),crypto=require(_0x274843(0x11e)),chat_service_1=require(_0x274843(0x117)),auth_service_1=require(_0x274843(0x158)),autoreply_service_1=require(_0x274843(0x142)),globalConfig_service_1=require(_0x274843(0x166)),user_service_1=require('./../user/user.service');function _0x544c(){const _0x5c478b=['decorate','处理扫码事件时发生错误','env','error','HttpStatus','\x0a\x20\x20\x20\x20<xml>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<ToUserName><![CDATA[','bindWxBySceneStr','Scanning\x20with\x20openID:\x20','../../common/utils','/connect/oauth2/authorize?appid=','getJsapiTicket','join','1biGhzy','jsapi_ticket=','GlobalConfigService','getWechatAccessToken','autoreplyService','loginByOpenId','getRedirectUrl','log','11fBvJNM','&redirect_uri=','weChatOpenUrl','ChatService','Error\x20in\x20scan\x20method:','split','../chat/chat.service','BAD_REQUEST','&url=','createRandomNonceStr','getOwnPropertyDescriptor','1102860ZPSgmh','jsapiTicket:\x20','crypto','sha1','6VvEscX','now','post','非法参数','__metadata','wechatOfficialAppId',']]></ToUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<FromUserName><![CDATA[','formatUrl','str:\x20','tousername','authService','&code=','scan','&noncestr=','userService','1819025TxNRYP','design:paramtypes','default','bindWx','15702912lDiWbS','sceneStrMap','&timestamp=','QR_STR_SCENE','message','user','276XPxyGv','getConfigs','wechatOfficialToken','AuthService','object','No\x20user\x20found',',\x20sceneStr:\x20','getUserFromOpenId','回跳跳转地址:\x20','./../autoreply/autoreply.service','globalConfigService','defineProperty','820766tZVsUH','OfficialService','Logger','verify','HttpException','digest','function','1136KjdkbH','getQRSceneStrByBind','scanedSceneStrMap','https://api.weixin.qq.com','officialAutoReplyText','Injectable','/sns/oauth2/access_token?appid=',']]></Content>\x0a\x20\x20\x20\x20</xml>','loginBySceneStr','__decorate','genXmlMsg','AutoreplyService','./../auth/auth.service','metadata','&secret=','&response_type=code&scope=snsapi_base&state=weChatLogin#wechat_redirect','getUserById','请求超时',']]></FromUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<CreateTime>','User\x20found:\x20','appId:\x20','wechatAccessToken','length','23429FhExFq','INTERNAL_SERVER_ERROR','weChatApiUrl','./../globalConfig/globalConfig.service','createHash','fetchQRCodeTicket','</CreateTime>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<MsgType><![CDATA[text]]></MsgType>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<Content><![CDATA[','12837pqdEXN','1341850DLQXub','axios','onModuleInit','https://open.weixin.qq.com'];_0x544c=function(){return _0x5c478b;};return _0x544c();}let OfficialService=class OfficialService{constructor(_0x1ec225,_0x514fcd,_0x51b4e2,_0x3a08f3,_0x1c88da){const _0x5170f1=_0x274843;this[_0x5170f1(0x10d)]=_0x1ec225,this[_0x5170f1(0x12e)]=_0x514fcd,this[_0x5170f1(0x12a)]=_0x51b4e2,this[_0x5170f1(0x143)]=_0x3a08f3,this['chatgptService']=_0x1c88da,this['sceneStrMap']={},this[_0x5170f1(0x14e)]={};}async[_0x274843(0x16d)](){const _0x9b669b=_0x274843;await this[_0x9b669b(0x143)][_0x9b669b(0x10c)](!![]);}async['getQRSceneStr'](){const _0x3037b5=_0x274843;let _0x4cf75e=(0x0,utils_1[_0x3037b5(0x11a)])(0x20);return this[_0x3037b5(0x134)][_0x4cf75e]=!![],_0x4cf75e;}async[_0x274843(0x14d)](_0x4131bb){const _0x3b67e1=_0x274843,{id:_0x1168ff}=_0x4131bb[_0x3b67e1(0x138)],_0x17b774=(0x0,utils_1[_0x3b67e1(0x11a)])(0x20)+'/'+_0x1168ff;return this[_0x3b67e1(0x134)][_0x17b774]=!![],_0x17b774;}async['getQRCodeTicket'](_0x30398d){const _0x1e4460=_0x274843;return this[_0x1e4460(0x168)](_0x30398d);}async[_0x274843(0x10f)](_0x234205){const _0x2f3453=_0x274843,_0x225c2f=await this[_0x2f3453(0x143)][_0x2f3453(0x13a)](['wechatOfficialAppId']),_0x135dfa=(0x0,utils_1[_0x2f3453(0x127)])(process['env'][_0x2f3453(0x113)]||_0x2f3453(0x16e)),_0x4eb892=_0x135dfa+_0x2f3453(0x106)+_0x225c2f+_0x2f3453(0x112)+encodeURIComponent(_0x234205)+_0x2f3453(0x15b);return console['log'](_0x2f3453(0x141),_0x4eb892),_0x4eb892;}async[_0x274843(0x107)](_0x42d8c9){const _0x72cd17=_0x274843,_0x173bfd=(0x0,utils_1[_0x72cd17(0x11a)])(0x20),_0x5212ef=(Date[_0x72cd17(0x121)]()/0x3e8)['toFixed'](0x0),_0x23fe3c=await this['globalConfigService'][_0x72cd17(0x13a)](['wechatJsapiTicket']);console['log'](_0x72cd17(0x11d),_0x23fe3c);const _0x5f057b=await this[_0x72cd17(0x143)]['getConfigs']([_0x72cd17(0x125)]);console['log'](_0x72cd17(0x160),_0x5f057b);const _0x308dac=_0x72cd17(0x10a)+_0x23fe3c+_0x72cd17(0x12d)+_0x173bfd+_0x72cd17(0x135)+_0x5212ef+_0x72cd17(0x119)+_0x42d8c9;console[_0x72cd17(0x110)](_0x72cd17(0x128),_0x308dac);const _0x3b2f70=this['sha1'](_0x308dac);return{'appId':_0x5f057b,'nonceStr':_0x173bfd,'timestamp':_0x5212ef,'signature':_0x3b2f70};}async[_0x274843(0x168)](_0x2dadfa){const _0x583ee3=_0x274843,_0x155220=await this[_0x583ee3(0x143)][_0x583ee3(0x13a)]([_0x583ee3(0x161)]),_0x8f48a6=(0x0,utils_1[_0x583ee3(0x127)])(process[_0x583ee3(0x171)][_0x583ee3(0x165)]||_0x583ee3(0x14f)),_0x2467af={'action_name':_0x583ee3(0x136),'action_info':{'scene':{'scene_str':_0x2dadfa}}},_0x44bfcf=await axios_1[_0x583ee3(0x131)][_0x583ee3(0x122)](_0x8f48a6+'/cgi-bin/qrcode/create?access_token='+_0x155220,_0x2467af),{data:{errmsg:_0x71aa0c,ticket:_0x266d52}}=_0x44bfcf;if(_0x71aa0c)throw new common_1['HttpException'](_0x71aa0c,common_1[_0x583ee3(0x173)][_0x583ee3(0x118)]);return _0x266d52;}async['loginByCode'](_0x2cd2b3,_0x5d9ecc){const _0x105fbe=_0x274843,_0x149af3=await this['globalConfigService'][_0x105fbe(0x13a)]([_0x105fbe(0x125)]),_0x3226c3=await this[_0x105fbe(0x143)][_0x105fbe(0x13a)](['wechatOfficialAppSecret']),_0x262b20=(0x0,utils_1[_0x105fbe(0x127)])(process[_0x105fbe(0x171)][_0x105fbe(0x165)]||'https://api.weixin.qq.com'),_0x370eb7=await axios_1[_0x105fbe(0x131)]['get'](_0x262b20+_0x105fbe(0x152)+_0x149af3+_0x105fbe(0x15a)+_0x3226c3+_0x105fbe(0x12b)+_0x5d9ecc+'&grant_type=authorization_code'),{data:{errmsg:_0x5a247f,openid:_0x5d3d1f}}=_0x370eb7;if(_0x5a247f)throw new common_1[(_0x105fbe(0x149))](_0x5a247f,common_1[_0x105fbe(0x173)][_0x105fbe(0x118)]);let _0x2d1a2b;return _0x2d1a2b=await this[_0x105fbe(0x12e)]['getUserOpenId'](_0x5d3d1f),!_0x2d1a2b&&(_0x2d1a2b=await this[_0x105fbe(0x12e)][_0x105fbe(0x140)](_0x5d3d1f)),this['authService'][_0x105fbe(0x10e)](_0x2d1a2b,_0x2cd2b3);}async[_0x274843(0x12c)](_0x415034,_0x5730d7){const _0x429786=_0x274843;try{common_1[_0x429786(0x147)]['log'](_0x429786(0x176)+_0x415034+_0x429786(0x13f)+_0x5730d7,_0x429786(0x146));if(!this[_0x429786(0x134)][_0x5730d7]){common_1['Logger'][_0x429786(0x172)]('非法参数:\x20未找到的\x20sceneStr\x20'+_0x5730d7);throw new common_1[(_0x429786(0x149))]('非法参数',common_1[_0x429786(0x173)]['BAD_REQUEST']);}const _0x5aed90=await this[_0x429786(0x12e)]['getUserFromOpenId'](_0x415034,_0x5730d7);common_1[_0x429786(0x147)][_0x429786(0x110)](_0x429786(0x15f)+(_0x5aed90?_0x5aed90['id']:_0x429786(0x13e)),'OfficialService'),this[_0x429786(0x14e)][_0x5730d7]=_0x5aed90['id'];}catch(_0x3b3ca3){common_1[_0x429786(0x147)][_0x429786(0x172)](_0x429786(0x115),_0x3b3ca3[_0x429786(0x137)]),common_1['Logger']['error']('Stack\x20trace:',_0x3b3ca3['stack']);throw new common_1[(_0x429786(0x149))](_0x429786(0x170),common_1[_0x429786(0x173)][_0x429786(0x164)]);}}async[_0x274843(0x154)](_0xd28e83,_0x3523e5){const _0x237768=_0x274843,{sceneStr:_0x509c28}=_0x3523e5;if(!this[_0x237768(0x134)][_0x509c28])return;const _0xf30e88=this[_0x237768(0x14e)][_0x509c28];if(!_0xf30e88)return'';const _0x47442a=await this[_0x237768(0x12e)][_0x237768(0x15c)](_0xf30e88);return delete this['scanedSceneStrMap'][_0x509c28],this[_0x237768(0x12a)][_0x237768(0x10e)](_0x47442a,_0xd28e83);}async['scanBindWx'](_0x5de362,_0x32dd9c){const _0x505c37=_0x274843;if(!this[_0x505c37(0x134)][_0x32dd9c])throw new common_1[(_0x505c37(0x149))](_0x505c37(0x123),common_1[_0x505c37(0x173)][_0x505c37(0x118)]);const _0x45c2e5=_0x32dd9c[_0x505c37(0x116)]('/')[0x1],_0x2a17a0=await this[_0x505c37(0x12e)][_0x505c37(0x132)](_0x5de362,_0x45c2e5);this[_0x505c37(0x14e)][_0x32dd9c]=_0x2a17a0;}async[_0x274843(0x175)](_0x2444d1,_0x291a86){const _0x47587e=_0x274843;if(!this[_0x47587e(0x134)][_0x291a86])throw new common_1[(_0x47587e(0x149))](_0x47587e(0x123),common_1[_0x47587e(0x173)][_0x47587e(0x118)]);const {id:_0x45d67b}=_0x2444d1[_0x47587e(0x138)],_0x51916f=this['scanedSceneStrMap'][_0x291a86];if(!_0x51916f)return'';return delete this[_0x47587e(0x14e)][_0x291a86],_0x51916f;}async[_0x274843(0x148)](_0x190dfe,_0x1a56d5,_0x4ade4d){const _0x190e83=_0x274843,_0x3d6f69=await this[_0x190e83(0x143)]['getConfigs']([_0x190e83(0x13b)])||'';return await this[_0x190e83(0x11f)]([_0x3d6f69,_0x1a56d5,_0x4ade4d]['sort']()[_0x190e83(0x108)](''))==_0x190dfe;}['sha1'](_0x507be4){const _0x24f135=_0x274843;return crypto[_0x24f135(0x167)](_0x24f135(0x11f))['update'](_0x507be4)[_0x24f135(0x14a)]('hex');}async['genXmlMsgByConfig'](_0x6eaaf4,_0x3950a2){const _0x216eff=_0x274843,_0x5322f3=await this[_0x216eff(0x143)][_0x216eff(0x13a)]([_0x3950a2]);return this[_0x216eff(0x156)](_0x6eaaf4,_0x5322f3);}async['genXmlMsg'](_0x3ca3f1,_0xb0c4ed){const _0x546a91=_0x274843;return _0x546a91(0x174)+_0x3ca3f1['fromusername'][0x0]+_0x546a91(0x126)+_0x3ca3f1[_0x546a91(0x129)][0x0]+_0x546a91(0x15e)+new Date()['getTime']()+_0x546a91(0x169)+_0xb0c4ed+_0x546a91(0x153);}async['aotoPlay'](_0x107053){const _0x146316=_0x274843,_0x31377c=new Promise((_0x3a6130,_0xb54172)=>{setTimeout(()=>{const _0x508555=_0x2383;_0xb54172(new Error(_0x508555(0x15d)));},0x12c0);});let _0x5122cf=await this['globalConfigService']['getConfigs']([_0x146316(0x150)])||'由于公众号的回复限制、过长的问题我们可能无法回复、您可以前往我们的官方站点享受更加完善的服务、如果您有更多问题、欢迎像我提问！';return _0x5122cf;}};OfficialService=__decorate([(0x0,common_1[_0x274843(0x151)])(),__metadata(_0x274843(0x130),[autoreply_service_1[_0x274843(0x157)],user_service_1['UserService'],auth_service_1[_0x274843(0x13c)],globalConfig_service_1[_0x274843(0x10b)],chat_service_1[_0x274843(0x114)]])],OfficialService),exports[_0x274843(0x146)]=OfficialService;