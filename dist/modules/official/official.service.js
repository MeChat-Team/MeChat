'use strict';const _0x2586de=_0x45bf;function _0x45bf(_0x1b33ba,_0x1efa57){const _0x150ae4=_0x150a();return _0x45bf=function(_0x45bfb6,_0x43d206){_0x45bfb6=_0x45bfb6-0x1b6;let _0x18eab7=_0x150ae4[_0x45bfb6];return _0x18eab7;},_0x45bf(_0x1b33ba,_0x1efa57);}(function(_0x56b73e,_0x810c1e){const _0x16daa9=_0x45bf,_0x309450=_0x56b73e();while(!![]){try{const _0xf950fd=-parseInt(_0x16daa9(0x21c))/0x1*(-parseInt(_0x16daa9(0x204))/0x2)+-parseInt(_0x16daa9(0x1c0))/0x3*(-parseInt(_0x16daa9(0x224))/0x4)+parseInt(_0x16daa9(0x1ef))/0x5*(parseInt(_0x16daa9(0x1e0))/0x6)+-parseInt(_0x16daa9(0x1f1))/0x7*(-parseInt(_0x16daa9(0x1d9))/0x8)+parseInt(_0x16daa9(0x1e6))/0x9*(parseInt(_0x16daa9(0x1e8))/0xa)+parseInt(_0x16daa9(0x1fd))/0xb+-parseInt(_0x16daa9(0x20f))/0xc;if(_0xf950fd===_0x810c1e)break;else _0x309450['push'](_0x309450['shift']());}catch(_0x226dba){_0x309450['push'](_0x309450['shift']());}}}(_0x150a,0xb5a85));var __decorate=this&&this['__decorate']||function(_0x20778b,_0x696dc1,_0x313638,_0x36b354){const _0x1e2516=_0x45bf;var _0x5e9a89=arguments[_0x1e2516(0x1f8)],_0x31481d=_0x5e9a89<0x3?_0x696dc1:_0x36b354===null?_0x36b354=Object[_0x1e2516(0x1fa)](_0x696dc1,_0x313638):_0x36b354,_0x2d13cc;if(typeof Reflect===_0x1e2516(0x1c3)&&typeof Reflect['decorate']===_0x1e2516(0x1d5))_0x31481d=Reflect[_0x1e2516(0x222)](_0x20778b,_0x696dc1,_0x313638,_0x36b354);else{for(var _0x1feddc=_0x20778b['length']-0x1;_0x1feddc>=0x0;_0x1feddc--)if(_0x2d13cc=_0x20778b[_0x1feddc])_0x31481d=(_0x5e9a89<0x3?_0x2d13cc(_0x31481d):_0x5e9a89>0x3?_0x2d13cc(_0x696dc1,_0x313638,_0x31481d):_0x2d13cc(_0x696dc1,_0x313638))||_0x31481d;}return _0x5e9a89>0x3&&_0x31481d&&Object[_0x1e2516(0x202)](_0x696dc1,_0x313638,_0x31481d),_0x31481d;},__metadata=this&&this[_0x2586de(0x1b6)]||function(_0x5aa8fb,_0x2a4b36){const _0x1541b3=_0x2586de;if(typeof Reflect===_0x1541b3(0x1c3)&&typeof Reflect['metadata']===_0x1541b3(0x1d5))return Reflect[_0x1541b3(0x1ba)](_0x5aa8fb,_0x2a4b36);};Object[_0x2586de(0x202)](exports,_0x2586de(0x206),{'value':!![]}),exports['OfficialService']=void 0x0;const utils_1=require(_0x2586de(0x1c9)),common_1=require(_0x2586de(0x205)),axios_1=require(_0x2586de(0x1d6)),crypto=require(_0x2586de(0x1c5)),chat_service_1=require(_0x2586de(0x1ce)),auth_service_1=require(_0x2586de(0x1ff)),autoreply_service_1=require(_0x2586de(0x1f7)),globalConfig_service_1=require(_0x2586de(0x1c4)),user_service_1=require(_0x2586de(0x1f3));function _0x150a(){const _0x46edc4=['object','./../globalConfig/globalConfig.service','crypto','wechatOfficialToken','QR_STR_SCENE','HttpStatus','../../common/utils','authService','HttpException','user','globalConfigService','../chat/chat.service','env','scanedSceneStrMap','createHash','autoreplyService','stack','/sns/oauth2/access_token?appid=','function','axios',']]></ToUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<FromUserName><![CDATA[','https://open.weixin.qq.com','224Btwnth','post',']]></Content>\x0a\x20\x20\x20\x20</xml>','/cgi-bin/qrcode/create?access_token=','log','https://api.weixin.qq.com','由于公众号的回复限制、过长的问题我们可能无法回复、您可以前往我们的官方站点享受更加完善的服务、如果您有更多问题、欢迎像我提问！','772782xgnSDQ','toFixed','default','&grant_type=authorization_code','onModuleInit','genXmlMsg','72aVxBtP','INTERNAL_SERVER_ERROR','1209940JxhnPp','&response_type=code&scope=snsapi_base&state=weChatLogin#wechat_redirect','error','OfficialService','officialAutoReplyText','非法参数:\x20未找到的\x20sceneStr\x20','GlobalConfigService','40UFYfLK','BAD_REQUEST','121744QunuTm','getQRSceneStrByBind','./../user/user.service','回跳跳转地址:\x20','aotoPlay','split','./../autoreply/autoreply.service','length',']]></FromUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<CreateTime>','getOwnPropertyDescriptor','join','createRandomNonceStr','4001976enbocG','chatgptService','./../auth/auth.service','处理扫码事件时发生错误','fetchQRCodeTicket','defineProperty','User\x20found:\x20','1942tVFLHC','@nestjs/common','__esModule','bindWxBySceneStr','loginByOpenId','Logger','getUserOpenId','sha1','getQRSceneStr','weChatApiUrl','design:paramtypes','33035856ndnoOr','非法参数','str:\x20','&timestamp=','digest','hex','bindWx','getWechatAccessToken','message','jsapi_ticket=','wechatAccessToken','sort','Stack\x20trace:','35RVDaEY','appId:\x20','fromusername','Injectable','userService','loginBySceneStr','decorate','now','724bROtce','</CreateTime>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<MsgType><![CDATA[text]]></MsgType>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<Content><![CDATA[','getUserFromOpenId','update','genXmlMsgByConfig','loginByCode','wechatJsapiTicket','\x0a\x20\x20\x20\x20<xml>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<ToUserName><![CDATA[','AutoreplyService','Error\x20in\x20scan\x20method:','&secret=','__metadata',',\x20sceneStr:\x20','sceneStrMap','wechatOfficialAppId','metadata','scanBindWx','getTime','getUserById','getJsapiTicket','formatUrl','10176vrtDBt','weChatOpenUrl','getConfigs'];_0x150a=function(){return _0x46edc4;};return _0x150a();}let OfficialService=class OfficialService{constructor(_0x35ad5d,_0x1ab8fd,_0x30b071,_0xb46c3e,_0x4059e6){const _0x5033ca=_0x2586de;this[_0x5033ca(0x1d2)]=_0x35ad5d,this[_0x5033ca(0x220)]=_0x1ab8fd,this[_0x5033ca(0x1ca)]=_0x30b071,this[_0x5033ca(0x1cd)]=_0xb46c3e,this[_0x5033ca(0x1fe)]=_0x4059e6,this[_0x5033ca(0x1b8)]={},this[_0x5033ca(0x1d0)]={};}async[_0x2586de(0x1e4)](){const _0x4e3fe4=_0x2586de;await this[_0x4e3fe4(0x1cd)][_0x4e3fe4(0x216)](!![]);}async[_0x2586de(0x20c)](){const _0x9b073f=_0x2586de;let _0x449b99=(0x0,utils_1['createRandomNonceStr'])(0x20);return this[_0x9b073f(0x1b8)][_0x449b99]=!![],_0x449b99;}async[_0x2586de(0x1f2)](_0x6619c0){const _0x15833d=_0x2586de,{id:_0x3d86dd}=_0x6619c0[_0x15833d(0x1cc)],_0x44876a=(0x0,utils_1[_0x15833d(0x1fc)])(0x20)+'/'+_0x3d86dd;return this[_0x15833d(0x1b8)][_0x44876a]=!![],_0x44876a;}async['getQRCodeTicket'](_0x510b96){const _0x434e35=_0x2586de;return this[_0x434e35(0x201)](_0x510b96);}async['getRedirectUrl'](_0x1a83d5){const _0x160653=_0x2586de,_0x3339a1=await this[_0x160653(0x1cd)][_0x160653(0x1c2)](['wechatOfficialAppId']),_0x451734=(0x0,utils_1[_0x160653(0x1bf)])(process['env'][_0x160653(0x1c1)]||_0x160653(0x1d8)),_0x331373=_0x451734+'/connect/oauth2/authorize?appid='+_0x3339a1+'&redirect_uri='+encodeURIComponent(_0x1a83d5)+_0x160653(0x1e9);return console[_0x160653(0x1dd)](_0x160653(0x1f4),_0x331373),_0x331373;}async[_0x2586de(0x1be)](_0x5191b2){const _0x37d374=_0x2586de,_0xb04b17=(0x0,utils_1[_0x37d374(0x1fc)])(0x20),_0x30e2b2=(Date[_0x37d374(0x223)]()/0x3e8)[_0x37d374(0x1e1)](0x0),_0x156424=await this[_0x37d374(0x1cd)]['getConfigs']([_0x37d374(0x22a)]);console['log']('jsapiTicket:\x20',_0x156424);const _0xdf9c1c=await this[_0x37d374(0x1cd)][_0x37d374(0x1c2)]([_0x37d374(0x1b9)]);console[_0x37d374(0x1dd)](_0x37d374(0x21d),_0xdf9c1c);const _0x4fcae0=_0x37d374(0x218)+_0x156424+'&noncestr='+_0xb04b17+_0x37d374(0x212)+_0x30e2b2+'&url='+_0x5191b2;console['log'](_0x37d374(0x211),_0x4fcae0);const _0x1a066a=this['sha1'](_0x4fcae0);return{'appId':_0xdf9c1c,'nonceStr':_0xb04b17,'timestamp':_0x30e2b2,'signature':_0x1a066a};}async[_0x2586de(0x201)](_0x195b86){const _0x4b4cf2=_0x2586de,_0x22579d=await this['globalConfigService'][_0x4b4cf2(0x1c2)]([_0x4b4cf2(0x219)]),_0x170b16=(0x0,utils_1[_0x4b4cf2(0x1bf)])(process[_0x4b4cf2(0x1cf)][_0x4b4cf2(0x20d)]||_0x4b4cf2(0x1de)),_0x586b49={'action_name':_0x4b4cf2(0x1c7),'action_info':{'scene':{'scene_str':_0x195b86}}},_0x142cd6=await axios_1[_0x4b4cf2(0x1e2)][_0x4b4cf2(0x1da)](_0x170b16+_0x4b4cf2(0x1dc)+_0x22579d,_0x586b49),{data:{errmsg:_0x41573b,ticket:_0x8ac40b}}=_0x142cd6;if(_0x41573b)throw new common_1[(_0x4b4cf2(0x1cb))](_0x41573b,common_1[_0x4b4cf2(0x1c8)][_0x4b4cf2(0x1f0)]);return _0x8ac40b;}async[_0x2586de(0x229)](_0x1e508c,_0x24d8d2){const _0x4ebc9f=_0x2586de,_0x5e0946=await this[_0x4ebc9f(0x1cd)]['getConfigs']([_0x4ebc9f(0x1b9)]),_0x4c2af7=await this[_0x4ebc9f(0x1cd)]['getConfigs'](['wechatOfficialAppSecret']),_0x182294=(0x0,utils_1[_0x4ebc9f(0x1bf)])(process[_0x4ebc9f(0x1cf)][_0x4ebc9f(0x20d)]||'https://api.weixin.qq.com'),_0x52c598=await axios_1[_0x4ebc9f(0x1e2)]['get'](_0x182294+_0x4ebc9f(0x1d4)+_0x5e0946+_0x4ebc9f(0x22e)+_0x4c2af7+'&code='+_0x24d8d2+_0x4ebc9f(0x1e3)),{data:{errmsg:_0x1ce47c,openid:_0x35c82a}}=_0x52c598;if(_0x1ce47c)throw new common_1['HttpException'](_0x1ce47c,common_1[_0x4ebc9f(0x1c8)][_0x4ebc9f(0x1f0)]);let _0x3c2a5d;return _0x3c2a5d=await this['userService'][_0x4ebc9f(0x20a)](_0x35c82a),!_0x3c2a5d&&(_0x3c2a5d=await this[_0x4ebc9f(0x220)][_0x4ebc9f(0x226)](_0x35c82a)),this['authService'][_0x4ebc9f(0x208)](_0x3c2a5d,_0x1e508c);}async['scan'](_0x2199dc,_0x135253){const _0x3626b0=_0x2586de;try{common_1[_0x3626b0(0x209)][_0x3626b0(0x1dd)]('Scanning\x20with\x20openID:\x20'+_0x2199dc+_0x3626b0(0x1b7)+_0x135253,_0x3626b0(0x1eb));if(!this[_0x3626b0(0x1b8)][_0x135253]){common_1[_0x3626b0(0x209)]['error'](_0x3626b0(0x1ed)+_0x135253);throw new common_1[(_0x3626b0(0x1cb))](_0x3626b0(0x210),common_1[_0x3626b0(0x1c8)][_0x3626b0(0x1f0)]);}const _0x349de0=await this['userService'][_0x3626b0(0x226)](_0x2199dc,_0x135253);common_1[_0x3626b0(0x209)][_0x3626b0(0x1dd)](_0x3626b0(0x203)+(_0x349de0?_0x349de0['id']:'No\x20user\x20found'),'OfficialService'),this[_0x3626b0(0x1d0)][_0x135253]=_0x349de0['id'];}catch(_0x203cce){common_1[_0x3626b0(0x209)]['error'](_0x3626b0(0x22d),_0x203cce[_0x3626b0(0x217)]),common_1['Logger'][_0x3626b0(0x1ea)](_0x3626b0(0x21b),_0x203cce[_0x3626b0(0x1d3)]);throw new common_1[(_0x3626b0(0x1cb))](_0x3626b0(0x200),common_1[_0x3626b0(0x1c8)][_0x3626b0(0x1e7)]);}}async[_0x2586de(0x221)](_0x3e8257,_0x9778bd){const _0x1a0ee5=_0x2586de,{sceneStr:_0x354fcf}=_0x9778bd;if(!this['sceneStrMap'][_0x354fcf])return;const _0x257d5e=this[_0x1a0ee5(0x1d0)][_0x354fcf];if(!_0x257d5e)return'';const _0x48ce55=await this[_0x1a0ee5(0x220)][_0x1a0ee5(0x1bd)](_0x257d5e);return delete this[_0x1a0ee5(0x1d0)][_0x354fcf],this['authService'][_0x1a0ee5(0x208)](_0x48ce55,_0x3e8257);}async[_0x2586de(0x1bb)](_0x2be996,_0x189104){const _0x180926=_0x2586de;if(!this[_0x180926(0x1b8)][_0x189104])throw new common_1[(_0x180926(0x1cb))](_0x180926(0x210),common_1[_0x180926(0x1c8)][_0x180926(0x1f0)]);const _0x752de9=_0x189104[_0x180926(0x1f6)]('/')[0x1],_0x100b1d=await this[_0x180926(0x220)][_0x180926(0x215)](_0x2be996,_0x752de9);this['scanedSceneStrMap'][_0x189104]=_0x100b1d;}async[_0x2586de(0x207)](_0x241961,_0x3b0125){const _0x31b2a3=_0x2586de;if(!this['sceneStrMap'][_0x3b0125])throw new common_1['HttpException'](_0x31b2a3(0x210),common_1[_0x31b2a3(0x1c8)]['BAD_REQUEST']);const {id:_0x5dfa43}=_0x241961[_0x31b2a3(0x1cc)],_0x1bfb90=this[_0x31b2a3(0x1d0)][_0x3b0125];if(!_0x1bfb90)return'';return delete this[_0x31b2a3(0x1d0)][_0x3b0125],_0x1bfb90;}async['verify'](_0x5eabe7,_0x5ace21,_0x44ff30){const _0x43accd=_0x2586de,_0x4ce42c=await this[_0x43accd(0x1cd)]['getConfigs']([_0x43accd(0x1c6)])||'';return await this['sha1']([_0x4ce42c,_0x5ace21,_0x44ff30][_0x43accd(0x21a)]()[_0x43accd(0x1fb)](''))==_0x5eabe7;}[_0x2586de(0x20b)](_0x432a21){const _0x167c16=_0x2586de;return crypto[_0x167c16(0x1d1)](_0x167c16(0x20b))[_0x167c16(0x227)](_0x432a21)[_0x167c16(0x213)](_0x167c16(0x214));}async[_0x2586de(0x228)](_0x1ebe7c,_0x1cdc50){const _0x665845=_0x2586de,_0x3d2ef8=await this['globalConfigService'][_0x665845(0x1c2)]([_0x1cdc50]);return this['genXmlMsg'](_0x1ebe7c,_0x3d2ef8);}async[_0x2586de(0x1e5)](_0x18f960,_0x437b76){const _0x2c7a28=_0x2586de;return _0x2c7a28(0x22b)+_0x18f960[_0x2c7a28(0x21e)][0x0]+_0x2c7a28(0x1d7)+_0x18f960['tousername'][0x0]+_0x2c7a28(0x1f9)+new Date()[_0x2c7a28(0x1bc)]()+_0x2c7a28(0x225)+_0x437b76+_0x2c7a28(0x1db);}async[_0x2586de(0x1f5)](_0x3ab140){const _0x108af2=_0x2586de,_0x546e4d=new Promise((_0x2f84da,_0x387f26)=>{setTimeout(()=>{_0x387f26(new Error('请求超时'));},0x12c0);});let _0x537192=await this[_0x108af2(0x1cd)][_0x108af2(0x1c2)]([_0x108af2(0x1ec)])||_0x108af2(0x1df);return _0x537192;}};OfficialService=__decorate([(0x0,common_1[_0x2586de(0x21f)])(),__metadata(_0x2586de(0x20e),[autoreply_service_1[_0x2586de(0x22c)],user_service_1['UserService'],auth_service_1['AuthService'],globalConfig_service_1[_0x2586de(0x1ee)],chat_service_1['ChatService']])],OfficialService),exports[_0x2586de(0x1eb)]=OfficialService;