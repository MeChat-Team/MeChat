'use strict';function _0x1ed2(_0xff2c04,_0x3c2398){const _0x142fbf=_0x142f();return _0x1ed2=function(_0x1ed2e0,_0x30657b){_0x1ed2e0=_0x1ed2e0-0x8b;let _0x456166=_0x142fbf[_0x1ed2e0];return _0x456166;},_0x1ed2(_0xff2c04,_0x3c2398);}const _0xb3aab0=_0x1ed2;(function(_0x4d519d,_0x12884c){const _0x5a7a39=_0x1ed2,_0x58750f=_0x4d519d();while(!![]){try{const _0x49cd48=parseInt(_0x5a7a39(0xef))/0x1+parseInt(_0x5a7a39(0xc5))/0x2+-parseInt(_0x5a7a39(0x97))/0x3+parseInt(_0x5a7a39(0xb4))/0x4*(parseInt(_0x5a7a39(0xdd))/0x5)+parseInt(_0x5a7a39(0xd4))/0x6+parseInt(_0x5a7a39(0xc7))/0x7*(parseInt(_0x5a7a39(0xd7))/0x8)+-parseInt(_0x5a7a39(0xba))/0x9;if(_0x49cd48===_0x12884c)break;else _0x58750f['push'](_0x58750f['shift']());}catch(_0x5af18f){_0x58750f['push'](_0x58750f['shift']());}}}(_0x142f,0xef17b));var __decorate=this&&this['__decorate']||function(_0x3e67c2,_0x28661d,_0x2cd83c,_0xe3493a){const _0x5d20d9=_0x1ed2;var _0x29d028=arguments[_0x5d20d9(0xc3)],_0x1adfd8=_0x29d028<0x3?_0x28661d:_0xe3493a===null?_0xe3493a=Object[_0x5d20d9(0xd1)](_0x28661d,_0x2cd83c):_0xe3493a,_0x1f99e8;if(typeof Reflect===_0x5d20d9(0xa5)&&typeof Reflect['decorate']===_0x5d20d9(0xbc))_0x1adfd8=Reflect[_0x5d20d9(0xb9)](_0x3e67c2,_0x28661d,_0x2cd83c,_0xe3493a);else{for(var _0x20978f=_0x3e67c2[_0x5d20d9(0xc3)]-0x1;_0x20978f>=0x0;_0x20978f--)if(_0x1f99e8=_0x3e67c2[_0x20978f])_0x1adfd8=(_0x29d028<0x3?_0x1f99e8(_0x1adfd8):_0x29d028>0x3?_0x1f99e8(_0x28661d,_0x2cd83c,_0x1adfd8):_0x1f99e8(_0x28661d,_0x2cd83c))||_0x1adfd8;}return _0x29d028>0x3&&_0x1adfd8&&Object['defineProperty'](_0x28661d,_0x2cd83c,_0x1adfd8),_0x1adfd8;},__metadata=this&&this['__metadata']||function(_0x51f9bf,_0x3651bc){const _0x5e12f8=_0x1ed2;if(typeof Reflect===_0x5e12f8(0xa5)&&typeof Reflect[_0x5e12f8(0xd9)]==='function')return Reflect[_0x5e12f8(0xd9)](_0x51f9bf,_0x3651bc);};Object['defineProperty'](exports,_0xb3aab0(0x8c),{'value':!![]}),exports[_0xb3aab0(0xb3)]=void 0x0;const utils_1=require(_0xb3aab0(0xc6)),common_1=require(_0xb3aab0(0xb1)),axios_1=require(_0xb3aab0(0xd3)),crypto=require(_0xb3aab0(0xed)),chat_service_1=require(_0xb3aab0(0xa9)),auth_service_1=require(_0xb3aab0(0xb6)),autoreply_service_1=require(_0xb3aab0(0xcc)),globalConfig_service_1=require('./../globalConfig/globalConfig.service'),user_service_1=require(_0xb3aab0(0xda));function _0x142f(){const _0x3f4920=['wechatOfficialToken','__esModule','globalConfigService',',\x20sceneStr:\x20',']]></Content>\x0a\x20\x20\x20\x20</xml>','ChatService',']]></FromUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<CreateTime>','&secret=','BAD_REQUEST','env','onModuleInit','weChatApiUrl','4089495EpyCSV','wechatOfficialAppSecret','getWechatAccessToken','getUserFromOpenId','非法参数','&timestamp=','createRandomNonceStr','https://api.weixin.qq.com','bindWxBySceneStr','fetchQRCodeTicket','createHash','officialAutoReplyText','getConfigs','Scanning\x20with\x20openID:\x20','object','sceneStrMap','Stack\x20trace:','非法参数:\x20未找到的\x20sceneStr\x20','../chat/chat.service','HttpStatus','getQRSceneStrByBind','hex','由于公众号的回复限制、过长的问题我们可能无法回复、您可以前往我们的官方站点享受更加完善的服务、如果您有更多问题、欢迎像我提问！','join','sha1','getTime','@nestjs/common','wechatOfficialAppId','OfficialService','876QVUSQT','update','./../auth/auth.service','genXmlMsg','INTERNAL_SERVER_ERROR','decorate','17835417HwkgxA','str:\x20','function','error','user','&code=','loginByCode','HttpException','QR_STR_SCENE','length','&noncestr=','492042BBvUOY','../../common/utils','21PukRqR','&response_type=code&scope=snsapi_base&state=weChatLogin#wechat_redirect','default','log','AuthService','./../autoreply/autoreply.service','stack','scanedSceneStrMap','wechatAccessToken','jsapiTicket:\x20','getOwnPropertyDescriptor','loginByOpenId','axios','5383122OLanpu',']]></ToUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<FromUserName><![CDATA[','jsapi_ticket=','1170272uoEXBw','userService','metadata','./../user/user.service','digest','wechatJsapiTicket','36355SEDTnn','&redirect_uri=','\x0a\x20\x20\x20\x20<xml>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<ToUserName><![CDATA[','bindWx','message','appId:\x20','AutoreplyService','fromusername','now','Logger','User\x20found:\x20','toFixed','genXmlMsgByConfig','loginBySceneStr','weChatOpenUrl','authService','crypto','请求超时','1149792pInWLH','sort'];_0x142f=function(){return _0x3f4920;};return _0x142f();}let OfficialService=class OfficialService{constructor(_0x3923c0,_0x37b3c2,_0x10d937,_0x452988,_0x58582c){const _0x364966=_0xb3aab0;this['autoreplyService']=_0x3923c0,this[_0x364966(0xd8)]=_0x37b3c2,this[_0x364966(0xec)]=_0x10d937,this[_0x364966(0x8d)]=_0x452988,this['chatgptService']=_0x58582c,this[_0x364966(0xa6)]={},this['scanedSceneStrMap']={};}async[_0xb3aab0(0x95)](){const _0x480310=_0xb3aab0;await this['globalConfigService'][_0x480310(0x99)](!![]);}async['getQRSceneStr'](){const _0x4ccfb9=_0xb3aab0;let _0x4bcfc1=(0x0,utils_1[_0x4ccfb9(0x9d)])(0x20);return this[_0x4ccfb9(0xa6)][_0x4bcfc1]=!![],_0x4bcfc1;}async[_0xb3aab0(0xab)](_0x1264d2){const _0xf7681d=_0xb3aab0,{id:_0x2b8ae9}=_0x1264d2[_0xf7681d(0xbe)],_0xdba387=(0x0,utils_1['createRandomNonceStr'])(0x20)+'/'+_0x2b8ae9;return this[_0xf7681d(0xa6)][_0xdba387]=!![],_0xdba387;}async['getQRCodeTicket'](_0x454745){const _0x6daa60=_0xb3aab0;return this[_0x6daa60(0xa0)](_0x454745);}async['getRedirectUrl'](_0x58fdd9){const _0x428187=_0xb3aab0,_0x87bed4=await this[_0x428187(0x8d)][_0x428187(0xa3)]([_0x428187(0xb2)]),_0x2f68fd=(0x0,utils_1['formatUrl'])(process[_0x428187(0x94)][_0x428187(0xeb)]||'https://open.weixin.qq.com'),_0x5d7f3d=_0x2f68fd+'/connect/oauth2/authorize?appid='+_0x87bed4+_0x428187(0xde)+encodeURIComponent(_0x58fdd9)+_0x428187(0xc8);return console[_0x428187(0xca)]('回跳跳转地址:\x20',_0x5d7f3d),_0x5d7f3d;}async['getJsapiTicket'](_0x44b5bd){const _0x79e59d=_0xb3aab0,_0x41686c=(0x0,utils_1['createRandomNonceStr'])(0x20),_0x4d7320=(Date[_0x79e59d(0xe5)]()/0x3e8)[_0x79e59d(0xe8)](0x0),_0x23e9cd=await this[_0x79e59d(0x8d)][_0x79e59d(0xa3)]([_0x79e59d(0xdc)]);console[_0x79e59d(0xca)](_0x79e59d(0xd0),_0x23e9cd);const _0x130dc8=await this[_0x79e59d(0x8d)][_0x79e59d(0xa3)](['wechatOfficialAppId']);console[_0x79e59d(0xca)](_0x79e59d(0xe2),_0x130dc8);const _0x53563d=_0x79e59d(0xd6)+_0x23e9cd+_0x79e59d(0xc4)+_0x41686c+_0x79e59d(0x9c)+_0x4d7320+'&url='+_0x44b5bd;console[_0x79e59d(0xca)](_0x79e59d(0xbb),_0x53563d);const _0x192169=this[_0x79e59d(0xaf)](_0x53563d);return{'appId':_0x130dc8,'nonceStr':_0x41686c,'timestamp':_0x4d7320,'signature':_0x192169};}async[_0xb3aab0(0xa0)](_0x592113){const _0x4ed103=_0xb3aab0,_0x27bc39=await this['globalConfigService'][_0x4ed103(0xa3)]([_0x4ed103(0xcf)]),_0x39f7fe=(0x0,utils_1['formatUrl'])(process[_0x4ed103(0x94)][_0x4ed103(0x96)]||_0x4ed103(0x9e)),_0xbe051={'action_name':_0x4ed103(0xc2),'action_info':{'scene':{'scene_str':_0x592113}}},_0x52e70a=await axios_1[_0x4ed103(0xc9)]['post'](_0x39f7fe+'/cgi-bin/qrcode/create?access_token='+_0x27bc39,_0xbe051),{data:{errmsg:_0x366eff,ticket:_0x1baf1e}}=_0x52e70a;if(_0x366eff)throw new common_1[(_0x4ed103(0xc1))](_0x366eff,common_1[_0x4ed103(0xaa)]['BAD_REQUEST']);return _0x1baf1e;}async[_0xb3aab0(0xc0)](_0x5456b0,_0x1b59b7){const _0x2046d9=_0xb3aab0,_0x4a923e=await this['globalConfigService'][_0x2046d9(0xa3)](['wechatOfficialAppId']),_0x970bbf=await this[_0x2046d9(0x8d)][_0x2046d9(0xa3)]([_0x2046d9(0x98)]),_0x3926b3=(0x0,utils_1['formatUrl'])(process[_0x2046d9(0x94)][_0x2046d9(0x96)]||_0x2046d9(0x9e)),_0x5b3e20=await axios_1[_0x2046d9(0xc9)]['get'](_0x3926b3+'/sns/oauth2/access_token?appid='+_0x4a923e+_0x2046d9(0x92)+_0x970bbf+_0x2046d9(0xbf)+_0x1b59b7+'&grant_type=authorization_code'),{data:{errmsg:_0x2c331d,openid:_0x4371bf}}=_0x5b3e20;if(_0x2c331d)throw new common_1[(_0x2046d9(0xc1))](_0x2c331d,common_1['HttpStatus'][_0x2046d9(0x93)]);let _0x1ff34c;return _0x1ff34c=await this[_0x2046d9(0xd8)]['getUserOpenId'](_0x4371bf),!_0x1ff34c&&(_0x1ff34c=await this[_0x2046d9(0xd8)][_0x2046d9(0x9a)](_0x4371bf)),this[_0x2046d9(0xec)]['loginByOpenId'](_0x1ff34c,_0x5456b0);}async['scan'](_0x28cb7d,_0xd4cacc){const _0x2479dd=_0xb3aab0;try{common_1[_0x2479dd(0xe6)]['log'](_0x2479dd(0xa4)+_0x28cb7d+_0x2479dd(0x8e)+_0xd4cacc,_0x2479dd(0xb3));if(!this[_0x2479dd(0xa6)][_0xd4cacc]){common_1[_0x2479dd(0xe6)]['error'](_0x2479dd(0xa8)+_0xd4cacc);throw new common_1[(_0x2479dd(0xc1))](_0x2479dd(0x9b),common_1[_0x2479dd(0xaa)][_0x2479dd(0x93)]);}const _0x48bbaa=await this[_0x2479dd(0xd8)][_0x2479dd(0x9a)](_0x28cb7d,_0xd4cacc);common_1[_0x2479dd(0xe6)][_0x2479dd(0xca)](_0x2479dd(0xe7)+(_0x48bbaa?_0x48bbaa['id']:'No\x20user\x20found'),_0x2479dd(0xb3)),this[_0x2479dd(0xce)][_0xd4cacc]=_0x48bbaa['id'];}catch(_0x387927){common_1[_0x2479dd(0xe6)]['error']('Error\x20in\x20scan\x20method:',_0x387927[_0x2479dd(0xe1)]),common_1[_0x2479dd(0xe6)][_0x2479dd(0xbd)](_0x2479dd(0xa7),_0x387927[_0x2479dd(0xcd)]);throw new common_1[(_0x2479dd(0xc1))]('处理扫码事件时发生错误',common_1[_0x2479dd(0xaa)][_0x2479dd(0xb8)]);}}async[_0xb3aab0(0xea)](_0x25c120,_0x1ea242){const _0x4aba58=_0xb3aab0,{sceneStr:_0x80dc0d}=_0x1ea242;if(!this[_0x4aba58(0xa6)][_0x80dc0d])return;const _0x31b391=this[_0x4aba58(0xce)][_0x80dc0d];if(!_0x31b391)return'';const _0x5cd0f8=await this['userService']['getUserById'](_0x31b391);return delete this[_0x4aba58(0xce)][_0x80dc0d],this['authService'][_0x4aba58(0xd2)](_0x5cd0f8,_0x25c120);}async['scanBindWx'](_0x2d16ce,_0x2af780){const _0x2f5869=_0xb3aab0;if(!this['sceneStrMap'][_0x2af780])throw new common_1['HttpException'](_0x2f5869(0x9b),common_1['HttpStatus']['BAD_REQUEST']);const _0x3f0f25=_0x2af780['split']('/')[0x1],_0x45436c=await this[_0x2f5869(0xd8)][_0x2f5869(0xe0)](_0x2d16ce,_0x3f0f25);this['scanedSceneStrMap'][_0x2af780]=_0x45436c;}async[_0xb3aab0(0x9f)](_0x36e0c8,_0x284d80){const _0x481d3c=_0xb3aab0;if(!this[_0x481d3c(0xa6)][_0x284d80])throw new common_1[(_0x481d3c(0xc1))]('非法参数',common_1['HttpStatus'][_0x481d3c(0x93)]);const {id:_0x26d709}=_0x36e0c8[_0x481d3c(0xbe)],_0x5ac462=this[_0x481d3c(0xce)][_0x284d80];if(!_0x5ac462)return'';return delete this[_0x481d3c(0xce)][_0x284d80],_0x5ac462;}async['verify'](_0x5dda17,_0x13b3a6,_0x242a27){const _0xef9341=_0xb3aab0,_0x5869d8=await this[_0xef9341(0x8d)][_0xef9341(0xa3)]([_0xef9341(0x8b)])||'';return await this[_0xef9341(0xaf)]([_0x5869d8,_0x13b3a6,_0x242a27][_0xef9341(0xf0)]()[_0xef9341(0xae)](''))==_0x5dda17;}['sha1'](_0x5e3ccc){const _0x12434f=_0xb3aab0;return crypto[_0x12434f(0xa1)]('sha1')[_0x12434f(0xb5)](_0x5e3ccc)[_0x12434f(0xdb)](_0x12434f(0xac));}async[_0xb3aab0(0xe9)](_0x50f6c1,_0x3aced1){const _0x8b6bfe=_0xb3aab0,_0x28ed04=await this[_0x8b6bfe(0x8d)]['getConfigs']([_0x3aced1]);return this[_0x8b6bfe(0xb7)](_0x50f6c1,_0x28ed04);}async['genXmlMsg'](_0x5e4cc0,_0x1f2a26){const _0x5c0478=_0xb3aab0;return _0x5c0478(0xdf)+_0x5e4cc0[_0x5c0478(0xe4)][0x0]+_0x5c0478(0xd5)+_0x5e4cc0['tousername'][0x0]+_0x5c0478(0x91)+new Date()[_0x5c0478(0xb0)]()+'</CreateTime>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<MsgType><![CDATA[text]]></MsgType>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<Content><![CDATA['+_0x1f2a26+_0x5c0478(0x8f);}async['aotoPlay'](_0x39296c){const _0x4cbaaa=_0xb3aab0,_0x56e9f7=new Promise((_0x33e31c,_0x5f318c)=>{setTimeout(()=>{const _0x1b8749=_0x1ed2;_0x5f318c(new Error(_0x1b8749(0xee)));},0x12c0);});let _0x46f319=await this[_0x4cbaaa(0x8d)][_0x4cbaaa(0xa3)]([_0x4cbaaa(0xa2)])||_0x4cbaaa(0xad);return _0x46f319;}};OfficialService=__decorate([(0x0,common_1['Injectable'])(),__metadata('design:paramtypes',[autoreply_service_1[_0xb3aab0(0xe3)],user_service_1['UserService'],auth_service_1[_0xb3aab0(0xcb)],globalConfig_service_1['GlobalConfigService'],chat_service_1[_0xb3aab0(0x90)]])],OfficialService),exports['OfficialService']=OfficialService;