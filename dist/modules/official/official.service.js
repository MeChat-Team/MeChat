'use strict';const _0x18afde=_0x4600;(function(_0x50fcc4,_0x3a95ef){const _0x94eb2=_0x4600,_0x2bdf38=_0x50fcc4();while(!![]){try{const _0x32692f=-parseInt(_0x94eb2(0x13c))/0x1*(-parseInt(_0x94eb2(0x180))/0x2)+parseInt(_0x94eb2(0x16d))/0x3*(parseInt(_0x94eb2(0x186))/0x4)+parseInt(_0x94eb2(0x120))/0x5*(parseInt(_0x94eb2(0x141))/0x6)+-parseInt(_0x94eb2(0x150))/0x7+-parseInt(_0x94eb2(0x167))/0x8+-parseInt(_0x94eb2(0x125))/0x9+-parseInt(_0x94eb2(0x142))/0xa;if(_0x32692f===_0x3a95ef)break;else _0x2bdf38['push'](_0x2bdf38['shift']());}catch(_0x158617){_0x2bdf38['push'](_0x2bdf38['shift']());}}}(_0x5479,0x66d2b));var __decorate=this&&this[_0x18afde(0x185)]||function(_0x3d7c32,_0x58f425,_0x421993,_0x49e7d5){const _0x5c15c8=_0x18afde;var _0x18c7a4=arguments[_0x5c15c8(0x183)],_0x24f360=_0x18c7a4<0x3?_0x58f425:_0x49e7d5===null?_0x49e7d5=Object[_0x5c15c8(0x123)](_0x58f425,_0x421993):_0x49e7d5,_0x2fbc09;if(typeof Reflect===_0x5c15c8(0x147)&&typeof Reflect[_0x5c15c8(0x187)]===_0x5c15c8(0x148))_0x24f360=Reflect['decorate'](_0x3d7c32,_0x58f425,_0x421993,_0x49e7d5);else{for(var _0x208088=_0x3d7c32[_0x5c15c8(0x183)]-0x1;_0x208088>=0x0;_0x208088--)if(_0x2fbc09=_0x3d7c32[_0x208088])_0x24f360=(_0x18c7a4<0x3?_0x2fbc09(_0x24f360):_0x18c7a4>0x3?_0x2fbc09(_0x58f425,_0x421993,_0x24f360):_0x2fbc09(_0x58f425,_0x421993))||_0x24f360;}return _0x18c7a4>0x3&&_0x24f360&&Object[_0x5c15c8(0x126)](_0x58f425,_0x421993,_0x24f360),_0x24f360;},__metadata=this&&this[_0x18afde(0x158)]||function(_0x3bce30,_0x30a795){const _0x315dcb=_0x18afde;if(typeof Reflect===_0x315dcb(0x147)&&typeof Reflect[_0x315dcb(0x13f)]===_0x315dcb(0x148))return Reflect[_0x315dcb(0x13f)](_0x3bce30,_0x30a795);};function _0x4600(_0x1b1444,_0x46021a){const _0x5479a4=_0x5479();return _0x4600=function(_0x4600b6,_0x4814f4){_0x4600b6=_0x4600b6-0x118;let _0x27d5c2=_0x5479a4[_0x4600b6];return _0x27d5c2;},_0x4600(_0x1b1444,_0x46021a);}Object[_0x18afde(0x126)](exports,_0x18afde(0x177),{'value':!![]}),exports[_0x18afde(0x131)]=void 0x0;const utils_1=require(_0x18afde(0x11e)),common_1=require(_0x18afde(0x121)),axios_1=require(_0x18afde(0x17a)),crypto=require(_0x18afde(0x118)),chat_service_1=require(_0x18afde(0x12b)),auth_service_1=require(_0x18afde(0x13d)),autoreply_service_1=require('./../autoreply/autoreply.service'),globalConfig_service_1=require(_0x18afde(0x163)),user_service_1=require('./../user/user.service');function _0x5479(){const _0x2477dc=['\x0a\x20\x20\x20\x20<xml>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<ToUserName><![CDATA[','../../common/utils','weChatOpenUrl','93615tOyIws','@nestjs/common','formatUrl','getOwnPropertyDescriptor','onModuleInit','2855970hbLkDg','defineProperty','Injectable','jsapi_ticket=','aotoPlay','scanBindWx','../chat/chat.service','getRedirectUrl','Stack\x20trace:','globalConfigService','wechatOfficialAppId','createRandomNonceStr','OfficialService','Logger','非法参数','getConfigs','&timestamp=','message','ChatService','getTime','&url=','digest','autoreplyService','31FXNBQh','./../auth/auth.service','getUserOpenId','metadata','QR_STR_SCENE','108qLHKKt','1098050kmHuMU','jsapiTicket:\x20','sceneStrMap','&redirect_uri=','Error\x20in\x20scan\x20method:','object','function','/connect/oauth2/authorize?appid=','post','genXmlMsg','now','userService','hex','https://api.weixin.qq.com','4846975PPtmSn','getQRSceneStr','getUserById',']]></Content>\x0a\x20\x20\x20\x20</xml>','fromusername','HttpStatus','&noncestr=','getUserFromOpenId','__metadata','tousername','loginByOpenId','scan','appId:\x20','chatgptService','wechatAccessToken','officialAutoReplyText','AuthService','bindWx','stack','./../globalConfig/globalConfig.service','INTERNAL_SERVER_ERROR','env','update','2028888yonwQC','authService','&code=','UserService','bindWxBySceneStr',']]></FromUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<CreateTime>','20853iZjUHr','fetchQRCodeTicket','get','scanedSceneStrMap','请求超时','&secret=','user','Scanning\x20with\x20openID:\x20','getJsapiTicket',',\x20sceneStr:\x20','__esModule','getQRSceneStrByBind','&response_type=code&scope=snsapi_base&state=weChatLogin#wechat_redirect','axios','getQRCodeTicket','BAD_REQUEST','verify','split','HttpException','39758topUSi','default','weChatApiUrl','length','log','__decorate','484LwYQtE','decorate','AutoreplyService','crypto','genXmlMsgByConfig','&grant_type=authorization_code','createHash','sha1'];_0x5479=function(){return _0x2477dc;};return _0x5479();}let OfficialService=class OfficialService{constructor(_0x273e42,_0x52789d,_0x47a951,_0x2a8b20,_0x30fdc6){const _0x1d9310=_0x18afde;this[_0x1d9310(0x13b)]=_0x273e42,this[_0x1d9310(0x14d)]=_0x52789d,this[_0x1d9310(0x168)]=_0x47a951,this[_0x1d9310(0x12e)]=_0x2a8b20,this[_0x1d9310(0x15d)]=_0x30fdc6,this[_0x1d9310(0x144)]={},this[_0x1d9310(0x170)]={};}async[_0x18afde(0x124)](){await this['globalConfigService']['getWechatAccessToken'](!![]);}async[_0x18afde(0x151)](){const _0x4fbdf6=_0x18afde;let _0x27c38d=(0x0,utils_1[_0x4fbdf6(0x130)])(0x20);return this[_0x4fbdf6(0x144)][_0x27c38d]=!![],_0x27c38d;}async[_0x18afde(0x178)](_0x35d082){const _0x3527a2=_0x18afde,{id:_0x44c894}=_0x35d082[_0x3527a2(0x173)],_0x56c29=(0x0,utils_1[_0x3527a2(0x130)])(0x20)+'/'+_0x44c894;return this[_0x3527a2(0x144)][_0x56c29]=!![],_0x56c29;}async[_0x18afde(0x17b)](_0x5b58b1){const _0x3c6f5a=_0x18afde;return this[_0x3c6f5a(0x16e)](_0x5b58b1);}async[_0x18afde(0x12c)](_0x3e7360){const _0x139edf=_0x18afde,_0x560cc1=await this['globalConfigService']['getConfigs']([_0x139edf(0x12f)]),_0x564b8e=(0x0,utils_1['formatUrl'])(process[_0x139edf(0x165)][_0x139edf(0x11f)]||'https://open.weixin.qq.com'),_0x24d6d1=_0x564b8e+_0x139edf(0x149)+_0x560cc1+_0x139edf(0x145)+encodeURIComponent(_0x3e7360)+_0x139edf(0x179);return console[_0x139edf(0x184)]('回跳跳转地址:\x20',_0x24d6d1),_0x24d6d1;}async[_0x18afde(0x175)](_0xed6be1){const _0x16759d=_0x18afde,_0x288458=(0x0,utils_1['createRandomNonceStr'])(0x20),_0x31c460=(Date[_0x16759d(0x14c)]()/0x3e8)['toFixed'](0x0),_0x247b83=await this[_0x16759d(0x12e)][_0x16759d(0x134)](['wechatJsapiTicket']);console[_0x16759d(0x184)](_0x16759d(0x143),_0x247b83);const _0x2d15b9=await this[_0x16759d(0x12e)]['getConfigs'](['wechatOfficialAppId']);console[_0x16759d(0x184)](_0x16759d(0x15c),_0x2d15b9);const _0x4a1e38=_0x16759d(0x128)+_0x247b83+_0x16759d(0x156)+_0x288458+_0x16759d(0x135)+_0x31c460+_0x16759d(0x139)+_0xed6be1;console['log']('str:\x20',_0x4a1e38);const _0xc16062=this[_0x16759d(0x11c)](_0x4a1e38);return{'appId':_0x2d15b9,'nonceStr':_0x288458,'timestamp':_0x31c460,'signature':_0xc16062};}async['fetchQRCodeTicket'](_0x3016f3){const _0x2bbccf=_0x18afde,_0x2e2e16=await this[_0x2bbccf(0x12e)][_0x2bbccf(0x134)]([_0x2bbccf(0x15e)]),_0x1152bd=(0x0,utils_1[_0x2bbccf(0x122)])(process[_0x2bbccf(0x165)][_0x2bbccf(0x182)]||_0x2bbccf(0x14f)),_0x16a100={'action_name':_0x2bbccf(0x140),'action_info':{'scene':{'scene_str':_0x3016f3}}},_0x51c693=await axios_1[_0x2bbccf(0x181)][_0x2bbccf(0x14a)](_0x1152bd+'/cgi-bin/qrcode/create?access_token='+_0x2e2e16,_0x16a100),{data:{errmsg:_0x2e3607,ticket:_0x3efedd}}=_0x51c693;if(_0x2e3607)throw new common_1['HttpException'](_0x2e3607,common_1[_0x2bbccf(0x155)][_0x2bbccf(0x17c)]);return _0x3efedd;}async['loginByCode'](_0x180b3a,_0x324f6e){const _0x5e2910=_0x18afde,_0x4745d=await this[_0x5e2910(0x12e)][_0x5e2910(0x134)](['wechatOfficialAppId']),_0x1bf487=await this[_0x5e2910(0x12e)][_0x5e2910(0x134)](['wechatOfficialAppSecret']),_0x355c3b=(0x0,utils_1[_0x5e2910(0x122)])(process[_0x5e2910(0x165)][_0x5e2910(0x182)]||_0x5e2910(0x14f)),_0x8f4d40=await axios_1[_0x5e2910(0x181)][_0x5e2910(0x16f)](_0x355c3b+'/sns/oauth2/access_token?appid='+_0x4745d+_0x5e2910(0x172)+_0x1bf487+_0x5e2910(0x169)+_0x324f6e+_0x5e2910(0x11a)),{data:{errmsg:_0x380d0c,openid:_0x753c5}}=_0x8f4d40;if(_0x380d0c)throw new common_1[(_0x5e2910(0x17f))](_0x380d0c,common_1[_0x5e2910(0x155)][_0x5e2910(0x17c)]);let _0x5d00f5;return _0x5d00f5=await this['userService'][_0x5e2910(0x13e)](_0x753c5),!_0x5d00f5&&(_0x5d00f5=await this['userService'][_0x5e2910(0x157)](_0x753c5)),this[_0x5e2910(0x168)][_0x5e2910(0x15a)](_0x5d00f5,_0x180b3a);}async[_0x18afde(0x15b)](_0x5b94cc,_0x3063b9){const _0x4769dd=_0x18afde;try{common_1[_0x4769dd(0x132)][_0x4769dd(0x184)](_0x4769dd(0x174)+_0x5b94cc+_0x4769dd(0x176)+_0x3063b9,'OfficialService');if(!this['sceneStrMap'][_0x3063b9]){common_1[_0x4769dd(0x132)]['error']('非法参数:\x20未找到的\x20sceneStr\x20'+_0x3063b9);throw new common_1[(_0x4769dd(0x17f))](_0x4769dd(0x133),common_1['HttpStatus'][_0x4769dd(0x17c)]);}const _0x2218d5=await this[_0x4769dd(0x14d)][_0x4769dd(0x157)](_0x5b94cc,_0x3063b9);common_1[_0x4769dd(0x132)]['log']('User\x20found:\x20'+(_0x2218d5?_0x2218d5['id']:'No\x20user\x20found'),_0x4769dd(0x131)),this['scanedSceneStrMap'][_0x3063b9]=_0x2218d5['id'];}catch(_0xdbce1c){common_1[_0x4769dd(0x132)]['error'](_0x4769dd(0x146),_0xdbce1c[_0x4769dd(0x136)]),common_1['Logger']['error'](_0x4769dd(0x12d),_0xdbce1c[_0x4769dd(0x162)]);throw new common_1[(_0x4769dd(0x17f))]('处理扫码事件时发生错误',common_1[_0x4769dd(0x155)][_0x4769dd(0x164)]);}}async['loginBySceneStr'](_0x5d6d0a,_0x333e77){const _0x230447=_0x18afde,{sceneStr:_0x319186}=_0x333e77;if(!this[_0x230447(0x144)][_0x319186])return;const _0x46c94a=this[_0x230447(0x170)][_0x319186];if(!_0x46c94a)return'';const _0xf9cc9b=await this['userService'][_0x230447(0x152)](_0x46c94a);return delete this[_0x230447(0x170)][_0x319186],this['authService'][_0x230447(0x15a)](_0xf9cc9b,_0x5d6d0a);}async[_0x18afde(0x12a)](_0x53906a,_0xbe0564){const _0x4611ed=_0x18afde;if(!this[_0x4611ed(0x144)][_0xbe0564])throw new common_1[(_0x4611ed(0x17f))](_0x4611ed(0x133),common_1[_0x4611ed(0x155)][_0x4611ed(0x17c)]);const _0xbef816=_0xbe0564[_0x4611ed(0x17e)]('/')[0x1],_0x2547ff=await this[_0x4611ed(0x14d)][_0x4611ed(0x161)](_0x53906a,_0xbef816);this['scanedSceneStrMap'][_0xbe0564]=_0x2547ff;}async[_0x18afde(0x16b)](_0x132134,_0x4e3960){const _0x3df4dd=_0x18afde;if(!this[_0x3df4dd(0x144)][_0x4e3960])throw new common_1[(_0x3df4dd(0x17f))](_0x3df4dd(0x133),common_1[_0x3df4dd(0x155)][_0x3df4dd(0x17c)]);const {id:_0x3aacf3}=_0x132134[_0x3df4dd(0x173)],_0x177ad2=this['scanedSceneStrMap'][_0x4e3960];if(!_0x177ad2)return'';return delete this[_0x3df4dd(0x170)][_0x4e3960],_0x177ad2;}async[_0x18afde(0x17d)](_0xc3c85c,_0x326410,_0xb2d709){const _0x16826a=_0x18afde,_0x41c1ee=await this[_0x16826a(0x12e)][_0x16826a(0x134)](['wechatOfficialToken'])||'';return await this[_0x16826a(0x11c)]([_0x41c1ee,_0x326410,_0xb2d709]['sort']()['join'](''))==_0xc3c85c;}[_0x18afde(0x11c)](_0x2af1fa){const _0xafe042=_0x18afde;return crypto[_0xafe042(0x11b)](_0xafe042(0x11c))[_0xafe042(0x166)](_0x2af1fa)[_0xafe042(0x13a)](_0xafe042(0x14e));}async[_0x18afde(0x119)](_0x122b68,_0x5809a3){const _0x1f83fe=_0x18afde,_0x32f1a0=await this[_0x1f83fe(0x12e)]['getConfigs']([_0x5809a3]);return this[_0x1f83fe(0x14b)](_0x122b68,_0x32f1a0);}async[_0x18afde(0x14b)](_0x3cb2a9,_0x48ca6c){const _0x4efaa1=_0x18afde;return _0x4efaa1(0x11d)+_0x3cb2a9[_0x4efaa1(0x154)][0x0]+']]></ToUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<FromUserName><![CDATA['+_0x3cb2a9[_0x4efaa1(0x159)][0x0]+_0x4efaa1(0x16c)+new Date()[_0x4efaa1(0x138)]()+'</CreateTime>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<MsgType><![CDATA[text]]></MsgType>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<Content><![CDATA['+_0x48ca6c+_0x4efaa1(0x153);}async[_0x18afde(0x129)](_0x36e6de){const _0x46e323=_0x18afde,_0x1cba3d=new Promise((_0x3d4c5a,_0x408c30)=>{setTimeout(()=>{const _0x20a4b0=_0x4600;_0x408c30(new Error(_0x20a4b0(0x171)));},0x12c0);});let _0x26efc7=await this[_0x46e323(0x12e)]['getConfigs']([_0x46e323(0x15f)])||'由于公众号的回复限制、过长的问题我们可能无法回复、您可以前往我们的官方站点享受更加完善的服务、如果您有更多问题、欢迎像我提问！';return _0x26efc7;}};OfficialService=__decorate([(0x0,common_1[_0x18afde(0x127)])(),__metadata('design:paramtypes',[autoreply_service_1[_0x18afde(0x188)],user_service_1[_0x18afde(0x16a)],auth_service_1[_0x18afde(0x160)],globalConfig_service_1['GlobalConfigService'],chat_service_1[_0x18afde(0x137)]])],OfficialService),exports[_0x18afde(0x131)]=OfficialService;