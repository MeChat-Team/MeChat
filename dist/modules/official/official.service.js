'use strict';const _0x39f60a=_0x2ca2;(function(_0x3536e6,_0x1b3ba1){const _0x1fe9b6=_0x2ca2,_0x51873e=_0x3536e6();while(!![]){try{const _0x3000b7=-parseInt(_0x1fe9b6(0xf4))/0x1*(-parseInt(_0x1fe9b6(0xc4))/0x2)+-parseInt(_0x1fe9b6(0xce))/0x3+parseInt(_0x1fe9b6(0xe6))/0x4+-parseInt(_0x1fe9b6(0xdd))/0x5+parseInt(_0x1fe9b6(0xbc))/0x6+parseInt(_0x1fe9b6(0xf1))/0x7+-parseInt(_0x1fe9b6(0xbb))/0x8;if(_0x3000b7===_0x1b3ba1)break;else _0x51873e['push'](_0x51873e['shift']());}catch(_0x99f9f7){_0x51873e['push'](_0x51873e['shift']());}}}(_0x2aa9,0x7e8b4));function _0x2ca2(_0x28244c,_0xfe7049){const _0x2aa928=_0x2aa9();return _0x2ca2=function(_0x2ca20d,_0x2ed5d6){_0x2ca20d=_0x2ca20d-0xb6;let _0x1f1e42=_0x2aa928[_0x2ca20d];return _0x1f1e42;},_0x2ca2(_0x28244c,_0xfe7049);}var __decorate=this&&this[_0x39f60a(0xd3)]||function(_0x4abba0,_0x3e82d2,_0x3191a0,_0x20d872){const _0x10a571=_0x39f60a;var _0x5f49d8=arguments['length'],_0x2d5aae=_0x5f49d8<0x3?_0x3e82d2:_0x20d872===null?_0x20d872=Object['getOwnPropertyDescriptor'](_0x3e82d2,_0x3191a0):_0x20d872,_0x3e0612;if(typeof Reflect===_0x10a571(0x119)&&typeof Reflect['decorate']===_0x10a571(0x11a))_0x2d5aae=Reflect[_0x10a571(0x11f)](_0x4abba0,_0x3e82d2,_0x3191a0,_0x20d872);else{for(var _0x46c3a1=_0x4abba0[_0x10a571(0xff)]-0x1;_0x46c3a1>=0x0;_0x46c3a1--)if(_0x3e0612=_0x4abba0[_0x46c3a1])_0x2d5aae=(_0x5f49d8<0x3?_0x3e0612(_0x2d5aae):_0x5f49d8>0x3?_0x3e0612(_0x3e82d2,_0x3191a0,_0x2d5aae):_0x3e0612(_0x3e82d2,_0x3191a0))||_0x2d5aae;}return _0x5f49d8>0x3&&_0x2d5aae&&Object[_0x10a571(0xd7)](_0x3e82d2,_0x3191a0,_0x2d5aae),_0x2d5aae;},__metadata=this&&this['__metadata']||function(_0x1d770b,_0x295f1b){const _0xccc9ed=_0x39f60a;if(typeof Reflect===_0xccc9ed(0x119)&&typeof Reflect[_0xccc9ed(0x11c)]===_0xccc9ed(0x11a))return Reflect['metadata'](_0x1d770b,_0x295f1b);};function _0x2aa9(){const _0x2363af=['3888025DdWevq','./../user/user.service','Injectable','getUserOpenId','loginByCode','stack','wechatAccessToken','log','getQRCodeTicket','1691252SgZIrX','chatgptService','Stack\x20trace:','BAD_REQUEST','&secret=','wechatOfficialAppId','update','fromusername','fetchQRCodeTicket','HttpException','/sns/oauth2/access_token?appid=','4165049EcDicd','../chat/chat.service','wechatOfficialAppSecret','236whJDYC','createHash','/connect/oauth2/authorize?appid=','loginByOpenId','digest','非法参数:\x20未找到的\x20sceneStr\x20','verify','INTERNAL_SERVER_ERROR','getTime','getQRSceneStrByBind','str:\x20','length','HttpStatus','../../common/utils','__esModule','split','scanedSceneStrMap','aotoPlay','UserService','axios','getUserFromOpenId','非法参数',']]></FromUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<CreateTime>','formatUrl','get','globalConfigService','onModuleInit','jsapiTicket:\x20','weChatApiUrl','error','&url=','getUserById','ChatService','User\x20found:\x20','GlobalConfigService','env','AuthService','object','function','OfficialService','metadata','user','</CreateTime>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<MsgType><![CDATA[text]]></MsgType>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<Content><![CDATA[','decorate','createRandomNonceStr','回跳跳转地址:\x20','appId:\x20','message','Scanning\x20with\x20openID:\x20','5490512yaStzi','295140mpAEFm','&noncestr=','hex','sha1','userService','post','design:paramtypes','AutoreplyService','8342fqlEEx','Logger',',\x20sceneStr:\x20',']]></ToUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<FromUserName><![CDATA[',']]></Content>\x0a\x20\x20\x20\x20</xml>','join','toFixed','/cgi-bin/qrcode/create?access_token=','./../globalConfig/globalConfig.service','处理扫码事件时发生错误','207369ZvJHFh','bindWx','由于公众号的回复限制、过长的问题我们可能无法回复、您可以前往我们的官方站点享受更加完善的服务、如果您有更多问题、欢迎像我提问！','getJsapiTicket','getConfigs','__decorate','jsapi_ticket=','officialAutoReplyText','genXmlMsg','defineProperty','sceneStrMap','authService','&timestamp=','./../auth/auth.service','getWechatAccessToken'];_0x2aa9=function(){return _0x2363af;};return _0x2aa9();}Object['defineProperty'](exports,_0x39f60a(0x102),{'value':!![]}),exports['OfficialService']=void 0x0;const utils_1=require(_0x39f60a(0x101)),common_1=require('@nestjs/common'),axios_1=require(_0x39f60a(0x107)),crypto=require('crypto'),chat_service_1=require(_0x39f60a(0xf2)),auth_service_1=require(_0x39f60a(0xdb)),autoreply_service_1=require('./../autoreply/autoreply.service'),globalConfig_service_1=require(_0x39f60a(0xcc)),user_service_1=require(_0x39f60a(0xde));let OfficialService=class OfficialService{constructor(_0x53c219,_0x6fb650,_0x5a68b1,_0x3d65a2,_0x12511a){const _0x36e584=_0x39f60a;this['autoreplyService']=_0x53c219,this[_0x36e584(0xc0)]=_0x6fb650,this[_0x36e584(0xd9)]=_0x5a68b1,this['globalConfigService']=_0x3d65a2,this[_0x36e584(0xe7)]=_0x12511a,this['sceneStrMap']={},this[_0x36e584(0x104)]={};}async[_0x39f60a(0x10e)](){const _0x5553c2=_0x39f60a;await this[_0x5553c2(0x10d)][_0x5553c2(0xdc)](!![]);}async['getQRSceneStr'](){const _0x5e20a3=_0x39f60a;let _0x4d2544=(0x0,utils_1[_0x5e20a3(0xb6)])(0x20);return this[_0x5e20a3(0xd8)][_0x4d2544]=!![],_0x4d2544;}async[_0x39f60a(0xfd)](_0x30f8c7){const _0x43a745=_0x39f60a,{id:_0x116d22}=_0x30f8c7[_0x43a745(0x11d)],_0x51849c=(0x0,utils_1[_0x43a745(0xb6)])(0x20)+'/'+_0x116d22;return this[_0x43a745(0xd8)][_0x51849c]=!![],_0x51849c;}async[_0x39f60a(0xe5)](_0x49ed05){const _0x4c1a81=_0x39f60a;return this[_0x4c1a81(0xee)](_0x49ed05);}async['getRedirectUrl'](_0x29ae5b){const _0x3d56c5=_0x39f60a,_0x4dd5e3=await this[_0x3d56c5(0x10d)]['getConfigs'](['wechatOfficialAppId']),_0x3420b9=(0x0,utils_1[_0x3d56c5(0x10b)])(process['env']['weChatOpenUrl']||'https://open.weixin.qq.com'),_0x1fc43a=_0x3420b9+_0x3d56c5(0xf6)+_0x4dd5e3+'&redirect_uri='+encodeURIComponent(_0x29ae5b)+'&response_type=code&scope=snsapi_base&state=weChatLogin#wechat_redirect';return console[_0x3d56c5(0xe4)](_0x3d56c5(0xb7),_0x1fc43a),_0x1fc43a;}async[_0x39f60a(0xd1)](_0x3640c7){const _0x2e4002=_0x39f60a,_0x47200e=(0x0,utils_1['createRandomNonceStr'])(0x20),_0x5f5121=(Date['now']()/0x3e8)[_0x2e4002(0xca)](0x0),_0x2c37ad=await this['globalConfigService'][_0x2e4002(0xd2)](['wechatJsapiTicket']);console[_0x2e4002(0xe4)](_0x2e4002(0x10f),_0x2c37ad);const _0x445a75=await this['globalConfigService'][_0x2e4002(0xd2)](['wechatOfficialAppId']);console[_0x2e4002(0xe4)](_0x2e4002(0xb8),_0x445a75);const _0x3eb96b=_0x2e4002(0xd4)+_0x2c37ad+_0x2e4002(0xbd)+_0x47200e+_0x2e4002(0xda)+_0x5f5121+_0x2e4002(0x112)+_0x3640c7;console[_0x2e4002(0xe4)](_0x2e4002(0xfe),_0x3eb96b);const _0x6b0c2=this[_0x2e4002(0xbf)](_0x3eb96b);return{'appId':_0x445a75,'nonceStr':_0x47200e,'timestamp':_0x5f5121,'signature':_0x6b0c2};}async[_0x39f60a(0xee)](_0x570a46){const _0x52b1bd=_0x39f60a,_0x220d85=await this[_0x52b1bd(0x10d)]['getConfigs']([_0x52b1bd(0xe3)]),_0x529aab=(0x0,utils_1['formatUrl'])(process[_0x52b1bd(0x117)][_0x52b1bd(0x110)]||'https://api.weixin.qq.com'),_0x362048={'action_name':'QR_STR_SCENE','action_info':{'scene':{'scene_str':_0x570a46}}},_0x5deca1=await axios_1['default'][_0x52b1bd(0xc1)](_0x529aab+_0x52b1bd(0xcb)+_0x220d85,_0x362048),{data:{errmsg:_0x2bf28b,ticket:_0x178acb}}=_0x5deca1;if(_0x2bf28b)throw new common_1['HttpException'](_0x2bf28b,common_1[_0x52b1bd(0x100)][_0x52b1bd(0xe9)]);return _0x178acb;}async[_0x39f60a(0xe1)](_0x2f8e3e,_0x23818c){const _0x1ea86d=_0x39f60a,_0x56ee73=await this[_0x1ea86d(0x10d)][_0x1ea86d(0xd2)]([_0x1ea86d(0xeb)]),_0x33d325=await this[_0x1ea86d(0x10d)][_0x1ea86d(0xd2)]([_0x1ea86d(0xf3)]),_0x21ec85=(0x0,utils_1['formatUrl'])(process['env'][_0x1ea86d(0x110)]||'https://api.weixin.qq.com'),_0x387cc7=await axios_1['default'][_0x1ea86d(0x10c)](_0x21ec85+_0x1ea86d(0xf0)+_0x56ee73+_0x1ea86d(0xea)+_0x33d325+'&code='+_0x23818c+'&grant_type=authorization_code'),{data:{errmsg:_0x593f83,openid:_0x4537fa}}=_0x387cc7;if(_0x593f83)throw new common_1[(_0x1ea86d(0xef))](_0x593f83,common_1[_0x1ea86d(0x100)][_0x1ea86d(0xe9)]);let _0x39f8e3;return _0x39f8e3=await this[_0x1ea86d(0xc0)][_0x1ea86d(0xe0)](_0x4537fa),!_0x39f8e3&&(_0x39f8e3=await this[_0x1ea86d(0xc0)][_0x1ea86d(0x108)](_0x4537fa)),this[_0x1ea86d(0xd9)][_0x1ea86d(0xf7)](_0x39f8e3,_0x2f8e3e);}async['scan'](_0x86880,_0x3cfffe){const _0x36e3c4=_0x39f60a;try{common_1[_0x36e3c4(0xc5)][_0x36e3c4(0xe4)](_0x36e3c4(0xba)+_0x86880+_0x36e3c4(0xc6)+_0x3cfffe,_0x36e3c4(0x11b));if(!this['sceneStrMap'][_0x3cfffe]){common_1[_0x36e3c4(0xc5)]['error'](_0x36e3c4(0xf9)+_0x3cfffe);throw new common_1[(_0x36e3c4(0xef))](_0x36e3c4(0x109),common_1[_0x36e3c4(0x100)][_0x36e3c4(0xe9)]);}const _0x3de221=await this['userService']['getUserFromOpenId'](_0x86880,_0x3cfffe);common_1[_0x36e3c4(0xc5)][_0x36e3c4(0xe4)](_0x36e3c4(0x115)+(_0x3de221?_0x3de221['id']:'No\x20user\x20found'),_0x36e3c4(0x11b)),this[_0x36e3c4(0x104)][_0x3cfffe]=_0x3de221['id'];}catch(_0x103172){common_1[_0x36e3c4(0xc5)][_0x36e3c4(0x111)]('Error\x20in\x20scan\x20method:',_0x103172[_0x36e3c4(0xb9)]),common_1[_0x36e3c4(0xc5)][_0x36e3c4(0x111)](_0x36e3c4(0xe8),_0x103172[_0x36e3c4(0xe2)]);throw new common_1[(_0x36e3c4(0xef))](_0x36e3c4(0xcd),common_1['HttpStatus'][_0x36e3c4(0xfb)]);}}async['loginBySceneStr'](_0x15e9c0,_0x42383){const _0x2b5d6d=_0x39f60a,{sceneStr:_0xe14077}=_0x42383;if(!this[_0x2b5d6d(0xd8)][_0xe14077])return;const _0x65f297=this[_0x2b5d6d(0x104)][_0xe14077];if(!_0x65f297)return'';const _0x268e39=await this['userService'][_0x2b5d6d(0x113)](_0x65f297);return delete this[_0x2b5d6d(0x104)][_0xe14077],this['authService'][_0x2b5d6d(0xf7)](_0x268e39,_0x15e9c0);}async['scanBindWx'](_0x14f0c5,_0x1495e2){const _0x2a9041=_0x39f60a;if(!this[_0x2a9041(0xd8)][_0x1495e2])throw new common_1[(_0x2a9041(0xef))](_0x2a9041(0x109),common_1['HttpStatus'][_0x2a9041(0xe9)]);const _0x2bc335=_0x1495e2[_0x2a9041(0x103)]('/')[0x1],_0x114cf2=await this[_0x2a9041(0xc0)][_0x2a9041(0xcf)](_0x14f0c5,_0x2bc335);this[_0x2a9041(0x104)][_0x1495e2]=_0x114cf2;}async['bindWxBySceneStr'](_0x202cf4,_0xfa294d){const _0x56786c=_0x39f60a;if(!this[_0x56786c(0xd8)][_0xfa294d])throw new common_1['HttpException'](_0x56786c(0x109),common_1['HttpStatus']['BAD_REQUEST']);const {id:_0x396652}=_0x202cf4[_0x56786c(0x11d)],_0x4d3e1e=this['scanedSceneStrMap'][_0xfa294d];if(!_0x4d3e1e)return'';return delete this[_0x56786c(0x104)][_0xfa294d],_0x4d3e1e;}async[_0x39f60a(0xfa)](_0x19b021,_0x5c0ea7,_0x33da41){const _0x864500=_0x39f60a,_0x4080e8=await this[_0x864500(0x10d)][_0x864500(0xd2)](['wechatOfficialToken'])||'';return await this[_0x864500(0xbf)]([_0x4080e8,_0x5c0ea7,_0x33da41]['sort']()[_0x864500(0xc9)](''))==_0x19b021;}[_0x39f60a(0xbf)](_0x47e332){const _0x2874b3=_0x39f60a;return crypto[_0x2874b3(0xf5)](_0x2874b3(0xbf))[_0x2874b3(0xec)](_0x47e332)[_0x2874b3(0xf8)](_0x2874b3(0xbe));}async['genXmlMsgByConfig'](_0x12541d,_0x3c79cb){const _0x45e316=_0x39f60a,_0x4695dc=await this[_0x45e316(0x10d)][_0x45e316(0xd2)]([_0x3c79cb]);return this[_0x45e316(0xd6)](_0x12541d,_0x4695dc);}async[_0x39f60a(0xd6)](_0x504110,_0x299930){const _0x239ee9=_0x39f60a;return'\x0a\x20\x20\x20\x20<xml>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<ToUserName><![CDATA['+_0x504110[_0x239ee9(0xed)][0x0]+_0x239ee9(0xc7)+_0x504110['tousername'][0x0]+_0x239ee9(0x10a)+new Date()[_0x239ee9(0xfc)]()+_0x239ee9(0x11e)+_0x299930+_0x239ee9(0xc8);}async[_0x39f60a(0x105)](_0x5a2dc4){const _0x334d33=_0x39f60a,_0x564f3f=new Promise((_0x50ebd3,_0x45eb9f)=>{setTimeout(()=>{_0x45eb9f(new Error('请求超时'));},0x12c0);});let _0x1533cb=await this['globalConfigService'][_0x334d33(0xd2)]([_0x334d33(0xd5)])||_0x334d33(0xd0);return _0x1533cb;}};OfficialService=__decorate([(0x0,common_1[_0x39f60a(0xdf)])(),__metadata(_0x39f60a(0xc2),[autoreply_service_1[_0x39f60a(0xc3)],user_service_1[_0x39f60a(0x106)],auth_service_1[_0x39f60a(0x118)],globalConfig_service_1[_0x39f60a(0x116)],chat_service_1[_0x39f60a(0x114)]])],OfficialService),exports[_0x39f60a(0x11b)]=OfficialService;