'use strict';const _0x2e0f97=_0x2881;(function(_0x2db5d1,_0xff7ca2){const _0x4cfdf8=_0x2881,_0x433e4c=_0x2db5d1();while(!![]){try{const _0x38f244=-parseInt(_0x4cfdf8(0x196))/0x1+parseInt(_0x4cfdf8(0x18a))/0x2*(parseInt(_0x4cfdf8(0x181))/0x3)+parseInt(_0x4cfdf8(0x1c8))/0x4+parseInt(_0x4cfdf8(0x1be))/0x5*(parseInt(_0x4cfdf8(0x18f))/0x6)+parseInt(_0x4cfdf8(0x1b6))/0x7+-parseInt(_0x4cfdf8(0x197))/0x8*(parseInt(_0x4cfdf8(0x1b8))/0x9)+-parseInt(_0x4cfdf8(0x1af))/0xa*(parseInt(_0x4cfdf8(0x184))/0xb);if(_0x38f244===_0xff7ca2)break;else _0x433e4c['push'](_0x433e4c['shift']());}catch(_0x3b9c11){_0x433e4c['push'](_0x433e4c['shift']());}}}(_0x2479,0x4cac0));var __decorate=this&&this[_0x2e0f97(0x178)]||function(_0xa08ccd,_0x55b0e6,_0x2bb967,_0xa26616){const _0x5315cc=_0x2e0f97;var _0x1ef3b9=arguments[_0x5315cc(0x18e)],_0xdcd337=_0x1ef3b9<0x3?_0x55b0e6:_0xa26616===null?_0xa26616=Object[_0x5315cc(0x1bc)](_0x55b0e6,_0x2bb967):_0xa26616,_0x24c528;if(typeof Reflect==='object'&&typeof Reflect['decorate']===_0x5315cc(0x1c3))_0xdcd337=Reflect[_0x5315cc(0x188)](_0xa08ccd,_0x55b0e6,_0x2bb967,_0xa26616);else{for(var _0x42e6f3=_0xa08ccd[_0x5315cc(0x18e)]-0x1;_0x42e6f3>=0x0;_0x42e6f3--)if(_0x24c528=_0xa08ccd[_0x42e6f3])_0xdcd337=(_0x1ef3b9<0x3?_0x24c528(_0xdcd337):_0x1ef3b9>0x3?_0x24c528(_0x55b0e6,_0x2bb967,_0xdcd337):_0x24c528(_0x55b0e6,_0x2bb967))||_0xdcd337;}return _0x1ef3b9>0x3&&_0xdcd337&&Object[_0x5315cc(0x19b)](_0x55b0e6,_0x2bb967,_0xdcd337),_0xdcd337;},__metadata=this&&this[_0x2e0f97(0x19e)]||function(_0xd1b684,_0x198493){const _0x5683ae=_0x2e0f97;if(typeof Reflect===_0x5683ae(0x1c9)&&typeof Reflect[_0x5683ae(0x1b4)]==='function')return Reflect[_0x5683ae(0x1b4)](_0xd1b684,_0x198493);},__param=this&&this[_0x2e0f97(0x180)]||function(_0x3a40c6,_0x1e19c2){return function(_0x317057,_0x1a98b8){_0x1e19c2(_0x317057,_0x1a98b8,_0x3a40c6);};};function _0x2881(_0x1fde3f,_0xefbcf7){const _0x2479f7=_0x2479();return _0x2881=function(_0x288166,_0x4b232a){_0x288166=_0x288166-0x175;let _0x95afbd=_0x2479f7[_0x288166];return _0x95afbd;},_0x2881(_0x1fde3f,_0xefbcf7);}Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[_0x2e0f97(0x17b)]=void 0x0;const common_1=require('@nestjs/common'),crami_entity_1=require(_0x2e0f97(0x19c)),typeorm_1=require(_0x2e0f97(0x185)),typeorm_2=require(_0x2e0f97(0x19d)),cramiPackage_entity_1=require(_0x2e0f97(0x1bb)),utils_1=require('../../common/utils'),user_entity_1=require(_0x2e0f97(0x177)),userBalance_service_1=require(_0x2e0f97(0x189)),balance_constant_1=require('../../common/constants/balance.constant');function _0x2479(){const _0x1a07de=['count','findOne','CramiService','queryAllCrami','当前卡密不存在、请确认您输入的卡密是否正确！','createPackage','当前套餐不存在、请确认您选择的套餐是否存在！','__param','587991ECipCr','LessThanOrEqual','使用卡密成功','1504437nEcaKV','@nestjs/typeorm','Repository','当前卡密已被使用、已使用的卡密禁止删除！','decorate','../userBalance/userBalance.service','2EsGMav','affected','useCrami','maskEmail','length','277038LTlqmW','PACKAGE_GIFT','InjectRepository','user','super','email','CramiPackageEntity','275445sempwu','24MYhNHW','userEntity','Not','当前套餐下存在卡密、请先删除卡密后才可删除套餐！','defineProperty','./crami.entity','typeorm','__metadata','generateCramiCode','当前套餐不存在、请检查你的输入参数！','删除卡密成功！','code','RechargeType','更新套餐成功！','userBalanceService','Like','username','HttpStatus','generateCrami','save','cramiEntity','queryAllPackage','更新套餐失败、请重试！','log','30fQGGzM','assign','forEach','cramiPackageEntity','addBalanceToUser','metadata','every','1900563RxZokd','role','936657VokBna','packageId','useId','./cramiPackage.entity','getOwnPropertyDescriptor','map','55wqnvwu','DESC','自定义卡密必须至少一项余额不为0️零！','当前卡密已被使用、请确认您输入的卡密是否正确！','Injectable','function','BAD_REQUEST','HttpException','delete','batchDelCrami','1346416fNvDHB','object','error:\x20','UserBalanceService','find','update','status','delCrami','../user/user.entity','__decorate'];_0x2479=function(){return _0x1a07de;};return _0x2479();}let CramiService=class CramiService{constructor(_0x2674f3,_0x3610cc,_0xeaedf6,_0x18ecc7){const _0x399458=_0x2e0f97;this[_0x399458(0x1ab)]=_0x2674f3,this[_0x399458(0x1b2)]=_0x3610cc,this[_0x399458(0x198)]=_0xeaedf6,this[_0x399458(0x1a5)]=_0x18ecc7;}async['queryOnePackage'](_0x2b44dc){const _0x1f2740=_0x2e0f97;return await this[_0x1f2740(0x1b2)][_0x1f2740(0x17a)]({'where':{'id':_0x2b44dc}});}async[_0x2e0f97(0x1ac)](_0x43eb66){const _0x5b8c81=_0x2e0f97;try{const {page:page=0x1,size:size=0xa,name:_0x1996c7,status:_0x4eed09,type:_0x3d30dc}=_0x43eb66,_0xb579ec={};_0x1996c7&&Object[_0x5b8c81(0x1b0)](_0xb579ec,{'name':(0x0,typeorm_2[_0x5b8c81(0x1a6)])('%'+_0x1996c7+'%')}),_0x4eed09&&Object[_0x5b8c81(0x1b0)](_0xb579ec,{'status':_0x4eed09});_0x3d30dc&&(_0x3d30dc>0x0?Object[_0x5b8c81(0x1b0)](_0xb579ec,{'days':(0x0,typeorm_2['MoreThan'])(0x0)}):Object[_0x5b8c81(0x1b0)](_0xb579ec,{'days':(0x0,typeorm_2[_0x5b8c81(0x182)])(0x0)}));const [_0x1fbc40,_0x389312]=await this['cramiPackageEntity']['findAndCount']({'skip':(page-0x1)*size,'take':size,'where':_0xb579ec,'order':{'order':'DESC'}});return{'rows':_0x1fbc40,'count':_0x389312};}catch(_0x3944b3){console['log'](_0x5b8c81(0x1ca),_0x3944b3);}}async[_0x2e0f97(0x17e)](_0x345fdb){const _0x56136d=_0x2e0f97,{name:_0x31a424,weight:_0x51ba49}=_0x345fdb,_0x4741ea=await this[_0x56136d(0x1b2)][_0x56136d(0x17a)]({'where':[{'name':_0x31a424},{'weight':_0x51ba49}]});if(_0x4741ea)throw new common_1[(_0x56136d(0x1c5))]('套餐名称或套餐等级重复、请检查！',common_1[_0x56136d(0x1a8)][_0x56136d(0x1c4)]);try{return await this[_0x56136d(0x1b2)][_0x56136d(0x1aa)](_0x345fdb);}catch(_0x4054f4){console[_0x56136d(0x1ae)](_0x56136d(0x1ca),_0x4054f4);throw new common_1[(_0x56136d(0x1c5))](_0x4054f4,common_1[_0x56136d(0x1a8)][_0x56136d(0x1c4)]);}}async['updatePackage'](_0x276ad6){const _0x6e8939=_0x2e0f97,{id:_0x583e2a,name:_0x2a6676,weight:_0x361384}=_0x276ad6,_0xbdbbf3=await this[_0x6e8939(0x1b2)][_0x6e8939(0x17a)]({'where':{'id':_0x583e2a}});if(!_0xbdbbf3)throw new common_1['HttpException'](_0x6e8939(0x1a0),common_1['HttpStatus'][_0x6e8939(0x1c4)]);const _0x4c19b7=await this[_0x6e8939(0x1b2)][_0x6e8939(0x179)]({'where':[{'name':_0x2a6676,'id':(0x0,typeorm_2[_0x6e8939(0x199)])(_0x583e2a)},{'weight':_0x361384,'id':(0x0,typeorm_2[_0x6e8939(0x199)])(_0x583e2a)}]});if(_0x4c19b7)throw new common_1[(_0x6e8939(0x1c5))]('套餐名称或套餐等级重复、请检查！',common_1[_0x6e8939(0x1a8)][_0x6e8939(0x1c4)]);const _0x5c8e8a=await this['cramiPackageEntity'][_0x6e8939(0x1cd)]({'id':_0x583e2a},_0x276ad6);if(_0x5c8e8a[_0x6e8939(0x18b)]>0x0)return _0x6e8939(0x1a4);else throw new common_1[(_0x6e8939(0x1c5))](_0x6e8939(0x1ad),common_1[_0x6e8939(0x1a8)]['BAD_REQUEST']);}async['delPackage'](_0x54c671){const _0x35ccc6=_0x2e0f97,{id:_0xc3c2cb}=_0x54c671,_0x28a99b=await this['cramiEntity'][_0x35ccc6(0x179)]({'where':{'packageId':_0xc3c2cb}});if(_0x28a99b)throw new common_1[(_0x35ccc6(0x1c5))](_0x35ccc6(0x19a),common_1[_0x35ccc6(0x1a8)]['BAD_REQUEST']);return await this['cramiPackageEntity'][_0x35ccc6(0x1c6)]({'id':_0xc3c2cb});}async['createCrami'](_0x5bdcb9){const _0x5dea63=_0x2e0f97,{packageId:_0x5dfa94,count:count=0x1}=_0x5bdcb9;if(_0x5dfa94){const _0x17ba2e=await this['cramiPackageEntity']['findOne']({'where':{'id':_0x5dfa94}});if(!_0x17ba2e)throw new common_1[(_0x5dea63(0x1c5))](_0x5dea63(0x17f),common_1['HttpStatus'][_0x5dea63(0x1c4)]);const {days:days=-0x1,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x17ba2e,_0x4d7266={'packageId':_0x5dfa94,'days':days,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount};return await this[_0x5dea63(0x1a9)](_0x4d7266,count);}if(!_0x5dfa94){const {model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x5bdcb9;if([model3Count,model4Count,drawMjCount][_0x5dea63(0x1b5)](_0x320e80=>!_0x320e80))throw new common_1[(_0x5dea63(0x1c5))](_0x5dea63(0x1c0),common_1['HttpStatus'][_0x5dea63(0x1c4)]);const _0x3e354e={'days':-0x1,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount};return await this['generateCrami'](_0x3e354e,count);}}async['generateCrami'](_0x5adc29,_0x4fd329){const _0x417c9e=_0x2e0f97,_0x3799c7=[];for(let _0x2049ea=0x0;_0x2049ea<_0x4fd329;_0x2049ea++){const _0x29224d=(0x0,utils_1[_0x417c9e(0x19f)])(),_0x37b51d=this[_0x417c9e(0x1ab)]['create'](Object['assign'](Object[_0x417c9e(0x1b0)]({},_0x5adc29),{'code':_0x29224d}));_0x3799c7['push'](_0x37b51d);}return await this[_0x417c9e(0x1ab)]['save'](_0x3799c7);}async[_0x2e0f97(0x18c)](_0x965d2b,_0x1abf06){const _0x555295=_0x2e0f97,{id:_0x694909}=_0x965d2b[_0x555295(0x192)],_0x5f1dae=await this['cramiEntity']['findOne']({'where':{'code':_0x1abf06[_0x555295(0x1a2)]}});if(!_0x5f1dae)throw new common_1['HttpException'](_0x555295(0x17d),common_1[_0x555295(0x1a8)][_0x555295(0x1c4)]);const {status:_0x2a2a5c,days:days=-0x1,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0,packageId:_0x529c0e}=_0x5f1dae;if(_0x2a2a5c===0x1)throw new common_1[(_0x555295(0x1c5))](_0x555295(0x1c1),common_1[_0x555295(0x1a8)][_0x555295(0x1c4)]);const _0xd4b671={'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'packageId':_0x529c0e};return await this[_0x555295(0x1a5)][_0x555295(0x1b3)](_0x694909,Object[_0x555295(0x1b0)]({},_0xd4b671),days),await this[_0x555295(0x1a5)]['saveRecordRechargeLog']({'userId':_0x694909,'rechargeType':balance_constant_1[_0x555295(0x1a3)][_0x555295(0x190)],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'days':days}),await this['cramiEntity'][_0x555295(0x1cd)]({'code':_0x1abf06[_0x555295(0x1a2)]},{'useId':_0x694909,'status':0x1}),_0x555295(0x183);}async[_0x2e0f97(0x17c)](_0x1a19b6,_0x159802){const _0x2c55a7=_0x2e0f97,{page:page=0x1,size:size=0xa,status:_0x4e9ca4,useId:_0x3a8906}=_0x1a19b6,_0x31969c={};_0x4e9ca4&&Object[_0x2c55a7(0x1b0)](_0x31969c,{'status':_0x4e9ca4}),_0x3a8906&&Object[_0x2c55a7(0x1b0)](_0x31969c,{'useId':_0x3a8906});const [_0x8380df,_0x36ef63]=await this[_0x2c55a7(0x1ab)]['findAndCount']({'skip':(page-0x1)*size,'take':size,'order':{'createdAt':_0x2c55a7(0x1bf)},'where':_0x31969c}),_0x571a74=_0x8380df['map'](_0x291cf4=>_0x291cf4[_0x2c55a7(0x1ba)]),_0x140ff4=_0x8380df[_0x2c55a7(0x1bd)](_0x1bad01=>_0x1bad01[_0x2c55a7(0x1b9)]),_0x5c8c3b=await this[_0x2c55a7(0x198)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x571a74)}}),_0x5615e4=await this[_0x2c55a7(0x1b2)][_0x2c55a7(0x1cc)]({'where':{'id':(0x0,typeorm_2['In'])(_0x140ff4)}});return _0x8380df[_0x2c55a7(0x1b1)](_0x3ca565=>{const _0x4d6e8=_0x2c55a7;var _0x1918c9,_0x11ad44,_0x34c965;_0x3ca565['username']=(_0x1918c9=_0x5c8c3b[_0x4d6e8(0x1cc)](_0x2c8dae=>_0x2c8dae['id']===_0x3ca565[_0x4d6e8(0x1ba)]))===null||_0x1918c9===void 0x0?void 0x0:_0x1918c9[_0x4d6e8(0x1a7)],_0x3ca565['email']=(_0x11ad44=_0x5c8c3b[_0x4d6e8(0x1cc)](_0x3c7a95=>_0x3c7a95['id']===_0x3ca565[_0x4d6e8(0x1ba)]))===null||_0x11ad44===void 0x0?void 0x0:_0x11ad44[_0x4d6e8(0x194)],_0x3ca565['packageName']=(_0x34c965=_0x5615e4[_0x4d6e8(0x1cc)](_0x538293=>_0x538293['id']===_0x3ca565[_0x4d6e8(0x1b9)]))===null||_0x34c965===void 0x0?void 0x0:_0x34c965['name'];}),_0x159802[_0x2c55a7(0x192)]['role']!=='super'&&_0x8380df['forEach'](_0x303883=>_0x303883['email']=(0x0,utils_1[_0x2c55a7(0x18d)])(_0x303883['email'])),_0x159802['user'][_0x2c55a7(0x1b7)]!==_0x2c55a7(0x193)&&_0x8380df[_0x2c55a7(0x1b1)](_0x4ccdd2=>_0x4ccdd2[_0x2c55a7(0x1a2)]=(0x0,utils_1['maskCrami'])(_0x4ccdd2[_0x2c55a7(0x1a2)])),{'rows':_0x8380df,'count':_0x36ef63};}async[_0x2e0f97(0x176)](_0xfc0914){const _0x11cd6d=_0x2e0f97,_0x21e6b2=await this[_0x11cd6d(0x1ab)][_0x11cd6d(0x17a)]({'where':{'id':_0xfc0914}});if(!_0x21e6b2)throw new common_1[(_0x11cd6d(0x1c5))]('当前卡密不存在、请确认您要删除的卡密是否存在！',common_1[_0x11cd6d(0x1a8)][_0x11cd6d(0x1c4)]);if(_0x21e6b2[_0x11cd6d(0x175)]===0x1)throw new common_1['HttpException'](_0x11cd6d(0x187),common_1[_0x11cd6d(0x1a8)][_0x11cd6d(0x1c4)]);return await this['cramiEntity']['delete']({'id':_0xfc0914});}async[_0x2e0f97(0x1c7)](_0x4db550){const _0xfb38e9=_0x2e0f97,{ids:_0x586e10}=_0x4db550,_0xd5666=await this['cramiEntity'][_0xfb38e9(0x1c6)](_0x586e10);if(_0xd5666[_0xfb38e9(0x18b)]>0x0)return _0xfb38e9(0x1a1);else throw new common_1[(_0xfb38e9(0x1c5))]('删除卡密失败、请重试！',common_1['HttpStatus']['BAD_REQUEST']);}};CramiService=__decorate([(0x0,common_1[_0x2e0f97(0x1c2)])(),__param(0x0,(0x0,typeorm_1[_0x2e0f97(0x191)])(crami_entity_1['CramiEntity'])),__param(0x1,(0x0,typeorm_1[_0x2e0f97(0x191)])(cramiPackage_entity_1[_0x2e0f97(0x195)])),__param(0x2,(0x0,typeorm_1[_0x2e0f97(0x191)])(user_entity_1['UserEntity'])),__metadata('design:paramtypes',[typeorm_2[_0x2e0f97(0x186)],typeorm_2[_0x2e0f97(0x186)],typeorm_2[_0x2e0f97(0x186)],userBalance_service_1[_0x2e0f97(0x1cb)]])],CramiService),exports[_0x2e0f97(0x17b)]=CramiService;