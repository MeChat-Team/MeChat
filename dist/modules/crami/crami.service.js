'use strict';const _0x2b6771=_0x12de;(function(_0x8a633a,_0x400656){const _0x2fd5df=_0x12de,_0x5e6667=_0x8a633a();while(!![]){try{const _0x447659=-parseInt(_0x2fd5df(0x11d))/0x1+-parseInt(_0x2fd5df(0xd9))/0x2*(-parseInt(_0x2fd5df(0xe8))/0x3)+-parseInt(_0x2fd5df(0xf9))/0x4*(parseInt(_0x2fd5df(0x116))/0x5)+-parseInt(_0x2fd5df(0x10b))/0x6+-parseInt(_0x2fd5df(0x10d))/0x7*(parseInt(_0x2fd5df(0xfd))/0x8)+parseInt(_0x2fd5df(0xd2))/0x9*(parseInt(_0x2fd5df(0x124))/0xa)+parseInt(_0x2fd5df(0xda))/0xb*(parseInt(_0x2fd5df(0xd3))/0xc);if(_0x447659===_0x400656)break;else _0x5e6667['push'](_0x5e6667['shift']());}catch(_0x383097){_0x5e6667['push'](_0x5e6667['shift']());}}}(_0x20c6,0x6af49));var __decorate=this&&this[_0x2b6771(0xe7)]||function(_0x56057f,_0x2b93e5,_0x441abe,_0x3b371b){const _0x23651f=_0x2b6771;var _0x7a34fc=arguments[_0x23651f(0x119)],_0x15b040=_0x7a34fc<0x3?_0x2b93e5:_0x3b371b===null?_0x3b371b=Object[_0x23651f(0x11a)](_0x2b93e5,_0x441abe):_0x3b371b,_0x3476ea;if(typeof Reflect===_0x23651f(0xf0)&&typeof Reflect[_0x23651f(0xcc)]===_0x23651f(0x103))_0x15b040=Reflect[_0x23651f(0xcc)](_0x56057f,_0x2b93e5,_0x441abe,_0x3b371b);else{for(var _0x423b82=_0x56057f[_0x23651f(0x119)]-0x1;_0x423b82>=0x0;_0x423b82--)if(_0x3476ea=_0x56057f[_0x423b82])_0x15b040=(_0x7a34fc<0x3?_0x3476ea(_0x15b040):_0x7a34fc>0x3?_0x3476ea(_0x2b93e5,_0x441abe,_0x15b040):_0x3476ea(_0x2b93e5,_0x441abe))||_0x15b040;}return _0x7a34fc>0x3&&_0x15b040&&Object[_0x23651f(0x10f)](_0x2b93e5,_0x441abe,_0x15b040),_0x15b040;},__metadata=this&&this[_0x2b6771(0xdc)]||function(_0x21a1cc,_0x115f55){const _0xce53b=_0x2b6771;if(typeof Reflect===_0xce53b(0xf0)&&typeof Reflect[_0xce53b(0x104)]==='function')return Reflect[_0xce53b(0x104)](_0x21a1cc,_0x115f55);},__param=this&&this[_0x2b6771(0xdd)]||function(_0x2386d5,_0x1723f4){return function(_0x17d136,_0x56b361){_0x1723f4(_0x17d136,_0x56b361,_0x2386d5);};};function _0x12de(_0x5a1d4c,_0x54fe70){const _0x20c691=_0x20c6();return _0x12de=function(_0x12decc,_0x596d01){_0x12decc=_0x12decc-0xc8;let _0xd14d15=_0x20c691[_0x12decc];return _0xd14d15;},_0x12de(_0x5a1d4c,_0x54fe70);}Object[_0x2b6771(0x10f)](exports,_0x2b6771(0x120),{'value':!![]}),exports[_0x2b6771(0xd7)]=void 0x0;const common_1=require(_0x2b6771(0xca)),crami_entity_1=require(_0x2b6771(0xf1)),typeorm_1=require(_0x2b6771(0xe5)),typeorm_2=require('typeorm'),cramiPackage_entity_1=require(_0x2b6771(0xe2)),utils_1=require(_0x2b6771(0xea)),user_entity_1=require('../user/user.entity'),userBalance_service_1=require(_0x2b6771(0x108)),balance_constant_1=require(_0x2b6771(0x11e));let CramiService=class CramiService{constructor(_0x17e92d,_0x2337f0,_0x2dd61d,_0x3dcc86){const _0x420478=_0x2b6771;this[_0x420478(0xd1)]=_0x17e92d,this[_0x420478(0x102)]=_0x2337f0,this[_0x420478(0xe4)]=_0x2dd61d,this['userBalanceService']=_0x3dcc86;}async[_0x2b6771(0x11c)](_0x4e3d04){const _0x313e4c=_0x2b6771;return await this[_0x313e4c(0x102)][_0x313e4c(0x11b)]({'where':{'id':_0x4e3d04}});}async['queryAllPackage'](_0x188971){const _0x5f2ad9=_0x2b6771;try{const {page:page=0x1,size:size=0xa,name:_0x30120f,status:_0x21a272,type:_0x3fa858}=_0x188971,_0x10b4ac={};_0x30120f&&Object[_0x5f2ad9(0xe3)](_0x10b4ac,{'name':(0x0,typeorm_2[_0x5f2ad9(0xf4)])('%'+_0x30120f+'%')}),_0x21a272&&Object[_0x5f2ad9(0xe3)](_0x10b4ac,{'status':_0x21a272});_0x3fa858&&(_0x3fa858>0x0?Object[_0x5f2ad9(0xe3)](_0x10b4ac,{'days':(0x0,typeorm_2[_0x5f2ad9(0xce)])(0x0)}):Object['assign'](_0x10b4ac,{'days':(0x0,typeorm_2[_0x5f2ad9(0xdf)])(0x0)}));const [_0x860371,_0x2c2ab0]=await this[_0x5f2ad9(0x102)][_0x5f2ad9(0xd4)]({'skip':(page-0x1)*size,'take':size,'where':_0x10b4ac,'order':{'order':'DESC'}});return{'rows':_0x860371,'count':_0x2c2ab0};}catch(_0x40c605){console[_0x5f2ad9(0x115)](_0x5f2ad9(0x113),_0x40c605);}}async[_0x2b6771(0xd5)](_0x33fa60){const _0x4ef06f=_0x2b6771,{name:_0x53dac9,weight:_0x4de52c}=_0x33fa60,_0x37fd08=await this['cramiPackageEntity'][_0x4ef06f(0x11b)]({'where':[{'name':_0x53dac9},{'weight':_0x4de52c}]});if(_0x37fd08)throw new common_1['HttpException']('套餐名称或套餐等级重复、请检查！',common_1['HttpStatus'][_0x4ef06f(0xef)]);try{return await this[_0x4ef06f(0x102)]['save'](_0x33fa60);}catch(_0x1882c0){console[_0x4ef06f(0x115)](_0x4ef06f(0x113),_0x1882c0);throw new common_1[(_0x4ef06f(0xcf))](_0x1882c0,common_1[_0x4ef06f(0x10c)][_0x4ef06f(0xef)]);}}async[_0x2b6771(0xf7)](_0x1ffc1e){const _0x5cb341=_0x2b6771,{id:_0x3d1e70,name:_0x1c5cbe,weight:_0x131fd8}=_0x1ffc1e,_0xe669e8=await this[_0x5cb341(0x102)][_0x5cb341(0x11b)]({'where':{'id':_0x3d1e70}});if(!_0xe669e8)throw new common_1[(_0x5cb341(0xcf))]('当前套餐不存在、请检查你的输入参数！',common_1[_0x5cb341(0x10c)]['BAD_REQUEST']);const _0x219dbf=await this[_0x5cb341(0x102)][_0x5cb341(0xec)]({'where':[{'name':_0x1c5cbe,'id':(0x0,typeorm_2[_0x5cb341(0xee)])(_0x3d1e70)},{'weight':_0x131fd8,'id':(0x0,typeorm_2[_0x5cb341(0xee)])(_0x3d1e70)}]});if(_0x219dbf)throw new common_1[(_0x5cb341(0xcf))](_0x5cb341(0xfe),common_1['HttpStatus'][_0x5cb341(0xef)]);const _0x141c31=await this['cramiPackageEntity'][_0x5cb341(0x129)]({'id':_0x3d1e70},_0x1ffc1e);if(_0x141c31[_0x5cb341(0x112)]>0x0)return _0x5cb341(0xf5);else throw new common_1[(_0x5cb341(0xcf))](_0x5cb341(0xc9),common_1['HttpStatus'][_0x5cb341(0xef)]);}async[_0x2b6771(0xfb)](_0x580344){const _0x1ed6a3=_0x2b6771,{id:_0x12f2a3}=_0x580344,_0x56b099=await this[_0x1ed6a3(0xd1)]['count']({'where':{'packageId':_0x12f2a3}});if(_0x56b099)throw new common_1['HttpException'](_0x1ed6a3(0x10a),common_1['HttpStatus'][_0x1ed6a3(0xef)]);return await this[_0x1ed6a3(0x102)][_0x1ed6a3(0xcd)]({'id':_0x12f2a3});}async[_0x2b6771(0x12a)](_0x209326){const _0x21e396=_0x2b6771,{packageId:_0x358ea8,count:count=0x1}=_0x209326;if(_0x358ea8){const _0x3ee553=await this['cramiPackageEntity'][_0x21e396(0x11b)]({'where':{'id':_0x358ea8}});if(!_0x3ee553)throw new common_1[(_0x21e396(0xcf))](_0x21e396(0x126),common_1[_0x21e396(0x10c)][_0x21e396(0xef)]);const {days:days=-0x1,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x3ee553,_0x1fa597={'packageId':_0x358ea8,'days':days,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount};return await this['generateCrami'](_0x1fa597,count);}if(!_0x358ea8){const {model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x209326;if([model3Count,model4Count,drawMjCount][_0x21e396(0xed)](_0x1d7a4c=>!_0x1d7a4c))throw new common_1[(_0x21e396(0xcf))](_0x21e396(0x123),common_1[_0x21e396(0x10c)][_0x21e396(0xef)]);const _0x1d7eb0={'days':-0x1,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount};return await this[_0x21e396(0x109)](_0x1d7eb0,count);}}async[_0x2b6771(0x109)](_0x27a92c,_0x42d54d){const _0x5b6772=_0x2b6771,_0xa51989=[];for(let _0x52ab1c=0x0;_0x52ab1c<_0x42d54d;_0x52ab1c++){const _0x1548c2=(0x0,utils_1[_0x5b6772(0xf3)])(),_0xb4f274=this[_0x5b6772(0xd1)][_0x5b6772(0xc8)](Object[_0x5b6772(0xe3)](Object[_0x5b6772(0xe3)]({},_0x27a92c),{'code':_0x1548c2}));_0xa51989[_0x5b6772(0xde)](_0xb4f274);}return await this[_0x5b6772(0xd1)][_0x5b6772(0x125)](_0xa51989);}async['useCrami'](_0x1c706b,_0x1739dc){const _0x1aa8ed=_0x2b6771,{id:_0x9a53a4}=_0x1c706b['user'],_0x3c2ae1=await this[_0x1aa8ed(0xd1)][_0x1aa8ed(0x11b)]({'where':{'code':_0x1739dc[_0x1aa8ed(0x122)]}});if(!_0x3c2ae1)throw new common_1[(_0x1aa8ed(0xcf))]('当前卡密不存在、请确认您输入的卡密是否正确！',common_1[_0x1aa8ed(0x10c)][_0x1aa8ed(0xef)]);const {status:_0x51a7a2,days:days=-0x1,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0,packageId:_0x2289d4}=_0x3c2ae1;if(_0x51a7a2===0x1)throw new common_1[(_0x1aa8ed(0xcf))](_0x1aa8ed(0xf2),common_1[_0x1aa8ed(0x10c)][_0x1aa8ed(0xef)]);const _0x2718e1={'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'packageId':_0x2289d4};return await this[_0x1aa8ed(0x107)]['addBalanceToUser'](_0x9a53a4,Object[_0x1aa8ed(0xe3)]({},_0x2718e1),days),await this['userBalanceService']['saveRecordRechargeLog']({'userId':_0x9a53a4,'rechargeType':balance_constant_1[_0x1aa8ed(0xf6)][_0x1aa8ed(0x106)],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'days':days}),await this[_0x1aa8ed(0xd1)][_0x1aa8ed(0x129)]({'code':_0x1739dc[_0x1aa8ed(0x122)]},{'useId':_0x9a53a4,'status':0x1}),_0x1aa8ed(0xe1);}async['queryAllCrami'](_0x256126,_0x3f4add){const _0x3c846e=_0x2b6771,{page:page=0x1,size:size=0xa,status:_0x3e5c7b,useId:_0x414a2b}=_0x256126,_0x3e923e={};_0x3e5c7b&&Object[_0x3c846e(0xe3)](_0x3e923e,{'status':_0x3e5c7b}),_0x414a2b&&Object[_0x3c846e(0xe3)](_0x3e923e,{'useId':_0x414a2b});const [_0x47f0de,_0x65de10]=await this['cramiEntity'][_0x3c846e(0xd4)]({'skip':(page-0x1)*size,'take':size,'order':{'createdAt':_0x3c846e(0x110)},'where':_0x3e923e}),_0x55386a=_0x47f0de[_0x3c846e(0xe6)](_0x2f077b=>_0x2f077b[_0x3c846e(0x105)]),_0x39677c=_0x47f0de[_0x3c846e(0xe6)](_0x1b7762=>_0x1b7762[_0x3c846e(0xfc)]),_0x4a79c1=await this[_0x3c846e(0xe4)][_0x3c846e(0x127)]({'where':{'id':(0x0,typeorm_2['In'])(_0x55386a)}}),_0x244620=await this[_0x3c846e(0x102)][_0x3c846e(0x127)]({'where':{'id':(0x0,typeorm_2['In'])(_0x39677c)}});return _0x47f0de[_0x3c846e(0x11f)](_0x566209=>{const _0x289b85=_0x3c846e;var _0x4b212a,_0x3def75,_0x6c414d;_0x566209['username']=(_0x4b212a=_0x4a79c1[_0x289b85(0x127)](_0x3d9073=>_0x3d9073['id']===_0x566209[_0x289b85(0x105)]))===null||_0x4b212a===void 0x0?void 0x0:_0x4b212a[_0x289b85(0xe0)],_0x566209[_0x289b85(0xe9)]=(_0x3def75=_0x4a79c1['find'](_0xab7bec=>_0xab7bec['id']===_0x566209[_0x289b85(0x105)]))===null||_0x3def75===void 0x0?void 0x0:_0x3def75[_0x289b85(0xe9)],_0x566209['packageName']=(_0x6c414d=_0x244620[_0x289b85(0x127)](_0x37a9c1=>_0x37a9c1['id']===_0x566209[_0x289b85(0xfc)]))===null||_0x6c414d===void 0x0?void 0x0:_0x6c414d['name'];}),_0x3f4add[_0x3c846e(0x111)]['role']!==_0x3c846e(0xff)&&_0x47f0de['forEach'](_0x400b51=>_0x400b51['email']=(0x0,utils_1[_0x3c846e(0x128)])(_0x400b51[_0x3c846e(0xe9)])),_0x3f4add[_0x3c846e(0x111)][_0x3c846e(0xfa)]!==_0x3c846e(0xff)&&_0x47f0de[_0x3c846e(0x11f)](_0x4b4213=>_0x4b4213[_0x3c846e(0x122)]=(0x0,utils_1['maskCrami'])(_0x4b4213[_0x3c846e(0x122)])),{'rows':_0x47f0de,'count':_0x65de10};}async[_0x2b6771(0x121)](_0x5cddd9){const _0x15ad63=_0x2b6771,_0x287164=await this['cramiEntity'][_0x15ad63(0x11b)]({'where':{'id':_0x5cddd9}});if(!_0x287164)throw new common_1['HttpException'](_0x15ad63(0xd8),common_1[_0x15ad63(0x10c)][_0x15ad63(0xef)]);if(_0x287164[_0x15ad63(0xcb)]===0x1)throw new common_1['HttpException'](_0x15ad63(0x114),common_1[_0x15ad63(0x10c)][_0x15ad63(0xef)]);return await this['cramiEntity']['delete']({'id':_0x5cddd9});}async['batchDelCrami'](_0x124372){const _0x5e7d29=_0x2b6771,{ids:_0x3939c7}=_0x124372,_0x5b38ae=await this['cramiEntity'][_0x5e7d29(0xcd)](_0x3939c7);if(_0x5b38ae[_0x5e7d29(0x112)]>0x0)return _0x5e7d29(0x117);else throw new common_1[(_0x5e7d29(0xcf))](_0x5e7d29(0x10e),common_1[_0x5e7d29(0x10c)][_0x5e7d29(0xef)]);}};function _0x20c6(){const _0xb121dd=['Injectable','359672Npixuq','role','delPackage','packageId','907568ulAuBn','套餐名称或套餐等级重复、请检查！','super','UserEntity','CramiPackageEntity','cramiPackageEntity','function','metadata','useId','PACKAGE_GIFT','userBalanceService','../userBalance/userBalance.service','generateCrami','当前套餐下存在卡密、请先删除卡密后才可删除套餐！','4423764aDJbnM','HttpStatus','49JyiMQs','删除卡密失败、请重试！','defineProperty','DESC','user','affected','error:\x20','当前卡密已被使用、已使用的卡密禁止删除！','log','10lfvmhD','删除卡密成功！','CramiEntity','length','getOwnPropertyDescriptor','findOne','queryOnePackage','687469sQKzMT','../../common/constants/balance.constant','forEach','__esModule','delCrami','code','自定义卡密必须至少一项余额不为0️零！','50ZywYnY','save','当前套餐不存在、请确认您选择的套餐是否存在！','find','maskEmail','update','createCrami','create','更新套餐失败、请重试！','@nestjs/common','status','decorate','delete','MoreThan','HttpException','UserBalanceService','cramiEntity','184761aYnlpG','228VCdMCx','findAndCount','createPackage','InjectRepository','CramiService','当前卡密不存在、请确认您要删除的卡密是否存在！','13396RdXLhS','1447215mePCCc','Repository','__metadata','__param','push','LessThanOrEqual','username','使用卡密成功','./cramiPackage.entity','assign','userEntity','@nestjs/typeorm','map','__decorate','105YTSuDi','email','../../common/utils','design:paramtypes','count','every','Not','BAD_REQUEST','object','./crami.entity','当前卡密已被使用、请确认您输入的卡密是否正确！','generateCramiCode','Like','更新套餐成功！','RechargeType','updatePackage'];_0x20c6=function(){return _0xb121dd;};return _0x20c6();}CramiService=__decorate([(0x0,common_1[_0x2b6771(0xf8)])(),__param(0x0,(0x0,typeorm_1[_0x2b6771(0xd6)])(crami_entity_1[_0x2b6771(0x118)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(cramiPackage_entity_1[_0x2b6771(0x101)])),__param(0x2,(0x0,typeorm_1[_0x2b6771(0xd6)])(user_entity_1[_0x2b6771(0x100)])),__metadata(_0x2b6771(0xeb),[typeorm_2[_0x2b6771(0xdb)],typeorm_2[_0x2b6771(0xdb)],typeorm_2[_0x2b6771(0xdb)],userBalance_service_1[_0x2b6771(0xd0)]])],CramiService),exports[_0x2b6771(0xd7)]=CramiService;