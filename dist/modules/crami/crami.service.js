'use strict';function _0x5328(_0x226eee,_0x374e70){const _0x217012=_0x2170();return _0x5328=function(_0x5328e6,_0x13b612){_0x5328e6=_0x5328e6-0x164;let _0x1a1e2c=_0x217012[_0x5328e6];return _0x1a1e2c;},_0x5328(_0x226eee,_0x374e70);}const _0x1b207a=_0x5328;(function(_0x1946ad,_0xff4bc2){const _0x381213=_0x5328,_0x4eb504=_0x1946ad();while(!![]){try{const _0x3631d6=-parseInt(_0x381213(0x1a5))/0x1+parseInt(_0x381213(0x180))/0x2*(-parseInt(_0x381213(0x1ac))/0x3)+-parseInt(_0x381213(0x169))/0x4*(parseInt(_0x381213(0x16c))/0x5)+-parseInt(_0x381213(0x1a0))/0x6*(parseInt(_0x381213(0x172))/0x7)+parseInt(_0x381213(0x1a6))/0x8+-parseInt(_0x381213(0x19a))/0x9*(parseInt(_0x381213(0x1ad))/0xa)+parseInt(_0x381213(0x1a9))/0xb;if(_0x3631d6===_0xff4bc2)break;else _0x4eb504['push'](_0x4eb504['shift']());}catch(_0x3224e3){_0x4eb504['push'](_0x4eb504['shift']());}}}(_0x2170,0x1cfbf));var __decorate=this&&this[_0x1b207a(0x1b9)]||function(_0x19d051,_0x323421,_0x952a6,_0x519277){const _0x163971=_0x1b207a;var _0x16f9e3=arguments[_0x163971(0x183)],_0x511793=_0x16f9e3<0x3?_0x323421:_0x519277===null?_0x519277=Object[_0x163971(0x195)](_0x323421,_0x952a6):_0x519277,_0x39bce1;if(typeof Reflect===_0x163971(0x16a)&&typeof Reflect[_0x163971(0x1b1)]===_0x163971(0x185))_0x511793=Reflect[_0x163971(0x1b1)](_0x19d051,_0x323421,_0x952a6,_0x519277);else{for(var _0x15a0c3=_0x19d051['length']-0x1;_0x15a0c3>=0x0;_0x15a0c3--)if(_0x39bce1=_0x19d051[_0x15a0c3])_0x511793=(_0x16f9e3<0x3?_0x39bce1(_0x511793):_0x16f9e3>0x3?_0x39bce1(_0x323421,_0x952a6,_0x511793):_0x39bce1(_0x323421,_0x952a6))||_0x511793;}return _0x16f9e3>0x3&&_0x511793&&Object[_0x163971(0x176)](_0x323421,_0x952a6,_0x511793),_0x511793;},__metadata=this&&this[_0x1b207a(0x181)]||function(_0x5bf19f,_0x5e17a5){const _0x66c811=_0x1b207a;if(typeof Reflect===_0x66c811(0x16a)&&typeof Reflect[_0x66c811(0x1ba)]==='function')return Reflect[_0x66c811(0x1ba)](_0x5bf19f,_0x5e17a5);},__param=this&&this['__param']||function(_0x4bae29,_0x3de3a3){return function(_0x5b1390,_0x1524d0){_0x3de3a3(_0x5b1390,_0x1524d0,_0x4bae29);};};Object['defineProperty'](exports,_0x1b207a(0x194),{'value':!![]}),exports[_0x1b207a(0x17d)]=void 0x0;const common_1=require(_0x1b207a(0x174)),crami_entity_1=require(_0x1b207a(0x16f)),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0x1b207a(0x199)),cramiPackage_entity_1=require('./cramiPackage.entity'),utils_1=require(_0x1b207a(0x164)),user_entity_1=require(_0x1b207a(0x18c)),userBalance_service_1=require('../userBalance/userBalance.service'),balance_constant_1=require(_0x1b207a(0x1b5));function _0x2170(){const _0xca05eb=['every','error:\x20','typeorm','41247lEkDSV','user','forEach','更新套餐成功！','generateCrami','maskEmail','924972acXrHT','design:paramtypes','queryAllPackage','generateCramiCode','套餐名称或套餐等级重复、请检查！','185865IsjNjW','1694240hddShK','自定义卡密必须至少一项余额不为0️零！','update','7351740lGNzSJ','UserBalanceService','addBalanceToUser','6SFRjYD','70MvMKqo','HttpStatus','useCrami','PACKAGE_GIFT','decorate','status','assign','map','../../common/constants/balance.constant','username','Repository','super','__decorate','metadata','cramiPackageEntity','find','role','packageId','更新套餐失败、请重试！','CramiPackageEntity','Not','createCrami','../../common/utils','delCrami','delete','saveRecordRechargeLog','count','84eTSeTH','object','delPackage','46915uvQsHU','当前卡密不存在、请确认您输入的卡密是否正确！','maskCrami','./crami.entity','当前卡密不存在、请确认您要删除的卡密是否存在！','findOne','7lFssxI','CramiEntity','@nestjs/common','useId','defineProperty','HttpException','queryOnePackage','cramiEntity','Like','code','当前套餐下存在卡密、请先删除卡密后才可删除套餐！','CramiService','Injectable','email','192250QqBJen','__metadata','updatePackage','length','RechargeType','function','BAD_REQUEST','save','batchDelCrami','affected','userEntity','createPackage','../user/user.entity','push','InjectRepository','log','使用卡密成功','userBalanceService','UserEntity','当前套餐不存在、请检查你的输入参数！','__esModule','getOwnPropertyDescriptor','findAndCount'];_0x2170=function(){return _0xca05eb;};return _0x2170();}let CramiService=class CramiService{constructor(_0x81c7ed,_0x1c2739,_0x4a8434,_0x48834f){const _0x12c71a=_0x1b207a;this[_0x12c71a(0x179)]=_0x81c7ed,this[_0x12c71a(0x1bb)]=_0x1c2739,this[_0x12c71a(0x18a)]=_0x4a8434,this[_0x12c71a(0x191)]=_0x48834f;}async[_0x1b207a(0x178)](_0x4b3c7e){const _0x45c376=_0x1b207a;return await this['cramiPackageEntity'][_0x45c376(0x171)]({'where':{'id':_0x4b3c7e}});}async[_0x1b207a(0x1a2)](_0x13eab2){const _0xd5a6ba=_0x1b207a;try{const {page:page=0x1,size:size=0xa,name:_0x1408c5,status:_0x5c260b,type:_0x4b9c55}=_0x13eab2,_0x51958a={};_0x1408c5&&Object['assign'](_0x51958a,{'name':(0x0,typeorm_2[_0xd5a6ba(0x17a)])('%'+_0x1408c5+'%')}),_0x5c260b&&Object['assign'](_0x51958a,{'status':_0x5c260b});_0x4b9c55&&(_0x4b9c55>0x0?Object[_0xd5a6ba(0x1b3)](_0x51958a,{'days':(0x0,typeorm_2['MoreThan'])(0x0)}):Object[_0xd5a6ba(0x1b3)](_0x51958a,{'days':(0x0,typeorm_2['LessThanOrEqual'])(0x0)}));const [_0x4749f1,_0x19afef]=await this[_0xd5a6ba(0x1bb)][_0xd5a6ba(0x196)]({'skip':(page-0x1)*size,'take':size,'where':_0x51958a,'order':{'order':'DESC'}});return{'rows':_0x4749f1,'count':_0x19afef};}catch(_0x38c3c9){console[_0xd5a6ba(0x18f)](_0xd5a6ba(0x198),_0x38c3c9);}}async[_0x1b207a(0x18b)](_0x5204da){const _0x1c5370=_0x1b207a,{name:_0x4917ab,weight:_0x272799}=_0x5204da,_0x4b46e4=await this['cramiPackageEntity'][_0x1c5370(0x171)]({'where':[{'name':_0x4917ab},{'weight':_0x272799}]});if(_0x4b46e4)throw new common_1[(_0x1c5370(0x177))]('套餐名称或套餐等级重复、请检查！',common_1['HttpStatus'][_0x1c5370(0x186)]);try{return await this[_0x1c5370(0x1bb)][_0x1c5370(0x187)](_0x5204da);}catch(_0x18886c){console[_0x1c5370(0x18f)]('error:\x20',_0x18886c);throw new common_1['HttpException'](_0x18886c,common_1['HttpStatus'][_0x1c5370(0x186)]);}}async[_0x1b207a(0x182)](_0x13831d){const _0x307711=_0x1b207a,{id:_0x2a45ba,name:_0x4286b9,weight:_0x81119e}=_0x13831d,_0x1d93cc=await this[_0x307711(0x1bb)]['findOne']({'where':{'id':_0x2a45ba}});if(!_0x1d93cc)throw new common_1[(_0x307711(0x177))](_0x307711(0x193),common_1[_0x307711(0x1ae)][_0x307711(0x186)]);const _0x30badb=await this[_0x307711(0x1bb)][_0x307711(0x168)]({'where':[{'name':_0x4286b9,'id':(0x0,typeorm_2[_0x307711(0x1c1)])(_0x2a45ba)},{'weight':_0x81119e,'id':(0x0,typeorm_2[_0x307711(0x1c1)])(_0x2a45ba)}]});if(_0x30badb)throw new common_1['HttpException'](_0x307711(0x1a4),common_1[_0x307711(0x1ae)][_0x307711(0x186)]);const _0x1d44ef=await this[_0x307711(0x1bb)][_0x307711(0x1a8)]({'id':_0x2a45ba},_0x13831d);if(_0x1d44ef[_0x307711(0x189)]>0x0)return _0x307711(0x19d);else throw new common_1[(_0x307711(0x177))](_0x307711(0x1bf),common_1['HttpStatus']['BAD_REQUEST']);}async[_0x1b207a(0x16b)](_0x37bad8){const _0x4d81bb=_0x1b207a,{id:_0x366a98}=_0x37bad8,_0x5fa8c5=await this[_0x4d81bb(0x179)][_0x4d81bb(0x168)]({'where':{'packageId':_0x366a98}});if(_0x5fa8c5)throw new common_1[(_0x4d81bb(0x177))](_0x4d81bb(0x17c),common_1['HttpStatus'][_0x4d81bb(0x186)]);return await this[_0x4d81bb(0x1bb)][_0x4d81bb(0x166)]({'id':_0x366a98});}async[_0x1b207a(0x1c2)](_0x2d80e8){const _0x53cd84=_0x1b207a,{packageId:_0x28a736,count:count=0x1}=_0x2d80e8;if(_0x28a736){const _0x1e3f9c=await this[_0x53cd84(0x1bb)]['findOne']({'where':{'id':_0x28a736}});if(!_0x1e3f9c)throw new common_1['HttpException']('当前套餐不存在、请确认您选择的套餐是否存在！',common_1['HttpStatus']['BAD_REQUEST']);const {days:days=-0x1,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x1e3f9c,_0x18cbf1={'packageId':_0x28a736,'days':days,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount};return await this[_0x53cd84(0x19e)](_0x18cbf1,count);}if(!_0x28a736){const {model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x2d80e8;if([model3Count,model4Count,drawMjCount][_0x53cd84(0x197)](_0x48c32f=>!_0x48c32f))throw new common_1['HttpException'](_0x53cd84(0x1a7),common_1[_0x53cd84(0x1ae)]['BAD_REQUEST']);const _0x27f00e={'days':-0x1,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount};return await this[_0x53cd84(0x19e)](_0x27f00e,count);}}async[_0x1b207a(0x19e)](_0x2d6373,_0x2318e1){const _0x3e9b7d=_0x1b207a,_0x59b28a=[];for(let _0x204a8f=0x0;_0x204a8f<_0x2318e1;_0x204a8f++){const _0x1629d6=(0x0,utils_1[_0x3e9b7d(0x1a3)])(),_0x3246ba=this[_0x3e9b7d(0x179)]['create'](Object['assign'](Object[_0x3e9b7d(0x1b3)]({},_0x2d6373),{'code':_0x1629d6}));_0x59b28a[_0x3e9b7d(0x18d)](_0x3246ba);}return await this[_0x3e9b7d(0x179)]['save'](_0x59b28a);}async[_0x1b207a(0x1af)](_0x5c07fb,_0x50f62a){const _0x104a03=_0x1b207a,{id:_0x77441b}=_0x5c07fb['user'],_0x3da19a=await this[_0x104a03(0x179)][_0x104a03(0x171)]({'where':{'code':_0x50f62a['code']}});if(!_0x3da19a)throw new common_1[(_0x104a03(0x177))](_0x104a03(0x16d),common_1[_0x104a03(0x1ae)][_0x104a03(0x186)]);const {status:_0x149449,days:days=-0x1,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0,packageId:_0xaeb335}=_0x3da19a;if(_0x149449===0x1)throw new common_1[(_0x104a03(0x177))]('当前卡密已被使用、请确认您输入的卡密是否正确！',common_1[_0x104a03(0x1ae)][_0x104a03(0x186)]);const _0x4dcddf={'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'packageId':_0xaeb335};return await this[_0x104a03(0x191)][_0x104a03(0x1ab)](_0x77441b,Object[_0x104a03(0x1b3)]({},_0x4dcddf),days),await this[_0x104a03(0x191)][_0x104a03(0x167)]({'userId':_0x77441b,'rechargeType':balance_constant_1[_0x104a03(0x184)][_0x104a03(0x1b0)],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'days':days}),await this[_0x104a03(0x179)][_0x104a03(0x1a8)]({'code':_0x50f62a['code']},{'useId':_0x77441b,'status':0x1}),_0x104a03(0x190);}async['queryAllCrami'](_0x57916d,_0x7ea2fe){const _0x5762c0=_0x1b207a,{page:page=0x1,size:size=0xa,status:_0x21f6b7,useId:_0x1e4571}=_0x57916d,_0x43b978={};_0x21f6b7&&Object[_0x5762c0(0x1b3)](_0x43b978,{'status':_0x21f6b7}),_0x1e4571&&Object[_0x5762c0(0x1b3)](_0x43b978,{'useId':_0x1e4571});const [_0x419aec,_0xd4b9a2]=await this[_0x5762c0(0x179)]['findAndCount']({'skip':(page-0x1)*size,'take':size,'order':{'createdAt':'DESC'},'where':_0x43b978}),_0x5aac74=_0x419aec[_0x5762c0(0x1b4)](_0x9c493b=>_0x9c493b['useId']),_0x278ee5=_0x419aec['map'](_0x447641=>_0x447641[_0x5762c0(0x1be)]),_0x465bc6=await this[_0x5762c0(0x18a)][_0x5762c0(0x1bc)]({'where':{'id':(0x0,typeorm_2['In'])(_0x5aac74)}}),_0x24ac8b=await this[_0x5762c0(0x1bb)][_0x5762c0(0x1bc)]({'where':{'id':(0x0,typeorm_2['In'])(_0x278ee5)}});return _0x419aec[_0x5762c0(0x19c)](_0x2d509f=>{const _0x312718=_0x5762c0;var _0x4388dc,_0xf03a33,_0x1d1bae;_0x2d509f['username']=(_0x4388dc=_0x465bc6[_0x312718(0x1bc)](_0x15ffc1=>_0x15ffc1['id']===_0x2d509f['useId']))===null||_0x4388dc===void 0x0?void 0x0:_0x4388dc[_0x312718(0x1b6)],_0x2d509f['email']=(_0xf03a33=_0x465bc6[_0x312718(0x1bc)](_0x4cc39f=>_0x4cc39f['id']===_0x2d509f[_0x312718(0x175)]))===null||_0xf03a33===void 0x0?void 0x0:_0xf03a33['email'],_0x2d509f['packageName']=(_0x1d1bae=_0x24ac8b[_0x312718(0x1bc)](_0x1803c4=>_0x1803c4['id']===_0x2d509f[_0x312718(0x1be)]))===null||_0x1d1bae===void 0x0?void 0x0:_0x1d1bae['name'];}),_0x7ea2fe['user']['role']!==_0x5762c0(0x1b8)&&_0x419aec['forEach'](_0x4c7aff=>_0x4c7aff[_0x5762c0(0x17f)]=(0x0,utils_1[_0x5762c0(0x19f)])(_0x4c7aff[_0x5762c0(0x17f)])),_0x7ea2fe[_0x5762c0(0x19b)][_0x5762c0(0x1bd)]!==_0x5762c0(0x1b8)&&_0x419aec['forEach'](_0x1b01cf=>_0x1b01cf[_0x5762c0(0x17b)]=(0x0,utils_1[_0x5762c0(0x16e)])(_0x1b01cf[_0x5762c0(0x17b)])),{'rows':_0x419aec,'count':_0xd4b9a2};}async[_0x1b207a(0x165)](_0x66fe7){const _0x202f1b=_0x1b207a,_0x4f8b89=await this['cramiEntity']['findOne']({'where':{'id':_0x66fe7}});if(!_0x4f8b89)throw new common_1['HttpException'](_0x202f1b(0x170),common_1[_0x202f1b(0x1ae)]['BAD_REQUEST']);if(_0x4f8b89[_0x202f1b(0x1b2)]===0x1)throw new common_1[(_0x202f1b(0x177))]('当前卡密已被使用、已使用的卡密禁止删除！',common_1[_0x202f1b(0x1ae)][_0x202f1b(0x186)]);return await this[_0x202f1b(0x179)][_0x202f1b(0x166)]({'id':_0x66fe7});}async[_0x1b207a(0x188)](_0x6f5d6b){const _0x2de528=_0x1b207a,{ids:_0x535368}=_0x6f5d6b,_0x3561a1=await this[_0x2de528(0x179)]['delete'](_0x535368);if(_0x3561a1[_0x2de528(0x189)]>0x0)return'删除卡密成功！';else throw new common_1[(_0x2de528(0x177))]('删除卡密失败、请重试！',common_1[_0x2de528(0x1ae)][_0x2de528(0x186)]);}};CramiService=__decorate([(0x0,common_1[_0x1b207a(0x17e)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(crami_entity_1[_0x1b207a(0x173)])),__param(0x1,(0x0,typeorm_1[_0x1b207a(0x18e)])(cramiPackage_entity_1[_0x1b207a(0x1c0)])),__param(0x2,(0x0,typeorm_1[_0x1b207a(0x18e)])(user_entity_1[_0x1b207a(0x192)])),__metadata(_0x1b207a(0x1a1),[typeorm_2[_0x1b207a(0x1b7)],typeorm_2[_0x1b207a(0x1b7)],typeorm_2[_0x1b207a(0x1b7)],userBalance_service_1[_0x1b207a(0x1aa)]])],CramiService),exports[_0x1b207a(0x17d)]=CramiService;