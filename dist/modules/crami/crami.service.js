'use strict';const _0x297e8c=_0x3f44;function _0x3f44(_0x584781,_0x3048cc){const _0x219136=_0x2191();return _0x3f44=function(_0x3f44a2,_0x1dc971){_0x3f44a2=_0x3f44a2-0x1bb;let _0x54219d=_0x219136[_0x3f44a2];return _0x54219d;},_0x3f44(_0x584781,_0x3048cc);}(function(_0x5865e7,_0x44bb10){const _0x4cc105=_0x3f44,_0x283ea8=_0x5865e7();while(!![]){try{const _0x5b0879=parseInt(_0x4cc105(0x1d4))/0x1+parseInt(_0x4cc105(0x217))/0x2*(-parseInt(_0x4cc105(0x1cb))/0x3)+parseInt(_0x4cc105(0x1bd))/0x4*(-parseInt(_0x4cc105(0x1c8))/0x5)+-parseInt(_0x4cc105(0x1d1))/0x6*(parseInt(_0x4cc105(0x212))/0x7)+parseInt(_0x4cc105(0x1bb))/0x8*(parseInt(_0x4cc105(0x1cc))/0x9)+-parseInt(_0x4cc105(0x1cf))/0xa+-parseInt(_0x4cc105(0x1e1))/0xb*(-parseInt(_0x4cc105(0x208))/0xc);if(_0x5b0879===_0x44bb10)break;else _0x283ea8['push'](_0x283ea8['shift']());}catch(_0x2e6b5e){_0x283ea8['push'](_0x283ea8['shift']());}}}(_0x2191,0xe7cd5));var __decorate=this&&this[_0x297e8c(0x21a)]||function(_0x3608b7,_0x31c5ac,_0x49e9ec,_0xdfa8ca){const _0x55847a=_0x297e8c;var _0x20fd86=arguments[_0x55847a(0x1ee)],_0x42a9c9=_0x20fd86<0x3?_0x31c5ac:_0xdfa8ca===null?_0xdfa8ca=Object['getOwnPropertyDescriptor'](_0x31c5ac,_0x49e9ec):_0xdfa8ca,_0x29c60e;if(typeof Reflect===_0x55847a(0x203)&&typeof Reflect[_0x55847a(0x219)]==='function')_0x42a9c9=Reflect[_0x55847a(0x219)](_0x3608b7,_0x31c5ac,_0x49e9ec,_0xdfa8ca);else{for(var _0x256b07=_0x3608b7[_0x55847a(0x1ee)]-0x1;_0x256b07>=0x0;_0x256b07--)if(_0x29c60e=_0x3608b7[_0x256b07])_0x42a9c9=(_0x20fd86<0x3?_0x29c60e(_0x42a9c9):_0x20fd86>0x3?_0x29c60e(_0x31c5ac,_0x49e9ec,_0x42a9c9):_0x29c60e(_0x31c5ac,_0x49e9ec))||_0x42a9c9;}return _0x20fd86>0x3&&_0x42a9c9&&Object[_0x55847a(0x207)](_0x31c5ac,_0x49e9ec,_0x42a9c9),_0x42a9c9;},__metadata=this&&this[_0x297e8c(0x1e8)]||function(_0x28e021,_0x18dd8b){const _0x21f632=_0x297e8c;if(typeof Reflect===_0x21f632(0x203)&&typeof Reflect[_0x21f632(0x1da)]===_0x21f632(0x1fb))return Reflect[_0x21f632(0x1da)](_0x28e021,_0x18dd8b);},__param=this&&this['__param']||function(_0x137da8,_0x3cfa30){return function(_0x560c75,_0x2eab6e){_0x3cfa30(_0x560c75,_0x2eab6e,_0x137da8);};};Object[_0x297e8c(0x207)](exports,'__esModule',{'value':!![]}),exports['CramiService']=void 0x0;const common_1=require(_0x297e8c(0x1db)),crami_entity_1=require(_0x297e8c(0x20b)),typeorm_1=require(_0x297e8c(0x1e4)),typeorm_2=require(_0x297e8c(0x1c1)),cramiPackage_entity_1=require(_0x297e8c(0x1ea)),utils_1=require('../../common/utils'),user_entity_1=require(_0x297e8c(0x1d7)),userBalance_service_1=require(_0x297e8c(0x1d8)),balance_constant_1=require('../../common/constants/balance.constant');let CramiService=class CramiService{constructor(_0x5d24b3,_0x4e1686,_0x1aaa57,_0x2da25e){const _0x191c2b=_0x297e8c;this[_0x191c2b(0x205)]=_0x5d24b3,this[_0x191c2b(0x1bf)]=_0x4e1686,this[_0x191c2b(0x1de)]=_0x1aaa57,this[_0x191c2b(0x1d0)]=_0x2da25e;}async[_0x297e8c(0x216)](_0x4f20d8){return await this['cramiPackageEntity']['findOne']({'where':{'id':_0x4f20d8}});}async['queryAllPackage'](_0x5744b0){const _0x5698fa=_0x297e8c;try{const {page:page=0x1,size:size=0xa,name:_0x1203e8,status:_0x2dd595,type:_0x4dc726}=_0x5744b0,_0x3b0ca4={};_0x1203e8&&Object[_0x5698fa(0x1df)](_0x3b0ca4,{'name':(0x0,typeorm_2['Like'])('%'+_0x1203e8+'%')}),_0x2dd595&&Object['assign'](_0x3b0ca4,{'status':_0x2dd595});_0x4dc726&&(_0x4dc726>0x0?Object[_0x5698fa(0x1df)](_0x3b0ca4,{'days':(0x0,typeorm_2[_0x5698fa(0x213)])(0x0)}):Object['assign'](_0x3b0ca4,{'days':(0x0,typeorm_2['LessThanOrEqual'])(0x0)}));const [_0x52d705,_0x5699ba]=await this[_0x5698fa(0x1bf)][_0x5698fa(0x1f4)]({'skip':(page-0x1)*size,'take':size,'where':_0x3b0ca4,'order':{'order':_0x5698fa(0x210)}});return{'rows':_0x52d705,'count':_0x5699ba};}catch(_0x291f84){console[_0x5698fa(0x1f8)](_0x5698fa(0x1f7),_0x291f84);}}async[_0x297e8c(0x1eb)](_0x56a7a9){const _0x45a22d=_0x297e8c,{name:_0x2e29f0,weight:_0xfbbfe6}=_0x56a7a9,_0x4c868a=await this[_0x45a22d(0x1bf)][_0x45a22d(0x1c9)]({'where':[{'name':_0x2e29f0},{'weight':_0xfbbfe6}]});if(_0x4c868a)throw new common_1[(_0x45a22d(0x1dd))](_0x45a22d(0x1e7),common_1[_0x45a22d(0x1d9)][_0x45a22d(0x1c3)]);try{return await this[_0x45a22d(0x1bf)][_0x45a22d(0x211)](_0x56a7a9);}catch(_0x3e792f){console[_0x45a22d(0x1f8)](_0x45a22d(0x1f7),_0x3e792f);throw new common_1[(_0x45a22d(0x1dd))](_0x3e792f,common_1[_0x45a22d(0x1d9)][_0x45a22d(0x1c3)]);}}async[_0x297e8c(0x1fa)](_0x1166b0){const _0x195bf3=_0x297e8c,{id:_0x479fd2,name:_0x63671e,weight:_0x2d48fe}=_0x1166b0,_0x14bf92=await this['cramiPackageEntity'][_0x195bf3(0x1c9)]({'where':{'id':_0x479fd2}});if(!_0x14bf92)throw new common_1[(_0x195bf3(0x1dd))]('当前套餐不存在、请检查你的输入参数！',common_1[_0x195bf3(0x1d9)]['BAD_REQUEST']);const _0x1bc021=await this['cramiPackageEntity'][_0x195bf3(0x1ca)]({'where':[{'name':_0x63671e,'id':(0x0,typeorm_2['Not'])(_0x479fd2)},{'weight':_0x2d48fe,'id':(0x0,typeorm_2[_0x195bf3(0x1c7)])(_0x479fd2)}]});if(_0x1bc021)throw new common_1[(_0x195bf3(0x1dd))](_0x195bf3(0x1e7),common_1['HttpStatus'][_0x195bf3(0x1c3)]);const _0x24d13a=await this[_0x195bf3(0x1bf)][_0x195bf3(0x1f3)]({'id':_0x479fd2},_0x1166b0);if(_0x24d13a[_0x195bf3(0x1d5)]>0x0)return _0x195bf3(0x1ed);else throw new common_1['HttpException'](_0x195bf3(0x1c2),common_1[_0x195bf3(0x1d9)][_0x195bf3(0x1c3)]);}async[_0x297e8c(0x20c)](_0x1be8b5){const _0x48801a=_0x297e8c,{id:_0x2be11b}=_0x1be8b5,_0x189666=await this[_0x48801a(0x205)]['count']({'where':{'packageId':_0x2be11b}});if(_0x189666)throw new common_1[(_0x48801a(0x1dd))](_0x48801a(0x1ec),common_1['HttpStatus'][_0x48801a(0x1c3)]);return await this[_0x48801a(0x1bf)][_0x48801a(0x1c6)]({'id':_0x2be11b});}async[_0x297e8c(0x1ce)](_0x3b39c3){const _0x20c74c=_0x297e8c,{packageId:_0x584a1c,count:count=0x1}=_0x3b39c3;if(_0x584a1c){const _0x475040=await this['cramiPackageEntity'][_0x20c74c(0x1c9)]({'where':{'id':_0x584a1c}});if(!_0x475040)throw new common_1[(_0x20c74c(0x1dd))](_0x20c74c(0x1d2),common_1[_0x20c74c(0x1d9)][_0x20c74c(0x1c3)]);const {days:days=-0x1,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x475040,_0x448c70={'packageId':_0x584a1c,'days':days,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount};return await this['generateCrami'](_0x448c70,count);}if(!_0x584a1c){const {model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x3b39c3;if([model3Count,model4Count,drawMjCount]['every'](_0x447c22=>!_0x447c22))throw new common_1[(_0x20c74c(0x1dd))](_0x20c74c(0x209),common_1[_0x20c74c(0x1d9)][_0x20c74c(0x1c3)]);const _0x7fe593={'days':-0x1,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount};return await this[_0x20c74c(0x1be)](_0x7fe593,count);}}async['generateCrami'](_0xfcb8b6,_0xe11d62){const _0x3cee08=_0x297e8c,_0x1a9150=[];for(let _0x54cf50=0x0;_0x54cf50<_0xe11d62;_0x54cf50++){const _0x244d7f=(0x0,utils_1[_0x3cee08(0x1d6)])(),_0x38c3b3=this['cramiEntity'][_0x3cee08(0x1f2)](Object['assign'](Object[_0x3cee08(0x1df)]({},_0xfcb8b6),{'code':_0x244d7f}));_0x1a9150[_0x3cee08(0x1e5)](_0x38c3b3);}return await this['cramiEntity'][_0x3cee08(0x211)](_0x1a9150);}async['useCrami'](_0x1144ed,_0x2a3e22){const _0x5c3608=_0x297e8c,{id:_0x26da03}=_0x1144ed['user'],_0x3c2491=await this[_0x5c3608(0x205)][_0x5c3608(0x1c9)]({'where':{'code':_0x2a3e22[_0x5c3608(0x200)]}});if(!_0x3c2491)throw new common_1['HttpException'](_0x5c3608(0x1c5),common_1[_0x5c3608(0x1d9)][_0x5c3608(0x1c3)]);const {status:_0x5886eb,days:days=-0x1,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0,packageId:_0x38c43b}=_0x3c2491;if(_0x5886eb===0x1)throw new common_1[(_0x5c3608(0x1dd))](_0x5c3608(0x1dc),common_1[_0x5c3608(0x1d9)]['BAD_REQUEST']);const _0x26d37a={'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'packageId':_0x38c43b};return await this[_0x5c3608(0x1d0)][_0x5c3608(0x20f)](_0x26da03,Object['assign']({},_0x26d37a),days),await this['userBalanceService'][_0x5c3608(0x1d3)]({'userId':_0x26da03,'rechargeType':balance_constant_1[_0x5c3608(0x1bc)][_0x5c3608(0x1fc)],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'days':days}),await this[_0x5c3608(0x205)]['update']({'code':_0x2a3e22['code']},{'useId':_0x26da03,'status':0x1}),_0x5c3608(0x1f0);}async['queryAllCrami'](_0x57e765,_0x5408e6){const _0x546e3a=_0x297e8c,{page:page=0x1,size:size=0xa,status:_0x52143d,useId:_0x27a6e3}=_0x57e765,_0x92e171={};_0x52143d&&Object[_0x546e3a(0x1df)](_0x92e171,{'status':_0x52143d}),_0x27a6e3&&Object['assign'](_0x92e171,{'useId':_0x27a6e3});const [_0x567171,_0x5f3acb]=await this[_0x546e3a(0x205)][_0x546e3a(0x1f4)]({'skip':(page-0x1)*size,'take':size,'order':{'createdAt':'DESC'},'where':_0x92e171}),_0x461e50=_0x567171['map'](_0x52d246=>_0x52d246['useId']),_0x1a0aa0=_0x567171['map'](_0x4e31d8=>_0x4e31d8[_0x546e3a(0x1c0)]),_0x4b096a=await this[_0x546e3a(0x1de)][_0x546e3a(0x1cd)]({'where':{'id':(0x0,typeorm_2['In'])(_0x461e50)}}),_0x39e339=await this[_0x546e3a(0x1bf)][_0x546e3a(0x1cd)]({'where':{'id':(0x0,typeorm_2['In'])(_0x1a0aa0)}});return _0x567171['forEach'](_0x4cafe3=>{const _0x299b72=_0x546e3a;var _0xcfefe6,_0x5a8d8a,_0x5950a7;_0x4cafe3['username']=(_0xcfefe6=_0x4b096a[_0x299b72(0x1cd)](_0x5559b9=>_0x5559b9['id']===_0x4cafe3[_0x299b72(0x1e3)]))===null||_0xcfefe6===void 0x0?void 0x0:_0xcfefe6[_0x299b72(0x214)],_0x4cafe3[_0x299b72(0x1e2)]=(_0x5a8d8a=_0x4b096a[_0x299b72(0x1cd)](_0x708e0a=>_0x708e0a['id']===_0x4cafe3[_0x299b72(0x1e3)]))===null||_0x5a8d8a===void 0x0?void 0x0:_0x5a8d8a['email'],_0x4cafe3[_0x299b72(0x1e0)]=(_0x5950a7=_0x39e339[_0x299b72(0x1cd)](_0x553794=>_0x553794['id']===_0x4cafe3['packageId']))===null||_0x5950a7===void 0x0?void 0x0:_0x5950a7[_0x299b72(0x1f5)];}),_0x5408e6[_0x546e3a(0x204)][_0x546e3a(0x201)]!==_0x546e3a(0x1fe)&&_0x567171[_0x546e3a(0x206)](_0x21b66b=>_0x21b66b[_0x546e3a(0x1e2)]=(0x0,utils_1[_0x546e3a(0x1fd)])(_0x21b66b[_0x546e3a(0x1e2)])),_0x5408e6['user'][_0x546e3a(0x201)]!==_0x546e3a(0x1fe)&&_0x567171[_0x546e3a(0x206)](_0xc80425=>_0xc80425[_0x546e3a(0x200)]=(0x0,utils_1[_0x546e3a(0x202)])(_0xc80425[_0x546e3a(0x200)])),{'rows':_0x567171,'count':_0x5f3acb};}async[_0x297e8c(0x1e9)](_0x41f438){const _0x1f1061=_0x297e8c,_0x2497ad=await this['cramiEntity'][_0x1f1061(0x1c9)]({'where':{'id':_0x41f438}});if(!_0x2497ad)throw new common_1[(_0x1f1061(0x1dd))](_0x1f1061(0x1f1),common_1[_0x1f1061(0x1d9)][_0x1f1061(0x1c3)]);if(_0x2497ad[_0x1f1061(0x1ff)]===0x1)throw new common_1[(_0x1f1061(0x1dd))](_0x1f1061(0x20e),common_1['HttpStatus'][_0x1f1061(0x1c3)]);return await this[_0x1f1061(0x205)]['delete']({'id':_0x41f438});}async['batchDelCrami'](_0x195508){const _0x112bc4=_0x297e8c,{ids:_0x37bd81}=_0x195508,_0x39452b=await this[_0x112bc4(0x205)][_0x112bc4(0x1c6)](_0x37bd81);if(_0x39452b[_0x112bc4(0x1d5)]>0x0)return _0x112bc4(0x1ef);else throw new common_1[(_0x112bc4(0x1dd))](_0x112bc4(0x20d),common_1['HttpStatus'][_0x112bc4(0x1c3)]);}};CramiService=__decorate([(0x0,common_1[_0x297e8c(0x1f9)])(),__param(0x0,(0x0,typeorm_1[_0x297e8c(0x21b)])(crami_entity_1[_0x297e8c(0x215)])),__param(0x1,(0x0,typeorm_1[_0x297e8c(0x21b)])(cramiPackage_entity_1[_0x297e8c(0x1f6)])),__param(0x2,(0x0,typeorm_1[_0x297e8c(0x21b)])(user_entity_1['UserEntity'])),__metadata(_0x297e8c(0x1c4),[typeorm_2[_0x297e8c(0x20a)],typeorm_2[_0x297e8c(0x20a)],typeorm_2['Repository'],userBalance_service_1[_0x297e8c(0x1e6)]])],CramiService),exports[_0x297e8c(0x218)]=CramiService;function _0x2191(){const _0x251079=['删除卡密失败、请重试！','当前卡密已被使用、已使用的卡密禁止删除！','addBalanceToUser','DESC','save','6539939xuYggM','MoreThan','username','CramiEntity','queryOnePackage','128974lWJxwP','CramiService','decorate','__decorate','InjectRepository','2235128bBDpmL','RechargeType','848948Aqwyjc','generateCrami','cramiPackageEntity','packageId','typeorm','更新套餐失败、请重试！','BAD_REQUEST','design:paramtypes','当前卡密不存在、请确认您输入的卡密是否正确！','delete','Not','30yRmcsX','findOne','count','39vkLlIy','9dWSiwh','find','createCrami','78150TvvAvq','userBalanceService','6ZYCTbp','当前套餐不存在、请确认您选择的套餐是否存在！','saveRecordRechargeLog','1508815PCnRBo','affected','generateCramiCode','../user/user.entity','../userBalance/userBalance.service','HttpStatus','metadata','@nestjs/common','当前卡密已被使用、请确认您输入的卡密是否正确！','HttpException','userEntity','assign','packageName','57332wmzjsH','email','useId','@nestjs/typeorm','push','UserBalanceService','套餐名称或套餐等级重复、请检查！','__metadata','delCrami','./cramiPackage.entity','createPackage','当前套餐下存在卡密、请先删除卡密后才可删除套餐！','更新套餐成功！','length','删除卡密成功！','使用卡密成功','当前卡密不存在、请确认您要删除的卡密是否存在！','create','update','findAndCount','name','CramiPackageEntity','error:\x20','log','Injectable','updatePackage','function','PACKAGE_GIFT','maskEmail','super','status','code','role','maskCrami','object','user','cramiEntity','forEach','defineProperty','5100tGdTzr','自定义卡密必须至少一项余额不为0️零！','Repository','./crami.entity','delPackage'];_0x2191=function(){return _0x251079;};return _0x2191();}