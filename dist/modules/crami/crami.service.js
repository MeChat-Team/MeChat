'use strict';function _0x5325(){const _0x274a33=['delCrami','__esModule','queryOnePackage','findOne','144mnZYAm','@nestjs/typeorm','getOwnPropertyDescriptor','length','cramiPackageEntity','userEntity','CramiPackageEntity','1718985rmGmYp','Like','MoreThan','forEach','createCrami','__param','cramiEntity','InjectRepository','../user/user.entity','log','当前套餐不存在、请检查你的输入参数！','generateCrami','username','自定义卡密必须至少一项余额不为0️零！','user','6837084aZqfzI','Injectable','useId','@nestjs/common','findAndCount','metadata','defineProperty','../userBalance/userBalance.service','139356QgubMF','find','265679LBpnBY','530515GdAyYy','status','email','1284604CjxggY','object','decorate','every','super','HttpException','userBalanceService','使用卡密成功','name','affected','create','2rfDoWX','queryAllPackage','update','save','套餐名称或套餐等级重复、请检查！','删除卡密失败、请重试！','assign','function','CramiService','addBalanceToUser','createPackage','3388592dSsjem','delete','当前卡密不存在、请确认您要删除的卡密是否存在！','PACKAGE_GIFT','role','当前卡密已被使用、已使用的卡密禁止删除！','delPackage','../../common/constants/balance.constant','packageName','当前卡密不存在、请确认您输入的卡密是否正确！','HttpStatus','packageId','RechargeType','UserBalanceService','maskCrami','DESC','map','../../common/utils','CramiEntity','当前卡密已被使用、请确认您输入的卡密是否正确！','BAD_REQUEST','./cramiPackage.entity','code','maskEmail','Not','Repository','generateCramiCode','./crami.entity','error:\x20','LessThanOrEqual'];_0x5325=function(){return _0x274a33;};return _0x5325();}function _0x2612(_0x346292,_0x40bfe4){const _0x53250f=_0x5325();return _0x2612=function(_0x2612fc,_0x377c0f){_0x2612fc=_0x2612fc-0x14b;let _0x171157=_0x53250f[_0x2612fc];return _0x171157;},_0x2612(_0x346292,_0x40bfe4);}const _0x52b220=_0x2612;(function(_0x673b9e,_0x4a7ff8){const _0x27579b=_0x2612,_0x3c6f24=_0x673b9e();while(!![]){try{const _0x47ef1a=parseInt(_0x27579b(0x18f))/0x1*(-parseInt(_0x27579b(0x19e))/0x2)+-parseInt(_0x27579b(0x176))/0x3+parseInt(_0x27579b(0x193))/0x4+parseInt(_0x27579b(0x190))/0x5+-parseInt(_0x27579b(0x16f))/0x6*(-parseInt(_0x27579b(0x18d))/0x7)+-parseInt(_0x27579b(0x14d))/0x8+parseInt(_0x27579b(0x185))/0x9;if(_0x47ef1a===_0x4a7ff8)break;else _0x3c6f24['push'](_0x3c6f24['shift']());}catch(_0xdb412c){_0x3c6f24['push'](_0x3c6f24['shift']());}}}(_0x5325,0x6242a));var __decorate=this&&this['__decorate']||function(_0x4b05a9,_0x2865c6,_0x21655f,_0x1c940a){const _0x20527a=_0x2612;var _0x3d8f47=arguments[_0x20527a(0x172)],_0x4e5475=_0x3d8f47<0x3?_0x2865c6:_0x1c940a===null?_0x1c940a=Object[_0x20527a(0x171)](_0x2865c6,_0x21655f):_0x1c940a,_0x4e2ffd;if(typeof Reflect==='object'&&typeof Reflect[_0x20527a(0x195)]===_0x20527a(0x1a5))_0x4e5475=Reflect[_0x20527a(0x195)](_0x4b05a9,_0x2865c6,_0x21655f,_0x1c940a);else{for(var _0x148ae4=_0x4b05a9[_0x20527a(0x172)]-0x1;_0x148ae4>=0x0;_0x148ae4--)if(_0x4e2ffd=_0x4b05a9[_0x148ae4])_0x4e5475=(_0x3d8f47<0x3?_0x4e2ffd(_0x4e5475):_0x3d8f47>0x3?_0x4e2ffd(_0x2865c6,_0x21655f,_0x4e5475):_0x4e2ffd(_0x2865c6,_0x21655f))||_0x4e5475;}return _0x3d8f47>0x3&&_0x4e5475&&Object['defineProperty'](_0x2865c6,_0x21655f,_0x4e5475),_0x4e5475;},__metadata=this&&this['__metadata']||function(_0x31e3c4,_0x4bfc27){const _0x579f7b=_0x2612;if(typeof Reflect===_0x579f7b(0x194)&&typeof Reflect[_0x579f7b(0x18a)]===_0x579f7b(0x1a5))return Reflect[_0x579f7b(0x18a)](_0x31e3c4,_0x4bfc27);},__param=this&&this[_0x52b220(0x17b)]||function(_0x1f77c7,_0x175e3a){return function(_0x1c8aca,_0x4089da){_0x175e3a(_0x1c8aca,_0x4089da,_0x1f77c7);};};Object[_0x52b220(0x18b)](exports,_0x52b220(0x16c),{'value':!![]}),exports[_0x52b220(0x1a6)]=void 0x0;const common_1=require(_0x52b220(0x188)),crami_entity_1=require(_0x52b220(0x168)),typeorm_1=require(_0x52b220(0x170)),typeorm_2=require('typeorm'),cramiPackage_entity_1=require(_0x52b220(0x162)),utils_1=require(_0x52b220(0x15e)),user_entity_1=require(_0x52b220(0x17e)),userBalance_service_1=require(_0x52b220(0x18c)),balance_constant_1=require(_0x52b220(0x154));let CramiService=class CramiService{constructor(_0x41b620,_0x58eb26,_0x15807c,_0x5ce307){const _0x522079=_0x52b220;this[_0x522079(0x17c)]=_0x41b620,this['cramiPackageEntity']=_0x58eb26,this[_0x522079(0x174)]=_0x15807c,this[_0x522079(0x199)]=_0x5ce307;}async[_0x52b220(0x16d)](_0x2f1ea4){const _0x3b76cd=_0x52b220;return await this['cramiPackageEntity'][_0x3b76cd(0x16e)]({'where':{'id':_0x2f1ea4}});}async[_0x52b220(0x19f)](_0x2d3a30){const _0x17a6c9=_0x52b220;try{const {page:page=0x1,size:size=0xa,name:_0x3c501c,status:_0x443775,type:_0xa7310a}=_0x2d3a30,_0x5be2d9={};_0x3c501c&&Object['assign'](_0x5be2d9,{'name':(0x0,typeorm_2[_0x17a6c9(0x177)])('%'+_0x3c501c+'%')}),_0x443775&&Object[_0x17a6c9(0x1a4)](_0x5be2d9,{'status':_0x443775});_0xa7310a&&(_0xa7310a>0x0?Object[_0x17a6c9(0x1a4)](_0x5be2d9,{'days':(0x0,typeorm_2[_0x17a6c9(0x178)])(0x0)}):Object['assign'](_0x5be2d9,{'days':(0x0,typeorm_2[_0x17a6c9(0x16a)])(0x0)}));const [_0x19c425,_0x12e9f2]=await this[_0x17a6c9(0x173)][_0x17a6c9(0x189)]({'skip':(page-0x1)*size,'take':size,'where':_0x5be2d9,'order':{'order':_0x17a6c9(0x15c)}});return{'rows':_0x19c425,'count':_0x12e9f2};}catch(_0x3032d3){console[_0x17a6c9(0x17f)](_0x17a6c9(0x169),_0x3032d3);}}async[_0x52b220(0x14c)](_0x5831db){const _0x170a03=_0x52b220,{name:_0x57dd00,weight:_0x548c24}=_0x5831db,_0x31ce26=await this[_0x170a03(0x173)][_0x170a03(0x16e)]({'where':[{'name':_0x57dd00},{'weight':_0x548c24}]});if(_0x31ce26)throw new common_1[(_0x170a03(0x198))](_0x170a03(0x1a2),common_1[_0x170a03(0x157)][_0x170a03(0x161)]);try{return await this[_0x170a03(0x173)][_0x170a03(0x1a1)](_0x5831db);}catch(_0x58b770){console['log'](_0x170a03(0x169),_0x58b770);throw new common_1['HttpException'](_0x58b770,common_1[_0x170a03(0x157)][_0x170a03(0x161)]);}}async['updatePackage'](_0x1ba312){const _0x5d75df=_0x52b220,{id:_0x51822f,name:_0x32c3a0,weight:_0x25f659}=_0x1ba312,_0x3b26b8=await this[_0x5d75df(0x173)][_0x5d75df(0x16e)]({'where':{'id':_0x51822f}});if(!_0x3b26b8)throw new common_1[(_0x5d75df(0x198))](_0x5d75df(0x180),common_1['HttpStatus'][_0x5d75df(0x161)]);const _0x35208f=await this[_0x5d75df(0x173)]['count']({'where':[{'name':_0x32c3a0,'id':(0x0,typeorm_2[_0x5d75df(0x165)])(_0x51822f)},{'weight':_0x25f659,'id':(0x0,typeorm_2[_0x5d75df(0x165)])(_0x51822f)}]});if(_0x35208f)throw new common_1['HttpException']('套餐名称或套餐等级重复、请检查！',common_1[_0x5d75df(0x157)][_0x5d75df(0x161)]);const _0xc792df=await this[_0x5d75df(0x173)][_0x5d75df(0x1a0)]({'id':_0x51822f},_0x1ba312);if(_0xc792df[_0x5d75df(0x19c)]>0x0)return'更新套餐成功！';else throw new common_1[(_0x5d75df(0x198))]('更新套餐失败、请重试！',common_1['HttpStatus']['BAD_REQUEST']);}async[_0x52b220(0x153)](_0x3df167){const _0x3b052a=_0x52b220,{id:_0x470a73}=_0x3df167,_0x2b4684=await this[_0x3b052a(0x17c)]['count']({'where':{'packageId':_0x470a73}});if(_0x2b4684)throw new common_1[(_0x3b052a(0x198))]('当前套餐下存在卡密、请先删除卡密后才可删除套餐！',common_1['HttpStatus'][_0x3b052a(0x161)]);return await this[_0x3b052a(0x173)]['delete']({'id':_0x470a73});}async[_0x52b220(0x17a)](_0x307809){const _0x103cea=_0x52b220,{packageId:_0x5c101c,count:count=0x1}=_0x307809;if(_0x5c101c){const _0x1ca163=await this[_0x103cea(0x173)][_0x103cea(0x16e)]({'where':{'id':_0x5c101c}});if(!_0x1ca163)throw new common_1['HttpException']('当前套餐不存在、请确认您选择的套餐是否存在！',common_1[_0x103cea(0x157)][_0x103cea(0x161)]);const {days:days=-0x1,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x1ca163,_0x51d8df={'packageId':_0x5c101c,'days':days,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount};return await this[_0x103cea(0x181)](_0x51d8df,count);}if(!_0x5c101c){const {model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x307809;if([model3Count,model4Count,drawMjCount][_0x103cea(0x196)](_0x85a1a9=>!_0x85a1a9))throw new common_1[(_0x103cea(0x198))](_0x103cea(0x183),common_1[_0x103cea(0x157)]['BAD_REQUEST']);const _0x43e7d8={'days':-0x1,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount};return await this[_0x103cea(0x181)](_0x43e7d8,count);}}async['generateCrami'](_0x4d4f67,_0x5c63a2){const _0x1f7089=_0x52b220,_0x62704f=[];for(let _0x28cc33=0x0;_0x28cc33<_0x5c63a2;_0x28cc33++){const _0x192bc2=(0x0,utils_1[_0x1f7089(0x167)])(),_0x1e12ae=this[_0x1f7089(0x17c)][_0x1f7089(0x19d)](Object['assign'](Object[_0x1f7089(0x1a4)]({},_0x4d4f67),{'code':_0x192bc2}));_0x62704f['push'](_0x1e12ae);}return await this[_0x1f7089(0x17c)][_0x1f7089(0x1a1)](_0x62704f);}async['useCrami'](_0x540b26,_0x2cb3c4){const _0x4bf7b6=_0x52b220,{id:_0x4026fc}=_0x540b26[_0x4bf7b6(0x184)],_0x3ff9e4=await this[_0x4bf7b6(0x17c)][_0x4bf7b6(0x16e)]({'where':{'code':_0x2cb3c4[_0x4bf7b6(0x163)]}});if(!_0x3ff9e4)throw new common_1[(_0x4bf7b6(0x198))](_0x4bf7b6(0x156),common_1[_0x4bf7b6(0x157)][_0x4bf7b6(0x161)]);const {status:_0x21cc2a,days:days=-0x1,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0,packageId:_0x16065f}=_0x3ff9e4;if(_0x21cc2a===0x1)throw new common_1[(_0x4bf7b6(0x198))](_0x4bf7b6(0x160),common_1['HttpStatus'][_0x4bf7b6(0x161)]);const _0x4cd534={'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'packageId':_0x16065f};return await this[_0x4bf7b6(0x199)][_0x4bf7b6(0x14b)](_0x4026fc,Object['assign']({},_0x4cd534),days),await this[_0x4bf7b6(0x199)]['saveRecordRechargeLog']({'userId':_0x4026fc,'rechargeType':balance_constant_1[_0x4bf7b6(0x159)][_0x4bf7b6(0x150)],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'days':days}),await this[_0x4bf7b6(0x17c)]['update']({'code':_0x2cb3c4['code']},{'useId':_0x4026fc,'status':0x1}),_0x4bf7b6(0x19a);}async['queryAllCrami'](_0x261ad2,_0x416e39){const _0x19e7ea=_0x52b220,{page:page=0x1,size:size=0xa,status:_0x29eaed,useId:_0x17c062}=_0x261ad2,_0x2a8b1b={};_0x29eaed&&Object[_0x19e7ea(0x1a4)](_0x2a8b1b,{'status':_0x29eaed}),_0x17c062&&Object[_0x19e7ea(0x1a4)](_0x2a8b1b,{'useId':_0x17c062});const [_0x367346,_0x154e91]=await this['cramiEntity'][_0x19e7ea(0x189)]({'skip':(page-0x1)*size,'take':size,'order':{'createdAt':'DESC'},'where':_0x2a8b1b}),_0x1ab919=_0x367346[_0x19e7ea(0x15d)](_0x1df6f3=>_0x1df6f3[_0x19e7ea(0x187)]),_0x29106d=_0x367346[_0x19e7ea(0x15d)](_0x23a16d=>_0x23a16d[_0x19e7ea(0x158)]),_0x36ffc8=await this['userEntity'][_0x19e7ea(0x18e)]({'where':{'id':(0x0,typeorm_2['In'])(_0x1ab919)}}),_0xb9b412=await this['cramiPackageEntity'][_0x19e7ea(0x18e)]({'where':{'id':(0x0,typeorm_2['In'])(_0x29106d)}});return _0x367346[_0x19e7ea(0x179)](_0x516b6c=>{const _0x5c5a5a=_0x19e7ea;var _0x2f2c1d,_0x425165,_0x430135;_0x516b6c[_0x5c5a5a(0x182)]=(_0x2f2c1d=_0x36ffc8[_0x5c5a5a(0x18e)](_0x43657d=>_0x43657d['id']===_0x516b6c[_0x5c5a5a(0x187)]))===null||_0x2f2c1d===void 0x0?void 0x0:_0x2f2c1d[_0x5c5a5a(0x182)],_0x516b6c[_0x5c5a5a(0x192)]=(_0x425165=_0x36ffc8[_0x5c5a5a(0x18e)](_0x5d1926=>_0x5d1926['id']===_0x516b6c[_0x5c5a5a(0x187)]))===null||_0x425165===void 0x0?void 0x0:_0x425165[_0x5c5a5a(0x192)],_0x516b6c[_0x5c5a5a(0x155)]=(_0x430135=_0xb9b412[_0x5c5a5a(0x18e)](_0x1718c2=>_0x1718c2['id']===_0x516b6c[_0x5c5a5a(0x158)]))===null||_0x430135===void 0x0?void 0x0:_0x430135[_0x5c5a5a(0x19b)];}),_0x416e39[_0x19e7ea(0x184)][_0x19e7ea(0x151)]!==_0x19e7ea(0x197)&&_0x367346['forEach'](_0x4b8415=>_0x4b8415[_0x19e7ea(0x192)]=(0x0,utils_1[_0x19e7ea(0x164)])(_0x4b8415[_0x19e7ea(0x192)])),_0x416e39[_0x19e7ea(0x184)][_0x19e7ea(0x151)]!==_0x19e7ea(0x197)&&_0x367346[_0x19e7ea(0x179)](_0x4aba65=>_0x4aba65[_0x19e7ea(0x163)]=(0x0,utils_1[_0x19e7ea(0x15b)])(_0x4aba65[_0x19e7ea(0x163)])),{'rows':_0x367346,'count':_0x154e91};}async[_0x52b220(0x16b)](_0x2a8053){const _0x6fc720=_0x52b220,_0x37223b=await this[_0x6fc720(0x17c)][_0x6fc720(0x16e)]({'where':{'id':_0x2a8053}});if(!_0x37223b)throw new common_1[(_0x6fc720(0x198))](_0x6fc720(0x14f),common_1['HttpStatus'][_0x6fc720(0x161)]);if(_0x37223b[_0x6fc720(0x191)]===0x1)throw new common_1['HttpException'](_0x6fc720(0x152),common_1[_0x6fc720(0x157)][_0x6fc720(0x161)]);return await this[_0x6fc720(0x17c)][_0x6fc720(0x14e)]({'id':_0x2a8053});}async['batchDelCrami'](_0x1c0b31){const _0xad1d81=_0x52b220,{ids:_0x2d01f6}=_0x1c0b31,_0x1971ec=await this[_0xad1d81(0x17c)]['delete'](_0x2d01f6);if(_0x1971ec[_0xad1d81(0x19c)]>0x0)return'删除卡密成功！';else throw new common_1[(_0xad1d81(0x198))](_0xad1d81(0x1a3),common_1[_0xad1d81(0x157)]['BAD_REQUEST']);}};CramiService=__decorate([(0x0,common_1[_0x52b220(0x186)])(),__param(0x0,(0x0,typeorm_1[_0x52b220(0x17d)])(crami_entity_1[_0x52b220(0x15f)])),__param(0x1,(0x0,typeorm_1[_0x52b220(0x17d)])(cramiPackage_entity_1[_0x52b220(0x175)])),__param(0x2,(0x0,typeorm_1[_0x52b220(0x17d)])(user_entity_1['UserEntity'])),__metadata('design:paramtypes',[typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2[_0x52b220(0x166)],userBalance_service_1[_0x52b220(0x15a)]])],CramiService),exports[_0x52b220(0x1a6)]=CramiService;