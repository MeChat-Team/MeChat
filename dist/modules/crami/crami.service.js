'use strict';const _0x439e2e=_0x3a87;(function(_0x5ce515,_0x11a042){const _0x5f4a0e=_0x3a87,_0x54a87b=_0x5ce515();while(!![]){try{const _0x160c4b=-parseInt(_0x5f4a0e(0xcd))/0x1*(parseInt(_0x5f4a0e(0xca))/0x2)+-parseInt(_0x5f4a0e(0xea))/0x3*(parseInt(_0x5f4a0e(0x100))/0x4)+-parseInt(_0x5f4a0e(0xd8))/0x5*(-parseInt(_0x5f4a0e(0xf0))/0x6)+parseInt(_0x5f4a0e(0xcf))/0x7+-parseInt(_0x5f4a0e(0xe1))/0x8*(parseInt(_0x5f4a0e(0xd1))/0x9)+parseInt(_0x5f4a0e(0xbd))/0xa+parseInt(_0x5f4a0e(0x101))/0xb;if(_0x160c4b===_0x11a042)break;else _0x54a87b['push'](_0x54a87b['shift']());}catch(_0x154821){_0x54a87b['push'](_0x54a87b['shift']());}}}(_0x4d2b,0x1da35));function _0x3a87(_0x439555,_0x4e3c5a){const _0x4d2b9c=_0x4d2b();return _0x3a87=function(_0x3a87b9,_0x411340){_0x3a87b9=_0x3a87b9-0xbd;let _0x3b0bb2=_0x4d2b9c[_0x3a87b9];return _0x3b0bb2;},_0x3a87(_0x439555,_0x4e3c5a);}function _0x4d2b(){const _0x4931bd=['207ekKIFq','当前卡密不存在、请确认您输入的卡密是否正确！','code','object','user','更新套餐失败、请重试！','log','5HUWqia','cramiEntity','当前套餐不存在、请确认您选择的套餐是否存在！','__metadata','自定义卡密必须至少一项余额不为0️零！','generateCramiCode','packageId','CramiService','batchDelCrami','16472zbVSVQ','当前卡密已被使用、请确认您输入的卡密是否正确！','defineProperty','__decorate','assign','./crami.entity','queryAllCrami','username','PACKAGE_GIFT','33pHLiSH','__esModule','findOne','当前套餐不存在、请检查你的输入参数！','every','userBalanceService','389118PYKpAT','CramiEntity','../../common/constants/balance.constant','push','Repository','cramiPackageEntity','当前卡密已被使用、已使用的卡密禁止删除！','InjectRepository','LessThanOrEqual','当前卡密不存在、请确认您要删除的卡密是否存在！','find','generateCrami','Not','name','BAD_REQUEST','delPackage','6292GcyfRM','603328XhLdku','typeorm','HttpException','updatePackage','DESC','Like','role','更新套餐成功！','userEntity','length','function','套餐名称或套餐等级重复、请检查！','create','delete','../../common/utils','packageName','MoreThan','getOwnPropertyDescriptor','使用卡密成功','decorate','error:\x20','createCrami','queryOnePackage','CramiPackageEntity','useId','save','maskEmail','91710UClsoH','metadata','./cramiPackage.entity','@nestjs/typeorm','删除卡密失败、请重试！','email','Injectable','forEach','count','status','../userBalance/userBalance.service','super','update','1954JVNVpb','HttpStatus','createPackage','54zzSXxB','affected','769601APbUip','findAndCount'];_0x4d2b=function(){return _0x4931bd;};return _0x4d2b();}var __decorate=this&&this[_0x439e2e(0xe4)]||function(_0xe0194b,_0x248814,_0x1ab86a,_0x1e47d0){const _0xde3deb=_0x439e2e;var _0x4e6b4a=arguments[_0xde3deb(0x10a)],_0x5c4ab2=_0x4e6b4a<0x3?_0x248814:_0x1e47d0===null?_0x1e47d0=Object[_0xde3deb(0x112)](_0x248814,_0x1ab86a):_0x1e47d0,_0x1c0435;if(typeof Reflect===_0xde3deb(0xd4)&&typeof Reflect[_0xde3deb(0x114)]===_0xde3deb(0x10b))_0x5c4ab2=Reflect[_0xde3deb(0x114)](_0xe0194b,_0x248814,_0x1ab86a,_0x1e47d0);else{for(var _0x5b187e=_0xe0194b[_0xde3deb(0x10a)]-0x1;_0x5b187e>=0x0;_0x5b187e--)if(_0x1c0435=_0xe0194b[_0x5b187e])_0x5c4ab2=(_0x4e6b4a<0x3?_0x1c0435(_0x5c4ab2):_0x4e6b4a>0x3?_0x1c0435(_0x248814,_0x1ab86a,_0x5c4ab2):_0x1c0435(_0x248814,_0x1ab86a))||_0x5c4ab2;}return _0x4e6b4a>0x3&&_0x5c4ab2&&Object[_0xde3deb(0xe3)](_0x248814,_0x1ab86a,_0x5c4ab2),_0x5c4ab2;},__metadata=this&&this[_0x439e2e(0xdb)]||function(_0x2a35b5,_0x4b1dfe){const _0x1cbbcc=_0x439e2e;if(typeof Reflect===_0x1cbbcc(0xd4)&&typeof Reflect[_0x1cbbcc(0xbe)]===_0x1cbbcc(0x10b))return Reflect[_0x1cbbcc(0xbe)](_0x2a35b5,_0x4b1dfe);},__param=this&&this['__param']||function(_0xf0e0d2,_0x5b6645){return function(_0x3205fd,_0x4d2883){_0x5b6645(_0x3205fd,_0x4d2883,_0xf0e0d2);};};Object['defineProperty'](exports,_0x439e2e(0xeb),{'value':!![]}),exports['CramiService']=void 0x0;const common_1=require('@nestjs/common'),crami_entity_1=require(_0x439e2e(0xe6)),typeorm_1=require(_0x439e2e(0xc0)),typeorm_2=require(_0x439e2e(0x102)),cramiPackage_entity_1=require(_0x439e2e(0xbf)),utils_1=require(_0x439e2e(0x10f)),user_entity_1=require('../user/user.entity'),userBalance_service_1=require(_0x439e2e(0xc7)),balance_constant_1=require(_0x439e2e(0xf2));let CramiService=class CramiService{constructor(_0x4b2aac,_0x3475bc,_0xf6e926,_0x235525){const _0x4a1d49=_0x439e2e;this['cramiEntity']=_0x4b2aac,this[_0x4a1d49(0xf5)]=_0x3475bc,this[_0x4a1d49(0x109)]=_0xf6e926,this[_0x4a1d49(0xef)]=_0x235525;}async[_0x439e2e(0x117)](_0x5c5116){const _0x7c7d38=_0x439e2e;return await this[_0x7c7d38(0xf5)][_0x7c7d38(0xec)]({'where':{'id':_0x5c5116}});}async['queryAllPackage'](_0x48cf01){const _0x1d2f45=_0x439e2e;try{const {page:page=0x1,size:size=0xa,name:_0xf51431,status:_0x2b741d,type:_0xd64bfa}=_0x48cf01,_0x5e59d3={};_0xf51431&&Object[_0x1d2f45(0xe5)](_0x5e59d3,{'name':(0x0,typeorm_2[_0x1d2f45(0x106)])('%'+_0xf51431+'%')}),_0x2b741d&&Object[_0x1d2f45(0xe5)](_0x5e59d3,{'status':_0x2b741d});_0xd64bfa&&(_0xd64bfa>0x0?Object['assign'](_0x5e59d3,{'days':(0x0,typeorm_2[_0x1d2f45(0x111)])(0x0)}):Object[_0x1d2f45(0xe5)](_0x5e59d3,{'days':(0x0,typeorm_2[_0x1d2f45(0xf8)])(0x0)}));const [_0x16113d,_0x2b1009]=await this['cramiPackageEntity']['findAndCount']({'skip':(page-0x1)*size,'take':size,'where':_0x5e59d3,'order':{'order':_0x1d2f45(0x105)}});return{'rows':_0x16113d,'count':_0x2b1009};}catch(_0x511f8b){console[_0x1d2f45(0xd7)](_0x1d2f45(0x115),_0x511f8b);}}async[_0x439e2e(0xcc)](_0x5c32a5){const _0x280ae7=_0x439e2e,{name:_0x1d73b5,weight:_0x30b28f}=_0x5c32a5,_0x13842d=await this['cramiPackageEntity']['findOne']({'where':[{'name':_0x1d73b5},{'weight':_0x30b28f}]});if(_0x13842d)throw new common_1[(_0x280ae7(0x103))](_0x280ae7(0x10c),common_1[_0x280ae7(0xcb)]['BAD_REQUEST']);try{return await this['cramiPackageEntity'][_0x280ae7(0x11a)](_0x5c32a5);}catch(_0x3733b4){console[_0x280ae7(0xd7)](_0x280ae7(0x115),_0x3733b4);throw new common_1[(_0x280ae7(0x103))](_0x3733b4,common_1[_0x280ae7(0xcb)][_0x280ae7(0xfe)]);}}async[_0x439e2e(0x104)](_0x1ddae2){const _0x492697=_0x439e2e,{id:_0x11e945,name:_0x57a4a8,weight:_0x172bc9}=_0x1ddae2,_0x33e00c=await this['cramiPackageEntity'][_0x492697(0xec)]({'where':{'id':_0x11e945}});if(!_0x33e00c)throw new common_1[(_0x492697(0x103))](_0x492697(0xed),common_1[_0x492697(0xcb)]['BAD_REQUEST']);const _0x18f747=await this[_0x492697(0xf5)][_0x492697(0xc5)]({'where':[{'name':_0x57a4a8,'id':(0x0,typeorm_2[_0x492697(0xfc)])(_0x11e945)},{'weight':_0x172bc9,'id':(0x0,typeorm_2[_0x492697(0xfc)])(_0x11e945)}]});if(_0x18f747)throw new common_1[(_0x492697(0x103))](_0x492697(0x10c),common_1[_0x492697(0xcb)]['BAD_REQUEST']);const _0x2d4e20=await this[_0x492697(0xf5)][_0x492697(0xc9)]({'id':_0x11e945},_0x1ddae2);if(_0x2d4e20[_0x492697(0xce)]>0x0)return _0x492697(0x108);else throw new common_1[(_0x492697(0x103))](_0x492697(0xd6),common_1['HttpStatus'][_0x492697(0xfe)]);}async[_0x439e2e(0xff)](_0x4609df){const _0xcf2cd4=_0x439e2e,{id:_0x4f3a3e}=_0x4609df,_0x584282=await this[_0xcf2cd4(0xd9)]['count']({'where':{'packageId':_0x4f3a3e}});if(_0x584282)throw new common_1['HttpException']('当前套餐下存在卡密、请先删除卡密后才可删除套餐！',common_1['HttpStatus'][_0xcf2cd4(0xfe)]);return await this[_0xcf2cd4(0xf5)][_0xcf2cd4(0x10e)]({'id':_0x4f3a3e});}async[_0x439e2e(0x116)](_0x545e70){const _0xc1cc90=_0x439e2e,{packageId:_0x3a9011,count:count=0x1}=_0x545e70;if(_0x3a9011){const _0x3a6d76=await this[_0xc1cc90(0xf5)]['findOne']({'where':{'id':_0x3a9011}});if(!_0x3a6d76)throw new common_1['HttpException'](_0xc1cc90(0xda),common_1['HttpStatus'][_0xc1cc90(0xfe)]);const {days:days=-0x1,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x3a6d76,_0x264c87={'packageId':_0x3a9011,'days':days,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount};return await this[_0xc1cc90(0xfb)](_0x264c87,count);}if(!_0x3a9011){const {model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x545e70;if([model3Count,model4Count,drawMjCount][_0xc1cc90(0xee)](_0x792d15=>!_0x792d15))throw new common_1[(_0xc1cc90(0x103))](_0xc1cc90(0xdc),common_1[_0xc1cc90(0xcb)]['BAD_REQUEST']);const _0x1fcc1a={'days':-0x1,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount};return await this[_0xc1cc90(0xfb)](_0x1fcc1a,count);}}async['generateCrami'](_0x121ddd,_0x3a26f1){const _0x70d778=_0x439e2e,_0x237c33=[];for(let _0x589db0=0x0;_0x589db0<_0x3a26f1;_0x589db0++){const _0x3ea52c=(0x0,utils_1[_0x70d778(0xdd)])(),_0x3e2bf9=this[_0x70d778(0xd9)][_0x70d778(0x10d)](Object['assign'](Object[_0x70d778(0xe5)]({},_0x121ddd),{'code':_0x3ea52c}));_0x237c33[_0x70d778(0xf3)](_0x3e2bf9);}return await this[_0x70d778(0xd9)][_0x70d778(0x11a)](_0x237c33);}async['useCrami'](_0x30593b,_0x368b52){const _0x569270=_0x439e2e,{id:_0x417c89}=_0x30593b[_0x569270(0xd5)],_0x28aaf4=await this[_0x569270(0xd9)][_0x569270(0xec)]({'where':{'code':_0x368b52[_0x569270(0xd3)]}});if(!_0x28aaf4)throw new common_1[(_0x569270(0x103))](_0x569270(0xd2),common_1['HttpStatus'][_0x569270(0xfe)]);const {status:_0xb49432,days:days=-0x1,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0,packageId:_0x24e708}=_0x28aaf4;if(_0xb49432===0x1)throw new common_1['HttpException'](_0x569270(0xe2),common_1[_0x569270(0xcb)][_0x569270(0xfe)]);const _0xcb2d8c={'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'packageId':_0x24e708};return await this[_0x569270(0xef)]['addBalanceToUser'](_0x417c89,Object[_0x569270(0xe5)]({},_0xcb2d8c),days),await this['userBalanceService']['saveRecordRechargeLog']({'userId':_0x417c89,'rechargeType':balance_constant_1['RechargeType'][_0x569270(0xe9)],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'days':days}),await this[_0x569270(0xd9)]['update']({'code':_0x368b52['code']},{'useId':_0x417c89,'status':0x1}),_0x569270(0x113);}async[_0x439e2e(0xe7)](_0x3c9e2c,_0x272115){const _0x54decc=_0x439e2e,{page:page=0x1,size:size=0xa,status:_0xc61a2d,useId:_0x4fc4c4}=_0x3c9e2c,_0x2d387f={};_0xc61a2d&&Object[_0x54decc(0xe5)](_0x2d387f,{'status':_0xc61a2d}),_0x4fc4c4&&Object['assign'](_0x2d387f,{'useId':_0x4fc4c4});const [_0x5d140d,_0xe9a16]=await this['cramiEntity'][_0x54decc(0xd0)]({'skip':(page-0x1)*size,'take':size,'order':{'createdAt':'DESC'},'where':_0x2d387f}),_0x3db1c9=_0x5d140d['map'](_0x377fb4=>_0x377fb4['useId']),_0x485690=_0x5d140d['map'](_0x4d7215=>_0x4d7215[_0x54decc(0xde)]),_0x51fa9c=await this[_0x54decc(0x109)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x3db1c9)}}),_0x13a87e=await this['cramiPackageEntity'][_0x54decc(0xfa)]({'where':{'id':(0x0,typeorm_2['In'])(_0x485690)}});return _0x5d140d['forEach'](_0x2ee334=>{const _0x337847=_0x54decc;var _0x5f44cc,_0x23418,_0x387738;_0x2ee334['username']=(_0x5f44cc=_0x51fa9c[_0x337847(0xfa)](_0x3ee851=>_0x3ee851['id']===_0x2ee334[_0x337847(0x119)]))===null||_0x5f44cc===void 0x0?void 0x0:_0x5f44cc[_0x337847(0xe8)],_0x2ee334[_0x337847(0xc2)]=(_0x23418=_0x51fa9c['find'](_0xb06f34=>_0xb06f34['id']===_0x2ee334[_0x337847(0x119)]))===null||_0x23418===void 0x0?void 0x0:_0x23418['email'],_0x2ee334[_0x337847(0x110)]=(_0x387738=_0x13a87e[_0x337847(0xfa)](_0xec254=>_0xec254['id']===_0x2ee334[_0x337847(0xde)]))===null||_0x387738===void 0x0?void 0x0:_0x387738[_0x337847(0xfd)];}),_0x272115[_0x54decc(0xd5)][_0x54decc(0x107)]!=='super'&&_0x5d140d[_0x54decc(0xc4)](_0x5207ca=>_0x5207ca[_0x54decc(0xc2)]=(0x0,utils_1[_0x54decc(0x11b)])(_0x5207ca['email'])),_0x272115['user'][_0x54decc(0x107)]!==_0x54decc(0xc8)&&_0x5d140d[_0x54decc(0xc4)](_0x5c7ba1=>_0x5c7ba1[_0x54decc(0xd3)]=(0x0,utils_1['maskCrami'])(_0x5c7ba1[_0x54decc(0xd3)])),{'rows':_0x5d140d,'count':_0xe9a16};}async['delCrami'](_0x1381f7){const _0x45ef81=_0x439e2e,_0x4eb69b=await this[_0x45ef81(0xd9)]['findOne']({'where':{'id':_0x1381f7}});if(!_0x4eb69b)throw new common_1[(_0x45ef81(0x103))](_0x45ef81(0xf9),common_1[_0x45ef81(0xcb)]['BAD_REQUEST']);if(_0x4eb69b[_0x45ef81(0xc6)]===0x1)throw new common_1['HttpException'](_0x45ef81(0xf6),common_1[_0x45ef81(0xcb)]['BAD_REQUEST']);return await this['cramiEntity'][_0x45ef81(0x10e)]({'id':_0x1381f7});}async[_0x439e2e(0xe0)](_0x36e1e3){const _0xb6b8d3=_0x439e2e,{ids:_0x191e8c}=_0x36e1e3,_0x1bcd89=await this[_0xb6b8d3(0xd9)]['delete'](_0x191e8c);if(_0x1bcd89['affected']>0x0)return'删除卡密成功！';else throw new common_1[(_0xb6b8d3(0x103))](_0xb6b8d3(0xc1),common_1[_0xb6b8d3(0xcb)]['BAD_REQUEST']);}};CramiService=__decorate([(0x0,common_1[_0x439e2e(0xc3)])(),__param(0x0,(0x0,typeorm_1[_0x439e2e(0xf7)])(crami_entity_1[_0x439e2e(0xf1)])),__param(0x1,(0x0,typeorm_1[_0x439e2e(0xf7)])(cramiPackage_entity_1[_0x439e2e(0x118)])),__param(0x2,(0x0,typeorm_1[_0x439e2e(0xf7)])(user_entity_1['UserEntity'])),__metadata('design:paramtypes',[typeorm_2[_0x439e2e(0xf4)],typeorm_2[_0x439e2e(0xf4)],typeorm_2['Repository'],userBalance_service_1['UserBalanceService']])],CramiService),exports[_0x439e2e(0xdf)]=CramiService;