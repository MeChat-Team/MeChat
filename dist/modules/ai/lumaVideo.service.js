'use strict';function _0x65a0(){const _0x227dbc=['getConfigs','padStart','LumaService','video/luma/','更新日志失败:\x20','completed','GlobalConfigService','轮询过程中发生错误:\x20','uploadFileFromUrl','任务提交失败:\x20','taskId','pollLumaVideoResult','135242IvMAfz','design:paramtypes','未能获取结果数据,\x20即将重试','__esModule','查询生成结果时发生错误:','audioUrl','length','9vWjvtW','任务提交失败','stringify','2287432CnvfSd','Lum\x20aService','__metadata','任务提交成功,\x20任务ID:\x20','../globalConfig/globalConfig.service','查询超时，请稍后再试！','3540258xmiSfG','decorate','size','localStorageStatus','__decorate','正在准备发送请求到\x20','log','../upload/upload.service','轮询超时，请稍后再试！','floor','UploadService','message','getDate','error','axios','，payload:\x20','default','Bearer\x20','44LwrgpF','now','function','data','轮询失败，重试次数:\x20','uploadService','object','download_url','LumaVideoService','Injectable','1890189WAxUqJ','16:9','chatLogService','14pFKNzg','视频任务已完成','taskData','/luma/generations/','videoUrl','../chatLog/chatLog.service','updateChatLog','answer','视频生成中...','progress','Logger','100%','globalConfigService','视频生成中\x20（','state','轮询结果:\x20','177925flONfq','getOwnPropertyDescriptor','status','ChatLogService','defineProperty','getMonth','video','getFullYear','fileInfo','上传文件失败:\x20','metadata','40PUuNJW','url','2416640aUOKzR','7HlXWnO','8524212DOHUPZ'];_0x65a0=function(){return _0x227dbc;};return _0x65a0();}function _0x5c2a(_0x4b7f98,_0x57fcb7){const _0x65a0b3=_0x65a0();return _0x5c2a=function(_0x5c2ad5,_0x2158e7){_0x5c2ad5=_0x5c2ad5-0x84;let _0x15ec20=_0x65a0b3[_0x5c2ad5];return _0x15ec20;},_0x5c2a(_0x4b7f98,_0x57fcb7);}const _0x3a6ad2=_0x5c2a;(function(_0x403480,_0x2f4794){const _0x2a6762=_0x5c2a,_0x529b49=_0x403480();while(!![]){try{const _0x250a83=parseInt(_0x2a6762(0xaa))/0x1*(parseInt(_0x2a6762(0xd6))/0x2)+-parseInt(_0x2a6762(0xa7))/0x3+-parseInt(_0x2a6762(0xc5))/0x4*(parseInt(_0x2a6762(0xba))/0x5)+-parseInt(_0x2a6762(0x8b))/0x6*(-parseInt(_0x2a6762(0xc8))/0x7)+parseInt(_0x2a6762(0x85))/0x8*(-parseInt(_0x2a6762(0xdd))/0x9)+-parseInt(_0x2a6762(0xc7))/0xa*(-parseInt(_0x2a6762(0x9d))/0xb)+-parseInt(_0x2a6762(0xc9))/0xc;if(_0x250a83===_0x2f4794)break;else _0x529b49['push'](_0x529b49['shift']());}catch(_0x5b3327){_0x529b49['push'](_0x529b49['shift']());}}}(_0x65a0,0x7f3f0));var __decorate=this&&this[_0x3a6ad2(0x8f)]||function(_0x36dffa,_0x43f611,_0x54af94,_0x5160ee){const _0x17b38c=_0x3a6ad2;var _0x3c4040=arguments[_0x17b38c(0xdc)],_0x5a1f01=_0x3c4040<0x3?_0x43f611:_0x5160ee===null?_0x5160ee=Object[_0x17b38c(0xbb)](_0x43f611,_0x54af94):_0x5160ee,_0x7df82d;if(typeof Reflect===_0x17b38c(0xa3)&&typeof Reflect[_0x17b38c(0x8c)]===_0x17b38c(0x9f))_0x5a1f01=Reflect[_0x17b38c(0x8c)](_0x36dffa,_0x43f611,_0x54af94,_0x5160ee);else{for(var _0x147cb3=_0x36dffa[_0x17b38c(0xdc)]-0x1;_0x147cb3>=0x0;_0x147cb3--)if(_0x7df82d=_0x36dffa[_0x147cb3])_0x5a1f01=(_0x3c4040<0x3?_0x7df82d(_0x5a1f01):_0x3c4040>0x3?_0x7df82d(_0x43f611,_0x54af94,_0x5a1f01):_0x7df82d(_0x43f611,_0x54af94))||_0x5a1f01;}return _0x3c4040>0x3&&_0x5a1f01&&Object[_0x17b38c(0xbe)](_0x43f611,_0x54af94,_0x5a1f01),_0x5a1f01;},__metadata=this&&this[_0x3a6ad2(0x87)]||function(_0x4f877e,_0x369564){const _0x3fa453=_0x3a6ad2;if(typeof Reflect===_0x3fa453(0xa3)&&typeof Reflect[_0x3fa453(0xc4)]===_0x3fa453(0x9f))return Reflect[_0x3fa453(0xc4)](_0x4f877e,_0x369564);};Object[_0x3a6ad2(0xbe)](exports,_0x3a6ad2(0xd9),{'value':!![]}),exports[_0x3a6ad2(0xa5)]=void 0x0;const common_1=require('@nestjs/common'),axios_1=require(_0x3a6ad2(0x99)),chatLog_service_1=require(_0x3a6ad2(0xaf)),globalConfig_service_1=require(_0x3a6ad2(0x89)),upload_service_1=require(_0x3a6ad2(0x92));let LumaVideoService=class LumaVideoService{constructor(_0x542883,_0x3530bf,_0xcd2d8a){const _0x45293a=_0x3a6ad2;this[_0x45293a(0xa9)]=_0x542883,this[_0x45293a(0xb6)]=_0x3530bf,this[_0x45293a(0xa2)]=_0xcd2d8a;}async['lumaVideo'](_0x1b2c04){const _0x3f13ee=_0x3a6ad2;var _0x384268,_0x461583,_0xc98598;const {apiKey:_0x2880c2,proxyUrl:_0x2d90d2,fileInfo:_0x3efc15,prompt:_0x553b06,timeout:_0xdfed1c,assistantLogId:_0x1b1661,extraParam:_0x4bca79}=_0x1b2c04;let _0x46e6c2={'text':'','fileInfo':'','taskId':'','taskData':'','status':0x2},_0x12fa02=null,_0x52eca3='',_0x498487={};const _0x3686d0={'Authorization':_0x3f13ee(0x9c)+_0x2880c2};_0x52eca3=_0x2d90d2+_0x3f13ee(0xad);const _0x2f5b34=_0x4bca79[_0x3f13ee(0x8d)]||_0x3f13ee(0xa8);_0x498487={'user_prompt':_0x553b06,'aspect_ratio':_0x2f5b34,'expand_prompt':!![]};_0x3efc15&&(_0x498487['image_url']=_0x3efc15);common_1[_0x3f13ee(0xb4)][_0x3f13ee(0x91)](_0x3f13ee(0x90)+_0x52eca3+_0x3f13ee(0x9a)+JSON['stringify'](_0x498487)+',\x20headers:\x20'+JSON[_0x3f13ee(0x84)](_0x3686d0),_0x3f13ee(0xcc));try{_0x12fa02=await axios_1[_0x3f13ee(0x9b)]['post'](_0x52eca3,_0x498487,{'headers':_0x3686d0});}catch(_0x25626d){common_1['Logger'][_0x3f13ee(0x98)](_0x3f13ee(0xd3)+_0x25626d[_0x3f13ee(0x96)],_0x3f13ee(0xcc));throw new Error(_0x3f13ee(0xde));}if((_0x384268=_0x12fa02===null||_0x12fa02===void 0x0?void 0x0:_0x12fa02['data'])===null||_0x384268===void 0x0?void 0x0:_0x384268['id'])_0x46e6c2[_0x3f13ee(0xd4)]=(_0x461583=_0x12fa02===null||_0x12fa02===void 0x0?void 0x0:_0x12fa02[_0x3f13ee(0xa0)])===null||_0x461583===void 0x0?void 0x0:_0x461583['id'],common_1['Logger'][_0x3f13ee(0x91)](_0x3f13ee(0x88)+((_0xc98598=_0x12fa02===null||_0x12fa02===void 0x0?void 0x0:_0x12fa02[_0x3f13ee(0xa0)])===null||_0xc98598===void 0x0?void 0x0:_0xc98598['id']),_0x3f13ee(0xcc));else throw new Error(_0x3f13ee(0xd8));try{await this[_0x3f13ee(0xd5)]({'proxyUrl':_0x2d90d2,'apiKey':_0x2880c2,'taskId':_0x12fa02[_0x3f13ee(0xa0)]['id'],'timeout':_0xdfed1c,'prompt':_0x553b06,'onSuccess':async _0x2e81a3=>{const _0x3781bd=_0x3f13ee;try{await this['chatLogService']['updateChatLog'](_0x1b1661,{'videoUrl':_0x2e81a3===null||_0x2e81a3===void 0x0?void 0x0:_0x2e81a3[_0x3781bd(0xae)],'audioUrl':_0x2e81a3===null||_0x2e81a3===void 0x0?void 0x0:_0x2e81a3[_0x3781bd(0xdb)],'fileInfo':_0x2e81a3===null||_0x2e81a3===void 0x0?void 0x0:_0x2e81a3[_0x3781bd(0xc2)],'answer':(_0x2e81a3===null||_0x2e81a3===void 0x0?void 0x0:_0x2e81a3[_0x3781bd(0xb1)])||_0x553b06,'progress':_0x3781bd(0xb5),'status':0x3,'taskId':_0x2e81a3===null||_0x2e81a3===void 0x0?void 0x0:_0x2e81a3[_0x3781bd(0xd4)],'taskData':_0x2e81a3===null||_0x2e81a3===void 0x0?void 0x0:_0x2e81a3[_0x3781bd(0xac)]}),common_1[_0x3781bd(0xb4)][_0x3781bd(0x91)](_0x3781bd(0xab),_0x3781bd(0xcc));}catch(_0x5e7686){common_1[_0x3781bd(0xb4)][_0x3781bd(0x98)](_0x3781bd(0xce)+_0x5e7686['message'],_0x3781bd(0xcc));}},'onGenerating':async _0x3a7682=>{const _0x57ab3c=_0x3f13ee;try{await this[_0x57ab3c(0xa9)][_0x57ab3c(0xb0)](_0x1b1661,{'videoUrl':_0x3a7682===null||_0x3a7682===void 0x0?void 0x0:_0x3a7682[_0x57ab3c(0xae)],'audioUrl':_0x3a7682===null||_0x3a7682===void 0x0?void 0x0:_0x3a7682[_0x57ab3c(0xdb)],'fileInfo':_0x3a7682===null||_0x3a7682===void 0x0?void 0x0:_0x3a7682[_0x57ab3c(0xc2)],'answer':(_0x3a7682===null||_0x3a7682===void 0x0?void 0x0:_0x3a7682[_0x57ab3c(0xb1)])||_0x57ab3c(0xb2),'progress':_0x3a7682===null||_0x3a7682===void 0x0?void 0x0:_0x3a7682[_0x57ab3c(0xb3)],'status':_0x3a7682[_0x57ab3c(0xbc)]}),common_1['Logger'][_0x57ab3c(0x91)]('视频生成中...',_0x57ab3c(0xcc));}catch(_0x3d5288){common_1[_0x57ab3c(0xb4)]['error'](_0x57ab3c(0xce)+_0x3d5288[_0x57ab3c(0x96)],_0x57ab3c(0xcc));}},'onFailure':async _0x35609e=>{const _0x2b7b2e=_0x3f13ee;try{await this[_0x2b7b2e(0xa9)][_0x2b7b2e(0xb0)](_0x1b1661,{'answer':'视频生成失败','status':_0x35609e[_0x2b7b2e(0xbc)]}),common_1[_0x2b7b2e(0xb4)][_0x2b7b2e(0x91)]('生成失败',_0x2b7b2e(0x86));}catch(_0xb9d6f){common_1['Logger'][_0x2b7b2e(0x98)]('更新日志失败:\x20'+_0xb9d6f[_0x2b7b2e(0x96)],_0x2b7b2e(0xcc));}}});}catch(_0x368965){common_1[_0x3f13ee(0xb4)][_0x3f13ee(0x98)](_0x3f13ee(0xda),_0x368965[_0x3f13ee(0x96)],_0x3f13ee(0xcc));throw new Error('查询生成结果时发生错误');}return _0x46e6c2;}async[_0x3a6ad2(0xd5)](_0x1f11d8){const _0x1ac101=_0x3a6ad2,{proxyUrl:_0x52dd35,apiKey:_0x3641a1,taskId:_0x23410f,timeout:_0x46293e,onSuccess:_0x27ef18,onFailure:_0xe5064e,onGenerating:_0x4bdfba,action:_0x2f95f4}=_0x1f11d8;let _0x4eba37={'videoUrl':'','audioUrl':'','fileInfo':'','drawId':'','taskData':'','status':0x2,'progress':0x0,'answer':''};const _0x4ffe17={'Authorization':'Bearer\x20'+_0x3641a1},_0x2122b5=_0x52dd35+_0x1ac101(0xad)+_0x23410f,_0x1ad59f=Date[_0x1ac101(0x9e)](),_0x4d283b=0x493e0,_0x1488b6=0x1388;let _0x2d3253=0x0;try{while(Date['now']()-_0x1ad59f<_0x46293e){await new Promise(_0x38727c=>setTimeout(_0x38727c,_0x1488b6));try{const _0x304e5e=await axios_1[_0x1ac101(0x9b)]['get'](_0x2122b5,{'headers':_0x4ffe17}),_0x4c3f38=setInterval(()=>{const _0xbed1c2=_0x1ac101,_0x48d7a0=Date['now']()-_0x1ad59f;let _0x823abd=Math[_0xbed1c2(0x94)](_0x48d7a0/_0x4d283b*0x64);if(_0x823abd>=0x63)_0x823abd=0x63;_0x4eba37[_0xbed1c2(0xb1)]=_0xbed1c2(0xb7)+_0x823abd+'%）';},0x3e8),_0x3e9e20=_0x304e5e[_0x1ac101(0xa0)];common_1[_0x1ac101(0xb4)]['debug'](_0x1ac101(0xb9)+JSON['stringify'](_0x3e9e20),_0x1ac101(0xcc));if(_0x3e9e20[_0x1ac101(0xb8)]===_0x1ac101(0xcf)){_0x4eba37[_0x1ac101(0xd4)]=_0x3e9e20['id'],_0x4eba37[_0x1ac101(0xac)]=JSON[_0x1ac101(0x84)](_0x3e9e20),_0x4eba37[_0x1ac101(0xc2)]=_0x3e9e20[_0x1ac101(0xc0)][_0x1ac101(0xc6)];try{const _0x1d30ef=await this[_0x1ac101(0xb6)][_0x1ac101(0xca)]([_0x1ac101(0x8e)]);if(Number(_0x1d30ef)){const _0x47ea29=new Date(),_0x4717d7=_0x47ea29[_0x1ac101(0xc1)](),_0x56eaa2=String(_0x47ea29[_0x1ac101(0xbf)]()+0x1)[_0x1ac101(0xcb)](0x2,'0'),_0x92d300=String(_0x47ea29[_0x1ac101(0x97)]())['padStart'](0x2,'0'),_0x38b364=''+_0x4717d7+_0x56eaa2+'/'+_0x92d300;_0x4eba37[_0x1ac101(0xc2)]=await this['uploadService'][_0x1ac101(0xd2)]({'url':_0x3e9e20[_0x1ac101(0xc0)][_0x1ac101(0xa4)],'dir':_0x1ac101(0xcd)+_0x38b364});}}catch(_0x4f1bd1){common_1[_0x1ac101(0xb4)][_0x1ac101(0x98)](_0x1ac101(0xc3)+_0x4f1bd1['message'],'LumaService');}_0x4eba37['answer']='提示词:\x20\x22'+_0x3e9e20['prompt']+'\x22',_0x27ef18(_0x4eba37),clearInterval(_0x4c3f38);return;}else _0x4bdfba(_0x4eba37);if(_0x4eba37[_0x1ac101(0xb3)]){}}catch(_0x479d6c){_0x2d3253++,common_1[_0x1ac101(0xb4)][_0x1ac101(0x98)](_0x1ac101(0xa1)+_0x2d3253,_0x1ac101(0xcc));}}common_1[_0x1ac101(0xb4)][_0x1ac101(0x98)](_0x1ac101(0x93),_0x1ac101(0xcc)),_0x4eba37['status']=0x4,_0xe5064e(_0x4eba37);throw new Error(_0x1ac101(0x8a));}catch(_0x56f285){common_1[_0x1ac101(0xb4)][_0x1ac101(0x98)](_0x1ac101(0xd1)+_0x56f285,_0x1ac101(0xcc)),_0x4eba37[_0x1ac101(0xbc)]=0x5,_0xe5064e(_0x4eba37);}}};LumaVideoService=__decorate([(0x0,common_1[_0x3a6ad2(0xa6)])(),__metadata(_0x3a6ad2(0xd7),[chatLog_service_1[_0x3a6ad2(0xbd)],globalConfig_service_1[_0x3a6ad2(0xd0)],upload_service_1[_0x3a6ad2(0x95)]])],LumaVideoService),exports[_0x3a6ad2(0xa5)]=LumaVideoService;