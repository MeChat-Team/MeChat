'use strict';function _0x3358(_0x217c5c,_0x209f88){const _0x177008=_0x1770();return _0x3358=function(_0x33581a,_0x5d8dcf){_0x33581a=_0x33581a-0xab;let _0x1a8566=_0x177008[_0x33581a];return _0x1a8566;},_0x3358(_0x217c5c,_0x209f88);}const _0x3a4249=_0x3358;(function(_0x188716,_0x3ecbe6){const _0x1fe746=_0x3358,_0x1ff130=_0x188716();while(!![]){try{const _0x1bc967=parseInt(_0x1fe746(0xce))/0x1*(parseInt(_0x1fe746(0xd6))/0x2)+-parseInt(_0x1fe746(0xc3))/0x3+parseInt(_0x1fe746(0xc4))/0x4+-parseInt(_0x1fe746(0xd2))/0x5*(parseInt(_0x1fe746(0xf8))/0x6)+parseInt(_0x1fe746(0xc9))/0x7+-parseInt(_0x1fe746(0xc2))/0x8*(parseInt(_0x1fe746(0xae))/0x9)+parseInt(_0x1fe746(0xd3))/0xa;if(_0x1bc967===_0x3ecbe6)break;else _0x1ff130['push'](_0x1ff130['shift']());}catch(_0x3a9df7){_0x1ff130['push'](_0x1ff130['shift']());}}}(_0x1770,0xd8ce4));var __decorate=this&&this[_0x3a4249(0xd5)]||function(_0x358707,_0x44a781,_0x5797e4,_0x3f17e0){const _0x1438fc=_0x3a4249;var _0x4e5e3a=arguments[_0x1438fc(0xf4)],_0x43ae85=_0x4e5e3a<0x3?_0x44a781:_0x3f17e0===null?_0x3f17e0=Object[_0x1438fc(0xac)](_0x44a781,_0x5797e4):_0x3f17e0,_0x5d5061;if(typeof Reflect===_0x1438fc(0xb1)&&typeof Reflect[_0x1438fc(0xad)]==='function')_0x43ae85=Reflect[_0x1438fc(0xad)](_0x358707,_0x44a781,_0x5797e4,_0x3f17e0);else{for(var _0x3f7c76=_0x358707['length']-0x1;_0x3f7c76>=0x0;_0x3f7c76--)if(_0x5d5061=_0x358707[_0x3f7c76])_0x43ae85=(_0x4e5e3a<0x3?_0x5d5061(_0x43ae85):_0x4e5e3a>0x3?_0x5d5061(_0x44a781,_0x5797e4,_0x43ae85):_0x5d5061(_0x44a781,_0x5797e4))||_0x43ae85;}return _0x4e5e3a>0x3&&_0x43ae85&&Object[_0x1438fc(0xd7)](_0x44a781,_0x5797e4,_0x43ae85),_0x43ae85;},__metadata=this&&this['__metadata']||function(_0x1e1f9b,_0x2764ac){const _0x353d0c=_0x3a4249;if(typeof Reflect===_0x353d0c(0xb1)&&typeof Reflect[_0x353d0c(0xed)]===_0x353d0c(0xd9))return Reflect[_0x353d0c(0xed)](_0x1e1f9b,_0x2764ac);};Object[_0x3a4249(0xd7)](exports,'__esModule',{'value':!![]}),exports['LumaVideoService']=void 0x0;const common_1=require(_0x3a4249(0xbd)),axios_1=require(_0x3a4249(0xc7)),chatLog_service_1=require(_0x3a4249(0xc0)),globalConfig_service_1=require(_0x3a4249(0xef)),upload_service_1=require(_0x3a4249(0xc6));function _0x1770(){const _0xeba8a0=['100%','任务提交失败','message','pollLumaVideoResult','LumaVideoService','post','getDate','state','metadata','Lum\x20aService','../globalConfig/globalConfig.service','default','任务提交失败:\x20','uploadService','videoUrl','length','design:paramtypes','视频生成中...','globalConfigService','76098ChAJBP','任务提交成功,\x20任务ID:\x20','ChatLogService','轮询过程中发生错误:\x20','status','padStart','lumaVideo','getOwnPropertyDescriptor','decorate','3826062dEWBIg','更新日志失败:\x20','/luma/generations/','object','localStorageStatus','error','未能获取结果数据,\x20即将重试','image_url','Logger','UploadService','updateChatLog','上传文件失败:\x20','get','LumaService','progress','@nestjs/common','正在准备发送请求到\x20','视频任务已完成','../chatLog/chatLog.service','answer','24udHaWp','3894369QjTkpB','3676304pckbqs','data','../upload/upload.service','axios','fileInfo','2746583gDqrGa','，payload:\x20','视频生成失败','chatLogService','查询超时，请稍后再试！','265mFLukf','生成失败','轮询结果:\x20','floor','255tdETJR','22987010tdaHQC','prompt','__decorate','3760AxlXmG','defineProperty','stringify','function','now','log','audioUrl','getMonth','提示词:\x20\x22','url','video/luma/','轮询失败，重试次数:\x20','video','taskId','uploadFileFromUrl'];_0x1770=function(){return _0xeba8a0;};return _0x1770();}let LumaVideoService=class LumaVideoService{constructor(_0xcf7e1d,_0x20ebc7,_0x390802){const _0x2d1997=_0x3a4249;this[_0x2d1997(0xcc)]=_0xcf7e1d,this[_0x2d1997(0xf7)]=_0x20ebc7,this[_0x2d1997(0xf2)]=_0x390802;}async[_0x3a4249(0xab)](_0x49a855){const _0x196b49=_0x3a4249;var _0x14057e,_0x56ce6e,_0x48d5ee;const {apiKey:_0x283ad0,proxyUrl:_0x5d59b7,fileInfo:_0x8f031d,prompt:_0x289b62,timeout:_0xb9dfb8,assistantLogId:_0x2c3253,extraParam:_0x34f420}=_0x49a855;let _0x1ba0a1={'text':'','fileInfo':'','taskId':'','taskData':'','status':0x2},_0x4d348a=null,_0x73b81e='',_0x48932={};const _0x5a6df5={'Authorization':'Bearer\x20'+_0x283ad0};_0x73b81e=_0x5d59b7+_0x196b49(0xb0);const _0x53eca5=_0x34f420['size']||'16:9';_0x48932={'user_prompt':_0x289b62,'aspect_ratio':_0x53eca5,'expand_prompt':!![]};_0x8f031d&&(_0x48932[_0x196b49(0xb5)]=_0x8f031d);common_1['Logger'][_0x196b49(0xdb)](_0x196b49(0xbe)+_0x73b81e+_0x196b49(0xca)+JSON['stringify'](_0x48932)+',\x20headers:\x20'+JSON[_0x196b49(0xd8)](_0x5a6df5),_0x196b49(0xbb));try{_0x4d348a=await axios_1[_0x196b49(0xf0)][_0x196b49(0xea)](_0x73b81e,_0x48932,{'headers':_0x5a6df5});}catch(_0x4337b0){common_1[_0x196b49(0xb6)]['error'](_0x196b49(0xf1)+_0x4337b0[_0x196b49(0xe7)],_0x196b49(0xbb));throw new Error(_0x196b49(0xe6));}if((_0x14057e=_0x4d348a===null||_0x4d348a===void 0x0?void 0x0:_0x4d348a[_0x196b49(0xc5)])===null||_0x14057e===void 0x0?void 0x0:_0x14057e['id'])_0x1ba0a1['taskId']=(_0x56ce6e=_0x4d348a===null||_0x4d348a===void 0x0?void 0x0:_0x4d348a[_0x196b49(0xc5)])===null||_0x56ce6e===void 0x0?void 0x0:_0x56ce6e['id'],common_1['Logger'][_0x196b49(0xdb)](_0x196b49(0xf9)+((_0x48d5ee=_0x4d348a===null||_0x4d348a===void 0x0?void 0x0:_0x4d348a[_0x196b49(0xc5)])===null||_0x48d5ee===void 0x0?void 0x0:_0x48d5ee['id']),_0x196b49(0xbb));else throw new Error(_0x196b49(0xb4));try{await this[_0x196b49(0xe8)]({'proxyUrl':_0x5d59b7,'apiKey':_0x283ad0,'taskId':_0x4d348a[_0x196b49(0xc5)]['id'],'timeout':_0xb9dfb8,'prompt':_0x289b62,'onSuccess':async _0x17c6b4=>{const _0x2a4694=_0x196b49;try{await this[_0x2a4694(0xcc)]['updateChatLog'](_0x2c3253,{'videoUrl':_0x17c6b4===null||_0x17c6b4===void 0x0?void 0x0:_0x17c6b4[_0x2a4694(0xf3)],'audioUrl':_0x17c6b4===null||_0x17c6b4===void 0x0?void 0x0:_0x17c6b4[_0x2a4694(0xdc)],'fileInfo':_0x17c6b4===null||_0x17c6b4===void 0x0?void 0x0:_0x17c6b4[_0x2a4694(0xc8)],'answer':(_0x17c6b4===null||_0x17c6b4===void 0x0?void 0x0:_0x17c6b4[_0x2a4694(0xc1)])||_0x289b62,'progress':_0x2a4694(0xe5),'status':0x3,'taskId':_0x17c6b4===null||_0x17c6b4===void 0x0?void 0x0:_0x17c6b4[_0x2a4694(0xe3)],'taskData':_0x17c6b4===null||_0x17c6b4===void 0x0?void 0x0:_0x17c6b4['taskData']}),common_1[_0x2a4694(0xb6)][_0x2a4694(0xdb)](_0x2a4694(0xbf),_0x2a4694(0xbb));}catch(_0x49df90){common_1[_0x2a4694(0xb6)][_0x2a4694(0xb3)](_0x2a4694(0xaf)+_0x49df90[_0x2a4694(0xe7)],_0x2a4694(0xbb));}},'onGenerating':async _0x5923c9=>{const _0x32e1a7=_0x196b49;try{await this[_0x32e1a7(0xcc)][_0x32e1a7(0xb8)](_0x2c3253,{'videoUrl':_0x5923c9===null||_0x5923c9===void 0x0?void 0x0:_0x5923c9[_0x32e1a7(0xf3)],'audioUrl':_0x5923c9===null||_0x5923c9===void 0x0?void 0x0:_0x5923c9[_0x32e1a7(0xdc)],'fileInfo':_0x5923c9===null||_0x5923c9===void 0x0?void 0x0:_0x5923c9[_0x32e1a7(0xc8)],'answer':(_0x5923c9===null||_0x5923c9===void 0x0?void 0x0:_0x5923c9[_0x32e1a7(0xc1)])||_0x32e1a7(0xf6),'progress':_0x5923c9===null||_0x5923c9===void 0x0?void 0x0:_0x5923c9[_0x32e1a7(0xbc)],'status':_0x5923c9['status']}),common_1[_0x32e1a7(0xb6)][_0x32e1a7(0xdb)](_0x32e1a7(0xf6),'LumaService');}catch(_0x243a57){common_1['Logger']['error'](_0x32e1a7(0xaf)+_0x243a57[_0x32e1a7(0xe7)],_0x32e1a7(0xbb));}},'onFailure':async _0xf618a=>{const _0x47f089=_0x196b49;try{await this[_0x47f089(0xcc)][_0x47f089(0xb8)](_0x2c3253,{'answer':_0x47f089(0xcb),'status':_0xf618a[_0x47f089(0xfc)]}),common_1[_0x47f089(0xb6)][_0x47f089(0xdb)](_0x47f089(0xcf),_0x47f089(0xee));}catch(_0x78c28a){common_1[_0x47f089(0xb6)][_0x47f089(0xb3)](_0x47f089(0xaf)+_0x78c28a[_0x47f089(0xe7)],'LumaService');}}});}catch(_0x52cea7){common_1[_0x196b49(0xb6)][_0x196b49(0xb3)]('查询生成结果时发生错误:',_0x52cea7[_0x196b49(0xe7)],'LumaService');throw new Error('查询生成结果时发生错误');}return _0x1ba0a1;}async[_0x3a4249(0xe8)](_0x24c08e){const _0x37bdf5=_0x3a4249,{proxyUrl:_0x3e81b5,apiKey:_0x5d390d,taskId:_0x52c5d0,timeout:_0xbf009b,onSuccess:_0xa6347c,onFailure:_0x856ca9,onGenerating:_0x5d5b6e,action:_0x534fcf}=_0x24c08e;let _0x32ca5a={'videoUrl':'','audioUrl':'','fileInfo':'','drawId':'','taskData':'','status':0x2,'progress':0x0,'answer':''};const _0x50bd14={'Authorization':'Bearer\x20'+_0x5d390d},_0x559a99=_0x3e81b5+_0x37bdf5(0xb0)+_0x52c5d0,_0x4c27e2=Date['now'](),_0x234e4a=0x493e0,_0x430ebf=0x1388;let _0x39d0c9=0x0;try{while(Date[_0x37bdf5(0xda)]()-_0x4c27e2<_0xbf009b){await new Promise(_0x2fe582=>setTimeout(_0x2fe582,_0x430ebf));try{const _0x3ad405=await axios_1[_0x37bdf5(0xf0)][_0x37bdf5(0xba)](_0x559a99,{'headers':_0x50bd14}),_0x5797e9=setInterval(()=>{const _0x3f73aa=_0x37bdf5,_0x14c4ff=Date[_0x3f73aa(0xda)]()-_0x4c27e2;let _0x1f3fc4=Math[_0x3f73aa(0xd1)](_0x14c4ff/_0x234e4a*0x64);if(_0x1f3fc4>=0x63)_0x1f3fc4=0x63;_0x32ca5a[_0x3f73aa(0xc1)]='视频生成中\x20（'+_0x1f3fc4+'%）';},0x3e8),_0x4cb69d=_0x3ad405[_0x37bdf5(0xc5)];common_1[_0x37bdf5(0xb6)]['debug'](_0x37bdf5(0xd0)+JSON[_0x37bdf5(0xd8)](_0x4cb69d),'LumaService');if(_0x4cb69d[_0x37bdf5(0xec)]==='completed'){_0x32ca5a[_0x37bdf5(0xe3)]=_0x4cb69d['id'],_0x32ca5a['taskData']=JSON['stringify'](_0x4cb69d),_0x32ca5a['fileInfo']=_0x4cb69d[_0x37bdf5(0xe2)][_0x37bdf5(0xdf)];try{const _0x5e2587=await this[_0x37bdf5(0xf7)]['getConfigs']([_0x37bdf5(0xb2)]);if(Number(_0x5e2587)){const _0x41b456=new Date(),_0x3f5b77=_0x41b456['getFullYear'](),_0x16e080=String(_0x41b456[_0x37bdf5(0xdd)]()+0x1)[_0x37bdf5(0xfd)](0x2,'0'),_0x23fdac=String(_0x41b456[_0x37bdf5(0xeb)]())[_0x37bdf5(0xfd)](0x2,'0'),_0x3bd28d=''+_0x3f5b77+_0x16e080+'/'+_0x23fdac;_0x32ca5a[_0x37bdf5(0xc8)]=await this[_0x37bdf5(0xf2)][_0x37bdf5(0xe4)]({'url':_0x4cb69d['video']['download_url'],'dir':_0x37bdf5(0xe0)+_0x3bd28d});}}catch(_0x41a3a4){common_1[_0x37bdf5(0xb6)]['error'](_0x37bdf5(0xb9)+_0x41a3a4[_0x37bdf5(0xe7)],_0x37bdf5(0xbb));}_0x32ca5a[_0x37bdf5(0xc1)]=_0x37bdf5(0xde)+_0x4cb69d[_0x37bdf5(0xd4)]+'\x22',_0xa6347c(_0x32ca5a),clearInterval(_0x5797e9);return;}else _0x5d5b6e(_0x32ca5a);if(_0x32ca5a['progress']){}}catch(_0x53e8d6){_0x39d0c9++,common_1['Logger'][_0x37bdf5(0xb3)](_0x37bdf5(0xe1)+_0x39d0c9,_0x37bdf5(0xbb));}}common_1['Logger'][_0x37bdf5(0xb3)]('轮询超时，请稍后再试！','LumaService'),_0x32ca5a[_0x37bdf5(0xfc)]=0x4,_0x856ca9(_0x32ca5a);throw new Error(_0x37bdf5(0xcd));}catch(_0x38eeff){common_1[_0x37bdf5(0xb6)][_0x37bdf5(0xb3)](_0x37bdf5(0xfb)+_0x38eeff,_0x37bdf5(0xbb)),_0x32ca5a[_0x37bdf5(0xfc)]=0x5,_0x856ca9(_0x32ca5a);}}};LumaVideoService=__decorate([(0x0,common_1['Injectable'])(),__metadata(_0x3a4249(0xf5),[chatLog_service_1[_0x3a4249(0xfa)],globalConfig_service_1['GlobalConfigService'],upload_service_1[_0x3a4249(0xb7)]])],LumaVideoService),exports[_0x3a4249(0xe9)]=LumaVideoService;