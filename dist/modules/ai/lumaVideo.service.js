'use strict';function _0x2889(){const _0x4a0e8b=['未能获取结果数据,\x20即将重试','轮询失败，重试次数:\x20','6ZvLMAr','100%','18045PyRZbb','completed','轮询超时，请稍后再试！','audioUrl','27225baPNqg','stringify','lumaVideo','Bearer\x20','1629GBMZWO','getDate','5nONyjC','updateChatLog','/luma/generations/','progress','debug','download_url','globalConfigService','585360lOpjwD','pollLumaVideoResult','image_url','3186040kzjCQR','更新日志失败:\x20','prompt','post','now','status','16:9','uploadService','602348RaNvWF','videoUrl','taskId','length','fileInfo','3036XlLoCR','LumaService','log','decorate','__decorate','default','视频生成中\x20（','chatLogService','GlobalConfigService','floor','padStart','LumaVideoService','error','轮询结果:\x20','function','video/luma/','6792omNHZX',',\x20headers:\x20','message','提示词:\x20\x22','__metadata','查询超时，请稍后再试！','Lum\x20aService','UploadService','video','Injectable','getConfigs','生成失败','defineProperty','axios','2569Gwfeoz','taskData','data','视频任务已完成','get','../globalConfig/globalConfig.service','轮询过程中发生错误:\x20','localStorageStatus','上传文件失败:\x20','size','Logger','answer','任务提交失败:\x20','16kcXced'];_0x2889=function(){return _0x4a0e8b;};return _0x2889();}const _0x4c8025=_0x4215;(function(_0x1f16b4,_0x54c631){const _0x81c5a6=_0x4215,_0x578cb0=_0x1f16b4();while(!![]){try{const _0x4e7e72=parseInt(_0x81c5a6(0x1ba))/0x1+-parseInt(_0x81c5a6(0x1a4))/0x2*(parseInt(_0x81c5a6(0x1a9))/0x3)+-parseInt(_0x81c5a6(0x1c5))/0x4*(parseInt(_0x81c5a6(0x1b3))/0x5)+parseInt(_0x81c5a6(0x1a7))/0x6*(-parseInt(_0x81c5a6(0x197))/0x7)+-parseInt(_0x81c5a6(0x189))/0x8*(parseInt(_0x81c5a6(0x1b1))/0x9)+-parseInt(_0x81c5a6(0x1bd))/0xa+parseInt(_0x81c5a6(0x1ad))/0xb*(parseInt(_0x81c5a6(0x1ca))/0xc);if(_0x4e7e72===_0x54c631)break;else _0x578cb0['push'](_0x578cb0['shift']());}catch(_0x4c25a8){_0x578cb0['push'](_0x578cb0['shift']());}}}(_0x2889,0x83e1c));var __decorate=this&&this[_0x4c8025(0x1ce)]||function(_0x158209,_0x3188e9,_0x201ad5,_0x1f6be2){const _0x10577b=_0x4c8025;var _0x3385b9=arguments[_0x10577b(0x1c8)],_0x1628f6=_0x3385b9<0x3?_0x3188e9:_0x1f6be2===null?_0x1f6be2=Object['getOwnPropertyDescriptor'](_0x3188e9,_0x201ad5):_0x1f6be2,_0x4fd2b6;if(typeof Reflect==='object'&&typeof Reflect[_0x10577b(0x1cd)]==='function')_0x1628f6=Reflect[_0x10577b(0x1cd)](_0x158209,_0x3188e9,_0x201ad5,_0x1f6be2);else{for(var _0x23f794=_0x158209[_0x10577b(0x1c8)]-0x1;_0x23f794>=0x0;_0x23f794--)if(_0x4fd2b6=_0x158209[_0x23f794])_0x1628f6=(_0x3385b9<0x3?_0x4fd2b6(_0x1628f6):_0x3385b9>0x3?_0x4fd2b6(_0x3188e9,_0x201ad5,_0x1628f6):_0x4fd2b6(_0x3188e9,_0x201ad5))||_0x1628f6;}return _0x3385b9>0x3&&_0x1628f6&&Object[_0x10577b(0x195)](_0x3188e9,_0x201ad5,_0x1628f6),_0x1628f6;},__metadata=this&&this[_0x4c8025(0x18d)]||function(_0xcf2e13,_0x126420){const _0x143365=_0x4c8025;if(typeof Reflect==='object'&&typeof Reflect['metadata']===_0x143365(0x1d8))return Reflect['metadata'](_0xcf2e13,_0x126420);};Object[_0x4c8025(0x195)](exports,'__esModule',{'value':!![]}),exports[_0x4c8025(0x1d5)]=void 0x0;function _0x4215(_0x43f1e2,_0x17b2ed){const _0x28893f=_0x2889();return _0x4215=function(_0x421572,_0x50f8e2){_0x421572=_0x421572-0x188;let _0x37392a=_0x28893f[_0x421572];return _0x37392a;},_0x4215(_0x43f1e2,_0x17b2ed);}const common_1=require('@nestjs/common'),axios_1=require(_0x4c8025(0x196)),chatLog_service_1=require('../chatLog/chatLog.service'),globalConfig_service_1=require(_0x4c8025(0x19c)),upload_service_1=require('../upload/upload.service');let LumaVideoService=class LumaVideoService{constructor(_0x469043,_0x455360,_0x2c1a29){const _0x56b7c2=_0x4c8025;this[_0x56b7c2(0x1d1)]=_0x469043,this[_0x56b7c2(0x1b9)]=_0x455360,this[_0x56b7c2(0x1c4)]=_0x2c1a29;}async[_0x4c8025(0x1af)](_0x12e252){const _0x4e0e35=_0x4c8025;var _0x2800b5,_0x3f44b4,_0x4468db;const {apiKey:_0xbe9e24,proxyUrl:_0x4e66cd,fileInfo:_0x7defd3,prompt:_0x57745b,timeout:_0x20d7f3,assistantLogId:_0x51a1d3,extraParam:_0x181d77}=_0x12e252;let _0x2831ad={'text':'','fileInfo':'','taskId':'','taskData':'','status':0x2},_0x195b10=null,_0x4c2437='',_0x2534e4={};const _0x4776b6={'Authorization':_0x4e0e35(0x1b0)+_0xbe9e24};_0x4c2437=_0x4e66cd+_0x4e0e35(0x1b5);const _0x436749=_0x181d77[_0x4e0e35(0x1a0)]||_0x4e0e35(0x1c3);_0x2534e4={'user_prompt':_0x57745b,'aspect_ratio':_0x436749,'expand_prompt':!![]};_0x7defd3&&(_0x2534e4[_0x4e0e35(0x1bc)]=_0x7defd3);common_1['Logger'][_0x4e0e35(0x1cc)]('正在准备发送请求到\x20'+_0x4c2437+'，payload:\x20'+JSON[_0x4e0e35(0x1ae)](_0x2534e4)+_0x4e0e35(0x18a)+JSON[_0x4e0e35(0x1ae)](_0x4776b6),'LumaService');try{_0x195b10=await axios_1[_0x4e0e35(0x1cf)][_0x4e0e35(0x1c0)](_0x4c2437,_0x2534e4,{'headers':_0x4776b6});}catch(_0x37a7b5){common_1[_0x4e0e35(0x1a1)][_0x4e0e35(0x1d6)](_0x4e0e35(0x1a3)+_0x37a7b5[_0x4e0e35(0x18b)],_0x4e0e35(0x1cb));throw new Error('任务提交失败');}if((_0x2800b5=_0x195b10===null||_0x195b10===void 0x0?void 0x0:_0x195b10[_0x4e0e35(0x199)])===null||_0x2800b5===void 0x0?void 0x0:_0x2800b5['id'])_0x2831ad[_0x4e0e35(0x1c7)]=(_0x3f44b4=_0x195b10===null||_0x195b10===void 0x0?void 0x0:_0x195b10[_0x4e0e35(0x199)])===null||_0x3f44b4===void 0x0?void 0x0:_0x3f44b4['id'],common_1['Logger'][_0x4e0e35(0x1cc)]('任务提交成功,\x20任务ID:\x20'+((_0x4468db=_0x195b10===null||_0x195b10===void 0x0?void 0x0:_0x195b10['data'])===null||_0x4468db===void 0x0?void 0x0:_0x4468db['id']),_0x4e0e35(0x1cb));else throw new Error(_0x4e0e35(0x1a5));try{await this['pollLumaVideoResult']({'proxyUrl':_0x4e66cd,'apiKey':_0xbe9e24,'taskId':_0x195b10[_0x4e0e35(0x199)]['id'],'timeout':_0x20d7f3,'prompt':_0x57745b,'onSuccess':async _0x5883e6=>{const _0x31185f=_0x4e0e35;try{await this[_0x31185f(0x1d1)]['updateChatLog'](_0x51a1d3,{'videoUrl':_0x5883e6===null||_0x5883e6===void 0x0?void 0x0:_0x5883e6[_0x31185f(0x1c6)],'audioUrl':_0x5883e6===null||_0x5883e6===void 0x0?void 0x0:_0x5883e6[_0x31185f(0x1ac)],'fileInfo':_0x5883e6===null||_0x5883e6===void 0x0?void 0x0:_0x5883e6[_0x31185f(0x1c9)],'answer':(_0x5883e6===null||_0x5883e6===void 0x0?void 0x0:_0x5883e6[_0x31185f(0x1a2)])||_0x57745b,'progress':_0x31185f(0x1a8),'status':0x3,'taskId':_0x5883e6===null||_0x5883e6===void 0x0?void 0x0:_0x5883e6[_0x31185f(0x1c7)],'taskData':_0x5883e6===null||_0x5883e6===void 0x0?void 0x0:_0x5883e6[_0x31185f(0x198)]}),common_1[_0x31185f(0x1a1)][_0x31185f(0x1cc)](_0x31185f(0x19a),'LumaService');}catch(_0x44c840){common_1[_0x31185f(0x1a1)][_0x31185f(0x1d6)](_0x31185f(0x1be)+_0x44c840[_0x31185f(0x18b)],'LumaService');}},'onGenerating':async _0x24dfed=>{const _0x33c788=_0x4e0e35;try{await this['chatLogService'][_0x33c788(0x1b4)](_0x51a1d3,{'videoUrl':_0x24dfed===null||_0x24dfed===void 0x0?void 0x0:_0x24dfed[_0x33c788(0x1c6)],'audioUrl':_0x24dfed===null||_0x24dfed===void 0x0?void 0x0:_0x24dfed['audioUrl'],'fileInfo':_0x24dfed===null||_0x24dfed===void 0x0?void 0x0:_0x24dfed[_0x33c788(0x1c9)],'answer':(_0x24dfed===null||_0x24dfed===void 0x0?void 0x0:_0x24dfed[_0x33c788(0x1a2)])||'视频生成中...','progress':_0x24dfed===null||_0x24dfed===void 0x0?void 0x0:_0x24dfed['progress'],'status':_0x24dfed['status']}),common_1[_0x33c788(0x1a1)]['log']('视频生成中...',_0x33c788(0x1cb));}catch(_0x13588f){common_1[_0x33c788(0x1a1)]['error'](_0x33c788(0x1be)+_0x13588f[_0x33c788(0x18b)],_0x33c788(0x1cb));}},'onFailure':async _0x37bb81=>{const _0x34cea5=_0x4e0e35;try{await this['chatLogService'][_0x34cea5(0x1b4)](_0x51a1d3,{'answer':'视频生成失败','status':_0x37bb81[_0x34cea5(0x1c2)]}),common_1[_0x34cea5(0x1a1)][_0x34cea5(0x1cc)](_0x34cea5(0x194),_0x34cea5(0x18f));}catch(_0x245aa2){common_1[_0x34cea5(0x1a1)][_0x34cea5(0x1d6)](_0x34cea5(0x1be)+_0x245aa2['message'],'LumaService');}}});}catch(_0x46abd5){common_1[_0x4e0e35(0x1a1)][_0x4e0e35(0x1d6)]('查询生成结果时发生错误:',_0x46abd5[_0x4e0e35(0x18b)],_0x4e0e35(0x1cb));throw new Error('查询生成结果时发生错误');}return _0x2831ad;}async[_0x4c8025(0x1bb)](_0x334d7d){const _0x3a2719=_0x4c8025,{proxyUrl:_0x4607fc,apiKey:_0x129680,taskId:_0x1eb1fa,timeout:_0x35e893,onSuccess:_0x3f54b6,onFailure:_0x63e8dc,onGenerating:_0x2d9507,action:_0x331b45}=_0x334d7d;let _0x54c265={'videoUrl':'','audioUrl':'','fileInfo':'','drawId':'','taskData':'','status':0x2,'progress':0x0,'answer':''};const _0x3e4429={'Authorization':'Bearer\x20'+_0x129680},_0x1babfd=_0x4607fc+'/luma/generations/'+_0x1eb1fa,_0x411526=Date[_0x3a2719(0x1c1)](),_0x2ff478=0x493e0,_0x6bb38a=0x1388;let _0x2b25ee=0x0;try{while(Date[_0x3a2719(0x1c1)]()-_0x411526<_0x35e893){await new Promise(_0x380492=>setTimeout(_0x380492,_0x6bb38a));try{const _0x308ffe=await axios_1['default'][_0x3a2719(0x19b)](_0x1babfd,{'headers':_0x3e4429}),_0x39592c=setInterval(()=>{const _0x211430=_0x3a2719,_0x2dc721=Date[_0x211430(0x1c1)]()-_0x411526;let _0x5b5b59=Math[_0x211430(0x1d3)](_0x2dc721/_0x2ff478*0x64);if(_0x5b5b59>=0x63)_0x5b5b59=0x63;_0x54c265[_0x211430(0x1a2)]=_0x211430(0x1d0)+_0x5b5b59+'%）';},0x3e8),_0x5abaaf=_0x308ffe[_0x3a2719(0x199)];common_1[_0x3a2719(0x1a1)][_0x3a2719(0x1b7)](_0x3a2719(0x1d7)+JSON['stringify'](_0x5abaaf),_0x3a2719(0x1cb));if(_0x5abaaf['state']===_0x3a2719(0x1aa)){_0x54c265['taskId']=_0x5abaaf['id'],_0x54c265[_0x3a2719(0x198)]=JSON[_0x3a2719(0x1ae)](_0x5abaaf),_0x54c265[_0x3a2719(0x1c9)]=_0x5abaaf['video']['url'];try{const _0x4650ea=await this[_0x3a2719(0x1b9)][_0x3a2719(0x193)]([_0x3a2719(0x19e)]);if(Number(_0x4650ea)){const _0x4d530f=new Date(),_0x4323a9=_0x4d530f['getFullYear'](),_0x3c5026=String(_0x4d530f['getMonth']()+0x1)[_0x3a2719(0x1d4)](0x2,'0'),_0x262971=String(_0x4d530f[_0x3a2719(0x1b2)]())[_0x3a2719(0x1d4)](0x2,'0'),_0x3a5163=''+_0x4323a9+_0x3c5026+'/'+_0x262971;_0x54c265[_0x3a2719(0x1c9)]=await this[_0x3a2719(0x1c4)]['uploadFileFromUrl']({'url':_0x5abaaf[_0x3a2719(0x191)][_0x3a2719(0x1b8)],'dir':_0x3a2719(0x188)+_0x3a5163});}}catch(_0x3f770f){common_1[_0x3a2719(0x1a1)]['error'](_0x3a2719(0x19f)+_0x3f770f[_0x3a2719(0x18b)],_0x3a2719(0x1cb));}_0x54c265[_0x3a2719(0x1a2)]=_0x3a2719(0x18c)+_0x5abaaf[_0x3a2719(0x1bf)]+'\x22',_0x3f54b6(_0x54c265),clearInterval(_0x39592c);return;}else _0x2d9507(_0x54c265);if(_0x54c265[_0x3a2719(0x1b6)]){}}catch(_0x3fad00){_0x2b25ee++,common_1[_0x3a2719(0x1a1)][_0x3a2719(0x1d6)](_0x3a2719(0x1a6)+_0x2b25ee,_0x3a2719(0x1cb));}}common_1[_0x3a2719(0x1a1)][_0x3a2719(0x1d6)](_0x3a2719(0x1ab),_0x3a2719(0x1cb)),_0x54c265[_0x3a2719(0x1c2)]=0x4,_0x63e8dc(_0x54c265);throw new Error(_0x3a2719(0x18e));}catch(_0x5ba60a){common_1[_0x3a2719(0x1a1)][_0x3a2719(0x1d6)](_0x3a2719(0x19d)+_0x5ba60a,'LumaService'),_0x54c265['status']=0x5,_0x63e8dc(_0x54c265);}}};LumaVideoService=__decorate([(0x0,common_1[_0x4c8025(0x192)])(),__metadata('design:paramtypes',[chatLog_service_1['ChatLogService'],globalConfig_service_1[_0x4c8025(0x1d2)],upload_service_1[_0x4c8025(0x190)]])],LumaVideoService),exports['LumaVideoService']=LumaVideoService;