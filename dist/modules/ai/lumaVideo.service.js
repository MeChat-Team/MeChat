'use strict';const _0x272c7f=_0xe035;function _0x3c03(){const _0x570df7=['6538536BIAlWo','chatLogService','pollLumaVideoResult','Injectable','__esModule','uploadFileFromUrl','fileInfo','url','decorate','更新日志失败:\x20','46645AasYLC','defineProperty',',\x20headers:\x20','视频生成失败','length','Logger','__decorate','__metadata','videoUrl','getOwnPropertyDescriptor','/luma/generations/','audioUrl','，payload:\x20','message','@nestjs/common','stringify','getConfigs','90zOgjZE','answer','updateChatLog','116440igZoLj','2224510VhgMMI','任务提交成功,\x20任务ID:\x20','视频生成中...','design:paramtypes','未能获取结果数据,\x20即将重试','data','视频生成中\x20（','taskData','getMonth','LumaService','object','2632ypUHTx','4152xxAaLA','LumaVideoService','8105610LpZcBD','视频任务已完成','completed','default','提示词:\x20\x22','error','2JWYxJs','上传文件失败:\x20','metadata','padStart','uploadService','video','now','taskId','localStorageStatus','轮询失败，重试次数:\x20','floor','size','function','任务提交失败','轮询结果:\x20','100%','status','progress','查询超时，请稍后再试！','生成失败','Lum\x20aService','ChatLogService','UploadService','Bearer\x20','3741352LwsOKZ','正在准备发送请求到\x20','debug','查询生成结果时发生错误:','globalConfigService','lumaVideo','post','../upload/upload.service','log'];_0x3c03=function(){return _0x570df7;};return _0x3c03();}(function(_0x19ca5b,_0x454a2d){const _0x148908=_0xe035,_0x1e26fc=_0x19ca5b();while(!![]){try{const _0x332ed2=parseInt(_0x148908(0x118))/0x1*(-parseInt(_0x148908(0xed))/0x2)+parseInt(_0x148908(0x129))/0x3*(parseInt(_0x148908(0x12c))/0x4)+parseInt(_0x148908(0x12d))/0x5+parseInt(_0x148908(0x139))/0x6*(-parseInt(_0x148908(0x138))/0x7)+-parseInt(_0x148908(0x105))/0x8+parseInt(_0x148908(0x10e))/0x9+-parseInt(_0x148908(0x13b))/0xa;if(_0x332ed2===_0x454a2d)break;else _0x1e26fc['push'](_0x1e26fc['shift']());}catch(_0x125068){_0x1e26fc['push'](_0x1e26fc['shift']());}}}(_0x3c03,0x70377));function _0xe035(_0x3019a7,_0x7db6f4){const _0x3c0368=_0x3c03();return _0xe035=function(_0xe035ef,_0x2b8b11){_0xe035ef=_0xe035ef-0xeb;let _0x3c7ace=_0x3c0368[_0xe035ef];return _0x3c7ace;},_0xe035(_0x3019a7,_0x7db6f4);}var __decorate=this&&this[_0x272c7f(0x11e)]||function(_0x165160,_0x508f57,_0x6449e7,_0x3bf229){const _0x3849c5=_0x272c7f;var _0x56ecb6=arguments[_0x3849c5(0x11c)],_0x2080be=_0x56ecb6<0x3?_0x508f57:_0x3bf229===null?_0x3bf229=Object[_0x3849c5(0x121)](_0x508f57,_0x6449e7):_0x3bf229,_0x2d2a74;if(typeof Reflect===_0x3849c5(0x137)&&typeof Reflect[_0x3849c5(0x116)]===_0x3849c5(0xf9))_0x2080be=Reflect[_0x3849c5(0x116)](_0x165160,_0x508f57,_0x6449e7,_0x3bf229);else{for(var _0x3434f3=_0x165160['length']-0x1;_0x3434f3>=0x0;_0x3434f3--)if(_0x2d2a74=_0x165160[_0x3434f3])_0x2080be=(_0x56ecb6<0x3?_0x2d2a74(_0x2080be):_0x56ecb6>0x3?_0x2d2a74(_0x508f57,_0x6449e7,_0x2080be):_0x2d2a74(_0x508f57,_0x6449e7))||_0x2080be;}return _0x56ecb6>0x3&&_0x2080be&&Object[_0x3849c5(0x119)](_0x508f57,_0x6449e7,_0x2080be),_0x2080be;},__metadata=this&&this[_0x272c7f(0x11f)]||function(_0x3fbc4d,_0x1ecf09){const _0xd01096=_0x272c7f;if(typeof Reflect===_0xd01096(0x137)&&typeof Reflect['metadata']===_0xd01096(0xf9))return Reflect[_0xd01096(0xef)](_0x3fbc4d,_0x1ecf09);};Object['defineProperty'](exports,_0x272c7f(0x112),{'value':!![]}),exports[_0x272c7f(0x13a)]=void 0x0;const common_1=require(_0x272c7f(0x126)),axios_1=require('axios'),chatLog_service_1=require('../chatLog/chatLog.service'),globalConfig_service_1=require('../globalConfig/globalConfig.service'),upload_service_1=require(_0x272c7f(0x10c));let LumaVideoService=class LumaVideoService{constructor(_0x5ddc1c,_0x17ced2,_0xa7aec5){const _0x16fa38=_0x272c7f;this[_0x16fa38(0x10f)]=_0x5ddc1c,this[_0x16fa38(0x109)]=_0x17ced2,this['uploadService']=_0xa7aec5;}async[_0x272c7f(0x10a)](_0x558b41){const _0x3b05ee=_0x272c7f;var _0x37811b,_0x1f3692,_0x7e1cb6;const {apiKey:_0x4b5ad1,proxyUrl:_0x50d6a2,fileInfo:_0x52b1fd,prompt:_0x110b9b,timeout:_0x1b3490,assistantLogId:_0x115431,extraParam:_0x42a6fd}=_0x558b41;let _0x23bb9f={'text':'','fileInfo':'','taskId':'','taskData':'','status':0x2},_0x1a856a=null,_0x2a57c5='',_0x3036d3={};const _0x23cb92={'Authorization':_0x3b05ee(0x104)+_0x4b5ad1};_0x2a57c5=_0x50d6a2+_0x3b05ee(0x122);const _0x435107=_0x42a6fd[_0x3b05ee(0xf8)]||'16:9';_0x3036d3={'user_prompt':_0x110b9b,'aspect_ratio':_0x435107,'expand_prompt':!![]};_0x52b1fd&&(_0x3036d3['image_url']=_0x52b1fd);common_1[_0x3b05ee(0x11d)][_0x3b05ee(0x10d)](_0x3b05ee(0x106)+_0x2a57c5+_0x3b05ee(0x124)+JSON[_0x3b05ee(0x127)](_0x3036d3)+_0x3b05ee(0x11a)+JSON[_0x3b05ee(0x127)](_0x23cb92),_0x3b05ee(0x136));try{_0x1a856a=await axios_1[_0x3b05ee(0x13e)][_0x3b05ee(0x10b)](_0x2a57c5,_0x3036d3,{'headers':_0x23cb92});}catch(_0x1582c6){common_1[_0x3b05ee(0x11d)]['error']('任务提交失败:\x20'+_0x1582c6[_0x3b05ee(0x125)],_0x3b05ee(0x136));throw new Error(_0x3b05ee(0xfa));}if((_0x37811b=_0x1a856a===null||_0x1a856a===void 0x0?void 0x0:_0x1a856a[_0x3b05ee(0x132)])===null||_0x37811b===void 0x0?void 0x0:_0x37811b['id'])_0x23bb9f[_0x3b05ee(0xf4)]=(_0x1f3692=_0x1a856a===null||_0x1a856a===void 0x0?void 0x0:_0x1a856a[_0x3b05ee(0x132)])===null||_0x1f3692===void 0x0?void 0x0:_0x1f3692['id'],common_1['Logger'][_0x3b05ee(0x10d)](_0x3b05ee(0x12e)+((_0x7e1cb6=_0x1a856a===null||_0x1a856a===void 0x0?void 0x0:_0x1a856a[_0x3b05ee(0x132)])===null||_0x7e1cb6===void 0x0?void 0x0:_0x7e1cb6['id']),'LumaService');else throw new Error(_0x3b05ee(0x131));try{await this[_0x3b05ee(0x110)]({'proxyUrl':_0x50d6a2,'apiKey':_0x4b5ad1,'taskId':_0x1a856a[_0x3b05ee(0x132)]['id'],'timeout':_0x1b3490,'prompt':_0x110b9b,'onSuccess':async _0x53bf2b=>{const _0x226a9a=_0x3b05ee;try{await this[_0x226a9a(0x10f)][_0x226a9a(0x12b)](_0x115431,{'videoUrl':_0x53bf2b===null||_0x53bf2b===void 0x0?void 0x0:_0x53bf2b[_0x226a9a(0x120)],'audioUrl':_0x53bf2b===null||_0x53bf2b===void 0x0?void 0x0:_0x53bf2b[_0x226a9a(0x123)],'fileInfo':_0x53bf2b===null||_0x53bf2b===void 0x0?void 0x0:_0x53bf2b[_0x226a9a(0x114)],'answer':(_0x53bf2b===null||_0x53bf2b===void 0x0?void 0x0:_0x53bf2b[_0x226a9a(0x12a)])||_0x110b9b,'progress':_0x226a9a(0xfc),'status':0x3,'taskId':_0x53bf2b===null||_0x53bf2b===void 0x0?void 0x0:_0x53bf2b[_0x226a9a(0xf4)],'taskData':_0x53bf2b===null||_0x53bf2b===void 0x0?void 0x0:_0x53bf2b[_0x226a9a(0x134)]}),common_1[_0x226a9a(0x11d)][_0x226a9a(0x10d)](_0x226a9a(0x13c),_0x226a9a(0x136));}catch(_0x5d9fd2){common_1[_0x226a9a(0x11d)][_0x226a9a(0xec)]('更新日志失败:\x20'+_0x5d9fd2[_0x226a9a(0x125)],_0x226a9a(0x136));}},'onGenerating':async _0x4bc2b0=>{const _0x3e161a=_0x3b05ee;try{await this['chatLogService'][_0x3e161a(0x12b)](_0x115431,{'videoUrl':_0x4bc2b0===null||_0x4bc2b0===void 0x0?void 0x0:_0x4bc2b0[_0x3e161a(0x120)],'audioUrl':_0x4bc2b0===null||_0x4bc2b0===void 0x0?void 0x0:_0x4bc2b0[_0x3e161a(0x123)],'fileInfo':_0x4bc2b0===null||_0x4bc2b0===void 0x0?void 0x0:_0x4bc2b0[_0x3e161a(0x114)],'answer':(_0x4bc2b0===null||_0x4bc2b0===void 0x0?void 0x0:_0x4bc2b0[_0x3e161a(0x12a)])||_0x3e161a(0x12f),'progress':_0x4bc2b0===null||_0x4bc2b0===void 0x0?void 0x0:_0x4bc2b0[_0x3e161a(0xfe)],'status':_0x4bc2b0['status']}),common_1[_0x3e161a(0x11d)]['log'](_0x3e161a(0x12f),_0x3e161a(0x136));}catch(_0x5ebc9d){common_1[_0x3e161a(0x11d)][_0x3e161a(0xec)](_0x3e161a(0x117)+_0x5ebc9d['message'],_0x3e161a(0x136));}},'onFailure':async _0x4d65bd=>{const _0x15663b=_0x3b05ee;try{await this[_0x15663b(0x10f)]['updateChatLog'](_0x115431,{'answer':_0x15663b(0x11b),'status':_0x4d65bd[_0x15663b(0xfd)]}),common_1[_0x15663b(0x11d)][_0x15663b(0x10d)](_0x15663b(0x100),_0x15663b(0x101));}catch(_0x544d35){common_1['Logger'][_0x15663b(0xec)](_0x15663b(0x117)+_0x544d35[_0x15663b(0x125)],_0x15663b(0x136));}}});}catch(_0x4ea4a0){common_1[_0x3b05ee(0x11d)][_0x3b05ee(0xec)](_0x3b05ee(0x108),_0x4ea4a0[_0x3b05ee(0x125)],_0x3b05ee(0x136));throw new Error('查询生成结果时发生错误');}return _0x23bb9f;}async[_0x272c7f(0x110)](_0x1cdf8f){const _0x25813a=_0x272c7f,{proxyUrl:_0x4ce0da,apiKey:_0x5edb3a,taskId:_0x3343d2,timeout:_0x29f268,onSuccess:_0x7ac9cc,onFailure:_0x342e2b,onGenerating:_0xd92394,action:_0x1b9158}=_0x1cdf8f;let _0x460e3d={'videoUrl':'','audioUrl':'','fileInfo':'','drawId':'','taskData':'','status':0x2,'progress':0x0,'answer':''};const _0x1cbc24={'Authorization':_0x25813a(0x104)+_0x5edb3a},_0x41cc8d=_0x4ce0da+_0x25813a(0x122)+_0x3343d2,_0x46f1ee=Date[_0x25813a(0xf3)](),_0x44bf66=0x493e0,_0x1fee19=0x1388;let _0x2d2d55=0x0;try{while(Date[_0x25813a(0xf3)]()-_0x46f1ee<_0x29f268){await new Promise(_0x27ffaf=>setTimeout(_0x27ffaf,_0x1fee19));try{const _0xf6ac3d=await axios_1[_0x25813a(0x13e)]['get'](_0x41cc8d,{'headers':_0x1cbc24}),_0x685b2a=setInterval(()=>{const _0xe513bd=_0x25813a,_0x2298b2=Date['now']()-_0x46f1ee;let _0x5acb1=Math[_0xe513bd(0xf7)](_0x2298b2/_0x44bf66*0x64);if(_0x5acb1>=0x63)_0x5acb1=0x63;_0x460e3d[_0xe513bd(0x12a)]=_0xe513bd(0x133)+_0x5acb1+'%）';},0x3e8),_0x5a2244=_0xf6ac3d[_0x25813a(0x132)];common_1[_0x25813a(0x11d)][_0x25813a(0x107)](_0x25813a(0xfb)+JSON[_0x25813a(0x127)](_0x5a2244),_0x25813a(0x136));if(_0x5a2244['state']===_0x25813a(0x13d)){_0x460e3d[_0x25813a(0xf4)]=_0x5a2244['id'],_0x460e3d['taskData']=JSON[_0x25813a(0x127)](_0x5a2244),_0x460e3d[_0x25813a(0x114)]=_0x5a2244[_0x25813a(0xf2)][_0x25813a(0x115)];try{const _0x36b3c8=await this['globalConfigService'][_0x25813a(0x128)]([_0x25813a(0xf5)]);if(Number(_0x36b3c8)){const _0x1c28b7=new Date(),_0x16f9bb=_0x1c28b7['getFullYear'](),_0x21457e=String(_0x1c28b7[_0x25813a(0x135)]()+0x1)['padStart'](0x2,'0'),_0x556c56=String(_0x1c28b7['getDate']())[_0x25813a(0xf0)](0x2,'0'),_0x316404=''+_0x16f9bb+_0x21457e+'/'+_0x556c56;_0x460e3d[_0x25813a(0x114)]=await this[_0x25813a(0xf1)][_0x25813a(0x113)]({'url':_0x5a2244[_0x25813a(0xf2)]['download_url'],'dir':'video/luma/'+_0x316404});}}catch(_0x4a6c6a){common_1[_0x25813a(0x11d)][_0x25813a(0xec)](_0x25813a(0xee)+_0x4a6c6a[_0x25813a(0x125)],_0x25813a(0x136));}_0x460e3d[_0x25813a(0x12a)]=_0x25813a(0xeb)+_0x5a2244['prompt']+'\x22',_0x7ac9cc(_0x460e3d),clearInterval(_0x685b2a);return;}else _0xd92394(_0x460e3d);if(_0x460e3d['progress']){}}catch(_0x457b07){_0x2d2d55++,common_1[_0x25813a(0x11d)][_0x25813a(0xec)](_0x25813a(0xf6)+_0x2d2d55,'LumaService');}}common_1['Logger'][_0x25813a(0xec)]('轮询超时，请稍后再试！','LumaService'),_0x460e3d[_0x25813a(0xfd)]=0x4,_0x342e2b(_0x460e3d);throw new Error(_0x25813a(0xff));}catch(_0x103992){common_1[_0x25813a(0x11d)]['error']('轮询过程中发生错误:\x20'+_0x103992,'LumaService'),_0x460e3d[_0x25813a(0xfd)]=0x5,_0x342e2b(_0x460e3d);}}};LumaVideoService=__decorate([(0x0,common_1[_0x272c7f(0x111)])(),__metadata(_0x272c7f(0x130),[chatLog_service_1[_0x272c7f(0x102)],globalConfig_service_1['GlobalConfigService'],upload_service_1[_0x272c7f(0x103)]])],LumaVideoService),exports[_0x272c7f(0x13a)]=LumaVideoService;