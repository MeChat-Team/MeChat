'use strict';const _0x24a58b=_0x3b76;(function(_0x53bf64,_0x4975e2){const _0x471471=_0x3b76,_0x5c3645=_0x53bf64();while(!![]){try{const _0x41d73b=-parseInt(_0x471471(0x17b))/0x1*(-parseInt(_0x471471(0x137))/0x2)+parseInt(_0x471471(0x150))/0x3*(parseInt(_0x471471(0x168))/0x4)+parseInt(_0x471471(0x16b))/0x5*(-parseInt(_0x471471(0x173))/0x6)+parseInt(_0x471471(0x14e))/0x7+parseInt(_0x471471(0x145))/0x8+-parseInt(_0x471471(0x157))/0x9*(-parseInt(_0x471471(0x16e))/0xa)+-parseInt(_0x471471(0x151))/0xb;if(_0x41d73b===_0x4975e2)break;else _0x5c3645['push'](_0x5c3645['shift']());}catch(_0x18880c){_0x5c3645['push'](_0x5c3645['shift']());}}}(_0x12ff,0x6e51d));function _0x12ff(){const _0x2c6f63=['answer','1545100wvpTkJ','debug','fileInfo','audioUrl','chatLogService','progress','video/luma/','videoUrl','defineProperty','function','padStart','视频任务已完成',',\x20headers:\x20','completed','1222752bJKZSO','post','Injectable','ChatLogService','updateChatLog','查询超时，请稍后再试！','视频生成失败','axios','../upload/upload.service','5088391NewgrE','object','228009Bbciql','14199174fpdezk','data','state','Bearer\x20','更新日志失败:\x20','，payload:\x20','9wrPicb','查询生成结果时发生错误','视频生成中\x20（','video','globalConfigService','LumaService','prompt','轮询失败，重试次数:\x20','getConfigs','lumaVideo','生成失败','提示词:\x20\x22','message','url','任务提交失败:\x20','metadata','download_url','12QaSMlv','length','taskId','1063100EbzMbx','UploadService','error','7128670mQEItE','未能获取结果数据,\x20即将重试','任务提交成功,\x20任务ID:\x20','decorate','localStorageStatus','24IfSGSz','getFullYear','size','Lum\x20aService','Logger','轮询过程中发生错误:\x20','../globalConfig/globalConfig.service','log','1ciZjUt','轮询结果:\x20','pollLumaVideoResult','16:9','正在准备发送请求到\x20','floor','now','stringify','../chatLog/chatLog.service','上传文件失败:\x20','uploadFileFromUrl','查询生成结果时发生错误:','@nestjs/common','视频生成中...','uploadService','轮询超时，请稍后再试！','LumaVideoService','GlobalConfigService','default','taskData','getDate','getOwnPropertyDescriptor'];_0x12ff=function(){return _0x2c6f63;};return _0x12ff();}function _0x3b76(_0x1e97ec,_0x543e7d){const _0x12ffd2=_0x12ff();return _0x3b76=function(_0x3b76e1,_0x3b3348){_0x3b76e1=_0x3b76e1-0x12d;let _0xe5fe5=_0x12ffd2[_0x3b76e1];return _0xe5fe5;},_0x3b76(_0x1e97ec,_0x543e7d);}var __decorate=this&&this['__decorate']||function(_0x5d6b7f,_0x193257,_0x59768a,_0x1dfdc0){const _0x28cfc1=_0x3b76;var _0x345f91=arguments['length'],_0x58174f=_0x345f91<0x3?_0x193257:_0x1dfdc0===null?_0x1dfdc0=Object[_0x28cfc1(0x135)](_0x193257,_0x59768a):_0x1dfdc0,_0x3fa98f;if(typeof Reflect===_0x28cfc1(0x14f)&&typeof Reflect[_0x28cfc1(0x171)]===_0x28cfc1(0x140))_0x58174f=Reflect[_0x28cfc1(0x171)](_0x5d6b7f,_0x193257,_0x59768a,_0x1dfdc0);else{for(var _0xf646d6=_0x5d6b7f[_0x28cfc1(0x169)]-0x1;_0xf646d6>=0x0;_0xf646d6--)if(_0x3fa98f=_0x5d6b7f[_0xf646d6])_0x58174f=(_0x345f91<0x3?_0x3fa98f(_0x58174f):_0x345f91>0x3?_0x3fa98f(_0x193257,_0x59768a,_0x58174f):_0x3fa98f(_0x193257,_0x59768a))||_0x58174f;}return _0x345f91>0x3&&_0x58174f&&Object[_0x28cfc1(0x13f)](_0x193257,_0x59768a,_0x58174f),_0x58174f;},__metadata=this&&this['__metadata']||function(_0x3be94e,_0x5ad9cf){const _0x13969b=_0x3b76;if(typeof Reflect==='object'&&typeof Reflect[_0x13969b(0x166)]===_0x13969b(0x140))return Reflect[_0x13969b(0x166)](_0x3be94e,_0x5ad9cf);};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports['LumaVideoService']=void 0x0;const common_1=require(_0x24a58b(0x187)),axios_1=require(_0x24a58b(0x14c)),chatLog_service_1=require(_0x24a58b(0x183)),globalConfig_service_1=require(_0x24a58b(0x179)),upload_service_1=require(_0x24a58b(0x14d));let LumaVideoService=class LumaVideoService{constructor(_0x2a98f6,_0x19ba34,_0x2dd1a0){const _0x1e0f7e=_0x24a58b;this[_0x1e0f7e(0x13b)]=_0x2a98f6,this[_0x1e0f7e(0x15b)]=_0x19ba34,this[_0x1e0f7e(0x12e)]=_0x2dd1a0;}async[_0x24a58b(0x160)](_0x433c7d){const _0x354be5=_0x24a58b;var _0x228e7b,_0x5e4a9f,_0x21e53e;const {apiKey:_0x1d2f17,proxyUrl:_0x20318c,fileInfo:_0x35ceb9,prompt:_0x486871,timeout:_0x2bbd30,assistantLogId:_0xca5530,extraParam:_0x582a3c}=_0x433c7d;let _0x49bd1a={'text':'','fileInfo':'','taskId':'','taskData':'','status':0x2},_0x1e2893=null,_0x1fd3b6='',_0x2e2d9e={};const _0x22fbbf={'Authorization':'Bearer\x20'+_0x1d2f17};_0x1fd3b6=_0x20318c+'/luma/generations/';const _0x10ae0d=_0x582a3c[_0x354be5(0x175)]||_0x354be5(0x17e);_0x2e2d9e={'user_prompt':_0x486871,'aspect_ratio':_0x10ae0d,'expand_prompt':!![]};_0x35ceb9&&(_0x2e2d9e['image_url']=_0x35ceb9);common_1['Logger'][_0x354be5(0x17a)](_0x354be5(0x17f)+_0x1fd3b6+_0x354be5(0x156)+JSON[_0x354be5(0x182)](_0x2e2d9e)+_0x354be5(0x143)+JSON[_0x354be5(0x182)](_0x22fbbf),'LumaService');try{_0x1e2893=await axios_1[_0x354be5(0x132)][_0x354be5(0x146)](_0x1fd3b6,_0x2e2d9e,{'headers':_0x22fbbf});}catch(_0x415ec6){common_1[_0x354be5(0x177)][_0x354be5(0x16d)](_0x354be5(0x165)+_0x415ec6['message'],'LumaService');throw new Error('任务提交失败');}if((_0x228e7b=_0x1e2893===null||_0x1e2893===void 0x0?void 0x0:_0x1e2893[_0x354be5(0x152)])===null||_0x228e7b===void 0x0?void 0x0:_0x228e7b['id'])_0x49bd1a['taskId']=(_0x5e4a9f=_0x1e2893===null||_0x1e2893===void 0x0?void 0x0:_0x1e2893[_0x354be5(0x152)])===null||_0x5e4a9f===void 0x0?void 0x0:_0x5e4a9f['id'],common_1[_0x354be5(0x177)]['log'](_0x354be5(0x170)+((_0x21e53e=_0x1e2893===null||_0x1e2893===void 0x0?void 0x0:_0x1e2893[_0x354be5(0x152)])===null||_0x21e53e===void 0x0?void 0x0:_0x21e53e['id']),_0x354be5(0x15c));else throw new Error(_0x354be5(0x16f));try{await this[_0x354be5(0x17d)]({'proxyUrl':_0x20318c,'apiKey':_0x1d2f17,'taskId':_0x1e2893[_0x354be5(0x152)]['id'],'timeout':_0x2bbd30,'prompt':_0x486871,'onSuccess':async _0x1e5e2c=>{const _0x437ad6=_0x354be5;try{await this[_0x437ad6(0x13b)][_0x437ad6(0x149)](_0xca5530,{'videoUrl':_0x1e5e2c===null||_0x1e5e2c===void 0x0?void 0x0:_0x1e5e2c[_0x437ad6(0x13e)],'audioUrl':_0x1e5e2c===null||_0x1e5e2c===void 0x0?void 0x0:_0x1e5e2c[_0x437ad6(0x13a)],'fileInfo':_0x1e5e2c===null||_0x1e5e2c===void 0x0?void 0x0:_0x1e5e2c[_0x437ad6(0x139)],'answer':(_0x1e5e2c===null||_0x1e5e2c===void 0x0?void 0x0:_0x1e5e2c['answer'])||_0x486871,'progress':'100%','status':0x3,'taskId':_0x1e5e2c===null||_0x1e5e2c===void 0x0?void 0x0:_0x1e5e2c[_0x437ad6(0x16a)],'taskData':_0x1e5e2c===null||_0x1e5e2c===void 0x0?void 0x0:_0x1e5e2c[_0x437ad6(0x133)]}),common_1[_0x437ad6(0x177)]['log'](_0x437ad6(0x142),_0x437ad6(0x15c));}catch(_0x41fca5){common_1['Logger'][_0x437ad6(0x16d)]('更新日志失败:\x20'+_0x41fca5[_0x437ad6(0x163)],_0x437ad6(0x15c));}},'onGenerating':async _0x2db388=>{const _0x58d870=_0x354be5;try{await this['chatLogService'][_0x58d870(0x149)](_0xca5530,{'videoUrl':_0x2db388===null||_0x2db388===void 0x0?void 0x0:_0x2db388['videoUrl'],'audioUrl':_0x2db388===null||_0x2db388===void 0x0?void 0x0:_0x2db388[_0x58d870(0x13a)],'fileInfo':_0x2db388===null||_0x2db388===void 0x0?void 0x0:_0x2db388['fileInfo'],'answer':(_0x2db388===null||_0x2db388===void 0x0?void 0x0:_0x2db388[_0x58d870(0x136)])||_0x58d870(0x12d),'progress':_0x2db388===null||_0x2db388===void 0x0?void 0x0:_0x2db388[_0x58d870(0x13c)],'status':_0x2db388['status']}),common_1['Logger'][_0x58d870(0x17a)](_0x58d870(0x12d),_0x58d870(0x15c));}catch(_0x2fdce2){common_1['Logger']['error'](_0x58d870(0x155)+_0x2fdce2[_0x58d870(0x163)],'LumaService');}},'onFailure':async _0x4acbc9=>{const _0x110c1f=_0x354be5;try{await this[_0x110c1f(0x13b)][_0x110c1f(0x149)](_0xca5530,{'answer':_0x110c1f(0x14b),'status':_0x4acbc9['status']}),common_1['Logger'][_0x110c1f(0x17a)](_0x110c1f(0x161),_0x110c1f(0x176));}catch(_0x38cd16){common_1[_0x110c1f(0x177)][_0x110c1f(0x16d)]('更新日志失败:\x20'+_0x38cd16[_0x110c1f(0x163)],_0x110c1f(0x15c));}}});}catch(_0x173a97){common_1[_0x354be5(0x177)]['error'](_0x354be5(0x186),_0x173a97['message'],'LumaService');throw new Error(_0x354be5(0x158));}return _0x49bd1a;}async[_0x24a58b(0x17d)](_0x41bc7d){const _0x100291=_0x24a58b,{proxyUrl:_0x53ae55,apiKey:_0x8ead7,taskId:_0x449514,timeout:_0x58a31d,onSuccess:_0x47c5e8,onFailure:_0x452a08,onGenerating:_0x5c5f8c,action:_0x52e643}=_0x41bc7d;let _0x1db836={'videoUrl':'','audioUrl':'','fileInfo':'','drawId':'','taskData':'','status':0x2,'progress':0x0,'answer':''};const _0x1dd6ba={'Authorization':_0x100291(0x154)+_0x8ead7},_0x5721ef=_0x53ae55+'/luma/generations/'+_0x449514,_0x2784cd=Date[_0x100291(0x181)](),_0x17866f=0x493e0,_0x107d82=0x1388;let _0x17e5b7=0x0;try{while(Date[_0x100291(0x181)]()-_0x2784cd<_0x58a31d){await new Promise(_0x365af8=>setTimeout(_0x365af8,_0x107d82));try{const _0x131849=await axios_1[_0x100291(0x132)]['get'](_0x5721ef,{'headers':_0x1dd6ba}),_0x1f7055=setInterval(()=>{const _0x113d25=_0x100291,_0x47fded=Date['now']()-_0x2784cd;let _0x568136=Math[_0x113d25(0x180)](_0x47fded/_0x17866f*0x64);if(_0x568136>=0x63)_0x568136=0x63;_0x1db836['answer']=_0x113d25(0x159)+_0x568136+'%）';},0x3e8),_0x3a43c2=_0x131849['data'];common_1[_0x100291(0x177)][_0x100291(0x138)](_0x100291(0x17c)+JSON[_0x100291(0x182)](_0x3a43c2),_0x100291(0x15c));if(_0x3a43c2[_0x100291(0x153)]===_0x100291(0x144)){_0x1db836['taskId']=_0x3a43c2['id'],_0x1db836['taskData']=JSON['stringify'](_0x3a43c2),_0x1db836[_0x100291(0x139)]=_0x3a43c2[_0x100291(0x15a)][_0x100291(0x164)];try{const _0x1f9fe0=await this[_0x100291(0x15b)][_0x100291(0x15f)]([_0x100291(0x172)]);if(Number(_0x1f9fe0)){const _0xb5f94c=new Date(),_0xa6e6ef=_0xb5f94c[_0x100291(0x174)](),_0x41a999=String(_0xb5f94c['getMonth']()+0x1)[_0x100291(0x141)](0x2,'0'),_0x3eb767=String(_0xb5f94c[_0x100291(0x134)]())[_0x100291(0x141)](0x2,'0'),_0x712d22=''+_0xa6e6ef+_0x41a999+'/'+_0x3eb767;_0x1db836[_0x100291(0x139)]=await this['uploadService'][_0x100291(0x185)]({'url':_0x3a43c2[_0x100291(0x15a)][_0x100291(0x167)],'dir':_0x100291(0x13d)+_0x712d22});}}catch(_0x1d0e08){common_1[_0x100291(0x177)][_0x100291(0x16d)](_0x100291(0x184)+_0x1d0e08[_0x100291(0x163)],_0x100291(0x15c));}_0x1db836['answer']=_0x100291(0x162)+_0x3a43c2[_0x100291(0x15d)]+'\x22',_0x47c5e8(_0x1db836),clearInterval(_0x1f7055);return;}else _0x5c5f8c(_0x1db836);if(_0x1db836[_0x100291(0x13c)]){}}catch(_0x32c4b5){_0x17e5b7++,common_1[_0x100291(0x177)][_0x100291(0x16d)](_0x100291(0x15e)+_0x17e5b7,_0x100291(0x15c));}}common_1['Logger'][_0x100291(0x16d)](_0x100291(0x12f),_0x100291(0x15c)),_0x1db836['status']=0x4,_0x452a08(_0x1db836);throw new Error(_0x100291(0x14a));}catch(_0x18651d){common_1['Logger']['error'](_0x100291(0x178)+_0x18651d,_0x100291(0x15c)),_0x1db836['status']=0x5,_0x452a08(_0x1db836);}}};LumaVideoService=__decorate([(0x0,common_1[_0x24a58b(0x147)])(),__metadata('design:paramtypes',[chatLog_service_1[_0x24a58b(0x148)],globalConfig_service_1[_0x24a58b(0x131)],upload_service_1[_0x24a58b(0x16c)]])],LumaVideoService),exports[_0x24a58b(0x130)]=LumaVideoService;