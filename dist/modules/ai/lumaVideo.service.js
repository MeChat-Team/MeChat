'use strict';const _0x47619a=_0x2b4d;(function(_0x53bf65,_0x5db16e){const _0x33dec9=_0x2b4d,_0x438073=_0x53bf65();while(!![]){try{const _0x819db4=parseInt(_0x33dec9(0xfd))/0x1*(-parseInt(_0x33dec9(0xc8))/0x2)+-parseInt(_0x33dec9(0xef))/0x3+-parseInt(_0x33dec9(0xd8))/0x4+parseInt(_0x33dec9(0xd3))/0x5*(parseInt(_0x33dec9(0xd1))/0x6)+parseInt(_0x33dec9(0xe4))/0x7+-parseInt(_0x33dec9(0xea))/0x8*(-parseInt(_0x33dec9(0xb2))/0x9)+parseInt(_0x33dec9(0xfe))/0xa;if(_0x819db4===_0x5db16e)break;else _0x438073['push'](_0x438073['shift']());}catch(_0xe4cb49){_0x438073['push'](_0x438073['shift']());}}}(_0x4869,0xb1476));function _0x4869(){const _0x4b30da=['任务提交成功,\x20任务ID:\x20','metadata','GlobalConfigService','function','fileInfo','taskData','Bearer\x20','uploadFileFromUrl','now','answer','16:9','轮询过程中发生错误:\x20','1370002OupexZ','lumaVideo','上传文件失败:\x20','axios','../upload/upload.service','defineProperty','提示词:\x20\x22','更新日志失败:\x20','message','481956MuGycC','floor','10qlfGEe','查询生成结果时发生错误','get','updateChatLog','log','3475708nuzCSj','length','default','videoUrl','image_url','design:paramtypes','LumaVideoService','prompt','post','video/luma/','completed','生成失败','4380292qioGOL','视频生成中...','decorate','__esModule','，payload:\x20','轮询超时，请稍后再试！','238976rhEXNJ','pollLumaVideoResult','查询生成结果时发生错误:','__decorate','视频生成中\x20（','2729022VWuIuJ','Injectable','object','100%','audioUrl','uploadService','/luma/generations/','status','正在准备发送请求到\x20','Logger','getMonth','state','stringify','padStart','1rfkcDt','11785760gsDbkT','视频任务已完成','video','download_url','getDate','taskId','data','@nestjs/common',',\x20headers:\x20','../chatLog/chatLog.service','任务提交失败:\x20','369cETpHq','UploadService','progress','debug','查询超时，请稍后再试！','chatLogService','轮询结果:\x20','LumaService','Lum\x20aService','error'];_0x4869=function(){return _0x4b30da;};return _0x4869();}var __decorate=this&&this[_0x47619a(0xed)]||function(_0x495386,_0x4cd47e,_0x7f1671,_0x524b65){const _0xd98221=_0x47619a;var _0x1f9732=arguments['length'],_0x1b4fe1=_0x1f9732<0x3?_0x4cd47e:_0x524b65===null?_0x524b65=Object['getOwnPropertyDescriptor'](_0x4cd47e,_0x7f1671):_0x524b65,_0x35d034;if(typeof Reflect===_0xd98221(0xf1)&&typeof Reflect[_0xd98221(0xe6)]===_0xd98221(0xbf))_0x1b4fe1=Reflect['decorate'](_0x495386,_0x4cd47e,_0x7f1671,_0x524b65);else{for(var _0x70985d=_0x495386[_0xd98221(0xd9)]-0x1;_0x70985d>=0x0;_0x70985d--)if(_0x35d034=_0x495386[_0x70985d])_0x1b4fe1=(_0x1f9732<0x3?_0x35d034(_0x1b4fe1):_0x1f9732>0x3?_0x35d034(_0x4cd47e,_0x7f1671,_0x1b4fe1):_0x35d034(_0x4cd47e,_0x7f1671))||_0x1b4fe1;}return _0x1f9732>0x3&&_0x1b4fe1&&Object[_0xd98221(0xcd)](_0x4cd47e,_0x7f1671,_0x1b4fe1),_0x1b4fe1;},__metadata=this&&this['__metadata']||function(_0xff67d4,_0x5f4097){const _0x4d0938=_0x47619a;if(typeof Reflect===_0x4d0938(0xf1)&&typeof Reflect[_0x4d0938(0xbd)]===_0x4d0938(0xbf))return Reflect[_0x4d0938(0xbd)](_0xff67d4,_0x5f4097);};function _0x2b4d(_0x1322d7,_0x1e715c){const _0x4869cb=_0x4869();return _0x2b4d=function(_0x2b4d8f,_0x563dd3){_0x2b4d8f=_0x2b4d8f-0xac;let _0x157b8a=_0x4869cb[_0x2b4d8f];return _0x157b8a;},_0x2b4d(_0x1322d7,_0x1e715c);}Object[_0x47619a(0xcd)](exports,_0x47619a(0xe7),{'value':!![]}),exports[_0x47619a(0xde)]=void 0x0;const common_1=require(_0x47619a(0xae)),axios_1=require(_0x47619a(0xcb)),chatLog_service_1=require(_0x47619a(0xb0)),globalConfig_service_1=require('../globalConfig/globalConfig.service'),upload_service_1=require(_0x47619a(0xcc));let LumaVideoService=class LumaVideoService{constructor(_0x5365a5,_0x39a8ec,_0xc6d0be){const _0x2e9ac3=_0x47619a;this[_0x2e9ac3(0xb7)]=_0x5365a5,this['globalConfigService']=_0x39a8ec,this[_0x2e9ac3(0xf4)]=_0xc6d0be;}async[_0x47619a(0xc9)](_0x6f2c17){const _0x2eee7a=_0x47619a;var _0x2ef2f7,_0x5c9e14,_0x493ee3;const {apiKey:_0x12ff00,proxyUrl:_0x32c65f,fileInfo:_0x5b04f7,prompt:_0x1d15bc,timeout:_0x39bb6a,assistantLogId:_0xb65427,extraParam:_0x26a4d3}=_0x6f2c17;let _0x5cffc6={'text':'','fileInfo':'','taskId':'','taskData':'','status':0x2},_0x106127=null,_0x31c103='',_0x3db817={};const _0x308f6d={'Authorization':'Bearer\x20'+_0x12ff00};_0x31c103=_0x32c65f+'/luma/generations/';const _0x555bce=_0x26a4d3['size']||_0x2eee7a(0xc6);_0x3db817={'user_prompt':_0x1d15bc,'aspect_ratio':_0x555bce,'expand_prompt':!![]};_0x5b04f7&&(_0x3db817[_0x2eee7a(0xdc)]=_0x5b04f7);common_1[_0x2eee7a(0xf8)][_0x2eee7a(0xd7)](_0x2eee7a(0xf7)+_0x31c103+_0x2eee7a(0xe8)+JSON[_0x2eee7a(0xfb)](_0x3db817)+_0x2eee7a(0xaf)+JSON[_0x2eee7a(0xfb)](_0x308f6d),_0x2eee7a(0xb9));try{_0x106127=await axios_1[_0x2eee7a(0xda)][_0x2eee7a(0xe0)](_0x31c103,_0x3db817,{'headers':_0x308f6d});}catch(_0x316bdb){common_1[_0x2eee7a(0xf8)][_0x2eee7a(0xbb)](_0x2eee7a(0xb1)+_0x316bdb[_0x2eee7a(0xd0)],_0x2eee7a(0xb9));throw new Error('任务提交失败');}if((_0x2ef2f7=_0x106127===null||_0x106127===void 0x0?void 0x0:_0x106127[_0x2eee7a(0xad)])===null||_0x2ef2f7===void 0x0?void 0x0:_0x2ef2f7['id'])_0x5cffc6['taskId']=(_0x5c9e14=_0x106127===null||_0x106127===void 0x0?void 0x0:_0x106127[_0x2eee7a(0xad)])===null||_0x5c9e14===void 0x0?void 0x0:_0x5c9e14['id'],common_1['Logger'][_0x2eee7a(0xd7)](_0x2eee7a(0xbc)+((_0x493ee3=_0x106127===null||_0x106127===void 0x0?void 0x0:_0x106127[_0x2eee7a(0xad)])===null||_0x493ee3===void 0x0?void 0x0:_0x493ee3['id']),_0x2eee7a(0xb9));else throw new Error('未能获取结果数据,\x20即将重试');try{await this[_0x2eee7a(0xeb)]({'proxyUrl':_0x32c65f,'apiKey':_0x12ff00,'taskId':_0x106127['data']['id'],'timeout':_0x39bb6a,'prompt':_0x1d15bc,'onSuccess':async _0x495049=>{const _0x30a793=_0x2eee7a;try{await this[_0x30a793(0xb7)][_0x30a793(0xd6)](_0xb65427,{'videoUrl':_0x495049===null||_0x495049===void 0x0?void 0x0:_0x495049[_0x30a793(0xdb)],'audioUrl':_0x495049===null||_0x495049===void 0x0?void 0x0:_0x495049[_0x30a793(0xf3)],'fileInfo':_0x495049===null||_0x495049===void 0x0?void 0x0:_0x495049['fileInfo'],'answer':(_0x495049===null||_0x495049===void 0x0?void 0x0:_0x495049['answer'])||_0x1d15bc,'progress':_0x30a793(0xf2),'status':0x3,'taskId':_0x495049===null||_0x495049===void 0x0?void 0x0:_0x495049[_0x30a793(0xac)],'taskData':_0x495049===null||_0x495049===void 0x0?void 0x0:_0x495049[_0x30a793(0xc1)]}),common_1[_0x30a793(0xf8)][_0x30a793(0xd7)](_0x30a793(0xff),'LumaService');}catch(_0x3993cb){common_1['Logger']['error'](_0x30a793(0xcf)+_0x3993cb[_0x30a793(0xd0)],_0x30a793(0xb9));}},'onGenerating':async _0x3853f3=>{const _0x87f5dc=_0x2eee7a;try{await this[_0x87f5dc(0xb7)][_0x87f5dc(0xd6)](_0xb65427,{'videoUrl':_0x3853f3===null||_0x3853f3===void 0x0?void 0x0:_0x3853f3['videoUrl'],'audioUrl':_0x3853f3===null||_0x3853f3===void 0x0?void 0x0:_0x3853f3[_0x87f5dc(0xf3)],'fileInfo':_0x3853f3===null||_0x3853f3===void 0x0?void 0x0:_0x3853f3[_0x87f5dc(0xc0)],'answer':(_0x3853f3===null||_0x3853f3===void 0x0?void 0x0:_0x3853f3['answer'])||_0x87f5dc(0xe5),'progress':_0x3853f3===null||_0x3853f3===void 0x0?void 0x0:_0x3853f3[_0x87f5dc(0xb4)],'status':_0x3853f3[_0x87f5dc(0xf6)]}),common_1[_0x87f5dc(0xf8)]['log'](_0x87f5dc(0xe5),_0x87f5dc(0xb9));}catch(_0x422b0f){common_1[_0x87f5dc(0xf8)][_0x87f5dc(0xbb)]('更新日志失败:\x20'+_0x422b0f[_0x87f5dc(0xd0)],_0x87f5dc(0xb9));}},'onFailure':async _0x450340=>{const _0x456091=_0x2eee7a;try{await this[_0x456091(0xb7)][_0x456091(0xd6)](_0xb65427,{'answer':'视频生成失败','status':_0x450340[_0x456091(0xf6)]}),common_1[_0x456091(0xf8)][_0x456091(0xd7)](_0x456091(0xe3),_0x456091(0xba));}catch(_0x39f040){common_1[_0x456091(0xf8)][_0x456091(0xbb)](_0x456091(0xcf)+_0x39f040[_0x456091(0xd0)],_0x456091(0xb9));}}});}catch(_0x4ae23d){common_1[_0x2eee7a(0xf8)][_0x2eee7a(0xbb)](_0x2eee7a(0xec),_0x4ae23d['message'],'LumaService');throw new Error(_0x2eee7a(0xd4));}return _0x5cffc6;}async[_0x47619a(0xeb)](_0x2d3274){const _0x22eeca=_0x47619a,{proxyUrl:_0x67a0a2,apiKey:_0x4aa498,taskId:_0x546ae4,timeout:_0x56177d,onSuccess:_0x233076,onFailure:_0x2b4e5f,onGenerating:_0x42d184,action:_0xd2f880}=_0x2d3274;let _0x1f3f8f={'videoUrl':'','audioUrl':'','fileInfo':'','drawId':'','taskData':'','status':0x2,'progress':0x0,'answer':''};const _0x2c1305={'Authorization':_0x22eeca(0xc2)+_0x4aa498},_0x338d12=_0x67a0a2+_0x22eeca(0xf5)+_0x546ae4,_0x275547=Date[_0x22eeca(0xc4)](),_0x27e69e=0x493e0,_0x1ddef6=0x1388;let _0x221d48=0x0;try{while(Date[_0x22eeca(0xc4)]()-_0x275547<_0x56177d){await new Promise(_0x24fcaa=>setTimeout(_0x24fcaa,_0x1ddef6));try{const _0x4a27ce=await axios_1[_0x22eeca(0xda)][_0x22eeca(0xd5)](_0x338d12,{'headers':_0x2c1305}),_0x2d058f=setInterval(()=>{const _0xbec62f=_0x22eeca,_0x255b4b=Date['now']()-_0x275547;let _0x426278=Math[_0xbec62f(0xd2)](_0x255b4b/_0x27e69e*0x64);if(_0x426278>=0x63)_0x426278=0x63;_0x1f3f8f[_0xbec62f(0xc5)]=_0xbec62f(0xee)+_0x426278+'%）';},0x3e8),_0xd609f=_0x4a27ce[_0x22eeca(0xad)];common_1[_0x22eeca(0xf8)][_0x22eeca(0xb5)](_0x22eeca(0xb8)+JSON[_0x22eeca(0xfb)](_0xd609f),_0x22eeca(0xb9));if(_0xd609f[_0x22eeca(0xfa)]===_0x22eeca(0xe2)){_0x1f3f8f[_0x22eeca(0xac)]=_0xd609f['id'],_0x1f3f8f[_0x22eeca(0xc1)]=JSON[_0x22eeca(0xfb)](_0xd609f),_0x1f3f8f[_0x22eeca(0xc0)]=_0xd609f[_0x22eeca(0x100)]['url'];try{const _0x189613=await this['globalConfigService']['getConfigs'](['localStorageStatus']);if(Number(_0x189613)){const _0x3a3f06=new Date(),_0x2d2042=_0x3a3f06['getFullYear'](),_0x3e3479=String(_0x3a3f06[_0x22eeca(0xf9)]()+0x1)[_0x22eeca(0xfc)](0x2,'0'),_0x591788=String(_0x3a3f06[_0x22eeca(0x102)]())[_0x22eeca(0xfc)](0x2,'0'),_0xe7077d=''+_0x2d2042+_0x3e3479+'/'+_0x591788;_0x1f3f8f['fileInfo']=await this['uploadService'][_0x22eeca(0xc3)]({'url':_0xd609f[_0x22eeca(0x100)][_0x22eeca(0x101)],'dir':_0x22eeca(0xe1)+_0xe7077d});}}catch(_0x1320ee){common_1[_0x22eeca(0xf8)][_0x22eeca(0xbb)](_0x22eeca(0xca)+_0x1320ee[_0x22eeca(0xd0)],_0x22eeca(0xb9));}_0x1f3f8f['answer']=_0x22eeca(0xce)+_0xd609f[_0x22eeca(0xdf)]+'\x22',_0x233076(_0x1f3f8f),clearInterval(_0x2d058f);return;}else _0x42d184(_0x1f3f8f);if(_0x1f3f8f[_0x22eeca(0xb4)]){}}catch(_0x4a6ec2){_0x221d48++,common_1['Logger'][_0x22eeca(0xbb)]('轮询失败，重试次数:\x20'+_0x221d48,_0x22eeca(0xb9));}}common_1[_0x22eeca(0xf8)]['error'](_0x22eeca(0xe9),_0x22eeca(0xb9)),_0x1f3f8f[_0x22eeca(0xf6)]=0x4,_0x2b4e5f(_0x1f3f8f);throw new Error(_0x22eeca(0xb6));}catch(_0x2a3f74){common_1[_0x22eeca(0xf8)][_0x22eeca(0xbb)](_0x22eeca(0xc7)+_0x2a3f74,'LumaService'),_0x1f3f8f[_0x22eeca(0xf6)]=0x5,_0x2b4e5f(_0x1f3f8f);}}};LumaVideoService=__decorate([(0x0,common_1[_0x47619a(0xf0)])(),__metadata(_0x47619a(0xdd),[chatLog_service_1['ChatLogService'],globalConfig_service_1[_0x47619a(0xbe)],upload_service_1[_0x47619a(0xb3)]])],LumaVideoService),exports['LumaVideoService']=LumaVideoService;