'use strict';function _0x4dcc(_0x4a9305,_0x5ef6fd){const _0x54b712=_0x54b7();return _0x4dcc=function(_0x4dcca5,_0x15cc97){_0x4dcca5=_0x4dcca5-0xdd;let _0x54e10a=_0x54b712[_0x4dcca5];return _0x54e10a;},_0x4dcc(_0x4a9305,_0x5ef6fd);}const _0x2d2a9b=_0x4dcc;(function(_0x643aa,_0x2754b2){const _0x18bcc4=_0x4dcc,_0x1aee4e=_0x643aa();while(!![]){try{const _0x21f13b=parseInt(_0x18bcc4(0x105))/0x1+-parseInt(_0x18bcc4(0x111))/0x2*(parseInt(_0x18bcc4(0x121))/0x3)+parseInt(_0x18bcc4(0xfe))/0x4+-parseInt(_0x18bcc4(0xf4))/0x5+parseInt(_0x18bcc4(0x132))/0x6*(-parseInt(_0x18bcc4(0xfd))/0x7)+-parseInt(_0x18bcc4(0x11f))/0x8+-parseInt(_0x18bcc4(0xed))/0x9*(-parseInt(_0x18bcc4(0xf0))/0xa);if(_0x21f13b===_0x2754b2)break;else _0x1aee4e['push'](_0x1aee4e['shift']());}catch(_0xbccc3a){_0x1aee4e['push'](_0x1aee4e['shift']());}}}(_0x54b7,0xb00aa));var __decorate=this&&this[_0x2d2a9b(0x11c)]||function(_0x5a9d73,_0x1a17e6,_0x101f2c,_0x15a4c8){const _0x45cc55=_0x2d2a9b;var _0x180b67=arguments[_0x45cc55(0x12b)],_0x4ba5f3=_0x180b67<0x3?_0x1a17e6:_0x15a4c8===null?_0x15a4c8=Object[_0x45cc55(0xf8)](_0x1a17e6,_0x101f2c):_0x15a4c8,_0x5edfd6;if(typeof Reflect==='object'&&typeof Reflect[_0x45cc55(0x110)]===_0x45cc55(0x11e))_0x4ba5f3=Reflect['decorate'](_0x5a9d73,_0x1a17e6,_0x101f2c,_0x15a4c8);else{for(var _0x5dd06d=_0x5a9d73[_0x45cc55(0x12b)]-0x1;_0x5dd06d>=0x0;_0x5dd06d--)if(_0x5edfd6=_0x5a9d73[_0x5dd06d])_0x4ba5f3=(_0x180b67<0x3?_0x5edfd6(_0x4ba5f3):_0x180b67>0x3?_0x5edfd6(_0x1a17e6,_0x101f2c,_0x4ba5f3):_0x5edfd6(_0x1a17e6,_0x101f2c))||_0x4ba5f3;}return _0x180b67>0x3&&_0x4ba5f3&&Object[_0x45cc55(0x117)](_0x1a17e6,_0x101f2c,_0x4ba5f3),_0x4ba5f3;},__metadata=this&&this[_0x2d2a9b(0xfc)]||function(_0xc856ae,_0x2a1d8e){const _0x306ea0=_0x2d2a9b;if(typeof Reflect===_0x306ea0(0x128)&&typeof Reflect[_0x306ea0(0x123)]===_0x306ea0(0x11e))return Reflect[_0x306ea0(0x123)](_0xc856ae,_0x2a1d8e);};Object['defineProperty'](exports,_0x2d2a9b(0xfa),{'value':!![]}),exports[_0x2d2a9b(0x119)]=void 0x0;function _0x54b7(){const _0x752a0=['视频任务已完成','视频生成失败','1065763YHkVlg','updateChatLog','completed','axios','/luma/generations/','audioUrl','pollLumaVideoResult','design:paramtypes','getDate','video/luma/','debug','decorate','8cNzKVs','LumaService','download_url','stringify','Injectable','padStart','defineProperty','任务提交成功,\x20任务ID:\x20','LumaVideoService','100%','error','__decorate','轮询过程中发生错误:\x20','function','5397616CJVEPv','default','663357aVCcPc','image_url','metadata','轮询结果:\x20','video','GlobalConfigService','now','object','轮询失败，重试次数:\x20','floor','length','get','../chatLog/chatLog.service','更新日志失败:\x20','fileInfo','answer','16:9','4627284YwRcXv','查询生成结果时发生错误:','size','getFullYear','log','url','uploadService','提示词:\x20\x22','message','正在准备发送请求到\x20','@nestjs/common','taskId','videoUrl','未能获取结果数据,\x20即将重试','上传文件失败:\x20','data','查询超时，请稍后再试！','prompt','localStorageStatus','lumaVideo','../globalConfig/globalConfig.service','progress','视频生成中...','9KxBOec','任务提交失败','status','16007820KwZmQk','，payload:\x20','chatLogService','../upload/upload.service','826740qHBjNU','taskData','Logger','state','getOwnPropertyDescriptor',',\x20headers:\x20','__esModule','视频生成中\x20（','__metadata','7BYXELY','2201044uTGTgf','globalConfigService','uploadFileFromUrl','Bearer\x20','Lum\x20aService'];_0x54b7=function(){return _0x752a0;};return _0x54b7();}const common_1=require(_0x2d2a9b(0xe0)),axios_1=require(_0x2d2a9b(0x108)),chatLog_service_1=require(_0x2d2a9b(0x12d)),globalConfig_service_1=require(_0x2d2a9b(0xea)),upload_service_1=require(_0x2d2a9b(0xf3));let LumaVideoService=class LumaVideoService{constructor(_0x4ec197,_0x25b612,_0x22ff8d){const _0x89f1d0=_0x2d2a9b;this['chatLogService']=_0x4ec197,this[_0x89f1d0(0xff)]=_0x25b612,this[_0x89f1d0(0x138)]=_0x22ff8d;}async[_0x2d2a9b(0xe9)](_0xa4e119){const _0xce846e=_0x2d2a9b;var _0xf0f560,_0x2e1ae7,_0x1c7dd8;const {apiKey:_0x315ff5,proxyUrl:_0x1ab4cb,fileInfo:_0x41277f,prompt:_0x6421f5,timeout:_0x281c6b,assistantLogId:_0x42638f,extraParam:_0x5befb1}=_0xa4e119;let _0xf9ecf={'text':'','fileInfo':'','taskId':'','taskData':'','status':0x2},_0x1e3572=null,_0x4ad29a='',_0x1cdf6c={};const _0x324321={'Authorization':_0xce846e(0x101)+_0x315ff5};_0x4ad29a=_0x1ab4cb+_0xce846e(0x109);const _0x5f1bba=_0x5befb1[_0xce846e(0x134)]||_0xce846e(0x131);_0x1cdf6c={'user_prompt':_0x6421f5,'aspect_ratio':_0x5f1bba,'expand_prompt':!![]};_0x41277f&&(_0x1cdf6c[_0xce846e(0x122)]=_0x41277f);common_1[_0xce846e(0xf6)]['log'](_0xce846e(0xdf)+_0x4ad29a+_0xce846e(0xf1)+JSON[_0xce846e(0x114)](_0x1cdf6c)+_0xce846e(0xf9)+JSON[_0xce846e(0x114)](_0x324321),_0xce846e(0x112));try{_0x1e3572=await axios_1[_0xce846e(0x120)]['post'](_0x4ad29a,_0x1cdf6c,{'headers':_0x324321});}catch(_0x11236b){common_1[_0xce846e(0xf6)]['error']('任务提交失败:\x20'+_0x11236b[_0xce846e(0xde)],_0xce846e(0x112));throw new Error(_0xce846e(0xee));}if((_0xf0f560=_0x1e3572===null||_0x1e3572===void 0x0?void 0x0:_0x1e3572[_0xce846e(0xe5)])===null||_0xf0f560===void 0x0?void 0x0:_0xf0f560['id'])_0xf9ecf[_0xce846e(0xe1)]=(_0x2e1ae7=_0x1e3572===null||_0x1e3572===void 0x0?void 0x0:_0x1e3572[_0xce846e(0xe5)])===null||_0x2e1ae7===void 0x0?void 0x0:_0x2e1ae7['id'],common_1[_0xce846e(0xf6)]['log'](_0xce846e(0x118)+((_0x1c7dd8=_0x1e3572===null||_0x1e3572===void 0x0?void 0x0:_0x1e3572[_0xce846e(0xe5)])===null||_0x1c7dd8===void 0x0?void 0x0:_0x1c7dd8['id']),_0xce846e(0x112));else throw new Error(_0xce846e(0xe3));try{await this[_0xce846e(0x10b)]({'proxyUrl':_0x1ab4cb,'apiKey':_0x315ff5,'taskId':_0x1e3572[_0xce846e(0xe5)]['id'],'timeout':_0x281c6b,'prompt':_0x6421f5,'onSuccess':async _0x4226eb=>{const _0xa62585=_0xce846e;try{await this[_0xa62585(0xf2)][_0xa62585(0x106)](_0x42638f,{'videoUrl':_0x4226eb===null||_0x4226eb===void 0x0?void 0x0:_0x4226eb[_0xa62585(0xe2)],'audioUrl':_0x4226eb===null||_0x4226eb===void 0x0?void 0x0:_0x4226eb[_0xa62585(0x10a)],'fileInfo':_0x4226eb===null||_0x4226eb===void 0x0?void 0x0:_0x4226eb[_0xa62585(0x12f)],'answer':(_0x4226eb===null||_0x4226eb===void 0x0?void 0x0:_0x4226eb[_0xa62585(0x130)])||_0x6421f5,'progress':_0xa62585(0x11a),'status':0x3,'taskId':_0x4226eb===null||_0x4226eb===void 0x0?void 0x0:_0x4226eb[_0xa62585(0xe1)],'taskData':_0x4226eb===null||_0x4226eb===void 0x0?void 0x0:_0x4226eb[_0xa62585(0xf5)]}),common_1[_0xa62585(0xf6)]['log'](_0xa62585(0x103),_0xa62585(0x112));}catch(_0x1bca03){common_1[_0xa62585(0xf6)][_0xa62585(0x11b)](_0xa62585(0x12e)+_0x1bca03['message'],'LumaService');}},'onGenerating':async _0x20e734=>{const _0x4aa182=_0xce846e;try{await this[_0x4aa182(0xf2)][_0x4aa182(0x106)](_0x42638f,{'videoUrl':_0x20e734===null||_0x20e734===void 0x0?void 0x0:_0x20e734[_0x4aa182(0xe2)],'audioUrl':_0x20e734===null||_0x20e734===void 0x0?void 0x0:_0x20e734[_0x4aa182(0x10a)],'fileInfo':_0x20e734===null||_0x20e734===void 0x0?void 0x0:_0x20e734[_0x4aa182(0x12f)],'answer':(_0x20e734===null||_0x20e734===void 0x0?void 0x0:_0x20e734[_0x4aa182(0x130)])||_0x4aa182(0xec),'progress':_0x20e734===null||_0x20e734===void 0x0?void 0x0:_0x20e734[_0x4aa182(0xeb)],'status':_0x20e734['status']}),common_1[_0x4aa182(0xf6)][_0x4aa182(0x136)](_0x4aa182(0xec),_0x4aa182(0x112));}catch(_0x24c209){common_1[_0x4aa182(0xf6)]['error']('更新日志失败:\x20'+_0x24c209[_0x4aa182(0xde)],_0x4aa182(0x112));}},'onFailure':async _0x2beca1=>{const _0x457424=_0xce846e;try{await this[_0x457424(0xf2)][_0x457424(0x106)](_0x42638f,{'answer':_0x457424(0x104),'status':_0x2beca1[_0x457424(0xef)]}),common_1[_0x457424(0xf6)]['log']('生成失败',_0x457424(0x102));}catch(_0x472886){common_1['Logger'][_0x457424(0x11b)]('更新日志失败:\x20'+_0x472886['message'],_0x457424(0x112));}}});}catch(_0x47d4d8){common_1[_0xce846e(0xf6)]['error'](_0xce846e(0x133),_0x47d4d8[_0xce846e(0xde)],_0xce846e(0x112));throw new Error('查询生成结果时发生错误');}return _0xf9ecf;}async['pollLumaVideoResult'](_0x572825){const _0x28351a=_0x2d2a9b,{proxyUrl:_0x53d87a,apiKey:_0x225311,taskId:_0x5ecc9c,timeout:_0x27f4a3,onSuccess:_0x3bd628,onFailure:_0x18d3b6,onGenerating:_0x365bac,action:_0x15d721}=_0x572825;let _0xff4a75={'videoUrl':'','audioUrl':'','fileInfo':'','drawId':'','taskData':'','status':0x2,'progress':0x0,'answer':''};const _0x22f95a={'Authorization':_0x28351a(0x101)+_0x225311},_0x1fcbeb=_0x53d87a+'/luma/generations/'+_0x5ecc9c,_0x47e968=Date[_0x28351a(0x127)](),_0x5da156=0x493e0,_0x256cb7=0x1388;let _0x3c1894=0x0;try{while(Date['now']()-_0x47e968<_0x27f4a3){await new Promise(_0x13b07c=>setTimeout(_0x13b07c,_0x256cb7));try{const _0x9c888c=await axios_1['default'][_0x28351a(0x12c)](_0x1fcbeb,{'headers':_0x22f95a}),_0x2bd442=setInterval(()=>{const _0x5c733a=_0x28351a,_0x526214=Date['now']()-_0x47e968;let _0x1fe7b2=Math[_0x5c733a(0x12a)](_0x526214/_0x5da156*0x64);if(_0x1fe7b2>=0x63)_0x1fe7b2=0x63;_0xff4a75['answer']=_0x5c733a(0xfb)+_0x1fe7b2+'%）';},0x3e8),_0x39d3bd=_0x9c888c[_0x28351a(0xe5)];common_1['Logger'][_0x28351a(0x10f)](_0x28351a(0x124)+JSON['stringify'](_0x39d3bd),'LumaService');if(_0x39d3bd[_0x28351a(0xf7)]===_0x28351a(0x107)){_0xff4a75[_0x28351a(0xe1)]=_0x39d3bd['id'],_0xff4a75['taskData']=JSON[_0x28351a(0x114)](_0x39d3bd),_0xff4a75[_0x28351a(0x12f)]=_0x39d3bd[_0x28351a(0x125)][_0x28351a(0x137)];try{const _0x267bbc=await this[_0x28351a(0xff)]['getConfigs']([_0x28351a(0xe8)]);if(Number(_0x267bbc)){const _0x406000=new Date(),_0x351604=_0x406000[_0x28351a(0x135)](),_0x5acf1b=String(_0x406000['getMonth']()+0x1)[_0x28351a(0x116)](0x2,'0'),_0xbc0015=String(_0x406000[_0x28351a(0x10d)]())[_0x28351a(0x116)](0x2,'0'),_0x12ad27=''+_0x351604+_0x5acf1b+'/'+_0xbc0015;_0xff4a75[_0x28351a(0x12f)]=await this[_0x28351a(0x138)][_0x28351a(0x100)]({'url':_0x39d3bd[_0x28351a(0x125)][_0x28351a(0x113)],'dir':_0x28351a(0x10e)+_0x12ad27});}}catch(_0x738be8){common_1[_0x28351a(0xf6)][_0x28351a(0x11b)](_0x28351a(0xe4)+_0x738be8['message'],'LumaService');}_0xff4a75[_0x28351a(0x130)]=_0x28351a(0xdd)+_0x39d3bd[_0x28351a(0xe7)]+'\x22',_0x3bd628(_0xff4a75),clearInterval(_0x2bd442);return;}else _0x365bac(_0xff4a75);if(_0xff4a75[_0x28351a(0xeb)]){}}catch(_0x3584d9){_0x3c1894++,common_1['Logger'][_0x28351a(0x11b)](_0x28351a(0x129)+_0x3c1894,_0x28351a(0x112));}}common_1[_0x28351a(0xf6)][_0x28351a(0x11b)]('轮询超时，请稍后再试！',_0x28351a(0x112)),_0xff4a75[_0x28351a(0xef)]=0x4,_0x18d3b6(_0xff4a75);throw new Error(_0x28351a(0xe6));}catch(_0x42126b){common_1[_0x28351a(0xf6)][_0x28351a(0x11b)](_0x28351a(0x11d)+_0x42126b,_0x28351a(0x112)),_0xff4a75[_0x28351a(0xef)]=0x5,_0x18d3b6(_0xff4a75);}}};LumaVideoService=__decorate([(0x0,common_1[_0x2d2a9b(0x115)])(),__metadata(_0x2d2a9b(0x10c),[chatLog_service_1['ChatLogService'],globalConfig_service_1[_0x2d2a9b(0x126)],upload_service_1['UploadService']])],LumaVideoService),exports[_0x2d2a9b(0x119)]=LumaVideoService;