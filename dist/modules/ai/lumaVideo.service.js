'use strict';const _0x39df7f=_0x4938;(function(_0x426999,_0x23ab55){const _0x1b9071=_0x4938,_0x43c170=_0x426999();while(!![]){try{const _0x4ab2ab=parseInt(_0x1b9071(0xbd))/0x1+-parseInt(_0x1b9071(0x9c))/0x2*(parseInt(_0x1b9071(0x7d))/0x3)+parseInt(_0x1b9071(0xa1))/0x4+parseInt(_0x1b9071(0xab))/0x5+-parseInt(_0x1b9071(0x8a))/0x6+-parseInt(_0x1b9071(0x98))/0x7+-parseInt(_0x1b9071(0xb9))/0x8;if(_0x4ab2ab===_0x23ab55)break;else _0x43c170['push'](_0x43c170['shift']());}catch(_0x1d1ad7){_0x43c170['push'](_0x43c170['shift']());}}}(_0x2cbc,0x3a2f5));function _0x4938(_0x366341,_0x394ae6){const _0x2cbc11=_0x2cbc();return _0x4938=function(_0x493833,_0x4c3474){_0x493833=_0x493833-0x76;let _0x4872a0=_0x2cbc11[_0x493833];return _0x4872a0;},_0x4938(_0x366341,_0x394ae6);}var __decorate=this&&this[_0x39df7f(0x8c)]||function(_0x198878,_0x2797ac,_0x2ecf9f,_0x17eca1){const _0x1861de=_0x39df7f;var _0x5d28ee=arguments[_0x1861de(0xae)],_0x2a8385=_0x5d28ee<0x3?_0x2797ac:_0x17eca1===null?_0x17eca1=Object[_0x1861de(0xac)](_0x2797ac,_0x2ecf9f):_0x17eca1,_0xc24569;if(typeof Reflect===_0x1861de(0x88)&&typeof Reflect['decorate']==='function')_0x2a8385=Reflect['decorate'](_0x198878,_0x2797ac,_0x2ecf9f,_0x17eca1);else{for(var _0x3c2f9e=_0x198878['length']-0x1;_0x3c2f9e>=0x0;_0x3c2f9e--)if(_0xc24569=_0x198878[_0x3c2f9e])_0x2a8385=(_0x5d28ee<0x3?_0xc24569(_0x2a8385):_0x5d28ee>0x3?_0xc24569(_0x2797ac,_0x2ecf9f,_0x2a8385):_0xc24569(_0x2797ac,_0x2ecf9f))||_0x2a8385;}return _0x5d28ee>0x3&&_0x2a8385&&Object['defineProperty'](_0x2797ac,_0x2ecf9f,_0x2a8385),_0x2a8385;},__metadata=this&&this[_0x39df7f(0x8b)]||function(_0x3a5b03,_0x21505f){const _0x1f16ba=_0x39df7f;if(typeof Reflect===_0x1f16ba(0x88)&&typeof Reflect[_0x1f16ba(0x96)]===_0x1f16ba(0xa3))return Reflect['metadata'](_0x3a5b03,_0x21505f);};Object['defineProperty'](exports,_0x39df7f(0xb5),{'value':!![]}),exports['LumaVideoService']=void 0x0;const common_1=require('@nestjs/common'),axios_1=require(_0x39df7f(0x8e)),chatLog_service_1=require(_0x39df7f(0x86)),globalConfig_service_1=require(_0x39df7f(0xb4)),upload_service_1=require(_0x39df7f(0xb7));function _0x2cbc(){const _0x1315ad=['data','上传文件失败:\x20','getMonth','taskData','video/luma/',',\x20headers:\x20','status','2355200USWJYR','getOwnPropertyDescriptor','answer','length','getConfigs','更新日志失败:\x20','，payload:\x20','state','轮询结果:\x20','../globalConfig/globalConfig.service','__esModule','error','../upload/upload.service','查询超时，请稍后再试！','2666040ffjmKm','progress','stringify','视频生成失败','409075lBkmYF','Bearer\x20','padStart','videoUrl','getDate','LumaService','lumaVideo','pollLumaVideoResult','updateChatLog','log','LumaVideoService','256377YZCaRJ','16:9','uploadFileFromUrl','uploadService','查询生成结果时发生错误','now','Logger','提示词:\x20\x22','轮询失败，重试次数:\x20','../chatLog/chatLog.service','视频任务已完成','object','debug','1015686WHonSy','__metadata','__decorate','轮询过程中发生错误:\x20','axios','default','message','轮询超时，请稍后再试！','Injectable','design:paramtypes','fileInfo','Lum\x20aService','metadata','taskId','957628HcmZIP','audioUrl','ChatLogService','size','2dZdQAP','floor','UploadService','视频生成中...','任务提交失败:\x20','332036pxfFPa','chatLogService','function'];_0x2cbc=function(){return _0x1315ad;};return _0x2cbc();}let LumaVideoService=class LumaVideoService{constructor(_0x28b325,_0x14fb38,_0x548c0a){const _0x16183e=_0x39df7f;this['chatLogService']=_0x28b325,this['globalConfigService']=_0x14fb38,this[_0x16183e(0x80)]=_0x548c0a;}async[_0x39df7f(0x78)](_0x4f7ad2){const _0xa88f28=_0x39df7f;var _0x3fbe98,_0x5d896d,_0x59e3c3;const {apiKey:_0x1b53b6,proxyUrl:_0x1af911,fileInfo:_0x152214,prompt:_0x2c8501,timeout:_0x527244,assistantLogId:_0x16424d,extraParam:_0x8788c6}=_0x4f7ad2;let _0x2dbba1={'text':'','fileInfo':'','taskId':'','taskData':'','status':0x2},_0x17ab17=null,_0xd8776a='',_0x5a9772={};const _0x35c740={'Authorization':_0xa88f28(0xbe)+_0x1b53b6};_0xd8776a=_0x1af911+'/luma/generations/';const _0x1361f7=_0x8788c6[_0xa88f28(0x9b)]||_0xa88f28(0x7e);_0x5a9772={'user_prompt':_0x2c8501,'aspect_ratio':_0x1361f7,'expand_prompt':!![]};_0x152214&&(_0x5a9772['image_url']=_0x152214);common_1['Logger']['log']('正在准备发送请求到\x20'+_0xd8776a+_0xa88f28(0xb1)+JSON[_0xa88f28(0xbb)](_0x5a9772)+_0xa88f28(0xa9)+JSON[_0xa88f28(0xbb)](_0x35c740),'LumaService');try{_0x17ab17=await axios_1[_0xa88f28(0x8f)]['post'](_0xd8776a,_0x5a9772,{'headers':_0x35c740});}catch(_0x5ecfe9){common_1[_0xa88f28(0x83)]['error'](_0xa88f28(0xa0)+_0x5ecfe9[_0xa88f28(0x90)],_0xa88f28(0x77));throw new Error('任务提交失败');}if((_0x3fbe98=_0x17ab17===null||_0x17ab17===void 0x0?void 0x0:_0x17ab17[_0xa88f28(0xa4)])===null||_0x3fbe98===void 0x0?void 0x0:_0x3fbe98['id'])_0x2dbba1['taskId']=(_0x5d896d=_0x17ab17===null||_0x17ab17===void 0x0?void 0x0:_0x17ab17[_0xa88f28(0xa4)])===null||_0x5d896d===void 0x0?void 0x0:_0x5d896d['id'],common_1[_0xa88f28(0x83)]['log']('任务提交成功,\x20任务ID:\x20'+((_0x59e3c3=_0x17ab17===null||_0x17ab17===void 0x0?void 0x0:_0x17ab17['data'])===null||_0x59e3c3===void 0x0?void 0x0:_0x59e3c3['id']),_0xa88f28(0x77));else throw new Error('未能获取结果数据,\x20即将重试');try{await this[_0xa88f28(0x79)]({'proxyUrl':_0x1af911,'apiKey':_0x1b53b6,'taskId':_0x17ab17[_0xa88f28(0xa4)]['id'],'timeout':_0x527244,'prompt':_0x2c8501,'onSuccess':async _0x277008=>{const _0x4d672e=_0xa88f28;try{await this[_0x4d672e(0xa2)][_0x4d672e(0x7a)](_0x16424d,{'videoUrl':_0x277008===null||_0x277008===void 0x0?void 0x0:_0x277008[_0x4d672e(0xc0)],'audioUrl':_0x277008===null||_0x277008===void 0x0?void 0x0:_0x277008[_0x4d672e(0x99)],'fileInfo':_0x277008===null||_0x277008===void 0x0?void 0x0:_0x277008['fileInfo'],'answer':(_0x277008===null||_0x277008===void 0x0?void 0x0:_0x277008['answer'])||_0x2c8501,'progress':'100%','status':0x3,'taskId':_0x277008===null||_0x277008===void 0x0?void 0x0:_0x277008[_0x4d672e(0x97)],'taskData':_0x277008===null||_0x277008===void 0x0?void 0x0:_0x277008[_0x4d672e(0xa7)]}),common_1[_0x4d672e(0x83)][_0x4d672e(0x7b)](_0x4d672e(0x87),_0x4d672e(0x77));}catch(_0x11e2a8){common_1[_0x4d672e(0x83)][_0x4d672e(0xb6)]('更新日志失败:\x20'+_0x11e2a8[_0x4d672e(0x90)],_0x4d672e(0x77));}},'onGenerating':async _0x47c9a7=>{const _0x33ec27=_0xa88f28;try{await this[_0x33ec27(0xa2)][_0x33ec27(0x7a)](_0x16424d,{'videoUrl':_0x47c9a7===null||_0x47c9a7===void 0x0?void 0x0:_0x47c9a7[_0x33ec27(0xc0)],'audioUrl':_0x47c9a7===null||_0x47c9a7===void 0x0?void 0x0:_0x47c9a7['audioUrl'],'fileInfo':_0x47c9a7===null||_0x47c9a7===void 0x0?void 0x0:_0x47c9a7['fileInfo'],'answer':(_0x47c9a7===null||_0x47c9a7===void 0x0?void 0x0:_0x47c9a7[_0x33ec27(0xad)])||_0x33ec27(0x9f),'progress':_0x47c9a7===null||_0x47c9a7===void 0x0?void 0x0:_0x47c9a7[_0x33ec27(0xba)],'status':_0x47c9a7[_0x33ec27(0xaa)]}),common_1[_0x33ec27(0x83)][_0x33ec27(0x7b)](_0x33ec27(0x9f),_0x33ec27(0x77));}catch(_0x54f0e1){common_1[_0x33ec27(0x83)][_0x33ec27(0xb6)](_0x33ec27(0xb0)+_0x54f0e1[_0x33ec27(0x90)],_0x33ec27(0x77));}},'onFailure':async _0x58bb7c=>{const _0x2830c4=_0xa88f28;try{await this[_0x2830c4(0xa2)][_0x2830c4(0x7a)](_0x16424d,{'answer':_0x2830c4(0xbc),'status':_0x58bb7c[_0x2830c4(0xaa)]}),common_1[_0x2830c4(0x83)]['log']('生成失败',_0x2830c4(0x95));}catch(_0x3987c6){common_1[_0x2830c4(0x83)][_0x2830c4(0xb6)](_0x2830c4(0xb0)+_0x3987c6['message'],'LumaService');}}});}catch(_0x5e48a2){common_1[_0xa88f28(0x83)][_0xa88f28(0xb6)]('查询生成结果时发生错误:',_0x5e48a2[_0xa88f28(0x90)],_0xa88f28(0x77));throw new Error(_0xa88f28(0x81));}return _0x2dbba1;}async[_0x39df7f(0x79)](_0x393356){const _0x152251=_0x39df7f,{proxyUrl:_0x182d4b,apiKey:_0x5c36a3,taskId:_0xd67bdc,timeout:_0x24facc,onSuccess:_0x2a02fe,onFailure:_0x5d9a94,onGenerating:_0x20ef2c,action:_0x16e7ca}=_0x393356;let _0xbabefc={'videoUrl':'','audioUrl':'','fileInfo':'','drawId':'','taskData':'','status':0x2,'progress':0x0,'answer':''};const _0x3fd96c={'Authorization':_0x152251(0xbe)+_0x5c36a3},_0xceb90c=_0x182d4b+'/luma/generations/'+_0xd67bdc,_0x611e48=Date[_0x152251(0x82)](),_0xe1397a=0x493e0,_0x1235e6=0x1388;let _0x32ad51=0x0;try{while(Date['now']()-_0x611e48<_0x24facc){await new Promise(_0x521549=>setTimeout(_0x521549,_0x1235e6));try{const _0x93bfc0=await axios_1[_0x152251(0x8f)]['get'](_0xceb90c,{'headers':_0x3fd96c}),_0x9a2a2=setInterval(()=>{const _0x392490=_0x152251,_0x2688d0=Date[_0x392490(0x82)]()-_0x611e48;let _0x4f8bd4=Math[_0x392490(0x9d)](_0x2688d0/_0xe1397a*0x64);if(_0x4f8bd4>=0x63)_0x4f8bd4=0x63;_0xbabefc[_0x392490(0xad)]='视频生成中\x20（'+_0x4f8bd4+'%）';},0x3e8),_0x154c2d=_0x93bfc0['data'];common_1[_0x152251(0x83)][_0x152251(0x89)](_0x152251(0xb3)+JSON[_0x152251(0xbb)](_0x154c2d),_0x152251(0x77));if(_0x154c2d[_0x152251(0xb2)]==='completed'){_0xbabefc[_0x152251(0x97)]=_0x154c2d['id'],_0xbabefc[_0x152251(0xa7)]=JSON[_0x152251(0xbb)](_0x154c2d),_0xbabefc['fileInfo']=_0x154c2d['video']['url'];try{const _0x544ba6=await this['globalConfigService'][_0x152251(0xaf)](['localStorageStatus']);if(Number(_0x544ba6)){const _0x7113ad=new Date(),_0x3145ff=_0x7113ad['getFullYear'](),_0x59a7d2=String(_0x7113ad[_0x152251(0xa6)]()+0x1)[_0x152251(0xbf)](0x2,'0'),_0x4d45d5=String(_0x7113ad[_0x152251(0x76)]())[_0x152251(0xbf)](0x2,'0'),_0xb52677=''+_0x3145ff+_0x59a7d2+'/'+_0x4d45d5;_0xbabefc[_0x152251(0x94)]=await this[_0x152251(0x80)][_0x152251(0x7f)]({'url':_0x154c2d['video']['download_url'],'dir':_0x152251(0xa8)+_0xb52677});}}catch(_0x1fe5c0){common_1['Logger'][_0x152251(0xb6)](_0x152251(0xa5)+_0x1fe5c0[_0x152251(0x90)],'LumaService');}_0xbabefc['answer']=_0x152251(0x84)+_0x154c2d['prompt']+'\x22',_0x2a02fe(_0xbabefc),clearInterval(_0x9a2a2);return;}else _0x20ef2c(_0xbabefc);if(_0xbabefc[_0x152251(0xba)]){}}catch(_0x198f2a){_0x32ad51++,common_1[_0x152251(0x83)][_0x152251(0xb6)](_0x152251(0x85)+_0x32ad51,'LumaService');}}common_1[_0x152251(0x83)]['error'](_0x152251(0x91),_0x152251(0x77)),_0xbabefc[_0x152251(0xaa)]=0x4,_0x5d9a94(_0xbabefc);throw new Error(_0x152251(0xb8));}catch(_0x10fa08){common_1[_0x152251(0x83)][_0x152251(0xb6)](_0x152251(0x8d)+_0x10fa08,_0x152251(0x77)),_0xbabefc['status']=0x5,_0x5d9a94(_0xbabefc);}}};LumaVideoService=__decorate([(0x0,common_1[_0x39df7f(0x92)])(),__metadata(_0x39df7f(0x93),[chatLog_service_1[_0x39df7f(0x9a)],globalConfig_service_1['GlobalConfigService'],upload_service_1[_0x39df7f(0x9e)]])],LumaVideoService),exports[_0x39df7f(0x7c)]=LumaVideoService;