'use strict';function _0xf95c(_0x59f89f,_0xc2006d){const _0x14de3f=_0x14de();return _0xf95c=function(_0xf95c99,_0x241632){_0xf95c99=_0xf95c99-0x102;let _0x3d3196=_0x14de3f[_0xf95c99];return _0x3d3196;},_0xf95c(_0x59f89f,_0xc2006d);}const _0x735ca3=_0xf95c;(function(_0x37bdc8,_0x3bedaa){const _0x5178da=_0xf95c,_0x1a77c3=_0x37bdc8();while(!![]){try{const _0x11974f=parseInt(_0x5178da(0x116))/0x1*(parseInt(_0x5178da(0x150))/0x2)+parseInt(_0x5178da(0x141))/0x3*(-parseInt(_0x5178da(0x128))/0x4)+-parseInt(_0x5178da(0x114))/0x5+parseInt(_0x5178da(0x11e))/0x6+-parseInt(_0x5178da(0x153))/0x7+parseInt(_0x5178da(0x147))/0x8+-parseInt(_0x5178da(0x127))/0x9*(-parseInt(_0x5178da(0x121))/0xa);if(_0x11974f===_0x3bedaa)break;else _0x1a77c3['push'](_0x1a77c3['shift']());}catch(_0x36823f){_0x1a77c3['push'](_0x1a77c3['shift']());}}}(_0x14de,0x987b7));var __decorate=this&&this[_0x735ca3(0x111)]||function(_0x14bf87,_0x584dee,_0xac1e58,_0x468ced){const _0x137758=_0x735ca3;var _0x3322b3=arguments[_0x137758(0x13a)],_0x10deaf=_0x3322b3<0x3?_0x584dee:_0x468ced===null?_0x468ced=Object['getOwnPropertyDescriptor'](_0x584dee,_0xac1e58):_0x468ced,_0x3b2dd5;if(typeof Reflect===_0x137758(0x10e)&&typeof Reflect[_0x137758(0x107)]===_0x137758(0x14d))_0x10deaf=Reflect['decorate'](_0x14bf87,_0x584dee,_0xac1e58,_0x468ced);else{for(var _0x3a68e3=_0x14bf87[_0x137758(0x13a)]-0x1;_0x3a68e3>=0x0;_0x3a68e3--)if(_0x3b2dd5=_0x14bf87[_0x3a68e3])_0x10deaf=(_0x3322b3<0x3?_0x3b2dd5(_0x10deaf):_0x3322b3>0x3?_0x3b2dd5(_0x584dee,_0xac1e58,_0x10deaf):_0x3b2dd5(_0x584dee,_0xac1e58))||_0x10deaf;}return _0x3322b3>0x3&&_0x10deaf&&Object['defineProperty'](_0x584dee,_0xac1e58,_0x10deaf),_0x10deaf;},__metadata=this&&this[_0x735ca3(0x113)]||function(_0x1a02cd,_0x4a228f){const _0x28b260=_0x735ca3;if(typeof Reflect===_0x28b260(0x10e)&&typeof Reflect[_0x28b260(0x105)]==='function')return Reflect[_0x28b260(0x105)](_0x1a02cd,_0x4a228f);};Object[_0x735ca3(0x13d)](exports,'__esModule',{'value':!![]}),exports[_0x735ca3(0x138)]=void 0x0;function _0x14de(){const _0x4d62ef=['download_url','轮询失败，重试次数:\x20','Logger','object','uploadService','design:paramtypes','__decorate','stringify','__metadata','4361635EcsUzl','视频任务已完成','9LbbYBe','padStart','pollLumaVideoResult','轮询过程中发生错误:\x20','progress','轮询结果:\x20','taskId','100%','962982HjRnET','debug','更新日志失败:\x20','490FNXPwd','查询生成结果时发生错误','completed','post','globalConfigService','status','286866giArPH','1124528dHTjAU','视频生成中...','轮询超时，请稍后再试！','error','/luma/generations/','prompt',',\x20headers:\x20','getFullYear','GlobalConfigService','16:9','getMonth','任务提交失败','LumaService','data','fileInfo','任务提交成功,\x20任务ID:\x20','LumaVideoService','videoUrl','length','message','answer','defineProperty','，payload:\x20','查询生成结果时发生错误:','../globalConfig/globalConfig.service','3iPQwfV','size','audioUrl','Bearer\x20','floor','default','5435816BptIyO','state','视频生成中\x20（','taskData','Injectable','@nestjs/common','function','video','提示词:\x20\x22','71954FuWMhf','updateChatLog','未能获取结果数据,\x20即将重试','6632969PMRwvz','UploadService','image_url','chatLogService','正在准备发送请求到\x20','Lum\x20aService','getDate','任务提交失败:\x20','查询超时，请稍后再试！','log','uploadFileFromUrl','now','metadata','localStorageStatus','decorate','video/luma/','getConfigs','axios'];_0x14de=function(){return _0x4d62ef;};return _0x14de();}const common_1=require(_0x735ca3(0x14c)),axios_1=require(_0x735ca3(0x10a)),chatLog_service_1=require('../chatLog/chatLog.service'),globalConfig_service_1=require(_0x735ca3(0x140)),upload_service_1=require('../upload/upload.service');let LumaVideoService=class LumaVideoService{constructor(_0x279867,_0x30406a,_0x170527){const _0x3347cf=_0x735ca3;this[_0x3347cf(0x156)]=_0x279867,this[_0x3347cf(0x125)]=_0x30406a,this[_0x3347cf(0x10f)]=_0x170527;}async['lumaVideo'](_0x13a699){const _0x329476=_0x735ca3;var _0x26af25,_0x1cd6f9,_0x136bdc;const {apiKey:_0x222a10,proxyUrl:_0x5decb3,fileInfo:_0x19fa90,prompt:_0x2050a4,timeout:_0xe17f,assistantLogId:_0x4ebe32,extraParam:_0x388b41}=_0x13a699;let _0x41832e={'text':'','fileInfo':'','taskId':'','taskData':'','status':0x2},_0x3f5ccb=null,_0xaedcd8='',_0x19ad5b={};const _0x3d6513={'Authorization':'Bearer\x20'+_0x222a10};_0xaedcd8=_0x5decb3+_0x329476(0x12c);const _0x5cd85c=_0x388b41[_0x329476(0x142)]||_0x329476(0x131);_0x19ad5b={'user_prompt':_0x2050a4,'aspect_ratio':_0x5cd85c,'expand_prompt':!![]};_0x19fa90&&(_0x19ad5b[_0x329476(0x155)]=_0x19fa90);common_1[_0x329476(0x10d)][_0x329476(0x102)](_0x329476(0x157)+_0xaedcd8+_0x329476(0x13e)+JSON[_0x329476(0x112)](_0x19ad5b)+_0x329476(0x12e)+JSON[_0x329476(0x112)](_0x3d6513),_0x329476(0x134));try{_0x3f5ccb=await axios_1[_0x329476(0x146)][_0x329476(0x124)](_0xaedcd8,_0x19ad5b,{'headers':_0x3d6513});}catch(_0xd0c090){common_1['Logger'][_0x329476(0x12b)](_0x329476(0x15a)+_0xd0c090['message'],_0x329476(0x134));throw new Error(_0x329476(0x133));}if((_0x26af25=_0x3f5ccb===null||_0x3f5ccb===void 0x0?void 0x0:_0x3f5ccb['data'])===null||_0x26af25===void 0x0?void 0x0:_0x26af25['id'])_0x41832e[_0x329476(0x11c)]=(_0x1cd6f9=_0x3f5ccb===null||_0x3f5ccb===void 0x0?void 0x0:_0x3f5ccb[_0x329476(0x135)])===null||_0x1cd6f9===void 0x0?void 0x0:_0x1cd6f9['id'],common_1[_0x329476(0x10d)][_0x329476(0x102)](_0x329476(0x137)+((_0x136bdc=_0x3f5ccb===null||_0x3f5ccb===void 0x0?void 0x0:_0x3f5ccb[_0x329476(0x135)])===null||_0x136bdc===void 0x0?void 0x0:_0x136bdc['id']),_0x329476(0x134));else throw new Error(_0x329476(0x152));try{await this[_0x329476(0x118)]({'proxyUrl':_0x5decb3,'apiKey':_0x222a10,'taskId':_0x3f5ccb[_0x329476(0x135)]['id'],'timeout':_0xe17f,'prompt':_0x2050a4,'onSuccess':async _0x1d8296=>{const _0x12fc67=_0x329476;try{await this['chatLogService'][_0x12fc67(0x151)](_0x4ebe32,{'videoUrl':_0x1d8296===null||_0x1d8296===void 0x0?void 0x0:_0x1d8296[_0x12fc67(0x139)],'audioUrl':_0x1d8296===null||_0x1d8296===void 0x0?void 0x0:_0x1d8296['audioUrl'],'fileInfo':_0x1d8296===null||_0x1d8296===void 0x0?void 0x0:_0x1d8296[_0x12fc67(0x136)],'answer':(_0x1d8296===null||_0x1d8296===void 0x0?void 0x0:_0x1d8296[_0x12fc67(0x13c)])||_0x2050a4,'progress':_0x12fc67(0x11d),'status':0x3,'taskId':_0x1d8296===null||_0x1d8296===void 0x0?void 0x0:_0x1d8296[_0x12fc67(0x11c)],'taskData':_0x1d8296===null||_0x1d8296===void 0x0?void 0x0:_0x1d8296[_0x12fc67(0x14a)]}),common_1[_0x12fc67(0x10d)][_0x12fc67(0x102)](_0x12fc67(0x115),'LumaService');}catch(_0x204130){common_1['Logger']['error'](_0x12fc67(0x120)+_0x204130[_0x12fc67(0x13b)],'LumaService');}},'onGenerating':async _0x3ebf1e=>{const _0x3bd391=_0x329476;try{await this[_0x3bd391(0x156)][_0x3bd391(0x151)](_0x4ebe32,{'videoUrl':_0x3ebf1e===null||_0x3ebf1e===void 0x0?void 0x0:_0x3ebf1e[_0x3bd391(0x139)],'audioUrl':_0x3ebf1e===null||_0x3ebf1e===void 0x0?void 0x0:_0x3ebf1e[_0x3bd391(0x143)],'fileInfo':_0x3ebf1e===null||_0x3ebf1e===void 0x0?void 0x0:_0x3ebf1e[_0x3bd391(0x136)],'answer':(_0x3ebf1e===null||_0x3ebf1e===void 0x0?void 0x0:_0x3ebf1e[_0x3bd391(0x13c)])||_0x3bd391(0x129),'progress':_0x3ebf1e===null||_0x3ebf1e===void 0x0?void 0x0:_0x3ebf1e[_0x3bd391(0x11a)],'status':_0x3ebf1e[_0x3bd391(0x126)]}),common_1[_0x3bd391(0x10d)][_0x3bd391(0x102)](_0x3bd391(0x129),_0x3bd391(0x134));}catch(_0x5cd378){common_1[_0x3bd391(0x10d)][_0x3bd391(0x12b)](_0x3bd391(0x120)+_0x5cd378['message'],'LumaService');}},'onFailure':async _0x9942ac=>{const _0xd2796a=_0x329476;try{await this[_0xd2796a(0x156)][_0xd2796a(0x151)](_0x4ebe32,{'answer':'视频生成失败','status':_0x9942ac['status']}),common_1[_0xd2796a(0x10d)][_0xd2796a(0x102)]('生成失败',_0xd2796a(0x158));}catch(_0x1281df){common_1[_0xd2796a(0x10d)][_0xd2796a(0x12b)](_0xd2796a(0x120)+_0x1281df[_0xd2796a(0x13b)],'LumaService');}}});}catch(_0x49f88a){common_1[_0x329476(0x10d)][_0x329476(0x12b)](_0x329476(0x13f),_0x49f88a['message'],_0x329476(0x134));throw new Error(_0x329476(0x122));}return _0x41832e;}async[_0x735ca3(0x118)](_0x49f1a2){const _0x3f84a9=_0x735ca3,{proxyUrl:_0x31fc77,apiKey:_0x4ebd74,taskId:_0x2824c4,timeout:_0xa8f0e6,onSuccess:_0x129dca,onFailure:_0x52aac8,onGenerating:_0x5f2cda,action:_0x5704c4}=_0x49f1a2;let _0x448c9c={'videoUrl':'','audioUrl':'','fileInfo':'','drawId':'','taskData':'','status':0x2,'progress':0x0,'answer':''};const _0x749b98={'Authorization':_0x3f84a9(0x144)+_0x4ebd74},_0x3fd44e=_0x31fc77+_0x3f84a9(0x12c)+_0x2824c4,_0x257cfc=Date['now'](),_0x457db7=0x493e0,_0x5e5b3c=0x1388;let _0x194cf5=0x0;try{while(Date[_0x3f84a9(0x104)]()-_0x257cfc<_0xa8f0e6){await new Promise(_0x1f7f1c=>setTimeout(_0x1f7f1c,_0x5e5b3c));try{const _0x51fca7=await axios_1[_0x3f84a9(0x146)]['get'](_0x3fd44e,{'headers':_0x749b98}),_0x26787c=setInterval(()=>{const _0x555fe7=_0x3f84a9,_0x3cc7b3=Date[_0x555fe7(0x104)]()-_0x257cfc;let _0x2f77ad=Math[_0x555fe7(0x145)](_0x3cc7b3/_0x457db7*0x64);if(_0x2f77ad>=0x63)_0x2f77ad=0x63;_0x448c9c[_0x555fe7(0x13c)]=_0x555fe7(0x149)+_0x2f77ad+'%）';},0x3e8),_0x15915b=_0x51fca7[_0x3f84a9(0x135)];common_1[_0x3f84a9(0x10d)][_0x3f84a9(0x11f)](_0x3f84a9(0x11b)+JSON[_0x3f84a9(0x112)](_0x15915b),_0x3f84a9(0x134));if(_0x15915b[_0x3f84a9(0x148)]===_0x3f84a9(0x123)){_0x448c9c[_0x3f84a9(0x11c)]=_0x15915b['id'],_0x448c9c[_0x3f84a9(0x14a)]=JSON['stringify'](_0x15915b),_0x448c9c['fileInfo']=_0x15915b[_0x3f84a9(0x14e)]['url'];try{const _0x7d37d2=await this[_0x3f84a9(0x125)][_0x3f84a9(0x109)]([_0x3f84a9(0x106)]);if(Number(_0x7d37d2)){const _0x155425=new Date(),_0x152665=_0x155425[_0x3f84a9(0x12f)](),_0x315242=String(_0x155425[_0x3f84a9(0x132)]()+0x1)['padStart'](0x2,'0'),_0x1cdef8=String(_0x155425[_0x3f84a9(0x159)]())[_0x3f84a9(0x117)](0x2,'0'),_0x16de34=''+_0x152665+_0x315242+'/'+_0x1cdef8;_0x448c9c['fileInfo']=await this['uploadService'][_0x3f84a9(0x103)]({'url':_0x15915b[_0x3f84a9(0x14e)][_0x3f84a9(0x10b)],'dir':_0x3f84a9(0x108)+_0x16de34});}}catch(_0x5e9d85){common_1[_0x3f84a9(0x10d)][_0x3f84a9(0x12b)]('上传文件失败:\x20'+_0x5e9d85[_0x3f84a9(0x13b)],_0x3f84a9(0x134));}_0x448c9c['answer']=_0x3f84a9(0x14f)+_0x15915b[_0x3f84a9(0x12d)]+'\x22',_0x129dca(_0x448c9c),clearInterval(_0x26787c);return;}else _0x5f2cda(_0x448c9c);if(_0x448c9c[_0x3f84a9(0x11a)]){}}catch(_0x48f410){_0x194cf5++,common_1[_0x3f84a9(0x10d)][_0x3f84a9(0x12b)](_0x3f84a9(0x10c)+_0x194cf5,'LumaService');}}common_1[_0x3f84a9(0x10d)][_0x3f84a9(0x12b)](_0x3f84a9(0x12a),_0x3f84a9(0x134)),_0x448c9c['status']=0x4,_0x52aac8(_0x448c9c);throw new Error(_0x3f84a9(0x15b));}catch(_0x113b50){common_1[_0x3f84a9(0x10d)][_0x3f84a9(0x12b)](_0x3f84a9(0x119)+_0x113b50,_0x3f84a9(0x134)),_0x448c9c[_0x3f84a9(0x126)]=0x5,_0x52aac8(_0x448c9c);}}};LumaVideoService=__decorate([(0x0,common_1[_0x735ca3(0x14b)])(),__metadata(_0x735ca3(0x110),[chatLog_service_1['ChatLogService'],globalConfig_service_1[_0x735ca3(0x130)],upload_service_1[_0x735ca3(0x154)]])],LumaVideoService),exports[_0x735ca3(0x138)]=LumaVideoService;