'use strict';const _0x17320e=_0x460f;(function(_0x1c158e,_0x424f2d){const _0x563e67=_0x460f,_0xabc3af=_0x1c158e();while(!![]){try{const _0x3bcb3a=-parseInt(_0x563e67(0x163))/0x1*(parseInt(_0x563e67(0x164))/0x2)+-parseInt(_0x563e67(0x1a4))/0x3*(-parseInt(_0x563e67(0x197))/0x4)+-parseInt(_0x563e67(0x17c))/0x5+parseInt(_0x563e67(0x17a))/0x6+-parseInt(_0x563e67(0x166))/0x7+parseInt(_0x563e67(0x18f))/0x8+-parseInt(_0x563e67(0x185))/0x9*(-parseInt(_0x563e67(0x167))/0xa);if(_0x3bcb3a===_0x424f2d)break;else _0xabc3af['push'](_0xabc3af['shift']());}catch(_0x5e7acc){_0xabc3af['push'](_0xabc3af['shift']());}}}(_0x2451,0xd2a64));var __decorate=this&&this[_0x17320e(0x174)]||function(_0x1735ff,_0x3d6cf8,_0x28ffec,_0x36de5b){const _0x27e968=_0x17320e;var _0x114eed=arguments[_0x27e968(0x19a)],_0x5968f4=_0x114eed<0x3?_0x3d6cf8:_0x36de5b===null?_0x36de5b=Object[_0x27e968(0x1a3)](_0x3d6cf8,_0x28ffec):_0x36de5b,_0x3740c7;if(typeof Reflect===_0x27e968(0x15d)&&typeof Reflect[_0x27e968(0x158)]==='function')_0x5968f4=Reflect['decorate'](_0x1735ff,_0x3d6cf8,_0x28ffec,_0x36de5b);else{for(var _0x4a3d0d=_0x1735ff['length']-0x1;_0x4a3d0d>=0x0;_0x4a3d0d--)if(_0x3740c7=_0x1735ff[_0x4a3d0d])_0x5968f4=(_0x114eed<0x3?_0x3740c7(_0x5968f4):_0x114eed>0x3?_0x3740c7(_0x3d6cf8,_0x28ffec,_0x5968f4):_0x3740c7(_0x3d6cf8,_0x28ffec))||_0x5968f4;}return _0x114eed>0x3&&_0x5968f4&&Object[_0x27e968(0x15e)](_0x3d6cf8,_0x28ffec,_0x5968f4),_0x5968f4;},__metadata=this&&this[_0x17320e(0x198)]||function(_0x1cac7e,_0x486b18){const _0x3a4d54=_0x17320e;if(typeof Reflect===_0x3a4d54(0x15d)&&typeof Reflect[_0x3a4d54(0x187)]===_0x3a4d54(0x186))return Reflect[_0x3a4d54(0x187)](_0x1cac7e,_0x486b18);};Object['defineProperty'](exports,_0x17320e(0x184),{'value':!![]}),exports[_0x17320e(0x194)]=void 0x0;const common_1=require(_0x17320e(0x171)),axios_1=require(_0x17320e(0x16a)),chatLog_service_1=require(_0x17320e(0x182)),globalConfig_service_1=require('../globalConfig/globalConfig.service'),upload_service_1=require(_0x17320e(0x165));let LumaVideoService=class LumaVideoService{constructor(_0x277b54,_0x5a3a01,_0x1c67a5){const _0x5bfdc5=_0x17320e;this[_0x5bfdc5(0x169)]=_0x277b54,this[_0x5bfdc5(0x18a)]=_0x5a3a01,this[_0x5bfdc5(0x159)]=_0x1c67a5;}async[_0x17320e(0x193)](_0x267538){const _0x561bf4=_0x17320e;var _0x445673,_0x4640b2,_0x1537c6;const {apiKey:_0x5508b2,proxyUrl:_0xec8e2,fileInfo:_0x28098f,prompt:_0x8bbfb4,timeout:_0x334269,assistantLogId:_0x431573,extraParam:_0x4aa5f4}=_0x267538;let _0x161ddb={'text':'','fileInfo':'','taskId':'','taskData':'','status':0x2},_0x3770c9=null,_0x3842df='',_0x2586db={};const _0x1c8143={'Authorization':'Bearer\x20'+_0x5508b2};_0x3842df=_0xec8e2+'/luma/generations/';const _0x4cb74a=_0x4aa5f4[_0x561bf4(0x19c)]||_0x561bf4(0x178);_0x2586db={'user_prompt':_0x8bbfb4,'aspect_ratio':_0x4cb74a,'expand_prompt':!![]};_0x28098f&&(_0x2586db[_0x561bf4(0x1a6)]=_0x28098f);common_1['Logger'][_0x561bf4(0x15a)]('正在准备发送请求到\x20'+_0x3842df+'，payload:\x20'+JSON['stringify'](_0x2586db)+',\x20headers:\x20'+JSON[_0x561bf4(0x168)](_0x1c8143),_0x561bf4(0x16f));try{_0x3770c9=await axios_1['default']['post'](_0x3842df,_0x2586db,{'headers':_0x1c8143});}catch(_0x45801b){common_1[_0x561bf4(0x19d)][_0x561bf4(0x189)]('任务提交失败:\x20'+_0x45801b[_0x561bf4(0x176)],'LumaService');throw new Error(_0x561bf4(0x1a7));}if((_0x445673=_0x3770c9===null||_0x3770c9===void 0x0?void 0x0:_0x3770c9[_0x561bf4(0x17d)])===null||_0x445673===void 0x0?void 0x0:_0x445673['id'])_0x161ddb[_0x561bf4(0x15f)]=(_0x4640b2=_0x3770c9===null||_0x3770c9===void 0x0?void 0x0:_0x3770c9[_0x561bf4(0x17d)])===null||_0x4640b2===void 0x0?void 0x0:_0x4640b2['id'],common_1['Logger']['log'](_0x561bf4(0x19f)+((_0x1537c6=_0x3770c9===null||_0x3770c9===void 0x0?void 0x0:_0x3770c9[_0x561bf4(0x17d)])===null||_0x1537c6===void 0x0?void 0x0:_0x1537c6['id']),_0x561bf4(0x16f));else throw new Error('未能获取结果数据,\x20即将重试');try{await this[_0x561bf4(0x19b)]({'proxyUrl':_0xec8e2,'apiKey':_0x5508b2,'taskId':_0x3770c9[_0x561bf4(0x17d)]['id'],'timeout':_0x334269,'prompt':_0x8bbfb4,'onSuccess':async _0x1e9334=>{const _0x492e98=_0x561bf4;try{await this[_0x492e98(0x169)][_0x492e98(0x196)](_0x431573,{'videoUrl':_0x1e9334===null||_0x1e9334===void 0x0?void 0x0:_0x1e9334[_0x492e98(0x161)],'audioUrl':_0x1e9334===null||_0x1e9334===void 0x0?void 0x0:_0x1e9334[_0x492e98(0x1a8)],'fileInfo':_0x1e9334===null||_0x1e9334===void 0x0?void 0x0:_0x1e9334[_0x492e98(0x162)],'answer':(_0x1e9334===null||_0x1e9334===void 0x0?void 0x0:_0x1e9334[_0x492e98(0x1a2)])||_0x8bbfb4,'progress':_0x492e98(0x15b),'status':0x3,'taskId':_0x1e9334===null||_0x1e9334===void 0x0?void 0x0:_0x1e9334[_0x492e98(0x15f)],'taskData':_0x1e9334===null||_0x1e9334===void 0x0?void 0x0:_0x1e9334['taskData']}),common_1[_0x492e98(0x19d)][_0x492e98(0x15a)]('视频任务已完成','LumaService');}catch(_0x17333c){common_1[_0x492e98(0x19d)][_0x492e98(0x189)]('更新日志失败:\x20'+_0x17333c['message'],_0x492e98(0x16f));}},'onGenerating':async _0x14921c=>{const _0x3d9681=_0x561bf4;try{await this['chatLogService'][_0x3d9681(0x196)](_0x431573,{'videoUrl':_0x14921c===null||_0x14921c===void 0x0?void 0x0:_0x14921c[_0x3d9681(0x161)],'audioUrl':_0x14921c===null||_0x14921c===void 0x0?void 0x0:_0x14921c['audioUrl'],'fileInfo':_0x14921c===null||_0x14921c===void 0x0?void 0x0:_0x14921c[_0x3d9681(0x162)],'answer':(_0x14921c===null||_0x14921c===void 0x0?void 0x0:_0x14921c[_0x3d9681(0x1a2)])||_0x3d9681(0x17b),'progress':_0x14921c===null||_0x14921c===void 0x0?void 0x0:_0x14921c[_0x3d9681(0x19e)],'status':_0x14921c[_0x3d9681(0x15c)]}),common_1[_0x3d9681(0x19d)]['log'](_0x3d9681(0x17b),_0x3d9681(0x16f));}catch(_0x560afe){common_1[_0x3d9681(0x19d)]['error']('更新日志失败:\x20'+_0x560afe['message'],'LumaService');}},'onFailure':async _0x2698cb=>{const _0x1ba589=_0x561bf4;try{await this[_0x1ba589(0x169)][_0x1ba589(0x196)](_0x431573,{'answer':'视频生成失败','status':_0x2698cb[_0x1ba589(0x15c)]}),common_1[_0x1ba589(0x19d)][_0x1ba589(0x15a)](_0x1ba589(0x199),_0x1ba589(0x170));}catch(_0x4bb911){common_1[_0x1ba589(0x19d)][_0x1ba589(0x189)](_0x1ba589(0x192)+_0x4bb911[_0x1ba589(0x176)],_0x1ba589(0x16f));}}});}catch(_0x1764ad){common_1[_0x561bf4(0x19d)][_0x561bf4(0x189)]('查询生成结果时发生错误:',_0x1764ad[_0x561bf4(0x176)],_0x561bf4(0x16f));throw new Error(_0x561bf4(0x18c));}return _0x161ddb;}async['pollLumaVideoResult'](_0x1ea88f){const _0x147c9c=_0x17320e,{proxyUrl:_0x341c50,apiKey:_0x2b8be5,taskId:_0x2d65a4,timeout:_0x3b6566,onSuccess:_0x2fbffc,onFailure:_0xf4277f,onGenerating:_0x5188d4,action:_0x5c783a}=_0x1ea88f;let _0x1a4812={'videoUrl':'','audioUrl':'','fileInfo':'','drawId':'','taskData':'','status':0x2,'progress':0x0,'answer':''};const _0x57e3bb={'Authorization':_0x147c9c(0x1a5)+_0x2b8be5},_0x45343a=_0x341c50+'/luma/generations/'+_0x2d65a4,_0xedca6f=Date['now'](),_0x22603f=0x493e0,_0x25be86=0x1388;let _0x1bbd36=0x0;try{while(Date[_0x147c9c(0x180)]()-_0xedca6f<_0x3b6566){await new Promise(_0x3e15ba=>setTimeout(_0x3e15ba,_0x25be86));try{const _0x1144b5=await axios_1['default'][_0x147c9c(0x179)](_0x45343a,{'headers':_0x57e3bb}),_0xdf84d0=setInterval(()=>{const _0x1585b0=_0x147c9c,_0x35a425=Date['now']()-_0xedca6f;let _0x54986f=Math[_0x1585b0(0x195)](_0x35a425/_0x22603f*0x64);if(_0x54986f>=0x63)_0x54986f=0x63;_0x1a4812[_0x1585b0(0x1a2)]=_0x1585b0(0x17f)+_0x54986f+'%）';},0x3e8),_0x2758b0=_0x1144b5['data'];common_1[_0x147c9c(0x19d)][_0x147c9c(0x157)](_0x147c9c(0x1a1)+JSON[_0x147c9c(0x168)](_0x2758b0),_0x147c9c(0x16f));if(_0x2758b0[_0x147c9c(0x175)]==='completed'){_0x1a4812[_0x147c9c(0x15f)]=_0x2758b0['id'],_0x1a4812[_0x147c9c(0x16e)]=JSON[_0x147c9c(0x168)](_0x2758b0),_0x1a4812[_0x147c9c(0x162)]=_0x2758b0['video'][_0x147c9c(0x18b)];try{const _0x4ed3b8=await this[_0x147c9c(0x18a)][_0x147c9c(0x177)]([_0x147c9c(0x156)]);if(Number(_0x4ed3b8)){const _0x114bbb=new Date(),_0x456faf=_0x114bbb[_0x147c9c(0x183)](),_0x3dd030=String(_0x114bbb[_0x147c9c(0x16b)]()+0x1)['padStart'](0x2,'0'),_0x2a80fa=String(_0x114bbb[_0x147c9c(0x16d)]())['padStart'](0x2,'0'),_0x3ae1a9=''+_0x456faf+_0x3dd030+'/'+_0x2a80fa;_0x1a4812[_0x147c9c(0x162)]=await this['uploadService']['uploadFileFromUrl']({'url':_0x2758b0[_0x147c9c(0x190)][_0x147c9c(0x16c)],'dir':_0x147c9c(0x173)+_0x3ae1a9});}}catch(_0x2565bf){common_1[_0x147c9c(0x19d)][_0x147c9c(0x189)](_0x147c9c(0x188)+_0x2565bf[_0x147c9c(0x176)],_0x147c9c(0x16f));}_0x1a4812['answer']=_0x147c9c(0x172)+_0x2758b0[_0x147c9c(0x18d)]+'\x22',_0x2fbffc(_0x1a4812),clearInterval(_0xdf84d0);return;}else _0x5188d4(_0x1a4812);if(_0x1a4812['progress']){}}catch(_0x23cfa4){_0x1bbd36++,common_1['Logger'][_0x147c9c(0x189)](_0x147c9c(0x181)+_0x1bbd36,_0x147c9c(0x16f));}}common_1[_0x147c9c(0x19d)]['error'](_0x147c9c(0x17e),_0x147c9c(0x16f)),_0x1a4812[_0x147c9c(0x15c)]=0x4,_0xf4277f(_0x1a4812);throw new Error('查询超时，请稍后再试！');}catch(_0x15a3ae){common_1[_0x147c9c(0x19d)]['error'](_0x147c9c(0x155)+_0x15a3ae,_0x147c9c(0x16f)),_0x1a4812[_0x147c9c(0x15c)]=0x5,_0xf4277f(_0x1a4812);}}};function _0x460f(_0x361cf1,_0x7f5e0c){const _0x245159=_0x2451();return _0x460f=function(_0x460ff5,_0x502a06){_0x460ff5=_0x460ff5-0x155;let _0x5996db=_0x245159[_0x460ff5];return _0x5996db;},_0x460f(_0x361cf1,_0x7f5e0c);}function _0x2451(){const _0x3555fd=['生成失败','length','pollLumaVideoResult','size','Logger','progress','任务提交成功,\x20任务ID:\x20','Injectable','轮询结果:\x20','answer','getOwnPropertyDescriptor','279BotFMt','Bearer\x20','image_url','任务提交失败','audioUrl','轮询过程中发生错误:\x20','localStorageStatus','debug','decorate','uploadService','log','100%','status','object','defineProperty','taskId','design:paramtypes','videoUrl','fileInfo','19478Mdsowo','142hEJFNb','../upload/upload.service','7105238nsPOjU','140QjoFyR','stringify','chatLogService','axios','getMonth','download_url','getDate','taskData','LumaService','Lum\x20aService','@nestjs/common','提示词:\x20\x22','video/luma/','__decorate','state','message','getConfigs','16:9','get','3748998ZWJpmf','视频生成中...','5107395VtvwkA','data','轮询超时，请稍后再试！','视频生成中\x20（','now','轮询失败，重试次数:\x20','../chatLog/chatLog.service','getFullYear','__esModule','1139931jKXEUf','function','metadata','上传文件失败:\x20','error','globalConfigService','url','查询生成结果时发生错误','prompt','UploadService','1308208jgZxAi','video','ChatLogService','更新日志失败:\x20','lumaVideo','LumaVideoService','floor','updateChatLog','74008eiIytf','__metadata'];_0x2451=function(){return _0x3555fd;};return _0x2451();}LumaVideoService=__decorate([(0x0,common_1[_0x17320e(0x1a0)])(),__metadata(_0x17320e(0x160),[chatLog_service_1[_0x17320e(0x191)],globalConfig_service_1['GlobalConfigService'],upload_service_1[_0x17320e(0x18e)]])],LumaVideoService),exports[_0x17320e(0x194)]=LumaVideoService;