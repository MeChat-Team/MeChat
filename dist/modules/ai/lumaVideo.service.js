'use strict';const _0x1b6913=_0x3a69;function _0x3a69(_0x292344,_0x21ad46){const _0x3687c3=_0x3687();return _0x3a69=function(_0x3a692e,_0x3e2755){_0x3a692e=_0x3a692e-0x16a;let _0x53bcbe=_0x3687c3[_0x3a692e];return _0x53bcbe;},_0x3a69(_0x292344,_0x21ad46);}(function(_0x49f317,_0x2fc78e){const _0x5e1739=_0x3a69,_0x9c0a2e=_0x49f317();while(!![]){try{const _0x22bd81=parseInt(_0x5e1739(0x1a9))/0x1+-parseInt(_0x5e1739(0x1a8))/0x2*(parseInt(_0x5e1739(0x16c))/0x3)+-parseInt(_0x5e1739(0x1bd))/0x4*(-parseInt(_0x5e1739(0x1c2))/0x5)+-parseInt(_0x5e1739(0x1ad))/0x6+-parseInt(_0x5e1739(0x1a7))/0x7+-parseInt(_0x5e1739(0x1b3))/0x8+-parseInt(_0x5e1739(0x19f))/0x9*(-parseInt(_0x5e1739(0x1b4))/0xa);if(_0x22bd81===_0x2fc78e)break;else _0x9c0a2e['push'](_0x9c0a2e['shift']());}catch(_0x5909d6){_0x9c0a2e['push'](_0x9c0a2e['shift']());}}}(_0x3687,0x47fce));var __decorate=this&&this[_0x1b6913(0x175)]||function(_0x311258,_0x68f1f3,_0x540b5b,_0x259ed1){const _0x48cb2d=_0x1b6913;var _0x3c74b2=arguments[_0x48cb2d(0x1c7)],_0x5cab86=_0x3c74b2<0x3?_0x68f1f3:_0x259ed1===null?_0x259ed1=Object[_0x48cb2d(0x187)](_0x68f1f3,_0x540b5b):_0x259ed1,_0x3500af;if(typeof Reflect===_0x48cb2d(0x180)&&typeof Reflect[_0x48cb2d(0x192)]===_0x48cb2d(0x1ba))_0x5cab86=Reflect[_0x48cb2d(0x192)](_0x311258,_0x68f1f3,_0x540b5b,_0x259ed1);else{for(var _0x4fa052=_0x311258[_0x48cb2d(0x1c7)]-0x1;_0x4fa052>=0x0;_0x4fa052--)if(_0x3500af=_0x311258[_0x4fa052])_0x5cab86=(_0x3c74b2<0x3?_0x3500af(_0x5cab86):_0x3c74b2>0x3?_0x3500af(_0x68f1f3,_0x540b5b,_0x5cab86):_0x3500af(_0x68f1f3,_0x540b5b))||_0x5cab86;}return _0x3c74b2>0x3&&_0x5cab86&&Object[_0x48cb2d(0x1b8)](_0x68f1f3,_0x540b5b,_0x5cab86),_0x5cab86;},__metadata=this&&this[_0x1b6913(0x1a3)]||function(_0x2e6a43,_0x6a3ca7){const _0x5dc8ed=_0x1b6913;if(typeof Reflect==='object'&&typeof Reflect[_0x5dc8ed(0x16d)]===_0x5dc8ed(0x1ba))return Reflect[_0x5dc8ed(0x16d)](_0x2e6a43,_0x6a3ca7);};Object['defineProperty'](exports,_0x1b6913(0x171),{'value':!![]}),exports['LumaVideoService']=void 0x0;const common_1=require(_0x1b6913(0x18b)),axios_1=require(_0x1b6913(0x1bf)),chatLog_service_1=require(_0x1b6913(0x189)),globalConfig_service_1=require(_0x1b6913(0x1ae)),upload_service_1=require(_0x1b6913(0x18a));let LumaVideoService=class LumaVideoService{constructor(_0x1ea6c8,_0x4d2022,_0x5c19a1){const _0xfae41b=_0x1b6913;this['chatLogService']=_0x1ea6c8,this[_0xfae41b(0x1c5)]=_0x4d2022,this['uploadService']=_0x5c19a1;}async[_0x1b6913(0x193)](_0x2ed8ea){const _0x5beec2=_0x1b6913;var _0x56816b,_0x17e65c,_0x108376;const {apiKey:_0x1ea739,proxyUrl:_0x5be095,fileInfo:_0x3329cf,prompt:_0x29be54,timeout:_0x3d56ee,assistantLogId:_0x2153df,extraParam:_0x3a0f0a}=_0x2ed8ea;let _0x45a8d3={'text':'','fileInfo':'','taskId':'','taskData':'','status':0x2},_0x991db9=null,_0xdd85fe='',_0x46467c={};const _0x12c6df={'Authorization':_0x5beec2(0x177)+_0x1ea739};_0xdd85fe=_0x5be095+_0x5beec2(0x1a4);const _0x45317e=_0x3a0f0a[_0x5beec2(0x174)]||_0x5beec2(0x17a);_0x46467c={'user_prompt':_0x29be54,'aspect_ratio':_0x45317e,'expand_prompt':!![]};_0x3329cf&&(_0x46467c[_0x5beec2(0x197)]=_0x3329cf);common_1['Logger'][_0x5beec2(0x1ac)](_0x5beec2(0x1ab)+_0xdd85fe+'，payload:\x20'+JSON['stringify'](_0x46467c)+',\x20headers:\x20'+JSON[_0x5beec2(0x179)](_0x12c6df),'LumaService');try{_0x991db9=await axios_1['default'][_0x5beec2(0x183)](_0xdd85fe,_0x46467c,{'headers':_0x12c6df});}catch(_0x292f4a){common_1['Logger'][_0x5beec2(0x1bc)](_0x5beec2(0x182)+_0x292f4a[_0x5beec2(0x19c)],_0x5beec2(0x172));throw new Error(_0x5beec2(0x1b6));}if((_0x56816b=_0x991db9===null||_0x991db9===void 0x0?void 0x0:_0x991db9[_0x5beec2(0x178)])===null||_0x56816b===void 0x0?void 0x0:_0x56816b['id'])_0x45a8d3[_0x5beec2(0x1be)]=(_0x17e65c=_0x991db9===null||_0x991db9===void 0x0?void 0x0:_0x991db9[_0x5beec2(0x178)])===null||_0x17e65c===void 0x0?void 0x0:_0x17e65c['id'],common_1[_0x5beec2(0x186)][_0x5beec2(0x1ac)](_0x5beec2(0x17f)+((_0x108376=_0x991db9===null||_0x991db9===void 0x0?void 0x0:_0x991db9['data'])===null||_0x108376===void 0x0?void 0x0:_0x108376['id']),_0x5beec2(0x172));else throw new Error(_0x5beec2(0x195));try{await this[_0x5beec2(0x1b2)]({'proxyUrl':_0x5be095,'apiKey':_0x1ea739,'taskId':_0x991db9[_0x5beec2(0x178)]['id'],'timeout':_0x3d56ee,'prompt':_0x29be54,'onSuccess':async _0x18d0fb=>{const _0xa7ae37=_0x5beec2;try{await this[_0xa7ae37(0x1a0)][_0xa7ae37(0x1a6)](_0x2153df,{'videoUrl':_0x18d0fb===null||_0x18d0fb===void 0x0?void 0x0:_0x18d0fb[_0xa7ae37(0x16b)],'audioUrl':_0x18d0fb===null||_0x18d0fb===void 0x0?void 0x0:_0x18d0fb[_0xa7ae37(0x1c6)],'fileInfo':_0x18d0fb===null||_0x18d0fb===void 0x0?void 0x0:_0x18d0fb['fileInfo'],'answer':(_0x18d0fb===null||_0x18d0fb===void 0x0?void 0x0:_0x18d0fb['answer'])||_0x29be54,'progress':_0xa7ae37(0x18c),'status':0x3,'taskId':_0x18d0fb===null||_0x18d0fb===void 0x0?void 0x0:_0x18d0fb['taskId'],'taskData':_0x18d0fb===null||_0x18d0fb===void 0x0?void 0x0:_0x18d0fb['taskData']}),common_1['Logger']['log'](_0xa7ae37(0x17d),_0xa7ae37(0x172));}catch(_0x5e4388){common_1['Logger']['error']('更新日志失败:\x20'+_0x5e4388['message'],_0xa7ae37(0x172));}},'onGenerating':async _0x59c3cd=>{const _0x41c666=_0x5beec2;try{await this[_0x41c666(0x1a0)][_0x41c666(0x1a6)](_0x2153df,{'videoUrl':_0x59c3cd===null||_0x59c3cd===void 0x0?void 0x0:_0x59c3cd['videoUrl'],'audioUrl':_0x59c3cd===null||_0x59c3cd===void 0x0?void 0x0:_0x59c3cd['audioUrl'],'fileInfo':_0x59c3cd===null||_0x59c3cd===void 0x0?void 0x0:_0x59c3cd[_0x41c666(0x1bb)],'answer':(_0x59c3cd===null||_0x59c3cd===void 0x0?void 0x0:_0x59c3cd[_0x41c666(0x1aa)])||_0x41c666(0x17c),'progress':_0x59c3cd===null||_0x59c3cd===void 0x0?void 0x0:_0x59c3cd[_0x41c666(0x198)],'status':_0x59c3cd[_0x41c666(0x1a5)]}),common_1[_0x41c666(0x186)][_0x41c666(0x1ac)]('视频生成中...','LumaService');}catch(_0x2f661e){common_1['Logger']['error'](_0x41c666(0x1af)+_0x2f661e[_0x41c666(0x19c)],_0x41c666(0x172));}},'onFailure':async _0x4be191=>{const _0x1b1d77=_0x5beec2;try{await this[_0x1b1d77(0x1a0)][_0x1b1d77(0x1a6)](_0x2153df,{'answer':_0x1b1d77(0x1c1),'status':_0x4be191[_0x1b1d77(0x1a5)]}),common_1[_0x1b1d77(0x186)][_0x1b1d77(0x1ac)](_0x1b1d77(0x19e),_0x1b1d77(0x196));}catch(_0x5ec2b2){common_1[_0x1b1d77(0x186)][_0x1b1d77(0x1bc)](_0x1b1d77(0x1af)+_0x5ec2b2[_0x1b1d77(0x19c)],'LumaService');}}});}catch(_0x51325d){common_1[_0x5beec2(0x186)]['error'](_0x5beec2(0x191),_0x51325d[_0x5beec2(0x19c)],_0x5beec2(0x172));throw new Error(_0x5beec2(0x194));}return _0x45a8d3;}async[_0x1b6913(0x1b2)](_0xa49e0e){const _0x56521b=_0x1b6913,{proxyUrl:_0x1ed87c,apiKey:_0x38e348,taskId:_0x38c892,timeout:_0xf140cb,onSuccess:_0x17505f,onFailure:_0x27a879,onGenerating:_0x12e31b,action:_0x322700}=_0xa49e0e;let _0x3f769c={'videoUrl':'','audioUrl':'','fileInfo':'','drawId':'','taskData':'','status':0x2,'progress':0x0,'answer':''};const _0x3dcd52={'Authorization':_0x56521b(0x177)+_0x38e348},_0x2ce787=_0x1ed87c+'/luma/generations/'+_0x38c892,_0x4acdf6=Date['now'](),_0x233dbc=0x493e0,_0x320272=0x1388;let _0x4c498f=0x0;try{while(Date['now']()-_0x4acdf6<_0xf140cb){await new Promise(_0x45fda4=>setTimeout(_0x45fda4,_0x320272));try{const _0x455ddb=await axios_1[_0x56521b(0x184)][_0x56521b(0x18d)](_0x2ce787,{'headers':_0x3dcd52}),_0x3a923c=setInterval(()=>{const _0x593e1d=_0x56521b,_0x546478=Date[_0x593e1d(0x16f)]()-_0x4acdf6;let _0x9a9376=Math[_0x593e1d(0x190)](_0x546478/_0x233dbc*0x64);if(_0x9a9376>=0x63)_0x9a9376=0x63;_0x3f769c[_0x593e1d(0x1aa)]=_0x593e1d(0x17b)+_0x9a9376+'%）';},0x3e8),_0x1fd292=_0x455ddb[_0x56521b(0x178)];common_1[_0x56521b(0x186)][_0x56521b(0x188)]('轮询结果:\x20'+JSON[_0x56521b(0x179)](_0x1fd292),_0x56521b(0x172));if(_0x1fd292['state']===_0x56521b(0x173)){_0x3f769c['taskId']=_0x1fd292['id'],_0x3f769c[_0x56521b(0x1a2)]=JSON['stringify'](_0x1fd292),_0x3f769c['fileInfo']=_0x1fd292['video'][_0x56521b(0x18e)];try{const _0x18b15d=await this[_0x56521b(0x1c5)][_0x56521b(0x18f)]([_0x56521b(0x16a)]);if(Number(_0x18b15d)){const _0x4bfbf7=new Date(),_0x40043f=_0x4bfbf7[_0x56521b(0x1b0)](),_0x20c4b5=String(_0x4bfbf7[_0x56521b(0x170)]()+0x1)[_0x56521b(0x17e)](0x2,'0'),_0x30692d=String(_0x4bfbf7['getDate']())[_0x56521b(0x17e)](0x2,'0'),_0x48f33d=''+_0x40043f+_0x20c4b5+'/'+_0x30692d;_0x3f769c[_0x56521b(0x1bb)]=await this[_0x56521b(0x1c4)]['uploadFileFromUrl']({'url':_0x1fd292[_0x56521b(0x16e)][_0x56521b(0x1c3)],'dir':_0x56521b(0x1b5)+_0x48f33d});}}catch(_0x10c234){common_1[_0x56521b(0x186)][_0x56521b(0x1bc)](_0x56521b(0x19b)+_0x10c234[_0x56521b(0x19c)],_0x56521b(0x172));}_0x3f769c[_0x56521b(0x1aa)]='提示词:\x20\x22'+_0x1fd292[_0x56521b(0x1b9)]+'\x22',_0x17505f(_0x3f769c),clearInterval(_0x3a923c);return;}else _0x12e31b(_0x3f769c);if(_0x3f769c[_0x56521b(0x198)]){}}catch(_0x135074){_0x4c498f++,common_1[_0x56521b(0x186)][_0x56521b(0x1bc)](_0x56521b(0x176)+_0x4c498f,_0x56521b(0x172));}}common_1[_0x56521b(0x186)][_0x56521b(0x1bc)](_0x56521b(0x1a1),_0x56521b(0x172)),_0x3f769c[_0x56521b(0x1a5)]=0x4,_0x27a879(_0x3f769c);throw new Error(_0x56521b(0x199));}catch(_0x1cb124){common_1['Logger'][_0x56521b(0x1bc)](_0x56521b(0x1c0)+_0x1cb124,'LumaService'),_0x3f769c[_0x56521b(0x1a5)]=0x5,_0x27a879(_0x3f769c);}}};LumaVideoService=__decorate([(0x0,common_1[_0x1b6913(0x1b7)])(),__metadata(_0x1b6913(0x181),[chatLog_service_1[_0x1b6913(0x185)],globalConfig_service_1[_0x1b6913(0x19d)],upload_service_1[_0x1b6913(0x1b1)]])],LumaVideoService),exports[_0x1b6913(0x19a)]=LumaVideoService;function _0x3687(){const _0x14dd8f=['轮询过程中发生错误:\x20','视频生成失败','467210vwBjnv','download_url','uploadService','globalConfigService','audioUrl','length','localStorageStatus','videoUrl','57iDvqoU','metadata','video','now','getMonth','__esModule','LumaService','completed','size','__decorate','轮询失败，重试次数:\x20','Bearer\x20','data','stringify','16:9','视频生成中\x20（','视频生成中...','视频任务已完成','padStart','任务提交成功,\x20任务ID:\x20','object','design:paramtypes','任务提交失败:\x20','post','default','ChatLogService','Logger','getOwnPropertyDescriptor','debug','../chatLog/chatLog.service','../upload/upload.service','@nestjs/common','100%','get','url','getConfigs','floor','查询生成结果时发生错误:','decorate','lumaVideo','查询生成结果时发生错误','未能获取结果数据,\x20即将重试','Lum\x20aService','image_url','progress','查询超时，请稍后再试！','LumaVideoService','上传文件失败:\x20','message','GlobalConfigService','生成失败','70011tcDqIe','chatLogService','轮询超时，请稍后再试！','taskData','__metadata','/luma/generations/','status','updateChatLog','2645993LlqIIM','5354yDXxVu','428064SNTcAO','answer','正在准备发送请求到\x20','log','3234540arcYBK','../globalConfig/globalConfig.service','更新日志失败:\x20','getFullYear','UploadService','pollLumaVideoResult','3902192gkKoiR','1580mwyAGT','video/luma/','任务提交失败','Injectable','defineProperty','prompt','function','fileInfo','error','4ZzpLZg','taskId','axios'];_0x3687=function(){return _0x14dd8f;};return _0x3687();}