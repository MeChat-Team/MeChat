'use strict';const _0x28b68c=_0x9747;(function(_0x2db617,_0x11f0f0){const _0x1734ac=_0x9747,_0x45966f=_0x2db617();while(!![]){try{const _0x416841=-parseInt(_0x1734ac(0xb0))/0x1*(parseInt(_0x1734ac(0xf3))/0x2)+parseInt(_0x1734ac(0xe8))/0x3*(parseInt(_0x1734ac(0xcf))/0x4)+-parseInt(_0x1734ac(0xe1))/0x5+parseInt(_0x1734ac(0xc4))/0x6*(-parseInt(_0x1734ac(0xd6))/0x7)+parseInt(_0x1734ac(0xce))/0x8+-parseInt(_0x1734ac(0xdd))/0x9*(parseInt(_0x1734ac(0xdc))/0xa)+parseInt(_0x1734ac(0xf1))/0xb*(parseInt(_0x1734ac(0xed))/0xc);if(_0x416841===_0x11f0f0)break;else _0x45966f['push'](_0x45966f['shift']());}catch(_0x5f34aa){_0x45966f['push'](_0x45966f['shift']());}}}(_0x5878,0x91bf9));function _0x9747(_0x59b2df,_0x1e8d14){const _0x58781f=_0x5878();return _0x9747=function(_0x974713,_0x548d14){_0x974713=_0x974713-0x9a;let _0x39b33d=_0x58781f[_0x974713];return _0x39b33d;},_0x9747(_0x59b2df,_0x1e8d14);}var __decorate=this&&this[_0x28b68c(0xab)]||function(_0x153b08,_0x1aec38,_0x1a0665,_0x4dfd9b){const _0x1a54c3=_0x28b68c;var _0x4e0406=arguments['length'],_0x18b2cf=_0x4e0406<0x3?_0x1aec38:_0x4dfd9b===null?_0x4dfd9b=Object[_0x1a54c3(0xb2)](_0x1aec38,_0x1a0665):_0x4dfd9b,_0x1d9c3c;if(typeof Reflect==='object'&&typeof Reflect[_0x1a54c3(0xc7)]==='function')_0x18b2cf=Reflect[_0x1a54c3(0xc7)](_0x153b08,_0x1aec38,_0x1a0665,_0x4dfd9b);else{for(var _0x523434=_0x153b08[_0x1a54c3(0xde)]-0x1;_0x523434>=0x0;_0x523434--)if(_0x1d9c3c=_0x153b08[_0x523434])_0x18b2cf=(_0x4e0406<0x3?_0x1d9c3c(_0x18b2cf):_0x4e0406>0x3?_0x1d9c3c(_0x1aec38,_0x1a0665,_0x18b2cf):_0x1d9c3c(_0x1aec38,_0x1a0665))||_0x18b2cf;}return _0x4e0406>0x3&&_0x18b2cf&&Object[_0x1a54c3(0xd2)](_0x1aec38,_0x1a0665,_0x18b2cf),_0x18b2cf;},__metadata=this&&this[_0x28b68c(0xc3)]||function(_0x5edf48,_0x1381bd){const _0x5d975=_0x28b68c;if(typeof Reflect===_0x5d975(0x9b)&&typeof Reflect[_0x5d975(0xa8)]==='function')return Reflect['metadata'](_0x5edf48,_0x1381bd);};function _0x5878(){const _0x111d76=['28dkkcup','now',',\x20数据:\x20','object','查询生成结果时发生错误:','../globalConfig/globalConfig.service','查询超时，请稍后再试！','chatLogService','轮询结果:\x20','task_status','Lum\x20aService','getDate','ChatLogService','上传文件失败:\x20','fileInfo','，payload:\x20','metadata','progress','debug','__decorate','视频生成中...','UploadService','message','Logger','1283vwQACi','getConfigs','getOwnPropertyDescriptor','floor','SUCCESS','statusText','未能获取结果数据,\x20即将重试','../chatLog/chatLog.service','globalConfigService','log','url','cogVideo','audioUrl','image_url','request_id','post','updateChatLog','uploadFileFromUrl','answer','__metadata','774oHOoGK','100%','status','decorate','任务提交结果，状态码:\x20','轮询失败，重试次数:\x20','Bearer\x20','taskData','生成失败','轮询超时，请稍后再试！','9186112jGEwgE','4534924ZkvhGD','localStorageStatus','design:paramtypes','defineProperty','CogVideoService','/cogvideox/v4/videos/generations','CogService','58723kARKJA','GlobalConfigService','视频生成失败','更新日志失败:\x20','视频任务已完成','/cogvideox/v4/async-result/','8683320Aedngn','9HXplJr','length','videoUrl','video_result','487160vXwnyj','stringify','轮询过程中发生错误:\x20','taskId','Injectable','padStart',',\x20headers:\x20','3JqnWfN','uploadService','__esModule','任务提交失败','../upload/upload.service','147444jrJEMw','error','正在准备发送请求到\x20','data','341gAqViU','pollCogVideoResult'];_0x5878=function(){return _0x111d76;};return _0x5878();}Object[_0x28b68c(0xd2)](exports,_0x28b68c(0xea),{'value':!![]}),exports[_0x28b68c(0xd3)]=void 0x0;const common_1=require('@nestjs/common'),axios_1=require('axios'),chatLog_service_1=require(_0x28b68c(0xb7)),globalConfig_service_1=require(_0x28b68c(0x9d)),upload_service_1=require(_0x28b68c(0xec));let CogVideoService=class CogVideoService{constructor(_0x35f565,_0x139097,_0x219f4a){const _0x11f282=_0x28b68c;this[_0x11f282(0x9f)]=_0x35f565,this['globalConfigService']=_0x139097,this[_0x11f282(0xe9)]=_0x219f4a;}async[_0x28b68c(0xbb)](_0xf2d3a2){const _0x31dd1f=_0x28b68c;var _0x230dc6,_0x321f11,_0x33fab5;const {apiKey:_0x246679,proxyUrl:_0x13556c,fileInfo:_0x805bfa,prompt:_0x1b00b9,timeout:_0x286f38,assistantLogId:_0x3fb514}=_0xf2d3a2;let _0x314f47={'text':'','fileInfo':'','taskId':'','taskData':'','status':0x2},_0x3c8484=null,_0x589f06='',_0x2bbe80={};const _0xe33182={'Authorization':_0x31dd1f(0xca)+_0x246679};_0x589f06=_0x13556c+_0x31dd1f(0xd4),_0x2bbe80={'model':'cogvideox','prompt':_0x1b00b9};_0x805bfa&&(_0x2bbe80[_0x31dd1f(0xbd)]=_0x805bfa);common_1[_0x31dd1f(0xaf)][_0x31dd1f(0xb9)](_0x31dd1f(0xef)+_0x589f06+_0x31dd1f(0xa7)+JSON[_0x31dd1f(0xe2)](_0x2bbe80)+_0x31dd1f(0xe7)+JSON[_0x31dd1f(0xe2)](_0xe33182),_0x31dd1f(0xd5));try{_0x3c8484=await axios_1['default'][_0x31dd1f(0xbf)](_0x589f06,_0x2bbe80,{'headers':_0xe33182}),common_1['Logger'][_0x31dd1f(0xaa)](_0x31dd1f(0xc8)+_0x3c8484[_0x31dd1f(0xc6)]+',\x20状态消息:\x20'+_0x3c8484[_0x31dd1f(0xb5)]+_0x31dd1f(0x9a)+JSON[_0x31dd1f(0xe2)](_0x3c8484['data']));}catch(_0x4d7a18){common_1[_0x31dd1f(0xaf)]['error']('任务提交失败:\x20'+_0x4d7a18[_0x31dd1f(0xae)],_0x31dd1f(0xd5));throw new Error(_0x31dd1f(0xeb));}if((_0x230dc6=_0x3c8484===null||_0x3c8484===void 0x0?void 0x0:_0x3c8484[_0x31dd1f(0xf0)])===null||_0x230dc6===void 0x0?void 0x0:_0x230dc6['id'])_0x314f47[_0x31dd1f(0xe4)]=(_0x321f11=_0x3c8484===null||_0x3c8484===void 0x0?void 0x0:_0x3c8484[_0x31dd1f(0xf0)])===null||_0x321f11===void 0x0?void 0x0:_0x321f11['id'],common_1['Logger'][_0x31dd1f(0xb9)]('任务提交成功,\x20任务ID:\x20'+((_0x33fab5=_0x3c8484===null||_0x3c8484===void 0x0?void 0x0:_0x3c8484[_0x31dd1f(0xf0)])===null||_0x33fab5===void 0x0?void 0x0:_0x33fab5['id']),_0x31dd1f(0xd5));else throw new Error(_0x31dd1f(0xb6));try{await this['pollCogVideoResult']({'proxyUrl':_0x13556c,'apiKey':_0x246679,'taskId':_0x3c8484[_0x31dd1f(0xf0)]['id'],'timeout':_0x286f38,'prompt':_0x1b00b9,'onSuccess':async _0x54737d=>{const _0x4b470b=_0x31dd1f;try{await this[_0x4b470b(0x9f)][_0x4b470b(0xc0)](_0x3fb514,{'videoUrl':_0x54737d===null||_0x54737d===void 0x0?void 0x0:_0x54737d[_0x4b470b(0xdf)],'audioUrl':_0x54737d===null||_0x54737d===void 0x0?void 0x0:_0x54737d[_0x4b470b(0xbc)],'fileInfo':_0x54737d===null||_0x54737d===void 0x0?void 0x0:_0x54737d[_0x4b470b(0xa6)],'answer':(_0x54737d===null||_0x54737d===void 0x0?void 0x0:_0x54737d[_0x4b470b(0xc2)])||_0x1b00b9,'progress':_0x4b470b(0xc5),'status':0x3,'taskId':_0x54737d===null||_0x54737d===void 0x0?void 0x0:_0x54737d['taskId'],'taskData':_0x54737d===null||_0x54737d===void 0x0?void 0x0:_0x54737d[_0x4b470b(0xcb)]}),common_1[_0x4b470b(0xaf)][_0x4b470b(0xb9)](_0x4b470b(0xda),_0x4b470b(0xd5));}catch(_0xbc2526){common_1[_0x4b470b(0xaf)]['error'](_0x4b470b(0xd9)+_0xbc2526[_0x4b470b(0xae)],_0x4b470b(0xd5));}},'onGenerating':async _0x5b9293=>{const _0x50355e=_0x31dd1f;try{await this[_0x50355e(0x9f)][_0x50355e(0xc0)](_0x3fb514,{'videoUrl':_0x5b9293===null||_0x5b9293===void 0x0?void 0x0:_0x5b9293[_0x50355e(0xdf)],'audioUrl':_0x5b9293===null||_0x5b9293===void 0x0?void 0x0:_0x5b9293['audioUrl'],'fileInfo':_0x5b9293===null||_0x5b9293===void 0x0?void 0x0:_0x5b9293[_0x50355e(0xa6)],'answer':(_0x5b9293===null||_0x5b9293===void 0x0?void 0x0:_0x5b9293[_0x50355e(0xc2)])||_0x50355e(0xac),'progress':_0x5b9293===null||_0x5b9293===void 0x0?void 0x0:_0x5b9293['progress'],'status':_0x5b9293['status']}),common_1['Logger'][_0x50355e(0xb9)](_0x50355e(0xac),'CogService');}catch(_0x9f6e91){common_1[_0x50355e(0xaf)][_0x50355e(0xee)](_0x50355e(0xd9)+_0x9f6e91[_0x50355e(0xae)],'CogService');}},'onFailure':async _0x31280d=>{const _0x1cd549=_0x31dd1f;try{await this[_0x1cd549(0x9f)][_0x1cd549(0xc0)](_0x3fb514,{'answer':_0x1cd549(0xd8),'status':_0x31280d[_0x1cd549(0xc6)]}),common_1[_0x1cd549(0xaf)][_0x1cd549(0xb9)](_0x1cd549(0xcc),_0x1cd549(0xa2));}catch(_0xb4329f){common_1[_0x1cd549(0xaf)][_0x1cd549(0xee)](_0x1cd549(0xd9)+_0xb4329f[_0x1cd549(0xae)],'CogService');}}});}catch(_0x5893b8){common_1[_0x31dd1f(0xaf)][_0x31dd1f(0xee)](_0x31dd1f(0x9c),_0x5893b8[_0x31dd1f(0xae)],_0x31dd1f(0xd5));throw new Error('查询生成结果时发生错误');}return _0x314f47;}async[_0x28b68c(0xf2)](_0x137ecc){const _0x4a57f4=_0x28b68c,{proxyUrl:_0x941288,apiKey:_0x20e585,taskId:_0x381950,timeout:_0x3abb65,onSuccess:_0x18ebe2,onFailure:_0x55c126,onGenerating:_0x4de73a,prompt:_0x26c6e9,action:_0x46288c}=_0x137ecc;let _0x4d8cd6={'videoUrl':'','audioUrl':'','fileInfo':'','drawId':'','taskData':'','status':0x2,'progress':0x0,'answer':''};const _0x84e206={'Authorization':_0x4a57f4(0xca)+_0x20e585},_0x511134=_0x941288+_0x4a57f4(0xdb)+_0x381950,_0x1d43b1=Date[_0x4a57f4(0xf4)](),_0xf67f47=0x493e0,_0x2d6f9b=0x1388;let _0x3dadc7=0x0;try{while(Date[_0x4a57f4(0xf4)]()-_0x1d43b1<_0x3abb65){await new Promise(_0x11f2e2=>setTimeout(_0x11f2e2,_0x2d6f9b));try{const _0x2d49b3=await axios_1['default']['get'](_0x511134,{'headers':_0x84e206}),_0x36f67=setInterval(()=>{const _0x168439=_0x4a57f4,_0x25f311=Date['now']()-_0x1d43b1;let _0x6938f3=Math[_0x168439(0xb3)](_0x25f311/_0xf67f47*0x64);if(_0x6938f3>=0x63)_0x6938f3=0x63;_0x4d8cd6[_0x168439(0xc2)]='视频生成中\x20（'+_0x6938f3+'%）';},0x3e8),_0x434f79=_0x2d49b3['data'];common_1[_0x4a57f4(0xaf)]['debug'](_0x4a57f4(0xa0)+JSON['stringify'](_0x434f79),_0x4a57f4(0xd5));if(_0x434f79[_0x4a57f4(0xa1)]===_0x4a57f4(0xb4)){_0x4d8cd6[_0x4a57f4(0xe4)]=_0x434f79[_0x4a57f4(0xbe)],_0x4d8cd6['taskData']=JSON[_0x4a57f4(0xe2)](_0x434f79),common_1[_0x4a57f4(0xaf)]['log']('视频生成成功',_0x4a57f4(0xd5)),_0x4d8cd6[_0x4a57f4(0xa6)]=_0x434f79[_0x4a57f4(0xe0)][0x0][_0x4a57f4(0xba)],common_1['Logger'][_0x4a57f4(0xb9)](_0x4d8cd6['fileInfo'],_0x4a57f4(0xd5));try{const _0xdbbed7=await this[_0x4a57f4(0xb8)][_0x4a57f4(0xb1)]([_0x4a57f4(0xd0)]);if(Number(_0xdbbed7)){const _0x4c3b04=new Date(),_0x5ef746=_0x4c3b04['getFullYear'](),_0x2a7850=String(_0x4c3b04['getMonth']()+0x1)[_0x4a57f4(0xe6)](0x2,'0'),_0x49bf32=String(_0x4c3b04[_0x4a57f4(0xa3)]())['padStart'](0x2,'0'),_0x3de098=''+_0x5ef746+_0x2a7850+'/'+_0x49bf32;_0x4d8cd6[_0x4a57f4(0xa6)]=await this[_0x4a57f4(0xe9)][_0x4a57f4(0xc1)]({'url':_0x434f79[_0x4a57f4(0xe0)][0x0][_0x4a57f4(0xba)],'dir':'video/cog/'+_0x3de098});}}catch(_0x5f3159){common_1['Logger']['error'](_0x4a57f4(0xa5)+_0x5f3159['message'],_0x4a57f4(0xd5));}_0x4d8cd6[_0x4a57f4(0xc2)]='提示词:\x20\x22'+_0x26c6e9+'\x22',_0x18ebe2(_0x4d8cd6),clearInterval(_0x36f67);return;}else _0x4de73a(_0x4d8cd6);if(_0x4d8cd6[_0x4a57f4(0xa9)]){}}catch(_0x17d1ea){_0x3dadc7++,common_1[_0x4a57f4(0xaf)][_0x4a57f4(0xee)](_0x4a57f4(0xc9)+_0x3dadc7,'CogService');}}common_1[_0x4a57f4(0xaf)]['error'](_0x4a57f4(0xcd),_0x4a57f4(0xd5)),_0x4d8cd6[_0x4a57f4(0xc6)]=0x4,_0x55c126(_0x4d8cd6);throw new Error(_0x4a57f4(0x9e));}catch(_0x51c107){common_1[_0x4a57f4(0xaf)]['error'](_0x4a57f4(0xe3)+_0x51c107,_0x4a57f4(0xd5)),_0x4d8cd6[_0x4a57f4(0xc6)]=0x5,_0x55c126(_0x4d8cd6);}}};CogVideoService=__decorate([(0x0,common_1[_0x28b68c(0xe5)])(),__metadata(_0x28b68c(0xd1),[chatLog_service_1[_0x28b68c(0xa4)],globalConfig_service_1[_0x28b68c(0xd7)],upload_service_1[_0x28b68c(0xad)]])],CogVideoService),exports[_0x28b68c(0xd3)]=CogVideoService;