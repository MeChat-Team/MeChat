'use strict';const _0x5c3321=_0x1951;(function(_0x232e17,_0x31f465){const _0x1e5392=_0x1951,_0x518529=_0x232e17();while(!![]){try{const _0x33b856=-parseInt(_0x1e5392(0x19b))/0x1+-parseInt(_0x1e5392(0x194))/0x2*(parseInt(_0x1e5392(0x18f))/0x3)+-parseInt(_0x1e5392(0x1d7))/0x4+-parseInt(_0x1e5392(0x1cc))/0x5*(-parseInt(_0x1e5392(0x1b5))/0x6)+parseInt(_0x1e5392(0x198))/0x7*(parseInt(_0x1e5392(0x191))/0x8)+-parseInt(_0x1e5392(0x18c))/0x9*(-parseInt(_0x1e5392(0x1c8))/0xa)+parseInt(_0x1e5392(0x1d6))/0xb;if(_0x33b856===_0x31f465)break;else _0x518529['push'](_0x518529['shift']());}catch(_0xe5084b){_0x518529['push'](_0x518529['shift']());}}}(_0xc640,0x579b6));var __decorate=this&&this[_0x5c3321(0x1ba)]||function(_0x242e45,_0x1387c7,_0xf533d8,_0x3e75b1){const _0x305456=_0x5c3321;var _0x3fbffd=arguments[_0x305456(0x18b)],_0x48c7ee=_0x3fbffd<0x3?_0x1387c7:_0x3e75b1===null?_0x3e75b1=Object[_0x305456(0x193)](_0x1387c7,_0xf533d8):_0x3e75b1,_0x5281d6;if(typeof Reflect==='object'&&typeof Reflect['decorate']===_0x305456(0x1c2))_0x48c7ee=Reflect['decorate'](_0x242e45,_0x1387c7,_0xf533d8,_0x3e75b1);else{for(var _0x260b1d=_0x242e45['length']-0x1;_0x260b1d>=0x0;_0x260b1d--)if(_0x5281d6=_0x242e45[_0x260b1d])_0x48c7ee=(_0x3fbffd<0x3?_0x5281d6(_0x48c7ee):_0x3fbffd>0x3?_0x5281d6(_0x1387c7,_0xf533d8,_0x48c7ee):_0x5281d6(_0x1387c7,_0xf533d8))||_0x48c7ee;}return _0x3fbffd>0x3&&_0x48c7ee&&Object[_0x305456(0x1af)](_0x1387c7,_0xf533d8,_0x48c7ee),_0x48c7ee;},__metadata=this&&this[_0x5c3321(0x18a)]||function(_0x27e86a,_0x560862){const _0xdb69ba=_0x5c3321;if(typeof Reflect==='object'&&typeof Reflect[_0xdb69ba(0x1ab)]==='function')return Reflect[_0xdb69ba(0x1ab)](_0x27e86a,_0x560862);};Object['defineProperty'](exports,_0x5c3321(0x190),{'value':!![]}),exports['CogVideoService']=void 0x0;function _0x1951(_0xfd12c3,_0x249701){const _0xc640a4=_0xc640();return _0x1951=function(_0x1951fe,_0x220adc){_0x1951fe=_0x1951fe-0x183;let _0x304027=_0xc640a4[_0x1951fe];return _0x304027;},_0x1951(_0xfd12c3,_0x249701);}const common_1=require(_0x5c3321(0x1be)),axios_1=require(_0x5c3321(0x1a8)),chatLog_service_1=require(_0x5c3321(0x1c1)),globalConfig_service_1=require(_0x5c3321(0x1b1)),upload_service_1=require(_0x5c3321(0x1d5));let CogVideoService=class CogVideoService{constructor(_0x45d33b,_0x18a036,_0x560d20){const _0x2cf8f2=_0x5c3321;this[_0x2cf8f2(0x1a0)]=_0x45d33b,this['globalConfigService']=_0x18a036,this[_0x2cf8f2(0x1bc)]=_0x560d20;}async[_0x5c3321(0x1b2)](_0x573eb5){const _0xb550a=_0x5c3321;var _0x225917,_0x5f063f,_0x657457;const {apiKey:_0x2a9dd1,proxyUrl:_0x2a4288,fileInfo:_0xd33e45,prompt:_0x7e288e,timeout:_0x5b1221,assistantLogId:_0x3c2541}=_0x573eb5;let _0x588d09={'text':'','fileInfo':'','taskId':'','taskData':'','status':0x2},_0x1273f5=null,_0x103cea='',_0x5cb10f={};const _0xdef95d={'Authorization':'Bearer\x20'+_0x2a9dd1};_0x103cea=_0x2a4288+'/cogvideox/v4/videos/generations',_0x5cb10f={'model':_0xb550a(0x1ca),'prompt':_0x7e288e};_0xd33e45&&(_0x5cb10f[_0xb550a(0x186)]=_0xd33e45);common_1[_0xb550a(0x1d2)][_0xb550a(0x1a1)](_0xb550a(0x1a6)+_0x103cea+_0xb550a(0x19c)+JSON[_0xb550a(0x1c3)](_0x5cb10f)+_0xb550a(0x1d8)+JSON[_0xb550a(0x1c3)](_0xdef95d),_0xb550a(0x18e));try{_0x1273f5=await axios_1[_0xb550a(0x1ae)][_0xb550a(0x199)](_0x103cea,_0x5cb10f,{'headers':_0xdef95d}),common_1[_0xb550a(0x1d2)][_0xb550a(0x189)]('任务提交结果，状态码:\x20'+_0x1273f5[_0xb550a(0x19e)]+_0xb550a(0x1a7)+_0x1273f5[_0xb550a(0x183)]+',\x20数据:\x20'+JSON[_0xb550a(0x1c3)](_0x1273f5[_0xb550a(0x1d3)]));}catch(_0x2e8694){common_1[_0xb550a(0x1d2)]['error'](_0xb550a(0x1ac)+_0x2e8694[_0xb550a(0x19d)],_0xb550a(0x18e));throw new Error(_0xb550a(0x196));}if((_0x225917=_0x1273f5===null||_0x1273f5===void 0x0?void 0x0:_0x1273f5['data'])===null||_0x225917===void 0x0?void 0x0:_0x225917['id'])_0x588d09[_0xb550a(0x1c7)]=(_0x5f063f=_0x1273f5===null||_0x1273f5===void 0x0?void 0x0:_0x1273f5['data'])===null||_0x5f063f===void 0x0?void 0x0:_0x5f063f['id'],common_1[_0xb550a(0x1d2)][_0xb550a(0x1a1)](_0xb550a(0x18d)+((_0x657457=_0x1273f5===null||_0x1273f5===void 0x0?void 0x0:_0x1273f5[_0xb550a(0x1d3)])===null||_0x657457===void 0x0?void 0x0:_0x657457['id']),'CogService');else throw new Error(_0xb550a(0x197));try{await this[_0xb550a(0x1b0)]({'proxyUrl':_0x2a4288,'apiKey':_0x2a9dd1,'taskId':_0x1273f5[_0xb550a(0x1d3)]['id'],'timeout':_0x5b1221,'prompt':_0x7e288e,'onSuccess':async _0x357a9a=>{const _0x425e71=_0xb550a;try{await this[_0x425e71(0x1a0)][_0x425e71(0x1c0)](_0x3c2541,{'videoUrl':_0x357a9a===null||_0x357a9a===void 0x0?void 0x0:_0x357a9a['videoUrl'],'audioUrl':_0x357a9a===null||_0x357a9a===void 0x0?void 0x0:_0x357a9a[_0x425e71(0x1c9)],'fileInfo':_0x357a9a===null||_0x357a9a===void 0x0?void 0x0:_0x357a9a[_0x425e71(0x1cd)],'answer':(_0x357a9a===null||_0x357a9a===void 0x0?void 0x0:_0x357a9a['answer'])||_0x7e288e,'progress':_0x425e71(0x19a),'status':0x3,'taskId':_0x357a9a===null||_0x357a9a===void 0x0?void 0x0:_0x357a9a[_0x425e71(0x1c7)],'taskData':_0x357a9a===null||_0x357a9a===void 0x0?void 0x0:_0x357a9a['taskData']}),common_1[_0x425e71(0x1d2)][_0x425e71(0x1a1)](_0x425e71(0x19f),_0x425e71(0x18e));}catch(_0x43aba0){common_1['Logger'][_0x425e71(0x187)](_0x425e71(0x1cb)+_0x43aba0['message'],_0x425e71(0x18e));}},'onGenerating':async _0x2d6457=>{const _0x509925=_0xb550a;try{await this[_0x509925(0x1a0)]['updateChatLog'](_0x3c2541,{'videoUrl':_0x2d6457===null||_0x2d6457===void 0x0?void 0x0:_0x2d6457['videoUrl'],'audioUrl':_0x2d6457===null||_0x2d6457===void 0x0?void 0x0:_0x2d6457[_0x509925(0x1c9)],'fileInfo':_0x2d6457===null||_0x2d6457===void 0x0?void 0x0:_0x2d6457[_0x509925(0x1cd)],'answer':(_0x2d6457===null||_0x2d6457===void 0x0?void 0x0:_0x2d6457[_0x509925(0x1b3)])||'视频生成中...','progress':_0x2d6457===null||_0x2d6457===void 0x0?void 0x0:_0x2d6457['progress'],'status':_0x2d6457[_0x509925(0x19e)]}),common_1[_0x509925(0x1d2)][_0x509925(0x1a1)]('视频生成中...',_0x509925(0x18e));}catch(_0x11e2da){common_1[_0x509925(0x1d2)][_0x509925(0x187)]('更新日志失败:\x20'+_0x11e2da['message'],_0x509925(0x18e));}},'onFailure':async _0x239b2f=>{const _0x3fb304=_0xb550a;try{await this[_0x3fb304(0x1a0)][_0x3fb304(0x1c0)](_0x3c2541,{'answer':_0x3fb304(0x192),'status':_0x239b2f[_0x3fb304(0x19e)]}),common_1[_0x3fb304(0x1d2)][_0x3fb304(0x1a1)](_0x3fb304(0x1b7),_0x3fb304(0x1a3));}catch(_0x112292){common_1[_0x3fb304(0x1d2)][_0x3fb304(0x187)]('更新日志失败:\x20'+_0x112292['message'],'CogService');}}});}catch(_0xafaa10){common_1[_0xb550a(0x1d2)]['error']('查询生成结果时发生错误:',_0xafaa10[_0xb550a(0x19d)],_0xb550a(0x18e));throw new Error(_0xb550a(0x195));}return _0x588d09;}async[_0x5c3321(0x1b0)](_0x37e00a){const _0x1c8f64=_0x5c3321,{proxyUrl:_0x420fe0,apiKey:_0x5ae55e,taskId:_0xad87,timeout:_0xa77655,onSuccess:_0x731ab3,onFailure:_0x30b5d5,onGenerating:_0x18bf25,prompt:_0x29972c,action:_0x52c27f}=_0x37e00a;let _0x4fbabf={'videoUrl':'','audioUrl':'','fileInfo':'','drawId':'','taskData':'','status':0x2,'progress':0x0,'answer':''};const _0x4a09c2={'Authorization':'Bearer\x20'+_0x5ae55e},_0x2d72ea=_0x420fe0+_0x1c8f64(0x184)+_0xad87,_0x4081a6=Date['now'](),_0x3cc32a=0x493e0,_0x419583=0x1388;let _0x19fc0c=0x0;try{while(Date['now']()-_0x4081a6<_0xa77655){await new Promise(_0x55a9db=>setTimeout(_0x55a9db,_0x419583));try{const _0x4dc9a8=await axios_1[_0x1c8f64(0x1ae)][_0x1c8f64(0x1a4)](_0x2d72ea,{'headers':_0x4a09c2}),_0x575167=setInterval(()=>{const _0x1e22e0=_0x1c8f64,_0x2b5377=Date[_0x1e22e0(0x1ce)]()-_0x4081a6;let _0x897123=Math['floor'](_0x2b5377/_0x3cc32a*0x64);if(_0x897123>=0x63)_0x897123=0x63;_0x4fbabf[_0x1e22e0(0x1b3)]='视频生成中\x20（'+_0x897123+'%）';},0x3e8),_0x4a5329=_0x4dc9a8[_0x1c8f64(0x1d3)];common_1[_0x1c8f64(0x1d2)][_0x1c8f64(0x189)](_0x1c8f64(0x1a5)+JSON[_0x1c8f64(0x1c3)](_0x4a5329),_0x1c8f64(0x18e));if(_0x4a5329[_0x1c8f64(0x1c4)]==='SUCCESS'){_0x4fbabf[_0x1c8f64(0x1c7)]=_0x4a5329[_0x1c8f64(0x1cf)],_0x4fbabf['taskData']=JSON['stringify'](_0x4a5329),common_1['Logger'][_0x1c8f64(0x1a1)](_0x1c8f64(0x1aa),_0x1c8f64(0x18e)),_0x4fbabf[_0x1c8f64(0x1cd)]=_0x4a5329[_0x1c8f64(0x1ad)][0x0][_0x1c8f64(0x1bf)],common_1['Logger']['log'](_0x4fbabf[_0x1c8f64(0x1cd)],_0x1c8f64(0x18e));try{const _0x56426d=await this['globalConfigService']['getConfigs']([_0x1c8f64(0x1b4)]);if(Number(_0x56426d)){const _0x10dd73=new Date(),_0x58f09b=_0x10dd73[_0x1c8f64(0x1d4)](),_0x21b030=String(_0x10dd73['getMonth']()+0x1)[_0x1c8f64(0x1c5)](0x2,'0'),_0x32c4db=String(_0x10dd73[_0x1c8f64(0x185)]())['padStart'](0x2,'0'),_0x395a17=''+_0x58f09b+_0x21b030+'/'+_0x32c4db;_0x4fbabf[_0x1c8f64(0x1cd)]=await this[_0x1c8f64(0x1bc)]['uploadFileFromUrl']({'url':_0x4a5329[_0x1c8f64(0x1ad)][0x0][_0x1c8f64(0x1bf)],'dir':_0x1c8f64(0x188)+_0x395a17});}}catch(_0x243122){common_1[_0x1c8f64(0x1d2)][_0x1c8f64(0x187)](_0x1c8f64(0x1a2)+_0x243122['message'],_0x1c8f64(0x18e));}_0x4fbabf[_0x1c8f64(0x1b3)]=_0x1c8f64(0x1d1)+_0x29972c+'\x22',_0x731ab3(_0x4fbabf),clearInterval(_0x575167);return;}else _0x18bf25(_0x4fbabf);if(_0x4fbabf[_0x1c8f64(0x1b8)]){}}catch(_0x49e7df){_0x19fc0c++,common_1[_0x1c8f64(0x1d2)][_0x1c8f64(0x187)](_0x1c8f64(0x1bd)+_0x19fc0c,_0x1c8f64(0x18e));}}common_1['Logger'][_0x1c8f64(0x187)](_0x1c8f64(0x1b6),_0x1c8f64(0x18e)),_0x4fbabf[_0x1c8f64(0x19e)]=0x4,_0x30b5d5(_0x4fbabf);throw new Error(_0x1c8f64(0x1c6));}catch(_0x564e38){common_1[_0x1c8f64(0x1d2)][_0x1c8f64(0x187)](_0x1c8f64(0x1b9)+_0x564e38,_0x1c8f64(0x18e)),_0x4fbabf[_0x1c8f64(0x19e)]=0x5,_0x30b5d5(_0x4fbabf);}}};function _0xc640(){const _0x5ea3fd=['轮询结果:\x20','正在准备发送请求到\x20',',\x20状态消息:\x20','axios','UploadService','视频生成成功','metadata','任务提交失败:\x20','video_result','default','defineProperty','pollCogVideoResult','../globalConfig/globalConfig.service','cogVideo','answer','localStorageStatus','66TpdjCN','轮询超时，请稍后再试！','生成失败','progress','轮询过程中发生错误:\x20','__decorate','ChatLogService','uploadService','轮询失败，重试次数:\x20','@nestjs/common','url','updateChatLog','../chatLog/chatLog.service','function','stringify','task_status','padStart','查询超时，请稍后再试！','taskId','2740420lFstmg','audioUrl','cogvideox','更新日志失败:\x20','21085QrtppR','fileInfo','now','request_id','Injectable','提示词:\x20\x22','Logger','data','getFullYear','../upload/upload.service','7863757vSXUao','1702292abTTmq',',\x20headers:\x20','statusText','/cogvideox/v4/async-result/','getDate','image_url','error','video/cog/','debug','__metadata','length','9oBLUtK','任务提交成功,\x20任务ID:\x20','CogService','6xpWMgP','__esModule','296nLkdfg','视频生成失败','getOwnPropertyDescriptor','651026ELeIkJ','查询生成结果时发生错误','任务提交失败','未能获取结果数据,\x20即将重试','112378owoHzm','post','100%','193877MxigkR','，payload:\x20','message','status','视频任务已完成','chatLogService','log','上传文件失败:\x20','Lum\x20aService','get'];_0xc640=function(){return _0x5ea3fd;};return _0xc640();}CogVideoService=__decorate([(0x0,common_1[_0x5c3321(0x1d0)])(),__metadata('design:paramtypes',[chatLog_service_1[_0x5c3321(0x1bb)],globalConfig_service_1['GlobalConfigService'],upload_service_1[_0x5c3321(0x1a9)]])],CogVideoService),exports['CogVideoService']=CogVideoService;