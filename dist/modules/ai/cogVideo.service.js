'use strict';const _0x1d168f=_0x5c32;function _0x372c(){const _0x5d3e62=['videoUrl','，payload:\x20','metadata','stringify','轮询失败，重试次数:\x20','object','2770470ECmdBy','axios',',\x20headers:\x20','getConfigs','5013624ZIPItn','CogService','视频任务已完成','updateChatLog','length','get','任务提交成功,\x20任务ID:\x20','now','function','request_id','decorate','getFullYear','3810762EHuzhf','26526348hupxdk','UploadService','任务提交结果，状态码:\x20','defineProperty','fileInfo','taskId','生成失败','正在准备发送请求到\x20','282254rshIpb','/cogvideox/v4/async-result/','GlobalConfigService','Logger','更新日志失败:\x20','9145264JtOtJh','uploadService','/cogvideox/v4/videos/generations','task_status','data','Injectable','6756155tZceno','CogVideoService','progress','SUCCESS','status','globalConfigService','url','taskData','__esModule','@nestjs/common','pollCogVideoResult','cogVideo','1QynsJh','padStart','7ECUAaK','ChatLogService','提示词:\x20\x22','chatLogService','Bearer\x20','answer','视频生成中...','100%','statusText','../globalConfig/globalConfig.service','getMonth','getDate','error','uploadFileFromUrl','cogvideox','log','audioUrl','Lum\x20aService','任务提交失败',',\x20状态消息:\x20','default','__decorate','查询超时，请稍后再试！','message','查询生成结果时发生错误:','查询生成结果时发生错误','debug','上传文件失败:\x20','video_result'];_0x372c=function(){return _0x5d3e62;};return _0x372c();}(function(_0x4d83c3,_0x1b433a){const _0xa50568=_0x5c32,_0x333a57=_0x4d83c3();while(!![]){try{const _0x3d67f0=parseInt(_0xa50568(0xc9))/0x1*(-parseInt(_0xa50568(0x107))/0x2)+-parseInt(_0xa50568(0xfe))/0x3+parseInt(_0xa50568(0xf2))/0x4+-parseInt(_0xa50568(0xbd))/0x5+parseInt(_0xa50568(0xee))/0x6+-parseInt(_0xa50568(0xcb))/0x7*(parseInt(_0xa50568(0xb7))/0x8)+parseInt(_0xa50568(0xff))/0x9;if(_0x3d67f0===_0x1b433a)break;else _0x333a57['push'](_0x333a57['shift']());}catch(_0x13cf9e){_0x333a57['push'](_0x333a57['shift']());}}}(_0x372c,0xb8c11));var __decorate=this&&this[_0x1d168f(0xe0)]||function(_0x467513,_0x1089b3,_0x576973,_0x1108de){const _0x58e411=_0x1d168f;var _0x37e419=arguments[_0x58e411(0xf6)],_0x4e120f=_0x37e419<0x3?_0x1089b3:_0x1108de===null?_0x1108de=Object['getOwnPropertyDescriptor'](_0x1089b3,_0x576973):_0x1108de,_0x2ffd70;if(typeof Reflect===_0x58e411(0xed)&&typeof Reflect[_0x58e411(0xfc)]===_0x58e411(0xfa))_0x4e120f=Reflect[_0x58e411(0xfc)](_0x467513,_0x1089b3,_0x576973,_0x1108de);else{for(var _0x11051c=_0x467513[_0x58e411(0xf6)]-0x1;_0x11051c>=0x0;_0x11051c--)if(_0x2ffd70=_0x467513[_0x11051c])_0x4e120f=(_0x37e419<0x3?_0x2ffd70(_0x4e120f):_0x37e419>0x3?_0x2ffd70(_0x1089b3,_0x576973,_0x4e120f):_0x2ffd70(_0x1089b3,_0x576973))||_0x4e120f;}return _0x37e419>0x3&&_0x4e120f&&Object[_0x58e411(0x102)](_0x1089b3,_0x576973,_0x4e120f),_0x4e120f;},__metadata=this&&this['__metadata']||function(_0x23f326,_0x534f25){const _0x27b241=_0x1d168f;if(typeof Reflect===_0x27b241(0xed)&&typeof Reflect[_0x27b241(0xea)]===_0x27b241(0xfa))return Reflect['metadata'](_0x23f326,_0x534f25);};Object[_0x1d168f(0x102)](exports,_0x1d168f(0xc5),{'value':!![]}),exports[_0x1d168f(0xbe)]=void 0x0;const common_1=require(_0x1d168f(0xc6)),axios_1=require(_0x1d168f(0xef)),chatLog_service_1=require('../chatLog/chatLog.service'),globalConfig_service_1=require(_0x1d168f(0xd4)),upload_service_1=require('../upload/upload.service');let CogVideoService=class CogVideoService{constructor(_0x482bce,_0x20ad16,_0x1df290){const _0x462f63=_0x1d168f;this[_0x462f63(0xce)]=_0x482bce,this[_0x462f63(0xc2)]=_0x20ad16,this[_0x462f63(0xb8)]=_0x1df290;}async[_0x1d168f(0xc8)](_0x3b13d8){const _0x3706cd=_0x1d168f;var _0x1f6472,_0x42a916,_0x9a1de9;const {apiKey:_0x4bba38,proxyUrl:_0x13ee76,fileInfo:_0x183f78,prompt:_0x14f4ce,timeout:_0x30ae7c,assistantLogId:_0x47bb2e}=_0x3b13d8;let _0x43dfef={'text':'','fileInfo':'','taskId':'','taskData':'','status':0x2},_0x36a7ba=null,_0x264575='',_0x30631e={};const _0x2ba4e4={'Authorization':_0x3706cd(0xcf)+_0x4bba38};_0x264575=_0x13ee76+_0x3706cd(0xb9),_0x30631e={'model':_0x3706cd(0xd9),'prompt':_0x14f4ce};_0x183f78&&(_0x30631e['image_url']=_0x183f78);common_1[_0x3706cd(0xb5)][_0x3706cd(0xda)](_0x3706cd(0x106)+_0x264575+_0x3706cd(0xe9)+JSON[_0x3706cd(0xeb)](_0x30631e)+_0x3706cd(0xf0)+JSON[_0x3706cd(0xeb)](_0x2ba4e4),_0x3706cd(0xf3));try{_0x36a7ba=await axios_1[_0x3706cd(0xdf)]['post'](_0x264575,_0x30631e,{'headers':_0x2ba4e4}),common_1['Logger']['debug'](_0x3706cd(0x101)+_0x36a7ba[_0x3706cd(0xc1)]+_0x3706cd(0xde)+_0x36a7ba[_0x3706cd(0xd3)]+',\x20数据:\x20'+JSON[_0x3706cd(0xeb)](_0x36a7ba[_0x3706cd(0xbb)]));}catch(_0x33751c){common_1[_0x3706cd(0xb5)]['error']('任务提交失败:\x20'+_0x33751c[_0x3706cd(0xe2)],_0x3706cd(0xf3));throw new Error(_0x3706cd(0xdd));}if((_0x1f6472=_0x36a7ba===null||_0x36a7ba===void 0x0?void 0x0:_0x36a7ba[_0x3706cd(0xbb)])===null||_0x1f6472===void 0x0?void 0x0:_0x1f6472['id'])_0x43dfef[_0x3706cd(0x104)]=(_0x42a916=_0x36a7ba===null||_0x36a7ba===void 0x0?void 0x0:_0x36a7ba[_0x3706cd(0xbb)])===null||_0x42a916===void 0x0?void 0x0:_0x42a916['id'],common_1[_0x3706cd(0xb5)]['log'](_0x3706cd(0xf8)+((_0x9a1de9=_0x36a7ba===null||_0x36a7ba===void 0x0?void 0x0:_0x36a7ba[_0x3706cd(0xbb)])===null||_0x9a1de9===void 0x0?void 0x0:_0x9a1de9['id']),_0x3706cd(0xf3));else throw new Error('未能获取结果数据,\x20即将重试');try{await this[_0x3706cd(0xc7)]({'proxyUrl':_0x13ee76,'apiKey':_0x4bba38,'taskId':_0x36a7ba[_0x3706cd(0xbb)]['id'],'timeout':_0x30ae7c,'prompt':_0x14f4ce,'onSuccess':async _0x29aa9c=>{const _0x480790=_0x3706cd;try{await this[_0x480790(0xce)][_0x480790(0xf5)](_0x47bb2e,{'videoUrl':_0x29aa9c===null||_0x29aa9c===void 0x0?void 0x0:_0x29aa9c[_0x480790(0xe8)],'audioUrl':_0x29aa9c===null||_0x29aa9c===void 0x0?void 0x0:_0x29aa9c['audioUrl'],'fileInfo':_0x29aa9c===null||_0x29aa9c===void 0x0?void 0x0:_0x29aa9c['fileInfo'],'answer':(_0x29aa9c===null||_0x29aa9c===void 0x0?void 0x0:_0x29aa9c['answer'])||_0x14f4ce,'progress':_0x480790(0xd2),'status':0x3,'taskId':_0x29aa9c===null||_0x29aa9c===void 0x0?void 0x0:_0x29aa9c[_0x480790(0x104)],'taskData':_0x29aa9c===null||_0x29aa9c===void 0x0?void 0x0:_0x29aa9c[_0x480790(0xc4)]}),common_1[_0x480790(0xb5)]['log'](_0x480790(0xf4),_0x480790(0xf3));}catch(_0x5188c4){common_1[_0x480790(0xb5)][_0x480790(0xd7)]('更新日志失败:\x20'+_0x5188c4[_0x480790(0xe2)],_0x480790(0xf3));}},'onGenerating':async _0x31d7c9=>{const _0x432751=_0x3706cd;try{await this[_0x432751(0xce)]['updateChatLog'](_0x47bb2e,{'videoUrl':_0x31d7c9===null||_0x31d7c9===void 0x0?void 0x0:_0x31d7c9[_0x432751(0xe8)],'audioUrl':_0x31d7c9===null||_0x31d7c9===void 0x0?void 0x0:_0x31d7c9[_0x432751(0xdb)],'fileInfo':_0x31d7c9===null||_0x31d7c9===void 0x0?void 0x0:_0x31d7c9[_0x432751(0x103)],'answer':(_0x31d7c9===null||_0x31d7c9===void 0x0?void 0x0:_0x31d7c9[_0x432751(0xd0)])||_0x432751(0xd1),'progress':_0x31d7c9===null||_0x31d7c9===void 0x0?void 0x0:_0x31d7c9[_0x432751(0xbf)],'status':_0x31d7c9[_0x432751(0xc1)]}),common_1['Logger'][_0x432751(0xda)](_0x432751(0xd1),_0x432751(0xf3));}catch(_0x370a05){common_1['Logger']['error'](_0x432751(0xb6)+_0x370a05[_0x432751(0xe2)],_0x432751(0xf3));}},'onFailure':async _0x346403=>{const _0x2f79f7=_0x3706cd;try{await this[_0x2f79f7(0xce)]['updateChatLog'](_0x47bb2e,{'answer':'视频生成失败','status':_0x346403[_0x2f79f7(0xc1)]}),common_1[_0x2f79f7(0xb5)][_0x2f79f7(0xda)](_0x2f79f7(0x105),_0x2f79f7(0xdc));}catch(_0x12c641){common_1['Logger'][_0x2f79f7(0xd7)](_0x2f79f7(0xb6)+_0x12c641[_0x2f79f7(0xe2)],_0x2f79f7(0xf3));}}});}catch(_0x203a5e){common_1[_0x3706cd(0xb5)][_0x3706cd(0xd7)](_0x3706cd(0xe3),_0x203a5e[_0x3706cd(0xe2)],_0x3706cd(0xf3));throw new Error(_0x3706cd(0xe4));}return _0x43dfef;}async[_0x1d168f(0xc7)](_0x33a931){const _0x4382e9=_0x1d168f,{proxyUrl:_0x4ddbd2,apiKey:_0x22e39a,taskId:_0x37a0f3,timeout:_0x41a7d2,onSuccess:_0x3733eb,onFailure:_0x1c0ffe,onGenerating:_0x3ad1b8,prompt:_0x581bd5,action:_0x5071c3}=_0x33a931;let _0x43f34f={'videoUrl':'','audioUrl':'','fileInfo':'','drawId':'','taskData':'','status':0x2,'progress':0x0,'answer':''};const _0x556067={'Authorization':_0x4382e9(0xcf)+_0x22e39a},_0x4c728b=_0x4ddbd2+_0x4382e9(0x108)+_0x37a0f3,_0x3ec741=Date[_0x4382e9(0xf9)](),_0x421c8a=0x493e0,_0x368b8a=0x1388;let _0x85d4d=0x0;try{while(Date[_0x4382e9(0xf9)]()-_0x3ec741<_0x41a7d2){await new Promise(_0x4c3ecf=>setTimeout(_0x4c3ecf,_0x368b8a));try{const _0x155bff=await axios_1[_0x4382e9(0xdf)][_0x4382e9(0xf7)](_0x4c728b,{'headers':_0x556067}),_0x59f7d8=setInterval(()=>{const _0x442dda=_0x4382e9,_0x51d772=Date[_0x442dda(0xf9)]()-_0x3ec741;let _0x27990f=Math['floor'](_0x51d772/_0x421c8a*0x64);if(_0x27990f>=0x63)_0x27990f=0x63;_0x43f34f[_0x442dda(0xd0)]='视频生成中\x20（'+_0x27990f+'%）';},0x3e8),_0x493535=_0x155bff[_0x4382e9(0xbb)];common_1[_0x4382e9(0xb5)][_0x4382e9(0xe5)]('轮询结果:\x20'+JSON[_0x4382e9(0xeb)](_0x493535),_0x4382e9(0xf3));if(_0x493535[_0x4382e9(0xba)]===_0x4382e9(0xc0)){_0x43f34f[_0x4382e9(0x104)]=_0x493535[_0x4382e9(0xfb)],_0x43f34f[_0x4382e9(0xc4)]=JSON['stringify'](_0x493535),common_1[_0x4382e9(0xb5)][_0x4382e9(0xda)]('视频生成成功','CogService'),_0x43f34f[_0x4382e9(0x103)]=_0x493535[_0x4382e9(0xe7)][0x0][_0x4382e9(0xc3)],common_1['Logger'][_0x4382e9(0xda)](_0x43f34f[_0x4382e9(0x103)],_0x4382e9(0xf3));try{const _0x4f03f6=await this[_0x4382e9(0xc2)][_0x4382e9(0xf1)](['localStorageStatus']);if(Number(_0x4f03f6)){const _0x414e62=new Date(),_0x42d1b8=_0x414e62[_0x4382e9(0xfd)](),_0x21f085=String(_0x414e62[_0x4382e9(0xd5)]()+0x1)[_0x4382e9(0xca)](0x2,'0'),_0x25ef1a=String(_0x414e62[_0x4382e9(0xd6)]())[_0x4382e9(0xca)](0x2,'0'),_0x507d79=''+_0x42d1b8+_0x21f085+'/'+_0x25ef1a;_0x43f34f['fileInfo']=await this['uploadService'][_0x4382e9(0xd8)]({'url':_0x493535[_0x4382e9(0xe7)][0x0][_0x4382e9(0xc3)],'dir':'video/cog/'+_0x507d79});}}catch(_0x580a80){common_1[_0x4382e9(0xb5)]['error'](_0x4382e9(0xe6)+_0x580a80[_0x4382e9(0xe2)],'CogService');}_0x43f34f[_0x4382e9(0xd0)]=_0x4382e9(0xcd)+_0x581bd5+'\x22',_0x3733eb(_0x43f34f),clearInterval(_0x59f7d8);return;}else _0x3ad1b8(_0x43f34f);if(_0x43f34f['progress']){}}catch(_0x5aaedd){_0x85d4d++,common_1[_0x4382e9(0xb5)][_0x4382e9(0xd7)](_0x4382e9(0xec)+_0x85d4d,_0x4382e9(0xf3));}}common_1[_0x4382e9(0xb5)][_0x4382e9(0xd7)]('轮询超时，请稍后再试！',_0x4382e9(0xf3)),_0x43f34f[_0x4382e9(0xc1)]=0x4,_0x1c0ffe(_0x43f34f);throw new Error(_0x4382e9(0xe1));}catch(_0x1b18ba){common_1[_0x4382e9(0xb5)]['error']('轮询过程中发生错误:\x20'+_0x1b18ba,'CogService'),_0x43f34f[_0x4382e9(0xc1)]=0x5,_0x1c0ffe(_0x43f34f);}}};function _0x5c32(_0x4dc24c,_0x1bdc2a){const _0x372cf9=_0x372c();return _0x5c32=function(_0x5c3259,_0x57a01a){_0x5c3259=_0x5c3259-0xb4;let _0x4385dd=_0x372cf9[_0x5c3259];return _0x4385dd;},_0x5c32(_0x4dc24c,_0x1bdc2a);}CogVideoService=__decorate([(0x0,common_1[_0x1d168f(0xbc)])(),__metadata('design:paramtypes',[chatLog_service_1[_0x1d168f(0xcc)],globalConfig_service_1[_0x1d168f(0xb4)],upload_service_1[_0x1d168f(0x100)]])],CogVideoService),exports['CogVideoService']=CogVideoService;