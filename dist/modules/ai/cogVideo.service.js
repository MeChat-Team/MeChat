'use strict';const _0x60ad23=_0x3636;(function(_0x1aa0f4,_0xfdedf1){const _0x2953ab=_0x3636,_0x595cb2=_0x1aa0f4();while(!![]){try{const _0x17dce7=-parseInt(_0x2953ab(0x1e9))/0x1*(-parseInt(_0x2953ab(0x1ee))/0x2)+-parseInt(_0x2953ab(0x1fc))/0x3+-parseInt(_0x2953ab(0x1f4))/0x4+parseInt(_0x2953ab(0x238))/0x5*(-parseInt(_0x2953ab(0x20b))/0x6)+-parseInt(_0x2953ab(0x234))/0x7*(parseInt(_0x2953ab(0x209))/0x8)+-parseInt(_0x2953ab(0x232))/0x9+parseInt(_0x2953ab(0x202))/0xa*(parseInt(_0x2953ab(0x1f3))/0xb);if(_0x17dce7===_0xfdedf1)break;else _0x595cb2['push'](_0x595cb2['shift']());}catch(_0x5c96d9){_0x595cb2['push'](_0x595cb2['shift']());}}}(_0x2076,0xbcf11));var __decorate=this&&this[_0x60ad23(0x224)]||function(_0x287781,_0x2c163f,_0x20f102,_0x47e535){const _0x5456f6=_0x60ad23;var _0x36801e=arguments['length'],_0x1dd34f=_0x36801e<0x3?_0x2c163f:_0x47e535===null?_0x47e535=Object['getOwnPropertyDescriptor'](_0x2c163f,_0x20f102):_0x47e535,_0x3cb158;if(typeof Reflect===_0x5456f6(0x1ff)&&typeof Reflect[_0x5456f6(0x205)]===_0x5456f6(0x223))_0x1dd34f=Reflect['decorate'](_0x287781,_0x2c163f,_0x20f102,_0x47e535);else{for(var _0x43e765=_0x287781['length']-0x1;_0x43e765>=0x0;_0x43e765--)if(_0x3cb158=_0x287781[_0x43e765])_0x1dd34f=(_0x36801e<0x3?_0x3cb158(_0x1dd34f):_0x36801e>0x3?_0x3cb158(_0x2c163f,_0x20f102,_0x1dd34f):_0x3cb158(_0x2c163f,_0x20f102))||_0x1dd34f;}return _0x36801e>0x3&&_0x1dd34f&&Object[_0x5456f6(0x20e)](_0x2c163f,_0x20f102,_0x1dd34f),_0x1dd34f;},__metadata=this&&this[_0x60ad23(0x236)]||function(_0x1d4177,_0x1cc1e7){const _0x4434e7=_0x60ad23;if(typeof Reflect==='object'&&typeof Reflect['metadata']===_0x4434e7(0x223))return Reflect[_0x4434e7(0x22d)](_0x1d4177,_0x1cc1e7);};Object[_0x60ad23(0x20e)](exports,'__esModule',{'value':!![]}),exports['CogVideoService']=void 0x0;function _0x2076(){const _0x48eccd=['now','progress','../upload/upload.service','CogService','1778562pxrgaw','轮询失败，重试次数:\x20','查询生成结果时发生错误','object','default','视频任务已完成','3115940yWqcXn','视频生成中...','视频生成中\x20（','decorate','getDate','getFullYear','axios','872TWMxiE','查询生成结果时发生错误:','18HciImt','轮询过程中发生错误:\x20','taskId','defineProperty','cogVideo','Lum\x20aService',',\x20headers:\x20','UploadService','video_result','../globalConfig/globalConfig.service','videoUrl',',\x20数据:\x20','globalConfigService','task_status','chatLogService','floor','@nestjs/common','error','audioUrl','getConfigs','statusText','message','status','uploadService','function','__decorate','Injectable','cogvideox','生成失败','未能获取结果数据,\x20即将重试','design:paramtypes','request_id','debug','，payload:\x20','metadata','轮询结果:\x20','任务提交成功,\x20任务ID:\x20','answer','pollCogVideoResult','12653748bfijAt','stringify','97951BQkvjU','updateChatLog','__metadata','ChatLogService','1108595fOZrkv','padStart','SUCCESS','getMonth','15854uqEsQn','更新日志失败:\x20','url','log','/cogvideox/v4/videos/generations','86HhbHZn','Logger','GlobalConfigService','video/cog/','data','165TwOsmv','1570028APOUcb','Bearer\x20','上传文件失败:\x20','fileInfo'];_0x2076=function(){return _0x48eccd;};return _0x2076();}const common_1=require(_0x60ad23(0x21b)),axios_1=require(_0x60ad23(0x208)),chatLog_service_1=require('../chatLog/chatLog.service'),globalConfig_service_1=require(_0x60ad23(0x214)),upload_service_1=require(_0x60ad23(0x1fa));let CogVideoService=class CogVideoService{constructor(_0x3119d5,_0x27a733,_0x52f875){const _0x2537e0=_0x60ad23;this[_0x2537e0(0x219)]=_0x3119d5,this['globalConfigService']=_0x27a733,this['uploadService']=_0x52f875;}async[_0x60ad23(0x20f)](_0x39ab4f){const _0x40f32c=_0x60ad23;var _0x5de4c4,_0x57d5e5,_0x4bc7ef;const {apiKey:_0x8c8bd4,proxyUrl:_0x543868,fileInfo:_0x431872,prompt:_0x1c0a7d,timeout:_0x2ba064,assistantLogId:_0x271a1f}=_0x39ab4f;let _0x33b4eb={'text':'','fileInfo':'','taskId':'','taskData':'','status':0x2},_0x46eeb5=null,_0x21132f='',_0x41eba9={};const _0x292fb1={'Authorization':_0x40f32c(0x1f5)+_0x8c8bd4};_0x21132f=_0x543868+_0x40f32c(0x1ed),_0x41eba9={'model':_0x40f32c(0x226),'prompt':_0x1c0a7d};_0x431872&&(_0x41eba9['image_url']=_0x431872);common_1[_0x40f32c(0x1ef)][_0x40f32c(0x1ec)]('正在准备发送请求到\x20'+_0x21132f+_0x40f32c(0x22c)+JSON['stringify'](_0x41eba9)+_0x40f32c(0x211)+JSON[_0x40f32c(0x233)](_0x292fb1),'CogService');try{_0x46eeb5=await axios_1['default']['post'](_0x21132f,_0x41eba9,{'headers':_0x292fb1}),common_1[_0x40f32c(0x1ef)][_0x40f32c(0x22b)]('任务提交结果，状态码:\x20'+_0x46eeb5[_0x40f32c(0x221)]+',\x20状态消息:\x20'+_0x46eeb5[_0x40f32c(0x21f)]+_0x40f32c(0x216)+JSON[_0x40f32c(0x233)](_0x46eeb5['data']));}catch(_0x2e5dfe){common_1[_0x40f32c(0x1ef)][_0x40f32c(0x21c)]('任务提交失败:\x20'+_0x2e5dfe['message'],'CogService');throw new Error('任务提交失败');}if((_0x5de4c4=_0x46eeb5===null||_0x46eeb5===void 0x0?void 0x0:_0x46eeb5[_0x40f32c(0x1f2)])===null||_0x5de4c4===void 0x0?void 0x0:_0x5de4c4['id'])_0x33b4eb[_0x40f32c(0x20d)]=(_0x57d5e5=_0x46eeb5===null||_0x46eeb5===void 0x0?void 0x0:_0x46eeb5[_0x40f32c(0x1f2)])===null||_0x57d5e5===void 0x0?void 0x0:_0x57d5e5['id'],common_1[_0x40f32c(0x1ef)][_0x40f32c(0x1ec)](_0x40f32c(0x22f)+((_0x4bc7ef=_0x46eeb5===null||_0x46eeb5===void 0x0?void 0x0:_0x46eeb5['data'])===null||_0x4bc7ef===void 0x0?void 0x0:_0x4bc7ef['id']),_0x40f32c(0x1fb));else throw new Error(_0x40f32c(0x228));try{await this[_0x40f32c(0x231)]({'proxyUrl':_0x543868,'apiKey':_0x8c8bd4,'taskId':_0x46eeb5[_0x40f32c(0x1f2)]['id'],'timeout':_0x2ba064,'prompt':_0x1c0a7d,'onSuccess':async _0x95992=>{const _0x4b50a6=_0x40f32c;try{await this[_0x4b50a6(0x219)][_0x4b50a6(0x235)](_0x271a1f,{'videoUrl':_0x95992===null||_0x95992===void 0x0?void 0x0:_0x95992[_0x4b50a6(0x215)],'audioUrl':_0x95992===null||_0x95992===void 0x0?void 0x0:_0x95992[_0x4b50a6(0x21d)],'fileInfo':_0x95992===null||_0x95992===void 0x0?void 0x0:_0x95992['fileInfo'],'answer':(_0x95992===null||_0x95992===void 0x0?void 0x0:_0x95992['answer'])||_0x1c0a7d,'progress':'100%','status':0x3,'taskId':_0x95992===null||_0x95992===void 0x0?void 0x0:_0x95992['taskId'],'taskData':_0x95992===null||_0x95992===void 0x0?void 0x0:_0x95992['taskData']}),common_1[_0x4b50a6(0x1ef)]['log'](_0x4b50a6(0x201),_0x4b50a6(0x1fb));}catch(_0x1f737c){common_1['Logger']['error']('更新日志失败:\x20'+_0x1f737c[_0x4b50a6(0x220)],'CogService');}},'onGenerating':async _0x2ac5f5=>{const _0x37cf7a=_0x40f32c;try{await this[_0x37cf7a(0x219)][_0x37cf7a(0x235)](_0x271a1f,{'videoUrl':_0x2ac5f5===null||_0x2ac5f5===void 0x0?void 0x0:_0x2ac5f5[_0x37cf7a(0x215)],'audioUrl':_0x2ac5f5===null||_0x2ac5f5===void 0x0?void 0x0:_0x2ac5f5[_0x37cf7a(0x21d)],'fileInfo':_0x2ac5f5===null||_0x2ac5f5===void 0x0?void 0x0:_0x2ac5f5[_0x37cf7a(0x1f7)],'answer':(_0x2ac5f5===null||_0x2ac5f5===void 0x0?void 0x0:_0x2ac5f5['answer'])||_0x37cf7a(0x203),'progress':_0x2ac5f5===null||_0x2ac5f5===void 0x0?void 0x0:_0x2ac5f5[_0x37cf7a(0x1f9)],'status':_0x2ac5f5[_0x37cf7a(0x221)]}),common_1[_0x37cf7a(0x1ef)]['log'](_0x37cf7a(0x203),'CogService');}catch(_0x8e7454){common_1[_0x37cf7a(0x1ef)][_0x37cf7a(0x21c)]('更新日志失败:\x20'+_0x8e7454[_0x37cf7a(0x220)],_0x37cf7a(0x1fb));}},'onFailure':async _0x356403=>{const _0x145225=_0x40f32c;try{await this[_0x145225(0x219)][_0x145225(0x235)](_0x271a1f,{'answer':'视频生成失败','status':_0x356403[_0x145225(0x221)]}),common_1[_0x145225(0x1ef)][_0x145225(0x1ec)](_0x145225(0x227),_0x145225(0x210));}catch(_0xbaf349){common_1['Logger']['error'](_0x145225(0x1ea)+_0xbaf349[_0x145225(0x220)],_0x145225(0x1fb));}}});}catch(_0xbe4b5a){common_1[_0x40f32c(0x1ef)]['error'](_0x40f32c(0x20a),_0xbe4b5a[_0x40f32c(0x220)],_0x40f32c(0x1fb));throw new Error(_0x40f32c(0x1fe));}return _0x33b4eb;}async[_0x60ad23(0x231)](_0x55b69b){const _0x3ef6a4=_0x60ad23,{proxyUrl:_0x2941dd,apiKey:_0x3c6eab,taskId:_0x334e94,timeout:_0x502852,onSuccess:_0x159a80,onFailure:_0x257428,onGenerating:_0x1f74dc,prompt:_0x3c2f6f,action:_0x17de31}=_0x55b69b;let _0x443193={'videoUrl':'','audioUrl':'','fileInfo':'','drawId':'','taskData':'','status':0x2,'progress':0x0,'answer':''};const _0x3929a1={'Authorization':_0x3ef6a4(0x1f5)+_0x3c6eab},_0x43727d=_0x2941dd+'/cogvideox/v4/async-result/'+_0x334e94,_0x4377ac=Date[_0x3ef6a4(0x1f8)](),_0xebe338=0x493e0,_0x6ffb47=0x1388;let _0x298fd4=0x0;try{while(Date['now']()-_0x4377ac<_0x502852){await new Promise(_0x3ea5d8=>setTimeout(_0x3ea5d8,_0x6ffb47));try{const _0x544671=await axios_1[_0x3ef6a4(0x200)]['get'](_0x43727d,{'headers':_0x3929a1}),_0x4ad8a2=setInterval(()=>{const _0x2f823b=_0x3ef6a4,_0x558a=Date[_0x2f823b(0x1f8)]()-_0x4377ac;let _0x29d81a=Math[_0x2f823b(0x21a)](_0x558a/_0xebe338*0x64);if(_0x29d81a>=0x63)_0x29d81a=0x63;_0x443193[_0x2f823b(0x230)]=_0x2f823b(0x204)+_0x29d81a+'%）';},0x3e8),_0x3e701d=_0x544671[_0x3ef6a4(0x1f2)];common_1[_0x3ef6a4(0x1ef)]['debug'](_0x3ef6a4(0x22e)+JSON['stringify'](_0x3e701d),_0x3ef6a4(0x1fb));if(_0x3e701d[_0x3ef6a4(0x218)]===_0x3ef6a4(0x23a)){_0x443193[_0x3ef6a4(0x20d)]=_0x3e701d[_0x3ef6a4(0x22a)],_0x443193['taskData']=JSON[_0x3ef6a4(0x233)](_0x3e701d),common_1['Logger'][_0x3ef6a4(0x1ec)]('视频生成成功',_0x3ef6a4(0x1fb)),_0x443193[_0x3ef6a4(0x1f7)]=_0x3e701d[_0x3ef6a4(0x213)][0x0][_0x3ef6a4(0x1eb)],common_1[_0x3ef6a4(0x1ef)][_0x3ef6a4(0x1ec)](_0x443193[_0x3ef6a4(0x1f7)],_0x3ef6a4(0x1fb));try{const _0xf8db2f=await this[_0x3ef6a4(0x217)][_0x3ef6a4(0x21e)](['localStorageStatus']);if(Number(_0xf8db2f)){const _0x29080f=new Date(),_0xc92e57=_0x29080f[_0x3ef6a4(0x207)](),_0xccc819=String(_0x29080f[_0x3ef6a4(0x1e8)]()+0x1)[_0x3ef6a4(0x239)](0x2,'0'),_0x263311=String(_0x29080f[_0x3ef6a4(0x206)]())[_0x3ef6a4(0x239)](0x2,'0'),_0xd9319c=''+_0xc92e57+_0xccc819+'/'+_0x263311;_0x443193[_0x3ef6a4(0x1f7)]=await this[_0x3ef6a4(0x222)]['uploadFileFromUrl']({'url':_0x3e701d[_0x3ef6a4(0x213)][0x0][_0x3ef6a4(0x1eb)],'dir':_0x3ef6a4(0x1f1)+_0xd9319c});}}catch(_0x4118e4){common_1[_0x3ef6a4(0x1ef)][_0x3ef6a4(0x21c)](_0x3ef6a4(0x1f6)+_0x4118e4[_0x3ef6a4(0x220)],_0x3ef6a4(0x1fb));}_0x443193['answer']='提示词:\x20\x22'+_0x3c2f6f+'\x22',_0x159a80(_0x443193),clearInterval(_0x4ad8a2);return;}else _0x1f74dc(_0x443193);if(_0x443193['progress']){}}catch(_0x18582f){_0x298fd4++,common_1['Logger']['error'](_0x3ef6a4(0x1fd)+_0x298fd4,_0x3ef6a4(0x1fb));}}common_1[_0x3ef6a4(0x1ef)][_0x3ef6a4(0x21c)]('轮询超时，请稍后再试！',_0x3ef6a4(0x1fb)),_0x443193['status']=0x4,_0x257428(_0x443193);throw new Error('查询超时，请稍后再试！');}catch(_0x5b92de){common_1[_0x3ef6a4(0x1ef)][_0x3ef6a4(0x21c)](_0x3ef6a4(0x20c)+_0x5b92de,_0x3ef6a4(0x1fb)),_0x443193[_0x3ef6a4(0x221)]=0x5,_0x257428(_0x443193);}}};function _0x3636(_0x424578,_0x1c4c84){const _0x20768f=_0x2076();return _0x3636=function(_0x36367d,_0xb16115){_0x36367d=_0x36367d-0x1e8;let _0x36f44f=_0x20768f[_0x36367d];return _0x36f44f;},_0x3636(_0x424578,_0x1c4c84);}CogVideoService=__decorate([(0x0,common_1[_0x60ad23(0x225)])(),__metadata(_0x60ad23(0x229),[chatLog_service_1[_0x60ad23(0x237)],globalConfig_service_1[_0x60ad23(0x1f0)],upload_service_1[_0x60ad23(0x212)]])],CogVideoService),exports['CogVideoService']=CogVideoService;