'use strict';const _0x3b0c32=_0x410d;(function(_0x7e3de1,_0x423f3a){const _0x4148d9=_0x410d,_0x5ced6c=_0x7e3de1();while(!![]){try{const _0x3571d1=-parseInt(_0x4148d9(0x1a8))/0x1+-parseInt(_0x4148d9(0x168))/0x2*(-parseInt(_0x4148d9(0x165))/0x3)+parseInt(_0x4148d9(0x192))/0x4*(parseInt(_0x4148d9(0x187))/0x5)+-parseInt(_0x4148d9(0x173))/0x6+-parseInt(_0x4148d9(0x171))/0x7+-parseInt(_0x4148d9(0x1a7))/0x8*(-parseInt(_0x4148d9(0x17e))/0x9)+parseInt(_0x4148d9(0x1a1))/0xa;if(_0x3571d1===_0x423f3a)break;else _0x5ced6c['push'](_0x5ced6c['shift']());}catch(_0x491bd0){_0x5ced6c['push'](_0x5ced6c['shift']());}}}(_0x1cdb,0x1b8a3));function _0x1cdb(){const _0x104b33=['padStart','任务提交成功,\x20任务ID:\x20','Injectable','27CtkPdz','任务提交结果，状态码:\x20','pollCogVideoResult','44094wpKLxn','image_url','request_id','globalConfigService','answer','正在准备发送请求到\x20','now','uploadService','UploadService','1222508xdjZsV','__metadata','1231374bzAFXY','/cogvideox/v4/videos/generations','progress','log','CogVideoService','statusText','Lum\x20aService','视频生成失败','uploadFileFromUrl','decorate','url','9UIJOFN','default','getOwnPropertyDescriptor','上传文件失败:\x20','chatLogService','taskData','localStorageStatus','status','Bearer\x20','7125sYZvkg','message','error','轮询失败，重试次数:\x20','function','data','查询超时，请稍后再试！','design:paramtypes','GlobalConfigService','视频生成中\x20（','Logger','236PwBWez','updateChatLog','audioUrl','../chatLog/chatLog.service','未能获取结果数据,\x20即将重试',',\x20数据:\x20','debug','length',',\x20headers:\x20','轮询过程中发生错误:\x20','stringify','task_status','taskId','getMonth','查询生成结果时发生错误','2113520xHrDpo','fileInfo','getFullYear','CogService','video/cog/','更新日志失败:\x20','797752ydbMQR','100893WOCGLN','defineProperty','floor','视频生成中...','SUCCESS','生成失败','object','任务提交失败','__decorate',',\x20状态消息:\x20','../globalConfig/globalConfig.service','video_result','getConfigs','videoUrl','cogVideo'];_0x1cdb=function(){return _0x104b33;};return _0x1cdb();}function _0x410d(_0x1fd813,_0x522217){const _0x1cdb48=_0x1cdb();return _0x410d=function(_0x410dd8,_0xb4df22){_0x410dd8=_0x410dd8-0x15e;let _0x3fe1fb=_0x1cdb48[_0x410dd8];return _0x3fe1fb;},_0x410d(_0x1fd813,_0x522217);}var __decorate=this&&this[_0x3b0c32(0x1b0)]||function(_0x3c2c23,_0x34e27a,_0x36c03d,_0x3eb59f){const _0x30af9c=_0x3b0c32;var _0x57a583=arguments[_0x30af9c(0x199)],_0x195c50=_0x57a583<0x3?_0x34e27a:_0x3eb59f===null?_0x3eb59f=Object[_0x30af9c(0x180)](_0x34e27a,_0x36c03d):_0x3eb59f,_0x169de0;if(typeof Reflect===_0x30af9c(0x1ae)&&typeof Reflect['decorate']===_0x30af9c(0x18b))_0x195c50=Reflect[_0x30af9c(0x17c)](_0x3c2c23,_0x34e27a,_0x36c03d,_0x3eb59f);else{for(var _0x1bb8b7=_0x3c2c23['length']-0x1;_0x1bb8b7>=0x0;_0x1bb8b7--)if(_0x169de0=_0x3c2c23[_0x1bb8b7])_0x195c50=(_0x57a583<0x3?_0x169de0(_0x195c50):_0x57a583>0x3?_0x169de0(_0x34e27a,_0x36c03d,_0x195c50):_0x169de0(_0x34e27a,_0x36c03d))||_0x195c50;}return _0x57a583>0x3&&_0x195c50&&Object[_0x30af9c(0x1a9)](_0x34e27a,_0x36c03d,_0x195c50),_0x195c50;},__metadata=this&&this[_0x3b0c32(0x172)]||function(_0x3dbfad,_0x50249c){const _0x425e6e=_0x3b0c32;if(typeof Reflect===_0x425e6e(0x1ae)&&typeof Reflect['metadata']===_0x425e6e(0x18b))return Reflect['metadata'](_0x3dbfad,_0x50249c);};Object[_0x3b0c32(0x1a9)](exports,'__esModule',{'value':!![]}),exports[_0x3b0c32(0x177)]=void 0x0;const common_1=require('@nestjs/common'),axios_1=require('axios'),chatLog_service_1=require(_0x3b0c32(0x195)),globalConfig_service_1=require(_0x3b0c32(0x1b2)),upload_service_1=require('../upload/upload.service');let CogVideoService=class CogVideoService{constructor(_0x336943,_0x498265,_0x35fa45){const _0x376045=_0x3b0c32;this[_0x376045(0x182)]=_0x336943,this['globalConfigService']=_0x498265,this[_0x376045(0x16f)]=_0x35fa45;}async[_0x3b0c32(0x161)](_0x4cc189){const _0x314444=_0x3b0c32;var _0x51bd5e,_0x5f4483,_0xba9382;const {apiKey:_0x4afd78,proxyUrl:_0x11dfac,fileInfo:_0x38935e,prompt:_0x214c07,timeout:_0x2aba05,assistantLogId:_0x6b347}=_0x4cc189;let _0x3a294b={'text':'','fileInfo':'','taskId':'','taskData':'','status':0x2},_0x12beac=null,_0x2cec2b='',_0x3b82fe={};const _0x261683={'Authorization':_0x314444(0x186)+_0x4afd78};_0x2cec2b=_0x11dfac+_0x314444(0x174),_0x3b82fe={'model':'cogvideox','prompt':_0x214c07};_0x38935e&&(_0x3b82fe[_0x314444(0x169)]=_0x38935e);common_1['Logger'][_0x314444(0x176)](_0x314444(0x16d)+_0x2cec2b+'，payload:\x20'+JSON[_0x314444(0x19c)](_0x3b82fe)+_0x314444(0x19a)+JSON[_0x314444(0x19c)](_0x261683),'CogService');try{_0x12beac=await axios_1[_0x314444(0x17f)]['post'](_0x2cec2b,_0x3b82fe,{'headers':_0x261683}),common_1[_0x314444(0x191)][_0x314444(0x198)](_0x314444(0x166)+_0x12beac[_0x314444(0x185)]+_0x314444(0x1b1)+_0x12beac[_0x314444(0x178)]+_0x314444(0x197)+JSON[_0x314444(0x19c)](_0x12beac[_0x314444(0x18c)]));}catch(_0x17273c){common_1['Logger'][_0x314444(0x189)]('任务提交失败:\x20'+_0x17273c[_0x314444(0x188)],'CogService');throw new Error(_0x314444(0x1af));}if((_0x51bd5e=_0x12beac===null||_0x12beac===void 0x0?void 0x0:_0x12beac[_0x314444(0x18c)])===null||_0x51bd5e===void 0x0?void 0x0:_0x51bd5e['id'])_0x3a294b['taskId']=(_0x5f4483=_0x12beac===null||_0x12beac===void 0x0?void 0x0:_0x12beac[_0x314444(0x18c)])===null||_0x5f4483===void 0x0?void 0x0:_0x5f4483['id'],common_1['Logger'][_0x314444(0x176)](_0x314444(0x163)+((_0xba9382=_0x12beac===null||_0x12beac===void 0x0?void 0x0:_0x12beac[_0x314444(0x18c)])===null||_0xba9382===void 0x0?void 0x0:_0xba9382['id']),_0x314444(0x1a4));else throw new Error(_0x314444(0x196));try{await this[_0x314444(0x167)]({'proxyUrl':_0x11dfac,'apiKey':_0x4afd78,'taskId':_0x12beac['data']['id'],'timeout':_0x2aba05,'prompt':_0x214c07,'onSuccess':async _0x27af69=>{const _0x582708=_0x314444;try{await this[_0x582708(0x182)]['updateChatLog'](_0x6b347,{'videoUrl':_0x27af69===null||_0x27af69===void 0x0?void 0x0:_0x27af69[_0x582708(0x160)],'audioUrl':_0x27af69===null||_0x27af69===void 0x0?void 0x0:_0x27af69[_0x582708(0x194)],'fileInfo':_0x27af69===null||_0x27af69===void 0x0?void 0x0:_0x27af69[_0x582708(0x1a2)],'answer':(_0x27af69===null||_0x27af69===void 0x0?void 0x0:_0x27af69['answer'])||_0x214c07,'progress':'100%','status':0x3,'taskId':_0x27af69===null||_0x27af69===void 0x0?void 0x0:_0x27af69[_0x582708(0x19e)],'taskData':_0x27af69===null||_0x27af69===void 0x0?void 0x0:_0x27af69[_0x582708(0x183)]}),common_1[_0x582708(0x191)]['log']('视频任务已完成',_0x582708(0x1a4));}catch(_0xe12949){common_1[_0x582708(0x191)]['error']('更新日志失败:\x20'+_0xe12949[_0x582708(0x188)],_0x582708(0x1a4));}},'onGenerating':async _0x56788c=>{const _0x441474=_0x314444;try{await this['chatLogService'][_0x441474(0x193)](_0x6b347,{'videoUrl':_0x56788c===null||_0x56788c===void 0x0?void 0x0:_0x56788c['videoUrl'],'audioUrl':_0x56788c===null||_0x56788c===void 0x0?void 0x0:_0x56788c['audioUrl'],'fileInfo':_0x56788c===null||_0x56788c===void 0x0?void 0x0:_0x56788c[_0x441474(0x1a2)],'answer':(_0x56788c===null||_0x56788c===void 0x0?void 0x0:_0x56788c[_0x441474(0x16c)])||_0x441474(0x1ab),'progress':_0x56788c===null||_0x56788c===void 0x0?void 0x0:_0x56788c[_0x441474(0x175)],'status':_0x56788c[_0x441474(0x185)]}),common_1['Logger'][_0x441474(0x176)](_0x441474(0x1ab),_0x441474(0x1a4));}catch(_0x5461dd){common_1['Logger'][_0x441474(0x189)](_0x441474(0x1a6)+_0x5461dd[_0x441474(0x188)],_0x441474(0x1a4));}},'onFailure':async _0x194a57=>{const _0x5ae0b4=_0x314444;try{await this[_0x5ae0b4(0x182)][_0x5ae0b4(0x193)](_0x6b347,{'answer':_0x5ae0b4(0x17a),'status':_0x194a57['status']}),common_1[_0x5ae0b4(0x191)][_0x5ae0b4(0x176)](_0x5ae0b4(0x1ad),_0x5ae0b4(0x179));}catch(_0x47f625){common_1[_0x5ae0b4(0x191)][_0x5ae0b4(0x189)](_0x5ae0b4(0x1a6)+_0x47f625[_0x5ae0b4(0x188)],'CogService');}}});}catch(_0x1aa0ec){common_1['Logger'][_0x314444(0x189)]('查询生成结果时发生错误:',_0x1aa0ec[_0x314444(0x188)],_0x314444(0x1a4));throw new Error(_0x314444(0x1a0));}return _0x3a294b;}async[_0x3b0c32(0x167)](_0x4da099){const _0x3e045e=_0x3b0c32,{proxyUrl:_0x544d05,apiKey:_0x2869b1,taskId:_0x1188bd,timeout:_0xa02be6,onSuccess:_0x4ff0d2,onFailure:_0x1fd7ca,onGenerating:_0x23bb14,prompt:_0x1ca136,action:_0xb5cd87}=_0x4da099;let _0x5508a4={'videoUrl':'','audioUrl':'','fileInfo':'','drawId':'','taskData':'','status':0x2,'progress':0x0,'answer':''};const _0x3a3b88={'Authorization':_0x3e045e(0x186)+_0x2869b1},_0x1e5694=_0x544d05+'/cogvideox/v4/async-result/'+_0x1188bd,_0x737220=Date[_0x3e045e(0x16e)](),_0x41d197=0x493e0,_0x52b06a=0x1388;let _0xad54e6=0x0;try{while(Date[_0x3e045e(0x16e)]()-_0x737220<_0xa02be6){await new Promise(_0x84cc6c=>setTimeout(_0x84cc6c,_0x52b06a));try{const _0x40cf99=await axios_1['default']['get'](_0x1e5694,{'headers':_0x3a3b88}),_0x432fca=setInterval(()=>{const _0x51a7a0=_0x3e045e,_0x9a5aba=Date[_0x51a7a0(0x16e)]()-_0x737220;let _0x2943fe=Math[_0x51a7a0(0x1aa)](_0x9a5aba/_0x41d197*0x64);if(_0x2943fe>=0x63)_0x2943fe=0x63;_0x5508a4[_0x51a7a0(0x16c)]=_0x51a7a0(0x190)+_0x2943fe+'%）';},0x3e8),_0x35970b=_0x40cf99[_0x3e045e(0x18c)];common_1[_0x3e045e(0x191)][_0x3e045e(0x198)]('轮询结果:\x20'+JSON[_0x3e045e(0x19c)](_0x35970b),'CogService');if(_0x35970b[_0x3e045e(0x19d)]===_0x3e045e(0x1ac)){_0x5508a4[_0x3e045e(0x19e)]=_0x35970b[_0x3e045e(0x16a)],_0x5508a4[_0x3e045e(0x183)]=JSON[_0x3e045e(0x19c)](_0x35970b),common_1[_0x3e045e(0x191)][_0x3e045e(0x176)]('视频生成成功',_0x3e045e(0x1a4)),_0x5508a4[_0x3e045e(0x1a2)]=_0x35970b[_0x3e045e(0x15e)][0x0]['url'],common_1[_0x3e045e(0x191)]['log'](_0x5508a4['fileInfo'],_0x3e045e(0x1a4));try{const _0xf1196c=await this[_0x3e045e(0x16b)][_0x3e045e(0x15f)]([_0x3e045e(0x184)]);if(Number(_0xf1196c)){const _0x2748e9=new Date(),_0x25df20=_0x2748e9[_0x3e045e(0x1a3)](),_0x42be60=String(_0x2748e9[_0x3e045e(0x19f)]()+0x1)[_0x3e045e(0x162)](0x2,'0'),_0xd80333=String(_0x2748e9['getDate']())[_0x3e045e(0x162)](0x2,'0'),_0x94026=''+_0x25df20+_0x42be60+'/'+_0xd80333;_0x5508a4[_0x3e045e(0x1a2)]=await this[_0x3e045e(0x16f)][_0x3e045e(0x17b)]({'url':_0x35970b[_0x3e045e(0x15e)][0x0][_0x3e045e(0x17d)],'dir':_0x3e045e(0x1a5)+_0x94026});}}catch(_0x5ed452){common_1[_0x3e045e(0x191)][_0x3e045e(0x189)](_0x3e045e(0x181)+_0x5ed452['message'],_0x3e045e(0x1a4));}_0x5508a4[_0x3e045e(0x16c)]='提示词:\x20\x22'+_0x1ca136+'\x22',_0x4ff0d2(_0x5508a4),clearInterval(_0x432fca);return;}else _0x23bb14(_0x5508a4);if(_0x5508a4[_0x3e045e(0x175)]){}}catch(_0x5b7a57){_0xad54e6++,common_1[_0x3e045e(0x191)]['error'](_0x3e045e(0x18a)+_0xad54e6,_0x3e045e(0x1a4));}}common_1[_0x3e045e(0x191)]['error']('轮询超时，请稍后再试！','CogService'),_0x5508a4[_0x3e045e(0x185)]=0x4,_0x1fd7ca(_0x5508a4);throw new Error(_0x3e045e(0x18d));}catch(_0x516c32){common_1[_0x3e045e(0x191)][_0x3e045e(0x189)](_0x3e045e(0x19b)+_0x516c32,_0x3e045e(0x1a4)),_0x5508a4[_0x3e045e(0x185)]=0x5,_0x1fd7ca(_0x5508a4);}}};CogVideoService=__decorate([(0x0,common_1[_0x3b0c32(0x164)])(),__metadata(_0x3b0c32(0x18e),[chatLog_service_1['ChatLogService'],globalConfig_service_1[_0x3b0c32(0x18f)],upload_service_1[_0x3b0c32(0x170)]])],CogVideoService),exports['CogVideoService']=CogVideoService;