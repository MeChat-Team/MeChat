'use strict';const _0x10a1ae=_0x17eb;(function(_0x225056,_0x152f78){const _0x1e0ec9=_0x17eb,_0x34a3c0=_0x225056();while(!![]){try{const _0x349c10=parseInt(_0x1e0ec9(0x13e))/0x1*(-parseInt(_0x1e0ec9(0x184))/0x2)+-parseInt(_0x1e0ec9(0x154))/0x3*(-parseInt(_0x1e0ec9(0x18f))/0x4)+-parseInt(_0x1e0ec9(0x168))/0x5+parseInt(_0x1e0ec9(0x15f))/0x6+parseInt(_0x1e0ec9(0x15e))/0x7+-parseInt(_0x1e0ec9(0x14c))/0x8+parseInt(_0x1e0ec9(0x192))/0x9;if(_0x349c10===_0x152f78)break;else _0x34a3c0['push'](_0x34a3c0['shift']());}catch(_0x3a633a){_0x34a3c0['push'](_0x34a3c0['shift']());}}}(_0x2cdc,0x3ca75));function _0x2cdc(){const _0x4abd7e=['CogVideoService','data','876aPnsdP','ChatLogService','视频任务已完成','2882637PJbgae','轮询失败，重试次数:\x20','getDate','/cogvideox/v4/videos/generations','design:paramtypes','未能获取结果数据,\x20即将重试','request_id','视频生成失败','更新日志失败:\x20','Lum\x20aService','padStart','__esModule','11eCAstj','stringify','cogvideox','任务提交失败','轮询超时，请稍后再试！','log','Injectable','chatLogService','default','audioUrl','video/cog/','getConfigs','error','object','1508984mkfGXV','defineProperty','url','SUCCESS','globalConfigService','progress','查询生成结果时发生错误:','function','5703RGBSXi','轮询过程中发生错误:\x20','video_result','localStorageStatus','提示词:\x20\x22','axios','轮询结果:\x20','debug','/cogvideox/v4/async-result/','UploadService','2412683BWPLMF','665652zlJIsf','length','taskData','message','cogVideo','视频生成中...','videoUrl','updateChatLog','查询生成结果时发生错误','2069000rMuMXO','GlobalConfigService','decorate','image_url','floor',',\x20状态消息:\x20','uploadService','getOwnPropertyDescriptor','__decorate','metadata','../chatLog/chatLog.service',',\x20数据:\x20','task_status','fileInfo','Logger','Bearer\x20','__metadata','上传文件失败:\x20','查询超时，请稍后再试！','../globalConfig/globalConfig.service','answer','任务提交失败:\x20','now','status','正在准备发送请求到\x20','视频生成成功','uploadFileFromUrl','get','62066AcRmdv','任务提交结果，状态码:\x20','taskId','statusText','pollCogVideoResult',',\x20headers:\x20','100%','@nestjs/common','CogService'];_0x2cdc=function(){return _0x4abd7e;};return _0x2cdc();}var __decorate=this&&this[_0x10a1ae(0x170)]||function(_0x46ca37,_0xb478c7,_0x3e7a15,_0x158a1c){const _0x76802a=_0x10a1ae;var _0x564dc5=arguments[_0x76802a(0x160)],_0x1b25a5=_0x564dc5<0x3?_0xb478c7:_0x158a1c===null?_0x158a1c=Object[_0x76802a(0x16f)](_0xb478c7,_0x3e7a15):_0x158a1c,_0x22d8ab;if(typeof Reflect===_0x76802a(0x14b)&&typeof Reflect[_0x76802a(0x16a)]==='function')_0x1b25a5=Reflect['decorate'](_0x46ca37,_0xb478c7,_0x3e7a15,_0x158a1c);else{for(var _0x343d16=_0x46ca37[_0x76802a(0x160)]-0x1;_0x343d16>=0x0;_0x343d16--)if(_0x22d8ab=_0x46ca37[_0x343d16])_0x1b25a5=(_0x564dc5<0x3?_0x22d8ab(_0x1b25a5):_0x564dc5>0x3?_0x22d8ab(_0xb478c7,_0x3e7a15,_0x1b25a5):_0x22d8ab(_0xb478c7,_0x3e7a15))||_0x1b25a5;}return _0x564dc5>0x3&&_0x1b25a5&&Object[_0x76802a(0x14d)](_0xb478c7,_0x3e7a15,_0x1b25a5),_0x1b25a5;},__metadata=this&&this[_0x10a1ae(0x178)]||function(_0x5bd90e,_0x5bacbf){const _0x14a91a=_0x10a1ae;if(typeof Reflect==='object'&&typeof Reflect[_0x14a91a(0x171)]===_0x14a91a(0x153))return Reflect['metadata'](_0x5bd90e,_0x5bacbf);};Object[_0x10a1ae(0x14d)](exports,_0x10a1ae(0x13d),{'value':!![]}),exports[_0x10a1ae(0x18d)]=void 0x0;const common_1=require(_0x10a1ae(0x18b)),axios_1=require(_0x10a1ae(0x159)),chatLog_service_1=require(_0x10a1ae(0x172)),globalConfig_service_1=require(_0x10a1ae(0x17b)),upload_service_1=require('../upload/upload.service');function _0x17eb(_0x1ef179,_0x1f06ed){const _0x2cdcba=_0x2cdc();return _0x17eb=function(_0x17eb3b,_0x570499){_0x17eb3b=_0x17eb3b-0x139;let _0x3f75fc=_0x2cdcba[_0x17eb3b];return _0x3f75fc;},_0x17eb(_0x1ef179,_0x1f06ed);}let CogVideoService=class CogVideoService{constructor(_0x5ccfe0,_0x56058d,_0x5275f5){const _0x12bf32=_0x10a1ae;this[_0x12bf32(0x145)]=_0x5ccfe0,this[_0x12bf32(0x150)]=_0x56058d,this[_0x12bf32(0x16e)]=_0x5275f5;}async[_0x10a1ae(0x163)](_0x5706b1){const _0x788e4e=_0x10a1ae;var _0x4bfc6d,_0x76fc61,_0x2e9ef6;const {apiKey:_0x581275,proxyUrl:_0x494817,fileInfo:_0x2d7cff,prompt:_0x45c77f,timeout:_0x54b946,assistantLogId:_0x422bda}=_0x5706b1;let _0x44214a={'text':'','fileInfo':'','taskId':'','taskData':'','status':0x2},_0x177462=null,_0x203863='',_0xd0e1db={};const _0x2fb783={'Authorization':_0x788e4e(0x177)+_0x581275};_0x203863=_0x494817+_0x788e4e(0x195),_0xd0e1db={'model':_0x788e4e(0x140),'prompt':_0x45c77f};_0x2d7cff&&(_0xd0e1db[_0x788e4e(0x16b)]=_0x2d7cff);common_1['Logger'][_0x788e4e(0x143)](_0x788e4e(0x180)+_0x203863+'，payload:\x20'+JSON[_0x788e4e(0x13f)](_0xd0e1db)+_0x788e4e(0x189)+JSON[_0x788e4e(0x13f)](_0x2fb783),_0x788e4e(0x18c));try{_0x177462=await axios_1[_0x788e4e(0x146)]['post'](_0x203863,_0xd0e1db,{'headers':_0x2fb783}),common_1[_0x788e4e(0x176)][_0x788e4e(0x15b)](_0x788e4e(0x185)+_0x177462[_0x788e4e(0x17f)]+_0x788e4e(0x16d)+_0x177462[_0x788e4e(0x187)]+_0x788e4e(0x173)+JSON[_0x788e4e(0x13f)](_0x177462[_0x788e4e(0x18e)]));}catch(_0x593f16){common_1[_0x788e4e(0x176)][_0x788e4e(0x14a)](_0x788e4e(0x17d)+_0x593f16['message'],_0x788e4e(0x18c));throw new Error(_0x788e4e(0x141));}if((_0x4bfc6d=_0x177462===null||_0x177462===void 0x0?void 0x0:_0x177462[_0x788e4e(0x18e)])===null||_0x4bfc6d===void 0x0?void 0x0:_0x4bfc6d['id'])_0x44214a[_0x788e4e(0x186)]=(_0x76fc61=_0x177462===null||_0x177462===void 0x0?void 0x0:_0x177462[_0x788e4e(0x18e)])===null||_0x76fc61===void 0x0?void 0x0:_0x76fc61['id'],common_1[_0x788e4e(0x176)][_0x788e4e(0x143)]('任务提交成功,\x20任务ID:\x20'+((_0x2e9ef6=_0x177462===null||_0x177462===void 0x0?void 0x0:_0x177462[_0x788e4e(0x18e)])===null||_0x2e9ef6===void 0x0?void 0x0:_0x2e9ef6['id']),_0x788e4e(0x18c));else throw new Error(_0x788e4e(0x197));try{await this[_0x788e4e(0x188)]({'proxyUrl':_0x494817,'apiKey':_0x581275,'taskId':_0x177462['data']['id'],'timeout':_0x54b946,'prompt':_0x45c77f,'onSuccess':async _0x32c4ad=>{const _0x2e44e4=_0x788e4e;try{await this[_0x2e44e4(0x145)][_0x2e44e4(0x166)](_0x422bda,{'videoUrl':_0x32c4ad===null||_0x32c4ad===void 0x0?void 0x0:_0x32c4ad[_0x2e44e4(0x165)],'audioUrl':_0x32c4ad===null||_0x32c4ad===void 0x0?void 0x0:_0x32c4ad[_0x2e44e4(0x147)],'fileInfo':_0x32c4ad===null||_0x32c4ad===void 0x0?void 0x0:_0x32c4ad[_0x2e44e4(0x175)],'answer':(_0x32c4ad===null||_0x32c4ad===void 0x0?void 0x0:_0x32c4ad[_0x2e44e4(0x17c)])||_0x45c77f,'progress':_0x2e44e4(0x18a),'status':0x3,'taskId':_0x32c4ad===null||_0x32c4ad===void 0x0?void 0x0:_0x32c4ad['taskId'],'taskData':_0x32c4ad===null||_0x32c4ad===void 0x0?void 0x0:_0x32c4ad[_0x2e44e4(0x161)]}),common_1[_0x2e44e4(0x176)][_0x2e44e4(0x143)](_0x2e44e4(0x191),_0x2e44e4(0x18c));}catch(_0x55be3e){common_1[_0x2e44e4(0x176)][_0x2e44e4(0x14a)](_0x2e44e4(0x13a)+_0x55be3e[_0x2e44e4(0x162)],'CogService');}},'onGenerating':async _0x460dce=>{const _0x397932=_0x788e4e;try{await this['chatLogService']['updateChatLog'](_0x422bda,{'videoUrl':_0x460dce===null||_0x460dce===void 0x0?void 0x0:_0x460dce[_0x397932(0x165)],'audioUrl':_0x460dce===null||_0x460dce===void 0x0?void 0x0:_0x460dce[_0x397932(0x147)],'fileInfo':_0x460dce===null||_0x460dce===void 0x0?void 0x0:_0x460dce[_0x397932(0x175)],'answer':(_0x460dce===null||_0x460dce===void 0x0?void 0x0:_0x460dce['answer'])||'视频生成中...','progress':_0x460dce===null||_0x460dce===void 0x0?void 0x0:_0x460dce['progress'],'status':_0x460dce[_0x397932(0x17f)]}),common_1[_0x397932(0x176)][_0x397932(0x143)](_0x397932(0x164),_0x397932(0x18c));}catch(_0x57bfe6){common_1[_0x397932(0x176)][_0x397932(0x14a)](_0x397932(0x13a)+_0x57bfe6[_0x397932(0x162)],'CogService');}},'onFailure':async _0x30138f=>{const _0x43118e=_0x788e4e;try{await this[_0x43118e(0x145)][_0x43118e(0x166)](_0x422bda,{'answer':_0x43118e(0x139),'status':_0x30138f[_0x43118e(0x17f)]}),common_1[_0x43118e(0x176)][_0x43118e(0x143)]('生成失败',_0x43118e(0x13b));}catch(_0x43a7b1){common_1[_0x43118e(0x176)]['error'](_0x43118e(0x13a)+_0x43a7b1['message'],_0x43118e(0x18c));}}});}catch(_0xfc5ea0){common_1[_0x788e4e(0x176)][_0x788e4e(0x14a)](_0x788e4e(0x152),_0xfc5ea0['message'],_0x788e4e(0x18c));throw new Error(_0x788e4e(0x167));}return _0x44214a;}async[_0x10a1ae(0x188)](_0x303caa){const _0x850d85=_0x10a1ae,{proxyUrl:_0x759b22,apiKey:_0x56034d,taskId:_0x52ea96,timeout:_0xa97c50,onSuccess:_0x1eff6c,onFailure:_0x12be5a,onGenerating:_0xe96591,prompt:_0x14d067,action:_0x234f82}=_0x303caa;let _0x2e603a={'videoUrl':'','audioUrl':'','fileInfo':'','drawId':'','taskData':'','status':0x2,'progress':0x0,'answer':''};const _0x1c656b={'Authorization':'Bearer\x20'+_0x56034d},_0x9b5259=_0x759b22+_0x850d85(0x15c)+_0x52ea96,_0x2dbae8=Date['now'](),_0x103c3f=0x493e0,_0x1a0f7d=0x1388;let _0x4614df=0x0;try{while(Date['now']()-_0x2dbae8<_0xa97c50){await new Promise(_0x1caa2d=>setTimeout(_0x1caa2d,_0x1a0f7d));try{const _0x58fc04=await axios_1[_0x850d85(0x146)][_0x850d85(0x183)](_0x9b5259,{'headers':_0x1c656b}),_0x148ebd=setInterval(()=>{const _0x456c78=_0x850d85,_0xeefa50=Date[_0x456c78(0x17e)]()-_0x2dbae8;let _0x520e4f=Math[_0x456c78(0x16c)](_0xeefa50/_0x103c3f*0x64);if(_0x520e4f>=0x63)_0x520e4f=0x63;_0x2e603a[_0x456c78(0x17c)]='视频生成中\x20（'+_0x520e4f+'%）';},0x3e8),_0x393144=_0x58fc04[_0x850d85(0x18e)];common_1[_0x850d85(0x176)][_0x850d85(0x15b)](_0x850d85(0x15a)+JSON[_0x850d85(0x13f)](_0x393144),_0x850d85(0x18c));if(_0x393144[_0x850d85(0x174)]===_0x850d85(0x14f)){_0x2e603a[_0x850d85(0x186)]=_0x393144[_0x850d85(0x198)],_0x2e603a[_0x850d85(0x161)]=JSON[_0x850d85(0x13f)](_0x393144),common_1[_0x850d85(0x176)][_0x850d85(0x143)](_0x850d85(0x181),_0x850d85(0x18c)),_0x2e603a[_0x850d85(0x175)]=_0x393144['video_result'][0x0][_0x850d85(0x14e)],common_1['Logger'][_0x850d85(0x143)](_0x2e603a[_0x850d85(0x175)],_0x850d85(0x18c));try{const _0x58926e=await this[_0x850d85(0x150)][_0x850d85(0x149)]([_0x850d85(0x157)]);if(Number(_0x58926e)){const _0x4f2eca=new Date(),_0x2edd88=_0x4f2eca['getFullYear'](),_0xb10a58=String(_0x4f2eca['getMonth']()+0x1)['padStart'](0x2,'0'),_0x2cd32c=String(_0x4f2eca[_0x850d85(0x194)]())[_0x850d85(0x13c)](0x2,'0'),_0x1db7c2=''+_0x2edd88+_0xb10a58+'/'+_0x2cd32c;_0x2e603a['fileInfo']=await this['uploadService'][_0x850d85(0x182)]({'url':_0x393144[_0x850d85(0x156)][0x0][_0x850d85(0x14e)],'dir':_0x850d85(0x148)+_0x1db7c2});}}catch(_0x3f12d3){common_1[_0x850d85(0x176)]['error'](_0x850d85(0x179)+_0x3f12d3[_0x850d85(0x162)],_0x850d85(0x18c));}_0x2e603a['answer']=_0x850d85(0x158)+_0x14d067+'\x22',_0x1eff6c(_0x2e603a),clearInterval(_0x148ebd);return;}else _0xe96591(_0x2e603a);if(_0x2e603a[_0x850d85(0x151)]){}}catch(_0x454a7e){_0x4614df++,common_1[_0x850d85(0x176)][_0x850d85(0x14a)](_0x850d85(0x193)+_0x4614df,_0x850d85(0x18c));}}common_1[_0x850d85(0x176)][_0x850d85(0x14a)](_0x850d85(0x142),_0x850d85(0x18c)),_0x2e603a[_0x850d85(0x17f)]=0x4,_0x12be5a(_0x2e603a);throw new Error(_0x850d85(0x17a));}catch(_0x34a6a6){common_1[_0x850d85(0x176)][_0x850d85(0x14a)](_0x850d85(0x155)+_0x34a6a6,'CogService'),_0x2e603a[_0x850d85(0x17f)]=0x5,_0x12be5a(_0x2e603a);}}};CogVideoService=__decorate([(0x0,common_1[_0x10a1ae(0x144)])(),__metadata(_0x10a1ae(0x196),[chatLog_service_1[_0x10a1ae(0x190)],globalConfig_service_1[_0x10a1ae(0x169)],upload_service_1[_0x10a1ae(0x15d)]])],CogVideoService),exports[_0x10a1ae(0x18d)]=CogVideoService;