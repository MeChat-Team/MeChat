'use strict';const _0x93cd43=_0x276c;(function(_0x2c0c43,_0xe2a019){const _0x3b3c28=_0x276c,_0x1b3a8c=_0x2c0c43();while(!![]){try{const _0x477f03=-parseInt(_0x3b3c28(0xa8))/0x1*(parseInt(_0x3b3c28(0xc8))/0x2)+-parseInt(_0x3b3c28(0xb2))/0x3+-parseInt(_0x3b3c28(0x8e))/0x4*(parseInt(_0x3b3c28(0xc3))/0x5)+parseInt(_0x3b3c28(0xa2))/0x6*(-parseInt(_0x3b3c28(0x92))/0x7)+-parseInt(_0x3b3c28(0xca))/0x8*(-parseInt(_0x3b3c28(0x9b))/0x9)+-parseInt(_0x3b3c28(0x94))/0xa+parseInt(_0x3b3c28(0x9d))/0xb*(parseInt(_0x3b3c28(0x8a))/0xc);if(_0x477f03===_0xe2a019)break;else _0x1b3a8c['push'](_0x1b3a8c['shift']());}catch(_0x612574){_0x1b3a8c['push'](_0x1b3a8c['shift']());}}}(_0x2200,0x4427a));function _0x2200(){const _0x43229d=['视频生成中\x20（','log','CogVideoService','cogvideox','statusText','design:paramtypes','taskData','视频生成失败','Logger','GlobalConfigService','正在准备发送请求到\x20','uploadFileFromUrl','getDate','error','任务提交失败','get','taskId','4257588EJrYFB',',\x20headers:\x20','videoUrl','default','1364oIPRmf','更新日志失败:\x20','任务提交成功,\x20任务ID:\x20','Lum\x20aService','28182aIOxNQ','__esModule','991780daylzR','查询超时，请稍后再试！','stringify','UploadService','defineProperty','轮询过程中发生错误:\x20','pollCogVideoResult','2295VKvfzM','uploadService','44vymjzP',',\x20数据:\x20','任务提交失败:\x20','未能获取结果数据,\x20即将重试','post','30wgyrqI','getConfigs','function','getOwnPropertyDescriptor','cogVideo','CogService','1399eeYmjF','axios','轮询超时，请稍后再试！','video_result','轮询结果:\x20','answer','100%','request_id','SUCCESS','status','1290297wvCNyT','updateChatLog','progress','decorate','查询生成结果时发生错误','__decorate','now','length','任务提交结果，状态码:\x20','Bearer\x20','上传文件失败:\x20',',\x20状态消息:\x20','/cogvideox/v4/videos/generations','metadata','提示词:\x20\x22','globalConfigService','../globalConfig/globalConfig.service','3620AFMoKn','ChatLogService','@nestjs/common','video/cog/','chatLogService','654jteIpN','floor','3568pPlHmh','url','查询生成结果时发生错误:','fileInfo','视频生成成功','../upload/upload.service','padStart','视频任务已完成','data','debug','视频生成中...','message','getFullYear'];_0x2200=function(){return _0x43229d;};return _0x2200();}var __decorate=this&&this[_0x93cd43(0xb7)]||function(_0x5db8af,_0x260c5d,_0x804894,_0x5ba169){const _0x3615b8=_0x93cd43;var _0x47f135=arguments[_0x3615b8(0xb9)],_0x3c6218=_0x47f135<0x3?_0x260c5d:_0x5ba169===null?_0x5ba169=Object[_0x3615b8(0xa5)](_0x260c5d,_0x804894):_0x5ba169,_0x2dd496;if(typeof Reflect==='object'&&typeof Reflect['decorate']===_0x3615b8(0xa4))_0x3c6218=Reflect[_0x3615b8(0xb5)](_0x5db8af,_0x260c5d,_0x804894,_0x5ba169);else{for(var _0x430ed9=_0x5db8af['length']-0x1;_0x430ed9>=0x0;_0x430ed9--)if(_0x2dd496=_0x5db8af[_0x430ed9])_0x3c6218=(_0x47f135<0x3?_0x2dd496(_0x3c6218):_0x47f135>0x3?_0x2dd496(_0x260c5d,_0x804894,_0x3c6218):_0x2dd496(_0x260c5d,_0x804894))||_0x3c6218;}return _0x47f135>0x3&&_0x3c6218&&Object[_0x3615b8(0x98)](_0x260c5d,_0x804894,_0x3c6218),_0x3c6218;},__metadata=this&&this['__metadata']||function(_0xfed31e,_0xf8f8db){const _0x2ac4d6=_0x93cd43;if(typeof Reflect==='object'&&typeof Reflect[_0x2ac4d6(0xbf)]==='function')return Reflect[_0x2ac4d6(0xbf)](_0xfed31e,_0xf8f8db);};function _0x276c(_0x310b4f,_0x255941){const _0x2200e3=_0x2200();return _0x276c=function(_0x276cbb,_0x4e2a39){_0x276cbb=_0x276cbb-0x85;let _0x12d986=_0x2200e3[_0x276cbb];return _0x12d986;},_0x276c(_0x310b4f,_0x255941);}Object[_0x93cd43(0x98)](exports,_0x93cd43(0x93),{'value':!![]}),exports[_0x93cd43(0xd9)]=void 0x0;const common_1=require(_0x93cd43(0xc5)),axios_1=require(_0x93cd43(0xa9)),chatLog_service_1=require('../chatLog/chatLog.service'),globalConfig_service_1=require(_0x93cd43(0xc2)),upload_service_1=require(_0x93cd43(0xcf));let CogVideoService=class CogVideoService{constructor(_0x50604c,_0x4da7e8,_0x51a160){const _0x229444=_0x93cd43;this['chatLogService']=_0x50604c,this['globalConfigService']=_0x4da7e8,this[_0x229444(0x9c)]=_0x51a160;}async[_0x93cd43(0xa6)](_0x4d6c71){const _0x3ae9a6=_0x93cd43;var _0x2dfaf1,_0x498e07,_0x4c54f9;const {apiKey:_0x5a728a,proxyUrl:_0x2ea9fc,fileInfo:_0x42ab98,prompt:_0x229849,timeout:_0x70a796,assistantLogId:_0x429999}=_0x4d6c71;let _0x126c1e={'text':'','fileInfo':'','taskId':'','taskData':'','status':0x2},_0x4ae200=null,_0x3b89ef='',_0x1d5bc9={};const _0x49f116={'Authorization':_0x3ae9a6(0xbb)+_0x5a728a};_0x3b89ef=_0x2ea9fc+_0x3ae9a6(0xbe),_0x1d5bc9={'model':_0x3ae9a6(0xda),'prompt':_0x229849};_0x42ab98&&(_0x1d5bc9['image_url']=_0x42ab98);common_1[_0x3ae9a6(0xdf)][_0x3ae9a6(0xd8)](_0x3ae9a6(0xe1)+_0x3b89ef+'，payload:\x20'+JSON['stringify'](_0x1d5bc9)+_0x3ae9a6(0x8b)+JSON[_0x3ae9a6(0x96)](_0x49f116),_0x3ae9a6(0xa7));try{_0x4ae200=await axios_1['default'][_0x3ae9a6(0xa1)](_0x3b89ef,_0x1d5bc9,{'headers':_0x49f116}),common_1[_0x3ae9a6(0xdf)]['debug'](_0x3ae9a6(0xba)+_0x4ae200['status']+_0x3ae9a6(0xbd)+_0x4ae200[_0x3ae9a6(0xdb)]+_0x3ae9a6(0x9e)+JSON['stringify'](_0x4ae200[_0x3ae9a6(0xd2)]));}catch(_0x2d59fc){common_1['Logger'][_0x3ae9a6(0x86)](_0x3ae9a6(0x9f)+_0x2d59fc[_0x3ae9a6(0xd5)],'CogService');throw new Error(_0x3ae9a6(0x87));}if((_0x2dfaf1=_0x4ae200===null||_0x4ae200===void 0x0?void 0x0:_0x4ae200[_0x3ae9a6(0xd2)])===null||_0x2dfaf1===void 0x0?void 0x0:_0x2dfaf1['id'])_0x126c1e['taskId']=(_0x498e07=_0x4ae200===null||_0x4ae200===void 0x0?void 0x0:_0x4ae200[_0x3ae9a6(0xd2)])===null||_0x498e07===void 0x0?void 0x0:_0x498e07['id'],common_1['Logger'][_0x3ae9a6(0xd8)](_0x3ae9a6(0x90)+((_0x4c54f9=_0x4ae200===null||_0x4ae200===void 0x0?void 0x0:_0x4ae200['data'])===null||_0x4c54f9===void 0x0?void 0x0:_0x4c54f9['id']),_0x3ae9a6(0xa7));else throw new Error(_0x3ae9a6(0xa0));try{await this[_0x3ae9a6(0x9a)]({'proxyUrl':_0x2ea9fc,'apiKey':_0x5a728a,'taskId':_0x4ae200[_0x3ae9a6(0xd2)]['id'],'timeout':_0x70a796,'prompt':_0x229849,'onSuccess':async _0x43ebb8=>{const _0x496e53=_0x3ae9a6;try{await this['chatLogService'][_0x496e53(0xb3)](_0x429999,{'videoUrl':_0x43ebb8===null||_0x43ebb8===void 0x0?void 0x0:_0x43ebb8[_0x496e53(0x8c)],'audioUrl':_0x43ebb8===null||_0x43ebb8===void 0x0?void 0x0:_0x43ebb8['audioUrl'],'fileInfo':_0x43ebb8===null||_0x43ebb8===void 0x0?void 0x0:_0x43ebb8[_0x496e53(0xcd)],'answer':(_0x43ebb8===null||_0x43ebb8===void 0x0?void 0x0:_0x43ebb8[_0x496e53(0xad)])||_0x229849,'progress':_0x496e53(0xae),'status':0x3,'taskId':_0x43ebb8===null||_0x43ebb8===void 0x0?void 0x0:_0x43ebb8[_0x496e53(0x89)],'taskData':_0x43ebb8===null||_0x43ebb8===void 0x0?void 0x0:_0x43ebb8[_0x496e53(0xdd)]}),common_1['Logger'][_0x496e53(0xd8)](_0x496e53(0xd1),'CogService');}catch(_0x340ceb){common_1['Logger']['error'](_0x496e53(0x8f)+_0x340ceb[_0x496e53(0xd5)],_0x496e53(0xa7));}},'onGenerating':async _0x3780a4=>{const _0x14a916=_0x3ae9a6;try{await this[_0x14a916(0xc7)][_0x14a916(0xb3)](_0x429999,{'videoUrl':_0x3780a4===null||_0x3780a4===void 0x0?void 0x0:_0x3780a4[_0x14a916(0x8c)],'audioUrl':_0x3780a4===null||_0x3780a4===void 0x0?void 0x0:_0x3780a4['audioUrl'],'fileInfo':_0x3780a4===null||_0x3780a4===void 0x0?void 0x0:_0x3780a4[_0x14a916(0xcd)],'answer':(_0x3780a4===null||_0x3780a4===void 0x0?void 0x0:_0x3780a4[_0x14a916(0xad)])||'视频生成中...','progress':_0x3780a4===null||_0x3780a4===void 0x0?void 0x0:_0x3780a4[_0x14a916(0xb4)],'status':_0x3780a4[_0x14a916(0xb1)]}),common_1['Logger']['log'](_0x14a916(0xd4),_0x14a916(0xa7));}catch(_0x4fc42f){common_1[_0x14a916(0xdf)][_0x14a916(0x86)](_0x14a916(0x8f)+_0x4fc42f['message'],_0x14a916(0xa7));}},'onFailure':async _0x30b05c=>{const _0x579270=_0x3ae9a6;try{await this[_0x579270(0xc7)][_0x579270(0xb3)](_0x429999,{'answer':_0x579270(0xde),'status':_0x30b05c['status']}),common_1[_0x579270(0xdf)][_0x579270(0xd8)]('生成失败',_0x579270(0x91));}catch(_0x9840d){common_1['Logger'][_0x579270(0x86)](_0x579270(0x8f)+_0x9840d[_0x579270(0xd5)],'CogService');}}});}catch(_0x345dd5){common_1[_0x3ae9a6(0xdf)][_0x3ae9a6(0x86)](_0x3ae9a6(0xcc),_0x345dd5[_0x3ae9a6(0xd5)],_0x3ae9a6(0xa7));throw new Error(_0x3ae9a6(0xb6));}return _0x126c1e;}async[_0x93cd43(0x9a)](_0x20023f){const _0x3c2f2f=_0x93cd43,{proxyUrl:_0x1912d1,apiKey:_0x800aba,taskId:_0x4a7777,timeout:_0x597231,onSuccess:_0x20a05e,onFailure:_0x10ac63,onGenerating:_0x3721c5,prompt:_0x5c14cd,action:_0x3ccb85}=_0x20023f;let _0x253d96={'videoUrl':'','audioUrl':'','fileInfo':'','drawId':'','taskData':'','status':0x2,'progress':0x0,'answer':''};const _0x1ce5b5={'Authorization':_0x3c2f2f(0xbb)+_0x800aba},_0x2776bc=_0x1912d1+'/cogvideox/v4/async-result/'+_0x4a7777,_0x27dedd=Date[_0x3c2f2f(0xb8)](),_0xa136e7=0x493e0,_0x1ee45c=0x1388;let _0xe03921=0x0;try{while(Date[_0x3c2f2f(0xb8)]()-_0x27dedd<_0x597231){await new Promise(_0x26469a=>setTimeout(_0x26469a,_0x1ee45c));try{const _0x40b574=await axios_1[_0x3c2f2f(0x8d)][_0x3c2f2f(0x88)](_0x2776bc,{'headers':_0x1ce5b5}),_0x46f21b=setInterval(()=>{const _0x3b8f8c=_0x3c2f2f,_0xbe65e4=Date[_0x3b8f8c(0xb8)]()-_0x27dedd;let _0x1dab2b=Math[_0x3b8f8c(0xc9)](_0xbe65e4/_0xa136e7*0x64);if(_0x1dab2b>=0x63)_0x1dab2b=0x63;_0x253d96[_0x3b8f8c(0xad)]=_0x3b8f8c(0xd7)+_0x1dab2b+'%）';},0x3e8),_0x551043=_0x40b574[_0x3c2f2f(0xd2)];common_1[_0x3c2f2f(0xdf)][_0x3c2f2f(0xd3)](_0x3c2f2f(0xac)+JSON[_0x3c2f2f(0x96)](_0x551043),_0x3c2f2f(0xa7));if(_0x551043['task_status']===_0x3c2f2f(0xb0)){_0x253d96[_0x3c2f2f(0x89)]=_0x551043[_0x3c2f2f(0xaf)],_0x253d96['taskData']=JSON['stringify'](_0x551043),common_1[_0x3c2f2f(0xdf)][_0x3c2f2f(0xd8)](_0x3c2f2f(0xce),_0x3c2f2f(0xa7)),_0x253d96[_0x3c2f2f(0xcd)]=_0x551043['video_result'][0x0][_0x3c2f2f(0xcb)],common_1[_0x3c2f2f(0xdf)][_0x3c2f2f(0xd8)](_0x253d96[_0x3c2f2f(0xcd)],_0x3c2f2f(0xa7));try{const _0x38a4ee=await this[_0x3c2f2f(0xc1)][_0x3c2f2f(0xa3)](['localStorageStatus']);if(Number(_0x38a4ee)){const _0x189290=new Date(),_0x1795ca=_0x189290[_0x3c2f2f(0xd6)](),_0x885b5d=String(_0x189290['getMonth']()+0x1)[_0x3c2f2f(0xd0)](0x2,'0'),_0x2a4c4c=String(_0x189290[_0x3c2f2f(0x85)]())[_0x3c2f2f(0xd0)](0x2,'0'),_0x231fdc=''+_0x1795ca+_0x885b5d+'/'+_0x2a4c4c;_0x253d96[_0x3c2f2f(0xcd)]=await this[_0x3c2f2f(0x9c)][_0x3c2f2f(0xe2)]({'url':_0x551043[_0x3c2f2f(0xab)][0x0][_0x3c2f2f(0xcb)],'dir':_0x3c2f2f(0xc6)+_0x231fdc});}}catch(_0x2794d8){common_1[_0x3c2f2f(0xdf)][_0x3c2f2f(0x86)](_0x3c2f2f(0xbc)+_0x2794d8[_0x3c2f2f(0xd5)],'CogService');}_0x253d96[_0x3c2f2f(0xad)]=_0x3c2f2f(0xc0)+_0x5c14cd+'\x22',_0x20a05e(_0x253d96),clearInterval(_0x46f21b);return;}else _0x3721c5(_0x253d96);if(_0x253d96[_0x3c2f2f(0xb4)]){}}catch(_0x30f363){_0xe03921++,common_1['Logger']['error']('轮询失败，重试次数:\x20'+_0xe03921,_0x3c2f2f(0xa7));}}common_1[_0x3c2f2f(0xdf)][_0x3c2f2f(0x86)](_0x3c2f2f(0xaa),_0x3c2f2f(0xa7)),_0x253d96[_0x3c2f2f(0xb1)]=0x4,_0x10ac63(_0x253d96);throw new Error(_0x3c2f2f(0x95));}catch(_0x23f24d){common_1[_0x3c2f2f(0xdf)]['error'](_0x3c2f2f(0x99)+_0x23f24d,_0x3c2f2f(0xa7)),_0x253d96[_0x3c2f2f(0xb1)]=0x5,_0x10ac63(_0x253d96);}}};CogVideoService=__decorate([(0x0,common_1['Injectable'])(),__metadata(_0x93cd43(0xdc),[chatLog_service_1[_0x93cd43(0xc4)],globalConfig_service_1[_0x93cd43(0xe0)],upload_service_1[_0x93cd43(0x97)]])],CogVideoService),exports['CogVideoService']=CogVideoService;