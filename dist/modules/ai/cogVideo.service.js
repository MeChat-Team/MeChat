'use strict';const _0x5be5b1=_0xc063;function _0xc063(_0x384aa6,_0x2cadb8){const _0x57fa33=_0x57fa();return _0xc063=function(_0xc06332,_0x3b8d81){_0xc06332=_0xc06332-0xd2;let _0x18a5b3=_0x57fa33[_0xc06332];return _0x18a5b3;},_0xc063(_0x384aa6,_0x2cadb8);}(function(_0xd67bc5,_0x8bfd9){const _0x19f603=_0xc063,_0x4e669a=_0xd67bc5();while(!![]){try{const _0x134b6e=parseInt(_0x19f603(0x11b))/0x1+parseInt(_0x19f603(0x11d))/0x2*(-parseInt(_0x19f603(0x109))/0x3)+-parseInt(_0x19f603(0xfc))/0x4*(parseInt(_0x19f603(0x126))/0x5)+parseInt(_0x19f603(0x122))/0x6+parseInt(_0x19f603(0x114))/0x7*(-parseInt(_0x19f603(0xed))/0x8)+parseInt(_0x19f603(0xdc))/0x9*(-parseInt(_0x19f603(0x10c))/0xa)+parseInt(_0x19f603(0xf4))/0xb;if(_0x134b6e===_0x8bfd9)break;else _0x4e669a['push'](_0x4e669a['shift']());}catch(_0x408fbe){_0x4e669a['push'](_0x4e669a['shift']());}}}(_0x57fa,0x6a00f));var __decorate=this&&this[_0x5be5b1(0x100)]||function(_0x31cba9,_0x446d04,_0x48eeaf,_0x5ce2d7){const _0x237aa9=_0x5be5b1;var _0x4572=arguments[_0x237aa9(0x10d)],_0x3a8422=_0x4572<0x3?_0x446d04:_0x5ce2d7===null?_0x5ce2d7=Object[_0x237aa9(0xee)](_0x446d04,_0x48eeaf):_0x5ce2d7,_0x25aca8;if(typeof Reflect===_0x237aa9(0xde)&&typeof Reflect[_0x237aa9(0x11e)]==='function')_0x3a8422=Reflect[_0x237aa9(0x11e)](_0x31cba9,_0x446d04,_0x48eeaf,_0x5ce2d7);else{for(var _0x10bc81=_0x31cba9[_0x237aa9(0x10d)]-0x1;_0x10bc81>=0x0;_0x10bc81--)if(_0x25aca8=_0x31cba9[_0x10bc81])_0x3a8422=(_0x4572<0x3?_0x25aca8(_0x3a8422):_0x4572>0x3?_0x25aca8(_0x446d04,_0x48eeaf,_0x3a8422):_0x25aca8(_0x446d04,_0x48eeaf))||_0x3a8422;}return _0x4572>0x3&&_0x3a8422&&Object[_0x237aa9(0x125)](_0x446d04,_0x48eeaf,_0x3a8422),_0x3a8422;},__metadata=this&&this['__metadata']||function(_0x489283,_0x482022){const _0x2d3918=_0x5be5b1;if(typeof Reflect===_0x2d3918(0xde)&&typeof Reflect['metadata']==='function')return Reflect[_0x2d3918(0xd6)](_0x489283,_0x482022);};function _0x57fa(){const _0x486138=['Lum\x20aService','100%','/cogvideox/v4/async-result/','fileInfo','pollCogVideoResult','url','stringify','425973lbMEgz','debug','updateChatLog','290RLDZNi','length','log','getConfigs','生成失败','cogvideox','Bearer\x20','task_status','7HtSWem','chatLogService','post','../chatLog/chatLog.service','taskData',',\x20数据:\x20','视频生成中...','390255XwCCeV','message','2rnErjG','decorate','查询生成结果时发生错误','uploadFileFromUrl','get','675876sGZfoE','Logger','padStart','defineProperty','323545yahacq','轮询过程中发生错误:\x20','CogService','UploadService','default','，payload:\x20','metadata','任务提交成功,\x20任务ID:\x20','../globalConfig/globalConfig.service','未能获取结果数据,\x20即将重试','now','globalConfigService','269307ILcKAk','uploadService','object','任务提交失败:\x20','CogVideoService','轮询超时，请稍后再试！','视频任务已完成','taskId','video_result','查询超时，请稍后再试！','design:paramtypes','data','status','progress','videoUrl','error','任务提交结果，状态码:\x20','4514984sTotqV','getOwnPropertyDescriptor','floor','__esModule','更新日志失败:\x20','audioUrl','getMonth','20118626RKcPgW','查询生成结果时发生错误:','answer','image_url','@nestjs/common','cogVideo','正在准备发送请求到\x20','statusText','20coLvTI','/cogvideox/v4/videos/generations',',\x20状态消息:\x20','video/cog/','__decorate','request_id'];_0x57fa=function(){return _0x486138;};return _0x57fa();}Object['defineProperty'](exports,_0x5be5b1(0xf0),{'value':!![]}),exports[_0x5be5b1(0xe0)]=void 0x0;const common_1=require(_0x5be5b1(0xf8)),axios_1=require('axios'),chatLog_service_1=require(_0x5be5b1(0x117)),globalConfig_service_1=require(_0x5be5b1(0xd8)),upload_service_1=require('../upload/upload.service');let CogVideoService=class CogVideoService{constructor(_0x12685f,_0x482cbc,_0x2d417e){const _0x35667c=_0x5be5b1;this['chatLogService']=_0x12685f,this[_0x35667c(0xdb)]=_0x482cbc,this[_0x35667c(0xdd)]=_0x2d417e;}async[_0x5be5b1(0xf9)](_0x110f48){const _0x33217f=_0x5be5b1;var _0x1eeb9a,_0x16f43a,_0x441517;const {apiKey:_0x45811d,proxyUrl:_0x4c5185,fileInfo:_0x313fef,prompt:_0x1782c,timeout:_0x170335,assistantLogId:_0x593879}=_0x110f48;let _0xdff00c={'text':'','fileInfo':'','taskId':'','taskData':'','status':0x2},_0x3293b6=null,_0x4eb392='',_0x331a82={};const _0xcb81c7={'Authorization':_0x33217f(0x112)+_0x45811d};_0x4eb392=_0x4c5185+_0x33217f(0xfd),_0x331a82={'model':_0x33217f(0x111),'prompt':_0x1782c};_0x313fef&&(_0x331a82[_0x33217f(0xf7)]=_0x313fef);common_1['Logger'][_0x33217f(0x10e)](_0x33217f(0xfa)+_0x4eb392+_0x33217f(0xd5)+JSON['stringify'](_0x331a82)+',\x20headers:\x20'+JSON[_0x33217f(0x108)](_0xcb81c7),_0x33217f(0xd2));try{_0x3293b6=await axios_1[_0x33217f(0xd4)][_0x33217f(0x116)](_0x4eb392,_0x331a82,{'headers':_0xcb81c7}),common_1[_0x33217f(0x123)]['debug'](_0x33217f(0xec)+_0x3293b6[_0x33217f(0xe8)]+_0x33217f(0xfe)+_0x3293b6[_0x33217f(0xfb)]+_0x33217f(0x119)+JSON[_0x33217f(0x108)](_0x3293b6[_0x33217f(0xe7)]));}catch(_0x225c79){common_1[_0x33217f(0x123)]['error'](_0x33217f(0xdf)+_0x225c79['message'],_0x33217f(0xd2));throw new Error('任务提交失败');}if((_0x1eeb9a=_0x3293b6===null||_0x3293b6===void 0x0?void 0x0:_0x3293b6['data'])===null||_0x1eeb9a===void 0x0?void 0x0:_0x1eeb9a['id'])_0xdff00c[_0x33217f(0xe3)]=(_0x16f43a=_0x3293b6===null||_0x3293b6===void 0x0?void 0x0:_0x3293b6['data'])===null||_0x16f43a===void 0x0?void 0x0:_0x16f43a['id'],common_1[_0x33217f(0x123)][_0x33217f(0x10e)](_0x33217f(0xd7)+((_0x441517=_0x3293b6===null||_0x3293b6===void 0x0?void 0x0:_0x3293b6['data'])===null||_0x441517===void 0x0?void 0x0:_0x441517['id']),_0x33217f(0xd2));else throw new Error(_0x33217f(0xd9));try{await this['pollCogVideoResult']({'proxyUrl':_0x4c5185,'apiKey':_0x45811d,'taskId':_0x3293b6[_0x33217f(0xe7)]['id'],'timeout':_0x170335,'prompt':_0x1782c,'onSuccess':async _0x34f9b0=>{const _0x55ffc2=_0x33217f;try{await this['chatLogService'][_0x55ffc2(0x10b)](_0x593879,{'videoUrl':_0x34f9b0===null||_0x34f9b0===void 0x0?void 0x0:_0x34f9b0[_0x55ffc2(0xea)],'audioUrl':_0x34f9b0===null||_0x34f9b0===void 0x0?void 0x0:_0x34f9b0[_0x55ffc2(0xf2)],'fileInfo':_0x34f9b0===null||_0x34f9b0===void 0x0?void 0x0:_0x34f9b0[_0x55ffc2(0x105)],'answer':(_0x34f9b0===null||_0x34f9b0===void 0x0?void 0x0:_0x34f9b0[_0x55ffc2(0xf6)])||_0x1782c,'progress':_0x55ffc2(0x103),'status':0x3,'taskId':_0x34f9b0===null||_0x34f9b0===void 0x0?void 0x0:_0x34f9b0[_0x55ffc2(0xe3)],'taskData':_0x34f9b0===null||_0x34f9b0===void 0x0?void 0x0:_0x34f9b0[_0x55ffc2(0x118)]}),common_1[_0x55ffc2(0x123)]['log'](_0x55ffc2(0xe2),_0x55ffc2(0xd2));}catch(_0x136060){common_1[_0x55ffc2(0x123)]['error'](_0x55ffc2(0xf1)+_0x136060['message'],_0x55ffc2(0xd2));}},'onGenerating':async _0x338ce0=>{const _0x52c43b=_0x33217f;try{await this['chatLogService'][_0x52c43b(0x10b)](_0x593879,{'videoUrl':_0x338ce0===null||_0x338ce0===void 0x0?void 0x0:_0x338ce0[_0x52c43b(0xea)],'audioUrl':_0x338ce0===null||_0x338ce0===void 0x0?void 0x0:_0x338ce0[_0x52c43b(0xf2)],'fileInfo':_0x338ce0===null||_0x338ce0===void 0x0?void 0x0:_0x338ce0[_0x52c43b(0x105)],'answer':(_0x338ce0===null||_0x338ce0===void 0x0?void 0x0:_0x338ce0['answer'])||_0x52c43b(0x11a),'progress':_0x338ce0===null||_0x338ce0===void 0x0?void 0x0:_0x338ce0[_0x52c43b(0xe9)],'status':_0x338ce0[_0x52c43b(0xe8)]}),common_1[_0x52c43b(0x123)][_0x52c43b(0x10e)](_0x52c43b(0x11a),_0x52c43b(0xd2));}catch(_0x337bd8){common_1['Logger']['error']('更新日志失败:\x20'+_0x337bd8[_0x52c43b(0x11c)],_0x52c43b(0xd2));}},'onFailure':async _0x38c7b8=>{const _0x384083=_0x33217f;try{await this[_0x384083(0x115)]['updateChatLog'](_0x593879,{'answer':'视频生成失败','status':_0x38c7b8['status']}),common_1[_0x384083(0x123)][_0x384083(0x10e)](_0x384083(0x110),_0x384083(0x102));}catch(_0x3f558e){common_1[_0x384083(0x123)]['error'](_0x384083(0xf1)+_0x3f558e[_0x384083(0x11c)],_0x384083(0xd2));}}});}catch(_0x5af6cf){common_1['Logger'][_0x33217f(0xeb)](_0x33217f(0xf5),_0x5af6cf[_0x33217f(0x11c)],_0x33217f(0xd2));throw new Error(_0x33217f(0x11f));}return _0xdff00c;}async[_0x5be5b1(0x106)](_0x3df2ac){const _0x414461=_0x5be5b1,{proxyUrl:_0x3d7ae2,apiKey:_0x4a507b,taskId:_0x1c4bf7,timeout:_0x78ff29,onSuccess:_0x205e1f,onFailure:_0x2e059d,onGenerating:_0x55609e,prompt:_0x6ab745,action:_0x188d5b}=_0x3df2ac;let _0x53251f={'videoUrl':'','audioUrl':'','fileInfo':'','drawId':'','taskData':'','status':0x2,'progress':0x0,'answer':''};const _0x1afc19={'Authorization':_0x414461(0x112)+_0x4a507b},_0xa22dfc=_0x3d7ae2+_0x414461(0x104)+_0x1c4bf7,_0x2b085c=Date[_0x414461(0xda)](),_0x230ad1=0x493e0,_0x4c168e=0x1388;let _0xf45cb8=0x0;try{while(Date['now']()-_0x2b085c<_0x78ff29){await new Promise(_0x182db3=>setTimeout(_0x182db3,_0x4c168e));try{const _0x5be05f=await axios_1[_0x414461(0xd4)][_0x414461(0x121)](_0xa22dfc,{'headers':_0x1afc19}),_0x22e518=setInterval(()=>{const _0x359075=_0x414461,_0x62cb42=Date[_0x359075(0xda)]()-_0x2b085c;let _0x31f407=Math[_0x359075(0xef)](_0x62cb42/_0x230ad1*0x64);if(_0x31f407>=0x63)_0x31f407=0x63;_0x53251f[_0x359075(0xf6)]='视频生成中\x20（'+_0x31f407+'%）';},0x3e8),_0x440349=_0x5be05f[_0x414461(0xe7)];common_1[_0x414461(0x123)][_0x414461(0x10a)]('轮询结果:\x20'+JSON[_0x414461(0x108)](_0x440349),_0x414461(0xd2));if(_0x440349[_0x414461(0x113)]==='SUCCESS'){_0x53251f['taskId']=_0x440349[_0x414461(0x101)],_0x53251f[_0x414461(0x118)]=JSON['stringify'](_0x440349),common_1[_0x414461(0x123)][_0x414461(0x10e)]('视频生成成功',_0x414461(0xd2)),_0x53251f['fileInfo']=_0x440349[_0x414461(0xe4)][0x0]['url'],common_1[_0x414461(0x123)][_0x414461(0x10e)](_0x53251f['fileInfo'],_0x414461(0xd2));try{const _0x1fbe45=await this[_0x414461(0xdb)][_0x414461(0x10f)](['localStorageStatus']);if(Number(_0x1fbe45)){const _0x17d6a9=new Date(),_0x5abcec=_0x17d6a9['getFullYear'](),_0x5b924e=String(_0x17d6a9[_0x414461(0xf3)]()+0x1)[_0x414461(0x124)](0x2,'0'),_0x502d2a=String(_0x17d6a9['getDate']())[_0x414461(0x124)](0x2,'0'),_0x53a4bf=''+_0x5abcec+_0x5b924e+'/'+_0x502d2a;_0x53251f[_0x414461(0x105)]=await this[_0x414461(0xdd)][_0x414461(0x120)]({'url':_0x440349[_0x414461(0xe4)][0x0][_0x414461(0x107)],'dir':_0x414461(0xff)+_0x53a4bf});}}catch(_0x620eae){common_1['Logger'][_0x414461(0xeb)]('上传文件失败:\x20'+_0x620eae[_0x414461(0x11c)],_0x414461(0xd2));}_0x53251f[_0x414461(0xf6)]='提示词:\x20\x22'+_0x6ab745+'\x22',_0x205e1f(_0x53251f),clearInterval(_0x22e518);return;}else _0x55609e(_0x53251f);if(_0x53251f[_0x414461(0xe9)]){}}catch(_0x45cf55){_0xf45cb8++,common_1[_0x414461(0x123)][_0x414461(0xeb)]('轮询失败，重试次数:\x20'+_0xf45cb8,_0x414461(0xd2));}}common_1[_0x414461(0x123)][_0x414461(0xeb)](_0x414461(0xe1),_0x414461(0xd2)),_0x53251f[_0x414461(0xe8)]=0x4,_0x2e059d(_0x53251f);throw new Error(_0x414461(0xe5));}catch(_0x514964){common_1[_0x414461(0x123)][_0x414461(0xeb)](_0x414461(0x127)+_0x514964,_0x414461(0xd2)),_0x53251f['status']=0x5,_0x2e059d(_0x53251f);}}};CogVideoService=__decorate([(0x0,common_1['Injectable'])(),__metadata(_0x5be5b1(0xe6),[chatLog_service_1['ChatLogService'],globalConfig_service_1['GlobalConfigService'],upload_service_1[_0x5be5b1(0xd3)]])],CogVideoService),exports['CogVideoService']=CogVideoService;