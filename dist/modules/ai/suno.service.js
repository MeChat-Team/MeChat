'use strict';const _0x3588e3=_0x21fa;(function(_0x4be991,_0x3b9691){const _0x2498db=_0x21fa,_0x39bfc4=_0x4be991();while(!![]){try{const _0x3c2ae3=-parseInt(_0x2498db(0x1db))/0x1*(-parseInt(_0x2498db(0x1c7))/0x2)+parseInt(_0x2498db(0x21a))/0x3+-parseInt(_0x2498db(0x1da))/0x4+-parseInt(_0x2498db(0x1cd))/0x5+parseInt(_0x2498db(0x1d0))/0x6+parseInt(_0x2498db(0x202))/0x7+-parseInt(_0x2498db(0x20d))/0x8;if(_0x3c2ae3===_0x3b9691)break;else _0x39bfc4['push'](_0x39bfc4['shift']());}catch(_0x341bf9){_0x39bfc4['push'](_0x39bfc4['shift']());}}}(_0xafb6,0xeda5e));function _0xafb6(){const _0x37190e=['MUSIC','function','title','GlobalConfigService','轮询失败，重试次数:\x20','defineProperty','__metadata','../globalConfig/globalConfig.service','design:paramtypes','音乐生成中...','object','globalConfigService','/task/suno/v1/submit/music','102tXTKut',',\x20数据:\x20','fileInfo','error','default','push','3144555GQUksQ','now','../chatLog/chatLog.service','5264886vUGypY','查询超时，请稍后再试！','progress','Logger','正在准备发送请求到\x20','解析taskData失败:\x20','video_url','uploadFileFromUrl','SunoService','当前生成进度\x20','4642236WAyOsW','37925JfdEUa','log','answer','length','音乐已生成','data','isArray','未能获取结果数据,\x20即将重试','音乐任务已完成','chatLogService','suno','metadata','taskId','video/suno-music/','获取配置失败:\x20','任务提交失败:\x20','歌词生成中','getConfigs','audio_url','Bearer\x20','getOwnPropertyDescriptor','padStart','stringify','音乐生成失败','LYRICS','SUCCESS','uploadService','get','post','查询生成结果时发生错误','任务提交成功,\x20任务ID:\x20','上传音频文件失败:\x20','updateChatLog','getMonth','任务提交失败','filter','decorate','map','status','10689525qIaWhX','音频生成成功，等待视频生成...','__esModule','debug','LumaService','ChatLogService','getFullYear','pollSunoMusicResult','join','任务提交结果，状态码:\x20','message','24451592EhvGnN','audio/suno-music/','上传图片文件失败:\x20','taskData格式错误','images/suno-music/','轮询过程中发生错误:\x20','UploadService','text','@nestjs/common','audioUrl','查询生成结果时发生错误:','音乐生成成功:\x20','更新日志失败:\x20','4441782xKrpyX','轮询结果:\x20','videoUrl','taskData'];_0xafb6=function(){return _0x37190e;};return _0xafb6();}var __decorate=this&&this['__decorate']||function(_0x150542,_0x19f8b6,_0x3c7904,_0x36de59){const _0x41353c=_0x21fa;var _0x18d064=arguments['length'],_0xd85406=_0x18d064<0x3?_0x19f8b6:_0x36de59===null?_0x36de59=Object[_0x41353c(0x1ef)](_0x19f8b6,_0x3c7904):_0x36de59,_0x48a9be;if(typeof Reflect===_0x41353c(0x1c4)&&typeof Reflect[_0x41353c(0x1ff)]===_0x41353c(0x1bb))_0xd85406=Reflect[_0x41353c(0x1ff)](_0x150542,_0x19f8b6,_0x3c7904,_0x36de59);else{for(var _0xa0cbcf=_0x150542[_0x41353c(0x1de)]-0x1;_0xa0cbcf>=0x0;_0xa0cbcf--)if(_0x48a9be=_0x150542[_0xa0cbcf])_0xd85406=(_0x18d064<0x3?_0x48a9be(_0xd85406):_0x18d064>0x3?_0x48a9be(_0x19f8b6,_0x3c7904,_0xd85406):_0x48a9be(_0x19f8b6,_0x3c7904))||_0xd85406;}return _0x18d064>0x3&&_0xd85406&&Object[_0x41353c(0x1bf)](_0x19f8b6,_0x3c7904,_0xd85406),_0xd85406;},__metadata=this&&this[_0x3588e3(0x1c0)]||function(_0x1a47d7,_0x3a96ae){const _0x10952d=_0x3588e3;if(typeof Reflect===_0x10952d(0x1c4)&&typeof Reflect['metadata']==='function')return Reflect[_0x10952d(0x1e6)](_0x1a47d7,_0x3a96ae);};Object[_0x3588e3(0x1bf)](exports,_0x3588e3(0x204),{'value':!![]}),exports['SunoService']=void 0x0;const common_1=require(_0x3588e3(0x215)),axios_1=require('axios'),chatLog_service_1=require(_0x3588e3(0x1cf)),globalConfig_service_1=require(_0x3588e3(0x1c1)),upload_service_1=require('../upload/upload.service');function _0x21fa(_0x2a7716,_0x26d021){const _0xafb6e0=_0xafb6();return _0x21fa=function(_0x21fa36,_0xa040d5){_0x21fa36=_0x21fa36-0x1b9;let _0xb33d21=_0xafb6e0[_0x21fa36];return _0xb33d21;},_0x21fa(_0x2a7716,_0x26d021);}let SunoService=class SunoService{constructor(_0x23a260,_0x335710,_0x395700){const _0x59b592=_0x3588e3;this[_0x59b592(0x1e4)]=_0x23a260,this[_0x59b592(0x1f5)]=_0x335710,this[_0x59b592(0x1c5)]=_0x395700;}async[_0x3588e3(0x1e5)](_0x2e8c9c){const _0x3cef5a=_0x3588e3;var _0x47fed0,_0x2c4e91,_0x274a5c;const {apiKey:_0x121b7d,proxyUrl:_0x2f6c7e,action:_0x5296b4,prompt:_0x16ab31,timeout:_0x2265a6,assistantLogId:_0x1ef44b,taskData:_0x4f32a5,extraParam:_0x3d0335}=_0x2e8c9c;common_1[_0x3cef5a(0x1d3)]['debug']('SunoService:\x20'+JSON[_0x3cef5a(0x1f1)](_0x2e8c9c),_0x3cef5a(0x1d8));let _0x40b120={'text':'','fileInfo':'','taskId':'','taskData':'','status':0x2};common_1[_0x3cef5a(0x1d3)][_0x3cef5a(0x1dc)]('开始生成音乐',_0x3cef5a(0x1d8));let _0x11208c=null,_0xe87937='',_0x270bc6={};const _0x3ba003={'Authorization':_0x3cef5a(0x1ee)+_0x121b7d};_0x5296b4===_0x3cef5a(0x1f3)&&(_0xe87937=_0x2f6c7e+'/task/suno/v1/submit/lyrics',_0x270bc6={'prompt':_0x16ab31});if(_0x5296b4===_0x3cef5a(0x1ba)){_0xe87937=_0x2f6c7e+_0x3cef5a(0x1c6);try{_0x270bc6=JSON['parse'](_0x4f32a5);}catch(_0x1d77d9){common_1['Logger']['error'](_0x3cef5a(0x1d5)+_0x1d77d9[_0x3cef5a(0x20c)],_0x3cef5a(0x1d8));throw new Error(_0x3cef5a(0x210));}}common_1[_0x3cef5a(0x1d3)][_0x3cef5a(0x1dc)](_0x3cef5a(0x1d4)+_0xe87937+'，payload:\x20'+JSON[_0x3cef5a(0x1f1)](_0x270bc6)+',\x20headers:\x20'+JSON[_0x3cef5a(0x1f1)](_0x3ba003),_0x3cef5a(0x1d8));try{_0x11208c=await axios_1['default'][_0x3cef5a(0x1f7)](_0xe87937,_0x270bc6,{'headers':_0x3ba003}),common_1[_0x3cef5a(0x1d3)]['debug'](_0x3cef5a(0x20b)+_0x11208c[_0x3cef5a(0x201)]+',\x20状态消息:\x20'+_0x11208c['statusText']+_0x3cef5a(0x1c8)+JSON[_0x3cef5a(0x1f1)](_0x11208c[_0x3cef5a(0x1e0)]));}catch(_0x19626d){common_1[_0x3cef5a(0x1d3)]['error'](_0x3cef5a(0x1ea)+_0x19626d[_0x3cef5a(0x20c)],'SunoService');throw new Error(_0x3cef5a(0x1fd));}if((_0x47fed0=_0x11208c===null||_0x11208c===void 0x0?void 0x0:_0x11208c[_0x3cef5a(0x1e0)])===null||_0x47fed0===void 0x0?void 0x0:_0x47fed0[_0x3cef5a(0x1e0)])_0x40b120[_0x3cef5a(0x1e7)]=(_0x2c4e91=_0x11208c===null||_0x11208c===void 0x0?void 0x0:_0x11208c[_0x3cef5a(0x1e0)])===null||_0x2c4e91===void 0x0?void 0x0:_0x2c4e91[_0x3cef5a(0x1e0)],common_1['Logger'][_0x3cef5a(0x1dc)](_0x3cef5a(0x1f9)+((_0x274a5c=_0x11208c===null||_0x11208c===void 0x0?void 0x0:_0x11208c[_0x3cef5a(0x1e0)])===null||_0x274a5c===void 0x0?void 0x0:_0x274a5c[_0x3cef5a(0x1e0)]),'SunoService');else throw new Error(_0x3cef5a(0x1e2));try{await this[_0x3cef5a(0x209)]({'proxyUrl':_0x2f6c7e,'apiKey':_0x121b7d,'taskId':_0x11208c[_0x3cef5a(0x1e0)][_0x3cef5a(0x1e0)],'timeout':_0x2265a6,'prompt':_0x16ab31,'action':_0x5296b4,'onSuccess':async _0x454838=>{const _0x37d2d8=_0x3cef5a;try{await this['chatLogService'][_0x37d2d8(0x1fb)](_0x1ef44b,{'videoUrl':_0x454838===null||_0x454838===void 0x0?void 0x0:_0x454838[_0x37d2d8(0x21c)],'audioUrl':_0x454838===null||_0x454838===void 0x0?void 0x0:_0x454838[_0x37d2d8(0x216)],'fileInfo':_0x454838===null||_0x454838===void 0x0?void 0x0:_0x454838[_0x37d2d8(0x1c9)],'answer':(_0x454838===null||_0x454838===void 0x0?void 0x0:_0x454838['answer'])||_0x16ab31,'progress':'100%','status':0x3,'taskId':_0x454838===null||_0x454838===void 0x0?void 0x0:_0x454838[_0x37d2d8(0x1e7)],'taskData':_0x454838===null||_0x454838===void 0x0?void 0x0:_0x454838[_0x37d2d8(0x1b9)]}),common_1[_0x37d2d8(0x1d3)][_0x37d2d8(0x1dc)](_0x37d2d8(0x1e3),_0x37d2d8(0x1d8));}catch(_0x49a361){common_1[_0x37d2d8(0x1d3)][_0x37d2d8(0x1ca)](_0x37d2d8(0x219)+_0x49a361[_0x37d2d8(0x20c)],_0x37d2d8(0x1d8));}},'onAudioSuccess':async _0x1eed36=>{const _0x3fbf05=_0x3cef5a;try{await this[_0x3fbf05(0x1e4)][_0x3fbf05(0x1fb)](_0x1ef44b,{'videoUrl':_0x1eed36===null||_0x1eed36===void 0x0?void 0x0:_0x1eed36[_0x3fbf05(0x21c)],'audioUrl':_0x1eed36===null||_0x1eed36===void 0x0?void 0x0:_0x1eed36['audioUrl'],'fileInfo':_0x1eed36===null||_0x1eed36===void 0x0?void 0x0:_0x1eed36['fileInfo'],'answer':(_0x1eed36===null||_0x1eed36===void 0x0?void 0x0:_0x1eed36[_0x3fbf05(0x1dd)])||_0x16ab31,'progress':_0x1eed36===null||_0x1eed36===void 0x0?void 0x0:_0x1eed36[_0x3fbf05(0x1d2)],'status':_0x1eed36[_0x3fbf05(0x201)],'taskId':_0x1eed36===null||_0x1eed36===void 0x0?void 0x0:_0x1eed36[_0x3fbf05(0x1e7)],'taskData':_0x1eed36===null||_0x1eed36===void 0x0?void 0x0:_0x1eed36[_0x3fbf05(0x1b9)]}),common_1[_0x3fbf05(0x1d3)]['log'](_0x3fbf05(0x203),_0x3fbf05(0x1d8));}catch(_0x1196f7){common_1['Logger']['error'](_0x3fbf05(0x219)+_0x1196f7[_0x3fbf05(0x20c)],_0x3fbf05(0x1d8));}},'onGenerating':async _0x498b9f=>{const _0x3e1ebe=_0x3cef5a;try{await this[_0x3e1ebe(0x1e4)][_0x3e1ebe(0x1fb)](_0x1ef44b,{'videoUrl':_0x498b9f===null||_0x498b9f===void 0x0?void 0x0:_0x498b9f['videoUrl'],'audioUrl':_0x498b9f===null||_0x498b9f===void 0x0?void 0x0:_0x498b9f[_0x3e1ebe(0x216)],'fileInfo':_0x498b9f===null||_0x498b9f===void 0x0?void 0x0:_0x498b9f[_0x3e1ebe(0x1c9)],'answer':(_0x498b9f===null||_0x498b9f===void 0x0?void 0x0:_0x498b9f[_0x3e1ebe(0x1dd)])||_0x3e1ebe(0x1c3),'progress':_0x498b9f===null||_0x498b9f===void 0x0?void 0x0:_0x498b9f['progress'],'status':_0x498b9f[_0x3e1ebe(0x201)]}),common_1[_0x3e1ebe(0x1d3)][_0x3e1ebe(0x1dc)]('音乐生成中...',_0x3e1ebe(0x1d8));}catch(_0x3ae268){common_1[_0x3e1ebe(0x1d3)][_0x3e1ebe(0x1ca)](_0x3e1ebe(0x219)+_0x3ae268['message'],'SunoService');}},'onFailure':async _0x265325=>{const _0x5e3274=_0x3cef5a;try{await this[_0x5e3274(0x1e4)][_0x5e3274(0x1fb)](_0x1ef44b,{'answer':_0x5e3274(0x1f2),'status':_0x265325['status']}),common_1['Logger']['log']('生成失败','SunoService');}catch(_0x39fc3b){common_1[_0x5e3274(0x1d3)][_0x5e3274(0x1ca)]('更新日志失败:\x20'+_0x39fc3b[_0x5e3274(0x20c)],_0x5e3274(0x1d8));}}});}catch(_0x576d1f){common_1[_0x3cef5a(0x1d3)]['error'](_0x3cef5a(0x217),_0x576d1f[_0x3cef5a(0x20c)],_0x3cef5a(0x1d8));throw new Error(_0x3cef5a(0x1f8));}return _0x40b120;}async[_0x3588e3(0x209)](_0x2fad47){const _0x4de704=_0x3588e3,{proxyUrl:_0x8e34bf,apiKey:_0xa4abfc,taskId:_0x473358,timeout:_0x3379de,onSuccess:_0x43f6ac,onAudioSuccess:_0x5e8ebe,onFailure:_0x536e92,onGenerating:_0x92bf41,action:_0x2689be}=_0x2fad47;let _0x435b1e={'videoUrl':'','audioUrl':'','fileInfo':'','drawId':'','taskData':'','status':0x2,'progress':0x0,'answer':''};const _0x50f073={'Authorization':_0x4de704(0x1ee)+_0xa4abfc},_0x116663=_0x8e34bf+'/task/suno/v1/fetch/'+_0x473358,_0x5871df=Date['now'](),_0x208f8f=0x1388;let _0x5246b6=0x0;try{while(Date[_0x4de704(0x1ce)]()-_0x5871df<_0x3379de){await new Promise(_0x45cce5=>setTimeout(_0x45cce5,_0x208f8f));try{const _0x346a3d=await axios_1[_0x4de704(0x1cb)][_0x4de704(0x1f6)](_0x116663,{'headers':_0x50f073}),_0x1be724=_0x346a3d['data']['data'];common_1[_0x4de704(0x1d3)][_0x4de704(0x205)](_0x4de704(0x21b)+JSON[_0x4de704(0x1f1)](_0x1be724),_0x4de704(0x1d8));if(_0x2689be==='LYRICS'){if(_0x1be724[_0x4de704(0x201)]===_0x4de704(0x1f4)){_0x435b1e[_0x4de704(0x1e7)]=_0x1be724['data']['id'],_0x435b1e[_0x4de704(0x1b9)]=JSON[_0x4de704(0x1f1)](_0x1be724[_0x4de704(0x1e0)]),_0x435b1e[_0x4de704(0x1dd)]=_0x1be724[_0x4de704(0x1e0)][_0x4de704(0x214)],_0x43f6ac(_0x435b1e);return;}_0x435b1e[_0x4de704(0x1d2)]=_0x1be724===null||_0x1be724===void 0x0?void 0x0:_0x1be724['progress'],_0x435b1e[_0x4de704(0x1dd)]=_0x4de704(0x1eb),_0x435b1e[_0x4de704(0x1d2)]&&_0x92bf41(_0x435b1e);}if(_0x2689be==='MUSIC'){if(_0x1be724[_0x4de704(0x1e0)]){const _0xebc118=_0x1be724[_0x4de704(0x1e0)];_0x435b1e[_0x4de704(0x1b9)]=JSON[_0x4de704(0x1f1)](_0xebc118);if(Array[_0x4de704(0x1e1)](_0xebc118)){const _0x63fa2b=_0xebc118[_0x4de704(0x200)](_0x8d8282=>_0x8d8282[_0x4de704(0x1ed)])[_0x4de704(0x1fe)](_0xfd952=>_0xfd952),_0x93a842=_0xebc118[_0x4de704(0x200)](_0x15120f=>_0x15120f[_0x4de704(0x1d6)])['filter'](_0x49c10b=>_0x49c10b),_0x1b7db7=_0xebc118[_0x4de704(0x200)](_0x2d0202=>_0x2d0202['image_url'])[_0x4de704(0x1fe)](_0x1c3a04=>_0x1c3a04),_0x4765a0=_0xebc118[_0x4de704(0x200)](_0x8be81a=>_0x8be81a[_0x4de704(0x1bc)]),_0x437919=_0x4765a0[_0x4de704(0x1de)]>0x0?_0x4765a0[0x0]:_0x4de704(0x1df);if(_0x1be724['status']==='SUCCESS'){let _0x3da893=[],_0x2224f4=[],_0x32f86d=[];try{const _0x1bb3f4=await this['globalConfigService'][_0x4de704(0x1ec)](['localStorageStatus']);if(Number(_0x1bb3f4)){const _0x51d644=new Date(),_0x2e05eb=_0x51d644[_0x4de704(0x208)](),_0x2a0d66=String(_0x51d644[_0x4de704(0x1fc)]()+0x1)['padStart'](0x2,'0'),_0x4e840c=String(_0x51d644['getDate']())[_0x4de704(0x1f0)](0x2,'0'),_0x3c67ee=''+_0x2e05eb+_0x2a0d66+'/'+_0x4e840c;for(const _0x166def of _0x63fa2b){try{const _0x4c063c=await this[_0x4de704(0x1f5)][_0x4de704(0x1d7)]({'url':_0x166def,'dir':_0x4de704(0x20e)+_0x3c67ee});_0x3da893[_0x4de704(0x1cc)](_0x4c063c);}catch(_0x3ecea7){common_1[_0x4de704(0x1d3)][_0x4de704(0x1ca)](_0x4de704(0x1fa)+_0x3ecea7['message'],_0x4de704(0x1d8)),_0x3da893[_0x4de704(0x1cc)](_0x166def);}}for(const _0x354a6e of _0x93a842){try{const _0xfe83f6=await this[_0x4de704(0x1f5)]['uploadFileFromUrl']({'url':_0x354a6e,'dir':_0x4de704(0x1e8)+_0x3c67ee});_0x2224f4[_0x4de704(0x1cc)](_0xfe83f6);}catch(_0x11be8b){common_1[_0x4de704(0x1d3)][_0x4de704(0x1ca)]('上传视频文件失败:\x20'+_0x11be8b[_0x4de704(0x20c)],'SunoService'),_0x2224f4[_0x4de704(0x1cc)](_0x354a6e);}}for(const _0x1b69c4 of _0x1b7db7){try{const _0x39127b=await this[_0x4de704(0x1f5)]['uploadFileFromUrl']({'url':_0x1b69c4,'dir':_0x4de704(0x211)+_0x3c67ee});_0x32f86d['push'](_0x39127b);}catch(_0x513960){common_1[_0x4de704(0x1d3)][_0x4de704(0x1ca)](_0x4de704(0x20f)+_0x513960['message'],_0x4de704(0x1d8)),_0x32f86d[_0x4de704(0x1cc)](_0x1b69c4);}}}else _0x3da893=_0x63fa2b,_0x2224f4=_0x93a842,_0x32f86d=_0x1b7db7;}catch(_0x25e324){common_1['Logger'][_0x4de704(0x1ca)](_0x4de704(0x1e9)+_0x25e324['message'],_0x4de704(0x206)),_0x3da893=_0x63fa2b,_0x2224f4=_0x93a842,_0x32f86d=_0x1b7db7;}_0x435b1e['audioUrl']=_0x3da893[_0x4de704(0x20a)](','),_0x435b1e['videoUrl']=_0x2224f4['join'](','),_0x435b1e[_0x4de704(0x1c9)]=_0x32f86d['join'](',');_0x63fa2b[_0x4de704(0x1de)]===0x2?(_0x435b1e[_0x4de704(0x201)]=0x3,_0x435b1e[_0x4de704(0x1dd)]=_0x437919):(_0x435b1e[_0x4de704(0x201)]=0x2,_0x435b1e[_0x4de704(0x1d2)]=_0x1be724===null||_0x1be724===void 0x0?void 0x0:_0x1be724[_0x4de704(0x1d2)],_0x435b1e['answer']=_0x4de704(0x1d9)+(_0x1be724===null||_0x1be724===void 0x0?void 0x0:_0x1be724[_0x4de704(0x1d2)]));common_1[_0x4de704(0x1d3)][_0x4de704(0x205)](_0x4de704(0x218)+JSON['stringify'](_0xebc118),_0x4de704(0x1d8)),_0x43f6ac(_0x435b1e);return;}else _0x435b1e[_0x4de704(0x216)]=_0x63fa2b[_0x4de704(0x20a)](','),_0x435b1e[_0x4de704(0x21c)]=_0x93a842['join'](','),_0x435b1e['fileInfo']=_0x1b7db7[_0x4de704(0x20a)](','),_0x435b1e[_0x4de704(0x201)]=0x2,_0x435b1e['progress']=_0x1be724===null||_0x1be724===void 0x0?void 0x0:_0x1be724[_0x4de704(0x1d2)],_0x435b1e['answer']=_0x437919,_0x5e8ebe(_0x435b1e);}}!_0x435b1e[_0x4de704(0x216)]&&_0x435b1e[_0x4de704(0x1d2)]&&_0x435b1e[_0x4de704(0x201)]===0x2&&_0x92bf41(_0x435b1e);}}catch(_0x21484a){_0x5246b6++,common_1['Logger'][_0x4de704(0x1ca)](_0x4de704(0x1be)+_0x5246b6,'SunoService');}}common_1[_0x4de704(0x1d3)]['error']('轮询超时，请稍后再试！',_0x4de704(0x1d8)),_0x435b1e['status']=0x4,_0x536e92(_0x435b1e);throw new Error(_0x4de704(0x1d1));}catch(_0x3eab35){common_1[_0x4de704(0x1d3)][_0x4de704(0x1ca)](_0x4de704(0x212)+_0x3eab35,_0x4de704(0x1d8)),_0x435b1e[_0x4de704(0x201)]=0x5,_0x536e92(_0x435b1e);}}};SunoService=__decorate([(0x0,common_1['Injectable'])(),__metadata(_0x3588e3(0x1c2),[chatLog_service_1[_0x3588e3(0x207)],upload_service_1[_0x3588e3(0x213)],globalConfig_service_1[_0x3588e3(0x1bd)]])],SunoService),exports['SunoService']=SunoService;