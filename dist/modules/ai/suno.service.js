'use strict';function _0xf676(_0x26fe17,_0x1aa773){const _0x1f7bcf=_0x1f7b();return _0xf676=function(_0xf67690,_0x1bb613){_0xf67690=_0xf67690-0x102;let _0x546704=_0x1f7bcf[_0xf67690];return _0x546704;},_0xf676(_0x26fe17,_0x1aa773);}const _0x366e5a=_0xf676;(function(_0x53f1f4,_0x24b8ee){const _0x15ce49=_0xf676,_0x41affd=_0x53f1f4();while(!![]){try{const _0x1a7176=parseInt(_0x15ce49(0x11e))/0x1+parseInt(_0x15ce49(0x128))/0x2+parseInt(_0x15ce49(0x112))/0x3+-parseInt(_0x15ce49(0x152))/0x4*(parseInt(_0x15ce49(0x12d))/0x5)+-parseInt(_0x15ce49(0x12c))/0x6+-parseInt(_0x15ce49(0x144))/0x7*(parseInt(_0x15ce49(0x11c))/0x8)+-parseInt(_0x15ce49(0x14f))/0x9*(-parseInt(_0x15ce49(0x10a))/0xa);if(_0x1a7176===_0x24b8ee)break;else _0x41affd['push'](_0x41affd['shift']());}catch(_0x4d39d4){_0x41affd['push'](_0x41affd['shift']());}}}(_0x1f7b,0x3d08e));var __decorate=this&&this[_0x366e5a(0x11d)]||function(_0x489147,_0x4baba4,_0x46f4c5,_0x5c5b97){const _0xa5d646=_0x366e5a;var _0x3aa836=arguments[_0xa5d646(0x163)],_0x173288=_0x3aa836<0x3?_0x4baba4:_0x5c5b97===null?_0x5c5b97=Object[_0xa5d646(0x118)](_0x4baba4,_0x46f4c5):_0x5c5b97,_0x3f3f73;if(typeof Reflect===_0xa5d646(0x111)&&typeof Reflect[_0xa5d646(0x10c)]===_0xa5d646(0x124))_0x173288=Reflect[_0xa5d646(0x10c)](_0x489147,_0x4baba4,_0x46f4c5,_0x5c5b97);else{for(var _0x2f5d7d=_0x489147[_0xa5d646(0x163)]-0x1;_0x2f5d7d>=0x0;_0x2f5d7d--)if(_0x3f3f73=_0x489147[_0x2f5d7d])_0x173288=(_0x3aa836<0x3?_0x3f3f73(_0x173288):_0x3aa836>0x3?_0x3f3f73(_0x4baba4,_0x46f4c5,_0x173288):_0x3f3f73(_0x4baba4,_0x46f4c5))||_0x173288;}return _0x3aa836>0x3&&_0x173288&&Object[_0xa5d646(0x140)](_0x4baba4,_0x46f4c5,_0x173288),_0x173288;},__metadata=this&&this['__metadata']||function(_0x33cee2,_0x50cbd9){const _0x4d0695=_0x366e5a;if(typeof Reflect===_0x4d0695(0x111)&&typeof Reflect[_0x4d0695(0x15c)]===_0x4d0695(0x124))return Reflect[_0x4d0695(0x15c)](_0x33cee2,_0x50cbd9);};Object[_0x366e5a(0x140)](exports,_0x366e5a(0x10d),{'value':!![]}),exports[_0x366e5a(0x117)]=void 0x0;const common_1=require('@nestjs/common'),axios_1=require('axios'),chatLog_service_1=require('../chatLog/chatLog.service'),globalConfig_service_1=require('../globalConfig/globalConfig.service'),upload_service_1=require(_0x366e5a(0x139));let SunoService=class SunoService{constructor(_0x466012,_0x13affa,_0x3c20ed){const _0x43e480=_0x366e5a;this[_0x43e480(0x164)]=_0x466012,this[_0x43e480(0x13a)]=_0x13affa,this['globalConfigService']=_0x3c20ed;}async[_0x366e5a(0x149)](_0x6149b8){const _0x3b90ff=_0x366e5a;var _0x5aa8de,_0x359b3f,_0x18fe0a;const {apiKey:_0x359ae3,proxyUrl:_0x57f1b0,action:_0x275a44,prompt:_0x585bd6,timeout:_0x2a3815,assistantLogId:_0x40644d,taskData:_0x1cd171,extraParam:_0x459672}=_0x6149b8;common_1[_0x3b90ff(0x108)][_0x3b90ff(0x142)](_0x3b90ff(0x15a)+JSON['stringify'](_0x6149b8),_0x3b90ff(0x117));let _0x548cde={'text':'','fileInfo':'','taskId':'','taskData':'','status':0x2};common_1[_0x3b90ff(0x108)][_0x3b90ff(0x122)](_0x3b90ff(0x14d),'SunoService');let _0x349d05=null,_0x503d88='',_0x8cd9d={};const _0xd4df9b={'Authorization':_0x3b90ff(0x161)+_0x359ae3};_0x275a44===_0x3b90ff(0x114)&&(_0x503d88=_0x57f1b0+_0x3b90ff(0x119),_0x8cd9d={'prompt':_0x585bd6});if(_0x275a44==='MUSIC'){_0x503d88=_0x57f1b0+'/task/suno/v1/submit/music';try{_0x8cd9d=JSON[_0x3b90ff(0x120)](_0x1cd171);}catch(_0x255bfc){common_1[_0x3b90ff(0x108)][_0x3b90ff(0x12f)]('解析taskData失败:\x20'+_0x255bfc[_0x3b90ff(0x12a)],_0x3b90ff(0x117));throw new Error(_0x3b90ff(0x133));}}common_1[_0x3b90ff(0x108)][_0x3b90ff(0x122)](_0x3b90ff(0x110)+_0x503d88+'，payload:\x20'+JSON[_0x3b90ff(0x11b)](_0x8cd9d)+_0x3b90ff(0x14a)+JSON[_0x3b90ff(0x11b)](_0xd4df9b),'SunoService');try{_0x349d05=await axios_1['default']['post'](_0x503d88,_0x8cd9d,{'headers':_0xd4df9b}),common_1[_0x3b90ff(0x108)][_0x3b90ff(0x142)](_0x3b90ff(0x12e)+_0x349d05['status']+_0x3b90ff(0x125)+_0x349d05[_0x3b90ff(0x158)]+_0x3b90ff(0x145)+JSON[_0x3b90ff(0x11b)](_0x349d05[_0x3b90ff(0x151)]));}catch(_0xae0eba){common_1[_0x3b90ff(0x108)]['error']('任务提交失败:\x20'+_0xae0eba[_0x3b90ff(0x12a)],_0x3b90ff(0x117));throw new Error('任务提交失败');}if((_0x5aa8de=_0x349d05===null||_0x349d05===void 0x0?void 0x0:_0x349d05[_0x3b90ff(0x151)])===null||_0x5aa8de===void 0x0?void 0x0:_0x5aa8de[_0x3b90ff(0x151)])_0x548cde[_0x3b90ff(0x15e)]=(_0x359b3f=_0x349d05===null||_0x349d05===void 0x0?void 0x0:_0x349d05[_0x3b90ff(0x151)])===null||_0x359b3f===void 0x0?void 0x0:_0x359b3f[_0x3b90ff(0x151)],common_1[_0x3b90ff(0x108)][_0x3b90ff(0x122)]('任务提交成功,\x20任务ID:\x20'+((_0x18fe0a=_0x349d05===null||_0x349d05===void 0x0?void 0x0:_0x349d05['data'])===null||_0x18fe0a===void 0x0?void 0x0:_0x18fe0a['data']),_0x3b90ff(0x117));else throw new Error(_0x3b90ff(0x131));try{await this[_0x3b90ff(0x105)]({'proxyUrl':_0x57f1b0,'apiKey':_0x359ae3,'taskId':_0x349d05[_0x3b90ff(0x151)]['data'],'timeout':_0x2a3815,'prompt':_0x585bd6,'action':_0x275a44,'onSuccess':async _0x2ca1e6=>{const _0x303c85=_0x3b90ff;try{await this[_0x303c85(0x164)][_0x303c85(0x13e)](_0x40644d,{'videoUrl':_0x2ca1e6===null||_0x2ca1e6===void 0x0?void 0x0:_0x2ca1e6[_0x303c85(0x165)],'audioUrl':_0x2ca1e6===null||_0x2ca1e6===void 0x0?void 0x0:_0x2ca1e6['audioUrl'],'fileInfo':_0x2ca1e6===null||_0x2ca1e6===void 0x0?void 0x0:_0x2ca1e6['fileInfo'],'answer':(_0x2ca1e6===null||_0x2ca1e6===void 0x0?void 0x0:_0x2ca1e6[_0x303c85(0x115)])||_0x585bd6,'progress':_0x303c85(0x162),'status':0x3,'taskId':_0x2ca1e6===null||_0x2ca1e6===void 0x0?void 0x0:_0x2ca1e6['taskId'],'taskData':_0x2ca1e6===null||_0x2ca1e6===void 0x0?void 0x0:_0x2ca1e6['taskData']}),common_1[_0x303c85(0x108)][_0x303c85(0x122)](_0x303c85(0x113),_0x303c85(0x117));}catch(_0x3469a9){common_1[_0x303c85(0x108)]['error'](_0x303c85(0x138)+_0x3469a9[_0x303c85(0x12a)],_0x303c85(0x117));}},'onAudioSuccess':async _0x6f6b94=>{const _0x353de9=_0x3b90ff;try{await this[_0x353de9(0x164)][_0x353de9(0x13e)](_0x40644d,{'videoUrl':_0x6f6b94===null||_0x6f6b94===void 0x0?void 0x0:_0x6f6b94[_0x353de9(0x165)],'audioUrl':_0x6f6b94===null||_0x6f6b94===void 0x0?void 0x0:_0x6f6b94['audioUrl'],'fileInfo':_0x6f6b94===null||_0x6f6b94===void 0x0?void 0x0:_0x6f6b94[_0x353de9(0x10f)],'answer':(_0x6f6b94===null||_0x6f6b94===void 0x0?void 0x0:_0x6f6b94[_0x353de9(0x115)])||_0x585bd6,'progress':_0x6f6b94===null||_0x6f6b94===void 0x0?void 0x0:_0x6f6b94['progress'],'status':_0x6f6b94[_0x353de9(0x13c)],'taskId':_0x6f6b94===null||_0x6f6b94===void 0x0?void 0x0:_0x6f6b94['taskId'],'taskData':_0x6f6b94===null||_0x6f6b94===void 0x0?void 0x0:_0x6f6b94[_0x353de9(0x141)]}),common_1[_0x353de9(0x108)][_0x353de9(0x122)](_0x353de9(0x14b),_0x353de9(0x117));}catch(_0x1f51e1){common_1[_0x353de9(0x108)][_0x353de9(0x12f)]('更新日志失败:\x20'+_0x1f51e1['message'],_0x353de9(0x117));}},'onGenerating':async _0x424a69=>{const _0x59a820=_0x3b90ff;try{await this[_0x59a820(0x164)]['updateChatLog'](_0x40644d,{'videoUrl':_0x424a69===null||_0x424a69===void 0x0?void 0x0:_0x424a69[_0x59a820(0x165)],'audioUrl':_0x424a69===null||_0x424a69===void 0x0?void 0x0:_0x424a69['audioUrl'],'fileInfo':_0x424a69===null||_0x424a69===void 0x0?void 0x0:_0x424a69[_0x59a820(0x10f)],'answer':(_0x424a69===null||_0x424a69===void 0x0?void 0x0:_0x424a69['answer'])||_0x59a820(0x155),'progress':_0x424a69===null||_0x424a69===void 0x0?void 0x0:_0x424a69[_0x59a820(0x159)],'status':_0x424a69[_0x59a820(0x13c)]}),common_1[_0x59a820(0x108)][_0x59a820(0x122)](_0x59a820(0x155),'SunoService');}catch(_0x4192c1){common_1[_0x59a820(0x108)]['error'](_0x59a820(0x138)+_0x4192c1[_0x59a820(0x12a)],_0x59a820(0x117));}},'onFailure':async _0x2234ea=>{const _0x16bb9a=_0x3b90ff;try{await this[_0x16bb9a(0x164)]['updateChatLog'](_0x40644d,{'answer':_0x16bb9a(0x134),'status':_0x2234ea[_0x16bb9a(0x13c)]}),common_1[_0x16bb9a(0x108)][_0x16bb9a(0x122)](_0x16bb9a(0x154),_0x16bb9a(0x117));}catch(_0x30fbaa){common_1[_0x16bb9a(0x108)][_0x16bb9a(0x12f)](_0x16bb9a(0x138)+_0x30fbaa[_0x16bb9a(0x12a)],'SunoService');}}});}catch(_0x5b3526){common_1[_0x3b90ff(0x108)][_0x3b90ff(0x12f)](_0x3b90ff(0x130),_0x5b3526[_0x3b90ff(0x12a)],_0x3b90ff(0x117));throw new Error(_0x3b90ff(0x137));}return _0x548cde;}async[_0x366e5a(0x105)](_0x5d20d1){const _0x5c39b4=_0x366e5a,{proxyUrl:_0x3a5707,apiKey:_0x48f5e8,taskId:_0x2f1a38,timeout:_0x383888,onSuccess:_0x399014,onAudioSuccess:_0x1c8972,onFailure:_0x1acffb,onGenerating:_0x436ef9,action:_0x17b2e5}=_0x5d20d1;let _0xa6d58c={'videoUrl':'','audioUrl':'','fileInfo':'','drawId':'','taskData':'','status':0x2,'progress':0x0,'answer':''};const _0x1fa09e={'Authorization':_0x5c39b4(0x161)+_0x48f5e8},_0x12f9d1=_0x3a5707+'/task/suno/v1/fetch/'+_0x2f1a38,_0x32b01b=Date['now'](),_0x4bf0d9=0x1388;let _0x22b9c1=0x0;try{while(Date[_0x5c39b4(0x10b)]()-_0x32b01b<_0x383888){await new Promise(_0x239725=>setTimeout(_0x239725,_0x4bf0d9));try{const _0x3c2b24=await axios_1[_0x5c39b4(0x11f)][_0x5c39b4(0x126)](_0x12f9d1,{'headers':_0x1fa09e}),_0x22f56e=_0x3c2b24[_0x5c39b4(0x151)]['data'];common_1['Logger'][_0x5c39b4(0x142)](_0x5c39b4(0x13f)+JSON[_0x5c39b4(0x11b)](_0x22f56e),_0x5c39b4(0x117));if(_0x17b2e5===_0x5c39b4(0x114)){if(_0x22f56e['status']==='SUCCESS'){_0xa6d58c[_0x5c39b4(0x15e)]=_0x22f56e[_0x5c39b4(0x151)]['id'],_0xa6d58c[_0x5c39b4(0x141)]=JSON['stringify'](_0x22f56e[_0x5c39b4(0x151)]),_0xa6d58c[_0x5c39b4(0x115)]=_0x22f56e[_0x5c39b4(0x151)][_0x5c39b4(0x102)],_0x399014(_0xa6d58c);return;}_0xa6d58c[_0x5c39b4(0x159)]=_0x22f56e===null||_0x22f56e===void 0x0?void 0x0:_0x22f56e['progress'],_0xa6d58c[_0x5c39b4(0x115)]=_0x5c39b4(0x146),_0xa6d58c[_0x5c39b4(0x159)]&&_0x436ef9(_0xa6d58c);}if(_0x17b2e5===_0x5c39b4(0x15d)){if(_0x22f56e[_0x5c39b4(0x151)]){const _0x3fc6e0=_0x22f56e[_0x5c39b4(0x151)];_0xa6d58c[_0x5c39b4(0x141)]=JSON[_0x5c39b4(0x11b)](_0x3fc6e0);if(Array['isArray'](_0x3fc6e0)){const _0x3d70c2=_0x3fc6e0[_0x5c39b4(0x135)](_0x1d0868=>_0x1d0868[_0x5c39b4(0x150)])[_0x5c39b4(0x147)](_0x1d9e78=>_0x1d9e78),_0xccf131=_0x3fc6e0[_0x5c39b4(0x135)](_0x3d3082=>_0x3d3082['video_url'])[_0x5c39b4(0x147)](_0x539529=>_0x539529),_0x236a5d=_0x3fc6e0['map'](_0x11327f=>_0x11327f['image_url'])['filter'](_0x109b23=>_0x109b23),_0x3c9c28=_0x3fc6e0[_0x5c39b4(0x135)](_0x279798=>_0x279798[_0x5c39b4(0x14c)]),_0xb1e294=_0x3c9c28[_0x5c39b4(0x163)]>0x0?_0x3c9c28[0x0]:_0x5c39b4(0x15f);if(_0x22f56e['status']===_0x5c39b4(0x132)){let _0x53c14d=[],_0x3218cd=[],_0x2d3f0d=[];try{const _0x21a5c1=await this[_0x5c39b4(0x160)]['getConfigs']([_0x5c39b4(0x13d)]);if(Number(_0x21a5c1)){const _0x372b33=new Date(),_0x1e66cc=_0x372b33[_0x5c39b4(0x107)](),_0x3c287d=String(_0x372b33[_0x5c39b4(0x11a)]()+0x1)[_0x5c39b4(0x156)](0x2,'0'),_0x120e9f=String(_0x372b33[_0x5c39b4(0x104)]())[_0x5c39b4(0x156)](0x2,'0'),_0x2c8f52=''+_0x1e66cc+_0x3c287d+'/'+_0x120e9f;for(const _0xb96658 of _0x3d70c2){try{const _0x150882=await this[_0x5c39b4(0x13a)]['uploadFileFromUrl']({'url':_0xb96658,'dir':_0x5c39b4(0x109)+_0x2c8f52});_0x53c14d[_0x5c39b4(0x15b)](_0x150882);}catch(_0xb0315c){common_1[_0x5c39b4(0x108)][_0x5c39b4(0x12f)]('上传音频文件失败:\x20'+_0xb0315c[_0x5c39b4(0x12a)],_0x5c39b4(0x117)),_0x53c14d[_0x5c39b4(0x15b)](_0xb96658);}}for(const _0x3b579b of _0xccf131){try{const _0x3961a4=await this[_0x5c39b4(0x13a)]['uploadFileFromUrl']({'url':_0x3b579b,'dir':_0x5c39b4(0x103)+_0x2c8f52});_0x3218cd[_0x5c39b4(0x15b)](_0x3961a4);}catch(_0x1edce8){common_1['Logger'][_0x5c39b4(0x12f)](_0x5c39b4(0x12b)+_0x1edce8[_0x5c39b4(0x12a)],_0x5c39b4(0x117)),_0x3218cd['push'](_0x3b579b);}}for(const _0x10274d of _0x236a5d){try{const _0x117846=await this[_0x5c39b4(0x13a)][_0x5c39b4(0x157)]({'url':_0x10274d,'dir':_0x5c39b4(0x10e)+_0x2c8f52});_0x2d3f0d[_0x5c39b4(0x15b)](_0x117846);}catch(_0x3a1cf6){common_1[_0x5c39b4(0x108)][_0x5c39b4(0x12f)](_0x5c39b4(0x153)+_0x3a1cf6[_0x5c39b4(0x12a)],_0x5c39b4(0x117)),_0x2d3f0d[_0x5c39b4(0x15b)](_0x10274d);}}}else _0x53c14d=_0x3d70c2,_0x3218cd=_0xccf131,_0x2d3f0d=_0x236a5d;}catch(_0x1de208){common_1['Logger']['error']('获取配置失败:\x20'+_0x1de208[_0x5c39b4(0x12a)],_0x5c39b4(0x129)),_0x53c14d=_0x3d70c2,_0x3218cd=_0xccf131,_0x2d3f0d=_0x236a5d;}_0xa6d58c['audioUrl']=_0x53c14d[_0x5c39b4(0x13b)](','),_0xa6d58c['videoUrl']=_0x3218cd[_0x5c39b4(0x13b)](','),_0xa6d58c[_0x5c39b4(0x10f)]=_0x2d3f0d[_0x5c39b4(0x13b)](',');_0x3d70c2['length']===0x2?(_0xa6d58c[_0x5c39b4(0x13c)]=0x3,_0xa6d58c[_0x5c39b4(0x115)]=_0xb1e294):(_0xa6d58c[_0x5c39b4(0x13c)]=0x2,_0xa6d58c['progress']=_0x22f56e===null||_0x22f56e===void 0x0?void 0x0:_0x22f56e['progress'],_0xa6d58c[_0x5c39b4(0x115)]=_0x5c39b4(0x116)+(_0x22f56e===null||_0x22f56e===void 0x0?void 0x0:_0x22f56e[_0x5c39b4(0x159)]));common_1[_0x5c39b4(0x108)]['debug'](_0x5c39b4(0x123)+JSON[_0x5c39b4(0x11b)](_0x3fc6e0),_0x5c39b4(0x117)),_0x399014(_0xa6d58c);return;}else _0xa6d58c['audioUrl']=_0x3d70c2[_0x5c39b4(0x13b)](','),_0xa6d58c['videoUrl']=_0xccf131[_0x5c39b4(0x13b)](','),_0xa6d58c[_0x5c39b4(0x10f)]=_0x236a5d[_0x5c39b4(0x13b)](','),_0xa6d58c[_0x5c39b4(0x13c)]=0x2,_0xa6d58c[_0x5c39b4(0x159)]=_0x22f56e===null||_0x22f56e===void 0x0?void 0x0:_0x22f56e[_0x5c39b4(0x159)],_0xa6d58c['answer']=_0xb1e294,_0x1c8972(_0xa6d58c);}}!_0xa6d58c[_0x5c39b4(0x14e)]&&_0xa6d58c[_0x5c39b4(0x159)]&&_0xa6d58c['status']===0x2&&_0x436ef9(_0xa6d58c);}}catch(_0x4a83d0){_0x22b9c1++,common_1[_0x5c39b4(0x108)][_0x5c39b4(0x12f)]('轮询失败，重试次数:\x20'+_0x22b9c1,_0x5c39b4(0x117));}}common_1[_0x5c39b4(0x108)][_0x5c39b4(0x12f)](_0x5c39b4(0x106),_0x5c39b4(0x117)),_0xa6d58c['status']=0x4,_0x1acffb(_0xa6d58c);throw new Error(_0x5c39b4(0x121));}catch(_0x32c318){common_1[_0x5c39b4(0x108)][_0x5c39b4(0x12f)](_0x5c39b4(0x127)+_0x32c318,_0x5c39b4(0x117)),_0xa6d58c[_0x5c39b4(0x13c)]=0x5,_0x1acffb(_0xa6d58c);}}};SunoService=__decorate([(0x0,common_1['Injectable'])(),__metadata(_0x366e5a(0x148),[chatLog_service_1[_0x366e5a(0x136)],upload_service_1[_0x366e5a(0x143)],globalConfig_service_1['GlobalConfigService']])],SunoService),exports['SunoService']=SunoService;function _0x1f7b(){const _0x477ff3=['查询生成结果时发生错误:','未能获取结果数据,\x20即将重试','SUCCESS','taskData格式错误','音乐生成失败','map','ChatLogService','查询生成结果时发生错误','更新日志失败:\x20','../upload/upload.service','uploadService','join','status','localStorageStatus','updateChatLog','轮询结果:\x20','defineProperty','taskData','debug','UploadService','21ZLBuzk',',\x20数据:\x20','歌词生成中','filter','design:paramtypes','suno',',\x20headers:\x20','音频生成成功，等待视频生成...','title','开始生成音乐','audioUrl','4083039ctlMPo','audio_url','data','6464Zhgcwb','上传图片文件失败:\x20','生成失败','音乐生成中...','padStart','uploadFileFromUrl','statusText','progress','SunoService:\x20','push','metadata','MUSIC','taskId','音乐已生成','globalConfigService','Bearer\x20','100%','length','chatLogService','videoUrl','text','video/suno-music/','getDate','pollSunoMusicResult','轮询超时，请稍后再试！','getFullYear','Logger','audio/suno-music/','20tBfDDs','now','decorate','__esModule','images/suno-music/','fileInfo','正在准备发送请求到\x20','object','761712zsmBux','音乐任务已完成','LYRICS','answer','当前生成进度\x20','SunoService','getOwnPropertyDescriptor','/task/suno/v1/submit/lyrics','getMonth','stringify','441472xWvsZh','__decorate','15668aoiMQk','default','parse','查询超时，请稍后再试！','log','音乐生成成功:\x20','function',',\x20状态消息:\x20','get','轮询过程中发生错误:\x20','189780ENBxOI','LumaService','message','上传视频文件失败:\x20','2442036GjcLKs','1390DSrtkS','任务提交结果，状态码:\x20','error'];_0x1f7b=function(){return _0x477ff3;};return _0x1f7b();}