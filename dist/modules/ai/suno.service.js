'use strict';const _0xe2ae8d=_0x196a;function _0x56e1(){const _0x5f5472=['decorate','UploadService','uploadService','2098328RhsToL','轮询结果:\x20','@nestjs/common','ChatLogService','歌词生成中','音乐任务已完成','object','post','videoUrl','../chatLog/chatLog.service','get','任务提交结果，状态码:\x20','log','audio/suno-music/','fileInfo','length','Bearer\x20','data','SUCCESS','../upload/upload.service','now','title','Logger','images/suno-music/','getOwnPropertyDescriptor','getDate','axios','error','未能获取结果数据,\x20即将重试','2585805xQliHo',',\x20headers:\x20','__metadata','MUSIC','查询超时，请稍后再试！','answer','default','text','2416356lJBkNs','开始生成音乐','metadata','35hvveAa','GlobalConfigService','getConfigs','获取配置失败:\x20','getMonth','uploadFileFromUrl','2635362VuMzQU','/task/suno/v1/fetch/','status','任务提交失败:\x20','message','image_url','audioUrl','chatLogService','更新日志失败:\x20','轮询超时，请稍后再试！','Injectable','parse','，payload:\x20','音频生成成功，等待视频生成...','globalConfigService','isArray','getFullYear','suno','filter','padStart',',\x20状态消息:\x20','updateChatLog','debug','__decorate','当前生成进度\x20','948688GdaMsI','4741612qFwXYt','SunoService','__esModule','push','taskId','stringify','progress','video/suno-music/','defineProperty','解析taskData失败:\x20','LYRICS','map','上传音频文件失败:\x20','任务提交成功,\x20任务ID:\x20','查询生成结果时发生错误:','join','LumaService','design:paramtypes','../globalConfig/globalConfig.service','pollSunoMusicResult','taskData','function','音乐生成中...','958298AtbBvo',',\x20数据:\x20'];_0x56e1=function(){return _0x5f5472;};return _0x56e1();}(function(_0x2570f4,_0x1e6405){const _0x38f725=_0x196a,_0x1e26cb=_0x2570f4();while(!![]){try{const _0xc2c4b=parseInt(_0x38f725(0x122))/0x1+parseInt(_0x38f725(0x127))/0x2+-parseInt(_0x38f725(0x14c))/0x3+parseInt(_0x38f725(0x10b))/0x4+-parseInt(_0x38f725(0x144))/0x5+-parseInt(_0x38f725(0x155))/0x6+parseInt(_0x38f725(0x14f))/0x7*(-parseInt(_0x38f725(0x16e))/0x8);if(_0xc2c4b===_0x1e6405)break;else _0x1e26cb['push'](_0x1e26cb['shift']());}catch(_0x26344a){_0x1e26cb['push'](_0x1e26cb['shift']());}}}(_0x56e1,0xcc9cf));function _0x196a(_0x3dc6d8,_0x3cd59f){const _0x56e189=_0x56e1();return _0x196a=function(_0x196a30,_0xbd2ccf){_0x196a30=_0x196a30-0x10b;let _0x4da592=_0x56e189[_0x196a30];return _0x4da592;},_0x196a(_0x3dc6d8,_0x3cd59f);}var __decorate=this&&this[_0xe2ae8d(0x16c)]||function(_0x5503dd,_0x260627,_0x50f6b6,_0x33db9e){const _0x4892ec=_0xe2ae8d;var _0x589faa=arguments['length'],_0xd10423=_0x589faa<0x3?_0x260627:_0x33db9e===null?_0x33db9e=Object[_0x4892ec(0x13f)](_0x260627,_0x50f6b6):_0x33db9e,_0xcc49bb;if(typeof Reflect==='object'&&typeof Reflect[_0x4892ec(0x124)]===_0x4892ec(0x120))_0xd10423=Reflect[_0x4892ec(0x124)](_0x5503dd,_0x260627,_0x50f6b6,_0x33db9e);else{for(var _0x160fb4=_0x5503dd[_0x4892ec(0x136)]-0x1;_0x160fb4>=0x0;_0x160fb4--)if(_0xcc49bb=_0x5503dd[_0x160fb4])_0xd10423=(_0x589faa<0x3?_0xcc49bb(_0xd10423):_0x589faa>0x3?_0xcc49bb(_0x260627,_0x50f6b6,_0xd10423):_0xcc49bb(_0x260627,_0x50f6b6))||_0xd10423;}return _0x589faa>0x3&&_0xd10423&&Object[_0x4892ec(0x113)](_0x260627,_0x50f6b6,_0xd10423),_0xd10423;},__metadata=this&&this[_0xe2ae8d(0x146)]||function(_0x4adba5,_0x246ce8){const _0x35b9e1=_0xe2ae8d;if(typeof Reflect===_0x35b9e1(0x12d)&&typeof Reflect[_0x35b9e1(0x14e)]===_0x35b9e1(0x120))return Reflect[_0x35b9e1(0x14e)](_0x4adba5,_0x246ce8);};Object['defineProperty'](exports,_0xe2ae8d(0x10d),{'value':!![]}),exports[_0xe2ae8d(0x10c)]=void 0x0;const common_1=require(_0xe2ae8d(0x129)),axios_1=require(_0xe2ae8d(0x141)),chatLog_service_1=require(_0xe2ae8d(0x130)),globalConfig_service_1=require(_0xe2ae8d(0x11d)),upload_service_1=require(_0xe2ae8d(0x13a));let SunoService=class SunoService{constructor(_0x5a9bdf,_0x48d91d,_0x54fe22){const _0x2e355a=_0xe2ae8d;this[_0x2e355a(0x15c)]=_0x5a9bdf,this['uploadService']=_0x48d91d,this[_0x2e355a(0x163)]=_0x54fe22;}async[_0xe2ae8d(0x166)](_0x18b92f){const _0x3c2148=_0xe2ae8d;var _0x2d5892,_0xdf7af3,_0x3e1808;const {apiKey:_0x546a5c,proxyUrl:_0x376ec4,action:_0x4e1417,prompt:_0x461220,timeout:_0x4a3b59,assistantLogId:_0x498ef7,taskData:_0x38d05c,extraParam:_0x246e0e}=_0x18b92f;common_1[_0x3c2148(0x13d)]['debug']('SunoService:\x20'+JSON[_0x3c2148(0x110)](_0x18b92f),_0x3c2148(0x10c));let _0x3b87f4={'text':'','fileInfo':'','taskId':'','taskData':'','status':0x2};common_1['Logger'][_0x3c2148(0x133)](_0x3c2148(0x14d),_0x3c2148(0x10c));let _0x91a45=null,_0x28dff1='',_0x59252b={};const _0x5c940f={'Authorization':_0x3c2148(0x137)+_0x546a5c};_0x4e1417===_0x3c2148(0x115)&&(_0x28dff1=_0x376ec4+'/task/suno/v1/submit/lyrics',_0x59252b={'prompt':_0x461220});if(_0x4e1417===_0x3c2148(0x147)){_0x28dff1=_0x376ec4+'/task/suno/v1/submit/music';try{_0x59252b=JSON[_0x3c2148(0x160)](_0x38d05c);}catch(_0x23dc14){common_1[_0x3c2148(0x13d)][_0x3c2148(0x142)](_0x3c2148(0x114)+_0x23dc14[_0x3c2148(0x159)],_0x3c2148(0x10c));throw new Error('taskData格式错误');}}common_1[_0x3c2148(0x13d)][_0x3c2148(0x133)]('正在准备发送请求到\x20'+_0x28dff1+_0x3c2148(0x161)+JSON['stringify'](_0x59252b)+_0x3c2148(0x145)+JSON[_0x3c2148(0x110)](_0x5c940f),_0x3c2148(0x10c));try{_0x91a45=await axios_1['default'][_0x3c2148(0x12e)](_0x28dff1,_0x59252b,{'headers':_0x5c940f}),common_1[_0x3c2148(0x13d)]['debug'](_0x3c2148(0x132)+_0x91a45[_0x3c2148(0x157)]+_0x3c2148(0x169)+_0x91a45['statusText']+_0x3c2148(0x123)+JSON[_0x3c2148(0x110)](_0x91a45[_0x3c2148(0x138)]));}catch(_0x50074c){common_1[_0x3c2148(0x13d)][_0x3c2148(0x142)](_0x3c2148(0x158)+_0x50074c[_0x3c2148(0x159)],_0x3c2148(0x10c));throw new Error('任务提交失败');}if((_0x2d5892=_0x91a45===null||_0x91a45===void 0x0?void 0x0:_0x91a45[_0x3c2148(0x138)])===null||_0x2d5892===void 0x0?void 0x0:_0x2d5892[_0x3c2148(0x138)])_0x3b87f4['taskId']=(_0xdf7af3=_0x91a45===null||_0x91a45===void 0x0?void 0x0:_0x91a45['data'])===null||_0xdf7af3===void 0x0?void 0x0:_0xdf7af3[_0x3c2148(0x138)],common_1[_0x3c2148(0x13d)][_0x3c2148(0x133)](_0x3c2148(0x118)+((_0x3e1808=_0x91a45===null||_0x91a45===void 0x0?void 0x0:_0x91a45['data'])===null||_0x3e1808===void 0x0?void 0x0:_0x3e1808['data']),_0x3c2148(0x10c));else throw new Error(_0x3c2148(0x143));try{await this[_0x3c2148(0x11e)]({'proxyUrl':_0x376ec4,'apiKey':_0x546a5c,'taskId':_0x91a45[_0x3c2148(0x138)][_0x3c2148(0x138)],'timeout':_0x4a3b59,'prompt':_0x461220,'action':_0x4e1417,'onSuccess':async _0x580f13=>{const _0x72344b=_0x3c2148;try{await this[_0x72344b(0x15c)]['updateChatLog'](_0x498ef7,{'videoUrl':_0x580f13===null||_0x580f13===void 0x0?void 0x0:_0x580f13['videoUrl'],'audioUrl':_0x580f13===null||_0x580f13===void 0x0?void 0x0:_0x580f13['audioUrl'],'fileInfo':_0x580f13===null||_0x580f13===void 0x0?void 0x0:_0x580f13[_0x72344b(0x135)],'answer':(_0x580f13===null||_0x580f13===void 0x0?void 0x0:_0x580f13[_0x72344b(0x149)])||_0x461220,'progress':'100%','status':0x3,'taskId':_0x580f13===null||_0x580f13===void 0x0?void 0x0:_0x580f13['taskId'],'taskData':_0x580f13===null||_0x580f13===void 0x0?void 0x0:_0x580f13[_0x72344b(0x11f)]}),common_1[_0x72344b(0x13d)][_0x72344b(0x133)](_0x72344b(0x12c),_0x72344b(0x10c));}catch(_0x3d19d2){common_1['Logger'][_0x72344b(0x142)]('更新日志失败:\x20'+_0x3d19d2[_0x72344b(0x159)],_0x72344b(0x10c));}},'onAudioSuccess':async _0x5cb1b1=>{const _0x541873=_0x3c2148;try{await this['chatLogService'][_0x541873(0x16a)](_0x498ef7,{'videoUrl':_0x5cb1b1===null||_0x5cb1b1===void 0x0?void 0x0:_0x5cb1b1[_0x541873(0x12f)],'audioUrl':_0x5cb1b1===null||_0x5cb1b1===void 0x0?void 0x0:_0x5cb1b1['audioUrl'],'fileInfo':_0x5cb1b1===null||_0x5cb1b1===void 0x0?void 0x0:_0x5cb1b1[_0x541873(0x135)],'answer':(_0x5cb1b1===null||_0x5cb1b1===void 0x0?void 0x0:_0x5cb1b1['answer'])||_0x461220,'progress':_0x5cb1b1===null||_0x5cb1b1===void 0x0?void 0x0:_0x5cb1b1['progress'],'status':_0x5cb1b1['status'],'taskId':_0x5cb1b1===null||_0x5cb1b1===void 0x0?void 0x0:_0x5cb1b1[_0x541873(0x10f)],'taskData':_0x5cb1b1===null||_0x5cb1b1===void 0x0?void 0x0:_0x5cb1b1['taskData']}),common_1[_0x541873(0x13d)][_0x541873(0x133)](_0x541873(0x162),_0x541873(0x10c));}catch(_0x241b6e){common_1['Logger'][_0x541873(0x142)](_0x541873(0x15d)+_0x241b6e[_0x541873(0x159)],_0x541873(0x10c));}},'onGenerating':async _0x466c1=>{const _0x3db1ba=_0x3c2148;try{await this['chatLogService'][_0x3db1ba(0x16a)](_0x498ef7,{'videoUrl':_0x466c1===null||_0x466c1===void 0x0?void 0x0:_0x466c1['videoUrl'],'audioUrl':_0x466c1===null||_0x466c1===void 0x0?void 0x0:_0x466c1[_0x3db1ba(0x15b)],'fileInfo':_0x466c1===null||_0x466c1===void 0x0?void 0x0:_0x466c1[_0x3db1ba(0x135)],'answer':(_0x466c1===null||_0x466c1===void 0x0?void 0x0:_0x466c1[_0x3db1ba(0x149)])||'音乐生成中...','progress':_0x466c1===null||_0x466c1===void 0x0?void 0x0:_0x466c1[_0x3db1ba(0x111)],'status':_0x466c1[_0x3db1ba(0x157)]}),common_1['Logger'][_0x3db1ba(0x133)](_0x3db1ba(0x121),_0x3db1ba(0x10c));}catch(_0x11a3b3){common_1[_0x3db1ba(0x13d)][_0x3db1ba(0x142)](_0x3db1ba(0x15d)+_0x11a3b3['message'],_0x3db1ba(0x10c));}},'onFailure':async _0x41e5d6=>{const _0x330bd8=_0x3c2148;try{await this['chatLogService']['updateChatLog'](_0x498ef7,{'answer':'音乐生成失败','status':_0x41e5d6[_0x330bd8(0x157)]}),common_1[_0x330bd8(0x13d)][_0x330bd8(0x133)]('生成失败',_0x330bd8(0x10c));}catch(_0xcfd5ce){common_1[_0x330bd8(0x13d)][_0x330bd8(0x142)](_0x330bd8(0x15d)+_0xcfd5ce['message'],_0x330bd8(0x10c));}}});}catch(_0x3b3516){common_1[_0x3c2148(0x13d)]['error'](_0x3c2148(0x119),_0x3b3516[_0x3c2148(0x159)],_0x3c2148(0x10c));throw new Error('查询生成结果时发生错误');}return _0x3b87f4;}async[_0xe2ae8d(0x11e)](_0xd32cb4){const _0x45d00d=_0xe2ae8d,{proxyUrl:_0x25c075,apiKey:_0x20997c,taskId:_0x4c5edb,timeout:_0x4b5492,onSuccess:_0x3a5f9f,onAudioSuccess:_0x37785e,onFailure:_0x16f0b8,onGenerating:_0x31f38c,action:_0x1d5ffe}=_0xd32cb4;let _0x3db094={'videoUrl':'','audioUrl':'','fileInfo':'','drawId':'','taskData':'','status':0x2,'progress':0x0,'answer':''};const _0x5b264d={'Authorization':_0x45d00d(0x137)+_0x20997c},_0x58cc45=_0x25c075+_0x45d00d(0x156)+_0x4c5edb,_0x4cc866=Date[_0x45d00d(0x13b)](),_0x54d7ef=0x1388;let _0x48518e=0x0;try{while(Date['now']()-_0x4cc866<_0x4b5492){await new Promise(_0x15bba4=>setTimeout(_0x15bba4,_0x54d7ef));try{const _0x5883fc=await axios_1[_0x45d00d(0x14a)][_0x45d00d(0x131)](_0x58cc45,{'headers':_0x5b264d}),_0xca790e=_0x5883fc[_0x45d00d(0x138)][_0x45d00d(0x138)];common_1[_0x45d00d(0x13d)][_0x45d00d(0x16b)](_0x45d00d(0x128)+JSON[_0x45d00d(0x110)](_0xca790e),'SunoService');if(_0x1d5ffe===_0x45d00d(0x115)){if(_0xca790e[_0x45d00d(0x157)]===_0x45d00d(0x139)){_0x3db094[_0x45d00d(0x10f)]=_0xca790e[_0x45d00d(0x138)]['id'],_0x3db094[_0x45d00d(0x11f)]=JSON['stringify'](_0xca790e[_0x45d00d(0x138)]),_0x3db094[_0x45d00d(0x149)]=_0xca790e[_0x45d00d(0x138)][_0x45d00d(0x14b)],_0x3a5f9f(_0x3db094);return;}_0x3db094[_0x45d00d(0x111)]=_0xca790e===null||_0xca790e===void 0x0?void 0x0:_0xca790e['progress'],_0x3db094['answer']=_0x45d00d(0x12b),_0x3db094[_0x45d00d(0x111)]&&_0x31f38c(_0x3db094);}if(_0x1d5ffe===_0x45d00d(0x147)){if(_0xca790e['data']){const _0x5bf011=_0xca790e['data'];_0x3db094[_0x45d00d(0x11f)]=JSON[_0x45d00d(0x110)](_0x5bf011);if(Array[_0x45d00d(0x164)](_0x5bf011)){const _0x493934=_0x5bf011[_0x45d00d(0x116)](_0xe4d40f=>_0xe4d40f['audio_url'])[_0x45d00d(0x167)](_0x41c8bb=>_0x41c8bb),_0x4ea55c=_0x5bf011['map'](_0x1b6737=>_0x1b6737['video_url'])[_0x45d00d(0x167)](_0xb13e18=>_0xb13e18),_0xd7b9bc=_0x5bf011[_0x45d00d(0x116)](_0x48f1cf=>_0x48f1cf[_0x45d00d(0x15a)])['filter'](_0x107965=>_0x107965),_0x2a065f=_0x5bf011[_0x45d00d(0x116)](_0x3060dd=>_0x3060dd[_0x45d00d(0x13c)]),_0x5dcc0f=_0x2a065f[_0x45d00d(0x136)]>0x0?_0x2a065f[0x0]:'音乐已生成';if(_0xca790e[_0x45d00d(0x157)]===_0x45d00d(0x139)){let _0xafe15e=[],_0x580702=[],_0x32968f=[];try{const _0x3215d6=await this['globalConfigService'][_0x45d00d(0x151)](['localStorageStatus']);if(Number(_0x3215d6)){const _0x4bf413=new Date(),_0x4b5d00=_0x4bf413[_0x45d00d(0x165)](),_0x51febf=String(_0x4bf413[_0x45d00d(0x153)]()+0x1)[_0x45d00d(0x168)](0x2,'0'),_0x2b9f8f=String(_0x4bf413[_0x45d00d(0x140)]())[_0x45d00d(0x168)](0x2,'0'),_0xacfc42=''+_0x4b5d00+_0x51febf+'/'+_0x2b9f8f;for(const _0x51365b of _0x493934){try{const _0x2055ab=await this[_0x45d00d(0x126)][_0x45d00d(0x154)]({'url':_0x51365b,'dir':_0x45d00d(0x134)+_0xacfc42});_0xafe15e['push'](_0x2055ab);}catch(_0x471c38){common_1[_0x45d00d(0x13d)][_0x45d00d(0x142)](_0x45d00d(0x117)+_0x471c38[_0x45d00d(0x159)],_0x45d00d(0x10c)),_0xafe15e[_0x45d00d(0x10e)](_0x51365b);}}for(const _0x522a96 of _0x4ea55c){try{const _0x4e96dd=await this[_0x45d00d(0x126)][_0x45d00d(0x154)]({'url':_0x522a96,'dir':_0x45d00d(0x112)+_0xacfc42});_0x580702['push'](_0x4e96dd);}catch(_0x5b13ed){common_1['Logger'][_0x45d00d(0x142)]('上传视频文件失败:\x20'+_0x5b13ed['message'],_0x45d00d(0x10c)),_0x580702[_0x45d00d(0x10e)](_0x522a96);}}for(const _0x269bf3 of _0xd7b9bc){try{const _0x4c8273=await this[_0x45d00d(0x126)][_0x45d00d(0x154)]({'url':_0x269bf3,'dir':_0x45d00d(0x13e)+_0xacfc42});_0x32968f[_0x45d00d(0x10e)](_0x4c8273);}catch(_0x432b87){common_1['Logger'][_0x45d00d(0x142)]('上传图片文件失败:\x20'+_0x432b87[_0x45d00d(0x159)],_0x45d00d(0x10c)),_0x32968f[_0x45d00d(0x10e)](_0x269bf3);}}}else _0xafe15e=_0x493934,_0x580702=_0x4ea55c,_0x32968f=_0xd7b9bc;}catch(_0x27f691){common_1[_0x45d00d(0x13d)]['error'](_0x45d00d(0x152)+_0x27f691['message'],_0x45d00d(0x11b)),_0xafe15e=_0x493934,_0x580702=_0x4ea55c,_0x32968f=_0xd7b9bc;}_0x3db094[_0x45d00d(0x15b)]=_0xafe15e[_0x45d00d(0x11a)](','),_0x3db094[_0x45d00d(0x12f)]=_0x580702[_0x45d00d(0x11a)](','),_0x3db094['fileInfo']=_0x32968f[_0x45d00d(0x11a)](',');_0x493934['length']===0x2?(_0x3db094[_0x45d00d(0x157)]=0x3,_0x3db094[_0x45d00d(0x149)]=_0x5dcc0f):(_0x3db094['status']=0x2,_0x3db094[_0x45d00d(0x111)]=_0xca790e===null||_0xca790e===void 0x0?void 0x0:_0xca790e[_0x45d00d(0x111)],_0x3db094['answer']=_0x45d00d(0x16d)+(_0xca790e===null||_0xca790e===void 0x0?void 0x0:_0xca790e[_0x45d00d(0x111)]));common_1['Logger'][_0x45d00d(0x16b)]('音乐生成成功:\x20'+JSON[_0x45d00d(0x110)](_0x5bf011),_0x45d00d(0x10c)),_0x3a5f9f(_0x3db094);return;}else _0x3db094[_0x45d00d(0x15b)]=_0x493934['join'](','),_0x3db094[_0x45d00d(0x12f)]=_0x4ea55c[_0x45d00d(0x11a)](','),_0x3db094[_0x45d00d(0x135)]=_0xd7b9bc[_0x45d00d(0x11a)](','),_0x3db094[_0x45d00d(0x157)]=0x2,_0x3db094['progress']=_0xca790e===null||_0xca790e===void 0x0?void 0x0:_0xca790e[_0x45d00d(0x111)],_0x3db094[_0x45d00d(0x149)]=_0x5dcc0f,_0x37785e(_0x3db094);}}!_0x3db094['audioUrl']&&_0x3db094['progress']&&_0x3db094[_0x45d00d(0x157)]===0x2&&_0x31f38c(_0x3db094);}}catch(_0x12f305){_0x48518e++,common_1['Logger']['error']('轮询失败，重试次数:\x20'+_0x48518e,_0x45d00d(0x10c));}}common_1[_0x45d00d(0x13d)][_0x45d00d(0x142)](_0x45d00d(0x15e),'SunoService'),_0x3db094['status']=0x4,_0x16f0b8(_0x3db094);throw new Error(_0x45d00d(0x148));}catch(_0x156aa6){common_1['Logger']['error']('轮询过程中发生错误:\x20'+_0x156aa6,'SunoService'),_0x3db094[_0x45d00d(0x157)]=0x5,_0x16f0b8(_0x3db094);}}};SunoService=__decorate([(0x0,common_1[_0xe2ae8d(0x15f)])(),__metadata(_0xe2ae8d(0x11c),[chatLog_service_1[_0xe2ae8d(0x12a)],upload_service_1[_0xe2ae8d(0x125)],globalConfig_service_1[_0xe2ae8d(0x150)]])],SunoService),exports[_0xe2ae8d(0x10c)]=SunoService;