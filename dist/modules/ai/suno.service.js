'use strict';const _0x6d4514=_0x4ab7;function _0x2de8(){const _0x4e8586=['Bearer\x20','decorate','getFullYear','音频生成成功，等待视频生成...','__esModule','pollSunoMusicResult','轮询失败，重试次数:\x20','progress','100%','Logger','获取配置失败:\x20','function','1505405ViZChu','filter','111404VbIgIe','SunoService','uploadService','更新日志失败:\x20','statusText','MUSIC','1559628IuxdiD','生成失败','images/suno-music/','default','查询超时，请稍后再试！','未能获取结果数据,\x20即将重试','轮询超时，请稍后再试！','/task/suno/v1/fetch/','taskId','任务提交失败','30594WgSUoP','解析taskData失败:\x20','音乐生成失败','defineProperty','10yTJvGX','音乐生成成功:\x20','@nestjs/common','answer','../upload/upload.service','__metadata','UploadService','SunoService:\x20','uploadFileFromUrl','taskData','message','上传视频文件失败:\x20','fileInfo','debug','text','/task/suno/v1/submit/music','chatLogService','任务提交成功,\x20任务ID:\x20','parse','join','音乐已生成','getMonth','stringify','title','data','length','Injectable','design:paramtypes','padStart','now','/task/suno/v1/submit/lyrics','SUCCESS','歌词生成中','get','map','音乐任务已完成','metadata','LYRICS','1655jdGCRn','audioUrl','，payload:\x20','video_url','当前生成进度\x20','updateChatLog','轮询结果:\x20','object','globalConfigService','error','log','suno','push','3189016VfztOr','GlobalConfigService','14cRuQMp','音乐生成中...','查询生成结果时发生错误','video/suno-music/','videoUrl','post','7303456kDQuyf','status','6678306LbSWSB','image_url'];_0x2de8=function(){return _0x4e8586;};return _0x2de8();}(function(_0x3f40a6,_0x21c6b8){const _0x4f6fb6=_0x4ab7,_0x319a4c=_0x3f40a6();while(!![]){try{const _0xf81f95=-parseInt(_0x4f6fb6(0x110))/0x1+-parseInt(_0x4f6fb6(0x112))/0x2+parseInt(_0x4f6fb6(0x118))/0x3+-parseInt(_0x4f6fb6(0xf8))/0x4+parseInt(_0x4f6fb6(0xeb))/0x5*(parseInt(_0x4f6fb6(0x122))/0x6)+parseInt(_0x4f6fb6(0xfa))/0x7*(parseInt(_0x4f6fb6(0x100))/0x8)+parseInt(_0x4f6fb6(0x102))/0x9*(-parseInt(_0x4f6fb6(0x126))/0xa);if(_0xf81f95===_0x21c6b8)break;else _0x319a4c['push'](_0x319a4c['shift']());}catch(_0x27bdfe){_0x319a4c['push'](_0x319a4c['shift']());}}}(_0x2de8,0xe3cfa));var __decorate=this&&this['__decorate']||function(_0x25388c,_0x527285,_0x1f7037,_0x27abdb){const _0x14757b=_0x4ab7;var _0x13b3b3=arguments[_0x14757b(0xde)],_0x4ebfce=_0x13b3b3<0x3?_0x527285:_0x27abdb===null?_0x27abdb=Object['getOwnPropertyDescriptor'](_0x527285,_0x1f7037):_0x27abdb,_0x1c70e7;if(typeof Reflect===_0x14757b(0xf2)&&typeof Reflect[_0x14757b(0x105)]===_0x14757b(0x10f))_0x4ebfce=Reflect[_0x14757b(0x105)](_0x25388c,_0x527285,_0x1f7037,_0x27abdb);else{for(var _0x4cce73=_0x25388c[_0x14757b(0xde)]-0x1;_0x4cce73>=0x0;_0x4cce73--)if(_0x1c70e7=_0x25388c[_0x4cce73])_0x4ebfce=(_0x13b3b3<0x3?_0x1c70e7(_0x4ebfce):_0x13b3b3>0x3?_0x1c70e7(_0x527285,_0x1f7037,_0x4ebfce):_0x1c70e7(_0x527285,_0x1f7037))||_0x4ebfce;}return _0x13b3b3>0x3&&_0x4ebfce&&Object[_0x14757b(0x125)](_0x527285,_0x1f7037,_0x4ebfce),_0x4ebfce;},__metadata=this&&this[_0x6d4514(0x12b)]||function(_0xf861cf,_0x4cdb70){const _0xc2fb6d=_0x6d4514;if(typeof Reflect===_0xc2fb6d(0xf2)&&typeof Reflect[_0xc2fb6d(0xe9)]==='function')return Reflect[_0xc2fb6d(0xe9)](_0xf861cf,_0x4cdb70);};Object[_0x6d4514(0x125)](exports,_0x6d4514(0x108),{'value':!![]}),exports[_0x6d4514(0x113)]=void 0x0;const common_1=require(_0x6d4514(0x128)),axios_1=require('axios'),chatLog_service_1=require('../chatLog/chatLog.service'),globalConfig_service_1=require('../globalConfig/globalConfig.service'),upload_service_1=require(_0x6d4514(0x12a));let SunoService=class SunoService{constructor(_0x3d9232,_0x2bb0e7,_0x364687){const _0xdb7774=_0x6d4514;this[_0xdb7774(0xd5)]=_0x3d9232,this[_0xdb7774(0x114)]=_0x2bb0e7,this[_0xdb7774(0xf3)]=_0x364687;}async[_0x6d4514(0xf6)](_0x2d48e7){const _0xa7ca5c=_0x6d4514;var _0x4cbefc,_0x3945fd,_0xa70352;const {apiKey:_0x597549,proxyUrl:_0x4e1d34,action:_0x524831,prompt:_0x595808,timeout:_0x15b08b,assistantLogId:_0x14dc5e,taskData:_0x3a70e6,extraParam:_0x3248f9}=_0x2d48e7;common_1[_0xa7ca5c(0x10d)]['debug'](_0xa7ca5c(0xcc)+JSON[_0xa7ca5c(0xdb)](_0x2d48e7),_0xa7ca5c(0x113));let _0x1aae4f={'text':'','fileInfo':'','taskId':'','taskData':'','status':0x2};common_1['Logger'][_0xa7ca5c(0xf5)]('开始生成音乐','SunoService');let _0x538c4e=null,_0x3d7a90='',_0x2a7ed9={};const _0x4902b4={'Authorization':_0xa7ca5c(0x104)+_0x597549};_0x524831==='LYRICS'&&(_0x3d7a90=_0x4e1d34+_0xa7ca5c(0xe3),_0x2a7ed9={'prompt':_0x595808});if(_0x524831===_0xa7ca5c(0x117)){_0x3d7a90=_0x4e1d34+_0xa7ca5c(0xd4);try{_0x2a7ed9=JSON[_0xa7ca5c(0xd7)](_0x3a70e6);}catch(_0x1f143c){common_1[_0xa7ca5c(0x10d)]['error'](_0xa7ca5c(0x123)+_0x1f143c[_0xa7ca5c(0xcf)],'SunoService');throw new Error('taskData格式错误');}}common_1[_0xa7ca5c(0x10d)][_0xa7ca5c(0xf5)]('正在准备发送请求到\x20'+_0x3d7a90+_0xa7ca5c(0xed)+JSON[_0xa7ca5c(0xdb)](_0x2a7ed9)+',\x20headers:\x20'+JSON['stringify'](_0x4902b4),'SunoService');try{_0x538c4e=await axios_1[_0xa7ca5c(0x11b)][_0xa7ca5c(0xff)](_0x3d7a90,_0x2a7ed9,{'headers':_0x4902b4}),common_1[_0xa7ca5c(0x10d)]['debug']('任务提交结果，状态码:\x20'+_0x538c4e[_0xa7ca5c(0x101)]+',\x20状态消息:\x20'+_0x538c4e[_0xa7ca5c(0x116)]+',\x20数据:\x20'+JSON[_0xa7ca5c(0xdb)](_0x538c4e['data']));}catch(_0x43cf53){common_1[_0xa7ca5c(0x10d)][_0xa7ca5c(0xf4)]('任务提交失败:\x20'+_0x43cf53['message'],_0xa7ca5c(0x113));throw new Error(_0xa7ca5c(0x121));}if((_0x4cbefc=_0x538c4e===null||_0x538c4e===void 0x0?void 0x0:_0x538c4e['data'])===null||_0x4cbefc===void 0x0?void 0x0:_0x4cbefc[_0xa7ca5c(0xdd)])_0x1aae4f[_0xa7ca5c(0x120)]=(_0x3945fd=_0x538c4e===null||_0x538c4e===void 0x0?void 0x0:_0x538c4e[_0xa7ca5c(0xdd)])===null||_0x3945fd===void 0x0?void 0x0:_0x3945fd[_0xa7ca5c(0xdd)],common_1[_0xa7ca5c(0x10d)][_0xa7ca5c(0xf5)](_0xa7ca5c(0xd6)+((_0xa70352=_0x538c4e===null||_0x538c4e===void 0x0?void 0x0:_0x538c4e[_0xa7ca5c(0xdd)])===null||_0xa70352===void 0x0?void 0x0:_0xa70352[_0xa7ca5c(0xdd)]),_0xa7ca5c(0x113));else throw new Error(_0xa7ca5c(0x11d));try{await this[_0xa7ca5c(0x109)]({'proxyUrl':_0x4e1d34,'apiKey':_0x597549,'taskId':_0x538c4e[_0xa7ca5c(0xdd)]['data'],'timeout':_0x15b08b,'prompt':_0x595808,'action':_0x524831,'onSuccess':async _0x5ef504=>{const _0x3abd77=_0xa7ca5c;try{await this[_0x3abd77(0xd5)][_0x3abd77(0xf0)](_0x14dc5e,{'videoUrl':_0x5ef504===null||_0x5ef504===void 0x0?void 0x0:_0x5ef504[_0x3abd77(0xfe)],'audioUrl':_0x5ef504===null||_0x5ef504===void 0x0?void 0x0:_0x5ef504[_0x3abd77(0xec)],'fileInfo':_0x5ef504===null||_0x5ef504===void 0x0?void 0x0:_0x5ef504[_0x3abd77(0xd1)],'answer':(_0x5ef504===null||_0x5ef504===void 0x0?void 0x0:_0x5ef504['answer'])||_0x595808,'progress':_0x3abd77(0x10c),'status':0x3,'taskId':_0x5ef504===null||_0x5ef504===void 0x0?void 0x0:_0x5ef504[_0x3abd77(0x120)],'taskData':_0x5ef504===null||_0x5ef504===void 0x0?void 0x0:_0x5ef504[_0x3abd77(0xce)]}),common_1[_0x3abd77(0x10d)]['log'](_0x3abd77(0xe8),_0x3abd77(0x113));}catch(_0x23df2e){common_1['Logger'][_0x3abd77(0xf4)](_0x3abd77(0x115)+_0x23df2e[_0x3abd77(0xcf)],_0x3abd77(0x113));}},'onAudioSuccess':async _0x2e0c38=>{const _0x18e01c=_0xa7ca5c;try{await this['chatLogService'][_0x18e01c(0xf0)](_0x14dc5e,{'videoUrl':_0x2e0c38===null||_0x2e0c38===void 0x0?void 0x0:_0x2e0c38['videoUrl'],'audioUrl':_0x2e0c38===null||_0x2e0c38===void 0x0?void 0x0:_0x2e0c38[_0x18e01c(0xec)],'fileInfo':_0x2e0c38===null||_0x2e0c38===void 0x0?void 0x0:_0x2e0c38['fileInfo'],'answer':(_0x2e0c38===null||_0x2e0c38===void 0x0?void 0x0:_0x2e0c38['answer'])||_0x595808,'progress':_0x2e0c38===null||_0x2e0c38===void 0x0?void 0x0:_0x2e0c38[_0x18e01c(0x10b)],'status':_0x2e0c38['status'],'taskId':_0x2e0c38===null||_0x2e0c38===void 0x0?void 0x0:_0x2e0c38[_0x18e01c(0x120)],'taskData':_0x2e0c38===null||_0x2e0c38===void 0x0?void 0x0:_0x2e0c38[_0x18e01c(0xce)]}),common_1[_0x18e01c(0x10d)][_0x18e01c(0xf5)](_0x18e01c(0x107),_0x18e01c(0x113));}catch(_0x471b83){common_1[_0x18e01c(0x10d)][_0x18e01c(0xf4)](_0x18e01c(0x115)+_0x471b83[_0x18e01c(0xcf)],'SunoService');}},'onGenerating':async _0x362acd=>{const _0x2ab267=_0xa7ca5c;try{await this[_0x2ab267(0xd5)][_0x2ab267(0xf0)](_0x14dc5e,{'videoUrl':_0x362acd===null||_0x362acd===void 0x0?void 0x0:_0x362acd[_0x2ab267(0xfe)],'audioUrl':_0x362acd===null||_0x362acd===void 0x0?void 0x0:_0x362acd[_0x2ab267(0xec)],'fileInfo':_0x362acd===null||_0x362acd===void 0x0?void 0x0:_0x362acd[_0x2ab267(0xd1)],'answer':(_0x362acd===null||_0x362acd===void 0x0?void 0x0:_0x362acd[_0x2ab267(0x129)])||'音乐生成中...','progress':_0x362acd===null||_0x362acd===void 0x0?void 0x0:_0x362acd[_0x2ab267(0x10b)],'status':_0x362acd['status']}),common_1[_0x2ab267(0x10d)][_0x2ab267(0xf5)](_0x2ab267(0xfb),_0x2ab267(0x113));}catch(_0x462ce8){common_1['Logger'][_0x2ab267(0xf4)]('更新日志失败:\x20'+_0x462ce8[_0x2ab267(0xcf)],_0x2ab267(0x113));}},'onFailure':async _0x39bb9f=>{const _0x58727b=_0xa7ca5c;try{await this[_0x58727b(0xd5)][_0x58727b(0xf0)](_0x14dc5e,{'answer':_0x58727b(0x124),'status':_0x39bb9f[_0x58727b(0x101)]}),common_1['Logger']['log'](_0x58727b(0x119),'SunoService');}catch(_0x4ccfd0){common_1[_0x58727b(0x10d)][_0x58727b(0xf4)](_0x58727b(0x115)+_0x4ccfd0[_0x58727b(0xcf)],_0x58727b(0x113));}}});}catch(_0x4c93d2){common_1['Logger']['error']('查询生成结果时发生错误:',_0x4c93d2[_0xa7ca5c(0xcf)],_0xa7ca5c(0x113));throw new Error(_0xa7ca5c(0xfc));}return _0x1aae4f;}async[_0x6d4514(0x109)](_0xef4d30){const _0x51a1d6=_0x6d4514,{proxyUrl:_0x3b9d69,apiKey:_0x1c7817,taskId:_0x1cefc5,timeout:_0x567290,onSuccess:_0x53703e,onAudioSuccess:_0x50f10b,onFailure:_0x35c860,onGenerating:_0x35941c,action:_0x52e0fa}=_0xef4d30;let _0x1b3231={'videoUrl':'','audioUrl':'','fileInfo':'','drawId':'','taskData':'','status':0x2,'progress':0x0,'answer':''};const _0x1aa0f2={'Authorization':_0x51a1d6(0x104)+_0x1c7817},_0x2e6660=_0x3b9d69+_0x51a1d6(0x11f)+_0x1cefc5,_0x26eef9=Date[_0x51a1d6(0xe2)](),_0x3460c0=0x1388;let _0x368bf4=0x0;try{while(Date[_0x51a1d6(0xe2)]()-_0x26eef9<_0x567290){await new Promise(_0x16b428=>setTimeout(_0x16b428,_0x3460c0));try{const _0x23f9c0=await axios_1[_0x51a1d6(0x11b)][_0x51a1d6(0xe6)](_0x2e6660,{'headers':_0x1aa0f2}),_0x1e226f=_0x23f9c0[_0x51a1d6(0xdd)][_0x51a1d6(0xdd)];common_1[_0x51a1d6(0x10d)][_0x51a1d6(0xd2)](_0x51a1d6(0xf1)+JSON['stringify'](_0x1e226f),_0x51a1d6(0x113));if(_0x52e0fa===_0x51a1d6(0xea)){if(_0x1e226f[_0x51a1d6(0x101)]===_0x51a1d6(0xe4)){_0x1b3231[_0x51a1d6(0x120)]=_0x1e226f[_0x51a1d6(0xdd)]['id'],_0x1b3231[_0x51a1d6(0xce)]=JSON[_0x51a1d6(0xdb)](_0x1e226f[_0x51a1d6(0xdd)]),_0x1b3231['answer']=_0x1e226f[_0x51a1d6(0xdd)][_0x51a1d6(0xd3)],_0x53703e(_0x1b3231);return;}_0x1b3231[_0x51a1d6(0x10b)]=_0x1e226f===null||_0x1e226f===void 0x0?void 0x0:_0x1e226f[_0x51a1d6(0x10b)],_0x1b3231['answer']=_0x51a1d6(0xe5),_0x1b3231['progress']&&_0x35941c(_0x1b3231);}if(_0x52e0fa===_0x51a1d6(0x117)){if(_0x1e226f['data']){const _0x5bff5b=_0x1e226f[_0x51a1d6(0xdd)];_0x1b3231['taskData']=JSON[_0x51a1d6(0xdb)](_0x5bff5b);if(Array['isArray'](_0x5bff5b)){const _0x402e57=_0x5bff5b[_0x51a1d6(0xe7)](_0x489bbe=>_0x489bbe['audio_url'])['filter'](_0x1a4605=>_0x1a4605),_0x45f1fa=_0x5bff5b[_0x51a1d6(0xe7)](_0xed7713=>_0xed7713[_0x51a1d6(0xee)])[_0x51a1d6(0x111)](_0x38f78a=>_0x38f78a),_0x2755a9=_0x5bff5b[_0x51a1d6(0xe7)](_0x7a2214=>_0x7a2214[_0x51a1d6(0x103)])[_0x51a1d6(0x111)](_0x135628=>_0x135628),_0x1c03f6=_0x5bff5b[_0x51a1d6(0xe7)](_0x4a6d14=>_0x4a6d14[_0x51a1d6(0xdc)]),_0x150c9d=_0x1c03f6['length']>0x0?_0x1c03f6[0x0]:_0x51a1d6(0xd9);if(_0x1e226f[_0x51a1d6(0x101)]===_0x51a1d6(0xe4)){let _0x139723=[],_0x4bddaf=[],_0x5af1c2=[];try{const _0x5f73ad=await this[_0x51a1d6(0xf3)]['getConfigs'](['localStorageStatus']);if(Number(_0x5f73ad)){const _0x363db6=new Date(),_0x5e56af=_0x363db6[_0x51a1d6(0x106)](),_0x319e33=String(_0x363db6[_0x51a1d6(0xda)]()+0x1)['padStart'](0x2,'0'),_0x31d3dd=String(_0x363db6['getDate']())[_0x51a1d6(0xe1)](0x2,'0'),_0x463343=''+_0x5e56af+_0x319e33+'/'+_0x31d3dd;for(const _0x205758 of _0x402e57){try{const _0x4c0e81=await this[_0x51a1d6(0x114)][_0x51a1d6(0xcd)]({'url':_0x205758,'dir':'audio/suno-music/'+_0x463343});_0x139723[_0x51a1d6(0xf7)](_0x4c0e81);}catch(_0x1efa54){common_1[_0x51a1d6(0x10d)][_0x51a1d6(0xf4)]('上传音频文件失败:\x20'+_0x1efa54[_0x51a1d6(0xcf)],_0x51a1d6(0x113)),_0x139723[_0x51a1d6(0xf7)](_0x205758);}}for(const _0x2a96bb of _0x45f1fa){try{const _0x4f3112=await this['uploadService'][_0x51a1d6(0xcd)]({'url':_0x2a96bb,'dir':_0x51a1d6(0xfd)+_0x463343});_0x4bddaf['push'](_0x4f3112);}catch(_0x256d8f){common_1[_0x51a1d6(0x10d)]['error'](_0x51a1d6(0xd0)+_0x256d8f[_0x51a1d6(0xcf)],_0x51a1d6(0x113)),_0x4bddaf['push'](_0x2a96bb);}}for(const _0x447f22 of _0x2755a9){try{const _0x1b0925=await this[_0x51a1d6(0x114)]['uploadFileFromUrl']({'url':_0x447f22,'dir':_0x51a1d6(0x11a)+_0x463343});_0x5af1c2[_0x51a1d6(0xf7)](_0x1b0925);}catch(_0x50b457){common_1[_0x51a1d6(0x10d)][_0x51a1d6(0xf4)]('上传图片文件失败:\x20'+_0x50b457[_0x51a1d6(0xcf)],'SunoService'),_0x5af1c2[_0x51a1d6(0xf7)](_0x447f22);}}}else _0x139723=_0x402e57,_0x4bddaf=_0x45f1fa,_0x5af1c2=_0x2755a9;}catch(_0xb9c7f3){common_1[_0x51a1d6(0x10d)]['error'](_0x51a1d6(0x10e)+_0xb9c7f3['message'],'LumaService'),_0x139723=_0x402e57,_0x4bddaf=_0x45f1fa,_0x5af1c2=_0x2755a9;}_0x1b3231[_0x51a1d6(0xec)]=_0x139723[_0x51a1d6(0xd8)](','),_0x1b3231[_0x51a1d6(0xfe)]=_0x4bddaf['join'](','),_0x1b3231[_0x51a1d6(0xd1)]=_0x5af1c2[_0x51a1d6(0xd8)](',');_0x402e57[_0x51a1d6(0xde)]===0x2?(_0x1b3231[_0x51a1d6(0x101)]=0x3,_0x1b3231[_0x51a1d6(0x129)]=_0x150c9d):(_0x1b3231[_0x51a1d6(0x101)]=0x2,_0x1b3231[_0x51a1d6(0x10b)]=_0x1e226f===null||_0x1e226f===void 0x0?void 0x0:_0x1e226f[_0x51a1d6(0x10b)],_0x1b3231[_0x51a1d6(0x129)]=_0x51a1d6(0xef)+(_0x1e226f===null||_0x1e226f===void 0x0?void 0x0:_0x1e226f[_0x51a1d6(0x10b)]));common_1['Logger']['debug'](_0x51a1d6(0x127)+JSON[_0x51a1d6(0xdb)](_0x5bff5b),_0x51a1d6(0x113)),_0x53703e(_0x1b3231);return;}else _0x1b3231[_0x51a1d6(0xec)]=_0x402e57[_0x51a1d6(0xd8)](','),_0x1b3231[_0x51a1d6(0xfe)]=_0x45f1fa[_0x51a1d6(0xd8)](','),_0x1b3231[_0x51a1d6(0xd1)]=_0x2755a9['join'](','),_0x1b3231[_0x51a1d6(0x101)]=0x2,_0x1b3231[_0x51a1d6(0x10b)]=_0x1e226f===null||_0x1e226f===void 0x0?void 0x0:_0x1e226f[_0x51a1d6(0x10b)],_0x1b3231[_0x51a1d6(0x129)]=_0x150c9d,_0x50f10b(_0x1b3231);}}!_0x1b3231[_0x51a1d6(0xec)]&&_0x1b3231[_0x51a1d6(0x10b)]&&_0x1b3231[_0x51a1d6(0x101)]===0x2&&_0x35941c(_0x1b3231);}}catch(_0x16e302){_0x368bf4++,common_1['Logger'][_0x51a1d6(0xf4)](_0x51a1d6(0x10a)+_0x368bf4,_0x51a1d6(0x113));}}common_1[_0x51a1d6(0x10d)][_0x51a1d6(0xf4)](_0x51a1d6(0x11e),'SunoService'),_0x1b3231[_0x51a1d6(0x101)]=0x4,_0x35c860(_0x1b3231);throw new Error(_0x51a1d6(0x11c));}catch(_0x27527d){common_1['Logger'][_0x51a1d6(0xf4)]('轮询过程中发生错误:\x20'+_0x27527d,_0x51a1d6(0x113)),_0x1b3231[_0x51a1d6(0x101)]=0x5,_0x35c860(_0x1b3231);}}};function _0x4ab7(_0x54090c,_0x4e6104){const _0x2de835=_0x2de8();return _0x4ab7=function(_0x4ab706,_0x2cf8ff){_0x4ab706=_0x4ab706-0xcc;let _0x202586=_0x2de835[_0x4ab706];return _0x202586;},_0x4ab7(_0x54090c,_0x4e6104);}SunoService=__decorate([(0x0,common_1[_0x6d4514(0xdf)])(),__metadata(_0x6d4514(0xe0),[chatLog_service_1['ChatLogService'],upload_service_1[_0x6d4514(0x12c)],globalConfig_service_1[_0x6d4514(0xf9)]])],SunoService),exports[_0x6d4514(0x113)]=SunoService;