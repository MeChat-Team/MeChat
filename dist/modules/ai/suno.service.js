'use strict';const _0x58c798=_0x4245;(function(_0x4ba064,_0x5cd8cb){const _0x326fb2=_0x4245,_0x5da0af=_0x4ba064();while(!![]){try{const _0x3ade0e=-parseInt(_0x326fb2(0x181))/0x1+parseInt(_0x326fb2(0x165))/0x2*(parseInt(_0x326fb2(0x1a4))/0x3)+-parseInt(_0x326fb2(0x1a2))/0x4*(parseInt(_0x326fb2(0x1b5))/0x5)+parseInt(_0x326fb2(0x1b2))/0x6+-parseInt(_0x326fb2(0x174))/0x7+parseInt(_0x326fb2(0x17c))/0x8*(-parseInt(_0x326fb2(0x194))/0x9)+parseInt(_0x326fb2(0x160))/0xa;if(_0x3ade0e===_0x5cd8cb)break;else _0x5da0af['push'](_0x5da0af['shift']());}catch(_0x2fc0d1){_0x5da0af['push'](_0x5da0af['shift']());}}}(_0x2050,0x5f77a));function _0x2050(){const _0x448b40=['text','/task/suno/v1/fetch/','轮询失败，重试次数:\x20','decorate','data','chatLogService','object','音频生成成功，等待视频生成...','344ifVAby','ChatLogService','3tjhSlc','video/suno-music/','更新日志失败:\x20','/task/suno/v1/submit/music','../upload/upload.service','taskData','获取配置失败:\x20','查询生成结果时发生错误','UploadService','查询生成结果时发生错误:','metadata','images/suno-music/','Logger','音乐生成中...','128118SIwjyU','filter','getOwnPropertyDescriptor','5755CvUHlA','当前生成进度\x20',',\x20状态消息:\x20','message','function','image_url','生成失败','上传音频文件失败:\x20','log','getConfigs','padStart','LYRICS','status','updateChatLog','debug','push','上传图片文件失败:\x20','12715640sFZgWn','localStorageStatus','__metadata','歌词生成中','join','1341002raZnvL','suno','video_url','正在准备发送请求到\x20','audio/suno-music/','statusText','任务提交失败','length','轮询过程中发生错误:\x20','查询超时，请稍后再试！','../globalConfig/globalConfig.service','@nestjs/common','design:paramtypes','MUSIC','音乐任务已完成','2384298KLWYco','fileInfo','上传视频文件失败:\x20','taskId','SunoService:\x20','getFullYear','isArray','audioUrl','488RrICUJ','uploadFileFromUrl','answer','globalConfigService','default','399625jxxCZf','任务提交成功,\x20任务ID:\x20','/task/suno/v1/submit/lyrics','get','pollSunoMusicResult','SunoService','轮询超时，请稍后再试！','error','videoUrl','map','uploadService','defineProperty','任务提交失败:\x20','SUCCESS',',\x20headers:\x20','未能获取结果数据,\x20即将重试','Injectable','__decorate','stringify','108171pgNbDE','__esModule',',\x20数据:\x20','now','progress','parse'];_0x2050=function(){return _0x448b40;};return _0x2050();}var __decorate=this&&this[_0x58c798(0x192)]||function(_0x4ffa3c,_0x5ecf79,_0xa4d91a,_0x3423b6){const _0x568020=_0x58c798;var _0x1f2e40=arguments['length'],_0x2870e1=_0x1f2e40<0x3?_0x5ecf79:_0x3423b6===null?_0x3423b6=Object[_0x568020(0x1b4)](_0x5ecf79,_0xa4d91a):_0x3423b6,_0x130785;if(typeof Reflect===_0x568020(0x1a0)&&typeof Reflect[_0x568020(0x19d)]===_0x568020(0x1b9))_0x2870e1=Reflect['decorate'](_0x4ffa3c,_0x5ecf79,_0xa4d91a,_0x3423b6);else{for(var _0x29bab1=_0x4ffa3c[_0x568020(0x16c)]-0x1;_0x29bab1>=0x0;_0x29bab1--)if(_0x130785=_0x4ffa3c[_0x29bab1])_0x2870e1=(_0x1f2e40<0x3?_0x130785(_0x2870e1):_0x1f2e40>0x3?_0x130785(_0x5ecf79,_0xa4d91a,_0x2870e1):_0x130785(_0x5ecf79,_0xa4d91a))||_0x2870e1;}return _0x1f2e40>0x3&&_0x2870e1&&Object[_0x568020(0x18c)](_0x5ecf79,_0xa4d91a,_0x2870e1),_0x2870e1;},__metadata=this&&this[_0x58c798(0x162)]||function(_0x13eb1e,_0x5ea0ca){const _0xb8365c=_0x58c798;if(typeof Reflect===_0xb8365c(0x1a0)&&typeof Reflect[_0xb8365c(0x1ae)]===_0xb8365c(0x1b9))return Reflect['metadata'](_0x13eb1e,_0x5ea0ca);};Object['defineProperty'](exports,_0x58c798(0x195),{'value':!![]}),exports[_0x58c798(0x186)]=void 0x0;const common_1=require(_0x58c798(0x170)),axios_1=require('axios'),chatLog_service_1=require('../chatLog/chatLog.service'),globalConfig_service_1=require(_0x58c798(0x16f)),upload_service_1=require(_0x58c798(0x1a8));let SunoService=class SunoService{constructor(_0x2de625,_0x769139,_0xcdae59){const _0x38d906=_0x58c798;this[_0x38d906(0x19f)]=_0x2de625,this[_0x38d906(0x18b)]=_0x769139,this['globalConfigService']=_0xcdae59;}async[_0x58c798(0x166)](_0x36ff45){const _0x56e527=_0x58c798;var _0x42c95a,_0x185217,_0x1fc94f;const {apiKey:_0x35da42,proxyUrl:_0x5b7b74,action:_0x25a4a6,prompt:_0x6a0e56,timeout:_0x12bcf0,assistantLogId:_0x42ff05,taskData:_0x32e622,extraParam:_0x585e11}=_0x36ff45;common_1[_0x56e527(0x1b0)][_0x56e527(0x15d)](_0x56e527(0x178)+JSON[_0x56e527(0x193)](_0x36ff45),_0x56e527(0x186));let _0x2aaec3={'text':'','fileInfo':'','taskId':'','taskData':'','status':0x2};common_1[_0x56e527(0x1b0)][_0x56e527(0x1bd)]('开始生成音乐','SunoService');let _0x18a47f=null,_0x167346='',_0x1207d9={};const _0xe8245a={'Authorization':'Bearer\x20'+_0x35da42};_0x25a4a6===_0x56e527(0x15a)&&(_0x167346=_0x5b7b74+_0x56e527(0x183),_0x1207d9={'prompt':_0x6a0e56});if(_0x25a4a6==='MUSIC'){_0x167346=_0x5b7b74+_0x56e527(0x1a7);try{_0x1207d9=JSON[_0x56e527(0x199)](_0x32e622);}catch(_0x49b418){common_1[_0x56e527(0x1b0)][_0x56e527(0x188)]('解析taskData失败:\x20'+_0x49b418[_0x56e527(0x1b8)],_0x56e527(0x186));throw new Error('taskData格式错误');}}common_1[_0x56e527(0x1b0)][_0x56e527(0x1bd)](_0x56e527(0x168)+_0x167346+'，payload:\x20'+JSON['stringify'](_0x1207d9)+_0x56e527(0x18f)+JSON[_0x56e527(0x193)](_0xe8245a),'SunoService');try{_0x18a47f=await axios_1['default']['post'](_0x167346,_0x1207d9,{'headers':_0xe8245a}),common_1[_0x56e527(0x1b0)][_0x56e527(0x15d)]('任务提交结果，状态码:\x20'+_0x18a47f[_0x56e527(0x15b)]+_0x56e527(0x1b7)+_0x18a47f[_0x56e527(0x16a)]+_0x56e527(0x196)+JSON[_0x56e527(0x193)](_0x18a47f[_0x56e527(0x19e)]));}catch(_0x5163d8){common_1[_0x56e527(0x1b0)][_0x56e527(0x188)](_0x56e527(0x18d)+_0x5163d8['message'],_0x56e527(0x186));throw new Error(_0x56e527(0x16b));}if((_0x42c95a=_0x18a47f===null||_0x18a47f===void 0x0?void 0x0:_0x18a47f['data'])===null||_0x42c95a===void 0x0?void 0x0:_0x42c95a[_0x56e527(0x19e)])_0x2aaec3[_0x56e527(0x177)]=(_0x185217=_0x18a47f===null||_0x18a47f===void 0x0?void 0x0:_0x18a47f['data'])===null||_0x185217===void 0x0?void 0x0:_0x185217[_0x56e527(0x19e)],common_1['Logger'][_0x56e527(0x1bd)](_0x56e527(0x182)+((_0x1fc94f=_0x18a47f===null||_0x18a47f===void 0x0?void 0x0:_0x18a47f[_0x56e527(0x19e)])===null||_0x1fc94f===void 0x0?void 0x0:_0x1fc94f[_0x56e527(0x19e)]),'SunoService');else throw new Error(_0x56e527(0x190));try{await this[_0x56e527(0x185)]({'proxyUrl':_0x5b7b74,'apiKey':_0x35da42,'taskId':_0x18a47f['data'][_0x56e527(0x19e)],'timeout':_0x12bcf0,'prompt':_0x6a0e56,'action':_0x25a4a6,'onSuccess':async _0x52dbdf=>{const _0x2df23b=_0x56e527;try{await this[_0x2df23b(0x19f)][_0x2df23b(0x15c)](_0x42ff05,{'videoUrl':_0x52dbdf===null||_0x52dbdf===void 0x0?void 0x0:_0x52dbdf[_0x2df23b(0x189)],'audioUrl':_0x52dbdf===null||_0x52dbdf===void 0x0?void 0x0:_0x52dbdf['audioUrl'],'fileInfo':_0x52dbdf===null||_0x52dbdf===void 0x0?void 0x0:_0x52dbdf[_0x2df23b(0x175)],'answer':(_0x52dbdf===null||_0x52dbdf===void 0x0?void 0x0:_0x52dbdf[_0x2df23b(0x17e)])||_0x6a0e56,'progress':'100%','status':0x3,'taskId':_0x52dbdf===null||_0x52dbdf===void 0x0?void 0x0:_0x52dbdf[_0x2df23b(0x177)],'taskData':_0x52dbdf===null||_0x52dbdf===void 0x0?void 0x0:_0x52dbdf[_0x2df23b(0x1a9)]}),common_1['Logger'][_0x2df23b(0x1bd)](_0x2df23b(0x173),'SunoService');}catch(_0x21c7d2){common_1[_0x2df23b(0x1b0)][_0x2df23b(0x188)](_0x2df23b(0x1a6)+_0x21c7d2[_0x2df23b(0x1b8)],_0x2df23b(0x186));}},'onAudioSuccess':async _0x101fea=>{const _0x519c1a=_0x56e527;try{await this[_0x519c1a(0x19f)][_0x519c1a(0x15c)](_0x42ff05,{'videoUrl':_0x101fea===null||_0x101fea===void 0x0?void 0x0:_0x101fea[_0x519c1a(0x189)],'audioUrl':_0x101fea===null||_0x101fea===void 0x0?void 0x0:_0x101fea[_0x519c1a(0x17b)],'fileInfo':_0x101fea===null||_0x101fea===void 0x0?void 0x0:_0x101fea['fileInfo'],'answer':(_0x101fea===null||_0x101fea===void 0x0?void 0x0:_0x101fea[_0x519c1a(0x17e)])||_0x6a0e56,'progress':_0x101fea===null||_0x101fea===void 0x0?void 0x0:_0x101fea[_0x519c1a(0x198)],'status':_0x101fea['status'],'taskId':_0x101fea===null||_0x101fea===void 0x0?void 0x0:_0x101fea[_0x519c1a(0x177)],'taskData':_0x101fea===null||_0x101fea===void 0x0?void 0x0:_0x101fea['taskData']}),common_1['Logger']['log'](_0x519c1a(0x1a1),'SunoService');}catch(_0x549976){common_1[_0x519c1a(0x1b0)][_0x519c1a(0x188)](_0x519c1a(0x1a6)+_0x549976[_0x519c1a(0x1b8)],'SunoService');}},'onGenerating':async _0x628c1a=>{const _0x4b1c11=_0x56e527;try{await this[_0x4b1c11(0x19f)][_0x4b1c11(0x15c)](_0x42ff05,{'videoUrl':_0x628c1a===null||_0x628c1a===void 0x0?void 0x0:_0x628c1a[_0x4b1c11(0x189)],'audioUrl':_0x628c1a===null||_0x628c1a===void 0x0?void 0x0:_0x628c1a[_0x4b1c11(0x17b)],'fileInfo':_0x628c1a===null||_0x628c1a===void 0x0?void 0x0:_0x628c1a[_0x4b1c11(0x175)],'answer':(_0x628c1a===null||_0x628c1a===void 0x0?void 0x0:_0x628c1a['answer'])||_0x4b1c11(0x1b1),'progress':_0x628c1a===null||_0x628c1a===void 0x0?void 0x0:_0x628c1a['progress'],'status':_0x628c1a['status']}),common_1[_0x4b1c11(0x1b0)][_0x4b1c11(0x1bd)](_0x4b1c11(0x1b1),'SunoService');}catch(_0x2c79d6){common_1[_0x4b1c11(0x1b0)][_0x4b1c11(0x188)](_0x4b1c11(0x1a6)+_0x2c79d6[_0x4b1c11(0x1b8)],_0x4b1c11(0x186));}},'onFailure':async _0x328351=>{const _0x37ded4=_0x56e527;try{await this[_0x37ded4(0x19f)][_0x37ded4(0x15c)](_0x42ff05,{'answer':'音乐生成失败','status':_0x328351['status']}),common_1[_0x37ded4(0x1b0)][_0x37ded4(0x1bd)](_0x37ded4(0x1bb),_0x37ded4(0x186));}catch(_0x1b5e56){common_1[_0x37ded4(0x1b0)][_0x37ded4(0x188)](_0x37ded4(0x1a6)+_0x1b5e56[_0x37ded4(0x1b8)],_0x37ded4(0x186));}}});}catch(_0x4f1994){common_1['Logger']['error'](_0x56e527(0x1ad),_0x4f1994[_0x56e527(0x1b8)],_0x56e527(0x186));throw new Error(_0x56e527(0x1ab));}return _0x2aaec3;}async[_0x58c798(0x185)](_0x23de57){const _0x311a15=_0x58c798,{proxyUrl:_0x1578af,apiKey:_0x4a2a0a,taskId:_0x4cdbc3,timeout:_0x2d6666,onSuccess:_0x4eccb9,onAudioSuccess:_0x44cd68,onFailure:_0x38ea02,onGenerating:_0x169d58,action:_0x6a2a95}=_0x23de57;let _0x5407e6={'videoUrl':'','audioUrl':'','fileInfo':'','drawId':'','taskData':'','status':0x2,'progress':0x0,'answer':''};const _0x4aa82f={'Authorization':'Bearer\x20'+_0x4a2a0a},_0x310f91=_0x1578af+_0x311a15(0x19b)+_0x4cdbc3,_0x332a00=Date[_0x311a15(0x197)](),_0x1d81f8=0x1388;let _0x1e607b=0x0;try{while(Date[_0x311a15(0x197)]()-_0x332a00<_0x2d6666){await new Promise(_0x56a4a3=>setTimeout(_0x56a4a3,_0x1d81f8));try{const _0xa766cf=await axios_1[_0x311a15(0x180)][_0x311a15(0x184)](_0x310f91,{'headers':_0x4aa82f}),_0x4369eb=_0xa766cf[_0x311a15(0x19e)][_0x311a15(0x19e)];common_1[_0x311a15(0x1b0)][_0x311a15(0x15d)]('轮询结果:\x20'+JSON[_0x311a15(0x193)](_0x4369eb),'SunoService');if(_0x6a2a95===_0x311a15(0x15a)){if(_0x4369eb[_0x311a15(0x15b)]===_0x311a15(0x18e)){_0x5407e6['taskId']=_0x4369eb[_0x311a15(0x19e)]['id'],_0x5407e6[_0x311a15(0x1a9)]=JSON['stringify'](_0x4369eb[_0x311a15(0x19e)]),_0x5407e6['answer']=_0x4369eb[_0x311a15(0x19e)][_0x311a15(0x19a)],_0x4eccb9(_0x5407e6);return;}_0x5407e6[_0x311a15(0x198)]=_0x4369eb===null||_0x4369eb===void 0x0?void 0x0:_0x4369eb[_0x311a15(0x198)],_0x5407e6[_0x311a15(0x17e)]=_0x311a15(0x163),_0x5407e6[_0x311a15(0x198)]&&_0x169d58(_0x5407e6);}if(_0x6a2a95===_0x311a15(0x172)){if(_0x4369eb[_0x311a15(0x19e)]){const _0x51d43e=_0x4369eb['data'];_0x5407e6['taskData']=JSON[_0x311a15(0x193)](_0x51d43e);if(Array[_0x311a15(0x17a)](_0x51d43e)){const _0x357783=_0x51d43e[_0x311a15(0x18a)](_0x46edd2=>_0x46edd2['audio_url'])[_0x311a15(0x1b3)](_0x2cc63c=>_0x2cc63c),_0x1f441f=_0x51d43e[_0x311a15(0x18a)](_0x253a84=>_0x253a84[_0x311a15(0x167)])[_0x311a15(0x1b3)](_0x5b6430=>_0x5b6430),_0x20098d=_0x51d43e[_0x311a15(0x18a)](_0x182727=>_0x182727[_0x311a15(0x1ba)])['filter'](_0x11480e=>_0x11480e),_0x34ee60=_0x51d43e['map'](_0x3132aa=>_0x3132aa['title']),_0x47ae89=_0x34ee60[_0x311a15(0x16c)]>0x0?_0x34ee60[0x0]:'音乐已生成';if(_0x4369eb['status']==='SUCCESS'){let _0x5b6c01=[],_0x2553af=[],_0x37e78f=[];try{const _0x321612=await this[_0x311a15(0x17f)][_0x311a15(0x1be)]([_0x311a15(0x161)]);if(Number(_0x321612)){const _0x5f2dbc=new Date(),_0x1628ef=_0x5f2dbc[_0x311a15(0x179)](),_0x36a634=String(_0x5f2dbc['getMonth']()+0x1)[_0x311a15(0x159)](0x2,'0'),_0x59917b=String(_0x5f2dbc['getDate']())[_0x311a15(0x159)](0x2,'0'),_0x1efb33=''+_0x1628ef+_0x36a634+'/'+_0x59917b;for(const _0x17f689 of _0x357783){try{const _0x2a917c=await this['uploadService']['uploadFileFromUrl']({'url':_0x17f689,'dir':_0x311a15(0x169)+_0x1efb33});_0x5b6c01[_0x311a15(0x15e)](_0x2a917c);}catch(_0x413424){common_1[_0x311a15(0x1b0)][_0x311a15(0x188)](_0x311a15(0x1bc)+_0x413424[_0x311a15(0x1b8)],_0x311a15(0x186)),_0x5b6c01['push'](_0x17f689);}}for(const _0x505d9 of _0x1f441f){try{const _0x28ef3f=await this[_0x311a15(0x18b)][_0x311a15(0x17d)]({'url':_0x505d9,'dir':_0x311a15(0x1a5)+_0x1efb33});_0x2553af[_0x311a15(0x15e)](_0x28ef3f);}catch(_0x24086b){common_1[_0x311a15(0x1b0)][_0x311a15(0x188)](_0x311a15(0x176)+_0x24086b[_0x311a15(0x1b8)],'SunoService'),_0x2553af[_0x311a15(0x15e)](_0x505d9);}}for(const _0x4e2471 of _0x20098d){try{const _0x25198d=await this[_0x311a15(0x18b)][_0x311a15(0x17d)]({'url':_0x4e2471,'dir':_0x311a15(0x1af)+_0x1efb33});_0x37e78f[_0x311a15(0x15e)](_0x25198d);}catch(_0x42df47){common_1[_0x311a15(0x1b0)]['error'](_0x311a15(0x15f)+_0x42df47[_0x311a15(0x1b8)],_0x311a15(0x186)),_0x37e78f[_0x311a15(0x15e)](_0x4e2471);}}}else _0x5b6c01=_0x357783,_0x2553af=_0x1f441f,_0x37e78f=_0x20098d;}catch(_0x383454){common_1['Logger'][_0x311a15(0x188)](_0x311a15(0x1aa)+_0x383454[_0x311a15(0x1b8)],'LumaService'),_0x5b6c01=_0x357783,_0x2553af=_0x1f441f,_0x37e78f=_0x20098d;}_0x5407e6[_0x311a15(0x17b)]=_0x5b6c01[_0x311a15(0x164)](','),_0x5407e6[_0x311a15(0x189)]=_0x2553af[_0x311a15(0x164)](','),_0x5407e6[_0x311a15(0x175)]=_0x37e78f[_0x311a15(0x164)](',');_0x357783[_0x311a15(0x16c)]===0x2?(_0x5407e6[_0x311a15(0x15b)]=0x3,_0x5407e6[_0x311a15(0x17e)]=_0x47ae89):(_0x5407e6['status']=0x2,_0x5407e6['progress']=_0x4369eb===null||_0x4369eb===void 0x0?void 0x0:_0x4369eb['progress'],_0x5407e6[_0x311a15(0x17e)]=_0x311a15(0x1b6)+(_0x4369eb===null||_0x4369eb===void 0x0?void 0x0:_0x4369eb['progress']));common_1[_0x311a15(0x1b0)][_0x311a15(0x15d)]('音乐生成成功:\x20'+JSON[_0x311a15(0x193)](_0x51d43e),'SunoService'),_0x4eccb9(_0x5407e6);return;}else _0x5407e6[_0x311a15(0x17b)]=_0x357783[_0x311a15(0x164)](','),_0x5407e6[_0x311a15(0x189)]=_0x1f441f[_0x311a15(0x164)](','),_0x5407e6[_0x311a15(0x175)]=_0x20098d['join'](','),_0x5407e6[_0x311a15(0x15b)]=0x2,_0x5407e6['progress']=_0x4369eb===null||_0x4369eb===void 0x0?void 0x0:_0x4369eb[_0x311a15(0x198)],_0x5407e6['answer']=_0x47ae89,_0x44cd68(_0x5407e6);}}!_0x5407e6[_0x311a15(0x17b)]&&_0x5407e6['progress']&&_0x5407e6[_0x311a15(0x15b)]===0x2&&_0x169d58(_0x5407e6);}}catch(_0x4d4de0){_0x1e607b++,common_1[_0x311a15(0x1b0)][_0x311a15(0x188)](_0x311a15(0x19c)+_0x1e607b,'SunoService');}}common_1[_0x311a15(0x1b0)][_0x311a15(0x188)](_0x311a15(0x187),_0x311a15(0x186)),_0x5407e6[_0x311a15(0x15b)]=0x4,_0x38ea02(_0x5407e6);throw new Error(_0x311a15(0x16e));}catch(_0x37e1a7){common_1['Logger'][_0x311a15(0x188)](_0x311a15(0x16d)+_0x37e1a7,_0x311a15(0x186)),_0x5407e6[_0x311a15(0x15b)]=0x5,_0x38ea02(_0x5407e6);}}};function _0x4245(_0x36f84c,_0xf61fe7){const _0x205097=_0x2050();return _0x4245=function(_0x4245cb,_0x1846e3){_0x4245cb=_0x4245cb-0x159;let _0x25a003=_0x205097[_0x4245cb];return _0x25a003;},_0x4245(_0x36f84c,_0xf61fe7);}SunoService=__decorate([(0x0,common_1[_0x58c798(0x191)])(),__metadata(_0x58c798(0x171),[chatLog_service_1[_0x58c798(0x1a3)],upload_service_1[_0x58c798(0x1ac)],globalConfig_service_1['GlobalConfigService']])],SunoService),exports[_0x58c798(0x186)]=SunoService;