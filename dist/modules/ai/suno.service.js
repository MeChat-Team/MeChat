'use strict';const _0x87fc8c=_0x5a1c;(function(_0x1a50cf,_0x5059af){const _0x126d40=_0x5a1c,_0x402c00=_0x1a50cf();while(!![]){try{const _0x4057fd=-parseInt(_0x126d40(0xea))/0x1+parseInt(_0x126d40(0xc7))/0x2*(-parseInt(_0x126d40(0xfd))/0x3)+parseInt(_0x126d40(0xb8))/0x4+parseInt(_0x126d40(0xf5))/0x5*(parseInt(_0x126d40(0xda))/0x6)+-parseInt(_0x126d40(0xfc))/0x7*(parseInt(_0x126d40(0xd2))/0x8)+parseInt(_0x126d40(0xc5))/0x9+parseInt(_0x126d40(0xfa))/0xa;if(_0x4057fd===_0x5059af)break;else _0x402c00['push'](_0x402c00['shift']());}catch(_0x1e042b){_0x402c00['push'](_0x402c00['shift']());}}}(_0x1b7b,0x84345));function _0x1b7b(){const _0x4c759d=['5zoYqZa','length','message','uploadService','debug','17753030euvizn','default','2679845MDtxal','15LwkIun','get','任务提交成功,\x20任务ID:\x20','suno','error','getDate','updateChatLog','push','音乐生成失败','status','查询生成结果时发生错误:','videoUrl','now','@nestjs/common','answer','design:paramtypes','padStart','taskId','查询超时，请稍后再试！','GlobalConfigService','UploadService','音频生成成功，等待视频生成...','globalConfigService','filter','log','音乐已生成','../chatLog/chatLog.service','轮询过程中发生错误:\x20','decorate','__esModule','object','1006696Kygmre','SUCCESS','音乐生成中...','audio_url','__decorate','当前生成进度\x20','任务提交失败','Logger','stringify','taskData格式错误',',\x20headers:\x20','../globalConfig/globalConfig.service','uploadFileFromUrl','7284384kiQGta','title','346854RrFqBw','SunoService','progress','defineProperty','开始生成音乐','上传音频文件失败:\x20','ChatLogService','SunoService:\x20','audio/suno-music/','歌词生成中','Injectable','16xouSVJ','data','chatLogService','LumaService','生成失败','任务提交结果，状态码:\x20','axios','100%','776814AsUuGy','轮询超时，请稍后再试！',',\x20数据:\x20','join','MUSIC','map','正在准备发送请求到\x20','taskData','fileInfo','轮询结果:\x20','video_url','function','../upload/upload.service','pollSunoMusicResult','audioUrl','getOwnPropertyDescriptor','791508DvIFEo','音乐任务已完成','localStorageStatus','音乐生成成功:\x20','video/suno-music/','getFullYear','Bearer\x20','更新日志失败:\x20','查询生成结果时发生错误','parse','/task/suno/v1/submit/lyrics'];_0x1b7b=function(){return _0x4c759d;};return _0x1b7b();}var __decorate=this&&this[_0x87fc8c(0xbc)]||function(_0x585b5d,_0x7f1a0e,_0x22f5a0,_0x18bb91){const _0x7d8e95=_0x87fc8c;var _0xaa976f=arguments[_0x7d8e95(0xf6)],_0x960423=_0xaa976f<0x3?_0x7f1a0e:_0x18bb91===null?_0x18bb91=Object[_0x7d8e95(0xe9)](_0x7f1a0e,_0x22f5a0):_0x18bb91,_0x434744;if(typeof Reflect===_0x7d8e95(0xb7)&&typeof Reflect[_0x7d8e95(0xb5)]===_0x7d8e95(0xe5))_0x960423=Reflect['decorate'](_0x585b5d,_0x7f1a0e,_0x22f5a0,_0x18bb91);else{for(var _0x4355d3=_0x585b5d['length']-0x1;_0x4355d3>=0x0;_0x4355d3--)if(_0x434744=_0x585b5d[_0x4355d3])_0x960423=(_0xaa976f<0x3?_0x434744(_0x960423):_0xaa976f>0x3?_0x434744(_0x7f1a0e,_0x22f5a0,_0x960423):_0x434744(_0x7f1a0e,_0x22f5a0))||_0x960423;}return _0xaa976f>0x3&&_0x960423&&Object[_0x7d8e95(0xca)](_0x7f1a0e,_0x22f5a0,_0x960423),_0x960423;},__metadata=this&&this['__metadata']||function(_0x2079a1,_0x3a3448){const _0xeb35f4=_0x87fc8c;if(typeof Reflect==='object'&&typeof Reflect['metadata']===_0xeb35f4(0xe5))return Reflect['metadata'](_0x2079a1,_0x3a3448);};function _0x5a1c(_0x183570,_0x28a02d){const _0x1b7b92=_0x1b7b();return _0x5a1c=function(_0x5a1c10,_0x28083f){_0x5a1c10=_0x5a1c10-0xb3;let _0x107abd=_0x1b7b92[_0x5a1c10];return _0x107abd;},_0x5a1c(_0x183570,_0x28a02d);}Object[_0x87fc8c(0xca)](exports,_0x87fc8c(0xb6),{'value':!![]}),exports[_0x87fc8c(0xc8)]=void 0x0;const common_1=require(_0x87fc8c(0x10a)),axios_1=require(_0x87fc8c(0xd8)),chatLog_service_1=require(_0x87fc8c(0xb3)),globalConfig_service_1=require(_0x87fc8c(0xc3)),upload_service_1=require(_0x87fc8c(0xe6));let SunoService=class SunoService{constructor(_0x2fcf88,_0x2d6023,_0x5e44ac){const _0x57b0c0=_0x87fc8c;this[_0x57b0c0(0xd4)]=_0x2fcf88,this['uploadService']=_0x2d6023,this[_0x57b0c0(0x113)]=_0x5e44ac;}async[_0x87fc8c(0x100)](_0x4dbf98){const _0x15b391=_0x87fc8c;var _0x35318a,_0x12ac76,_0x54f308;const {apiKey:_0x3fa437,proxyUrl:_0x3e290d,action:_0x3b4a11,prompt:_0x3a7d99,timeout:_0x1ab90f,assistantLogId:_0x1d6000,taskData:_0x22b3a2,extraParam:_0x21ae69}=_0x4dbf98;common_1[_0x15b391(0xbf)][_0x15b391(0xf9)](_0x15b391(0xce)+JSON[_0x15b391(0xc0)](_0x4dbf98),_0x15b391(0xc8));let _0x21d7ee={'text':'','fileInfo':'','taskId':'','taskData':'','status':0x2};common_1[_0x15b391(0xbf)][_0x15b391(0x115)](_0x15b391(0xcb),'SunoService');let _0x3da09e=null,_0x4dcd71='',_0x19b18e={};const _0x2d7d6e={'Authorization':_0x15b391(0xf0)+_0x3fa437};_0x3b4a11==='LYRICS'&&(_0x4dcd71=_0x3e290d+_0x15b391(0xf4),_0x19b18e={'prompt':_0x3a7d99});if(_0x3b4a11===_0x15b391(0xde)){_0x4dcd71=_0x3e290d+'/task/suno/v1/submit/music';try{_0x19b18e=JSON[_0x15b391(0xf3)](_0x22b3a2);}catch(_0x3d159a){common_1[_0x15b391(0xbf)][_0x15b391(0x101)]('解析taskData失败:\x20'+_0x3d159a[_0x15b391(0xf7)],_0x15b391(0xc8));throw new Error(_0x15b391(0xc1));}}common_1[_0x15b391(0xbf)][_0x15b391(0x115)](_0x15b391(0xe0)+_0x4dcd71+'，payload:\x20'+JSON[_0x15b391(0xc0)](_0x19b18e)+_0x15b391(0xc2)+JSON[_0x15b391(0xc0)](_0x2d7d6e),_0x15b391(0xc8));try{_0x3da09e=await axios_1[_0x15b391(0xfb)]['post'](_0x4dcd71,_0x19b18e,{'headers':_0x2d7d6e}),common_1[_0x15b391(0xbf)][_0x15b391(0xf9)](_0x15b391(0xd7)+_0x3da09e[_0x15b391(0x106)]+',\x20状态消息:\x20'+_0x3da09e['statusText']+_0x15b391(0xdc)+JSON[_0x15b391(0xc0)](_0x3da09e[_0x15b391(0xd3)]));}catch(_0x39c7fa){common_1[_0x15b391(0xbf)][_0x15b391(0x101)]('任务提交失败:\x20'+_0x39c7fa['message'],_0x15b391(0xc8));throw new Error(_0x15b391(0xbe));}if((_0x35318a=_0x3da09e===null||_0x3da09e===void 0x0?void 0x0:_0x3da09e[_0x15b391(0xd3)])===null||_0x35318a===void 0x0?void 0x0:_0x35318a[_0x15b391(0xd3)])_0x21d7ee[_0x15b391(0x10e)]=(_0x12ac76=_0x3da09e===null||_0x3da09e===void 0x0?void 0x0:_0x3da09e[_0x15b391(0xd3)])===null||_0x12ac76===void 0x0?void 0x0:_0x12ac76['data'],common_1['Logger'][_0x15b391(0x115)](_0x15b391(0xff)+((_0x54f308=_0x3da09e===null||_0x3da09e===void 0x0?void 0x0:_0x3da09e[_0x15b391(0xd3)])===null||_0x54f308===void 0x0?void 0x0:_0x54f308[_0x15b391(0xd3)]),_0x15b391(0xc8));else throw new Error('未能获取结果数据,\x20即将重试');try{await this[_0x15b391(0xe7)]({'proxyUrl':_0x3e290d,'apiKey':_0x3fa437,'taskId':_0x3da09e[_0x15b391(0xd3)][_0x15b391(0xd3)],'timeout':_0x1ab90f,'prompt':_0x3a7d99,'action':_0x3b4a11,'onSuccess':async _0x3dc9cf=>{const _0x380488=_0x15b391;try{await this['chatLogService'][_0x380488(0x103)](_0x1d6000,{'videoUrl':_0x3dc9cf===null||_0x3dc9cf===void 0x0?void 0x0:_0x3dc9cf[_0x380488(0x108)],'audioUrl':_0x3dc9cf===null||_0x3dc9cf===void 0x0?void 0x0:_0x3dc9cf[_0x380488(0xe8)],'fileInfo':_0x3dc9cf===null||_0x3dc9cf===void 0x0?void 0x0:_0x3dc9cf['fileInfo'],'answer':(_0x3dc9cf===null||_0x3dc9cf===void 0x0?void 0x0:_0x3dc9cf[_0x380488(0x10b)])||_0x3a7d99,'progress':_0x380488(0xd9),'status':0x3,'taskId':_0x3dc9cf===null||_0x3dc9cf===void 0x0?void 0x0:_0x3dc9cf[_0x380488(0x10e)],'taskData':_0x3dc9cf===null||_0x3dc9cf===void 0x0?void 0x0:_0x3dc9cf[_0x380488(0xe1)]}),common_1['Logger'][_0x380488(0x115)](_0x380488(0xeb),_0x380488(0xc8));}catch(_0xff625){common_1[_0x380488(0xbf)][_0x380488(0x101)](_0x380488(0xf1)+_0xff625['message'],_0x380488(0xc8));}},'onAudioSuccess':async _0x4ab40f=>{const _0x451a38=_0x15b391;try{await this[_0x451a38(0xd4)][_0x451a38(0x103)](_0x1d6000,{'videoUrl':_0x4ab40f===null||_0x4ab40f===void 0x0?void 0x0:_0x4ab40f[_0x451a38(0x108)],'audioUrl':_0x4ab40f===null||_0x4ab40f===void 0x0?void 0x0:_0x4ab40f[_0x451a38(0xe8)],'fileInfo':_0x4ab40f===null||_0x4ab40f===void 0x0?void 0x0:_0x4ab40f['fileInfo'],'answer':(_0x4ab40f===null||_0x4ab40f===void 0x0?void 0x0:_0x4ab40f[_0x451a38(0x10b)])||_0x3a7d99,'progress':_0x4ab40f===null||_0x4ab40f===void 0x0?void 0x0:_0x4ab40f[_0x451a38(0xc9)],'status':_0x4ab40f[_0x451a38(0x106)],'taskId':_0x4ab40f===null||_0x4ab40f===void 0x0?void 0x0:_0x4ab40f[_0x451a38(0x10e)],'taskData':_0x4ab40f===null||_0x4ab40f===void 0x0?void 0x0:_0x4ab40f[_0x451a38(0xe1)]}),common_1[_0x451a38(0xbf)][_0x451a38(0x115)](_0x451a38(0x112),'SunoService');}catch(_0x420c76){common_1[_0x451a38(0xbf)]['error'](_0x451a38(0xf1)+_0x420c76[_0x451a38(0xf7)],_0x451a38(0xc8));}},'onGenerating':async _0x1fa6f8=>{const _0x82c1d1=_0x15b391;try{await this['chatLogService']['updateChatLog'](_0x1d6000,{'videoUrl':_0x1fa6f8===null||_0x1fa6f8===void 0x0?void 0x0:_0x1fa6f8['videoUrl'],'audioUrl':_0x1fa6f8===null||_0x1fa6f8===void 0x0?void 0x0:_0x1fa6f8[_0x82c1d1(0xe8)],'fileInfo':_0x1fa6f8===null||_0x1fa6f8===void 0x0?void 0x0:_0x1fa6f8[_0x82c1d1(0xe2)],'answer':(_0x1fa6f8===null||_0x1fa6f8===void 0x0?void 0x0:_0x1fa6f8['answer'])||'音乐生成中...','progress':_0x1fa6f8===null||_0x1fa6f8===void 0x0?void 0x0:_0x1fa6f8['progress'],'status':_0x1fa6f8[_0x82c1d1(0x106)]}),common_1['Logger'][_0x82c1d1(0x115)](_0x82c1d1(0xba),_0x82c1d1(0xc8));}catch(_0x147df9){common_1[_0x82c1d1(0xbf)][_0x82c1d1(0x101)]('更新日志失败:\x20'+_0x147df9[_0x82c1d1(0xf7)],_0x82c1d1(0xc8));}},'onFailure':async _0x47d9b1=>{const _0x3572a8=_0x15b391;try{await this[_0x3572a8(0xd4)][_0x3572a8(0x103)](_0x1d6000,{'answer':_0x3572a8(0x105),'status':_0x47d9b1[_0x3572a8(0x106)]}),common_1['Logger'][_0x3572a8(0x115)](_0x3572a8(0xd6),_0x3572a8(0xc8));}catch(_0x253168){common_1[_0x3572a8(0xbf)][_0x3572a8(0x101)](_0x3572a8(0xf1)+_0x253168['message'],_0x3572a8(0xc8));}}});}catch(_0x17a2d3){common_1[_0x15b391(0xbf)][_0x15b391(0x101)](_0x15b391(0x107),_0x17a2d3[_0x15b391(0xf7)],'SunoService');throw new Error(_0x15b391(0xf2));}return _0x21d7ee;}async[_0x87fc8c(0xe7)](_0x4e64c4){const _0x4868c3=_0x87fc8c,{proxyUrl:_0x17c5e0,apiKey:_0x1494c3,taskId:_0x166aa0,timeout:_0x2fa521,onSuccess:_0x38520c,onAudioSuccess:_0x73ca86,onFailure:_0x739e19,onGenerating:_0x5793de,action:_0x53da1a}=_0x4e64c4;let _0xbfea2e={'videoUrl':'','audioUrl':'','fileInfo':'','drawId':'','taskData':'','status':0x2,'progress':0x0,'answer':''};const _0x5eb97b={'Authorization':_0x4868c3(0xf0)+_0x1494c3},_0xdd5d05=_0x17c5e0+'/task/suno/v1/fetch/'+_0x166aa0,_0x21001a=Date[_0x4868c3(0x109)](),_0x4ccf2e=0x1388;let _0x3df843=0x0;try{while(Date[_0x4868c3(0x109)]()-_0x21001a<_0x2fa521){await new Promise(_0x240890=>setTimeout(_0x240890,_0x4ccf2e));try{const _0x3891c5=await axios_1[_0x4868c3(0xfb)][_0x4868c3(0xfe)](_0xdd5d05,{'headers':_0x5eb97b}),_0x12d24f=_0x3891c5[_0x4868c3(0xd3)]['data'];common_1[_0x4868c3(0xbf)][_0x4868c3(0xf9)](_0x4868c3(0xe3)+JSON[_0x4868c3(0xc0)](_0x12d24f),'SunoService');if(_0x53da1a==='LYRICS'){if(_0x12d24f['status']===_0x4868c3(0xb9)){_0xbfea2e[_0x4868c3(0x10e)]=_0x12d24f['data']['id'],_0xbfea2e[_0x4868c3(0xe1)]=JSON[_0x4868c3(0xc0)](_0x12d24f[_0x4868c3(0xd3)]),_0xbfea2e[_0x4868c3(0x10b)]=_0x12d24f[_0x4868c3(0xd3)]['text'],_0x38520c(_0xbfea2e);return;}_0xbfea2e['progress']=_0x12d24f===null||_0x12d24f===void 0x0?void 0x0:_0x12d24f['progress'],_0xbfea2e[_0x4868c3(0x10b)]=_0x4868c3(0xd0),_0xbfea2e[_0x4868c3(0xc9)]&&_0x5793de(_0xbfea2e);}if(_0x53da1a===_0x4868c3(0xde)){if(_0x12d24f[_0x4868c3(0xd3)]){const _0x2e14da=_0x12d24f[_0x4868c3(0xd3)];_0xbfea2e[_0x4868c3(0xe1)]=JSON[_0x4868c3(0xc0)](_0x2e14da);if(Array['isArray'](_0x2e14da)){const _0x37f90d=_0x2e14da[_0x4868c3(0xdf)](_0x5b9a3d=>_0x5b9a3d[_0x4868c3(0xbb)])['filter'](_0x3613f0=>_0x3613f0),_0x23def9=_0x2e14da[_0x4868c3(0xdf)](_0x303fc5=>_0x303fc5[_0x4868c3(0xe4)])[_0x4868c3(0x114)](_0x59116c=>_0x59116c),_0x5e05a4=_0x2e14da[_0x4868c3(0xdf)](_0x9a0a3e=>_0x9a0a3e['image_url'])[_0x4868c3(0x114)](_0x77b46b=>_0x77b46b),_0x932bc6=_0x2e14da[_0x4868c3(0xdf)](_0x2d05d6=>_0x2d05d6[_0x4868c3(0xc6)]),_0x100553=_0x932bc6[_0x4868c3(0xf6)]>0x0?_0x932bc6[0x0]:_0x4868c3(0x116);if(_0x12d24f[_0x4868c3(0x106)]===_0x4868c3(0xb9)){let _0x555389=[],_0xf50f91=[],_0x338c4f=[];try{const _0x54a7cc=await this[_0x4868c3(0x113)]['getConfigs']([_0x4868c3(0xec)]);if(Number(_0x54a7cc)){const _0x4bb2e2=new Date(),_0x7cc158=_0x4bb2e2[_0x4868c3(0xef)](),_0x54b810=String(_0x4bb2e2['getMonth']()+0x1)[_0x4868c3(0x10d)](0x2,'0'),_0x3a42ab=String(_0x4bb2e2[_0x4868c3(0x102)]())[_0x4868c3(0x10d)](0x2,'0'),_0x4df06b=''+_0x7cc158+_0x54b810+'/'+_0x3a42ab;for(const _0x17a9ed of _0x37f90d){try{const _0x54b700=await this['uploadService'][_0x4868c3(0xc4)]({'url':_0x17a9ed,'dir':_0x4868c3(0xcf)+_0x4df06b});_0x555389[_0x4868c3(0x104)](_0x54b700);}catch(_0xba546b){common_1[_0x4868c3(0xbf)][_0x4868c3(0x101)](_0x4868c3(0xcc)+_0xba546b[_0x4868c3(0xf7)],_0x4868c3(0xc8)),_0x555389[_0x4868c3(0x104)](_0x17a9ed);}}for(const _0x18da33 of _0x23def9){try{const _0x53bec1=await this[_0x4868c3(0xf8)][_0x4868c3(0xc4)]({'url':_0x18da33,'dir':_0x4868c3(0xee)+_0x4df06b});_0xf50f91[_0x4868c3(0x104)](_0x53bec1);}catch(_0x594ffe){common_1[_0x4868c3(0xbf)][_0x4868c3(0x101)]('上传视频文件失败:\x20'+_0x594ffe[_0x4868c3(0xf7)],_0x4868c3(0xc8)),_0xf50f91['push'](_0x18da33);}}for(const _0x2f09ca of _0x5e05a4){try{const _0x2f546f=await this[_0x4868c3(0xf8)][_0x4868c3(0xc4)]({'url':_0x2f09ca,'dir':'images/suno-music/'+_0x4df06b});_0x338c4f[_0x4868c3(0x104)](_0x2f546f);}catch(_0x4486bf){common_1[_0x4868c3(0xbf)]['error']('上传图片文件失败:\x20'+_0x4486bf[_0x4868c3(0xf7)],'SunoService'),_0x338c4f[_0x4868c3(0x104)](_0x2f09ca);}}}else _0x555389=_0x37f90d,_0xf50f91=_0x23def9,_0x338c4f=_0x5e05a4;}catch(_0x1deb4b){common_1[_0x4868c3(0xbf)][_0x4868c3(0x101)]('获取配置失败:\x20'+_0x1deb4b['message'],_0x4868c3(0xd5)),_0x555389=_0x37f90d,_0xf50f91=_0x23def9,_0x338c4f=_0x5e05a4;}_0xbfea2e[_0x4868c3(0xe8)]=_0x555389[_0x4868c3(0xdd)](','),_0xbfea2e[_0x4868c3(0x108)]=_0xf50f91[_0x4868c3(0xdd)](','),_0xbfea2e[_0x4868c3(0xe2)]=_0x338c4f[_0x4868c3(0xdd)](',');_0x37f90d[_0x4868c3(0xf6)]===0x2?(_0xbfea2e[_0x4868c3(0x106)]=0x3,_0xbfea2e['answer']=_0x100553):(_0xbfea2e['status']=0x2,_0xbfea2e[_0x4868c3(0xc9)]=_0x12d24f===null||_0x12d24f===void 0x0?void 0x0:_0x12d24f[_0x4868c3(0xc9)],_0xbfea2e[_0x4868c3(0x10b)]=_0x4868c3(0xbd)+(_0x12d24f===null||_0x12d24f===void 0x0?void 0x0:_0x12d24f[_0x4868c3(0xc9)]));common_1[_0x4868c3(0xbf)][_0x4868c3(0xf9)](_0x4868c3(0xed)+JSON[_0x4868c3(0xc0)](_0x2e14da),_0x4868c3(0xc8)),_0x38520c(_0xbfea2e);return;}else _0xbfea2e['audioUrl']=_0x37f90d[_0x4868c3(0xdd)](','),_0xbfea2e['videoUrl']=_0x23def9['join'](','),_0xbfea2e[_0x4868c3(0xe2)]=_0x5e05a4['join'](','),_0xbfea2e[_0x4868c3(0x106)]=0x2,_0xbfea2e['progress']=_0x12d24f===null||_0x12d24f===void 0x0?void 0x0:_0x12d24f['progress'],_0xbfea2e[_0x4868c3(0x10b)]=_0x100553,_0x73ca86(_0xbfea2e);}}!_0xbfea2e['audioUrl']&&_0xbfea2e[_0x4868c3(0xc9)]&&_0xbfea2e[_0x4868c3(0x106)]===0x2&&_0x5793de(_0xbfea2e);}}catch(_0x5dec09){_0x3df843++,common_1[_0x4868c3(0xbf)][_0x4868c3(0x101)]('轮询失败，重试次数:\x20'+_0x3df843,_0x4868c3(0xc8));}}common_1[_0x4868c3(0xbf)][_0x4868c3(0x101)](_0x4868c3(0xdb),_0x4868c3(0xc8)),_0xbfea2e[_0x4868c3(0x106)]=0x4,_0x739e19(_0xbfea2e);throw new Error(_0x4868c3(0x10f));}catch(_0x5077c7){common_1[_0x4868c3(0xbf)][_0x4868c3(0x101)](_0x4868c3(0xb4)+_0x5077c7,'SunoService'),_0xbfea2e[_0x4868c3(0x106)]=0x5,_0x739e19(_0xbfea2e);}}};SunoService=__decorate([(0x0,common_1[_0x87fc8c(0xd1)])(),__metadata(_0x87fc8c(0x10c),[chatLog_service_1[_0x87fc8c(0xcd)],upload_service_1[_0x87fc8c(0x111)],globalConfig_service_1[_0x87fc8c(0x110)]])],SunoService),exports[_0x87fc8c(0xc8)]=SunoService;