'use strict';const _0x116291=_0x5a08;function _0xf00a(){const _0x1771e5=['LYRICS','音乐生成失败','status','audio/suno-music/','log','轮询过程中发生错误:\x20','轮询超时，请稍后再试！','answer','上传音频文件失败:\x20','object','上传视频文件失败:\x20','pollSunoMusicResult','audioUrl','getDate','2192ZUWlwe','查询生成结果时发生错误:','GlobalConfigService','message','420QcTMzs','正在准备发送请求到\x20','text','任务提交失败','114714xmdACN','length','解析taskData失败:\x20','getFullYear','push','ChatLogService','function','/task/suno/v1/submit/music','video_url','join','updateChatLog','任务提交失败:\x20','Bearer\x20','suno',',\x20headers:\x20','decorate','fileInfo','轮询失败，重试次数:\x20','data','progress','81088UQmVTh','更新日志失败:\x20','uploadFileFromUrl','2267320CYSltf','image_url','get','音频生成成功，等待视频生成...','/task/suno/v1/fetch/','音乐生成中...','statusText','uploadService','72621yPbOMY','音乐任务已完成','任务提交结果，状态码:\x20','defineProperty','3LAGCWu','now','__esModule','100%','未能获取结果数据,\x20即将重试','taskData','parse','getConfigs','Logger','default','chatLogService','videoUrl','SUCCESS','filter','isArray','@nestjs/common','217032rEJInF','查询超时，请稍后再试！','video/suno-music/','globalConfigService','获取配置失败:\x20','getMonth','debug','__metadata','生成失败','error','SunoService:\x20','../chatLog/chatLog.service','map','3240eAEkOi','轮询结果:\x20','taskData格式错误','padStart','当前生成进度\x20','SunoService','images/suno-music/','taskId','音乐已生成','MUSIC','758544WZCVym','LumaService','，payload:\x20','design:paramtypes','stringify','metadata'];_0xf00a=function(){return _0x1771e5;};return _0xf00a();}(function(_0x5a720e,_0x58091a){const _0x1e97b8=_0x5a08,_0x1be177=_0x5a720e();while(!![]){try{const _0x112e6b=parseInt(_0x1e97b8(0x1b8))/0x1+-parseInt(_0x1e97b8(0x1cc))/0x2*(parseInt(_0x1e97b8(0x1bc))/0x3)+parseInt(_0x1e97b8(0x191))/0x4*(parseInt(_0x1e97b8(0x1d9))/0x5)+parseInt(_0x1e97b8(0x1e3))/0x6+-parseInt(_0x1e97b8(0x1ad))/0x7+parseInt(_0x1e97b8(0x1b0))/0x8+-parseInt(_0x1e97b8(0x199))/0x9*(parseInt(_0x1e97b8(0x195))/0xa);if(_0x112e6b===_0x58091a)break;else _0x1be177['push'](_0x1be177['shift']());}catch(_0x21b1dd){_0x1be177['push'](_0x1be177['shift']());}}}(_0xf00a,0x2c774));function _0x5a08(_0x46ec6b,_0xdb246){const _0xf00aea=_0xf00a();return _0x5a08=function(_0x5a08da,_0x53c573){_0x5a08da=_0x5a08da-0x18c;let _0x5920dd=_0xf00aea[_0x5a08da];return _0x5920dd;},_0x5a08(_0x46ec6b,_0xdb246);}var __decorate=this&&this['__decorate']||function(_0x4da9da,_0x3f52a0,_0x36ea4f,_0x54d450){const _0x42223f=_0x5a08;var _0x3a3d56=arguments['length'],_0x303243=_0x3a3d56<0x3?_0x3f52a0:_0x54d450===null?_0x54d450=Object['getOwnPropertyDescriptor'](_0x3f52a0,_0x36ea4f):_0x54d450,_0x3984e1;if(typeof Reflect===_0x42223f(0x18c)&&typeof Reflect['decorate']===_0x42223f(0x19f))_0x303243=Reflect[_0x42223f(0x1a8)](_0x4da9da,_0x3f52a0,_0x36ea4f,_0x54d450);else{for(var _0x49fdd9=_0x4da9da[_0x42223f(0x19a)]-0x1;_0x49fdd9>=0x0;_0x49fdd9--)if(_0x3984e1=_0x4da9da[_0x49fdd9])_0x303243=(_0x3a3d56<0x3?_0x3984e1(_0x303243):_0x3a3d56>0x3?_0x3984e1(_0x3f52a0,_0x36ea4f,_0x303243):_0x3984e1(_0x3f52a0,_0x36ea4f))||_0x303243;}return _0x3a3d56>0x3&&_0x303243&&Object[_0x42223f(0x1bb)](_0x3f52a0,_0x36ea4f,_0x303243),_0x303243;},__metadata=this&&this[_0x116291(0x1d3)]||function(_0x3cfa3a,_0x2f7755){const _0x59fa9b=_0x116291;if(typeof Reflect===_0x59fa9b(0x18c)&&typeof Reflect[_0x59fa9b(0x1e8)]===_0x59fa9b(0x19f))return Reflect['metadata'](_0x3cfa3a,_0x2f7755);};Object[_0x116291(0x1bb)](exports,_0x116291(0x1be),{'value':!![]}),exports[_0x116291(0x1de)]=void 0x0;const common_1=require(_0x116291(0x1cb)),axios_1=require('axios'),chatLog_service_1=require(_0x116291(0x1d7)),globalConfig_service_1=require('../globalConfig/globalConfig.service'),upload_service_1=require('../upload/upload.service');let SunoService=class SunoService{constructor(_0x460a8a,_0x5180c8,_0x1cfcfd){const _0x56c087=_0x116291;this[_0x56c087(0x1c6)]=_0x460a8a,this[_0x56c087(0x1b7)]=_0x5180c8,this[_0x56c087(0x1cf)]=_0x1cfcfd;}async[_0x116291(0x1a6)](_0x178a0b){const _0x3e5538=_0x116291;var _0x1b9eab,_0x2b8ca5,_0x1903c9;const {apiKey:_0x45c30e,proxyUrl:_0x144171,action:_0x500b47,prompt:_0x905a94,timeout:_0x639c52,assistantLogId:_0x5438ce,taskData:_0x2a3038,extraParam:_0x587bf2}=_0x178a0b;common_1[_0x3e5538(0x1c4)]['debug'](_0x3e5538(0x1d6)+JSON['stringify'](_0x178a0b),'SunoService');let _0x24e295={'text':'','fileInfo':'','taskId':'','taskData':'','status':0x2};common_1[_0x3e5538(0x1c4)][_0x3e5538(0x1ed)]('开始生成音乐',_0x3e5538(0x1de));let _0x452894=null,_0x33f141='',_0x396643={};const _0x6278a3={'Authorization':_0x3e5538(0x1a5)+_0x45c30e};_0x500b47==='LYRICS'&&(_0x33f141=_0x144171+'/task/suno/v1/submit/lyrics',_0x396643={'prompt':_0x905a94});if(_0x500b47===_0x3e5538(0x1e2)){_0x33f141=_0x144171+_0x3e5538(0x1a0);try{_0x396643=JSON[_0x3e5538(0x1c2)](_0x2a3038);}catch(_0x9c0895){common_1[_0x3e5538(0x1c4)]['error'](_0x3e5538(0x19b)+_0x9c0895['message'],_0x3e5538(0x1de));throw new Error(_0x3e5538(0x1db));}}common_1[_0x3e5538(0x1c4)][_0x3e5538(0x1ed)](_0x3e5538(0x196)+_0x33f141+_0x3e5538(0x1e5)+JSON[_0x3e5538(0x1e7)](_0x396643)+_0x3e5538(0x1a7)+JSON[_0x3e5538(0x1e7)](_0x6278a3),_0x3e5538(0x1de));try{_0x452894=await axios_1[_0x3e5538(0x1c5)]['post'](_0x33f141,_0x396643,{'headers':_0x6278a3}),common_1[_0x3e5538(0x1c4)][_0x3e5538(0x1d2)](_0x3e5538(0x1ba)+_0x452894[_0x3e5538(0x1eb)]+',\x20状态消息:\x20'+_0x452894[_0x3e5538(0x1b6)]+',\x20数据:\x20'+JSON['stringify'](_0x452894['data']));}catch(_0x48c163){common_1[_0x3e5538(0x1c4)]['error'](_0x3e5538(0x1a4)+_0x48c163['message'],_0x3e5538(0x1de));throw new Error(_0x3e5538(0x198));}if((_0x1b9eab=_0x452894===null||_0x452894===void 0x0?void 0x0:_0x452894[_0x3e5538(0x1ab)])===null||_0x1b9eab===void 0x0?void 0x0:_0x1b9eab[_0x3e5538(0x1ab)])_0x24e295[_0x3e5538(0x1e0)]=(_0x2b8ca5=_0x452894===null||_0x452894===void 0x0?void 0x0:_0x452894['data'])===null||_0x2b8ca5===void 0x0?void 0x0:_0x2b8ca5[_0x3e5538(0x1ab)],common_1[_0x3e5538(0x1c4)][_0x3e5538(0x1ed)]('任务提交成功,\x20任务ID:\x20'+((_0x1903c9=_0x452894===null||_0x452894===void 0x0?void 0x0:_0x452894[_0x3e5538(0x1ab)])===null||_0x1903c9===void 0x0?void 0x0:_0x1903c9[_0x3e5538(0x1ab)]),_0x3e5538(0x1de));else throw new Error(_0x3e5538(0x1c0));try{await this[_0x3e5538(0x18e)]({'proxyUrl':_0x144171,'apiKey':_0x45c30e,'taskId':_0x452894[_0x3e5538(0x1ab)]['data'],'timeout':_0x639c52,'prompt':_0x905a94,'action':_0x500b47,'onSuccess':async _0xe8cc25=>{const _0x229fb3=_0x3e5538;try{await this[_0x229fb3(0x1c6)][_0x229fb3(0x1a3)](_0x5438ce,{'videoUrl':_0xe8cc25===null||_0xe8cc25===void 0x0?void 0x0:_0xe8cc25[_0x229fb3(0x1c7)],'audioUrl':_0xe8cc25===null||_0xe8cc25===void 0x0?void 0x0:_0xe8cc25[_0x229fb3(0x18f)],'fileInfo':_0xe8cc25===null||_0xe8cc25===void 0x0?void 0x0:_0xe8cc25[_0x229fb3(0x1a9)],'answer':(_0xe8cc25===null||_0xe8cc25===void 0x0?void 0x0:_0xe8cc25[_0x229fb3(0x1f0)])||_0x905a94,'progress':_0x229fb3(0x1bf),'status':0x3,'taskId':_0xe8cc25===null||_0xe8cc25===void 0x0?void 0x0:_0xe8cc25[_0x229fb3(0x1e0)],'taskData':_0xe8cc25===null||_0xe8cc25===void 0x0?void 0x0:_0xe8cc25['taskData']}),common_1[_0x229fb3(0x1c4)][_0x229fb3(0x1ed)](_0x229fb3(0x1b9),'SunoService');}catch(_0x32f761){common_1[_0x229fb3(0x1c4)][_0x229fb3(0x1d5)](_0x229fb3(0x1ae)+_0x32f761[_0x229fb3(0x194)],'SunoService');}},'onAudioSuccess':async _0x5b6bdf=>{const _0x27aeb6=_0x3e5538;try{await this[_0x27aeb6(0x1c6)]['updateChatLog'](_0x5438ce,{'videoUrl':_0x5b6bdf===null||_0x5b6bdf===void 0x0?void 0x0:_0x5b6bdf[_0x27aeb6(0x1c7)],'audioUrl':_0x5b6bdf===null||_0x5b6bdf===void 0x0?void 0x0:_0x5b6bdf[_0x27aeb6(0x18f)],'fileInfo':_0x5b6bdf===null||_0x5b6bdf===void 0x0?void 0x0:_0x5b6bdf[_0x27aeb6(0x1a9)],'answer':(_0x5b6bdf===null||_0x5b6bdf===void 0x0?void 0x0:_0x5b6bdf[_0x27aeb6(0x1f0)])||_0x905a94,'progress':_0x5b6bdf===null||_0x5b6bdf===void 0x0?void 0x0:_0x5b6bdf[_0x27aeb6(0x1ac)],'status':_0x5b6bdf[_0x27aeb6(0x1eb)],'taskId':_0x5b6bdf===null||_0x5b6bdf===void 0x0?void 0x0:_0x5b6bdf['taskId'],'taskData':_0x5b6bdf===null||_0x5b6bdf===void 0x0?void 0x0:_0x5b6bdf[_0x27aeb6(0x1c1)]}),common_1['Logger'][_0x27aeb6(0x1ed)](_0x27aeb6(0x1b3),'SunoService');}catch(_0x6066ac){common_1[_0x27aeb6(0x1c4)][_0x27aeb6(0x1d5)](_0x27aeb6(0x1ae)+_0x6066ac[_0x27aeb6(0x194)],_0x27aeb6(0x1de));}},'onGenerating':async _0x52e582=>{const _0x11318b=_0x3e5538;try{await this['chatLogService']['updateChatLog'](_0x5438ce,{'videoUrl':_0x52e582===null||_0x52e582===void 0x0?void 0x0:_0x52e582[_0x11318b(0x1c7)],'audioUrl':_0x52e582===null||_0x52e582===void 0x0?void 0x0:_0x52e582[_0x11318b(0x18f)],'fileInfo':_0x52e582===null||_0x52e582===void 0x0?void 0x0:_0x52e582[_0x11318b(0x1a9)],'answer':(_0x52e582===null||_0x52e582===void 0x0?void 0x0:_0x52e582[_0x11318b(0x1f0)])||'音乐生成中...','progress':_0x52e582===null||_0x52e582===void 0x0?void 0x0:_0x52e582['progress'],'status':_0x52e582[_0x11318b(0x1eb)]}),common_1[_0x11318b(0x1c4)]['log'](_0x11318b(0x1b5),'SunoService');}catch(_0x164dd7){common_1[_0x11318b(0x1c4)][_0x11318b(0x1d5)](_0x11318b(0x1ae)+_0x164dd7['message'],_0x11318b(0x1de));}},'onFailure':async _0x35c0c4=>{const _0x526732=_0x3e5538;try{await this[_0x526732(0x1c6)]['updateChatLog'](_0x5438ce,{'answer':_0x526732(0x1ea),'status':_0x35c0c4[_0x526732(0x1eb)]}),common_1[_0x526732(0x1c4)][_0x526732(0x1ed)](_0x526732(0x1d4),_0x526732(0x1de));}catch(_0x30b55f){common_1[_0x526732(0x1c4)][_0x526732(0x1d5)](_0x526732(0x1ae)+_0x30b55f['message'],'SunoService');}}});}catch(_0x491393){common_1[_0x3e5538(0x1c4)]['error'](_0x3e5538(0x192),_0x491393[_0x3e5538(0x194)],_0x3e5538(0x1de));throw new Error('查询生成结果时发生错误');}return _0x24e295;}async['pollSunoMusicResult'](_0x531c55){const _0xb27e32=_0x116291,{proxyUrl:_0x202610,apiKey:_0x3cb191,taskId:_0x8db2ea,timeout:_0x5b2a75,onSuccess:_0x423601,onAudioSuccess:_0x4416b1,onFailure:_0x9d5d31,onGenerating:_0x38ca6c,action:_0x3e26de}=_0x531c55;let _0x63ba82={'videoUrl':'','audioUrl':'','fileInfo':'','drawId':'','taskData':'','status':0x2,'progress':0x0,'answer':''};const _0x428a6e={'Authorization':_0xb27e32(0x1a5)+_0x3cb191},_0x84179b=_0x202610+_0xb27e32(0x1b4)+_0x8db2ea,_0x1617de=Date['now'](),_0x1a8214=0x1388;let _0x5920af=0x0;try{while(Date[_0xb27e32(0x1bd)]()-_0x1617de<_0x5b2a75){await new Promise(_0x3ea521=>setTimeout(_0x3ea521,_0x1a8214));try{const _0x482a77=await axios_1[_0xb27e32(0x1c5)][_0xb27e32(0x1b2)](_0x84179b,{'headers':_0x428a6e}),_0x300074=_0x482a77['data'][_0xb27e32(0x1ab)];common_1[_0xb27e32(0x1c4)][_0xb27e32(0x1d2)](_0xb27e32(0x1da)+JSON['stringify'](_0x300074),_0xb27e32(0x1de));if(_0x3e26de===_0xb27e32(0x1e9)){if(_0x300074[_0xb27e32(0x1eb)]===_0xb27e32(0x1c8)){_0x63ba82['taskId']=_0x300074[_0xb27e32(0x1ab)]['id'],_0x63ba82['taskData']=JSON[_0xb27e32(0x1e7)](_0x300074[_0xb27e32(0x1ab)]),_0x63ba82['answer']=_0x300074[_0xb27e32(0x1ab)][_0xb27e32(0x197)],_0x423601(_0x63ba82);return;}_0x63ba82[_0xb27e32(0x1ac)]=_0x300074===null||_0x300074===void 0x0?void 0x0:_0x300074['progress'],_0x63ba82[_0xb27e32(0x1f0)]='歌词生成中',_0x63ba82['progress']&&_0x38ca6c(_0x63ba82);}if(_0x3e26de===_0xb27e32(0x1e2)){if(_0x300074['data']){const _0x55e11f=_0x300074['data'];_0x63ba82[_0xb27e32(0x1c1)]=JSON['stringify'](_0x55e11f);if(Array[_0xb27e32(0x1ca)](_0x55e11f)){const _0x37724f=_0x55e11f[_0xb27e32(0x1d8)](_0x43a83a=>_0x43a83a['audio_url'])['filter'](_0x2cca61=>_0x2cca61),_0x37b153=_0x55e11f['map'](_0x4a6856=>_0x4a6856[_0xb27e32(0x1a1)])[_0xb27e32(0x1c9)](_0x5d721e=>_0x5d721e),_0x3ad82f=_0x55e11f['map'](_0x20a49b=>_0x20a49b[_0xb27e32(0x1b1)])[_0xb27e32(0x1c9)](_0x301338=>_0x301338),_0x285d70=_0x55e11f[_0xb27e32(0x1d8)](_0x17bf9a=>_0x17bf9a['title']),_0x2abe54=_0x285d70[_0xb27e32(0x19a)]>0x0?_0x285d70[0x0]:_0xb27e32(0x1e1);if(_0x300074[_0xb27e32(0x1eb)]===_0xb27e32(0x1c8)){let _0x5db1e1=[],_0x9d67de=[],_0xcadd7f=[];try{const _0x226506=await this['globalConfigService'][_0xb27e32(0x1c3)](['localStorageStatus']);if(Number(_0x226506)){const _0xa04644=new Date(),_0x48c221=_0xa04644[_0xb27e32(0x19c)](),_0x15bc43=String(_0xa04644[_0xb27e32(0x1d1)]()+0x1)[_0xb27e32(0x1dc)](0x2,'0'),_0x29088a=String(_0xa04644[_0xb27e32(0x190)]())[_0xb27e32(0x1dc)](0x2,'0'),_0x395c0a=''+_0x48c221+_0x15bc43+'/'+_0x29088a;for(const _0xd411b of _0x37724f){try{const _0x54b758=await this[_0xb27e32(0x1b7)][_0xb27e32(0x1af)]({'url':_0xd411b,'dir':_0xb27e32(0x1ec)+_0x395c0a});_0x5db1e1['push'](_0x54b758);}catch(_0xb28e90){common_1['Logger']['error'](_0xb27e32(0x1f1)+_0xb28e90[_0xb27e32(0x194)],_0xb27e32(0x1de)),_0x5db1e1[_0xb27e32(0x19d)](_0xd411b);}}for(const _0x11965f of _0x37b153){try{const _0x3a3531=await this['uploadService'][_0xb27e32(0x1af)]({'url':_0x11965f,'dir':_0xb27e32(0x1ce)+_0x395c0a});_0x9d67de[_0xb27e32(0x19d)](_0x3a3531);}catch(_0x2397e1){common_1[_0xb27e32(0x1c4)][_0xb27e32(0x1d5)](_0xb27e32(0x18d)+_0x2397e1[_0xb27e32(0x194)],_0xb27e32(0x1de)),_0x9d67de[_0xb27e32(0x19d)](_0x11965f);}}for(const _0x458e1f of _0x3ad82f){try{const _0x43d203=await this[_0xb27e32(0x1b7)]['uploadFileFromUrl']({'url':_0x458e1f,'dir':_0xb27e32(0x1df)+_0x395c0a});_0xcadd7f['push'](_0x43d203);}catch(_0x37e76e){common_1[_0xb27e32(0x1c4)][_0xb27e32(0x1d5)]('上传图片文件失败:\x20'+_0x37e76e[_0xb27e32(0x194)],_0xb27e32(0x1de)),_0xcadd7f['push'](_0x458e1f);}}}else _0x5db1e1=_0x37724f,_0x9d67de=_0x37b153,_0xcadd7f=_0x3ad82f;}catch(_0xe278e1){common_1[_0xb27e32(0x1c4)]['error'](_0xb27e32(0x1d0)+_0xe278e1[_0xb27e32(0x194)],_0xb27e32(0x1e4)),_0x5db1e1=_0x37724f,_0x9d67de=_0x37b153,_0xcadd7f=_0x3ad82f;}_0x63ba82[_0xb27e32(0x18f)]=_0x5db1e1[_0xb27e32(0x1a2)](','),_0x63ba82['videoUrl']=_0x9d67de[_0xb27e32(0x1a2)](','),_0x63ba82['fileInfo']=_0xcadd7f[_0xb27e32(0x1a2)](',');_0x37724f[_0xb27e32(0x19a)]===0x2?(_0x63ba82[_0xb27e32(0x1eb)]=0x3,_0x63ba82[_0xb27e32(0x1f0)]=_0x2abe54):(_0x63ba82[_0xb27e32(0x1eb)]=0x2,_0x63ba82[_0xb27e32(0x1ac)]=_0x300074===null||_0x300074===void 0x0?void 0x0:_0x300074['progress'],_0x63ba82[_0xb27e32(0x1f0)]=_0xb27e32(0x1dd)+(_0x300074===null||_0x300074===void 0x0?void 0x0:_0x300074['progress']));common_1[_0xb27e32(0x1c4)]['debug']('音乐生成成功:\x20'+JSON['stringify'](_0x55e11f),_0xb27e32(0x1de)),_0x423601(_0x63ba82);return;}else _0x63ba82[_0xb27e32(0x18f)]=_0x37724f[_0xb27e32(0x1a2)](','),_0x63ba82[_0xb27e32(0x1c7)]=_0x37b153[_0xb27e32(0x1a2)](','),_0x63ba82[_0xb27e32(0x1a9)]=_0x3ad82f[_0xb27e32(0x1a2)](','),_0x63ba82[_0xb27e32(0x1eb)]=0x2,_0x63ba82[_0xb27e32(0x1ac)]=_0x300074===null||_0x300074===void 0x0?void 0x0:_0x300074[_0xb27e32(0x1ac)],_0x63ba82[_0xb27e32(0x1f0)]=_0x2abe54,_0x4416b1(_0x63ba82);}}!_0x63ba82[_0xb27e32(0x18f)]&&_0x63ba82[_0xb27e32(0x1ac)]&&_0x63ba82[_0xb27e32(0x1eb)]===0x2&&_0x38ca6c(_0x63ba82);}}catch(_0x530ae7){_0x5920af++,common_1[_0xb27e32(0x1c4)][_0xb27e32(0x1d5)](_0xb27e32(0x1aa)+_0x5920af,_0xb27e32(0x1de));}}common_1[_0xb27e32(0x1c4)]['error'](_0xb27e32(0x1ef),'SunoService'),_0x63ba82[_0xb27e32(0x1eb)]=0x4,_0x9d5d31(_0x63ba82);throw new Error(_0xb27e32(0x1cd));}catch(_0x341627){common_1[_0xb27e32(0x1c4)][_0xb27e32(0x1d5)](_0xb27e32(0x1ee)+_0x341627,_0xb27e32(0x1de)),_0x63ba82[_0xb27e32(0x1eb)]=0x5,_0x9d5d31(_0x63ba82);}}};SunoService=__decorate([(0x0,common_1['Injectable'])(),__metadata(_0x116291(0x1e6),[chatLog_service_1[_0x116291(0x19e)],upload_service_1['UploadService'],globalConfig_service_1[_0x116291(0x193)]])],SunoService),exports[_0x116291(0x1de)]=SunoService;