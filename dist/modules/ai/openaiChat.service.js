'use strict';const _0x3a7a30=_0x5cae;(function(_0x9290bd,_0x2c8554){const _0x495ca1=_0x5cae,_0x4f06fc=_0x9290bd();while(!![]){try{const _0x45ac20=-parseInt(_0x495ca1(0x14f))/0x1+-parseInt(_0x495ca1(0x148))/0x2+-parseInt(_0x495ca1(0x161))/0x3+parseInt(_0x495ca1(0x137))/0x4+parseInt(_0x495ca1(0x174))/0x5*(parseInt(_0x495ca1(0x162))/0x6)+-parseInt(_0x495ca1(0x14e))/0x7+parseInt(_0x495ca1(0x17b))/0x8*(parseInt(_0x495ca1(0x15c))/0x9);if(_0x45ac20===_0x2c8554)break;else _0x4f06fc['push'](_0x4f06fc['shift']());}catch(_0x52ad0a){_0x4f06fc['push'](_0x4f06fc['shift']());}}}(_0x1168,0x68f61));var __decorate=this&&this[_0x3a7a30(0x144)]||function(_0x2787f0,_0x76fd8a,_0x3dd54c,_0x596d42){const _0x5c236e=_0x3a7a30;var _0x368841=arguments['length'],_0x3eb615=_0x368841<0x3?_0x76fd8a:_0x596d42===null?_0x596d42=Object['getOwnPropertyDescriptor'](_0x76fd8a,_0x3dd54c):_0x596d42,_0x54afcf;if(typeof Reflect===_0x5c236e(0x14d)&&typeof Reflect['decorate']==='function')_0x3eb615=Reflect[_0x5c236e(0x14c)](_0x2787f0,_0x76fd8a,_0x3dd54c,_0x596d42);else{for(var _0x44016c=_0x2787f0[_0x5c236e(0x13a)]-0x1;_0x44016c>=0x0;_0x44016c--)if(_0x54afcf=_0x2787f0[_0x44016c])_0x3eb615=(_0x368841<0x3?_0x54afcf(_0x3eb615):_0x368841>0x3?_0x54afcf(_0x76fd8a,_0x3dd54c,_0x3eb615):_0x54afcf(_0x76fd8a,_0x3dd54c))||_0x3eb615;}return _0x368841>0x3&&_0x3eb615&&Object['defineProperty'](_0x76fd8a,_0x3dd54c,_0x3eb615),_0x3eb615;},__metadata=this&&this[_0x3a7a30(0x170)]||function(_0x1f3283,_0x4ff358){const _0x15325a=_0x3a7a30;if(typeof Reflect===_0x15325a(0x14d)&&typeof Reflect[_0x15325a(0x16b)]==='function')return Reflect[_0x15325a(0x16b)](_0x1f3283,_0x4ff358);};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports['OpenAIChatService']=void 0x0;const utils_1=require('../../common/utils'),common_1=require(_0x3a7a30(0x15a)),axios_1=require(_0x3a7a30(0x172)),globalConfig_service_1=require(_0x3a7a30(0x12f));function _0x1168(){const _0x28081d=['Authorization','answer','openaiBaseUrl','Error\x20parsing\x20line:','全局模型调用成功,\x20返回结果:\x20','application/json','data:image/***;base64\x20...\x20...','sanitizeOptionsForLogging','error','@nestjs/common','message','117jOdmri','forEach','system','messages','parse','2433996tiecWo','256734BoCcDn','split','user','errMsg','getConfigs','data','headers','POST','handleError','metadata','url','/v1/chat/completions','请求配置:','globalConfigService','__metadata','design:paramtypes','axios','stream','75WDOeST','delta','Bearer\x20','slice','addEventListener','end','ChatService','717856SQbONT','image_url','signal','../globalConfig/globalConfig.service','stringify','log','data:\x20[DONE]','isArray','Injectable','startsWith','temperature','247608MtddNR','map','GlobalConfigService','length','push','abort','trim','OpenAIChatService','default','error:\x20','pop','gpt-3.5-turbo-0125','Logger','__decorate','choices','type','content','706332JDTxaI','assign','openaiBaseKey','openAIChat','decorate','object','1431731HRremW','71301Gsirut','openaiBaseModel'];_0x1168=function(){return _0x28081d;};return _0x1168();}let OpenAIChatService=class OpenAIChatService{constructor(_0x439fa5){const _0x3104ea=_0x3a7a30;this[_0x3104ea(0x16f)]=_0x439fa5;}async[_0x3a7a30(0x14b)](_0x23ec77,_0x5683a2){const _0x423c81=_0x3a7a30,{onFailure:_0x2ac614,onProgress:_0x230a1e,apiKey:_0x13d60a,model:_0x2ed2b3,proxyUrl:_0x26a041,modelName:_0x3ba17a,timeout:_0x4f6a2c,chatId:_0x10d1ce,isFileUpload:_0xd008b2,modelAvatar:_0x23efd0,temperature:_0x208efd,abortController:_0x32df0e}=_0x5683a2;let _0x51d723={'text':'','model':'','modelName':_0x3ba17a,'chatId':_0x10d1ce,'answer':'','errMsg':'','modelAvatar':_0x23efd0};const _0x496dc8=Object[_0x423c81(0x149)]({'model':_0x2ed2b3,'messages':_0x23ec77},_0xd008b2===0x2&&{'max_tokens':0x800});_0x496dc8[_0x423c81(0x173)]=!![],_0x496dc8[_0x423c81(0x136)]=_0x208efd;const _0x17ffd7={'method':_0x423c81(0x169),'url':_0x26a041+'/v1/chat/completions','responseType':'stream','timeout':_0x4f6a2c,'headers':{'Content-Type':_0x423c81(0x156),'Authorization':_0x423c81(0x176)+_0x13d60a},'data':_0x496dc8},_0xcc81e8=await this[_0x423c81(0x158)](_0x17ffd7);console[_0x423c81(0x131)]('请求配置:',JSON[_0x423c81(0x130)](_0xcc81e8,null,0x2),_0x423c81(0x17a)),console[_0x423c81(0x131)](_0x423c81(0x16e),JSON[_0x423c81(0x130)](_0xcc81e8,null,0x2),'ChatService');try{const _0x3f2727=await(0x0,axios_1[_0x423c81(0x13f)])(_0x17ffd7),_0x11450c=_0x3f2727[_0x423c81(0x167)];let _0x101f8d='';return await new Promise((_0xfa77f9,_0x1024b4)=>{const _0x254979=_0x423c81;_0x11450c['on'](_0x254979(0x167),_0x27f9bb=>{const _0x1c7e13=_0x254979;_0x101f8d+=_0x27f9bb['toString']();let _0x10ead8=_0x101f8d[_0x1c7e13(0x163)]('\x0a');_0x101f8d=_0x10ead8[_0x1c7e13(0x141)](),_0x10ead8[_0x1c7e13(0x15d)](_0x19f24f=>{const _0x2c2081=_0x1c7e13;var _0x4330e6,_0x4e7bfc;if(_0x19f24f[_0x2c2081(0x13d)]()===_0x2c2081(0x132)){console[_0x2c2081(0x131)]('处理结束信号\x20[DONE]'),_0xfa77f9(_0x51d723);return;}if(_0x19f24f[_0x2c2081(0x135)]('data:\x20'))try{const _0x4878c2=_0x19f24f[_0x2c2081(0x177)](0x6)['trim']();if(_0x4878c2){const _0xbbf62b=JSON[_0x2c2081(0x160)](_0x4878c2),_0x371e75=((_0x4e7bfc=(_0x4330e6=_0xbbf62b[_0x2c2081(0x145)][0x0])===null||_0x4330e6===void 0x0?void 0x0:_0x4330e6[_0x2c2081(0x175)])===null||_0x4e7bfc===void 0x0?void 0x0:_0x4e7bfc[_0x2c2081(0x147)])||'';_0x51d723[_0x2c2081(0x152)]+=_0x371e75,_0x230a1e===null||_0x230a1e===void 0x0?void 0x0:_0x230a1e({'text':_0x371e75,'answer':_0x51d723[_0x2c2081(0x152)]});}}catch(_0x85a362){console[_0x2c2081(0x159)](_0x2c2081(0x154),_0x19f24f,_0x85a362);}});}),_0x11450c['on'](_0x254979(0x179),()=>{_0xfa77f9(_0x51d723);}),_0x11450c['on'](_0x254979(0x159),_0x5a267b=>{_0x1024b4(_0x5a267b);}),_0x32df0e[_0x254979(0x12e)][_0x254979(0x178)](_0x254979(0x13c),()=>{_0xfa77f9(_0x51d723);});}),_0x51d723;}catch(_0x56e33d){return _0x51d723['errMsg']=(0x0,utils_1[_0x423c81(0x16a)])(_0x56e33d),common_1[_0x423c81(0x143)]['error'](_0x51d723[_0x423c81(0x165)]),_0x2ac614(_0x51d723),_0x51d723;}}async['sanitizeOptionsForLogging'](_0x1fed2d){const _0x5a973f=_0x3a7a30,_0x1ab833=JSON[_0x5a973f(0x160)](JSON['stringify'](_0x1fed2d));if(_0x1ab833[_0x5a973f(0x168)]&&_0x1ab833[_0x5a973f(0x168)][_0x5a973f(0x151)]){const _0x5b3cb1=_0x1ab833[_0x5a973f(0x168)][_0x5a973f(0x151)];if(_0x5b3cb1[_0x5a973f(0x135)](_0x5a973f(0x176))){const _0x51aa17=_0x5b3cb1[_0x5a973f(0x177)](0x7);_0x51aa17[_0x5a973f(0x13a)]>0xa&&(_0x1ab833[_0x5a973f(0x168)][_0x5a973f(0x151)]=_0x5a973f(0x176)+_0x51aa17[_0x5a973f(0x177)](0x0,0x5)+'****'+_0x51aa17[_0x5a973f(0x177)](-0x4));}}return _0x1ab833[_0x5a973f(0x167)]&&_0x1ab833[_0x5a973f(0x167)]['messages']&&Array[_0x5a973f(0x133)](_0x1ab833[_0x5a973f(0x167)][_0x5a973f(0x15f)])&&(_0x1ab833[_0x5a973f(0x167)][_0x5a973f(0x15f)]=_0x1ab833[_0x5a973f(0x167)]['messages']['map'](_0x1bc293=>{const _0x57c86f=_0x5a973f;return _0x1bc293[_0x57c86f(0x147)]&&Array[_0x57c86f(0x133)](_0x1bc293['content'])&&(_0x1bc293[_0x57c86f(0x147)]=_0x1bc293[_0x57c86f(0x147)][_0x57c86f(0x138)](_0x15ab09=>{const _0x1f7c9a=_0x57c86f;return _0x15ab09[_0x1f7c9a(0x146)]===_0x1f7c9a(0x12d)&&_0x15ab09[_0x1f7c9a(0x12d)]&&_0x15ab09[_0x1f7c9a(0x12d)][_0x1f7c9a(0x16c)]&&(_0x15ab09[_0x1f7c9a(0x12d)]['url']=_0x1f7c9a(0x157)),_0x15ab09;})),_0x1bc293;})),_0x1ab833;}async['chatFree'](_0x3ad655,_0x3929b0,_0x216b6d){const _0x2cc956=_0x3a7a30,{openaiBaseUrl:openaiBaseUrl='',openaiBaseKey:openaiBaseKey='',openaiBaseModel:_0x27feb0}=await this[_0x2cc956(0x16f)][_0x2cc956(0x166)]([_0x2cc956(0x14a),_0x2cc956(0x153),_0x2cc956(0x150)]),_0x182799=openaiBaseKey,_0x54e542=openaiBaseUrl;let _0x3af745=[];_0x3929b0&&_0x3af745[_0x2cc956(0x13b)]({'role':_0x2cc956(0x15e),'content':_0x3929b0});_0x216b6d&&_0x216b6d[_0x2cc956(0x13a)]>0x0?_0x3af745=_0x3af745['concat'](_0x216b6d):_0x3af745['push']({'role':_0x2cc956(0x164),'content':_0x3ad655});const _0x24f855={'method':_0x2cc956(0x169),'url':_0x54e542+_0x2cc956(0x16d),'headers':{'Content-Type':_0x2cc956(0x156),'Authorization':_0x2cc956(0x176)+_0x182799},'data':{'model':_0x27feb0||_0x2cc956(0x142),'messages':_0x3af745}};try{const _0x2c455c=await(0x0,axios_1[_0x2cc956(0x13f)])(_0x24f855);return common_1['Logger'][_0x2cc956(0x131)](_0x2cc956(0x155)+(_0x2c455c===null||_0x2c455c===void 0x0?void 0x0:_0x2c455c[_0x2cc956(0x167)][_0x2cc956(0x145)][0x0]['message'][_0x2cc956(0x147)]),_0x2cc956(0x17a)),_0x2c455c===null||_0x2c455c===void 0x0?void 0x0:_0x2c455c[_0x2cc956(0x167)]['choices'][0x0][_0x2cc956(0x15b)][_0x2cc956(0x147)];}catch(_0x7965e0){console[_0x2cc956(0x131)](_0x2cc956(0x140),_0x7965e0);}}};function _0x5cae(_0x5ec10d,_0x4e2a41){const _0x11680c=_0x1168();return _0x5cae=function(_0x5caece,_0x3debac){_0x5caece=_0x5caece-0x12d;let _0x22ca01=_0x11680c[_0x5caece];return _0x22ca01;},_0x5cae(_0x5ec10d,_0x4e2a41);}OpenAIChatService=__decorate([(0x0,common_1[_0x3a7a30(0x134)])(),__metadata(_0x3a7a30(0x171),[globalConfig_service_1[_0x3a7a30(0x139)]])],OpenAIChatService),exports[_0x3a7a30(0x13e)]=OpenAIChatService;