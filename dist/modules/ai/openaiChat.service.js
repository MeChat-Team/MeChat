'use strict';const _0x4633e0=_0x464e;(function(_0x3fb770,_0x4f0794){const _0x16a492=_0x464e,_0x510f53=_0x3fb770();while(!![]){try{const _0x37ef87=parseInt(_0x16a492(0x106))/0x1*(-parseInt(_0x16a492(0x12f))/0x2)+-parseInt(_0x16a492(0x120))/0x3+parseInt(_0x16a492(0x10d))/0x4*(-parseInt(_0x16a492(0x13f))/0x5)+-parseInt(_0x16a492(0xfd))/0x6+parseInt(_0x16a492(0x10f))/0x7*(parseInt(_0x16a492(0x111))/0x8)+parseInt(_0x16a492(0x13c))/0x9+-parseInt(_0x16a492(0x10b))/0xa*(-parseInt(_0x16a492(0x134))/0xb);if(_0x37ef87===_0x4f0794)break;else _0x510f53['push'](_0x510f53['shift']());}catch(_0x379688){_0x510f53['push'](_0x510f53['shift']());}}}(_0x220b,0xaf060));var __decorate=this&&this[_0x4633e0(0x122)]||function(_0x538490,_0x1c9e50,_0x29bff4,_0x32ab90){const _0x16ecda=_0x4633e0;var _0xf0c946=arguments[_0x16ecda(0x12c)],_0x57491d=_0xf0c946<0x3?_0x1c9e50:_0x32ab90===null?_0x32ab90=Object[_0x16ecda(0x127)](_0x1c9e50,_0x29bff4):_0x32ab90,_0x255ae5;if(typeof Reflect===_0x16ecda(0x101)&&typeof Reflect['decorate']==='function')_0x57491d=Reflect['decorate'](_0x538490,_0x1c9e50,_0x29bff4,_0x32ab90);else{for(var _0x310170=_0x538490[_0x16ecda(0x12c)]-0x1;_0x310170>=0x0;_0x310170--)if(_0x255ae5=_0x538490[_0x310170])_0x57491d=(_0xf0c946<0x3?_0x255ae5(_0x57491d):_0xf0c946>0x3?_0x255ae5(_0x1c9e50,_0x29bff4,_0x57491d):_0x255ae5(_0x1c9e50,_0x29bff4))||_0x57491d;}return _0xf0c946>0x3&&_0x57491d&&Object[_0x16ecda(0x130)](_0x1c9e50,_0x29bff4,_0x57491d),_0x57491d;},__metadata=this&&this[_0x4633e0(0x11a)]||function(_0x5d19b9,_0x306f2e){const _0x568166=_0x4633e0;if(typeof Reflect===_0x568166(0x101)&&typeof Reflect[_0x568166(0x11f)]===_0x568166(0xf3))return Reflect[_0x568166(0x11f)](_0x5d19b9,_0x306f2e);};Object[_0x4633e0(0x130)](exports,_0x4633e0(0x141),{'value':!![]}),exports[_0x4633e0(0xfb)]=void 0x0;const utils_1=require(_0x4633e0(0x118)),common_1=require(_0x4633e0(0x10c)),axios_1=require(_0x4633e0(0x12e)),globalConfig_service_1=require(_0x4633e0(0x124));let OpenAIChatService=class OpenAIChatService{constructor(_0x2ef1cd){const _0x538583=_0x4633e0;this[_0x538583(0x115)]=_0x2ef1cd;}async[_0x4633e0(0xf8)](_0xafd4d7,_0x6598dd){const _0xb19f5f=_0x4633e0,{onFailure:_0x3652fd,onProgress:_0x4592d0,apiKey:_0x4641eb,model:_0x5a2eb1,proxyUrl:_0x1c0b12,modelName:_0x5a3aff,timeout:_0xf1612b,chatId:_0x3c65bf,isFileUpload:_0x5ce26f,modelAvatar:_0x5e0019,temperature:_0x54993b,abortController:_0x19a363}=_0x6598dd;let _0x14de32={'text':'','model':'','modelName':_0x5a3aff,'chatId':_0x3c65bf,'answer':'','errMsg':'','modelAvatar':_0x5e0019};const _0x9f7ec9=Object[_0xb19f5f(0x116)]({'model':_0x5a2eb1,'messages':_0xafd4d7},_0x5ce26f===0x2&&{'max_tokens':0x800});_0x9f7ec9['stream']=!![],_0x9f7ec9['temperature']=_0x54993b;const _0x1aa297={'method':_0xb19f5f(0x13e),'url':_0x1c0b12+'/v1/chat/completions','responseType':_0xb19f5f(0x13b),'timeout':_0xf1612b,'headers':{'Content-Type':'application/json','Authorization':_0xb19f5f(0x103)+_0x4641eb},'data':_0x9f7ec9},_0x35cf3d=await this['sanitizeOptionsForLogging'](_0x1aa297);console[_0xb19f5f(0xfc)]('请求配置:',JSON['stringify'](_0x35cf3d,null,0x2),'ChatService'),console[_0xb19f5f(0xfc)](_0xb19f5f(0x12d),JSON[_0xb19f5f(0x135)](_0x35cf3d,null,0x2),'ChatService');try{const _0xc1a9ba=await(0x0,axios_1[_0xb19f5f(0xf4)])(_0x1aa297),_0x1a3159=_0xc1a9ba[_0xb19f5f(0xf9)];let _0x1fee6a='';return await new Promise((_0x268caf,_0x165d6d)=>{const _0x357deb=_0xb19f5f;_0x1a3159['on'](_0x357deb(0xf9),_0x162342=>{const _0x52da47=_0x357deb;_0x1fee6a+=_0x162342[_0x52da47(0x119)]();let _0x38f972=_0x1fee6a[_0x52da47(0x128)]('\x0a');_0x1fee6a=_0x38f972[_0x52da47(0x108)](),_0x38f972[_0x52da47(0x12a)](_0xe43a0d=>{const _0x531271=_0x52da47;var _0xd26d8,_0x3556bf;if(_0xe43a0d[_0x531271(0x13d)]()===_0x531271(0x100)){console[_0x531271(0xfc)](_0x531271(0x102)),_0x268caf(_0x14de32);return;}if(_0xe43a0d[_0x531271(0x105)](_0x531271(0x131)))try{const _0x1f7958=_0xe43a0d[_0x531271(0x142)](0x6)[_0x531271(0x13d)]();if(_0x1f7958){const _0x140f85=JSON[_0x531271(0x126)](_0x1f7958),_0x5f27a3=((_0x3556bf=(_0xd26d8=_0x140f85[_0x531271(0x129)][0x0])===null||_0xd26d8===void 0x0?void 0x0:_0xd26d8['delta'])===null||_0x3556bf===void 0x0?void 0x0:_0x3556bf[_0x531271(0x114)])||'';_0x14de32['answer']+=_0x5f27a3,_0x4592d0===null||_0x4592d0===void 0x0?void 0x0:_0x4592d0({'text':_0x5f27a3,'answer':_0x14de32[_0x531271(0x138)]});}}catch(_0x5a9607){console['error'](_0x531271(0x113),_0xe43a0d,_0x5a9607);}});}),_0x1a3159['on']('end',()=>{_0x268caf(_0x14de32);}),_0x1a3159['on'](_0x357deb(0x11c),_0x28e78e=>{_0x165d6d(_0x28e78e);}),_0x19a363['signal'][_0x357deb(0x121)](_0x357deb(0xf2),()=>{_0x268caf(_0x14de32);});}),_0x14de32;}catch(_0x273757){return _0x14de32[_0xb19f5f(0x12b)]=(0x0,utils_1[_0xb19f5f(0xfa)])(_0x273757),common_1[_0xb19f5f(0x132)]['error'](_0x14de32['errMsg']),_0x3652fd(_0x14de32),_0x14de32;}}async[_0x4633e0(0x11b)](_0x91ea66){const _0x883c02=_0x4633e0,_0x2796d5=JSON['parse'](JSON['stringify'](_0x91ea66));if(_0x2796d5['headers']&&_0x2796d5[_0x883c02(0x117)][_0x883c02(0xf5)]){const _0x46224a=_0x2796d5[_0x883c02(0x117)][_0x883c02(0xf5)];if(_0x46224a['startsWith'](_0x883c02(0x103))){const _0x2a377d=_0x46224a[_0x883c02(0x142)](0x7);_0x2a377d[_0x883c02(0x12c)]>0xa&&(_0x2796d5[_0x883c02(0x117)][_0x883c02(0xf5)]=_0x883c02(0x103)+_0x2a377d[_0x883c02(0x142)](0x0,0x5)+'****'+_0x2a377d[_0x883c02(0x142)](-0x4));}}return _0x2796d5[_0x883c02(0xf9)]&&_0x2796d5['data']['messages']&&Array[_0x883c02(0x10a)](_0x2796d5[_0x883c02(0xf9)][_0x883c02(0x125)])&&(_0x2796d5[_0x883c02(0xf9)][_0x883c02(0x125)]=_0x2796d5[_0x883c02(0xf9)][_0x883c02(0x125)][_0x883c02(0x133)](_0x1605fe=>{const _0x4a5d79=_0x883c02;return _0x1605fe[_0x4a5d79(0x114)]&&Array['isArray'](_0x1605fe['content'])&&(_0x1605fe[_0x4a5d79(0x114)]=_0x1605fe['content']['map'](_0x121186=>{const _0x415081=_0x4a5d79;return _0x121186[_0x415081(0xfe)]===_0x415081(0x13a)&&_0x121186[_0x415081(0x13a)]&&_0x121186[_0x415081(0x13a)][_0x415081(0xff)]&&(_0x121186['image_url'][_0x415081(0xff)]='data:image/***;base64\x20...\x20...'),_0x121186;})),_0x1605fe;})),_0x2796d5;}async[_0x4633e0(0x112)](_0x541676,_0x4e498a,_0x3e29fb){const _0x3401ee=_0x4633e0,{openaiBaseUrl:openaiBaseUrl='',openaiBaseKey:openaiBaseKey='',openaiBaseModel:_0x2ffd0f}=await this[_0x3401ee(0x115)][_0x3401ee(0x110)]([_0x3401ee(0x140),'openaiBaseUrl',_0x3401ee(0x104)]),_0x3c7c03=openaiBaseKey,_0x445d76=openaiBaseUrl;let _0x359512=[];_0x4e498a&&_0x359512[_0x3401ee(0x123)]({'role':_0x3401ee(0x10e),'content':_0x4e498a});_0x3e29fb&&_0x3e29fb[_0x3401ee(0x12c)]>0x0?_0x359512=_0x359512[_0x3401ee(0x136)](_0x3e29fb):_0x359512['push']({'role':_0x3401ee(0x137),'content':_0x541676});const _0x1b2674={'method':_0x3401ee(0x13e),'url':_0x445d76+_0x3401ee(0xf7),'headers':{'Content-Type':_0x3401ee(0xf6),'Authorization':'Bearer\x20'+_0x3c7c03},'data':{'model':_0x2ffd0f||_0x3401ee(0x139),'messages':_0x359512}};try{const _0x5ce6e6=await(0x0,axios_1[_0x3401ee(0xf4)])(_0x1b2674);return common_1[_0x3401ee(0x132)][_0x3401ee(0xfc)]('全局模型调用成功,\x20返回结果:\x20'+(_0x5ce6e6===null||_0x5ce6e6===void 0x0?void 0x0:_0x5ce6e6['data'][_0x3401ee(0x129)][0x0][_0x3401ee(0x109)][_0x3401ee(0x114)]),_0x3401ee(0x11d)),_0x5ce6e6===null||_0x5ce6e6===void 0x0?void 0x0:_0x5ce6e6[_0x3401ee(0xf9)][_0x3401ee(0x129)][0x0][_0x3401ee(0x109)][_0x3401ee(0x114)];}catch(_0x202f34){console[_0x3401ee(0xfc)]('error:\x20',_0x202f34);}}};function _0x464e(_0x5d36f6,_0xfe63f2){const _0x220baa=_0x220b();return _0x464e=function(_0x464e71,_0x40b771){_0x464e71=_0x464e71-0xf2;let _0x5dd79e=_0x220baa[_0x464e71];return _0x5dd79e;},_0x464e(_0x5d36f6,_0xfe63f2);}OpenAIChatService=__decorate([(0x0,common_1[_0x4633e0(0x107)])(),__metadata(_0x4633e0(0x11e),[globalConfig_service_1['GlobalConfigService']])],OpenAIChatService),exports[_0x4633e0(0xfb)]=OpenAIChatService;function _0x220b(){const _0x35a0ca=['sanitizeOptionsForLogging','error','ChatService','design:paramtypes','metadata','790266KTZXij','addEventListener','__decorate','push','../globalConfig/globalConfig.service','messages','parse','getOwnPropertyDescriptor','split','choices','forEach','errMsg','length','请求配置:','axios','1029298heilGj','defineProperty','data:\x20','Logger','map','2519CVyrua','stringify','concat','user','answer','gpt-3.5-turbo-0125','image_url','stream','10204938WKpcHx','trim','POST','2603145AekgvK','openaiBaseKey','__esModule','slice','abort','function','default','Authorization','application/json','/v1/chat/completions','openAIChat','data','handleError','OpenAIChatService','log','5633682LnTmBj','type','url','data:\x20[DONE]','object','处理结束信号\x20[DONE]','Bearer\x20','openaiBaseModel','startsWith','1GfaFlZ','Injectable','pop','message','isArray','32570Hylygq','@nestjs/common','4rjGfxi','system','3761828LlKcBr','getConfigs','16HLPwZr','chatFree','Error\x20parsing\x20line:','content','globalConfigService','assign','headers','../../common/utils','toString','__metadata'];_0x220b=function(){return _0x35a0ca;};return _0x220b();}