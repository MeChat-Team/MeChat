'use strict';const _0x319608=_0x10d9;(function(_0x14d026,_0x548383){const _0x214e12=_0x10d9,_0x2833e8=_0x14d026();while(!![]){try{const _0x367f9b=parseInt(_0x214e12(0x120))/0x1*(parseInt(_0x214e12(0x156))/0x2)+parseInt(_0x214e12(0x153))/0x3*(parseInt(_0x214e12(0x138))/0x4)+-parseInt(_0x214e12(0x126))/0x5*(parseInt(_0x214e12(0x148))/0x6)+-parseInt(_0x214e12(0x115))/0x7*(parseInt(_0x214e12(0x124))/0x8)+parseInt(_0x214e12(0x117))/0x9*(parseInt(_0x214e12(0x149))/0xa)+-parseInt(_0x214e12(0x122))/0xb+-parseInt(_0x214e12(0x10d))/0xc*(-parseInt(_0x214e12(0x13f))/0xd);if(_0x367f9b===_0x548383)break;else _0x2833e8['push'](_0x2833e8['shift']());}catch(_0x3bb1c0){_0x2833e8['push'](_0x2833e8['shift']());}}}(_0x4653,0xb3670));var __decorate=this&&this[_0x319608(0x118)]||function(_0xba246d,_0x245e60,_0x577990,_0xf467a3){const _0x2c4a47=_0x319608;var _0x1f945b=arguments[_0x2c4a47(0x134)],_0x1bdd7e=_0x1f945b<0x3?_0x245e60:_0xf467a3===null?_0xf467a3=Object[_0x2c4a47(0x12a)](_0x245e60,_0x577990):_0xf467a3,_0x5100fd;if(typeof Reflect===_0x2c4a47(0x15a)&&typeof Reflect[_0x2c4a47(0x13b)]===_0x2c4a47(0x13d))_0x1bdd7e=Reflect['decorate'](_0xba246d,_0x245e60,_0x577990,_0xf467a3);else{for(var _0x3aa556=_0xba246d['length']-0x1;_0x3aa556>=0x0;_0x3aa556--)if(_0x5100fd=_0xba246d[_0x3aa556])_0x1bdd7e=(_0x1f945b<0x3?_0x5100fd(_0x1bdd7e):_0x1f945b>0x3?_0x5100fd(_0x245e60,_0x577990,_0x1bdd7e):_0x5100fd(_0x245e60,_0x577990))||_0x1bdd7e;}return _0x1f945b>0x3&&_0x1bdd7e&&Object[_0x2c4a47(0x144)](_0x245e60,_0x577990,_0x1bdd7e),_0x1bdd7e;},__metadata=this&&this['__metadata']||function(_0x2bef22,_0x4b6acd){const _0x1747d9=_0x319608;if(typeof Reflect==='object'&&typeof Reflect[_0x1747d9(0x12c)]===_0x1747d9(0x13d))return Reflect[_0x1747d9(0x12c)](_0x2bef22,_0x4b6acd);};function _0x10d9(_0x50702b,_0x1d4fa5){const _0x465313=_0x4653();return _0x10d9=function(_0x10d97a,_0x10a57e){_0x10d97a=_0x10d97a-0x10b;let _0x589abd=_0x465313[_0x10d97a];return _0x589abd;},_0x10d9(_0x50702b,_0x1d4fa5);}Object[_0x319608(0x144)](exports,'__esModule',{'value':!![]}),exports[_0x319608(0x11a)]=void 0x0;const utils_1=require(_0x319608(0x145)),common_1=require(_0x319608(0x11b)),axios_1=require('axios'),globalConfig_service_1=require(_0x319608(0x139));let OpenAIChatService=class OpenAIChatService{constructor(_0x5781a4){const _0x2aa062=_0x319608;this[_0x2aa062(0x155)]=_0x5781a4;}async[_0x319608(0x11e)](_0x550d7f,_0xd2905c){const _0x1eda86=_0x319608,{onFailure:_0x50ae10,onProgress:_0x4b989e,apiKey:_0x2eb13a,model:_0x138c3c,proxyUrl:_0x4ef81d,modelName:_0x575d52,timeout:_0x58149f,chatId:_0x1ee31c,isFileUpload:_0x9e8541,modelAvatar:_0x42ba93,temperature:_0x1d2e4c,abortController:_0x2b168c}=_0xd2905c;let _0x36d5f8={'text':'','model':'','modelName':_0x575d52,'chatId':_0x1ee31c,'answer':'','errMsg':'','modelAvatar':_0x42ba93};const _0x400fc1=Object[_0x1eda86(0x140)]({'model':_0x138c3c,'messages':_0x550d7f},_0x9e8541===0x2&&{'max_tokens':0x800});_0x400fc1[_0x1eda86(0x116)]=!![],_0x400fc1['temperature']=_0x1d2e4c;const _0x42da2e={'method':_0x1eda86(0x123),'url':_0x4ef81d+_0x1eda86(0x14c),'responseType':_0x1eda86(0x116),'timeout':_0x58149f,'headers':{'Content-Type':_0x1eda86(0x112),'Authorization':'Bearer\x20'+_0x2eb13a},'data':_0x400fc1},_0x561459=await this[_0x1eda86(0x150)](_0x42da2e);console[_0x1eda86(0x151)](_0x1eda86(0x12f),JSON['stringify'](_0x561459,null,0x2),'ChatService'),console[_0x1eda86(0x151)](_0x1eda86(0x12f),JSON['stringify'](_0x561459,null,0x2),_0x1eda86(0x14f));try{const _0x346615=await(0x0,axios_1[_0x1eda86(0x12d)])(_0x42da2e),_0x45a08a=_0x346615['data'];let _0x24a37a='';return await new Promise((_0x51afc6,_0x210cce)=>{const _0x3ecef8=_0x1eda86;_0x45a08a['on'](_0x3ecef8(0x10e),_0x262675=>{const _0x2474ae=_0x3ecef8;_0x24a37a+=_0x262675[_0x2474ae(0x133)]();let _0x1bd33c=_0x24a37a[_0x2474ae(0x125)]('\x0a');_0x24a37a=_0x1bd33c['pop'](),_0x1bd33c[_0x2474ae(0x14a)](_0x5abb47=>{const _0x7362e6=_0x2474ae;var _0x4d25cf,_0xdd2fe4;if(_0x5abb47[_0x7362e6(0x111)]()===_0x7362e6(0x157)){console['log'](_0x7362e6(0x114)),_0x51afc6(_0x36d5f8);return;}if(_0x5abb47[_0x7362e6(0x146)](_0x7362e6(0x158)))try{const _0x4a602a=_0x5abb47[_0x7362e6(0x13a)](0x6)[_0x7362e6(0x111)]();if(_0x4a602a){const _0x566abf=JSON[_0x7362e6(0x110)](_0x4a602a),_0x15a45d=((_0xdd2fe4=(_0x4d25cf=_0x566abf[_0x7362e6(0x152)][0x0])===null||_0x4d25cf===void 0x0?void 0x0:_0x4d25cf[_0x7362e6(0x119)])===null||_0xdd2fe4===void 0x0?void 0x0:_0xdd2fe4[_0x7362e6(0x135)])||'';_0x36d5f8[_0x7362e6(0x141)]+=_0x15a45d,_0x4b989e===null||_0x4b989e===void 0x0?void 0x0:_0x4b989e({'text':_0x15a45d,'answer':_0x36d5f8[_0x7362e6(0x141)]});}}catch(_0x462d34){console[_0x7362e6(0x128)](_0x7362e6(0x132),_0x5abb47,_0x462d34);}});}),_0x45a08a['on'](_0x3ecef8(0x137),()=>{_0x51afc6(_0x36d5f8);}),_0x45a08a['on']('error',_0x2061ec=>{_0x210cce(_0x2061ec);}),_0x2b168c['signal']['addEventListener'](_0x3ecef8(0x131),()=>{_0x51afc6(_0x36d5f8);});}),_0x36d5f8;}catch(_0x2c250c){return _0x36d5f8[_0x1eda86(0x147)]=(0x0,utils_1[_0x1eda86(0x13e)])(_0x2c250c),common_1[_0x1eda86(0x12b)][_0x1eda86(0x128)](_0x36d5f8['errMsg']),_0x50ae10(_0x36d5f8),_0x36d5f8;}}async[_0x319608(0x150)](_0x4e9cf3){const _0x225f0d=_0x319608,_0x231066=JSON[_0x225f0d(0x110)](JSON['stringify'](_0x4e9cf3));if(_0x231066['headers']&&_0x231066['headers'][_0x225f0d(0x14e)]){const _0x5a8582=_0x231066['headers'][_0x225f0d(0x14e)];if(_0x5a8582['startsWith'](_0x225f0d(0x113))){const _0x540a69=_0x5a8582[_0x225f0d(0x13a)](0x7);_0x540a69['length']>0xa&&(_0x231066[_0x225f0d(0x121)][_0x225f0d(0x14e)]=_0x225f0d(0x113)+_0x540a69[_0x225f0d(0x13a)](0x0,0x5)+_0x225f0d(0x11c)+_0x540a69[_0x225f0d(0x13a)](-0x4));}}return _0x231066['data']&&_0x231066['data'][_0x225f0d(0x154)]&&Array['isArray'](_0x231066[_0x225f0d(0x10e)][_0x225f0d(0x154)])&&(_0x231066[_0x225f0d(0x10e)][_0x225f0d(0x154)]=_0x231066[_0x225f0d(0x10e)][_0x225f0d(0x154)]['map'](_0x5df938=>{const _0x228257=_0x225f0d;return _0x5df938[_0x228257(0x135)]&&Array[_0x228257(0x11d)](_0x5df938['content'])&&(_0x5df938['content']=_0x5df938['content']['map'](_0x235ca9=>{const _0x49ac04=_0x228257;return _0x235ca9[_0x49ac04(0x159)]===_0x49ac04(0x13c)&&_0x235ca9[_0x49ac04(0x13c)]&&_0x235ca9[_0x49ac04(0x13c)]['url']&&(_0x235ca9[_0x49ac04(0x13c)][_0x49ac04(0x14d)]=_0x49ac04(0x136)),_0x235ca9;})),_0x5df938;})),_0x231066;}async[_0x319608(0x142)](_0x113f6d,_0x5c6a06,_0x2bc474){const _0x27a668=_0x319608,{openaiBaseUrl:openaiBaseUrl='',openaiBaseKey:openaiBaseKey='',openaiBaseModel:_0x1c2792}=await this[_0x27a668(0x155)][_0x27a668(0x130)](['openaiBaseKey','openaiBaseUrl',_0x27a668(0x12e)]),_0x4c4e6e=openaiBaseKey,_0x32cc4d=openaiBaseUrl;let _0x121585=[];_0x5c6a06&&_0x121585['push']({'role':_0x27a668(0x14b),'content':_0x5c6a06});_0x2bc474&&_0x2bc474['length']>0x0?_0x121585=_0x121585[_0x27a668(0x10f)](_0x2bc474):_0x121585[_0x27a668(0x143)]({'role':_0x27a668(0x10c),'content':_0x113f6d});const _0x12d0e3={'method':_0x27a668(0x123),'url':_0x32cc4d+_0x27a668(0x14c),'headers':{'Content-Type':_0x27a668(0x112),'Authorization':'Bearer\x20'+_0x4c4e6e},'data':{'model':_0x1c2792||'gpt-3.5-turbo-0125','messages':_0x121585}};try{const _0x430cb1=await(0x0,axios_1[_0x27a668(0x12d)])(_0x12d0e3);return common_1[_0x27a668(0x12b)][_0x27a668(0x151)]('全局模型调用成功,\x20返回结果:\x20'+(_0x430cb1===null||_0x430cb1===void 0x0?void 0x0:_0x430cb1[_0x27a668(0x10e)]['choices'][0x0]['message'][_0x27a668(0x135)]),_0x27a668(0x14f)),_0x430cb1===null||_0x430cb1===void 0x0?void 0x0:_0x430cb1[_0x27a668(0x10e)][_0x27a668(0x152)][0x0][_0x27a668(0x10b)][_0x27a668(0x135)];}catch(_0x3866f6){console[_0x27a668(0x151)](_0x27a668(0x127),_0x3866f6);}}};OpenAIChatService=__decorate([(0x0,common_1['Injectable'])(),__metadata(_0x319608(0x11f),[globalConfig_service_1[_0x319608(0x129)]])],OpenAIChatService),exports['OpenAIChatService']=OpenAIChatService;function _0x4653(){const _0x3ffd3e=['forEach','system','/v1/chat/completions','url','Authorization','ChatService','sanitizeOptionsForLogging','log','choices','6AMGQYK','messages','globalConfigService','186tGotYQ','data:\x20[DONE]','data:\x20','type','object','message','user','2568ZPaZBR','data','concat','parse','trim','application/json','Bearer\x20','处理结束信号\x20[DONE]','8099462qYgiya','stream','12933423qvjIBt','__decorate','delta','OpenAIChatService','@nestjs/common','****','isArray','openAIChat','design:paramtypes','1105eagjAQ','headers','11256135wLOnIE','POST','8EOVnZI','split','55ybXBao','error:\x20','error','GlobalConfigService','getOwnPropertyDescriptor','Logger','metadata','default','openaiBaseModel','请求配置:','getConfigs','abort','Error\x20parsing\x20line:','toString','length','content','data:image/***;base64\x20...\x20...','end','285700TafKcg','../globalConfig/globalConfig.service','slice','decorate','image_url','function','handleError','140322nXoTUY','assign','answer','chatFree','push','defineProperty','../../common/utils','startsWith','errMsg','587670zmlGmX','10JqLGTq'];_0x4653=function(){return _0x3ffd3e;};return _0x4653();}