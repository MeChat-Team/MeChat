'use strict';const _0x123e30=_0x3cda;function _0x512e(){const _0x48a47d=['system','data','37613376jqaKEq','type','addEventListener','function','headers','ChatService','3ESSgnb','delta','5ResIFR','concat','168NhWqTn','sanitizeOptionsForLogging','length','__decorate','assign','@nestjs/common','__metadata','default','OpenAIChatService','image_url','error','error:\x20','Error\x20parsing\x20line:','4369800NMmeGC','Authorization','stringify','messages','split','user','请求配置:','Bearer\x20','map','temperature','data:\x20','answer','11570283vuUZso','choices','openaiBaseModel','openaiBaseUrl','getOwnPropertyDescriptor','3289KJXijR','gpt-3.5-turbo-0125','url','openaiBaseKey','handleError','log','/v1/chat/completions','message','1195052Rrdtsk','****','abort','object','globalConfigService','push','content','slice','处理结束信号\x20[DONE]','decorate','POST','168049xirXWG','application/json','全局模型调用成功,\x20返回结果:\x20','data:image/***;base64\x20...\x20...','metadata','47843KIjghz','18zudVbg','toString','startsWith','parse','defineProperty','trim','design:paramtypes','GlobalConfigService','errMsg','22400dUdBdt','data:\x20[DONE]','openAIChat','Logger'];_0x512e=function(){return _0x48a47d;};return _0x512e();}(function(_0x549b7f,_0x1cb514){const _0x30e94f=_0x3cda,_0x281716=_0x549b7f();while(!![]){try{const _0x1d2a2b=-parseInt(_0x30e94f(0x162))/0x1*(-parseInt(_0x30e94f(0x163))/0x2)+parseInt(_0x30e94f(0x178))/0x3*(parseInt(_0x30e94f(0x152))/0x4)+-parseInt(_0x30e94f(0x12a))/0x5*(parseInt(_0x30e94f(0x139))/0x6)+-parseInt(_0x30e94f(0x15d))/0x7*(parseInt(_0x30e94f(0x12c))/0x8)+-parseInt(_0x30e94f(0x145))/0x9+-parseInt(_0x30e94f(0x16c))/0xa*(parseInt(_0x30e94f(0x14a))/0xb)+parseInt(_0x30e94f(0x172))/0xc;if(_0x1d2a2b===_0x1cb514)break;else _0x281716['push'](_0x281716['shift']());}catch(_0x392689){_0x281716['push'](_0x281716['shift']());}}}(_0x512e,0xa50a4));var __decorate=this&&this[_0x123e30(0x12f)]||function(_0x5f081a,_0x3bf09c,_0x497454,_0x4813af){const _0x4d1069=_0x123e30;var _0x20f341=arguments[_0x4d1069(0x12e)],_0x4dbbae=_0x20f341<0x3?_0x3bf09c:_0x4813af===null?_0x4813af=Object[_0x4d1069(0x149)](_0x3bf09c,_0x497454):_0x4813af,_0x87c487;if(typeof Reflect===_0x4d1069(0x155)&&typeof Reflect[_0x4d1069(0x15b)]===_0x4d1069(0x175))_0x4dbbae=Reflect[_0x4d1069(0x15b)](_0x5f081a,_0x3bf09c,_0x497454,_0x4813af);else{for(var _0x508e89=_0x5f081a[_0x4d1069(0x12e)]-0x1;_0x508e89>=0x0;_0x508e89--)if(_0x87c487=_0x5f081a[_0x508e89])_0x4dbbae=(_0x20f341<0x3?_0x87c487(_0x4dbbae):_0x20f341>0x3?_0x87c487(_0x3bf09c,_0x497454,_0x4dbbae):_0x87c487(_0x3bf09c,_0x497454))||_0x4dbbae;}return _0x20f341>0x3&&_0x4dbbae&&Object[_0x4d1069(0x167)](_0x3bf09c,_0x497454,_0x4dbbae),_0x4dbbae;},__metadata=this&&this[_0x123e30(0x132)]||function(_0x4f3d7e,_0x1a7104){const _0x1c3d19=_0x123e30;if(typeof Reflect===_0x1c3d19(0x155)&&typeof Reflect[_0x1c3d19(0x161)]===_0x1c3d19(0x175))return Reflect[_0x1c3d19(0x161)](_0x4f3d7e,_0x1a7104);};Object[_0x123e30(0x167)](exports,'__esModule',{'value':!![]}),exports[_0x123e30(0x134)]=void 0x0;function _0x3cda(_0x338e9d,_0x1fb908){const _0x512e11=_0x512e();return _0x3cda=function(_0x3cdaeb,_0x59a902){_0x3cdaeb=_0x3cdaeb-0x12a;let _0x45b0e6=_0x512e11[_0x3cdaeb];return _0x45b0e6;},_0x3cda(_0x338e9d,_0x1fb908);}const utils_1=require('../../common/utils'),common_1=require(_0x123e30(0x131)),axios_1=require('axios'),globalConfig_service_1=require('../globalConfig/globalConfig.service');let OpenAIChatService=class OpenAIChatService{constructor(_0xa38796){const _0xcbf353=_0x123e30;this[_0xcbf353(0x156)]=_0xa38796;}async[_0x123e30(0x16e)](_0x25bf5f,_0xddf5ed){const _0x186e91=_0x123e30,{onFailure:_0x2007bd,onProgress:_0x462d2e,apiKey:_0x21de0c,model:_0x3fc135,proxyUrl:_0x24ecc6,modelName:_0x1043c7,timeout:_0x105f71,chatId:_0x4239eb,isFileUpload:_0x14e097,modelAvatar:_0x3643e4,temperature:_0xc101e1,abortController:_0x99b596}=_0xddf5ed;let _0x572e4d={'text':'','model':'','modelName':_0x1043c7,'chatId':_0x4239eb,'answer':'','errMsg':'','modelAvatar':_0x3643e4};const _0x9acf21=Object[_0x186e91(0x130)]({'model':_0x3fc135,'messages':_0x25bf5f},_0x14e097===0x2&&{'max_tokens':0x800});_0x9acf21['stream']=!![],_0x9acf21[_0x186e91(0x142)]=_0xc101e1;const _0x2c6e50={'method':_0x186e91(0x15c),'url':_0x24ecc6+_0x186e91(0x150),'responseType':'stream','timeout':_0x105f71,'headers':{'Content-Type':'application/json','Authorization':_0x186e91(0x140)+_0x21de0c},'data':_0x9acf21},_0xc49fb2=await this[_0x186e91(0x12d)](_0x2c6e50);console[_0x186e91(0x14f)](_0x186e91(0x13f),JSON[_0x186e91(0x13b)](_0xc49fb2,null,0x2),'ChatService'),console['log'](_0x186e91(0x13f),JSON[_0x186e91(0x13b)](_0xc49fb2,null,0x2),'ChatService');try{const _0x120ae4=await(0x0,axios_1['default'])(_0x2c6e50),_0x929022=_0x120ae4[_0x186e91(0x171)];let _0x514e14='';return await new Promise((_0x420919,_0x1e4287)=>{const _0x1f62bd=_0x186e91;_0x929022['on']('data',_0x32b60d=>{const _0x10121e=_0x3cda;_0x514e14+=_0x32b60d[_0x10121e(0x164)]();let _0x29b0dc=_0x514e14[_0x10121e(0x13d)]('\x0a');_0x514e14=_0x29b0dc['pop'](),_0x29b0dc['forEach'](_0x3c3c5d=>{const _0xb328a3=_0x10121e;var _0x3cc99c,_0x2efc2e;if(_0x3c3c5d[_0xb328a3(0x168)]()===_0xb328a3(0x16d)){console[_0xb328a3(0x14f)](_0xb328a3(0x15a)),_0x420919(_0x572e4d);return;}if(_0x3c3c5d[_0xb328a3(0x165)](_0xb328a3(0x143)))try{const _0x36e3cc=_0x3c3c5d[_0xb328a3(0x159)](0x6)[_0xb328a3(0x168)]();if(_0x36e3cc){const _0x3aa28e=JSON[_0xb328a3(0x166)](_0x36e3cc),_0x18a2af=((_0x2efc2e=(_0x3cc99c=_0x3aa28e[_0xb328a3(0x146)][0x0])===null||_0x3cc99c===void 0x0?void 0x0:_0x3cc99c[_0xb328a3(0x179)])===null||_0x2efc2e===void 0x0?void 0x0:_0x2efc2e[_0xb328a3(0x158)])||'';_0x572e4d[_0xb328a3(0x144)]+=_0x18a2af,_0x462d2e===null||_0x462d2e===void 0x0?void 0x0:_0x462d2e({'text':_0x18a2af,'answer':_0x572e4d[_0xb328a3(0x144)]});}}catch(_0x5e6215){console[_0xb328a3(0x136)](_0xb328a3(0x138),_0x3c3c5d,_0x5e6215);}});}),_0x929022['on']('end',()=>{_0x420919(_0x572e4d);}),_0x929022['on']('error',_0x5e7052=>{_0x1e4287(_0x5e7052);}),_0x99b596['signal'][_0x1f62bd(0x174)](_0x1f62bd(0x154),()=>{_0x420919(_0x572e4d);});}),_0x572e4d;}catch(_0xadff48){return _0x572e4d[_0x186e91(0x16b)]=(0x0,utils_1[_0x186e91(0x14e)])(_0xadff48),common_1[_0x186e91(0x16f)]['error'](_0x572e4d['errMsg']),_0x2007bd(_0x572e4d),_0x572e4d;}}async[_0x123e30(0x12d)](_0x7ad978){const _0x5eeefb=_0x123e30,_0x584044=JSON['parse'](JSON['stringify'](_0x7ad978));if(_0x584044[_0x5eeefb(0x176)]&&_0x584044[_0x5eeefb(0x176)][_0x5eeefb(0x13a)]){const _0x6889ee=_0x584044[_0x5eeefb(0x176)][_0x5eeefb(0x13a)];if(_0x6889ee['startsWith']('Bearer\x20')){const _0x3cce8a=_0x6889ee['slice'](0x7);_0x3cce8a[_0x5eeefb(0x12e)]>0xa&&(_0x584044[_0x5eeefb(0x176)][_0x5eeefb(0x13a)]=_0x5eeefb(0x140)+_0x3cce8a['slice'](0x0,0x5)+_0x5eeefb(0x153)+_0x3cce8a[_0x5eeefb(0x159)](-0x4));}}return _0x584044[_0x5eeefb(0x171)]&&_0x584044['data'][_0x5eeefb(0x13c)]&&Array['isArray'](_0x584044[_0x5eeefb(0x171)]['messages'])&&(_0x584044[_0x5eeefb(0x171)][_0x5eeefb(0x13c)]=_0x584044[_0x5eeefb(0x171)]['messages'][_0x5eeefb(0x141)](_0x2f8fea=>{const _0x1a1b12=_0x5eeefb;return _0x2f8fea[_0x1a1b12(0x158)]&&Array['isArray'](_0x2f8fea[_0x1a1b12(0x158)])&&(_0x2f8fea[_0x1a1b12(0x158)]=_0x2f8fea[_0x1a1b12(0x158)][_0x1a1b12(0x141)](_0xd33ee8=>{const _0x50c460=_0x1a1b12;return _0xd33ee8[_0x50c460(0x173)]===_0x50c460(0x135)&&_0xd33ee8['image_url']&&_0xd33ee8[_0x50c460(0x135)]['url']&&(_0xd33ee8[_0x50c460(0x135)][_0x50c460(0x14c)]=_0x50c460(0x160)),_0xd33ee8;})),_0x2f8fea;})),_0x584044;}async['chatFree'](_0x2fa169,_0x452897,_0x4f1b79){const _0x4cd3a3=_0x123e30,{openaiBaseUrl:openaiBaseUrl='',openaiBaseKey:openaiBaseKey='',openaiBaseModel:_0x3ef5e1}=await this['globalConfigService']['getConfigs']([_0x4cd3a3(0x14d),_0x4cd3a3(0x148),_0x4cd3a3(0x147)]),_0x1af0c6=openaiBaseKey,_0x26b2aa=openaiBaseUrl;let _0x15ee54=[];_0x452897&&_0x15ee54[_0x4cd3a3(0x157)]({'role':_0x4cd3a3(0x170),'content':_0x452897});_0x4f1b79&&_0x4f1b79['length']>0x0?_0x15ee54=_0x15ee54[_0x4cd3a3(0x12b)](_0x4f1b79):_0x15ee54[_0x4cd3a3(0x157)]({'role':_0x4cd3a3(0x13e),'content':_0x2fa169});const _0x237872={'method':_0x4cd3a3(0x15c),'url':_0x26b2aa+_0x4cd3a3(0x150),'headers':{'Content-Type':_0x4cd3a3(0x15e),'Authorization':_0x4cd3a3(0x140)+_0x1af0c6},'data':{'model':_0x3ef5e1||_0x4cd3a3(0x14b),'messages':_0x15ee54}};try{const _0x1ddfc1=await(0x0,axios_1[_0x4cd3a3(0x133)])(_0x237872);return common_1[_0x4cd3a3(0x16f)][_0x4cd3a3(0x14f)](_0x4cd3a3(0x15f)+(_0x1ddfc1===null||_0x1ddfc1===void 0x0?void 0x0:_0x1ddfc1[_0x4cd3a3(0x171)][_0x4cd3a3(0x146)][0x0][_0x4cd3a3(0x151)][_0x4cd3a3(0x158)]),_0x4cd3a3(0x177)),_0x1ddfc1===null||_0x1ddfc1===void 0x0?void 0x0:_0x1ddfc1[_0x4cd3a3(0x171)][_0x4cd3a3(0x146)][0x0][_0x4cd3a3(0x151)]['content'];}catch(_0x52db59){console[_0x4cd3a3(0x14f)](_0x4cd3a3(0x137),_0x52db59);}}};OpenAIChatService=__decorate([(0x0,common_1['Injectable'])(),__metadata(_0x123e30(0x169),[globalConfig_service_1[_0x123e30(0x16a)]])],OpenAIChatService),exports[_0x123e30(0x134)]=OpenAIChatService;