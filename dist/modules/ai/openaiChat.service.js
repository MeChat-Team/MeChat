'use strict';const _0x12f36a=_0x5d5e;(function(_0x9efd2c,_0x9b6afb){const _0x2600bd=_0x5d5e,_0xf5d9c7=_0x9efd2c();while(!![]){try{const _0x1eb38b=-parseInt(_0x2600bd(0xe4))/0x1+-parseInt(_0x2600bd(0xf7))/0x2*(-parseInt(_0x2600bd(0xe5))/0x3)+-parseInt(_0x2600bd(0xfb))/0x4*(-parseInt(_0x2600bd(0xfc))/0x5)+-parseInt(_0x2600bd(0xd7))/0x6*(-parseInt(_0x2600bd(0xf3))/0x7)+parseInt(_0x2600bd(0xe0))/0x8*(-parseInt(_0x2600bd(0xba))/0x9)+-parseInt(_0x2600bd(0xb5))/0xa+-parseInt(_0x2600bd(0xd8))/0xb;if(_0x1eb38b===_0x9b6afb)break;else _0xf5d9c7['push'](_0xf5d9c7['shift']());}catch(_0x445963){_0xf5d9c7['push'](_0xf5d9c7['shift']());}}}(_0x2935,0x9dff2));function _0x5d5e(_0x2838b5,_0x2abe4d){const _0x293557=_0x2935();return _0x5d5e=function(_0x5d5e17,_0x5397e1){_0x5d5e17=_0x5d5e17-0xb4;let _0x24594f=_0x293557[_0x5d5e17];return _0x24594f;},_0x5d5e(_0x2838b5,_0x2abe4d);}function _0x2935(){const _0x358fd1=['log','openaiBaseModel','messages','content','axios','image_url','slice','openAIChat','object','end','****','1183VQveON','全局模型调用成功,\x20返回结果:\x20','请求配置:','error:\x20','7394YAWeGb','gpt-3.5-turbo-0125','metadata','headers','4xoAnWu','6175445mAGiVS','data:image/***;base64\x20...\x20...','isArray','forEach','__esModule','pop','2915030peQTvb','error','Bearer\x20','handleError','errMsg','104589Iesbue','ChatService','split','data:\x20','/v1/chat/completions','url','push','Authorization','length','openaiBaseKey','getConfigs','message','default','globalConfigService','defineProperty','addEventListener','OpenAIChatService','Injectable','Logger','map','POST','application/json','choices','sanitizeOptionsForLogging','signal','../globalConfig/globalConfig.service','__decorate','answer','design:paramtypes','19098ajvAfc','8008583rxQtbI','data','decorate','parse','stringify','type','Error\x20parsing\x20line:','GlobalConfigService','200HWkvtr','__metadata','delta','../../common/utils','56086MuBjUu','195VbZVck','toString','stream'];_0x2935=function(){return _0x358fd1;};return _0x2935();}var __decorate=this&&this[_0x12f36a(0xd4)]||function(_0x1bf5c4,_0xd33d09,_0x4c8b7b,_0x2c725e){const _0x902636=_0x12f36a;var _0x3cde71=arguments[_0x902636(0xc2)],_0x17620e=_0x3cde71<0x3?_0xd33d09:_0x2c725e===null?_0x2c725e=Object['getOwnPropertyDescriptor'](_0xd33d09,_0x4c8b7b):_0x2c725e,_0x54efc6;if(typeof Reflect===_0x902636(0xf0)&&typeof Reflect[_0x902636(0xda)]==='function')_0x17620e=Reflect[_0x902636(0xda)](_0x1bf5c4,_0xd33d09,_0x4c8b7b,_0x2c725e);else{for(var _0xe6ad1f=_0x1bf5c4[_0x902636(0xc2)]-0x1;_0xe6ad1f>=0x0;_0xe6ad1f--)if(_0x54efc6=_0x1bf5c4[_0xe6ad1f])_0x17620e=(_0x3cde71<0x3?_0x54efc6(_0x17620e):_0x3cde71>0x3?_0x54efc6(_0xd33d09,_0x4c8b7b,_0x17620e):_0x54efc6(_0xd33d09,_0x4c8b7b))||_0x17620e;}return _0x3cde71>0x3&&_0x17620e&&Object[_0x902636(0xc8)](_0xd33d09,_0x4c8b7b,_0x17620e),_0x17620e;},__metadata=this&&this[_0x12f36a(0xe1)]||function(_0x152e44,_0xa5eea1){const _0x4863b7=_0x12f36a;if(typeof Reflect==='object'&&typeof Reflect[_0x4863b7(0xf9)]==='function')return Reflect['metadata'](_0x152e44,_0xa5eea1);};Object[_0x12f36a(0xc8)](exports,_0x12f36a(0x100),{'value':!![]}),exports[_0x12f36a(0xca)]=void 0x0;const utils_1=require(_0x12f36a(0xe3)),common_1=require('@nestjs/common'),axios_1=require(_0x12f36a(0xec)),globalConfig_service_1=require(_0x12f36a(0xd3));let OpenAIChatService=class OpenAIChatService{constructor(_0x41adbd){const _0x46439f=_0x12f36a;this[_0x46439f(0xc7)]=_0x41adbd;}async[_0x12f36a(0xef)](_0x1c3931,_0x2a1aff){const _0x4e0160=_0x12f36a,{onFailure:_0x2c6c59,onProgress:_0x2294f8,apiKey:_0x174b2c,model:_0x5ca908,proxyUrl:_0x18ee70,modelName:_0x38f4f6,timeout:_0x52a440,chatId:_0x57ad56,isFileUpload:_0x531e62,modelAvatar:_0x437d8f,temperature:_0x4c7f74,abortController:_0x436d82}=_0x2a1aff;let _0x5d1896={'text':'','model':'','modelName':_0x38f4f6,'chatId':_0x57ad56,'answer':'','errMsg':'','modelAvatar':_0x437d8f};const _0x29cb26=Object['assign']({'model':_0x5ca908,'messages':_0x1c3931},_0x531e62===0x2&&{'max_tokens':0x800});_0x29cb26[_0x4e0160(0xe7)]=!![],_0x29cb26['temperature']=_0x4c7f74;const _0x458eb={'method':'POST','url':_0x18ee70+'/v1/chat/completions','responseType':_0x4e0160(0xe7),'timeout':_0x52a440,'headers':{'Content-Type':_0x4e0160(0xcf),'Authorization':_0x4e0160(0xb7)+_0x174b2c},'data':_0x29cb26},_0x1e93dd=await this[_0x4e0160(0xd1)](_0x458eb);console[_0x4e0160(0xe8)](_0x4e0160(0xf5),JSON['stringify'](_0x1e93dd,null,0x2),_0x4e0160(0xbb)),console[_0x4e0160(0xe8)]('请求配置:',JSON['stringify'](_0x1e93dd,null,0x2),_0x4e0160(0xbb));try{const _0x5efccd=await(0x0,axios_1[_0x4e0160(0xc6)])(_0x458eb),_0x2ce764=_0x5efccd['data'];let _0x566873='';return await new Promise((_0x1c88d4,_0x21b839)=>{const _0x18c4aa=_0x4e0160;_0x2ce764['on'](_0x18c4aa(0xd9),_0x277993=>{const _0x402cc2=_0x18c4aa;_0x566873+=_0x277993[_0x402cc2(0xe6)]();let _0x475be1=_0x566873[_0x402cc2(0xbc)]('\x0a');_0x566873=_0x475be1[_0x402cc2(0xb4)](),_0x475be1[_0x402cc2(0xff)](_0x15210c=>{const _0x20b97d=_0x402cc2;var _0xd45004,_0x51800e;if(_0x15210c['trim']()==='data:\x20[DONE]'){console[_0x20b97d(0xe8)]('处理结束信号\x20[DONE]'),_0x1c88d4(_0x5d1896);return;}if(_0x15210c['startsWith'](_0x20b97d(0xbd)))try{const _0x494e58=_0x15210c['slice'](0x6)['trim']();if(_0x494e58){const _0x27ac2f=JSON[_0x20b97d(0xdb)](_0x494e58),_0x2b80ad=((_0x51800e=(_0xd45004=_0x27ac2f[_0x20b97d(0xd0)][0x0])===null||_0xd45004===void 0x0?void 0x0:_0xd45004[_0x20b97d(0xe2)])===null||_0x51800e===void 0x0?void 0x0:_0x51800e[_0x20b97d(0xeb)])||'';_0x5d1896[_0x20b97d(0xd5)]+=_0x2b80ad,_0x2294f8===null||_0x2294f8===void 0x0?void 0x0:_0x2294f8({'text':_0x2b80ad,'answer':_0x5d1896[_0x20b97d(0xd5)]});}}catch(_0x4179e1){console[_0x20b97d(0xb6)](_0x20b97d(0xde),_0x15210c,_0x4179e1);}});}),_0x2ce764['on'](_0x18c4aa(0xf1),()=>{_0x1c88d4(_0x5d1896);}),_0x2ce764['on']('error',_0xf7dbd0=>{_0x21b839(_0xf7dbd0);}),_0x436d82[_0x18c4aa(0xd2)][_0x18c4aa(0xc9)]('abort',()=>{_0x1c88d4(_0x5d1896);});}),_0x5d1896;}catch(_0x591c78){return _0x5d1896[_0x4e0160(0xb9)]=(0x0,utils_1[_0x4e0160(0xb8)])(_0x591c78),common_1[_0x4e0160(0xcc)][_0x4e0160(0xb6)](_0x5d1896[_0x4e0160(0xb9)]),_0x2c6c59(_0x5d1896),_0x5d1896;}}async[_0x12f36a(0xd1)](_0x4c6471){const _0x160ab8=_0x12f36a,_0x550db7=JSON[_0x160ab8(0xdb)](JSON[_0x160ab8(0xdc)](_0x4c6471));if(_0x550db7[_0x160ab8(0xfa)]&&_0x550db7[_0x160ab8(0xfa)][_0x160ab8(0xc1)]){const _0x47294b=_0x550db7[_0x160ab8(0xfa)][_0x160ab8(0xc1)];if(_0x47294b['startsWith']('Bearer\x20')){const _0x4fc23a=_0x47294b[_0x160ab8(0xee)](0x7);_0x4fc23a[_0x160ab8(0xc2)]>0xa&&(_0x550db7[_0x160ab8(0xfa)]['Authorization']='Bearer\x20'+_0x4fc23a['slice'](0x0,0x5)+_0x160ab8(0xf2)+_0x4fc23a[_0x160ab8(0xee)](-0x4));}}return _0x550db7['data']&&_0x550db7[_0x160ab8(0xd9)][_0x160ab8(0xea)]&&Array[_0x160ab8(0xfe)](_0x550db7[_0x160ab8(0xd9)][_0x160ab8(0xea)])&&(_0x550db7[_0x160ab8(0xd9)][_0x160ab8(0xea)]=_0x550db7['data'][_0x160ab8(0xea)]['map'](_0x54d718=>{const _0x59cd4d=_0x160ab8;return _0x54d718[_0x59cd4d(0xeb)]&&Array[_0x59cd4d(0xfe)](_0x54d718[_0x59cd4d(0xeb)])&&(_0x54d718[_0x59cd4d(0xeb)]=_0x54d718['content'][_0x59cd4d(0xcd)](_0x1200ed=>{const _0x1e651b=_0x59cd4d;return _0x1200ed[_0x1e651b(0xdd)]===_0x1e651b(0xed)&&_0x1200ed['image_url']&&_0x1200ed['image_url'][_0x1e651b(0xbf)]&&(_0x1200ed[_0x1e651b(0xed)][_0x1e651b(0xbf)]=_0x1e651b(0xfd)),_0x1200ed;})),_0x54d718;})),_0x550db7;}async['chatFree'](_0x56716d,_0x47f3cc,_0x4d75e6){const _0x2199e5=_0x12f36a,{openaiBaseUrl:openaiBaseUrl='',openaiBaseKey:openaiBaseKey='',openaiBaseModel:_0x1bd8e0}=await this['globalConfigService'][_0x2199e5(0xc4)]([_0x2199e5(0xc3),'openaiBaseUrl',_0x2199e5(0xe9)]),_0x1bb4ee=openaiBaseKey,_0x130459=openaiBaseUrl;let _0x5e0871=[];_0x47f3cc&&_0x5e0871[_0x2199e5(0xc0)]({'role':'system','content':_0x47f3cc});_0x4d75e6&&_0x4d75e6['length']>0x0?_0x5e0871=_0x5e0871['concat'](_0x4d75e6):_0x5e0871[_0x2199e5(0xc0)]({'role':'user','content':_0x56716d});const _0x261305={'method':_0x2199e5(0xce),'url':_0x130459+_0x2199e5(0xbe),'headers':{'Content-Type':'application/json','Authorization':_0x2199e5(0xb7)+_0x1bb4ee},'data':{'model':_0x1bd8e0||_0x2199e5(0xf8),'messages':_0x5e0871}};try{const _0x3d1211=await(0x0,axios_1[_0x2199e5(0xc6)])(_0x261305);return common_1[_0x2199e5(0xcc)][_0x2199e5(0xe8)](_0x2199e5(0xf4)+(_0x3d1211===null||_0x3d1211===void 0x0?void 0x0:_0x3d1211[_0x2199e5(0xd9)][_0x2199e5(0xd0)][0x0][_0x2199e5(0xc5)][_0x2199e5(0xeb)]),'ChatService'),_0x3d1211===null||_0x3d1211===void 0x0?void 0x0:_0x3d1211[_0x2199e5(0xd9)][_0x2199e5(0xd0)][0x0][_0x2199e5(0xc5)]['content'];}catch(_0x26ddac){console[_0x2199e5(0xe8)](_0x2199e5(0xf6),_0x26ddac);}}};OpenAIChatService=__decorate([(0x0,common_1[_0x12f36a(0xcb)])(),__metadata(_0x12f36a(0xd6),[globalConfig_service_1[_0x12f36a(0xdf)]])],OpenAIChatService),exports[_0x12f36a(0xca)]=OpenAIChatService;