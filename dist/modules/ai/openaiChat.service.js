'use strict';const _0x447481=_0x3060;function _0x289b(){const _0x2f25fe=['abort','concat','3253347LTRNqd','data:\x20','temperature','__metadata','data','toString','addEventListener','axios','data:\x20[DONE]','8fUQOJE','829312eJZfiZ','gpt-3.5-turbo-0125','message','decorate','function','POST','isArray','openaiBaseModel','messages','getConfigs','stringify','150kTfyKp','stream','12517309bXKDxK','application/json','chatFree','parse','Logger','ChatService','Injectable','168690SwXzJt','headers','openaiBaseUrl','__decorate','__esModule','log','4LANJVX','openaiBaseKey','725710eDjPpK','choices','startsWith','image_url','defineProperty','@nestjs/common','signal','default','6589773vKbkMH','object','../globalConfig/globalConfig.service','****','GlobalConfigService','89573bdtwgA','处理结束信号\x20[DONE]','error:\x20','OpenAIChatService','content','data:image/***;base64\x20...\x20...','length','Bearer\x20','slice','Authorization','pop','answer','../../common/utils','请求配置:','trim','8090vrccef','error','globalConfigService','push','map','split','getOwnPropertyDescriptor','handleError','/v1/chat/completions'];_0x289b=function(){return _0x2f25fe;};return _0x289b();}function _0x3060(_0x4b5d40,_0x414b0e){const _0x289b27=_0x289b();return _0x3060=function(_0x306050,_0x35a155){_0x306050=_0x306050-0x13f;let _0x85ef2c=_0x289b27[_0x306050];return _0x85ef2c;},_0x3060(_0x4b5d40,_0x414b0e);}(function(_0x35cb3b,_0x3ba83e){const _0x46b684=_0x3060,_0x7bd1f1=_0x35cb3b();while(!![]){try{const _0x3ee6ae=-parseInt(_0x46b684(0x188))/0x1*(parseInt(_0x46b684(0x18a))/0x2)+-parseInt(_0x46b684(0x164))/0x3+parseInt(_0x46b684(0x16e))/0x4+parseInt(_0x46b684(0x179))/0x5*(-parseInt(_0x46b684(0x182))/0x6)+-parseInt(_0x46b684(0x17b))/0x7+parseInt(_0x46b684(0x16d))/0x8*(-parseInt(_0x46b684(0x145))/0x9)+parseInt(_0x46b684(0x159))/0xa*(parseInt(_0x46b684(0x14a))/0xb);if(_0x3ee6ae===_0x3ba83e)break;else _0x7bd1f1['push'](_0x7bd1f1['shift']());}catch(_0x1959a5){_0x7bd1f1['push'](_0x7bd1f1['shift']());}}}(_0x289b,0xda950));var __decorate=this&&this[_0x447481(0x185)]||function(_0x2a02b2,_0x69dda9,_0x1d2cfc,_0x5e7bc9){const _0x57c088=_0x447481;var _0x40d088=arguments[_0x57c088(0x150)],_0x5ef315=_0x40d088<0x3?_0x69dda9:_0x5e7bc9===null?_0x5e7bc9=Object[_0x57c088(0x15f)](_0x69dda9,_0x1d2cfc):_0x5e7bc9,_0x33c6e3;if(typeof Reflect===_0x57c088(0x146)&&typeof Reflect[_0x57c088(0x171)]===_0x57c088(0x172))_0x5ef315=Reflect[_0x57c088(0x171)](_0x2a02b2,_0x69dda9,_0x1d2cfc,_0x5e7bc9);else{for(var _0x6e67dd=_0x2a02b2[_0x57c088(0x150)]-0x1;_0x6e67dd>=0x0;_0x6e67dd--)if(_0x33c6e3=_0x2a02b2[_0x6e67dd])_0x5ef315=(_0x40d088<0x3?_0x33c6e3(_0x5ef315):_0x40d088>0x3?_0x33c6e3(_0x69dda9,_0x1d2cfc,_0x5ef315):_0x33c6e3(_0x69dda9,_0x1d2cfc))||_0x5ef315;}return _0x40d088>0x3&&_0x5ef315&&Object[_0x57c088(0x141)](_0x69dda9,_0x1d2cfc,_0x5ef315),_0x5ef315;},__metadata=this&&this[_0x447481(0x167)]||function(_0x1dc812,_0x3d2da4){const _0x21972b=_0x447481;if(typeof Reflect===_0x21972b(0x146)&&typeof Reflect['metadata']===_0x21972b(0x172))return Reflect['metadata'](_0x1dc812,_0x3d2da4);};Object['defineProperty'](exports,_0x447481(0x186),{'value':!![]}),exports['OpenAIChatService']=void 0x0;const utils_1=require(_0x447481(0x156)),common_1=require(_0x447481(0x142)),axios_1=require(_0x447481(0x16b)),globalConfig_service_1=require(_0x447481(0x147));let OpenAIChatService=class OpenAIChatService{constructor(_0x542ebd){const _0x3d243f=_0x447481;this[_0x3d243f(0x15b)]=_0x542ebd;}async['openAIChat'](_0x1dec1e,_0x35579e){const _0x4ee295=_0x447481,{onFailure:_0x3bb6c8,onProgress:_0x1a15e4,apiKey:_0x2b80e9,model:_0x1721b4,proxyUrl:_0x4cbaec,modelName:_0x51c883,timeout:_0x5ed031,chatId:_0x311a96,isFileUpload:_0x4983bf,modelAvatar:_0x40f3a3,temperature:_0x1a6d39,abortController:_0x2d0427}=_0x35579e;let _0xa396e3={'text':'','model':'','modelName':_0x51c883,'chatId':_0x311a96,'answer':'','errMsg':'','modelAvatar':_0x40f3a3};const _0x519f11=Object['assign']({'model':_0x1721b4,'messages':_0x1dec1e},_0x4983bf===0x2&&{'max_tokens':0x800});_0x519f11['stream']=!![],_0x519f11[_0x4ee295(0x166)]=_0x1a6d39;const _0xda7b50={'method':_0x4ee295(0x173),'url':_0x4cbaec+_0x4ee295(0x161),'responseType':_0x4ee295(0x17a),'timeout':_0x5ed031,'headers':{'Content-Type':_0x4ee295(0x17c),'Authorization':_0x4ee295(0x151)+_0x2b80e9},'data':_0x519f11},_0x22ef93=await this['sanitizeOptionsForLogging'](_0xda7b50);console['log']('请求配置:',JSON[_0x4ee295(0x178)](_0x22ef93,null,0x2),_0x4ee295(0x180)),console['log'](_0x4ee295(0x157),JSON['stringify'](_0x22ef93,null,0x2),_0x4ee295(0x180));try{const _0x4ef4da=await(0x0,axios_1[_0x4ee295(0x144)])(_0xda7b50),_0x27a71a=_0x4ef4da['data'];let _0x9f2d17='';return await new Promise((_0x2940c0,_0x2a2dba)=>{const _0x2289d9=_0x4ee295;_0x27a71a['on'](_0x2289d9(0x168),_0x5e04f9=>{const _0x565bcb=_0x2289d9;_0x9f2d17+=_0x5e04f9[_0x565bcb(0x169)]();let _0x1ec2c2=_0x9f2d17[_0x565bcb(0x15e)]('\x0a');_0x9f2d17=_0x1ec2c2[_0x565bcb(0x154)](),_0x1ec2c2['forEach'](_0x40e267=>{const _0x100f31=_0x565bcb;var _0x31385e,_0x690cc4;if(_0x40e267[_0x100f31(0x158)]()===_0x100f31(0x16c)){console[_0x100f31(0x187)](_0x100f31(0x14b)),_0x2940c0(_0xa396e3);return;}if(_0x40e267[_0x100f31(0x13f)](_0x100f31(0x165)))try{const _0x1c25fd=_0x40e267['slice'](0x6)[_0x100f31(0x158)]();if(_0x1c25fd){const _0x53d42e=JSON[_0x100f31(0x17e)](_0x1c25fd),_0x5a7e05=((_0x690cc4=(_0x31385e=_0x53d42e[_0x100f31(0x18b)][0x0])===null||_0x31385e===void 0x0?void 0x0:_0x31385e['delta'])===null||_0x690cc4===void 0x0?void 0x0:_0x690cc4[_0x100f31(0x14e)])||'';_0xa396e3['answer']+=_0x5a7e05,_0x1a15e4===null||_0x1a15e4===void 0x0?void 0x0:_0x1a15e4({'text':_0x5a7e05,'answer':_0xa396e3[_0x100f31(0x155)]});}}catch(_0x37877e){console[_0x100f31(0x15a)]('Error\x20parsing\x20line:',_0x40e267,_0x37877e);}});}),_0x27a71a['on']('end',()=>{_0x2940c0(_0xa396e3);}),_0x27a71a['on']('error',_0x20679c=>{_0x2a2dba(_0x20679c);}),_0x2d0427[_0x2289d9(0x143)][_0x2289d9(0x16a)](_0x2289d9(0x162),()=>{_0x2940c0(_0xa396e3);});}),_0xa396e3;}catch(_0x3259c3){return _0xa396e3['errMsg']=(0x0,utils_1[_0x4ee295(0x160)])(_0x3259c3),common_1[_0x4ee295(0x17f)][_0x4ee295(0x15a)](_0xa396e3['errMsg']),_0x3bb6c8(_0xa396e3),_0xa396e3;}}async['sanitizeOptionsForLogging'](_0x5c127f){const _0x5cc31c=_0x447481,_0x11ed9d=JSON[_0x5cc31c(0x17e)](JSON[_0x5cc31c(0x178)](_0x5c127f));if(_0x11ed9d[_0x5cc31c(0x183)]&&_0x11ed9d['headers'][_0x5cc31c(0x153)]){const _0x544b18=_0x11ed9d[_0x5cc31c(0x183)][_0x5cc31c(0x153)];if(_0x544b18[_0x5cc31c(0x13f)](_0x5cc31c(0x151))){const _0x21cbd2=_0x544b18['slice'](0x7);_0x21cbd2[_0x5cc31c(0x150)]>0xa&&(_0x11ed9d['headers']['Authorization']=_0x5cc31c(0x151)+_0x21cbd2[_0x5cc31c(0x152)](0x0,0x5)+_0x5cc31c(0x148)+_0x21cbd2[_0x5cc31c(0x152)](-0x4));}}return _0x11ed9d[_0x5cc31c(0x168)]&&_0x11ed9d['data'][_0x5cc31c(0x176)]&&Array[_0x5cc31c(0x174)](_0x11ed9d['data'][_0x5cc31c(0x176)])&&(_0x11ed9d[_0x5cc31c(0x168)][_0x5cc31c(0x176)]=_0x11ed9d[_0x5cc31c(0x168)]['messages']['map'](_0x16c636=>{const _0x5c6586=_0x5cc31c;return _0x16c636['content']&&Array[_0x5c6586(0x174)](_0x16c636['content'])&&(_0x16c636[_0x5c6586(0x14e)]=_0x16c636[_0x5c6586(0x14e)][_0x5c6586(0x15d)](_0x1440b9=>{const _0x42d392=_0x5c6586;return _0x1440b9['type']===_0x42d392(0x140)&&_0x1440b9[_0x42d392(0x140)]&&_0x1440b9[_0x42d392(0x140)]['url']&&(_0x1440b9['image_url']['url']=_0x42d392(0x14f)),_0x1440b9;})),_0x16c636;})),_0x11ed9d;}async[_0x447481(0x17d)](_0x4aa357,_0x196428,_0xe44608){const _0x19996a=_0x447481,{openaiBaseUrl:openaiBaseUrl='',openaiBaseKey:openaiBaseKey='',openaiBaseModel:_0x3a0599}=await this[_0x19996a(0x15b)][_0x19996a(0x177)]([_0x19996a(0x189),_0x19996a(0x184),_0x19996a(0x175)]),_0x4234e7=openaiBaseKey,_0x5f18d4=openaiBaseUrl;let _0x37e799=[];_0x196428&&_0x37e799[_0x19996a(0x15c)]({'role':'system','content':_0x196428});_0xe44608&&_0xe44608[_0x19996a(0x150)]>0x0?_0x37e799=_0x37e799[_0x19996a(0x163)](_0xe44608):_0x37e799['push']({'role':'user','content':_0x4aa357});const _0x2b70bc={'method':_0x19996a(0x173),'url':_0x5f18d4+_0x19996a(0x161),'headers':{'Content-Type':'application/json','Authorization':_0x19996a(0x151)+_0x4234e7},'data':{'model':_0x3a0599||_0x19996a(0x16f),'messages':_0x37e799}};try{const _0x365175=await(0x0,axios_1[_0x19996a(0x144)])(_0x2b70bc);return common_1[_0x19996a(0x17f)]['log']('全局模型调用成功,\x20返回结果:\x20'+(_0x365175===null||_0x365175===void 0x0?void 0x0:_0x365175[_0x19996a(0x168)]['choices'][0x0]['message'][_0x19996a(0x14e)]),_0x19996a(0x180)),_0x365175===null||_0x365175===void 0x0?void 0x0:_0x365175[_0x19996a(0x168)][_0x19996a(0x18b)][0x0][_0x19996a(0x170)][_0x19996a(0x14e)];}catch(_0x28fd24){console['log'](_0x19996a(0x14c),_0x28fd24);}}};OpenAIChatService=__decorate([(0x0,common_1[_0x447481(0x181)])(),__metadata('design:paramtypes',[globalConfig_service_1[_0x447481(0x149)]])],OpenAIChatService),exports[_0x447481(0x14d)]=OpenAIChatService;