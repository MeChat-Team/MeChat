'use strict';const _0x1a14f8=_0x3e6d;(function(_0x235de7,_0x521938){const _0x57cea6=_0x3e6d,_0x18512d=_0x235de7();while(!![]){try{const _0x1d24ca=parseInt(_0x57cea6(0x89))/0x1+-parseInt(_0x57cea6(0xad))/0x2*(-parseInt(_0x57cea6(0x9d))/0x3)+-parseInt(_0x57cea6(0x96))/0x4*(parseInt(_0x57cea6(0x8c))/0x5)+-parseInt(_0x57cea6(0xab))/0x6+-parseInt(_0x57cea6(0xc1))/0x7*(-parseInt(_0x57cea6(0x7a))/0x8)+-parseInt(_0x57cea6(0x9a))/0x9+parseInt(_0x57cea6(0xbe))/0xa;if(_0x1d24ca===_0x521938)break;else _0x18512d['push'](_0x18512d['shift']());}catch(_0x298b42){_0x18512d['push'](_0x18512d['shift']());}}}(_0x3376,0x1ccd2));function _0x3376(){const _0x3a54ab=['errMsg','10285GmTJxb','application/json','message','494380CDBfir','function','../../common/utils','sanitizeOptionsForLogging','log','slice','answer','@nestjs/common','Injectable','messages','8tHUweX','****','handleError','design:paramtypes','126657ykNwrV','image_url','ChatService','24fpCQAw','全局模型调用成功,\x20返回结果:\x20','trim','map','处理结束信号\x20[DONE]','isArray','openAIChat','Logger','url','Bearer\x20','metadata','globalConfigService','gpt-3.5-turbo-0125','error:\x20','782712efGNmT','assign','3512KZxOUS','data:\x20','getOwnPropertyDescriptor','Authorization','axios','Error\x20parsing\x20line:','headers','system','data','请求配置:','choices','error','startsWith','parse','data:\x20[DONE]','content','length','3316950ZwFfAE','../globalConfig/globalConfig.service','getConfigs','729533nRpNPn','openaiBaseModel','stream','defineProperty','signal','default','push','chatFree','data:image/***;base64\x20...\x20...','pop','decorate','end','8EiYAUu','toString','type','/v1/chat/completions','object','addEventListener','__esModule','split','openaiBaseUrl','OpenAIChatService','__metadata','GlobalConfigService','POST','openaiBaseKey'];_0x3376=function(){return _0x3a54ab;};return _0x3376();}var __decorate=this&&this['__decorate']||function(_0x41177c,_0x2285e1,_0x2cfa9b,_0x12d03f){const _0xb56101=_0x3e6d;var _0x347a54=arguments['length'],_0x343e64=_0x347a54<0x3?_0x2285e1:_0x12d03f===null?_0x12d03f=Object[_0xb56101(0xaf)](_0x2285e1,_0x2cfa9b):_0x12d03f,_0x36ba00;if(typeof Reflect==='object'&&typeof Reflect[_0xb56101(0x78)]===_0xb56101(0x8d))_0x343e64=Reflect[_0xb56101(0x78)](_0x41177c,_0x2285e1,_0x2cfa9b,_0x12d03f);else{for(var _0x1bc6f4=_0x41177c[_0xb56101(0xbd)]-0x1;_0x1bc6f4>=0x0;_0x1bc6f4--)if(_0x36ba00=_0x41177c[_0x1bc6f4])_0x343e64=(_0x347a54<0x3?_0x36ba00(_0x343e64):_0x347a54>0x3?_0x36ba00(_0x2285e1,_0x2cfa9b,_0x343e64):_0x36ba00(_0x2285e1,_0x2cfa9b))||_0x343e64;}return _0x347a54>0x3&&_0x343e64&&Object[_0xb56101(0xc4)](_0x2285e1,_0x2cfa9b,_0x343e64),_0x343e64;},__metadata=this&&this[_0x1a14f8(0x84)]||function(_0x1681a9,_0x4a2a11){const _0x2b8928=_0x1a14f8;if(typeof Reflect===_0x2b8928(0x7e)&&typeof Reflect[_0x2b8928(0xa7)]===_0x2b8928(0x8d))return Reflect[_0x2b8928(0xa7)](_0x1681a9,_0x4a2a11);};Object['defineProperty'](exports,_0x1a14f8(0x80),{'value':!![]}),exports[_0x1a14f8(0x83)]=void 0x0;const utils_1=require(_0x1a14f8(0x8e)),common_1=require(_0x1a14f8(0x93)),axios_1=require(_0x1a14f8(0xb1)),globalConfig_service_1=require(_0x1a14f8(0xbf));let OpenAIChatService=class OpenAIChatService{constructor(_0x35c64a){const _0x5d653f=_0x1a14f8;this[_0x5d653f(0xa8)]=_0x35c64a;}async[_0x1a14f8(0xa3)](_0x400075,_0x113a20){const _0x53624e=_0x1a14f8,{onFailure:_0x38c3dd,onProgress:_0x1fada1,apiKey:_0xc0408a,model:_0x2ba414,proxyUrl:_0x57b820,modelName:_0x21c79d,timeout:_0x421fad,chatId:_0x13c574,isFileUpload:_0x15a7e6,modelAvatar:_0x594f18,temperature:_0x31353a,abortController:_0x459462}=_0x113a20;let _0x77dae4={'text':'','model':'','modelName':_0x21c79d,'chatId':_0x13c574,'answer':'','errMsg':'','modelAvatar':_0x594f18};const _0x145e6f=Object[_0x53624e(0xac)]({'model':_0x2ba414,'messages':_0x400075},_0x15a7e6===0x2&&{'max_tokens':0x800});_0x145e6f[_0x53624e(0xc3)]=!![],_0x145e6f['temperature']=_0x31353a;const _0x54df2f={'method':'POST','url':_0x57b820+_0x53624e(0x7d),'responseType':'stream','timeout':_0x421fad,'headers':{'Content-Type':_0x53624e(0x8a),'Authorization':_0x53624e(0xa6)+_0xc0408a},'data':_0x145e6f},_0x1ec60b=await this[_0x53624e(0x8f)](_0x54df2f);console[_0x53624e(0x90)]('请求配置:',JSON['stringify'](_0x1ec60b,null,0x2),_0x53624e(0x9c)),console[_0x53624e(0x90)](_0x53624e(0xb6),JSON['stringify'](_0x1ec60b,null,0x2),_0x53624e(0x9c));try{const _0x1316be=await(0x0,axios_1[_0x53624e(0xc6)])(_0x54df2f),_0x5defea=_0x1316be[_0x53624e(0xb5)];let _0x57fbcf='';return await new Promise((_0x149111,_0x4314c1)=>{const _0x4fc7d6=_0x53624e;_0x5defea['on'](_0x4fc7d6(0xb5),_0x54f3e1=>{const _0x4cbb21=_0x4fc7d6;_0x57fbcf+=_0x54f3e1[_0x4cbb21(0x7b)]();let _0x403f31=_0x57fbcf[_0x4cbb21(0x81)]('\x0a');_0x57fbcf=_0x403f31[_0x4cbb21(0xca)](),_0x403f31['forEach'](_0x1d68d1=>{const _0x392c96=_0x4cbb21;var _0x255d4f,_0x378910;if(_0x1d68d1[_0x392c96(0x9f)]()===_0x392c96(0xbb)){console[_0x392c96(0x90)](_0x392c96(0xa1)),_0x149111(_0x77dae4);return;}if(_0x1d68d1[_0x392c96(0xb9)](_0x392c96(0xae)))try{const _0x49e86b=_0x1d68d1[_0x392c96(0x91)](0x6)[_0x392c96(0x9f)]();if(_0x49e86b){const _0x304d7e=JSON['parse'](_0x49e86b),_0x203628=((_0x378910=(_0x255d4f=_0x304d7e[_0x392c96(0xb7)][0x0])===null||_0x255d4f===void 0x0?void 0x0:_0x255d4f['delta'])===null||_0x378910===void 0x0?void 0x0:_0x378910[_0x392c96(0xbc)])||'';_0x77dae4[_0x392c96(0x92)]+=_0x203628,_0x1fada1===null||_0x1fada1===void 0x0?void 0x0:_0x1fada1({'text':_0x203628,'answer':_0x77dae4['answer']});}}catch(_0x3f281d){console['error'](_0x392c96(0xb2),_0x1d68d1,_0x3f281d);}});}),_0x5defea['on'](_0x4fc7d6(0x79),()=>{_0x149111(_0x77dae4);}),_0x5defea['on']('error',_0x2c2b97=>{_0x4314c1(_0x2c2b97);}),_0x459462[_0x4fc7d6(0xc5)][_0x4fc7d6(0x7f)]('abort',()=>{_0x149111(_0x77dae4);});}),_0x77dae4;}catch(_0x3a39cd){return _0x77dae4[_0x53624e(0x88)]=(0x0,utils_1[_0x53624e(0x98)])(_0x3a39cd),common_1[_0x53624e(0xa4)][_0x53624e(0xb8)](_0x77dae4[_0x53624e(0x88)]),_0x38c3dd(_0x77dae4),_0x77dae4;}}async['sanitizeOptionsForLogging'](_0x3a8187){const _0x3efd74=_0x1a14f8,_0x8b0b8=JSON[_0x3efd74(0xba)](JSON['stringify'](_0x3a8187));if(_0x8b0b8[_0x3efd74(0xb3)]&&_0x8b0b8['headers']['Authorization']){const _0x196506=_0x8b0b8['headers']['Authorization'];if(_0x196506[_0x3efd74(0xb9)](_0x3efd74(0xa6))){const _0x4d9b8a=_0x196506[_0x3efd74(0x91)](0x7);_0x4d9b8a['length']>0xa&&(_0x8b0b8['headers'][_0x3efd74(0xb0)]=_0x3efd74(0xa6)+_0x4d9b8a[_0x3efd74(0x91)](0x0,0x5)+_0x3efd74(0x97)+_0x4d9b8a[_0x3efd74(0x91)](-0x4));}}return _0x8b0b8[_0x3efd74(0xb5)]&&_0x8b0b8[_0x3efd74(0xb5)][_0x3efd74(0x95)]&&Array[_0x3efd74(0xa2)](_0x8b0b8[_0x3efd74(0xb5)][_0x3efd74(0x95)])&&(_0x8b0b8[_0x3efd74(0xb5)][_0x3efd74(0x95)]=_0x8b0b8[_0x3efd74(0xb5)]['messages']['map'](_0x512cd0=>{const _0x42ae95=_0x3efd74;return _0x512cd0['content']&&Array[_0x42ae95(0xa2)](_0x512cd0['content'])&&(_0x512cd0[_0x42ae95(0xbc)]=_0x512cd0[_0x42ae95(0xbc)][_0x42ae95(0xa0)](_0x3da230=>{const _0x4d72d9=_0x42ae95;return _0x3da230[_0x4d72d9(0x7c)]===_0x4d72d9(0x9b)&&_0x3da230[_0x4d72d9(0x9b)]&&_0x3da230[_0x4d72d9(0x9b)][_0x4d72d9(0xa5)]&&(_0x3da230[_0x4d72d9(0x9b)][_0x4d72d9(0xa5)]=_0x4d72d9(0xc9)),_0x3da230;})),_0x512cd0;})),_0x8b0b8;}async[_0x1a14f8(0xc8)](_0x521931,_0x254107,_0x1b8f24){const _0x527204=_0x1a14f8,{openaiBaseUrl:openaiBaseUrl='',openaiBaseKey:openaiBaseKey='',openaiBaseModel:_0x3c261c}=await this[_0x527204(0xa8)][_0x527204(0xc0)]([_0x527204(0x87),_0x527204(0x82),_0x527204(0xc2)]),_0x13cf45=openaiBaseKey,_0x5cd7c6=openaiBaseUrl;let _0x57c772=[];_0x254107&&_0x57c772['push']({'role':_0x527204(0xb4),'content':_0x254107});_0x1b8f24&&_0x1b8f24['length']>0x0?_0x57c772=_0x57c772['concat'](_0x1b8f24):_0x57c772[_0x527204(0xc7)]({'role':'user','content':_0x521931});const _0x279a74={'method':_0x527204(0x86),'url':_0x5cd7c6+_0x527204(0x7d),'headers':{'Content-Type':_0x527204(0x8a),'Authorization':_0x527204(0xa6)+_0x13cf45},'data':{'model':_0x3c261c||_0x527204(0xa9),'messages':_0x57c772}};try{const _0xa4abc5=await(0x0,axios_1[_0x527204(0xc6)])(_0x279a74);return common_1['Logger']['log'](_0x527204(0x9e)+(_0xa4abc5===null||_0xa4abc5===void 0x0?void 0x0:_0xa4abc5[_0x527204(0xb5)][_0x527204(0xb7)][0x0]['message'][_0x527204(0xbc)]),'ChatService'),_0xa4abc5===null||_0xa4abc5===void 0x0?void 0x0:_0xa4abc5['data'][_0x527204(0xb7)][0x0][_0x527204(0x8b)][_0x527204(0xbc)];}catch(_0x30d2cc){console[_0x527204(0x90)](_0x527204(0xaa),_0x30d2cc);}}};function _0x3e6d(_0x4d1f9f,_0xaf2d55){const _0x3376f0=_0x3376();return _0x3e6d=function(_0x3e6ddf,_0x1afa56){_0x3e6ddf=_0x3e6ddf-0x78;let _0x5817fa=_0x3376f0[_0x3e6ddf];return _0x5817fa;},_0x3e6d(_0x4d1f9f,_0xaf2d55);}OpenAIChatService=__decorate([(0x0,common_1[_0x1a14f8(0x94)])(),__metadata(_0x1a14f8(0x99),[globalConfig_service_1[_0x1a14f8(0x85)]])],OpenAIChatService),exports[_0x1a14f8(0x83)]=OpenAIChatService;