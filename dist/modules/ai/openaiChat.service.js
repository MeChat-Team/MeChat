'use strict';const _0x45f4b2=_0x3655;(function(_0x1433c5,_0x552505){const _0x10ae1c=_0x3655,_0x504cd7=_0x1433c5();while(!![]){try{const _0x4a9644=-parseInt(_0x10ae1c(0x195))/0x1+-parseInt(_0x10ae1c(0x19a))/0x2*(parseInt(_0x10ae1c(0x163))/0x3)+-parseInt(_0x10ae1c(0x177))/0x4*(parseInt(_0x10ae1c(0x16e))/0x5)+-parseInt(_0x10ae1c(0x152))/0x6*(-parseInt(_0x10ae1c(0x161))/0x7)+-parseInt(_0x10ae1c(0x18e))/0x8*(-parseInt(_0x10ae1c(0x198))/0x9)+parseInt(_0x10ae1c(0x180))/0xa+parseInt(_0x10ae1c(0x17d))/0xb*(parseInt(_0x10ae1c(0x192))/0xc);if(_0x4a9644===_0x552505)break;else _0x504cd7['push'](_0x504cd7['shift']());}catch(_0x1ddc90){_0x504cd7['push'](_0x504cd7['shift']());}}}(_0x32b3,0xc4b6d));function _0x3655(_0x2dc63d,_0x29bad6){const _0x32b3d1=_0x32b3();return _0x3655=function(_0x3655d5,_0x3752e2){_0x3655d5=_0x3655d5-0x149;let _0x2091e4=_0x32b3d1[_0x3655d5];return _0x2091e4;},_0x3655(_0x2dc63d,_0x29bad6);}var __decorate=this&&this[_0x45f4b2(0x17e)]||function(_0x36d09c,_0x2f76f3,_0x2e46ca,_0x12b5f7){const _0x5da588=_0x45f4b2;var _0x44bf5b=arguments[_0x5da588(0x164)],_0x321fed=_0x44bf5b<0x3?_0x2f76f3:_0x12b5f7===null?_0x12b5f7=Object[_0x5da588(0x160)](_0x2f76f3,_0x2e46ca):_0x12b5f7,_0x4cc7d6;if(typeof Reflect==='object'&&typeof Reflect['decorate']===_0x5da588(0x167))_0x321fed=Reflect[_0x5da588(0x189)](_0x36d09c,_0x2f76f3,_0x2e46ca,_0x12b5f7);else{for(var _0x4dbc12=_0x36d09c['length']-0x1;_0x4dbc12>=0x0;_0x4dbc12--)if(_0x4cc7d6=_0x36d09c[_0x4dbc12])_0x321fed=(_0x44bf5b<0x3?_0x4cc7d6(_0x321fed):_0x44bf5b>0x3?_0x4cc7d6(_0x2f76f3,_0x2e46ca,_0x321fed):_0x4cc7d6(_0x2f76f3,_0x2e46ca))||_0x321fed;}return _0x44bf5b>0x3&&_0x321fed&&Object[_0x5da588(0x186)](_0x2f76f3,_0x2e46ca,_0x321fed),_0x321fed;},__metadata=this&&this[_0x45f4b2(0x183)]||function(_0x4f9665,_0x422196){const _0x209830=_0x45f4b2;if(typeof Reflect==='object'&&typeof Reflect[_0x209830(0x172)]==='function')return Reflect[_0x209830(0x172)](_0x4f9665,_0x422196);};Object[_0x45f4b2(0x186)](exports,_0x45f4b2(0x181),{'value':!![]}),exports[_0x45f4b2(0x150)]=void 0x0;const utils_1=require(_0x45f4b2(0x17f)),common_1=require(_0x45f4b2(0x199)),axios_1=require(_0x45f4b2(0x166)),globalConfig_service_1=require(_0x45f4b2(0x191));let OpenAIChatService=class OpenAIChatService{constructor(_0xd02755){const _0x2134c0=_0x45f4b2;this[_0x2134c0(0x15e)]=_0xd02755;}async['openAIChat'](_0x4a9d6d,_0x5c184c){const _0x3639cf=_0x45f4b2,{onFailure:_0xc17dd3,onProgress:_0xadb1dd,apiKey:_0x5ccf68,model:_0x4f8d51,proxyUrl:_0x2e28d2,modelName:_0x5caef9,timeout:_0xe2cd34,chatId:_0x3b2c72,isFileUpload:_0x47f2f6,modelAvatar:_0x1e7aea,temperature:_0x224933,abortController:_0x5efe1a}=_0x5c184c;let _0x33a677={'text':'','model':'','modelName':_0x5caef9,'chatId':_0x3b2c72,'answer':'','errMsg':'','modelAvatar':_0x1e7aea};const _0x8113c7=Object[_0x3639cf(0x187)]({'model':_0x4f8d51,'messages':_0x4a9d6d},_0x47f2f6===0x2&&{'max_tokens':0x800});_0x8113c7[_0x3639cf(0x17a)]=!![],_0x8113c7[_0x3639cf(0x190)]=_0x224933;const _0x393642={'method':'POST','url':_0x2e28d2+'/v1/chat/completions','responseType':_0x3639cf(0x17a),'timeout':_0xe2cd34,'headers':{'Content-Type':_0x3639cf(0x15c),'Authorization':_0x3639cf(0x14a)+_0x5ccf68},'data':_0x8113c7},_0x5a0eb0=await this['sanitizeOptionsForLogging'](_0x393642);console[_0x3639cf(0x18a)](_0x3639cf(0x18f),JSON[_0x3639cf(0x157)](_0x5a0eb0,null,0x2),_0x3639cf(0x16f)),console[_0x3639cf(0x18a)](_0x3639cf(0x18f),JSON['stringify'](_0x5a0eb0,null,0x2),'ChatService');try{const _0x11508f=await(0x0,axios_1['default'])(_0x393642),_0x535b02=_0x11508f[_0x3639cf(0x17c)];let _0x37c7c6='';return await new Promise((_0x2f62ef,_0x449033)=>{const _0x4a3670=_0x3639cf;_0x535b02['on'](_0x4a3670(0x17c),_0x27a20e=>{const _0x59a6be=_0x4a3670;_0x37c7c6+=_0x27a20e[_0x59a6be(0x175)]();let _0x38d51e=_0x37c7c6['split']('\x0a');_0x37c7c6=_0x38d51e[_0x59a6be(0x18c)](),_0x38d51e[_0x59a6be(0x159)](_0x356714=>{const _0x2f6f35=_0x59a6be;var _0x97c420,_0x5712d1;if(_0x356714[_0x2f6f35(0x184)]()===_0x2f6f35(0x15b)){console[_0x2f6f35(0x18a)](_0x2f6f35(0x156)),_0x2f62ef(_0x33a677);return;}if(_0x356714[_0x2f6f35(0x16a)](_0x2f6f35(0x158)))try{const _0x28cf89=_0x356714[_0x2f6f35(0x15d)](0x6)['trim']();if(_0x28cf89){const _0x3cc39c=JSON[_0x2f6f35(0x169)](_0x28cf89),_0x4bb930=((_0x5712d1=(_0x97c420=_0x3cc39c[_0x2f6f35(0x165)][0x0])===null||_0x97c420===void 0x0?void 0x0:_0x97c420[_0x2f6f35(0x196)])===null||_0x5712d1===void 0x0?void 0x0:_0x5712d1[_0x2f6f35(0x16b)])||'';_0x33a677[_0x2f6f35(0x151)]+=_0x4bb930,_0xadb1dd===null||_0xadb1dd===void 0x0?void 0x0:_0xadb1dd({'text':_0x4bb930,'answer':_0x33a677[_0x2f6f35(0x151)]});}}catch(_0x48115f){console['error'](_0x2f6f35(0x149),_0x356714,_0x48115f);}});}),_0x535b02['on'](_0x4a3670(0x162),()=>{_0x2f62ef(_0x33a677);}),_0x535b02['on'](_0x4a3670(0x176),_0x5d28cf=>{_0x449033(_0x5d28cf);}),_0x5efe1a['signal']['addEventListener'](_0x4a3670(0x18d),()=>{_0x2f62ef(_0x33a677);});}),_0x33a677;}catch(_0x7588d3){return _0x33a677[_0x3639cf(0x14f)]=(0x0,utils_1[_0x3639cf(0x153)])(_0x7588d3),common_1[_0x3639cf(0x14e)][_0x3639cf(0x176)](_0x33a677['errMsg']),_0xc17dd3(_0x33a677),_0x33a677;}}async[_0x45f4b2(0x197)](_0x293c0a){const _0x303490=_0x45f4b2,_0x3d88ec=JSON['parse'](JSON[_0x303490(0x157)](_0x293c0a));if(_0x3d88ec[_0x303490(0x15f)]&&_0x3d88ec[_0x303490(0x15f)][_0x303490(0x19b)]){const _0x5d3be2=_0x3d88ec[_0x303490(0x15f)][_0x303490(0x19b)];if(_0x5d3be2[_0x303490(0x16a)]('Bearer\x20')){const _0x5cbebd=_0x5d3be2['slice'](0x7);_0x5cbebd[_0x303490(0x164)]>0xa&&(_0x3d88ec[_0x303490(0x15f)][_0x303490(0x19b)]=_0x303490(0x14a)+_0x5cbebd[_0x303490(0x15d)](0x0,0x5)+_0x303490(0x188)+_0x5cbebd[_0x303490(0x15d)](-0x4));}}return _0x3d88ec[_0x303490(0x17c)]&&_0x3d88ec['data'][_0x303490(0x14c)]&&Array[_0x303490(0x14b)](_0x3d88ec[_0x303490(0x17c)]['messages'])&&(_0x3d88ec[_0x303490(0x17c)][_0x303490(0x14c)]=_0x3d88ec[_0x303490(0x17c)][_0x303490(0x14c)][_0x303490(0x14d)](_0x170207=>{const _0x259908=_0x303490;return _0x170207['content']&&Array['isArray'](_0x170207[_0x259908(0x16b)])&&(_0x170207['content']=_0x170207[_0x259908(0x16b)][_0x259908(0x14d)](_0x30e3b7=>{const _0x4a614e=_0x259908;return _0x30e3b7[_0x4a614e(0x154)]===_0x4a614e(0x194)&&_0x30e3b7[_0x4a614e(0x194)]&&_0x30e3b7[_0x4a614e(0x194)][_0x4a614e(0x15a)]&&(_0x30e3b7[_0x4a614e(0x194)]['url']=_0x4a614e(0x17b)),_0x30e3b7;})),_0x170207;})),_0x3d88ec;}async[_0x45f4b2(0x182)](_0x1d368b,_0x20a624,_0x1d8eab){const _0x195b9d=_0x45f4b2,{openaiBaseUrl:openaiBaseUrl='',openaiBaseKey:openaiBaseKey='',openaiBaseModel:_0xcf55d4}=await this[_0x195b9d(0x15e)]['getConfigs']([_0x195b9d(0x193),_0x195b9d(0x178),_0x195b9d(0x170)]),_0xa59637=openaiBaseKey,_0x278bec=openaiBaseUrl;let _0x488575=[];_0x20a624&&_0x488575[_0x195b9d(0x18b)]({'role':_0x195b9d(0x173),'content':_0x20a624});_0x1d8eab&&_0x1d8eab[_0x195b9d(0x164)]>0x0?_0x488575=_0x488575[_0x195b9d(0x171)](_0x1d8eab):_0x488575['push']({'role':_0x195b9d(0x179),'content':_0x1d368b});const _0x46d2e6={'method':'POST','url':_0x278bec+_0x195b9d(0x16d),'headers':{'Content-Type':_0x195b9d(0x15c),'Authorization':_0x195b9d(0x14a)+_0xa59637},'data':{'model':_0xcf55d4||_0x195b9d(0x155),'messages':_0x488575}};try{const _0x5a9066=await(0x0,axios_1['default'])(_0x46d2e6);return common_1['Logger']['log']('全局模型调用成功,\x20返回结果:\x20'+(_0x5a9066===null||_0x5a9066===void 0x0?void 0x0:_0x5a9066[_0x195b9d(0x17c)][_0x195b9d(0x165)][0x0][_0x195b9d(0x185)][_0x195b9d(0x16b)]),_0x195b9d(0x16f)),_0x5a9066===null||_0x5a9066===void 0x0?void 0x0:_0x5a9066['data'][_0x195b9d(0x165)][0x0][_0x195b9d(0x185)][_0x195b9d(0x16b)];}catch(_0x306df6){console['log'](_0x195b9d(0x174),_0x306df6);}}};function _0x32b3(){const _0xc3464a=['choices','axios','function','Injectable','parse','startsWith','content','design:paramtypes','/v1/chat/completions','10QEWNrO','ChatService','openaiBaseModel','concat','metadata','system','error:\x20','toString','error','2398328gAdVtj','openaiBaseUrl','user','stream','data:image/***;base64\x20...\x20...','data','143RSUbzJ','__decorate','../../common/utils','4886000aXcgRp','__esModule','chatFree','__metadata','trim','message','defineProperty','assign','****','decorate','log','push','pop','abort','375816yqZEBc','请求配置:','temperature','../globalConfig/globalConfig.service','1476660fzWGoy','openaiBaseKey','image_url','1086821CQCmgc','delta','sanitizeOptionsForLogging','297FYDuHW','@nestjs/common','594282FXgJKt','Authorization','Error\x20parsing\x20line:','Bearer\x20','isArray','messages','map','Logger','errMsg','OpenAIChatService','answer','6PWpBeo','handleError','type','gpt-3.5-turbo-0125','处理结束信号\x20[DONE]','stringify','data:\x20','forEach','url','data:\x20[DONE]','application/json','slice','globalConfigService','headers','getOwnPropertyDescriptor','2412151KxkcTo','end','9zkdhbO','length'];_0x32b3=function(){return _0xc3464a;};return _0x32b3();}OpenAIChatService=__decorate([(0x0,common_1[_0x45f4b2(0x168)])(),__metadata(_0x45f4b2(0x16c),[globalConfig_service_1['GlobalConfigService']])],OpenAIChatService),exports[_0x45f4b2(0x150)]=OpenAIChatService;