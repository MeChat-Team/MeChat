'use strict';const _0x1a6478=_0x18a6;function _0x18a6(_0x4488b5,_0x12fb1a){const _0x403e3c=_0x403e();return _0x18a6=function(_0x18a6af,_0x3fe618){_0x18a6af=_0x18a6af-0xc4;let _0x11df92=_0x403e3c[_0x18a6af];return _0x11df92;},_0x18a6(_0x4488b5,_0x12fb1a);}(function(_0x58d6c2,_0xd4d1f6){const _0x31a4fc=_0x18a6,_0x3fbb46=_0x58d6c2();while(!![]){try{const _0x561cbd=-parseInt(_0x31a4fc(0xe8))/0x1+-parseInt(_0x31a4fc(0xec))/0x2*(-parseInt(_0x31a4fc(0x10f))/0x3)+-parseInt(_0x31a4fc(0xe9))/0x4+-parseInt(_0x31a4fc(0xe3))/0x5+-parseInt(_0x31a4fc(0x106))/0x6*(parseInt(_0x31a4fc(0xfb))/0x7)+parseInt(_0x31a4fc(0xd0))/0x8*(parseInt(_0x31a4fc(0xc9))/0x9)+parseInt(_0x31a4fc(0x105))/0xa;if(_0x561cbd===_0xd4d1f6)break;else _0x3fbb46['push'](_0x3fbb46['shift']());}catch(_0x31b250){_0x3fbb46['push'](_0x3fbb46['shift']());}}}(_0x403e,0x1ee5c));var __decorate=this&&this['__decorate']||function(_0xc46a0f,_0x395644,_0x41f16a,_0x380e0e){const _0xe87222=_0x18a6;var _0x5be679=arguments[_0xe87222(0xd8)],_0x396373=_0x5be679<0x3?_0x395644:_0x380e0e===null?_0x380e0e=Object['getOwnPropertyDescriptor'](_0x395644,_0x41f16a):_0x380e0e,_0x4206ce;if(typeof Reflect===_0xe87222(0xc8)&&typeof Reflect[_0xe87222(0xcb)]===_0xe87222(0x10e))_0x396373=Reflect[_0xe87222(0xcb)](_0xc46a0f,_0x395644,_0x41f16a,_0x380e0e);else{for(var _0x497437=_0xc46a0f[_0xe87222(0xd8)]-0x1;_0x497437>=0x0;_0x497437--)if(_0x4206ce=_0xc46a0f[_0x497437])_0x396373=(_0x5be679<0x3?_0x4206ce(_0x396373):_0x5be679>0x3?_0x4206ce(_0x395644,_0x41f16a,_0x396373):_0x4206ce(_0x395644,_0x41f16a))||_0x396373;}return _0x5be679>0x3&&_0x396373&&Object[_0xe87222(0xfd)](_0x395644,_0x41f16a,_0x396373),_0x396373;},__metadata=this&&this[_0x1a6478(0xcc)]||function(_0x4879c4,_0x23bc84){const _0x4f4215=_0x1a6478;if(typeof Reflect===_0x4f4215(0xc8)&&typeof Reflect[_0x4f4215(0xd1)]===_0x4f4215(0x10e))return Reflect[_0x4f4215(0xd1)](_0x4879c4,_0x23bc84);};Object[_0x1a6478(0xfd)](exports,_0x1a6478(0xde),{'value':!![]}),exports[_0x1a6478(0xd5)]=void 0x0;function _0x403e(){const _0x23b01a=['data:\x20','data:\x20[DONE]','axios','error:\x20','stream','function','251682uxfiuU','error','parse','ChatService','application/json','openaiBaseUrl','getConfigs','openaiBaseModel','stringify','openaiBaseKey','default','object','18cxpaiy','choices','decorate','__metadata','isArray','split','end','551312uPvOmT','metadata','globalConfigService','concat','toString','OpenAIChatService','pop','temperature','length','openAIChat','signal','sanitizeOptionsForLogging','content','Authorization','__esModule','chatFree','abort','Error\x20parsing\x20line:','forEach','63515bzhtXX','messages','message','Injectable','data','174665aXXJlS','406936FUuMgk','/v1/chat/completions','GlobalConfigService','6fByWZJ','image_url','handleError','headers','trim','Bearer\x20','Logger','delta','design:paramtypes','system','POST','../../common/utils','startsWith','请求配置:','answer','1558487FBkRvh','errMsg','defineProperty','log','@nestjs/common','slice','url','assign','全局模型调用成功,\x20返回结果:\x20','../globalConfig/globalConfig.service','2487890VmeXOa','6oByovD','push','data:image/***;base64\x20...\x20...'];_0x403e=function(){return _0x23b01a;};return _0x403e();}const utils_1=require(_0x1a6478(0xf7)),common_1=require(_0x1a6478(0xff)),axios_1=require(_0x1a6478(0x10b)),globalConfig_service_1=require(_0x1a6478(0x104));let OpenAIChatService=class OpenAIChatService{constructor(_0x1c4e5c){const _0xa3f84e=_0x1a6478;this[_0xa3f84e(0xd2)]=_0x1c4e5c;}async[_0x1a6478(0xd9)](_0x3e7d32,_0x406b08){const _0x49bf47=_0x1a6478,{onFailure:_0x4522b8,onProgress:_0x378c61,apiKey:_0x5b5ab3,model:_0x424864,proxyUrl:_0x37e137,modelName:_0x2f6a21,timeout:_0x129b05,chatId:_0x5bfbff,isFileUpload:_0xb3040a,modelAvatar:_0x491338,temperature:_0x2c4a57,abortController:_0x560d4e}=_0x406b08;let _0x5137b3={'text':'','model':'','modelName':_0x2f6a21,'chatId':_0x5bfbff,'answer':'','errMsg':'','modelAvatar':_0x491338};const _0x381534=Object[_0x49bf47(0x102)]({'model':_0x424864,'messages':_0x3e7d32},_0xb3040a===0x2&&{'max_tokens':0x800});_0x381534[_0x49bf47(0x10d)]=!![],_0x381534[_0x49bf47(0xd7)]=_0x2c4a57;const _0x59ad43={'method':_0x49bf47(0xf6),'url':_0x37e137+_0x49bf47(0xea),'responseType':_0x49bf47(0x10d),'timeout':_0x129b05,'headers':{'Content-Type':_0x49bf47(0x113),'Authorization':'Bearer\x20'+_0x5b5ab3},'data':_0x381534},_0x17e933=await this['sanitizeOptionsForLogging'](_0x59ad43);console[_0x49bf47(0xfe)](_0x49bf47(0xf9),JSON[_0x49bf47(0xc5)](_0x17e933,null,0x2),_0x49bf47(0x112)),console[_0x49bf47(0xfe)]('请求配置:',JSON[_0x49bf47(0xc5)](_0x17e933,null,0x2),'ChatService');try{const _0x236ef9=await(0x0,axios_1[_0x49bf47(0xc7)])(_0x59ad43),_0x497a19=_0x236ef9[_0x49bf47(0xe7)];let _0x3257c4='';return await new Promise((_0x445419,_0xc93e2c)=>{const _0x537571=_0x49bf47;_0x497a19['on'](_0x537571(0xe7),_0x2e6026=>{const _0x3c2568=_0x537571;_0x3257c4+=_0x2e6026[_0x3c2568(0xd4)]();let _0x2539a7=_0x3257c4[_0x3c2568(0xce)]('\x0a');_0x3257c4=_0x2539a7[_0x3c2568(0xd6)](),_0x2539a7[_0x3c2568(0xe2)](_0xfac59b=>{const _0x26e13e=_0x3c2568;var _0x26e527,_0x723edb;if(_0xfac59b[_0x26e13e(0xf0)]()===_0x26e13e(0x10a)){console['log']('处理结束信号\x20[DONE]'),_0x445419(_0x5137b3);return;}if(_0xfac59b['startsWith'](_0x26e13e(0x109)))try{const _0x958f10=_0xfac59b[_0x26e13e(0x100)](0x6)['trim']();if(_0x958f10){const _0x15426e=JSON['parse'](_0x958f10),_0x52cf0a=((_0x723edb=(_0x26e527=_0x15426e['choices'][0x0])===null||_0x26e527===void 0x0?void 0x0:_0x26e527[_0x26e13e(0xf3)])===null||_0x723edb===void 0x0?void 0x0:_0x723edb['content'])||'';_0x5137b3['answer']+=_0x52cf0a,_0x378c61===null||_0x378c61===void 0x0?void 0x0:_0x378c61({'text':_0x52cf0a,'answer':_0x5137b3[_0x26e13e(0xfa)]});}}catch(_0x8eee42){console[_0x26e13e(0x110)](_0x26e13e(0xe1),_0xfac59b,_0x8eee42);}});}),_0x497a19['on'](_0x537571(0xcf),()=>{_0x445419(_0x5137b3);}),_0x497a19['on']('error',_0x44ec7b=>{_0xc93e2c(_0x44ec7b);}),_0x560d4e[_0x537571(0xda)]['addEventListener'](_0x537571(0xe0),()=>{_0x445419(_0x5137b3);});}),_0x5137b3;}catch(_0x452723){return _0x5137b3[_0x49bf47(0xfc)]=(0x0,utils_1[_0x49bf47(0xee)])(_0x452723),common_1[_0x49bf47(0xf2)]['error'](_0x5137b3[_0x49bf47(0xfc)]),_0x4522b8(_0x5137b3),_0x5137b3;}}async[_0x1a6478(0xdb)](_0x2ecb9e){const _0x3d6024=_0x1a6478,_0x671932=JSON[_0x3d6024(0x111)](JSON[_0x3d6024(0xc5)](_0x2ecb9e));if(_0x671932['headers']&&_0x671932[_0x3d6024(0xef)][_0x3d6024(0xdd)]){const _0x1a8420=_0x671932[_0x3d6024(0xef)][_0x3d6024(0xdd)];if(_0x1a8420[_0x3d6024(0xf8)](_0x3d6024(0xf1))){const _0x56a0e8=_0x1a8420['slice'](0x7);_0x56a0e8[_0x3d6024(0xd8)]>0xa&&(_0x671932['headers'][_0x3d6024(0xdd)]=_0x3d6024(0xf1)+_0x56a0e8[_0x3d6024(0x100)](0x0,0x5)+'****'+_0x56a0e8[_0x3d6024(0x100)](-0x4));}}return _0x671932[_0x3d6024(0xe7)]&&_0x671932[_0x3d6024(0xe7)]['messages']&&Array[_0x3d6024(0xcd)](_0x671932[_0x3d6024(0xe7)][_0x3d6024(0xe4)])&&(_0x671932[_0x3d6024(0xe7)][_0x3d6024(0xe4)]=_0x671932['data'][_0x3d6024(0xe4)]['map'](_0x222a16=>{const _0x407cf1=_0x3d6024;return _0x222a16['content']&&Array[_0x407cf1(0xcd)](_0x222a16[_0x407cf1(0xdc)])&&(_0x222a16[_0x407cf1(0xdc)]=_0x222a16[_0x407cf1(0xdc)]['map'](_0xd26c19=>{const _0x26509d=_0x407cf1;return _0xd26c19['type']===_0x26509d(0xed)&&_0xd26c19[_0x26509d(0xed)]&&_0xd26c19[_0x26509d(0xed)]['url']&&(_0xd26c19[_0x26509d(0xed)][_0x26509d(0x101)]=_0x26509d(0x108)),_0xd26c19;})),_0x222a16;})),_0x671932;}async[_0x1a6478(0xdf)](_0x5a97c7,_0xd30b83,_0x115818){const _0x559de1=_0x1a6478,{openaiBaseUrl:openaiBaseUrl='',openaiBaseKey:openaiBaseKey='',openaiBaseModel:_0x5489d7}=await this['globalConfigService'][_0x559de1(0x115)]([_0x559de1(0xc6),_0x559de1(0x114),_0x559de1(0xc4)]),_0x455c1f=openaiBaseKey,_0x53c67b=openaiBaseUrl;let _0x1d4f14=[];_0xd30b83&&_0x1d4f14[_0x559de1(0x107)]({'role':_0x559de1(0xf5),'content':_0xd30b83});_0x115818&&_0x115818[_0x559de1(0xd8)]>0x0?_0x1d4f14=_0x1d4f14[_0x559de1(0xd3)](_0x115818):_0x1d4f14[_0x559de1(0x107)]({'role':'user','content':_0x5a97c7});const _0x155cec={'method':_0x559de1(0xf6),'url':_0x53c67b+_0x559de1(0xea),'headers':{'Content-Type':_0x559de1(0x113),'Authorization':_0x559de1(0xf1)+_0x455c1f},'data':{'model':_0x5489d7||'gpt-3.5-turbo-0125','messages':_0x1d4f14}};try{const _0x3b351b=await(0x0,axios_1['default'])(_0x155cec);return common_1['Logger'][_0x559de1(0xfe)](_0x559de1(0x103)+(_0x3b351b===null||_0x3b351b===void 0x0?void 0x0:_0x3b351b[_0x559de1(0xe7)][_0x559de1(0xca)][0x0][_0x559de1(0xe5)][_0x559de1(0xdc)]),'ChatService'),_0x3b351b===null||_0x3b351b===void 0x0?void 0x0:_0x3b351b[_0x559de1(0xe7)][_0x559de1(0xca)][0x0][_0x559de1(0xe5)][_0x559de1(0xdc)];}catch(_0x1c9be3){console[_0x559de1(0xfe)](_0x559de1(0x10c),_0x1c9be3);}}};OpenAIChatService=__decorate([(0x0,common_1[_0x1a6478(0xe6)])(),__metadata(_0x1a6478(0xf4),[globalConfig_service_1[_0x1a6478(0xeb)]])],OpenAIChatService),exports[_0x1a6478(0xd5)]=OpenAIChatService;