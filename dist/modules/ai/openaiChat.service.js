'use strict';function _0x18e9(){const _0x17dc03=['startsWith','toString','content','headers','temperature','error','messages','处理结束信号\x20[DONE]','openAIChat','assign','****','stream','message','defineProperty','design:paramtypes','stringify','__esModule','image_url','gpt-3.5-turbo-0125','390190gDFheQ','split','slice','data:image/***;base64\x20...\x20...','trim','concat','error:\x20','603008luZhKZ','log','url','请求配置:','data:\x20','ChatService','/v1/chat/completions','3953735CyKZSL','pop','choices','Logger','function','Authorization','data','@nestjs/common','336324QVgOEG','Injectable','../globalConfig/globalConfig.service','handleError','33nxlPfl','parse','154ThsYmc','default','sanitizeOptionsForLogging','abort','application/json','1406328CNiJCB','decorate','system','308LszHbt','user','6chhPvp','axios','length','type','addEventListener','1155216EKZDQI','__metadata','812434ffysLs','object','Bearer\x20','POST','answer','isArray','getOwnPropertyDescriptor','9dOmlLi','OpenAIChatService','globalConfigService','GlobalConfigService'];_0x18e9=function(){return _0x17dc03;};return _0x18e9();}const _0x247bb1=_0x122c;(function(_0x4913ef,_0x4b9b66){const _0x16c255=_0x122c,_0x471cf8=_0x4913ef();while(!![]){try{const _0x320da3=parseInt(_0x16c255(0x216))/0x1+parseInt(_0x16c255(0x20a))/0x2+-parseInt(_0x16c255(0x203))/0x3*(parseInt(_0x16c255(0x1ff))/0x4)+parseInt(_0x16c255(0x1f7))/0x5*(-parseInt(_0x16c255(0x20f))/0x6)+-parseInt(_0x16c255(0x205))/0x7*(parseInt(_0x16c255(0x1f0))/0x8)+-parseInt(_0x16c255(0x21d))/0x9*(-parseInt(_0x16c255(0x1e9))/0xa)+parseInt(_0x16c255(0x20d))/0xb*(parseInt(_0x16c255(0x214))/0xc);if(_0x320da3===_0x4b9b66)break;else _0x471cf8['push'](_0x471cf8['shift']());}catch(_0x230da5){_0x471cf8['push'](_0x471cf8['shift']());}}}(_0x18e9,0xd5eb3));function _0x122c(_0x4388fb,_0x3b2e37){const _0x18e9e8=_0x18e9();return _0x122c=function(_0x122cf0,_0x24bd63){_0x122cf0=_0x122cf0-0x1dc;let _0x4696ad=_0x18e9e8[_0x122cf0];return _0x4696ad;},_0x122c(_0x4388fb,_0x3b2e37);}var __decorate=this&&this['__decorate']||function(_0x3aa393,_0x213523,_0x29b374,_0x2b5bd5){const _0x577b5c=_0x122c;var _0x137286=arguments[_0x577b5c(0x211)],_0x5888e3=_0x137286<0x3?_0x213523:_0x2b5bd5===null?_0x2b5bd5=Object[_0x577b5c(0x21c)](_0x213523,_0x29b374):_0x2b5bd5,_0x295cd9;if(typeof Reflect==='object'&&typeof Reflect[_0x577b5c(0x20b)]===_0x577b5c(0x1fb))_0x5888e3=Reflect[_0x577b5c(0x20b)](_0x3aa393,_0x213523,_0x29b374,_0x2b5bd5);else{for(var _0x119e6a=_0x3aa393['length']-0x1;_0x119e6a>=0x0;_0x119e6a--)if(_0x295cd9=_0x3aa393[_0x119e6a])_0x5888e3=(_0x137286<0x3?_0x295cd9(_0x5888e3):_0x137286>0x3?_0x295cd9(_0x213523,_0x29b374,_0x5888e3):_0x295cd9(_0x213523,_0x29b374))||_0x5888e3;}return _0x137286>0x3&&_0x5888e3&&Object[_0x577b5c(0x1e3)](_0x213523,_0x29b374,_0x5888e3),_0x5888e3;},__metadata=this&&this[_0x247bb1(0x215)]||function(_0x1040d1,_0xf9d5e5){const _0xc5f29a=_0x247bb1;if(typeof Reflect===_0xc5f29a(0x217)&&typeof Reflect['metadata']===_0xc5f29a(0x1fb))return Reflect['metadata'](_0x1040d1,_0xf9d5e5);};Object['defineProperty'](exports,_0x247bb1(0x1e6),{'value':!![]}),exports[_0x247bb1(0x21e)]=void 0x0;const utils_1=require('../../common/utils'),common_1=require(_0x247bb1(0x1fe)),axios_1=require(_0x247bb1(0x210)),globalConfig_service_1=require(_0x247bb1(0x201));let OpenAIChatService=class OpenAIChatService{constructor(_0x52aeea){const _0x36eac8=_0x247bb1;this[_0x36eac8(0x21f)]=_0x52aeea;}async[_0x247bb1(0x1de)](_0x21f104,_0x58be18){const _0x3926bf=_0x247bb1,{onFailure:_0x67bbb6,onProgress:_0x5d789a,apiKey:_0x1e20b5,model:_0x41e26f,proxyUrl:_0x4ca985,modelName:_0x4f4a38,timeout:_0x35129f,chatId:_0xa0364c,isFileUpload:_0xccbb10,modelAvatar:_0x345e4e,temperature:_0x23069b,abortController:_0x1dcced}=_0x58be18;let _0x3345a3={'text':'','model':'','modelName':_0x4f4a38,'chatId':_0xa0364c,'answer':'','errMsg':'','modelAvatar':_0x345e4e};const _0x26e15d=Object[_0x3926bf(0x1df)]({'model':_0x41e26f,'messages':_0x21f104},_0xccbb10===0x2&&{'max_tokens':0x800});_0x26e15d[_0x3926bf(0x1e1)]=!![],_0x26e15d[_0x3926bf(0x225)]=_0x23069b;const _0x3f7baf={'method':_0x3926bf(0x219),'url':_0x4ca985+_0x3926bf(0x1f6),'responseType':_0x3926bf(0x1e1),'timeout':_0x35129f,'headers':{'Content-Type':_0x3926bf(0x209),'Authorization':_0x3926bf(0x218)+_0x1e20b5},'data':_0x26e15d},_0x4bfcef=await this[_0x3926bf(0x207)](_0x3f7baf);console[_0x3926bf(0x1f1)](_0x3926bf(0x1f3),JSON[_0x3926bf(0x1e5)](_0x4bfcef,null,0x2),_0x3926bf(0x1f5)),console[_0x3926bf(0x1f1)](_0x3926bf(0x1f3),JSON[_0x3926bf(0x1e5)](_0x4bfcef,null,0x2),'ChatService');try{const _0x424a82=await(0x0,axios_1['default'])(_0x3f7baf),_0x99e53f=_0x424a82[_0x3926bf(0x1fd)];let _0x42e57d='';return await new Promise((_0x335182,_0x2fb82f)=>{const _0x51f583=_0x3926bf;_0x99e53f['on'](_0x51f583(0x1fd),_0x1e26f3=>{const _0x2db75a=_0x51f583;_0x42e57d+=_0x1e26f3[_0x2db75a(0x222)]();let _0x2db192=_0x42e57d[_0x2db75a(0x1ea)]('\x0a');_0x42e57d=_0x2db192[_0x2db75a(0x1f8)](),_0x2db192['forEach'](_0x3f5600=>{const _0x2d983c=_0x2db75a;var _0x3d3240,_0x59d457;if(_0x3f5600[_0x2d983c(0x1ed)]()==='data:\x20[DONE]'){console[_0x2d983c(0x1f1)](_0x2d983c(0x1dd)),_0x335182(_0x3345a3);return;}if(_0x3f5600[_0x2d983c(0x221)](_0x2d983c(0x1f4)))try{const _0x56e049=_0x3f5600[_0x2d983c(0x1eb)](0x6)[_0x2d983c(0x1ed)]();if(_0x56e049){const _0x2959e5=JSON['parse'](_0x56e049),_0x2cc60c=((_0x59d457=(_0x3d3240=_0x2959e5[_0x2d983c(0x1f9)][0x0])===null||_0x3d3240===void 0x0?void 0x0:_0x3d3240['delta'])===null||_0x59d457===void 0x0?void 0x0:_0x59d457['content'])||'';_0x3345a3[_0x2d983c(0x21a)]+=_0x2cc60c,_0x5d789a===null||_0x5d789a===void 0x0?void 0x0:_0x5d789a({'text':_0x2cc60c,'answer':_0x3345a3['answer']});}}catch(_0x457fe4){console[_0x2d983c(0x226)]('Error\x20parsing\x20line:',_0x3f5600,_0x457fe4);}});}),_0x99e53f['on']('end',()=>{_0x335182(_0x3345a3);}),_0x99e53f['on'](_0x51f583(0x226),_0x1549cb=>{_0x2fb82f(_0x1549cb);}),_0x1dcced['signal'][_0x51f583(0x213)](_0x51f583(0x208),()=>{_0x335182(_0x3345a3);});}),_0x3345a3;}catch(_0x192b81){return _0x3345a3['errMsg']=(0x0,utils_1[_0x3926bf(0x202)])(_0x192b81),common_1[_0x3926bf(0x1fa)][_0x3926bf(0x226)](_0x3345a3['errMsg']),_0x67bbb6(_0x3345a3),_0x3345a3;}}async['sanitizeOptionsForLogging'](_0x16533f){const _0x467ee1=_0x247bb1,_0x43ddcf=JSON[_0x467ee1(0x204)](JSON[_0x467ee1(0x1e5)](_0x16533f));if(_0x43ddcf[_0x467ee1(0x224)]&&_0x43ddcf[_0x467ee1(0x224)][_0x467ee1(0x1fc)]){const _0x1f9284=_0x43ddcf[_0x467ee1(0x224)]['Authorization'];if(_0x1f9284[_0x467ee1(0x221)](_0x467ee1(0x218))){const _0x578023=_0x1f9284['slice'](0x7);_0x578023['length']>0xa&&(_0x43ddcf[_0x467ee1(0x224)]['Authorization']=_0x467ee1(0x218)+_0x578023['slice'](0x0,0x5)+_0x467ee1(0x1e0)+_0x578023[_0x467ee1(0x1eb)](-0x4));}}return _0x43ddcf[_0x467ee1(0x1fd)]&&_0x43ddcf[_0x467ee1(0x1fd)]['messages']&&Array['isArray'](_0x43ddcf[_0x467ee1(0x1fd)][_0x467ee1(0x1dc)])&&(_0x43ddcf[_0x467ee1(0x1fd)][_0x467ee1(0x1dc)]=_0x43ddcf[_0x467ee1(0x1fd)][_0x467ee1(0x1dc)]['map'](_0x19837c=>{const _0x1384c0=_0x467ee1;return _0x19837c[_0x1384c0(0x223)]&&Array[_0x1384c0(0x21b)](_0x19837c[_0x1384c0(0x223)])&&(_0x19837c[_0x1384c0(0x223)]=_0x19837c[_0x1384c0(0x223)]['map'](_0x3707b1=>{const _0x56e80f=_0x1384c0;return _0x3707b1[_0x56e80f(0x212)]==='image_url'&&_0x3707b1[_0x56e80f(0x1e7)]&&_0x3707b1['image_url'][_0x56e80f(0x1f2)]&&(_0x3707b1[_0x56e80f(0x1e7)][_0x56e80f(0x1f2)]=_0x56e80f(0x1ec)),_0x3707b1;})),_0x19837c;})),_0x43ddcf;}async['chatFree'](_0x472d04,_0x1e132d,_0x8ec57e){const _0x270638=_0x247bb1,{openaiBaseUrl:openaiBaseUrl='',openaiBaseKey:openaiBaseKey='',openaiBaseModel:_0x24916e}=await this[_0x270638(0x21f)]['getConfigs'](['openaiBaseKey','openaiBaseUrl','openaiBaseModel']),_0x36566c=openaiBaseKey,_0xa52d48=openaiBaseUrl;let _0xe0b2f4=[];_0x1e132d&&_0xe0b2f4['push']({'role':_0x270638(0x20c),'content':_0x1e132d});_0x8ec57e&&_0x8ec57e[_0x270638(0x211)]>0x0?_0xe0b2f4=_0xe0b2f4[_0x270638(0x1ee)](_0x8ec57e):_0xe0b2f4['push']({'role':_0x270638(0x20e),'content':_0x472d04});const _0xfef827={'method':_0x270638(0x219),'url':_0xa52d48+_0x270638(0x1f6),'headers':{'Content-Type':_0x270638(0x209),'Authorization':_0x270638(0x218)+_0x36566c},'data':{'model':_0x24916e||_0x270638(0x1e8),'messages':_0xe0b2f4}};try{const _0x3b58ed=await(0x0,axios_1[_0x270638(0x206)])(_0xfef827);return common_1[_0x270638(0x1fa)][_0x270638(0x1f1)]('全局模型调用成功,\x20返回结果:\x20'+(_0x3b58ed===null||_0x3b58ed===void 0x0?void 0x0:_0x3b58ed[_0x270638(0x1fd)][_0x270638(0x1f9)][0x0][_0x270638(0x1e2)]['content']),_0x270638(0x1f5)),_0x3b58ed===null||_0x3b58ed===void 0x0?void 0x0:_0x3b58ed[_0x270638(0x1fd)][_0x270638(0x1f9)][0x0][_0x270638(0x1e2)][_0x270638(0x223)];}catch(_0x3da08f){console['log'](_0x270638(0x1ef),_0x3da08f);}}};OpenAIChatService=__decorate([(0x0,common_1[_0x247bb1(0x200)])(),__metadata(_0x247bb1(0x1e4),[globalConfig_service_1[_0x247bb1(0x220)]])],OpenAIChatService),exports[_0x247bb1(0x21e)]=OpenAIChatService;