'use strict';const _0x573292=_0x3c1c;(function(_0x3825e0,_0x441382){const _0x57ff56=_0x3c1c,_0x5b1bee=_0x3825e0();while(!![]){try{const _0x16ccfa=-parseInt(_0x57ff56(0xd5))/0x1+-parseInt(_0x57ff56(0x103))/0x2+parseInt(_0x57ff56(0xb3))/0x3*(-parseInt(_0x57ff56(0xcb))/0x4)+-parseInt(_0x57ff56(0x109))/0x5*(parseInt(_0x57ff56(0xae))/0x6)+-parseInt(_0x57ff56(0xc0))/0x7*(-parseInt(_0x57ff56(0x108))/0x8)+-parseInt(_0x57ff56(0x10b))/0x9+parseInt(_0x57ff56(0x110))/0xa*(parseInt(_0x57ff56(0xe8))/0xb);if(_0x16ccfa===_0x441382)break;else _0x5b1bee['push'](_0x5b1bee['shift']());}catch(_0x49af69){_0x5b1bee['push'](_0x5b1bee['shift']());}}}(_0x4b8d,0x9ec9f));var __decorate=this&&this[_0x573292(0x114)]||function(_0x1613d0,_0x3a7193,_0x3c4db2,_0x16bf99){const _0xd16a45=_0x573292;var _0x46dcc8=arguments['length'],_0x23d394=_0x46dcc8<0x3?_0x3a7193:_0x16bf99===null?_0x16bf99=Object['getOwnPropertyDescriptor'](_0x3a7193,_0x3c4db2):_0x16bf99,_0x40e171;if(typeof Reflect===_0xd16a45(0xe0)&&typeof Reflect['decorate']===_0xd16a45(0xfd))_0x23d394=Reflect['decorate'](_0x1613d0,_0x3a7193,_0x3c4db2,_0x16bf99);else{for(var _0x5db448=_0x1613d0['length']-0x1;_0x5db448>=0x0;_0x5db448--)if(_0x40e171=_0x1613d0[_0x5db448])_0x23d394=(_0x46dcc8<0x3?_0x40e171(_0x23d394):_0x46dcc8>0x3?_0x40e171(_0x3a7193,_0x3c4db2,_0x23d394):_0x40e171(_0x3a7193,_0x3c4db2))||_0x23d394;}return _0x46dcc8>0x3&&_0x23d394&&Object[_0xd16a45(0x118)](_0x3a7193,_0x3c4db2,_0x23d394),_0x23d394;},__metadata=this&&this[_0x573292(0xdc)]||function(_0x4189f1,_0x182f36){const _0x183801=_0x573292;if(typeof Reflect===_0x183801(0xe0)&&typeof Reflect[_0x183801(0xee)]===_0x183801(0xfd))return Reflect[_0x183801(0xee)](_0x4189f1,_0x182f36);};Object[_0x573292(0x118)](exports,_0x573292(0xe1),{'value':!![]}),exports['MidjourneyService']=void 0x0;const common_1=require(_0x573292(0x113)),axios_1=require(_0x573292(0x100)),chatLog_service_1=require('../chatLog/chatLog.service'),globalConfig_service_1=require(_0x573292(0xe3)),upload_service_1=require(_0x573292(0xf7)),models_service_1=require('../models/models.service');function _0x3c1c(_0x189028,_0x319556){const _0x4b8d59=_0x4b8d();return _0x3c1c=function(_0x3c1cb4,_0x35dc49){_0x3c1cb4=_0x3c1cb4-0xae;let _0x20d3cd=_0x4b8d59[_0x3c1cb4];return _0x20d3cd;},_0x3c1c(_0x189028,_0x319556);}let MidjourneyService=class MidjourneyService{constructor(_0x142c93,_0x4df2f4,_0x46205b,_0x273da0){const _0x1e0e22=_0x573292;this['uploadService']=_0x142c93,this['globalConfigService']=_0x4df2f4,this[_0x1e0e22(0xc2)]=_0x46205b,this[_0x1e0e22(0x101)]=_0x273da0;}async[_0x573292(0xca)](_0x4bd37d){const _0x42bd34=_0x573292;var _0x33735c,_0x1d7c6a,_0x22b678,_0x458082;const {id:_0xf8e07e,apiKey:_0x3303cb,proxyUrl:_0x1f18d7,action:_0x383307,drawId:_0x7e4241,prompt:_0x1e842f,usePrompt:_0x9c3321,customId:_0x202181,timeout:_0x3eb5c2,fileInfo:_0x1ea694,assistantLogId:_0x23ac49,pluginName:_0x330549}=_0x4bd37d;let _0x224fdf={'text':'','fileInfo':'','drawId':'','customId':'','status':0x2};const _0x1a5051=this[_0x42bd34(0x115)](_0x330549),_0x4be142=await this[_0x42bd34(0x101)][_0x42bd34(0x105)](_0x1a5051),_0x304806=(_0x4be142===null||_0x4be142===void 0x0?void 0x0:_0x4be142[_0x42bd34(0xcd)])||_0x3303cb;let _0x5f0c56,_0x5b7ed1=0x0,_0xb8a9b8='';const _0x9adf56={'mj-api-secret':_0x304806};common_1[_0x42bd34(0xd0)]['debug'](_0x42bd34(0xbe)+_0x383307,'MidjourneyService');while(_0x5b7ed1<0x3){let _0x12ef72={};try{if(_0x383307===_0x42bd34(0xcc))_0xb8a9b8=_0x1f18d7+_0x42bd34(0xaf),_0x12ef72={'prompt':_0x9c3321};else{if(_0x383307===_0x42bd34(0xff)){_0xb8a9b8=_0x1f18d7+_0x42bd34(0xd7);if(_0x1ea694){const _0x2335de=await fetch(_0x1ea694),_0x2b05a9=await _0x2335de[_0x42bd34(0xbf)](),_0x1ec2c4=Buffer[_0x42bd34(0xda)](await _0x2b05a9[_0x42bd34(0xd2)]()),_0x1582d4=_0x1ec2c4[_0x42bd34(0xc4)](_0x42bd34(0xde));_0x12ef72={'base64':_0x42bd34(0xc7)+_0x1582d4};}else return;}else _0x383307===_0x42bd34(0xe6)?(_0xb8a9b8=_0x1f18d7+_0x42bd34(0xd1),_0x12ef72={'taskId':_0x7e4241,'customId':_0x202181},_0x5f0c56=await axios_1[_0x42bd34(0xf1)]['post'](_0xb8a9b8,_0x12ef72,{'headers':_0x9adf56}),(_0x5f0c56===null||_0x5f0c56===void 0x0?void 0x0:_0x5f0c56['status'])===0xc8&&((_0x33735c=_0x5f0c56===null||_0x5f0c56===void 0x0?void 0x0:_0x5f0c56[_0x42bd34(0x104)])===null||_0x33735c===void 0x0?void 0x0:_0x33735c[_0x42bd34(0xf2)])&&(_0xb8a9b8=_0x1f18d7+_0x42bd34(0xe5),_0x12ef72={'taskId':(_0x1d7c6a=_0x5f0c56===null||_0x5f0c56===void 0x0?void 0x0:_0x5f0c56[_0x42bd34(0x104)])===null||_0x1d7c6a===void 0x0?void 0x0:_0x1d7c6a['result']})):(_0xb8a9b8=_0x1f18d7+_0x42bd34(0xd1),_0x12ef72={'taskId':_0x7e4241,'customId':_0x202181});}common_1['Logger'][_0x42bd34(0xc6)](_0x42bd34(0xc5)+_0xb8a9b8+_0x42bd34(0xfa)+JSON['stringify'](_0x12ef72)+_0x42bd34(0xf0)+JSON[_0x42bd34(0xec)](_0x9adf56),_0x42bd34(0xba)),_0x5f0c56=await axios_1['default'][_0x42bd34(0xf3)](_0xb8a9b8,_0x12ef72,{'headers':_0x9adf56});if((_0x5f0c56===null||_0x5f0c56===void 0x0?void 0x0:_0x5f0c56[_0x42bd34(0xb6)])===0xc8&&((_0x22b678=_0x5f0c56===null||_0x5f0c56===void 0x0?void 0x0:_0x5f0c56['data'])===null||_0x22b678===void 0x0?void 0x0:_0x22b678[_0x42bd34(0xf2)])){common_1[_0x42bd34(0xd0)][_0x42bd34(0x107)]('收到响应:\x20'+JSON[_0x42bd34(0xec)](_0x5f0c56['data']),_0x42bd34(0xba)),_0x224fdf[_0x42bd34(0xce)]=(_0x458082=_0x5f0c56===null||_0x5f0c56===void 0x0?void 0x0:_0x5f0c56['data'])===null||_0x458082===void 0x0?void 0x0:_0x458082[_0x42bd34(0xf2)],_0x224fdf[_0x42bd34(0x111)]=0x2,_0x224fdf[_0x42bd34(0x106)]=_0x42bd34(0xe9),common_1[_0x42bd34(0xd0)][_0x42bd34(0xc6)]('绘画任务提交成功,\x20绘画ID:\x20'+_0x5f0c56[_0x42bd34(0x104)][_0x42bd34(0xf2)],'MidjourneyService');break;}else throw new Error(_0x42bd34(0xb1));}catch(_0x3f7ed9){_0x5b7ed1++,_0x5b7ed1>=0x3&&(_0x224fdf['answer']='任务提交失败，请检查提示词后重试',_0x224fdf[_0x42bd34(0xb6)]=0x5,common_1[_0x42bd34(0xd0)][_0x42bd34(0xc6)]('绘画任务提交失败,\x20请检查后台配置或者稍后重试!\x20'+_0x3f7ed9,_0x42bd34(0xba)));}}return this[_0x42bd34(0x10e)]({'proxyUrl':_0x1f18d7,'apiKey':_0x304806,'drawId':_0x224fdf[_0x42bd34(0xce)],'timeout':_0x3eb5c2,'prompt':_0x1e842f,'onSuccess':async _0x597bfc=>{const _0x31e04f=_0x42bd34;await this[_0x31e04f(0xc2)][_0x31e04f(0x10d)](_0x23ac49,{'fileInfo':_0x597bfc===null||_0x597bfc===void 0x0?void 0x0:_0x597bfc[_0x31e04f(0x116)],'answer':(_0x597bfc===null||_0x597bfc===void 0x0?void 0x0:_0x597bfc[_0x31e04f(0x106)])||_0x1e842f,'progress':'100%','status':0x3,'drawId':_0x597bfc===null||_0x597bfc===void 0x0?void 0x0:_0x597bfc[_0x31e04f(0xce)],'customId':_0x597bfc===null||_0x597bfc===void 0x0?void 0x0:_0x597bfc[_0x31e04f(0x10a)]}),common_1[_0x31e04f(0xd0)]['log'](_0x31e04f(0xd9),'MidjourneyService');},'onDrawing':async _0x279ffb=>{const _0x15b41e=_0x42bd34;await this[_0x15b41e(0xc2)][_0x15b41e(0x10d)](_0x23ac49,{'answer':(_0x279ffb===null||_0x279ffb===void 0x0?void 0x0:_0x279ffb[_0x15b41e(0x106)])||'绘制中','progress':_0x279ffb===null||_0x279ffb===void 0x0?void 0x0:_0x279ffb[_0x15b41e(0xb0)],'status':0x2}),common_1['Logger'][_0x15b41e(0xc6)](_0x15b41e(0xb9)+(_0x279ffb===null||_0x279ffb===void 0x0?void 0x0:_0x279ffb['progress']),'MidjourneyService');},'onFailure':async _0x352d18=>{const _0x396c3d=_0x42bd34;await this[_0x396c3d(0xc2)][_0x396c3d(0x10d)](_0x23ac49,{'answer':_0x396c3d(0x119),'status':_0x352d18[_0x396c3d(0xb6)]}),common_1['Logger'][_0x396c3d(0xc6)](_0x396c3d(0x119),'MidjourneyService');}})['catch'](_0x1b7a03=>{const _0x4ea121=_0x42bd34;common_1[_0x4ea121(0xd0)][_0x4ea121(0xb4)]('查询绘图结果时发生错误:',_0x1b7a03,_0x4ea121(0xba));}),_0x224fdf;}async[_0x573292(0x10e)](_0x27f3d6){const _0x549e2c=_0x573292,{proxyUrl:_0x1ecb47,apiKey:_0x53884e,drawId:_0x4e12a9,timeout:_0x172ae0,onSuccess:_0x30eccc,prompt:_0x44ea0a,onFailure:_0x39ba21,onDrawing:_0x1779dd}=_0x27f3d6,{mjNotSaveImg:_0x5a9245,mjProxyImgUrl:_0x5a6aa7,mjNotUseProxy:_0x451f05}=await this['globalConfigService']['getConfigs']([_0x549e2c(0xe2),_0x549e2c(0xbd),_0x549e2c(0xf8)]);let _0x521806={'fileInfo':'','drawId':'','customId':'','status':0x2,'progress':0x0,'answer':''};const _0x3c1e98=Date[_0x549e2c(0xc3)](),_0x47fc69=0x1388;let _0xf8b4f2=0x0;try{while(Date[_0x549e2c(0xc3)]()-_0x3c1e98<_0x172ae0){await new Promise(_0x365e14=>setTimeout(_0x365e14,_0x47fc69));try{const _0xaf1bc={'Content-Type':_0x549e2c(0xfc),'mj-api-secret':_0x53884e},_0xcaec07=_0x1ecb47+'/mj/task/'+_0x4e12a9+_0x549e2c(0xc9),_0x11cc81=await axios_1[_0x549e2c(0xf1)]['get'](_0xcaec07,{'headers':_0xaf1bc}),_0x4c4ed4=_0x11cc81[_0x549e2c(0x104)];common_1[_0x549e2c(0xd0)][_0x549e2c(0x107)](_0x549e2c(0xb7)+JSON[_0x549e2c(0xec)](_0x4c4ed4),'MidjourneyService');if(_0x4c4ed4[_0x549e2c(0xb6)]===_0x549e2c(0x112)){common_1[_0x549e2c(0xd0)][_0x549e2c(0xc6)](_0x549e2c(0xe7)+_0x4c4ed4[_0x549e2c(0xd3)],_0x549e2c(0xba));let _0x432baa=_0x4c4ed4[_0x549e2c(0xd3)];const _0x3ff0e6=_0x451f05==='0'&&_0x5a6aa7;let _0x392045='';if(_0x3ff0e6){const _0x10a3c9=new URL(_0x5a6aa7),_0x4bf8f5=new URL(_0x4c4ed4['imageUrl']);_0x4bf8f5[_0x549e2c(0xdd)]=_0x10a3c9[_0x549e2c(0xdd)],_0x4bf8f5['hostname']=_0x10a3c9['hostname'],_0x4bf8f5['port']=_0x10a3c9[_0x549e2c(0xd8)]?_0x10a3c9[_0x549e2c(0xd8)]:'',_0x432baa=_0x4bf8f5[_0x549e2c(0xc4)](),_0x392045='使用代理替换后的\x20URL:\x20'+_0x432baa,common_1[_0x549e2c(0xd0)]['log'](_0x392045,_0x549e2c(0xba));}if(_0x5a9245!=='1'){try{common_1['Logger'][_0x549e2c(0xc6)](_0x549e2c(0x117),_0x549e2c(0xba));const _0xe17147=new Date(),_0x56908f=_0xe17147[_0x549e2c(0xeb)](),_0x52e956=String(_0xe17147[_0x549e2c(0xcf)]()+0x1)[_0x549e2c(0xfb)](0x2,'0'),_0x45b705=String(_0xe17147[_0x549e2c(0xbb)]())[_0x549e2c(0xfb)](0x2,'0'),_0x29c9fb=''+_0x56908f+_0x52e956+'/'+_0x45b705;_0x432baa=await this[_0x549e2c(0xf6)][_0x549e2c(0xb2)]({'url':_0x432baa,'dir':_0x549e2c(0x10f)+_0x29c9fb}),_0x392045=_0x549e2c(0xc8)+_0x432baa;}catch(_0x28eda2){common_1['Logger'][_0x549e2c(0xb4)](_0x549e2c(0xb5)),_0x392045='存储图片失败，使用原始/代理图片链接\x20'+_0x432baa;}common_1[_0x549e2c(0xd0)][_0x549e2c(0xc6)](_0x392045,_0x549e2c(0xba));}else _0x392045=_0x549e2c(0xef)+_0x432baa,common_1['Logger'][_0x549e2c(0xc6)](_0x392045,_0x549e2c(0xba));_0x521806[_0x549e2c(0x116)]=_0x432baa,_0x521806['drawId']=_0x4c4ed4['id'],_0x521806['customId']=JSON['stringify'](_0x4c4ed4[_0x549e2c(0x10c)]),_0x521806['answer']=_0x44ea0a+'\x0a'+(_0x4c4ed4['finalPrompt']||_0x4c4ed4[_0x549e2c(0x102)]['finalPrompt']||''),_0x30eccc(_0x521806);return;}_0x521806[_0x549e2c(0xb0)]=_0x4c4ed4===null||_0x4c4ed4===void 0x0?void 0x0:_0x4c4ed4['progress'],_0x521806['answer']=_0x549e2c(0xf4)+(_0x4c4ed4===null||_0x4c4ed4===void 0x0?void 0x0:_0x4c4ed4[_0x549e2c(0xb0)]),_0x521806[_0x549e2c(0xb0)]&&_0x1779dd(_0x521806);}catch(_0x54ba36){_0xf8b4f2++,common_1[_0x549e2c(0xd0)][_0x549e2c(0xb4)]('轮询过程中发生错误:\x20'+_0x54ba36,_0x549e2c(0xba));}}common_1[_0x549e2c(0xd0)]['error'](_0x549e2c(0xd4)+_0x3c1e98/0x3e8+_0x549e2c(0xe4)),_0x521806[_0x549e2c(0xb6)]=0x4,_0x39ba21(_0x521806);throw new common_1[(_0x549e2c(0xbc))](_0x549e2c(0xdb),common_1[_0x549e2c(0xf5)]['BAD_REQUEST']);}catch(_0x4134cb){common_1[_0x549e2c(0xd0)]['error'](_0x549e2c(0xc1)+_0x4134cb+_0x549e2c(0xf9)),_0x521806[_0x549e2c(0xb6)]=0x5,_0x39ba21(_0x521806);}}[_0x573292(0x115)](_0x44ef9f){const _0x2c68c1=_0x573292;return _0x2c68c1(0xdf);}};MidjourneyService=__decorate([(0x0,common_1['Injectable'])(),__metadata(_0x573292(0xed),[upload_service_1[_0x573292(0xfe)],globalConfig_service_1[_0x573292(0xb8)],chatLog_service_1[_0x573292(0xea)],models_service_1[_0x573292(0xd6)]])],MidjourneyService),exports[_0x573292(0xba)]=MidjourneyService;function _0x4b8d(){const _0x43b2a1=['绘画失败:\x20','chatLogService','now','toString','正在准备发送请求到\x20','log','data:image/png;base64,','上传成功\x20URL:\x20','/fetch','midjourneyDraw','3016nNmvSv','IMAGINE','key','drawId','getMonth','Logger','/mj/submit/action','arrayBuffer','imageUrl','超过\x20','105098MWakOr','ModelsService','/mj/submit/describe','port','绘图成功！','from','绘画超时，请稍后再试！','__metadata','protocol','base64','midjourney','object','__esModule','mjNotSaveImg','../globalConfig/globalConfig.service','\x20s\x20未完成绘画,\x20请稍后再试!\x20MidjourneyService','/mj/submit/modal','PICREADER','绘制成功,\x20获取到的URL:\x20','11tZdWYB','绘画任务提交成功','ChatLogService','getFullYear','stringify','design:paramtypes','metadata','不保存图片，使用\x20URL:\x20',',\x20headers:\x20','default','result','post','当前绘制进度\x20','HttpStatus','uploadService','../upload/upload.service','mjNotUseProxy','\x20MidjourneyService','，payload:\x20','padStart','application/x-www-form-urlencoded','function','UploadService','DESCRIBE','axios','modelsService','properties','81992JOxzoA','data','getModelConfigByName','answer','debug','2795304CKGszf','65WfjOqj','customId','9207774nLKBJv','buttons','updateChatLog','pollMjDrawingResult','images/midjourney/','26006350ugHOkS','state','SUCCESS','@nestjs/common','__decorate','getMidjourneyModelByPlugin','fileInfo','------>\x20开始上传图片！！！','defineProperty','绘图失败','546054SNQVwX','/mj/submit/imagine','progress','未能获取结果数据,\x20即将重试','uploadFileFromUrl','2571lOKCds','error','存储图片失败，使用原始/代理图片链接','status','查询结果:\x20','GlobalConfigService','绘制中！绘制进度','MidjourneyService','getDate','HttpException','mjProxyImgUrl','当前任务类型:\x20','blob','21GCbnvJ'];_0x4b8d=function(){return _0x43b2a1;};return _0x4b8d();}