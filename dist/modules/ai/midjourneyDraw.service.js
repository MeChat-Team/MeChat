'use strict';const _0x501fac=_0x5a37;(function(_0x4c8fc6,_0x256311){const _0x3af59e=_0x5a37,_0x127571=_0x4c8fc6();while(!![]){try{const _0x48468a=parseInt(_0x3af59e(0xaf))/0x1+parseInt(_0x3af59e(0xd4))/0x2+parseInt(_0x3af59e(0xcd))/0x3+-parseInt(_0x3af59e(0xe8))/0x4*(parseInt(_0x3af59e(0xb8))/0x5)+parseInt(_0x3af59e(0x10f))/0x6+-parseInt(_0x3af59e(0xe7))/0x7*(parseInt(_0x3af59e(0xd8))/0x8)+-parseInt(_0x3af59e(0xd5))/0x9;if(_0x48468a===_0x256311)break;else _0x127571['push'](_0x127571['shift']());}catch(_0x691f31){_0x127571['push'](_0x127571['shift']());}}}(_0x1452,0xe7166));var __decorate=this&&this['__decorate']||function(_0x24b462,_0x2f021d,_0x5acdaa,_0x15d9db){const _0xde7ef9=_0x5a37;var _0x55de7a=arguments['length'],_0x36a670=_0x55de7a<0x3?_0x2f021d:_0x15d9db===null?_0x15d9db=Object[_0xde7ef9(0xda)](_0x2f021d,_0x5acdaa):_0x15d9db,_0x2dfd2b;if(typeof Reflect===_0xde7ef9(0xb5)&&typeof Reflect['decorate']==='function')_0x36a670=Reflect[_0xde7ef9(0xe2)](_0x24b462,_0x2f021d,_0x5acdaa,_0x15d9db);else{for(var _0x373d43=_0x24b462[_0xde7ef9(0xb3)]-0x1;_0x373d43>=0x0;_0x373d43--)if(_0x2dfd2b=_0x24b462[_0x373d43])_0x36a670=(_0x55de7a<0x3?_0x2dfd2b(_0x36a670):_0x55de7a>0x3?_0x2dfd2b(_0x2f021d,_0x5acdaa,_0x36a670):_0x2dfd2b(_0x2f021d,_0x5acdaa))||_0x36a670;}return _0x55de7a>0x3&&_0x36a670&&Object[_0xde7ef9(0xdc)](_0x2f021d,_0x5acdaa,_0x36a670),_0x36a670;},__metadata=this&&this[_0x501fac(0xc6)]||function(_0x173ce2,_0x219332){const _0x1e8285=_0x501fac;if(typeof Reflect===_0x1e8285(0xb5)&&typeof Reflect[_0x1e8285(0x109)]==='function')return Reflect['metadata'](_0x173ce2,_0x219332);};function _0x5a37(_0x1e53a5,_0x1791fa){const _0x1452b0=_0x1452();return _0x5a37=function(_0x5a37e4,_0x17f4c4){_0x5a37e4=_0x5a37e4-0xae;let _0x372c81=_0x1452b0[_0x5a37e4];return _0x372c81;},_0x5a37(_0x1e53a5,_0x1791fa);}Object['defineProperty'](exports,_0x501fac(0xd1),{'value':!![]}),exports[_0x501fac(0xfb)]=void 0x0;function _0x1452(){const _0x5eb91f=['HttpException','metadata','mjNotUseProxy','protocol','绘画任务提交成功,\x20绘画ID:\x20','存储图片失败，使用原始/代理图片链接\x20','progress','10981968yauawT','getMidjourneyModelByPlugin','modelsService','getMonth','drawId','error','pollMjDrawingResult','不保存图片，使用\x20URL:\x20','IMAGINE','getConfigs','超过\x20','1514980JbvfII','answer','正在准备发送请求到\x20','updateChatLog','length','mjProxyImgUrl','object','padStart','chatLogService','5660PlJnCZ','Logger','properties','debug','../chatLog/chatLog.service','/mj/submit/describe','PICREADER','../models/models.service','state','axios','midjourneyDraw','log','绘图失败','midjourney','__metadata','绘图成功！','uploadService','../upload/upload.service','hostname','------>\x20开始上传图片！！！','../globalConfig/globalConfig.service','5495913qlqOhM','上传成功\x20URL:\x20','当前任务类型:\x20','/mj/submit/action','__esModule','UploadService','fileInfo','1851286whSXzr','37411245oNgxZE','stringify','now','38296JhmpjP','绘制中','getOwnPropertyDescriptor','post','defineProperty','arrayBuffer','default','ModelsService','/mj/submit/imagine','toString','decorate','design:paramtypes','ChatLogService','customId','GlobalConfigService','735SjCxdf','1756cPPIai','查询绘图结果时发生错误:','getDate','收到响应:\x20',',\x20headers:\x20','Injectable','key','使用代理替换后的\x20URL:\x20','status','未能获取结果数据,\x20即将重试','get','HttpStatus','\x20s\x20未完成绘画,\x20请稍后再试!\x20MidjourneyService','任务提交失败，请检查提示词后重试','，payload:\x20','DESCRIBE','查询结果:\x20','data','100%','MidjourneyService','绘画失败:\x20','\x20MidjourneyService','result','BAD_REQUEST','port','application/x-www-form-urlencoded','finalPrompt','images/midjourney/','imageUrl','绘画任务提交失败,\x20请检查后台配置或者稍后重试!\x20','buttons','getFullYear'];_0x1452=function(){return _0x5eb91f;};return _0x1452();}const common_1=require('@nestjs/common'),axios_1=require(_0x501fac(0xc1)),chatLog_service_1=require(_0x501fac(0xbc)),globalConfig_service_1=require(_0x501fac(0xcc)),upload_service_1=require(_0x501fac(0xc9)),models_service_1=require(_0x501fac(0xbf));let MidjourneyService=class MidjourneyService{constructor(_0x516cd2,_0x31a3a9,_0x5c0be2,_0x56bd6d){const _0x79c91d=_0x501fac;this[_0x79c91d(0xc8)]=_0x516cd2,this['globalConfigService']=_0x31a3a9,this[_0x79c91d(0xb7)]=_0x5c0be2,this[_0x79c91d(0x111)]=_0x56bd6d;}async[_0x501fac(0xc2)](_0x29d2c0){const _0x15fa2d=_0x501fac;var _0x1b626a,_0x55ba9b,_0x2b015a,_0x439974;const {id:_0xdce41b,apiKey:_0x11c5d2,proxyUrl:_0x4b2586,action:_0x3c1bbb,drawId:_0x2eda3a,prompt:_0x14e257,usePrompt:_0x33d06b,customId:_0x366611,timeout:_0x21c198,fileInfo:_0x59c864,assistantLogId:_0x25d8e4,pluginName:_0xb12ce1}=_0x29d2c0;let _0x2e92db={'text':'','fileInfo':'','drawId':'','customId':'','status':0x2};const _0x51627f=this[_0x15fa2d(0x110)](_0xb12ce1),_0x407d0f=await this['modelsService']['getModelConfigByName'](_0x51627f),_0x58c6ef=(_0x407d0f===null||_0x407d0f===void 0x0?void 0x0:_0x407d0f[_0x15fa2d(0xee)])||_0x11c5d2;let _0x956e,_0x28ea76=0x0,_0x293677='';const _0x4b55c9={'mj-api-secret':_0x58c6ef};common_1['Logger']['debug'](_0x15fa2d(0xcf)+_0x3c1bbb,'MidjourneyService');while(_0x28ea76<0x3){let _0x206c04={};try{if(_0x3c1bbb===_0x15fa2d(0x117))_0x293677=_0x4b2586+_0x15fa2d(0xe0),_0x206c04={'prompt':_0x33d06b};else{if(_0x3c1bbb===_0x15fa2d(0xf7)){_0x293677=_0x4b2586+_0x15fa2d(0xbd);if(_0x59c864){const _0x1afa2f=await fetch(_0x59c864),_0x2ae3e0=await _0x1afa2f['blob'](),_0x2971f6=Buffer['from'](await _0x2ae3e0[_0x15fa2d(0xdd)]()),_0x5180f7=_0x2971f6[_0x15fa2d(0xe1)]('base64');_0x206c04={'base64':'data:image/png;base64,'+_0x5180f7};}else return;}else _0x3c1bbb===_0x15fa2d(0xbe)?(_0x293677=_0x4b2586+'/mj/submit/action',_0x206c04={'taskId':_0x2eda3a,'customId':_0x366611},_0x956e=await axios_1[_0x15fa2d(0xde)][_0x15fa2d(0xdb)](_0x293677,_0x206c04,{'headers':_0x4b55c9}),(_0x956e===null||_0x956e===void 0x0?void 0x0:_0x956e[_0x15fa2d(0xf0)])===0xc8&&((_0x1b626a=_0x956e===null||_0x956e===void 0x0?void 0x0:_0x956e[_0x15fa2d(0xf9)])===null||_0x1b626a===void 0x0?void 0x0:_0x1b626a[_0x15fa2d(0xfe)])&&(_0x293677=_0x4b2586+'/mj/submit/modal',_0x206c04={'taskId':(_0x55ba9b=_0x956e===null||_0x956e===void 0x0?void 0x0:_0x956e[_0x15fa2d(0xf9)])===null||_0x55ba9b===void 0x0?void 0x0:_0x55ba9b[_0x15fa2d(0xfe)]})):(_0x293677=_0x4b2586+_0x15fa2d(0xd0),_0x206c04={'taskId':_0x2eda3a,'customId':_0x366611});}common_1[_0x15fa2d(0xb9)][_0x15fa2d(0xc3)](_0x15fa2d(0xb1)+_0x293677+_0x15fa2d(0xf6)+JSON[_0x15fa2d(0xd6)](_0x206c04)+_0x15fa2d(0xec)+JSON[_0x15fa2d(0xd6)](_0x4b55c9),_0x15fa2d(0xfb)),_0x956e=await axios_1[_0x15fa2d(0xde)][_0x15fa2d(0xdb)](_0x293677,_0x206c04,{'headers':_0x4b55c9});if((_0x956e===null||_0x956e===void 0x0?void 0x0:_0x956e['status'])===0xc8&&((_0x2b015a=_0x956e===null||_0x956e===void 0x0?void 0x0:_0x956e[_0x15fa2d(0xf9)])===null||_0x2b015a===void 0x0?void 0x0:_0x2b015a[_0x15fa2d(0xfe)])){common_1[_0x15fa2d(0xb9)][_0x15fa2d(0xbb)](_0x15fa2d(0xeb)+JSON[_0x15fa2d(0xd6)](_0x956e[_0x15fa2d(0xf9)]),'MidjourneyService'),_0x2e92db[_0x15fa2d(0x113)]=(_0x439974=_0x956e===null||_0x956e===void 0x0?void 0x0:_0x956e[_0x15fa2d(0xf9)])===null||_0x439974===void 0x0?void 0x0:_0x439974[_0x15fa2d(0xfe)],_0x2e92db[_0x15fa2d(0xc0)]=0x2,_0x2e92db[_0x15fa2d(0xb0)]='绘画任务提交成功',common_1['Logger'][_0x15fa2d(0xc3)](_0x15fa2d(0x10c)+_0x956e[_0x15fa2d(0xf9)]['result'],_0x15fa2d(0xfb));break;}else throw new Error(_0x15fa2d(0xf1));}catch(_0x32fc64){_0x28ea76++,_0x28ea76>=0x3&&(_0x2e92db['answer']=_0x15fa2d(0xf5),_0x2e92db[_0x15fa2d(0xf0)]=0x5,common_1[_0x15fa2d(0xb9)][_0x15fa2d(0xc3)](_0x15fa2d(0x105)+_0x32fc64,_0x15fa2d(0xfb)));}}return this[_0x15fa2d(0x115)]({'proxyUrl':_0x4b2586,'apiKey':_0x58c6ef,'drawId':_0x2e92db['drawId'],'timeout':_0x21c198,'prompt':_0x14e257,'onSuccess':async _0x529e1f=>{const _0x4f4bbc=_0x15fa2d;await this[_0x4f4bbc(0xb7)][_0x4f4bbc(0xb2)](_0x25d8e4,{'fileInfo':_0x529e1f===null||_0x529e1f===void 0x0?void 0x0:_0x529e1f[_0x4f4bbc(0xd3)],'answer':(_0x529e1f===null||_0x529e1f===void 0x0?void 0x0:_0x529e1f[_0x4f4bbc(0xb0)])||_0x14e257,'progress':_0x4f4bbc(0xfa),'status':0x3,'drawId':_0x529e1f===null||_0x529e1f===void 0x0?void 0x0:_0x529e1f['drawId'],'customId':_0x529e1f===null||_0x529e1f===void 0x0?void 0x0:_0x529e1f['customId']}),common_1['Logger'][_0x4f4bbc(0xc3)](_0x4f4bbc(0xc7),_0x4f4bbc(0xfb));},'onDrawing':async _0x9d8eb4=>{const _0x48ef79=_0x15fa2d;await this[_0x48ef79(0xb7)][_0x48ef79(0xb2)](_0x25d8e4,{'answer':(_0x9d8eb4===null||_0x9d8eb4===void 0x0?void 0x0:_0x9d8eb4[_0x48ef79(0xb0)])||_0x48ef79(0xd9),'progress':_0x9d8eb4===null||_0x9d8eb4===void 0x0?void 0x0:_0x9d8eb4['progress'],'status':0x2}),common_1[_0x48ef79(0xb9)][_0x48ef79(0xc3)]('绘制中！绘制进度'+(_0x9d8eb4===null||_0x9d8eb4===void 0x0?void 0x0:_0x9d8eb4[_0x48ef79(0x10e)]),_0x48ef79(0xfb));},'onFailure':async _0x12e6d0=>{const _0x2f76f2=_0x15fa2d;await this[_0x2f76f2(0xb7)][_0x2f76f2(0xb2)](_0x25d8e4,{'answer':'绘图失败','status':_0x12e6d0[_0x2f76f2(0xf0)]}),common_1[_0x2f76f2(0xb9)][_0x2f76f2(0xc3)](_0x2f76f2(0xc4),_0x2f76f2(0xfb));}})['catch'](_0xe9d9c8=>{const _0x4d1d52=_0x15fa2d;common_1[_0x4d1d52(0xb9)][_0x4d1d52(0x114)](_0x4d1d52(0xe9),_0xe9d9c8,'MidjourneyService');}),_0x2e92db;}async[_0x501fac(0x115)](_0x561e04){const _0x26e2a7=_0x501fac,{proxyUrl:_0x1e0cb9,apiKey:_0x25e051,drawId:_0x171c1b,timeout:_0x2425f7,onSuccess:_0x19fd4c,prompt:_0x52e8b5,onFailure:_0x5e26c5,onDrawing:_0x3bab30}=_0x561e04,{mjNotSaveImg:_0x2bbc4c,mjProxyImgUrl:_0x49bffa,mjNotUseProxy:_0x313c70}=await this['globalConfigService'][_0x26e2a7(0x118)](['mjNotSaveImg',_0x26e2a7(0xb4),_0x26e2a7(0x10a)]);let _0x2eee65={'fileInfo':'','drawId':'','customId':'','status':0x2,'progress':0x0,'answer':''};const _0x3b76bf=Date[_0x26e2a7(0xd7)](),_0x25ea35=0x1388;let _0x25a0e5=0x0;try{while(Date[_0x26e2a7(0xd7)]()-_0x3b76bf<_0x2425f7){await new Promise(_0x2ef90f=>setTimeout(_0x2ef90f,_0x25ea35));try{const _0x33a2a6={'Content-Type':_0x26e2a7(0x101),'mj-api-secret':_0x25e051},_0x468b31=_0x1e0cb9+'/mj/task/'+_0x171c1b+'/fetch',_0x1c365b=await axios_1[_0x26e2a7(0xde)][_0x26e2a7(0xf2)](_0x468b31,{'headers':_0x33a2a6}),_0x27cb7c=_0x1c365b[_0x26e2a7(0xf9)];common_1[_0x26e2a7(0xb9)][_0x26e2a7(0xbb)](_0x26e2a7(0xf8)+JSON[_0x26e2a7(0xd6)](_0x27cb7c),_0x26e2a7(0xfb));if(_0x27cb7c[_0x26e2a7(0xf0)]==='SUCCESS'){common_1['Logger'][_0x26e2a7(0xc3)]('绘制成功,\x20获取到的URL:\x20'+_0x27cb7c[_0x26e2a7(0x104)],_0x26e2a7(0xfb));let _0x4b4ac4=_0x27cb7c['imageUrl'];const _0x5ecac1=_0x313c70==='0'&&_0x49bffa;let _0x4dc497='';if(_0x5ecac1){const _0x33f921=new URL(_0x49bffa),_0x10189a=new URL(_0x27cb7c[_0x26e2a7(0x104)]);_0x10189a[_0x26e2a7(0x10b)]=_0x33f921[_0x26e2a7(0x10b)],_0x10189a[_0x26e2a7(0xca)]=_0x33f921[_0x26e2a7(0xca)],_0x10189a[_0x26e2a7(0x100)]=_0x33f921[_0x26e2a7(0x100)]?_0x33f921[_0x26e2a7(0x100)]:'',_0x4b4ac4=_0x10189a['toString'](),_0x4dc497=_0x26e2a7(0xef)+_0x4b4ac4,common_1[_0x26e2a7(0xb9)][_0x26e2a7(0xc3)](_0x4dc497,'MidjourneyService');}if(_0x2bbc4c!=='1'){try{common_1['Logger']['log'](_0x26e2a7(0xcb),_0x26e2a7(0xfb));const _0x3c4caa=new Date(),_0x51de91=_0x3c4caa[_0x26e2a7(0x107)](),_0x3311a2=String(_0x3c4caa[_0x26e2a7(0x112)]()+0x1)[_0x26e2a7(0xb6)](0x2,'0'),_0x5ce5a1=String(_0x3c4caa[_0x26e2a7(0xea)]())[_0x26e2a7(0xb6)](0x2,'0'),_0x4a1159=''+_0x51de91+_0x3311a2+'/'+_0x5ce5a1;_0x4b4ac4=await this[_0x26e2a7(0xc8)]['uploadFileFromUrl']({'url':_0x4b4ac4,'dir':_0x26e2a7(0x103)+_0x4a1159}),_0x4dc497=_0x26e2a7(0xce)+_0x4b4ac4;}catch(_0x4235d7){common_1['Logger'][_0x26e2a7(0x114)]('存储图片失败，使用原始/代理图片链接'),_0x4dc497=_0x26e2a7(0x10d)+_0x4b4ac4;}common_1['Logger'][_0x26e2a7(0xc3)](_0x4dc497,_0x26e2a7(0xfb));}else _0x4dc497=_0x26e2a7(0x116)+_0x4b4ac4,common_1['Logger']['log'](_0x4dc497,'MidjourneyService');_0x2eee65['fileInfo']=_0x4b4ac4,_0x2eee65[_0x26e2a7(0x113)]=_0x27cb7c['id'],_0x2eee65[_0x26e2a7(0xe5)]=JSON[_0x26e2a7(0xd6)](_0x27cb7c[_0x26e2a7(0x106)]),_0x2eee65[_0x26e2a7(0xb0)]=_0x52e8b5+'\x0a'+(_0x27cb7c[_0x26e2a7(0x102)]||_0x27cb7c[_0x26e2a7(0xba)]['finalPrompt']||''),_0x19fd4c(_0x2eee65);return;}_0x2eee65[_0x26e2a7(0x10e)]=_0x27cb7c===null||_0x27cb7c===void 0x0?void 0x0:_0x27cb7c[_0x26e2a7(0x10e)],_0x2eee65['answer']='当前绘制进度\x20'+(_0x27cb7c===null||_0x27cb7c===void 0x0?void 0x0:_0x27cb7c[_0x26e2a7(0x10e)]),_0x2eee65[_0x26e2a7(0x10e)]&&_0x3bab30(_0x2eee65);}catch(_0x54ec0f){_0x25a0e5++,common_1[_0x26e2a7(0xb9)]['error']('轮询过程中发生错误:\x20'+_0x54ec0f,_0x26e2a7(0xfb));}}common_1['Logger']['error'](_0x26e2a7(0xae)+_0x3b76bf/0x3e8+_0x26e2a7(0xf4)),_0x2eee65[_0x26e2a7(0xf0)]=0x4,_0x5e26c5(_0x2eee65);throw new common_1[(_0x26e2a7(0x108))]('绘画超时，请稍后再试！',common_1[_0x26e2a7(0xf3)][_0x26e2a7(0xff)]);}catch(_0x24bcbf){common_1[_0x26e2a7(0xb9)][_0x26e2a7(0x114)](_0x26e2a7(0xfc)+_0x24bcbf+_0x26e2a7(0xfd)),_0x2eee65['status']=0x5,_0x5e26c5(_0x2eee65);}}[_0x501fac(0x110)](_0x5f499d){const _0x2a8f51=_0x501fac;return _0x2a8f51(0xc5);}};MidjourneyService=__decorate([(0x0,common_1[_0x501fac(0xed)])(),__metadata(_0x501fac(0xe3),[upload_service_1[_0x501fac(0xd2)],globalConfig_service_1[_0x501fac(0xe6)],chatLog_service_1[_0x501fac(0xe4)],models_service_1[_0x501fac(0xdf)]])],MidjourneyService),exports['MidjourneyService']=MidjourneyService;