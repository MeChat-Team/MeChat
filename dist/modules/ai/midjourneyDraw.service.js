'use strict';function _0x3bf9(){const _0x156403=['/mj/submit/action','------>\x20开始上传图片！！！','9faCGvk','1HqvmgP','__esModule','不保存图片，使用\x20URL:\x20','getOwnPropertyDescriptor','debug','收到响应:\x20','hostname','images/midjourney/','result','state','__metadata','base64','blob','globalConfigService','fileInfo','chatLogService','from','data','914754xLEoje','使用代理替换后的\x20URL:\x20','任务提交失败，请检查提示词后重试',',\x20headers:\x20','getConfigs','arrayBuffer','progress','绘图成功！','12685432lYynKd','getMidjourneyModelByPlugin','updateChatLog','/fetch','/mj/task/','114ZXpwZl','status','Injectable','padStart','getDate','uploadFileFromUrl','key','midjourney','axios','decorate','drawId','轮询过程中发生错误:\x20','2627182LhbCRa','DESCRIBE','Logger','catch','绘图失败','function','超过\x20','1202180DEMRfV','2023224avwKhb','mjProxyImgUrl','mjNotUseProxy','midjourneyDraw','default','pollMjDrawingResult','now','绘画任务提交失败,\x20请检查后台配置或者稍后重试!\x20','HttpStatus','100%','error','上传成功\x20URL:\x20','GlobalConfigService','44630mnTEGa','当前绘制进度\x20','存储图片失败，使用原始/代理图片链接\x20','正在准备发送请求到\x20','UploadService','__decorate','查询绘图结果时发生错误:','/mj/submit/modal','length','绘画任务提交成功','uploadService','mjNotSaveImg','绘画超时，请稍后再试！','MidjourneyService','defineProperty','answer','post','IMAGINE','HttpException','port','log','imageUrl','object','metadata','\x20MidjourneyService','绘画任务提交成功,\x20绘画ID:\x20','../globalConfig/globalConfig.service','/mj/submit/describe','getModelConfigByName','\x20s\x20未完成绘画,\x20请稍后再试!\x20MidjourneyService','toString','../upload/upload.service','design:paramtypes','data:image/png;base64,','stringify','，payload:\x20','finalPrompt','protocol','绘制中','get','存储图片失败，使用原始/代理图片链接','39945110WbATxG','ModelsService','ChatLogService'];_0x3bf9=function(){return _0x156403;};return _0x3bf9();}const _0x20dede=_0x258b;(function(_0xb49bc5,_0x41b019){const _0x17ffc0=_0x258b,_0x2484f9=_0xb49bc5();while(!![]){try{const _0x50d961=parseInt(_0x17ffc0(0x143))/0x1*(-parseInt(_0x17ffc0(0xff))/0x2)+parseInt(_0x17ffc0(0x155))/0x3+-parseInt(_0x17ffc0(0x107))/0x4+-parseInt(_0x17ffc0(0x114))/0x5*(parseInt(_0x17ffc0(0x162))/0x6)+parseInt(_0x17ffc0(0x106))/0x7+parseInt(_0x17ffc0(0x15d))/0x8*(-parseInt(_0x17ffc0(0x142))/0x9)+parseInt(_0x17ffc0(0x13d))/0xa;if(_0x50d961===_0x41b019)break;else _0x2484f9['push'](_0x2484f9['shift']());}catch(_0x578e5c){_0x2484f9['push'](_0x2484f9['shift']());}}}(_0x3bf9,0xdadf3));var __decorate=this&&this[_0x20dede(0x119)]||function(_0x3e3dbe,_0x5af1d6,_0x49c95f,_0x181266){const _0x1ebc2a=_0x20dede;var _0x23eaea=arguments[_0x1ebc2a(0x11c)],_0x5cef57=_0x23eaea<0x3?_0x5af1d6:_0x181266===null?_0x181266=Object[_0x1ebc2a(0x146)](_0x5af1d6,_0x49c95f):_0x181266,_0x411552;if(typeof Reflect===_0x1ebc2a(0x12a)&&typeof Reflect[_0x1ebc2a(0x16b)]===_0x1ebc2a(0x104))_0x5cef57=Reflect[_0x1ebc2a(0x16b)](_0x3e3dbe,_0x5af1d6,_0x49c95f,_0x181266);else{for(var _0x124fd4=_0x3e3dbe[_0x1ebc2a(0x11c)]-0x1;_0x124fd4>=0x0;_0x124fd4--)if(_0x411552=_0x3e3dbe[_0x124fd4])_0x5cef57=(_0x23eaea<0x3?_0x411552(_0x5cef57):_0x23eaea>0x3?_0x411552(_0x5af1d6,_0x49c95f,_0x5cef57):_0x411552(_0x5af1d6,_0x49c95f))||_0x5cef57;}return _0x23eaea>0x3&&_0x5cef57&&Object[_0x1ebc2a(0x122)](_0x5af1d6,_0x49c95f,_0x5cef57),_0x5cef57;},__metadata=this&&this[_0x20dede(0x14d)]||function(_0xf83f75,_0x4e72d0){const _0x38f618=_0x20dede;if(typeof Reflect==='object'&&typeof Reflect['metadata']===_0x38f618(0x104))return Reflect[_0x38f618(0x12b)](_0xf83f75,_0x4e72d0);};Object[_0x20dede(0x122)](exports,_0x20dede(0x144),{'value':!![]}),exports[_0x20dede(0x121)]=void 0x0;function _0x258b(_0x1ec3d8,_0xe3ea50){const _0x3bf930=_0x3bf9();return _0x258b=function(_0x258bd4,_0x526ed4){_0x258bd4=_0x258bd4-0xfe;let _0x17e4a8=_0x3bf930[_0x258bd4];return _0x17e4a8;},_0x258b(_0x1ec3d8,_0xe3ea50);}const common_1=require('@nestjs/common'),axios_1=require(_0x20dede(0x16a)),chatLog_service_1=require('../chatLog/chatLog.service'),globalConfig_service_1=require(_0x20dede(0x12e)),upload_service_1=require(_0x20dede(0x133)),models_service_1=require('../models/models.service');let MidjourneyService=class MidjourneyService{constructor(_0x45c311,_0x433cbb,_0x1fce57,_0x2a5a40){const _0x4c45dc=_0x20dede;this[_0x4c45dc(0x11e)]=_0x45c311,this[_0x4c45dc(0x150)]=_0x433cbb,this[_0x4c45dc(0x152)]=_0x1fce57,this['modelsService']=_0x2a5a40;}async[_0x20dede(0x10a)](_0x51df13){const _0x2e42fb=_0x20dede;var _0x51f0c0,_0x1dfb5e,_0x5a864c,_0x43783e;const {id:_0x33809c,apiKey:_0x6e5215,proxyUrl:_0x11710d,action:_0x4141a4,drawId:_0x5d03c3,prompt:_0x5a8c10,usePrompt:_0x27909c,customId:_0x2227ac,timeout:_0x182acc,fileInfo:_0x10b60b,assistantLogId:_0x227d62,pluginName:_0x21fb01}=_0x51df13;let _0x4c92dd={'text':'','fileInfo':'','drawId':'','customId':'','status':0x2};const _0x414090=this[_0x2e42fb(0x15e)](_0x21fb01),_0x3debaa=await this['modelsService'][_0x2e42fb(0x130)](_0x414090),_0x9a846d=(_0x3debaa===null||_0x3debaa===void 0x0?void 0x0:_0x3debaa[_0x2e42fb(0x168)])||_0x6e5215;let _0x5e364f,_0xb86ea0=0x0,_0x4ed8c5='';const _0x4872e6={'mj-api-secret':_0x9a846d};common_1[_0x2e42fb(0x101)][_0x2e42fb(0x147)]('当前任务类型:\x20'+_0x4141a4,_0x2e42fb(0x121));while(_0xb86ea0<0x3){let _0x2fca6c={};try{if(_0x4141a4===_0x2e42fb(0x125))_0x4ed8c5=_0x11710d+'/mj/submit/imagine',_0x2fca6c={'prompt':_0x27909c};else{if(_0x4141a4===_0x2e42fb(0x100)){_0x4ed8c5=_0x11710d+_0x2e42fb(0x12f);if(_0x10b60b){const _0x2777bb=await fetch(_0x10b60b),_0x5374bd=await _0x2777bb[_0x2e42fb(0x14f)](),_0xbbc1fb=Buffer[_0x2e42fb(0x153)](await _0x5374bd[_0x2e42fb(0x15a)]()),_0x1ad567=_0xbbc1fb[_0x2e42fb(0x132)](_0x2e42fb(0x14e));_0x2fca6c={'base64':_0x2e42fb(0x135)+_0x1ad567};}else return;}else _0x4141a4==='PICREADER'?(_0x4ed8c5=_0x11710d+_0x2e42fb(0x140),_0x2fca6c={'taskId':_0x5d03c3,'customId':_0x2227ac},_0x5e364f=await axios_1[_0x2e42fb(0x10b)][_0x2e42fb(0x124)](_0x4ed8c5,_0x2fca6c,{'headers':_0x4872e6}),(_0x5e364f===null||_0x5e364f===void 0x0?void 0x0:_0x5e364f[_0x2e42fb(0x163)])===0xc8&&((_0x51f0c0=_0x5e364f===null||_0x5e364f===void 0x0?void 0x0:_0x5e364f[_0x2e42fb(0x154)])===null||_0x51f0c0===void 0x0?void 0x0:_0x51f0c0[_0x2e42fb(0x14b)])&&(_0x4ed8c5=_0x11710d+_0x2e42fb(0x11b),_0x2fca6c={'taskId':(_0x1dfb5e=_0x5e364f===null||_0x5e364f===void 0x0?void 0x0:_0x5e364f[_0x2e42fb(0x154)])===null||_0x1dfb5e===void 0x0?void 0x0:_0x1dfb5e[_0x2e42fb(0x14b)]})):(_0x4ed8c5=_0x11710d+'/mj/submit/action',_0x2fca6c={'taskId':_0x5d03c3,'customId':_0x2227ac});}common_1[_0x2e42fb(0x101)][_0x2e42fb(0x128)](_0x2e42fb(0x117)+_0x4ed8c5+_0x2e42fb(0x137)+JSON[_0x2e42fb(0x136)](_0x2fca6c)+_0x2e42fb(0x158)+JSON[_0x2e42fb(0x136)](_0x4872e6),_0x2e42fb(0x121)),_0x5e364f=await axios_1['default'][_0x2e42fb(0x124)](_0x4ed8c5,_0x2fca6c,{'headers':_0x4872e6});if((_0x5e364f===null||_0x5e364f===void 0x0?void 0x0:_0x5e364f[_0x2e42fb(0x163)])===0xc8&&((_0x5a864c=_0x5e364f===null||_0x5e364f===void 0x0?void 0x0:_0x5e364f['data'])===null||_0x5a864c===void 0x0?void 0x0:_0x5a864c['result'])){common_1[_0x2e42fb(0x101)]['debug'](_0x2e42fb(0x148)+JSON[_0x2e42fb(0x136)](_0x5e364f['data']),'MidjourneyService'),_0x4c92dd[_0x2e42fb(0x16c)]=(_0x43783e=_0x5e364f===null||_0x5e364f===void 0x0?void 0x0:_0x5e364f[_0x2e42fb(0x154)])===null||_0x43783e===void 0x0?void 0x0:_0x43783e[_0x2e42fb(0x14b)],_0x4c92dd[_0x2e42fb(0x14c)]=0x2,_0x4c92dd[_0x2e42fb(0x123)]=_0x2e42fb(0x11d),common_1[_0x2e42fb(0x101)][_0x2e42fb(0x128)](_0x2e42fb(0x12d)+_0x5e364f[_0x2e42fb(0x154)][_0x2e42fb(0x14b)],'MidjourneyService');break;}else throw new Error('未能获取结果数据,\x20即将重试');}catch(_0x2ababa){_0xb86ea0++,_0xb86ea0>=0x3&&(_0x4c92dd[_0x2e42fb(0x123)]=_0x2e42fb(0x157),_0x4c92dd[_0x2e42fb(0x163)]=0x5,common_1[_0x2e42fb(0x101)]['log'](_0x2e42fb(0x10e)+_0x2ababa,_0x2e42fb(0x121)));}}return this[_0x2e42fb(0x10c)]({'proxyUrl':_0x11710d,'apiKey':_0x9a846d,'drawId':_0x4c92dd['drawId'],'timeout':_0x182acc,'prompt':_0x5a8c10,'onSuccess':async _0x6f024c=>{const _0x5200b3=_0x2e42fb;await this[_0x5200b3(0x152)][_0x5200b3(0x15f)](_0x227d62,{'fileInfo':_0x6f024c===null||_0x6f024c===void 0x0?void 0x0:_0x6f024c[_0x5200b3(0x151)],'answer':(_0x6f024c===null||_0x6f024c===void 0x0?void 0x0:_0x6f024c['answer'])||_0x5a8c10,'progress':_0x5200b3(0x110),'status':0x3,'drawId':_0x6f024c===null||_0x6f024c===void 0x0?void 0x0:_0x6f024c[_0x5200b3(0x16c)],'customId':_0x6f024c===null||_0x6f024c===void 0x0?void 0x0:_0x6f024c['customId']}),common_1['Logger'][_0x5200b3(0x128)](_0x5200b3(0x15c),'MidjourneyService');},'onDrawing':async _0x54f99a=>{const _0x3221fb=_0x2e42fb;await this[_0x3221fb(0x152)][_0x3221fb(0x15f)](_0x227d62,{'answer':(_0x54f99a===null||_0x54f99a===void 0x0?void 0x0:_0x54f99a[_0x3221fb(0x123)])||_0x3221fb(0x13a),'progress':_0x54f99a===null||_0x54f99a===void 0x0?void 0x0:_0x54f99a[_0x3221fb(0x15b)],'status':0x2}),common_1[_0x3221fb(0x101)][_0x3221fb(0x128)]('绘制中！绘制进度'+(_0x54f99a===null||_0x54f99a===void 0x0?void 0x0:_0x54f99a['progress']),_0x3221fb(0x121));},'onFailure':async _0x1d15ce=>{const _0xfcc80c=_0x2e42fb;await this[_0xfcc80c(0x152)]['updateChatLog'](_0x227d62,{'answer':_0xfcc80c(0x103),'status':_0x1d15ce['status']}),common_1[_0xfcc80c(0x101)][_0xfcc80c(0x128)](_0xfcc80c(0x103),'MidjourneyService');}})[_0x2e42fb(0x102)](_0x3205d1=>{const _0x648af5=_0x2e42fb;common_1[_0x648af5(0x101)]['error'](_0x648af5(0x11a),_0x3205d1,_0x648af5(0x121));}),_0x4c92dd;}async['pollMjDrawingResult'](_0x7edb9e){const _0x59b85a=_0x20dede,{proxyUrl:_0x1294d1,apiKey:_0x8fcb12,drawId:_0x2d1f33,timeout:_0x5c8b7e,onSuccess:_0x18f08c,prompt:_0x5788be,onFailure:_0x421abf,onDrawing:_0x3a9d9d}=_0x7edb9e,{mjNotSaveImg:_0xc2bddb,mjProxyImgUrl:_0xa8fbb2,mjNotUseProxy:_0x3b4ef9}=await this[_0x59b85a(0x150)][_0x59b85a(0x159)]([_0x59b85a(0x11f),_0x59b85a(0x108),_0x59b85a(0x109)]);let _0x2bc29f={'fileInfo':'','drawId':'','customId':'','status':0x2,'progress':0x0,'answer':''};const _0x120edb=Date[_0x59b85a(0x10d)](),_0x57efbd=0x1388;let _0x4f102e=0x0;try{while(Date[_0x59b85a(0x10d)]()-_0x120edb<_0x5c8b7e){await new Promise(_0x42611d=>setTimeout(_0x42611d,_0x57efbd));try{const _0x3523bb={'Content-Type':'application/x-www-form-urlencoded','mj-api-secret':_0x8fcb12},_0x5e910e=_0x1294d1+_0x59b85a(0x161)+_0x2d1f33+_0x59b85a(0x160),_0x421446=await axios_1['default'][_0x59b85a(0x13b)](_0x5e910e,{'headers':_0x3523bb}),_0x34991=_0x421446['data'];common_1[_0x59b85a(0x101)][_0x59b85a(0x147)]('查询结果:\x20'+JSON[_0x59b85a(0x136)](_0x34991),_0x59b85a(0x121));if(_0x34991[_0x59b85a(0x163)]==='SUCCESS'){common_1[_0x59b85a(0x101)][_0x59b85a(0x128)]('绘制成功,\x20获取到的URL:\x20'+_0x34991[_0x59b85a(0x129)],'MidjourneyService');let _0x4cda1b=_0x34991[_0x59b85a(0x129)];const _0x49ba77=_0x3b4ef9==='0'&&_0xa8fbb2;let _0x3ff808='';if(_0x49ba77){const _0x1b3aed=new URL(_0xa8fbb2),_0x5a2e85=new URL(_0x34991[_0x59b85a(0x129)]);_0x5a2e85['protocol']=_0x1b3aed[_0x59b85a(0x139)],_0x5a2e85[_0x59b85a(0x149)]=_0x1b3aed[_0x59b85a(0x149)],_0x5a2e85['port']=_0x1b3aed[_0x59b85a(0x127)]?_0x1b3aed[_0x59b85a(0x127)]:'',_0x4cda1b=_0x5a2e85[_0x59b85a(0x132)](),_0x3ff808=_0x59b85a(0x156)+_0x4cda1b,common_1[_0x59b85a(0x101)]['log'](_0x3ff808,_0x59b85a(0x121));}if(_0xc2bddb!=='1'){try{common_1['Logger']['log'](_0x59b85a(0x141),_0x59b85a(0x121));const _0x145aab=new Date(),_0x454160=_0x145aab['getFullYear'](),_0x5d547b=String(_0x145aab['getMonth']()+0x1)[_0x59b85a(0x165)](0x2,'0'),_0x5703f9=String(_0x145aab[_0x59b85a(0x166)]())['padStart'](0x2,'0'),_0x2cdb7a=''+_0x454160+_0x5d547b+'/'+_0x5703f9;_0x4cda1b=await this[_0x59b85a(0x11e)][_0x59b85a(0x167)]({'url':_0x4cda1b,'dir':_0x59b85a(0x14a)+_0x2cdb7a}),_0x3ff808=_0x59b85a(0x112)+_0x4cda1b;}catch(_0x16ab30){common_1['Logger'][_0x59b85a(0x111)](_0x59b85a(0x13c)),_0x3ff808=_0x59b85a(0x116)+_0x4cda1b;}common_1[_0x59b85a(0x101)]['log'](_0x3ff808,_0x59b85a(0x121));}else _0x3ff808=_0x59b85a(0x145)+_0x4cda1b,common_1['Logger'][_0x59b85a(0x128)](_0x3ff808,'MidjourneyService');_0x2bc29f[_0x59b85a(0x151)]=_0x4cda1b,_0x2bc29f['drawId']=_0x34991['id'],_0x2bc29f['customId']=JSON['stringify'](_0x34991['buttons']),_0x2bc29f[_0x59b85a(0x123)]=_0x5788be+'\x0a'+(_0x34991[_0x59b85a(0x138)]||_0x34991['properties'][_0x59b85a(0x138)]||''),_0x18f08c(_0x2bc29f);return;}_0x2bc29f[_0x59b85a(0x15b)]=_0x34991===null||_0x34991===void 0x0?void 0x0:_0x34991[_0x59b85a(0x15b)],_0x2bc29f['answer']=_0x59b85a(0x115)+(_0x34991===null||_0x34991===void 0x0?void 0x0:_0x34991['progress']),_0x2bc29f[_0x59b85a(0x15b)]&&_0x3a9d9d(_0x2bc29f);}catch(_0x5c53f5){_0x4f102e++,common_1['Logger'][_0x59b85a(0x111)](_0x59b85a(0xfe)+_0x5c53f5,'MidjourneyService');}}common_1[_0x59b85a(0x101)][_0x59b85a(0x111)](_0x59b85a(0x105)+_0x120edb/0x3e8+_0x59b85a(0x131)),_0x2bc29f[_0x59b85a(0x163)]=0x4,_0x421abf(_0x2bc29f);throw new common_1[(_0x59b85a(0x126))](_0x59b85a(0x120),common_1[_0x59b85a(0x10f)]['BAD_REQUEST']);}catch(_0xd6ac9f){common_1['Logger'][_0x59b85a(0x111)]('绘画失败:\x20'+_0xd6ac9f+_0x59b85a(0x12c)),_0x2bc29f['status']=0x5,_0x421abf(_0x2bc29f);}}['getMidjourneyModelByPlugin'](_0x29f5e6){const _0x462421=_0x20dede;return _0x462421(0x169);}};MidjourneyService=__decorate([(0x0,common_1[_0x20dede(0x164)])(),__metadata(_0x20dede(0x134),[upload_service_1[_0x20dede(0x118)],globalConfig_service_1[_0x20dede(0x113)],chatLog_service_1[_0x20dede(0x13f)],models_service_1[_0x20dede(0x13e)]])],MidjourneyService),exports[_0x20dede(0x121)]=MidjourneyService;