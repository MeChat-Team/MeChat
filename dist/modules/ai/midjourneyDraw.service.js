'use strict';const _0x56b594=_0x5505;function _0x5505(_0x59edca,_0x21b033){const _0x4b6bed=_0x4b6b();return _0x5505=function(_0x5505ce,_0x5e19d9){_0x5505ce=_0x5505ce-0x109;let _0x2eb6e9=_0x4b6bed[_0x5505ce];return _0x2eb6e9;},_0x5505(_0x59edca,_0x21b033);}(function(_0x4c1279,_0x3d0eec){const _0x328d6e=_0x5505,_0x1b88c2=_0x4c1279();while(!![]){try{const _0x5983d0=parseInt(_0x328d6e(0x16f))/0x1+-parseInt(_0x328d6e(0x15b))/0x2*(-parseInt(_0x328d6e(0x158))/0x3)+-parseInt(_0x328d6e(0x151))/0x4*(-parseInt(_0x328d6e(0x162))/0x5)+-parseInt(_0x328d6e(0x152))/0x6*(parseInt(_0x328d6e(0x124))/0x7)+-parseInt(_0x328d6e(0x159))/0x8*(parseInt(_0x328d6e(0x120))/0x9)+-parseInt(_0x328d6e(0x177))/0xa*(-parseInt(_0x328d6e(0x14c))/0xb)+parseInt(_0x328d6e(0x179))/0xc*(-parseInt(_0x328d6e(0x175))/0xd);if(_0x5983d0===_0x3d0eec)break;else _0x1b88c2['push'](_0x1b88c2['shift']());}catch(_0x55e4af){_0x1b88c2['push'](_0x1b88c2['shift']());}}}(_0x4b6b,0xd7850));function _0x4b6b(){const _0x10837b=['pollMjDrawingResult','uploadService','------>\x20开始上传图片！！！','不保存图片，使用\x20URL:\x20','log','design:paramtypes','SUCCESS','midjourneyDraw','uploadFileFromUrl','/fetch','HttpException','14643KZisvo','当前绘制进度\x20','toString','ModelsService','7vSyoex','status','正在准备发送请求到\x20','object','base64','HttpStatus','function','defineProperty','__decorate','，payload:\x20','buttons','查询结果:\x20','\x20MidjourneyService','100%','/mj/task/','未能获取结果数据,\x20即将重试','绘画失败:\x20','轮询过程中发生错误:\x20','绘制成功,\x20获取到的URL:\x20','padStart','hostname','chatLogService','getDate','get','使用代理替换后的\x20URL:\x20','BAD_REQUEST','DESCRIBE','绘图失败','data:image/png;base64,','UploadService','绘画任务提交成功,\x20绘画ID:\x20','../models/models.service','error','getMidjourneyModelByPlugin','查询绘图结果时发生错误:','/mj/submit/action','finalPrompt','绘画超时，请稍后再试！','result','blob','768394DNLBmO','post','绘图成功！','state','key','487468OlhdjP','3766182cVfiCZ','mjNotUseProxy','PICREADER','port','任务提交失败，请检查提示词后重试','IMAGINE','39HOMyuf','952ICMzbD','application/x-www-form-urlencoded','153606bjHGpt','updateChatLog','stringify','绘画任务提交成功','../globalConfig/globalConfig.service','ChatLogService','metadata','10SdvuNh','data','当前任务类型:\x20','收到响应:\x20','getModelConfigByName','/mj/submit/imagine','imageUrl','from','mjProxyImgUrl','上传成功\x20URL:\x20','properties','绘画任务提交失败,\x20请检查后台配置或者稍后重试!\x20','decorate','544810zjEqVS','MidjourneyService','customId','超过\x20','getFullYear','Logger','4710173NsPxVH','drawId','40OaQAei','fileInfo','12MghjSn','mjNotSaveImg','绘制中！绘制进度','\x20s\x20未完成绘画,\x20请稍后再试!\x20MidjourneyService','default','绘制中','__esModule','now','protocol','answer','getMonth','midjourney','debug','axios','modelsService','progress','../upload/upload.service','__metadata','length','arrayBuffer','globalConfigService'];_0x4b6b=function(){return _0x10837b;};return _0x4b6b();}var __decorate=this&&this[_0x56b594(0x12c)]||function(_0x2e154d,_0x8897b6,_0x5ba799,_0x3e94fe){const _0x4f8117=_0x56b594;var _0x10e6ba=arguments[_0x4f8117(0x112)],_0x3356a7=_0x10e6ba<0x3?_0x8897b6:_0x3e94fe===null?_0x3e94fe=Object['getOwnPropertyDescriptor'](_0x8897b6,_0x5ba799):_0x3e94fe,_0x2179ff;if(typeof Reflect===_0x4f8117(0x127)&&typeof Reflect[_0x4f8117(0x16e)]===_0x4f8117(0x12a))_0x3356a7=Reflect['decorate'](_0x2e154d,_0x8897b6,_0x5ba799,_0x3e94fe);else{for(var _0x3c5a6a=_0x2e154d[_0x4f8117(0x112)]-0x1;_0x3c5a6a>=0x0;_0x3c5a6a--)if(_0x2179ff=_0x2e154d[_0x3c5a6a])_0x3356a7=(_0x10e6ba<0x3?_0x2179ff(_0x3356a7):_0x10e6ba>0x3?_0x2179ff(_0x8897b6,_0x5ba799,_0x3356a7):_0x2179ff(_0x8897b6,_0x5ba799))||_0x3356a7;}return _0x10e6ba>0x3&&_0x3356a7&&Object[_0x4f8117(0x12b)](_0x8897b6,_0x5ba799,_0x3356a7),_0x3356a7;},__metadata=this&&this[_0x56b594(0x111)]||function(_0x4c082f,_0xc6e907){const _0x5a1e12=_0x56b594;if(typeof Reflect===_0x5a1e12(0x127)&&typeof Reflect[_0x5a1e12(0x161)]===_0x5a1e12(0x12a))return Reflect['metadata'](_0x4c082f,_0xc6e907);};Object[_0x56b594(0x12b)](exports,_0x56b594(0x17f),{'value':!![]}),exports[_0x56b594(0x170)]=void 0x0;const common_1=require('@nestjs/common'),axios_1=require(_0x56b594(0x10d)),chatLog_service_1=require('../chatLog/chatLog.service'),globalConfig_service_1=require(_0x56b594(0x15f)),upload_service_1=require(_0x56b594(0x110)),models_service_1=require(_0x56b594(0x143));let MidjourneyService=class MidjourneyService{constructor(_0x722ca9,_0x3662a6,_0x32890e,_0x1f1439){const _0x39f724=_0x56b594;this[_0x39f724(0x116)]=_0x722ca9,this[_0x39f724(0x114)]=_0x3662a6,this[_0x39f724(0x139)]=_0x32890e,this[_0x39f724(0x10e)]=_0x1f1439;}async[_0x56b594(0x11c)](_0x55bc7b){const _0x1a73d2=_0x56b594;var _0x3979a9,_0x4833a6,_0x1ff51d,_0x23fef1;const {id:_0xc88bde,apiKey:_0x35ebce,proxyUrl:_0x123f73,action:_0x3e86ae,drawId:_0x110de7,prompt:_0x2d4502,usePrompt:_0x15f33a,customId:_0x46f972,timeout:_0x51d521,fileInfo:_0x1534bc,assistantLogId:_0x52071f,pluginName:_0xd33854}=_0x55bc7b;let _0x12efd5={'text':'','fileInfo':'','drawId':'','customId':'','status':0x2};const _0x48e889=this['getMidjourneyModelByPlugin'](_0xd33854),_0x474774=await this[_0x1a73d2(0x10e)][_0x1a73d2(0x166)](_0x48e889),_0x62a73=(_0x474774===null||_0x474774===void 0x0?void 0x0:_0x474774[_0x1a73d2(0x150)])||_0x35ebce;let _0xb7154f,_0x12325d=0x0,_0x288360='';const _0x25a7fb={'mj-api-secret':_0x62a73};common_1['Logger'][_0x1a73d2(0x10c)](_0x1a73d2(0x164)+_0x3e86ae,_0x1a73d2(0x170));while(_0x12325d<0x3){let _0x55500f={};try{if(_0x3e86ae===_0x1a73d2(0x157))_0x288360=_0x123f73+_0x1a73d2(0x167),_0x55500f={'prompt':_0x15f33a};else{if(_0x3e86ae===_0x1a73d2(0x13e)){_0x288360=_0x123f73+'/mj/submit/describe';if(_0x1534bc){const _0x400361=await fetch(_0x1534bc),_0x9c4261=await _0x400361[_0x1a73d2(0x14b)](),_0x268228=Buffer[_0x1a73d2(0x169)](await _0x9c4261[_0x1a73d2(0x113)]()),_0x58435f=_0x268228['toString'](_0x1a73d2(0x128));_0x55500f={'base64':_0x1a73d2(0x140)+_0x58435f};}else return;}else _0x3e86ae===_0x1a73d2(0x154)?(_0x288360=_0x123f73+'/mj/submit/action',_0x55500f={'taskId':_0x110de7,'customId':_0x46f972},_0xb7154f=await axios_1[_0x1a73d2(0x17d)][_0x1a73d2(0x14d)](_0x288360,_0x55500f,{'headers':_0x25a7fb}),(_0xb7154f===null||_0xb7154f===void 0x0?void 0x0:_0xb7154f['status'])===0xc8&&((_0x3979a9=_0xb7154f===null||_0xb7154f===void 0x0?void 0x0:_0xb7154f['data'])===null||_0x3979a9===void 0x0?void 0x0:_0x3979a9[_0x1a73d2(0x14a)])&&(_0x288360=_0x123f73+'/mj/submit/modal',_0x55500f={'taskId':(_0x4833a6=_0xb7154f===null||_0xb7154f===void 0x0?void 0x0:_0xb7154f[_0x1a73d2(0x163)])===null||_0x4833a6===void 0x0?void 0x0:_0x4833a6[_0x1a73d2(0x14a)]})):(_0x288360=_0x123f73+_0x1a73d2(0x147),_0x55500f={'taskId':_0x110de7,'customId':_0x46f972});}common_1[_0x1a73d2(0x174)][_0x1a73d2(0x119)](_0x1a73d2(0x126)+_0x288360+_0x1a73d2(0x12d)+JSON[_0x1a73d2(0x15d)](_0x55500f)+',\x20headers:\x20'+JSON[_0x1a73d2(0x15d)](_0x25a7fb),'MidjourneyService'),_0xb7154f=await axios_1[_0x1a73d2(0x17d)]['post'](_0x288360,_0x55500f,{'headers':_0x25a7fb});if((_0xb7154f===null||_0xb7154f===void 0x0?void 0x0:_0xb7154f[_0x1a73d2(0x125)])===0xc8&&((_0x1ff51d=_0xb7154f===null||_0xb7154f===void 0x0?void 0x0:_0xb7154f[_0x1a73d2(0x163)])===null||_0x1ff51d===void 0x0?void 0x0:_0x1ff51d['result'])){common_1[_0x1a73d2(0x174)]['debug'](_0x1a73d2(0x165)+JSON[_0x1a73d2(0x15d)](_0xb7154f[_0x1a73d2(0x163)]),_0x1a73d2(0x170)),_0x12efd5[_0x1a73d2(0x176)]=(_0x23fef1=_0xb7154f===null||_0xb7154f===void 0x0?void 0x0:_0xb7154f['data'])===null||_0x23fef1===void 0x0?void 0x0:_0x23fef1['result'],_0x12efd5[_0x1a73d2(0x14f)]=0x2,_0x12efd5[_0x1a73d2(0x109)]=_0x1a73d2(0x15e),common_1[_0x1a73d2(0x174)][_0x1a73d2(0x119)](_0x1a73d2(0x142)+_0xb7154f[_0x1a73d2(0x163)][_0x1a73d2(0x14a)],_0x1a73d2(0x170));break;}else throw new Error(_0x1a73d2(0x133));}catch(_0x57298c){_0x12325d++,_0x12325d>=0x3&&(_0x12efd5['answer']=_0x1a73d2(0x156),_0x12efd5[_0x1a73d2(0x125)]=0x5,common_1[_0x1a73d2(0x174)][_0x1a73d2(0x119)](_0x1a73d2(0x16d)+_0x57298c,_0x1a73d2(0x170)));}}return this['pollMjDrawingResult']({'proxyUrl':_0x123f73,'apiKey':_0x62a73,'drawId':_0x12efd5['drawId'],'timeout':_0x51d521,'prompt':_0x2d4502,'onSuccess':async _0x3e432b=>{const _0x487c80=_0x1a73d2;await this[_0x487c80(0x139)]['updateChatLog'](_0x52071f,{'fileInfo':_0x3e432b===null||_0x3e432b===void 0x0?void 0x0:_0x3e432b['fileInfo'],'answer':(_0x3e432b===null||_0x3e432b===void 0x0?void 0x0:_0x3e432b[_0x487c80(0x109)])||_0x2d4502,'progress':_0x487c80(0x131),'status':0x3,'drawId':_0x3e432b===null||_0x3e432b===void 0x0?void 0x0:_0x3e432b['drawId'],'customId':_0x3e432b===null||_0x3e432b===void 0x0?void 0x0:_0x3e432b[_0x487c80(0x171)]}),common_1['Logger'][_0x487c80(0x119)](_0x487c80(0x14e),_0x487c80(0x170));},'onDrawing':async _0x3292d9=>{const _0x23debb=_0x1a73d2;await this[_0x23debb(0x139)][_0x23debb(0x15c)](_0x52071f,{'answer':(_0x3292d9===null||_0x3292d9===void 0x0?void 0x0:_0x3292d9[_0x23debb(0x109)])||_0x23debb(0x17e),'progress':_0x3292d9===null||_0x3292d9===void 0x0?void 0x0:_0x3292d9[_0x23debb(0x10f)],'status':0x2}),common_1[_0x23debb(0x174)][_0x23debb(0x119)](_0x23debb(0x17b)+(_0x3292d9===null||_0x3292d9===void 0x0?void 0x0:_0x3292d9[_0x23debb(0x10f)]),_0x23debb(0x170));},'onFailure':async _0x87cc20=>{const _0x47847c=_0x1a73d2;await this[_0x47847c(0x139)]['updateChatLog'](_0x52071f,{'answer':_0x47847c(0x13f),'status':_0x87cc20[_0x47847c(0x125)]}),common_1[_0x47847c(0x174)][_0x47847c(0x119)](_0x47847c(0x13f),'MidjourneyService');}})['catch'](_0x2c8b95=>{const _0x2da961=_0x1a73d2;common_1['Logger'][_0x2da961(0x144)](_0x2da961(0x146),_0x2c8b95,'MidjourneyService');}),_0x12efd5;}async[_0x56b594(0x115)](_0x1a4a3f){const _0x140c35=_0x56b594,{proxyUrl:_0x145fa2,apiKey:_0x47728c,drawId:_0x32d685,timeout:_0x68e1e1,onSuccess:_0x38d5b1,prompt:_0x449cd3,onFailure:_0x2f4287,onDrawing:_0xc5fb00}=_0x1a4a3f,{mjNotSaveImg:_0x5c814a,mjProxyImgUrl:_0xbf6099,mjNotUseProxy:_0x1167a8}=await this[_0x140c35(0x114)]['getConfigs']([_0x140c35(0x17a),_0x140c35(0x16a),_0x140c35(0x153)]);let _0x209dca={'fileInfo':'','drawId':'','customId':'','status':0x2,'progress':0x0,'answer':''};const _0x11a591=Date[_0x140c35(0x180)](),_0x63480=0x1388;let _0xed819e=0x0;try{while(Date[_0x140c35(0x180)]()-_0x11a591<_0x68e1e1){await new Promise(_0x59452f=>setTimeout(_0x59452f,_0x63480));try{const _0x266685={'Content-Type':_0x140c35(0x15a),'mj-api-secret':_0x47728c},_0xcc1ebb=_0x145fa2+_0x140c35(0x132)+_0x32d685+_0x140c35(0x11e),_0x5dc9b=await axios_1[_0x140c35(0x17d)][_0x140c35(0x13b)](_0xcc1ebb,{'headers':_0x266685}),_0x27e462=_0x5dc9b[_0x140c35(0x163)];common_1['Logger']['debug'](_0x140c35(0x12f)+JSON[_0x140c35(0x15d)](_0x27e462),_0x140c35(0x170));if(_0x27e462[_0x140c35(0x125)]===_0x140c35(0x11b)){common_1[_0x140c35(0x174)][_0x140c35(0x119)](_0x140c35(0x136)+_0x27e462[_0x140c35(0x168)],_0x140c35(0x170));let _0x30ff7c=_0x27e462['imageUrl'];const _0x46c691=_0x1167a8==='0'&&_0xbf6099;let _0x431dbd='';if(_0x46c691){const _0x924f05=new URL(_0xbf6099),_0x187fd0=new URL(_0x27e462[_0x140c35(0x168)]);_0x187fd0[_0x140c35(0x181)]=_0x924f05[_0x140c35(0x181)],_0x187fd0[_0x140c35(0x138)]=_0x924f05[_0x140c35(0x138)],_0x187fd0[_0x140c35(0x155)]=_0x924f05['port']?_0x924f05['port']:'',_0x30ff7c=_0x187fd0[_0x140c35(0x122)](),_0x431dbd=_0x140c35(0x13c)+_0x30ff7c,common_1[_0x140c35(0x174)]['log'](_0x431dbd,'MidjourneyService');}if(_0x5c814a!=='1'){try{common_1['Logger']['log'](_0x140c35(0x117),'MidjourneyService');const _0x3dcccd=new Date(),_0x38396a=_0x3dcccd[_0x140c35(0x173)](),_0x1b59d0=String(_0x3dcccd[_0x140c35(0x10a)]()+0x1)['padStart'](0x2,'0'),_0x236b49=String(_0x3dcccd[_0x140c35(0x13a)]())[_0x140c35(0x137)](0x2,'0'),_0x5f2d95=''+_0x38396a+_0x1b59d0+'/'+_0x236b49;_0x30ff7c=await this[_0x140c35(0x116)][_0x140c35(0x11d)]({'url':_0x30ff7c,'dir':'images/midjourney/'+_0x5f2d95}),_0x431dbd=_0x140c35(0x16b)+_0x30ff7c;}catch(_0x1553f3){common_1[_0x140c35(0x174)][_0x140c35(0x144)]('存储图片失败，使用原始/代理图片链接'),_0x431dbd='存储图片失败，使用原始/代理图片链接\x20'+_0x30ff7c;}common_1[_0x140c35(0x174)]['log'](_0x431dbd,_0x140c35(0x170));}else _0x431dbd=_0x140c35(0x118)+_0x30ff7c,common_1[_0x140c35(0x174)][_0x140c35(0x119)](_0x431dbd,_0x140c35(0x170));_0x209dca[_0x140c35(0x178)]=_0x30ff7c,_0x209dca[_0x140c35(0x176)]=_0x27e462['id'],_0x209dca['customId']=JSON[_0x140c35(0x15d)](_0x27e462[_0x140c35(0x12e)]),_0x209dca[_0x140c35(0x109)]=_0x449cd3+'\x0a'+(_0x27e462[_0x140c35(0x148)]||_0x27e462[_0x140c35(0x16c)][_0x140c35(0x148)]||''),_0x38d5b1(_0x209dca);return;}_0x209dca[_0x140c35(0x10f)]=_0x27e462===null||_0x27e462===void 0x0?void 0x0:_0x27e462[_0x140c35(0x10f)],_0x209dca[_0x140c35(0x109)]=_0x140c35(0x121)+(_0x27e462===null||_0x27e462===void 0x0?void 0x0:_0x27e462[_0x140c35(0x10f)]),_0x209dca[_0x140c35(0x10f)]&&_0xc5fb00(_0x209dca);}catch(_0x5145d0){_0xed819e++,common_1[_0x140c35(0x174)][_0x140c35(0x144)](_0x140c35(0x135)+_0x5145d0,_0x140c35(0x170));}}common_1[_0x140c35(0x174)][_0x140c35(0x144)](_0x140c35(0x172)+_0x11a591/0x3e8+_0x140c35(0x17c)),_0x209dca[_0x140c35(0x125)]=0x4,_0x2f4287(_0x209dca);throw new common_1[(_0x140c35(0x11f))](_0x140c35(0x149),common_1[_0x140c35(0x129)][_0x140c35(0x13d)]);}catch(_0x1255ca){common_1[_0x140c35(0x174)][_0x140c35(0x144)](_0x140c35(0x134)+_0x1255ca+_0x140c35(0x130)),_0x209dca['status']=0x5,_0x2f4287(_0x209dca);}}[_0x56b594(0x145)](_0x131ba8){const _0x76ac88=_0x56b594;return _0x76ac88(0x10b);}};MidjourneyService=__decorate([(0x0,common_1['Injectable'])(),__metadata(_0x56b594(0x11a),[upload_service_1[_0x56b594(0x141)],globalConfig_service_1['GlobalConfigService'],chatLog_service_1[_0x56b594(0x160)],models_service_1[_0x56b594(0x123)]])],MidjourneyService),exports[_0x56b594(0x170)]=MidjourneyService;