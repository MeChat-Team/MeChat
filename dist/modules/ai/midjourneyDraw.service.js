'use strict';const _0x20c08f=_0x4f5e;function _0x222e(){const _0x2de47d=['updateChatLog','，payload:\x20','超过\x20','绘制中','IMAGINE','getOwnPropertyDescriptor','function','getMonth','../globalConfig/globalConfig.service','SUCCESS','finalPrompt','metadata','MidjourneyService','不保存图片，使用\x20URL:\x20','globalConfigService','当前任务类型:\x20','error','29813OwzRwb','上传成功\x20URL:\x20','default','from','answer','当前绘制进度\x20','getDate','../upload/upload.service','__decorate','object','stringify','1898578OzxJRO','\x20MidjourneyService','../chatLog/chatLog.service','drawId','绘画超时，请稍后再试！','base64','state','5582716tsEyon','ModelsService','key','绘制中！绘制进度','modelsService','绘画任务提交成功','imageUrl','post','Injectable','/mj/submit/imagine','progress','port','fileInfo','mjProxyImgUrl','toString','arrayBuffer','@nestjs/common','../models/models.service','application/x-www-form-urlencoded','PICREADER','get','18MMjxLa','result','71624mdZqtr','catch','GlobalConfigService','1890783lgSaJr','buttons','绘画失败:\x20','uploadFileFromUrl','debug','uploadService','midjourney','------>\x20开始上传图片！！！','516AwceEc','decorate','properties','绘图成功！',',\x20headers:\x20','defineProperty','ChatLogService','getMidjourneyModelByPlugin','now','getModelConfigByName','HttpStatus','hostname','pollMjDrawingResult','log','1349632EDoCQW','绘画任务提交失败,\x20请检查后台配置或者稍后重试!\x20','chatLogService','/mj/submit/action','status','BAD_REQUEST','HttpException','__esModule','绘画任务提交成功,\x20绘画ID:\x20','protocol','5GWoTgi','Logger','正在准备发送请求到\x20','length','\x20s\x20未完成绘画,\x20请稍后再试!\x20MidjourneyService','14357300cvMUPD','轮询过程中发生错误:\x20','data','padStart','未能获取结果数据,\x20即将重试','getConfigs'];_0x222e=function(){return _0x2de47d;};return _0x222e();}(function(_0x1bf82c,_0x28cac7){const _0xdcfc52=_0x4f5e,_0x594785=_0x1bf82c();while(!![]){try{const _0xf8a311=parseInt(_0xdcfc52(0x19d))/0x1+-parseInt(_0xdcfc52(0x1d4))/0x2+-parseInt(_0xdcfc52(0x1be))/0x3+parseInt(_0xdcfc52(0x1a4))/0x4*(-parseInt(_0xdcfc52(0x176))/0x5)+-parseInt(_0xdcfc52(0x1c6))/0x6*(-parseInt(_0xdcfc52(0x192))/0x7)+parseInt(_0xdcfc52(0x1bb))/0x8*(-parseInt(_0xdcfc52(0x1b9))/0x9)+parseInt(_0xdcfc52(0x17b))/0xa;if(_0xf8a311===_0x28cac7)break;else _0x594785['push'](_0x594785['shift']());}catch(_0x302a89){_0x594785['push'](_0x594785['shift']());}}}(_0x222e,0xefba0));var __decorate=this&&this[_0x20c08f(0x19a)]||function(_0x12be71,_0x2199a4,_0x461dbb,_0x8e56fe){const _0xb50a9f=_0x20c08f;var _0x12128d=arguments[_0xb50a9f(0x179)],_0x1d17af=_0x12128d<0x3?_0x2199a4:_0x8e56fe===null?_0x8e56fe=Object[_0xb50a9f(0x186)](_0x2199a4,_0x461dbb):_0x8e56fe,_0xc0f2d3;if(typeof Reflect==='object'&&typeof Reflect[_0xb50a9f(0x1c7)]===_0xb50a9f(0x187))_0x1d17af=Reflect[_0xb50a9f(0x1c7)](_0x12be71,_0x2199a4,_0x461dbb,_0x8e56fe);else{for(var _0x4bad78=_0x12be71[_0xb50a9f(0x179)]-0x1;_0x4bad78>=0x0;_0x4bad78--)if(_0xc0f2d3=_0x12be71[_0x4bad78])_0x1d17af=(_0x12128d<0x3?_0xc0f2d3(_0x1d17af):_0x12128d>0x3?_0xc0f2d3(_0x2199a4,_0x461dbb,_0x1d17af):_0xc0f2d3(_0x2199a4,_0x461dbb))||_0x1d17af;}return _0x12128d>0x3&&_0x1d17af&&Object[_0xb50a9f(0x1cb)](_0x2199a4,_0x461dbb,_0x1d17af),_0x1d17af;},__metadata=this&&this['__metadata']||function(_0x18e80b,_0x4e9ab6){const _0x5ab11e=_0x20c08f;if(typeof Reflect===_0x5ab11e(0x19b)&&typeof Reflect[_0x5ab11e(0x18c)]===_0x5ab11e(0x187))return Reflect[_0x5ab11e(0x18c)](_0x18e80b,_0x4e9ab6);};Object[_0x20c08f(0x1cb)](exports,_0x20c08f(0x173),{'value':!![]}),exports['MidjourneyService']=void 0x0;function _0x4f5e(_0x33d8e0,_0x26a419){const _0x222e83=_0x222e();return _0x4f5e=function(_0x4f5e54,_0x18df31){_0x4f5e54=_0x4f5e54-0x16f;let _0x3515f0=_0x222e83[_0x4f5e54];return _0x3515f0;},_0x4f5e(_0x33d8e0,_0x26a419);}const common_1=require(_0x20c08f(0x1b4)),axios_1=require('axios'),chatLog_service_1=require(_0x20c08f(0x19f)),globalConfig_service_1=require(_0x20c08f(0x189)),upload_service_1=require(_0x20c08f(0x199)),models_service_1=require(_0x20c08f(0x1b5));let MidjourneyService=class MidjourneyService{constructor(_0x4d6bf9,_0x3afe17,_0x4f0dca,_0x58c896){const _0x25c16d=_0x20c08f;this[_0x25c16d(0x1c3)]=_0x4d6bf9,this[_0x25c16d(0x18f)]=_0x3afe17,this[_0x25c16d(0x1d6)]=_0x4f0dca,this['modelsService']=_0x58c896;}async['midjourneyDraw'](_0x2053bf){const _0x15daf8=_0x20c08f;var _0x22c9c5,_0x4dd0b7,_0x4ed7f4,_0x163627;const {id:_0x43374f,apiKey:_0x5cf4c0,proxyUrl:_0x4439af,action:_0x483727,drawId:_0x49ef0f,prompt:_0x4c6f27,usePrompt:_0x394a65,customId:_0x17f379,timeout:_0x3b75a6,fileInfo:_0x221abf,assistantLogId:_0x6c9eb,pluginName:_0x230efc}=_0x2053bf;let _0x2bed72={'text':'','fileInfo':'','drawId':'','customId':'','status':0x2};const _0x1131c9=this[_0x15daf8(0x1cd)](_0x230efc),_0x382712=await this[_0x15daf8(0x1a8)][_0x15daf8(0x1cf)](_0x1131c9),_0x57a66a=(_0x382712===null||_0x382712===void 0x0?void 0x0:_0x382712[_0x15daf8(0x1a6)])||_0x5cf4c0;let _0x332b05,_0x348770=0x0,_0x165190='';const _0x4c3120={'mj-api-secret':_0x57a66a};common_1[_0x15daf8(0x177)][_0x15daf8(0x1c2)](_0x15daf8(0x190)+_0x483727,_0x15daf8(0x18d));while(_0x348770<0x3){let _0x442f85={};try{if(_0x483727===_0x15daf8(0x185))_0x165190=_0x4439af+_0x15daf8(0x1ad),_0x442f85={'prompt':_0x394a65};else{if(_0x483727==='DESCRIBE'){_0x165190=_0x4439af+'/mj/submit/describe';if(_0x221abf){const _0x34f838=await fetch(_0x221abf),_0x25ef07=await _0x34f838['blob'](),_0x208c9e=Buffer[_0x15daf8(0x195)](await _0x25ef07[_0x15daf8(0x1b3)]()),_0x25b87c=_0x208c9e[_0x15daf8(0x1b2)](_0x15daf8(0x1a2));_0x442f85={'base64':'data:image/png;base64,'+_0x25b87c};}else return;}else _0x483727===_0x15daf8(0x1b7)?(_0x165190=_0x4439af+'/mj/submit/action',_0x442f85={'taskId':_0x49ef0f,'customId':_0x17f379},_0x332b05=await axios_1[_0x15daf8(0x194)]['post'](_0x165190,_0x442f85,{'headers':_0x4c3120}),(_0x332b05===null||_0x332b05===void 0x0?void 0x0:_0x332b05[_0x15daf8(0x170)])===0xc8&&((_0x22c9c5=_0x332b05===null||_0x332b05===void 0x0?void 0x0:_0x332b05[_0x15daf8(0x17d)])===null||_0x22c9c5===void 0x0?void 0x0:_0x22c9c5[_0x15daf8(0x1ba)])&&(_0x165190=_0x4439af+'/mj/submit/modal',_0x442f85={'taskId':(_0x4dd0b7=_0x332b05===null||_0x332b05===void 0x0?void 0x0:_0x332b05['data'])===null||_0x4dd0b7===void 0x0?void 0x0:_0x4dd0b7[_0x15daf8(0x1ba)]})):(_0x165190=_0x4439af+_0x15daf8(0x16f),_0x442f85={'taskId':_0x49ef0f,'customId':_0x17f379});}common_1[_0x15daf8(0x177)]['log'](_0x15daf8(0x178)+_0x165190+_0x15daf8(0x182)+JSON[_0x15daf8(0x19c)](_0x442f85)+_0x15daf8(0x1ca)+JSON['stringify'](_0x4c3120),_0x15daf8(0x18d)),_0x332b05=await axios_1[_0x15daf8(0x194)][_0x15daf8(0x1ab)](_0x165190,_0x442f85,{'headers':_0x4c3120});if((_0x332b05===null||_0x332b05===void 0x0?void 0x0:_0x332b05['status'])===0xc8&&((_0x4ed7f4=_0x332b05===null||_0x332b05===void 0x0?void 0x0:_0x332b05[_0x15daf8(0x17d)])===null||_0x4ed7f4===void 0x0?void 0x0:_0x4ed7f4[_0x15daf8(0x1ba)])){common_1[_0x15daf8(0x177)][_0x15daf8(0x1c2)]('收到响应:\x20'+JSON[_0x15daf8(0x19c)](_0x332b05[_0x15daf8(0x17d)]),_0x15daf8(0x18d)),_0x2bed72[_0x15daf8(0x1a0)]=(_0x163627=_0x332b05===null||_0x332b05===void 0x0?void 0x0:_0x332b05[_0x15daf8(0x17d)])===null||_0x163627===void 0x0?void 0x0:_0x163627[_0x15daf8(0x1ba)],_0x2bed72[_0x15daf8(0x1a3)]=0x2,_0x2bed72[_0x15daf8(0x196)]=_0x15daf8(0x1a9),common_1[_0x15daf8(0x177)][_0x15daf8(0x1d3)](_0x15daf8(0x174)+_0x332b05['data'][_0x15daf8(0x1ba)],_0x15daf8(0x18d));break;}else throw new Error(_0x15daf8(0x17f));}catch(_0x52863a){_0x348770++,_0x348770>=0x3&&(_0x2bed72['answer']='任务提交失败，请检查提示词后重试',_0x2bed72[_0x15daf8(0x170)]=0x5,common_1['Logger']['log'](_0x15daf8(0x1d5)+_0x52863a,_0x15daf8(0x18d)));}}return this['pollMjDrawingResult']({'proxyUrl':_0x4439af,'apiKey':_0x57a66a,'drawId':_0x2bed72['drawId'],'timeout':_0x3b75a6,'prompt':_0x4c6f27,'onSuccess':async _0x2883dd=>{const _0x1cbc57=_0x15daf8;await this[_0x1cbc57(0x1d6)]['updateChatLog'](_0x6c9eb,{'fileInfo':_0x2883dd===null||_0x2883dd===void 0x0?void 0x0:_0x2883dd['fileInfo'],'answer':(_0x2883dd===null||_0x2883dd===void 0x0?void 0x0:_0x2883dd[_0x1cbc57(0x196)])||_0x4c6f27,'progress':'100%','status':0x3,'drawId':_0x2883dd===null||_0x2883dd===void 0x0?void 0x0:_0x2883dd['drawId'],'customId':_0x2883dd===null||_0x2883dd===void 0x0?void 0x0:_0x2883dd['customId']}),common_1[_0x1cbc57(0x177)][_0x1cbc57(0x1d3)](_0x1cbc57(0x1c9),_0x1cbc57(0x18d));},'onDrawing':async _0x5ea8b9=>{const _0x16f888=_0x15daf8;await this[_0x16f888(0x1d6)][_0x16f888(0x181)](_0x6c9eb,{'answer':(_0x5ea8b9===null||_0x5ea8b9===void 0x0?void 0x0:_0x5ea8b9[_0x16f888(0x196)])||_0x16f888(0x184),'progress':_0x5ea8b9===null||_0x5ea8b9===void 0x0?void 0x0:_0x5ea8b9[_0x16f888(0x1ae)],'status':0x2}),common_1[_0x16f888(0x177)][_0x16f888(0x1d3)](_0x16f888(0x1a7)+(_0x5ea8b9===null||_0x5ea8b9===void 0x0?void 0x0:_0x5ea8b9[_0x16f888(0x1ae)]),_0x16f888(0x18d));},'onFailure':async _0x4fed19=>{const _0x5a2e61=_0x15daf8;await this['chatLogService']['updateChatLog'](_0x6c9eb,{'answer':'绘图失败','status':_0x4fed19['status']}),common_1[_0x5a2e61(0x177)]['log']('绘图失败',_0x5a2e61(0x18d));}})[_0x15daf8(0x1bc)](_0x3c2889=>{const _0x499598=_0x15daf8;common_1[_0x499598(0x177)][_0x499598(0x191)]('查询绘图结果时发生错误:',_0x3c2889,_0x499598(0x18d));}),_0x2bed72;}async[_0x20c08f(0x1d2)](_0x139e2c){const _0x583444=_0x20c08f,{proxyUrl:_0x181184,apiKey:_0x3254d2,drawId:_0x54fc05,timeout:_0x2d5e18,onSuccess:_0x3da9c4,prompt:_0x5c58ca,onFailure:_0x3f5c4a,onDrawing:_0x3cc4bb}=_0x139e2c,{mjNotSaveImg:_0x3f1787,mjProxyImgUrl:_0x361540,mjNotUseProxy:_0x11d684}=await this[_0x583444(0x18f)][_0x583444(0x180)](['mjNotSaveImg',_0x583444(0x1b1),'mjNotUseProxy']);let _0xb2606e={'fileInfo':'','drawId':'','customId':'','status':0x2,'progress':0x0,'answer':''};const _0x481fae=Date[_0x583444(0x1ce)](),_0x223164=0x1388;let _0x5590b3=0x0;try{while(Date[_0x583444(0x1ce)]()-_0x481fae<_0x2d5e18){await new Promise(_0x28ba1f=>setTimeout(_0x28ba1f,_0x223164));try{const _0x56ffca={'Content-Type':_0x583444(0x1b6),'mj-api-secret':_0x3254d2},_0x114d22=_0x181184+'/mj/task/'+_0x54fc05+'/fetch',_0x12b7bd=await axios_1[_0x583444(0x194)][_0x583444(0x1b8)](_0x114d22,{'headers':_0x56ffca}),_0x1225a7=_0x12b7bd[_0x583444(0x17d)];common_1['Logger'][_0x583444(0x1c2)]('查询结果:\x20'+JSON[_0x583444(0x19c)](_0x1225a7),'MidjourneyService');if(_0x1225a7[_0x583444(0x170)]===_0x583444(0x18a)){common_1[_0x583444(0x177)][_0x583444(0x1d3)]('绘制成功,\x20获取到的URL:\x20'+_0x1225a7['imageUrl'],_0x583444(0x18d));let _0x356f90=_0x1225a7[_0x583444(0x1aa)];const _0x360817=_0x11d684==='0'&&_0x361540;let _0x492aa3='';if(_0x360817){const _0x2fcf06=new URL(_0x361540),_0x321fcc=new URL(_0x1225a7[_0x583444(0x1aa)]);_0x321fcc[_0x583444(0x175)]=_0x2fcf06[_0x583444(0x175)],_0x321fcc[_0x583444(0x1d1)]=_0x2fcf06['hostname'],_0x321fcc[_0x583444(0x1af)]=_0x2fcf06[_0x583444(0x1af)]?_0x2fcf06['port']:'',_0x356f90=_0x321fcc[_0x583444(0x1b2)](),_0x492aa3='使用代理替换后的\x20URL:\x20'+_0x356f90,common_1[_0x583444(0x177)][_0x583444(0x1d3)](_0x492aa3,_0x583444(0x18d));}if(_0x3f1787!=='1'){try{common_1[_0x583444(0x177)][_0x583444(0x1d3)](_0x583444(0x1c5),_0x583444(0x18d));const _0x578fa2=new Date(),_0x2e3da8=_0x578fa2['getFullYear'](),_0x8fdd5e=String(_0x578fa2[_0x583444(0x188)]()+0x1)[_0x583444(0x17e)](0x2,'0'),_0x21ebc3=String(_0x578fa2[_0x583444(0x198)]())[_0x583444(0x17e)](0x2,'0'),_0x34e1a9=''+_0x2e3da8+_0x8fdd5e+'/'+_0x21ebc3;_0x356f90=await this[_0x583444(0x1c3)][_0x583444(0x1c1)]({'url':_0x356f90,'dir':'images/midjourney/'+_0x34e1a9}),_0x492aa3=_0x583444(0x193)+_0x356f90;}catch(_0x1e037e){common_1[_0x583444(0x177)]['error']('存储图片失败，使用原始/代理图片链接'),_0x492aa3='存储图片失败，使用原始/代理图片链接\x20'+_0x356f90;}common_1['Logger'][_0x583444(0x1d3)](_0x492aa3,_0x583444(0x18d));}else _0x492aa3=_0x583444(0x18e)+_0x356f90,common_1[_0x583444(0x177)][_0x583444(0x1d3)](_0x492aa3,_0x583444(0x18d));_0xb2606e[_0x583444(0x1b0)]=_0x356f90,_0xb2606e['drawId']=_0x1225a7['id'],_0xb2606e['customId']=JSON[_0x583444(0x19c)](_0x1225a7[_0x583444(0x1bf)]),_0xb2606e[_0x583444(0x196)]=_0x5c58ca+'\x0a'+(_0x1225a7[_0x583444(0x18b)]||_0x1225a7[_0x583444(0x1c8)][_0x583444(0x18b)]||''),_0x3da9c4(_0xb2606e);return;}_0xb2606e[_0x583444(0x1ae)]=_0x1225a7===null||_0x1225a7===void 0x0?void 0x0:_0x1225a7['progress'],_0xb2606e[_0x583444(0x196)]=_0x583444(0x197)+(_0x1225a7===null||_0x1225a7===void 0x0?void 0x0:_0x1225a7[_0x583444(0x1ae)]),_0xb2606e['progress']&&_0x3cc4bb(_0xb2606e);}catch(_0x138ead){_0x5590b3++,common_1[_0x583444(0x177)][_0x583444(0x191)](_0x583444(0x17c)+_0x138ead,_0x583444(0x18d));}}common_1['Logger'][_0x583444(0x191)](_0x583444(0x183)+_0x481fae/0x3e8+_0x583444(0x17a)),_0xb2606e['status']=0x4,_0x3f5c4a(_0xb2606e);throw new common_1[(_0x583444(0x172))](_0x583444(0x1a1),common_1[_0x583444(0x1d0)][_0x583444(0x171)]);}catch(_0x136336){common_1['Logger'][_0x583444(0x191)](_0x583444(0x1c0)+_0x136336+_0x583444(0x19e)),_0xb2606e[_0x583444(0x170)]=0x5,_0x3f5c4a(_0xb2606e);}}[_0x20c08f(0x1cd)](_0x5600db){const _0x53bc46=_0x20c08f;return _0x53bc46(0x1c4);}};MidjourneyService=__decorate([(0x0,common_1[_0x20c08f(0x1ac)])(),__metadata('design:paramtypes',[upload_service_1['UploadService'],globalConfig_service_1[_0x20c08f(0x1bd)],chatLog_service_1[_0x20c08f(0x1cc)],models_service_1[_0x20c08f(0x1a5)]])],MidjourneyService),exports[_0x20c08f(0x18d)]=MidjourneyService;