'use strict';const _0x244b17=_0x2282;(function(_0x72ecbb,_0x25bb1a){const _0x3c00ce=_0x2282,_0xf727ab=_0x72ecbb();while(!![]){try{const _0x15865d=-parseInt(_0x3c00ce(0x12d))/0x1*(parseInt(_0x3c00ce(0x135))/0x2)+-parseInt(_0x3c00ce(0x10c))/0x3+-parseInt(_0x3c00ce(0x125))/0x4*(-parseInt(_0x3c00ce(0x10f))/0x5)+-parseInt(_0x3c00ce(0x11c))/0x6*(-parseInt(_0x3c00ce(0xf2))/0x7)+-parseInt(_0x3c00ce(0x148))/0x8*(-parseInt(_0x3c00ce(0xfe))/0x9)+parseInt(_0x3c00ce(0x134))/0xa+parseInt(_0x3c00ce(0x12a))/0xb*(parseInt(_0x3c00ce(0x10a))/0xc);if(_0x15865d===_0x25bb1a)break;else _0xf727ab['push'](_0xf727ab['shift']());}catch(_0x1fc230){_0xf727ab['push'](_0xf727ab['shift']());}}}(_0x33ce,0xd8f2e));var __decorate=this&&this[_0x244b17(0x11d)]||function(_0x1acf00,_0x206879,_0x2f50bf,_0x5deb46){const _0x4d0119=_0x244b17;var _0x78154d=arguments[_0x4d0119(0x111)],_0x2012d3=_0x78154d<0x3?_0x206879:_0x5deb46===null?_0x5deb46=Object[_0x4d0119(0x104)](_0x206879,_0x2f50bf):_0x5deb46,_0x577df9;if(typeof Reflect===_0x4d0119(0x152)&&typeof Reflect[_0x4d0119(0x106)]===_0x4d0119(0x127))_0x2012d3=Reflect[_0x4d0119(0x106)](_0x1acf00,_0x206879,_0x2f50bf,_0x5deb46);else{for(var _0x3e3282=_0x1acf00['length']-0x1;_0x3e3282>=0x0;_0x3e3282--)if(_0x577df9=_0x1acf00[_0x3e3282])_0x2012d3=(_0x78154d<0x3?_0x577df9(_0x2012d3):_0x78154d>0x3?_0x577df9(_0x206879,_0x2f50bf,_0x2012d3):_0x577df9(_0x206879,_0x2f50bf))||_0x2012d3;}return _0x78154d>0x3&&_0x2012d3&&Object[_0x4d0119(0xea)](_0x206879,_0x2f50bf,_0x2012d3),_0x2012d3;},__metadata=this&&this[_0x244b17(0xfa)]||function(_0x24a13c,_0x266620){const _0x100821=_0x244b17;if(typeof Reflect===_0x100821(0x152)&&typeof Reflect['metadata']===_0x100821(0x127))return Reflect['metadata'](_0x24a13c,_0x266620);};Object[_0x244b17(0xea)](exports,_0x244b17(0x140),{'value':!![]}),exports[_0x244b17(0xfd)]=void 0x0;const common_1=require(_0x244b17(0x13c)),axios_1=require(_0x244b17(0x14a)),chatLog_service_1=require(_0x244b17(0x126)),globalConfig_service_1=require(_0x244b17(0xed)),upload_service_1=require(_0x244b17(0x109)),models_service_1=require(_0x244b17(0x143));let MidjourneyService=class MidjourneyService{constructor(_0x8e3d3f,_0x2b796e,_0x37688f,_0x26a3d6){const _0x3ca13a=_0x244b17;this[_0x3ca13a(0x119)]=_0x8e3d3f,this[_0x3ca13a(0x153)]=_0x2b796e,this[_0x3ca13a(0xeb)]=_0x37688f,this[_0x3ca13a(0x14e)]=_0x26a3d6;}async['midjourneyDraw'](_0x4f9d04){const _0x172149=_0x244b17;var _0x27416d,_0x2c0196,_0x3c0623,_0x2915ad;const {id:_0x3ab2c4,apiKey:_0x29c101,proxyUrl:_0x4570dc,action:_0x30461d,drawId:_0x4de60c,prompt:_0x367775,usePrompt:_0x6b1082,customId:_0x230d99,timeout:_0x5caa5a,fileInfo:_0x4f2581,assistantLogId:_0x14c0e9,pluginName:_0x12382c}=_0x4f9d04;let _0x29febc={'text':'','fileInfo':'','drawId':'','customId':'','status':0x2};const _0x2953b1=this['getMidjourneyModelByPlugin'](_0x12382c),_0x39f1f7=await this[_0x172149(0x14e)][_0x172149(0x12b)](_0x2953b1),_0x4e0ec8=(_0x39f1f7===null||_0x39f1f7===void 0x0?void 0x0:_0x39f1f7['key'])||_0x29c101;let _0x527383,_0x4c1cc5=0x0,_0x5805a1='';const _0x48567b={'mj-api-secret':_0x4e0ec8};common_1['Logger'][_0x172149(0x117)]('当前任务类型:\x20'+_0x30461d,_0x172149(0xfd));while(_0x4c1cc5<0x3){let _0xf4e420={};try{if(_0x30461d===_0x172149(0xf6))_0x5805a1=_0x4570dc+'/mj/submit/imagine',_0xf4e420={'prompt':_0x6b1082};else{if(_0x30461d===_0x172149(0xf4)){_0x5805a1=_0x4570dc+_0x172149(0x139);if(_0x4f2581){const _0x4883ac=await fetch(_0x4f2581),_0x2a2cf8=await _0x4883ac['blob'](),_0x3197d5=Buffer[_0x172149(0x123)](await _0x2a2cf8['arrayBuffer']()),_0x591f5b=_0x3197d5[_0x172149(0x137)](_0x172149(0x102));_0xf4e420={'base64':_0x172149(0x138)+_0x591f5b};}else return;}else _0x30461d===_0x172149(0x12f)?(_0x5805a1=_0x4570dc+_0x172149(0x100),_0xf4e420={'taskId':_0x4de60c,'customId':_0x230d99},_0x527383=await axios_1['default']['post'](_0x5805a1,_0xf4e420,{'headers':_0x48567b}),(_0x527383===null||_0x527383===void 0x0?void 0x0:_0x527383[_0x172149(0x130)])===0xc8&&((_0x27416d=_0x527383===null||_0x527383===void 0x0?void 0x0:_0x527383[_0x172149(0x105)])===null||_0x27416d===void 0x0?void 0x0:_0x27416d['result'])&&(_0x5805a1=_0x4570dc+_0x172149(0x131),_0xf4e420={'taskId':(_0x2c0196=_0x527383===null||_0x527383===void 0x0?void 0x0:_0x527383[_0x172149(0x105)])===null||_0x2c0196===void 0x0?void 0x0:_0x2c0196[_0x172149(0x132)]})):(_0x5805a1=_0x4570dc+'/mj/submit/action',_0xf4e420={'taskId':_0x4de60c,'customId':_0x230d99});}common_1['Logger'][_0x172149(0x115)](_0x172149(0xec)+_0x5805a1+_0x172149(0x118)+JSON['stringify'](_0xf4e420)+',\x20headers:\x20'+JSON[_0x172149(0xff)](_0x48567b),'MidjourneyService'),_0x527383=await axios_1['default']['post'](_0x5805a1,_0xf4e420,{'headers':_0x48567b});if((_0x527383===null||_0x527383===void 0x0?void 0x0:_0x527383[_0x172149(0x130)])===0xc8&&((_0x3c0623=_0x527383===null||_0x527383===void 0x0?void 0x0:_0x527383['data'])===null||_0x3c0623===void 0x0?void 0x0:_0x3c0623[_0x172149(0x132)])){common_1[_0x172149(0xef)]['debug']('收到响应:\x20'+JSON[_0x172149(0xff)](_0x527383[_0x172149(0x105)]),'MidjourneyService'),_0x29febc[_0x172149(0x151)]=(_0x2915ad=_0x527383===null||_0x527383===void 0x0?void 0x0:_0x527383[_0x172149(0x105)])===null||_0x2915ad===void 0x0?void 0x0:_0x2915ad[_0x172149(0x132)],_0x29febc[_0x172149(0x13e)]=0x2,_0x29febc[_0x172149(0x147)]=_0x172149(0x150),common_1[_0x172149(0xef)][_0x172149(0x115)](_0x172149(0xfb)+_0x527383['data'][_0x172149(0x132)],_0x172149(0xfd));break;}else throw new Error('未能获取结果数据,\x20即将重试');}catch(_0x2982d7){_0x4c1cc5++,_0x4c1cc5>=0x3&&(_0x29febc[_0x172149(0x147)]='任务提交失败，请检查提示词后重试',_0x29febc[_0x172149(0x130)]=0x5,common_1['Logger']['log'](_0x172149(0x149)+_0x2982d7,_0x172149(0xfd)));}}return this['pollMjDrawingResult']({'proxyUrl':_0x4570dc,'apiKey':_0x4e0ec8,'drawId':_0x29febc[_0x172149(0x151)],'timeout':_0x5caa5a,'prompt':_0x367775,'onSuccess':async _0x335a36=>{const _0x1614fc=_0x172149;await this['chatLogService'][_0x1614fc(0xf0)](_0x14c0e9,{'fileInfo':_0x335a36===null||_0x335a36===void 0x0?void 0x0:_0x335a36[_0x1614fc(0x11f)],'answer':(_0x335a36===null||_0x335a36===void 0x0?void 0x0:_0x335a36['answer'])||_0x367775,'progress':_0x1614fc(0x10b),'status':0x3,'drawId':_0x335a36===null||_0x335a36===void 0x0?void 0x0:_0x335a36[_0x1614fc(0x151)],'customId':_0x335a36===null||_0x335a36===void 0x0?void 0x0:_0x335a36['customId']}),common_1[_0x1614fc(0xef)][_0x1614fc(0x115)](_0x1614fc(0xf5),_0x1614fc(0xfd));},'onDrawing':async _0x1654d5=>{const _0x1cc616=_0x172149;await this[_0x1cc616(0xeb)][_0x1cc616(0xf0)](_0x14c0e9,{'answer':(_0x1654d5===null||_0x1654d5===void 0x0?void 0x0:_0x1654d5[_0x1cc616(0x147)])||'绘制中','progress':_0x1654d5===null||_0x1654d5===void 0x0?void 0x0:_0x1654d5[_0x1cc616(0x13a)],'status':0x2}),common_1[_0x1cc616(0xef)]['log']('绘制中！绘制进度'+(_0x1654d5===null||_0x1654d5===void 0x0?void 0x0:_0x1654d5['progress']),_0x1cc616(0xfd));},'onFailure':async _0x497254=>{const _0x17e076=_0x172149;await this[_0x17e076(0xeb)][_0x17e076(0xf0)](_0x14c0e9,{'answer':_0x17e076(0x11b),'status':_0x497254['status']}),common_1['Logger'][_0x17e076(0x115)](_0x17e076(0x11b),_0x17e076(0xfd));}})[_0x172149(0x14b)](_0x20787a=>{const _0x5ecb37=_0x172149;common_1[_0x5ecb37(0xef)][_0x5ecb37(0x146)](_0x5ecb37(0x113),_0x20787a,'MidjourneyService');}),_0x29febc;}async[_0x244b17(0x14d)](_0x229d7c){const _0x24bdcc=_0x244b17,{proxyUrl:_0xc9ade9,apiKey:_0x5d48a9,drawId:_0x3d1786,timeout:_0x31b4d1,onSuccess:_0x44d308,prompt:_0x17e8a3,onFailure:_0x4382a1,onDrawing:_0x3ec23e}=_0x229d7c,{mjNotSaveImg:_0x2c027b,mjProxyImgUrl:_0x370be3,mjNotUseProxy:_0x5062eb}=await this['globalConfigService'][_0x24bdcc(0x10d)]([_0x24bdcc(0x133),'mjProxyImgUrl',_0x24bdcc(0x114)]);let _0x32e247={'fileInfo':'','drawId':'','customId':'','status':0x2,'progress':0x0,'answer':''};const _0x35134f=Date[_0x24bdcc(0x101)](),_0x2b309d=0x1388;let _0x339dc3=0x0;try{while(Date[_0x24bdcc(0x101)]()-_0x35134f<_0x31b4d1){await new Promise(_0x36abc0=>setTimeout(_0x36abc0,_0x2b309d));try{const _0x227fff={'Content-Type':_0x24bdcc(0x103),'mj-api-secret':_0x5d48a9},_0xa1930d=_0xc9ade9+_0x24bdcc(0x13d)+_0x3d1786+_0x24bdcc(0x144),_0xcabf79=await axios_1['default'][_0x24bdcc(0xf8)](_0xa1930d,{'headers':_0x227fff}),_0x174cd3=_0xcabf79[_0x24bdcc(0x105)];common_1[_0x24bdcc(0xef)]['debug']('查询结果:\x20'+JSON[_0x24bdcc(0xff)](_0x174cd3),_0x24bdcc(0xfd));if(_0x174cd3['status']===_0x24bdcc(0x124)){common_1[_0x24bdcc(0xef)][_0x24bdcc(0x115)](_0x24bdcc(0x13b)+_0x174cd3[_0x24bdcc(0x12c)],_0x24bdcc(0xfd));let _0x850522=_0x174cd3[_0x24bdcc(0x12c)];const _0x293785=_0x5062eb==='0'&&_0x370be3;let _0x267b26='';if(_0x293785){const _0x33f1eb=new URL(_0x370be3),_0x12ceec=new URL(_0x174cd3['imageUrl']);_0x12ceec['protocol']=_0x33f1eb[_0x24bdcc(0x122)],_0x12ceec['hostname']=_0x33f1eb['hostname'],_0x12ceec[_0x24bdcc(0x145)]=_0x33f1eb[_0x24bdcc(0x145)]?_0x33f1eb[_0x24bdcc(0x145)]:'',_0x850522=_0x12ceec[_0x24bdcc(0x137)](),_0x267b26=_0x24bdcc(0x14c)+_0x850522,common_1['Logger']['log'](_0x267b26,_0x24bdcc(0xfd));}if(_0x2c027b!=='1'){try{common_1['Logger'][_0x24bdcc(0x115)]('------>\x20开始上传图片！！！','MidjourneyService');const _0x41c819=new Date(),_0x166f9b=_0x41c819['getFullYear'](),_0x3b8290=String(_0x41c819[_0x24bdcc(0x12e)]()+0x1)[_0x24bdcc(0xf7)](0x2,'0'),_0x324e3e=String(_0x41c819[_0x24bdcc(0x13f)]())[_0x24bdcc(0xf7)](0x2,'0'),_0x11fbff=''+_0x166f9b+_0x3b8290+'/'+_0x324e3e;_0x850522=await this['uploadService']['uploadFileFromUrl']({'url':_0x850522,'dir':_0x24bdcc(0xf3)+_0x11fbff}),_0x267b26=_0x24bdcc(0x112)+_0x850522;}catch(_0x2d93f2){common_1[_0x24bdcc(0xef)][_0x24bdcc(0x146)](_0x24bdcc(0x142)),_0x267b26=_0x24bdcc(0x129)+_0x850522;}common_1[_0x24bdcc(0xef)][_0x24bdcc(0x115)](_0x267b26,'MidjourneyService');}else _0x267b26=_0x24bdcc(0x121)+_0x850522,common_1['Logger'][_0x24bdcc(0x115)](_0x267b26,_0x24bdcc(0xfd));_0x32e247[_0x24bdcc(0x11f)]=_0x850522,_0x32e247[_0x24bdcc(0x151)]=_0x174cd3['id'],_0x32e247[_0x24bdcc(0x136)]=JSON[_0x24bdcc(0xff)](_0x174cd3['buttons']),_0x32e247['answer']=_0x17e8a3+'\x0a'+(_0x174cd3[_0x24bdcc(0xfc)]||_0x174cd3[_0x24bdcc(0x11e)][_0x24bdcc(0xfc)]||''),_0x44d308(_0x32e247);return;}_0x32e247[_0x24bdcc(0x13a)]=_0x174cd3===null||_0x174cd3===void 0x0?void 0x0:_0x174cd3[_0x24bdcc(0x13a)],_0x32e247[_0x24bdcc(0x147)]='当前绘制进度\x20'+(_0x174cd3===null||_0x174cd3===void 0x0?void 0x0:_0x174cd3[_0x24bdcc(0x13a)]),_0x32e247[_0x24bdcc(0x13a)]&&_0x3ec23e(_0x32e247);}catch(_0x196280){_0x339dc3++,common_1[_0x24bdcc(0xef)][_0x24bdcc(0x146)]('轮询过程中发生错误:\x20'+_0x196280,'MidjourneyService');}}common_1['Logger'][_0x24bdcc(0x146)](_0x24bdcc(0xee)+_0x35134f/0x3e8+_0x24bdcc(0x110)),_0x32e247[_0x24bdcc(0x130)]=0x4,_0x4382a1(_0x32e247);throw new common_1['HttpException'](_0x24bdcc(0xf9),common_1[_0x24bdcc(0x108)][_0x24bdcc(0x11a)]);}catch(_0x1870a0){common_1[_0x24bdcc(0xef)][_0x24bdcc(0x146)](_0x24bdcc(0x120)+_0x1870a0+_0x24bdcc(0x10e)),_0x32e247['status']=0x5,_0x4382a1(_0x32e247);}}['getMidjourneyModelByPlugin'](_0x594c31){const _0x5d3221=_0x244b17;return _0x5d3221(0xf1);}};function _0x2282(_0x3c7681,_0x115822){const _0x33ceb1=_0x33ce();return _0x2282=function(_0x228247,_0x41ad98){_0x228247=_0x228247-0xea;let _0x59bd2=_0x33ceb1[_0x228247];return _0x59bd2;},_0x2282(_0x3c7681,_0x115822);}MidjourneyService=__decorate([(0x0,common_1[_0x244b17(0x116)])(),__metadata(_0x244b17(0x14f),[upload_service_1[_0x244b17(0x141)],globalConfig_service_1[_0x244b17(0x107)],chatLog_service_1[_0x244b17(0x128)],models_service_1['ModelsService']])],MidjourneyService),exports['MidjourneyService']=MidjourneyService;function _0x33ce(){const _0x53c04b=['properties','fileInfo','绘画失败:\x20','不保存图片，使用\x20URL:\x20','protocol','from','SUCCESS','3920744grIhrz','../chatLog/chatLog.service','function','ChatLogService','存储图片失败，使用原始/代理图片链接\x20','121rqTDYq','getModelConfigByName','imageUrl','570578qlCTMc','getMonth','PICREADER','status','/mj/submit/modal','result','mjNotSaveImg','7986970VwecOE','6TLkApP','customId','toString','data:image/png;base64,','/mj/submit/describe','progress','绘制成功,\x20获取到的URL:\x20','@nestjs/common','/mj/task/','state','getDate','__esModule','UploadService','存储图片失败，使用原始/代理图片链接','../models/models.service','/fetch','port','error','answer','88976cFfThp','绘画任务提交失败,\x20请检查后台配置或者稍后重试!\x20','axios','catch','使用代理替换后的\x20URL:\x20','pollMjDrawingResult','modelsService','design:paramtypes','绘画任务提交成功','drawId','object','globalConfigService','defineProperty','chatLogService','正在准备发送请求到\x20','../globalConfig/globalConfig.service','超过\x20','Logger','updateChatLog','midjourney','25809xUkNpc','images/midjourney/','DESCRIBE','绘图成功！','IMAGINE','padStart','get','绘画超时，请稍后再试！','__metadata','绘画任务提交成功,\x20绘画ID:\x20','finalPrompt','MidjourneyService','306BTjSxh','stringify','/mj/submit/action','now','base64','application/x-www-form-urlencoded','getOwnPropertyDescriptor','data','decorate','GlobalConfigService','HttpStatus','../upload/upload.service','175656rrBQsF','100%','1066632hXrIWF','getConfigs','\x20MidjourneyService','5JWfoDw','\x20s\x20未完成绘画,\x20请稍后再试!\x20MidjourneyService','length','上传成功\x20URL:\x20','查询绘图结果时发生错误:','mjNotUseProxy','log','Injectable','debug','，payload:\x20','uploadService','BAD_REQUEST','绘图失败','1038zQTTFv','__decorate'];_0x33ce=function(){return _0x53c04b;};return _0x33ce();}