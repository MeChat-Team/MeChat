'use strict';const _0x570cdf=_0x20f3;(function(_0x41f2e5,_0x3fc6f5){const _0x3200a6=_0x20f3,_0x529c95=_0x41f2e5();while(!![]){try{const _0x29bbfb=-parseInt(_0x3200a6(0x150))/0x1+-parseInt(_0x3200a6(0x193))/0x2*(parseInt(_0x3200a6(0x14b))/0x3)+parseInt(_0x3200a6(0x13f))/0x4*(-parseInt(_0x3200a6(0x14e))/0x5)+parseInt(_0x3200a6(0x181))/0x6+parseInt(_0x3200a6(0x136))/0x7*(parseInt(_0x3200a6(0x189))/0x8)+-parseInt(_0x3200a6(0x16f))/0x9*(parseInt(_0x3200a6(0x18c))/0xa)+-parseInt(_0x3200a6(0x17b))/0xb*(-parseInt(_0x3200a6(0x143))/0xc);if(_0x29bbfb===_0x3fc6f5)break;else _0x529c95['push'](_0x529c95['shift']());}catch(_0x37ea9b){_0x529c95['push'](_0x529c95['shift']());}}}(_0x3619,0x5ca45));function _0x20f3(_0x363de4,_0x27be1a){const _0x36193b=_0x3619();return _0x20f3=function(_0x20f33d,_0x4f1bd5){_0x20f33d=_0x20f33d-0x12e;let _0x46e3da=_0x36193b[_0x20f33d];return _0x46e3da;},_0x20f3(_0x363de4,_0x27be1a);}function _0x3619(){const _0x16042f=['padStart','length','绘画任务提交失败,\x20请检查后台配置或者稍后重试!\x20','drawId','chatLogService','log','getMidjourneyModelByPlugin','../models/models.service','error','/mj/submit/describe','debug','progress','正在准备发送请求到\x20','Injectable','mjProxyImgUrl','MidjourneyService','GlobalConfigService','Logger','------>\x20开始上传图片！！！','fileInfo','now','function','../upload/upload.service','ModelsService','protocol','midjourney','绘制成功,\x20获取到的URL:\x20','updateChatLog','绘图失败','9DMIzIB','decorate','绘图成功！','轮询过程中发生错误:\x20','state','getModelConfigByName','port','__esModule','finalPrompt','result','BAD_REQUEST','查询绘图结果时发生错误:','7805633mwMXmY','/mj/submit/action','axios','uploadFileFromUrl','\x20s\x20未完成绘画,\x20请稍后再试!\x20MidjourneyService','，payload:\x20','420960AFKDjT','default','绘画任务提交成功,\x20绘画ID:\x20','midjourneyDraw','SUCCESS','uploadService','../globalConfig/globalConfig.service','__decorate','5972808wtipuo','收到响应:\x20','from','1789070BvhDZv','post','answer','/mj/task/','buttons','getConfigs','properties','20ngdygo','metadata','../chatLog/chatLog.service','查询结果:\x20','存储图片失败，使用原始/代理图片链接\x20','100%','blob','绘画任务提交成功','object','status','hostname','UploadService','mjNotSaveImg','stringify','未能获取结果数据,\x20即将重试','7zvjJro','/mj/submit/imagine','imageUrl','@nestjs/common','globalConfigService','toString','defineProperty','catch','/mj/submit/modal','20LikXte','超过\x20','任务提交失败，请检查提示词后重试','design:paramtypes','12LkRVRs','get','modelsService','__metadata','images/midjourney/','PICREADER','data:image/png;base64,','pollMjDrawingResult','38220VwWAhr','HttpException','存储图片失败，使用原始/代理图片链接','191665sEmmRP','data','648931ALjToX','绘制中！绘制进度'];_0x3619=function(){return _0x16042f;};return _0x3619();}var __decorate=this&&this[_0x570cdf(0x188)]||function(_0x160d5e,_0x21956b,_0x52821c,_0x1c3c78){const _0x1b8f6a=_0x570cdf;var _0x31e5bb=arguments[_0x1b8f6a(0x153)],_0x4dd5c8=_0x31e5bb<0x3?_0x21956b:_0x1c3c78===null?_0x1c3c78=Object['getOwnPropertyDescriptor'](_0x21956b,_0x52821c):_0x1c3c78,_0x2f80e8;if(typeof Reflect===_0x1b8f6a(0x12f)&&typeof Reflect[_0x1b8f6a(0x170)]===_0x1b8f6a(0x167))_0x4dd5c8=Reflect['decorate'](_0x160d5e,_0x21956b,_0x52821c,_0x1c3c78);else{for(var _0x34828e=_0x160d5e[_0x1b8f6a(0x153)]-0x1;_0x34828e>=0x0;_0x34828e--)if(_0x2f80e8=_0x160d5e[_0x34828e])_0x4dd5c8=(_0x31e5bb<0x3?_0x2f80e8(_0x4dd5c8):_0x31e5bb>0x3?_0x2f80e8(_0x21956b,_0x52821c,_0x4dd5c8):_0x2f80e8(_0x21956b,_0x52821c))||_0x4dd5c8;}return _0x31e5bb>0x3&&_0x4dd5c8&&Object[_0x1b8f6a(0x13c)](_0x21956b,_0x52821c,_0x4dd5c8),_0x4dd5c8;},__metadata=this&&this[_0x570cdf(0x146)]||function(_0x1fa53a,_0x3c228c){const _0x3b58c3=_0x570cdf;if(typeof Reflect===_0x3b58c3(0x12f)&&typeof Reflect[_0x3b58c3(0x194)]==='function')return Reflect[_0x3b58c3(0x194)](_0x1fa53a,_0x3c228c);};Object['defineProperty'](exports,_0x570cdf(0x176),{'value':!![]}),exports['MidjourneyService']=void 0x0;const common_1=require(_0x570cdf(0x139)),axios_1=require(_0x570cdf(0x17d)),chatLog_service_1=require(_0x570cdf(0x195)),globalConfig_service_1=require(_0x570cdf(0x187)),upload_service_1=require(_0x570cdf(0x168)),models_service_1=require(_0x570cdf(0x159));let MidjourneyService=class MidjourneyService{constructor(_0x4e3236,_0xb597e6,_0x3e255b,_0x3402d4){const _0x5add25=_0x570cdf;this[_0x5add25(0x186)]=_0x4e3236,this[_0x5add25(0x13a)]=_0xb597e6,this[_0x5add25(0x156)]=_0x3e255b,this[_0x5add25(0x145)]=_0x3402d4;}async[_0x570cdf(0x184)](_0x4c364c){const _0x2e5904=_0x570cdf;var _0x2811ef,_0x4c29f8,_0x325ae7,_0x142cc7;const {id:_0xb4470f,apiKey:_0x44ca57,proxyUrl:_0x12699d,action:_0x488497,drawId:_0x5b23f4,prompt:_0x29e295,usePrompt:_0x1f1579,customId:_0x152f1e,timeout:_0x25c853,fileInfo:_0x4c6145,assistantLogId:_0x34abe5,pluginName:_0x4950f2}=_0x4c364c;let _0x26e2e5={'text':'','fileInfo':'','drawId':'','customId':'','status':0x2};const _0x13ad9e=this['getMidjourneyModelByPlugin'](_0x4950f2),_0x8e0dbe=await this[_0x2e5904(0x145)][_0x2e5904(0x174)](_0x13ad9e),_0x1e609e=(_0x8e0dbe===null||_0x8e0dbe===void 0x0?void 0x0:_0x8e0dbe['key'])||_0x44ca57;let _0x368119,_0x22f07f=0x0,_0x3a8bda='';const _0xea6d8d={'mj-api-secret':_0x1e609e};common_1[_0x2e5904(0x163)][_0x2e5904(0x15c)]('当前任务类型:\x20'+_0x488497,_0x2e5904(0x161));while(_0x22f07f<0x3){let _0x10e347={};try{if(_0x488497==='IMAGINE')_0x3a8bda=_0x12699d+_0x2e5904(0x137),_0x10e347={'prompt':_0x1f1579};else{if(_0x488497==='DESCRIBE'){_0x3a8bda=_0x12699d+_0x2e5904(0x15b);if(_0x4c6145){const _0x88ac6d=await fetch(_0x4c6145),_0x509223=await _0x88ac6d[_0x2e5904(0x199)](),_0x4c7513=Buffer[_0x2e5904(0x18b)](await _0x509223['arrayBuffer']()),_0xb9ea1c=_0x4c7513[_0x2e5904(0x13b)]('base64');_0x10e347={'base64':_0x2e5904(0x149)+_0xb9ea1c};}else return;}else _0x488497===_0x2e5904(0x148)?(_0x3a8bda=_0x12699d+_0x2e5904(0x17c),_0x10e347={'taskId':_0x5b23f4,'customId':_0x152f1e},_0x368119=await axios_1[_0x2e5904(0x182)]['post'](_0x3a8bda,_0x10e347,{'headers':_0xea6d8d}),(_0x368119===null||_0x368119===void 0x0?void 0x0:_0x368119['status'])===0xc8&&((_0x2811ef=_0x368119===null||_0x368119===void 0x0?void 0x0:_0x368119['data'])===null||_0x2811ef===void 0x0?void 0x0:_0x2811ef['result'])&&(_0x3a8bda=_0x12699d+_0x2e5904(0x13e),_0x10e347={'taskId':(_0x4c29f8=_0x368119===null||_0x368119===void 0x0?void 0x0:_0x368119['data'])===null||_0x4c29f8===void 0x0?void 0x0:_0x4c29f8[_0x2e5904(0x178)]})):(_0x3a8bda=_0x12699d+'/mj/submit/action',_0x10e347={'taskId':_0x5b23f4,'customId':_0x152f1e});}common_1[_0x2e5904(0x163)]['log'](_0x2e5904(0x15e)+_0x3a8bda+_0x2e5904(0x180)+JSON[_0x2e5904(0x134)](_0x10e347)+',\x20headers:\x20'+JSON[_0x2e5904(0x134)](_0xea6d8d),_0x2e5904(0x161)),_0x368119=await axios_1[_0x2e5904(0x182)][_0x2e5904(0x18d)](_0x3a8bda,_0x10e347,{'headers':_0xea6d8d});if((_0x368119===null||_0x368119===void 0x0?void 0x0:_0x368119[_0x2e5904(0x130)])===0xc8&&((_0x325ae7=_0x368119===null||_0x368119===void 0x0?void 0x0:_0x368119['data'])===null||_0x325ae7===void 0x0?void 0x0:_0x325ae7[_0x2e5904(0x178)])){common_1[_0x2e5904(0x163)][_0x2e5904(0x15c)](_0x2e5904(0x18a)+JSON[_0x2e5904(0x134)](_0x368119[_0x2e5904(0x14f)]),_0x2e5904(0x161)),_0x26e2e5['drawId']=(_0x142cc7=_0x368119===null||_0x368119===void 0x0?void 0x0:_0x368119[_0x2e5904(0x14f)])===null||_0x142cc7===void 0x0?void 0x0:_0x142cc7[_0x2e5904(0x178)],_0x26e2e5[_0x2e5904(0x173)]=0x2,_0x26e2e5['answer']=_0x2e5904(0x12e),common_1['Logger'][_0x2e5904(0x157)](_0x2e5904(0x183)+_0x368119['data'][_0x2e5904(0x178)],_0x2e5904(0x161));break;}else throw new Error(_0x2e5904(0x135));}catch(_0x4d9870){_0x22f07f++,_0x22f07f>=0x3&&(_0x26e2e5[_0x2e5904(0x18e)]=_0x2e5904(0x141),_0x26e2e5[_0x2e5904(0x130)]=0x5,common_1['Logger'][_0x2e5904(0x157)](_0x2e5904(0x154)+_0x4d9870,_0x2e5904(0x161)));}}return this[_0x2e5904(0x14a)]({'proxyUrl':_0x12699d,'apiKey':_0x1e609e,'drawId':_0x26e2e5['drawId'],'timeout':_0x25c853,'prompt':_0x29e295,'onSuccess':async _0x19add4=>{const _0x4224c5=_0x2e5904;await this[_0x4224c5(0x156)][_0x4224c5(0x16d)](_0x34abe5,{'fileInfo':_0x19add4===null||_0x19add4===void 0x0?void 0x0:_0x19add4['fileInfo'],'answer':(_0x19add4===null||_0x19add4===void 0x0?void 0x0:_0x19add4[_0x4224c5(0x18e)])||_0x29e295,'progress':_0x4224c5(0x198),'status':0x3,'drawId':_0x19add4===null||_0x19add4===void 0x0?void 0x0:_0x19add4[_0x4224c5(0x155)],'customId':_0x19add4===null||_0x19add4===void 0x0?void 0x0:_0x19add4['customId']}),common_1[_0x4224c5(0x163)][_0x4224c5(0x157)](_0x4224c5(0x171),_0x4224c5(0x161));},'onDrawing':async _0x304e7b=>{const _0x5ed28f=_0x2e5904;await this[_0x5ed28f(0x156)][_0x5ed28f(0x16d)](_0x34abe5,{'answer':(_0x304e7b===null||_0x304e7b===void 0x0?void 0x0:_0x304e7b[_0x5ed28f(0x18e)])||'绘制中','progress':_0x304e7b===null||_0x304e7b===void 0x0?void 0x0:_0x304e7b[_0x5ed28f(0x15d)],'status':0x2}),common_1[_0x5ed28f(0x163)][_0x5ed28f(0x157)](_0x5ed28f(0x151)+(_0x304e7b===null||_0x304e7b===void 0x0?void 0x0:_0x304e7b[_0x5ed28f(0x15d)]),_0x5ed28f(0x161));},'onFailure':async _0x765a46=>{const _0xb82b30=_0x2e5904;await this[_0xb82b30(0x156)]['updateChatLog'](_0x34abe5,{'answer':_0xb82b30(0x16e),'status':_0x765a46[_0xb82b30(0x130)]}),common_1[_0xb82b30(0x163)][_0xb82b30(0x157)](_0xb82b30(0x16e),_0xb82b30(0x161));}})[_0x2e5904(0x13d)](_0x2ecbd5=>{const _0x32a2e6=_0x2e5904;common_1['Logger']['error'](_0x32a2e6(0x17a),_0x2ecbd5,_0x32a2e6(0x161));}),_0x26e2e5;}async[_0x570cdf(0x14a)](_0x48ec9c){const _0x81bcc3=_0x570cdf,{proxyUrl:_0x4b0cf6,apiKey:_0x515e39,drawId:_0x2b22ed,timeout:_0x3d7beb,onSuccess:_0x22aedb,prompt:_0xb57e7a,onFailure:_0x5b3642,onDrawing:_0x52efec}=_0x48ec9c,{mjNotSaveImg:_0x5a8898,mjProxyImgUrl:_0x3098ad,mjNotUseProxy:_0x5198e9}=await this[_0x81bcc3(0x13a)][_0x81bcc3(0x191)]([_0x81bcc3(0x133),_0x81bcc3(0x160),'mjNotUseProxy']);let _0x42be3b={'fileInfo':'','drawId':'','customId':'','status':0x2,'progress':0x0,'answer':''};const _0x1d88cf=Date[_0x81bcc3(0x166)](),_0x38c594=0x1388;let _0x5ccbe4=0x0;try{while(Date[_0x81bcc3(0x166)]()-_0x1d88cf<_0x3d7beb){await new Promise(_0x28489e=>setTimeout(_0x28489e,_0x38c594));try{const _0x44ce84={'Content-Type':'application/x-www-form-urlencoded','mj-api-secret':_0x515e39},_0x46e281=_0x4b0cf6+_0x81bcc3(0x18f)+_0x2b22ed+'/fetch',_0xf5ced3=await axios_1['default'][_0x81bcc3(0x144)](_0x46e281,{'headers':_0x44ce84}),_0x2cd103=_0xf5ced3['data'];common_1[_0x81bcc3(0x163)][_0x81bcc3(0x15c)](_0x81bcc3(0x196)+JSON[_0x81bcc3(0x134)](_0x2cd103),'MidjourneyService');if(_0x2cd103[_0x81bcc3(0x130)]===_0x81bcc3(0x185)){common_1['Logger'][_0x81bcc3(0x157)](_0x81bcc3(0x16c)+_0x2cd103[_0x81bcc3(0x138)],'MidjourneyService');let _0x4c44d3=_0x2cd103[_0x81bcc3(0x138)];const _0x5e895e=_0x5198e9==='0'&&_0x3098ad;let _0x30a96c='';if(_0x5e895e){const _0x4a3b3a=new URL(_0x3098ad),_0x471457=new URL(_0x2cd103['imageUrl']);_0x471457[_0x81bcc3(0x16a)]=_0x4a3b3a[_0x81bcc3(0x16a)],_0x471457[_0x81bcc3(0x131)]=_0x4a3b3a[_0x81bcc3(0x131)],_0x471457['port']=_0x4a3b3a[_0x81bcc3(0x175)]?_0x4a3b3a[_0x81bcc3(0x175)]:'',_0x4c44d3=_0x471457[_0x81bcc3(0x13b)](),_0x30a96c='使用代理替换后的\x20URL:\x20'+_0x4c44d3,common_1[_0x81bcc3(0x163)][_0x81bcc3(0x157)](_0x30a96c,'MidjourneyService');}if(_0x5a8898!=='1'){try{common_1['Logger'][_0x81bcc3(0x157)](_0x81bcc3(0x164),_0x81bcc3(0x161));const _0x1ea508=new Date(),_0x4d6479=_0x1ea508['getFullYear'](),_0x1ca4ef=String(_0x1ea508['getMonth']()+0x1)[_0x81bcc3(0x152)](0x2,'0'),_0x6b7bc1=String(_0x1ea508['getDate']())[_0x81bcc3(0x152)](0x2,'0'),_0x1ee6c5=''+_0x4d6479+_0x1ca4ef+'/'+_0x6b7bc1;_0x4c44d3=await this[_0x81bcc3(0x186)][_0x81bcc3(0x17e)]({'url':_0x4c44d3,'dir':_0x81bcc3(0x147)+_0x1ee6c5}),_0x30a96c='上传成功\x20URL:\x20'+_0x4c44d3;}catch(_0x25b5a0){common_1['Logger'][_0x81bcc3(0x15a)](_0x81bcc3(0x14d)),_0x30a96c=_0x81bcc3(0x197)+_0x4c44d3;}common_1[_0x81bcc3(0x163)]['log'](_0x30a96c,'MidjourneyService');}else _0x30a96c='不保存图片，使用\x20URL:\x20'+_0x4c44d3,common_1[_0x81bcc3(0x163)][_0x81bcc3(0x157)](_0x30a96c,'MidjourneyService');_0x42be3b[_0x81bcc3(0x165)]=_0x4c44d3,_0x42be3b[_0x81bcc3(0x155)]=_0x2cd103['id'],_0x42be3b['customId']=JSON['stringify'](_0x2cd103[_0x81bcc3(0x190)]),_0x42be3b[_0x81bcc3(0x18e)]=_0xb57e7a+'\x0a'+(_0x2cd103[_0x81bcc3(0x177)]||_0x2cd103[_0x81bcc3(0x192)][_0x81bcc3(0x177)]||''),_0x22aedb(_0x42be3b);return;}_0x42be3b[_0x81bcc3(0x15d)]=_0x2cd103===null||_0x2cd103===void 0x0?void 0x0:_0x2cd103['progress'],_0x42be3b[_0x81bcc3(0x18e)]='当前绘制进度\x20'+(_0x2cd103===null||_0x2cd103===void 0x0?void 0x0:_0x2cd103[_0x81bcc3(0x15d)]),_0x42be3b[_0x81bcc3(0x15d)]&&_0x52efec(_0x42be3b);}catch(_0xd0246){_0x5ccbe4++,common_1[_0x81bcc3(0x163)][_0x81bcc3(0x15a)](_0x81bcc3(0x172)+_0xd0246,'MidjourneyService');}}common_1[_0x81bcc3(0x163)][_0x81bcc3(0x15a)](_0x81bcc3(0x140)+_0x1d88cf/0x3e8+_0x81bcc3(0x17f)),_0x42be3b[_0x81bcc3(0x130)]=0x4,_0x5b3642(_0x42be3b);throw new common_1[(_0x81bcc3(0x14c))]('绘画超时，请稍后再试！',common_1['HttpStatus'][_0x81bcc3(0x179)]);}catch(_0x1677ca){common_1['Logger'][_0x81bcc3(0x15a)]('绘画失败:\x20'+_0x1677ca+'\x20MidjourneyService'),_0x42be3b['status']=0x5,_0x5b3642(_0x42be3b);}}[_0x570cdf(0x158)](_0x1303e6){const _0x3ad1df=_0x570cdf;return _0x3ad1df(0x16b);}};MidjourneyService=__decorate([(0x0,common_1[_0x570cdf(0x15f)])(),__metadata(_0x570cdf(0x142),[upload_service_1[_0x570cdf(0x132)],globalConfig_service_1[_0x570cdf(0x162)],chatLog_service_1['ChatLogService'],models_service_1[_0x570cdf(0x169)]])],MidjourneyService),exports['MidjourneyService']=MidjourneyService;