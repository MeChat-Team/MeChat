'use strict';const _0x46a0f1=_0x28c1;function _0x67fd(){const _0x3531af=['properties','arrayBuffer','@nestjs/common','15oGpxKc','绘画任务提交成功,\x20绘画ID:\x20','查询结果:\x20','result','../models/models.service','绘画任务提交失败,\x20请检查后台配置或者稍后重试!\x20','9zZFwLO','GlobalConfigService','drawId','port','blob','/mj/submit/action','1024422FwnoFl','ChatLogService','data','getConfigs','finalPrompt','pollMjDrawingResult','padStart','存储图片失败，使用原始/代理图片链接','application/x-www-form-urlencoded','modelsService','uploadService','progress','使用代理替换后的\x20URL:\x20','updateChatLog','当前绘制进度\x20','state','/mj/task/','function','decorate','DESCRIBE','key','MidjourneyService','data:image/png;base64,','getOwnPropertyDescriptor','defineProperty','Logger','/mj/submit/modal','getFullYear','2711152BHmEbq','answer','object','error','查询绘图结果时发生错误:','未能获取结果数据,\x20即将重试','../chatLog/chatLog.service','fileInfo','HttpStatus','，payload:\x20','mjProxyImgUrl','正在准备发送请求到\x20','get','midjourney','------>\x20开始上传图片！！！','627158PifeHa','HttpException','__metadata','ModelsService','轮询过程中发生错误:\x20','toString','metadata','3149755eSOvRf','Injectable','绘图成功！','绘制中','绘图失败','PICREADER','../globalConfig/globalConfig.service','status','绘制中！绘制进度',',\x20headers:\x20','绘画超时，请稍后再试！','绘画失败:\x20','design:paramtypes','imageUrl','post','stringify','hostname','553005xEHaXF','BAD_REQUEST','getMonth','debug','customId','/mj/submit/imagine','不保存图片，使用\x20URL:\x20','绘画任务提交成功','1175820PGfgkC','\x20s\x20未完成绘画,\x20请稍后再试!\x20MidjourneyService','log','__decorate','上传成功\x20URL:\x20','chatLogService','存储图片失败，使用原始/代理图片链接\x20','length','getMidjourneyModelByPlugin','uploadFileFromUrl','default','protocol','globalConfigService','/mj/submit/describe','257065VmUhlk','now'];_0x67fd=function(){return _0x3531af;};return _0x67fd();}(function(_0x1727b9,_0x3c8683){const _0x22e53f=_0x28c1,_0x3be299=_0x1727b9();while(!![]){try{const _0x423573=-parseInt(_0x22e53f(0x101))/0x1+parseInt(_0x22e53f(0x13d))/0x2+parseInt(_0x22e53f(0x155))/0x3+parseInt(_0x22e53f(0x15d))/0x4+-parseInt(_0x22e53f(0x106))/0x5*(-parseInt(_0x22e53f(0x112))/0x6)+-parseInt(_0x22e53f(0x144))/0x7+parseInt(_0x22e53f(0x12e))/0x8*(-parseInt(_0x22e53f(0x10c))/0x9);if(_0x423573===_0x3c8683)break;else _0x3be299['push'](_0x3be299['shift']());}catch(_0x2bb4c4){_0x3be299['push'](_0x3be299['shift']());}}}(_0x67fd,0x3f06c));var __decorate=this&&this[_0x46a0f1(0x160)]||function(_0xa2de1d,_0x402777,_0x391a39,_0x23c8d0){const _0x4c45e7=_0x46a0f1;var _0x422685=arguments[_0x4c45e7(0x164)],_0x1082e0=_0x422685<0x3?_0x402777:_0x23c8d0===null?_0x23c8d0=Object[_0x4c45e7(0x129)](_0x402777,_0x391a39):_0x23c8d0,_0x53b99b;if(typeof Reflect===_0x4c45e7(0x130)&&typeof Reflect[_0x4c45e7(0x124)]==='function')_0x1082e0=Reflect[_0x4c45e7(0x124)](_0xa2de1d,_0x402777,_0x391a39,_0x23c8d0);else{for(var _0x5549f7=_0xa2de1d['length']-0x1;_0x5549f7>=0x0;_0x5549f7--)if(_0x53b99b=_0xa2de1d[_0x5549f7])_0x1082e0=(_0x422685<0x3?_0x53b99b(_0x1082e0):_0x422685>0x3?_0x53b99b(_0x402777,_0x391a39,_0x1082e0):_0x53b99b(_0x402777,_0x391a39))||_0x1082e0;}return _0x422685>0x3&&_0x1082e0&&Object[_0x4c45e7(0x12a)](_0x402777,_0x391a39,_0x1082e0),_0x1082e0;},__metadata=this&&this[_0x46a0f1(0x13f)]||function(_0xf0d10c,_0x462857){const _0x473200=_0x46a0f1;if(typeof Reflect==='object'&&typeof Reflect['metadata']===_0x473200(0x123))return Reflect[_0x473200(0x143)](_0xf0d10c,_0x462857);};function _0x28c1(_0x3882e,_0x4935a3){const _0x67fd85=_0x67fd();return _0x28c1=function(_0x28c18d,_0xe9c78e){_0x28c18d=_0x28c18d-0x100;let _0x11dcf4=_0x67fd85[_0x28c18d];return _0x11dcf4;},_0x28c1(_0x3882e,_0x4935a3);}Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[_0x46a0f1(0x127)]=void 0x0;const common_1=require(_0x46a0f1(0x105)),axios_1=require('axios'),chatLog_service_1=require(_0x46a0f1(0x134)),globalConfig_service_1=require(_0x46a0f1(0x14a)),upload_service_1=require('../upload/upload.service'),models_service_1=require(_0x46a0f1(0x10a));let MidjourneyService=class MidjourneyService{constructor(_0x3216b2,_0x26f569,_0x4e0dbe,_0x1acb18){const _0x24a795=_0x46a0f1;this[_0x24a795(0x11c)]=_0x3216b2,this[_0x24a795(0x169)]=_0x26f569,this[_0x24a795(0x162)]=_0x4e0dbe,this[_0x24a795(0x11b)]=_0x1acb18;}async['midjourneyDraw'](_0x353b6f){const _0x217d36=_0x46a0f1;var _0x16d7ca,_0x147819,_0x16840a,_0x283af4;const {id:_0x1068d4,apiKey:_0x3edcf4,proxyUrl:_0x4d307a,action:_0x8e5748,drawId:_0x28efef,prompt:_0x3e01a3,usePrompt:_0x2f88eb,customId:_0x37f0b5,timeout:_0xc2bc96,fileInfo:_0x123de2,assistantLogId:_0x524c20,pluginName:_0x4ccc68}=_0x353b6f;let _0x159ac6={'text':'','fileInfo':'','drawId':'','customId':'','status':0x2};const _0xf48005=this[_0x217d36(0x165)](_0x4ccc68),_0x5eabd5=await this['modelsService']['getModelConfigByName'](_0xf48005),_0x11d754=(_0x5eabd5===null||_0x5eabd5===void 0x0?void 0x0:_0x5eabd5[_0x217d36(0x126)])||_0x3edcf4;let _0x2251ac,_0x433520=0x0,_0x19de0c='';const _0x5f029f={'mj-api-secret':_0x11d754};common_1['Logger'][_0x217d36(0x158)]('当前任务类型:\x20'+_0x8e5748,_0x217d36(0x127));while(_0x433520<0x3){let _0x1b9407={};try{if(_0x8e5748==='IMAGINE')_0x19de0c=_0x4d307a+_0x217d36(0x15a),_0x1b9407={'prompt':_0x2f88eb};else{if(_0x8e5748===_0x217d36(0x125)){_0x19de0c=_0x4d307a+_0x217d36(0x100);if(_0x123de2){const _0x5d8a3b=await fetch(_0x123de2),_0xb31eb3=await _0x5d8a3b[_0x217d36(0x110)](),_0xfffa28=Buffer['from'](await _0xb31eb3[_0x217d36(0x104)]()),_0x2e1537=_0xfffa28[_0x217d36(0x142)]('base64');_0x1b9407={'base64':_0x217d36(0x128)+_0x2e1537};}else return;}else _0x8e5748===_0x217d36(0x149)?(_0x19de0c=_0x4d307a+_0x217d36(0x111),_0x1b9407={'taskId':_0x28efef,'customId':_0x37f0b5},_0x2251ac=await axios_1['default'][_0x217d36(0x152)](_0x19de0c,_0x1b9407,{'headers':_0x5f029f}),(_0x2251ac===null||_0x2251ac===void 0x0?void 0x0:_0x2251ac['status'])===0xc8&&((_0x16d7ca=_0x2251ac===null||_0x2251ac===void 0x0?void 0x0:_0x2251ac['data'])===null||_0x16d7ca===void 0x0?void 0x0:_0x16d7ca[_0x217d36(0x109)])&&(_0x19de0c=_0x4d307a+_0x217d36(0x12c),_0x1b9407={'taskId':(_0x147819=_0x2251ac===null||_0x2251ac===void 0x0?void 0x0:_0x2251ac[_0x217d36(0x114)])===null||_0x147819===void 0x0?void 0x0:_0x147819[_0x217d36(0x109)]})):(_0x19de0c=_0x4d307a+_0x217d36(0x111),_0x1b9407={'taskId':_0x28efef,'customId':_0x37f0b5});}common_1[_0x217d36(0x12b)][_0x217d36(0x15f)](_0x217d36(0x139)+_0x19de0c+_0x217d36(0x137)+JSON[_0x217d36(0x153)](_0x1b9407)+_0x217d36(0x14d)+JSON[_0x217d36(0x153)](_0x5f029f),_0x217d36(0x127)),_0x2251ac=await axios_1[_0x217d36(0x167)]['post'](_0x19de0c,_0x1b9407,{'headers':_0x5f029f});if((_0x2251ac===null||_0x2251ac===void 0x0?void 0x0:_0x2251ac['status'])===0xc8&&((_0x16840a=_0x2251ac===null||_0x2251ac===void 0x0?void 0x0:_0x2251ac[_0x217d36(0x114)])===null||_0x16840a===void 0x0?void 0x0:_0x16840a[_0x217d36(0x109)])){common_1[_0x217d36(0x12b)][_0x217d36(0x158)]('收到响应:\x20'+JSON[_0x217d36(0x153)](_0x2251ac[_0x217d36(0x114)]),'MidjourneyService'),_0x159ac6['drawId']=(_0x283af4=_0x2251ac===null||_0x2251ac===void 0x0?void 0x0:_0x2251ac['data'])===null||_0x283af4===void 0x0?void 0x0:_0x283af4[_0x217d36(0x109)],_0x159ac6[_0x217d36(0x121)]=0x2,_0x159ac6['answer']=_0x217d36(0x15c),common_1['Logger'][_0x217d36(0x15f)](_0x217d36(0x107)+_0x2251ac['data'][_0x217d36(0x109)],_0x217d36(0x127));break;}else throw new Error(_0x217d36(0x133));}catch(_0x252bc5){_0x433520++,_0x433520>=0x3&&(_0x159ac6[_0x217d36(0x12f)]='任务提交失败，请检查提示词后重试',_0x159ac6[_0x217d36(0x14b)]=0x5,common_1['Logger']['log'](_0x217d36(0x10b)+_0x252bc5,_0x217d36(0x127)));}}return this['pollMjDrawingResult']({'proxyUrl':_0x4d307a,'apiKey':_0x11d754,'drawId':_0x159ac6[_0x217d36(0x10e)],'timeout':_0xc2bc96,'prompt':_0x3e01a3,'onSuccess':async _0x20f671=>{const _0x508f28=_0x217d36;await this[_0x508f28(0x162)][_0x508f28(0x11f)](_0x524c20,{'fileInfo':_0x20f671===null||_0x20f671===void 0x0?void 0x0:_0x20f671[_0x508f28(0x135)],'answer':(_0x20f671===null||_0x20f671===void 0x0?void 0x0:_0x20f671['answer'])||_0x3e01a3,'progress':'100%','status':0x3,'drawId':_0x20f671===null||_0x20f671===void 0x0?void 0x0:_0x20f671[_0x508f28(0x10e)],'customId':_0x20f671===null||_0x20f671===void 0x0?void 0x0:_0x20f671[_0x508f28(0x159)]}),common_1[_0x508f28(0x12b)][_0x508f28(0x15f)](_0x508f28(0x146),_0x508f28(0x127));},'onDrawing':async _0x51481d=>{const _0x291a84=_0x217d36;await this[_0x291a84(0x162)][_0x291a84(0x11f)](_0x524c20,{'answer':(_0x51481d===null||_0x51481d===void 0x0?void 0x0:_0x51481d['answer'])||_0x291a84(0x147),'progress':_0x51481d===null||_0x51481d===void 0x0?void 0x0:_0x51481d[_0x291a84(0x11d)],'status':0x2}),common_1[_0x291a84(0x12b)]['log'](_0x291a84(0x14c)+(_0x51481d===null||_0x51481d===void 0x0?void 0x0:_0x51481d[_0x291a84(0x11d)]),_0x291a84(0x127));},'onFailure':async _0x3bee38=>{const _0x128709=_0x217d36;await this[_0x128709(0x162)]['updateChatLog'](_0x524c20,{'answer':_0x128709(0x148),'status':_0x3bee38[_0x128709(0x14b)]}),common_1[_0x128709(0x12b)]['log'](_0x128709(0x148),_0x128709(0x127));}})['catch'](_0x565f9b=>{const _0x3bcf6a=_0x217d36;common_1[_0x3bcf6a(0x12b)][_0x3bcf6a(0x131)](_0x3bcf6a(0x132),_0x565f9b,_0x3bcf6a(0x127));}),_0x159ac6;}async[_0x46a0f1(0x117)](_0x4e7691){const _0x200be3=_0x46a0f1,{proxyUrl:_0x2106d9,apiKey:_0xb2a561,drawId:_0x5662dc,timeout:_0x274309,onSuccess:_0x2226c6,prompt:_0x28a249,onFailure:_0x2b981f,onDrawing:_0x3b5ea3}=_0x4e7691,{mjNotSaveImg:_0x1f98e9,mjProxyImgUrl:_0x5d27a7,mjNotUseProxy:_0x5c9135}=await this['globalConfigService'][_0x200be3(0x115)](['mjNotSaveImg',_0x200be3(0x138),'mjNotUseProxy']);let _0x9b840e={'fileInfo':'','drawId':'','customId':'','status':0x2,'progress':0x0,'answer':''};const _0x3ee324=Date[_0x200be3(0x102)](),_0x222b30=0x1388;let _0x3f3b4a=0x0;try{while(Date[_0x200be3(0x102)]()-_0x3ee324<_0x274309){await new Promise(_0x215ba5=>setTimeout(_0x215ba5,_0x222b30));try{const _0x418a70={'Content-Type':_0x200be3(0x11a),'mj-api-secret':_0xb2a561},_0x5455c2=_0x2106d9+_0x200be3(0x122)+_0x5662dc+'/fetch',_0x3a6639=await axios_1[_0x200be3(0x167)][_0x200be3(0x13a)](_0x5455c2,{'headers':_0x418a70}),_0x388d9b=_0x3a6639['data'];common_1[_0x200be3(0x12b)][_0x200be3(0x158)](_0x200be3(0x108)+JSON[_0x200be3(0x153)](_0x388d9b),_0x200be3(0x127));if(_0x388d9b['status']==='SUCCESS'){common_1[_0x200be3(0x12b)]['log']('绘制成功,\x20获取到的URL:\x20'+_0x388d9b[_0x200be3(0x151)],_0x200be3(0x127));let _0x307578=_0x388d9b['imageUrl'];const _0x579f2b=_0x5c9135==='0'&&_0x5d27a7;let _0x3f4b38='';if(_0x579f2b){const _0x559619=new URL(_0x5d27a7),_0x2c85a6=new URL(_0x388d9b[_0x200be3(0x151)]);_0x2c85a6[_0x200be3(0x168)]=_0x559619[_0x200be3(0x168)],_0x2c85a6['hostname']=_0x559619[_0x200be3(0x154)],_0x2c85a6[_0x200be3(0x10f)]=_0x559619[_0x200be3(0x10f)]?_0x559619[_0x200be3(0x10f)]:'',_0x307578=_0x2c85a6[_0x200be3(0x142)](),_0x3f4b38=_0x200be3(0x11e)+_0x307578,common_1[_0x200be3(0x12b)][_0x200be3(0x15f)](_0x3f4b38,_0x200be3(0x127));}if(_0x1f98e9!=='1'){try{common_1['Logger'][_0x200be3(0x15f)](_0x200be3(0x13c),_0x200be3(0x127));const _0x3d9f54=new Date(),_0x1524e2=_0x3d9f54[_0x200be3(0x12d)](),_0x1df9e7=String(_0x3d9f54[_0x200be3(0x157)]()+0x1)[_0x200be3(0x118)](0x2,'0'),_0x2ab3fa=String(_0x3d9f54['getDate']())[_0x200be3(0x118)](0x2,'0'),_0x4d9376=''+_0x1524e2+_0x1df9e7+'/'+_0x2ab3fa;_0x307578=await this['uploadService'][_0x200be3(0x166)]({'url':_0x307578,'dir':'images/midjourney/'+_0x4d9376}),_0x3f4b38=_0x200be3(0x161)+_0x307578;}catch(_0x520f88){common_1[_0x200be3(0x12b)][_0x200be3(0x131)](_0x200be3(0x119)),_0x3f4b38=_0x200be3(0x163)+_0x307578;}common_1['Logger']['log'](_0x3f4b38,_0x200be3(0x127));}else _0x3f4b38=_0x200be3(0x15b)+_0x307578,common_1['Logger'][_0x200be3(0x15f)](_0x3f4b38,'MidjourneyService');_0x9b840e[_0x200be3(0x135)]=_0x307578,_0x9b840e['drawId']=_0x388d9b['id'],_0x9b840e[_0x200be3(0x159)]=JSON['stringify'](_0x388d9b['buttons']),_0x9b840e[_0x200be3(0x12f)]=_0x28a249+'\x0a'+(_0x388d9b[_0x200be3(0x116)]||_0x388d9b[_0x200be3(0x103)]['finalPrompt']||''),_0x2226c6(_0x9b840e);return;}_0x9b840e[_0x200be3(0x11d)]=_0x388d9b===null||_0x388d9b===void 0x0?void 0x0:_0x388d9b[_0x200be3(0x11d)],_0x9b840e[_0x200be3(0x12f)]=_0x200be3(0x120)+(_0x388d9b===null||_0x388d9b===void 0x0?void 0x0:_0x388d9b['progress']),_0x9b840e[_0x200be3(0x11d)]&&_0x3b5ea3(_0x9b840e);}catch(_0x32d7a0){_0x3f3b4a++,common_1[_0x200be3(0x12b)][_0x200be3(0x131)](_0x200be3(0x141)+_0x32d7a0,_0x200be3(0x127));}}common_1[_0x200be3(0x12b)]['error']('超过\x20'+_0x3ee324/0x3e8+_0x200be3(0x15e)),_0x9b840e[_0x200be3(0x14b)]=0x4,_0x2b981f(_0x9b840e);throw new common_1[(_0x200be3(0x13e))](_0x200be3(0x14e),common_1[_0x200be3(0x136)][_0x200be3(0x156)]);}catch(_0x27fda6){common_1['Logger'][_0x200be3(0x131)](_0x200be3(0x14f)+_0x27fda6+'\x20MidjourneyService'),_0x9b840e['status']=0x5,_0x2b981f(_0x9b840e);}}[_0x46a0f1(0x165)](_0x217e38){const _0x361bbf=_0x46a0f1;return _0x361bbf(0x13b);}};MidjourneyService=__decorate([(0x0,common_1[_0x46a0f1(0x145)])(),__metadata(_0x46a0f1(0x150),[upload_service_1['UploadService'],globalConfig_service_1[_0x46a0f1(0x10d)],chatLog_service_1[_0x46a0f1(0x113)],models_service_1[_0x46a0f1(0x140)]])],MidjourneyService),exports['MidjourneyService']=MidjourneyService;