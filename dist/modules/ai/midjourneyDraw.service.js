'use strict';const _0x45537b=_0x566c;function _0x489f(){const _0x3bcd60=['catch','globalConfigService','50kgrFDd','Logger','GlobalConfigService','1301XQuNwi','object','hostname','mjNotUseProxy','result','PICREADER','key','832316SDxcsx','mjNotSaveImg','default','存储图片失败，使用原始/代理图片链接','MidjourneyService','__metadata','存储图片失败，使用原始/代理图片链接\x20','getModelConfigByName','uploadFileFromUrl','getMidjourneyModelByPlugin','drawId','绘制中！绘制进度','midjourney','绘制成功,\x20获取到的URL:\x20','BAD_REQUEST','protocol','getConfigs','413XhJHLf','design:paramtypes','IMAGINE','当前任务类型:\x20','绘画超时，请稍后再试！','绘画失败:\x20','正在准备发送请求到\x20','40pEafQN','查询绘图结果时发生错误:','now','data','function','updateChatLog','metadata','log','绘画任务提交成功','../models/models.service','不保存图片，使用\x20URL:\x20','绘画任务提交失败,\x20请检查后台配置或者稍后重试!\x20','HttpException','../upload/upload.service','uploadService','使用代理替换后的\x20URL:\x20','blob','，payload:\x20','data:image/png;base64,','ChatLogService',',\x20headers:\x20','UploadService','get','properties','DESCRIBE','1647515umMzGQ','toString','/mj/submit/modal','images/midjourney/','当前绘制进度\x20','customId','base64','SUCCESS','1338588sMkOfH','modelsService','debug','finalPrompt','收到响应:\x20','5520tQyuKm','axios','decorate','buttons','answer','1071135tQoRSM','post','status','state','@nestjs/common','progress','stringify','/mj/submit/action','port','/mj/submit/imagine','/mj/submit/describe','绘图失败','error','上传成功\x20URL:\x20','length','绘画任务提交成功,\x20绘画ID:\x20','imageUrl','37938gcaOvb','getMonth','超过\x20','绘图成功！','application/x-www-form-urlencoded','chatLogService','pollMjDrawingResult','__decorate','/fetch','13200bUpbnC'];_0x489f=function(){return _0x3bcd60;};return _0x489f();}function _0x566c(_0x2b895a,_0xcb08a3){const _0x489f2e=_0x489f();return _0x566c=function(_0x566c31,_0x347bd5){_0x566c31=_0x566c31-0x133;let _0x23740f=_0x489f2e[_0x566c31];return _0x23740f;},_0x566c(_0x2b895a,_0xcb08a3);}(function(_0x3dba03,_0x5e9939){const _0x4d56fd=_0x566c,_0x3b5876=_0x3dba03();while(!![]){try{const _0x43f54c=parseInt(_0x4d56fd(0x162))/0x1*(parseInt(_0x4d56fd(0x15f))/0x2)+-parseInt(_0x4d56fd(0x138))/0x3+parseInt(_0x4d56fd(0x169))/0x4+-parseInt(_0x4d56fd(0x19a))/0x5+-parseInt(_0x4d56fd(0x153))/0x6*(parseInt(_0x4d56fd(0x17a))/0x7)+parseInt(_0x4d56fd(0x181))/0x8*(parseInt(_0x4d56fd(0x142))/0x9)+-parseInt(_0x4d56fd(0x13d))/0xa*(-parseInt(_0x4d56fd(0x15c))/0xb);if(_0x43f54c===_0x5e9939)break;else _0x3b5876['push'](_0x3b5876['shift']());}catch(_0x5cd434){_0x3b5876['push'](_0x3b5876['shift']());}}}(_0x489f,0x5548b));var __decorate=this&&this[_0x45537b(0x15a)]||function(_0x340ab2,_0x25ab49,_0x9571a7,_0x100bab){const _0x1e2437=_0x45537b;var _0x3187e2=arguments[_0x1e2437(0x150)],_0x347224=_0x3187e2<0x3?_0x25ab49:_0x100bab===null?_0x100bab=Object['getOwnPropertyDescriptor'](_0x25ab49,_0x9571a7):_0x100bab,_0x58ab9c;if(typeof Reflect===_0x1e2437(0x163)&&typeof Reflect['decorate']===_0x1e2437(0x185))_0x347224=Reflect[_0x1e2437(0x13f)](_0x340ab2,_0x25ab49,_0x9571a7,_0x100bab);else{for(var _0x38d134=_0x340ab2[_0x1e2437(0x150)]-0x1;_0x38d134>=0x0;_0x38d134--)if(_0x58ab9c=_0x340ab2[_0x38d134])_0x347224=(_0x3187e2<0x3?_0x58ab9c(_0x347224):_0x3187e2>0x3?_0x58ab9c(_0x25ab49,_0x9571a7,_0x347224):_0x58ab9c(_0x25ab49,_0x9571a7))||_0x347224;}return _0x3187e2>0x3&&_0x347224&&Object['defineProperty'](_0x25ab49,_0x9571a7,_0x347224),_0x347224;},__metadata=this&&this[_0x45537b(0x16e)]||function(_0x6f5599,_0x252201){const _0x543ad0=_0x45537b;if(typeof Reflect==='object'&&typeof Reflect[_0x543ad0(0x187)]===_0x543ad0(0x185))return Reflect['metadata'](_0x6f5599,_0x252201);};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[_0x45537b(0x16d)]=void 0x0;const common_1=require(_0x45537b(0x146)),axios_1=require(_0x45537b(0x13e)),chatLog_service_1=require('../chatLog/chatLog.service'),globalConfig_service_1=require('../globalConfig/globalConfig.service'),upload_service_1=require(_0x45537b(0x18e)),models_service_1=require(_0x45537b(0x18a));let MidjourneyService=class MidjourneyService{constructor(_0x40254a,_0xb0103f,_0xd70f5d,_0x15b65b){const _0x7e843e=_0x45537b;this[_0x7e843e(0x18f)]=_0x40254a,this[_0x7e843e(0x15e)]=_0xb0103f,this[_0x7e843e(0x158)]=_0xd70f5d,this[_0x7e843e(0x139)]=_0x15b65b;}async['midjourneyDraw'](_0x11c55c){const _0x56144d=_0x45537b;var _0x51b2a2,_0x51bbeb,_0x2a2c71,_0x11f3a8;const {id:_0x58adf2,apiKey:_0x14d1c9,proxyUrl:_0x581801,action:_0x13c452,drawId:_0x445b50,prompt:_0x168bbb,usePrompt:_0x5bff43,customId:_0x5b933f,timeout:_0x4171e0,fileInfo:_0x4d5eb1,assistantLogId:_0x2389e0,pluginName:_0x50eec0}=_0x11c55c;let _0x14525d={'text':'','fileInfo':'','drawId':'','customId':'','status':0x2};const _0x11a287=this['getMidjourneyModelByPlugin'](_0x50eec0),_0xcaf5d7=await this['modelsService'][_0x56144d(0x170)](_0x11a287),_0x5c4646=(_0xcaf5d7===null||_0xcaf5d7===void 0x0?void 0x0:_0xcaf5d7[_0x56144d(0x168)])||_0x14d1c9;let _0x2eb62e,_0x2dba3f=0x0,_0x3d8187='';const _0x3f1129={'mj-api-secret':_0x5c4646};common_1['Logger'][_0x56144d(0x13a)](_0x56144d(0x17d)+_0x13c452,_0x56144d(0x16d));while(_0x2dba3f<0x3){let _0x5760a6={};try{if(_0x13c452===_0x56144d(0x17c))_0x3d8187=_0x581801+_0x56144d(0x14b),_0x5760a6={'prompt':_0x5bff43};else{if(_0x13c452===_0x56144d(0x199)){_0x3d8187=_0x581801+_0x56144d(0x14c);if(_0x4d5eb1){const _0x411f39=await fetch(_0x4d5eb1),_0x58cd43=await _0x411f39[_0x56144d(0x191)](),_0x1d3098=Buffer['from'](await _0x58cd43['arrayBuffer']()),_0x58e471=_0x1d3098['toString'](_0x56144d(0x136));_0x5760a6={'base64':_0x56144d(0x193)+_0x58e471};}else return;}else _0x13c452===_0x56144d(0x167)?(_0x3d8187=_0x581801+_0x56144d(0x149),_0x5760a6={'taskId':_0x445b50,'customId':_0x5b933f},_0x2eb62e=await axios_1[_0x56144d(0x16b)]['post'](_0x3d8187,_0x5760a6,{'headers':_0x3f1129}),(_0x2eb62e===null||_0x2eb62e===void 0x0?void 0x0:_0x2eb62e[_0x56144d(0x144)])===0xc8&&((_0x51b2a2=_0x2eb62e===null||_0x2eb62e===void 0x0?void 0x0:_0x2eb62e[_0x56144d(0x184)])===null||_0x51b2a2===void 0x0?void 0x0:_0x51b2a2[_0x56144d(0x166)])&&(_0x3d8187=_0x581801+_0x56144d(0x19c),_0x5760a6={'taskId':(_0x51bbeb=_0x2eb62e===null||_0x2eb62e===void 0x0?void 0x0:_0x2eb62e[_0x56144d(0x184)])===null||_0x51bbeb===void 0x0?void 0x0:_0x51bbeb['result']})):(_0x3d8187=_0x581801+'/mj/submit/action',_0x5760a6={'taskId':_0x445b50,'customId':_0x5b933f});}common_1[_0x56144d(0x160)]['log'](_0x56144d(0x180)+_0x3d8187+_0x56144d(0x192)+JSON['stringify'](_0x5760a6)+_0x56144d(0x195)+JSON[_0x56144d(0x148)](_0x3f1129),_0x56144d(0x16d)),_0x2eb62e=await axios_1['default'][_0x56144d(0x143)](_0x3d8187,_0x5760a6,{'headers':_0x3f1129});if((_0x2eb62e===null||_0x2eb62e===void 0x0?void 0x0:_0x2eb62e[_0x56144d(0x144)])===0xc8&&((_0x2a2c71=_0x2eb62e===null||_0x2eb62e===void 0x0?void 0x0:_0x2eb62e[_0x56144d(0x184)])===null||_0x2a2c71===void 0x0?void 0x0:_0x2a2c71[_0x56144d(0x166)])){common_1['Logger'][_0x56144d(0x13a)](_0x56144d(0x13c)+JSON[_0x56144d(0x148)](_0x2eb62e[_0x56144d(0x184)]),_0x56144d(0x16d)),_0x14525d['drawId']=(_0x11f3a8=_0x2eb62e===null||_0x2eb62e===void 0x0?void 0x0:_0x2eb62e[_0x56144d(0x184)])===null||_0x11f3a8===void 0x0?void 0x0:_0x11f3a8[_0x56144d(0x166)],_0x14525d[_0x56144d(0x145)]=0x2,_0x14525d[_0x56144d(0x141)]=_0x56144d(0x189),common_1[_0x56144d(0x160)][_0x56144d(0x188)](_0x56144d(0x151)+_0x2eb62e[_0x56144d(0x184)][_0x56144d(0x166)],_0x56144d(0x16d));break;}else throw new Error('未能获取结果数据,\x20即将重试');}catch(_0x5b4ffe){_0x2dba3f++,_0x2dba3f>=0x3&&(_0x14525d[_0x56144d(0x141)]='任务提交失败，请检查提示词后重试',_0x14525d[_0x56144d(0x144)]=0x5,common_1['Logger'][_0x56144d(0x188)](_0x56144d(0x18c)+_0x5b4ffe,_0x56144d(0x16d)));}}return this[_0x56144d(0x159)]({'proxyUrl':_0x581801,'apiKey':_0x5c4646,'drawId':_0x14525d[_0x56144d(0x173)],'timeout':_0x4171e0,'prompt':_0x168bbb,'onSuccess':async _0x417f23=>{const _0x459839=_0x56144d;await this[_0x459839(0x158)][_0x459839(0x186)](_0x2389e0,{'fileInfo':_0x417f23===null||_0x417f23===void 0x0?void 0x0:_0x417f23['fileInfo'],'answer':(_0x417f23===null||_0x417f23===void 0x0?void 0x0:_0x417f23['answer'])||_0x168bbb,'progress':'100%','status':0x3,'drawId':_0x417f23===null||_0x417f23===void 0x0?void 0x0:_0x417f23['drawId'],'customId':_0x417f23===null||_0x417f23===void 0x0?void 0x0:_0x417f23['customId']}),common_1[_0x459839(0x160)]['log'](_0x459839(0x156),'MidjourneyService');},'onDrawing':async _0x5b0157=>{const _0x300f7c=_0x56144d;await this['chatLogService'][_0x300f7c(0x186)](_0x2389e0,{'answer':(_0x5b0157===null||_0x5b0157===void 0x0?void 0x0:_0x5b0157[_0x300f7c(0x141)])||'绘制中','progress':_0x5b0157===null||_0x5b0157===void 0x0?void 0x0:_0x5b0157[_0x300f7c(0x147)],'status':0x2}),common_1['Logger'][_0x300f7c(0x188)](_0x300f7c(0x174)+(_0x5b0157===null||_0x5b0157===void 0x0?void 0x0:_0x5b0157[_0x300f7c(0x147)]),_0x300f7c(0x16d));},'onFailure':async _0x4ef3c9=>{const _0x11ebdc=_0x56144d;await this[_0x11ebdc(0x158)][_0x11ebdc(0x186)](_0x2389e0,{'answer':_0x11ebdc(0x14d),'status':_0x4ef3c9['status']}),common_1['Logger'][_0x11ebdc(0x188)](_0x11ebdc(0x14d),'MidjourneyService');}})[_0x56144d(0x15d)](_0x2cfa27=>{const _0x2012c1=_0x56144d;common_1['Logger'][_0x2012c1(0x14e)](_0x2012c1(0x182),_0x2cfa27,_0x2012c1(0x16d));}),_0x14525d;}async[_0x45537b(0x159)](_0x40d30b){const _0x4331c3=_0x45537b,{proxyUrl:_0x3bf3c9,apiKey:_0x4d0c6b,drawId:_0x307d39,timeout:_0x1b2f0f,onSuccess:_0x3a0e2b,prompt:_0x9bd1e7,onFailure:_0x50f8bd,onDrawing:_0x27877b}=_0x40d30b,{mjNotSaveImg:_0x4cc958,mjProxyImgUrl:_0x34c134,mjNotUseProxy:_0x15bd32}=await this[_0x4331c3(0x15e)][_0x4331c3(0x179)]([_0x4331c3(0x16a),'mjProxyImgUrl',_0x4331c3(0x165)]);let _0x5e2eb6={'fileInfo':'','drawId':'','customId':'','status':0x2,'progress':0x0,'answer':''};const _0x3e36f0=Date[_0x4331c3(0x183)](),_0x5e47a4=0x1388;let _0x6a597c=0x0;try{while(Date[_0x4331c3(0x183)]()-_0x3e36f0<_0x1b2f0f){await new Promise(_0x3970d7=>setTimeout(_0x3970d7,_0x5e47a4));try{const _0x47d4b2={'Content-Type':_0x4331c3(0x157),'mj-api-secret':_0x4d0c6b},_0x1df0bf=_0x3bf3c9+'/mj/task/'+_0x307d39+_0x4331c3(0x15b),_0x3bda32=await axios_1[_0x4331c3(0x16b)][_0x4331c3(0x197)](_0x1df0bf,{'headers':_0x47d4b2}),_0x46cb75=_0x3bda32[_0x4331c3(0x184)];common_1[_0x4331c3(0x160)][_0x4331c3(0x13a)]('查询结果:\x20'+JSON[_0x4331c3(0x148)](_0x46cb75),_0x4331c3(0x16d));if(_0x46cb75[_0x4331c3(0x144)]===_0x4331c3(0x137)){common_1['Logger'][_0x4331c3(0x188)](_0x4331c3(0x176)+_0x46cb75[_0x4331c3(0x152)],_0x4331c3(0x16d));let _0x4e39a6=_0x46cb75[_0x4331c3(0x152)];const _0x40c56b=_0x15bd32==='0'&&_0x34c134;let _0x5ee711='';if(_0x40c56b){const _0x4645fe=new URL(_0x34c134),_0x5f07bb=new URL(_0x46cb75[_0x4331c3(0x152)]);_0x5f07bb[_0x4331c3(0x178)]=_0x4645fe[_0x4331c3(0x178)],_0x5f07bb[_0x4331c3(0x164)]=_0x4645fe[_0x4331c3(0x164)],_0x5f07bb[_0x4331c3(0x14a)]=_0x4645fe['port']?_0x4645fe['port']:'',_0x4e39a6=_0x5f07bb[_0x4331c3(0x19b)](),_0x5ee711=_0x4331c3(0x190)+_0x4e39a6,common_1[_0x4331c3(0x160)][_0x4331c3(0x188)](_0x5ee711,'MidjourneyService');}if(_0x4cc958!=='1'){try{common_1[_0x4331c3(0x160)][_0x4331c3(0x188)]('------>\x20开始上传图片！！！',_0x4331c3(0x16d));const _0x23c7c5=new Date(),_0x93b885=_0x23c7c5['getFullYear'](),_0x462d7=String(_0x23c7c5[_0x4331c3(0x154)]()+0x1)['padStart'](0x2,'0'),_0x4423ba=String(_0x23c7c5['getDate']())['padStart'](0x2,'0'),_0x14cb04=''+_0x93b885+_0x462d7+'/'+_0x4423ba;_0x4e39a6=await this[_0x4331c3(0x18f)][_0x4331c3(0x171)]({'url':_0x4e39a6,'dir':_0x4331c3(0x133)+_0x14cb04}),_0x5ee711=_0x4331c3(0x14f)+_0x4e39a6;}catch(_0x252af2){common_1['Logger']['error'](_0x4331c3(0x16c)),_0x5ee711=_0x4331c3(0x16f)+_0x4e39a6;}common_1[_0x4331c3(0x160)][_0x4331c3(0x188)](_0x5ee711,_0x4331c3(0x16d));}else _0x5ee711=_0x4331c3(0x18b)+_0x4e39a6,common_1[_0x4331c3(0x160)][_0x4331c3(0x188)](_0x5ee711,_0x4331c3(0x16d));_0x5e2eb6['fileInfo']=_0x4e39a6,_0x5e2eb6[_0x4331c3(0x173)]=_0x46cb75['id'],_0x5e2eb6[_0x4331c3(0x135)]=JSON[_0x4331c3(0x148)](_0x46cb75[_0x4331c3(0x140)]),_0x5e2eb6[_0x4331c3(0x141)]=_0x9bd1e7+'\x0a'+(_0x46cb75[_0x4331c3(0x13b)]||_0x46cb75[_0x4331c3(0x198)]['finalPrompt']||''),_0x3a0e2b(_0x5e2eb6);return;}_0x5e2eb6[_0x4331c3(0x147)]=_0x46cb75===null||_0x46cb75===void 0x0?void 0x0:_0x46cb75[_0x4331c3(0x147)],_0x5e2eb6[_0x4331c3(0x141)]=_0x4331c3(0x134)+(_0x46cb75===null||_0x46cb75===void 0x0?void 0x0:_0x46cb75[_0x4331c3(0x147)]),_0x5e2eb6['progress']&&_0x27877b(_0x5e2eb6);}catch(_0x561c4b){_0x6a597c++,common_1['Logger']['error']('轮询过程中发生错误:\x20'+_0x561c4b,_0x4331c3(0x16d));}}common_1[_0x4331c3(0x160)][_0x4331c3(0x14e)](_0x4331c3(0x155)+_0x3e36f0/0x3e8+'\x20s\x20未完成绘画,\x20请稍后再试!\x20MidjourneyService'),_0x5e2eb6['status']=0x4,_0x50f8bd(_0x5e2eb6);throw new common_1[(_0x4331c3(0x18d))](_0x4331c3(0x17e),common_1['HttpStatus'][_0x4331c3(0x177)]);}catch(_0x2a116b){common_1[_0x4331c3(0x160)][_0x4331c3(0x14e)](_0x4331c3(0x17f)+_0x2a116b+'\x20MidjourneyService'),_0x5e2eb6[_0x4331c3(0x144)]=0x5,_0x50f8bd(_0x5e2eb6);}}[_0x45537b(0x172)](_0x2c3256){const _0x164d9c=_0x45537b;return _0x164d9c(0x175);}};MidjourneyService=__decorate([(0x0,common_1['Injectable'])(),__metadata(_0x45537b(0x17b),[upload_service_1[_0x45537b(0x196)],globalConfig_service_1[_0x45537b(0x161)],chatLog_service_1[_0x45537b(0x194)],models_service_1['ModelsService']])],MidjourneyService),exports[_0x45537b(0x16d)]=MidjourneyService;