'use strict';const _0x50b790=_0x581b;(function(_0x572094,_0x32dd7d){const _0x19b32d=_0x581b,_0x5baecc=_0x572094();while(!![]){try{const _0x47c716=-parseInt(_0x19b32d(0x142))/0x1+-parseInt(_0x19b32d(0x170))/0x2+parseInt(_0x19b32d(0x16f))/0x3*(-parseInt(_0x19b32d(0x14c))/0x4)+-parseInt(_0x19b32d(0x184))/0x5*(-parseInt(_0x19b32d(0x136))/0x6)+parseInt(_0x19b32d(0x155))/0x7+parseInt(_0x19b32d(0x158))/0x8+-parseInt(_0x19b32d(0x163))/0x9*(-parseInt(_0x19b32d(0x144))/0xa);if(_0x47c716===_0x32dd7d)break;else _0x5baecc['push'](_0x5baecc['shift']());}catch(_0x55ed70){_0x5baecc['push'](_0x5baecc['shift']());}}}(_0x989f,0x59250));function _0x581b(_0x31c580,_0x585812){const _0x989f17=_0x989f();return _0x581b=function(_0x581b6c,_0x528f48){_0x581b6c=_0x581b6c-0x122;let _0x2095da=_0x989f17[_0x581b6c];return _0x2095da;},_0x581b(_0x31c580,_0x585812);}function _0x989f(){const _0x201834=['drawId','port','uploadService','axios','3fHcCPq','823930jTEFrH','收到响应:\x20','------>\x20开始上传图片！！！','getModelConfigByName','HttpStatus','100%','../models/models.service','SUCCESS','default','getMonth','toString','当前绘制进度\x20','pollMjDrawingResult','../globalConfig/globalConfig.service','length','answer','mjNotSaveImg','hostname',',\x20headers:\x20','BAD_REQUEST','1955410FMwwiB','查询绘图结果时发生错误:','绘画超时，请稍后再试！','properties','绘图失败','Injectable','__decorate','error','function','imageUrl','protocol','log','未能获取结果数据,\x20即将重试','@nestjs/common','post','customId','modelsService','使用代理替换后的\x20URL:\x20','MidjourneyService','images/midjourney/','fileInfo','finalPrompt','getOwnPropertyDescriptor','base64','getConfigs','查询结果:\x20','blob','Logger','6NWfwFI','getMidjourneyModelByPlugin','getFullYear','mjNotUseProxy','buttons','defineProperty','../chatLog/chatLog.service','progress','__esModule','绘制中','data:image/png;base64,','ModelsService','580897zYMnHD','updateChatLog','130dOgRfX','超过\x20','绘画失败:\x20','midjourneyDraw','ChatLogService','轮询过程中发生错误:\x20','object','stringify','2420896pCmCMZ','decorate','/mj/submit/action','globalConfigService','status','存储图片失败，使用原始/代理图片链接','/mj/submit/describe','，payload:\x20','../upload/upload.service','2924124JhnBnU','\x20MidjourneyService','\x20s\x20未完成绘画,\x20请稍后再试!\x20MidjourneyService','5591832vqRWWh','/mj/task/','绘制成功,\x20获取到的URL:\x20','uploadFileFromUrl','HttpException','不保存图片，使用\x20URL:\x20','result','getDate','midjourney','chatLogService','/mj/submit/modal','315297dcCfzI','任务提交失败，请检查提示词后重试','绘画任务提交成功','绘制中！绘制进度','data','now','key','metadata'];_0x989f=function(){return _0x201834;};return _0x989f();}var __decorate=this&&this[_0x50b790(0x18a)]||function(_0x4c2d8b,_0x23a54b,_0x1bf154,_0x1eb922){const _0x514481=_0x50b790;var _0xde2631=arguments[_0x514481(0x17e)],_0x1e4ec7=_0xde2631<0x3?_0x23a54b:_0x1eb922===null?_0x1eb922=Object[_0x514481(0x130)](_0x23a54b,_0x1bf154):_0x1eb922,_0x45be12;if(typeof Reflect===_0x514481(0x14a)&&typeof Reflect[_0x514481(0x14d)]===_0x514481(0x122))_0x1e4ec7=Reflect[_0x514481(0x14d)](_0x4c2d8b,_0x23a54b,_0x1bf154,_0x1eb922);else{for(var _0x4d1045=_0x4c2d8b[_0x514481(0x17e)]-0x1;_0x4d1045>=0x0;_0x4d1045--)if(_0x45be12=_0x4c2d8b[_0x4d1045])_0x1e4ec7=(_0xde2631<0x3?_0x45be12(_0x1e4ec7):_0xde2631>0x3?_0x45be12(_0x23a54b,_0x1bf154,_0x1e4ec7):_0x45be12(_0x23a54b,_0x1bf154))||_0x1e4ec7;}return _0xde2631>0x3&&_0x1e4ec7&&Object[_0x514481(0x13b)](_0x23a54b,_0x1bf154,_0x1e4ec7),_0x1e4ec7;},__metadata=this&&this['__metadata']||function(_0x5a8bbd,_0x540302){const _0x471ce8=_0x50b790;if(typeof Reflect==='object'&&typeof Reflect['metadata']===_0x471ce8(0x122))return Reflect[_0x471ce8(0x16a)](_0x5a8bbd,_0x540302);};Object['defineProperty'](exports,_0x50b790(0x13e),{'value':!![]}),exports[_0x50b790(0x12c)]=void 0x0;const common_1=require(_0x50b790(0x127)),axios_1=require(_0x50b790(0x16e)),chatLog_service_1=require(_0x50b790(0x13c)),globalConfig_service_1=require(_0x50b790(0x17d)),upload_service_1=require(_0x50b790(0x154)),models_service_1=require(_0x50b790(0x176));let MidjourneyService=class MidjourneyService{constructor(_0x2e4237,_0x436e52,_0x1f1d10,_0x56b3eb){const _0x44315c=_0x50b790;this[_0x44315c(0x16d)]=_0x2e4237,this[_0x44315c(0x14f)]=_0x436e52,this[_0x44315c(0x161)]=_0x1f1d10,this[_0x44315c(0x12a)]=_0x56b3eb;}async[_0x50b790(0x147)](_0x51b0bb){const _0xff84db=_0x50b790;var _0x4dc7b1,_0x55f7d4,_0x2959c8,_0x407008;const {id:_0x5a89de,apiKey:_0x90a016,proxyUrl:_0x2aa762,action:_0x5b1ba2,drawId:_0x3be34c,prompt:_0x4163e9,usePrompt:_0x252c18,customId:_0x2ccf07,timeout:_0x33f25c,fileInfo:_0x17898e,assistantLogId:_0x15d7a7,pluginName:_0x1b5f69}=_0x51b0bb;let _0x1f2100={'text':'','fileInfo':'','drawId':'','customId':'','status':0x2};const _0x414b2c=this[_0xff84db(0x137)](_0x1b5f69),_0x39f75a=await this[_0xff84db(0x12a)][_0xff84db(0x173)](_0x414b2c),_0x221612=(_0x39f75a===null||_0x39f75a===void 0x0?void 0x0:_0x39f75a[_0xff84db(0x169)])||_0x90a016;let _0x4c60da,_0x2c7294=0x0,_0xb872ba='';const _0xbcaf08={'mj-api-secret':_0x221612};common_1[_0xff84db(0x135)]['debug']('当前任务类型:\x20'+_0x5b1ba2,_0xff84db(0x12c));while(_0x2c7294<0x3){let _0x354c63={};try{if(_0x5b1ba2==='IMAGINE')_0xb872ba=_0x2aa762+'/mj/submit/imagine',_0x354c63={'prompt':_0x252c18};else{if(_0x5b1ba2==='DESCRIBE'){_0xb872ba=_0x2aa762+_0xff84db(0x152);if(_0x17898e){const _0x13c06d=await fetch(_0x17898e),_0x3d9895=await _0x13c06d[_0xff84db(0x134)](),_0x4e8aad=Buffer['from'](await _0x3d9895['arrayBuffer']()),_0x6711f2=_0x4e8aad['toString'](_0xff84db(0x131));_0x354c63={'base64':_0xff84db(0x140)+_0x6711f2};}else return;}else _0x5b1ba2==='PICREADER'?(_0xb872ba=_0x2aa762+_0xff84db(0x14e),_0x354c63={'taskId':_0x3be34c,'customId':_0x2ccf07},_0x4c60da=await axios_1[_0xff84db(0x178)][_0xff84db(0x128)](_0xb872ba,_0x354c63,{'headers':_0xbcaf08}),(_0x4c60da===null||_0x4c60da===void 0x0?void 0x0:_0x4c60da[_0xff84db(0x150)])===0xc8&&((_0x4dc7b1=_0x4c60da===null||_0x4c60da===void 0x0?void 0x0:_0x4c60da[_0xff84db(0x167)])===null||_0x4dc7b1===void 0x0?void 0x0:_0x4dc7b1['result'])&&(_0xb872ba=_0x2aa762+_0xff84db(0x162),_0x354c63={'taskId':(_0x55f7d4=_0x4c60da===null||_0x4c60da===void 0x0?void 0x0:_0x4c60da[_0xff84db(0x167)])===null||_0x55f7d4===void 0x0?void 0x0:_0x55f7d4['result']})):(_0xb872ba=_0x2aa762+_0xff84db(0x14e),_0x354c63={'taskId':_0x3be34c,'customId':_0x2ccf07});}common_1['Logger'][_0xff84db(0x125)]('正在准备发送请求到\x20'+_0xb872ba+_0xff84db(0x153)+JSON[_0xff84db(0x14b)](_0x354c63)+_0xff84db(0x182)+JSON[_0xff84db(0x14b)](_0xbcaf08),_0xff84db(0x12c)),_0x4c60da=await axios_1[_0xff84db(0x178)][_0xff84db(0x128)](_0xb872ba,_0x354c63,{'headers':_0xbcaf08});if((_0x4c60da===null||_0x4c60da===void 0x0?void 0x0:_0x4c60da[_0xff84db(0x150)])===0xc8&&((_0x2959c8=_0x4c60da===null||_0x4c60da===void 0x0?void 0x0:_0x4c60da['data'])===null||_0x2959c8===void 0x0?void 0x0:_0x2959c8[_0xff84db(0x15e)])){common_1[_0xff84db(0x135)]['debug'](_0xff84db(0x171)+JSON[_0xff84db(0x14b)](_0x4c60da['data']),'MidjourneyService'),_0x1f2100[_0xff84db(0x16b)]=(_0x407008=_0x4c60da===null||_0x4c60da===void 0x0?void 0x0:_0x4c60da[_0xff84db(0x167)])===null||_0x407008===void 0x0?void 0x0:_0x407008[_0xff84db(0x15e)],_0x1f2100['state']=0x2,_0x1f2100[_0xff84db(0x17f)]=_0xff84db(0x165),common_1['Logger']['log']('绘画任务提交成功,\x20绘画ID:\x20'+_0x4c60da[_0xff84db(0x167)][_0xff84db(0x15e)],_0xff84db(0x12c));break;}else throw new Error(_0xff84db(0x126));}catch(_0xb281f1){_0x2c7294++,_0x2c7294>=0x3&&(_0x1f2100[_0xff84db(0x17f)]=_0xff84db(0x164),_0x1f2100['status']=0x5,common_1[_0xff84db(0x135)][_0xff84db(0x125)]('绘画任务提交失败,\x20请检查后台配置或者稍后重试!\x20'+_0xb281f1,_0xff84db(0x12c)));}}return this[_0xff84db(0x17c)]({'proxyUrl':_0x2aa762,'apiKey':_0x221612,'drawId':_0x1f2100[_0xff84db(0x16b)],'timeout':_0x33f25c,'prompt':_0x4163e9,'onSuccess':async _0x847308=>{const _0xc3e4e2=_0xff84db;await this['chatLogService'][_0xc3e4e2(0x143)](_0x15d7a7,{'fileInfo':_0x847308===null||_0x847308===void 0x0?void 0x0:_0x847308['fileInfo'],'answer':(_0x847308===null||_0x847308===void 0x0?void 0x0:_0x847308[_0xc3e4e2(0x17f)])||_0x4163e9,'progress':_0xc3e4e2(0x175),'status':0x3,'drawId':_0x847308===null||_0x847308===void 0x0?void 0x0:_0x847308[_0xc3e4e2(0x16b)],'customId':_0x847308===null||_0x847308===void 0x0?void 0x0:_0x847308[_0xc3e4e2(0x129)]}),common_1[_0xc3e4e2(0x135)][_0xc3e4e2(0x125)]('绘图成功！',_0xc3e4e2(0x12c));},'onDrawing':async _0x2ee9bc=>{const _0x3876cc=_0xff84db;await this[_0x3876cc(0x161)][_0x3876cc(0x143)](_0x15d7a7,{'answer':(_0x2ee9bc===null||_0x2ee9bc===void 0x0?void 0x0:_0x2ee9bc['answer'])||_0x3876cc(0x13f),'progress':_0x2ee9bc===null||_0x2ee9bc===void 0x0?void 0x0:_0x2ee9bc['progress'],'status':0x2}),common_1['Logger'][_0x3876cc(0x125)](_0x3876cc(0x166)+(_0x2ee9bc===null||_0x2ee9bc===void 0x0?void 0x0:_0x2ee9bc[_0x3876cc(0x13d)]),'MidjourneyService');},'onFailure':async _0x3e5ba8=>{const _0x74529c=_0xff84db;await this['chatLogService'][_0x74529c(0x143)](_0x15d7a7,{'answer':_0x74529c(0x188),'status':_0x3e5ba8['status']}),common_1[_0x74529c(0x135)][_0x74529c(0x125)](_0x74529c(0x188),'MidjourneyService');}})['catch'](_0x4fa1bb=>{const _0x1dd4d5=_0xff84db;common_1[_0x1dd4d5(0x135)]['error'](_0x1dd4d5(0x185),_0x4fa1bb,_0x1dd4d5(0x12c));}),_0x1f2100;}async[_0x50b790(0x17c)](_0x4e6a55){const _0x232143=_0x50b790,{proxyUrl:_0x156e92,apiKey:_0x305fe9,drawId:_0x6bfa88,timeout:_0x2c8267,onSuccess:_0x172ef5,prompt:_0x2a3f34,onFailure:_0x13f367,onDrawing:_0x252644}=_0x4e6a55,{mjNotSaveImg:_0x14ecef,mjProxyImgUrl:_0x3b3dac,mjNotUseProxy:_0x5e0abe}=await this[_0x232143(0x14f)][_0x232143(0x132)]([_0x232143(0x180),'mjProxyImgUrl',_0x232143(0x139)]);let _0x5148c3={'fileInfo':'','drawId':'','customId':'','status':0x2,'progress':0x0,'answer':''};const _0x432786=Date[_0x232143(0x168)](),_0x5eaa21=0x1388;let _0x182e1e=0x0;try{while(Date[_0x232143(0x168)]()-_0x432786<_0x2c8267){await new Promise(_0x4dc960=>setTimeout(_0x4dc960,_0x5eaa21));try{const _0x117f5a={'Content-Type':'application/x-www-form-urlencoded','mj-api-secret':_0x305fe9},_0x223bac=_0x156e92+_0x232143(0x159)+_0x6bfa88+'/fetch',_0x2d44da=await axios_1['default']['get'](_0x223bac,{'headers':_0x117f5a}),_0x160e27=_0x2d44da[_0x232143(0x167)];common_1[_0x232143(0x135)]['debug'](_0x232143(0x133)+JSON['stringify'](_0x160e27),'MidjourneyService');if(_0x160e27[_0x232143(0x150)]===_0x232143(0x177)){common_1['Logger'][_0x232143(0x125)](_0x232143(0x15a)+_0x160e27[_0x232143(0x123)],_0x232143(0x12c));let _0x32da66=_0x160e27[_0x232143(0x123)];const _0x50aacb=_0x5e0abe==='0'&&_0x3b3dac;let _0x442518='';if(_0x50aacb){const _0x47b226=new URL(_0x3b3dac),_0x38e662=new URL(_0x160e27[_0x232143(0x123)]);_0x38e662[_0x232143(0x124)]=_0x47b226[_0x232143(0x124)],_0x38e662['hostname']=_0x47b226[_0x232143(0x181)],_0x38e662[_0x232143(0x16c)]=_0x47b226['port']?_0x47b226[_0x232143(0x16c)]:'',_0x32da66=_0x38e662[_0x232143(0x17a)](),_0x442518=_0x232143(0x12b)+_0x32da66,common_1[_0x232143(0x135)][_0x232143(0x125)](_0x442518,_0x232143(0x12c));}if(_0x14ecef!=='1'){try{common_1[_0x232143(0x135)]['log'](_0x232143(0x172),_0x232143(0x12c));const _0x1894fd=new Date(),_0x16ae7a=_0x1894fd[_0x232143(0x138)](),_0x1bc874=String(_0x1894fd[_0x232143(0x179)]()+0x1)['padStart'](0x2,'0'),_0x3e1140=String(_0x1894fd[_0x232143(0x15f)]())['padStart'](0x2,'0'),_0xa96796=''+_0x16ae7a+_0x1bc874+'/'+_0x3e1140;_0x32da66=await this['uploadService'][_0x232143(0x15b)]({'url':_0x32da66,'dir':_0x232143(0x12d)+_0xa96796}),_0x442518='上传成功\x20URL:\x20'+_0x32da66;}catch(_0x4608e8){common_1[_0x232143(0x135)]['error'](_0x232143(0x151)),_0x442518='存储图片失败，使用原始/代理图片链接\x20'+_0x32da66;}common_1[_0x232143(0x135)][_0x232143(0x125)](_0x442518,_0x232143(0x12c));}else _0x442518=_0x232143(0x15d)+_0x32da66,common_1['Logger'][_0x232143(0x125)](_0x442518,_0x232143(0x12c));_0x5148c3[_0x232143(0x12e)]=_0x32da66,_0x5148c3[_0x232143(0x16b)]=_0x160e27['id'],_0x5148c3[_0x232143(0x129)]=JSON['stringify'](_0x160e27[_0x232143(0x13a)]),_0x5148c3[_0x232143(0x17f)]=_0x2a3f34+'\x0a'+(_0x160e27[_0x232143(0x12f)]||_0x160e27[_0x232143(0x187)][_0x232143(0x12f)]||''),_0x172ef5(_0x5148c3);return;}_0x5148c3[_0x232143(0x13d)]=_0x160e27===null||_0x160e27===void 0x0?void 0x0:_0x160e27[_0x232143(0x13d)],_0x5148c3[_0x232143(0x17f)]=_0x232143(0x17b)+(_0x160e27===null||_0x160e27===void 0x0?void 0x0:_0x160e27[_0x232143(0x13d)]),_0x5148c3[_0x232143(0x13d)]&&_0x252644(_0x5148c3);}catch(_0x1aa86d){_0x182e1e++,common_1[_0x232143(0x135)]['error'](_0x232143(0x149)+_0x1aa86d,_0x232143(0x12c));}}common_1[_0x232143(0x135)][_0x232143(0x18b)](_0x232143(0x145)+_0x432786/0x3e8+_0x232143(0x157)),_0x5148c3[_0x232143(0x150)]=0x4,_0x13f367(_0x5148c3);throw new common_1[(_0x232143(0x15c))](_0x232143(0x186),common_1[_0x232143(0x174)][_0x232143(0x183)]);}catch(_0x377cd1){common_1[_0x232143(0x135)][_0x232143(0x18b)](_0x232143(0x146)+_0x377cd1+_0x232143(0x156)),_0x5148c3['status']=0x5,_0x13f367(_0x5148c3);}}[_0x50b790(0x137)](_0x2716ec){const _0x2f2113=_0x50b790;return _0x2f2113(0x160);}};MidjourneyService=__decorate([(0x0,common_1[_0x50b790(0x189)])(),__metadata('design:paramtypes',[upload_service_1['UploadService'],globalConfig_service_1['GlobalConfigService'],chatLog_service_1[_0x50b790(0x148)],models_service_1[_0x50b790(0x141)]])],MidjourneyService),exports[_0x50b790(0x12c)]=MidjourneyService;