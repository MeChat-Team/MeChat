'use strict';const _0xed7a7d=_0x5ae5;(function(_0x47eb2b,_0x3806db){const _0x3d60f3=_0x5ae5,_0x40830d=_0x47eb2b();while(!![]){try{const _0x3e551b=-parseInt(_0x3d60f3(0x87))/0x1*(parseInt(_0x3d60f3(0x9e))/0x2)+parseInt(_0x3d60f3(0xa4))/0x3*(parseInt(_0x3d60f3(0x8c))/0x4)+parseInt(_0x3d60f3(0x8a))/0x5+parseInt(_0x3d60f3(0x74))/0x6*(-parseInt(_0x3d60f3(0xc5))/0x7)+-parseInt(_0x3d60f3(0x98))/0x8+-parseInt(_0x3d60f3(0xcc))/0x9*(parseInt(_0x3d60f3(0xa8))/0xa)+-parseInt(_0x3d60f3(0xa7))/0xb*(-parseInt(_0x3d60f3(0xaf))/0xc);if(_0x3e551b===_0x3806db)break;else _0x40830d['push'](_0x40830d['shift']());}catch(_0x2b5f2a){_0x40830d['push'](_0x40830d['shift']());}}}(_0x3b55,0x1c340));var __decorate=this&&this[_0xed7a7d(0xd9)]||function(_0x51e42e,_0x56fc28,_0x425db1,_0x121306){const _0x408df4=_0xed7a7d;var _0xcdcc52=arguments[_0x408df4(0xd0)],_0xe5985c=_0xcdcc52<0x3?_0x56fc28:_0x121306===null?_0x121306=Object[_0x408df4(0xd6)](_0x56fc28,_0x425db1):_0x121306,_0x3eaafd;if(typeof Reflect===_0x408df4(0xa1)&&typeof Reflect['decorate']===_0x408df4(0xdd))_0xe5985c=Reflect['decorate'](_0x51e42e,_0x56fc28,_0x425db1,_0x121306);else{for(var _0x24f323=_0x51e42e[_0x408df4(0xd0)]-0x1;_0x24f323>=0x0;_0x24f323--)if(_0x3eaafd=_0x51e42e[_0x24f323])_0xe5985c=(_0xcdcc52<0x3?_0x3eaafd(_0xe5985c):_0xcdcc52>0x3?_0x3eaafd(_0x56fc28,_0x425db1,_0xe5985c):_0x3eaafd(_0x56fc28,_0x425db1))||_0xe5985c;}return _0xcdcc52>0x3&&_0xe5985c&&Object['defineProperty'](_0x56fc28,_0x425db1,_0xe5985c),_0xe5985c;},__metadata=this&&this[_0xed7a7d(0xab)]||function(_0x1b914c,_0x5542e0){const _0x2c437d=_0xed7a7d;if(typeof Reflect===_0x2c437d(0xa1)&&typeof Reflect['metadata']===_0x2c437d(0xdd))return Reflect[_0x2c437d(0x78)](_0x1b914c,_0x5542e0);};Object[_0xed7a7d(0x99)](exports,_0xed7a7d(0xb8),{'value':!![]}),exports[_0xed7a7d(0x7f)]=void 0x0;function _0x5ae5(_0x578446,_0x19215d){const _0x3b55c3=_0x3b55();return _0x5ae5=function(_0x5ae5be,_0x4b958a){_0x5ae5be=_0x5ae5be-0x72;let _0x29f665=_0x3b55c3[_0x5ae5be];return _0x29f665;},_0x5ae5(_0x578446,_0x19215d);}function _0x3b55(){const _0x11cc6e=['state','428229sXxEIm','../globalConfig/globalConfig.service','uploadFileFromUrl','axios','length','data:image/png;base64,','getModelConfigByName','midjourneyDraw','progress','@nestjs/common','getOwnPropertyDescriptor','绘画任务提交失败,\x20请检查后台配置或者稍后重试!\x20','answer','__decorate','../models/models.service','getMonth','未能获取结果数据,\x20即将重试','function','UploadService','arrayBuffer','Logger','/fetch','modelsService','log','20268dkfQNV','ModelsService','查询绘图结果时发生错误:','getConfigs','metadata','properties','stringify','port','绘画超时，请稍后再试！','绘制中！绘制进度','/mj/submit/imagine','MidjourneyService','toString','hostname','超过\x20','/mj/submit/action','上传成功\x20URL:\x20','error','使用代理替换后的\x20URL:\x20','1571wkMKeD','debug','收到响应:\x20','1075025NgXZpT','fileInfo','4XrwDJr','application/x-www-form-urlencoded','GlobalConfigService','\x20s\x20未完成绘画,\x20请稍后再试!\x20MidjourneyService','/mj/task/','status','blob','绘图失败','HttpStatus','存储图片失败，使用原始/代理图片链接\x20','pollMjDrawingResult','data','1217376lIsdtS','defineProperty','../chatLog/chatLog.service','查询结果:\x20','绘制成功,\x20获取到的URL:\x20','post','46bJXeUv','chatLogService','/mj/submit/modal','object','mjProxyImgUrl','\x20MidjourneyService','106338fjCCTm','正在准备发送请求到\x20','getFullYear','55JqFreu','30fujwuv','轮询过程中发生错误:\x20','catch','__metadata','now','IMAGINE','mjNotUseProxy','600396iXeZvi','PICREADER','updateChatLog','protocol','imageUrl','drawId','customId','uploadService','get','__esModule','finalPrompt','HttpException','getMidjourneyModelByPlugin','SUCCESS','任务提交失败，请检查提示词后重试','绘画任务提交成功,\x20绘画ID:\x20','padStart','default','mjNotSaveImg','result','from','BAD_REQUEST','112wGrFMS','绘图成功！','Injectable','globalConfigService','当前绘制进度\x20','midjourney'];_0x3b55=function(){return _0x11cc6e;};return _0x3b55();}const common_1=require(_0xed7a7d(0xd5)),axios_1=require(_0xed7a7d(0xcf)),chatLog_service_1=require(_0xed7a7d(0x9a)),globalConfig_service_1=require(_0xed7a7d(0xcd)),upload_service_1=require('../upload/upload.service'),models_service_1=require(_0xed7a7d(0xda));let MidjourneyService=class MidjourneyService{constructor(_0x338a4c,_0x2bcc19,_0x9f96aa,_0x3bd618){const _0x10226f=_0xed7a7d;this[_0x10226f(0xb6)]=_0x338a4c,this['globalConfigService']=_0x2bcc19,this[_0x10226f(0x9f)]=_0x9f96aa,this['modelsService']=_0x3bd618;}async[_0xed7a7d(0xd3)](_0x1821ec){const _0x42d108=_0xed7a7d;var _0x30d103,_0x435a54,_0x4e9010,_0x33ed8d;const {id:_0x4fc5af,apiKey:_0x10502b,proxyUrl:_0x41af15,action:_0x3a9702,drawId:_0x2e021e,prompt:_0x33f482,usePrompt:_0x181efb,customId:_0x485f36,timeout:_0x4b1b48,fileInfo:_0x615494,assistantLogId:_0x55793b,pluginName:_0x408908}=_0x1821ec;let _0x4b7451={'text':'','fileInfo':'','drawId':'','customId':'','status':0x2};const _0x478a4b=this[_0x42d108(0xbb)](_0x408908),_0x177893=await this[_0x42d108(0x72)][_0x42d108(0xd2)](_0x478a4b),_0x454091=(_0x177893===null||_0x177893===void 0x0?void 0x0:_0x177893['key'])||_0x10502b;let _0x8eb73b,_0x113d0a=0x0,_0x1cad03='';const _0x3b92e0={'mj-api-secret':_0x454091};common_1['Logger'][_0x42d108(0x88)]('当前任务类型:\x20'+_0x3a9702,_0x42d108(0x7f));while(_0x113d0a<0x3){let _0x1f1172={};try{if(_0x3a9702===_0x42d108(0xad))_0x1cad03=_0x41af15+_0x42d108(0x7e),_0x1f1172={'prompt':_0x181efb};else{if(_0x3a9702==='DESCRIBE'){_0x1cad03=_0x41af15+'/mj/submit/describe';if(_0x615494){const _0x142a1a=await fetch(_0x615494),_0x6b22fb=await _0x142a1a[_0x42d108(0x92)](),_0x57b656=Buffer[_0x42d108(0xc3)](await _0x6b22fb[_0x42d108(0xdf)]()),_0x30b682=_0x57b656[_0x42d108(0x80)]('base64');_0x1f1172={'base64':_0x42d108(0xd1)+_0x30b682};}else return;}else _0x3a9702===_0x42d108(0xb0)?(_0x1cad03=_0x41af15+_0x42d108(0x83),_0x1f1172={'taskId':_0x2e021e,'customId':_0x485f36},_0x8eb73b=await axios_1[_0x42d108(0xc0)][_0x42d108(0x9d)](_0x1cad03,_0x1f1172,{'headers':_0x3b92e0}),(_0x8eb73b===null||_0x8eb73b===void 0x0?void 0x0:_0x8eb73b['status'])===0xc8&&((_0x30d103=_0x8eb73b===null||_0x8eb73b===void 0x0?void 0x0:_0x8eb73b[_0x42d108(0x97)])===null||_0x30d103===void 0x0?void 0x0:_0x30d103[_0x42d108(0xc2)])&&(_0x1cad03=_0x41af15+_0x42d108(0xa0),_0x1f1172={'taskId':(_0x435a54=_0x8eb73b===null||_0x8eb73b===void 0x0?void 0x0:_0x8eb73b[_0x42d108(0x97)])===null||_0x435a54===void 0x0?void 0x0:_0x435a54[_0x42d108(0xc2)]})):(_0x1cad03=_0x41af15+'/mj/submit/action',_0x1f1172={'taskId':_0x2e021e,'customId':_0x485f36});}common_1[_0x42d108(0xe0)][_0x42d108(0x73)](_0x42d108(0xa5)+_0x1cad03+'，payload:\x20'+JSON['stringify'](_0x1f1172)+',\x20headers:\x20'+JSON['stringify'](_0x3b92e0),'MidjourneyService'),_0x8eb73b=await axios_1[_0x42d108(0xc0)][_0x42d108(0x9d)](_0x1cad03,_0x1f1172,{'headers':_0x3b92e0});if((_0x8eb73b===null||_0x8eb73b===void 0x0?void 0x0:_0x8eb73b[_0x42d108(0x91)])===0xc8&&((_0x4e9010=_0x8eb73b===null||_0x8eb73b===void 0x0?void 0x0:_0x8eb73b[_0x42d108(0x97)])===null||_0x4e9010===void 0x0?void 0x0:_0x4e9010[_0x42d108(0xc2)])){common_1['Logger']['debug'](_0x42d108(0x89)+JSON[_0x42d108(0x7a)](_0x8eb73b['data']),'MidjourneyService'),_0x4b7451['drawId']=(_0x33ed8d=_0x8eb73b===null||_0x8eb73b===void 0x0?void 0x0:_0x8eb73b[_0x42d108(0x97)])===null||_0x33ed8d===void 0x0?void 0x0:_0x33ed8d[_0x42d108(0xc2)],_0x4b7451[_0x42d108(0xcb)]=0x2,_0x4b7451[_0x42d108(0xd8)]='绘画任务提交成功',common_1[_0x42d108(0xe0)][_0x42d108(0x73)](_0x42d108(0xbe)+_0x8eb73b[_0x42d108(0x97)][_0x42d108(0xc2)],_0x42d108(0x7f));break;}else throw new Error(_0x42d108(0xdc));}catch(_0x3b7cfe){_0x113d0a++,_0x113d0a>=0x3&&(_0x4b7451[_0x42d108(0xd8)]=_0x42d108(0xbd),_0x4b7451[_0x42d108(0x91)]=0x5,common_1[_0x42d108(0xe0)]['log'](_0x42d108(0xd7)+_0x3b7cfe,_0x42d108(0x7f)));}}return this[_0x42d108(0x96)]({'proxyUrl':_0x41af15,'apiKey':_0x454091,'drawId':_0x4b7451[_0x42d108(0xb4)],'timeout':_0x4b1b48,'prompt':_0x33f482,'onSuccess':async _0x14ab9f=>{const _0x17fc9a=_0x42d108;await this[_0x17fc9a(0x9f)][_0x17fc9a(0xb1)](_0x55793b,{'fileInfo':_0x14ab9f===null||_0x14ab9f===void 0x0?void 0x0:_0x14ab9f[_0x17fc9a(0x8b)],'answer':(_0x14ab9f===null||_0x14ab9f===void 0x0?void 0x0:_0x14ab9f[_0x17fc9a(0xd8)])||_0x33f482,'progress':'100%','status':0x3,'drawId':_0x14ab9f===null||_0x14ab9f===void 0x0?void 0x0:_0x14ab9f[_0x17fc9a(0xb4)],'customId':_0x14ab9f===null||_0x14ab9f===void 0x0?void 0x0:_0x14ab9f[_0x17fc9a(0xb5)]}),common_1[_0x17fc9a(0xe0)][_0x17fc9a(0x73)](_0x17fc9a(0xc6),'MidjourneyService');},'onDrawing':async _0x5956fc=>{const _0xd83c31=_0x42d108;await this['chatLogService'][_0xd83c31(0xb1)](_0x55793b,{'answer':(_0x5956fc===null||_0x5956fc===void 0x0?void 0x0:_0x5956fc[_0xd83c31(0xd8)])||'绘制中','progress':_0x5956fc===null||_0x5956fc===void 0x0?void 0x0:_0x5956fc[_0xd83c31(0xd4)],'status':0x2}),common_1[_0xd83c31(0xe0)][_0xd83c31(0x73)](_0xd83c31(0x7d)+(_0x5956fc===null||_0x5956fc===void 0x0?void 0x0:_0x5956fc[_0xd83c31(0xd4)]),_0xd83c31(0x7f));},'onFailure':async _0x180f65=>{const _0x4c9039=_0x42d108;await this[_0x4c9039(0x9f)]['updateChatLog'](_0x55793b,{'answer':'绘图失败','status':_0x180f65[_0x4c9039(0x91)]}),common_1[_0x4c9039(0xe0)][_0x4c9039(0x73)](_0x4c9039(0x93),_0x4c9039(0x7f));}})[_0x42d108(0xaa)](_0x216181=>{const _0x430e22=_0x42d108;common_1[_0x430e22(0xe0)][_0x430e22(0x85)](_0x430e22(0x76),_0x216181,_0x430e22(0x7f));}),_0x4b7451;}async[_0xed7a7d(0x96)](_0x266e7d){const _0x2b6781=_0xed7a7d,{proxyUrl:_0x11e30d,apiKey:_0x3a9b06,drawId:_0x26707c,timeout:_0x8efa73,onSuccess:_0x455a78,prompt:_0x1ebd70,onFailure:_0x3da46b,onDrawing:_0x2bbd19}=_0x266e7d,{mjNotSaveImg:_0x6d8341,mjProxyImgUrl:_0x56fd4c,mjNotUseProxy:_0x424824}=await this[_0x2b6781(0xc8)][_0x2b6781(0x77)]([_0x2b6781(0xc1),_0x2b6781(0xa2),_0x2b6781(0xae)]);let _0x3b9868={'fileInfo':'','drawId':'','customId':'','status':0x2,'progress':0x0,'answer':''};const _0x30dcf3=Date[_0x2b6781(0xac)](),_0x2e0152=0x1388;let _0x328b81=0x0;try{while(Date[_0x2b6781(0xac)]()-_0x30dcf3<_0x8efa73){await new Promise(_0x14c2e9=>setTimeout(_0x14c2e9,_0x2e0152));try{const _0x2acec0={'Content-Type':_0x2b6781(0x8d),'mj-api-secret':_0x3a9b06},_0x3381c9=_0x11e30d+_0x2b6781(0x90)+_0x26707c+_0x2b6781(0xe1),_0x5d6bd0=await axios_1['default'][_0x2b6781(0xb7)](_0x3381c9,{'headers':_0x2acec0}),_0xcb9eab=_0x5d6bd0[_0x2b6781(0x97)];common_1[_0x2b6781(0xe0)]['debug'](_0x2b6781(0x9b)+JSON[_0x2b6781(0x7a)](_0xcb9eab),_0x2b6781(0x7f));if(_0xcb9eab[_0x2b6781(0x91)]===_0x2b6781(0xbc)){common_1[_0x2b6781(0xe0)][_0x2b6781(0x73)](_0x2b6781(0x9c)+_0xcb9eab[_0x2b6781(0xb3)],'MidjourneyService');let _0xd9c33d=_0xcb9eab[_0x2b6781(0xb3)];const _0x32341c=_0x424824==='0'&&_0x56fd4c;let _0x4bcc16='';if(_0x32341c){const _0x4b6f8d=new URL(_0x56fd4c),_0xf59184=new URL(_0xcb9eab[_0x2b6781(0xb3)]);_0xf59184[_0x2b6781(0xb2)]=_0x4b6f8d[_0x2b6781(0xb2)],_0xf59184[_0x2b6781(0x81)]=_0x4b6f8d['hostname'],_0xf59184[_0x2b6781(0x7b)]=_0x4b6f8d['port']?_0x4b6f8d[_0x2b6781(0x7b)]:'',_0xd9c33d=_0xf59184['toString'](),_0x4bcc16=_0x2b6781(0x86)+_0xd9c33d,common_1[_0x2b6781(0xe0)][_0x2b6781(0x73)](_0x4bcc16,_0x2b6781(0x7f));}if(_0x6d8341!=='1'){try{common_1[_0x2b6781(0xe0)][_0x2b6781(0x73)]('------>\x20开始上传图片！！！',_0x2b6781(0x7f));const _0x379e53=new Date(),_0x59575f=_0x379e53[_0x2b6781(0xa6)](),_0x290297=String(_0x379e53[_0x2b6781(0xdb)]()+0x1)[_0x2b6781(0xbf)](0x2,'0'),_0x2345ba=String(_0x379e53['getDate']())[_0x2b6781(0xbf)](0x2,'0'),_0x5d639c=''+_0x59575f+_0x290297+'/'+_0x2345ba;_0xd9c33d=await this[_0x2b6781(0xb6)][_0x2b6781(0xce)]({'url':_0xd9c33d,'dir':'images/midjourney/'+_0x5d639c}),_0x4bcc16=_0x2b6781(0x84)+_0xd9c33d;}catch(_0xb4f8bf){common_1[_0x2b6781(0xe0)][_0x2b6781(0x85)]('存储图片失败，使用原始/代理图片链接'),_0x4bcc16=_0x2b6781(0x95)+_0xd9c33d;}common_1['Logger'][_0x2b6781(0x73)](_0x4bcc16,'MidjourneyService');}else _0x4bcc16='不保存图片，使用\x20URL:\x20'+_0xd9c33d,common_1['Logger'][_0x2b6781(0x73)](_0x4bcc16,_0x2b6781(0x7f));_0x3b9868[_0x2b6781(0x8b)]=_0xd9c33d,_0x3b9868['drawId']=_0xcb9eab['id'],_0x3b9868[_0x2b6781(0xb5)]=JSON[_0x2b6781(0x7a)](_0xcb9eab['buttons']),_0x3b9868[_0x2b6781(0xd8)]=_0x1ebd70+'\x0a'+(_0xcb9eab[_0x2b6781(0xb9)]||_0xcb9eab[_0x2b6781(0x79)][_0x2b6781(0xb9)]||''),_0x455a78(_0x3b9868);return;}_0x3b9868[_0x2b6781(0xd4)]=_0xcb9eab===null||_0xcb9eab===void 0x0?void 0x0:_0xcb9eab[_0x2b6781(0xd4)],_0x3b9868[_0x2b6781(0xd8)]=_0x2b6781(0xc9)+(_0xcb9eab===null||_0xcb9eab===void 0x0?void 0x0:_0xcb9eab[_0x2b6781(0xd4)]),_0x3b9868[_0x2b6781(0xd4)]&&_0x2bbd19(_0x3b9868);}catch(_0x357702){_0x328b81++,common_1[_0x2b6781(0xe0)][_0x2b6781(0x85)](_0x2b6781(0xa9)+_0x357702,_0x2b6781(0x7f));}}common_1[_0x2b6781(0xe0)][_0x2b6781(0x85)](_0x2b6781(0x82)+_0x30dcf3/0x3e8+_0x2b6781(0x8f)),_0x3b9868[_0x2b6781(0x91)]=0x4,_0x3da46b(_0x3b9868);throw new common_1[(_0x2b6781(0xba))](_0x2b6781(0x7c),common_1[_0x2b6781(0x94)][_0x2b6781(0xc4)]);}catch(_0x1318d1){common_1[_0x2b6781(0xe0)][_0x2b6781(0x85)]('绘画失败:\x20'+_0x1318d1+_0x2b6781(0xa3)),_0x3b9868['status']=0x5,_0x3da46b(_0x3b9868);}}['getMidjourneyModelByPlugin'](_0xbe4b9e){const _0x2604da=_0xed7a7d;return _0x2604da(0xca);}};MidjourneyService=__decorate([(0x0,common_1[_0xed7a7d(0xc7)])(),__metadata('design:paramtypes',[upload_service_1[_0xed7a7d(0xde)],globalConfig_service_1[_0xed7a7d(0x8e)],chatLog_service_1['ChatLogService'],models_service_1[_0xed7a7d(0x75)]])],MidjourneyService),exports[_0xed7a7d(0x7f)]=MidjourneyService;