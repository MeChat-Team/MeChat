'use strict';const _0x246c28=_0xd61c;(function(_0x54a247,_0x3e682d){const _0x289590=_0xd61c,_0x3e681c=_0x54a247();while(!![]){try{const _0x13cd35=parseInt(_0x289590(0x209))/0x1*(-parseInt(_0x289590(0x206))/0x2)+parseInt(_0x289590(0x1c5))/0x3*(parseInt(_0x289590(0x1b1))/0x4)+parseInt(_0x289590(0x1cd))/0x5+parseInt(_0x289590(0x214))/0x6+parseInt(_0x289590(0x1bd))/0x7+parseInt(_0x289590(0x1e7))/0x8*(parseInt(_0x289590(0x1af))/0x9)+-parseInt(_0x289590(0x1ab))/0xa*(parseInt(_0x289590(0x1c9))/0xb);if(_0x13cd35===_0x3e682d)break;else _0x3e681c['push'](_0x3e681c['shift']());}catch(_0x16c6b9){_0x3e681c['push'](_0x3e681c['shift']());}}}(_0x40ed,0x92b2a));function _0x40ed(){const _0x26d0f0=['decorate','uploadService','../chatLog/chatLog.service','查询绘图结果时发生错误:','UploadService','getDate','updateChatLog','\x20MidjourneyService','catch','padStart','getModelConfigByName','application/x-www-form-urlencoded','DESCRIBE','25234nuoRVu','ChatLogService','progress','64JOKvpN','status','mjNotSaveImg','/mj/submit/modal','Logger','design:paramtypes','object','result','SUCCESS','/mj/task/','midjourneyDraw','7140252HBFVAP','pollMjDrawingResult',',\x20headers:\x20','Injectable','arrayBuffer','任务提交失败，请检查提示词后重试','function','40LVnGUe','port','now','answer','2628NdgpKi','error','16KBcxny','/fetch','\x20s\x20未完成绘画,\x20请稍后再试!\x20MidjourneyService','当前绘制进度\x20','key','------>\x20开始上传图片！！！','stringify','modelsService','fileInfo','HttpStatus','查询结果:\x20','globalConfigService','2589356aqFsRO','绘画任务提交成功','metadata','@nestjs/common','axios','绘图失败','toString','使用代理替换后的\x20URL:\x20','224877RsqYxV','未能获取结果数据,\x20即将重试','getConfigs','绘制中！绘制进度','4665551VKMhVM','绘制中','data','mjProxyImgUrl','901080NZzHig','MidjourneyService','base64','../globalConfig/globalConfig.service','__esModule','ModelsService','../models/models.service','log','images/midjourney/','buttons','finalPrompt','存储图片失败，使用原始/代理图片链接','getMonth','绘制成功,\x20获取到的URL:\x20','绘画超时，请稍后再试！','__decorate','hostname','当前任务类型:\x20','../upload/upload.service','绘画任务提交失败,\x20请检查后台配置或者稍后重试!\x20','drawId','BAD_REQUEST','存储图片失败，使用原始/代理图片链接\x20','/mj/submit/action','blob','protocol','29176CPCKUz','mjNotUseProxy','正在准备发送请求到\x20','length','state','getMidjourneyModelByPlugin','properties','，payload:\x20','上传成功\x20URL:\x20','post','IMAGINE','customId','debug','chatLogService','imageUrl','defineProperty','PICREADER','绘画任务提交成功,\x20绘画ID:\x20'];_0x40ed=function(){return _0x26d0f0;};return _0x40ed();}function _0xd61c(_0x367706,_0x11949b){const _0x40ed99=_0x40ed();return _0xd61c=function(_0xd61c9f,_0x4abc22){_0xd61c9f=_0xd61c9f-0x1a6;let _0x2cdf47=_0x40ed99[_0xd61c9f];return _0x2cdf47;},_0xd61c(_0x367706,_0x11949b);}var __decorate=this&&this[_0x246c28(0x1dc)]||function(_0x36538b,_0x3cf2ba,_0x38f21f,_0x3b72c5){const _0x9418e4=_0x246c28;var _0x19177e=arguments[_0x9418e4(0x1ea)],_0x1cf637=_0x19177e<0x3?_0x3cf2ba:_0x3b72c5===null?_0x3b72c5=Object['getOwnPropertyDescriptor'](_0x3cf2ba,_0x38f21f):_0x3b72c5,_0x3cdd20;if(typeof Reflect===_0x9418e4(0x20f)&&typeof Reflect[_0x9418e4(0x1f9)]===_0x9418e4(0x1aa))_0x1cf637=Reflect[_0x9418e4(0x1f9)](_0x36538b,_0x3cf2ba,_0x38f21f,_0x3b72c5);else{for(var _0x317c5f=_0x36538b['length']-0x1;_0x317c5f>=0x0;_0x317c5f--)if(_0x3cdd20=_0x36538b[_0x317c5f])_0x1cf637=(_0x19177e<0x3?_0x3cdd20(_0x1cf637):_0x19177e>0x3?_0x3cdd20(_0x3cf2ba,_0x38f21f,_0x1cf637):_0x3cdd20(_0x3cf2ba,_0x38f21f))||_0x1cf637;}return _0x19177e>0x3&&_0x1cf637&&Object[_0x9418e4(0x1f6)](_0x3cf2ba,_0x38f21f,_0x1cf637),_0x1cf637;},__metadata=this&&this['__metadata']||function(_0x39481a,_0x2fb559){const _0x3408a2=_0x246c28;if(typeof Reflect===_0x3408a2(0x20f)&&typeof Reflect[_0x3408a2(0x1bf)]===_0x3408a2(0x1aa))return Reflect[_0x3408a2(0x1bf)](_0x39481a,_0x2fb559);};Object[_0x246c28(0x1f6)](exports,_0x246c28(0x1d1),{'value':!![]}),exports[_0x246c28(0x1ce)]=void 0x0;const common_1=require(_0x246c28(0x1c0)),axios_1=require(_0x246c28(0x1c1)),chatLog_service_1=require(_0x246c28(0x1fb)),globalConfig_service_1=require(_0x246c28(0x1d0)),upload_service_1=require(_0x246c28(0x1df)),models_service_1=require(_0x246c28(0x1d3));let MidjourneyService=class MidjourneyService{constructor(_0x5bc758,_0x558df0,_0xd6268e,_0x35196f){const _0x547686=_0x246c28;this[_0x547686(0x1fa)]=_0x5bc758,this[_0x547686(0x1bc)]=_0x558df0,this['chatLogService']=_0xd6268e,this[_0x547686(0x1b8)]=_0x35196f;}async[_0x246c28(0x213)](_0xf8dba3){const _0x183910=_0x246c28;var _0x3d8c11,_0xac1ed0,_0x54bad7,_0x1f43a9;const {id:_0x214e8f,apiKey:_0x1bb9fe,proxyUrl:_0x4b17ce,action:_0x5f46c9,drawId:_0x4eb721,prompt:_0x3b7241,usePrompt:_0xf0b1df,customId:_0x1eebba,timeout:_0x25e95a,fileInfo:_0x4a24e5,assistantLogId:_0x4c87e9,pluginName:_0x1f45cb}=_0xf8dba3;let _0x2c1a64={'text':'','fileInfo':'','drawId':'','customId':'','status':0x2};const _0x15bfdd=this['getMidjourneyModelByPlugin'](_0x1f45cb),_0x14ff1c=await this[_0x183910(0x1b8)][_0x183910(0x203)](_0x15bfdd),_0x1be2b2=(_0x14ff1c===null||_0x14ff1c===void 0x0?void 0x0:_0x14ff1c[_0x183910(0x1b5)])||_0x1bb9fe;let _0x4eae66,_0x40eb5e=0x0,_0x1c4c92='';const _0x5cfd06={'mj-api-secret':_0x1be2b2};common_1[_0x183910(0x20d)][_0x183910(0x1f3)](_0x183910(0x1de)+_0x5f46c9,_0x183910(0x1ce));while(_0x40eb5e<0x3){let _0x206e00={};try{if(_0x5f46c9===_0x183910(0x1f1))_0x1c4c92=_0x4b17ce+'/mj/submit/imagine',_0x206e00={'prompt':_0xf0b1df};else{if(_0x5f46c9===_0x183910(0x205)){_0x1c4c92=_0x4b17ce+'/mj/submit/describe';if(_0x4a24e5){const _0x3bfecc=await fetch(_0x4a24e5),_0x4ea883=await _0x3bfecc[_0x183910(0x1e5)](),_0xdc6200=Buffer['from'](await _0x4ea883[_0x183910(0x1a8)]()),_0x29fb85=_0xdc6200[_0x183910(0x1c3)](_0x183910(0x1cf));_0x206e00={'base64':'data:image/png;base64,'+_0x29fb85};}else return;}else _0x5f46c9===_0x183910(0x1f7)?(_0x1c4c92=_0x4b17ce+_0x183910(0x1e4),_0x206e00={'taskId':_0x4eb721,'customId':_0x1eebba},_0x4eae66=await axios_1['default'][_0x183910(0x1f0)](_0x1c4c92,_0x206e00,{'headers':_0x5cfd06}),(_0x4eae66===null||_0x4eae66===void 0x0?void 0x0:_0x4eae66['status'])===0xc8&&((_0x3d8c11=_0x4eae66===null||_0x4eae66===void 0x0?void 0x0:_0x4eae66[_0x183910(0x1cb)])===null||_0x3d8c11===void 0x0?void 0x0:_0x3d8c11[_0x183910(0x210)])&&(_0x1c4c92=_0x4b17ce+_0x183910(0x20c),_0x206e00={'taskId':(_0xac1ed0=_0x4eae66===null||_0x4eae66===void 0x0?void 0x0:_0x4eae66[_0x183910(0x1cb)])===null||_0xac1ed0===void 0x0?void 0x0:_0xac1ed0[_0x183910(0x210)]})):(_0x1c4c92=_0x4b17ce+_0x183910(0x1e4),_0x206e00={'taskId':_0x4eb721,'customId':_0x1eebba});}common_1[_0x183910(0x20d)][_0x183910(0x1d4)](_0x183910(0x1e9)+_0x1c4c92+_0x183910(0x1ee)+JSON[_0x183910(0x1b7)](_0x206e00)+_0x183910(0x1a6)+JSON['stringify'](_0x5cfd06),'MidjourneyService'),_0x4eae66=await axios_1['default'][_0x183910(0x1f0)](_0x1c4c92,_0x206e00,{'headers':_0x5cfd06});if((_0x4eae66===null||_0x4eae66===void 0x0?void 0x0:_0x4eae66[_0x183910(0x20a)])===0xc8&&((_0x54bad7=_0x4eae66===null||_0x4eae66===void 0x0?void 0x0:_0x4eae66[_0x183910(0x1cb)])===null||_0x54bad7===void 0x0?void 0x0:_0x54bad7[_0x183910(0x210)])){common_1[_0x183910(0x20d)][_0x183910(0x1f3)]('收到响应:\x20'+JSON['stringify'](_0x4eae66[_0x183910(0x1cb)]),_0x183910(0x1ce)),_0x2c1a64[_0x183910(0x1e1)]=(_0x1f43a9=_0x4eae66===null||_0x4eae66===void 0x0?void 0x0:_0x4eae66[_0x183910(0x1cb)])===null||_0x1f43a9===void 0x0?void 0x0:_0x1f43a9[_0x183910(0x210)],_0x2c1a64[_0x183910(0x1eb)]=0x2,_0x2c1a64[_0x183910(0x1ae)]=_0x183910(0x1be),common_1[_0x183910(0x20d)][_0x183910(0x1d4)](_0x183910(0x1f8)+_0x4eae66[_0x183910(0x1cb)][_0x183910(0x210)],_0x183910(0x1ce));break;}else throw new Error(_0x183910(0x1c6));}catch(_0x2a1f67){_0x40eb5e++,_0x40eb5e>=0x3&&(_0x2c1a64[_0x183910(0x1ae)]=_0x183910(0x1a9),_0x2c1a64[_0x183910(0x20a)]=0x5,common_1[_0x183910(0x20d)][_0x183910(0x1d4)](_0x183910(0x1e0)+_0x2a1f67,_0x183910(0x1ce)));}}return this[_0x183910(0x215)]({'proxyUrl':_0x4b17ce,'apiKey':_0x1be2b2,'drawId':_0x2c1a64[_0x183910(0x1e1)],'timeout':_0x25e95a,'prompt':_0x3b7241,'onSuccess':async _0x1b5a3c=>{const _0xd69c0a=_0x183910;await this[_0xd69c0a(0x1f4)][_0xd69c0a(0x1ff)](_0x4c87e9,{'fileInfo':_0x1b5a3c===null||_0x1b5a3c===void 0x0?void 0x0:_0x1b5a3c[_0xd69c0a(0x1b9)],'answer':(_0x1b5a3c===null||_0x1b5a3c===void 0x0?void 0x0:_0x1b5a3c['answer'])||_0x3b7241,'progress':'100%','status':0x3,'drawId':_0x1b5a3c===null||_0x1b5a3c===void 0x0?void 0x0:_0x1b5a3c[_0xd69c0a(0x1e1)],'customId':_0x1b5a3c===null||_0x1b5a3c===void 0x0?void 0x0:_0x1b5a3c[_0xd69c0a(0x1f2)]}),common_1['Logger'][_0xd69c0a(0x1d4)]('绘图成功！','MidjourneyService');},'onDrawing':async _0x11009f=>{const _0x5424dc=_0x183910;await this[_0x5424dc(0x1f4)]['updateChatLog'](_0x4c87e9,{'answer':(_0x11009f===null||_0x11009f===void 0x0?void 0x0:_0x11009f[_0x5424dc(0x1ae)])||_0x5424dc(0x1ca),'progress':_0x11009f===null||_0x11009f===void 0x0?void 0x0:_0x11009f[_0x5424dc(0x208)],'status':0x2}),common_1[_0x5424dc(0x20d)][_0x5424dc(0x1d4)](_0x5424dc(0x1c8)+(_0x11009f===null||_0x11009f===void 0x0?void 0x0:_0x11009f['progress']),_0x5424dc(0x1ce));},'onFailure':async _0x43cbe6=>{const _0x303132=_0x183910;await this[_0x303132(0x1f4)][_0x303132(0x1ff)](_0x4c87e9,{'answer':_0x303132(0x1c2),'status':_0x43cbe6[_0x303132(0x20a)]}),common_1[_0x303132(0x20d)]['log'](_0x303132(0x1c2),'MidjourneyService');}})[_0x183910(0x201)](_0x3eee2d=>{const _0x591fe6=_0x183910;common_1[_0x591fe6(0x20d)][_0x591fe6(0x1b0)](_0x591fe6(0x1fc),_0x3eee2d,_0x591fe6(0x1ce));}),_0x2c1a64;}async[_0x246c28(0x215)](_0x2951d1){const _0x1a1f07=_0x246c28,{proxyUrl:_0x2e7065,apiKey:_0x1c794a,drawId:_0x44114e,timeout:_0x11f070,onSuccess:_0x9f744d,prompt:_0x49af35,onFailure:_0x319c47,onDrawing:_0x4388e6}=_0x2951d1,{mjNotSaveImg:_0x2f3707,mjProxyImgUrl:_0xab5a8c,mjNotUseProxy:_0x58e07d}=await this[_0x1a1f07(0x1bc)][_0x1a1f07(0x1c7)]([_0x1a1f07(0x20b),_0x1a1f07(0x1cc),_0x1a1f07(0x1e8)]);let _0x10cdb2={'fileInfo':'','drawId':'','customId':'','status':0x2,'progress':0x0,'answer':''};const _0x2cf86d=Date[_0x1a1f07(0x1ad)](),_0x560d07=0x1388;let _0x5052fb=0x0;try{while(Date[_0x1a1f07(0x1ad)]()-_0x2cf86d<_0x11f070){await new Promise(_0x4839e3=>setTimeout(_0x4839e3,_0x560d07));try{const _0x2742f1={'Content-Type':_0x1a1f07(0x204),'mj-api-secret':_0x1c794a},_0x3da2b0=_0x2e7065+_0x1a1f07(0x212)+_0x44114e+_0x1a1f07(0x1b2),_0x60e845=await axios_1['default']['get'](_0x3da2b0,{'headers':_0x2742f1}),_0x112194=_0x60e845[_0x1a1f07(0x1cb)];common_1[_0x1a1f07(0x20d)][_0x1a1f07(0x1f3)](_0x1a1f07(0x1bb)+JSON['stringify'](_0x112194),_0x1a1f07(0x1ce));if(_0x112194[_0x1a1f07(0x20a)]===_0x1a1f07(0x211)){common_1[_0x1a1f07(0x20d)][_0x1a1f07(0x1d4)](_0x1a1f07(0x1da)+_0x112194[_0x1a1f07(0x1f5)],_0x1a1f07(0x1ce));let _0x455eef=_0x112194[_0x1a1f07(0x1f5)];const _0x4babdc=_0x58e07d==='0'&&_0xab5a8c;let _0x25ed6f='';if(_0x4babdc){const _0x5ec386=new URL(_0xab5a8c),_0x43821e=new URL(_0x112194[_0x1a1f07(0x1f5)]);_0x43821e[_0x1a1f07(0x1e6)]=_0x5ec386[_0x1a1f07(0x1e6)],_0x43821e['hostname']=_0x5ec386[_0x1a1f07(0x1dd)],_0x43821e[_0x1a1f07(0x1ac)]=_0x5ec386[_0x1a1f07(0x1ac)]?_0x5ec386[_0x1a1f07(0x1ac)]:'',_0x455eef=_0x43821e[_0x1a1f07(0x1c3)](),_0x25ed6f=_0x1a1f07(0x1c4)+_0x455eef,common_1[_0x1a1f07(0x20d)][_0x1a1f07(0x1d4)](_0x25ed6f,'MidjourneyService');}if(_0x2f3707!=='1'){try{common_1[_0x1a1f07(0x20d)][_0x1a1f07(0x1d4)](_0x1a1f07(0x1b6),'MidjourneyService');const _0x88f93a=new Date(),_0x1e092a=_0x88f93a['getFullYear'](),_0x42b22b=String(_0x88f93a[_0x1a1f07(0x1d9)]()+0x1)['padStart'](0x2,'0'),_0x51ac41=String(_0x88f93a[_0x1a1f07(0x1fe)]())[_0x1a1f07(0x202)](0x2,'0'),_0x3d6164=''+_0x1e092a+_0x42b22b+'/'+_0x51ac41;_0x455eef=await this[_0x1a1f07(0x1fa)]['uploadFileFromUrl']({'url':_0x455eef,'dir':_0x1a1f07(0x1d5)+_0x3d6164}),_0x25ed6f=_0x1a1f07(0x1ef)+_0x455eef;}catch(_0x44e7fc){common_1['Logger'][_0x1a1f07(0x1b0)](_0x1a1f07(0x1d8)),_0x25ed6f=_0x1a1f07(0x1e3)+_0x455eef;}common_1[_0x1a1f07(0x20d)][_0x1a1f07(0x1d4)](_0x25ed6f,'MidjourneyService');}else _0x25ed6f='不保存图片，使用\x20URL:\x20'+_0x455eef,common_1[_0x1a1f07(0x20d)][_0x1a1f07(0x1d4)](_0x25ed6f,'MidjourneyService');_0x10cdb2['fileInfo']=_0x455eef,_0x10cdb2['drawId']=_0x112194['id'],_0x10cdb2[_0x1a1f07(0x1f2)]=JSON[_0x1a1f07(0x1b7)](_0x112194[_0x1a1f07(0x1d6)]),_0x10cdb2[_0x1a1f07(0x1ae)]=_0x49af35+'\x0a'+(_0x112194[_0x1a1f07(0x1d7)]||_0x112194[_0x1a1f07(0x1ed)][_0x1a1f07(0x1d7)]||''),_0x9f744d(_0x10cdb2);return;}_0x10cdb2[_0x1a1f07(0x208)]=_0x112194===null||_0x112194===void 0x0?void 0x0:_0x112194['progress'],_0x10cdb2[_0x1a1f07(0x1ae)]=_0x1a1f07(0x1b4)+(_0x112194===null||_0x112194===void 0x0?void 0x0:_0x112194[_0x1a1f07(0x208)]),_0x10cdb2[_0x1a1f07(0x208)]&&_0x4388e6(_0x10cdb2);}catch(_0x1df9fa){_0x5052fb++,common_1[_0x1a1f07(0x20d)][_0x1a1f07(0x1b0)]('轮询过程中发生错误:\x20'+_0x1df9fa,_0x1a1f07(0x1ce));}}common_1[_0x1a1f07(0x20d)]['error']('超过\x20'+_0x2cf86d/0x3e8+_0x1a1f07(0x1b3)),_0x10cdb2[_0x1a1f07(0x20a)]=0x4,_0x319c47(_0x10cdb2);throw new common_1['HttpException'](_0x1a1f07(0x1db),common_1[_0x1a1f07(0x1ba)][_0x1a1f07(0x1e2)]);}catch(_0x4d2566){common_1[_0x1a1f07(0x20d)][_0x1a1f07(0x1b0)]('绘画失败:\x20'+_0x4d2566+_0x1a1f07(0x200)),_0x10cdb2[_0x1a1f07(0x20a)]=0x5,_0x319c47(_0x10cdb2);}}[_0x246c28(0x1ec)](_0x290939){return'midjourney';}};MidjourneyService=__decorate([(0x0,common_1[_0x246c28(0x1a7)])(),__metadata(_0x246c28(0x20e),[upload_service_1[_0x246c28(0x1fd)],globalConfig_service_1['GlobalConfigService'],chatLog_service_1[_0x246c28(0x207)],models_service_1[_0x246c28(0x1d2)]])],MidjourneyService),exports[_0x246c28(0x1ce)]=MidjourneyService;