'use strict';const _0x36d662=_0x55f2;(function(_0x1be600,_0x3ea924){const _0x5d10b3=_0x55f2,_0x286206=_0x1be600();while(!![]){try{const _0xe03feb=parseInt(_0x5d10b3(0x1ba))/0x1*(parseInt(_0x5d10b3(0x1a0))/0x2)+-parseInt(_0x5d10b3(0x200))/0x3+parseInt(_0x5d10b3(0x1b3))/0x4+parseInt(_0x5d10b3(0x1b9))/0x5*(parseInt(_0x5d10b3(0x19f))/0x6)+-parseInt(_0x5d10b3(0x1e7))/0x7+parseInt(_0x5d10b3(0x1bc))/0x8+parseInt(_0x5d10b3(0x1d3))/0x9;if(_0xe03feb===_0x3ea924)break;else _0x286206['push'](_0x286206['shift']());}catch(_0xa33b67){_0x286206['push'](_0x286206['shift']());}}}(_0x5d05,0x4fcfc));function _0x55f2(_0x3cd6c7,_0x39cc0e){const _0x5d05a8=_0x5d05();return _0x55f2=function(_0x55f21c,_0x56a52b){_0x55f21c=_0x55f21c-0x199;let _0x37f300=_0x5d05a8[_0x55f21c];return _0x37f300;},_0x55f2(_0x3cd6c7,_0x39cc0e);}var __decorate=this&&this['__decorate']||function(_0x46b68d,_0x5da3e6,_0x2560df,_0x3e9c77){const _0xe86ba0=_0x55f2;var _0x50a822=arguments[_0xe86ba0(0x1b0)],_0x2a6928=_0x50a822<0x3?_0x5da3e6:_0x3e9c77===null?_0x3e9c77=Object[_0xe86ba0(0x19d)](_0x5da3e6,_0x2560df):_0x3e9c77,_0x199d8a;if(typeof Reflect===_0xe86ba0(0x1e3)&&typeof Reflect[_0xe86ba0(0x1f0)]===_0xe86ba0(0x1a8))_0x2a6928=Reflect[_0xe86ba0(0x1f0)](_0x46b68d,_0x5da3e6,_0x2560df,_0x3e9c77);else{for(var _0x26172b=_0x46b68d[_0xe86ba0(0x1b0)]-0x1;_0x26172b>=0x0;_0x26172b--)if(_0x199d8a=_0x46b68d[_0x26172b])_0x2a6928=(_0x50a822<0x3?_0x199d8a(_0x2a6928):_0x50a822>0x3?_0x199d8a(_0x5da3e6,_0x2560df,_0x2a6928):_0x199d8a(_0x5da3e6,_0x2560df))||_0x2a6928;}return _0x50a822>0x3&&_0x2a6928&&Object[_0xe86ba0(0x1cb)](_0x5da3e6,_0x2560df,_0x2a6928),_0x2a6928;},__metadata=this&&this[_0x36d662(0x1f2)]||function(_0x2ff8ae,_0x5cb7e3){const _0x441fc0=_0x36d662;if(typeof Reflect===_0x441fc0(0x1e3)&&typeof Reflect[_0x441fc0(0x1f1)]===_0x441fc0(0x1a8))return Reflect[_0x441fc0(0x1f1)](_0x2ff8ae,_0x5cb7e3);};Object[_0x36d662(0x1cb)](exports,_0x36d662(0x1d8),{'value':!![]}),exports['MidjourneyService']=void 0x0;const common_1=require(_0x36d662(0x1ae)),axios_1=require('axios'),chatLog_service_1=require('../chatLog/chatLog.service'),globalConfig_service_1=require(_0x36d662(0x1a3)),upload_service_1=require(_0x36d662(0x1a1)),models_service_1=require(_0x36d662(0x1e4));function _0x5d05(){const _0x13cb68=['当前任务类型:\x20','answer','898016tdtKys','/mj/submit/modal','mjNotUseProxy','from','getFullYear','，payload:\x20','860ebbIGy','142585pUbOnN','getMidjourneyModelByPlugin','409984rKsfvF','port','mjProxyImgUrl','getDate','design:paramtypes','padStart','buttons','midjourney','------>\x20开始上传图片！！！','stringify','UploadService','pollMjDrawingResult','globalConfigService','fileInfo','properties','defineProperty','绘制中！绘制进度','IMAGINE','debug','HttpException','uploadService','轮询过程中发生错误:\x20','result','4411161PGUUsn','error','modelsService','绘制中','绘画任务提交成功,\x20绘画ID:\x20','__esModule','finalPrompt','上传成功\x20URL:\x20','BAD_REQUEST','绘画任务提交失败,\x20请检查后台配置或者稍后重试!\x20','state','PICREADER','/mj/submit/describe','images/midjourney/','ModelsService','updateChatLog','object','../models/models.service','default','chatLogService','2822218fKGhyy','protocol','progress','ChatLogService','任务提交失败，请检查提示词后重试','查询绘图结果时发生错误:','Injectable','绘图成功！','getMonth','decorate','metadata','__metadata','drawId','toString','使用代理替换后的\x20URL:\x20','mjNotSaveImg','MidjourneyService','DESCRIBE','now','/mj/submit/action','正在准备发送请求到\x20','未能获取结果数据,\x20即将重试','arrayBuffer','Logger','收到响应:\x20','1465491AWPeIZ','key','不保存图片，使用\x20URL:\x20','getConfigs','get','/mj/task/','imageUrl','status','blob','log','getOwnPropertyDescriptor','customId','5844wvzNAB','4slZvfG','../upload/upload.service','存储图片失败，使用原始/代理图片链接\x20','../globalConfig/globalConfig.service','绘画任务提交成功','hostname','data','绘制成功,\x20获取到的URL:\x20','function','post','midjourneyDraw','绘图失败','data:image/png;base64,',',\x20headers:\x20','@nestjs/common','100%','length'];_0x5d05=function(){return _0x13cb68;};return _0x5d05();}let MidjourneyService=class MidjourneyService{constructor(_0x37799b,_0x3e021b,_0x3ab675,_0x216d0a){const _0x3ea627=_0x36d662;this[_0x3ea627(0x1d0)]=_0x37799b,this[_0x3ea627(0x1c8)]=_0x3e021b,this[_0x3ea627(0x1e6)]=_0x3ab675,this[_0x3ea627(0x1d5)]=_0x216d0a;}async[_0x36d662(0x1aa)](_0x5baa97){const _0x1dab94=_0x36d662;var _0x29975b,_0x45019d,_0x185739,_0x2958ed;const {id:_0x5da587,apiKey:_0x5d5f59,proxyUrl:_0x5a66d6,action:_0x1e0f52,drawId:_0xb44e3,prompt:_0x143979,usePrompt:_0x2ca04b,customId:_0x4cd1e7,timeout:_0xe6e5b4,fileInfo:_0x18e5c1,assistantLogId:_0x239f9e,pluginName:_0x274e3a}=_0x5baa97;let _0x20551b={'text':'','fileInfo':'','drawId':'','customId':'','status':0x2};const _0x43d153=this['getMidjourneyModelByPlugin'](_0x274e3a),_0x25596a=await this[_0x1dab94(0x1d5)]['getModelConfigByName'](_0x43d153),_0x4eaa76=(_0x25596a===null||_0x25596a===void 0x0?void 0x0:_0x25596a[_0x1dab94(0x201)])||_0x5d5f59;let _0x5102a2,_0x4791db=0x0,_0x116715='';const _0x502800={'mj-api-secret':_0x4eaa76};common_1[_0x1dab94(0x1fe)][_0x1dab94(0x1ce)](_0x1dab94(0x1b1)+_0x1e0f52,_0x1dab94(0x1f7));while(_0x4791db<0x3){let _0x2934da={};try{if(_0x1e0f52===_0x1dab94(0x1cd))_0x116715=_0x5a66d6+'/mj/submit/imagine',_0x2934da={'prompt':_0x2ca04b};else{if(_0x1e0f52===_0x1dab94(0x1f8)){_0x116715=_0x5a66d6+_0x1dab94(0x1df);if(_0x18e5c1){const _0x35308b=await fetch(_0x18e5c1),_0x584e74=await _0x35308b[_0x1dab94(0x19b)](),_0x3bf180=Buffer[_0x1dab94(0x1b6)](await _0x584e74[_0x1dab94(0x1fd)]()),_0x4c6a6b=_0x3bf180['toString']('base64');_0x2934da={'base64':_0x1dab94(0x1ac)+_0x4c6a6b};}else return;}else _0x1e0f52===_0x1dab94(0x1de)?(_0x116715=_0x5a66d6+_0x1dab94(0x1fa),_0x2934da={'taskId':_0xb44e3,'customId':_0x4cd1e7},_0x5102a2=await axios_1['default'][_0x1dab94(0x1a9)](_0x116715,_0x2934da,{'headers':_0x502800}),(_0x5102a2===null||_0x5102a2===void 0x0?void 0x0:_0x5102a2['status'])===0xc8&&((_0x29975b=_0x5102a2===null||_0x5102a2===void 0x0?void 0x0:_0x5102a2[_0x1dab94(0x1a6)])===null||_0x29975b===void 0x0?void 0x0:_0x29975b[_0x1dab94(0x1d2)])&&(_0x116715=_0x5a66d6+_0x1dab94(0x1b4),_0x2934da={'taskId':(_0x45019d=_0x5102a2===null||_0x5102a2===void 0x0?void 0x0:_0x5102a2['data'])===null||_0x45019d===void 0x0?void 0x0:_0x45019d['result']})):(_0x116715=_0x5a66d6+_0x1dab94(0x1fa),_0x2934da={'taskId':_0xb44e3,'customId':_0x4cd1e7});}common_1['Logger'][_0x1dab94(0x19c)](_0x1dab94(0x1fb)+_0x116715+_0x1dab94(0x1b8)+JSON[_0x1dab94(0x1c5)](_0x2934da)+_0x1dab94(0x1ad)+JSON[_0x1dab94(0x1c5)](_0x502800),_0x1dab94(0x1f7)),_0x5102a2=await axios_1[_0x1dab94(0x1e5)]['post'](_0x116715,_0x2934da,{'headers':_0x502800});if((_0x5102a2===null||_0x5102a2===void 0x0?void 0x0:_0x5102a2['status'])===0xc8&&((_0x185739=_0x5102a2===null||_0x5102a2===void 0x0?void 0x0:_0x5102a2['data'])===null||_0x185739===void 0x0?void 0x0:_0x185739[_0x1dab94(0x1d2)])){common_1[_0x1dab94(0x1fe)]['debug'](_0x1dab94(0x1ff)+JSON[_0x1dab94(0x1c5)](_0x5102a2[_0x1dab94(0x1a6)]),_0x1dab94(0x1f7)),_0x20551b[_0x1dab94(0x1f3)]=(_0x2958ed=_0x5102a2===null||_0x5102a2===void 0x0?void 0x0:_0x5102a2[_0x1dab94(0x1a6)])===null||_0x2958ed===void 0x0?void 0x0:_0x2958ed[_0x1dab94(0x1d2)],_0x20551b[_0x1dab94(0x1dd)]=0x2,_0x20551b['answer']=_0x1dab94(0x1a4),common_1['Logger'][_0x1dab94(0x19c)](_0x1dab94(0x1d7)+_0x5102a2['data']['result'],_0x1dab94(0x1f7));break;}else throw new Error(_0x1dab94(0x1fc));}catch(_0x2f5a63){_0x4791db++,_0x4791db>=0x3&&(_0x20551b['answer']=_0x1dab94(0x1eb),_0x20551b[_0x1dab94(0x19a)]=0x5,common_1[_0x1dab94(0x1fe)][_0x1dab94(0x19c)](_0x1dab94(0x1dc)+_0x2f5a63,'MidjourneyService'));}}return this['pollMjDrawingResult']({'proxyUrl':_0x5a66d6,'apiKey':_0x4eaa76,'drawId':_0x20551b['drawId'],'timeout':_0xe6e5b4,'prompt':_0x143979,'onSuccess':async _0x4f9474=>{const _0x5bae35=_0x1dab94;await this['chatLogService'][_0x5bae35(0x1e2)](_0x239f9e,{'fileInfo':_0x4f9474===null||_0x4f9474===void 0x0?void 0x0:_0x4f9474[_0x5bae35(0x1c9)],'answer':(_0x4f9474===null||_0x4f9474===void 0x0?void 0x0:_0x4f9474['answer'])||_0x143979,'progress':_0x5bae35(0x1af),'status':0x3,'drawId':_0x4f9474===null||_0x4f9474===void 0x0?void 0x0:_0x4f9474['drawId'],'customId':_0x4f9474===null||_0x4f9474===void 0x0?void 0x0:_0x4f9474[_0x5bae35(0x19e)]}),common_1[_0x5bae35(0x1fe)][_0x5bae35(0x19c)](_0x5bae35(0x1ee),_0x5bae35(0x1f7));},'onDrawing':async _0x4c4539=>{const _0x4b4102=_0x1dab94;await this['chatLogService'][_0x4b4102(0x1e2)](_0x239f9e,{'answer':(_0x4c4539===null||_0x4c4539===void 0x0?void 0x0:_0x4c4539[_0x4b4102(0x1b2)])||_0x4b4102(0x1d6),'progress':_0x4c4539===null||_0x4c4539===void 0x0?void 0x0:_0x4c4539['progress'],'status':0x2}),common_1[_0x4b4102(0x1fe)][_0x4b4102(0x19c)](_0x4b4102(0x1cc)+(_0x4c4539===null||_0x4c4539===void 0x0?void 0x0:_0x4c4539[_0x4b4102(0x1e9)]),'MidjourneyService');},'onFailure':async _0x5c9231=>{const _0x2f632e=_0x1dab94;await this['chatLogService'][_0x2f632e(0x1e2)](_0x239f9e,{'answer':_0x2f632e(0x1ab),'status':_0x5c9231[_0x2f632e(0x19a)]}),common_1[_0x2f632e(0x1fe)][_0x2f632e(0x19c)](_0x2f632e(0x1ab),_0x2f632e(0x1f7));}})['catch'](_0x2c5d71=>{const _0x53abbd=_0x1dab94;common_1['Logger'][_0x53abbd(0x1d4)](_0x53abbd(0x1ec),_0x2c5d71,_0x53abbd(0x1f7));}),_0x20551b;}async[_0x36d662(0x1c7)](_0x3a4013){const _0x5a91bb=_0x36d662,{proxyUrl:_0x52a617,apiKey:_0x24f331,drawId:_0x15b1c4,timeout:_0x68194d,onSuccess:_0x24c280,prompt:_0x49c3bf,onFailure:_0x5efea4,onDrawing:_0x41d5d4}=_0x3a4013,{mjNotSaveImg:_0x3fd3f8,mjProxyImgUrl:_0x245439,mjNotUseProxy:_0x7312b9}=await this['globalConfigService'][_0x5a91bb(0x203)]([_0x5a91bb(0x1f6),_0x5a91bb(0x1be),_0x5a91bb(0x1b5)]);let _0xa49939={'fileInfo':'','drawId':'','customId':'','status':0x2,'progress':0x0,'answer':''};const _0x23234e=Date[_0x5a91bb(0x1f9)](),_0x524c4e=0x1388;let _0x46f7b6=0x0;try{while(Date[_0x5a91bb(0x1f9)]()-_0x23234e<_0x68194d){await new Promise(_0x2f7837=>setTimeout(_0x2f7837,_0x524c4e));try{const _0x2c99ad={'Content-Type':'application/x-www-form-urlencoded','mj-api-secret':_0x24f331},_0x215fb4=_0x52a617+_0x5a91bb(0x205)+_0x15b1c4+'/fetch',_0x15db41=await axios_1[_0x5a91bb(0x1e5)][_0x5a91bb(0x204)](_0x215fb4,{'headers':_0x2c99ad}),_0x1a8570=_0x15db41[_0x5a91bb(0x1a6)];common_1[_0x5a91bb(0x1fe)][_0x5a91bb(0x1ce)]('查询结果:\x20'+JSON[_0x5a91bb(0x1c5)](_0x1a8570),'MidjourneyService');if(_0x1a8570[_0x5a91bb(0x19a)]==='SUCCESS'){common_1[_0x5a91bb(0x1fe)][_0x5a91bb(0x19c)](_0x5a91bb(0x1a7)+_0x1a8570['imageUrl'],'MidjourneyService');let _0x2071ff=_0x1a8570['imageUrl'];const _0x7b32aa=_0x7312b9==='0'&&_0x245439;let _0x571302='';if(_0x7b32aa){const _0xcc93be=new URL(_0x245439),_0x3a6650=new URL(_0x1a8570[_0x5a91bb(0x199)]);_0x3a6650['protocol']=_0xcc93be[_0x5a91bb(0x1e8)],_0x3a6650[_0x5a91bb(0x1a5)]=_0xcc93be['hostname'],_0x3a6650['port']=_0xcc93be[_0x5a91bb(0x1bd)]?_0xcc93be['port']:'',_0x2071ff=_0x3a6650[_0x5a91bb(0x1f4)](),_0x571302=_0x5a91bb(0x1f5)+_0x2071ff,common_1[_0x5a91bb(0x1fe)][_0x5a91bb(0x19c)](_0x571302,_0x5a91bb(0x1f7));}if(_0x3fd3f8!=='1'){try{common_1[_0x5a91bb(0x1fe)]['log'](_0x5a91bb(0x1c4),_0x5a91bb(0x1f7));const _0x70fca0=new Date(),_0x39d1a0=_0x70fca0[_0x5a91bb(0x1b7)](),_0x378a76=String(_0x70fca0[_0x5a91bb(0x1ef)]()+0x1)['padStart'](0x2,'0'),_0x66d1a0=String(_0x70fca0[_0x5a91bb(0x1bf)]())[_0x5a91bb(0x1c1)](0x2,'0'),_0x41f4e=''+_0x39d1a0+_0x378a76+'/'+_0x66d1a0;_0x2071ff=await this[_0x5a91bb(0x1d0)]['uploadFileFromUrl']({'url':_0x2071ff,'dir':_0x5a91bb(0x1e0)+_0x41f4e}),_0x571302=_0x5a91bb(0x1da)+_0x2071ff;}catch(_0x58b77d){common_1['Logger'][_0x5a91bb(0x1d4)]('存储图片失败，使用原始/代理图片链接'),_0x571302=_0x5a91bb(0x1a2)+_0x2071ff;}common_1[_0x5a91bb(0x1fe)][_0x5a91bb(0x19c)](_0x571302,_0x5a91bb(0x1f7));}else _0x571302=_0x5a91bb(0x202)+_0x2071ff,common_1[_0x5a91bb(0x1fe)][_0x5a91bb(0x19c)](_0x571302,_0x5a91bb(0x1f7));_0xa49939['fileInfo']=_0x2071ff,_0xa49939[_0x5a91bb(0x1f3)]=_0x1a8570['id'],_0xa49939['customId']=JSON[_0x5a91bb(0x1c5)](_0x1a8570[_0x5a91bb(0x1c2)]),_0xa49939['answer']=_0x49c3bf+'\x0a'+(_0x1a8570[_0x5a91bb(0x1d9)]||_0x1a8570[_0x5a91bb(0x1ca)][_0x5a91bb(0x1d9)]||''),_0x24c280(_0xa49939);return;}_0xa49939[_0x5a91bb(0x1e9)]=_0x1a8570===null||_0x1a8570===void 0x0?void 0x0:_0x1a8570[_0x5a91bb(0x1e9)],_0xa49939[_0x5a91bb(0x1b2)]='当前绘制进度\x20'+(_0x1a8570===null||_0x1a8570===void 0x0?void 0x0:_0x1a8570['progress']),_0xa49939[_0x5a91bb(0x1e9)]&&_0x41d5d4(_0xa49939);}catch(_0x3f3212){_0x46f7b6++,common_1[_0x5a91bb(0x1fe)][_0x5a91bb(0x1d4)](_0x5a91bb(0x1d1)+_0x3f3212,_0x5a91bb(0x1f7));}}common_1['Logger']['error']('超过\x20'+_0x23234e/0x3e8+'\x20s\x20未完成绘画,\x20请稍后再试!\x20MidjourneyService'),_0xa49939[_0x5a91bb(0x19a)]=0x4,_0x5efea4(_0xa49939);throw new common_1[(_0x5a91bb(0x1cf))]('绘画超时，请稍后再试！',common_1['HttpStatus'][_0x5a91bb(0x1db)]);}catch(_0x839b5b){common_1[_0x5a91bb(0x1fe)]['error']('绘画失败:\x20'+_0x839b5b+'\x20MidjourneyService'),_0xa49939[_0x5a91bb(0x19a)]=0x5,_0x5efea4(_0xa49939);}}[_0x36d662(0x1bb)](_0x202e73){const _0x6afe82=_0x36d662;return _0x6afe82(0x1c3);}};MidjourneyService=__decorate([(0x0,common_1[_0x36d662(0x1ed)])(),__metadata(_0x36d662(0x1c0),[upload_service_1[_0x36d662(0x1c6)],globalConfig_service_1['GlobalConfigService'],chatLog_service_1[_0x36d662(0x1ea)],models_service_1[_0x36d662(0x1e1)]])],MidjourneyService),exports[_0x36d662(0x1f7)]=MidjourneyService;